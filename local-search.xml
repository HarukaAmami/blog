<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>企业级反向代理HAPROXY</title>
    <link href="/blog/2021/06/07/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86HAPROXY/"/>
    <url>/blog/2021/06/07/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86HAPROXY/</url>
    
    <content type="html"><![CDATA[<h1 id="企业级反向代理HAPROXY"><a href="#企业级反向代理HAPROXY" class="headerlink" title="企业级反向代理HAPROXY"></a>企业级反向代理HAPROXY</h1><h2 id="一、web架构介绍"><a href="#一、web架构介绍" class="headerlink" title="一、web架构介绍"></a>一、web架构介绍</h2><h3 id="1-1-单机房架构"><a href="#1-1-单机房架构" class="headerlink" title="1.1 单机房架构"></a>1.1 单机房架构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy1.png"></p><h3 id="1-2-多机房架构"><a href="#1-2-多机房架构" class="headerlink" title="1.2 多机房架构"></a>1.2 多机房架构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy2.png"></p><h3 id="1-3-公有云架构"><a href="#1-3-公有云架构" class="headerlink" title="1.3 公有云架构"></a>1.3 公有云架构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy3.png"></p><h3 id="1-4-私有云架构"><a href="#1-4-私有云架构" class="headerlink" title="1.4 私有云架构"></a>1.4 私有云架构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy4.png"></p><h2 id="二、负载均衡简介"><a href="#二、负载均衡简介" class="headerlink" title="二、负载均衡简介"></a>二、负载均衡简介</h2><p>负载均衡：Load Balance，简称LB，是一种服务或基于硬件设备等实现的高可用反向代理技术，负载<br>均衡将特定的业务(web服务、网络流量等)分担给指定的一个或多个后端特定的服务器或设备，从而提<br>高了公司业务的并发处理能力、保证了业务的高可用性、方便了业务后期的水平动态扩展<br>阿里云SLB介绍 ：<a href="https://yq.aliyun.com/articles/1803">https://yq.aliyun.com/articles/1803</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy5.png"></p><h3 id="2-1-为什么使用负载均衡"><a href="#2-1-为什么使用负载均衡" class="headerlink" title="2.1 为什么使用负载均衡"></a>2.1 为什么使用负载均衡</h3><ul><li>Web服务器的动态水平扩展–&gt;对用户无感知</li><li>增加业务并发访问及处理能力–&gt;解决单服务器瓶颈问题</li><li>节约公网IP地址–&gt;降低IT支出成本</li><li>隐藏内部服务器IP–&gt;提高内部服务器安全性</li><li>配置简单–&gt;固定格式的配置文件</li><li>功能丰富–&gt;支持四层和七层，支持动态下线主机</li><li>性能较强–&gt;并发数万甚至数十万</li></ul><h3 id="2-2-负载均衡类型"><a href="#2-2-负载均衡类型" class="headerlink" title="2.2 负载均衡类型"></a>2.2 负载均衡类型</h3><p>四层：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">LVS：Linux Virtual Server<br>Nginx：1.9版之后<br>HAProxy：High Availability Proxy<br></code></pre></td></tr></table></figure><p>七层：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">HAProxy<br>Nginx<br></code></pre></td></tr></table></figure><p>硬件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">F5    https://f5.com/zh<br>Netscaler https://www.citrix.com.cn/products/citrix-adc/<br>Array   https://www.arraynetworks.com.cn/<br>深信服    http://www.sangfor.com.cn/<br>北京灵州   http://www.lingzhou.com.cn/cpzx/llfzjh/<br></code></pre></td></tr></table></figure><h3 id="2-3-应用场景"><a href="#2-3-应用场景" class="headerlink" title="2.3 应用场景"></a>2.3 应用场景</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">四层：Redis、Mysql、RabbitMQ、Memcache等<br>七层：Nginx、Tomcat、Apache、PHP、图片、动静分离、API等<br></code></pre></td></tr></table></figure><p>随着公司业务的发展，公司负载均衡服务既有四层的，又有七层的，通过LVS实现四层和Nginx实现七<br>层的负载均衡对机器资源消耗比较大，并且管理复杂度提升，运维总监要求，目前需要对前端负载均衡服务进行一定的优化和复用，能否用一种服务同既能实现七层负载均衡，又能实现四层负载均衡，并且性能高效，配置管理容易，而且还是开源。</p><p>在企业生产环境中，每天会有很多的需求变更，比如增加服务器、新业务上线、url路由修改、域名配置等等，对于前端负载均衡设备来说，容易维护，复杂度低，是首选指标。在企业中，稳定压倒一切，与其搞得很复杂，经常出问题，不如做的简单和稳定。在企业中，90%以上的故障，来源于需求变更。可能是程序bug，也可能是人为故障，也可能是架构设计问题等。前端负载均衡设备为重中之重，在软件选型上一定充分考虑，能满足业务的前提下，尽可能降低复杂度，提高易维护性</p><h3 id="2-4-HAProxy介绍"><a href="#2-4-HAProxy介绍" class="headerlink" title="2.4 HAProxy介绍"></a>2.4 HAProxy介绍</h3><p>HAProxy是法国开发者 威利塔罗(Willy Tarreau) 在2000年使用C语言开发的一个开源软件，是一款具<br>备高并发(一万以上)、高性能的TCP和HTTP负载均衡器，支持基于cookie的持久性，自动故障切换，支持正则表达式及web状态统计，目前最新TLS版本为2.2</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy6.png"></p><p><strong>历史版本：</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy7.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">历史版本更新功能：1.4 1.5 1.6 1.7 1.8 1.9 2.0 2.1 2.2 2.3 2.4-dev<br>1.8：多线程，HTTP/2缓存……<br>1.7：服务器动态配置，多类型证书……<br>1.6：DNS解析支持，HTTP连接多路复用……<br>1.5：开始支持SSL，IPV6，会话保持……<br></code></pre></td></tr></table></figure><p>从2013年HAProxy 分为社区版和企业版，企业版将提供更多的特性和功能以及全天24小时的技术支持<br>等服务。</p><h4 id="2-4-1-企业版"><a href="#2-4-1-企业版" class="headerlink" title="2.4.1 企业版"></a>2.4.1 企业版</h4><p>企业版网站：<a href="https://www.haproxy.com/">https://www.haproxy.com/</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy8.png"></p><h4 id="2-4-2-社区版"><a href="#2-4-2-社区版" class="headerlink" title="2.4.2 社区版"></a>2.4.2 社区版</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy9.png"></p><p>社区版网站：<a href="http://www.haproxy.org/">http://www.haproxy.org/</a><br>github：<a href="https://github.com/haproxy">https://github.com/haproxy</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy10.png"></p><h4 id="2-4-3-版本对比"><a href="#2-4-3-版本对比" class="headerlink" title="2.4.3 版本对比"></a>2.4.3 版本对比</h4><table><thead><tr><th>功能</th><th>社区版</th><th>企业版</th></tr></thead><tbody><tr><td>高级HTTP / TCP负载平衡和持久性</td><td>支持</td><td>支持</td></tr><tr><td>高级健康检查</td><td>支持</td><td>支持</td></tr><tr><td>应用程序加速</td><td>支持</td><td>支持</td></tr><tr><td>高级安全特性</td><td>支持</td><td>支持</td></tr><tr><td>高级管理</td><td>支持</td><td>支持</td></tr><tr><td>HAProxy Dev Branch新功能</td><td></td><td>支持</td></tr><tr><td>24*7 支持服务</td><td></td><td>支持</td></tr><tr><td>实时仪表盘</td><td></td><td>支持</td></tr><tr><td>VRRP和Route Health Injection HA工具</td><td></td><td>支持</td></tr><tr><td>基于应用程序的高级DDoS和Bot保护(自动保护)</td><td></td><td>支持</td></tr><tr><td>Bot(机器人)监测</td><td></td><td>支持</td></tr><tr><td>ACL，映射和TLS票证密钥同步</td><td></td><td>支持</td></tr><tr><td>Web应用防火墙</td><td></td><td>支持</td></tr><tr><td>HTTP协议验证</td><td></td><td>支持</td></tr><tr><td>实时集群追踪</td><td></td><td>支持</td></tr></tbody></table><h4 id="2-4-4-HAProxy功能"><a href="#2-4-4-HAProxy功能" class="headerlink" title="2.4.4 HAProxy功能"></a>2.4.4 HAProxy功能</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy11.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy12.png"></p><p>支持功能：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">TCP 和 HTTP反向代理<br>SSL/TSL服务器<br>可以针对HTTP请求添加cookie，进行路由后端服务器<br>可平衡负载至后端服务器，并支持持久连接<br>支持所有主服务器故障切换至备用服务器<br>支持专用端口实现监控服务<br>支持停止接受新连接请求，而不影响现有连接<br>可以在双向添加，修改或删除HTTP报文首部<br>响应报文压缩<br>支持基于pattern实现连接请求的访问控制<br>通过特定的URI为授权用户提供详细的状态信息<br>后端服务器只能看到haproxy服务器的ip地址对自己进项访问<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy13.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">支持http反向代理<br>支持动态程序的反向代理<br>支持基于数据库的反向代理<br></code></pre></td></tr></table></figure><p><strong>不具备的功能：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">正向代理--squid，nginx<br>缓存代理--varnish<br>web服务--nginx、tengine、apache、php、tomcat<br>UDP--目前不支持UDP协议<br>单机性能--相比LVS性能较差<br></code></pre></td></tr></table></figure><h2 id="三、HAProxy安装及基础配置"><a href="#三、HAProxy安装及基础配置" class="headerlink" title="三、HAProxy安装及基础配置"></a>三、HAProxy安装及基础配置</h2><p><strong>介绍HAProxy的基础安装及基础配置</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy14.png"></p><p>内网IP地址划分：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#外部网段：</span><br>172.16.0.0/16<br><br><span class="hljs-comment">#内部网段：</span><br>10.0.0.0/24<br><br><span class="hljs-comment">#可用地址范围：</span><br>10.0.0.1--10.0.0.254<br></code></pre></td></tr></table></figure><h3 id="3-1-Ubuntu-安装"><a href="#3-1-Ubuntu-安装" class="headerlink" title="3.1 Ubuntu 安装"></a>3.1 Ubuntu 安装</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy15.png"></p><p>打开链接： <a href="https://haproxy.debian.net/">https://haproxy.debian.net/</a> ，选择合适的版本，会自动出现下面安装提示</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy16.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#apt-get install software-properties-common</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#add-apt-repository ppa:vbernat/haproxy-2.0</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt update</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt-cache madison haproxy</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt install haproxy=2.0.4-1ppa1~bionic</span><br><br><span class="hljs-comment">#或安装最新版</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt-get install haproxy=2.0.\*</span><br><br><span class="hljs-comment">#验证haproxy版本</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#haproxy -v</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#apt-get install software-properties-common</span><br>Reading package lists... Done<br>Building dependency tree   <br>Reading state information... Done<br>The following additional packages will be installed:<br>python3-software-properties<br>The following packages will be upgraded:<br>python3-software-properties software-properties-common<br>2 upgraded, 0 newly installed, 0 to remove and 252 not upgraded.<br>Need to get 33.6 kB of archives.<br>After this operation, 13.3 kB of additional disk space will be used.<br>Do you want to <span class="hljs-built_in">continue</span>? [Y/n] y<br>Get:1 http://mirrors.aliyun.com/ubuntu bionic-updates/main amd64 software-<br>properties-common all 0.96.24.32.12 [10.0 kB]<br>Get:2 http://mirrors.aliyun.com/ubuntu bionic-updates/main amd64 python3-<br>software-properties all 0.96.24.32.12 [23.6 kB]<br>Fetched 33.6 kB <span class="hljs-keyword">in</span> 5s (6,528 B/s)        <br>(Reading database ... 71030 files and directories currently installed.)<br>Preparing to unpack .../software-properties-common_0.96.24.32.12_all.deb ...<br>Unpacking software-properties-common (0.96.24.32.12) over (0.96.24.32.4) ...<br>Preparing to unpack .../python3-software-properties_0.96.24.32.12_all.deb ...<br>Unpacking python3-software-properties (0.96.24.32.12) over (0.96.24.32.4) ...<br>Processing triggers <span class="hljs-keyword">for</span> man-db (2.8.3-2) ...<br>Setting up python3-software-properties (0.96.24.32.12) ...<br>Processing triggers <span class="hljs-keyword">for</span> dbus (1.12.2-1ubuntu1) ...<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#add-apt-repository ppa:vbernat/haproxy-2.0</span><br>HAProxy is a free, very fast and reliable solution offering high availability,<br>load balancing, and proxying <span class="hljs-keyword">for</span> TCP and HTTP-based applications. It is<br>particularly suited <span class="hljs-keyword">for</span> web sites crawling under very high loads <span class="hljs-keyword">while</span> needing<br>persistence or Layer7 processing. Supporting tens of thousands of connections is<br>clearly realistic with todays hardware. Its mode of operation makes its<br>integration into existing architectures very easy and riskless, <span class="hljs-keyword">while</span> still<br>offering the possibility not to expose fragile web servers to the Net.<br>This PPA contains packages <span class="hljs-keyword">for</span> HAProxy 2.0.<br>More info: https://launchpad.net/~vbernat/+archive/ubuntu/haproxy-2.0<br>Press [ENTER] to <span class="hljs-built_in">continue</span> or Ctrl-c to cancel adding it.<br>Hit:1 http://mirrors.aliyun.com/ubuntu bionic InRelease<br>Hit:2 http://mirrors.aliyun.com/ubuntu bionic-security InRelease<br>Hit:3 http://mirrors.aliyun.com/ubuntu bionic-updates InRelease        <br>    <br>Hit:4 http://mirrors.aliyun.com/ubuntu bionic-proposed InRelease        <br>   <br>Hit:5 http://mirrors.aliyun.com/ubuntu bionic-backports InRelease       <br>    <br>Get:6 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic InRelease [20.7<br>kB]  <br>Get:7 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main i386<br>Packages [984 B]<br>Get:8 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main amd64<br>Packages [988 B]<br>Get:9 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main<br>Translation-en [704 B]<br>Fetched 23.4 kB <span class="hljs-keyword">in</span> 6s (3,971 B/s)   <br>Reading package lists... Done<br><br>[root@ubuntu1804 ~]<span class="hljs-comment"># apt-get update</span><br>Hit:1 http://mirrors.aliyun.com/ubuntu bionic InRelease<br>Hit:2 http://mirrors.aliyun.com/ubuntu bionic-security InRelease        <br>   <br>Hit:3 http://mirrors.aliyun.com/ubuntu bionic-updates InRelease        <br>    <br>Hit:4 http://mirrors.aliyun.com/ubuntu bionic-proposed InRelease        <br>   <br>Hit:5 http://mirrors.aliyun.com/ubuntu bionic-backports InRelease       <br>    <br>Hit:6 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic InRelease   <br>   <br>Reading package lists... Done<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt-get install haproxy=2.0.\*</span><br>Reading package lists... Done<br>Building dependency tree   <br>Reading state information... Done<br>Selected version <span class="hljs-string">&#x27;2.0.13-1ppa1~bionic&#x27;</span> (HAProxy 2.0:18.04/bionic [amd64]) <span class="hljs-keyword">for</span><br><span class="hljs-string">&#x27;haproxy&#x27;</span><br>The following additional packages will be installed:<br>liblua5.3-0 libpcre2-8-0<br>Suggested packages:<br>vim-haproxy haproxy-doc<br>The following NEW packages will be installed:<br>haproxy liblua5.3-0 libpcre2-8-0<br>0 upgraded, 3 newly installed, 0 to remove and 252 not upgraded.<br>Need to get 1,526 kB/1,819 kB of archives.<br>After this operation, 4,246 kB of additional disk space will be used.<br>Do you want to <span class="hljs-built_in">continue</span>? [Y/n] y<br>Get:1 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main amd64<br>haproxy amd64 2.0.13-1ppa1~bionic [1,526 kB]<br>Fetched 572 kB <span class="hljs-keyword">in</span> 26s (22.1 kB/s)                       <br>    <br>Selecting previously unselected package liblua5.3-0:amd64.<br>(Reading database ... 71032 files and directories currently installed.)<br>Preparing to unpack .../liblua5.3-0_5.3.3-1ubuntu0.18.04.1_amd64.deb ...<br>Unpacking liblua5.3-0:amd64 (5.3.3-1ubuntu0.18.04.1) ...<br>Selecting previously unselected package libpcre2-8-0:amd64.<br>Preparing to unpack .../libpcre2-8-0_10.31-2_amd64.deb ...<br>Unpacking libpcre2-8-0:amd64 (10.31-2) ...<br>Selecting previously unselected package haproxy.<br>Preparing to unpack .../haproxy_2.0.13-1ppa1~bionic_amd64.deb ...<br>Unpacking haproxy (2.0.13-1ppa1~bionic) ...<br>Processing triggers <span class="hljs-keyword">for</span> ureadahead (0.100.0-20) ...<br>Processing triggers <span class="hljs-keyword">for</span> libc-bin (2.27-3ubuntu1) ...<br>Processing triggers <span class="hljs-keyword">for</span> systemd (237-3ubuntu10.3) ...<br>Processing triggers <span class="hljs-keyword">for</span> man-db (2.8.3-2) ...<br>Setting up libpcre2-8-0:amd64 (10.31-2) ...<br>Setting up liblua5.3-0:amd64 (5.3.3-1ubuntu0.18.04.1) ...<br>Processing triggers <span class="hljs-keyword">for</span> rsyslog (8.32.0-1ubuntu4) ...<br>Setting up haproxy (2.0.13-1ppa1~bionic) ...<br>Created symlink /etc/systemd/system/multi-user.target.wants/haproxy.service →<br>/lib/systemd/system/haproxy.service.<br>Processing triggers <span class="hljs-keyword">for</span> libc-bin (2.27-3ubuntu1) ...<br>Processing triggers <span class="hljs-keyword">for</span> ureadahead (0.100.0-20) ...<br>Processing triggers <span class="hljs-keyword">for</span> systemd (237-3ubuntu10.3) ...<br>Processing triggers <span class="hljs-keyword">for</span> rsyslog (8.32.0-1ubuntu4) ...<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt-cache madison haproxy</span><br> haproxy | 2.0.13-1ppa1~bionic | http://ppa.launchpad.net/vbernat/haproxy-<br>2.0/ubuntu bionic/main amd64 Packages<br> haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-<br>security/main amd64 Packages<br> haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-<br>updates/main amd64 Packages<br> haproxy |   1.8.8-1 | http://mirrors.aliyun.com/ubuntu bionic/main amd64<br>Packages<br> haproxy |   1.8.8-1 | http://mirrors.aliyun.com/ubuntu bionic/main Sources<br> haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-<br>security/main Sources<br> haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-<br>updates/main Sources<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#haproxy -v</span><br>HA-Proxy version 2.0.13-1ppa1~bionic 2020/02/15 - https://haproxy.org/<br></code></pre></td></tr></table></figure><h3 id="3-2-CentOS-安装"><a href="#3-2-CentOS-安装" class="headerlink" title="3.2 CentOS 安装"></a>3.2 CentOS 安装</h3><p>在centos 系统上通过 yum、编译等多种安装方式</p><h4 id="3-2-1-系统默认yum源"><a href="#3-2-1-系统默认yum源" class="headerlink" title="3.2.1 系统默认yum源"></a>3.2.1 系统默认yum源</h4><p>CentOS 7 的默认的base仓库中包含haproxy的安装包文件，但是版本比较旧，是1.5.18的版本，距离<br>当前版本已经有较长时间没有更新，由于版本比较旧所以有很多功能不支持，如果对功能和性能没有要求可以使用此版本，否则推荐使用新版本。</p><p>范例：CentOS 7 安装haproxy</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum install haproxy -y</span><br><span class="hljs-comment">#验证haproxy版本</span><br><br>[root@centos7 ~]<span class="hljs-comment"># haproxy -v</span><br>HA-Proxy version 1.5.18 2016/05/10<br>Copyright 2000-2016 Willy Tarreau &lt;willy@haproxy.org&gt;<br><br>[root@centos7 ~]<span class="hljs-comment"># rpm -ql haproxy</span><br>/etc/haproxy<br>/etc/haproxy/haproxy.cfg<br>/etc/logrotate.d/haproxy<br>/etc/sysconfig/haproxy<br>/usr/bin/halog<br>/usr/bin/iprange<br>/usr/lib/systemd/system/haproxy.service<br>/usr/sbin/haproxy<br>/usr/sbin/haproxy-systemd-wrapper<br>/usr/share/doc/haproxy-1.5.18<br>/usr/share/doc/haproxy-1.5.18/CHANGELOG<br>/usr/share/doc/haproxy-1.5.18/LICENSE<br>/usr/share/doc/haproxy-1.5.18/README<br>/usr/share/doc/haproxy-1.5.18/ROADMAP<br>/usr/share/doc/haproxy-1.5.18/VERSION<br>/usr/share/doc/haproxy-1.5.18/acl.fig<br>/usr/share/doc/haproxy-1.5.18/architecture.txt<br>/usr/share/doc/haproxy-1.5.18/close-options.txt<br>/usr/share/doc/haproxy-1.5.18/coding-style.txt<br>/usr/share/doc/haproxy-1.5.18/configuration.txt<br>/usr/share/doc/haproxy-1.5.18/cookie-options.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/backends-v0.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/backends.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/be-fe-changes.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/binding-possibilities.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/buffer-redesign.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/buffers.fig<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/config-language.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/connection-reuse.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/cttproxy-changes.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/entities-v2.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/how-it-works.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/http_load_time.url<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/rate-shaping.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/sess_par_sec.txt<br>/usr/share/doc/haproxy-1.5.18/examples<br>/usr/share/doc/haproxy-1.5.18/examples/acl-content-sw.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/auth.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/build.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/content-sw-sample.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/cttproxy-src.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/examples.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/haproxy.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/option-http_proxy.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/ssl.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/tarpit.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/test-section-kw.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/transparent_proxy.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/url-switching.cfg<br>/usr/share/doc/haproxy-1.5.18/gpl.txt<br>/usr/share/doc/haproxy-1.5.18/haproxy-en.txt<br>/usr/share/doc/haproxy-1.5.18/haproxy-fr.txt<br>/usr/share/doc/haproxy-1.5.18/haproxy.1<br>/usr/share/doc/haproxy-1.5.18/internals<br>/usr/share/doc/haproxy-1.5.18/internals/acl.txt<br>/usr/share/doc/haproxy-1.5.18/internals/body-parsing.txt<br>/usr/share/doc/haproxy-1.5.18/internals/buffer-operations.txt<br>/usr/share/doc/haproxy-1.5.18/internals/buffer-ops.fig<br>/usr/share/doc/haproxy-1.5.18/internals/connect-status.txt<br>/usr/share/doc/haproxy-1.5.18/internals/connection-header.txt<br>/usr/share/doc/haproxy-1.5.18/internals/connection-scale.txt<br>/usr/share/doc/haproxy-1.5.18/internals/entities.fig<br>/usr/share/doc/haproxy-1.5.18/internals/entities.pdf<br>/usr/share/doc/haproxy-1.5.18/internals/entities.svg<br>/usr/share/doc/haproxy-1.5.18/internals/entities.txt<br>/usr/share/doc/haproxy-1.5.18/internals/hashing.txt<br>/usr/share/doc/haproxy-1.5.18/internals/header-parser-speed.txt<br>/usr/share/doc/haproxy-1.5.18/internals/header-tree.txt<br>/usr/share/doc/haproxy-1.5.18/internals/http-cookies.txt<br>/usr/share/doc/haproxy-1.5.18/internals/http-docs.txt<br>/usr/share/doc/haproxy-1.5.18/internals/http-parsing.txt<br>/usr/share/doc/haproxy-1.5.18/internals/naming.txt<br>/usr/share/doc/haproxy-1.5.18/internals/pattern.dia<br>/usr/share/doc/haproxy-1.5.18/internals/pattern.pdf<br>/usr/share/doc/haproxy-1.5.18/internals/polling-states.fig<br>/usr/share/doc/haproxy-1.5.18/internals/repartition-be-fe-fi.txt<br>/usr/share/doc/haproxy-1.5.18/internals/sequence.fig<br>/usr/share/doc/haproxy-1.5.18/internals/stats-v2.txt<br>/usr/share/doc/haproxy-1.5.18/internals/stream-sock-states.fig<br>/usr/share/doc/haproxy-1.5.18/internals/todo.cttproxy<br>/usr/share/doc/haproxy-1.5.18/lgpl.txt<br>/usr/share/doc/haproxy-1.5.18/proxy-protocol.txt<br>/usr/share/doc/haproxy-1.5.18/queuing.fig<br>/usr/share/haproxy<br>/usr/share/haproxy/400.http<br>/usr/share/haproxy/403.http<br>/usr/share/haproxy/408.http<br>/usr/share/haproxy/500.http<br>/usr/share/haproxy/502.http<br>/usr/share/haproxy/503.http<br>/usr/share/haproxy/504.http<br>/usr/share/haproxy/README<br>/usr/share/man/man1/halog.1.gz<br>/usr/share/man/man1/haproxy.1.gz<br>/var/lib/haproxy<br></code></pre></td></tr></table></figure><p>范例：CentOS 8 安装haproxy</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#yum -y install haproxy</span><br>[root@centos8 ~]<span class="hljs-comment">#haproxy -v</span><br>HA-Proxy version 1.8.15 2018/12/13<br>Copyright 2000-2018 Willy Tarreau &lt;willy@haproxy.org&gt;<br>[root@centos8 ~]<span class="hljs-comment">#haproxy -vv</span><br>HA-Proxy version 1.8.15 2018/12/13<br>Copyright 2000-2018 Willy Tarreau &lt;willy@haproxy.org&gt;<br>Build options :<br>TARGET  = linux2628<br>CPU   = generic<br>CC    = gcc<br>CFLAGS  = -O2 -g -fno-strict-aliasing -Wdeclaration-after-statement -fwrapv -<br>Wno-format-truncation -Wno-null-dereference -Wno-unused-label<br>OPTIONS = USE_LINUX_TPROXY=1 USE_CRYPT_H=1 USE_GETADDRINFO=1 USE_ZLIB=1<br>USE_REGPARM=1 USE_OPENSSL=1 USE_LUA=1 USE_SYSTEMD=1 USE_PCRE=1<br>Default settings :<br>maxconn = 2000, bufsize = 16384, maxrewrite = 1024, maxpollevents = 200<br>Built with OpenSSL version : OpenSSL 1.1.1 FIPS  11 Sep 2018<br>Running on OpenSSL version : OpenSSL 1.1.1c FIPS  28 May 2019<br>OpenSSL library supports TLS extensions : yes<br>OpenSSL library supports SNI : yes<br>OpenSSL library supports : TLSv1.0 TLSv1.1 TLSv1.2 TLSv1.3<br>Built with Lua version : Lua 5.3.4<br>Built with transparent proxy support using: IP_TRANSPARENT IPV6_TRANSPARENT<br>IP_FREEBIND<br>Encrypted password support via crypt(3): yes<br>Built with multi-threading support.<br>Built with PCRE version : 8.42 2018-03-20<br>Running on PCRE version : 8.42 2018-03-20<br>PCRE library supports JIT : no (USE_PCRE_JIT not <span class="hljs-built_in">set</span>)<br>Built with zlib version : 1.2.11<br>Running on zlib version : 1.2.11<br>Compression algorithms supported : identity(<span class="hljs-string">&quot;identity&quot;</span>), deflate(<span class="hljs-string">&quot;deflate&quot;</span>),<br>raw-deflate(<span class="hljs-string">&quot;deflate&quot;</span>), gzip(<span class="hljs-string">&quot;gzip&quot;</span>)<br>Built with network namespace support.<br>Available polling systems :<br>  epoll : pref=300, <span class="hljs-built_in">test</span> result OK<br>   poll : pref=200, <span class="hljs-built_in">test</span> result OK<br>   select : pref=150, <span class="hljs-built_in">test</span> result OK<br>Total: 3 (3 usable), will use epoll.<br>Available filters :<br>[SPOE] spoe<br>[COMP] compression<br>[TRACE] trace<br></code></pre></td></tr></table></figure><h4 id="3-2-2-第三方安装包"><a href="#3-2-2-第三方安装包" class="headerlink" title="3.2.2 第三方安装包"></a>3.2.2 第三方安装包</h4><p>官方没有提供rpm相关的包,可以通过第三方仓库的rpm包<br>从第三方网站下载rpm包：<a href="https://pkgs.org/download/haproxy">https://pkgs.org/download/haproxy</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy17.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy18.png"></p><p>范例：基于互联网第三方仓库在线安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#wget http://www.nosuchhost.net/~cheese/fedora/packages/epel-7/x86_64/cheese-</span><br>release-7-1.noarch.rpm<br><span class="hljs-comment">#rpm -ivh cheese-release-7-1.noarch.rpm</span><br><span class="hljs-comment">#yum install haproxy</span><br><br><span class="hljs-comment">#验证haproxy版本</span><br><span class="hljs-comment"># haproxy -v</span><br>HA-Proxy version 1.8.14-52e4d43 2018/09/20<br>Copyright 2000-2018 Willy Tarreau &lt;willy@haproxy.org&gt;<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy19.png"></p><p>范例：利用第三方 yum 仓库安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#wget https://centos7.iuscommunity.org/ius-release.rpm</span><br>[root@centos7 ~]<span class="hljs-comment">#rpm -Uvh ius-release*rpm</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install epel-release</span><br>[root@centos7 ~]<span class="hljs-comment">#rpm -Uvh ius-release*rpm</span><br>[root@centos7 ~]<span class="hljs-comment">#yum install haproxy18u</span><br>[root@centos7 ~]<span class="hljs-comment">#haproxy -v</span><br>HA-Proxy version 1.8.23 2019/11/25<br>Copyright 2000-2019 Willy Tarreau &lt;willy@haproxy.org&gt;<br></code></pre></td></tr></table></figure><p>范例：下载rpm包离线安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载安装lua库对应的版本</span><br>[root@centos7 ~]<span class="hljs-comment">#wget</span><br>https://dl.iuscommunity.org/pub/ius/stable/CentOS/7/x86_64/lua53u-libs-5.3.4-<br>1.ius.centos7.x86_64.rpm<br><span class="hljs-comment">#安装lua库</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install lua53u-libs-5.3.4-1.ius.centos7.x86_64.rpm</span><br><span class="hljs-comment">#下载haproxy</span><br>[root@centos7 ~]<span class="hljs-comment">#wget</span><br>https://dl.iuscommunity.org/pub/ius/stable/CentOS/7/x86_64/haproxy18u-1.8.20-<br>1.el7.ius.x86_64.rpm<br><span class="hljs-comment">#安装haproxy</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install haproxy18u-1.8.20-1.el7.ius.x86_64.rpm</span><br>[root@centos7 ~]<span class="hljs-comment">#haproxy -v</span><br>HA-Proxy version 1.8.20 2019/04/25<br><br>Copyright 2000-2019 Willy Tarreau &lt;willy@haproxy.org&gt;<br>[root@centos7 ~]<span class="hljs-comment">#systemctl start haproxy</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl status haproxy.service</span><br>● haproxy.service - HAProxy Load Balancer<br> Loaded: loaded (/usr/lib/systemd/system/haproxy.service; disabled; vendor<br>preset: disabled)<br> Active: active (running) since Mon 2020-03-30 21:17:23 CST; 56s ago<br>Process: 1257 ExecStartPre=/usr/sbin/haproxy -f <span class="hljs-variable">$CONFIG</span> -c -q (code=exited,<br>status=0/SUCCESS)<br>Main PID: 1258 (haproxy)<br> CGroup: /system.slice/haproxy.service<br>     ├─1258 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p<br>/run/haproxy.pid<br>     └─1260 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p<br>/run/haproxy.pid<br>Mar 30 21:17:23 centos7.wangxiaochun.com systemd[1]: Starting HAProxy Load<br>Balancer...<br>Mar 30 21:17:23 centos7.wangxiaochun.com systemd[1]: Started HAProxy Load<br>Balancer.<br></code></pre></td></tr></table></figure><h3 id="3-3-编译安装-HAProxy"><a href="#3-3-编译安装-HAProxy" class="headerlink" title="3.3 编译安装 HAProxy"></a>3.3 编译安装 HAProxy</h3><p>编译安装HAProxy 2.0 LTS版本，更多源码包下载地址：<a href="http://www.haproxy.org/download/">http://www.haproxy.org/download/</a></p><h4 id="3-3-1-解决-lua-环境"><a href="#3-3-1-解决-lua-环境" class="headerlink" title="3.3.1 解决 lua 环境"></a>3.3.1 解决 lua 环境</h4><p>HAProxy 支持基于lua实现功能扩展，lua是一种小巧的脚本语言，于1993年由巴西里约热内卢天主教<br>大学（Pontifical Catholic University of Rio de Janeiro）里的一个研究小组开发，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p><p>Lua 官网：<a href="http://www.lua.org/">www.lua.org</a></p><p>Lua 应用场景</p><ul><li><p>游戏开发</p></li><li><p>独立应用脚本</p></li><li><p>Web 应用脚本</p></li><li><p>扩展和数据库插件，如MySQL Proxy</p></li><li><p>安全系统，如入侵检测系统</p></li></ul><h5 id="3-3-1-1-CentOS-基础环境"><a href="#3-3-1-1-CentOS-基础环境" class="headerlink" title="3.3.1.1 CentOS 基础环境"></a>3.3.1.1 CentOS 基础环境</h5><p>参考链接：<a href="http://www.lua.org/start.html">http://www.lua.org/start.html</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy20.png"></p><p>由于CentOS7 之前版本自带的lua版本比较低并不符合HAProxy要求的lua最低版本(5.3)的要求，因此需要编译安装较新版本的lua环境，然后才能编译安装HAProxy，过程如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#当前系统版本</span><br>[root@centos7 ~]<span class="hljs-comment">#lua -v</span><br>Lua 5.1.4 Copyright (C) 1994-2008 Lua.org, PUC-Rio<br><br><span class="hljs-comment">#安装基础命令及编译依赖环境</span><br>[root@centos7 ~]<span class="hljs-comment"># yum install gcc readline-devel -y</span><br>[root@centos7 ~]<span class="hljs-comment"># wget http://www.lua.org/ftp/lua-5.3.5.tar.gz</span><br>[root@centos7 ~]<span class="hljs-comment"># tar xvf lua-5.3.5.tar.gz -C /usr/local/src</span><br>[root@centos7 ~]<span class="hljs-comment"># cd /usr/local/src/lua-5.3.5</span><br>[root@centos7 lua-5.3.5]<span class="hljs-comment"># make linux test</span><br><br><span class="hljs-comment">#查看编译安装的版本</span><br>[root@centos7 lua-5.3.5]<span class="hljs-comment">#src/lua -v</span><br>Lua 5.3.5 Copyright (C) 1994-2018 Lua.org, PUC-Rio<br></code></pre></td></tr></table></figure><h5 id="3-3-1-2-Ubuntu-基础环境"><a href="#3-3-1-2-Ubuntu-基础环境" class="headerlink" title="3.3.1.2 Ubuntu 基础环境"></a>3.3.1.2 Ubuntu 基础环境</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装基础命令及编译依赖环境</span><br><span class="hljs-comment"># apt install gcc iproute2 ntpdate tcpdump telnet traceroute nfs-kernel-</span><br>server nfs-common lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-<br>dev openssh-server libreadline-dev libsystemd-dev<br><br><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># wget http://www.lua.org/ftp/lua-5.3.5.tar.gz</span><br><span class="hljs-comment"># tar xvf lua-5.3.5.tar.gz</span><br><span class="hljs-comment"># cd lua-5.3.5</span><br><span class="hljs-comment"># make linux test</span><br><br><span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/src/lua-5.3.5<br><span class="hljs-comment"># ./src/lua -v</span><br>Lua 5.3.5 Copyright (C) 1994-2018 Lua.org, PUC-Rio<br><span class="hljs-comment">#或安装系统自带的lua</span><br><span class="hljs-comment"># apt install lua5.3=5.3.3-1ubuntu0.18.04.1</span><br><span class="hljs-comment"># lua5.3 -v</span><br>Lua 5.3.3 Copyright (C) 1994-2016 Lua.org, PUC-Rio<br></code></pre></td></tr></table></figure><h4 id="3-3-2-编译安装HAProxy"><a href="#3-3-2-编译安装HAProxy" class="headerlink" title="3.3.2 编译安装HAProxy"></a>3.3.2 编译安装HAProxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#HAProxy 1.8及1.9版本编译参数：</span><br>make  ARCH=x86_64 TARGET=linux2628 USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1<br>USE_SYSTEMD=1  USE_CPU_AFFINITY=1  PREFIX=/usr/<span class="hljs-built_in">local</span>/haproxy<br><br><span class="hljs-comment">#HAProxy 2.0以上版本编译参数：</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install gcc openssl-devel pcre-devel systemd-devel</span><br>[root@centos7 ~]<span class="hljs-comment">#wget http://www.haproxy.org/download/2.0/src/haproxy-2.0.22.tar.gz</span><br>[root@centos7 ~]<span class="hljs-comment">#tar xvf haproxy-2.0.22.tar.gz -C /usr/local/src</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /usr/local/src/haproxy-2.0.22/</span><br><br><span class="hljs-comment">#查看安装方法</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#ll Makefile</span><br>-rw-rw-r-- 1 root root 40812 Feb 12 23:18 Makefile<br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#cat README</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#cat INSTALL</span><br><br><span class="hljs-comment">#参考INSTALL文件进行编译安装</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#make ARCH=x86_64 TARGET=linux-glibc USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1 USE_LUA=1 LUA_INC=/usr/local/src/lua-5.3.5/src/ LUA_LIB=/usr/local/src/lua-5.3.5/src/</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment"># make install PREFIX=/apps/haproxy</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#ln -s /apps/haproxy/sbin/haproxy /usr/sbin/</span><br><br><span class="hljs-comment">#查看生成的文件</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#tree /apps/haproxy/</span><br>/apps/haproxy/<br>├── doc<br>│  └── haproxy<br>│    ├── 51Degrees-device-detection.txt<br>│    ├── architecture.txt<br>│    ├── close-options.txt<br>│    ├── configuration.txt<br>│    ├── cookie-options.txt<br>│    ├── DeviceAtlas-device-detection.txt<br>│    ├── intro.txt<br>│    ├── linux-syn-cookies.txt<br>│    ├── lua.txt<br>│    ├── management.txt<br>│    ├── netscaler-client-ip-insertion-protocol.txt<br>│    ├── network-namespaces.txt<br>│    ├── peers.txt<br>│    ├── peers-v2.0.txt<br>│    ├── proxy-protocol.txt<br>│    ├── regression-testing.txt<br>│    ├── seamless_reload.txt<br>│    ├── SOCKS4.protocol.txt<br>│    ├── SPOE.txt<br>│    └── WURFL-device-detection.txt<br>├── sbin<br>│  └── haproxy<br>└── share<br> └── man<br>   └── man1<br>     └── haproxy.1<br>6 directories, 22 files<br></code></pre></td></tr></table></figure><h4 id="3-3-3-验证HAProxy版本"><a href="#3-3-3-验证HAProxy版本" class="headerlink" title="3.3.3 验证HAProxy版本"></a>3.3.3 验证HAProxy版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#验证HAProxy版本：</span><br>[root@centos7 ~]<span class="hljs-comment">#which haproxy</span><br>/usr/sbin/haproxy<br>[root@centos7 ~]<span class="hljs-comment"># haproxy -v</span><br>HA-Proxy version 2.0.22-d4759ba 2021/04/12 - https://haproxy.org/<br><br><span class="hljs-comment">#大写-V选项显示版本和帮助用法</span><br>[root@centos7 ~]<span class="hljs-comment"># haproxy -V</span><br>HA-Proxy version 2.0.22-d4759ba 2021/04/12 - https://haproxy.org/<br>Usage : haproxy [-f &lt;cfgfile|cfgdir&gt;]* [ -vdVD ] [ -n &lt;maxconn&gt; ] [ -N &lt;maxpconn&gt; ]<br>        [ -p &lt;pidfile&gt; ] [ -m &lt;max megs&gt; ] [ -C &lt;dir&gt; ] [-- &lt;cfgfile&gt;*]<br>        -v displays version ; -vv shows known build options.<br>        -d enters debug mode ; -db only disables background mode.<br>        -dM[&lt;byte&gt;] poisons memory with &lt;byte&gt; (defaults to 0x50)<br>        -V enters verbose mode (disables quiet mode)<br>        -D goes daemon ; -C changes to &lt;dir&gt; before loading files.<br>        -W master-worker mode.<br>        -Ws master-worker mode with systemd notify support.<br>        -q quiet mode : don<span class="hljs-string">&#x27;t display messages</span><br><span class="hljs-string">        -c check mode : only check config files and exit</span><br><span class="hljs-string">        -n sets the maximum total # of connections (uses ulimit -n)</span><br><span class="hljs-string">        -m limits the usable amount of memory (in MB)</span><br><span class="hljs-string">        -N sets the default, per-proxy maximum # of connections (0)</span><br><span class="hljs-string">        -L set local peer name (default to hostname)</span><br><span class="hljs-string">        -p writes pids of all children to this file</span><br><span class="hljs-string">        -de disables epoll() usage even when available</span><br><span class="hljs-string">        -dp disables poll() usage even when available</span><br><span class="hljs-string">        -dS disables splice usage (broken on old kernels)</span><br><span class="hljs-string">        -dG disables getaddrinfo() usage</span><br><span class="hljs-string">        -dR disables SO_REUSEPORT usage</span><br><span class="hljs-string">        -dr ignores server address resolution failures</span><br><span class="hljs-string">        -dV disables SSL verify on servers side</span><br><span class="hljs-string">        -sf/-st [pid ]* finishes/terminates old pids.</span><br><span class="hljs-string">        -x &lt;unix_socket&gt; get listening sockets from a unix socket</span><br><span class="hljs-string">        -S &lt;bind&gt;[,&lt;bind options&gt;...] new master CLI</span><br><span class="hljs-string">    </span><br><span class="hljs-string">[root@centos7 ~]# haproxy -vv</span><br><span class="hljs-string">HA-Proxy version 2.0.22-d4759ba 2021/04/12 - https://haproxy.org/</span><br><span class="hljs-string">Build options :</span><br><span class="hljs-string">  TARGET  = linux-glibc</span><br><span class="hljs-string">  CPU     = generic</span><br><span class="hljs-string">  CC      = gcc</span><br><span class="hljs-string">  CFLAGS  = -m64 -march=x86-64 -O2 -g -fno-strict-aliasing -Wdeclaration-after-statement -fwrapv -Wno-unused-label -Wno-sign-compare -Wno-unused-parameter -Wno-old-style-declaration -Wno-ignored-qualifiers -Wno-clobbered -Wno-missing-field-initializers -Wtype-limits</span><br><span class="hljs-string">  OPTIONS = USE_PCRE=1 USE_OPENSSL=1 USE_LUA=1 USE_ZLIB=1 USE_SYSTEMD=1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Feature list : +EPOLL -KQUEUE -MY_EPOLL -MY_SPLICE +NETFILTER +PCRE -PCRE_JIT -PCRE2 -PCRE2_JIT +POLL -PRIVATE_CACHE +THREAD -PTHREAD_PSHARED -REGPARM -STATIC_PCRE -STATIC_PCRE2 +TPROXY +LINUX_TPROXY +LINUX_SPLICE +LIBCRYPT +CRYPT_H -VSYSCALL +GETADDRINFO +OPENSSL +LUA +FUTEX +ACCEPT4 -CLOSEFROM -MY_ACCEPT4 +ZLIB -SLZ +CPU_AFFINITY +TFO +NS +DL +RT -DEVICEATLAS -51DEGREES -WURFL +SYSTEMD -OBSOLETE_LINKER +PRCTL +THREAD_DUMP -EVPORTS</span><br><span class="hljs-string"></span><br><span class="hljs-string">Default settings :</span><br><span class="hljs-string">  bufsize = 16384, maxrewrite = 1024, maxpollevents = 200</span><br><span class="hljs-string"></span><br><span class="hljs-string">Built with multi-threading support (MAX_THREADS=64, default=1).</span><br><span class="hljs-string">Built with OpenSSL version : OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="hljs-string">Running on OpenSSL version : OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="hljs-string">OpenSSL library supports TLS extensions : yes</span><br><span class="hljs-string">OpenSSL library supports SNI : yes</span><br><span class="hljs-string">OpenSSL library supports : SSLv3 TLSv1.0 TLSv1.1 TLSv1.2</span><br><span class="hljs-string">Built with Lua version : Lua 5.3.5</span><br><span class="hljs-string">Built with network namespace support.</span><br><span class="hljs-string">Built with transparent proxy support using: IP_TRANSPARENT IPV6_TRANSPARENT IP_FREEBIND</span><br><span class="hljs-string">Built with zlib version : 1.2.7</span><br><span class="hljs-string">Running on zlib version : 1.2.7</span><br><span class="hljs-string">Compression algorithms supported : identity(&quot;identity&quot;), deflate(&quot;deflate&quot;), raw-deflate(&quot;deflate&quot;), gzip(&quot;gzip&quot;)</span><br><span class="hljs-string">Built with PCRE version : 8.32 2012-11-30</span><br><span class="hljs-string">Running on PCRE version : 8.32 2012-11-30</span><br><span class="hljs-string">PCRE library supports JIT : no (USE_PCRE_JIT not set)</span><br><span class="hljs-string">Encrypted password support via crypt(3): yes</span><br><span class="hljs-string"></span><br><span class="hljs-string">Available polling systems :</span><br><span class="hljs-string">      epoll : pref=300,  test result OK</span><br><span class="hljs-string">       poll : pref=200,  test result OK</span><br><span class="hljs-string">     select : pref=150,  test result OK</span><br><span class="hljs-string">Total: 3 (3 usable), will use epoll.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Available multiplexer protocols :</span><br><span class="hljs-string">(protocols marked as &lt;default&gt; cannot be specified using &#x27;</span>proto<span class="hljs-string">&#x27; keyword)</span><br><span class="hljs-string">              h2 : mode=HTX        side=FE|BE     mux=H2</span><br><span class="hljs-string">              h2 : mode=HTTP       side=FE        mux=H2</span><br><span class="hljs-string">       &lt;default&gt; : mode=HTX        side=FE|BE     mux=H1</span><br><span class="hljs-string">       &lt;default&gt; : mode=TCP|HTTP   side=FE|BE     mux=PASS</span><br><span class="hljs-string"></span><br><span class="hljs-string">Available services : none</span><br><span class="hljs-string"></span><br><span class="hljs-string">Available filters :</span><br><span class="hljs-string">[SPOE] spoe</span><br><span class="hljs-string">[COMP] compression</span><br><span class="hljs-string">[CACHE] cache</span><br><span class="hljs-string">[TRACE] trace</span><br></code></pre></td></tr></table></figure><h4 id="3-3-4-HAProxy启动文件"><a href="#3-3-4-HAProxy启动文件" class="headerlink" title="3.3.4 HAProxy启动文件"></a>3.3.4 HAProxy启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /usr/lib/systemd/system/haproxy.service</span><br>[Unit]<br>Description=HAProxy Load Balancer<br>After=syslog.target network.target<br><br>[Service]<br>ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg  -c -q<br>ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /var/lib/haproxy/haproxy.pid<br>ExecReload=/bin/<span class="hljs-built_in">kill</span> -USR2 <span class="hljs-variable">$MAINPID</span><br><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment">#默认缺少配置文件，无法启动</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl daemon-reload</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl start haproxy</span><br>Job <span class="hljs-keyword">for</span> haproxy.service failed because the control process exited with error<br>code. See <span class="hljs-string">&quot;systemctl status haproxy.service&quot;</span> and <span class="hljs-string">&quot;journalctl -xe&quot;</span> <span class="hljs-keyword">for</span> details.<br><br>[root@centos7 ~]<span class="hljs-comment">#tail /var/log/messages</span><br>Mar 30 22:28:50 centos7 systemd: haproxy.service: control process exited,<br>code=exited status=1<br>Mar 30 22:28:50 centos7 systemd: Failed to start HAProxy Load Balancer.<br>Mar 30 22:28:50 centos7 systemd: Unit haproxy.service entered failed state.<br>Mar 30 22:28:50 centos7 systemd: haproxy.service failed.<br>Mar 30 22:28:54 centos7 systemd: Starting HAProxy Load Balancer...<br>Mar 30 22:28:54 centos7 haproxy: [ALERT] 089/222854 (28223) : Cannot open<br>configuration file/directory /etc/haproxy/haproxy.cfg : No such file or<br>directory<br>Mar 30 22:28:54 centos7 systemd: haproxy.service: control process exited,<br>code=exited status=1<br>Mar 30 22:28:54 centos7 systemd: Failed to start HAProxy Load Balancer.<br>Mar 30 22:28:54 centos7 systemd: Unit haproxy.service entered failed state.<br>Mar 30 22:28:54 centos7 systemd: haproxy.service failed.<br></code></pre></td></tr></table></figure><h4 id="3-3-5-配置文件"><a href="#3-3-5-配置文件" class="headerlink" title="3.3.5 配置文件"></a>3.3.5 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看配置文件范例</span><br>[root@centos7 ~]<span class="hljs-comment"># tree /usr/local/src/haproxy-2.0.22/examples/</span><br>/usr/<span class="hljs-built_in">local</span>/src/haproxy-2.0.22/examples/<br>├── acl-content-sw.cfg<br>├── content-sw-sample.cfg<br>├── errorfiles<br>│   ├── 400.http<br>│   ├── 403.http<br>│   ├── 408.http<br>│   ├── 500.http<br>│   ├── 502.http<br>│   ├── 503.http<br>│   ├── 504.http<br>│   └── README<br>├── haproxy.init<br>├── option-http_proxy.cfg<br>├── socks4.cfg<br>├── transparent_proxy.cfg<br>└── wurfl-example.cfg<br><br>1 directory, 15 files<br><br><span class="hljs-comment">#创建自定义的配置文件</span><br>[root@centos7 ~]<span class="hljs-comment"># mkdir /etc/haproxy</span><br>[root@centos7 ~]<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>global<br>    maxconn 100000<br>    chroot /apps/haproxy<br>    stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin<br>    <span class="hljs-comment">#uid 99</span><br>    <span class="hljs-comment">#gid 99</span><br>    user haproxy<br>    group haproxy<br>    daemon<br>    <span class="hljs-comment">#nbproc 4</span><br>    <span class="hljs-comment">#cpu-map 1 0</span><br>    <span class="hljs-comment">#cpu-map 2 1</span><br>    <span class="hljs-comment">#cpu-map 3 2</span><br>    <span class="hljs-comment">#cpu-map 4 3</span><br>    pidfile /var/lib/haproxy/haproxy.pid<br>    <span class="hljs-built_in">log</span> 127.0.0.1 local2 info<br><br>defaults<br>    option http-keep-alive<br>    option forwardfor<br>    maxconn 100000<br>    mode http<br>    timeout connect 300000ms<br>    timeout client 300000ms<br>    timeout server 300000ms<br><br>listen stats<br> mode http<br> <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br> stats <span class="hljs-built_in">enable</span><br> <span class="hljs-built_in">log</span> global<br> stats uri     /haproxy-status<br> stats auth    haadmin:123456<br><br>listen web_port<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    server web1 127.0.0.1:8080 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h4 id="3-3-6-启动-haproxy"><a href="#3-3-6-启动-haproxy" class="headerlink" title="3.3.6 启动 haproxy"></a>3.3.6 启动 haproxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#准备socket文件目录</span><br>[root@centos7 ~]<span class="hljs-comment"># mkdir /var/lib/haproxy</span><br><br><span class="hljs-comment">#设置用户和目录权限</span><br>[root@centos7 ~]<span class="hljs-comment"># useradd -r -s /sbin/nologin -d /var/lib/haproxy haproxy</span><br>[root@centos7 ~]<span class="hljs-comment"># systemctl enable --now haproxy</span><br></code></pre></td></tr></table></figure><h4 id="3-3-7-验证-haproxy-状态"><a href="#3-3-7-验证-haproxy-状态" class="headerlink" title="3.3.7 验证 haproxy 状态"></a>3.3.7 验证 haproxy 状态</h4><p>haproxy.cfg文件中定义了chroot、pidfile、user、group等参数，如果系统没有相应的资源会导致<br>haproxy无法启动，具体参考日志文件 /var/log/messages</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#systemctl status haproxy</span><br>● haproxy.service - HAProxy Load Balancer<br> Loaded: loaded (/usr/lib/systemd/system/haproxy.service; disabled; vendor<br>preset: disabled)<br> Active: active (running) since Mon 2020-03-30 20:45:20 CST; 4min 45s ago<br>Process: 1362 ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -c -q<br>(code=exited, status=0/SUCCESS)<br>Main PID: 1363 (haproxy)<br> CGroup: /system.slice/haproxy.service<br>     ├─1363 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p<br>/var/lib/haproxy/haproxy.pid<br>     └─1366 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p<br>/var/lib/haproxy/haproxy.pid<br>Mar 30 20:45:20 centos7.wangxiaochun.com systemd[1]: Starting HAProxy Load<br>Balancer...<br>Mar 30 20:45:20 centos7.wangxiaochun.com systemd[1]: Started HAProxy Load<br>Balancer.<br>Mar 30 20:45:20 centos7.wangxiaochun.com haproxy[1363]: [NOTICE] 089/204520<br>(1363) : New worker <span class="hljs-comment">#1 (1366...ked</span><br>Mar 30 20:45:20 centos7.wangxiaochun.com haproxy[1363]: [WARNING] 089/204520<br>(1366) : Server web_port/we...ue.<br>Mar 30 20:45:20 centos7.wangxiaochun.com haproxy[1363]: [ALERT] 089/204520<br>(1366) : proxy <span class="hljs-string">&#x27;web_port&#x27;</span> has...le!<br>Hint: Some lines were ellipsized, use -l to show <span class="hljs-keyword">in</span> full.<br><br>[root@centos7 ~]<span class="hljs-comment"># pstree -p |grep haproxy</span><br>     |-haproxy(28101)---haproxy(28105)<br></code></pre></td></tr></table></figure><h4 id="3-3-8-查看haproxy的状态页面"><a href="#3-3-8-查看haproxy的状态页面" class="headerlink" title="3.3.8 查看haproxy的状态页面"></a>3.3.8 查看haproxy的状态页面</h4><p>浏览器访问： <a href="http://haproxy-server:9999/haproxy-status">http://haproxy-server:9999/haproxy-status</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy21.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy22.png"></p><h3 id="3-4-基础配置详解"><a href="#3-4-基础配置详解" class="headerlink" title="3.4 基础配置详解"></a>3.4 基础配置详解</h3><p>配置文件官方帮助文档</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy23.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy24.png"></p><p>官方文档：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://cbonte.github.io/haproxy-dconv/ <span class="hljs-comment">#每个版本都可能会有参数发生变化，使用其他版本的时候要查看官方文档</span><br>http://cbonte.github.io/haproxy-dconv/2.1/configuration.html<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy25.png"></p><p>HAProxy 的配置文件haproxy.cfg由两大部分组成，分别是global和proxies部分</p><ul><li>global：全局配置段</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">进程及安全配置相关的参数<br>性能调整相关参数<br>Debug参数<br></code></pre></td></tr></table></figure><ul><li>proxies：代理配置段</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">defaults：为frontend, backend, listen提供默认配置<br>frontend：前端，相当于nginx中的server &#123;&#125;<br>backend：后端，相当于nginx中的upstream &#123;&#125;<br>listen：同时拥有前端和后端配置,配置简单,生产推荐使用<br></code></pre></td></tr></table></figure><h4 id="3-4-1-global配置"><a href="#3-4-1-global配置" class="headerlink" title="3.4.1 global配置"></a>3.4.1 global配置</h4><h5 id="3-4-1-1-global-配置参数说明"><a href="#3-4-1-1-global-配置参数说明" class="headerlink" title="3.4.1.1 global 配置参数说明"></a>3.4.1.1 global 配置参数说明</h5><p>官方文档：<a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#3">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#3</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">chroot <span class="hljs-comment">#锁定运行目录</span><br>deamon <span class="hljs-comment">#以守护进程运行</span><br>stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin process 1 <span class="hljs-comment">#socket文件</span><br>user, group, uid, gid  <span class="hljs-comment">#运行haproxy的用户身份</span><br>nbproc  n <span class="hljs-comment">#开启的haproxy work 进程数，默认进程数是一个</span><br><span class="hljs-comment">#nbthread 1 #和多进程 nbproc配置互斥（版本有关,CentOS8的haproxy1.8无此问题）,指定每个haproxy进程开启的线程数，默认为每个进程一个线程</span><br><span class="hljs-comment">#如果同时启用nbproc和nbthread 会出现以下日志的错误，无法启动服务</span><br>Apr  7 14:46:23 haproxy haproxy: [ALERT] 097/144623 (1454) : config : cannot<br><span class="hljs-built_in">enable</span> multiple processes <span class="hljs-keyword">if</span> multiple threads are configured. Please use either<br>nbproc or nbthread but not both.<br><br>cpu-map 1 0  <span class="hljs-comment">#绑定haproxy worker 进程至指定CPU，将第1个work进程绑定至0号CPU</span><br>cpu-map 2 1   <span class="hljs-comment">#绑定haproxy worker 进程至指定CPU，将第2个work进程绑定至1 号CPU</span><br><br>maxconn n  <span class="hljs-comment">#每个haproxy进程的最大并发连接数</span><br>maxsslconn n  <span class="hljs-comment">#每个haproxy进程ssl最大连接数,用于haproxy配置了证书的场景下</span><br>maxconnrate n  <span class="hljs-comment">#每个进程每秒创建的最大连接数量</span><br>spread-checks n <span class="hljs-comment">#后端server状态check随机提前或延迟百分比时间，建议2-5(20%-50%)之间，默认值0</span><br>pidfile <span class="hljs-comment">#指定pid文件路径</span><br><span class="hljs-built_in">log</span> 127.0.0.1 local2 info <span class="hljs-comment">#定义全局的syslog服务器；日志服务器需要开启UDP协议，最多可以定义两个</span><br></code></pre></td></tr></table></figure><h5 id="3-4-1-2-多进程和线程"><a href="#3-4-1-2-多进程和线程" class="headerlink" title="3.4.1.2 多进程和线程"></a>3.4.1.2 多进程和线程</h5><p>范例：多进程和socket文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br>global<br>maxconn 100000<br>chroot /apps/haproxy<br>stats socket /var/lib/haproxy/haproxy.sock1 mode 600 level admin process 1   <br>stats socket /var/lib/haproxy/haproxy.sock2 mode 600 level admin process 2<br>uid 99<br>gid 99<br>daemon<br>nbproc 2<br><br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart haproxy</span><br>[root@centos7 ~]<span class="hljs-comment">#pstree -p |grep haproxy</span><br>     |-haproxy(2634)-+-haproxy(2637)<br>     |        `-haproxy(2638)<br>[root@centos7 ~]<span class="hljs-comment">#ll /var/lib/haproxy/</span><br>total 4<br>-rw-r--r-- 1 root root 5 Mar 31 18:49 haproxy.pid<br>srw------- 1 root root 0 Mar 31 18:49 haproxy.sock1<br>srw------- 1 root root 0 Mar 31 18:49 haproxy.sock2<br></code></pre></td></tr></table></figure><h5 id="3-4-1-3-HAProxy日志配置"><a href="#3-4-1-3-HAProxy日志配置" class="headerlink" title="3.4.1.3 HAProxy日志配置"></a>3.4.1.3 HAProxy日志配置</h5><p>HAproxy本身不记录客户端的访问日志.此外为减少服务器负载,一般生产中HAProxy不记录日志，记录日志交给后端服务器。<br>也可以配置HAProxy利用rsyslog服务记录日志到指定日志文件中</p><h6 id="3-4-1-3-1-HAProxy配置"><a href="#3-4-1-3-1-HAProxy配置" class="headerlink" title="3.4.1.3.1 HAProxy配置"></a>3.4.1.3.1 HAProxy配置</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在global配置项定义：</span><br><span class="hljs-built_in">log</span> 127.0.0.1 <span class="hljs-built_in">local</span>&#123;1-7&#125; info <br><span class="hljs-comment">#基于syslog记录日志到指定设备，级别有(err、warning、info、debug) </span><br><span class="hljs-comment">#ip地址里如果换成其他后端服务器地址就会将日志发送到其他后端服务器里</span><br><br>listen web_port<br><span class="hljs-built_in">bind</span> 127.0.0.1:80<br>mode http<br><span class="hljs-built_in">log</span> global <span class="hljs-comment">#开启当前web_port的日志功能，默认不记录日志</span><br>server web1  127.0.0.1:8080 check inter 3000 fall 2 rise 5<br><br><span class="hljs-comment"># systemctl restart haproxy</span><br></code></pre></td></tr></table></figure><h6 id="3-4-1-3-2-Rsyslog配置"><a href="#3-4-1-3-2-Rsyslog配置" class="headerlink" title="3.4.1.3.2 Rsyslog配置"></a>3.4.1.3.2 Rsyslog配置</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/rsyslog.conf<br><span class="hljs-variable">$ModLoad</span> imudp<br><span class="hljs-variable">$UDPServerRun</span> 514<br>......<br>local3.*  /var/<span class="hljs-built_in">log</span>/haproxy.log<br>......<br><br><span class="hljs-comment"># systemctl restart rsyslog</span><br></code></pre></td></tr></table></figure><h6 id="3-4-1-3-3-验证HAProxy日志"><a href="#3-4-1-3-3-验证HAProxy日志" class="headerlink" title="3.4.1.3.3 验证HAProxy日志"></a>3.4.1.3.3 验证HAProxy日志</h6><p>重启syslog服务并访问app页面，然后验证是否生成日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># tail -f /var/log/haproxy.log</span><br>Aug 14 20:21:06 localhost haproxy[18253]: Connect from 192.168.0.1:3050 to<br>10.0.0.7:80 (web_host/HTTP)<br>Aug 14 20:21:06 localhost haproxy[18253]: Connect from 192.168.0.1:3051 to<br>10.0.0.7:80 (web_host/HTTP)<br>Aug 14 20:21:06 localhost haproxy[18253]: Connect from 192.168.0.1:3050 to<br>10.0.0.7:80 (web_host/HTTP)<br></code></pre></td></tr></table></figure><h6 id="3-4-1-3-4-实战案例：启动本地和远程日志"><a href="#3-4-1-3-4-实战案例：启动本地和远程日志" class="headerlink" title="3.4.1.3.4 实战案例：启动本地和远程日志"></a>3.4.1.3.4 实战案例：启动本地和远程日志</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br><span class="hljs-built_in">log</span> 127.0.0.1 local2 info<br><span class="hljs-built_in">log</span> 10.0.0.8 local2 info<br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart haproxy</span><br><span class="hljs-comment">#开启本地日志</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/rsyslog.conf</span><br><span class="hljs-variable">$ModLoad</span> imudp<br><span class="hljs-variable">$UDPServerRun</span> 514<br>......<br>local2.*                    /var/<span class="hljs-built_in">log</span>/haproxy.log<br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart rsyslog</span><br><br><span class="hljs-comment">#开启远程主机日志</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/rsyslog.conf</span><br>module(load=<span class="hljs-string">&quot;imudp&quot;</span>) <span class="hljs-comment"># needs to be done just once </span><br>input(<span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;imudp&quot;</span> port=<span class="hljs-string">&quot;514&quot;</span>)<br>local3.*          /var/<span class="hljs-built_in">log</span>/haproxy.log<br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart rsyslog</span><br><br><span class="hljs-comment">#浏览器访问：http://haproxy-server:9999/haproxy-status,观察本机和远程主机生成的日志</span><br>[root@centos7 ~]<span class="hljs-comment">#tail /var/log/haproxy.log</span><br>[root@centos7 ~]<span class="hljs-comment">#cat /var/log/haproxy.log</span><br>Mar 30 23:42:52 localhost haproxy[28643]: Connect from 10.0.0.1:7820 to<br>10.0.0.7:9999 (stats/HTTP)<br>Mar 30 23:42:52 localhost haproxy[28643]: Connect from 10.0.0.1:7821 to<br>10.0.0.7:9999 (stats/HTTP)<br>Mar 30 23:42:53 localhost haproxy[28643]: Connect from 10.0.0.1:7822 to<br>10.0.0.7:9999 (stats/HTTP)<br><br>[root@centos8 ~]<span class="hljs-comment">#tail /var/log/haproxy.log</span><br>Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7824 to<br>10.0.0.7:9999 (stats/HTTP)<br>Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7825 to<br>10.0.0.7:9999 (stats/HTTP)<br>Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7826 to<br>10.0.0.7:9999 (stats/HTTP)<br>Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7827 to<br>10.0.0.7:9999 (stats/HTTP)<br></code></pre></td></tr></table></figure><h4 id="3-4-2-Proxies配置"><a href="#3-4-2-Proxies配置" class="headerlink" title="3.4.2 Proxies配置"></a>3.4.2 Proxies配置</h4><p>官方文档：<a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">defaults [&lt;name&gt;] <span class="hljs-comment">#默认配置项，针对以下的frontend、backend和listen生效，可以多个name也可以没有name</span><br>frontend &lt;name&gt;  <span class="hljs-comment">#前端servername，类似于Nginx的一个虚拟主机 server和LVS服务集群。</span><br>backend &lt;name&gt;  <span class="hljs-comment">#后端服务器组，等于nginx的upstream和LVS中的RS服务器</span><br>listen  &lt;name&gt;  <span class="hljs-comment">#将frontend和backend合并在一起配置，相对于frontend和backend配置更简洁，生产常用</span><br></code></pre></td></tr></table></figure><p>注意：name字段只能使用大小写字母，数字，‘-’(dash)，’_‘(underscore)，’.’ (dot)和 ‘:’(colon)，并且严格区分大小写</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy26.png"></p><h5 id="3-4-2-1-Proxies配置-defaults"><a href="#3-4-2-1-Proxies配置-defaults" class="headerlink" title="3.4.2.1 Proxies配置-defaults"></a>3.4.2.1 Proxies配置-defaults</h5><p>defaults 配置参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">option redispatch   <span class="hljs-comment">#当server Id对应的服务器挂掉后，强制定向到其他健康的服务器，重新派发，默认开启</span><br>option abortonclose  <span class="hljs-comment">#当服务器负载很高时，自动结束掉当前队列处理比较久的连接，针对业务情况选择开启</span><br>option http-keep-alive <span class="hljs-comment">#开启与客户端的会话保持</span><br>option forwardfor   <span class="hljs-comment">#透传客户端真实IP至后端web服务器</span><br>mode http|tcp <span class="hljs-comment">#设置默认工作类型,使用TCP服务器性能更好，减少压力</span><br>timeout http-keep-alive 120s <span class="hljs-comment">#session 会话保持超时时间，此时间段内会转发到相同的后端服务器</span><br>timeout connect 120s <span class="hljs-comment">#客户端请求从haproxy到后端server最长连接等待时间(TCP连接之前)，默认单位ms</span><br>timeout server 600s <span class="hljs-comment">#客户端请求从haproxy到后端服务端的请求处理超时时长(TCP连接之后)，默认单位ms，如果超时，会出现502错误，此值建议设置较大些（根据业务设置），访止502错误</span><br>timeout client 600s <span class="hljs-comment">#设置haproxy与客户端的最长非活动时间，默认单位ms，建议和timeout server相同</span><br>timeout check  5s  <span class="hljs-comment">#对后端服务器的默认检测超时时间</span><br>default-server inter 1000 weight 3  <span class="hljs-comment">#指定后端服务器的默认设置</span><br></code></pre></td></tr></table></figure><h5 id="3-4-2-2-Proxies配置-listen-简化配置"><a href="#3-4-2-2-Proxies配置-listen-简化配置" class="headerlink" title="3.4.2.2 Proxies配置-listen 简化配置"></a>3.4.2.2 Proxies配置-listen 简化配置</h5><p>使用listen替换 frontend和backend的配置方式，可以简化设置，通常只用于TCP协议的应用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#官网业务访问入口</span><br>listen WEB_PORT_80<br> <span class="hljs-built_in">bind</span> 10.0.0.7:80 <br> mode http<br> option forwardfor<br> server web1  10.0.0.17:8080  check inter 3000 fall 3 rise 5<br> server web2  10.0.0.27:8080  check inter 3000 fall 3 rise 5<br></code></pre></td></tr></table></figure><p><strong>实例：</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy56.png" alt="架构图"></p><p>注意点：</p><ul><li>web1和web2网关不需要指向haproxy。因为使用ngixn作为反向代理的时候web服务器的网关也没有指向nginx</li><li>haproxy不需要ip_forward。因为haproxy仅仅是代理，而不像lvs那样做转发，因此不需要开启（根据需求开）</li></ul><table><thead><tr><th align="center">IP</th><th align="center">服务器名称</th><th align="center">作用</th></tr></thead><tbody><tr><td align="center">172.16.0.200/16</td><td align="center">internet</td><td align="center">用户访问机（仅主机模式）</td></tr><tr><td align="center">172.16.0.100/16</td><td align="center">haproxy</td><td align="center">haproxy服务器（eth1，仅主机模式）</td></tr><tr><td align="center">10.0.0.7/16</td><td align="center">haproxy</td><td align="center">haproxy服务器（eth0）</td></tr><tr><td align="center">10.0.0.17</td><td align="center">web1</td><td align="center">web服务器</td></tr><tr><td align="center">10.0.0.27</td><td align="center">web2</td><td align="center">web服务器</td></tr></tbody></table><p><strong>环境部署</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#internet服务器操作</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>PROXY_METHOD=<span class="hljs-string">&quot;none&quot;</span><br>BROWSER_ONLY=<span class="hljs-string">&quot;no&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=172.16.0.200 <span class="hljs-comment">#修改ip地址</span><br>DEFROUTE=<span class="hljs-string">&quot;yes&quot;</span><br>IPV4_FAILURE_FATAL=<span class="hljs-string">&quot;no&quot;</span><br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>UUID=<span class="hljs-string">&quot;e4085f99-fd7e-4239-9992-2dc837a3d5e2&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>IPV6_PRIVACY=<span class="hljs-string">&quot;no&quot;</span><br>NETMASK=255.255.0.0<br>DNS1=223.5.5.5<br>[root@centos7 ~]<span class="hljs-comment"># systemctl restart network</span><br><br><span class="hljs-comment">#haproxy服务器操作</span><br>[root@haproxy ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth1</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=172.16.0.100<br>NAME=<span class="hljs-string">&quot;eth1&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth1&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>PREFIX=16<br>[root@haproxy ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@haproxy ~]<span class="hljs-comment"># nmcli connection reload</span><br>[root@haproxy ~]<span class="hljs-comment"># nmcli connection </span><br>[root@haproxy ~]<span class="hljs-comment"># nmcli connection delete Wired\ connection\ 1</span><br>[root@haproxy ~]<span class="hljs-comment"># nmcli connection </span><br>NAME  UUID                                  TYPE            DEVICE <br>eth0  e4085f99-fd7e-4239-9992-2dc837a3d5e2  802-3-ethernet  eth0   <br>eth1  9c92fad9-6ecb-3e6c-eb4d-8a47c6f50c04  802-3-ethernet  eth1<br>[root@haproxy ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000<br>    link/ether 00:0c:29:1a:45:e7 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.7/24 brd 10.0.0.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::40d2:a76f:ddbe:7372/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000<br>    link/ether 00:0c:29:1a:45:f1 brd ff:ff:ff:ff:ff:ff<br>    inet 172.16.0.100/16 brd 172.16.255.255 scope global eth1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe1a:45f1/64 scope link <br>       valid_lft forever preferred_lft forever<br>       <br><span class="hljs-comment">#web1服务器操作</span><br>[root@web1 ~]<span class="hljs-comment"># yum install -y httpd;systemctl enable --now httpd;hostname &gt; /var/www/html/index.html</span><br>[root@web2 ~]<span class="hljs-comment"># yum install -y httpd;systemctl enable --now httpd;hostname &gt; /var/www/html/index.html</span><br><br><span class="hljs-comment">#测试web服务器</span><br>[root@haproxy ~]<span class="hljs-comment"># curl 10.0.0.17</span><br>web1<br>[root@haproxy ~]<span class="hljs-comment"># curl 10.0.0.27</span><br>web2<br></code></pre></td></tr></table></figure><p><strong>安装软件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#haproxy编译安装haproxy，过程略</span><br><br><span class="hljs-comment">#修改haproxy配置文件</span><br>[root@haproxy ~]<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>global<br>    maxconn 100000<br>    chroot /apps/haproxy<br>    <span class="hljs-comment">#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin</span><br>    stats socket /var/lib/haproxy/haproxy.sock1 mode 600 level admin process 1<br>    stats socket /var/lib/haproxy/haproxy.sock2 mode 600 level admin process 2<br>    <span class="hljs-comment">#uid 99</span><br>    <span class="hljs-comment">#gid 99</span><br>    user haproxy<br>    group haproxy<br>    daemon<br>    <span class="hljs-comment">#nbproc 4</span><br>    <span class="hljs-comment">#cpu-map 1 0</span><br>    <span class="hljs-comment">#cpu-map 2 1</span><br>    <span class="hljs-comment">#cpu-map 3 2</span><br>    <span class="hljs-comment">#cpu-map 4 3</span><br>    pidfile /var/lib/haproxy/haproxy.pid<br>    <span class="hljs-built_in">log</span> 127.0.0.1 local2 info<br><br>defaults<br>    option http-keep-alive<br>    option forwardfor<br>    maxconn 100000<br>    mode http<br>    timeout connect 300000ms<br>    timeout client 300000ms<br>    timeout server 300000ms<br><br>listen stats<br> mode http<br> <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br> stats <span class="hljs-built_in">enable</span><br> <span class="hljs-built_in">log</span> global<br> stats uri     /haproxy-status<br> stats auth    haadmin:123456<br><br>listen web_80_port<br>    <span class="hljs-built_in">bind</span> 172.16.0.100:80<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    server web1 10.0.0.17:80 check inter 3000 fall 3 rise 3<br>    server web2 10.0.0.27:80 check inter 3000 fall 3 rise 3<br><br>[root@haproxy ~]<span class="hljs-comment"># systemctl reload haproxy</span><br><br><span class="hljs-comment">#进入haproxy-status页面就会出现web1和web2这两行</span><br><br><span class="hljs-comment">#internal测试</span><br>[root@centos7 ~]<span class="hljs-comment"># curl 172.16.0.100</span><br>web1<br>[root@centos7 ~]<span class="hljs-comment"># curl 172.16.0.100</span><br>web2<br>[root@centos7 ~]<span class="hljs-comment"># curl 172.16.0.100</span><br>web1<br>[root@centos7 ~]<span class="hljs-comment"># curl 172.16.0.100</span><br>web2<br></code></pre></td></tr></table></figure><h5 id="3-4-2-3-Proxies配置-frontend"><a href="#3-4-2-3-Proxies配置-frontend" class="headerlink" title="3.4.2.3 Proxies配置-frontend"></a>3.4.2.3 Proxies配置-frontend</h5><p><strong>frontend 配置参数：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">bind</span>： <span class="hljs-comment">#指定HAProxy的监听地址，可以是IPV4或IPV6，可以同时监听多个IP或端口，可同时用于listen字段中</span><br><span class="hljs-comment">#格式：</span><br><span class="hljs-built_in">bind</span> [&lt;address&gt;]:&lt;port_range&gt; [, ...] [param*]<br><span class="hljs-comment">#注意：如果需要绑定在非本机的IP，需要开启内核参数：net.ipv4.ip_nonlocal_bind=1</span><br>backlog &lt;backlog&gt; <span class="hljs-comment">#针对所有server配置,当前端服务器的连接数达到上限后的后援队列长度，注意：不支持backend</span><br>4313<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen http_proxy <span class="hljs-comment">#监听http的多个IP的多个端口和sock文件</span><br>    <span class="hljs-built_in">bind</span> :80,:443,:8801-8810<br> <span class="hljs-built_in">bind</span> 10.0.0.1:10080,10.0.0.1:10443<br> <span class="hljs-built_in">bind</span> /var/run/ssl-frontend.sock user root mode 600 accept-proxy<br> <br>listen http_https_proxy <span class="hljs-comment">#https监听</span><br> <span class="hljs-built_in">bind</span> :80<br> <span class="hljs-built_in">bind</span> :443 ssl crt /etc/haproxy/site.pem <span class="hljs-comment">#公钥和私钥公共文件</span><br> <br>listen http_https_proxy_explicit <span class="hljs-comment">#监听ipv6、ipv4和unix sock文件</span><br> <span class="hljs-built_in">bind</span> ipv6@:80<br> <span class="hljs-built_in">bind</span> ipv4@public_ssl:443 ssl crt /etc/haproxy/site.pem<br> <span class="hljs-built_in">bind</span> unix@ssl-frontend.sock user root mode 600 accept-proxy<br> <br>listen external_bind_app1 <span class="hljs-comment">#监听file descriptor</span><br> <span class="hljs-built_in">bind</span> <span class="hljs-string">&quot;fd@<span class="hljs-variable">$&#123;FD_APP1&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure><p>生产示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">frontend magedu_web_port <span class="hljs-comment">#可以采用后面形式命名：业务-服务-端口号</span><br>    <span class="hljs-built_in">bind</span> :80,:8080<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:10080,:8801-8810,10.0.0.17:9001-9010<br>    mode http|tcp   <span class="hljs-comment">#指定负载协议类型</span><br>    use_backend &lt;backend_name&gt;  <span class="hljs-comment">#调用的后端服务器组名称</span><br></code></pre></td></tr></table></figure><h5 id="3-4-2-4-Proxies配置-backend"><a href="#3-4-2-4-Proxies配置-backend" class="headerlink" title="3.4.2.4 Proxies配置-backend"></a>3.4.2.4 Proxies配置-backend</h5><p>定义一组后端服务器，backend服务器将被frontend进行调用。<br>注意: backend 的名称必须唯一,并且必须在listen或frontend中事先定义才可以使用,否则服务无法启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">mode http|tcp   <span class="hljs-comment">#指定负载协议类型,和对应的frontend必须一致</span><br>option <span class="hljs-comment">#配置选项</span><br>server  <span class="hljs-comment">#定义后端real server,必须指定IP和端口</span><br></code></pre></td></tr></table></figure><p>注意：option后面加 httpchk，smtpchk,mysql-check,pgsql-check，ssl-hello-chk方法，可用于实现更多应用层检测功能。<br><strong>server 配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#针对一个server配置</span><br>check <span class="hljs-comment">#对指定real进行健康状态检查，如果不加此设置，默认不开启检查,只有check后面没有其它配置也可以启用检查功能</span><br><span class="hljs-comment">#默认对相应的后端服务器IP和端口,利用TCP连接进行周期性健康性检查（其实就是利用tcp的握手方式来检查）,注意必须指定端口才能实现健康性检查</span><br>addr &lt;IP&gt;  <span class="hljs-comment">#可指定的健康状态监测IP，可以是专门的数据网段，减少业务网络的流量</span><br>port &lt;num&gt; <span class="hljs-comment">#指定的健康状态监测端口</span><br>inter &lt;num&gt; <span class="hljs-comment">#健康状态检查间隔时间，默认2000 ms</span><br>fall &lt;num&gt;  <span class="hljs-comment">#后端服务器从线上转为线下的检查的连续失效次数，默认为3</span><br>rise &lt;num&gt;  <span class="hljs-comment">#后端服务器从下线恢复上线的检查的连续有效次数，默认为2</span><br>weight &lt;weight&gt; <span class="hljs-comment">#默认为1，最大值为256，0(状态为蓝色)表示不参与负载均衡（相当于服务器下线了），但仍接受持久连接</span><br>backup <span class="hljs-comment">#将后端服务器标记为备份状态,只在所有非备份主机down机时提供服务，类似Sorry Server</span><br>disabled <span class="hljs-comment">#将后端服务器标记为不可用状态，即维护状态，除了持久模式，将不再接受连接,状态为深黄色</span><br>redirect prefix http://www.baidu.com/ <span class="hljs-comment">#将请求临时(302)重定向至其它URL，只适用于http模式</span><br>redir http://www.baidu.com    <span class="hljs-comment">#将请求临时(302)重定向至其它URL，只适用于http模式</span><br>maxconn &lt;maxconn&gt; <span class="hljs-comment">#当前后端server的最大并发连接数</span><br></code></pre></td></tr></table></figure><h5 id="3-4-2-5-frontend-backend-配置实例"><a href="#3-4-2-5-frontend-backend-配置实例" class="headerlink" title="3.4.2.5 frontend+backend 配置实例"></a>3.4.2.5 frontend+backend 配置实例</h5><p>范例1：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">frontend magedu-test-http<br>    <span class="hljs-built_in">bind</span> :80,:8080<br>    mode tcp<br>    use_backend magedu-test-http-nodes<br><br>backend magedu-test-http-nodes<br>    mode tcp<br>    default-server inter 1000 weight 6 <br>    server web1 10.0.0.17:80 weight 2 check addr 10.0.0.117 port 8080<br>    server web1 10.0.0.27:80 check<br></code></pre></td></tr></table></figure><p>范例2：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#官网业务访问入口</span><br>frontend WEB_PORT_80<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    use_backend web_prot_http_nodes<br> <br>backend web_prot_http_nodes<br>    mode http<br>    option forwardfor<br>    server 10.0.0.17 10.0.0.17:8080  check inter 3000 fall 3 rise 5 <br>    server 10.0.0.27 10.0.0.27:8080  check inter 3000 fall 3 rise 5<br></code></pre></td></tr></table></figure><h4 id="3-4-3-使用子配置文件保存配置"><a href="#3-4-3-使用子配置文件保存配置" class="headerlink" title="3.4.3 使用子配置文件保存配置"></a>3.4.3 使用子配置文件保存配置</h4><p>当业务众多时，将所有配置都放在一个配置文件中，会造成维护困难。可以考虑按业务分类，将配置信息拆分，放在不同的子配置文件中，从而达到方便维护的目的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建子配置目录</span><br>[root@centos7 ~]<span class="hljs-comment">#mkdir /etc/haproxy/conf.d/</span><br><br><span class="hljs-comment">#创建子配置文件，注意：必须为cfg后缀非.开头的配置文件</span><br>[root@centos7 ~]<span class="hljs-comment">#vim  /etc/haproxy/conf.d/test.cfg</span><br>listen WEB_PORT_80<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    balance roundrobin<br>    server web1  10.0.0.17:80 check inter 3000 fall 2 rise 5<br>    server web2  10.0.0.27:80 check inter 3000 fall 2 rise 5<br><br><span class="hljs-comment">#添加子配置目录到unit文件中</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /lib/systemd/system/haproxy.service</span><br>[Unit]<br>Description=HAProxy Load Balancer<br>After=syslog.target network.target<br><br>[Service]<br><span class="hljs-comment">#修改下面两行</span><br>ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf.d/  -c -q<br>ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf.d/  -p /var/lib/haproxy/haproxy.pid<br>ExecReload=/bin/<span class="hljs-built_in">kill</span> -USR2 <span class="hljs-variable">$MAINPID</span><br><br>[Install]<br>WantedBy=multi-user.target<br><br>[root@centos7 ~]<span class="hljs-comment">#systemctl daemon-reload</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart haproxy</span><br></code></pre></td></tr></table></figure><h2 id="四、HAProxy调度算法"><a href="#四、HAProxy调度算法" class="headerlink" title="四、HAProxy调度算法"></a>四、HAProxy调度算法</h2><p>HAProxy通过固定参数 balance 指明对后端服务器的调度算法，该参数可以配置在listen或backend选<br>项中。<br>HAProxy的调度算法分为静态和动态调度算法，但是有些算法可以根据参数在静态和动态算法中相互转换。<br>官方文档：<a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-balance">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-balance</a></p><h3 id="4-1-静态算法"><a href="#4-1-静态算法" class="headerlink" title="4.1 静态算法"></a>4.1 静态算法</h3><p>静态算法：按照事先定义好的规则轮询公平调度，不关心后端服务器的当前负载、连接数和响应速度<br>等，且无法实时修改权重(只能为0和1,不支持其它值)，只能靠重启HAProxy生效。</p><h4 id="4-1-1-socat-工具"><a href="#4-1-1-socat-工具" class="headerlink" title="4.1.1 socat 工具"></a>4.1.1 socat 工具</h4><p>对服务器动态权重和其它状态可以利用 socat工具进行调整，Socat 是 Linux 下的一个多功能的网络工<br>具，名字来由是Socket CAT，相当于netCAT的增强版.Socat 的主要特点就是在两个数据流之间建立双<br>向通道，且支持众多协议和链接方式。如 IP、TCP、 UDP、IPv6、Socket文件等<br>范例：利用工具socat 对服务器动态权重调整</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#yum -y install socat</span><br><br><span class="hljs-comment">#查看帮助</span><br>[root@centos7 ~]<span class="hljs-comment">#socat -h</span><br>[root@centos7 ~]<span class="hljs-comment">#echo &quot;help&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>Unknown <span class="hljs-built_in">command</span>. Please enter one of the following commands only :<br><span class="hljs-built_in">help</span>      : this message<br>prompt     : toggle interactive mode with prompt<br>quit      : disconnect<br>show tls-keys [id|*]: show tls keys references or dump tls ticket keys when id<br>specified<br> <span class="hljs-built_in">set</span> ssl tls-key [id|keyfile] &lt;tlskey&gt;: <span class="hljs-built_in">set</span> the next TLS key <span class="hljs-keyword">for</span> the &lt;id&gt; or<br>&lt;keyfile&gt; listener to &lt;tlskey&gt;<br> <span class="hljs-built_in">set</span> ssl cert &lt;certfile&gt; &lt;payload&gt; : replace a certificate file<br>commit ssl cert &lt;certfile&gt; : commit a certificate file<br>abort ssl cert &lt;certfile&gt; : abort a transaction <span class="hljs-keyword">for</span> a certificate file<br>show sess [id] : report the list of current sessions or dump this session<br>shutdown session : <span class="hljs-built_in">kill</span> a specific session<br>shutdown sessions server : <span class="hljs-built_in">kill</span> sessions on a server<br> clear counters : clear max statistics counters (add <span class="hljs-string">&#x27;all&#x27;</span> <span class="hljs-keyword">for</span> all counters)<br>show info   : report information about the running process<br>[desc|json|typed]*<br>show <span class="hljs-built_in">stat</span>   : report counters <span class="hljs-keyword">for</span> each proxy and server [desc|json|typed]*<br>show schema json : report schema used <span class="hljs-keyword">for</span> stats<br><span class="hljs-built_in">disable</span> agent : <span class="hljs-built_in">disable</span> agent checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br><span class="hljs-built_in">disable</span> health : <span class="hljs-built_in">disable</span> health checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br><span class="hljs-built_in">disable</span> server : <span class="hljs-built_in">disable</span> a server <span class="hljs-keyword">for</span> maintenance (use <span class="hljs-string">&#x27;set server&#x27;</span> instead) <span class="hljs-comment">#禁用服务器</span><br><span class="hljs-built_in">enable</span> agent  : <span class="hljs-built_in">enable</span> agent checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br><span class="hljs-built_in">enable</span> health : <span class="hljs-built_in">enable</span> health checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br><span class="hljs-built_in">enable</span> server : <span class="hljs-built_in">enable</span> a disabled server (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)  <span class="hljs-comment">#启用服务器</span><br> <span class="hljs-built_in">set</span> maxconn server : change a server<span class="hljs-string">&#x27;s maxconn setting</span><br><span class="hljs-string"> set server   : change a server&#x27;</span>s state, weight or address      <span class="hljs-comment">#设置服务器</span><br> get weight   : report a server<span class="hljs-string">&#x27;s current weight</span><br><span class="hljs-string"> set weight   : change a server&#x27;</span>s weight (deprecated)<br>show startup-logs : report logs emitted during HAProxy startup<br>show peers [peers section]: dump some information about all the peers or this<br>peers section<br> <span class="hljs-built_in">set</span> maxconn global : change the per-process maxconn setting<br> <span class="hljs-built_in">set</span> rate-limit : change a rate limiting value<br> <span class="hljs-built_in">set</span> severity-output [none|number|string] : <span class="hljs-built_in">set</span> presence of severity level <span class="hljs-keyword">in</span><br>feedback information<br> <span class="hljs-built_in">set</span> timeout  : change a timeout setting<br>show env [var] : dump environment variables known to the process<br>show cli sockets : dump list of cli sockets<br>show cli level  : display the level of the current CLI session<br>show fd [num] : dump list of file descriptors <span class="hljs-keyword">in</span> use<br>show activity : show per-thread activity stats (<span class="hljs-keyword">for</span> support/developers)<br>operator    : lower the level of the current CLI session to operator<br>user      : lower the level of the current CLI session to user<br> clear table  : remove an entry from a table<br> <span class="hljs-built_in">set</span> table [id] : update or create a table entry<span class="hljs-string">&#x27;s data</span><br><span class="hljs-string">show table [id]: report table usage stats or dump this table&#x27;</span>s contents<br><span class="hljs-built_in">disable</span> frontend : temporarily <span class="hljs-built_in">disable</span> specific frontend<br><span class="hljs-built_in">enable</span> frontend : re-enable specific frontend<br> <span class="hljs-built_in">set</span> maxconn frontend : change a frontend<span class="hljs-string">&#x27;s maxconn setting</span><br><span class="hljs-string">show servers state [id]: dump volatile server information (for backend &lt;id&gt;)</span><br><span class="hljs-string">show backend  : list backends in the current running config</span><br><span class="hljs-string">shutdown frontend : stop a specific frontend</span><br><span class="hljs-string"> set dynamic-cookie-key backend : change a backend secret key for dynamic</span><br><span class="hljs-string">cookies</span><br><span class="hljs-string">enable dynamic-cookie backend : enable dynamic cookies on a specific backend</span><br><span class="hljs-string">disable dynamic-cookie backend : disable dynamic cookies on a specific backend</span><br><span class="hljs-string">show errors  : report last request and response errors for each proxy</span><br><span class="hljs-string">show resolvers [id]: dumps counters from all resolvers section and</span><br><span class="hljs-string">          associated name servers</span><br><span class="hljs-string">show cache   : show cache status</span><br><span class="hljs-string">add acl    : add acl entry</span><br><span class="hljs-string"> clear acl &lt;id&gt; : clear the content of this acl</span><br><span class="hljs-string">del acl    : delete acl entry</span><br><span class="hljs-string"> get acl    : report the patterns matching a sample for an ACL</span><br><span class="hljs-string">show acl [id] : report available acls or dump an acl&#x27;</span>s contents<br>add map    : add map entry<br> clear map &lt;id&gt; : clear the content of this map<br>del map    : delete map entry<br> get map    : report the keys and values matching a sample <span class="hljs-keyword">for</span> a map<br> <span class="hljs-built_in">set</span> map    : modify map entry<br>show map [id] : report available maps or dump a map<span class="hljs-string">&#x27;s contents</span><br><span class="hljs-string">trace &lt;module&gt; [cmd [args...]] : manage live tracing</span><br><span class="hljs-string">show trace [&lt;module&gt;] : show live tracing state</span><br><span class="hljs-string">show threads  : show some threads debugging information</span><br><span class="hljs-string">show pools   : report information about the memory pools usage</span><br><span class="hljs-string">show events [&lt;sink&gt;] : show event sink state</span><br><span class="hljs-string">show profiling : show CPU profiling options</span><br><span class="hljs-string"> set profiling : enable/disable CPU profiling</span><br><span class="hljs-string"> </span><br><span class="hljs-string"> [root@centos7 ~]#echo &quot;show info&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string">Name: HAProxy</span><br><span class="hljs-string">Version: 2.1.3</span><br><span class="hljs-string">Release_date: 2020/02/12</span><br><span class="hljs-string">Nbthread: 4</span><br><span class="hljs-string">Nbproc: 1</span><br><span class="hljs-string">Process_num: 1</span><br><span class="hljs-string">Pid: 2279</span><br><span class="hljs-string">Uptime: 0d 0h46m07s</span><br><span class="hljs-string">Uptime_sec: 2767</span><br><span class="hljs-string">Memmax_MB: 0</span><br><span class="hljs-string">PoolAlloc_MB: 0</span><br><span class="hljs-string">PoolUsed_MB: 0</span><br><span class="hljs-string">PoolFailed: 0</span><br><span class="hljs-string">Ulimit-n: 200041</span><br><span class="hljs-string">Maxsock: 200041</span><br><span class="hljs-string">Maxconn: 100000</span><br><span class="hljs-string">Hard_maxconn: 100000</span><br><span class="hljs-string">CurrConns: 0</span><br><span class="hljs-string">CumConns: 1</span><br><span class="hljs-string">CumReq: 1</span><br><span class="hljs-string">MaxSslConns: 0</span><br><span class="hljs-string">CurrSslConns: 0</span><br><span class="hljs-string">CumSslConns: 0</span><br><span class="hljs-string">Maxpipes: 0</span><br><span class="hljs-string">PipesUsed: 0</span><br><span class="hljs-string">PipesFree: 0</span><br><span class="hljs-string">ConnRate: 0</span><br><span class="hljs-string">ConnRateLimit: 0</span><br><span class="hljs-string">MaxConnRate: 0</span><br><span class="hljs-string">SessRate: 0</span><br><span class="hljs-string">SessRateLimit: 0</span><br><span class="hljs-string">MaxSessRate: 0</span><br><span class="hljs-string">SslRate: 0</span><br><span class="hljs-string">SslRateLimit: 0</span><br><span class="hljs-string">MaxSslRate: 0</span><br><span class="hljs-string">SslFrontendKeyRate: 0</span><br><span class="hljs-string">SslFrontendMaxKeyRate: 0</span><br><span class="hljs-string">SslFrontendSessionReuse_pct: 0</span><br><span class="hljs-string">SslBackendKeyRate: 0</span><br><span class="hljs-string">SslBackendMaxKeyRate: 0</span><br><span class="hljs-string">SslCacheLookups: 0</span><br><span class="hljs-string">SslCacheMisses: 0</span><br><span class="hljs-string">CompressBpsIn: 0</span><br><span class="hljs-string">CompressBpsOut: 0</span><br><span class="hljs-string">CompressBpsRateLim: 0</span><br><span class="hljs-string">ZlibMemUsage: 0</span><br><span class="hljs-string">MaxZlibMemUsage: 0</span><br><span class="hljs-string">Tasks: 19</span><br><span class="hljs-string">Run_queue: 1</span><br><span class="hljs-string">Idle_pct: 100</span><br><span class="hljs-string">node: centos7.wangxiaochun.com</span><br><span class="hljs-string">Stopping: 0</span><br><span class="hljs-string">Jobs: 7</span><br><span class="hljs-string">Unstoppable Jobs: 0</span><br><span class="hljs-string">Listeners: 6</span><br><span class="hljs-string">ActivePeers: 0</span><br><span class="hljs-string">ConnectedPeers: 0</span><br><span class="hljs-string">DroppedLogs: 0</span><br><span class="hljs-string">BusyPolling: 0</span><br><span class="hljs-string">FailedResolutions: 0</span><br><span class="hljs-string">TotalBytesOut: 0</span><br><span class="hljs-string">BytesOutRate: 0</span><br><span class="hljs-string">DebugCommandsIssued: 0</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#cat /etc/haproxy/haproxy.cfg</span><br><span class="hljs-string">......</span><br><span class="hljs-string">listen magedu-test-80</span><br><span class="hljs-string">bind :81,:82</span><br><span class="hljs-string">mode http</span><br><span class="hljs-string">server web1 10.0.0.17:80 check inter 3000 fall 3 rise 5</span><br><span class="hljs-string">server web2 10.0.0.27:80 check weight 3 </span><br><span class="hljs-string">......</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;show servers state&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string">1</span><br><span class="hljs-string"># be_id be_name srv_id srv_name srv_addr srv_op_state srv_admin_state</span><br><span class="hljs-string">srv_uweight srv_iweight srv_time_since_last_change srv_check_status</span><br><span class="hljs-string">srv_check_result srv_check_health srv_check_state srv_agent_state bk_f_forced_id</span><br><span class="hljs-string">srv_f_forced_id srv_fqdn srv_port srvrecord</span><br><span class="hljs-string">2 magedu-test-80 1 web1 10.0.0.17 2 0 2 1 812 6 3 7 6 0 0 0 - 80 -</span><br><span class="hljs-string">2 magedu-test-80 2 web2 10.0.0.27 2 0 2 3 812 6 3 4 6 0 0 0 - 80 -</span><br><span class="hljs-string">4 web_port 1 web1 127.0.0.1 0 0 1 1 810 8 2 0 6 0 0 0 - 8080 -</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;get weight magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock #注意配置文件中listen的名称</span><br><span class="hljs-string">3 (initial 3)</span><br><span class="hljs-string"></span><br><span class="hljs-string">#修改weight，注意只针对单进程有效。如要完全实现权重修改，就必须修改所有的sock文件</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;set weight magedu-test-80/web2 2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;get weight magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string">2 (initial 3)</span><br><span class="hljs-string"></span><br><span class="hljs-string">#将后端服务器禁用，注意只针对单进程有效。要完全实现权重修改，就必须修改所有的sock文件</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;disable server magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">#启用后端服务器</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;enable server magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">#将后端服务器软下线，即weight设为0</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;set weight magedu-test-80/web1 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">#针对haproxy的多进程,将后端服务器禁用</span><br><span class="hljs-string">[root@centos7 ~]#vim /etc/haproxy/haproxy.cfg</span><br><span class="hljs-string">......</span><br><span class="hljs-string">stats socket /var/lib/haproxy/haproxy1.sock mode 600 level admin process 1 #绑定第1个进程和socket文件</span><br><span class="hljs-string">stats socket /var/lib/haproxy/haproxy2.sock mode 600 level admin process 2 #绑定第2个进程和socket文件</span><br><span class="hljs-string">nbproc 2</span><br><span class="hljs-string">.....</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;disable server magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy1.sock</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;disable server magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy2.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@haproxy ~]#for i in &#123;1..2&#125;;do echo &quot;set weight magedu-test-80/web$i 10&quot; | socat stdio /var/lib/haproxy/haproxy$i.sock;done</span><br><span class="hljs-string"></span><br><span class="hljs-string">#如果静态算法，如:static-rr，可以更改weight为0或1，但不支持动态更改weight为其它值，否则会提示下面信息</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;set weight magedu-test-80/web1 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;set weight magedu-test-80/web1 1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;set weight magedu-test-80/web1 2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string">Backend is using a static LB algorithm and only accepts weights &#x27;</span>0%<span class="hljs-string">&#x27; and &#x27;</span>100%<span class="hljs-string">&#x27;.</span><br></code></pre></td></tr></table></figure><p>范例: 上线和下线后端服务器脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat haproyx_host_up_down.sh</span><br>. /etc/init.d/<span class="hljs-built_in">functions</span><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>up)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;set weight magedu-m42-web-80/<span class="hljs-variable">$2</span> 1&quot;</span> | socat stdio /var/lib/haproxy/haproxy.sock<br> [ $? -eq 0 ] &amp;&amp; action <span class="hljs-string">&quot;<span class="hljs-variable">$2</span> is up&quot;</span><br> ;;<br>down)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;set weight magedu-m42-web-80/<span class="hljs-variable">$2</span> 0&quot;</span> | socat stdio /var/lib/haproxy/haproxy.sock<br> [ $? -eq 0 ] &amp;&amp; action <span class="hljs-string">&quot;<span class="hljs-variable">$2</span> is down&quot;</span><br> ;;<br>*)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: `basename <span class="hljs-variable">$0</span>` up|down IP&quot;</span><br> ;;<br><span class="hljs-keyword">esac</span><br><br><span class="hljs-comment">#下图操作需要将脚本添加执行权限和做软连接到/usr/bin/下</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy27.png"></p><h4 id="4-1-2-static-rr"><a href="#4-1-2-static-rr" class="headerlink" title="4.1.2 static-rr"></a>4.1.2 static-rr</h4><p>static-rr：基于权重的轮询调度，不支持运行时利用socat进行权重的动态调整(只支持0和1,不支持其它值)及后端服务器慢启动，其后端主机数量没有限制，相当于LVS中的 wrr</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance static-rr<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 2 check inter 3000 fall 2 rise 5<br><br><span class="hljs-comment">#查看此时权重</span><br>[root@haproxy ~]<span class="hljs-comment"># echo &quot;get weight web_80_port/web1 1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>1 (initial 1)<br><br><span class="hljs-comment">#不能动态修改权重，但是可以改成0或1</span><br>[root@haproxy ~]<span class="hljs-comment"># echo &quot;set weight web_80_port/web1 3&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>Backend is using a static LB algorithm and only accepts weights <span class="hljs-string">&#x27;0%&#x27;</span> and <span class="hljs-string">&#x27;100%&#x27;</span>.<br><br>[root@haproxy ~]<span class="hljs-comment"># echo &quot;set weight web_80_port/web1 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><br>[root@haproxy ~]<span class="hljs-comment"># echo &quot;set weight web_80_port/web1 1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><br><br></code></pre></td></tr></table></figure><h4 id="4-1-3-first"><a href="#4-1-3-first" class="headerlink" title="4.1.3 first"></a>4.1.3 first</h4><p>first：根据服务器在列表中的位置，自上而下进行调度，但是其只会当第一台服务器的连接数达到上<br>限，新请求才会分配给下一台服务，因此会忽略服务器的权重设置，此方式使用较少<br>不支持用socat进行动态修改权重,可以设置0和1,可以设置其它值但无效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance first<br>    server web1 10.0.0.17:80 maxconn 2 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><p>测试访问效果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#同时运行下面命令，观察结果</span><br><span class="hljs-comment"># while true;do curl http://10.0.0.7/index.html ; sleep 0.1;done</span><br></code></pre></td></tr></table></figure><h3 id="4-2-动态算法"><a href="#4-2-动态算法" class="headerlink" title="4.2 动态算法"></a>4.2 动态算法</h3><p>动态算法：基于后端服务器状态进行调度适当调整，优先调度至当前负载较低的服务器，且权重可以在haproxy运行时动态调整无需重启。</p><h4 id="4-2-1-roundrobin"><a href="#4-2-1-roundrobin" class="headerlink" title="4.2.1 roundrobin"></a>4.2.1 roundrobin</h4><p>roundrobin：基于权重的轮询动态调度算法，支持权重的运行时调整，不同于lvs中的rr轮训模式，<br>HAProxy中的roundrobin支持慢启动(新加的服务器会逐渐增加转发数)，其每个后端backend中最多支持4095个real server，支持对real server权重动态调整，<strong>roundrobin为默认调度算法</strong>,此算法使用广泛</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance roundrobin<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 2 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><p>支持动态调整权重：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># echo &quot;get weight web_host/web1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>1 (initial 1)<br><br><span class="hljs-comment"># echo &quot;set weight web_host/web1 3&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><br><span class="hljs-comment"># echo &quot;get weight web_host/web1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>3 (initial 1)<br></code></pre></td></tr></table></figure><h4 id="4-2-2-leastconn"><a href="#4-2-2-leastconn" class="headerlink" title="4.2.2 leastconn"></a>4.2.2 leastconn</h4><p>leastconn加权的最少连接的动态，支持权重的运行时调整和慢启动，即:根据当前连接最少的后端服务器而非权重进行优先调度(新客户端连接)，比较适合长连接的场景使用，比如：MySQL等场景</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance leastconn<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h4 id="4-2-3-random"><a href="#4-2-3-random" class="headerlink" title="4.2.3 random"></a>4.2.3 random</h4><p>在1.9版本开始增加 random的负载平衡算法，其基于随机数作为一致性hash的key，随机负载平衡对于大型服务器场或经常添加或删除服务器非常有用，支持weight的动态调整，weight较大的主机有更大概率获取新请求<br>random配置实例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance random<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h3 id="4-3-其他算法"><a href="#4-3-其他算法" class="headerlink" title="4.3 其他算法"></a>4.3 其他算法</h3><p>其它算法即可作为静态算法，又可以通过选项成为动态算法</p><h4 id="4-3-1-source"><a href="#4-3-1-source" class="headerlink" title="4.3.1 source"></a>4.3.1 source</h4><p>源地址hash，基于用户源地址hash并将请求转发到后端服务器，后续同一个源地址请求将被转发至同<br>一个后端web服务器。此方式当后端服务器数据量发生变化时，会导致很多用户的请求转发至新的后端服务器，默认为静态方式，但是可以通过hash-type支持的选项更改</p><p>这个算法一般是在不插入Cookie的TCP模式下使用，也可给拒绝会话cookie的客户提供最好的会话粘<br>性，适用于session会话保持但不支持cookie和缓存的场景</p><p>源地址有两种转发客户端请求到后端服务器的服务器选取计算方式，分别是取模法和一致性hash</p><h5 id="4-3-1-1-map-base-取模法"><a href="#4-3-1-1-map-base-取模法" class="headerlink" title="4.3.1.1 map-base 取模法"></a>4.3.1.1 map-base 取模法</h5><p>map-based：取模法，对source地址进行hash计算，再基于服务器总权重的取模，最终结果决定将此<br>请求转发至对应的后端服务器。此方法是静态的，即不支持在线调整权重，不支持慢启动，可实现对后端服务器均衡调度。缺点是当服务器的总权重发生变化时，即有服务器上线或下线，都会因总权重发生变化而导致调度结果整体改变，hash-type 指定的默认值为此算法</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">所谓取模运算，就是计算两个数相除之后的余数，10%7=3, 7%4=3<br>map-based算法：基于权重取模，hash(source_ip)%所有后端服务器相加的总权重<br></code></pre></td></tr></table></figure><p>取模法配置示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode tcp<br>    <span class="hljs-built_in">log</span> global<br>    balance <span class="hljs-built_in">source</span><br>    hash-type map-based<br>    server web1  10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 3<br>    server web2  10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 3<br><br><span class="hljs-comment">#不支持动态调整权重值</span><br>[root@haproxy ~]<span class="hljs-comment">#echo &quot;set weight web_host/10.0.0.27 10&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>Backend is using a static LB algorithm and only accepts weights <span class="hljs-string">&#x27;0%&#x27;</span> and <span class="hljs-string">&#x27;100%&#x27;</span>.<br><br><span class="hljs-comment">#只能动态上线和下线</span><br>[root@haproxy ~]<span class="hljs-comment">#echo &quot;set weight web_host/10.0.0.27 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><br>[root@haproxy conf.d]<span class="hljs-comment">#echo &quot;get weight web_host/10.0.0.27&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>0 (initial 1)<br></code></pre></td></tr></table></figure><h5 id="4-3-1-2-一致性hash"><a href="#4-3-1-2-一致性hash" class="headerlink" title="4.3.1.2 一致性hash"></a>4.3.1.2 一致性hash</h5><p>一致性哈希，当服务器的总权重发生变化时，对调度结果影响是局部的，不会引起大的变动，<br>hash（o）mod n ，该hash算法是动态的，支持使用 socat等工具进行在线权重调整，支持慢启动<br>算法：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">1、key1=hash(source_ip)%(2^32) [0---4294967295]<br>2、keyA=hash(后端服务器虚拟ip)%(2^32)<br>3、将key1和keyA都放在hash环上，将用户请求调度到离key1最近的keyA对应的后端服务器<br></code></pre></td></tr></table></figure><p>hash环偏斜问题</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">增加虚拟服务器IP数量，比如：一个后端服务器根据权重为1生成1000个虚拟IP，再hash。而后端服务器权<br>重为2则生成2000的虚拟IP，再bash,最终在hash环上生成3000个节点，从而解决hash环偏斜问题<br></code></pre></td></tr></table></figure><h6 id="4-3-1-2-1-hash对象"><a href="#4-3-1-2-1-hash对象" class="headerlink" title="4.3.1.2.1 hash对象"></a>4.3.1.2.1 hash对象</h6><p>Hash对象到后端服务器的映射关系：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy28.png"></p><h6 id="4-3-1-2-2-一致性hash示意图"><a href="#4-3-1-2-2-一致性hash示意图" class="headerlink" title="4.3.1.2.2 一致性hash示意图"></a>4.3.1.2.2 一致性hash示意图</h6><p>后端服务器在线与离线的调度方式</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy29.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy30.png"></p><h6 id="4-3-1-2-3-一致性hash配置示例"><a href="#4-3-1-2-3-一致性hash配置示例" class="headerlink" title="4.3.1.2.3 一致性hash配置示例"></a>4.3.1.2.3 一致性hash配置示例</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode tcp<br>    <span class="hljs-built_in">log</span> global<br>    balance <span class="hljs-built_in">source</span><br>    hash-type consistent<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h4 id="4-3-2-uri"><a href="#4-3-2-uri" class="headerlink" title="4.3.2 uri"></a>4.3.2 uri</h4><p>基于对用户请求的URI的左半部分或整个uri做hash，再将hash结果对总权重进行取模后，根据最终结<br>果将请求转发到后端指定服务器，适用于后端是缓存服务器场景，默认是静态算法，也可以通过hash-<br>type指定map-based和consistent，来定义使用取模法还是一致性hash。<br><strong>注意：此算法基于应用层，所以只支持 mode http ，不支持 mode tcp</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;<br>左半部分：/&lt;path&gt;;&lt;params&gt;<br>整个uri：/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy31.png"></p><h5 id="4-3-2-1-uri-取模法配置示例"><a href="#4-3-2-1-uri-取模法配置示例" class="headerlink" title="4.3.2.1 uri 取模法配置示例"></a>4.3.2.1 uri 取模法配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance uri<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h5 id="4-3-2-2-uri-一致性hash配置示例"><a href="#4-3-2-2-uri-一致性hash配置示例" class="headerlink" title="4.3.2.2 uri 一致性hash配置示例"></a>4.3.2.2 uri 一致性hash配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance uri<br>    hash-type consistent<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h5 id="4-3-2-3-访问测试"><a href="#4-3-2-3-访问测试" class="headerlink" title="4.3.2.3 访问测试"></a>4.3.2.3 访问测试</h5><p>访问不同的uri，确认可以将用户同样的请求转发至相同的服务器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curl http://10.0.0.7/test1.html</span><br><span class="hljs-comment"># curl http://10.0.0.7/test2..html</span><br></code></pre></td></tr></table></figure><h4 id="4-3-3-url-param"><a href="#4-3-3-url-param" class="headerlink" title="4.3.3 url_param"></a>4.3.3 url_param</h4><p>url_param对用户请求的url中的 params 部分中的一个参数key对应的value值作hash计算，并由服务<br>器总权重相除以后派发至某挑出的服务器；通常用于追踪用户，以确保来自同一个用户的请求始终发往同一个real server，如果无没key，将按roundrobin算法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">假设：<br>url = http://www.magedu.com/foo/bar/index.php?key=value<br><br>则：<br>host = <span class="hljs-string">&quot;www.magedu.com&quot;</span><br>url_param = <span class="hljs-string">&quot;key=value&quot;</span><br></code></pre></td></tr></table></figure><h5 id="4-3-3-1-url-param取模法配置示例"><a href="#4-3-3-1-url-param取模法配置示例" class="headerlink" title="4.3.3.1 url_param取模法配置示例"></a>4.3.3.1 url_param取模法配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance url_param userid <span class="hljs-comment">#url_param hash</span><br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h5 id="4-3-3-2-url-param一致性hash配置示例"><a href="#4-3-3-2-url-param一致性hash配置示例" class="headerlink" title="4.3.3.2 url_param一致性hash配置示例"></a>4.3.3.2 url_param一致性hash配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance url_param userid keyword <span class="hljs-comment">#对url_param的值取hash</span><br>    hash-type consistent<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h5 id="4-3-3-3-测试访问"><a href="#4-3-3-3-测试访问" class="headerlink" title="4.3.3.3 测试访问"></a>4.3.3.3 测试访问</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">#url_param取模法<br># curl http://10.0.0.7/index.html?userid=&lt;NAME_ID&gt;<br>例子：<br>curl http://10.0.0.7/index.html?userid=1<br>curl http://10.0.0.7/index.html?userid=2<br>#url_param一致性hash<br># curl &quot;http://10.0.0.7/index.html?userid=&lt;NAME_ID&gt;&amp;typeid=&lt;TYPE_ID&gt;&quot;<br>例子：<br>curl http://10.0.0.7/index.html?userid=1&amp;typeid=1<br>curl http://10.0.0.7/index.html?userid=2&amp;typeid=2<br></code></pre></td></tr></table></figure><h4 id="4-3-4-hdr"><a href="#4-3-4-hdr" class="headerlink" title="4.3.4 hdr"></a>4.3.4 hdr</h4><p>针对用户每个http头部(header)请求中的指定信息做hash，此处由 name 指定的http首部将会被取出并做hash计算，然后由服务器总权重取模以后派发至某挑出的服务器，如果无有效值，则会使用默认的轮询调度。</p><h5 id="4-3-4-1-hdr取模法配置示例"><a href="#4-3-4-1-hdr取模法配置示例" class="headerlink" title="4.3.4.1 hdr取模法配置示例"></a>4.3.4.1 hdr取模法配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance hdr(User-Agent)<br>    <span class="hljs-comment">#balance hdr(host)</span><br><br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h5 id="4-3-4-2-一致性hash配置示例"><a href="#4-3-4-2-一致性hash配置示例" class="headerlink" title="4.3.4.2 一致性hash配置示例"></a>4.3.4.2 一致性hash配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance hdr(User-Agent)<br>    hash-type consistent<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h5 id="4-3-4-3-测试访问"><a href="#4-3-4-3-测试访问" class="headerlink" title="4.3.4.3 测试访问"></a>4.3.4.3 测试访问</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -v http://10.0.0.7/index.html</span><br>[root@centos6 ~]<span class="hljs-comment">#curl -vA &#x27;firefox&#x27; http://10.0.0.7/index.html</span><br>[root@centos6 ~]<span class="hljs-comment">#curl -vA &#x27;chrome&#x27; http://10.0.0.7/index.html</span><br></code></pre></td></tr></table></figure><h4 id="4-3-5-rdp-cookie"><a href="#4-3-5-rdp-cookie" class="headerlink" title="4.3.5 rdp-cookie"></a>4.3.5 rdp-cookie</h4><p>rdp-cookie对远windows远程桌面的负载，使用cookie保持会话，默认是静态，也可以通过hash-type<br>指定map-based和consistent，来定义使用取模法还是一致性hash。</p><h5 id="4-3-5-1-rdp-cookie-取模法配置示例"><a href="#4-3-5-1-rdp-cookie-取模法配置示例" class="headerlink" title="4.3.5.1 rdp-cookie 取模法配置示例"></a>4.3.5.1 rdp-cookie 取模法配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen RDP<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:3389<br>    balance rdp-cookie<br>    mode tcp<br>    server rdp0 10.0.0.17:3389 check fall 3 rise 5 inter 2000 weight 1<br></code></pre></td></tr></table></figure><h5 id="4-3-5-2-rdp-cookie-一致性hash配置示例"><a href="#4-3-5-2-rdp-cookie-一致性hash配置示例" class="headerlink" title="4.3.5.2 rdp-cookie 一致性hash配置示例"></a>4.3.5.2 rdp-cookie 一致性hash配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@haproxy ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/windows_rdp.cfg</span><br>listen windows_RDP_3389<br>    <span class="hljs-built_in">bind</span>  172.16.0.100:3389<br>    balance rdp-cookie<br>    hash-type consistent<br>    mode tcp<br>    server rdp0 10.0.0.200:3389 check fall 3 rise 5 inter 2000 weight 1<br><br>[root@haproxy ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.7 172.16.0.100<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy32.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy33.png"></p><h5 id="4-3-5-3-基于iptables实现RDP协议转发"><a href="#4-3-5-3-基于iptables实现RDP协议转发" class="headerlink" title="4.3.5.3 基于iptables实现RDP协议转发"></a>4.3.5.3 基于iptables实现RDP协议转发</h5><p>必须开启ip转发功能： net.ipv4.ip_forward = 1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#sysctl -w net.ipv4.ip_forward=1</span><br><span class="hljs-comment">#客户端和Windows在不同网段需要下面命令,注意后端服务器需要将iptables主机配置为网关</span><br>[root@centos8 ~]<span class="hljs-comment">#iptables -t nat -A PREROUTING -d 172.16.0.100 -p tcp --dport 3389 -j DNAT --to-destination 10.0.0.200:3389</span><br><br><span class="hljs-comment">#客户端和Windows在同一网段需要再执行下面命令</span><br>[root@centos8 ~]<span class="hljs-comment">#iptables -t nat -A PREROUTING -d 10.0.0.8 -p tcp --dport 3389 -j DNAT --to-destination 10.0.0.1:3389</span><br>[root@centos8 ~]<span class="hljs-comment">#iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j SNAT --to-source 10.0.0.8</span><br><br><span class="hljs-comment">#注意window网关要指向转发机器的ip地址</span><br></code></pre></td></tr></table></figure><p>在windows 可以看到以下信息</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy34.png"></p><h4 id="4-3-6-算法总结"><a href="#4-3-6-算法总结" class="headerlink" title="4.3.6 算法总结"></a>4.3.6 算法总结</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#静态</span><br>static-rr---------&gt;tcp/http <br>first-------------&gt;tcp/http <br><br><span class="hljs-comment">#动态</span><br>roundrobin--------&gt;tcp/http<br>leastconn---------&gt;tcp/http<br>random------------&gt;tcp/http<br><br><span class="hljs-comment">#以下静态和动态取决于hash_type是否consistent</span><br><span class="hljs-built_in">source</span>------------&gt;tcp/http<br>Uri---------------&gt;http<br>url_param---------&gt;http  <br>hdr---------------&gt;http<br>rdp-cookie--------&gt;tcp<br></code></pre></td></tr></table></figure><h4 id="4-3-7-各算法使用场景"><a href="#4-3-7-各算法使用场景" class="headerlink" title="4.3.7 各算法使用场景"></a>4.3.7 各算法使用场景</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">first <span class="hljs-comment">#使用较少</span><br><br>static-rr <span class="hljs-comment">#做了session共享的web集群</span><br>roundrobin<br>random<br><br>leastconn <span class="hljs-comment">#数据库</span><br><span class="hljs-built_in">source</span> <span class="hljs-comment">#基于客户端公网IP的会话保持</span><br><br>Uri---------------&gt;http  <span class="hljs-comment">#缓存服务器，CDN服务商，蓝汛、百度、阿里云、腾讯</span><br>url_param---------&gt;http  <span class="hljs-comment">#可以实现session保持</span><br><br>hdr <span class="hljs-comment">#基于客户端请求报文头部做下一步处理</span><br>rdp-cookie <span class="hljs-comment">#基于Windows主机,很少使用</span><br></code></pre></td></tr></table></figure><h2 id="五、高级功能及配置"><a href="#五、高级功能及配置" class="headerlink" title="五、高级功能及配置"></a>五、高级功能及配置</h2><p>介绍HAProxy高级配置及实用案例</p><h3 id="5-1-基于cookie的会话保持"><a href="#5-1-基于cookie的会话保持" class="headerlink" title="5.1 基于cookie的会话保持"></a>5.1 基于cookie的会话保持</h3><p>cookie value：为当前server指定cookie值，实现基于cookie的会话黏性，相对于基于 source 地址<br>hash 调度算法对客户端的粒度更精准，但同时也加大了haproxy负载，目前此模式使用较少， 已经被<br>session共享服务器代替</p><p>注意：不支持 tcp mode，使用 http mode</p><h4 id="5-1-1-配置选项"><a href="#5-1-1-配置选项" class="headerlink" title="5.1.1 配置选项"></a>5.1.1 配置选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">cookie name [ rewrite | insert | prefix ][ indirect ] [ nocache ][ postonly ] [<br>preserve ][ httponly ] [ secure ][ domain ]* [ maxidle &lt;idle&gt; ][ maxlife ]<br><br>name： <span class="hljs-comment">#cookie 的 key名称，用于实现持久连接</span><br>insert： <span class="hljs-comment">#插入新的cookie,默认不插入cookie</span><br>indirect： <span class="hljs-comment">#如果客户端已经有cookie,则不会再发送cookie信息</span><br>nocache： <span class="hljs-comment">#当client和hapoxy之间有缓存服务器（如：CDN）时，不允许中间缓存器缓存cookie，因为这会导致很多经过同一个CDN的请求都发送到同一台后端服务器</span><br></code></pre></td></tr></table></figure><h4 id="5-1-2-配置示例"><a href="#5-1-2-配置示例" class="headerlink" title="5.1.2 配置示例"></a>5.1.2 配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>balance roundrobin<br>mode http <span class="hljs-comment">#不支持 tcp mode</span><br><span class="hljs-built_in">log</span> global<br>cookie WEBSRV insert nocache indirect<br>server web1  10.0.0.17:80 check inter 3000 fall 2 rise 5 cookie web1<br>server web2  10.0.0.27:80 check inter 3000 fall 2 rise 5 cookie web2<br>解释：<br>第一次访问网站的时候系统会，响应报文会被服务器分配一个cookie（使用上面的参数为例，WEDSRV=web1）请求报文不会收到cookie。<br>下次访问同一个网站的时候，请求报文就携带上次响应报文里收到的cookie（也就是：WEDSRV=web1），然后haproxy收到就知道上次用户访问被分配到cookie为web1的服务器里，那么这次也是分配到web1。<br>如果浏览器缓存清理后就会重新分配cookie<br></code></pre></td></tr></table></figure><p>5.1.3 验证cookie信息<br>浏览器验证：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy35.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy36.png"></p><p>通过命令行验证：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -i 10.0.0.7</span><br>HTTP/1.1 200 OK<br>date: Thu, 02 Apr 2020 02:26:08 GMT<br>server: Apache/2.4.6 (CentOS)<br>last-modified: Thu, 02 Apr 2020 01:44:28 GMT<br>etag: <span class="hljs-string">&quot;a-5a244f0fd5175&quot;</span><br>accept-ranges: bytes<br>content-length: 10<br>content-type: text/html; charset=UTF-8<br>set-cookie: WEBSRV=web2; path=/<br>cache-control: private<br><br>10.0.0.27<br>[root@centos6 ~]<span class="hljs-comment">#curl -i 10.0.0.7</span><br>HTTP/1.1 200 OK<br>date: Thu, 02 Apr 2020 02:26:15 GMT<br>server: Apache/2.4.6 (CentOS)<br>last-modified: Thu, 02 Apr 2020 01:44:13 GMT<br>etag: <span class="hljs-string">&quot;a-5a244f01f8adc&quot;</span><br>accept-ranges: bytes<br>content-length: 10<br>content-type: text/html; charset=UTF-8<br>set-cookie: WEBSRV=web1; path=/<br>cache-control: private<br><br>10.0.0.17<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -b WEBSRV=web1 10.0.0.7</span><br>10.0.0.17<br>[root@centos6 ~]<span class="hljs-comment">#curl -b WEBSRV=web2 10.0.0.7</span><br>10.0.0.27<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -vb WEBSRV=web1 10.0.0.7</span><br>* About to connect() to 10.0.0.7 port 80 (<span class="hljs-comment">#0)</span><br>*  Trying 10.0.0.7... connected<br>* Connected to 10.0.0.7 (10.0.0.7) port 80 (<span class="hljs-comment">#0)</span><br>&gt; GET / HTTP/1.1<br>&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1<br>zlib/1.2.3 libidn/1.18 libssh2/1.4.2<br>&gt; Host: 10.0.0.7<br>&gt; Accept: */*<br>&gt; Cookie: WEBSRV=web1<br>&gt;<br>&lt; HTTP/1.1 200 OK<br>&lt; date: Thu, 02 Apr 2020 02:27:54 GMT<br>&lt; server: Apache/2.4.6 (CentOS)<br>&lt; last-modified: Thu, 02 Apr 2020 01:44:13 GMT<br>&lt; etag: <span class="hljs-string">&quot;a-5a244f01f8adc&quot;</span><br>&lt; accept-ranges: bytes<br>&lt; content-length: 10<br>&lt; content-type: text/html; charset=UTF-8<br>&lt;<br>10.0.0.17<br>* Connection <span class="hljs-comment">#0 to host 10.0.0.7 left intact</span><br>* Closing connection <span class="hljs-comment">#0</span><br>[root@centos6 ~]<span class="hljs-comment">#curl -vb WEBSRV=web2 10.0.0.7</span><br>* About to connect() to 10.0.0.7 port 80 (<span class="hljs-comment">#0)</span><br>*  Trying 10.0.0.7... connected<br>* Connected to 10.0.0.7 (10.0.0.7) port 80 (<span class="hljs-comment">#0)</span><br>&gt; GET / HTTP/1.1<br>&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1<br>zlib/1.2.3 libidn/1.18 libssh2/1.4.2<br>&gt; Host: 10.0.0.7<br>&gt; Accept: */*<br>&gt; Cookie: WEBSRV=web2<br>&gt;<br>&lt; HTTP/1.1 200 OK<br>&lt; date: Thu, 02 Apr 2020 02:27:57 GMT<br>&lt; server: Apache/2.4.6 (CentOS)<br>&lt; last-modified: Thu, 02 Apr 2020 01:44:28 GMT<br>&lt; etag: <span class="hljs-string">&quot;a-5a244f0fd5175&quot;</span><br>&lt; accept-ranges: bytes<br>&lt; content-length: 10<br>&lt; content-type: text/html; charset=UTF-8<br>&lt;<br>10.0.0.27<br>* Connection <span class="hljs-comment">#0 to host 10.0.0.7 left intact</span><br>* Closing connection <span class="hljs-comment">#0</span><br></code></pre></td></tr></table></figure><h3 id="5-2-HAProxy状态页"><a href="#5-2-HAProxy状态页" class="headerlink" title="5.2 HAProxy状态页"></a>5.2 HAProxy状态页</h3><p>通过web界面，显示当前HAProxy的运行状态<br>官方帮助：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-stats%20admin<br>http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4-stats%20admin<br></code></pre></td></tr></table></figure><h4 id="5-2-1-状态页配置项"><a href="#5-2-1-状态页配置项" class="headerlink" title="5.2.1 状态页配置项"></a>5.2.1 状态页配置项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">stats <span class="hljs-built_in">enable</span>          <span class="hljs-comment">#基于默认的参数启用stats page</span><br>stats hide-version    <span class="hljs-comment">#将状态页中haproxy版本隐藏</span><br>stats refresh &lt;delay&gt; <span class="hljs-comment">#设定自动刷新时间间隔，默认不自动刷新</span><br>stats uri &lt;prefix&gt;    <span class="hljs-comment">#自定义stats page uri，默认值：/haproxy?stats</span><br>stats realm &lt;realm&gt;   <span class="hljs-comment">#账户认证时的提示信息，示例：stats realm  HAProxy\Statistics</span><br>stats auth &lt;user&gt;:&lt;passwd&gt; <span class="hljs-comment">#认证时的账号和密码，可定义多个用户,每行指定一个用户.默认：no authentication</span><br>stats admin &#123; <span class="hljs-keyword">if</span> | unless &#125; &lt;cond&gt; <span class="hljs-comment">#启用stats page中的管理功能</span><br></code></pre></td></tr></table></figure><h4 id="5-2-2-启用状态页"><a href="#5-2-2-启用状态页" class="headerlink" title="5.2.2 启用状态页"></a>5.2.2 启用状态页</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen stats<br><span class="hljs-built_in">bind</span> :9999 <span class="hljs-comment">#绑定的ip一般使用内网IP，而不用外网或者0.0.0.0这种别人可以访问的IP</span><br>stats <span class="hljs-built_in">enable</span><br> <span class="hljs-comment">#stats hide-version</span><br>stats uri /haproxy-status      <span class="hljs-comment">#自定义stats page uri</span><br>stats realm HAProxy\ Status\ Page   <span class="hljs-comment">#账户认证时的提示信息，不是所有的浏览器会有提示信息</span><br>stats auth haadmin:123456  <span class="hljs-comment">#两个用户</span><br>stats auth admin:123456<br> <span class="hljs-comment">#stats refresh 30s</span><br>stats admin <span class="hljs-keyword">if</span> TRUE <span class="hljs-comment">#安全原因，不建议打开</span><br></code></pre></td></tr></table></figure><h4 id="5-2-3-登录状态页"><a href="#5-2-3-登录状态页" class="headerlink" title="5.2.3 登录状态页"></a>5.2.3 登录状态页</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">pid = 27134 (process <span class="hljs-comment">#1, nbproc = 1, nbthread = 1) #pid为当前pid号，process为当前进</span><br>程号，nbproc和nbthread为一共多少进程和每个进程多少个线程<br>uptime = 0d 0h00m04s <span class="hljs-comment">#启动了多长时间</span><br>system limits: memmax = unlimited; ulimit-n = 200029 <span class="hljs-comment">#系统资源限制：内存/最大打开文件</span><br>数/<br>maxsock = 200029; maxconn = 100000; maxpipes = 0 <span class="hljs-comment">#最大socket连接数/单进程最大连接数/</span><br>最大管道数maxpipes<br>current conns = 2; current pipes = 0/0; conn rate = 2/sec; bit rate = 0.000 kbps<br><span class="hljs-comment">#当前连接数/当前管道数/当前连接速率</span><br>Running tasks: 1/14; idle = 100 % <span class="hljs-comment">#运行的任务/当前空闲率</span><br>active UP： <span class="hljs-comment">#在线服务器</span><br>backup UP： <span class="hljs-comment">#标记为backup的服务器</span><br>active UP, going down： <span class="hljs-comment">#监测未通过正在进入down过程</span><br>backup UP, going down： <span class="hljs-comment">#备份服务器正在进入down过程</span><br>active DOWN, going up： <span class="hljs-comment">#down的服务器正在进入up过程</span><br>backup DOWN, going up： <span class="hljs-comment">#备份服务器正在进入up过程</span><br>active or backup DOWN： <span class="hljs-comment">#在线的服务器或者是backup的服务器已经转换成了down状态</span><br>not checked： <span class="hljs-comment">#标记为不监测的服务器</span><br>active or backup DOWN <span class="hljs-keyword">for</span> maintenance (MAINT) <span class="hljs-comment">#active或者backup服务器人为下线的</span><br>active or backup SOFT STOPPED <span class="hljs-keyword">for</span> maintenance <span class="hljs-comment">#active或者backup被人为软下线(人为将weight改成0)</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy37.png"></p><h4 id="5-2-4-backend-server信息"><a href="#5-2-4-backend-server信息" class="headerlink" title="5.2.4 backend server信息"></a>5.2.4 backend server信息</h4><table><thead><tr><th>session rate(每秒的连接会话信息)：</th><th>Errors(错误统计信息)：</th></tr></thead><tbody><tr><td>cur:每秒的当前会话数量</td><td>Req:错误请求量</td></tr><tr><td>max:每秒新的最大会话数量</td><td>conn:错误链接量</td></tr><tr><td>limit:每秒新的会话限制量</td><td>Resp:错误响应量</td></tr><tr><td>sessions(会话信息)：</td><td>Warnings(警告统计信息)：</td></tr><tr><td>cur:当前会话量</td><td>Retr:重新尝试次数</td></tr><tr><td>max:最大会话量</td><td>Redis:再次发送次数</td></tr><tr><td>limit: 限制会话量</td><td></td></tr><tr><td>Total:总共会话量</td><td>Server(real server信息)：</td></tr><tr><td>LBTot:选中一台服务器所用的总时间</td><td>Status:后端机的状态，包括UP和DOWN</td></tr><tr><td>Last：和服务器的持续连接时间</td><td>LastChk:持续检查后端服务器的时间</td></tr><tr><td>Wght:权重</td><td></td></tr><tr><td>Bytes(流量统计)：</td><td>Act:活动链接数量</td></tr><tr><td>In:网络的字节输入总量</td><td>Bck:备份的服务器数量</td></tr><tr><td>Out:网络的字节输出总量</td><td>Chk:心跳检测时间</td></tr><tr><td>Dwn:后端服务器连接后都是DOWN的数量</td><td></td></tr><tr><td>Denied(拒绝统计信息)：</td><td>Dwntme:总的downtime时间</td></tr><tr><td>Req:拒绝请求量</td><td>Thrtle:server 状态</td></tr><tr><td>Resp:拒绝回复量</td><td></td></tr></tbody></table><h4 id="5-2-5-利用状态页实现haproxy服务器的健康性检查"><a href="#5-2-5-利用状态页实现haproxy服务器的健康性检查" class="headerlink" title="5.2.5 利用状态页实现haproxy服务器的健康性检查"></a>5.2.5 利用状态页实现haproxy服务器的健康性检查</h4><p>范例：通过curl命令或killall命令对haproxy的状态页的访问实现健康检查</p><p><strong>使用keepalived实现haproxy的高可用，通过脚本检测haproxy服务器的健康性</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#curl -I http://haadmin:123456@10.0.0.7:9999/haproxy-status</span><br>HTTP/1.1 200 OK<br>cache-control: no-cache<br>content-type: text/html<br><br>[root@centos8 ~]<span class="hljs-comment">#curl -I -u haadmin:123456 http://10.0.0.7:9999/haproxy-status</span><br>HTTP/1.1 200 OK<br>cache-control: no-cache<br>content-type: text/html<br><br>[root@centos8 ~]<span class="hljs-comment">#echo $?</span><br>0<br><br>[root@haproxy ~]<span class="hljs-comment">#systemctl stop haproxy</span><br><br>[root@centos8 ~]<span class="hljs-comment">#curl -I http://haadmin:123456@10.0.0.7:9999/haproxy-status</span><br>curl: (7) Failed to connect to 10.0.0.7 port 9999: Connection refused<br><br>[root@centos8 ~]<span class="hljs-comment">#echo $?</span><br>7<br><br>[root@haproxy ~]<span class="hljs-comment"># systemctl stop haproxy</span><br>[root@haproxy ~]<span class="hljs-comment"># killall -0 haproxy</span><br>haproxy: no process found<br><br>[root@haproxy ~]<span class="hljs-comment"># systemctl start haproxy</span><br>[root@haproxy ~]<span class="hljs-comment"># killall -0 haproxy</span><br>[root@haproxy ~]<span class="hljs-comment"># echo $?</span><br>0<br></code></pre></td></tr></table></figure><h3 id="5-3-IP透传"><a href="#5-3-IP透传" class="headerlink" title="5.3 IP透传"></a>5.3 IP透传</h3><p>web服务器中需要记录客户端的真实IP地址，用于做访问统计、安全防护、行为分析、区域排行等场<br>景。</p><h4 id="5-3-1-layer-4-与-layer-7"><a href="#5-3-1-layer-4-与-layer-7" class="headerlink" title="5.3.1 layer 4 与 layer 7"></a>5.3.1 layer 4 与 layer 7</h4><p>四层：IP+PORT转发<br>七层：协议+内容交换</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy38.png" alt="layer4与layer7"></p><h5 id="5-3-1-1-四层负载"><a href="#5-3-1-1-四层负载" class="headerlink" title="5.3.1.1 四层负载"></a>5.3.1.1 四层负载</h5><p>在四层负载设备中，把client发送的报文目标地址(原来是负载均衡设备的IP地址)，根据均衡设备设置的选择web服务器的规则选择对应的web服务器IP地址，这样client就可以直接跟此服务器建立TCP连接并发送数据，而四层负载自身不参与建立连接，而和LVS不同，haproxy是伪四层负载均衡，因为haproxy需要分别和前端客户端及后端服务器建立连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@haproxy ~]<span class="hljs-comment">#tcpdump tcp -i eth0  -nn port ! 22 -w dump-tcp.pcap -v</span><br>[root@haproxy ~]<span class="hljs-comment">#tcpdump tcp -i eth1  -nn port ! 22 -w dump-tcp2.pcap -v</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy39.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy40.png"></p><h4 id="5-3-2-四层IP透传（不常用）"><a href="#5-3-2-四层IP透传（不常用）" class="headerlink" title="5.3.2 四层IP透传（不常用）"></a>5.3.2 四层IP透传（不常用）</h4><p>当haproxy工作在四层的时候，可以透传客户端真实IP至后端服务器。最后通过nginx日志记录客户端IP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#haproxy 配置：</span><br>listen web_http_nodes<br> <span class="hljs-built_in">bind</span>  172.16.0.100:80<br> mode tcp       <span class="hljs-comment">#不支持http协议</span><br> balance roundrobin<br> server web1 www.wangxiaochun.com:80 send-proxy check inter 3000 fall 3<br>rise 5 <span class="hljs-comment">#添加send-proxy</span><br><span class="hljs-comment">#nginx 配置：在访问日志中通过变量$proxy_protocol_addr 记录透传过来的客户端IP</span><br>http &#123;<br>log_format main  <span class="hljs-string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot;</span><br><span class="hljs-string">&quot;$proxy_protocol_addr&quot;&#x27;</span><br> server &#123;<br>   listen    80 proxy_protocol; <span class="hljs-comment">#启用此项，将无法直接访问此网站，只能通过四层代理</span><br>访问<br>   server_name www.wangxiaochun.com;<br>......<br></code></pre></td></tr></table></figure><p>抓包可以看到 continuation 信息中带有客户端的源IP</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy41.png"></p><p>范例: nginx 开启四层日志功能</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#nginx在开启proxy_protocol前</span><br>[root@internet ~]<span class="hljs-comment">#curl 172.16.0.100</span><br>&lt;html&gt;<br>&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;<br>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@VM_0_10_centos ~]<span class="hljs-comment"># tail -f /apps/nginx/logs/nginx.access.log</span><br>111.199.187.69 - - [09/Apr/2020:20:48:51 +0800] <span class="hljs-string">&quot;PROXY TCP4 10.0.0.7 58.87.87.99</span><br><span class="hljs-string">35948 80&quot;</span> sendfileon<br>111.199.187.69 - - [09/Apr/2020:20:48:54 +0800] <span class="hljs-string">&quot;PROXY TCP4 10.0.0.7 58.87.87.99</span><br><span class="hljs-string">35952 80&quot;</span> sendfileon<br>111.199.187.69 - - [09/Apr/2020:20:48:57 +0800] <span class="hljs-string">&quot;PROXY TCP4 10.0.0.7 58.87.87.99</span><br><span class="hljs-string">35954 80&quot;</span> sendfileon<br><br><span class="hljs-comment">#在nginx服务器上开启日志格式和proxy_protocal</span><br>[root@VM_0_10_centos ~]<span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br>http &#123;<br>.......<br>log_format main  <span class="hljs-string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot;</span><br><span class="hljs-string">&quot;$proxy_protocol_addr&quot;&#x27;</span><br> sendfile    on;<br> keepalive_timeout  65;<br> client_max_body_size 100m;<br> server &#123;<br>   listen    80 default_server proxy_protocol ;<br>......<br><br><span class="hljs-comment">#nginx在开启proxy_protocol后，可以看客户端真实源IP</span><br>[root@VM_0_10_centos ~]<span class="hljs-comment"># tail -f /apps/nginx/logs/nginx.access.log</span><br>111.199.187.69 - - [09/Apr/2020:20:52:52 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span><br><span class="hljs-string">&quot;172.16.0.200&quot;</span>sendfileon<br></code></pre></td></tr></table></figure><h4 id="5-3-3-七层IP透传"><a href="#5-3-3-七层IP透传" class="headerlink" title="5.3.3 七层IP透传"></a>5.3.3 七层IP透传</h4><p>当haproxy工作在七层的时候，也可以透传客户端真实IP至后端服务器</p><h5 id="5-3-3-1-HAProxy配置"><a href="#5-3-3-1-HAProxy配置" class="headerlink" title="5.3.3.1 HAProxy配置"></a>5.3.3.1 HAProxy配置</h5><p>在由haproxy发往后端主机的请求报文中添加“X-Forwarded-For”首部，其值为前端客户端的地址；用<br>于向后端主发送真实的客户端IP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">option forwardfor [ except &lt;network&gt; ] [ header &lt;name&gt; ] [ if-none ]<br>[ except &lt;network&gt; ]：请求报请来自此处指定的网络时不予添加此首部，如haproxy自身所在网络<br>[ header &lt;name&gt; ]：使用自定义的首部名称，而非“X-Forwarded-For<span class="hljs-string">&quot;，示例：X-client</span><br><span class="hljs-string">[ if-none ] 如果没有首部才添加首部，如果有使用默认值</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#haproxy 配置</span><br>defaults <span class="hljs-comment">#（添加以下任意一行）</span><br>    option forwardfor  <span class="hljs-comment">#此为默认值,首部字段默认为：X-Forwarded-For</span><br>    option forwardfor except 127.0.0.0/8 header X-client <span class="hljs-comment">#或者自定义首部,如:X-client</span><br><br><span class="hljs-comment">#listen配置</span><br>listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance random<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure><h5 id="5-3-3-2-web服务器日志格式配置"><a href="#5-3-3-2-web服务器日志格式配置" class="headerlink" title="5.3.3.2 web服务器日志格式配置"></a>5.3.3.2 web服务器日志格式配置</h5><p>配置web服务器，记录负载均衡透传的客户端IP地址</p><p><strong>注意：如自定义首部，那么日志格式添加的内容就要填自定义的首部</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#apache 配置：</span><br>LogFormat <span class="hljs-string">&quot;%&#123;X-Forwarded-For&#125;i %a %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined<br><br><span class="hljs-comment">#nginx 日志格式：</span><br><span class="hljs-comment">#即添加下面两种格式的其一，按需求选择</span><br><span class="hljs-variable">$proxy_add_x_forwarded_for</span>：包括客户端IP和中间经过的所有代理的IP<br><span class="hljs-variable">$http_x_forwarded_For</span>：只有客户端IP<br>log_format main  <span class="hljs-string">&#x27;&quot;$proxy_add_x_forwarded_for&quot; - $remote_user [$time_local]</span><br><span class="hljs-string">&quot;$request&quot; &#x27;</span><br>           <span class="hljs-string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>           <span class="hljs-string">&#x27;&quot;$http_user_agent&quot; $http_x_forwarded_For&#x27;</span>;<br>          <br>[root@centos8 ~]<span class="hljs-comment">#tail /var/log/nginx/access.log</span><br><span class="hljs-string">&quot;172.16.0.200, 10.0.0.7&quot;</span> 10.0.0.7 - - [09/Apr/2020:19:10:16 +0800] <span class="hljs-string">&quot;GET /</span><br><span class="hljs-string">HTTP/1.1&quot;</span> 200 4057 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7</span><br><span class="hljs-string">NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span><br><br><span class="hljs-comment">#tomcat 配置：conf目录下的server.xml</span><br>&lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="hljs-string">&quot;logs&quot;</span><br> prefix=<span class="hljs-string">&quot;localhost_access_log&quot;</span> suffix=<span class="hljs-string">&quot;.txt&quot;</span><br> pattern=<span class="hljs-string">&quot;%&#123;X-Forwarded-For&#125;i %h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;  <br></code></pre></td></tr></table></figure><h5 id="5-3-3-3-验证客户端IP地址"><a href="#5-3-3-3-验证客户端IP地址" class="headerlink" title="5.3.3.3 验证客户端IP地址"></a>5.3.3.3 验证客户端IP地址</h5><p>apache日志：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/httpd/conf/httpd.conf</span><br>LogFormat <span class="hljs-string">&quot;%&#123;X-Forwarded-For&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined<br><br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart httpd</span><br><br>[root@centos6 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.6<br><br>[root@centos6 ~]<span class="hljs-comment">#curl  http://10.0.0.7</span><br>10.0.0.17<br><br>[root@centos7 ~]<span class="hljs-comment">#tail -f /var/log/httpd/access_log</span><br>10.0.0.6 10.0.0.7 - - [01/Apr/2020:01:08:31 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span><br><span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span><br><span class="hljs-string">libidn/1.18 libssh2/1.4.2&quot;</span><br>10.0.0.6 10.0.0.7 - - [01/Apr/2020:01:08:33 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span><br><span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span><br><span class="hljs-string">libidn/1.18 libssh2/1.4.2&quot;</span><br></code></pre></td></tr></table></figure><h3 id="5-4-报文修改"><a href="#5-4-报文修改" class="headerlink" title="5.4 报文修改"></a>5.4 报文修改</h3><p>在http模式下，基于实际需求修改客户端的请求报文与响应报文，通过reqadd和reqdel在请求报文添加删除字段，通过rspadd与rspidel在响应报文中添加与删除字段。</p><p>注意：此功能的以下相关指令在2.1版本中已经取消</p><p>官方文档：参看2.0的帮助文档</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4-rspadd<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在向后端服务器转发的请求报文尾部添加指定首部</span><br>reqadd &lt;string&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]<br>示例：reqadd X-Via:\ HAproxy  <span class="hljs-comment">#注意只能有一个空格，并需要转义</span><br><br><span class="hljs-comment">#在向后端服务器转发的请求报文中删除匹配正则表达式的首部</span><br>reqdel &lt;search&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]<br>reqidel &lt;search&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]  <span class="hljs-comment">#忽略大小写</span><br>示例：<br>reqidel user-agent<br>reqidel X-Forwarded-For <span class="hljs-comment">#无法删除</span><br><br><span class="hljs-comment">#在向前端客户端转发的响应报文尾部添加指定首部</span><br>rspadd &lt;string&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]<br>示例：<br>rspadd X-Via:\ HAproxy<br>rspadd Server:\ wanginx<br><br><span class="hljs-comment">#从向前端客户端转发的响应报文中删除匹配正则表达式的首部</span><br>rspdel &lt;search&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]<br>rspidel &lt;search&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]  <span class="hljs-comment">#忽略大小写</span><br>示例：<br>rspidel ^server:.* <span class="hljs-comment">#从响应报文删除server信息</span><br>rspidel X-Powered-By:.* <span class="hljs-comment">#从响应报文删除X-Powered-By信息,一般此首部字段保存php版本信息 #</span><br></code></pre></td></tr></table></figure><p>2.1版本以上用下面指令http-request和http-response代替<br>官方文档：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-http-request<br>http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-http-response<br></code></pre></td></tr></table></figure><p>配置说明：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#添加请求报文</span><br>http-request add-header &lt;name&gt; &lt;fmt&gt; [ &#123; <span class="hljs-keyword">if</span> | unless &#125; &lt;condition&gt; ]<br><span class="hljs-comment">#示例：http-request add-header X-Haproxy-Current-Date %T</span><br><span class="hljs-comment">#删除请求报文</span><br>http-request del-header &lt;name&gt; [ &#123; <span class="hljs-keyword">if</span> | unless &#125; &lt;condition&gt; ]<br><br><span class="hljs-comment">#添加响应报文</span><br>http-response add-header &lt;name&gt; &lt;fmt&gt; [ &#123; <span class="hljs-keyword">if</span> | unless &#125; &lt;condition&gt; ]<br><span class="hljs-comment">#删除响应报文</span><br>http-response del-header &lt;name&gt;<br><span class="hljs-comment">#示例：http-response del-header Server</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#添加向后端报务器发起的请求报文首部</span><br>vim haproxy.cfg<br>frontend main *:80<br><span class="hljs-comment">#    bind *:80</span><br>   default_backend websrvs<br>   reqadd testheader:\ haproxyserver  <span class="hljs-comment">#加此行,注意只能有一个空格，并需要转义</span><br><br><span class="hljs-comment">#在后端httpd服务器</span><br>vim /etc/httpd/conf/httpd.conf<br>LogFormat <span class="hljs-string">&quot;%&#123;testheader&#125;i %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined<br><br><span class="hljs-comment">#查看日志</span><br>tail –f /var/<span class="hljs-built_in">log</span>/httpd/acesss_log<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#删除向后端服务器发起的请求报文首部</span><br>vim haproxy.cfg<br>frontend main *:80<br><span class="hljs-comment">#    bind *:80</span><br>   default_backend websrvs<br>   reqdel User-Agent <span class="hljs-comment">#或reqidel user-agent #忽略大小写</span><br>   <br><span class="hljs-comment">#查看后端服务器日志</span><br>[root@web1 ~]<span class="hljs-comment"># tail -f /var/log/httpd/access_log</span><br><span class="hljs-comment">#删除User-Agent前</span><br>10.0.0.7 - - [06/Jun/2021:16:30:04 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br>10.0.0.7 - - [06/Jun/2021:16:30:05 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br>10.0.0.7 - - [06/Jun/2021:16:30:06 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br><span class="hljs-comment">#删除User-Agent后</span><br>10.0.0.7 - - [06/Jun/2021:16:30:07 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br>10.0.0.7 - - [06/Jun/2021:16:30:08 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br>10.0.0.7 - - [06/Jun/2021:16:30:09 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#添加响应报文首部</span><br>vim haproxy.cfg<br>frontend main *:80<br><span class="hljs-comment">#    bind *:80</span><br>   default_backend websrvs<br>   rspadd X-Via:\ HAproxy-1  <span class="hljs-comment">#加此行</span><br>   maxconn     5000<br><br><span class="hljs-comment">#客户端访问调试模式,查看reponse headers，看到</span><br>Server: Apache/2.4.37 (centos)  <span class="hljs-comment">#系统自带显示</span><br>X-Via: HAproxy-1<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#删除响应报文中的server首部</span><br>vim haproxy.cfg<br>frontend main *:80<br><span class="hljs-comment">#    bind *:80</span><br>   default_backend websrvs<br>   rspadd X-Via:\ HAproxy-1<br>   rspidel Server <span class="hljs-comment">#或者 rspidel server   #加此行 ,忽略大小写</span><br>   rsqidel X-Powered-By:.* <span class="hljs-comment">#删除Php版本</span><br>   maxconn     5000<br><br><span class="hljs-comment">#客户端访问调试模式,查看reponse headers，看到</span><br>Server: Apache/2.4.37 (centos)  <span class="hljs-comment">#此行消失</span><br>X-Via: HAproxy-1<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#增加响应报文的首部，实现伪装Server首部</span><br>vim haproxy.cfg<br>frontend main *:80<br><span class="hljs-comment">#    bind *:80</span><br>   default_backend websrvs<br>   rspadd X-Via:\ HAproxy-1<br>   rspdel Server  <span class="hljs-comment">#或者用 rspidel server</span><br>   rspadd Server:\  wanginx  <span class="hljs-comment">#增加此行</span><br><br>[root@internet ~]<span class="hljs-comment">#curl -i  172.16.0.100</span><br>HTTP/1.1 200 OK<br>date: Thu, 09 Apr 2020 08:32:10 GMT<br>last-modified: Thu, 09 Apr 2020 01:23:18 GMT<br>etag: <span class="hljs-string">&quot;f-5a2d17630635b&quot;</span><br>accept-ranges: bytes<br>content-length: 15<br>content-type: text/html; charset=UTF-8<br>server: wanginx<br><br>RS1 10.0.0.17<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#新版本的写法</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br>listen web_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>http-request add-header X-Haproxy-Current-Date %T <span class="hljs-comment">#添加请求报文首部</span><br>http-response del-header server <span class="hljs-comment">#删除响应报文首部</span><br>mode http<br><span class="hljs-built_in">log</span> global<br>option httpchk<br>http-check expect status 200<br>server web1  10.0.0.17:80 check inter 3000 fall 2 rise 5<br>server web2  10.0.0.27:80 check inter 3000 fall 2 rise 5<br><br><span class="hljs-comment">#查看后端服务器日志</span><br>tail –f /var/<span class="hljs-built_in">log</span>/httpd/acesss_log<br>10.0.0.7 - - [05/Apr/2020:20:13:48 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span><br><span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) l</span><br><span class="hljs-string">ibcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span><br><span class="hljs-string">&quot;05/Apr/2020:12:13:48 +0000&quot;</span><br></code></pre></td></tr></table></figure><h3 id="5-5-自定义日志格式"><a href="#5-5-自定义日志格式" class="headerlink" title="5.5 自定义日志格式"></a>5.5 自定义日志格式</h3><p>log global 开启日志功能，默认只会在记录下面格式的日志</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">[root@haproxy ~]#tail /var/log/haproxy.log<br>Apr 9 19:38:46 localhost haproxy[60049]: Connect from 172.16.0.200:54628 to<br>172.16.0.100:80 (web_prot_http_nodes/HTTP)<br></code></pre></td></tr></table></figure><p>option httplog 可以用 http 格式记录下来，并且可以使用相关指令将特定信息记录在haproxy的日志中<strong>但一般不建议开启</strong>，这会加重 HAProxy 负载</p><h4 id="5-5-1-配置选项"><a href="#5-5-1-配置选项" class="headerlink" title="5.5.1 配置选项"></a>5.5.1 配置选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">log</span> global <span class="hljs-comment">#开启记录日志,默认不开启</span><br>option httplog                <span class="hljs-comment">#开启记录httplog日志格式选项</span><br>capture cookie &lt;name&gt; len &lt;length&gt; <span class="hljs-comment">#捕获请求和响应报文中的 cookie及值的长度,将之记录到日志</span><br>capture request header &lt;name&gt; len &lt;length&gt; <span class="hljs-comment">#捕获请求报文中指定的首部内容和长度并记录日志</span><br>capture response header &lt;name&gt; len &lt;length&gt; <span class="hljs-comment">#捕获响应报文中指定的内容和长度首部并记录日志</span><br><br><span class="hljs-comment">#示例：</span><br><span class="hljs-built_in">log</span> global<br>option httplog<br>capture request header Host len  256<br>capture request header User-Agent len 512<br>capture request header Referer len 15<br>capture request header X-Forwarded-For len 15<br></code></pre></td></tr></table></figure><p>同时开启日志功能log global和option httplog，记录日志格式如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@haproxy ~]<span class="hljs-comment">#tail /var/log/haproxy.log</span><br>Apr  9 19:42:02 localhost haproxy[60236]: 172.16.0.200:54630<br>[09/Apr/2020:19:42:02.623] web_prot_http_nodes web_prot_http_nodes/web1<br>0/0/1/1/2 200 4264 - - ---- 1/1/0/0/0 0/0 <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span><br></code></pre></td></tr></table></figure><h4 id="5-5-2-配置示例"><a href="#5-5-2-配置示例" class="headerlink" title="5.5.2 配置示例"></a>5.5.2 配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global <span class="hljs-comment">#开启日志功能</span><br>option httplog <span class="hljs-comment">#开启httplog日志格式选项</span><br>capture request header User-Agent len 512 <span class="hljs-comment">#记录日志信息,记录User-Agent首</span><br>部值的前512个字符<br>capture request header Host len  256 <span class="hljs-comment">#记录日志信息,记录Host首部值</span><br>cookie SERVER-COOKIE insert indirect nocache<br>server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5<br>server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5<br></code></pre></td></tr></table></figure><h4 id="5-5-3-验证日志格式"><a href="#5-5-3-验证日志格式" class="headerlink" title="5.5.3 验证日志格式"></a>5.5.3 验证日志格式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#tail -n3 /var/log/haproxy.log</span><br>Apr  2 12:44:26 localhost haproxy[27637]: 10.0.0.6:50004<br>[02/Apr/2020:12:44:26.817] web_port web_port/web1 0/0/0/2/3 200 42484 - - --NI<br>1/1/0/0/0 0/0 &#123;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1<br>zlib/1.2.3 libidn/1.18 libssh2/1.4.2|10.0.0.7&#125; <span class="hljs-string">&quot;GET /test.php HTTP/1.1&quot;</span><br>Apr  2 12:44:27 localhost haproxy[27637]: 10.0.0.6:50006<br>[02/Apr/2020:12:44:27.294] web_port web_port/web2 0/0/0/1/1 404 370 - - --NI<br>1/1/0/0/0 0/0 &#123;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1<br>zlib/1.2.3 libidn/1.18 libssh2/1.4.2|10.0.0.7&#125; <span class="hljs-string">&quot;GET /test.php HTTP/1.1&quot;</span><br>Apr  2 12:44:27 localhost haproxy[27637]: 10.0.0.6:50008<br>[02/Apr/2020:12:44:27.840] web_port web_port/web1 0/0/0/3/4 200 42484 - - --NI<br>1/1/0/0/0 0/0 &#123;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1<br>zlib/1.2.3 libidn/1.18 libssh2/1.4.2|10.0.0.7&#125; <span class="hljs-string">&quot;GET /test.php HTTP/1.1&quot;</span><br></code></pre></td></tr></table></figure><h3 id="5-6-压缩功能"><a href="#5-6-压缩功能" class="headerlink" title="5.6 压缩功能"></a>5.6 压缩功能</h3><p>对响应给客户端的报文进行压缩，以节省网络带宽，但是会占用部分CPU性能</p><p><strong>建议在后端服务器开启压缩功能，而非在HAProxy上开启压缩</strong></p><h4 id="5-6-1-配置选项"><a href="#5-6-1-配置选项" class="headerlink" title="5.6.1 配置选项"></a>5.6.1 配置选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">compression algo &lt;algorithm&gt; ... <span class="hljs-comment">#启用http协议中的压缩机制，常用算法有 gzip，deflate</span><br><br><span class="hljs-comment">#压缩算法&lt;algorithm&gt;支持下面类型：</span><br>    identity                     <span class="hljs-comment">#debug调试使用的压缩方式</span><br>    gzip                         <span class="hljs-comment">#常用的压缩方式，与各浏览器兼容较好</span><br>    deflate                      <span class="hljs-comment">#有些浏览器不支持</span><br>    raw-deflate                  <span class="hljs-comment">#新式的压缩方式</span><br>    compression <span class="hljs-built_in">type</span> &lt;mime <span class="hljs-built_in">type</span>&gt; ... <span class="hljs-comment">#要压缩的文件类型</span><br><br><span class="hljs-comment">#示例：</span><br>compression algo gzip deflate<br>compression <span class="hljs-built_in">type</span> text/html text/css text/plain<br></code></pre></td></tr></table></figure><h4 id="5-6-2-配置示例"><a href="#5-6-2-配置示例" class="headerlink" title="5.6.2 配置示例"></a>5.6.2 配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    balance roundrobin<br>    <span class="hljs-built_in">log</span> global<br>    option httplog<br>    compression algo gzip deflate  <span class="hljs-comment">#启用压缩和指定算法</span><br>    compression <span class="hljs-built_in">type</span> compression <span class="hljs-built_in">type</span> text/plain text/html text/css text/xml<br>    text/javascript application/javascript       <span class="hljs-comment">#指定压缩文件类型</span><br>    server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5<br>    server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5<br><br><span class="hljs-comment">#后端服务器准备一个文本文件</span><br>[root@centos7 ~]<span class="hljs-comment">#ll /var/www/html/m.txt -h</span><br>-rwxr-xr-x 1 root root 772K Apr  2 12:56 /var/www/html/m.txt<br></code></pre></td></tr></table></figure><h4 id="5-6-3-验证压缩功能"><a href="#5-6-3-验证压缩功能" class="headerlink" title="5.6.3 验证压缩功能"></a>5.6.3 验证压缩功能</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -is --compressed  10.0.0.7/m.txt|less</span><br>HTTP/1.1 200 OK<br>date: Thu, 02 Apr 2020 05:00:26 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>last-modified: Thu, 02 Apr 2020 04:56:25 GMT<br>etag: W/<span class="hljs-string">&quot;c0ef6-5a2479f7aee68&quot;</span><br>accept-ranges: bytes<br>content-type: text/plain; charset=UTF-8<br>set-cookie: WEBSRV=web1; path=/<br>cache-control: private<br>content-encoding: deflate<br>transfer-encoding: chunked<br>vary: Accept-Encoding<br>Feb  2 18:49:27 centos7 journal: Runtime journal is using 6.0M (max allowed<br>48.6M, trying to leave 72.9M free of 480.1M available → current <span class="hljs-built_in">limit</span> 48.6M).<br>Feb  2 18:49:27 centos7 kernel: Initializing cgroup subsys cpuset<br>Feb  2 18:49:27 centos7 kernel: Initializing cgroup subsys cpu<br>Feb  2 18:49:27 centos7 kernel: Initializing cgroup subsys cpuacct<br>......<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy42.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy43.png"></p><h3 id="5-7-web服务器状态监测"><a href="#5-7-web服务器状态监测" class="headerlink" title="5.7 web服务器状态监测"></a>5.7 web服务器状态监测</h3><h4 id="5-7-1-三种状态监测方式"><a href="#5-7-1-三种状态监测方式" class="headerlink" title="5.7.1 三种状态监测方式"></a>5.7.1 三种状态监测方式</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">基于四层的传输端口做状态监测，此为默认方式<br>基于GET方法指定 URI 做状态监测,需要访问整个页面资源,占用更多带宽<br>基于HEAD方法指定 URI 的request请求头部内容做状态监测，占用较少带宽,建议使用此方式<br></code></pre></td></tr></table></figure><h4 id="5-7-2-基于应用层http协议进行健康性检测"><a href="#5-7-2-基于应用层http协议进行健康性检测" class="headerlink" title="5.7.2 基于应用层http协议进行健康性检测"></a>5.7.2 基于应用层http协议进行健康性检测</h4><p>基于应用层http协议，采有不同的监测方式，对后端real server进行状态监测<br>注意: 此方式会导致在后端服务器生成很多的HAProxy发起的访问日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">option httpchk  <span class="hljs-comment">#启用七层健康性检测，对tcp 和 http 模式都支持，默认为：OPTIONS / HTTP/1.0</span><br><span class="hljs-comment">#下面为检测自定义网页</span><br>option httpchk &lt;uri&gt; <span class="hljs-comment">#此项是看改uri是否支持OPTIONS这个&lt;method&gt;方法，不是真实的访问该uri页面</span><br>option httpchk &lt;method&gt; &lt;uri&gt;<br>option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;<br><br><span class="hljs-comment">#期望以上检查得到的响应码</span><br>http-check expect [!] &lt;match&gt; &lt;pattern&gt;<br><span class="hljs-comment">#示例：</span><br>http-check expect status 200<br>http-check expect ! rstatus ^5 <span class="hljs-comment">#支持正则表达式</span><br><br><span class="hljs-comment">#关于HTTP/1.1的说明</span><br>&lt;version&gt; is the optional HTTP version string. It defaults to <span class="hljs-string">&quot;HTTP/1.0&quot;</span> but some servers might behave incorrectly <span class="hljs-keyword">in</span> HTTP 1.0, so turning it to HTTP/1.1 may sometimes <span class="hljs-built_in">help</span>. Note that the Host field is mandatory <span class="hljs-keyword">in</span> HTTP/1.1, and as a trick, it is possible to pass it after <span class="hljs-string">&quot;\r\n&quot;</span> following the version string.<br></code></pre></td></tr></table></figure><h4 id="5-7-3-配置示例"><a href="#5-7-3-配置示例" class="headerlink" title="5.7.3 配置示例"></a>5.7.3 配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br> <span class="hljs-comment">#option httpchk GET /monitor/check.html #默认HTTP/1.0</span><br> <span class="hljs-comment">#option httpchk GET /monitor/check.html HTTP/1.0</span><br> <span class="hljs-comment">#option httpchk GET /monitor/check.html HTTP/1.1 #注意：HTTP/1.1强制要求必须有Host字段</span><br>option httpchk HEAD /monitor/check.html HTTP/1.1\r\nHost:\ 10.0.0.7 <span class="hljs-comment">#使用HEAD减少网络流量</span><br>cookie SERVER-COOKIE insert indirect nocache<br>server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5<br>server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5<br><br><span class="hljs-comment">#在所有后端服务建立检测页面</span><br>[root@backend ~]<span class="hljs-comment">#mkdir /var/www/html/monitor/</span><br>[root@backend ~]<span class="hljs-comment">#echo monitor &gt; /var/www/html/monitor/check.html</span><br><br><span class="hljs-comment">#关闭一台Backend服务器</span><br>[root@backend1 ~]<span class="hljs-comment">#systemctl stop httpd</span><br></code></pre></td></tr></table></figure><h4 id="5-7-4-验证http监测"><a href="#5-7-4-验证http监测" class="headerlink" title="5.7.4 验证http监测"></a>5.7.4 验证http监测</h4><p>查看到状态页，可以看到启了七层检测功能：<strong>LastChk字段：L7</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy44.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#后端服务器查看访问日志</span><br>[root@backend ~]<span class="hljs-comment">#tail /var/log/httpd/access_log</span><br>10.0.0.7 - - [02/Apr/2020:14:25:22 +0800] <span class="hljs-string">&quot;HEAD /monitor/check.html HTTP/1.1&quot;</span><br>200 - <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span><br>10.0.0.7 - - [02/Apr/2020:14:25:25 +0800] <span class="hljs-string">&quot;HEAD /monitor/check.html HTTP/1.1&quot;</span><br>200 - <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span><br>10.0.0.7 - - [02/Apr/2020:14:25:28 +0800] <span class="hljs-string">&quot;HEAD /monitor/check.html HTTP/1.1&quot;</span><br>200 - <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span><br></code></pre></td></tr></table></figure><h3 id="5-8-ACL"><a href="#5-8-ACL" class="headerlink" title="5.8 ACL"></a>5.8 ACL</h3><p>访问控制列表（ACL，Access Control Lists）是一种基于包过滤的访问控制技术，它可以根据设定的条件对经过服务器传输的数据包进行过滤(条件匹配)，即对接收到的报文进行匹配和过滤，基于请求报文头部中的源地址、源端口、目标地址、目标端口、请求方法、URL、文件后缀等信息内容进行匹配并执行进一步操作，比如允许其通过或丢弃。<br>官方帮助</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7<br>http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#7<br></code></pre></td></tr></table></figure><h4 id="5-8-1-ACL配置选项"><a href="#5-8-1-ACL配置选项" class="headerlink" title="5.8.1 ACL配置选项"></a>5.8.1 ACL配置选项</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">acl  &lt;aclname&gt; &lt;criterion&gt;  [flags]   [operator]  [&lt;value&gt;]<br>acl   名称        匹配规范     匹配模式    具体操作符   操作对象类型<br></code></pre></td></tr></table></figure><h5 id="5-8-1-1-ACL-Name"><a href="#5-8-1-1-ACL-Name" class="headerlink" title="5.8.1.1 ACL-Name"></a>5.8.1.1 ACL-Name</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">acl  image_service hdr_dom(host)  -i  img.magedu.com<br><br><span class="hljs-comment">#ACL名称，可以使用大字母A-Z、小写字母a-z、数字0-9、冒号：、点.、中横线和下划线，并且严格区分大小写，比如:my_acl和My_Acl就是两个完全不同的acl</span><br></code></pre></td></tr></table></figure><h5 id="5-8-1-2-ACL-criterion"><a href="#5-8-1-2-ACL-criterion" class="headerlink" title="5.8.1.2 ACL-criterion"></a>5.8.1.2 ACL-criterion</h5><p><strong>定义ACL匹配规范，即：判断条件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs bash">hdr string，提取在一个HTTP请求报文的首部<br>hdr（[&lt;name&gt; [，&lt;occ&gt;]]）：完全匹配字符串,header的指定信息，&lt;occ&gt; 表示在多值中使用的值的出<br>现次数<br>hdr_beg（[&lt;name&gt; [，&lt;occ&gt;]]）：前缀匹配，header中指定匹配内容的begin<br>hdr_end（[&lt;name&gt; [，&lt;occ&gt;]]）：后缀匹配，header中指定匹配内容end<br>hdr_dom（[&lt;name&gt; [，&lt;occ&gt;]]）：域匹配，header中的domain name<br>hdr_dir（[&lt;name&gt; [，&lt;occ&gt;]]）：路径匹配，header的uri路径<br>hdr_len（[&lt;name&gt; [，&lt;occ&gt;]]）：长度匹配，header的长度匹配<br>hdr_reg（[&lt;name&gt; [，&lt;occ&gt;]]）：正则表达式匹配，自定义表达式(regex)模糊匹配<br>hdr_sub（[&lt;name&gt; [，&lt;occ&gt;]]）：子串匹配，header中的uri模糊匹配<br><br><span class="hljs-comment">#示例：</span><br>hdr(&lt;string&gt;) 用于测试请求头部首部指定内容<br>hdr_dom(host) 请求的host名称，如 www.magedu.com<br>hdr_beg(host) 请求的host开头，如 www.  img.  video.  download.  ftp.<br>hdr_end(host) 请求的host结尾，如 .com  .net  .cn<br><br><span class="hljs-comment">#示例：</span><br>acl bad_agent hdr_sub(User-Agent) -i curl wget<br>block <span class="hljs-keyword">if</span> bad_agent<br><br><span class="hljs-comment">#有些功能是类似的，比如以下几个都是匹配用户请求报文中host的开头是不是www</span><br>acl short_form hdr_beg(host)    www.<br>acl alternate1 hdr_beg(host) -m beg www.<br>acl alternate2 hdr_dom(host) -m beg www.<br>acl alternate3 hdr(host)   -m beg www.<br><br>base : string<br><span class="hljs-comment">#返回第一个主机头和请求的路径部分的连接，该请求从主机名开始，并在问号之前结束,对虚拟主机有用</span><br>&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@<span class="hljs-comment">#&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;#?&lt;query&gt;#&lt;frag&gt;</span><br>base   : exact string match<br>base_beg : prefix match<br>base_dir : subdir match<br>base_dom : domain match<br>base_end : suffix match<br>base_len : length match<br>base_reg : regex match<br>base_sub : substring match<br><br>path : string<br><span class="hljs-comment">#提取请求的URL路径，该路径从第一个斜杠开始，并在问号之前结束（无主机部分）</span><br>&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;<span class="hljs-comment">#/&lt;path&gt;;&lt;params&gt;#?&lt;query&gt;#&lt;frag&gt;</span><br>path   : exact string match<br>path_beg : prefix match  <span class="hljs-comment">#请求的URL开头，如/static、/images、/img、/css</span><br>path_end : suffix match  <span class="hljs-comment">#请求的URL中资源的结尾，如 .gif .png .css .js .jpg .jpeg</span><br>path_dom : domain match<br>path_dir : subdir match<br>path_len : length match<br>path_reg : regex match<br>path_sub : substring match<br><br><span class="hljs-comment">#示例：</span><br>path_beg -i /haproxy-status/<br>path_end .jpg .jpeg .png .gif<br>path_reg ^/images.*\.jpeg$<br>path_sub image <br><br>url : string<br><span class="hljs-comment">#提取请求中的整个URL。一个典型的应用是具有预取能力的缓存，以及需要从数据库聚合多个信息并将它们保</span><br>存在缓存中的网页门户入口，推荐使用path<br>url ：exact string match<br>url_beg : prefix match<br>url_dir : subdir match<br>url_dom : domain match<br>url_end : suffix match<br>url_len : length match<br>url_reg : regex match<br>url_sub : substring match<br><br>dst <span class="hljs-comment">#目标IP</span><br>dst_port <span class="hljs-comment">#目标PORT</span><br><br>src  <span class="hljs-comment">#源IP</span><br>src_port <span class="hljs-comment">#源PORT</span><br><br><span class="hljs-comment">#示例：</span><br>acl invalid_src src 10.0.0.7 192.168.1.0/24<br>acl invalid_src src 172.16.0.0/24<br><br>acl invalid_port src_port 0:1023<br><br>status : <span class="hljs-built_in">integer</span>  <span class="hljs-comment">#返回在响应报文中的状态码</span><br><br><span class="hljs-comment">#七层协议</span><br>acl valid_method method GET HEAD<br>http-request deny <span class="hljs-keyword">if</span> ! valid_method<br></code></pre></td></tr></table></figure><h5 id="5-8-1-3-ACL-flags"><a href="#5-8-1-3-ACL-flags" class="headerlink" title="5.8.1.3 ACL-flags"></a>5.8.1.3 ACL-flags</h5><p>ACL匹配模式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">-i 不区分大小写<br>-m 使用指定的pattern匹配方法<br>-n 不做DNS解析<br>-u 禁止acl重名，否则多个同名ACL匹配或关系<br></code></pre></td></tr></table></figure><h5 id="5-8-1-4-ACL-operator"><a href="#5-8-1-4-ACL-operator" class="headerlink" title="5.8.1.4 ACL-operator"></a>5.8.1.4 ACL-operator</h5><p>ACL 操作符</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">整数比较：eq、ge、gt、le、lt<br>字符比较：<br>- exact match   (-m str) :字符串必须完全匹配模式<br>- substring match (-m sub) :在提取的字符串中查找模式，如果其中任何一个被发现，ACL将匹配<br>- prefix match  (-m beg) :在提取的字符串首部中查找模式，如果其中任何一个被发现，ACL将匹<br>配<br>- suffix match  (-m end) :将模式与提取字符串的尾部进行比较，如果其中任何一个匹配，则ACL<br>进行匹配<br>- subdir match  (-m dir) :查看提取出来的用斜线分隔（“/<span class="hljs-string">&quot;）的字符串，如其中任一个匹配，则</span><br><span class="hljs-string">ACL进行匹配</span><br><span class="hljs-string">- domain match  (-m dom) :查找提取的用点（“.&quot;</span>）分隔字符串，如果其中任何一个匹配，则ACL<br>进行匹配<br></code></pre></td></tr></table></figure><h5 id="5-8-1-5-ACL-value"><a href="#5-8-1-5-ACL-value" class="headerlink" title="5.8.1.5 ACL-value"></a>5.8.1.5 ACL-value</h5><p>value的类型</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">The ACL engine can match these types against patterns of the following types :<br>- Boolean <span class="hljs-comment">#布尔值</span><br>- <span class="hljs-built_in">integer</span> or <span class="hljs-built_in">integer</span> range <span class="hljs-comment">#整数或整数范围，比如用于匹配端口范围</span><br>- IP address / network <span class="hljs-comment">#IP地址或IP范围, 192.168.0.1 ,192.168.0.1/24</span><br>- string--&gt; www.magedu.com<br>exact –精确比较<br>substring—子串<br>suffix-后缀比较<br>prefix-前缀比较<br>subdir-路径， /wp-includes/js/jquery/jquery.js<br>domain-域名，www.magedu.com<br>- regular expression <span class="hljs-comment">#正则表达式</span><br>- hex block <span class="hljs-comment">#16进制</span><br></code></pre></td></tr></table></figure><h4 id="5-8-2-多个ACL的组合调用方式"><a href="#5-8-2-多个ACL的组合调用方式" class="headerlink" title="5.8.2 多个ACL的组合调用方式"></a>5.8.2 多个ACL的组合调用方式</h4><p>多个ACL的逻辑处理</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">与：隐式（默认）使用<br>或：使用“or&quot; 或 “||&quot;表示<br>否定：使用 &quot;!&quot; 表示<br></code></pre></td></tr></table></figure><p><strong>多个ACL调用方式：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#示例：</span><br><span class="hljs-keyword">if</span> valid_src valid_port <span class="hljs-comment">#与关系，ACL中A和B都要满足为true，默认为与</span><br><span class="hljs-keyword">if</span> invalid_src || invalid_port  <span class="hljs-comment">#或，ACL中A或者B满足一个为true</span><br><span class="hljs-keyword">if</span> ! invalid_src <span class="hljs-comment">#非，取反，不满足ACL才为true</span><br></code></pre></td></tr></table></figure><h4 id="5-8-3-ACL示例-域名匹配"><a href="#5-8-3-ACL示例-域名匹配" class="headerlink" title="5.8.3 ACL示例-域名匹配"></a>5.8.3 ACL示例-域名匹配</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl pc_domain hdr_dom(host)    -i www.magedu.org<br>acl mobile_domain hdr_dom(host)  -i mobile.magedu.org<br><br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend pc_hosts <span class="hljs-keyword">if</span> pc_domain<br>use_backend mobile_hosts <span class="hljs-keyword">if</span> mobile_domain<br>default_backend pc_hosts  <span class="hljs-comment">#所有ACL都不匹配,则使用的默认backend</span><br><br><span class="hljs-comment">###################### backend hosts #############################</span><br>ackend mobile_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure><p>测试结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#cat /etc/hosts</span><br>127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4<br>centos6.localdomain<br>::1     localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.0.0.7 mobile.magedu.org www.magedu.org magedu.org<br><br>[root@centos6 ~]<span class="hljs-comment">#curl www.magedu.org</span><br>10.0.0.27<br>[root@centos6 ~]<span class="hljs-comment">#curl mobile.magedu.org</span><br>10.0.0.17<br>[root@centos6 ~]<span class="hljs-comment">#curl magedu.org</span><br>10.0.0.27<br></code></pre></td></tr></table></figure><h4 id="5-8-4-ACL示例-基于源IP或子网调度访问"><a href="#5-8-4-ACL示例-基于源IP或子网调度访问" class="headerlink" title="5.8.4 ACL示例-基于源IP或子网调度访问"></a>5.8.4 ACL示例-基于源IP或子网调度访问</h4><p>将指定的源地址调度至指定的web服务器组。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl pc_domain hdr_dom(host)    -i www.magedu.org<br>acl mobile_domain hdr_dom(host)  -i mobile.magedu.org<br>acl ip_range_test src 172.18.0.0/16 10.0.0.6   <span class="hljs-comment">#基于源地址的ACL,定义多个ACL的顺序无关</span><br>acl ip_range_test2 src 172.18.0.200<br><br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend pc_hosts     <span class="hljs-keyword">if</span>  ip_range_test  <span class="hljs-comment">#放在前面的ACL规则优先生效,引用ACL时,严格的ACL应放在前面</span><br>use_backend pc_hosts     <span class="hljs-keyword">if</span>  pc_domain<br>use_backend mobile_hosts   <span class="hljs-keyword">if</span>  mobile_domain<br>default_backend pc_hosts<br><br><span class="hljs-comment">###################### backend hosts #############################</span><br>backend mobile_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure><p>测试结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.6<br>[root@centos6 ~]<span class="hljs-comment">#curl www.magedu.org</span><br>10.0.0.27<br>[root@internet ~]<span class="hljs-comment">#curl -H &quot;HOST: www.magedu.org&quot; 10.0.0.7</span><br>10.0.0.27<br>[root@centos6 ~]<span class="hljs-comment">#curl mobile.magedu.org</span><br>10.0.0.27<br>[root@centos6 ~]<span class="hljs-comment">#curl magedu.org</span><br>10.0.0.27<br>[root@centos8 ~]<span class="hljs-comment">#curl mobile.magedu.org</span><br>10.0.0.17<br>[root@centos8 ~]<span class="hljs-comment">#curl www.magedu.org</span><br>10.0.0.27<br>[root@centos8 ~]<span class="hljs-comment">#curl magedu.org</span><br>10.0.0.27<br></code></pre></td></tr></table></figure><h4 id="5-8-5-ACL示例-基于源地址的访问控制"><a href="#5-8-5-ACL示例-基于源地址的访问控制" class="headerlink" title="5.8.5 ACL示例-基于源地址的访问控制"></a>5.8.5 ACL示例-基于源地址的访问控制</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy45.png"></p><p>拒绝指定IP或者IP范围访问</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl acl_deny_src src 10.0.0.6 192.168.0.0/24<br><br><span class="hljs-comment">###################### acl hosts #################################</span><br>http-request deny  <span class="hljs-keyword">if</span> acl_deny_src  <span class="hljs-comment">#2.1版本后，不再支持block，拒绝指定IP</span><br> <span class="hljs-comment">#block if acl_deny_src 拒绝指定IP</span><br> <span class="hljs-comment">#http-request allow</span><br>default_backend default_web<br><br><span class="hljs-comment">###################### backend hosts #############################</span><br>backend magedu_host<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend default_web<br>mode http<br>server web1 10.0.0.27:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure><p>测试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl www.magedu.org</span><br>&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;<br>Request forbidden by administrative rules.<br>&lt;/body&gt;&lt;/html&gt;<br></code></pre></td></tr></table></figure><h4 id="5-8-6-ACL示例-匹配浏览器类型"><a href="#5-8-6-ACL示例-匹配浏览器类型" class="headerlink" title="5.8.6 ACL示例-匹配浏览器类型"></a>5.8.6 ACL示例-匹配浏览器类型</h4><p>匹配客户端浏览器，将不同类型的浏览器调动至不同的服务器组<br>范例: 163 网易拒绝curl和wget的访问</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu2004 ~]<span class="hljs-comment">#curl -I www.163.com</span><br>HTTP/1.1 403 Forbidden<br>Date: Fri, 01 Jan 2021 06:57:22 GMT<br>Content-Type: text/html<br>Content-Length: 237<br>Connection: keep-alive<br>Server: web cache<br>Expires: Fri, 01 Jan 2021 06:57:22 GMT<br>X-Ser: BC17_lt-shandong-zaozhuang-6-cache-1<br>Cache-Control: no-cache,no-store,private<br>cdn-user-ip: 111.199.184.218<br>cdn-ip: 124.132.138.17<br>X-Cache-Remote: HIT<br>cdn-source: baishan<br><br>[root@ubuntu2004 ~]<span class="hljs-comment">#curl -I -A &quot;wget&quot; www.163.com</span><br>HTTP/1.1 403 Forbidden<br>Date: Fri, 01 Jan 2021 06:58:13 GMT<br>Content-Type: text/html<br>Content-Length: 237<br>Connection: keep-alive<br>Server: web cache<br>Expires: Fri, 01 Jan 2021 06:58:13 GMT<br>X-Ser: BC17_lt-shandong-zaozhuang-6-cache-1<br>Cache-Control: no-cache,no-store,private<br>cdn-user-ip: 111.199.184.218<br>cdn-ip: 124.132.138.17<br>X-Cache-Remote: HIT<br>cdn-source: baishan<br><br><span class="hljs-comment">#不拒绝其它浏览器的访问</span><br>[root@ubuntu2004 ~]<span class="hljs-comment">#curl -I -A &quot;ApacheBench&quot; www.163.com</span><br>HTTP/1.1 301 Moved Permanently<br>Date: Fri, 01 Jan 2021 06:58:41 GMT<br>Content-Length: 0<br>Connection: keep-alive<br>Server: web cache<br>Location: https://www.163.com/<br>Cache-Control: no-cache,no-store,private<br>cdn-user-ip: 111.199.184.218<br>cdn-ip: 124.132.138.11<br>X-Cache-Remote: MISS<br>cdn-source: baishan<br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl acl_user_agent hdr_sub(User-Agent)  -i curl wget    <span class="hljs-comment">#基于浏览器的ACL</span><br>acl acl_user_agent_ab hdr_sub(User-Agent)  -i ApacheBench<br><br><span class="hljs-comment">###################### acl hosts #################################</span><br>redirect prefix  http://www.baidu.com <span class="hljs-keyword">if</span> acl_user_agent <span class="hljs-comment">#302 临时重定向至新URL</span><br>http-request deny   <span class="hljs-keyword">if</span> acl_user_agent_ab <span class="hljs-comment">#拒绝ab</span><br><span class="hljs-comment">#block if acl_user_agent #拒绝agent</span><br>default_backend pc_hosts<br><br><span class="hljs-comment">###################### backend hosts #############################</span><br>backend mobile_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -I 10.0.0.7</span><br>HTTP/1.1 302 Found<br>content-length: 0<br>location: http://10.0.0.8/<br>cache-control: no-cache<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -L 10.0.0.7</span><br>10.0.0.8<br>[root@centos6 ~]<span class="hljs-comment">#wget -O - -q http://10.0.0.7</span><br>10.0.0.8<br>[root@centos6 ~]<span class="hljs-comment">#curl -A chrome http://10.0.0.7</span><br>10.0.0.27<br><br><span class="hljs-comment">#模拟ab</span><br>[root@centos6 ~]<span class="hljs-comment">#curl -A ApacheBench 10.0.0.7</span><br>&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;<br>Request forbidden by administrative rules.<br>&lt;/body&gt;&lt;/html&gt;<br><br>[root@centos6 ~]<span class="hljs-comment">#ab -n1 -c 1 http://10.0.0.7/</span><br>This is ApacheBench, Version 2.3 &lt;<span class="hljs-variable">$Revision</span>: 655654 $&gt;<br>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/<br>Licensed to The Apache Software Foundation, http://www.apache.org/<br><br>Benchmarking 10.0.0.7 (be patient).....<span class="hljs-keyword">done</span><br><br>Server Software:    <br>Server Hostname:     10.0.0.7<br>Server Port:       80<br><br>Document Path:     /<br>Document Length:     93 bytes<br><br>Concurrency Level:    1<br>Time taken <span class="hljs-keyword">for</span> tests:  0.001 seconds<br>Complete requests:    1<br>Failed requests:     0<br>Write errors:      0<br>Non-2xx responses:    1   <span class="hljs-comment">#提示出现非200的响应</span><br>Total transferred:    208 bytes<br>HTML transferred:    93 bytes<br>Requests per second:   939.85 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:    1.064 [ms] (mean)<br>Time per request:    1.064 [ms] (mean, across all concurrent requests)<br>Transfer rate:      190.91 [Kbytes/sec] received<br><br>Connection Times (ms)<br>      min mean[+/-sd] median  max<br>Connect:     1   1  0.0    1    1<br>Processing:   1   1  0.0    1    1<br>Waiting:     0   0  0.0    0    0<br>Total:      1   1  0.0    1    1<br><br><span class="hljs-comment">#haproxy日志提示403</span><br>[root@centos7 ~]<span class="hljs-comment">#tail /var/log/haproxy.log</span><br>Apr  4 08:16:29 localhost haproxy[1483]: 10.0.0.6:56470<br>[04/Apr/2020:08:16:29.977] magedu_http_port magedu_http_port/&lt;NOSRV&gt;<br>0/-1/-1/-1/0 403 212 - - PR-- 1/1/0/0/0 0/0 <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span><br></code></pre></td></tr></table></figure><h4 id="5-8-7-ACL示例-基于文件后缀名实现动静分离"><a href="#5-8-7-ACL示例-基于文件后缀名实现动静分离" class="headerlink" title="5.8.7 ACL示例-基于文件后缀名实现动静分离"></a>5.8.7 ACL示例-基于文件后缀名实现动静分离</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl acl_static path_end -i .jpg .jpeg .png .gif .css .js .html  <span class="hljs-comment">#基于文件后缀名的ACL</span><br>acl acl_php  path_end -i .php<br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend mobile_hosts <span class="hljs-keyword">if</span> acl_static<br>use_backend app_hosts <span class="hljs-keyword">if</span> acl_php<br>default_backend pc_hosts<br><span class="hljs-comment">###################### backend hosts #############################</span><br>backend mobile_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br><br>backend app_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br><br><span class="hljs-comment">#分别在后端两台主机准备相关文件</span><br>[root@centos17 ~]<span class="hljs-comment">#ls /var/www/html</span><br>index.html wang.jpg<br><br>[root@centos27 ~]<span class="hljs-comment">#cat /var/www/html/test.php</span><br>&lt;?php<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;h1&gt;http://10.0.0.27/test.php&lt;/h1&gt;\n&quot;</span>;<br>?&gt;<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy46.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy47.png"></p><h4 id="5-8-8-ACL-匹配访问路径实现动静分离"><a href="#5-8-8-ACL-匹配访问路径实现动静分离" class="headerlink" title="5.8.8 ACL-匹配访问路径实现动静分离"></a>5.8.8 ACL-匹配访问路径实现动静分离</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl acl_static path_beg  -i /static /images /javascript     <span class="hljs-comment">#基于路径的ACL，path_beg为...开头</span><br>acl acl_static path_end  -i .jpg .jpeg .png .gif .css .js .html .htm  <span class="hljs-comment">#ACL同名为或关系，path_end为...结尾</span><br>acl acl_app path_beg  -i /api<br><br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend static_hosts <span class="hljs-keyword">if</span> acl_static<br>use_backend app_hosts  <span class="hljs-keyword">if</span> acl_app<br>default_backend app_hosts<br><span class="hljs-comment">###################### backend hosts #############################</span><br>backend static_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend app_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br><br><span class="hljs-comment">#创建相关文件</span><br>[root@centos17 ~]<span class="hljs-comment">#mkdir /var/www/html/static</span><br>[root@centos17 ~]<span class="hljs-comment">#echo 10.0.0.17 &gt; /var/www/html/static/test.html</span><br><br><span class="hljs-comment">#测试访问</span><br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.7/static/test.html</span><br>10.0.0.17<br><br><br></code></pre></td></tr></table></figure><h4 id="5-8-9-ACL示例-预定义ACL使用"><a href="#5-8-9-ACL示例-预定义ACL使用" class="headerlink" title="5.8.9 ACL示例-预定义ACL使用"></a>5.8.9 ACL示例-预定义ACL使用</h4><p>官方帮助文档：<a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7.4">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7.4</a></p><h5 id="5-8-9-1-预定义ACL"><a href="#5-8-9-1-预定义ACL" class="headerlink" title="5.8.9.1 预定义ACL"></a>5.8.9.1 预定义ACL</h5><table><thead><tr><th>ACL name</th><th>Equivalent to</th><th>Usage</th></tr></thead><tbody><tr><td>FALSE</td><td>always_false</td><td>never match</td></tr><tr><td>HTTP</td><td>req_proto_http</td><td>match if protocol is valid HTTP</td></tr><tr><td>HTTP_1.0</td><td>req_ver 1.0</td><td>match HTTP version 1.0</td></tr><tr><td>HTTP_1.1</td><td>req_ver 1.1</td><td>match HTTP version 1.1</td></tr><tr><td>HTTP_CONTENT</td><td>hdr_val(content-length) gt 0</td><td>match an existing content-length</td></tr><tr><td>HTTP_URL_ABS</td><td>url_reg ^[^/:]*://</td><td>match absolute URL with scheme</td></tr><tr><td>HTTP_URL_SLASH</td><td>url_beg /</td><td>match URL beginning with “/“</td></tr><tr><td>HTTP_URL_STAR</td><td>url *</td><td>match URL equal to “*”</td></tr><tr><td>LOCALHOST</td><td>src 127.0.0.1/8</td><td>match connection from local host</td></tr><tr><td>METH_CONNECT</td><td>method CONNECT</td><td>match HTTP CONNECT method</td></tr><tr><td>METH_DELETE</td><td>method DELETE</td><td>match HTTP DELETE method</td></tr><tr><td>METH_GET</td><td>method GET HEAD</td><td>match HTTP GET or HEAD method</td></tr><tr><td>METH_HEAD</td><td>method HEAD</td><td>match HTTP HEAD method</td></tr><tr><td>METH_OPTIONS</td><td>method OPTIONS</td><td>match HTTP OPTIONS method</td></tr><tr><td>METH_POST</td><td>method POST</td><td>match HTTP POST method</td></tr><tr><td>METH_PUT</td><td>method PUT</td><td>match HTTP PUT method</td></tr><tr><td>METH_TRACE</td><td>method TRACE</td><td>match HTTP TRACE method</td></tr><tr><td>RDP_COOKIE</td><td>req_rdp_cookie_cnt gt 0</td><td>match presence of an RDP cookie</td></tr><tr><td>REQ_CONTENT</td><td>req_len gt 0</td><td>match data in the request buffer</td></tr><tr><td>TRUE</td><td>always_true</td><td>always match</td></tr><tr><td>WAIT_END</td><td>wait_end</td><td>wait for end of content analysis</td></tr></tbody></table><h5 id="5-8-9-2-预定义ACL使用"><a href="#5-8-9-2-预定义ACL使用" class="headerlink" title="5.8.9.2 预定义ACL使用"></a>5.8.9.2 预定义ACL使用</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -I -XTRACE 10.0.0.7/static/test.html</span><br>HTTP/1.1 200 OK<br>date: Sat, 04 Apr 2020 02:04:01 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>transfer-encoding: chunked<br>content-type: message/http<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl acl_static_path path_beg  -i /static /images /javascript<br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend static_path_hosts <span class="hljs-keyword">if</span> acl_static_path<br>http-request deny <span class="hljs-keyword">if</span> METH_TRACE HTTP_1.1  <span class="hljs-comment">#引用预定义的ACL，多个ACL默认为与关系</span><br>default_backend pc_hosts<br><span class="hljs-comment">################### backend hosts ################################</span><br>backend static_path_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend mobile_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -I -XTRACE 10.0.0.7/static/test.html</span><br>HTTP/1.1 403 Forbidden<br>content-length: 93<br>cache-control: no-cache<br>content-type: text/html<br>connection: close<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -I -0 -XTRACE 10.0.0.7/static/test.html</span><br>HTTP/1.1 200 OK<br>date: Sat, 04 Apr 2020 02:10:13 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>content-type: message/http<br>connection: close<br><br><span class="hljs-comment">#查看日志，观察协议版本</span><br>[root@centos17 ~]<span class="hljs-comment">#tail /var/log/httpd/access_log</span><br>10.0.0.7 - - [04/Apr/2020:10:11:41 +0800] <span class="hljs-string">&quot;TRACE /static/test.html HTTP/1.0&quot;</span> 200<br>230 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1</span><br><span class="hljs-string">zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span><br><br>[root@centos6 ~]<span class="hljs-comment">#curl -i 10.0.0.7/static/test.html</span><br>HTTP/1.1 200 OK<br>date: Sat, 04 Apr 2020 02:07:58 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>last-modified: Sat, 04 Apr 2020 01:27:45 GMT<br>etag: <span class="hljs-string">&quot;a-5a26cf0ed4913&quot;</span><br>accept-ranges: bytes<br>content-length: 10<br>content-type: text/html; charset=UTF-8<br>10.0.0.17<br></code></pre></td></tr></table></figure><h3 id="5-9-自定义HAProxy-错误界面"><a href="#5-9-自定义HAProxy-错误界面" class="headerlink" title="5.9 自定义HAProxy 错误界面"></a>5.9 自定义HAProxy 错误界面</h3><p>对指定的报错进行重定向，进行优雅的显示错误页面<br>使用errorfile和errorloc指令的两种方法，可以实现自定义各种错误页面</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy48.png"></p><p>默认情况下，所有后端服务器都down机后，会显示下面页面</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy49.png"></p><h4 id="5-9-1-基于自定义的错误页面文件"><a href="#5-9-1-基于自定义的错误页面文件" class="headerlink" title="5.9.1 基于自定义的错误页面文件"></a>5.9.1 基于自定义的错误页面文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#自定义错误页</span><br>errorfile &lt;code&gt; &lt;file&gt;<br>&lt;code&gt; <span class="hljs-comment">#HTTP status code.支持200, 400, 403, 405, 408, 425, 429, 500, 502，503,504</span><br>&lt;file&gt; <span class="hljs-comment">#包含完整HTTP响应头的错误页文件的绝对路径。 建议后缀&quot;.http&quot;，以和一般的html文件相区分</span><br><br><span class="hljs-comment">#示例：</span><br>errorfile 400 /etc/haproxy/errorfiles/400badreq.http<br>errorfile 403 /etc/haproxy/errorfiles/403forbid.http<br>errorfile 503 /etc/haproxy/errorfiles/503sorry.http<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">defaults<br><span class="hljs-comment">#option forwardfor</span><br><span class="hljs-comment">#no option http-use-htx 支持html文件,此设置和版本有关，2.1不支持</span><br><span class="hljs-comment">#......</span><br><br><span class="hljs-comment">#加下面行</span><br>errorfile 500 /usr/<span class="hljs-built_in">local</span>/haproxy/html/500.http<br>errorfile 502 /usr/<span class="hljs-built_in">local</span>/haproxy/html/502.http<br>errorfile 503 /usr/<span class="hljs-built_in">local</span>/haproxy/html/503.http<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br>defaults<br>option http-keep-alive<br>option forwardfor<br>maxconn 100000<br>mode http<br>timeout connect 300000ms<br>timeout client 300000ms<br>timeout server 300000ms<br>errorfile 503 /apps/haproxy/html/503.http <br><br>listen<br>.......<br><br>[root@centos7 ~]<span class="hljs-comment">#vim /apps/haproxy/html/503.http</span><br>HTTP/1.1 503 Service Unavailable<br>Content-Type:text/html;charset=utf-8<br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;报错页面&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;网站维护中......请稍候再试&lt;/h1&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h2&gt;联系电话：400-123-4567&lt;/h2&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;<br>&lt;/body&gt;<br><br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart haproxy</span><br><span class="hljs-comment">#将后端服务器down，可以观察到以下页面</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy50.png"></p><p>范例：启用no option http-use-htx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@haproxy ~]<span class="hljs-comment">#vi /etc/haproxy/haproxy.cfg</span><br>defaults<br> option http-keep-alive<br> no option http-use-htx  <span class="hljs-comment">#在defaults 块中添加</span><br> errorfile 503 /apps/haproxy/errorfiles/503.html<br> <br> [root@haproxy ~]<span class="hljs-comment">#cat /apps/haproxy/errorfiles/503.html</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;报错页面&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;网站维护中......请稍侯再试&lt;/h1&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h2&gt;联系电话：400-123-8888&lt;/h2&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;<br>&lt;/body&gt;<br><br><span class="hljs-comment">#注意没有响应头信息</span><br>[root@internet ~]<span class="hljs-comment">#curl -I 172.16.0.100</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;报错页面&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;网站维护中......请稍侯再试&lt;/h1&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h2&gt;联系电话：400-123-8888&lt;/h2&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;<br>&lt;/body&gt;<br><br><span class="hljs-comment">#ubuntu的客户端提示错误</span><br>root@ubuntu2004:~<span class="hljs-comment"># curl  172.16.0.100</span><br>curl: (1) Received HTTP/0.9 when not allowed<br></code></pre></td></tr></table></figure><h4 id="5-9-2-基于http重定向错误页面"><a href="#5-9-2-基于http重定向错误页面" class="headerlink" title="5.9.2 基于http重定向错误页面"></a>5.9.2 基于http重定向错误页面</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#错误页面重定向</span><br>errorloc &lt;code&gt; &lt;url&gt;<br><span class="hljs-comment">#相当于errorloc302 &lt;code&gt; &lt;url&gt;，利用302重定向至指URL</span><br><br><span class="hljs-comment">#示例：</span><br>errorloc 503 http://www.magedu.com/error_pages/503.html<br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br>defaults<br><span class="hljs-comment">#option http-keep-alive</span><br><span class="hljs-comment">#option forwardfor</span><br><span class="hljs-comment">#no option http-use-htx</span><br><span class="hljs-comment">#...... 加以下一行</span><br><span class="hljs-comment">#errorfile 503 /apps/haproxy/html/503.http</span><br>errorloc 503 http://10.0.0.8/error_page/503.html<br><br>[root@centos8 ~]<span class="hljs-comment">#cat /var/www/html/error_page/503.html</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;title&gt;报错页面&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;网站维护中......请稍侯再试&lt;/h1&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h2&gt;联系电话：400-123-4567&lt;/h2&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;<br>&lt;/body&gt;<br><br><span class="hljs-comment">#浏览器访问http://haproxy/ 302自动跳转至下面页面</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy51.png"></p><h3 id="5-10-HAProxy-四层负载"><a href="#5-10-HAProxy-四层负载" class="headerlink" title="5.10 HAProxy 四层负载"></a>5.10 HAProxy 四层负载</h3><p>针对除HTTP以外的TCP协议应用服务访问的应用场景</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">MySQL<br>Redis<br>Memcache<br>RabbitMQ<br></code></pre></td></tr></table></figure><p>Q: 后端服务器和haproxy还是和客户端建立三次握手?</p><p>A：后端服务器和haproxy建立三次握手</p><h4 id="5-10-1-四层负载示例"><a href="#5-10-1-四层负载示例" class="headerlink" title="5.10.1 四层负载示例"></a>5.10.1 四层负载示例</h4><p>注意：如果使用frontend和backend，一定在 frontend 和 backend 段中都指定mode tcp</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen redis-port<br> <span class="hljs-built_in">bind</span> 10.0.0.7:6379<br> mode tcp<br> balance leastconn<br> server server1 10.0.0.17:6379 check<br> server server2 10.0.0.27:6379 check backup<br></code></pre></td></tr></table></figure><p>范例：对 MySQL 服务实现四层负载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br>listen magedu_mysql<br><span class="hljs-built_in">bind</span> 10.0.0.7:3306<br>mode tcp<br>balance leastconn<br>server mysql1 10.0.0.17:3306 check <br> server mysql2 10.0.0.27:3306 check      <span class="hljs-comment">#如果不写端口号，可以转发，但无法check状态</span><br><br><span class="hljs-comment">#或者使用frontend和backend实现</span><br>frontend mysql<br>   <span class="hljs-built_in">bind</span> :3306<br>   mode tcp  <span class="hljs-comment">#必须指定tcp模式</span><br>   default_backend mysqlsrvs<br>backend mysqlsrvs<br>   mode tcp <span class="hljs-comment">#必须指定tcp模式</span><br>   balance leastconn<br>   server mysql1 10.0.0.17:3306<br>   server mysql2 10.0.0.27:3306<br>   <br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart haproxy</span><br><br><span class="hljs-comment">#在后端服务器安装和配置mariadb服务</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install mariadb-server</span><br>[root@centos7 ~]<span class="hljs-comment">#mysql -e &quot;grant all on *.* to test@&#x27;10.0.0.%&#x27; identified by &#x27;123456&#x27;&quot;</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/my.cnf</span><br>[mysqld]<br>server-id=17 <span class="hljs-comment">#在另一台主机为27</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl start mariadb</span><br><br><span class="hljs-comment">#测试</span><br>[root@centos6 ~]<span class="hljs-comment">#mysql -utest -p123456 -e &quot;show variables like &#x27;hostname&#x27;&quot;</span><br>+---------------+--------------------------+<br>| Variable_name | Value          |<br>+---------------+--------------------------+<br>| hostname   | centos17.wangxiaochu.com |<br>+---------------+--------------------------+<br>[root@centos6 ~]<span class="hljs-comment">#mysql -utest -p123456 -e &quot;show variables like &#x27;hostname&#x27;&quot;</span><br>+---------------+--------------------------+<br>| Variable_name | Value          |<br>+---------------+--------------------------+<br>| hostname   | centos27.wangxiaochu.com |<br>+---------------+--------------------------+<br>[root@centos6 ~]<span class="hljs-comment">#mysql -utest -p123456 -h10.0.0.7 -e &#x27;select @@server_id&#x27;</span><br>+-------------+<br>| @@server_id |<br>+-------------+<br>|      17 |<br>+-------------+<br>[root@centos6 ~]<span class="hljs-comment">#mysql -utest -p123456 -h10.0.0.7 -e &#x27;select @@server_id&#x27;</span><br>+-------------+<br>| @@server_id |<br>+-------------+<br>|      27 |<br>+-------------+<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy52.png"></p><h4 id="5-10-2-ACL示例-四层访问控制"><a href="#5-10-2-ACL示例-四层访问控制" class="headerlink" title="5.10.2 ACL示例-四层访问控制"></a>5.10.2 ACL示例-四层访问控制</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">frontend web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    balance roundrobin<br>    <span class="hljs-built_in">log</span> global<br>    option httplog<br><span class="hljs-comment">###################### acl setting ############################### </span><br>    acl static_path path_beg  -i /static /images /javascript<br>    acl invalid_src src 192.168.1.0/24 10.0.0.8<br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend static_path_host <span class="hljs-keyword">if</span> HTTP_1.1 TRUE static_path<br>tcp-request connection reject <span class="hljs-keyword">if</span> invalid_src   <span class="hljs-comment">#四层ACL控制 （tcp拒绝）</span><br>default_backend default_web<br><span class="hljs-comment">################### backend hosts ################################</span><br>backend php_server_host<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend static_path_host<br>mode http<br>server web1 10.0.0.27 check inter 2000 fall 3 rise 5<br><br>backend default_web<br>mode http<br>server web1 10.0.0.37:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure><h3 id="5-11-HAProxy-https-实现"><a href="#5-11-HAProxy-https-实现" class="headerlink" title="5.11 HAProxy https 实现"></a>5.11 HAProxy https 实现</h3><p>haproxy可以实现https的证书安全,但基于性能考虑,生产中证书都是在后端服务器比如nginx上实现<br>从用户到haproxy为https,从happroxy到后端服务器用http通信</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#配置HAProxy支持https协议，支持ssl会话；</span><br><span class="hljs-built_in">bind</span> *:443 ssl crt /PATH/TO/SOME_PEM_FILE<br><br><span class="hljs-comment">#指令 crt 后证书文件为PEM格式，需要同时包含证书和所有私钥</span><br>cat demo.key demo.crt &gt; demo.pem<br><br><span class="hljs-comment">#把80端口的请求重向定443</span><br><span class="hljs-built_in">bind</span> *:80<br>redirect scheme https <span class="hljs-keyword">if</span> !&#123; ssl_fc &#125;<br><br><span class="hljs-comment">#向后端传递用户请求的协议和端口（frontend或backend）</span><br>http_request set-header X-Forwarded-Port %[dst_port]<br>http_request add-header X-Forwared-Proto https <span class="hljs-keyword">if</span> &#123; ssl_fc &#125;<br></code></pre></td></tr></table></figure><h4 id="5-11-1-证书制作"><a href="#5-11-1-证书制作" class="headerlink" title="5.11.1 证书制作"></a>5.11.1 证书制作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs bash">方法1<br>[root@centos7 ~]mkdir /etc/haproxy/certs/<br>[root@centos7 ~]<span class="hljs-built_in">cd</span> /etc/haproxy/certs/<br>[root@centos7 certs]<span class="hljs-comment">#openssl genrsa -out haproxy.key 2048</span><br>[root@centos7 certs]<span class="hljs-comment">#openssl req -new -x509 -key haproxy.key -out haproxy.crt</span><br>-subj <span class="hljs-string">&quot;/CN=www.magedu.org&quot;</span><br><span class="hljs-comment">#或者用下一条命令实现</span><br>[root@centos7 certs]<span class="hljs-comment">#openssl req -x509 -newkey rsa:2048 -subj</span><br><span class="hljs-string">&quot;/CN=www.magedu.org&quot;</span> -keyout haproxy.key -nodes -days 365 -out haproxy.crt<br><br>[root@centos7 certs]<span class="hljs-comment">#cat haproxy.key haproxy.crt &gt; haproxy.pem</span><br>[root@centos7 certs]<span class="hljs-comment">#openssl x509 -in haproxy.pem -noout -text #查看证书</span><br><br><span class="hljs-comment">#方法2</span><br>[root@centos7 ~]<span class="hljs-comment">#mkdir /etc/haproxy/certs/</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /etc/pki/tls/certs</span><br>[root@centos7 certs]<span class="hljs-comment">#make /etc/haproxy/certs/haproxy.pem</span><br><span class="hljs-built_in">umask</span> 77 ; \<br>PEM1=`/bin/mktemp /tmp/openssl.XXXXXX` ; \<br>PEM2=`/bin/mktemp /tmp/openssl.XXXXXX` ; \<br>/usr/bin/openssl req -utf8 -newkey rsa:2048 -keyout <span class="hljs-variable">$PEM1</span> -nodes -x509 -days 365<br>-out <span class="hljs-variable">$PEM2</span> ; \<br>cat <span class="hljs-variable">$PEM1</span> &gt; /etc/haproxy/certs/haproxy.pem ; \<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span>  &gt;&gt; /etc/haproxy/certs/haproxy.pem ; \<br>cat <span class="hljs-variable">$PEM2</span> &gt;&gt; /etc/haproxy/certs/haproxy.pem ; \<br>rm -f <span class="hljs-variable">$PEM1</span> <span class="hljs-variable">$PEM2</span><br>Generating a 2048 bit RSA private key<br>.+++<br>..............................................+++<br>writing new private key to <span class="hljs-string">&#x27;/tmp/openssl.x8hOA8&#x27;</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Country Name (2 letter code) [XX]:CN<br>State or Province Name (full name) []:beijing<br>Locality Name (eg, city) [Default City]:beijing<br>Organization Name (eg, company) [Default Company Ltd]:magedu<br>Organizational Unit Name (eg, section) []:it<br>Common Name (eg, your name or your server<span class="hljs-string">&#x27;s hostname) []:www.magedu.org</span><br><span class="hljs-string">Email Address []:</span><br><span class="hljs-string">[root@centos7 certs]#ll /etc/haproxy/certs/</span><br><span class="hljs-string">total 4</span><br><span class="hljs-string">-rw------- 1 root root 3027 Apr  4 10:35 haproxy.pem</span><br></code></pre></td></tr></table></figure><h4 id="5-11-2-https配置示例"><a href="#5-11-2-https配置示例" class="headerlink" title="5.11.2 https配置示例"></a>5.11.2 https配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br><span class="hljs-comment">###################### https setting ############################## </span><br><span class="hljs-built_in">bind</span> 10.0.0.7:443 ssl crt /etc/haproxy/certs/haproxy.pem<br>redirect scheme https <span class="hljs-keyword">if</span> !&#123; ssl_fc &#125;     <span class="hljs-comment"># 注意&#123; &#125;内的空格</span><br>http-request set-header X-forwarded-Port  %[dst_port]<br>http-request add-header X-forwarded-Proto https <span class="hljs-keyword">if</span> &#123; ssl_fc &#125;<br><br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl mobile_domain hdr_dom(host)  -i mobile.magedu.org<br><span class="hljs-comment">###################### acl hosts #################################</span><br>default_backend pc_hosts<br><span class="hljs-comment">################### backend hosts #################################</span><br>backend mobile_hosts<br>mode http<br>server web1 10.0.0.17:80 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br> <span class="hljs-comment">#http-request set-header X-forwarded-Port  %[dst_port] 也可加在此处</span><br> <span class="hljs-comment">#http-request add-header X-forwarded-Proto https if &#123; ssl_fc &#125;</span><br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br><br>[root@centos7 ~]<span class="hljs-comment">#ss -ntl</span><br>State   Recv-Q Send-Q     Local Address:Port  Peer Address:Port    <br>  <br>LISTEN   0    100         127.0.0.1:25         *:*     <br>   <br>LISTEN   0    128          10.0.0.7:443        *:*     <br>   <br>LISTEN   0    128             *:9999        *:*     <br>   <br>LISTEN   0    128          10.0.0.7:80         *:*     <br>   <br>LISTEN   0    128             *:22         *:*     <br>   <br>LISTEN   0    128           [::]:22         [::]:* <br></code></pre></td></tr></table></figure><h4 id="5-11-3-修改后端服务器的日志格式"><a href="#5-11-3-修改后端服务器的日志格式" class="headerlink" title="5.11.3 修改后端服务器的日志格式"></a>5.11.3 修改后端服务器的日志格式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos27 ~]<span class="hljs-comment">#vim /etc/httpd/conf/httpd.conf</span><br>LogFormat <span class="hljs-string">&quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot; \&quot;%&#123;X-</span><br><span class="hljs-string">Forwarded-Port&#125;i\&quot; \&quot;%&#123;X-Forwarded-Proto&#125;i\&quot;&quot;</span> combined <br></code></pre></td></tr></table></figure><h4 id="5-11-4-验证https"><a href="#5-11-4-验证https" class="headerlink" title="5.11.4 验证https"></a>5.11.4 验证https</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -IkL http://www.magedu.org</span><br>HTTP/1.1 302 Found<br>content-length: 0<br>location: https://www.magedu.org/<br>cache-control: no-cache<br><br>HTTP/1.1 200 OK<br>date: Sat, 04 Apr 2020 02:31:31 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>last-modified: Thu, 02 Apr 2020 01:44:13 GMT<br>etag: <span class="hljs-string">&quot;a-5a244f01f8adc&quot;</span><br>accept-ranges: bytes<br>content-length: 10<br>content-type: text/html; charset=UTF-8<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -Ik https://www.magedu.org</span><br>HTTP/1.1 200 OK<br>date: Sat, 04 Apr 2020 02:31:50 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>last-modified: Thu, 02 Apr 2020 01:44:28 GMT<br>etag: <span class="hljs-string">&quot;a-5a244f0fd5175&quot;</span><br>accept-ranges: bytes<br>content-length: 10<br>content-type: text/html; charset=UTF-8<br><br><span class="hljs-comment">#查看后端服务器的访问日志</span><br>[root@centos27 ~]<span class="hljs-comment">#tail /var/log/httpd/access_log</span><br>10.0.0.7 - - [04/Apr/2020:10:40:17 +0800] <span class="hljs-string">&quot;HEAD / HTTP/1.1&quot;</span> 200 - <span class="hljs-string">&quot;-&quot;</span><br><span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span><br><span class="hljs-string">libidn/1.18 libssh2/1.4.2&quot;</span> <span class="hljs-string">&quot;443&quot;</span> <span class="hljs-string">&quot;https&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy53.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy54.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy55.png"></p><h2 id="六、-本章重点总结"><a href="#六、-本章重点总结" class="headerlink" title="六、 本章重点总结"></a>六、 本章重点总结</h2><ul><li>HAProxy调度算法</li><li>动静分离与客户端源IP透传</li><li>ACL使用与报文修改</li><li>服务器动态下线 </li><li>编写shell脚本，实现能够基于参数传递 Real Server 服务器IP，并实现将其从多个HAProxy进程下<br>线与上线（编写shell脚本，传递后端服务器IP，使其能够在HAProxy实现上线与下线。提示：使用socat命令）</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">stats socket /var/lib/haproxy/haproxy1.sock mode 600 level admin process 1<br>stats socket /var/lib/haproxy/haproxy2.sock mode 600 level admin process 2<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Linux HAPROXY</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Devops之基于Jenkins的CI与CD实战</title>
    <link href="/blog/2021/05/24/Devops%E4%B9%8B%E5%9F%BA%E4%BA%8EJenkins%E7%9A%84CI%E4%B8%8ECD%E5%AE%9E%E6%88%98/"/>
    <url>/blog/2021/05/24/Devops%E4%B9%8B%E5%9F%BA%E4%BA%8EJenkins%E7%9A%84CI%E4%B8%8ECD%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<h1 id="一、-对Jenkins实现代码的部署和回滚"><a href="#一、-对Jenkins实现代码的部署和回滚" class="headerlink" title="一、 对Jenkins实现代码的部署和回滚"></a>一、 对Jenkins实现代码的部署和回滚</h1><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another147.png" alt="代码部署流程图"></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs routeros">1.实现对测试环境和生产环境代码部署<br>  基于参数控制，基于传递分支，如果master就是生产环境，develop就是测试环境<br>    对于虚拟机或者物理机：<br>1.<span class="hljs-attribute">master</span>=10.0.0.106，10.0.0.107<br>2.<span class="hljs-attribute">develop</span>=10.0.0.105<br><span class="hljs-attribute">GROUP1</span>=10.0.0.105 #灰度服务器<br><span class="hljs-attribute">GROUP2</span>=10.0.0.106 10.0.0.107 #线上服务器<br><span class="hljs-attribute">GROUP3</span>=10.0.0.105 10.0.0.106 10.0.0.107 <br>对于容器，不需要指定地址<br>只要再k8s执行代码更新就行<br>对于公司有CMDB<br>通过CMDB的API自动获取当前环境当前服务器地址<br><span class="hljs-attribute">MASTER</span>=<span class="hljs-variable">$Host</span><br>2.实现对测试环境和生产环境代码的回滚<br>  基于git reset<br>    需要重新执行代码编译，代码编译时间较长 <br>  重新升级<br>    开发修复玩bug执行重新提交代码，也是需要重新执行代码编译，代码编译时间比较长<br>    基于本分代码目录回复，不需要代码编译，回滚时间少<br>  基于已经存在的历史版本目录<br>    1.我现在所处的版本<br>      如果今天升级过的版本 v1 v2 v3 ，最新是v3，<br>    2.我的上一个版本是谁<br>      v3<br>    3.将webapps/myapp 软连接重新指向上一个版本<br>    4.重启tomcat<br></code></pre></td></tr></table></figure><h1 id="二、-实现对测试环境和生产环境代码部署"><a href="#二、-实现对测试环境和生产环境代码部署" class="headerlink" title="二、 实现对测试环境和生产环境代码部署"></a>二、 实现对测试环境和生产环境代码部署</h1><h1 id="2-1-Jenkins创建新的项目"><a href="#2-1-Jenkins创建新的项目" class="headerlink" title="2.1 Jenkins创建新的项目"></a>2.1 Jenkins创建新的项目</h1><h1 id="2-2-项目构建"><a href="#2-2-项目构建" class="headerlink" title="2.2 项目构建"></a>2.2 项目构建</h1><h3 id="2-2-1执行shell"><a href="#2-2-1执行shell" class="headerlink" title="2.2.1执行shell"></a>2.2.1执行shell</h3><p>执行shell里的命令一般为执行shell脚本或者python脚本，而脚本的内容则为Jenkins代码的部署流程。</p><p>Q：为什么不像以前那样直接把流程写在Jenkins的网页里呢？</p><p>A：防止别人有意或无意对Jenkins网页里的脚本进行修改，而在Jenkins服务器里写成脚本我们可以适应gitlab进行脚本的备份，这样可以在shell脚本被修改后可以立即还原。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another103.png"></p><h3 id="2-2-2-添加脚本"><a href="#2-2-2-添加脚本" class="headerlink" title="2.2.2 添加脚本"></a>2.2.2 添加脚本</h3><p><strong>脚本的名称一般为项目的名称</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#新建文件夹和脚本</span><br>root@jenkins-master:~<span class="hljs-comment"># mkdir /data/scripts</span><br>root@jenkins-master:~<span class="hljs-comment"># vim /data/scripts/linux-master-web1.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>DATE=`date +%Y-%m-%d_%H-%M-%S`<br>METHOD=<span class="hljs-variable">$1</span><br>BRANCH=<span class="hljs-variable">$2</span><br>GROUP_LIST=<span class="hljs-variable">$3</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">IP_list</span></span>()&#123;<br>  <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;GROUP_LIST&#125;</span> == <span class="hljs-string">&quot;GROUP1&quot;</span> ]];<span class="hljs-keyword">then</span><br>     Server_IP=<span class="hljs-string">&quot;10.0.0.105&quot;</span><br>     <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span><br>     <span class="hljs-comment">#一旦为GROUP1，要在负载均衡里下线10.0.0.105，而10.0.0.106和10.0.0.107还是在负载均衡里，然后再对10.0.0.105进行代码部署</span><br>     ssh root@10.0.0.103 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">disable</span>  server linux-web-80-master/10.0.0.105<span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>     ssh root@10.0.0.104 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">disable</span>  server linux-web-80-master/10.0.0.105<span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>  <span class="hljs-keyword">elif</span> [[ <span class="hljs-variable">$&#123;GROUP_LIST&#125;</span> == <span class="hljs-string">&quot;GROUP2&quot;</span> ]];<span class="hljs-keyword">then</span><br>     Server_IP=<span class="hljs-string">&quot;10.0.0.106 10.0.0.107&quot;</span><br>     <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span><br>     <span class="hljs-comment">#要升级其他服务器，证明10.0.0.105已经升级成功，所以要把10.0.0.105再负载均衡里上线，然后就把其他服务器从负载均衡里下线，最后升级其他服务器</span><br>     ssh root@10.0.0.103 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">enable</span>  server linux-web-80-master/10.0.0.105<span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>     ssh root@10.0.0.104 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">enable</span>  server linux-web-80-master/10.0.0.105<span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>  <span class="hljs-keyword">elif</span> [[ <span class="hljs-variable">$&#123;GROUP_LIST&#125;</span> == <span class="hljs-string">&quot;GROUP3&quot;</span> ]];<span class="hljs-keyword">then</span><br>     Server_IP=<span class="hljs-string">&quot;10.0.0.105 10.0.0.106 10.0.0.107&quot;</span><br>     <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span><br>     <span class="hljs-comment">#针对当前所有服务器一次性上线成功，所以不需要顺序执行</span><br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">clone_code</span></span>()&#123;<br>  <span class="hljs-built_in">cd</span> /data/git/linux/ &amp;&amp; rm -rf web1<br>  git <span class="hljs-built_in">clone</span> -b <span class="hljs-variable">$&#123;BRANCH&#125;</span> git@10.0.0.101:linux/web1.git<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码clone完成&quot;</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">scanner_code</span></span>()&#123;<br>  <span class="hljs-built_in">cd</span> /data/git/linux/web1 &amp;&amp; /usr/<span class="hljs-built_in">local</span>/sonar-scanner/bin/sonar-scanner<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码扫描完成,请打开sonarqube查看扫描结果&quot;</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">code_maven</span></span>()&#123;<br>  <span class="hljs-built_in">echo</span>  <span class="hljs-string">&quot;cd /data/git/linux/web1 &amp;&amp; mvn clean package -Dmaven.test.skip=true&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码编译完成&quot;</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">make_zip</span></span>()&#123;<br>  <span class="hljs-built_in">cd</span> /data/git/linux/web1   &amp;&amp; zip -r code.zip ./<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码打包完成&quot;</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">down_node</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    ssh root@10.0.0.103 <span class="hljs-string">&quot;echo &quot;</span><span class="hljs-built_in">disable</span> server linux-web-80-master/<span class="hljs-variable">$&#123;node&#125;</span><span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span> <br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;node&#125;</span> 从负载均衡10.0.0.103下线成功&quot;</span><br>    ssh root@10.0.0.104 <span class="hljs-string">&quot;echo &quot;</span><span class="hljs-built_in">disable</span> server linux-web-80-master/<span class="hljs-variable">$&#123;node&#125;</span><span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;node&#125;</span> 从负载均衡10.0.0.104下线成功&quot;</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">scp_zipfile</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    scp /data/git/linux/web1/code.zip  www@<span class="hljs-variable">$&#123;node&#125;</span>:/data/tomcat/tomcat_appdir/code-<span class="hljs-variable">$&#123;DATE&#125;</span>.zip<br>    ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;unzip /data/tomcat/tomcat_appdir/code-<span class="hljs-variable">$&#123;DATE&#125;</span>.zip  -d /data/tomcat/tomcat_webdir/code-<span class="hljs-variable">$&#123;DATE&#125;</span> &amp;&amp; rm -rf  /data/tomcat/tomcat_webapps/myapp &amp;&amp; ln -sv  /data/tomcat/tomcat_webdir/code-<span class="hljs-variable">$&#123;DATE&#125;</span> /data/tomcat/tomcat_webapps/myapp&quot;</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">stop_tomcat</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    ssh www@<span class="hljs-variable">$&#123;node&#125;</span>   <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">start_tomcat</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    ssh www@<span class="hljs-variable">$&#123;node&#125;</span>   <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>    <span class="hljs-comment">#sleep 5</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">web_test</span></span>()&#123;<br>  sleep 5<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    NUM=`curl -s  -I -m 10 -o /dev/null  -w %&#123;http_code&#125;  http://<span class="hljs-variable">$&#123;node&#125;</span>:8080/myapp/index.html`<br>    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;NUM&#125;</span> -eq 200 ]];<span class="hljs-keyword">then</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;node&#125;</span> 测试通过,即将添加到负载&quot;</span><br>       add_node <span class="hljs-variable">$&#123;node&#125;</span><br>    <span class="hljs-keyword">else</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;node&#125;</span> 测试失败,请检查该服务器是否成功启动tomcat&quot;</span><br>    <span class="hljs-keyword">fi</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">add_node</span></span>()&#123;<br>   node=<span class="hljs-variable">$1</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;node&#125;</span>,<span class="hljs-string">&quot;-----&gt;&quot;</span><br>    <span class="hljs-comment">#if [[ $&#123;GROUP_LIST&#125; == &quot;GROUP2&quot; ]];then</span><br>    <span class="hljs-comment">#  ssh root@172.31.0.103 &quot;&quot;echo enable  server linux-web-80-master/172.31.0.105&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>    <span class="hljs-comment">#  ssh root@172.31.0.104 &quot;&quot;echo enable  server linux-web-80-master/172.31.0.105&quot; | socat stdio /run/haproxy/admin.sock&quot; </span><br>    <span class="hljs-comment">#fi</span><br>    <span class="hljs-comment">##########################################</span><br>    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$&#123;node&#125;</span> == <span class="hljs-string">&quot;10.0.0.105&quot;</span> ];<span class="hljs-keyword">then</span><br>       <span class="hljs-comment">#如果是第一次升级，且服务器等于10.0.0.105，仅仅会执行会说明已经部署完毕</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;10.0.0.105 部署完毕,请进行代码测试!&quot;</span><br>    <span class="hljs-keyword">else</span><br>       <span class="hljs-comment">#如果是升级其他服务器，就把其他服务器添加到负载均衡里即可</span><br>      ssh root@10.0.0.103 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">enable</span>  server linux-web-80-master/<span class="hljs-variable">$&#123;node&#125;</span><span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>      ssh root@10.0.0.104 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">enable</span>  server linux-web-80-master/<span class="hljs-variable">$&#123;node&#125;</span><span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>    <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">rollback_last_version</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>   <span class="hljs-built_in">echo</span> <span class="hljs-variable">$node</span><br>   NOW_VERSION=`ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;&quot;</span>/bin/ls -l  -rt /data/tomcat/tomcat_webapps/ | awk -F<span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>  | tail -n1<span class="hljs-string">&quot;&quot;</span>`<br>   NOW_VERSION=`basename <span class="hljs-variable">$&#123;NOW_VERSION&#125;</span>`<br>   <span class="hljs-built_in">echo</span> <span class="hljs-variable">$NOW_VERSION</span>,<span class="hljs-string">&quot;NOW_VERSION&quot;</span><br>   <span class="hljs-comment">#NAME为上一个版本的名称</span><br>   NAME=`ssh  www@<span class="hljs-variable">$&#123;node&#125;</span>  <span class="hljs-string">&quot;&quot;</span>ls  -l  -rt  /data/tomcat/tomcat_webdir/ | grep -B 1 <span class="hljs-variable">$&#123;NOW_VERSION&#125;</span> | head -n1 | awk <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span><span class="hljs-string">&quot;&quot;</span>`<br>   <span class="hljs-built_in">echo</span> <span class="hljs-variable">$NAME</span>,<span class="hljs-string">&quot;NAME&quot;</span><br>   ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;rm -rf /data/tomcat/tomcat_webapps/myapp &amp;&amp; ln -sv  /data/tomcat/tomcat_webdir/<span class="hljs-variable">$&#123;NAME&#125;</span> /data/tomcat/tomcat_webapps/myapp&quot;</span><br>  <span class="hljs-keyword">done</span> <br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">delete_history_version</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;rm -rf /data/tomcat/tomcat_appdir/*&quot;</span><br>    NUM=`ssh www@<span class="hljs-variable">$&#123;node&#125;</span>  <span class="hljs-string">&quot;&quot;</span>/bin/ls -l -d   -rt /data/tomcat/tomcat_webdir/code-* | wc -l<span class="hljs-string">&quot;&quot;</span>`<br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$NUM</span><br>      <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$&#123;NUM&#125;</span> -gt 10 ];<span class="hljs-keyword">then</span><br>         NAME=`ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;&quot;</span>/bin/ls -l -d   -rt /data/tomcat/tomcat_webdir/code-* | head -n1 | awk <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span><span class="hljs-string">&quot;&quot;</span>`<br>         ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;rm -rf <span class="hljs-variable">$&#123;NAME&#125;</span>&quot;</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;node&#125;</span> 删除历史版本 /data/tomcat/tomcat_webdir/<span class="hljs-variable">$&#123;NAME&#125;</span>成功!&quot;</span><br>      <span class="hljs-keyword">fi</span><br>  <span class="hljs-keyword">done</span> <br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">main</span></span>()&#123;<br>   <span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span>  <span class="hljs-keyword">in</span><br>      deploy)<br>        IP_list;        <br>        clone_code;<br>        scanner_code;<br>        make_zip;<br>        down_node;<br>        stop_tomcat;<br>        scp_zipfile;<br>        start_tomcat;<br>        web_test;<br>        delete_history_version;<br>         ;;<br>      rollback_last_version)<br>        IP_list;<br>        <span class="hljs-comment">#echo $&#123;Server_IP&#125;</span><br>        down_node;<br>        stop_tomcat;<br>        rollback_last_version;<br>        start_tomcat;<br>        web_test;<br>         ;;<br>    <span class="hljs-keyword">esac</span><br>&#125;<br><br>main <span class="hljs-variable">$1</span> <span class="hljs-variable">$2</span> <span class="hljs-variable">$3</span><br><br><span class="hljs-comment">#添加权限</span><br>root@jenkins-master:~<span class="hljs-comment"># chmod a+x /data/scripts/linux-master-web1.sh</span><br><span class="hljs-comment">#手动执行测试脚本</span><br>root@jenkins-master:~<span class="hljs-comment"># bash /data/scripts/linux-master-web1.sh</span><br></code></pre></td></tr></table></figure><h3 id="2-2-3-构建后的操作"><a href="#2-2-3-构建后的操作" class="headerlink" title="2.2.3 构建后的操作"></a>2.2.3 构建后的操作</h3><p>构建出现问题（构建失败）才发邮件</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another104.png"></p><h3 id="2-2-4-Jenkins基于参数做流程控制，进行代码管理"><a href="#2-2-4-Jenkins基于参数做流程控制，进行代码管理" class="headerlink" title="2.2.4 Jenkins基于参数做流程控制，进行代码管理"></a>2.2.4 Jenkins基于参数做流程控制，进行代码管理</h3><p>添加参数</p><p>Jenkins–项目–配置–General–参数化构建过程</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another109.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another110.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another111.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another112.png"></p><p>Jenkins–项目–配置–构建</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another114.png"></p><p>Jenkins–项目–配置–构建后操作</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another116.png"></p><p>所有操作完成后，返回项目页面就会出现Build with Parameters</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another105.png"></p><p>点击后会出现构建项目所需要的一些参数</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another149.png"></p><h3 id="2-2-5-开启负载均衡"><a href="#2-2-5-开启负载均衡" class="headerlink" title="2.2.5 开启负载均衡"></a>2.2.5 开启负载均衡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#slave1和slave2的Haproxy开启负载均衡</span><br>root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>global<br><span class="hljs-built_in">log</span> /dev/<span class="hljs-built_in">log</span>local0<br><span class="hljs-built_in">log</span> /dev/<span class="hljs-built_in">log</span>local1 notice<br>chroot /var/lib/haproxy<br>stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners<br>stats timeout 30s<br>user haproxy<br>group haproxy<br>daemon<br><br><span class="hljs-comment"># Default SSL material locations</span><br>ca-base /etc/ssl/certs<br>crt-base /etc/ssl/private<br><br><span class="hljs-comment"># Default ciphers to use on SSL-enabled listening sockets.</span><br><span class="hljs-comment"># For more information, see ciphers(1SSL). This list is from:</span><br><span class="hljs-comment">#  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/</span><br><span class="hljs-comment"># An alternative list with additional directives can be obtained from</span><br><span class="hljs-comment">#  https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy</span><br>ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS<br>ssl-default-bind-options no-sslv3<br><br>defaults<br><span class="hljs-built_in">log</span>global<br>modehttp<br>optionhttplog<br>optiondontlognull<br>        timeout connect 5000<br>        timeout client  50000<br>        timeout server  50000<br>errorfile 400 /etc/haproxy/errors/400.http<br>errorfile 403 /etc/haproxy/errors/403.http<br>errorfile 408 /etc/haproxy/errors/408.http<br>errorfile 500 /etc/haproxy/errors/500.http<br>errorfile 502 /etc/haproxy/errors/502.http<br>errorfile 503 /etc/haproxy/errors/503.http<br>errorfile 504 /etc/haproxy/errors/504.http<br><br>listen stats<br> mode http<br> <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br> stats <span class="hljs-built_in">enable</span><br> <span class="hljs-built_in">log</span> global<br> stats uri     /haproxy-status<br> stats auth    haadmin:q1w2e3r4ys<br><br>listen linux-web-80-develop<br>  <span class="hljs-built_in">bind</span> 10.0.0.249:80<br>  mode http<br>  server 10.0.0.105 10.0.0.105:8080 check inter 2s fall 3 rise 5<br><br>listen linux-web-80-master<br>  <span class="hljs-built_in">bind</span> 10.0.0.248:80<br>  mode http<br>  server 10.0.0.105 10.0.0.105:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.106 10.0.0.106:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.107 10.0.0.107:8080 check inter 2s fall 3 rise 5<br><br><span class="hljs-comment">#测试socket文件</span><br><span class="hljs-comment">#安装socat</span><br>root@jenkins-slave1:~<span class="hljs-comment"># apt install socat -y</span><br><span class="hljs-comment">#测试</span><br>root@jenkins-slave1:~<span class="hljs-comment"># echo &quot;help&quot; | socat stdio /run/haproxy/admin.sock </span><br>Unknown <span class="hljs-built_in">command</span>. Please enter one of the following commands only :<br>  <span class="hljs-built_in">help</span>           : this message<br>  prompt         : toggle interactive mode with prompt<br>  quit           : disconnect<br>  show tls-keys [id|*]: show tls keys references or dump tls ticket keys when id specified<br>  <span class="hljs-built_in">set</span> ssl tls-key [id|keyfile] &lt;tlskey&gt;: <span class="hljs-built_in">set</span> the next TLS key <span class="hljs-keyword">for</span> the &lt;id&gt; or &lt;keyfile&gt; listener to &lt;tlskey&gt;<br>  show errors    : report last request and response errors <span class="hljs-keyword">for</span> each proxy<br>  <span class="hljs-built_in">disable</span> agent  : <span class="hljs-built_in">disable</span> agent checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br>  <span class="hljs-built_in">disable</span> health : <span class="hljs-built_in">disable</span> health checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br>  <span class="hljs-built_in">disable</span> server : <span class="hljs-built_in">disable</span> a server <span class="hljs-keyword">for</span> maintenance (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br>  <span class="hljs-built_in">enable</span> agent   : <span class="hljs-built_in">enable</span> agent checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br>  <span class="hljs-built_in">enable</span> health  : <span class="hljs-built_in">enable</span> health checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br>  <span class="hljs-built_in">enable</span> server  : <span class="hljs-built_in">enable</span> a disabled server (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br>  <span class="hljs-built_in">set</span> maxconn server : change a server<span class="hljs-string">&#x27;s maxconn setting</span><br><span class="hljs-string">  set server     : change a server&#x27;</span>s state, weight or address<br>  get weight     : report a server<span class="hljs-string">&#x27;s current weight</span><br><span class="hljs-string">  set weight     : change a server&#x27;</span>s weight (deprecated)<br>  show sess [id] : report the list of current sessions or dump this session<br>  shutdown session : <span class="hljs-built_in">kill</span> a specific session<br>  shutdown sessions server : <span class="hljs-built_in">kill</span> sessions on a server<br>  clear table    : remove an entry from a table<br>  <span class="hljs-built_in">set</span> table [id] : update or create a table entry<span class="hljs-string">&#x27;s data</span><br><span class="hljs-string">  show table [id]: report table usage stats or dump this table&#x27;</span>s contents<br>  clear counters : clear max statistics counters (add <span class="hljs-string">&#x27;all&#x27;</span> <span class="hljs-keyword">for</span> all counters)<br>  show info      : report information about the running process<br>  show <span class="hljs-built_in">stat</span>      : report counters <span class="hljs-keyword">for</span> each proxy and server<br>  show schema json : report schema used <span class="hljs-keyword">for</span> stats<br>  show startup-logs : report logs emitted during HAProxy startup<br>  show resolvers [id]: dumps counters from all resolvers section and<br>                     associated name servers<br>  <span class="hljs-built_in">set</span> maxconn global : change the per-process maxconn setting<br>  <span class="hljs-built_in">set</span> rate-limit : change a rate limiting value<br>  <span class="hljs-built_in">set</span> severity-output [none|number|string] : <span class="hljs-built_in">set</span> presence of severity level <span class="hljs-keyword">in</span> feedback information<br>  <span class="hljs-built_in">set</span> timeout    : change a timeout setting<br>  show env [var] : dump environment variables known to the process<br>  show cli sockets : dump list of cli sockets<br>  show fd [num] : dump list of file descriptors <span class="hljs-keyword">in</span> use<br>  show activity : show per-thread activity stats (<span class="hljs-keyword">for</span> support/developers)<br>  <span class="hljs-built_in">disable</span> frontend : temporarily <span class="hljs-built_in">disable</span> specific frontend<br>  <span class="hljs-built_in">enable</span> frontend : re-enable specific frontend<br>  <span class="hljs-built_in">set</span> maxconn frontend : change a frontend<span class="hljs-string">&#x27;s maxconn setting</span><br><span class="hljs-string">  show servers state [id]: dump volatile server information (for backend &lt;id&gt;)</span><br><span class="hljs-string">  show backend   : list backends in the current running config</span><br><span class="hljs-string">  shutdown frontend : stop a specific frontend</span><br><span class="hljs-string">  set dynamic-cookie-key backend : change a backend secret key for dynamic cookies</span><br><span class="hljs-string">  enable dynamic-cookie backend : enable dynamic cookies on a specific backend</span><br><span class="hljs-string">  disable dynamic-cookie backend : disable dynamic cookies on a specific backend</span><br><span class="hljs-string">  show cache     : show cache status</span><br><span class="hljs-string">  add acl        : add acl entry</span><br><span class="hljs-string">  clear acl &lt;id&gt; : clear the content of this acl</span><br><span class="hljs-string">  del acl        : delete acl entry</span><br><span class="hljs-string">  get acl        : report the patterns matching a sample for an ACL</span><br><span class="hljs-string">  show acl [id]  : report available acls or dump an acl&#x27;</span>s contents<br>  add map        : add map entry<br>  clear map &lt;id&gt; : clear the content of this map<br>  del map        : delete map entry<br>  get map        : report the keys and values matching a sample <span class="hljs-keyword">for</span> a map<br>  <span class="hljs-built_in">set</span> map        : modify map entry<br>  show map [id]  : report available maps or dump a map<span class="hljs-string">&#x27;s contents</span><br><span class="hljs-string">  show pools     : report information about the memory pools usage</span><br><span class="hljs-string"></span><br><span class="hljs-string">#将Jenkins服务器公钥复制到slave1和slave2</span><br><span class="hljs-string">root@jenkins-master:/data/scripts# ssh-copy-id root@10.0.0.103</span><br><span class="hljs-string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span><br><span class="hljs-string">The authenticity of host &#x27;</span>10.0.0.103 (10.0.0.103)<span class="hljs-string">&#x27; can&#x27;</span>t be established.<br>ECDSA key fingerprint is SHA256:tLe8oiREqQLendzAnl1I3ydeXtXXSYaWogXpP8pfifI.<br>Are you sure you want to <span class="hljs-built_in">continue</span> connecting (yes/no)? yesw<br>/usr/bin/ssh-copy-id: INFO: attempting to <span class="hljs-built_in">log</span> <span class="hljs-keyword">in</span> with the new key(s), to filter out any that are already installed<br>/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="hljs-keyword">if</span> you are prompted now it is to install the new keys<br>root@10.0.0.103<span class="hljs-string">&#x27;s password: </span><br><span class="hljs-string"></span><br><span class="hljs-string">Number of key(s) added: 1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>root@10.0.0.103<span class="hljs-string">&#x27;&quot;</span><br><span class="hljs-string">and check to make sure that only the key(s) you wanted were added.</span><br><span class="hljs-string"></span><br><span class="hljs-string">root@jenkins-master:/data/scripts# ssh-copy-id root@10.0.0.104</span><br><span class="hljs-string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span><br><span class="hljs-string">The authenticity of host &#x27;</span>10.0.0.104 (10.0.0.104)<span class="hljs-string">&#x27; can&#x27;</span>t be established.<br>ECDSA key fingerprint is SHA256:tLe8oiREqQLendzAnl1I3ydeXtXXSYaWogXpP8pfifI.<br>Are you sure you want to <span class="hljs-built_in">continue</span> connecting (yes/no)? yes<br>/usr/bin/ssh-copy-id: INFO: attempting to <span class="hljs-built_in">log</span> <span class="hljs-keyword">in</span> with the new key(s), to filter out any that are already installed<br>/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="hljs-keyword">if</span> you are prompted now it is to install the new keys<br>root@10.0.0.104<span class="hljs-string">&#x27;s password: </span><br><span class="hljs-string"></span><br><span class="hljs-string">Number of key(s) added: 1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>root@10.0.0.104<span class="hljs-string">&#x27;&quot;</span><br><span class="hljs-string">and check to make sure that only the key(s) you wanted were added.</span><br><span class="hljs-string">#测试公钥复制后能否正常使用</span><br><span class="hljs-string">root@jenkins-master:/data/scripts# ssh root@10.0.0.103 &quot;echo &quot;get weight linux-web-80-master/10.0.0.106&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br><span class="hljs-string">1 (initial 1)</span><br><span class="hljs-string">#测试下线服务器，没有返回结果证明执行成功，可以到haproxy状态页查看服务器状态</span><br><span class="hljs-string">root@jenkins-master:/data/scripts# ssh root@10.0.0.103 &quot;echo &quot;disable server linux-web-80-master/10.0.0.106&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">#最后重启haproxy，让所有服务器上线</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another113.png" alt="10.0.0.106下线"></p><h3 id="2-2-6-测试"><a href="#2-2-6-测试" class="headerlink" title="2.2.6 测试"></a>2.2.6 测试</h3><p><strong>注意：如果生产环境是使用灰度发布的话，一定是先构建到灰度环境中，经过测试后没问题再构建到生产环境。并且脚本又正常的迭代顺序。</strong></p><h4 id="2-2-6-1-develop分支上传新的代码"><a href="#2-2-6-1-develop分支上传新的代码" class="headerlink" title="2.2.6.1 develop分支上传新的代码"></a>2.2.6.1 develop分支上传新的代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim index.html</span><br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v1&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v2&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v3&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v4&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v5&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v6&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v7&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v8&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v9&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v10&lt;/h1&gt;<br><br><span class="hljs-comment"># git add .</span><br><br><span class="hljs-comment">#git commit -m &quot;v10&quot;</span><br>[develop 361225d] v10<br> 1 file changed, 1 insertion(+)<br><br><span class="hljs-comment">#  git push</span><br>Enumerating objects: 5, <span class="hljs-keyword">done</span>.<br>Counting objects: 100% (5/5), <span class="hljs-keyword">done</span>.<br>Delta compression using up to 12 threads<br>Compressing objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>Writing objects: 100% (3/3), 282 bytes | 282.00 KiB/s, <span class="hljs-keyword">done</span>.<br>Total 3 (delta 2), reused 0 (delta 0), pack-reused 0<br>remote:<br>remote: To create a merge request <span class="hljs-keyword">for</span> develop, visit:<br>remote:   http://10.0.0.101/linux/web1/merge_requests/new?merge_request%5Bsource_branch%5D=develop<br>remote:<br>To http://10.0.0.101/linux/web1.git<br>   eeac925..361225d  develop -&gt; develop<br></code></pre></td></tr></table></figure><h4 id="2-2-6-2-对项目进行构建1"><a href="#2-2-6-2-对项目进行构建1" class="headerlink" title="2.2.6.2 对项目进行构建1"></a>2.2.6.2 对项目进行构建1</h4><h5 id="2-2-6-2-1-构建条件"><a href="#2-2-6-2-1-构建条件" class="headerlink" title="2.2.6.2.1 构建条件"></a>2.2.6.2.1 构建条件</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another115.png"></p><h5 id="2-2-6-2-2-构建过程"><a href="#2-2-6-2-2-构建过程" class="headerlink" title="2.2.6.2.2 构建过程"></a>2.2.6.2.2 构建过程</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#jenkins控制台输出</span><br>Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace /var/lib/jenkins/workspace/linux-web1-deploy<br>[linux-web1-deploy] $ /bin/sh -xe /tmp/jenkins787646829625291676.sh<br>+ bash /data/scripts/linux-master-web1-develop.sh deploy develop GROUP1<br>10.0.0.105<br><br><br>Cloning into <span class="hljs-string">&#x27;web1&#x27;</span>...<br>代码<span class="hljs-built_in">clone</span>完成<br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: /data/git/linux/web1/sonar-project.properties<br>INFO: SonarScanner 4.3.0.2102<br>INFO: Java 11.0.3 AdoptOpenJDK (64-bit)<br>INFO: Linux 4.15.0-55-generic amd64<br>INFO: User cache: /root/.sonar/cache<br>ERROR: SonarQube server [http://10.0.0.108:9000] can not be reached<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION FAILURE<br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: 4.996s<br>INFO: Final Memory: 2M/14M<br>INFO: ------------------------------------------------------------------------<br>ERROR: Error during SonarScanner execution<br>org.sonarsource.scanner.api.internal.ScannerException: Unable to execute SonarScanner analysis<br>at org.sonarsource.scanner.api.internal.IsolatedLauncherFactory.lambda$createLauncher<span class="hljs-variable">$0</span>(IsolatedLauncherFactory.java:85)<br>at java.base/java.security.AccessController.doPrivileged(Native Method)<br>at org.sonarsource.scanner.api.internal.IsolatedLauncherFactory.createLauncher(IsolatedLauncherFactory.java:74)<br>at org.sonarsource.scanner.api.internal.IsolatedLauncherFactory.createLauncher(IsolatedLauncherFactory.java:70)<br>at org.sonarsource.scanner.api.EmbeddedScanner.doStart(EmbeddedScanner.java:185)<br>at org.sonarsource.scanner.api.EmbeddedScanner.start(EmbeddedScanner.java:123)<br>at org.sonarsource.scanner.cli.Main.execute(Main.java:73)<br>at org.sonarsource.scanner.cli.Main.main(Main.java:61)<br>Caused by: java.lang.IllegalStateException: Fail to get bootstrap index from server<br>at org.sonarsource.scanner.api.internal.BootstrapIndexDownloader.getIndex(BootstrapIndexDownloader.java:42)<br>at org.sonarsource.scanner.api.internal.JarDownloader.getScannerEngineFiles(JarDownloader.java:58)<br>at org.sonarsource.scanner.api.internal.JarDownloader.download(JarDownloader.java:53)<br>at org.sonarsource.scanner.api.internal.IsolatedLauncherFactory.lambda$createLauncher<span class="hljs-variable">$0</span>(IsolatedLauncherFactory.java:76)<br>... 7 more<br>Caused by: java.net.NoRouteToHostException: No route to host (Host unreachable)<br>at java.base/java.net.PlainSocketImpl.socketConnect(Native Method)<br>at java.base/java.net.AbstractPlainSocketImpl.doConnect(Unknown Source)<br>at java.base/java.net.AbstractPlainSocketImpl.connectToAddress(Unknown Source)<br>at java.base/java.net.AbstractPlainSocketImpl.connect(Unknown Source)<br>at java.base/java.net.SocksSocketImpl.connect(Unknown Source)<br>at java.base/java.net.Socket.connect(Unknown Source)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.platform.Platform.connectSocket(Platform.java:130)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.RealConnection.connectSocket(RealConnection.java:263)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.RealConnection.connect(RealConnection.java:183)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.ExchangeFinder.findConnection(ExchangeFinder.java:224)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.ExchangeFinder.findHealthyConnection(ExchangeFinder.java:108)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.ExchangeFinder.find(ExchangeFinder.java:88)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.Transmitter.newExchange(Transmitter.java:169)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.java:41)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:142)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:117)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.cache.CacheInterceptor.intercept(CacheInterceptor.java:94)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:142)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:117)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.java:93)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:142)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.java:88)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:142)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:117)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.RealCall.getResponseWithInterceptorChain(RealCall.java:221)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.RealCall.execute(RealCall.java:81)<br>at org.sonarsource.scanner.api.internal.ServerConnection.callUrl(ServerConnection.java:114)<br>at org.sonarsource.scanner.api.internal.ServerConnection.downloadString(ServerConnection.java:99)<br>at org.sonarsource.scanner.api.internal.BootstrapIndexDownloader.getIndex(BootstrapIndexDownloader.java:39)<br>... 10 more<br>ERROR: <br>ERROR: Re-run SonarScanner using the -X switch to <span class="hljs-built_in">enable</span> full debug logging.<br>代码扫描完成,请打开sonarqube查看扫描结果<br>  adding: <span class="hljs-built_in">source</span>/ (stored 0%)<br>  adding: <span class="hljs-built_in">source</span>/linux.py (deflated 53%)<br>  adding: .git/ (stored 0%)<br>  adding: .git/hooks/ (stored 0%)<br>  adding: .git/hooks/pre-rebase.sample (deflated 59%)<br>  adding: .git/hooks/commit-msg.sample (deflated 44%)<br>  adding: .git/hooks/pre-commit.sample (deflated 43%)<br>  adding: .git/hooks/prepare-commit-msg.sample (deflated 50%)<br>  adding: .git/hooks/pre-push.sample (deflated 50%)<br>  adding: .git/hooks/update.sample (deflated 68%)<br>  adding: .git/hooks/applypatch-msg.sample (deflated 42%)<br>  adding: .git/hooks/pre-applypatch.sample (deflated 38%)<br>  adding: .git/hooks/pre-receive.sample (deflated 40%)<br>  adding: .git/hooks/post-update.sample (deflated 27%)<br>  adding: .git/hooks/fsmonitor-watchman.sample (deflated 53%)<br>  adding: .git/description (deflated 14%)<br>  adding: .git/info/ (stored 0%)<br>  adding: .git/info/exclude (deflated 28%)<br>  adding: .git/refs/ (stored 0%)<br>  adding: .git/refs/remotes/ (stored 0%)<br>  adding: .git/refs/remotes/origin/ (stored 0%)<br>  adding: .git/refs/remotes/origin/HEAD (stored 0%)<br>  adding: .git/refs/tags/ (stored 0%)<br>  adding: .git/refs/heads/ (stored 0%)<br>  adding: .git/refs/heads/develop (stored 0%)<br>  adding: .git/logs/ (stored 0%)<br>  adding: .git/logs/refs/ (stored 0%)<br>  adding: .git/logs/refs/remotes/ (stored 0%)<br>  adding: .git/logs/refs/remotes/origin/ (stored 0%)<br>  adding: .git/logs/refs/remotes/origin/HEAD (deflated 30%)<br>  adding: .git/logs/refs/heads/ (stored 0%)<br>  adding: .git/logs/refs/heads/develop (deflated 29%)<br>  adding: .git/logs/HEAD (deflated 29%)<br>  adding: .git/objects/ (stored 0%)<br>  adding: .git/objects/info/ (stored 0%)<br>  adding: .git/objects/pack/ (stored 0%)<br>  adding: .git/objects/pack/pack-b1395e602d40b684476ae540316110a2b2e43063.idx (deflated 32%)<br>  adding: .git/objects/pack/pack-b1395e602d40b684476ae540316110a2b2e43063.pack (deflated 15%)<br>  adding: .git/branches/ (stored 0%)<br>  adding: .git/HEAD (stored 0%)<br>  adding: .git/config (deflated 32%)<br>  adding: .git/packed-refs (deflated 26%)<br>  adding: .git/index (deflated 29%)<br>  adding: README.md (deflated 4%)<br>  adding: index.html (deflated 80%)<br>  adding: sonar-project.properties (deflated 39%)<br>代码打包完成<br><br>10.0.0.105 从负载均衡10.0.0.103下线成功<br><br>10.0.0.105 从负载均衡10.0.0.104下线成功<br>正在判断服务状态，请稍等3秒钟！<br>3<br>2<br>1<br>Tomcat运行中，1秒后关闭！<br>1<br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br>3<br>2<br>1<br>Tomcat 已经关闭完成！<br>3<br>2<br>1<br>Archive:  /data/tomcat/tomcat_appdir/code-2021-05-23_10-56-51.zip<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/<span class="hljs-built_in">source</span>/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/<span class="hljs-built_in">source</span>/linux.py  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/pre-rebase.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/pre-commit.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/prepare-commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/pre-push.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/applypatch-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/pre-applypatch.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/pre-receive.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/post-update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/hooks/fsmonitor-watchman.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/description  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/info/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/info/exclude  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/refs/remotes/origin/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/refs/tags/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/refs/heads/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/refs/heads/develop  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/logs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/logs/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/logs/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/logs/refs/remotes/origin/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/logs/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/logs/refs/heads/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/logs/refs/heads/develop  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/logs/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/objects/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/objects/info/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/objects/pack/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/objects/pack/pack-b1395e602d40b684476ae540316110a2b2e43063.idx  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/objects/pack/pack-b1395e602d40b684476ae540316110a2b2e43063.pack  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/branches/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/HEAD  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/config  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/packed-refs  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/.git/index  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/README.md  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/index.html  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51/sonar-project.properties  <br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/code-2021-05-23_10-56-51&#x27;</span><br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为1978<br>10.0.0.105 测试通过,即将添加到负载<br>10.0.0.105,-----&gt;<br>10.0.0.105 部署完毕,请进行代码测试!<br>Finished: SUCCESS<br></code></pre></td></tr></table></figure><p><strong>Haproxy状态页：</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another117.png" alt="http://10.0.0.103:9999/haproxy-status"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another118.png" alt="http://10.0.0.104:9999/haproxy-status"></p><h5 id="2-2-6-2-3-构建结果"><a href="#2-2-6-2-3-构建结果" class="headerlink" title="2.2.6.2.3 构建结果"></a>2.2.6.2.3 构建结果</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another119.png" alt="http://10.0.0.249/myapp/"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another120.png" alt="http://10.0.0.105:8080/myapp/"></p><h4 id="2-2-6-3-对项目进行构建2"><a href="#2-2-6-3-对项目进行构建2" class="headerlink" title="2.2.6.3 对项目进行构建2"></a>2.2.6.3 对项目进行构建2</h4><h5 id="2-2-6-3-1-构建条件"><a href="#2-2-6-3-1-构建条件" class="headerlink" title="2.2.6.3.1 构建条件"></a>2.2.6.3.1 构建条件</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another121.png"></p><h5 id="2-2-6-3-2-构建过程"><a href="#2-2-6-3-2-构建过程" class="headerlink" title="2.2.6.3.2 构建过程"></a>2.2.6.3.2 构建过程</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#jenkins控制台输出</span><br>Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace /var/lib/jenkins/workspace/linux-web1-deploy<br>[linux-web1-deploy] $ /bin/sh -xe /tmp/jenkins7893803183502097463.sh<br>+ bash /data/scripts/linux-master-web1-develop.sh deploy develop GROUP2<br>10.0.0.106 10.0.0.107<br><br><br>Cloning into <span class="hljs-string">&#x27;web1&#x27;</span>...<br>代码<span class="hljs-built_in">clone</span>完成<br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: /data/git/linux/web1/sonar-project.properties<br>INFO: SonarScanner 4.3.0.2102<br>INFO: Java 11.0.3 AdoptOpenJDK (64-bit)<br>INFO: Linux 4.15.0-55-generic amd64<br>INFO: User cache: /root/.sonar/cache<br>ERROR: SonarQube server [http://10.0.0.108:9000] can not be reached<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION FAILURE<br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: 3.413s<br>INFO: Final Memory: 2M/14M<br>INFO: ------------------------------------------------------------------------<br>ERROR: Error during SonarScanner execution<br>org.sonarsource.scanner.api.internal.ScannerException: Unable to execute SonarScanner analysis<br>at org.sonarsource.scanner.api.internal.IsolatedLauncherFactory.lambda$createLauncher<span class="hljs-variable">$0</span>(IsolatedLauncherFactory.java:85)<br>at java.base/java.security.AccessController.doPrivileged(Native Method)<br>at org.sonarsource.scanner.api.internal.IsolatedLauncherFactory.createLauncher(IsolatedLauncherFactory.java:74)<br>at org.sonarsource.scanner.api.internal.IsolatedLauncherFactory.createLauncher(IsolatedLauncherFactory.java:70)<br>at org.sonarsource.scanner.api.EmbeddedScanner.doStart(EmbeddedScanner.java:185)<br>at org.sonarsource.scanner.api.EmbeddedScanner.start(EmbeddedScanner.java:123)<br>at org.sonarsource.scanner.cli.Main.execute(Main.java:73)<br>at org.sonarsource.scanner.cli.Main.main(Main.java:61)<br>Caused by: java.lang.IllegalStateException: Fail to get bootstrap index from server<br>at org.sonarsource.scanner.api.internal.BootstrapIndexDownloader.getIndex(BootstrapIndexDownloader.java:42)<br>at org.sonarsource.scanner.api.internal.JarDownloader.getScannerEngineFiles(JarDownloader.java:58)<br>at org.sonarsource.scanner.api.internal.JarDownloader.download(JarDownloader.java:53)<br>at org.sonarsource.scanner.api.internal.IsolatedLauncherFactory.lambda$createLauncher<span class="hljs-variable">$0</span>(IsolatedLauncherFactory.java:76)<br>... 7 more<br>Caused by: java.net.NoRouteToHostException: No route to host (Host unreachable)<br>at java.base/java.net.PlainSocketImpl.socketConnect(Native Method)<br>at java.base/java.net.AbstractPlainSocketImpl.doConnect(Unknown Source)<br>at java.base/java.net.AbstractPlainSocketImpl.connectToAddress(Unknown Source)<br>at java.base/java.net.AbstractPlainSocketImpl.connect(Unknown Source)<br>at java.base/java.net.SocksSocketImpl.connect(Unknown Source)<br>at java.base/java.net.Socket.connect(Unknown Source)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.platform.Platform.connectSocket(Platform.java:130)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.RealConnection.connectSocket(RealConnection.java:263)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.RealConnection.connect(RealConnection.java:183)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.ExchangeFinder.findConnection(ExchangeFinder.java:224)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.ExchangeFinder.findHealthyConnection(ExchangeFinder.java:108)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.ExchangeFinder.find(ExchangeFinder.java:88)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.Transmitter.newExchange(Transmitter.java:169)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.java:41)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:142)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:117)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.cache.CacheInterceptor.intercept(CacheInterceptor.java:94)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:142)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:117)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.java:93)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:142)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.java:88)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:142)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:117)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.RealCall.getResponseWithInterceptorChain(RealCall.java:221)<br>at org.sonarsource.scanner.api.internal.shaded.okhttp.RealCall.execute(RealCall.java:81)<br>at org.sonarsource.scanner.api.internal.ServerConnection.callUrl(ServerConnection.java:114)<br>at org.sonarsource.scanner.api.internal.ServerConnection.downloadString(ServerConnection.java:99)<br>at org.sonarsource.scanner.api.internal.BootstrapIndexDownloader.getIndex(BootstrapIndexDownloader.java:39)<br>... 10 more<br>ERROR: <br>ERROR: Re-run SonarScanner using the -X switch to <span class="hljs-built_in">enable</span> full debug logging.<br>代码扫描完成,请打开sonarqube查看扫描结果<br>  adding: <span class="hljs-built_in">source</span>/ (stored 0%)<br>  adding: <span class="hljs-built_in">source</span>/linux.py (deflated 53%)<br>  adding: .git/ (stored 0%)<br>  adding: .git/hooks/ (stored 0%)<br>  adding: .git/hooks/pre-rebase.sample (deflated 59%)<br>  adding: .git/hooks/commit-msg.sample (deflated 44%)<br>  adding: .git/hooks/pre-commit.sample (deflated 43%)<br>  adding: .git/hooks/prepare-commit-msg.sample (deflated 50%)<br>  adding: .git/hooks/pre-push.sample (deflated 50%)<br>  adding: .git/hooks/update.sample (deflated 68%)<br>  adding: .git/hooks/applypatch-msg.sample (deflated 42%)<br>  adding: .git/hooks/pre-applypatch.sample (deflated 38%)<br>  adding: .git/hooks/pre-receive.sample (deflated 40%)<br>  adding: .git/hooks/post-update.sample (deflated 27%)<br>  adding: .git/hooks/fsmonitor-watchman.sample (deflated 53%)<br>  adding: .git/description (deflated 14%)<br>  adding: .git/info/ (stored 0%)<br>  adding: .git/info/exclude (deflated 28%)<br>  adding: .git/refs/ (stored 0%)<br>  adding: .git/refs/remotes/ (stored 0%)<br>  adding: .git/refs/remotes/origin/ (stored 0%)<br>  adding: .git/refs/remotes/origin/HEAD (stored 0%)<br>  adding: .git/refs/tags/ (stored 0%)<br>  adding: .git/refs/heads/ (stored 0%)<br>  adding: .git/refs/heads/develop (stored 0%)<br>  adding: .git/logs/ (stored 0%)<br>  adding: .git/logs/refs/ (stored 0%)<br>  adding: .git/logs/refs/remotes/ (stored 0%)<br>  adding: .git/logs/refs/remotes/origin/ (stored 0%)<br>  adding: .git/logs/refs/remotes/origin/HEAD (deflated 30%)<br>  adding: .git/logs/refs/heads/ (stored 0%)<br>  adding: .git/logs/refs/heads/develop (deflated 29%)<br>  adding: .git/logs/HEAD (deflated 29%)<br>  adding: .git/objects/ (stored 0%)<br>  adding: .git/objects/info/ (stored 0%)<br>  adding: .git/objects/pack/ (stored 0%)<br>  adding: .git/objects/pack/pack-b1395e602d40b684476ae540316110a2b2e43063.idx (deflated 32%)<br>  adding: .git/objects/pack/pack-b1395e602d40b684476ae540316110a2b2e43063.pack (deflated 15%)<br>  adding: .git/branches/ (stored 0%)<br>  adding: .git/HEAD (stored 0%)<br>  adding: .git/config (deflated 32%)<br>  adding: .git/packed-refs (deflated 26%)<br>  adding: .git/index (deflated 27%)<br>  adding: README.md (deflated 4%)<br>  adding: index.html (deflated 80%)<br>  adding: sonar-project.properties (deflated 39%)<br>代码打包完成<br><br>10.0.0.106 从负载均衡10.0.0.103下线成功<br><br>10.0.0.106 从负载均衡10.0.0.104下线成功<br><br>10.0.0.107 从负载均衡10.0.0.103下线成功<br><br>10.0.0.107 从负载均衡10.0.0.104下线成功<br>正在判断服务状态，请稍等3秒钟！<br>3<br>2<br>1<br>Tomcat运行中，1秒后关闭！<br>1<br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br>3<br>2<br>1<br>Tomcat 已经关闭完成！<br>3<br>2<br>1<br>正在判断服务状态，请稍等3秒钟！<br>3<br>2<br>1<br>Tomcat运行中，1秒后关闭！<br>1<br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br>3<br>2<br>1<br>Tomcat 已经关闭完成！<br>3<br>2<br>1<br>Archive:  /data/tomcat/tomcat_appdir/code-2021-05-23_11-22-57.zip<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/<span class="hljs-built_in">source</span>/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/<span class="hljs-built_in">source</span>/linux.py  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/pre-rebase.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/pre-commit.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/prepare-commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/pre-push.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/applypatch-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/pre-applypatch.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/pre-receive.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/post-update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/fsmonitor-watchman.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/description  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/info/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/info/exclude  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/remotes/origin/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/tags/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/heads/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/heads/develop  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/remotes/origin/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/heads/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/heads/develop  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/objects/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/objects/info/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/objects/pack/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/objects/pack/pack-b1395e602d40b684476ae540316110a2b2e43063.idx  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/objects/pack/pack-b1395e602d40b684476ae540316110a2b2e43063.pack  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/branches/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/HEAD  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/config  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/packed-refs  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/index  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/README.md  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/index.html  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/sonar-project.properties  <br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57&#x27;</span><br>Archive:  /data/tomcat/tomcat_appdir/code-2021-05-23_11-22-57.zip<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/<span class="hljs-built_in">source</span>/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/<span class="hljs-built_in">source</span>/linux.py  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/pre-rebase.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/pre-commit.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/prepare-commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/pre-push.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/applypatch-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/pre-applypatch.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/pre-receive.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/post-update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/hooks/fsmonitor-watchman.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/description  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/info/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/info/exclude  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/remotes/origin/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/tags/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/heads/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/refs/heads/develop  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/remotes/origin/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/heads/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/refs/heads/develop  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/logs/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/objects/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/objects/info/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/objects/pack/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/objects/pack/pack-b1395e602d40b684476ae540316110a2b2e43063.idx  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/objects/pack/pack-b1395e602d40b684476ae540316110a2b2e43063.pack  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/branches/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/HEAD  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/config  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/packed-refs  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/.git/index  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/README.md  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/index.html  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57/sonar-project.properties  <br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/code-2021-05-23_11-22-57&#x27;</span><br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为1992<br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为1990<br>10.0.0.106 测试通过,即将添加到负载<br>10.0.0.106,-----&gt;<br><br><br>10.0.0.107 测试通过,即将添加到负载<br>10.0.0.107,-----&gt;<br><br><br>Finished: SUCCESS<br></code></pre></td></tr></table></figure><p><strong>Haproxy状态页</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another122.png" alt="http://10.0.0.103:9999/haproxy-status"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another123.png" alt="http://10.0.0.104:9999/haproxy-status"></p><h5 id="2-2-6-3-3-构建结果"><a href="#2-2-6-3-3-构建结果" class="headerlink" title="2.2.6.3.3 构建结果"></a>2.2.6.3.3 构建结果</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another124.png" alt="http://10.0.0.248/myapp/"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another125.png" alt="http://10.0.0.106:8080/myapp/"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another126.png" alt="http://10.0.0.107:8080/myapp/"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another127.png" alt="http://10.0.0.103:9999/haproxy-status"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another128.png" alt="http://10.0.0.104:9999/haproxy-status"></p><h4 id="2-2-6-4-对项目进行构建3"><a href="#2-2-6-4-对项目进行构建3" class="headerlink" title="2.2.6.4 对项目进行构建3"></a>2.2.6.4 对项目进行构建3</h4><h5 id="2-2-6-4-1-构建前准备，添加新代码并上传"><a href="#2-2-6-4-1-构建前准备，添加新代码并上传" class="headerlink" title="2.2.6.4.1 构建前准备，添加新代码并上传"></a>2.2.6.4.1 构建前准备，添加新代码并上传</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim index.html</span><br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v1&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v2&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v3&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v4&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v5&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v6&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v7&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v8&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v9&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v10&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v11&lt;/h1&gt;<br><br><span class="hljs-comment"># git add .</span><br><br><span class="hljs-comment">#git commit -m &quot;v10&quot;</span><br>[develop 361225d] v11<br> 1 file changed, 1 insertion(+)<br><br><span class="hljs-comment">#  git push</span><br>Enumerating objects: 5, <span class="hljs-keyword">done</span>.<br>Counting objects: 100% (5/5), <span class="hljs-keyword">done</span>.<br>Delta compression using up to 12 threads<br>Compressing objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>Writing objects: 100% (3/3), 282 bytes | 282.00 KiB/s, <span class="hljs-keyword">done</span>.<br>Total 3 (delta 2), reused 0 (delta 0), pack-reused 0<br>remote:<br>remote: To create a merge request <span class="hljs-keyword">for</span> develop, visit:<br>remote:   http://10.0.0.101/linux/web1/merge_requests/new?merge_request%5Bsource_branch%5D=develop<br>remote:<br>To http://10.0.0.101/linux/web1.git<br>   eeac925..361225d  develop -&gt; develop<br></code></pre></td></tr></table></figure><h5 id="2-2-6-4-2-构建条件"><a href="#2-2-6-4-2-构建条件" class="headerlink" title="2.2.6.4.2 构建条件"></a>2.2.6.4.2 构建条件</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another129.png"></p><h5 id="2-2-6-4-3-构建过程"><a href="#2-2-6-4-3-构建过程" class="headerlink" title="2.2.6.4.3 构建过程"></a>2.2.6.4.3 构建过程</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#Jenkins控制台输出</span><br>Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace /var/lib/jenkins/workspace/linux-web1-deploy<br>[linux-web1-deploy] $ /bin/sh -xe /tmp/jenkins1663311920331200385.sh<br>+ bash /data/scripts/linux-master-web1-develop.sh deploy develop GROUP3<br>10.0.0.105 10.0.0.106 10.0.0.107<br>Cloning into <span class="hljs-string">&#x27;web1&#x27;</span>...<br>代码<span class="hljs-built_in">clone</span>完成<br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: /data/git/linux/web1/sonar-project.properties<br>INFO: SonarScanner 4.3.0.2102<br>INFO: Java 11.0.3 AdoptOpenJDK (64-bit)<br>INFO: Linux 4.15.0-55-generic amd64<br>INFO: User cache: /root/.sonar/cache<br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: /data/git/linux/web1/sonar-project.properties<br>INFO: Analyzing on SonarQube server 7.9.2<br>INFO: Default locale: <span class="hljs-string">&quot;en_US&quot;</span>, <span class="hljs-built_in">source</span> code encoding: <span class="hljs-string">&quot;UTF-8&quot;</span><br>INFO: Load global settings<br>INFO: Load global settings (<span class="hljs-keyword">done</span>) | time=36ms<br>INFO: Server id: 9A84A96E-AXl6fM6ITuzQthHv-dgM<br>INFO: User cache: /root/.sonar/cache<br>INFO: Load/download plugins<br>INFO: Load plugins index<br>INFO: Load plugins index (<span class="hljs-keyword">done</span>) | time=25ms<br>INFO: Plugin [l10nzh] defines <span class="hljs-string">&#x27;l10nen&#x27;</span> as base plugin. This metadata can be removed from manifest of l10n plugins since version 5.2.<br>INFO: Load/download plugins (<span class="hljs-keyword">done</span>) | time=58ms<br>INFO: Process project properties<br>INFO: Execute project builders<br>INFO: Execute project builders (<span class="hljs-keyword">done</span>) | time=2ms<br>INFO: Project key: linux-web1<br>INFO: Base dir: /data/git/linux/web1<br>INFO: Working dir: /data/git/linux/web1/.scannerwork<br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;linux-web1&#x27;</span><br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;linux-web1&#x27;</span> (<span class="hljs-keyword">done</span>) | time=26ms<br>INFO: Load quality profiles<br>INFO: Load quality profiles (<span class="hljs-keyword">done</span>) | time=22ms<br>INFO: Detected Jenkins<br>INFO: Load active rules<br>INFO: Load active rules (<span class="hljs-keyword">done</span>) | time=410ms<br>INFO: Indexing files...<br>INFO: Project configuration:<br>INFO: 1 file indexed<br>INFO: 0 files ignored because of scm ignore settings<br>INFO: Quality profile <span class="hljs-keyword">for</span> py: Sonar way<br>INFO: ------------- Run sensors on module linux-web1<br>INFO: Load metrics repository<br>INFO: Load metrics repository (<span class="hljs-keyword">done</span>) | time=13ms<br><br>WARNING: An illegal reflective access operation has occurred<br>WARNING: Illegal reflective access by net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span> (file:/root/.sonar/cache/866bb1adbf016ea515620f1aaa15ec53/sonar-javascript-plugin.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain)<br>WARNING: Please consider reporting this to the maintainers of net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span><br>WARNING: Use --illegal-access=warn to <span class="hljs-built_in">enable</span> warnings of further illegal reflective access operations<br>WARNING: All illegal access operations will be denied <span class="hljs-keyword">in</span> a future release<br>INFO: Sensor Python Squid Sensor [python]<br>INFO: Load project repositories<br>INFO: Load project repositories (<span class="hljs-keyword">done</span>) | time=11ms<br>INFO: Sensor Python Squid Sensor [python] (<span class="hljs-keyword">done</span>) | time=52ms<br>INFO: Sensor Cobertura Sensor <span class="hljs-keyword">for</span> Python coverage [python]<br>INFO: Sensor Cobertura Sensor <span class="hljs-keyword">for</span> Python coverage [python] (<span class="hljs-keyword">done</span>) | time=6ms<br>INFO: Sensor PythonXUnitSensor [python]<br>INFO: Sensor PythonXUnitSensor [python] (<span class="hljs-keyword">done</span>) | time=1ms<br>INFO: Sensor JaCoCo XML Report Importer [jacoco]<br>INFO: Sensor JaCoCo XML Report Importer [jacoco] (<span class="hljs-keyword">done</span>) | time=2ms<br>INFO: Sensor JavaXmlSensor [java]<br>INFO: Sensor JavaXmlSensor [java] (<span class="hljs-keyword">done</span>) | time=0ms<br>INFO: Sensor HTML [web]<br>INFO: Sensor HTML [web] (<span class="hljs-keyword">done</span>) | time=7ms<br>INFO: ------------- Run sensors on project<br>INFO: Sensor Zero Coverage Sensor<br>INFO: Sensor Zero Coverage Sensor (<span class="hljs-keyword">done</span>) | time=11ms<br>INFO: 1 file had no CPD blocks<br>INFO: Calculating CPD <span class="hljs-keyword">for</span> 0 files<br>INFO: CPD calculation finished<br>INFO: Analysis report generated <span class="hljs-keyword">in</span> 48ms, dir size=72 KB<br>INFO: Analysis report compressed <span class="hljs-keyword">in</span> 6ms, zip size=10 KB<br>INFO: Analysis report uploaded <span class="hljs-keyword">in</span> 15ms<br>INFO: ANALYSIS SUCCESSFUL, you can browse http://10.0.0.108:9000/dashboard?id=linux-web1<br>INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report<br>INFO: More about the report processing at http://10.0.0.108:9000/api/ce/task?id=AXmZk3QYw7KZh77zQSPe<br>INFO: Analysis total time: 1.868 s<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION SUCCESS<br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: 2.461s<br>INFO: Final Memory: 12M/44M<br>INFO: ------------------------------------------------------------------------<br>代码扫描完成,请打开sonarqube查看扫描结果<br>  adding: <span class="hljs-built_in">source</span>/ (stored 0%)<br>  adding: <span class="hljs-built_in">source</span>/linux.py (deflated 53%)<br>  adding: .git/ (stored 0%)<br>  adding: .git/hooks/ (stored 0%)<br>  adding: .git/hooks/pre-rebase.sample (deflated 59%)<br>  adding: .git/hooks/commit-msg.sample (deflated 44%)<br>  adding: .git/hooks/pre-commit.sample (deflated 43%)<br>  adding: .git/hooks/prepare-commit-msg.sample (deflated 50%)<br>  adding: .git/hooks/pre-push.sample (deflated 50%)<br>  adding: .git/hooks/update.sample (deflated 68%)<br>  adding: .git/hooks/applypatch-msg.sample (deflated 42%)<br>  adding: .git/hooks/pre-applypatch.sample (deflated 38%)<br>  adding: .git/hooks/pre-receive.sample (deflated 40%)<br>  adding: .git/hooks/post-update.sample (deflated 27%)<br>  adding: .git/hooks/fsmonitor-watchman.sample (deflated 53%)<br>  adding: .git/description (deflated 14%)<br>  adding: .git/info/ (stored 0%)<br>  adding: .git/info/exclude (deflated 28%)<br>  adding: .git/refs/ (stored 0%)<br>  adding: .git/refs/remotes/ (stored 0%)<br>  adding: .git/refs/remotes/origin/ (stored 0%)<br>  adding: .git/refs/remotes/origin/HEAD (stored 0%)<br>  adding: .git/refs/tags/ (stored 0%)<br>  adding: .git/refs/heads/ (stored 0%)<br>  adding: .git/refs/heads/develop (deflated 2%)<br>  adding: .git/logs/ (stored 0%)<br>  adding: .git/logs/refs/ (stored 0%)<br>  adding: .git/logs/refs/remotes/ (stored 0%)<br>  adding: .git/logs/refs/remotes/origin/ (stored 0%)<br>  adding: .git/logs/refs/remotes/origin/HEAD (deflated 30%)<br>  adding: .git/logs/refs/heads/ (stored 0%)<br>  adding: .git/logs/refs/heads/develop (deflated 29%)<br>  adding: .git/logs/HEAD (deflated 29%)<br>  adding: .git/objects/ (stored 0%)<br>  adding: .git/objects/info/ (stored 0%)<br>  adding: .git/objects/pack/ (stored 0%)<br>  adding: .git/objects/pack/pack-a683548f045dbaf2cc3d5a113d75e382742d26b4.idx (deflated 30%)<br>  adding: .git/objects/pack/pack-a683548f045dbaf2cc3d5a113d75e382742d26b4.pack (deflated 15%)<br>  adding: .git/branches/ (stored 0%)<br>  adding: .git/HEAD (stored 0%)<br>  adding: .git/config (deflated 32%)<br>  adding: .git/packed-refs (deflated 27%)<br>  adding: .git/index (deflated 29%)<br>  adding: README.md (deflated 4%)<br>  adding: index.html (deflated 82%)<br>  adding: sonar-project.properties (deflated 39%)<br>  adding: .scannerwork/ (stored 0%)<br>  adding: .scannerwork/.sonar_lock (stored 0%)<br>  adding: .scannerwork/report-task.txt (deflated 41%)<br>代码打包完成<br><br>10.0.0.105 从负载均衡10.0.0.103下线成功<br><br>10.0.0.105 从负载均衡10.0.0.104下线成功<br><br>10.0.0.106 从负载均衡10.0.0.103下线成功<br><br>10.0.0.106 从负载均衡10.0.0.104下线成功<br><br>10.0.0.107 从负载均衡10.0.0.103下线成功<br><br>10.0.0.107 从负载均衡10.0.0.104下线成功<br><br>正在判断服务状态，请稍等3秒钟！<br>3<br><br>2<br><br>1<br><br>Tomcat运行中，1秒后关闭！<br>1<br><br>即将关闭Tomcat服务，请稍等！<br><br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经关闭完成！<br>3<br><br>2<br><br>1<br><br>正在判断服务状态，请稍等3秒钟！<br>3<br><br>2<br><br>1<br><br>Tomcat运行中，1秒后关闭！<br>1<br><br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经关闭完成！<br>3<br><br>2<br><br>1<br><br>正在判断服务状态，请稍等3秒钟！<br>3<br><br>2<br><br>1<br><br>Tomcat运行中，1秒后关闭！<br>1<br><br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经关闭完成！<br>3<br><br>2<br><br>1<br><br>Archive:  /data/tomcat/tomcat_appdir/code-2021-05-23_22-14-04.zip<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/<span class="hljs-built_in">source</span>/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/<span class="hljs-built_in">source</span>/linux.py  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-rebase.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-commit.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/prepare-commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-push.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/applypatch-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-applypatch.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-receive.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/post-update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/fsmonitor-watchman.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/description  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/info/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/info/exclude  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/remotes/origin/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/tags/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/heads/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/heads/develop  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/remotes/origin/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/heads/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/heads/develop  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/info/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/pack/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/pack/pack-a683548f045dbaf2cc3d5a113d75e382742d26b4.idx  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/pack/pack-a683548f045dbaf2cc3d5a113d75e382742d26b4.pack  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/branches/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/HEAD  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/config  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/packed-refs  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/index  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/README.md  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/index.html  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/sonar-project.properties  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.scannerwork/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.scannerwork/.sonar_lock  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.scannerwork/report-task.txt  <br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04&#x27;</span><br><br>Archive:  /data/tomcat/tomcat_appdir/code-2021-05-23_22-14-04.zip<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/<span class="hljs-built_in">source</span>/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/<span class="hljs-built_in">source</span>/linux.py  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-rebase.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-commit.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/prepare-commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-push.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/applypatch-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-applypatch.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-receive.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/post-update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/fsmonitor-watchman.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/description  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/info/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/info/exclude  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/remotes/origin/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/tags/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/heads/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/heads/develop  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/remotes/origin/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/heads/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/heads/develop  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/info/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/pack/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/pack/pack-a683548f045dbaf2cc3d5a113d75e382742d26b4.idx  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/pack/pack-a683548f045dbaf2cc3d5a113d75e382742d26b4.pack  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/branches/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/HEAD  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/config  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/packed-refs  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/index  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/README.md  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/index.html  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/sonar-project.properties  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.scannerwork/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.scannerwork/.sonar_lock  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.scannerwork/report-task.txt  <br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04&#x27;</span><br><br>Archive:  /data/tomcat/tomcat_appdir/code-2021-05-23_22-14-04.zip<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/<span class="hljs-built_in">source</span>/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/<span class="hljs-built_in">source</span>/linux.py  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-rebase.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-commit.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/prepare-commit-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-push.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/applypatch-msg.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-applypatch.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/pre-receive.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/post-update.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/hooks/fsmonitor-watchman.sample  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/description  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/info/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/info/exclude  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/remotes/origin/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/tags/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/heads/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/refs/heads/develop  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/remotes/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/remotes/origin/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/remotes/origin/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/heads/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/refs/heads/develop  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/logs/HEAD  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/info/<br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/pack/<br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/pack/pack-a683548f045dbaf2cc3d5a113d75e382742d26b4.idx  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/objects/pack/pack-a683548f045dbaf2cc3d5a113d75e382742d26b4.pack  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/branches/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/HEAD  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/config  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/packed-refs  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.git/index  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/README.md  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/index.html  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/sonar-project.properties  <br>   creating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.scannerwork/<br> extracting: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.scannerwork/.sonar_lock  <br>  inflating: /data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04/.scannerwork/report-task.txt  <br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/code-2021-05-23_22-14-04&#x27;</span><br><br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br><br>2<br><br>1<br><br>Tomcat没有运行，1秒后启动！<br>1<br><br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br><br>4<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经成功启动1 个Tomcat进程!,PID为5641<br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br><br>2<br><br>1<br><br>Tomcat没有运行，1秒后启动！<br>1<br><br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br><br>4<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经成功启动1 个Tomcat进程!,PID为6892<br><br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br><br>2<br><br>1<br><br>Tomcat没有运行，1秒后启动！<br>1<br><br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br><br>4<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经成功启动1 个Tomcat进程!,PID为6730<br><br>10.0.0.105 测试通过,即将添加到负载<br>10.0.0.105,-----&gt;<br>10.0.0.105 部署完毕,请进行代码测试!<br>10.0.0.106 测试通过,即将添加到负载<br>10.0.0.106,-----&gt;<br><br><br>10.0.0.107 测试通过,即将添加到负载<br>10.0.0.107,-----&gt;<br><br><br>11<br><br>10.0.0.105 删除历史版本 /data/tomcat/tomcat_webdir//data/tomcat/tomcat_webdir/code-2021-05-21_22-31-31成功!<br><br>11<br>10.0.0.106 删除历史版本 /data/tomcat/tomcat_webdir//data/tomcat/tomcat_webdir/code-2021-05-21_22-37-10成功!<br><br>11<br><br>10.0.0.107 删除历史版本 /data/tomcat/tomcat_webdir//data/tomcat/tomcat_webdir/code-2021-05-21_22-32-44成功!<br>Finished: SUCCESS<br></code></pre></td></tr></table></figure><p><strong>Haproxy状态</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another130.png" alt="http://10.0.0.103:9999/haproxy-status"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another131.png" alt="http://10.0.0.104:9999/haproxy-status"></p><h5 id="2-2-6-4-4-构建结果"><a href="#2-2-6-4-4-构建结果" class="headerlink" title="2.2.6.4.4 构建结果"></a>2.2.6.4.4 构建结果</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another132.png" alt="http://10.0.0.248/myapp/"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another133.png" alt="http://10.0.0.105:8080/myapp/"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another134.png" alt="http://10.0.0.106:8080/myapp/"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another135.png" alt="http://10.0.0.107:8080/myapp/"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another136.png" alt="http://10.0.0.103:9999/haproxy-status"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another137.png" alt="http://10.0.0.104:9999/haproxy-status"></p><h1 id="3-实现对测试环境和生产环境代码的回滚"><a href="#3-实现对测试环境和生产环境代码的回滚" class="headerlink" title="3 实现对测试环境和生产环境代码的回滚"></a>3 实现对测试环境和生产环境代码的回滚</h1><h2 id="3-1-修改脚本"><a href="#3-1-修改脚本" class="headerlink" title="3.1 修改脚本"></a>3.1 修改脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#vim index.html</span><br></code></pre></td></tr></table></figure><h2 id="3-2-添加新的内容，并部署到测试环境和生产环境"><a href="#3-2-添加新的内容，并部署到测试环境和生产环境" class="headerlink" title="3.2 添加新的内容，并部署到测试环境和生产环境"></a>3.2 添加新的内容，并部署到测试环境和生产环境</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#  git add .</span><br><br><span class="hljs-comment">#git commit -m &quot;v12&quot;</span><br>[develop feab9bd] v12<br> 1 file changed, 1 insertion(+)<br> <br><span class="hljs-comment">#git push</span><br>Enumerating objects: 5, <span class="hljs-keyword">done</span>.<br>Counting objects: 100% (5/5), <span class="hljs-keyword">done</span>.<br>Delta compression using up to 12 threads<br>Compressing objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>Writing objects: 100% (3/3), 282 bytes | 282.00 KiB/s, <span class="hljs-keyword">done</span>.<br>Total 3 (delta 2), reused 0 (delta 0), pack-reused 0<br>rremote:<br>remote: To create a merge request <span class="hljs-keyword">for</span> develop, visit:<br>remote:   http://10.0.0.101/linux/web1/merge_requests/new?merge_request%5Bsource_branch%5D=develop<br>remote:<br>To http://10.0.0.101/linux/web1.git<br>   a38a0fe..feab9bd  develop -&gt; develop<br></code></pre></td></tr></table></figure><p>构建条件：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another138.png"></p><p>构建结果：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another140.png" alt="全部服务器的结果都一样"></p><h2 id="3-3-测试环境进行代码回滚"><a href="#3-3-测试环境进行代码回滚" class="headerlink" title="3.3 测试环境进行代码回滚"></a>3.3 测试环境进行代码回滚</h2><p>回滚条件：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another14.png"></p><p>回滚过程：</p><p>回滚的时候不会下载代码，不会扫描代码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#Jenkins控制台输出</span><br>Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace /var/lib/jenkins/workspace/linux-web1-deploy<br>[linux-web1-deploy] $ /bin/sh -xe /tmp/jenkins1682363474286860642.sh<br>+ bash /data/scripts/linux-master-web1-develop.sh rollback_last_version master GROUP1<br>10.0.0.105<br><br><br><br>10.0.0.105 从负载均衡10.0.0.103下线成功<br><br>10.0.0.105 从负载均衡10.0.0.104下线成功<br>正在判断服务状态，请稍等3秒钟！<br>3<br>2<br>1<br>Tomcat运行中，1秒后关闭！<br>1<br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经关闭完成！<br>3<br><br>2<br><br>1<br><br>10.0.0.105<br><br>code-2021-05-23_18-46-10,NOW_VERSION<br>code-2021-05-23_11-41-15,NAME<br><br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/code-2021-05-23_11-41-15&#x27;</span><br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br><br>2<br><br>1<br><br>Tomcat没有运行，1秒后启动！<br>1<br><br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br><br>4<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经成功启动1 个Tomcat进程!,PID为2384<br><br>10.0.0.105 测试通过,即将添加到负载<br>10.0.0.105,-----&gt;<br>10.0.0.105 部署完毕,请进行代码测试!<br>Finished: SUCCESS<br><br></code></pre></td></tr></table></figure><p>回滚结果：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another141.png"></p><p><strong>注意：此时10.0.0.105从负载均衡的服务器下线了</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another142.png"></p><h2 id="3-4-对生产环境代码的回滚"><a href="#3-4-对生产环境代码的回滚" class="headerlink" title="3.4 对生产环境代码的回滚"></a>3.4 对生产环境代码的回滚</h2><p>回滚条件：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another143.png"></p><p>回滚过程：</p><p>回滚的时候不会下载代码，不会扫描代码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs bash">Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace /var/lib/jenkins/workspace/linux-web1-deploy<br>[linux-web1-deploy] $ /bin/sh -xe /tmp/jenkins1276882209287301833.sh<br>+ bash /data/scripts/linux-master-web1-develop.sh rollback_last_version develop GROUP2<br>10.0.0.106 10.0.0.107<br><br><br><br>10.0.0.106 从负载均衡10.0.0.103下线成功<br><br>10.0.0.106 从负载均衡10.0.0.104下线成功<br><br>10.0.0.107 从负载均衡10.0.0.103下线成功<br><br>10.0.0.107 从负载均衡10.0.0.104下线成功<br><br>正在判断服务状态，请稍等3秒钟！<br>3<br><br>2<br><br>1<br><br>Tomcat运行中，1秒后关闭！<br>1<br><br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经关闭完成！<br>3<br><br>2<br><br>1<br><br>正在判断服务状态，请稍等3秒钟！<br>3<br><br>2<br><br>1<br><br>Tomcat运行中，1秒后关闭！<br>1<br><br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经关闭完成！<br>3<br><br>2<br><br>1<br><br>10.0.0.106<br>code-2021-05-23_20-28-59,NOW_VERSION<br><br>code-2021-05-23_11-41-15,NAME<br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/code-2021-05-23_11-41-15&#x27;</span><br>10.0.0.107<br><br>code-2021-05-23_20-28-59,NOW_VERSION<br>code-2021-05-23_11-41-15,NAME<br><br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/code-2021-05-23_11-41-15&#x27;</span><br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br><br>2<br><br>1<br><br>Tomcat没有运行，1秒后启动！<br>1<br><br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br><br>4<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经成功启动1 个Tomcat进程!,PID为2126<br><br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br><br>2<br><br>1<br><br>Tomcat没有运行，1秒后启动！<br>1<br><br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br><br>4<br><br>3<br><br>2<br><br>1<br><br>Tomcat 已经成功启动1 个Tomcat进程!,PID为2134<br><br>10.0.0.106 测试通过,即将添加到负载<br>10.0.0.106,-----&gt;<br><br>10.0.0.107 测试通过,即将添加到负载<br>10.0.0.107,-----&gt;<br><br>Finished: SUCCESS<br><br></code></pre></td></tr></table></figure><p>回滚结果：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another144.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another145.png"></p><p><strong>Haproxy状态：</strong></p><p><strong>10.0.0.105已经从负载均衡上线了</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another146.png"></p><h1 id="四、java自动上线脚本"><a href="#四、java自动上线脚本" class="headerlink" title="四、java自动上线脚本"></a>四、java自动上线脚本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#新建文件夹和脚本</span><br>root@jenkins-master:~<span class="hljs-comment"># mkdir /data/scripts</span><br>root@jenkins-master:~<span class="hljs-comment"># vim /data/scripts/linux-java-web1.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>DATE=`date +%Y-%m-%d_%H-%M-%S`<br>METHOD=<span class="hljs-variable">$1</span><br>BRANCH=<span class="hljs-variable">$2</span><br>GROUP_LIST=<span class="hljs-variable">$3</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">IP_list</span></span>()&#123;<br>  <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;GROUP_LIST&#125;</span> == <span class="hljs-string">&quot;GROUP1&quot;</span> ]];<span class="hljs-keyword">then</span><br>     Server_IP=<span class="hljs-string">&quot;10.0.0.105&quot;</span><br>     <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span><br>     <span class="hljs-comment">#一旦为GROUP1，要在负载均衡里下线10.0.0.105，而10.0.0.106和10.0.0.107还是在负载均衡里，然后再对10.0.0.105进行代码部署</span><br>     ssh root@10.0.0.103 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">disable</span>  server linux-web-80-master/10.0.0.105<span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>     ssh root@10.0.0.104 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">disable</span>  server linux-web-80-master/10.0.0.105<span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>  <span class="hljs-keyword">elif</span> [[ <span class="hljs-variable">$&#123;GROUP_LIST&#125;</span> == <span class="hljs-string">&quot;GROUP2&quot;</span> ]];<span class="hljs-keyword">then</span><br>     Server_IP=<span class="hljs-string">&quot;10.0.0.106 10.0.0.107&quot;</span><br>     <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span><br>     <span class="hljs-comment">#要升级其他服务器，证明10.0.0.105已经升级成功，所以要把10.0.0.105再负载均衡里上线，然后就把其他服务器从负载均衡里下线，最后升级其他服务器</span><br>     ssh root@10.0.0.103 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">enable</span>  server linux-web-80-master/10.0.0.105<span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>     ssh root@10.0.0.104 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">enable</span>  server linux-web-80-master/10.0.0.105<span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>  <span class="hljs-keyword">elif</span> [[ <span class="hljs-variable">$&#123;GROUP_LIST&#125;</span> == <span class="hljs-string">&quot;GROUP3&quot;</span> ]];<span class="hljs-keyword">then</span><br>     Server_IP=<span class="hljs-string">&quot;10.0.0.105 10.0.0.106 10.0.0.107&quot;</span><br>     <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span><br>     <span class="hljs-comment">#针对当前所有服务器一次性上线成功，所以不需要顺序执行</span><br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">clone_code</span></span>()&#123;<br>  <span class="hljs-built_in">cd</span> /data/git/linux/ &amp;&amp; rm -rf linux-java-web1<br>  git <span class="hljs-built_in">clone</span> -b <span class="hljs-variable">$&#123;BRANCH&#125;</span> git@10.0.0.101:linux/linux-java-web1.git<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码clone完成&quot;</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">scanner_code</span></span>()&#123;<br>  <span class="hljs-built_in">cd</span> /data/git/linux/linux-java-web1 &amp;&amp; /usr/<span class="hljs-built_in">local</span>/sonar-scanner/bin/sonar-scanner<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码扫描完成,请打开sonarqube查看扫描结果&quot;</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">code_maven</span></span>()&#123;<br> <span class="hljs-built_in">cd</span> /data/git/linux/linux-java-web1 &amp;&amp; mvn clean package -Dmaven.test.skip=<span class="hljs-literal">true</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码编译完成&quot;</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">make_zip</span></span>()&#123;<br>  <span class="hljs-built_in">cd</span> /data/git/linux/linux-java-web1<br>  unzip target/*.war -d /data/git/linux/linux-java-web1/java-code<br>  <span class="hljs-built_in">cd</span> java-code<br>  zip -r code.zip ./<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码打包完成&quot;</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">down_node</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    ssh root@10.0.0.103 <span class="hljs-string">&quot;echo &quot;</span><span class="hljs-built_in">disable</span> server linux-web-80-master/<span class="hljs-variable">$&#123;node&#125;</span><span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span> <br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;node&#125;</span> 从负载均衡10.0.0.103下线成功&quot;</span><br>    ssh root@10.0.0.104 <span class="hljs-string">&quot;echo &quot;</span><span class="hljs-built_in">disable</span> server linux-web-80-master/<span class="hljs-variable">$&#123;node&#125;</span><span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;node&#125;</span> 从负载均衡10.0.0.104下线成功&quot;</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">scp_zipfile</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    scp /data/git/linux/linux-java-web1/java-code/code.zip  www@<span class="hljs-variable">$&#123;node&#125;</span>:/data/tomcat/tomcat_appdir/code-<span class="hljs-variable">$&#123;DATE&#125;</span>.zip<br>    ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;unzip /data/tomcat/tomcat_appdir/code-<span class="hljs-variable">$&#123;DATE&#125;</span>.zip  -d /data/tomcat/tomcat_webdir/code-<span class="hljs-variable">$&#123;DATE&#125;</span> &amp;&amp; rm -rf  /data/tomcat/tomcat_webapps/myapp &amp;&amp; ln -sv  /data/tomcat/tomcat_webdir/code-<span class="hljs-variable">$&#123;DATE&#125;</span> /data/tomcat/tomcat_webapps/myapp&quot;</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">stop_tomcat</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    ssh www@<span class="hljs-variable">$&#123;node&#125;</span>   <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">start_tomcat</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    ssh www@<span class="hljs-variable">$&#123;node&#125;</span>   <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>    <span class="hljs-comment">#sleep 5</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">web_test</span></span>()&#123;<br>  sleep 5<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    NUM=`curl -s  -I -m 10 -o /dev/null  -w %&#123;http_code&#125;  http://<span class="hljs-variable">$&#123;node&#125;</span>:8080/myapp/index.html`<br>    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;NUM&#125;</span> -eq 200 ]];<span class="hljs-keyword">then</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;node&#125;</span> 测试通过,即将添加到负载&quot;</span><br>       add_node <span class="hljs-variable">$&#123;node&#125;</span><br>    <span class="hljs-keyword">else</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;node&#125;</span> 测试失败,请检查该服务器是否成功启动tomcat&quot;</span><br>    <span class="hljs-keyword">fi</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">add_node</span></span>()&#123;<br>   node=<span class="hljs-variable">$1</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;node&#125;</span>,<span class="hljs-string">&quot;-----&gt;&quot;</span><br>    <span class="hljs-comment">#if [[ $&#123;GROUP_LIST&#125; == &quot;GROUP2&quot; ]];then</span><br>    <span class="hljs-comment">#  ssh root@172.31.0.103 &quot;&quot;echo enable  server linux-web-80-master/172.31.0.105&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>    <span class="hljs-comment">#  ssh root@172.31.0.104 &quot;&quot;echo enable  server linux-web-80-master/172.31.0.105&quot; | socat stdio /run/haproxy/admin.sock&quot; </span><br>    <span class="hljs-comment">#fi</span><br>    <span class="hljs-comment">##########################################</span><br>    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$&#123;node&#125;</span> == <span class="hljs-string">&quot;10.0.0.105&quot;</span> ];<span class="hljs-keyword">then</span><br>       <span class="hljs-comment">#如果是第一次升级，且服务器等于10.0.0.105，仅仅会执行会说明已经部署完毕</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;10.0.0.105 部署完毕,请进行代码测试!&quot;</span><br>    <span class="hljs-keyword">else</span><br>       <span class="hljs-comment">#如果是升级其他服务器，就把其他服务器添加到负载均衡里即可</span><br>      ssh root@10.0.0.103 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">enable</span>  server linux-web-80-master/<span class="hljs-variable">$&#123;node&#125;</span><span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>      ssh root@10.0.0.104 <span class="hljs-string">&quot;&quot;</span><span class="hljs-built_in">echo</span> <span class="hljs-built_in">enable</span>  server linux-web-80-master/<span class="hljs-variable">$&#123;node&#125;</span><span class="hljs-string">&quot; | socat stdio /run/haproxy/admin.sock&quot;</span><br>    <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">rollback_last_version</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>   <span class="hljs-built_in">echo</span> <span class="hljs-variable">$node</span><br>   NOW_VERSION=`ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;&quot;</span>/bin/ls -l  -rt /data/tomcat/tomcat_webapps/ | awk -F<span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>  | tail -n1<span class="hljs-string">&quot;&quot;</span>`<br>   NOW_VERSION=`basename <span class="hljs-variable">$&#123;NOW_VERSION&#125;</span>`<br>   <span class="hljs-built_in">echo</span> <span class="hljs-variable">$NOW_VERSION</span>,<span class="hljs-string">&quot;NOW_VERSION&quot;</span><br>   <span class="hljs-comment">#NAME为上一个版本的名称</span><br>   NAME=`ssh  www@<span class="hljs-variable">$&#123;node&#125;</span>  <span class="hljs-string">&quot;&quot;</span>ls  -l  -rt  /data/tomcat/tomcat_webdir/ | grep -B 1 <span class="hljs-variable">$&#123;NOW_VERSION&#125;</span> | head -n1 | awk <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span><span class="hljs-string">&quot;&quot;</span>`<br>   <span class="hljs-built_in">echo</span> <span class="hljs-variable">$NAME</span>,<span class="hljs-string">&quot;NAME&quot;</span><br>   ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;rm -rf /data/tomcat/tomcat_webapps/myapp &amp;&amp; ln -sv  /data/tomcat/tomcat_webdir/<span class="hljs-variable">$&#123;NAME&#125;</span> /data/tomcat/tomcat_webapps/myapp&quot;</span><br>  <span class="hljs-keyword">done</span> <br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">delete_history_version</span></span>()&#123;<br>  <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;Server_IP&#125;</span>;<span class="hljs-keyword">do</span><br>    ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;rm -rf /data/tomcat/tomcat_appdir/*&quot;</span><br>    NUM=`ssh www@<span class="hljs-variable">$&#123;node&#125;</span>  <span class="hljs-string">&quot;&quot;</span>/bin/ls -l -d   -rt /data/tomcat/tomcat_webdir/code-* | wc -l<span class="hljs-string">&quot;&quot;</span>`<br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$NUM</span><br>      <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$&#123;NUM&#125;</span> -gt 10 ];<span class="hljs-keyword">then</span><br>         NAME=`ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;&quot;</span>/bin/ls -l -d   -rt /data/tomcat/tomcat_webdir/code-* | head -n1 | awk <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span><span class="hljs-string">&quot;&quot;</span>`<br>         ssh www@<span class="hljs-variable">$&#123;node&#125;</span> <span class="hljs-string">&quot;rm -rf <span class="hljs-variable">$&#123;NAME&#125;</span>&quot;</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;node&#125;</span> 删除历史版本 /data/tomcat/tomcat_webdir/<span class="hljs-variable">$&#123;NAME&#125;</span>成功!&quot;</span><br>      <span class="hljs-keyword">fi</span><br>  <span class="hljs-keyword">done</span> <br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">main</span></span>()&#123;<br>   <span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span>  <span class="hljs-keyword">in</span><br>      deploy)<br>        IP_list;        <br>        clone_code;<br>        scanner_code;<br>code_maven;<br>        make_zip;<br>        down_node;<br>        stop_tomcat;<br>        scp_zipfile;<br>        start_tomcat;<br>        web_test;<br>        delete_history_version;<br>         ;;<br>      rollback_last_version)<br>        IP_list;<br>        <span class="hljs-comment">#echo $&#123;Server_IP&#125;</span><br>        down_node;<br>        stop_tomcat;<br>        rollback_last_version;<br>        start_tomcat;<br>        web_test;<br>         ;;<br>    <span class="hljs-keyword">esac</span><br>&#125;<br><br>main <span class="hljs-variable">$1</span> <span class="hljs-variable">$2</span> <span class="hljs-variable">$3</span><br><br><span class="hljs-comment">#添加权限</span><br>root@jenkins-master:~<span class="hljs-comment"># chmod a+x /data/scripts/linux-master-web1.sh</span><br><span class="hljs-comment">#手动执行测试脚本</span><br>root@jenkins-master:~<span class="hljs-comment"># bash /data/scripts/linux-master-web1.sh</span><br><br><span class="hljs-comment">#其他和上面的操作一样</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Linux Jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Devops之基于Jenkins的CI与CD</title>
    <link href="/blog/2021/05/24/Devops%E4%B9%8B%E5%9F%BA%E4%BA%8EJenkins%E7%9A%84CI%E4%B8%8ECD/"/>
    <url>/blog/2021/05/24/Devops%E4%B9%8B%E5%9F%BA%E4%BA%8EJenkins%E7%9A%84CI%E4%B8%8ECD/</url>
    
    <content type="html"><![CDATA[<h1 id="Devops之基于Jenkins的CI与CD"><a href="#Devops之基于Jenkins的CI与CD" class="headerlink" title="Devops之基于Jenkins的CI与CD"></a>Devops之基于Jenkins的CI与CD</h1><h2 id="一、DevOps简介"><a href="#一、DevOps简介" class="headerlink" title="一、DevOps简介"></a>一、DevOps简介</h2><p><a href="https://www.bagevent.com/event/6243820?bag_track=bagevent">https://www.bagevent.com/event/6243820?bag_track=bagevent</a> #Gdevops2020<br><a href="https://www.bagevent.com/event/DevOpsDays-SH">https://www.bagevent.com/event/DevOpsDays-SH</a> #DevOpsDays 2019</p><p>DevOps 是 Development 和 Operations 的组合，也就是开发和运维的简写。<br>DevOps 是针对企业中的研发人员、运维人员和测试人员的工作理念，是他们在应用开发、代码部署和质量测试等整条生命周期中协作和沟通的最佳实践，DevOps 强调整个组织的合作以及交付和基础设施变更的自动化、从而实现持续集成、持续部署和持续交付。<br>DevOps 四大平台：代码托管(gitlab/svn)、项目管理(jira)、运维平台(腾讯蓝鲸/开源平台)、持续交付(Jenkins/gitlab)</p><h3 id="1-1-什么是DevOps"><a href="#1-1-什么是DevOps" class="headerlink" title="1.1 什么是DevOps"></a>1.1 什么是DevOps</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-1.png"></p><h3 id="1-2-为什么要推广-DevOps-？"><a href="#1-2-为什么要推广-DevOps-？" class="headerlink" title="1.2 为什么要推广 DevOps ？"></a>1.2 为什么要推广 DevOps ？</h3><p>DevOps 强调团队协作、相互协助、持续发展，然而传统的模式是开发人员只顾开发程序，运维只负责基础环境管理和代码部署及监控等，其并不是为了一个共同的目标而共同实现最终的目的，而 DevOps 则实现团队作战，即无论是开发、运维还是测试，都为了最终的代码发布、持续部署和业务稳定而付出各自的努力，从而实现产品设计、开发、测试和部署的良性循环，实现产品的最终持续交付。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-2.png"></p><h3 id="1-3-传统技术团队"><a href="#1-3-传统技术团队" class="headerlink" title="1.3 传统技术团队"></a>1.3 传统技术团队</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-3.png"></p><h3 id="1-4-DevOps技术团队"><a href="#1-4-DevOps技术团队" class="headerlink" title="1.4 DevOps技术团队"></a>1.4 DevOps技术团队</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-4.png"></p><h3 id="1-5-什么是持续集成-I-CI-Continuous-integration-："><a href="#1-5-什么是持续集成-I-CI-Continuous-integration-：" class="headerlink" title="1.5 什么是持续集成( (I CI- - Continuous integration) ："></a>1.5 什么是持续集成( (I CI- - Continuous integration) ：</h3><p>持续集成是指多名开发者在开发不同功能代码的过程当中，可以频繁的将代码行合并到一起并切相互不影响工作。</p><h3 id="1-6-什么是持续部署-CD-continuous-deployment-："><a href="#1-6-什么是持续部署-CD-continuous-deployment-：" class="headerlink" title="1.6 什么是持续部署( ( CD- - continuous deployment) ："></a>1.6 什么是持续部署( ( CD- - continuous deployment) ：</h3><p>是基于某种工具或平台实现代码自动化的构建、测试和部署到线上环境以实现交付高质量的产品,持续部署在某种程度上代表了一个开发团队的更新迭代速率。</p><h3 id="1-7-什么是持续交付-Continuous-Delivery-："><a href="#1-7-什么是持续交付-Continuous-Delivery-：" class="headerlink" title="1.7 什么是持续交付( ( Continuous Delivery) ："></a>1.7 什么是持续交付( ( Continuous Delivery) ：</h3><p>持续交付是在持续部署的基础之上，将产品交付到线上环境，因此持续交付是产品价值的一种交付，是产品价值的一种盈利的实现。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-5.png"></p><h3 id="1-8-常见的部署方式："><a href="#1-8-常见的部署方式：" class="headerlink" title="1.8 常见的部署方式："></a>1.8 常见的部署方式：</h3><p>开发自己上传–最原始的方案<br>开发给运维手动上传–运维自己手动部署<br>运维使用脚本复制–半自动化<br>结合 web 界面一键部署–自动化</p><h3 id="1-9-：-常见的持续集成开源工具："><a href="#1-9-：-常见的持续集成开源工具：" class="headerlink" title="1.9 ： 常见的持续集成开源工具："></a>1.9 ： 常见的持续集成开源工具：</h3><p>在公司的服务器安装某种程序，该程序用于按照特定格式和方式记录和保存公司多名开发人员不定期提交的源代码，且后期可以按照某种标记及方式对用户提交的数据进行还原。</p><h4 id="1-9-1：CVS-Concurrent-Version-System-："><a href="#1-9-1：CVS-Concurrent-Version-System-：" class="headerlink" title="1.9.1：CVS(Concurrent Version System)："></a>1.9.1：CVS(Concurrent Version System)：</h4><p>早期的集中式版本控制系统，现已基本淘汰</p><p>会出现数据提交后不完整的情况</p><h4 id="1-9-2-SVN-Subversion-–集中式版本控制系统"><a href="#1-9-2-SVN-Subversion-–集中式版本控制系统" class="headerlink" title="1.9.2 SVN(Subversion)–集中式版本控制系统"></a>1.9.2 SVN(Subversion)–集中式版本控制系统</h4><p>2000 年开始开发，目标就是替代 CVS 集中式管理，依赖于网络，一台服务器集中管理目前依然有部分公司在使用</p><h4 id="1-9-3-Gitlib—分布式版本控制系统"><a href="#1-9-3-Gitlib—分布式版本控制系统" class="headerlink" title="1.9.3 Gitlib—分布式版本控制系统:"></a>1.9.3 Gitlib—分布式版本控制系统:</h4><p>Linus 在 1991 年创建了开源的 Linux 内核，从此 Linux 便不断快速发展，不过 Linux 的壮大是离不开全世界的开发者的参与，这么多人在世界各地为 Linux 编写代码，那Linux 内核的代码是如何管理的呢？事实是，在 2002 年以前，世界各地的志愿者把源代码文件通过 diff 的方式发给 Linus，然后由 Linus 本人通过手工方式合并代码！你也许会想，为什么 Linus 不把 Linux 代码放到版本控制系统里呢？不是有 CVS、SVN 这些免费的版本控制系统吗？因为 Linus 坚定地反对 CVS 和 SVN，这些集中式的版本控制系统不但速度慢，且必须联网才能使用，但是也有一些商用的版本控制系统，虽然比CVS、SVN 好用，但那是付费的，和 Linux 的开源精神不符,不过，到了 2002 年，Linux 系统已经发展了十年了，代码库之大让 Linus 很难继续通过手工方式管理了，社区的弟兄们也对这种方式表达了强烈不满，于是 Linus 选择了一个商业的版本控制系统BitKeeper，BitKeeper 的东家 BitMover 公司出于人道主义精神，授权 Linux 社区免费使用这个版本控制系统,但是安定团结的大好局面在 2005 年就被打破了，原因是 Linux 社区牛人聚集，不免沾染了一些梁山好汉的江湖习气，开发 Samba 的 Andrew 试图破解 BitKeeper 的协议（这么干的其实也不只他一个），被 BitMover 公司发现了（监控 工作做得不错！），于是 BitMover 公司怒了，要收回 Linux 社区的免费使用权,这时候 其实 Linus 可以向 BitMover 公司道个歉，保证以后严格管教弟兄们，但这是不可能的，而且实际情况是 Linus 自己花了两周时间自己用C 写了一个分布式版本控制系统， 这就是 Git！一个月之内，Linux 内核的源码已经由 Git 管理了！牛是怎么定义的呢？ 大家可以体会一下,然后Git 迅速成为最流行的分布式版本控制系统，尤其是2008 年， GitHub 网站上线了，它为开源项目免费提供Git 存储，无数开源项目开始迁移至GitHub， 包括 jQuery，PHP，Ruby 等等。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-6.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-7.png"></p><h3 id="1-10-版本控制系统分类"><a href="#1-10-版本控制系统分类" class="headerlink" title="1.10 版本控制系统分类"></a>1.10 版本控制系统分类</h3><h4 id="1-10-1-集中式版本控制系统"><a href="#1-10-1-集中式版本控制系统" class="headerlink" title="1.10.1 集中式版本控制系统"></a>1.10.1 集中式版本控制系统</h4><p>任何的提交和回滚都依赖于连接服务器 SVN 服务器是单点</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-8.png"></p><h4 id="1-10-2-分布式版本控制系统："><a href="#1-10-2-分布式版本控制系统：" class="headerlink" title="1.10.2 分布式版本控制系统："></a>1.10.2 分布式版本控制系统：</h4><p>Git 在每个用户都有一个完整的服务器，然后在有一个中央服务器，用户可以先将代码提交到本地，没有网络也可以先提交到本地，然后在有网络的时候再提交到中央服务器，这样就大大方便了开发者的代码提交和回滚，而相比 CVS 和 SVN 都是集中式的版本控制系统，工作的时候需要先从中央服务器获取最新的代码，改完之后需要提交，如果是一个比较大的文件则需要足够快的网络才能快速提交完成，而使用分布式的版本控制系统，每个用户都是一个完整的版本库，即使没有中央服务器也可以提交代码或者回滚，最终再把改好的代码提交至中央服务器进行合并即可。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-9.png"></p><h2 id="二、Gitlab部署与使用"><a href="#二、Gitlab部署与使用" class="headerlink" title="二、Gitlab部署与使用"></a>二、Gitlab部署与使用</h2><p><a href="https://about.gitlab.com/install/">https://about.gitlab.com/install/</a> # Gitlab 服务的安装文档<br><a href="https://docs.gitlab.com/ce/install/requirements.html">https://docs.gitlab.com/ce/install/requirements.html</a> #安装环境要求</p><h3 id="2-1-下载署并部署-gitlab"><a href="#2-1-下载署并部署-gitlab" class="headerlink" title="2.1 下载署并部署 gitlab"></a>2.1 下载署并部署 gitlab</h3><p>硬件配置：</p><p>CPU：4C（小公司），8C（大公司）</p><p>内存：16G（小公司），32G（大公司）</p><p>硬盘：</p><pre><code>       本地硬盘：IO要快（使用RAID 10），空间要大，最好使用NAS（创建一个2T卷）</code></pre><h4 id="2-1-1-Ubuntu-系统环境准备"><a href="#2-1-1-Ubuntu-系统环境准备" class="headerlink" title="2.1.1 Ubuntu 系统环境准备"></a>2.1.1 Ubuntu 系统环境准备</h4><h5 id="2-1-1-1-Ubuntu-系统环境准备Ubuntu-系统环境准备"><a href="#2-1-1-1-Ubuntu-系统环境准备Ubuntu-系统环境准备" class="headerlink" title="2.1.1.1 Ubuntu 系统环境准备Ubuntu 系统环境准备"></a>2.1.1.1 Ubuntu 系统环境准备Ubuntu 系统环境准备</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#连接root</span><br><span class="hljs-comment">#更改密码</span><br>root@ubuntu:~<span class="hljs-comment"># passwd</span><br>Enter new UNIX password:<br>Retype new UNIX password:<br>passwd: password updated successfully<br><br>root@ubuntu:~<span class="hljs-comment"># vim /etc/ssh/sshd_config</span><br>PermitRootLogin yes<br>PasswordAuthentication yes<br></code></pre></td></tr></table></figure><h5 id="2-1-1-2-置-配置-ubuntu-网卡和主机名"><a href="#2-1-1-2-置-配置-ubuntu-网卡和主机名" class="headerlink" title="2.1.1.2 置 配置 ubuntu 网卡和主机名"></a>2.1.1.2 置 配置 ubuntu 网卡和主机名</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@ubuntu:~<span class="hljs-comment"># cat /etc/netplan/01-netcfg.yaml</span><br><span class="hljs-comment"># This file describes the network interfaces available on your system</span><br><span class="hljs-comment"># For more information, see netplan(5).</span><br>network:<br>  version: 2<br>  renderer: networkd<br>  ethernets:<br>    eth0:<br>      dhcp4: no<br>      addresses: [192.168.8.2/21]<br>      gateway4: 192.168.15.254<br>      nameservers:<br>        addresses: [192.168.15.254]<br>root@ubuntu:~<span class="hljs-comment"># cat /etc/hostname</span><br>jenkins.example.com<br>root@ubuntu:~<span class="hljs-comment"># reboot</span><br></code></pre></td></tr></table></figure><h5 id="2-1-1-3-置配置-ubuntu-仓库"><a href="#2-1-1-3-置配置-ubuntu-仓库" class="headerlink" title="2.1.1.3 置配置 ubuntu 仓库"></a>2.1.1.3 置配置 ubuntu 仓库</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#配置apt源</span><br>root@ubuntu:~<span class="hljs-comment">#vim /etc/apt/sources.list</span><br>deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse<br>deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse<br>deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe<br>multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse<br>deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse<br>deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse<br><br><span class="hljs-comment">#更新apt</span><br>root@jenkins:~<span class="hljs-comment"># apt update</span><br><br><span class="hljs-comment">#安装必要的工具</span><br>root@jenkins:~<span class="hljs-comment"># apt install iproute2 ntpdate tcpdump telnet traceroute nfs-kernel-server nfs-common lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev ntpdate tcpdump telnet traceroute gcc openssh-server lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev ntpdate tcpdump telnet traceroute iotop unzip zip ipmitool</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-10.png"></p><h4 id="2-1-2-Centos-系统环境在准备"><a href="#2-1-2-Centos-系统环境在准备" class="headerlink" title="2.1.2 Centos 系统环境在准备"></a>2.1.2 Centos 系统环境在准备</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#最小化服务器安装，配置如下</span><br>[root@centos7 ~]<span class="hljs-comment">#yum install vim gcc gcc-c++ wget net-tools lrzsz iotop lsof iotop bash-completion -y</span><br>[root@centos7 ~]<span class="hljs-comment">#yum install curl policycoreutils openssh-server openssh-clients postfix -y</span><br>[root@centos7 ~]<span class="hljs-comment">#wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl disable firewalld</span><br>[root@centos7 ~]<span class="hljs-comment">#sed -i &#x27;/SELINUX/s/enforcing/disabled/&#x27; /etc/sysconfig/selinux</span><br>[root@centos7 ~]<span class="hljs-comment">#hostnamectl set-hostname gitlab.example.com</span><br>[root@centos7 ~]<span class="hljs-comment">#reboot</span><br></code></pre></td></tr></table></figure><h4 id="2-1-3-gitlab-安装及使用"><a href="#2-1-3-gitlab-安装及使用" class="headerlink" title="2.1.3 gitlab 安装及使用"></a>2.1.3 gitlab 安装及使用</h4><p>安装包下载地址：<a href="https://packages.gitlab.com/gitlab/gitlab-ce">https://packages.gitlab.com/gitlab/gitlab-ce</a></p><p>rpm 包国内下载地址：<a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/</a></p><p>ubuntu 国内下载地址：<a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu/pool/">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu/pool/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#Ubuntu安装</span><br>root@gitlab:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment">#下载 gitlabdeb包</span><br>root@gitlab:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># dpkg -i gitlab-ce_11.11.8-ce.0_amd64.deb</span><br><span class="hljs-comment">#下面为安装完成的模样</span><br>(Reading database ... 71502 files and directories currently installed.)<br>Preparing to unpack gitlab-ce_11.11.8-ce.0_amd64.deb ...<br>gitlab preinstall: <br>gitlab preinstall: This node does not appear to be running a database<br>gitlab preinstall: Skipping version check, <span class="hljs-keyword">if</span> you think this is an error <span class="hljs-built_in">exit</span> now<br>gitlab preinstall: <br>Unpacking gitlab-ce (11.11.8-ce.0) over (11.11.8-ce.0) ...<br>Setting up gitlab-ce (11.11.8-ce.0) ...<br><br>gitlab: GitLab now ships with a newer version of PostgreSQL (10.7), but it is not yet<br>gitlab: enabled by default. To upgrade, RUN THE FOLLOWING COMMAND:<br><br>sudo gitlab-ctl pg-upgrade<br><br>gitlab: Note: This <span class="hljs-built_in">command</span> does not support Geo instances yet. So we don<span class="hljs-string">&#x27;t</span><br><span class="hljs-string">gitlab: recommend running this command on Geo nodes. It will be supported</span><br><span class="hljs-string">gitlab: in GitLab 12.0.</span><br><span class="hljs-string"></span><br><span class="hljs-string">gitlab: For more details, please see:</span><br><span class="hljs-string">gitlab: https://docs.gitlab.com/omnibus/settings/database.html#upgrade-packaged-postgresql-server</span><br><span class="hljs-string">gitlab: </span><br><span class="hljs-string">It looks like GitLab has not been configured yet; skipping the upgrade script.</span><br><span class="hljs-string"></span><br><span class="hljs-string">       *.                  *.</span><br><span class="hljs-string">      ***                 ***</span><br><span class="hljs-string">     *****               *****</span><br><span class="hljs-string">    .******             *******</span><br><span class="hljs-string">    ********            ********</span><br><span class="hljs-string">   ,,,,,,,,,***********,,,,,,,,,</span><br><span class="hljs-string">  ,,,,,,,,,,,*********,,,,,,,,,,,</span><br><span class="hljs-string">  .,,,,,,,,,,,*******,,,,,,,,,,,,</span><br><span class="hljs-string">      ,,,,,,,,,*****,,,,,,,,,.</span><br><span class="hljs-string">         ,,,,,,,****,,,,,,</span><br><span class="hljs-string">            .,,,***,,,,</span><br><span class="hljs-string">                ,*,.</span><br><span class="hljs-string">  </span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">     _______ __  __          __</span><br><span class="hljs-string">    / ____(_) /_/ /   ____ _/ /_</span><br><span class="hljs-string">   / / __/ / __/ /   / __ `/ __ \</span><br><span class="hljs-string">  / /_/ / / /_/ /___/ /_/ / /_/ /</span><br><span class="hljs-string">  \____/_/\__/_____/\__,_/_.___/</span><br><span class="hljs-string">  </span><br><span class="hljs-string"></span><br><span class="hljs-string">Thank you for installing GitLab!</span><br><span class="hljs-string">GitLab was unable to detect a valid hostname for your instance.</span><br><span class="hljs-string">Please configure a URL for your GitLab instance by setting `external_url`</span><br><span class="hljs-string">configuration in /etc/gitlab/gitlab.rb file.</span><br><span class="hljs-string">Then, you can start your GitLab instance by running the following command:</span><br><span class="hljs-string">  sudo gitlab-ctl reconfigure</span><br><span class="hljs-string"></span><br><span class="hljs-string">For a comprehensive list of configuration options please see the Omnibus GitLab readme</span><br><span class="hljs-string">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md</span><br><span class="hljs-string"></span><br><span class="hljs-string">#Centos安装</span><br><span class="hljs-string">。。。。。。。</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-11.png"></p><h5 id="2-1-3-1-gitlab-配置-使用"><a href="#2-1-3-1-gitlab-配置-使用" class="headerlink" title="2.1.3.1 gitlab 配置 使用"></a>2.1.3.1 gitlab 配置 使用</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># vim /etc/gitlab/gitlab.rb</span><br>（修改一下配置）<br>external_url <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span><br><span class="hljs-comment">#可选邮件通知设置</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_enable&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_address&#x27;</span>] = <span class="hljs-string">&quot;smtp.qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_port&#x27;</span>] = 465<br>gitlab_rails[<span class="hljs-string">&#x27;smtp_user_name&#x27;</span>] = <span class="hljs-string">&quot;346636558@qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_password&#x27;</span>] = <span class="hljs-string">&quot;olvjldsvshrlbgjc&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_domain&#x27;</span>] = <span class="hljs-string">&quot;qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_authentication&#x27;</span>] = :login<br>gitlab_rails[<span class="hljs-string">&#x27;smtp_enable_starttls_auto&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_tls&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;gitlab_email_from&#x27;</span>] = <span class="hljs-string">&quot;346636558@qq.com&quot;</span><br><span class="hljs-comment">#user[&quot;git_user_email&quot;] = &quot;2973707860@qq.com&quot;</span><br><br>root@gitlab:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># grep &quot;^[a-Z]&quot; /etc/gitlab/gitlab.rb</span><br>external_url <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_enable&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_address&#x27;</span>] = <span class="hljs-string">&quot;smtp.qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_port&#x27;</span>] = 465<br>gitlab_rails[<span class="hljs-string">&#x27;smtp_user_name&#x27;</span>] = <span class="hljs-string">&quot;346636558@qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_password&#x27;</span>] = <span class="hljs-string">&quot;olvjldsvshrlbgjc&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_domain&#x27;</span>] = <span class="hljs-string">&quot;qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_authentication&#x27;</span>] = :login<br>gitlab_rails[<span class="hljs-string">&#x27;smtp_enable_starttls_auto&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;gitlab_email_from&#x27;</span>] = <span class="hljs-string">&quot;346636558@qq.com&quot;</span><br><br><span class="hljs-comment">#使用smtp邮件的前提是能ping通smtp.qq.com</span><br>root@gitlab:~<span class="hljs-comment"># ping smtp.qq.com</span><br>PING smtp.qq.com (183.3.225.42) 56(84) bytes of data.<br>64 bytes from 183.3.225.42 (183.3.225.42): icmp_seq=1 ttl=128 time=24.9 ms<br>64 bytes from 183.3.225.42 (183.3.225.42): icmp_seq=2 ttl=128 time=22.2 ms<br>^C<br>--- smtp.qq.com ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1001ms<br>rtt min/avg/max/mdev = 22.200/23.566/24.933/1.375 ms<br></code></pre></td></tr></table></figure><h5 id="2-1-3-2-初始化服务"><a href="#2-1-3-2-初始化服务" class="headerlink" title="2.1.3.2  初始化服务"></a>2.1.3.2  初始化服务</h5><p>执行配置并启动服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gitlab-ctl reconfigure <span class="hljs-comment">#修改完配置文件要执行此操作</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-12.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#gitlab 相关的目录有哪些：</span><br>(以下目录都不能动)<br>/etc/gitlab <span class="hljs-comment">#配置文件目录</span><br>/run/gitlab <span class="hljs-comment">#运行 pid 目录</span><br>/opt/gitlab <span class="hljs-comment">#安装目录</span><br>/var/opt/gitlab <span class="hljs-comment">#数据目录</span><br>/var/<span class="hljs-built_in">log</span>/gitlab <span class="hljs-comment">#日志目录</span><br></code></pre></td></tr></table></figure><h5 id="2-1-3-3-常用命令"><a href="#2-1-3-3-常用命令" class="headerlink" title="2.1.3.3  常用命令"></a>2.1.3.3  常用命令</h5><p>gitlab-rails #用于启动控制台进行特殊操作，比如修改管理员密码、打开数据库控制台( gitlab-rails dbconsole)等</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:~<span class="hljs-comment"># gitlab-rails dbconsole</span><br>psql (9.6.11)<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>.<br><br>gitlabhq_production=&gt; <span class="hljs-built_in">help</span><br>You are using psql, the command-line interface to PostgreSQL.<br>Type:  \copyright <span class="hljs-keyword">for</span> distribution terms<br>       \h <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> with SQL commands<br>       \? <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> with psql commands<br>       \g or terminate with semicolon to execute query<br>       \q to quit<br>gitlabhq_production-&gt; \q<br>could not save <span class="hljs-built_in">history</span> to file <span class="hljs-string">&quot;/var/opt/gitlab/.psql_history&quot;</span>: Permission denied<br><br>root@gitlab:~<span class="hljs-comment"># gitlab-rails --help</span><br>The most common rails commands are:<br> generate     Generate new code (short-cut <span class="hljs-built_in">alias</span>: <span class="hljs-string">&quot;g&quot;</span>)<br> console      Start the Rails console (short-cut <span class="hljs-built_in">alias</span>: <span class="hljs-string">&quot;c&quot;</span>)<br> server       Start the Rails server (short-cut <span class="hljs-built_in">alias</span>: <span class="hljs-string">&quot;s&quot;</span>)<br> <span class="hljs-built_in">test</span>         Run tests except system tests (short-cut <span class="hljs-built_in">alias</span>: <span class="hljs-string">&quot;t&quot;</span>)<br> <span class="hljs-built_in">test</span>:system  Run system tests<br> dbconsole    Start a console <span class="hljs-keyword">for</span> the database specified <span class="hljs-keyword">in</span> config/database.yml<br>              (short-cut <span class="hljs-built_in">alias</span>: <span class="hljs-string">&quot;db&quot;</span>)<br><br> new          Create a new Rails application. <span class="hljs-string">&quot;rails new my_app&quot;</span> creates a<br>              new application called MyApp <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;./my_app&quot;</span><br><br><br>All commands can be run with -h (or --<span class="hljs-built_in">help</span>) <span class="hljs-keyword">for</span> more information.<br>In addition to those commands, there are:<br><br>-------------------------------------------------------------------------------------<br> GitLab:       11.11.8 (1d18d065069)<br> GitLab Shell: 9.1.0<br> PostgreSQL:   9.6.11<br>-------------------------------------------------------------------------------------<br>Rails:<br>  console<br>  dbconsole<br>  destroy<br>  generate<br>  new<br>  runner<br>  secrets:edit<br>  secrets:setup<br>  server<br>  <span class="hljs-built_in">test</span><br>  version<br><br>Rake:<br>  about<br>  acts_as_taggable_on_engine:install:migrations<br>  acts_as_taggable_on_engine:tag_names:collate_bin<br>  acts_as_taggable_on_engine:tag_names:collate_ci<br>  add_limits_mysql<br>  app:template<br>  app:update<br>  assets:clean[keep]<br>  assets:clobber<br>  assets:environment<br>  assets:precompile<br>  brakeman<br>  cache:clear:redis<br>  cache_digests:dependencies<br>  cache_digests:nested_dependencies<br>  ci:cleanup:builds<br>  clean<br>  clobber<br>  config_lint<br>  db:create<br>  db:drop<br>  db:environment:<span class="hljs-built_in">set</span><br>  db:fixtures:load<br>  db:load_config<br>  db:migrate<br>  db:migrate:status<br>  db:rollback<br>  db:schema:cache:clear<br>  db:schema:cache:dump<br>  db:schema:dump<br>  db:schema:load<br>  db:seed<br>  db:seed_fu<br>  db:setup<br>  db:structure:dump<br>  db:structure:load<br>  db:version<br>  dev:cache<br>  dev:load<br>  dev:setup<br>  downtime_check<br>  ee_compat_check<br>  gemojione:aliases<br>  gemojione:install_assets<br>  gettext:add_language[language]<br>  gettext:find<br>  gettext:lint<br>  gettext:pack<br>  gettext:po_to_json<br>  gettext:store_model_attributes<br>  gitlab:app:check<br>  gitlab:artifacts:check<br>  gitlab:artifacts:migrate<br>  gitlab:assets:clean<br>  gitlab:assets:compile<br>  gitlab:assets:fix_urls<br>  gitlab:assets:purge<br>  gitlab:assets:purge_modules<br>  gitlab:backup:create<br>  gitlab:backup:restore<br>  gitlab:check<br>  gitlab:cleanup:block_removed_ldap_users<br>  gitlab:cleanup:<span class="hljs-built_in">dirs</span><br>  gitlab:cleanup:project_uploads<br>  gitlab:cleanup:remote_upload_files<br>  gitlab:cleanup:repos<br>  gitlab:db:composite_primary_keys_add<br>  gitlab:db:composite_primary_keys_drop<br>  gitlab:db:configure<br>  gitlab:db:downtime_check[ref]<br>  gitlab:db:drop_tables<br>  gitlab:db:mark_migration_complete[version]<br>  gitlab:dev:ee_compat_check[branch]<br>  gitlab:env:info<br>  gitlab:exclusive_lease:clear[scope]<br>  gitlab:features:enable_rugged<br>  gitlab:git:fsck<br>  gitlab:gitaly:check<br>  gitlab:gitaly:install[dir,storage_path,repo]<br>  gitlab:gitlab_shell:check<br>  gitlab:import:all_users_to_all_groups<br>  gitlab:import:all_users_to_all_projects<br>  gitlab:import:repos[import_path]<br>  gitlab:import:user_to_groups[email]<br>  gitlab:import:user_to_projects[email]<br>  gitlab:import_export:bump_version<br>  gitlab:import_export:data<br>  gitlab:import_export:version<br>  gitlab:incoming_email:check<br>  gitlab:ldap:rename_provider[old_provider,new_provider]<br>  gitlab:lfs:check<br>  gitlab:lfs:migrate<br>  gitlab:orphans:check<br>  gitlab:orphans:check_namespaces<br>  gitlab:orphans:check_repositories<br>  gitlab:pages:admin_ping<br>  gitlab:seed:issues[project_full_path]<br>  gitlab:setup<br>  gitlab:shell:build_missing_projects<br>  gitlab:shell:create_hooks<br>  gitlab:shell:install[repo]<br>  gitlab:shell:setup<br>  gitlab:sidekiq:check<br>  gitlab:storage:hashed_attachments<br>  gitlab:storage:hashed_projects<br>  gitlab:storage:legacy_attachments<br>  gitlab:storage:legacy_projects<br>  gitlab:storage:list_hashed_attachments<br>  gitlab:storage:list_hashed_projects<br>  gitlab:storage:list_legacy_attachments<br>  gitlab:storage:list_legacy_projects<br>  gitlab:storage:migrate_to_hashed<br>  gitlab:storage:rollback_to_legacy<br>  gitlab:tcp_check[host,port]<br>  gitlab:<span class="hljs-built_in">test</span><br>  gitlab:traces:archive<br>  gitlab:track_deployment<br>  gitlab:two_factor:disable_for_all_users<br>  gitlab:two_factor:rotate_key:apply<br>  gitlab:two_factor:rotate_key:rollback<br>  gitlab:update_project_templates<br>  gitlab:update_templates<br>  gitlab:uploads:check<br>  gitlab:uploads:migrate:all<br>  gitlab:uploads:migrate[uploader_class,model_class,mounted_as]<br>  gitlab:uploads:sanitize:remove_exif[start_id,stop_id,dry_run,sleep_time]<br>  gitlab:web_hook:add<br>  gitlab:web_hook:list<br>  gitlab:web_hook:rm<br>  gitlab:workhorse:install[dir,repo]<br>  grape:path_helpers<br>  grape:routes<br>  hipchat:send[message]<br>  import:github[token,gitlab_username,project_path]<br>  initializers<br>  jira:generate_consumer_key<br>  jira:generate_public_cert<br>  <span class="hljs-built_in">log</span>:clear<br>  middleware<br>  migrate_iids<br>  notes<br>  notes:custom<br>  plugins:validate<br>  postgresql_md5_hash<br>  restart<br>  routes<br>  secret<br>  setup<br>  setup_postgresql<br>  sidekiq:launchd<br>  sidekiq:restart<br>  sidekiq:start<br>  sidekiq:stop<br>  spec<br>  spec:api<br>  spec:feature<br>  spec:lib<br>  spec:models<br>  spec:other<br>  spec:services<br>  stats<br>  <span class="hljs-built_in">test</span><br>  <span class="hljs-built_in">test</span>:db<br>  <span class="hljs-built_in">test</span>:system<br>  time:zones[country_or_offset]<br>  tmp:clear<br>  tmp:create<br>  tokens:reset_all_email<br>  tokens:reset_all_feed<br>  webpack:compile<br>  yarn<br>  yarn:available<br>  yarn:check<br>  yarn:clobber<br>  yarn:install<br></code></pre></td></tr></table></figure><p><strong>gitlab-psql #数据库命令行</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:~<span class="hljs-comment"># gitlab-psql</span><br>psql (9.6.11)<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>.<br><br>gitlabhq_production=<span class="hljs-comment"># \db</span><br>         List of tablespaces<br>    Name    |    Owner    | Location <br>------------+-------------+----------<br> pg_default | gitlab-psql | <br> pg_global  | gitlab-psql | <br>(2 rows)<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># gitlab-rake #数据备份恢复等数据操作</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-rake --help</span><br>rake [-f rakefile] &#123;options&#125; targets...<br><br>Options are ...<br>        --backtrace=[OUT]            Enable full backtrace.  OUT can be stderr (default) or stdout.<br>        --comments                   Show commented tasks only<br>        --job-stats [LEVEL]          Display job statistics. LEVEL=<span class="hljs-built_in">history</span> displays a complete job list<br>        --rules                      Trace the rules resolution.<br>        --suppress-backtrace PATTERN Suppress backtrace lines matching regexp PATTERN. Ignored <span class="hljs-keyword">if</span> --trace is on.<br>    -A, --all                        Show all tasks, even uncommented ones (<span class="hljs-keyword">in</span> combination with -T or -D)<br>    -B, --build-all                  Build all prerequisites, including those <span class="hljs-built_in">which</span> are up-to-date.<br>    -D, --describe [PATTERN]         Describe the tasks (matching optional PATTERN), <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span>.<br>    -e, --execute CODE               Execute some Ruby code and <span class="hljs-built_in">exit</span>.<br>    -E, --execute-continue CODE      Execute some Ruby code, <span class="hljs-keyword">then</span> <span class="hljs-built_in">continue</span> with normal task processing.<br>    -f, --rakefile [FILENAME]        Use FILENAME as the rakefile to search <span class="hljs-keyword">for</span>.<br>    -G, --no-system, --nosystem      Use standard project Rakefile search paths, ignore system wide rakefiles.<br>    -g, --system                     Using system wide (global) rakefiles (usually <span class="hljs-string">&#x27;~/.rake/*.rake&#x27;</span>).<br>    -I, --libdir LIBDIR              Include LIBDIR <span class="hljs-keyword">in</span> the search path <span class="hljs-keyword">for</span> required modules.<br>    -j, --<span class="hljs-built_in">jobs</span> [NUMBER]              Specifies the maximum number of tasks to execute <span class="hljs-keyword">in</span> parallel. (default is number of CPU cores + 4)<br>    -m, --multitask                  Treat all tasks as multitasks.<br>    -n, --dry-run                    Do a dry run without executing actions.<br>    -N, --no-search, --nosearch      Do not search parent directories <span class="hljs-keyword">for</span> the Rakefile.<br>    -P, --prereqs                    Display the tasks and dependencies, <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span>.<br>    -p, --execute-print CODE         Execute some Ruby code, <span class="hljs-built_in">print</span> the result, <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span>.<br>    -q, --quiet                      Do not <span class="hljs-built_in">log</span> messages to standard output.<br>    -r, --require MODULE             Require MODULE before executing rakefile.<br>    -R, --rakelibdir RAKELIBDIR,     Auto-import any .rake files <span class="hljs-keyword">in</span> RAKELIBDIR. (default is <span class="hljs-string">&#x27;rakelib&#x27;</span>)<br>        --rakelib<br>    -s, --silent                     Like --quiet, but also suppresses the <span class="hljs-string">&#x27;in directory&#x27;</span> announcement.<br>    -t, --trace=[OUT]                Turn on invoke/execute tracing, <span class="hljs-built_in">enable</span> full backtrace. OUT can be stderr (default) or stdout.<br>    -T, --tasks [PATTERN]            Display the tasks (matching optional PATTERN) with descriptions, <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span>. -AT combination displays all of tasks contained no description.<br>    -v, --verbose                    Log message to standard output.<br>    -V, --version                    Display the program version.<br>    -W, --<span class="hljs-built_in">where</span> [PATTERN]            Describe the tasks (matching optional PATTERN), <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span>.<br>    -X, --no-deprecation-warnings    Disable the deprecation warnings.<br>    -h, -H, --<span class="hljs-built_in">help</span>                   Display this <span class="hljs-built_in">help</span> message.<br><br><span class="hljs-comment"># gitlab-ctl #客户端命令行操作行</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl --help</span><br>omnibus-ctl: <span class="hljs-built_in">command</span> (subcommand)<br>check-config<br>  Check <span class="hljs-keyword">if</span> there are any configuration <span class="hljs-keyword">in</span> gitlab.rb that is removed <span class="hljs-keyword">in</span> specified version<br>deploy-page<br>  Put up the deploy page<br>diff-config<br>  Compare the user configuration with package available configuration<br>prometheus-upgrade<br>  Upgrade the Prometheus data to the latest supported version<br>remove-accounts<br>  Delete *all* users and groups used by this package<br>upgrade<br>  Run migrations after a package upgrade<br>General Commands:<br>  cleanse<br>    Delete *all* gitlab data, and start from scratch.<br>  <span class="hljs-built_in">help</span><br>    Print this <span class="hljs-built_in">help</span> message.<br>  reconfigure<br>    Reconfigure the application.<br>  show-config<br>    Show the configuration that would be generated by reconfigure.<br>  uninstall<br>    Kill all processes and uninstall the process supervisor (data will be preserved).<br>Service Management Commands:<br>  graceful-kill<br>    Attempt a graceful stop, <span class="hljs-keyword">then</span> SIGKILL the entire process group.<br>  hup<br>    Send the services a HUP.<br>  int<br>    Send the services an INT.<br>  <span class="hljs-built_in">kill</span><br>    Send the services a KILL.<br>  once<br>    Start the services <span class="hljs-keyword">if</span> they are down. Do not restart them <span class="hljs-keyword">if</span> they stop.<br>  restart<br>    Stop the services <span class="hljs-keyword">if</span> they are running, <span class="hljs-keyword">then</span> start them again.<br>  service-list<br>    List all the services (enabled services appear with a *.)<br>  start<br>    Start services <span class="hljs-keyword">if</span> they are down, and restart them <span class="hljs-keyword">if</span> they stop.<br>  status<br>    Show the status of all the services.<br>  stop<br>    Stop the services, and <span class="hljs-keyword">do</span> not restart them.<br>  tail<br>    Watch the service logs of all enabled services.<br>  term<br>    Send the services a TERM.<br>  usr1<br>    Send the services a USR1.<br>  usr2<br>    Send the services a USR2.<br>Database Commands:<br>  pg-password-md5<br>    Generate MD5 Hash of user password <span class="hljs-keyword">in</span> PostgreSQL format<br>  pg-upgrade<br>    Upgrade the PostgreSQL DB to the latest supported version<br>  revert-pg-upgrade<br>    Run this to revert to the previous version of the database<br>  set-replication-password<br>    Set database replication password<br>Let<span class="hljs-string">&#x27;s Encrypt Commands:</span><br><span class="hljs-string">  renew-le-certs</span><br><span class="hljs-string">    Renew the existing Let&#x27;</span>s Encrypt certificates<br>Container Registry Commands:<br>  registry-garbage-collect<br>    Run Container Registry garbage collection.<br><br><span class="hljs-comment"># gitlab-ctl stop #停止 gitlab</span><br><span class="hljs-comment"># gitlab-ctl start #启动 gitlab</span><br><span class="hljs-comment"># gitlab-ctl restar #重启 gitlab</span><br><span class="hljs-comment"># gitlab-ctl status #查看组件运行状态</span><br><span class="hljs-comment"># gitlab-ctl tail nginx #查看某个组件的日志</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-14.png"></p><h5 id="2-1-3-4-验证-gitlab-启动完成"><a href="#2-1-3-4-验证-gitlab-启动完成" class="headerlink" title="2.1.3.4 验证 gitlab 启动完成"></a>2.1.3.4 验证 gitlab 启动完成</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-13.png"></p><h5 id="2-1-3-5-验证端口及状态："><a href="#2-1-3-5-验证端口及状态：" class="headerlink" title="2.1.3.5  验证端口及状态："></a>2.1.3.5  验证端口及状态：</h5><p>80端口是在初始化 gitlib 的时候启动的，因此如果之前的有程序占用会导致初始化失败或无法访问！</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-15.png"></p><h5 id="2-1-3-6-登录-gitlab-web-界面-："><a href="#2-1-3-6-登录-gitlab-web-界面-：" class="headerlink" title="2.1.3.6 登录 gitlab web 界面 ："></a>2.1.3.6 登录 gitlab web 界面 ：</h5><p><a href="http://x.x.x.x/">http://x.x.x.x/</a><br>登录 web 页面并设置密码,最少 8 位：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-16.png"></p><h5 id="2-1-3-7-登录-gitlab-："><a href="#2-1-3-7-登录-gitlab-：" class="headerlink" title="2.1.3.7 登录 gitlab ："></a>2.1.3.7 登录 gitlab ：</h5><p>登录，默认用户为 root：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-17.png"></p><h5 id="2-1-3-8-默认首页"><a href="#2-1-3-8-默认首页" class="headerlink" title="2.1.3.8 默认首页"></a>2.1.3.8 默认首页</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-18.png"></p><h5 id="2-1-3-9-关闭账号注册"><a href="#2-1-3-9-关闭账号注册" class="headerlink" title="2.1.3.9  关闭账号注册"></a>2.1.3.9  关闭账号注册</h5><p>默认情况下可以直接注册账号，因此一般都关闭次功能</p><p><strong>注意：修改这些功能一定要长点心，推荐同时开两个网页，一个到登录页面，一个在修改页面，在修改保存后使用另外以恶搞页面登录，如果发现不能登录就立刻进行修改。</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-19.png"></p><p>取消账户注册功能之后点 save</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-20.png"></p><h5 id="2-1-3-10-验证是否还有注册选项"><a href="#2-1-3-10-验证是否还有注册选项" class="headerlink" title="2.1.3.10 验证是否还有注册选项"></a>2.1.3.10 验证是否还有注册选项</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-21.png"></p><h5 id="2-1-3-11建创建-git-账户"><a href="#2-1-3-11建创建-git-账户" class="headerlink" title="2.1.3.11建创建 git 账户"></a>2.1.3.11建创建 git 账户</h5><p>Admin area – Dashboard – New user</p><p>（通常运维只是创建用户，权限都是由开发老大自己设定）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-22.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-23.png"></p><h5 id="2-1-3-12-重新设置密码"><a href="#2-1-3-12-重新设置密码" class="headerlink" title="2.1. 3.12 重新设置密码"></a>2.1. 3.12 重新设置密码</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-24.png"></p><p>通过邮件重置用户密码</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-25.png"></p><p>在收件箱打开邮件设置密码</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-26.png"></p><p>设置密码</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-27.png"></p><h5 id="2-1-3-13-创建组"><a href="#2-1-3-13-创建组" class="headerlink" title="2 .1.3.13 创建组"></a>2 .1.3.13 创建组</h5><p>使用管理员 root 创建组，一个组里面可以有多个项目分支，可以将开发添加到组里面进行设置权限，不同的组就是公司不同的开发项目或者服务模块，不同的组添加不同的开发即可实现对开发设置权限的管理。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-28.png"></p><h5 id="2-1-3-14-使用管理员创建项目"><a href="#2-1-3-14-使用管理员创建项目" class="headerlink" title="2 .1.3.14 使用管理员创建项目"></a>2 .1.3.14 使用管理员创建项目</h5><p>（创建项目的名称也是由开发决定的）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-29.png"></p><p>使用管理员创建项目（创建项目的时候注意在填写项目的名称之后也要选择由哪个组来管理项目，即在Project URL下IP地址后点击就有的选择）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-30.png"></p><p>创建后的项目效果</p><p>（一般开发都有自己的项目开发工具来配置地址然后上传代码到gitlab）</p><p>python开发工具：pycharm</p><p>java开发工具：eclipse，intellij idea</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-31.png"></p><h5 id="2-1-3-15-将用户添加到组"><a href="#2-1-3-15-将用户添加到组" class="headerlink" title="2.1.3.15 将用户添加到组"></a>2.1.3.15 将用户添加到组</h5><p><a href="https://docs.gitlab.com/ee/user/permissions.html">https://docs.gitlab.com/ee/user/permissions.html</a> (更多权限)</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-32.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-33.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-34.png"></p><h5 id="2-1-3-16-创建一个测试页面"><a href="#2-1-3-16-创建一个测试页面" class="headerlink" title="2.1.3.16 创建一个测试页面"></a>2.1.3.16 创建一个测试页面</h5><p>找到项目界面</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-35.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-36.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-37.png"></p><p>添加一个页面</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-38.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-39.png"></p><h5 id="2-1-3-17-git-客户端测试-clone-项目"><a href="#2-1-3-17-git-客户端测试-clone-项目" class="headerlink" title="2.1.3.17 git 客户端测试 clone 项目"></a>2.1.3.17 git 客户端测试 clone 项目</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># git clone http://10.0.0.101/linux/web1.git</span><br>Cloning into <span class="hljs-string">&#x27;web1&#x27;</span>...<br>Username <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span>: rlin          <br>Password <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://rlin@10.0.0.101&#x27;</span>: <br>remote: Enumerating objects: 3, <span class="hljs-keyword">done</span>.<br>remote: Counting objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>remote: Total 3 (delta 0), reused 0 (delta 0)<br>Unpacking objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>root@gitlab:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># cat web1/README.md </span><br>&lt;h1&gt;This is a README&lt;/h1&gt;<br><br><span class="hljs-comment">#编辑文件并测试提交：</span><br>root@jenkins:/<span class="hljs-built_in">source</span><span class="hljs-comment"># cd test-project/</span><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># git config --global user.name &quot;jack&quot;</span><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># git config --global user.email 2973707860@qq.com</span><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># vim index.html</span><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># cat index.html</span><br>&lt;h1&gt;11111111111&lt;/h1&gt;<br>&lt;h1&gt;22222222222&lt;/h1&gt;<br><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># git add index.html</span><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># git commit -m &quot;v1&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-40.png"></p><h5 id="2-1-3-18-git-web-端验证数据"><a href="#2-1-3-18-git-web-端验证数据" class="headerlink" title="2.1.3.18 git web 端验证数据"></a>2.1.3.18 git web 端验证数据</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-41.png"></p><h5 id="2-1-3-19-gitblab-使用"><a href="#2-1-3-19-gitblab-使用" class="headerlink" title="2.1.3.19 gitblab 使用"></a>2.1.3.19 gitblab 使用</h5><h6 id="2-1-3-19-1-数据保方式"><a href="#2-1-3-19-1-数据保方式" class="headerlink" title="2.1.3.19.1 数据保方式"></a>2.1.3.19.1 数据保方式</h6><p>SVN 与 CVS</p><p>每次提交的文件都单独保存，即按照文件的提交时间区分不同的版本，保存至不同的逻辑存储区域，后期恢复的时候直接基于之前版本恢复。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-42.png"></p><p>Gitlab：<br>Gitlab 与 SVN 的数据保存方式不一样，gitlab 虽然也会在内部对数据进行逻辑划分保存，但是当后期提交的数据如果和之前提交过的数据没有变化，其就直接快照之前的文件，而不是在将文件重新上传一份在保存一遍，这样既节省了空间又加快了代码提交速度。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-43.png"></p><h5 id="2-1-3-19-2-用常用-git-命令："><a href="#2-1-3-19-2-用常用-git-命令：" class="headerlink" title="2.1.3.19.2 用常用 git 命令："></a>2.1.3.19.2 用常用 git 命令：</h5><p>使用 git 命令下载代码与提交代码等操作。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-44.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">git config --global user.name “name“ <span class="hljs-comment">#设置全局用户名</span><br>git config --global user.email xxx@xx.com <span class="hljs-comment">#设置全局邮箱</span><br>git config --global --list <span class="hljs-comment">#列出用户全局设置</span><br>git add index.html / . <span class="hljs-comment">#添加指定文件、目录或当前目录下所有数据到暂存区</span><br>git commit -m “11“ <span class="hljs-comment">#提交文件到工作区</span><br>git status <span class="hljs-comment">#查看工作区的状态</span><br>git push <span class="hljs-comment">#提交代码到服务器</span><br>git pull <span class="hljs-comment">#获取代码到本地</span><br>git <span class="hljs-built_in">log</span> <span class="hljs-comment">#查看操作日志</span><br>vim .gitignore <span class="hljs-comment">#定义忽略文件</span><br>git reset --hard HEAD^^ <span class="hljs-comment">#git 版本回滚， HEAD 为当前版本，加一个^为上一个，^^为上上一个版本，通常只用一个^</span><br>git reflog <span class="hljs-comment"># #获取每次提交的 ID，可以使用--hard 根据提交的 ID 进行版本回退</span><br>git reset --hard 5ae4b06 <span class="hljs-comment">#回退到指定 id 的版本</span><br>git branch <span class="hljs-comment">#查看当前所处的分支</span><br>git checkout -b develop <span class="hljs-comment">#创建并切换到一个新分支</span><br>git checkout develop <span class="hljs-comment">#切换分支</span><br></code></pre></td></tr></table></figure><h6 id="2-1-3-19-3-git-缓存区与工作区等概念："><a href="#2-1-3-19-3-git-缓存区与工作区等概念：" class="headerlink" title="2.1.3.19.3 git 缓存区与工作区等概念："></a>2.1.3.19.3 git 缓存区与工作区等概念：</h6><p>工作区：clone 的代码或者开发自己编写的代码文件所在的目录，通常是代码所在的一个服务的目录名称。</p><p>暂存区：用于存储在工作区中对代码进行修改后的文件所保存的地方，使用 git add 添加。</p><p>本地仓库：用于提交存储在工作区和暂存区中改过的文件地方，使用 git commit 提交。</p><p>远程仓库：多个开发共同协作提交代码的仓库，即 gitlab 服务器。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-45.png"></p><h5 id="2-1-3-20-gitlab-数据备份恢复"><a href="#2-1-3-20-gitlab-数据备份恢复" class="headerlink" title="2.1.3.20 gitlab 数据备份恢复"></a>2.1.3.20 gitlab 数据备份恢复</h5><h6 id="2-1-3-20-1-停止-gitlab-数据服务"><a href="#2-1-3-20-1-停止-gitlab-数据服务" class="headerlink" title="2.1.3.20.1 停止 gitlab 数据服务"></a>2.1.3.20.1 停止 gitlab 数据服务</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@s1:~<span class="hljs-comment"># gitlab-ctl stop unicorn</span><br>ok: down: unicorn: 1s, normally up<br>root@s1:~<span class="hljs-comment"># gitlab-ctl stop sidekiq</span><br>ok: down: sidekiq: 0s, normally up<br></code></pre></td></tr></table></figure><h6 id="2-1-3-20-2-手动备份数据"><a href="#2-1-3-20-2-手动备份数据" class="headerlink" title="2.1.3.20.2 手动备份数据"></a>2.1.3.20.2 手动备份数据</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:~<span class="hljs-comment"># gitlab-rake gitlab:backup:create #在任意目录即可备份当前 gitlab 数据</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl start #备份完成后启动 gitlab</span><br></code></pre></td></tr></table></figure><h6 id="2-1-3-20-3-查看要恢复的文件："><a href="#2-1-3-20-3-查看要恢复的文件：" class="headerlink" title="2.1.3.20.3 查看要恢复的文件："></a>2.1.3.20.3 查看要恢复的文件：</h6><p>/var/opt/gitlab/backups/ # Gitlab 数据备份目录，需要使用命令备份的<br>/var/opt/gitlab/nginx/conf #nginx 配置文件<br>/etc/gitlab/gitlab.rb #gitlab 配置文件<br>/etc/gitlab/gitlab-secrets.json #key 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@s1:~<span class="hljs-comment"># ll /var/opt/gitlab/backups/</span><br>total 408<br>drwx------ 4 git root 4096 Jul 17 10:42 ./<br>drwxr-xr-x 20 root root 4096 Jul 17 10:11 ../<br>-rw------- 1 git git 92160 Jul 17 10:20 1563330030_2019_07_17_11.11.5_gitlab_backup.tar<br>-rw------- 1 git git 92160 Jul 17 10:23 1563330216_2019_07_17_11.11.5_gitlab_backup.tar<br>-rw------- 1 git git 92160 Jul 17 10:30 1563330647_2019_07_17_11.11.5_gitlab_backup.tar<br>-rw------- 1 git git 92160 Jul 17 10:32 1563330751_2019_07_17_11.11.5_gitlab_backup.tar<br></code></pre></td></tr></table></figure><h6 id="2-1-3-20-4-执行恢复"><a href="#2-1-3-20-4-执行恢复" class="headerlink" title="2.1.3.20.4 执行恢复"></a>2.1.3.20.4 执行恢复</h6><p>删除一些数据，测试能否恢复</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:~<span class="hljs-comment"># gitlab-ctl stop unicorn</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl stop sidekiq #恢复数据之前停止服务</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-rake gitlab:backup:restore BACKUP=备份文件名</span><br>如：<br>root@gitlab:~<span class="hljs-comment"># gitlab-rake gitlab:backup:restore BACKUP=1617453050_2021_04_03_11.11.8</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-46.png"></p><p>确认恢复数据</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-47.png"></p><h6 id="2-1-3-20-5-启动服务"><a href="#2-1-3-20-5-启动服务" class="headerlink" title="2.1.3.20.5 启动服务"></a>2.1.3.20.5 启动服务</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@s1:~<span class="hljs-comment"># gitlab-ctl start sidekiq</span><br>ok: run: sidekiq: (pid 16859) 0s<br>root@s1:~<span class="hljs-comment"># gitlab-ctl start unicorn</span><br>ok: run: unicorn: (pid 16882) 1s<br></code></pre></td></tr></table></figure><h6 id="2-1-3-20-6-gitlab简单的备份脚本"><a href="#2-1-3-20-6-gitlab简单的备份脚本" class="headerlink" title="2.1.3.20.6 gitlab简单的备份脚本"></a>2.1.3.20.6 gitlab简单的备份脚本</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>gitlab-ctl stop unicorn<br>gitlab-ctl stop sidekiq<br>gitlab-rake gitlab:backup:create<br>gitlab-ctl start sidekiq<br>gitlab-ctl start unicorn<br></code></pre></td></tr></table></figure><h5 id="2-1-3-21-gitlab-汉化"><a href="#2-1-3-21-gitlab-汉化" class="headerlink" title="2.1.3.21 gitlab 汉化"></a>2.1.3.21 gitlab 汉化</h5><p>虽然不推荐，但是有需求，基于第三方开发爱好者实现</p><h6 id="2-1-3-21-1-载语言包替换"><a href="#2-1-3-21-1-载语言包替换" class="headerlink" title="2.1.3.21.1 载语言包替换"></a>2.1.3.21.1 载语言包替换</h6><p>通过指定版本的语言包汉化</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://gitlab.com/xhang/gitlab/-/archive/v12.3.5-zh/gitlab-v12.3.5-zh.tar.gz<br>https://gitlab.com/xhang/gitlab/-/archive/v11.11.5-zh/gitlab-v11.11.5-zh.tar<br>https://gitlab.com/xhang/gitlab/-/archive/v11.9.8-zh/gitlab-v11.9.8-zh.tar<br>https://gitlab.com/xhang/gitlab/-/tree/v11.11.8-zh<br>https://gitlab.com/xhang/gitlab/ <span class="hljs-comment">#gitlab中文社区</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-48.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#首次安装 gitlab 步骤</span><br>root@gitlab:~<span class="hljs-comment"># vim /etc/gitlab/gitlab.rb #修改配置</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl reconfigure</span><br><br><span class="hljs-comment">#查看gitlab版本</span><br>root@gitlab:~<span class="hljs-comment"># cat /opt/gitlab/version-manifest.txt</span><br>gitlab-ce 11.11.8<br>..........<br><br><span class="hljs-comment">#已经安装 gitlab 步骤</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl stop</span><br>root@gitlab:~<span class="hljs-comment"># tar xvf gitlab-vX.Y.Z-zh.tar</span><br>root@gitlab:~<span class="hljs-comment"># cp -rp /opt/gitlab/embedded/service/gitlab-rails /opt/gitlab-rails.bak #备份源文件</span><br>root@gitlab:~<span class="hljs-comment"># cp -rf gitlab-vX.Y.Z-zh/* /opt/gitlab/embedded/service/gitlab-rails/ #替换文件(拷贝后会出现两个报错，但是不用理会)</span><br>cp: cannot overwrite non-directory <span class="hljs-string">&#x27;/opt/gitlab/embedded/service/gitlab-rails/log&#x27;</span> with directory <span class="hljs-string">&#x27;gitlab-v11.11.8-zh/log&#x27;</span><br>cp: cannot overwrite non-directory <span class="hljs-string">&#x27;/opt/gitlab/embedded/service/gitlab-rails/tmp&#x27;</span> with directory <span class="hljs-string">&#x27;gitlab-v11.11.8-zh/tmp&#x27;</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl reconfigure</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl start</span><br><span class="hljs-comment">#如果重新打开gitlab会出现502就稍等一下</span><br></code></pre></td></tr></table></figure><p>Web 界面更改语言：<br>右上角的账户下拉框选 Settings 然后左侧 Preferences 设置项，然后语言选择中文,保存后刷新界面</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-49.png"></p><h6 id="2-1-3-21-2-通过源码汉化"><a href="#2-1-3-21-2-通过源码汉化" class="headerlink" title="2.1.3.21.2 通过源码汉化"></a>2.1.3.21.2 通过源码汉化</h6><p><strong>如果语言包的汉化不能使用再使用源码汉化</strong></p><p><a href="https://gitlab.com/xhang/gitlab">https://gitlab.com/xhang/gitlab</a> #汉化包地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:~<span class="hljs-comment"># gitlab-ctl stop</span><br>root@gitlab:~<span class="hljs-comment"># git clone https://gitlab.com/xhang/gitlab.git</span><br>root@gitlab:~<span class="hljs-comment"># head -1 /opt/gitlab/version-manifest.txt #查看当前 gitlab 版本</span><br>root@gitlab:~<span class="hljs-comment"># cd gitlab</span><br>root@gitlab:~<span class="hljs-comment"># git diff v11.9.8 v11.9.8-zh （英文版本和中文版本的对比）</span><br>root@gitlab:~<span class="hljs-comment"># git diff v12.3.5 v12.3.5-zh （英文版本和中文版本的对比）</span><br>root@gitlab:~<span class="hljs-comment"># git diff v11.9.8 v11.9.8-zh &gt; /root/v11.9.8-zh.diff</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl stop</span><br>root@gitlab:~<span class="hljs-comment"># patch -f -d /opt/gitlab/embedded/service/gitlab-rails -p1 &lt; /root/v11.9.8-zh.diff （打补丁）</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl reconfigure</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl start</span><br></code></pre></td></tr></table></figure><p>gatlab v11.11.8 汉化效果：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-50.png"></p><p>gatlab V12.3.5：汉化效果:</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-51.png"></p><h3 id="2-2-常见的代码部署方式"><a href="#2-2-常见的代码部署方式" class="headerlink" title="2.2 常见的代码部署方式"></a>2.2 常见的代码部署方式</h3><h4 id="2-2-1-蓝绿部署"><a href="#2-2-1-蓝绿部署" class="headerlink" title="2.2.1 蓝绿部署"></a>2.2.1 蓝绿部署</h4><p>蓝绿部署指的是不停老版本代码(不影响上一个版本访问)，而是在另外一套环境部署新版本然后进行测试，测试通过后将用户流量切到新版本，其特点为业务无中断，升级风险相对较小。<br>具体过程：</p><p>1、当前版本业务正常访问(V1)<br>2、在另外一套环境部署新代码(V2)，代码可能是增加了功能或者是修复了某些 bug<br>3、测试通过之后将用户请求流量切到新版本环境<br>4、观察一段时间，如有异常直接切换旧版本<br>5、下次升级，将旧版本升级到新版本(V3)</p><p>蓝绿部署适用的场景：</p><p>1、不停止老版本，额外部署一套新版本，等测试发现新版本 OK 后，删除老版本。<br>2、蓝绿发布是一种用于升级与更新的发布策略，部署的最小维度是容器，而发布的最小维度是应用。<br>3、蓝绿发布对于增量升级有比较好的支持，但是对于涉及数据表结构变更等等不可逆转的升级，并不完全合适用蓝绿发布来实现，需要结合一些业务的逻辑以及数据迁移与回滚的策略才可以完全满足需求。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-52.png"></p><h4 id="2-2-2-金丝雀发布"><a href="#2-2-2-金丝雀发布" class="headerlink" title="2.2.2 金丝雀发布"></a>2.2.2 金丝雀发布</h4><p>金丝雀发布也叫灰度发布，是指在黑与白之间，能够平滑过渡的一种发布方式，灰度发布是增量发布的一种类型，灰度发布是在原有版本可用的情况下，同时部署一个新版本应用作为“金丝雀”(小白鼠)，测试新版本的性能和表现，以保障整体系统稳定的情况下，尽早发现、调整问题。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">金丝雀”的由来：17 世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；而当瓦斯含量超过一定限度时，虽然鲁钝的人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为“瓦斯检测指标”，以便在危险状况下紧急撤离。<br></code></pre></td></tr></table></figure><p>金丝雀发布、灰度发布步骤组成：</p><p>1、准备好部署各个阶段的工件，包括：构建工件，测试脚本，配置文件和部署清单文件。<br>2、从负载均衡列表中移除掉“金丝雀”服务器。<br>3、升级“金丝雀”应用（排掉原有流量并进行部署）。<br>4、对应用进行自动化测试。<br>5、将“金丝雀”服务器重新添加到负载均衡列表中（连通性和健康检查）。<br>6、如果“金丝雀”在线使用测试成功，升级剩余的其他服务器。（否则就回滚）灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。</p><p>灰度发布/金丝雀部署适用的场景：</p><p>1、不停止老版本，额外搞一套新版本，不同版本应用共存。<br>2、灰度发布中，常常按照用户设置路由权重，例如 90%的用户维持使用老版本，10%的用户尝鲜新版本。<br>3、经常与 A/B 测试一起使用，用于测试选择多种方案。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-53.png"></p><h4 id="2-2-3-滚动发布"><a href="#2-2-3-滚动发布" class="headerlink" title="2.2.3 滚动发布"></a>2.2.3 滚动发布</h4><p>滚动发布，一般是取出一个或者多个服务器停止服务，执行更新，并重新将其投入使用。<br>周而复始，直到集群中所有的实例都更新成新版本。</p><h4 id="2-2-4-A-B-测试"><a href="#2-2-4-A-B-测试" class="headerlink" title="2.2.4 A/B 测试"></a>2.2.4 A/B 测试</h4><p>A/B 测试也是同时运行两个 APP 环境，但是蓝绿部署完全是两码事，A/B 测试是用来测试应用功能表现的方法，例如可用性、受欢迎程度、可见性等等，蓝绿部署的目的是安全稳定地发布新版本应用，并在必要时回滚，即蓝绿部署是一套正式环境环境在线，而A/B 测试是两套正式环境在线。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-54.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-55.png"></p><h4 id="2-2-5-稳定性排序"><a href="#2-2-5-稳定性排序" class="headerlink" title="2.2.5 稳定性排序"></a>2.2.5 稳定性排序</h4><p><strong>A/B测试&gt;蓝绿部署&gt;金丝雀发布&gt;A/B测试</strong></p><h2 id="三、部署web服务器环境"><a href="#三、部署web服务器环境" class="headerlink" title="三、部署web服务器环境"></a>三、部署web服务器环境</h2><h3 id="3-1-一般小公司架构图"><a href="#3-1-一般小公司架构图" class="headerlink" title="3.1 一般小公司架构图"></a>3.1 一般小公司架构图</h3><p><img src=""></p><table><thead><tr><th align="center">IP</th><th align="center">安装的服务</th><th align="center">服务器名称</th></tr></thead><tbody><tr><td align="center">10.0.0.101</td><td align="center">gitlab</td><td align="center">gitlab</td></tr><tr><td align="center">10.0.0.102</td><td align="center">Jenkins</td><td align="center">jenkins-master</td></tr><tr><td align="center">10.0.0.103</td><td align="center">keepalived，HAproxy</td><td align="center">jenkins-slave1</td></tr><tr><td align="center">10.0.0.104</td><td align="center">keepalived，HAproxy</td><td align="center">jenkins-slave2</td></tr><tr><td align="center">10.0.0105</td><td align="center">tomcat</td><td align="center">web1（测试环境）</td></tr><tr><td align="center">10.0.0.106</td><td align="center">tomcat</td><td align="center">web2（生产环境）</td></tr><tr><td align="center">10.0.0.107</td><td align="center">tomcat</td><td align="center">web3（生产环境）</td></tr><tr><td align="center">10.0.0.108</td><td align="center">sonarqube</td><td align="center">sonarqube</td></tr></tbody></table><h3 id="3-2-安装Haproxy"><a href="#3-2-安装Haproxy" class="headerlink" title="3.2 安装Haproxy"></a>3.2 安装Haproxy</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># yum install libnfnetlink-devel libnfnetlink ipvsadm libnl libnl-devel libnl3 libnl3-devel lm_sensors-libs net-snmp-agent-libs net-snmp-libs open server openssh-clients openssl openssl-devel automake iproute</span><br><br><span class="hljs-comment">#安装HAProxy</span><br>root@jenkins-slave1:~<span class="hljs-comment"># apt install haproxy -y</span><br><br><span class="hljs-comment">#haproxy.cfg修改成以下模样</span><br>root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>global<br><span class="hljs-built_in">log</span> /dev/<span class="hljs-built_in">log</span>local0<br><span class="hljs-built_in">log</span> /dev/<span class="hljs-built_in">log</span>local1 notice<br>chroot /var/lib/haproxy<br>stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners<br>stats timeout 30s<br>user haproxy<br>group haproxy<br>daemon<br><br><span class="hljs-comment"># Default SSL material locations</span><br>ca-base /etc/ssl/certs<br>crt-base /etc/ssl/private<br><br><span class="hljs-comment"># Default ciphers to use on SSL-enabled listening sockets.</span><br><span class="hljs-comment"># For more information, see ciphers(1SSL). This list is from:</span><br><span class="hljs-comment">#  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/</span><br><span class="hljs-comment"># An alternative list with additional directives can be obtained from</span><br><span class="hljs-comment">#  https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy</span><br>ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS<br>ssl-default-bind-options no-sslv3<br><br>defaults<br><span class="hljs-built_in">log</span>global<br>modehttp<br>optionhttplog<br>optiondontlognull<br>        timeout connect 5000<br>        timeout client  50000<br>        timeout server  50000<br>errorfile 400 /etc/haproxy/errors/400.http<br>errorfile 403 /etc/haproxy/errors/403.http<br>errorfile 408 /etc/haproxy/errors/408.http<br>errorfile 500 /etc/haproxy/errors/500.http<br>errorfile 502 /etc/haproxy/errors/502.http<br>errorfile 503 /etc/haproxy/errors/503.http<br>errorfile 504 /etc/haproxy/errors/504.http<br><br>listen linux-web-80-develop<br>  <span class="hljs-built_in">bind</span> 10.0.0.249:80<br>  mode http<br>  server 10.0.0.105 10.0.0.105:8080 check inter 2s fall 3 rise 5<br><br>listen linux-web-80-master<br>  <span class="hljs-built_in">bind</span> 10.0.0.248:80<br>  mode http<br>  server 10.0.0.106 10.0.0.106:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.107 10.0.0.107:8080 check inter 2s fall 3 rise 5<br><br>root@jenkins-slave1:~<span class="hljs-comment">#systemctl restart haproxy.service</span><br>root@jenkins-slave1:~<span class="hljs-comment">#systemctl enable haproxy.service</span><br>Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.<br>Executing: /lib/systemd/systemd-sysv-install <span class="hljs-built_in">enable</span> haproxy<br><span class="hljs-comment">#发送到10.0.0.104</span><br>root@jenkins-slave1:~<span class="hljs-comment">#scp /etc/haproxy/haproxy.cfg 10.0.0.104:/etc/haproxy/</span><br>root@jenkins-slave2:~<span class="hljs-comment"># sysctl -a | grep local</span><br>fs.nfs.nsm_local_state = 0<br>net.ipv4.conf.all.accept_local = 0<br>net.ipv4.conf.all.route_localnet = 0<br>net.ipv4.conf.default.accept_local = 0<br>net.ipv4.conf.default.route_localnet = 0<br>net.ipv4.conf.eth0.accept_local = 0<br>net.ipv4.conf.eth0.route_localnet = 0<br>net.ipv4.conf.lo.accept_local = 0<br>net.ipv4.conf.lo.route_localnet = 0<br>net.ipv4.igmp_link_local_mcast_reports = 1<br>net.ipv4.ip_local_port_range = 1000165000<br>net.ipv4.ip_local_reserved_ports = <br>net.ipv4.ip_nonlocal_bind = 0<br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.all.stable_secret&quot;</span><br>net.ipv6.conf.all.accept_ra_from_local = 0<br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.default.stable_secret&quot;</span><br>net.ipv6.conf.default.accept_ra_from_local = 0<br>sysctl: net.ipv6.conf.eth0.accept_ra_from_local = 0<br>reading key <span class="hljs-string">&quot;net.ipv6.conf.eth0.stable_secret&quot;</span><br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.lo.stable_secret&quot;</span><br>net.ipv6.conf.lo.accept_ra_from_local = 0<br>net.ipv6.ip_nonlocal_bind = 0<br>root@jenkins-slave2:~<span class="hljs-comment"># vim /etc/sysctl.conf</span><br><span class="hljs-comment">#添加</span><br>net.ipv4.ip_nonlocal_bind = 1<br>root@jenkins-slave2:~<span class="hljs-comment"># sysctl -p</span><br>root@jenkins-slave2:~<span class="hljs-comment"># systemctl restart haproxy.service</span><br>root@jenkins-slave2:~<span class="hljs-comment"># systemctl enable haproxy.service</span><br></code></pre></td></tr></table></figure><h3 id="3-3-安装并确认KeepAlived"><a href="#3-3-安装并确认KeepAlived" class="headerlink" title="3.3 安装并确认KeepAlived"></a>3.3 安装并确认KeepAlived</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># apt install keepalived -y</span><br><span class="hljs-comment">#复制Keepalived配置文件并修改</span><br>root@jenkins-slave1:~<span class="hljs-comment">#cp /usr/share/doc/keepalived/samples/keepalived.conf.vrrp /etc/keepalived/keepalived.conf</span><br><span class="hljs-comment">#keepalived.conf修改成以下的模样</span><br>root@jenkins-slave1:~<span class="hljs-comment">#vim /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>     acassen<br>   &#125;<br>   notification_email_from Alexandre.Cassen@firewall.loc<br>   smtp_server 192.168.200.1<br>   smtp_connect_timeout 30<br>   router_id LVS_DEVEL<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER<br>    interface eth0<br>    garp_master_delay 10<br>    smtp_alert<br>    virtual_router_id 51<br>    priority 100<br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.248 dev eth0 label eth0:1 <br>        10.0.0.249 dev eth0 label eth0:2<br>    &#125;<br>&#125;<br><br>root@jenkins-slave1:~<span class="hljs-comment">#systemctl restart keepalived.service</span><br>root@jenkins-slave1:~<span class="hljs-comment">#systemctl enable keepalived.service</span><br><span class="hljs-comment">#发送到10.0.0.104</span><br>root@jenkins-slave1:~<span class="hljs-comment">#scp /etc/keepalived/keepalived.conf 10.0.0.104:/etc/keepalived/</span><br>root@jenkins-slave2:~<span class="hljs-comment">#systemctl restart keepalived.service</span><br>root@jenkins-slave2:~<span class="hljs-comment">#systemctl enable keepalived.service</span><br><span class="hljs-comment">#确认jenkins-slave1服务器配置keepalived是否成功</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ping 10.0.0.248</span><br>PING 10.0.0.248 (10.0.0.248) 56(84) bytes of data.<br>64 bytes from 10.0.0.248: icmp_seq=1 ttl=64 time=0.431 ms<br>64 bytes from 10.0.0.248: icmp_seq=2 ttl=64 time=0.331 ms<br>64 bytes from 10.0.0.248: icmp_seq=3 ttl=64 time=0.326 ms<br>^C<br>--- 10.0.0.248 ping statistics ---<br>3 packets transmitted, 3 received, 0% packet loss, time 2053ms<br>rtt min/avg/max/mdev = 0.326/0.362/0.431/0.053 ms<br>root@jenkins-slave2:~<span class="hljs-comment"># apt install keepalived haproxy -y</span><br><br>root@jenkins-slave2:~<span class="hljs-comment"># ifconfig </span><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.104  netmask 255.255.0.0  broadcast 10.0.255.255<br>        inet6 fe80::20c:29ff:fe2b:9b02  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        ether 00:0c:29:2b:9b:02  txqueuelen 1000  (Ethernet)<br>        RX packets 9064  bytes 11704527 (11.7 MB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 3105  bytes 274585 (274.5 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 127.0.0.1  netmask 255.0.0.0<br>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;<br>        loop  txqueuelen 1000  (Local Loopback)<br>        RX packets 137  bytes 11552 (11.5 KB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 137  bytes 11552 (11.5 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br><span class="hljs-comment">#测试Keepalived有没有Ip漂移，先将jenkins-slave1的keepalived停掉，然后再观察本机是否出现eth0:1</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ifconfig </span><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.104  netmask 255.255.0.0  broadcast 10.0.255.255<br>        inet6 fe80::20c:29ff:fe2b:9b02  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        ether 00:0c:29:2b:9b:02  txqueuelen 1000  (Ethernet)<br>        RX packets 9093  bytes 11706447 (11.7 MB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 3128  bytes 277253 (277.2 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>eth0:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.248  netmask 255.255.255.255  broadcast 0.0.0.0<br>        ether 00:0c:29:2b:9b:02  txqueuelen 1000  (Ethernet)<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 127.0.0.1  netmask 255.0.0.0<br>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;<br>        loop  txqueuelen 1000  (Local Loopback)<br>        RX packets 137  bytes 11552 (11.5 KB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 137  bytes 11552 (11.5 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>root@jenkins-slave2:~<span class="hljs-comment"># sysctl -a | grep local</span><br>fs.nfs.nsm_local_state = 0<br>net.ipv4.conf.all.accept_local = 0<br>net.ipv4.conf.all.route_localnet = 0<br>net.ipv4.conf.default.accept_local = 0<br>net.ipv4.conf.default.route_localnet = 0<br>net.ipv4.conf.eth0.accept_local = 0<br>net.ipv4.conf.eth0.route_localnet = 0<br>net.ipv4.conf.lo.accept_local = 0<br>net.ipv4.conf.lo.route_localnet = 0<br>net.ipv4.igmp_link_local_mcast_reports = 1<br>net.ipv4.ip_local_port_range = 1000165000<br>net.ipv4.ip_local_reserved_ports = <br>net.ipv4.ip_nonlocal_bind = 0<br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.all.stable_secret&quot;</span><br>net.ipv6.conf.all.accept_ra_from_local = 0<br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.default.stable_secret&quot;</span><br>net.ipv6.conf.default.accept_ra_from_local = 0<br>sysctl: net.ipv6.conf.eth0.accept_ra_from_local = 0<br>reading key <span class="hljs-string">&quot;net.ipv6.conf.eth0.stable_secret&quot;</span><br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.lo.stable_secret&quot;</span><br>net.ipv6.conf.lo.accept_ra_from_local = 0<br>net.ipv6.ip_nonlocal_bind = 0<br>root@jenkins-slave2:~<span class="hljs-comment"># vim /etc/sysctl.conf</span><br><span class="hljs-comment">#添加</span><br>net.ipv4.ip_nonlocal_bind = 1<br>root@jenkins-slave2:~<span class="hljs-comment"># sysctl -p</span><br></code></pre></td></tr></table></figure><h3 id="3-4-java-环境"><a href="#3-4-java-环境" class="headerlink" title="3.4 java 环境"></a>3.4 java 环境</h3><p>各 web 服务器准备 tomcat 运行环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#全部web服务器都要配置，只演示web1</span><br>root@web1:~<span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment">#下载jdk，下载地址：http://www.sousou88.com/spec/java.html</span><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># tar xf jdk-8u241-linux-x64.tar.gz</span><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/jdk1.8.0_241 /usr/local/jdk</span><br><span class="hljs-string">&#x27;/usr/local/jdk&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/jdk1.8.0_241&#x27;</span><br><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># vim /etc/profile</span><br>（直接在最后添加）<br><span class="hljs-built_in">export</span> HISTTIMEFORMAT=<span class="hljs-string">&quot;%F %T `whoami` &quot;</span><br><span class="hljs-built_in">export</span> <span class="hljs-built_in">export</span> LANG=<span class="hljs-string">&quot;en_US.utf-8&quot;</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/dt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin<br><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># source /etc/profile &amp;&amp; java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_241&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_241-b07)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.241-b07, mixed mode)<br><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># mkdir /apps</span><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># cd /apps/</span><br><span class="hljs-comment">#下载tomcat</span><br>root@web1:/apps<span class="hljs-comment"># tar xf apache-tomcat-8.5.46.tar.gz</span><br>root@web1:/apps<span class="hljs-comment"># ln -sv apache-tomcat-8.5.46 /apps/tomcat</span><br><span class="hljs-string">&#x27;/apps/tomcat&#x27;</span> -&gt; <span class="hljs-string">&#x27;apache-tomcat-8.5.46&#x27;</span><br>root@web1:/apps<span class="hljs-comment"># ll</span><br>total 11364<br>drwxr-xr-x  3 root root     4096 Apr 11 12:33 ./<br>drwxr-xr-x 24 root root     4096 Apr 11 12:33 ../<br>drwxr-xr-x  9 root root     4096 Apr 11 12:33 apache-tomcat-8.5.46/<br>-rw-r--r--  1 root root 11623939 Apr 11 12:33 apache-tomcat-8.5.46.tar.gz<br>lrwxrwxrwx  1 root root       20 Apr 11 12:33 tomcat -&gt; apache-tomcat-8.5.46/<br></code></pre></td></tr></table></figure><h3 id="3-4-准备-tomcat-启动脚本"><a href="#3-4-准备-tomcat-启动脚本" class="headerlink" title="3.4 准备 tomcat 启动脚本"></a>3.4 准备 tomcat 启动脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@web1:/apps<span class="hljs-comment"># vim /etc/init.d/tomcat</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># #########################################################</span><br><span class="hljs-comment"># Tomcat init script for     &quot;中企动力科技股份有限公司&quot;####</span><br><span class="hljs-comment">###########################################################</span><br><span class="hljs-comment"># chkconfig: 2345 96 14 ###################################</span><br><span class="hljs-comment"># description: 2016/11/1.  张士杰##########################</span><br><span class="hljs-comment"># #########################################################</span><br><br>JDK_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br>CATALINA_HOME=/apps/tomcat<br><span class="hljs-built_in">export</span> JDK_HOME CATALINA_HOME<br><span class="hljs-built_in">source</span> /etc/profile<br><span class="hljs-comment">#PID=`ps -ef  | grep  -v grep  | grep java | awk  &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="hljs-comment">#NUM=`ps -ef  | grep  -v grep  | grep java | awk  &#x27;&#123;print $2&#125;&#x27; | wc -l`</span><br><br><span class="hljs-comment">#case $1 in</span><br><span class="hljs-function"><span class="hljs-title">start</span></span>() &#123;<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;正在判断服务状态，请稍等！&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;请稍等3秒钟&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span>;sleep 1<br>   <span class="hljs-keyword">if</span>netstat -an | grep 8080 | grep LISTEN &gt;/dev/null<br>     <span class="hljs-keyword">then</span><br>   <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat已经正在运行了！&quot;</span>  <br>  <span class="hljs-keyword">else</span> <br>   <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat没有运行，1秒后启动！&quot;</span><br><span class="hljs-built_in">echo</span> 1;sleep 1  <br>  <span class="hljs-variable">$CATALINA_HOME</span>/bin/catalina.sh start <br>  <span class="hljs-built_in">echo</span>  <span class="hljs-string">&quot;Tomcat 已经成功启动完成,5秒后判断是否启动成功&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;5&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;4&quot;</span>;sleep 1<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span>;sleep 1<br><span class="hljs-keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null<br>    <span class="hljs-keyword">then</span><br>PID=`ps -ef | grep  tomcat | grep jdk | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>NUM=`ps -ef | grep  tomcat | grep jdk | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | wc -l`<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat 已经成功启动<span class="hljs-variable">$&#123;NUM&#125;</span> 个Tomcat进程!,PID为<span class="hljs-variable">$&#123;PID&#125;</span>&quot;</span><br>    <span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat启动失败，请重新启动！&quot;</span><br>        <span class="hljs-built_in">echo</span> 1<br><span class="hljs-keyword">fi</span><br> <span class="hljs-keyword">fi</span><br>&#125;<br><span class="hljs-function"><span class="hljs-title">stop</span></span>() &#123;<br>PID=`ps -ef  | grep  -v grep  | grep java | awk  <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>NUM=`ps -ef | grep  -v <span class="hljs-string">&quot;color&quot;</span>  | grep tomcat | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | wc -l`<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;正在判断服务状态，请稍等3秒钟！&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span>;sleep 1<br><span class="hljs-keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null <br>   <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat运行中，1秒后关闭！&quot;</span><br><span class="hljs-built_in">echo</span>  1;sleep 1 <br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;即将关闭Tomcat服务，请稍等！&quot;</span> <br>        <span class="hljs-variable">$CATALINA_HOME</span>/bin/catalina.sh stop ;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！&quot;</span> <span class="hljs-comment">#公司用设置为30秒</span><br>sleep 2 <span class="hljs-comment">#公司用设置为27</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span>;sleep 1<br>pkill java &amp;&amp; pkill tomcat<br><span class="hljs-keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null;<span class="hljs-keyword">then</span><br>PID=`ps -ef  | grep  -v grep  | grep java | awk  <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>NUM=`ps -ef | grep  -v <span class="hljs-string">&quot;color&quot;</span>  | grep tomcat | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | wc -l`<br><span class="hljs-built_in">kill</span> -9 <span class="hljs-variable">$PID</span> ;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;已成功关闭<span class="hljs-variable">$&#123;NUM&#125;</span> 个tomcat进程&quot;</span><br><span class="hljs-keyword">else</span><br>  <span class="hljs-built_in">echo</span>  <span class="hljs-string">&quot;Tomcat 已经关闭完成！&quot;</span> <br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span>;sleep 1 <br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat 没有运行&quot;</span><br><span class="hljs-built_in">echo</span> 1<br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null;<span class="hljs-keyword">then</span><br>            PID=`ps -ef  | grep  -v grep  | grep java | awk  <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>            <span class="hljs-comment">#NUM=`ps -ef | grep  -v &quot;color&quot;  | grep tomcat | awk &#x27;&#123;print $2&#125;&#x27; | wc -l`</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;关闭失败，即将强制删除tomcat进程!&quot;</span><br>            sleep 2<br>            pkill tomcat ;sleep 2 <br>            <span class="hljs-keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null;<span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;强制关闭失败，即将再次强制删除tomcat进程!&quot;</span><br>                pkill java; sleep 2<br>            <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br>&#125;<br><span class="hljs-function"><span class="hljs-title">restart</span></span>() &#123;<br>stop <br>start <br> &#125;<br><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-keyword">in</span> <br>start) <br>start <br>;; <br><br>stop) <br>stop <br>;; <br><br>restart) <br>restart <br>;; <br><br>*) <br><span class="hljs-built_in">echo</span> $<span class="hljs-string">&quot;Usage: <span class="hljs-variable">$0</span> &#123;start|stop|restart|status&#125;&quot;</span> <br><span class="hljs-keyword">esac</span><br><br>root@web1:/apps<span class="hljs-comment"># scp /etc/init.d/tomcat 10.0.0.106:/etc/init.d/</span><br>root@web1:/apps<span class="hljs-comment"># scp /etc/init.d/tomcat 10.0.0.107:/etc/init.d/</span><br>root@web1:/apps<span class="hljs-comment"># chmod a+x /etc/init.d/tomcat</span><br>root@web2:/apps<span class="hljs-comment"># chmod a+x /etc/init.d/tomcat</span><br>root@web3:/apps<span class="hljs-comment"># chmod a+x /etc/init.d/tomcat</span><br></code></pre></td></tr></table></figure><h3 id="3-5-web-部署"><a href="#3-5-web-部署" class="headerlink" title="3.5 web 部署"></a>3.5 web 部署</h3><p><strong>部署 web 服务器并确认各 web 服务器访问正常</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#全部web服务器都要配置，只演示web1</span><br>root@web1:/apps<span class="hljs-comment"># useradd -m www -u 2020 -s /bin/bash #创建账户</span><br>root@web1:/apps<span class="hljs-comment"># chown www.www /apps/ -R #修改属主和属组</span><br><span class="hljs-comment">#测试tomcat是否能成功启动</span><br>root@web1:/apps<span class="hljs-comment"># su - www</span><br>www@web1:~$ /etc/init.d/tomcat start<br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Using CATALINA_BASE:   /apps/tomcat<br>Using CATALINA_HOME:   /apps/tomcat<br>Using CATALINA_TMPDIR: /apps/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为1486<br>www@web1:~$ ps -ef | grep tomcat<br>www        1486      1  2 12:59 pts/0    00:00:02 /usr/<span class="hljs-built_in">local</span>/jdk/bin/java -Djava.util.logging.config.file=/apps/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/apps/tomcat -Dcatalina.home=/apps/tomca -Djava.io.tmpdir=/apps/tomcat/temp org.apache.catalina.startup.Bootstrap start<br>www        1552   1455  0 13:01 pts/0    00:00:00 grep --color=auto tomcat<br><span class="hljs-comment">#使用浏览器访问10.0.0.105:8080 10.0.0.106:8080 10.0.0.107:8080，可以看见tomcat的页面</span><br><span class="hljs-comment">#使用浏览器访问10.0.0.248（使用负载均衡访问）</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another1.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another2.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another3.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another4.png"></p><h3 id="3-6-配置-tomcat-配置文件"><a href="#3-6-配置-tomcat-配置文件" class="headerlink" title="3.6 配置 tomcat 配置文件"></a>3.6 配置 tomcat 配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@web1:~<span class="hljs-comment"># mkdir /data/tomcat/tomcat_appdir -p </span><br><span class="hljs-comment">#保存 web 压缩包，同时保存之前版本的备份，保存5个版本之后每多出一个版本就删除最前的一个版本</span><br><span class="hljs-comment">#例如：文件夹中保存了 #myapp_2020_04_01-14-04-50.tar.gz #myapp_2020_04_01-14-30-40.tar.gz</span><br><br>root@web1:~<span class="hljs-comment"># mkdir /data/tomcat/tomcat_webdir </span><br><span class="hljs-comment">#保存解压后的 web 目录，同时保存之前版本的备份，保存5个版本之后每多出一个版本就删除最前的一个版本</span><br><span class="hljs-comment">#例如：文件夹中保存了 #myapp_2020_04_01-14-04-50 #myapp_2020_04_01-14-30-40</span><br><br>root@web1:~<span class="hljs-comment"># mkdir /data/tomcat/tomcat_webapps </span><br><span class="hljs-comment">#tomcat app 加载目录，在 server.xml 定义</span><br><span class="hljs-comment">#在 &lt;Host name=&quot;localhost&quot; appBase=&quot;/data/tomcat/tomcat_Webapps&quot; unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt; </span><br><span class="hljs-comment">#/data/tomcat/tomcat_Webapps --&gt; /data/tomcat/tomcat_webdir/myapp_2020_04_01-14-30-40</span><br><br>root@web1:~<span class="hljs-comment"># vim /apps/tomcat/conf/server.xml</span><br>......<br><span class="hljs-comment">#只要修改appBase那里的地址就可以</span><br> &lt;Host name=<span class="hljs-string">&quot;localhost&quot;</span>  appBase=<span class="hljs-string">&quot;/data/tomcat/tomcat_webapps&quot;</span><br>            unpackWARs=<span class="hljs-string">&quot;false&quot;</span> autoDeploy=<span class="hljs-string">&quot;false&quot;</span>&gt;<br><br>root@web1:~<span class="hljs-comment"># mkdir /data/tomcat/tomcat_webapps/myapp #Java 代码目录</span><br><span class="hljs-comment">#根据各自服务器IP输入内容</span><br>root@web1:~<span class="hljs-comment"># echo 10.0.0.105 &gt; /data/tomcat/tomcat_webapps/myapp/index.html</span><br><br>root@web1:~<span class="hljs-comment"># chown www.www /data/tomcat/ -R</span><br>root@web1:~<span class="hljs-comment"># ll /data/tomcat/</span><br>total 20<br>drwxr-xr-x 5 www  www  4096 Apr 11 22:22 ./<br>drwxr-xr-x 3 root root 4096 Apr 11 22:21 ../<br>drwxr-xr-x 2 www  www  4096 Apr 11 22:21 tomcat_appdir/<br>drwxr-xr-x 2 www  www  4096 Apr 11 22:22 tomcat_webapps/<br>drwxr-xr-x 2 www  www  4096 Apr 11 22:22 tomcat_webdir/<br></code></pre></td></tr></table></figure><h3 id="3-7-启动-tomcat"><a href="#3-7-启动-tomcat" class="headerlink" title="3.7 启动 tomcat"></a>3.7 启动 tomcat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#重启tomcat</span><br>root@web1:~<span class="hljs-comment"># su - www</span><br>www@web1:~$ /etc/init.d/tomcat restart<br>正在判断服务状态，请稍等3秒钟！<br>3<br>2<br>1<br>Tomcat运行中，1秒后关闭！<br>1<br>即将关闭Tomcat服务，请稍等！<br>Using CATALINA_BASE:   /apps/tomcat<br>Using CATALINA_HOME:   /apps/tomcat<br>Using CATALINA_TMPDIR: /apps/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br>3<br>2<br>1<br>Tomcat 已经关闭完成！<br>3<br>2<br>1<br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Using CATALINA_BASE:   /apps/tomcat<br>Using CATALINA_HOME:   /apps/tomcat<br>Using CATALINA_TMPDIR: /apps/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为2013<br></code></pre></td></tr></table></figure><h3 id="3-8-确认各-web-服务器访问正常"><a href="#3-8-确认各-web-服务器访问正常" class="headerlink" title="3.8 确认各 web 服务器访问正常"></a>3.8 确认各 web 服务器访问正常</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#浏览器访问</span><br><span class="hljs-comment">#10.0.0.105:8080,10.0.0.106:8080,10.0.0.107:8080</span><br><span class="hljs-comment">#对比</span><br><span class="hljs-comment">#10.0.0.105:8080/myapp,10.0.0.106:8080/myapp,10.0.0.107:8080/myapp</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another5.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another6.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another7.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another8.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another9.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another10.png"></p><h3 id="3-9-测试访问"><a href="#3-9-测试访问" class="headerlink" title="3.9 测试访问"></a>3.9 测试访问</h3><p><strong>测试 haproxy 反向代理 web 服务器：</strong><br>编辑本机 hosts 文件，将 myapp.web.com 解析到对应的 IP 负载 IP：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">C:\Windows\System32\drivers\etc\hosts<br>10.0.0.248 myapp.web.com<br></code></pre></td></tr></table></figure><p>开启日志文件服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/rsyslog.conf </span><br>14 <span class="hljs-comment"># Provides UDP syslog reception</span><br>15 <span class="hljs-variable">$ModLoad</span> imudp <span class="hljs-comment">#去掉注释</span><br>16 <span class="hljs-variable">$UDPServerRun</span> 514 <span class="hljs-comment">#去掉注释</span><br>18 <span class="hljs-comment"># Provides TCP syslog reception</span><br>19 <span class="hljs-variable">$ModLoad</span> imtcp <span class="hljs-comment">#去掉注释</span><br>20 <span class="hljs-variable">$InputTCPServerRun</span> 514 <span class="hljs-comment">#去掉注释</span><br>93 local3.* /var/<span class="hljs-built_in">log</span>/haproxy.log<br><br>root@jenkins-slave1:~<span class="hljs-comment"># systemctl restart rsyslog</span><br></code></pre></td></tr></table></figure><p>配置 HAProxy 访问日志：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>......<br>listen linux-web-80<br>  <span class="hljs-built_in">bind</span> 10.0.0.248:80<br>  mode http<br>  server 10.0.0.105 10.0.0.105:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.106 10.0.0.106:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.107 10.0.0.107:8080 check inter 2s fall 3 rise 5<br><br><span class="hljs-built_in">log</span> 127.0.0.1 local3 info <br>  listen web_port<br>  <span class="hljs-built_in">bind</span> 0.0.0.0:80<br>  mode http<br>  <span class="hljs-built_in">log</span> global<br>  option httplog<br>  server 10.0.0.105 10.0.0.105:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.106 10.0.0.106:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.107 10.0.0.107:8080 check inter 2s fall 3 rise 5<br></code></pre></td></tr></table></figure><p><strong>重启 rsyslog 和 haproxy 服务，验证/var/log/haproxy.log 可以记录日志：</strong></p><p>浏览器访问：<a href="http://myapp.web.com/myapp/">http://myapp.web.com/myapp/</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-56.png"></p><h3 id="3-10-验证-HAProxy-统计页面"><a href="#3-10-验证-HAProxy-统计页面" class="headerlink" title="3.10 验证 HAProxy 统计页面"></a>3.10 验证 HAProxy 统计页面</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>.....<br>        errorfile 504 /etc/haproxy/errors/504.http<br><br>listen stats<br> mode http<br> <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br> stats <span class="hljs-built_in">enable</span><br> <span class="hljs-built_in">log</span> global<br> stats uri     /haproxy-status<br> stats auth    haadmin:q1w2e3r4ys <span class="hljs-comment">#账号和密码</span><br><br><br>listen linux-web-80<br>  <span class="hljs-built_in">bind</span> 10.0.0.248:80<br>......<br>root@jenkins-slave1:~<span class="hljs-comment"># systemctl restart haproxy</span><br><br>root@jenkins-slave2:~<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>.....<br>        errorfile 504 /etc/haproxy/errors/504.http<br><br>listen stats<br> mode http<br> <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br> stats <span class="hljs-built_in">enable</span><br> <span class="hljs-built_in">log</span> global<br> stats uri     /haproxy-status<br> stats auth    haadmin:q1w2e3r4ys <span class="hljs-comment">#账号和密码</span><br><br><br>listen linux-web-80<br>  <span class="hljs-built_in">bind</span> 10.0.0.248:80<br>......<br>root@jenkins-slave2:~<span class="hljs-comment"># systemctl restart haproxy</span><br></code></pre></td></tr></table></figure><p>浏览器访问：</p><p><a href="http://10.0.0.103:9999/haproxy-status">http://10.0.0.103:9999/haproxy-status</a></p><p><a href="http://10.0.0.104:9999/haproxy-status">http://10.0.0.104:9999/haproxy-status</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-57.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-58.png"></p><h3 id="3-11-验证-haproxy-代理-web-服务器"><a href="#3-11-验证-haproxy-代理-web-服务器" class="headerlink" title="3.11 验证 haproxy 代理 web 服务器"></a>3.11 验证 haproxy 代理 web 服务器</h3><p><a href="http://myapp.web.com/myapp/">http://myapp.web.com/myapp/</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-59.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-60.png"></p><h2 id="四、Jenkins部署于基础配置"><a href="#四、Jenkins部署于基础配置" class="headerlink" title="四、Jenkins部署于基础配置"></a>四、Jenkins部署于基础配置</h2><p><a href="https://www.jenkins.io/zh/">https://www.jenkins.io/zh/</a></p><p>基于java开发，每12周（3个月或一个季度）发布一个TLS版本</p><p>公司配置：</p><p>4核CPU 8G内存 60G磁盘</p><p>8核CPU 16G内存 60G以上的磁盘</p><h3 id="4-1-配置-java-环境并署部署-jenkins"><a href="#4-1-配置-java-环境并署部署-jenkins" class="headerlink" title="4.1 配置 java 环境并署部署 jenkins"></a>4.1 配置 java 环境并署部署 jenkins</h3><h4 id="4-1-1-java-环境配置（在公司一定要用oracale的jdk）"><a href="#4-1-1-java-环境配置（在公司一定要用oracale的jdk）" class="headerlink" title="4.1.1 java 环境配置（在公司一定要用oracale的jdk）"></a>4.1.1 java 环境配置（在公司一定要用oracale的jdk）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment">#下载jdk</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># tar xvf jdk-8u192-linux-x64.tar.gz</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/jdk1.8.0_192/ /usr/local/jdk</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/jdk/bin/java /usr/bin/ #java 命令软连接</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$JAVA_HOME</span>/jre/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> CLASSPATH=.<span class="hljs-variable">$CLASSPATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/lib:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># source /etc/profile</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_192&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_192-b12)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.192-b12, mixed mode)<br></code></pre></td></tr></table></figure><h4 id="4-1-2-启动-Jenkins"><a href="#4-1-2-启动-Jenkins" class="headerlink" title="4.1.2 启动 Jenkins"></a>4.1.2 启动 Jenkins</h4><h5 id="4-1-2-1-下载并安装jenkins"><a href="#4-1-2-1-下载并安装jenkins" class="headerlink" title="4.1.2.1 下载并安装jenkins"></a>4.1.2.1 下载并安装jenkins</h5><p>下载安装包地址</p><p><a href="https://www.jenkins.io/zh/download/">https://www.jenkins.io/zh/download/</a></p><p><a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/debian-stable/">https://mirrors.tuna.tsinghua.edu.cn/jenkins/debian-stable/</a> #ubuntu 安装包下载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载daemon</span><br>root@jenkins-master:~<span class="hljs-comment"># apt install -y daemon</span><br><span class="hljs-comment">#安装Jenkins</span><br>root@jenkins-master:~<span class="hljs-comment"># dpkg -i jenkins_2.222.4_all.deb</span><br><span class="hljs-comment">#如有报错如下</span><br>Mar 08 20:53:10 jenkins-master.magedu.net systemd[1]: Starting LSB: Start Jenkins atboot time...<br>Mar 08 20:53:10 jenkins-master.magedu.net jenkins[17981]: ERROR: No Java executablefound <span class="hljs-keyword">in</span> current PATH: /bin:/usr/bin:/sbin:/usr/sbin<br>Mar 08 20:53:10 jenkins-master.magedu.net jenkins[17981]: If you actually have javainstalled on the system make sure the executable is <span class="hljs-keyword">in</span> the aforementioned path and that<span class="hljs-string">&#x27;type -p java&#x27;</span> returns the java executable path<br>Mar 08 20:53:10 jenkins-master.magedu.net systemd[1]: jenkins.service: Control processexited, code=exited status=1<br>Mar 08 20:53:10 jenkins-master.magedu.net systemd[1]: jenkins.service: Failed withresult <span class="hljs-string">&#x27;exit-code&#x27;</span>.<br><span class="hljs-comment">#解决方案：</span><br>root@jenkins-master:/var/<span class="hljs-built_in">log</span><span class="hljs-comment"># ln -sv /usr/local/jdk/bin/java /usr/bin/</span><br><span class="hljs-string">&#x27;/usr/bin/java&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/jdk/bin/java&#x27;</span><br><br><span class="hljs-comment">#查看安装的路径及文件</span><br>root@jenkins-master:~<span class="hljs-comment"># dpkg -c jenkins_2.222.4_all.deb </span><br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./etc/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./etc/default/<br>-rw-r--r-- root/root      2775 2020-03-04 02:00 ./etc/default/jenkins<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./etc/init.d/<br>-rwxr-xr-x root/root      7860 2020-03-04 02:00 ./etc/init.d/jenkins<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./etc/logrotate.d/<br>-rw-r--r-- root/root       191 2020-03-04 02:00 ./etc/logrotate.d/jenkins<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./usr/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./usr/share/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./usr/share/doc/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./usr/share/doc/jenkins/<br>-rw-r--r-- root/root       138 2020-03-04 02:00 ./usr/share/doc/jenkins/changelog.gz<br>-rw-r--r-- root/root      1498 2020-03-04 02:00 ./usr/share/doc/jenkins/copyright<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./usr/share/jenkins/<br>-rw-r--r-- root/root  64118165 2020-03-04 02:00 ./usr/share/jenkins/jenkins.war<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/cache/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/cache/jenkins/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/lib/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/lib/jenkins/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/<span class="hljs-built_in">log</span>/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/<span class="hljs-built_in">log</span>/jenkins/<br><span class="hljs-comment">#jenkins配置文件</span><br>root@jenkins-master:~<span class="hljs-comment"># vim /etc/default/jenkins</span><br><span class="hljs-comment">#（修改的参数参考下面，但是一般就修改MAXOPENFILES）</span><br>root@jenkins-master:~<span class="hljs-comment"># grep &quot;^[a-Z]&quot; /etc/default/jenkins</span><br>NAME=jenkins<br>JAVA_ARGS=<span class="hljs-string">&quot;-Djava.awt.headless=true&quot;</span><br>PIDFILE=/var/run/<span class="hljs-variable">$NAME</span>/<span class="hljs-variable">$NAME</span>.pid<br>JENKINS_USER=<span class="hljs-variable">$NAME</span><br>JENKINS_GROUP=<span class="hljs-variable">$NAME</span><br>JENKINS_WAR=/usr/share/<span class="hljs-variable">$NAME</span>/<span class="hljs-variable">$NAME</span>.war<br>JENKINS_HOME=/var/lib/<span class="hljs-variable">$NAME</span><br>RUN_STANDALONE=<span class="hljs-literal">true</span><br>JENKINS_LOG=/var/<span class="hljs-built_in">log</span>/<span class="hljs-variable">$NAME</span>/<span class="hljs-variable">$NAME</span>.<span class="hljs-built_in">log</span><br>JENKINS_ENABLE_ACCESS_LOG=<span class="hljs-string">&quot;no&quot;</span><br>MAXOPENFILES=65536<br>HTTP_PORT=8080<br>PREFIX=/<span class="hljs-variable">$NAME</span><br>JENKINS_ARGS=<span class="hljs-string">&quot;--webroot=/var/cache/<span class="hljs-variable">$NAME</span>/war --httpPort=<span class="hljs-variable">$HTTP_PORT</span>&quot;</span><br></code></pre></td></tr></table></figure><h5 id="4-1-2-2-启动并验证Jenkins"><a href="#4-1-2-2-启动并验证Jenkins" class="headerlink" title="4.1.2.2 启动并验证Jenkins"></a>4.1.2.2 启动并验证Jenkins</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启动jenkins</span><br>root@jenkins-master:~<span class="hljs-comment"># systemctl start jenkins</span><br><span class="hljs-comment">#设置为开机启动</span><br>root@jenkins-master:~<span class="hljs-comment"># systemctl enable jenkins</span><br>jenkins.service is not a native service, redirecting to systemd-sysv-install.<br>Executing: /lib/systemd/systemd-sysv-install <span class="hljs-built_in">enable</span> jenkins<br><br><span class="hljs-comment">#检查Jenkins是否启动成功</span><br>root@jenkins-master:/<span class="hljs-comment"># ps -ef|grep jenkins</span><br>jenkins    4759      1  0 22:14 ?        00:00:00 /lib/systemd/systemd --user<br>jenkins    4760   4759  0 22:14 ?        00:00:00 (sd-pam)<br>jenkins    4774      1  0 22:14 ?        00:00:00 /usr/bin/daemon --name=jenkins --inherit --env=JENKINS_HOME=/var/lib/jenkins --output=/var/<span class="hljs-built_in">log</span>/jenkins/jenkins.log --pidfile=/var/run/jenkins/jenkins.pid -- /usr/bin/java -Djava.awt.headless=<span class="hljs-literal">true</span> -jar /usr/share/jenkins/jenkins.war --webroot=/var/cache/jenkins/war --httpPort=8080<br>jenkins    4776   4774 99 22:14 ?        00:00:10 /usr/bin/java -Djava.awt.headless=<span class="hljs-literal">true</span> -jar /usr/share/jenkins/jenkins.war --webroot=/var/cache/jenkins/war --httpPort=8080<br>root       4826   3091  0 22:14 pts/1    00:00:00 grep --color=auto jenkins<br><br><span class="hljs-comment">#jenkins默认监听8080端口</span><br>root@jenkins-master:/<span class="hljs-comment"># lsof -i:8080</span><br>COMMAND  PID    USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>java    5207 jenkins  155u  IPv6  83563      0t0  TCP *:http-alt (LISTEN)<br></code></pre></td></tr></table></figure><h5 id="4-1-2-3-验证Jenkins启动日志"><a href="#4-1-2-3-验证Jenkins启动日志" class="headerlink" title="4.1.2.3 验证Jenkins启动日志"></a>4.1.2.3 验证Jenkins启动日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:/<span class="hljs-comment"># vim /var/log/jenkins/jenkins.log</span><br>*************************************************************<br>*************************************************************<br>*************************************************************<br>Jenkins initial setup is required. An admin user has been created and a password<br>generated.<br>Please use the following password to proceed to installation:<br>d2ef5aeb070b476f81b84c51b598582b<br>This may also be found at: /var/lib/jenkins/secrets/initialAdminPassword<br>*************************************************************<br>*************************************************************<br>*************************************************************<br>2020-03-08 12:54:48.118+0000 [id=28]  INFO  hudson.model.UpdateSite<span class="hljs-comment">#updateData:</span><br>Obtained the latest update center data file <span class="hljs-keyword">for</span> UpdateSource default<br>2020-03-08 12:54:48.310+0000 [id=25]  INFO  jenkins.InitReactorRunner<span class="hljs-variable">$1</span><span class="hljs-comment">#onAttained:</span><br>Completed initialization<br>2020-03-08 12:54:48.319+0000 [id=19]  INFO  hudson.WebAppMain<span class="hljs-variable">$3</span><span class="hljs-comment">#run: Jenkins is</span><br>fully up and running<br>2020-03-08 12:56:16.536+0000 [id=41]  INFO  hudson.model.UpdateSite<span class="hljs-comment">#updateData:</span><br>Obtained the latest update center data file <span class="hljs-keyword">for</span> UpdateSource default<br>2020-03-08 12:56:17.711+0000 [id=41]  INFO  h.m.DownloadService<span class="hljs-variable">$Downloadable</span><span class="hljs-comment">#load:</span><br>Obtained the updated data file <span class="hljs-keyword">for</span> hudson.tasks.Maven.MavenInstaller<br>2020-03-08 12:56:17.711+0000 [id=41]  INFO  hudson.util.Retrier<span class="hljs-comment">#start: Performed</span><br>the action check updates server successfully at the attempt <span class="hljs-comment">#1</span><br>2020-03-08 12:56:17.713+0000 [id=41]  INFO <br>hudson.model.AsyncPeriodicWork<span class="hljs-comment">#lambda$doRun$0: Finished Download metadata. 103,150 ms</span><br></code></pre></td></tr></table></figure><h5 id="4-1-2-4-访问web界面"><a href="#4-1-2-4-访问web界面" class="headerlink" title="4.1.2.4 访问web界面"></a>4.1.2.4 访问web界面</h5><p>浏览器访问：10.0.0.102:8080</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another12.png"></p><p>获取密码的地址</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another13.png" alt="another13"></p><p>查看密码，并粘贴到浏览器里</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another14.png"></p><h5 id="4-1-2-2-通过-jar-包直接启动-jenkins"><a href="#4-1-2-2-通过-jar-包直接启动-jenkins" class="headerlink" title="4.1.2.2 通过 jar 包直接启动 jenkins"></a>4.1.2.2 通过 jar 包直接启动 jenkins</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载jdk-8u241-linux-x64.tar.gz，jenkins.war</span><br><br><span class="hljs-comment">#解压jdk，设置软连接</span><br><br><span class="hljs-comment">#配置环境变量</span><br><br><span class="hljs-comment">#安装Jenkins</span><br>java -jar jenkins.war &amp;<br><span class="hljs-comment">#或（添加参数）</span><br>java \<br>-Dcom.sun.management.jmxremote \<br>-Dcom.sun.management.jmxremote.port=12345 \<br>-Dcom.sun.management.jmxremote.authenticate=<span class="hljs-literal">false</span> \<br>-Dcom.sun.management.jmxremote.ssl=<span class="hljs-literal">false</span> \<br>-Djava.rmi.server.hostname=<span class="hljs-string">&quot;192.168.8.2 &quot;</span> \<br>-jar jenkins-2.138.3.war &amp;<br><span class="hljs-comment">#详细的参数添加：java -jar jenkins.war --help</span><br><br><span class="hljs-comment">#使用nginx反向代理，修改hosts文件</span><br><br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure><h5 id="4-1-2-3-使用-tomcat-安装-Jenkins"><a href="#4-1-2-3-使用-tomcat-安装-Jenkins" class="headerlink" title="4.1.2.3 使用 tomcat 安装 Jenkins"></a>4.1.2.3 使用 tomcat 安装 Jenkins</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkdir /apps<br><span class="hljs-comment">#下载tomcat(如：apache-tpmcat-8.5.46.tar.gz)和jenkins.war到/apps里</span><br><span class="hljs-comment">#解压tomcat</span><br><span class="hljs-comment">#将jenkins.war拷贝到apache-tomcat-8.5.46/webapps里</span><br><span class="hljs-comment">#解压jenkins.war</span><br>unzip jenkins.war -d jenkins<br><span class="hljs-comment">#修改tomcat的server.xml</span><br>&lt;Host name=<span class="hljs-string">&quot;localhost&quot;</span>  appBase=<span class="hljs-string">&quot;webapps&quot;</span> unpackWARs=<span class="hljs-string">&quot;false&quot;</span> autoDeploy=<span class="hljs-string">&quot;false&quot;</span>&gt;<br><span class="hljs-comment">#开启tomcat /apps/apache-tomcat-8.5.46/bin/catalina.sh start</span><br><span class="hljs-comment">#浏览器打开ip:8080/Jenkins</span><br></code></pre></td></tr></table></figure><h5 id="4-1-2-4-rpm-包装安装-jenkins-配置"><a href="#4-1-2-4-rpm-包装安装-jenkins-配置" class="headerlink" title="4.1.2.4 rpm 包装安装 jenkins 配置"></a>4.1.2.4 rpm 包装安装 jenkins 配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@s1 ~]<span class="hljs-comment"># grep -v &quot;#&quot; /etc/sysconfig/jenkins | grep -v &quot;^$&quot;</span><br>JENKINS_HOME=<span class="hljs-string">&quot;/var/lib/jenkins&quot;</span><br>JENKINS_JAVA_CMD=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_USER=<span class="hljs-string">&quot;jenkins&quot;</span><br>JENKINS_JAVA_OPTIONS=<span class="hljs-string">&quot;-Djava.awt.headless=true \</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote \</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.port=12345 \</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.authenticate=false \</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.ssl=false \</span><br><span class="hljs-string">-Djava.rmi.server.hostname=&quot;</span>192.168.7.101<span class="hljs-string">&quot; \</span><br><span class="hljs-string">&quot;</span><br>JENKINS_PORT=<span class="hljs-string">&quot;8080&quot;</span><br>JENKINS_LISTEN_ADDRESS=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_HTTPS_PORT=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_HTTPS_KEYSTORE=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_HTTPS_KEYSTORE_PASSWORD=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_HTTPS_LISTEN_ADDRESS=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_DEBUG_LEVEL=<span class="hljs-string">&quot;5&quot;</span><br>JENKINS_ENABLE_ACCESS_LOG=<span class="hljs-string">&quot;no&quot;</span><br>JENKINS_HANDLER_MAX=<span class="hljs-string">&quot;100&quot;</span><br>JENKINS_HANDLER_IDLE=<span class="hljs-string">&quot;20&quot;</span><br>JENKINS_ARGS=<span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment">#可选启动参数：</span><br>JENKINS_JAVA_OPTIONS=<span class="hljs-string">&quot;--server -Xms1g -Xmx1g -Xss512k -Xmn1g</span><br><span class="hljs-string">-XX:CMSInitiatingOccupancyFraction=65</span><br><span class="hljs-string">-XX:+UseFastAccessorMethods</span><br><span class="hljs-string">-XX:+AggressiveOpts -XX:+UseBiasedLocking</span><br><span class="hljs-string">-XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10</span><br><span class="hljs-string">-XX:NewSize=2048M -XX:MaxNewSize=2048M -XX:NewRatio=2</span><br><span class="hljs-string">-XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5</span><br><span class="hljs-string">-XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC</span><br><span class="hljs-string">-XX:+CMSParallelRemarkEnabled -Djava.awt.headless=true</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.port=12345</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.authenticate=false</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.ssl=false</span><br><span class="hljs-string">-Djava.rmi.server.hostname=&quot;</span>192.168.7.102<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><h4 id="4-1-3-Jenkins-启动过程"><a href="#4-1-3-Jenkins-启动过程" class="headerlink" title="4.1.3 Jenkins 启动过程"></a>4.1.3 Jenkins 启动过程</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-61.png"></p><h4 id="4-1-4-访问-jenkins-页面"><a href="#4-1-4-访问-jenkins-页面" class="headerlink" title="4.1.4 访问 jenkins 页面"></a>4.1.4 访问 jenkins 页面</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-62.png"></p><h4 id="4-1-5-选择安装-jenkins-插件"><a href="#4-1-5-选择安装-jenkins-插件" class="headerlink" title="4.1.5 选择安装 jenkins 插件"></a>4.1.5 选择安装 jenkins 插件</h4><h5 id="4-1-5-0-Jenkins安装插件提速（直接使用最后一种）"><a href="#4-1-5-0-Jenkins安装插件提速（直接使用最后一种）" class="headerlink" title="4.1.5.0 Jenkins安装插件提速（直接使用最后一种）"></a>4.1.5.0 Jenkins安装插件提速（直接使用最后一种）</h5><p><a href="https://www.cnblogs.com/hellxz/p/jenkins_install_plugins_faster.html">https://www.cnblogs.com/hellxz/p/jenkins_install_plugins_faster.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> <span class="hljs-variable">$JENKINS_HOME</span><br>curl -Lo update-center.json https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json<br>sed -i <span class="hljs-string">&#x27;s#http://updates.jenkins-ci.org/download#https://mirrors.tuna.tsinghua.edu.cn/jenkins#g&#x27;</span> update-center.json &amp;&amp; sed -i <span class="hljs-string">&#x27;s#http://www.google.com#https://www.baidu.com#g&#x27;</span> update-center.json<br><span class="hljs-comment">#安装Nginx</span><br>sudo apt install nginx -y<br><span class="hljs-comment">#移动配置到nginx默认web目录</span><br>sudo mv update-center.json /var/www/html/<br><span class="hljs-comment">#修改Jenkins配置文件</span><br>sed -i <span class="hljs-string">&quot;s#https://updates.jenkins.io/update-center.json#http://10.0.0.102/update-center.json#g&quot;</span> hudson.model.UpdateCenter.xml<br></code></pre></td></tr></table></figure><h5 id="4-1-5-1-解决插件安装慢的解决方式，通过-Nginx-进行-rewrite-或者反向代理"><a href="#4-1-5-1-解决插件安装慢的解决方式，通过-Nginx-进行-rewrite-或者反向代理" class="headerlink" title="4.1.5.1 解决插件安装慢的解决方式，通过 Nginx 进行 rewrite 或者反向代理"></a>4.1.5.1 解决插件安装慢的解决方式，通过 Nginx 进行 rewrite 或者反向代理</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装nginx，最好是选择在其他服务器安装</span><br>root@web2:~<span class="hljs-comment"># cd /usr/local/src/</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># </span><br><span class="hljs-comment">#下载nginx</span><br><br><span class="hljs-comment">#解压nginx</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># tar xf nginx-1.16.1.tar.gz</span><br><br><span class="hljs-comment">#安装nginx</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># cd nginx-1.16.1/</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># ./configure --prefix=/apps/nginx</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># apt install -y make</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># make</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># make install</span><br><br><span class="hljs-comment">#修改nginx配置文件</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># cd /apps/nginx/conf/</span><br>root@web2:/apps/nginx/conf<span class="hljs-comment"># vim nginx.conf</span><br>......<br>location /download/plugins &#123;<br>      proxy_set_header Host mirrors.tuna.tsinghua.edu.cn;<br>      proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>      proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>      rewrite /download/plugins(.*) /jenkins/plugins/<span class="hljs-variable">$1</span> <span class="hljs-built_in">break</span>;<br>      proxy_pass http://mirrors.tuna.tsinghua.edu.cn;<br>&#125;<br><br><span class="hljs-comment">#开启nginx</span><br>root@web2:/apps/nginx/conf<span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>root@web2:/apps/nginx/conf<span class="hljs-comment"># /apps/nginx/sbin/nginx</span><br><br>root@jenkins-master:~<span class="hljs-comment"># vim /etc/hosts</span><br>.....<br>10.0.0.106 updates.jenkins-ci.org <span class="hljs-comment">#添加hosts解析</span><br><br><span class="hljs-comment">#重启Jenkins</span><br>root@jenkins-master:~<span class="hljs-comment"># systemctl restart jenkins.service </span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-63.png"></p><p>如果现实 jenkins 已离线，将以下文件中的更新检查地址改成国内清华大学地址，然后重启 jenkins 即可：<a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cat /var/lib/jenkins/hudson.model.UpdateCenter.xml</span><br>&lt;?xml version=<span class="hljs-string">&#x27;1.1&#x27;</span> encoding=<span class="hljs-string">&#x27;UTF-8&#x27;</span>?&gt;<br>&lt;sites&gt;<br>&lt;site&gt;<br>&lt;id&gt;default&lt;/id&gt;<br>&lt;url&gt;https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json&lt;/url&gt;<br>&lt;/site&gt;<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-64.png"></p><p>注意：如重新刷新网页后还是离线状态，可以使用这个方法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#寻找有关Jenkins的defalut.json文件</span><br>root@jenkins-master:~<span class="hljs-comment"># find / -name &quot;default.json&quot;</span><br>/var/lib/jenkins/updates/default.json<br><br><span class="hljs-comment">#先备份后修改文件</span><br>root@jenkins-master:~<span class="hljs-comment"># cd  /var/lib/jenkins/updates/</span><br>root@jenkins-master:/var/lib/jenkins/updates<span class="hljs-comment"># cp default.json default.json.bak</span><br>root@jenkins-master:/var/lib/jenkins/updates<span class="hljs-comment"># sed -i &#x27;s/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g&#x27; /var/lib/jenkins/updates/default.json &amp;&amp; sed -i &#x27;s/http:\/\/www.google.com/https:\/\/www.baidu.com/g&#x27; /var/lib/jenkins/updates/default.json</span><br><br><span class="hljs-comment">#重启Jenkins</span><br>root@jenkins-master:/var/lib/jenkins/updates<span class="hljs-comment"># systemctl restart jenkins.service</span><br></code></pre></td></tr></table></figure><p><strong>刷新浏览器</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another15.png"></p><h5 id="4-1-5-2-通过在jenkins网页里设置安装路径来安装插件"><a href="#4-1-5-2-通过在jenkins网页里设置安装路径来安装插件" class="headerlink" title="4.1.5.2 通过在jenkins网页里设置安装路径来安装插件"></a>4.1.5.2 通过在jenkins网页里设置安装路径来安装插件</h5><ol><li><p>跳过安装插件，直接设置账号密码，最后进入到jenkins界面</p></li><li><p>点击Manager Jenkins（插件管理）</p></li><li><p>点击Manage Plugins</p></li><li><p>点击Available，然后等待网页中插件目录加载完成</p></li><li><p>```bash<br>#回到xshell里<br>root@jenkins-master:~# cd /var/lib/jenkins/updates/<br>root@jenkins-master:/var/lib/jenkins/updates# sed -i ‘s/http://updates.jenkins-ci.org/download/https://mirrors.tuna.tsinghua.edu.cn/jenkins/g’ default.json &amp;&amp; sed -i ‘s/http://<a href="http://www.google.com/https:////www.baidu.com/g&#39;">www.google.com/https:\/\/www.baidu.com/g&#39;</a> default.json</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br><span class="hljs-number">6</span>. Manage Plugins点击Advanced，把Update Site改为国内插件下载地址<br><br><span class="hljs-number">7</span>. 下载中文汉化插件 Jenkins-&gt;Manage Jenkins-&gt;Manage Plugins，点击Available，搜索<span class="hljs-string">&quot;Chinese&quot;</span><br><br>   ![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-another16.png)<br><br>   完成后如下图：<br><br>   ![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-another17.png)<br><br>   重启Jenkins后，就看到Jenkins汉化了！（PS：但可能部分菜单汉化会失败）<br><br>   ![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-another18.png)<br><br><span class="hljs-comment">#### 4.1.6 插件安装过程中</span><br><br>http:<span class="hljs-regexp">//u</span>pdates.jenkins-ci.org<span class="hljs-regexp">/download/</span>plugins/ <span class="hljs-comment">#插件下载地址，在插件安装过程中如果因为某种原因导致有有安装失败的插件，没有关系，可以后期再单独安装。</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">65</span>.png)<br><br><span class="hljs-comment">#### 4.1.7 创建 jenkins 管理员</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">66</span>.png)<br><br><span class="hljs-comment">#### 4.1.8 配置 jenkins URL</span><br><br>（通常不需要更改，直接点击保存并完成即可）<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">67</span>.png)<br><br><span class="hljs-comment">#### 4.1.9 配置完成并登陆 jenkins</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">68</span>.png)<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">69</span>.png)<br><br><span class="hljs-comment">#### 4.1.10 登陆 jenkins 界面</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">70</span>.png)<br><br><span class="hljs-comment">#### 4.1.11 jenkins 插件管理及安装</span><br><br><span class="hljs-comment">##### 4.1.11.1 插件安装目录 ：</span><br><br>插件下载地址： http:<span class="hljs-regexp">//u</span>pdates.jenkins-ci.org<span class="hljs-regexp">/download/</span>plugins/<br><br>安装插件的目录：<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>plugins<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">71</span>.png)<br><br><span class="hljs-comment">##### 4.1.11.2 安装插件</span><br><br>搜索需要 gitlab 的插件并安装：<br>gitlab 和 Blue Ocean<br><br>**在安装插件的过程中可以点击“安装完成后重启Jenkins”**<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">72</span>.png)<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">73</span>.png)<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">74</span>.png)<br><br><span class="hljs-comment">#### 4.1.12 配置 jenkins 权限管理</span><br><br>基于角色的权限管理，先创建角色和用户，给角色授权，然后把用户管理到角色。<br><br><span class="hljs-comment">##### 4.1.12.1安装插件</span><br><br>**Role- - based <span class="hljs-comment"># # 基于角色的 认证**</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">75</span>.png)<br><br><span class="hljs-comment">##### 4.1.12.2 创建新用户</span><br><br>Jenkins—系统管理—管理用户—新建用户：<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">76</span>.png)<br><br><span class="hljs-comment">##### 4.1.12.3 更改认证方式</span><br><br>Jenkins—系统管理—全局安全配置<br>默认创建的用户登录后可以做任何操作，取决于默认的认证授权方式。<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">77</span>.png)<br><br><span class="hljs-comment">##### 4.1.12.4 创建角色</span><br><br>Jenkins—系统管理--Manage and Assign Roles(管理和分配角色)<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">78</span>.png)<br><br><span class="hljs-comment">##### 4.1.12.5 添加角色</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">79</span>.png)<br><br><span class="hljs-comment">##### 4.1.12.6 对角色分配权限</span><br><br>**注意：只分配Read权限**<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">80</span>.png)<br><br><span class="hljs-comment">##### 4.1.12.7 将用户关联到角色</span><br><br>Jenkins—系统管理--Manage and Assign Roles(管理和分配角色)--Assign Role<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">81</span>.png)<br><br><span class="hljs-comment">##### 4.1.12.8 测试普通用户登录</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">82</span>.png)<br><br>登录成功之的界面，没有系统管理权限，只能执行被授权过的job且没有了管理员权限。<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">83</span>.png)<br><br><span class="hljs-comment">##### 4.1.12.9 Jenkins 运行权限问题</span><br><br>默认jenkins服务以jenkins用户运行，这时在jenkins执行maven脚本时可能会发生没有权限操作某个目录下的文件，覆盖文件等情况，就会出现因权限问题而产生的执行错误，同时在编写脚本时也要考虑权限问题。<br><br>解决方法：可以让Jenkins以root用户运行来解决<br><br>```bash<br><span class="hljs-comment">#方法一：</span><br><span class="hljs-number">1</span>.修改<span class="hljs-regexp">/etc/</span>default/jenkins文件中的内容（将用户改成root）<br><span class="hljs-comment">#user id to be invoked as (otherwise will run as root; not wise!)</span><br>JENKINS_USER=root<br>JENKINS_GROUP=root<br><span class="hljs-number">2</span>.重启服务<br><span class="hljs-comment">#方法二：</span><br><span class="hljs-number">1</span>.将jenkins账号分别加入到root组中<br>gpasswd -a jenkins root<br><span class="hljs-number">2</span>.修改<span class="hljs-regexp">/etc/</span>sysconfig/jenkins文件中的内容（将用户改成root）<br><span class="hljs-comment">#user id to be invoked as (otherwise will run as root; not wise!)</span><br>JENKINS_USER=root<br>JENKINS_GROUP=root<br><span class="hljs-number">3</span>.重启服务<br></code></pre></td></tr></table></figure></li></ol><h4 id="4-1-13-jenkins-邮箱配置"><a href="#4-1-13-jenkins-邮箱配置" class="headerlink" title="4.1.13 jenkins 邮箱配置"></a>4.1.13 jenkins 邮箱配置</h4><h5 id="4-1-13-1-使用QQ邮箱进行邮箱配置"><a href="#4-1-13-1-使用QQ邮箱进行邮箱配置" class="headerlink" title="4.1.13.1 使用QQ邮箱进行邮箱配置"></a>4.1.13.1 使用QQ邮箱进行邮箱配置</h5><h5 id="生成-QQ-邮箱登录授权码"><a href="#生成-QQ-邮箱登录授权码" class="headerlink" title="生成 QQ 邮箱登录授权码"></a>生成 QQ 邮箱登录授权码</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-84.png"></p><h5 id="配置-jenkins-管理员邮箱"><a href="#配置-jenkins-管理员邮箱" class="headerlink" title="配置 jenkins 管理员邮箱"></a>配置 jenkins 管理员邮箱</h5><p><strong>Jenkins—系统管理—系统设置：</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-85.png"></p><h5 id="发件配置"><a href="#发件配置" class="headerlink" title="发件配置"></a>发件配置</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-86.png"></p><h5 id="测试发送邮件"><a href="#测试发送邮件" class="headerlink" title="测试发送邮件"></a>测试发送邮件</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-87.png"></p><h5 id="4-1-13-2-使用outlook进行邮箱配置"><a href="#4-1-13-2-使用outlook进行邮箱配置" class="headerlink" title="4.1.13.2 使用outlook进行邮箱配置"></a>4.1.13.2 使用outlook进行邮箱配置</h5><h5 id="配置-jenkins-管理员邮箱-1"><a href="#配置-jenkins-管理员邮箱-1" class="headerlink" title="配置 jenkins 管理员邮箱"></a>配置 jenkins 管理员邮箱</h5><p><strong>Jenkins—系统管理—系统设置：</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another19.png"></p><p><strong>发件配置</strong></p><p><strong><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another20.png"></strong></p><p><strong>测试发送邮件</strong></p><p><strong><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another21.png"></strong></p><h3 id="4-2-基于-ssh-key-拉取代码"><a href="#4-2-基于-ssh-key-拉取代码" class="headerlink" title="4.2 基于 ssh key 拉取代码"></a>4.2 基于 ssh key 拉取代码</h3><h4 id="4-2-1-添加-ssh-key"><a href="#4-2-1-添加-ssh-key" class="headerlink" title="4.2.1 添加 ssh key"></a>4.2.1 添加 ssh key</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-88.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#获取ssh key</span><br>root@jenkins-master:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># ssh-keygen </span><br>Generating public/private rsa key pair.<br>Enter file <span class="hljs-keyword">in</span> <span class="hljs-built_in">which</span> to save the key (/root/.ssh/id_rsa): <br>Enter passphrase (empty <span class="hljs-keyword">for</span> no passphrase): <br>Enter same passphrase again: <br>Your identification has been saved <span class="hljs-keyword">in</span> /root/.ssh/id_rsa.<br>Your public key has been saved <span class="hljs-keyword">in</span> /root/.ssh/id_rsa.pub.<br>The key fingerprint is:<br>SHA256:J/GdA4pUT98eo5zURJa/76oXliREQRZyxDG6zjRFF0Y root@jenkins-master<br>The key<span class="hljs-string">&#x27;s randomart image is:</span><br><span class="hljs-string">+---[RSA 2048]----+</span><br><span class="hljs-string">|        . o=%*Eo |</span><br><span class="hljs-string">|       . o BoO.  |</span><br><span class="hljs-string">|      . . +.+ =. |</span><br><span class="hljs-string">|     . . + B.=.o.|</span><br><span class="hljs-string">|      . S * Bo...|</span><br><span class="hljs-string">|         * . .+. |</span><br><span class="hljs-string">|          o  . ..|</span><br><span class="hljs-string">|              . .|</span><br><span class="hljs-string">|            .o.o.|</span><br><span class="hljs-string">+----[SHA256]-----+</span><br><span class="hljs-string"></span><br><span class="hljs-string">root@jenkins-master:/opt/source# cat /root/.ssh/id_rsa.pub </span><br><span class="hljs-string">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCk3+NqtDgb2/cHOdcu0PXP3k7IvWHkuPsPALwrKMiOgHJFad+sYP/yAhiyUGFnH8O0wCuX6sHiD5Q4TclWC/U96ablYK4VOLaKEr5LMY74pBx1xdyGYEpjA0JFXcAUrC3cM+YqrYjr1bjNZQ+KPVp0Rmu2c29/mm7lQcamM7KyryQrgn1ikWldWlkmxySZQisB4gDBssKvQo5liFg4o2rUnBqKXVwkC45htiRaq4tPiniwdcoR/O5qSxpqtW5lQZz4/zEuAYFt0belf2hKhJ1CwtpkX/+pjPACXnsuf6YodWujIXLxUvC0B9KqTKDV3cfxiM0mgd9BTOwasfHnZ4mX root@jenkins-master</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><h4 id="4-2-2-添加-ssh-key"><a href="#4-2-2-添加-ssh-key" class="headerlink" title="4.2.2 添加 ssh key"></a>4.2.2 添加 ssh key</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-89.png"></p><h4 id="4-2-3-创建-ssh-key"><a href="#4-2-3-创建-ssh-key" class="headerlink" title="4.2.3 创建 ssh key"></a>4.2.3 创建 ssh key</h4><p>ssh key 只用于免认证获取代码</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-90.png"></p><h4 id="4-2-4-测试-ssh-key"><a href="#4-2-4-测试-ssh-key" class="headerlink" title="4.2.4 测试 ssh key"></a>4.2.4 测试 ssh key</h4><p>测试可以不使用用户名密码后直接获取代码</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-91.png"></p><h3 id="4-3-配置-jenkins-到-gitlab-非交互拉取代码"><a href="#4-3-配置-jenkins-到-gitlab-非交互拉取代码" class="headerlink" title="4.3 配置 jenkins 到 gitlab 非交互拉取代码"></a>4.3 配置 jenkins 到 gitlab 非交互拉取代码</h3><h4 id="4-3-1-非交互拉取代码方法一：通过脚本或命令clone代码（仅限克隆代码，后面其他操作还是由shell执行）"><a href="#4-3-1-非交互拉取代码方法一：通过脚本或命令clone代码（仅限克隆代码，后面其他操作还是由shell执行）" class="headerlink" title="4.3.1 非交互拉取代码方法一：通过脚本或命令clone代码（仅限克隆代码，后面其他操作还是由shell执行）"></a>4.3.1 非交互拉取代码方法一：通过脚本或命令clone代码（仅限克隆代码，后面其他操作还是由shell执行）</h4><p><strong>通过shell命令clone代码，scp到各个web服务器，停止tomcat服务，代码替换，启动tomcat服务</strong></p><h5 id="4-3-1-1-Jenkins-项目添加shell构建"><a href="#4-3-1-1-Jenkins-项目添加shell构建" class="headerlink" title="4.3.1.1 Jenkins 项目添加shell构建"></a>4.3.1.1 Jenkins 项目添加shell构建</h5><p><strong>Jenkins-项目-构建触发器-构建-执行shell</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another22.png"></p><h5 id="4-3-1-2-添加需要执行的shell命令"><a href="#4-3-1-2-添加需要执行的shell命令" class="headerlink" title="4.3.1.2 添加需要执行的shell命令"></a>4.3.1.2 添加需要执行的shell命令</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another23.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#shell命令内容</span><br><span class="hljs-built_in">cd</span> /data/git/linux &amp;&amp; rm -rf web1 &amp;&amp; git <span class="hljs-built_in">clone</span> git@10.0.0.101:linux/web1.git<br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br>scp -r /data/git/linux/web1/* www@10.0.0.105:/data/tomcat/tomcat_webapps/myapp/<br>scp -r /data/git/linux/web1/* www@10.0.0.106:/data/tomcat/tomcat_webapps/myapp/<br>scp -r /data/git/linux/web1/* www@10.0.0.107:/data/tomcat/tomcat_webapps/myapp/<br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure><p><strong>添加完成后点击保存</strong></p><p><strong>将Jenkins服务器的公钥复制到web服务器上去</strong>*</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#web服务器需要提前设置密码</span><br>root@web1:~<span class="hljs-comment"># passwd www</span><br>Enter new UNIX password: <br>Retype new UNIX password: <br>passwd: password updated successfully<br><br>root@web2:~<span class="hljs-comment"># passwd www</span><br>Enter new UNIX password: <br>Retype new UNIX password: <br>passwd: password updated successfully<br><br>root@web3:~<span class="hljs-comment"># passwd www</span><br>Enter new UNIX password: <br>Retype new UNIX password: <br>passwd: password updated successfully<br><br>root@jenkins-master:/data/git/linux/web1<span class="hljs-comment"># ssh-copy-id www@10.0.0.105</span><br>/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: <span class="hljs-string">&quot;/root/.ssh/id_rsa.pub&quot;</span><br>/usr/bin/ssh-copy-id: INFO: attempting to <span class="hljs-built_in">log</span> <span class="hljs-keyword">in</span> with the new key(s), to filter out any that are already installed<br>/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="hljs-keyword">if</span> you are prompted now it is to install the new keys<br>www@10.0.0.105<span class="hljs-string">&#x27;s password: </span><br><span class="hljs-string"></span><br><span class="hljs-string">Number of key(s) added: 1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>www@10.0.0.105<span class="hljs-string">&#x27;&quot;</span><br><span class="hljs-string">and check to make sure that only the key(s) you wanted were added.</span><br><span class="hljs-string"></span><br><span class="hljs-string">root@jenkins-master:/data/git/linux/web1# ssh-copy-id www@10.0.0.106</span><br><span class="hljs-string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span><br><span class="hljs-string">The authenticity of host &#x27;</span>10.0.0.106 (10.0.0.106)<span class="hljs-string">&#x27; can&#x27;</span>t be established.<br>ECDSA key fingerprint is SHA256:tLe8oiREqQLendzAnl1I3ydeXtXXSYaWogXpP8pfifI.<br>Are you sure you want to <span class="hljs-built_in">continue</span> connecting (yes/no)? yes<br>/usr/bin/ssh-copy-id: INFO: attempting to <span class="hljs-built_in">log</span> <span class="hljs-keyword">in</span> with the new key(s), to filter out any that are already installed<br>/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="hljs-keyword">if</span> you are prompted now it is to install the new keys<br>www@10.0.0.106<span class="hljs-string">&#x27;s password: </span><br><span class="hljs-string"></span><br><span class="hljs-string">Number of key(s) added: 1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>www@10.0.0.106<span class="hljs-string">&#x27;&quot;</span><br><span class="hljs-string">and check to make sure that only the key(s) you wanted were added.</span><br><span class="hljs-string"></span><br><span class="hljs-string">root@jenkins-master:/data/git/linux/web1# ssh-copy-id www@10.0.0.107</span><br><span class="hljs-string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span><br><span class="hljs-string">The authenticity of host &#x27;</span>10.0.0.107 (10.0.0.107)<span class="hljs-string">&#x27; can&#x27;</span>t be established.<br>ECDSA key fingerprint is SHA256:tLe8oiREqQLendzAnl1I3ydeXtXXSYaWogXpP8pfifI.<br>Are you sure you want to <span class="hljs-built_in">continue</span> connecting (yes/no)? yes<br>/usr/bin/ssh-copy-id: INFO: attempting to <span class="hljs-built_in">log</span> <span class="hljs-keyword">in</span> with the new key(s), to filter out any that are already installed<br>/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="hljs-keyword">if</span> you are prompted now it is to install the new keys<br>www@10.0.0.107<span class="hljs-string">&#x27;s password: </span><br><span class="hljs-string"></span><br><span class="hljs-string">Number of key(s) added: 1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>www@10.0.0.107<span class="hljs-string">&#x27;&quot;</span><br><span class="hljs-string">and check to make sure that only the key(s) you wanted were added.</span><br></code></pre></td></tr></table></figure><h5 id="4-3-1-3-立即构建"><a href="#4-3-1-3-立即构建" class="headerlink" title="4.3.1.3 立即构建"></a>4.3.1.3 立即构建</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another24.png"></p><h5 id="4-3-1-4-使用控制台查看结果"><a href="#4-3-1-4-使用控制台查看结果" class="headerlink" title="4.3.1.4 使用控制台查看结果"></a>4.3.1.4 使用控制台查看结果</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another25.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another26.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another27.png"></p><h5 id="4-3-1-5-通过服务器查看是否开启成功"><a href="#4-3-1-5-通过服务器查看是否开启成功" class="headerlink" title="4.3.1.5 通过服务器查看是否开启成功"></a>4.3.1.5 通过服务器查看是否开启成功</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another28.png"></p><h5 id="4-3-1-6-通过查看网页是否构建成功"><a href="#4-3-1-6-通过查看网页是否构建成功" class="headerlink" title="4.3.1.6 通过查看网页是否构建成功"></a>4.3.1.6 通过查看网页是否构建成功</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another29.png"></p><h4 id="4-3-2-非交互拉取代码方法二：通过Jenkins-clone代码（仅限克隆代码，后面其他操作还是由shell执行）"><a href="#4-3-2-非交互拉取代码方法二：通过Jenkins-clone代码（仅限克隆代码，后面其他操作还是由shell执行）" class="headerlink" title="4.3.2 非交互拉取代码方法二：通过Jenkins clone代码（仅限克隆代码，后面其他操作还是由shell执行）"></a>4.3.2 非交互拉取代码方法二：通过Jenkins clone代码（仅限克隆代码，后面其他操作还是由shell执行）</h4><p><strong>通过Jenkins clone代码，对代码打包，scp到各个web服务器里，停服务，做代码替换，启动服务</strong></p><h4 id="4-3-2-1-jenkins-服务器添加证书"><a href="#4-3-2-1-jenkins-服务器添加证书" class="headerlink" title="4.3.2.1 jenkins 服务器添加证书"></a>4.3.2.1 jenkins 服务器添加证书</h4><p>Jenkins-凭据-jenkins—全局凭据—添加凭据</p><p>或</p><p>Jenkins-系统管理-Manage Credentials-全局-添加凭据</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another106.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another107.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another108.png"></p><p><strong>关于private key</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#需要Jenkins服务器里的私钥</span><br>root@jenkins-master:/data/git/linux/web1<span class="hljs-comment"># cat /root/.ssh/id_rsa</span><br>-----BEGIN RSA PRIVATE KEY-----<br>MIIEowIBAAKCAQEApN/jarQ4G9v3BznXLtD1z95OyL1h5Lj7DwC8KyjIjoByRWnf<br>rGD/8gIYslBhZx/DtMArl+rB4g+UOE3JVgv1Pemm5WCuFTi2ihK+SzGO+KQcdcXc<br>hmBKYwNCRV3AFKwt3DPmKq2I69W4zWUPij1adEZrtnNvf5pu5UHGpjOysq8kK4J9<br>YpFpXVpZJsckmUIrAeIAwbLCr0KOZYhYOKNq1Jwail1cJAuOYbYkWquLT4p4sHXK<br>EfzuaksaarVuZUGc+P8xLgGBbdG3pX9oSoSdQsLaZF//qYzwAl57Ln+mKHVroyFy<br>8VLwtAfSqkyg1d3H8YjNJoHfQUzsGrHx52eJlwIDAQABAoIBAQCX4XdJ0ILvhw5l<br>Ja9IfU40EwJYgb0wSgdcprywtX0raL/bmdBmp2Sft7awbMONkAFk/LIr3CKG8PsF<br>cwLJtXJRenA4VXuIKRpezy1lb13ZRrTA+WhQkVt1IodmBxru8D2+4EBjiEDdn6AB<br>9dr+6c3t1wFarbRExCrsHk+0w2MWni1hwf9u1QogysWcwAJ/DoMd2M4dwtIqTVfz<br>Nqi/Pi3or3jx7HtU28NJc9L6wNipGMtacVasgBBfrs2kzHDhTd2P0GxK9Hv/7xIu<br>AZixJqxmZg/sZgA5NrOSrNJQnRI/mUJfld8C1YDSsXl+a+xIu1lF0eL0po4Jxhk7<br>AB9PWsrBAoGBANqVxaGvsgOBWT2+4q79xT7HCUuKYjt4wwMOtZnTX0PYt1EIlGZk<br>wk+PluGA0qBthjZAvXthiUltkky6+KCw6C451UtTMWyEG2t76jy009Mn5NUuBSVv<br>0zXFJ2K1IybZYEmZfHlOK9TJhmiTw0F2tiLhLvaTkIUDsBHTZ4jDyZuJAoGBAMEY<br>kH+yLNtlFVlRPe8+BptoIlIqvfsoL06L+DHlNh7HhxW53uLHUBA0lmFE27Ohii+H<br>DlkuPl1cHewd+nxD0Kjq5iLeL1MxnakSr4RZfzRUj1N6r0RoaHqCR+IfkdiXaJNA<br>jDv4hJGCYtT/MQriN8zzzuuPw7tLAv/CPSdqXxQfAoGAOsVsVvXbgi/EI+LwJibb<br>Yu63JBV4Jg9pN6g70blQcviRCXuqEwHicOvloIo3l6T7Ihk0GTl3ZUPNw02+Tc5j<br>DxLDs7YRouC+Up8Fsv7XuX2PfHYcMh2oB1wUI+kaI3bs+b0IB8Gp7VOmDPY12KMn<br>g6dSLkAs6ma8b36M5uvliCkCgYBYf/6yWCJRB7pKLn8ZaK80iPy59hcOxrMv590A<br>WVJ9tutF3OO3wqwCUWfe+uVLJi2kbNz5qMUymuan8nF8hMRctxR1RKoiEip1dDf3<br>i+FORbdPBnrP+p5wD8gMbnW09GgcnUfosJVp732Gq9N5bocuq0vaEREfhVjBie/n<br>Ycxj9wKBgA80/IiRHJA37tMcI9SP95VKlMfYnvbtHOFsgYgbNVdUX4mt2LJncaWG<br>TjuiiVJe40XQaPyjRyUSLQjKyfaFlHsAB5WjlFKv4V++vMsKp3JUNgUd0OKrjaVz<br>qn0kXUy5MA7/BsQGnw0lwZRDToRtw47uInNPmrLDR+uXquCZTu65<br>-----END RSA PRIVATE KEY-----<br></code></pre></td></tr></table></figure><h4 id="4-3-2-2-jenkins-创建-project"><a href="#4-3-2-2-jenkins-创建-project" class="headerlink" title="4.3.2.2 jenkins 创建 project"></a>4.3.2.2 jenkins 创建 project</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-92.png"></p><h4 id="4-3-2-3-配置-git-项目地址和用户"><a href="#4-3-2-3-配置-git-项目地址和用户" class="headerlink" title="4.3.2.3 配置 git 项目地址和用户"></a>4.3.2.3 配置 git 项目地址和用户</h4><p>添加完成的证书没有报错表示认证通过</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-93.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another30.png"></p><p>没有Delete workspace before build starts，就安装workspace cleanup插件</p><h4 id="4-3-2-4-测试构建项目"><a href="#4-3-2-4-测试构建项目" class="headerlink" title="4.3.2.4 测试构建项目"></a>4.3.2.4 测试构建项目</h4><p>构建注意：在配置-General-选择丢弃旧的构建</p><p>没有必要留着那么多的构建记录</p><p>七天</p><p>最多五个</p><pre><code>七天内不足五个    最近七天上线不足五次，但是上一周或者以前有历史记录，这些记录加上七天内的超过五次，那么还是显示五次记录    最近七天上线不足五次，但是上一周或者以前有历史记录，这些记录加上七天内的也不足五次，那么就显示实际数量    最近七天没有上线，那就是最多五次记录，有可能是一到五当中任何一个，如果历史记录超过五次，那么就是最近的五次记录</code></pre><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another97.png"></p><h6 id="4-3-4-2-1-点击立即构建"><a href="#4-3-4-2-1-点击立即构建" class="headerlink" title="4.3.4.2.1 点击立即构建"></a>4.3.4.2.1 点击立即构建</h6><p><strong>如果使用旧项目的话，需要把构建里的shell全部注释或删除</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-94.png"></p><h6 id="4-3-4-2-2-验证构建结果"><a href="#4-3-4-2-2-验证构建结果" class="headerlink" title="4.3.4.2.2 验证构建结果"></a>4.3.4.2.2 验证构建结果</h6><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-95.png"></p><h6 id="4-3-4-2-3-服务器验证数据"><a href="#4-3-4-2-3-服务器验证数据" class="headerlink" title="4.3.4.2.3 服务器验证数据"></a>4.3.4.2.3 服务器验证数据</h6><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-96.png"></p><h6 id="4-3-4-2-4-将代码部署至后端服务器"><a href="#4-3-4-2-4-将代码部署至后端服务器" class="headerlink" title="4.3.4.2.4 将代码部署至后端服务器"></a>4.3.4.2.4 将代码部署至后端服务器</h6><p>构建-&gt;执行 shell，脚本内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#进入到Jenkins服务器项目文件夹，并将所有文件打包</span><br><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1 &amp;&amp; tar czvf myapp.tar.gz ./*<br><br><span class="hljs-comment">#打包文件发送到tomcat服务器</span><br>scp myapp.tar.gz www@10.0.0.105:/data/tomcat/tomcat_appdir/<br>scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/<br>scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/<br><br><span class="hljs-comment">#停止tomcat运行</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br><span class="hljs-comment">#删除存放项目目录里的所有文件，进入到存放项目压缩包文件夹，将压缩包解压到项目目录里</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br><br><span class="hljs-comment">#运行tomcat</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure><h3 id="4-4-gitlab分支管理"><a href="#4-4-gitlab分支管理" class="headerlink" title="4.4 gitlab分支管理"></a>4.4 gitlab分支管理</h3><p>账户权限：<a href="https://gitlab.com/xhang/gitlab/-/blob/12-3-stable-zh/doc/user/permissions.md">https://gitlab.com/xhang/gitlab/-/blob/12-3-stable-zh/doc/user/permissions.md</a></p><h4 id="4-4-1-gitlab-新建-develop-分支"><a href="#4-4-1-gitlab-新建-develop-分支" class="headerlink" title="4.4.1 gitlab 新建 develop 分支"></a>4.4.1 gitlab 新建 develop 分支</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-97.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-98.png"></p><h4 id="4-4-2-指定克隆分支下载gtilab文件"><a href="#4-4-2-指定克隆分支下载gtilab文件" class="headerlink" title="4.4.2 指定克隆分支下载gtilab文件"></a>4.4.2 指定克隆分支下载gtilab文件</h4><p>基于develop分支下载gitlab文件</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another31.png"></p><h4 id="4-4-3-上传代码到develop分支"><a href="#4-4-3-上传代码到develop分支" class="headerlink" title="4.4.3 上传代码到develop分支"></a>4.4.3 上传代码到develop分支</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another32.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another33.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another34.png"></p><h3 id="4-5-gitlab代码合并"><a href="#4-5-gitlab代码合并" class="headerlink" title="4.5 gitlab代码合并"></a>4.5 gitlab代码合并</h3><h4 id="4-5-1-开发环境代码部署到测试环境（10-0-0-105当作测试环境）"><a href="#4-5-1-开发环境代码部署到测试环境（10-0-0-105当作测试环境）" class="headerlink" title="4.5.1 开发环境代码部署到测试环境（10.0.0.105当作测试环境）"></a>4.5.1 开发环境代码部署到测试环境（10.0.0.105当作测试环境）</h4><p>进入Jenkins develop项目-配置-源码管理</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another35.png"></p><p>进入Jenkins develop项目-配置-构建</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another36.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-develop &amp;&amp; tar czvf myapp.tar.gz ./*<br><br>scp myapp.tar.gz www@10.0.0.105:/data/tomcat/tomcat_appdir/<br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure><p><strong>注意：保存后，立即构建（注意执行shell里的路径名称）</strong></p><h4 id="4-5-2-开发环境代码部署到生产环境"><a href="#4-5-2-开发环境代码部署到生产环境" class="headerlink" title="4.5.2 开发环境代码部署到生产环境"></a>4.5.2 开发环境代码部署到生产环境</h4><h5 id="4-5-2-1-创建生产环境Jenkins，可以基于开发环境进行复制"><a href="#4-5-2-1-创建生产环境Jenkins，可以基于开发环境进行复制" class="headerlink" title="4.5.2.1 创建生产环境Jenkins，可以基于开发环境进行复制"></a>4.5.2.1 创建生产环境Jenkins，可以基于开发环境进行复制</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another37.png"></p><h5 id="4-5-2-2-修改生产环境的配置"><a href="#4-5-2-2-修改生产环境的配置" class="headerlink" title="4.5.2.2 修改生产环境的配置"></a>4.5.2.2 修改生产环境的配置</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another38.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another39.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-develop &amp;&amp; tar czvf myapp.tar.gz ./*<br><br>scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/<br>scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/<br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure><p>**注意：所有Jenkins目录里构建的shell脚本都可以在 **/var/lib/jenkins/jobs 里的对应项目查看</p><h5 id="4-5-2-3-开发人员合并代码"><a href="#4-5-2-3-开发人员合并代码" class="headerlink" title="4.5.2.3 开发人员合并代码"></a>4.5.2.3 开发人员合并代码</h5><p>gitlab–linux–web1–合并请求–新建合并请求</p><p>Merge Requests-New merge request</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another40.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another41.png"></p><h5 id="4-5-2-4-开发领导会受到代码合并的邮件"><a href="#4-5-2-4-开发领导会受到代码合并的邮件" class="headerlink" title="4.5.2.4 开发领导会受到代码合并的邮件"></a>4.5.2.4 开发领导会受到代码合并的邮件</h5><p>开发领导收到邮件，且开发领导和开发在gitlab网页上也会看到合并的提示</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another42.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another43.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another44.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another45.png"></p><h5 id="4-5-2-5-使用Jenkins部署合并后的代码"><a href="#4-5-2-5-使用Jenkins部署合并后的代码" class="headerlink" title="4.5.2.5 使用Jenkins部署合并后的代码"></a>4.5.2.5 使用Jenkins部署合并后的代码</h5><p>在Jenkins里的开发环境立即构建，部署完成后即可到生产环境验证</p><h5 id="4-5-2-6-公司代码部署流程"><a href="#4-5-2-6-公司代码部署流程" class="headerlink" title="4.5.2.6 公司代码部署流程"></a>4.5.2.6 公司代码部署流程</h5><p><img src=""></p><h3 id="4-6-构建触发器-钩子"><a href="#4-6-构建触发器-钩子" class="headerlink" title="4.6 构建触发器( ( 钩子) )"></a>4.6 构建触发器( ( 钩子) )</h3><p><strong>只使用于测试环境</strong></p><p>构建触发器(webhook)，有的人称为钩子，实际上是一个 HTTP 回调,其用于<strong>在开发人员向 gitlab 提交代码后能够触发 jenkins 自动执行代码构建操作。</strong><br>以下为新建一个开发分支，只有在开发人员向开发(develop)分支提交代码的时候才会触发代码构建，而向主分支提交的代码不会自动构建，需要运维人员手动部署代码到生产环境。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-99.png"></p><h4 id="4-6-1-jenkins-安装插件"><a href="#4-6-1-jenkins-安装插件" class="headerlink" title="4.6.1 jenkins 安装插件"></a>4.6.1 jenkins 安装插件</h4><p><strong>系统管理-管理插件-可选插件-Gitlab Hook 和 Gitlab Authentication</strong><br>注意事项：<br><a href="https://jenkins.io/security/advisory/2018-05-09/#SECURITY-263">https://jenkins.io/security/advisory/2018-05-09/#SECURITY-263</a></p><ul><li>在 jenkins 系统管理–全局安全设置，认证改为登录用户可以做任何事情</li><li>取消跨站请求伪造保护的勾选项</li><li>Gitlab Hook Plugin 以纯文本形式存储和显示 GitLab API 令牌</li></ul><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-100.png"></p><h4 id="4-6-2-jenkins-修改登录认证方式"><a href="#4-6-2-jenkins-修改登录认证方式" class="headerlink" title="4.6.2 jenkins 修改登录认证方式"></a>4.6.2 jenkins 修改登录认证方式</h4><p>系统管理—全局安全设置–保存以上配置</p><p><strong>注意：高版本无法关闭跨站请求伪造保护方法</strong></p><p>参考博客：<a href="https://www.cnblogs.com/panchanggui/p/13557155.html">https://www.cnblogs.com/panchanggui/p/13557155.html</a> （只使用centos）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ubuntu</span><br>root@jenkins-master:~<span class="hljs-comment"># vim /etc/default/jenkins</span><br>1 <span class="hljs-comment"># defaults for Jenkins automation server</span><br>2 <br>3 <span class="hljs-comment"># pulled in from the init script; makes things easier.</span><br>4 NAME=jenkins<br>5 <br>6 <span class="hljs-comment"># arguments to pass to java</span><br>7 <br>8 <span class="hljs-comment"># Allow graphs etc. to work even when an X server is present</span><br>9 <span class="hljs-comment">#JAVA_ARGS=&quot;-Djava.awt.headless=true&quot;</span><br>10 JAVA_ARGS=<span class="hljs-string">&quot;-Djava.awt.headless=true -Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=true&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-101.png"></p><h4 id="4-6-3-jenkins-配置构建触发器"><a href="#4-6-3-jenkins-配置构建触发器" class="headerlink" title="4.6.3 jenkins 配置构建触发器"></a>4.6.3 jenkins 配置构建触发器</h4><p>生产 token 认证</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># openssl rand -hex 12</span><br>aa9ef9c4d39268b6d0756a1c<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-102.png"></p><h4 id="4-6-4-curl-命令测试触发并验证远程触发构建："><a href="#4-6-4-curl-命令测试触发并验证远程触发构建：" class="headerlink" title="4.6.4 curl 命令测试触发并验证远程触发构建："></a>4.6.4 curl 命令测试触发并验证远程触发构建：</h4><ul><li><p>使用浏览器直接访问 URL 地址</p></li><li><p>使用 curl 命令访问 URL</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#使用ping来确认Jenkins服务器是否能连通</span><br>root@web1:~<span class="hljs-comment"># ping 10.0.0.102</span><br>PING 10.0.0.102 (10.0.0.102) 56(84) bytes of data.<br>64 bytes from 10.0.0.102: icmp_seq=1 ttl=64 time=0.210 ms<br>64 bytes from 10.0.0.102: icmp_seq=2 ttl=64 time=0.258 ms<br>^C<br>--- 10.0.0.102 ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1019ms<br>rtt min/avg/max/mdev = 0.210/0.234/0.258/0.024 ms<br>root@jenkins-master:~<span class="hljs-comment"># curl http://10.0.0.102:8080/job/linux-web1-develop/build?token=aa9ef9c4d39268b6d0756a1c</span><br></code></pre></td></tr></table></figure><h4 id="4-6-5-jenkins-验证-develop-是否自动构建"><a href="#4-6-5-jenkins-验证-develop-是否自动构建" class="headerlink" title="4.6.5 jenkins 验证 develop 是否自动构建"></a>4.6.5 jenkins 验证 develop 是否自动构建</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another46.png"></p><h4 id="4-6-6-gitlab-配置-webhook"><a href="#4-6-6-gitlab-配置-webhook" class="headerlink" title="4.6.6 gitlab 配置 webhook"></a>4.6.6 gitlab 配置 webhook</h4><p>管理中心–系统钩子</p><p>Admin area—groups/project—System Hooks</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another47.png"></p><h4 id="4-6-7-测试钩子可用性"><a href="#4-6-7-测试钩子可用性" class="headerlink" title="4.6.7 测试钩子可用性"></a>4.6.7 测试钩子可用性</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another48.png"></p><p>执行结果：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-103.png"></p><p>Jenkins-项目运行结果</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another49.png"></p><h4 id="4-6-8-gitlab-开发分支-develop-测试提交代码"><a href="#4-6-8-gitlab-开发分支-develop-测试提交代码" class="headerlink" title="4.6.8 gitlab 开发分支 develop 测试提交代码"></a>4.6.8 gitlab 开发分支 develop 测试提交代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#往gitlab中develop分支上传代码</span><br>root@jenkins-slave1:~/web1<span class="hljs-comment"># vim index.html </span><br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v1&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v2&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v3&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v4&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v5&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v6&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v7&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v8&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v9&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v10&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v11&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v12&lt;/h1&gt; <span class="hljs-comment">#新添加的一行</span><br><br>root@jenkins-slave1:~/web1<span class="hljs-comment"># git add .</span><br>root@jenkins-slave1:~/web1<span class="hljs-comment"># git commit -m &quot;v12&quot;</span><br>[develop 48eeb9d] v12<br> 1 file changed, 1 insertion(+)<br>root@jenkins-slave1:~/web1<span class="hljs-comment"># git push</span><br>Username <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span>: laosong<br>Password <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://laosong@10.0.0.101&#x27;</span>: <br>3Counting objects: 3, <span class="hljs-keyword">done</span>.<br>Delta compression using up to 4 threads.<br>Compressing objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>Writing objects: 100% (3/3), 298 bytes | 298.00 KiB/s, <span class="hljs-keyword">done</span>.<br>Total 3 (delta 1), reused 0 (delta 0)<br>remote: <br>remote: To create a merge request <span class="hljs-keyword">for</span> develop, visit:<br>remote:   http://10.0.0.101/linux/web1/merge_requests/new?merge_request%5Bsource_branch%5D=develop<br>remote: <br>To http://10.0.0.101/linux/web1.git<br>   518bfd5..48eeb9d  develop -&gt; develop   <br></code></pre></td></tr></table></figure><h4 id="4-6-9-jenkins-验证-develop-自动构建"><a href="#4-6-9-jenkins-验证-develop-自动构建" class="headerlink" title="4.6.9 jenkins 验证 develop 自动构建"></a>4.6.9 jenkins 验证 develop 自动构建</h4><p>Jenkins自动构建</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another50.png"></p><p>测试web服务器网页</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another51.png"></p><p><strong>注意：生产环境还得是用人工请求来进行代码合并和代码部署</strong>*</p><p><strong>注意：Jenkins任务名称出现中文触发器网址就会有问题</strong></p><h3 id="4-7-构建后Jenkins项目关联（一般公司很少用）"><a href="#4-7-构建后Jenkins项目关联（一般公司很少用）" class="headerlink" title="4.7 构建后Jenkins项目关联（一般公司很少用）"></a>4.7 构建后Jenkins项目关联（一般公司很少用）</h3><p>用于多个 job 相互关联，需要串行执行多个 job 的场景，可以通过安装插件 Parameterized Trigger 触发执行其他 project。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-104.png"></p><p>原develop作为打包任务</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another56.png" alt="another56"></p><p>新建停止服务任务</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another52.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another53.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another54.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another55.png"></p><p>新建代码拷贝任务</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another61.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another62.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another63.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another64.png"></p><p>新建启动服务任务</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another57.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another58.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another59.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another60.png"></p><p>将所有的任务串联：</p><p>develop任务里的配置-构建后操作-构建其他工程-要构建的项目（填写停止服务任务）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another65.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another66.png"></p><p>停止服务任务里的配置-构建后操作-构建其他工程-要构建的项目（填写代码拷贝任务）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another67.png"></p><p>代码拷贝任务里的配置-构建后操作-构建其他工程-要构建的项目（填写启动服务任务）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another68.png"></p><h4 id="4-7-1-配置构建后操作"><a href="#4-7-1-配置构建后操作" class="headerlink" title="4.7.1 配置构建后操作"></a>4.7.1 配置构建后操作</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another69.png"></p><h4 id="4-7-2-验证构建后操作"><a href="#4-7-2-验证构建后操作" class="headerlink" title="4.7.2 验证构建后操作"></a>4.7.2 验证构建后操作</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another70.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another71.png"></p><h3 id="4-8-Jenkins视图"><a href="#4-8-Jenkins视图" class="headerlink" title="4.8 Jenkins视图"></a>4.8 Jenkins视图</h3><p>图可用于归档 job 进行分组显示，比如将一个业务的视图放在一个视图显示，安装完成 build pipeline 插件之后将会有一个+号用于创建视图。</p><h4 id="4-8-1-创建列表视图（基本上用这个）"><a href="#4-8-1-创建列表视图（基本上用这个）" class="headerlink" title="4.8.1 创建列表视图（基本上用这个）"></a>4.8.1 创建列表视图（基本上用这个）</h4><h5 id="4-8-1-1-点击“-”号"><a href="#4-8-1-1-点击“-”号" class="headerlink" title="4.8.1.1 点击“+”号"></a>4.8.1.1 点击“+”号</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another72.png"></p><h5 id="4-8-1-2-输入列表名和选择列表视图"><a href="#4-8-1-2-输入列表名和选择列表视图" class="headerlink" title="4.8.1.2 输入列表名和选择列表视图"></a>4.8.1.2 输入列表名和选择列表视图</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another73.png"></p><h5 id="4-8-1-3-任务任务过滤器-任务列表里选择任务"><a href="#4-8-1-3-任务任务过滤器-任务列表里选择任务" class="headerlink" title="4.8.1.3 任务任务过滤器-任务列表里选择任务"></a>4.8.1.3 任务任务过滤器-任务列表里选择任务</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another74.png"></p><h5 id="4-8-1-4-显示的结果"><a href="#4-8-1-4-显示的结果" class="headerlink" title="4.8.1.4 显示的结果"></a>4.8.1.4 显示的结果</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another75.png"></p><h5 id="4-8-1-5-在视图里添加新的任务"><a href="#4-8-1-5-在视图里添加新的任务" class="headerlink" title="4.8.1.5 在视图里添加新的任务"></a>4.8.1.5 在视图里添加新的任务</h5><p>选择列表-编辑视图-任务过滤器-任务列表添加需要的任务</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another76.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another77.png"></p><h4 id="4-8-2-创建-build-pipeline-视图（用的不多）"><a href="#4-8-2-创建-build-pipeline-视图（用的不多）" class="headerlink" title="4.8.2 创建 build pipeline 视图（用的不多）"></a>4.8.2 创建 build pipeline 视图（用的不多）</h4><p>视图可用于归档 job 进行分组显示，比如将一个业务的视图放在一个视图显示，安装完成 build pipeline 插件之后将会有一个+号用于创建视图。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-105.png"></p><h5 id="4-8-2-1-安装-build-pipeline-插件"><a href="#4-8-2-1-安装-build-pipeline-插件" class="headerlink" title="4.8.2.1 安装 build pipeline 插件"></a>4.8.2.1 安装 build pipeline 插件</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-106.png"></p><p>插件安装完成</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-107.png"></p><h5 id="4-8-2-2-创建新的视图"><a href="#4-8-2-2-创建新的视图" class="headerlink" title="4.8.2.2 创建新的视图"></a>4.8.2.2 创建新的视图</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-108.png"></p><h4 id="4-8-3-创建-pipline-视图"><a href="#4-8-3-创建-pipline-视图" class="headerlink" title="4.8.3 创建 pipline 视图"></a>4.8.3 创建 pipline 视图</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-109.png"></p><h5 id="4-8-3-1-定义视图配置信息"><a href="#4-8-3-1-定义视图配置信息" class="headerlink" title="4.8.3.1 定义视图配置信息"></a>4.8.3.1 定义视图配置信息</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-110.png"></p><h5 id="4-8-3-2-web-显示界面"><a href="#4-8-3-2-web-显示界面" class="headerlink" title="4.8.3.2 web 显示界面"></a>4.8.3.2 web 显示界面</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-111.png"></p><h4 id="4-8-4-列表视图"><a href="#4-8-4-列表视图" class="headerlink" title="4.8.4 列表视图"></a>4.8.4 列表视图</h4><p>列表视图使用场景比较多，用于将一个业务的job保存至一个列表视图进行分类管理，即不同业务的 job 放在不同的列表视图中。</p><h5 id="4-8-4-1-定义视图名称"><a href="#4-8-4-1-定义视图名称" class="headerlink" title="4.8.4.1 定义视图名称"></a>4.8.4.1 定义视图名称</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-112.png"></p><h5 id="4-8-4-2-选择任务"><a href="#4-8-4-2-选择任务" class="headerlink" title="4.8.4.2 选择任务"></a>4.8.4.2 选择任务</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-113.png"></p><h5 id="4-8-4-3-最终状态"><a href="#4-8-4-3-最终状态" class="headerlink" title="4.8.4.3 最终状态"></a>4.8.4.3 最终状态</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-114.png"></p><h4 id="4-8-5-我的视图"><a href="#4-8-5-我的视图" class="headerlink" title="4.8.5 我的视图"></a>4.8.5 我的视图</h4><p>我的视图会显示当前账户有权限访问的 job，因此需要提前划分好权限。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-115.png"></p><h5 id="4-8-5-2-最终状态"><a href="#4-8-5-2-最终状态" class="headerlink" title="4.8.5.2 最终状态"></a>4.8.5.2 最终状态</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-116.png"></p><h3 id="4-9-jenkins-分布式"><a href="#4-9-jenkins-分布式" class="headerlink" title="4.9 jenkins 分布式"></a>4.9 jenkins 分布式</h3><p>在众多 Job 的场景下，单台 jenkins master 同时执行代码 clone、编译、打包及构建，其性能可能会出现瓶颈从而会影响代码部署效率，影响 jenkins 官方提供了 jenkins 分布式构建，将众多 job 分散运行到不同的 jenkins slave 节点，大幅提高并行 job 的处理能力。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another78.png" alt="公司分布式图例"></p><p>Jenkins推荐配置：</p><p>小项目：配置2C 4G 60G（可以用数据盘，挂载到/var/lib/jenkins，项目都放在jobs里）</p><p>大项目：4C 8G 60G（可以用数据盘，挂载到/var/lib/jenkins，项目都放在jobs里，配置可用于几百个job）</p><h4 id="4-9-1-配置-slave-节点-java-环境"><a href="#4-9-1-配置-slave-节点-java-环境" class="headerlink" title="4.9.1 配置 slave 节点 java 环境"></a>4.9.1 配置 slave 节点 java 环境</h4><p>Slave 服务器创建工作目录，如果 slave 需要执行编译 job，则也需要配置 java 环境并且安装 git、svn、maven 等与 master 相同的基础运行环境，另外也要创建与 master 相同的数据目录，因为脚本中调用的路径只有相对一 master 的一个路径，此路径在master 与各 node 节点必须保持一致。</p><p>slave1和slave2同时执行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># mkdir -p /var/lib/jenkins #创建数据目录，slace节点目录最好跟master保持一致</span><br><br><span class="hljs-comment">#下载并安装jdk</span><br>root@jenkins-slave1:~<span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment">#下载并解压jdk</span><br>root@jenkins-slave1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># tar xf jdk-8u241-linux-x64.tar.gz</span><br>root@jenkins-slave1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/jdk1.8.0_241/ /usr/local/jdk</span><br><span class="hljs-string">&#x27;/usr/local/jdk&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/jdk1.8.0_241/&#x27;</span><br><br><span class="hljs-comment">#修改环境配置</span><br>root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$JAVA_HOME</span>/jre/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> CLASSPATH=.<span class="hljs-variable">$CLASSPATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/lib:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br>root@jenkins-slave1:~<span class="hljs-comment"># source /etc/profile</span><br><br>root@jenkins-slave1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_241&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_241-b07)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.241-b07, mixed mode)<br></code></pre></td></tr></table></figure><h4 id="4-9-2-添加-slave-节点"><a href="#4-9-2-添加-slave-节点" class="headerlink" title="4.9.2 添加 slave 节点"></a>4.9.2 添加 slave 节点</h4><p>Jenkins—系统管理—节点管理—新建节点</p><p>添加 slave 节点：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another79.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another80.png"></p><p>部分 jenkins slave 信息：</p><p>需要安装SSH Build Agents插件</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-117.png" alt="注意：如没有Launch agent agents via SSH 就安装SSH Build Agents插件"></p><p>或者选择不校验证书：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-118.png"></p><h4 id="4-9-3-添加-slave-认证凭据"><a href="#4-9-3-添加-slave-认证凭据" class="headerlink" title="4.9.3 添加 slave 认证凭据"></a>4.9.3 添加 slave 认证凭据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another81.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-119.png"></p><h4 id="4-9-4-slave-节点最终信息"><a href="#4-9-4-slave-节点最终信息" class="headerlink" title="4.9.4 slave 节点最终信息"></a>4.9.4 slave 节点最终信息</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-120.png"></p><h4 id="4-9-5-jenkins-slave-创建日志"><a href="#4-9-5-jenkins-slave-创建日志" class="headerlink" title="4.9.5 jenkins slave 创建日志"></a>4.9.5 jenkins slave 创建日志</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-121.png"></p><h4 id="4-9-6-添加新的-slave"><a href="#4-9-6-添加新的-slave" class="headerlink" title="4.9.6 添加新的 slave"></a>4.9.6 添加新的 slave</h4><p>Jenkins—系统管理—节点管理—新建节点</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another82.png"></p><p>修改一点信息</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another83.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another84.png"></p><h4 id="4-9-6-如果-slave-没有-java-环境则报错如下"><a href="#4-9-6-如果-slave-没有-java-环境则报错如下" class="headerlink" title="4.9.6 如果 slave 没有 java 环境则报错如下"></a>4.9.6 如果 slave 没有 java 环境则报错如下</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-122.png"></p><p>解决方法：根据日志中，系统会检查哪里由java文件，所以就在哪里创建软连接，最后再启动代理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#这里只选择了其中的一个路径</span><br>root@jenkins-slave1:/usr/bin<span class="hljs-comment"># ln -sv /usr/local/jdk/bin/java /usr/bin/java</span><br><span class="hljs-string">&#x27;/usr/bin/java&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/jdk/bin/java&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="4-9-7-验证-slave-web-状态"><a href="#4-9-7-验证-slave-web-状态" class="headerlink" title="4.9.7 验证 slave web 状态"></a>4.9.7 验证 slave web 状态</h4><p>正常状态：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-123.png"></p><p>时间不同步状态：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-124.png"></p><h3 id="4-10-代码回滚"><a href="#4-10-代码回滚" class="headerlink" title="4.10 代码回滚"></a>4.10 代码回滚</h3><h4 id="4-10-1-创建回滚的任务"><a href="#4-10-1-创建回滚的任务" class="headerlink" title="4.10.1 创建回滚的任务"></a>4.10.1 创建回滚的任务</h4><p>创建任务</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another85.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another86.png"></p><p>修改配置</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another87.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another88.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-master &amp;&amp; rm -rf myapp.tar.gz &amp;&amp; git reset --hard HEAD^ &amp;&amp; tar czvf myapp.tar.gz ./*<br><br>scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/<br>scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/<br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure><h4 id="4-10-2-构建任务"><a href="#4-10-2-构建任务" class="headerlink" title="4.10.2 构建任务"></a>4.10.2 构建任务</h4><h3 id="4-11-pipline"><a href="#4-11-pipline" class="headerlink" title="4.11 pipline"></a>4.11 pipline</h3><p>官方介绍；<a href="https://jenkins.io/2.0/">https://jenkins.io/2.0/</a><br>pipline 是帮助 Jenkins 实现 CI 到 CD 转变的重要角色，是运行在 jenkins 2.X 版本的核心插件，简单来说 Pipline 就是一套运行于 Jenkins 上的工作流框架，将原本独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂发布流程，从而实现单个任务很难实现的复杂流程编排和任务可视化，Pipeline 的实现方式是一套Groovy DSL，任何发布流程都可以表述为一段 Groovy 脚本。</p><h4 id="4-11-1-pipline-语法"><a href="#4-11-1-pipline-语法" class="headerlink" title="4.11.1 pipline 语法"></a>4.11.1 pipline 语法</h4><p>Stage：阶段，一个 pipline 可以划分为若干个 stage，每个 stage 都是一个操作步骤，比如 clone 代码、代码编译、代码测试和代码部署，阶段是一个逻辑分组，可以跨多个 node 执行。<br>Node：节点，每个 node 都是一个 jenkins 节点，可以是 jenkins master 也可以是jenkins agent，node 是执行 step 的具体服务器。<br>Step：步骤，step 是 jenkins pipline 最基本的操作单元，从在服务器创建目录到构建容器镜像，由各类 Jenkins 插件提供实现，一个 stage 中可以有多个 step，例如： sh “make”</p><h4 id="4-11-2-pipline-优势"><a href="#4-11-2-pipline-优势" class="headerlink" title="4.11.2 pipline 优势"></a>4.11.2 pipline 优势</h4><p>可持续性：jenkins 的重启或者中断后不影响已经执行的 Pipline Job<br>支持暂停：pipline 可以选择停止并等待人工输入或批准后再继续执行。<br>可扩展：通过 groovy 的编程更容易的扩展插件。<br>并行执行：通过 groovy 脚本可以实现 step，stage 间的并行执行，和更复杂的相互依赖关系。</p><h4 id="4-11-3-pipline-job-测试"><a href="#4-11-3-pipline-job-测试" class="headerlink" title="4.11.3 pipline job 测试"></a>4.11.3 pipline job 测试</h4><h5 id="4-11-3-1-创建-pipline-job"><a href="#4-11-3-1-创建-pipline-job" class="headerlink" title="4.11.3.1 创建 pipline job"></a>4.11.3.1 创建 pipline job</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another89.png"></p><h5 id="4-11-3-2-测试简单-pipline-job-运行"><a href="#4-11-3-2-测试简单-pipline-job-运行" class="headerlink" title="4.11.3.2 测试简单 pipline job 运行"></a>4.11.3.2 测试简单 pipline job 运行</h5><p>Pipeline 测试命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;clone 代码&quot;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码打包&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码拷贝&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码部署&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure><p>Jenkins Web 界面配置：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-125.png"></p><h5 id="4-11-3-3-执行-pipline-job"><a href="#4-11-3-3-执行-pipline-job" class="headerlink" title="4.11.3.3 执行 pipline job"></a>4.11.3.3 执行 pipline job</h5><p>先安装Stage View插件，才会有阶段视图</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another92.png"></p><h5 id="4-11-3-4-自动生成拉取的代码的-pipline-脚本"><a href="#4-11-3-4-自动生成拉取的代码的-pipline-脚本" class="headerlink" title="4.11.3.4 自动生成拉取的代码的  pipline 脚本"></a>4.11.3.4 自动生成拉取的代码的  pipline 脚本</h5><p>点击流水线语法跳转至生成脚本 URL：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-126.png"></p><p>生成流水线脚本：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another90.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another91.png"></p><h5 id="4-11-3-5-更改-pipline-job"><a href="#4-11-3-5-更改-pipline-job" class="headerlink" title="4.11.3.5  更改 pipline job"></a>4.11.3.5  更改 pipline job</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码打包&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码拷贝&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码部署&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-11-3-6-执行-jenkins-job"><a href="#4-11-3-6-执行-jenkins-job" class="headerlink" title="4.11.3.6 执行 jenkins job"></a>4.11.3.6 执行 jenkins job</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another94.png"></p><h5 id="4-11-3-7-验证-git-clone-日志"><a href="#4-11-3-7-验证-git-clone-日志" class="headerlink" title="4.11.3.7 验证 git clone 日志"></a>4.11.3.7 验证 git clone 日志</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another93.png"></p><h5 id="4-11-3-8-jenkins-服务器验证-clone-代码数据"><a href="#4-11-3-8-jenkins-服务器验证-clone-代码数据" class="headerlink" title="4.11.3.8 jenkins 服务器验证 clone 代码数据"></a>4.11.3.8 jenkins 服务器验证 clone 代码数据</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another95.png"></p><h5 id="4-11-3-9-pipline-代码打包"><a href="#4-11-3-9-pipline-代码打包" class="headerlink" title="4.11.3.9 pipline  代码打包"></a>4.11.3.9 pipline  代码打包</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      sh label: <span class="hljs-string">&#x27;&#x27;</span>, script: <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; rm -rf ./*&#x27;</span><br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; tar czvf myapp.tar.gz ./*&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码拷贝&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      ehco <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码部署&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      ehco <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-11-3-10-pipline-代码拷贝"><a href="#4-11-3-10-pipline-代码拷贝" class="headerlink" title="4.11.3.10 pipline 代码拷贝"></a>4.11.3.10 pipline 代码拷贝</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      sh label: <span class="hljs-string">&#x27;&#x27;</span>, script: <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; rm -rf ./*&#x27;</span><br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; tar czvf myapp.tar.gz ./*&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/&#x27;</span><br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      ehco <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码部署&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      ehco <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-11-3-11-pipline-停止web服务"><a href="#4-11-3-11-pipline-停止web服务" class="headerlink" title="4.11.3.11 pipline 停止web服务"></a>4.11.3.11 pipline 停止web服务</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      sh label: <span class="hljs-string">&#x27;&#x27;</span>, script: <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; rm -rf ./*&#x27;</span><br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; tar czvf myapp.tar.gz ./*&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/&#x27;</span><br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码部署&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-11-3-12-pipline-代码部署"><a href="#4-11-3-12-pipline-代码部署" class="headerlink" title="4.11.3.12 pipline 代码部署"></a>4.11.3.12 pipline 代码部署</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      sh label: <span class="hljs-string">&#x27;&#x27;</span>, script: <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; rm -rf ./*&#x27;</span><br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; tar czvf myapp.tar.gz ./*&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/&#x27;</span><br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>  &#125; <br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-11-3-13-pipline-启动服务"><a href="#4-11-3-13-pipline-启动服务" class="headerlink" title="4.11.3.13 pipline 启动服务"></a>4.11.3.13 pipline 启动服务</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      sh label: <span class="hljs-string">&#x27;&#x27;</span>, script: <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; rm -rf ./*&#x27;</span><br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; tar czvf myapp.tar.gz ./*&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/&#x27;</span><br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>  &#125; <br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;/etc/init.d/tomcat start&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;/etc/init.d/tomcat start&quot;&#x27;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-11-3-14-执行证并验证-pipline-job"><a href="#4-11-3-14-执行证并验证-pipline-job" class="headerlink" title="4.11.3.14 执行证并验证 pipline job"></a>4.11.3.14 执行证并验证 pipline job</h5><p>在 gitlab 提交代码，执行 pipline job 并验证代码是否最终部署到了 web 服务器。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another96.png"></p><h5 id="4-11-3-15-指定-node-节点运行-job"><a href="#4-11-3-15-指定-node-节点运行-job" class="headerlink" title="4.11.3.15 指定 node 节点运行 job"></a>4.11.3.15 指定 node 节点运行 job</h5><p>node 节点需要安装 git 命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#jenkins node1：</span><br><span class="hljs-comment"># apt-get install git -y</span><br><span class="hljs-comment">#jenkins node2：</span><br><span class="hljs-comment"># apt-get install git -y</span><br></code></pre></td></tr></table></figure><p>node 节点需要打通与 web server 免密钥登录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#jenkins slave1：</span><br>root@jenkins-slave1:~<span class="hljs-comment"># ssh-keygen</span><br>root@jenkins-slave1:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.105</span><br>root@jenkins-slave1:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.106</span><br>root@jenkins-slave1:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.107</span><br><br><span class="hljs-comment">#jenkins slave2：</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ssh-keygen</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.105</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.106</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.107</span><br><br><span class="hljs-comment">#jenkins pipeline 代码：</span><br>node(<span class="hljs-string">&quot;jenkins-slave1&quot;</span>)&#123;<br>    stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;rm -rf /var/lib/jenkins/workspace/pipline-test/*&#x27;</span><br>        git branch: <span class="hljs-string">&#x27;develop&#x27;</span>, credentialsId: <span class="hljs-string">&#x27;0e23c215-2853-4bdf-9198-481f28ac0e1b&#x27;</span>,<br>        url: <span class="hljs-string">&#x27;git@192.168.7.101:linux36/web1.git&#x27;</span><br>    &#125;<br>    stage(<span class="hljs-string">&quot;代码构建&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/pipline-test/ &amp;&amp; tar czvf code.tar.gz ./index.html&#x27;</span><br>    &#125;<br>    stage(<span class="hljs-string">&quot;代码复制&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/pipline-test/ &amp;&amp; scp code.tar.gz www@192.168.7.105:/data/tomcat/tomcat_appdir/&#x27;</span><br>        sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/pipline-test/ &amp;&amp; scp code.tar.gz www@192.168.7.105:/data/tomcat/tomcat_appdir/&#x27;</span><br>    &#125;<br>    stage(<span class="hljs-string">&quot;停止 tomcat 服务&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.105 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.106 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>    &#125;<br>    stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.105 &quot;rm -rf /data/tomcat/tomcat_webdir/myapp/* &amp;&amp; cd /data/tomcat/tomcat_appdir &amp;&amp; tar xvf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/&quot;&#x27;</span><br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.106 &quot;rm -rf /data/tomcat/tomcat_webdir/myapp/* &amp;&amp; cd /data/tomcat/tomcat_appdir &amp;&amp; tar xvf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/&quot;&#x27;</span><br>    &#125;<br>    stage(<span class="hljs-string">&quot;启动 tomcat 服务&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.105 &quot;/etc/init.d/tomcat start&quot;&#x27;</span><br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.106 &quot;/etc/init.d/tomcat start&quot;&#x27;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-11-3-16-验证-slave-执行构建"><a href="#4-11-3-16-验证-slave-执行构建" class="headerlink" title="4.11.3.16 验证 slave 执行构建"></a>4.11.3.16 验证 slave 执行构建</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-127.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-128.png"></p><h5 id="4-11-3-17-验证-web-服务器代码版本"><a href="#4-11-3-17-验证-web-服务器代码版本" class="headerlink" title="4.11.3.17 验证 web 服务器代码版本"></a>4.11.3.17 验证 web 服务器代码版本</h5><p>Gitlab 重新提交代码并测试代码部署</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-129.png"></p><h2 id="五、代码质量测试"><a href="#五、代码质量测试" class="headerlink" title="五、代码质量测试"></a>五、代码质量测试</h2><p>官方网站：<a href="http://www.sonarqube.org/">http://www.sonarqube.org/</a><br>SonarQube 是一个用于代码质量管理的开放平台，通过插件机制，SonarQube 可以集成不同的测试工具，代码分析工具，以及持续集成工具，例如 Hudson/Jenkins 等。<br>下载地址：<a href="https://www.sonarqube.org/downloads/">https://www.sonarqube.org/downloads/</a></p><p>七个维度检测代码质量</p><ul><li>复杂度分布：代码复杂度过高将难以理解</li><li>重复代码：程序中包含大量复制、粘贴的代码而导致代码臃肿，sonar 可以展示源码中重复严重的地方</li><li>单元测试统计：统计并展示单元测试覆盖率，开发或测试可以清楚测试代码的覆盖情况</li><li>代码规则检查：检查代码是否符合规范</li><li>注释率：若代码注释过少，特别是人员变动后，其他人接手比较难接手；若过多，又不利于阅读潜在的 Bug：检测潜在的 bug</li><li>结构与设计：找出循环，展示包与包、类与类之间的依赖、检查程序之间耦合度</li></ul><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-130.png"></p><h3 id="5-1-代码测试具-工具-SonarQube-简介"><a href="#5-1-代码测试具-工具-SonarQube-简介" class="headerlink" title="5.1 代码测试具 工具 SonarQube 简介"></a>5.1 代码测试具 工具 SonarQube 简介</h3><p>7.9.x 版本不再支持 MySQL<br><a href="https://docs.sonarqube.org/latest/setup/upgrade-notes/">https://docs.sonarqube.org/latest/setup/upgrade-notes/</a><br><strong>MySQL No Longer Supported</strong><br>SonarQube no longer supports MySQL. To migrate from MySQL to a supported database, see the free MySQL Migrator tool.</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-131.png"></p><p>下载官方安装文件：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-132.png"></p><h3 id="5-2-基础环境依赖"><a href="#5-2-基础环境依赖" class="headerlink" title="5.2 基础环境依赖"></a>5.2 基础环境依赖</h3><h4 id="5-2-1-数据库环境依赖："><a href="#5-2-1-数据库环境依赖：" class="headerlink" title="5.2.1 数据库环境依赖："></a>5.2.1 数据库环境依赖：</h4><p><a href="https://docs.sonarqube.org/6.7/Requirements.html">https://docs.sonarqube.org/6.7/Requirements.html</a><br>SonarQube 6.7.X LTS 版本要求数据库要使用 MySQ 5.6 及以上版本，不支持 5.5 及更早的版本， 7.9.X LTS 版本不再使用 MySQL 。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-133.png"></p><h4 id="5-2-2-java-环境依赖"><a href="#5-2-2-java-环境依赖" class="headerlink" title="5.2.2 java 环境依赖"></a>5.2.2 java 环境依赖</h4><p>6.7.X 需要使用 Oracle JRE8</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-134.png"></p><p>7.9.X 需要使用</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-135.png"></p><h4 id="5-2-3-系统及内核参数"><a href="#5-2-3-系统及内核参数" class="headerlink" title="5.2.3 系统及内核参数"></a>5.2.3 系统及内核参数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># useradd -s /bin/bash -m sonarqube #使用普通账户启动 sonarqube</span><br>root@sonarqube:~<span class="hljs-comment"># vim /etc/sysctl.conf</span><br>vm.max_map_count=262144<br>fs.file-max=65536<br>root@sonarqube:~<span class="hljs-comment"># sysctl -p</span><br><br>root@sonarqube:~<span class="hljs-comment"># vim /etc/security/limits.conf</span><br>sonarqube - nofile 65536<br>sonarqube - nproc 65536<br><br><span class="hljs-comment">#重新登录或重启生效limits.conf</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-136.png"></p><h4 id="5-2-4-硬件依赖"><a href="#5-2-4-硬件依赖" class="headerlink" title="5.2.4 硬件依赖"></a>5.2.4 硬件依赖</h4><p>CPU/内存/磁盘</p><h3 id="5-3-部署-SonarQube"><a href="#5-3-部署-SonarQube" class="headerlink" title="5.3 部署 SonarQube"></a>5.3 部署 SonarQube</h3><h4 id="5-3-1-MySQL-数据库及-SonarQube-6-7-X-部署"><a href="#5-3-1-MySQL-数据库及-SonarQube-6-7-X-部署" class="headerlink" title="5.3.1 MySQL 数据库及 SonarQube 6.7.X 部署"></a>5.3.1 MySQL 数据库及 SonarQube 6.7.X 部署</h4><h5 id="5-3-1-1-装安装-MySQL"><a href="#5-3-1-1-装安装-MySQL" class="headerlink" title="5.3.1.1 装安装 MySQL"></a>5.3.1.1 装安装 MySQL</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># apt-get install mysql-server mysql-client</span><br>root@sonarqube:~<span class="hljs-comment"># vim /etc/mysql/mysql.conf.d/mysqld.cnf #配置文件路径</span><br>root@sonarqube:~<span class="hljs-comment"># mysql</span><br>Welcome to the MySQL monitor. Commands end with ; or \g.<br>Your MySQL connection id is 3<br>Server version: 5.7.26-0ubuntu0.18.04.1 (Ubuntu)<br>Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.<br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><span class="hljs-comment">#创建数据库默认编码 utf-8 并授权</span><br>mysql&gt; create database sonar default character <span class="hljs-built_in">set</span> utf8 collate utf8_general_ci;<br>Query OK, 1 row affected (0.00 sec)<br>mysql&gt; GRANT ALL PRIVILEGES ON sonar.* TO <span class="hljs-string">&#x27;sonar&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED BY<br><span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected, 1 warning (0.00 sec)<br></code></pre></td></tr></table></figure><h5 id="5-3-1-2-测试-sonar-账户连接-mysql"><a href="#5-3-1-2-测试-sonar-账户连接-mysql" class="headerlink" title="5.3.1.2 测试 sonar 账户连接 mysql"></a>5.3.1.2 测试 sonar 账户连接 mysql</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># mysql -usonar -p123456</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor. Commands end with ; or \g.<br>Your MySQL connection id is 6<br>Server version: 5.7.26-0ubuntu0.18.04.1 (Ubuntu)<br>Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.<br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; show databases;<br>+--------------------+<br>| Database |<br>+--------------------+<br>| information_schema |<br>| sonar |<br>+--------------------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h5 id="5-3-1-3-解压-sonarqube-并配置文件"><a href="#5-3-1-3-解压-sonarqube-并配置文件" class="headerlink" title="5.3.1.3 解压 sonarqube 并配置文件"></a>5.3.1.3 解压 sonarqube 并配置文件</h5><p>sonar 依赖于 java 环境，而且 java 版本必须是 1.8 版本或更高，否则 sonar 启动失败6.7.X 版本的 sonar 需要调用 elasticsearch ，而且默认需要使用普通用户启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># cd /usr/local/src/</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># unzip sonarqube-6.7.7.zip</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/sonarqube-6.7.7 /usr/local/sonarqube</span><br><span class="hljs-string">&#x27;/usr/local/sonarqube&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/sonarqube-6.7.7&#x27;</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># chown sonarqube.sonarqube /usr/local/src/sonarqube-6.7.7</span><br>/usr/<span class="hljs-built_in">local</span>/sonarqube -R <span class="hljs-comment">#更改目录权限属主和属组为 sonarqube</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># cd /usr/local/sonarqube</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube<span class="hljs-comment"># ll #验证权限属主和属组都为 sonarqube</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube<span class="hljs-comment"># su – sonarqube # 切换为 sonarqube 账户</span><br>sonarqube@sonarqube:~$ <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/sonarqube<br>sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ vim conf/sonar.properties<br>sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ grep <span class="hljs-string">&quot;^[a-Z]&quot;</span> conf/sonar.properties<br>sonar.jdbc.username=sonar<br>sonar.jdbc.password=123456<br>sonar.jdbc.url=jdbc:mysql://127.0.0.1:3306/sonar?useUnicode=<span class="hljs-literal">true</span>&amp;characterEncoding =utf8&amp;rewriteBatchedStatements=<span class="hljs-literal">true</span>&amp;useConfigs=maxPerformance&amp;useSSL=<span class="hljs-literal">false</span><br>sonar.web.host=0.0.0.0<br>sonar.web.port=9000<br></code></pre></td></tr></table></figure><h5 id="5-3-14-启动-sonarqube"><a href="#5-3-14-启动-sonarqube" class="headerlink" title="5.3.14 启动 sonarqube"></a>5.3.14 启动 sonarqube</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ ./bin/linux-x86-64/sonar.sh start<br>Starting SonarQube...<br>Started SonarQube.<br>tail -f <span class="hljs-built_in">log</span>/*.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><p>验证日志：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-137.png"></p><h5 id="5-3-1-5-登录到-到-web-界面-："><a href="#5-3-1-5-登录到-到-web-界面-：" class="headerlink" title="5.3.1.5 登录到 到 web 界面 ："></a>5.3.1.5 登录到 到 web 界面 ：</h5><p>点击有上角 login 登录，默认用户名密码都是 admin</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-138.png"></p><h5 id="5-3-1-6-安装中文支持"><a href="#5-3-1-6-安装中文支持" class="headerlink" title="5.3.1.6 安装中文支持"></a>5.3.1.6 安装中文支持</h5><h6 id="5-3-1-6-1-查看本地已安装"><a href="#5-3-1-6-1-查看本地已安装" class="headerlink" title="5.3.1.6.1 查看本地已安装"></a>5.3.1.6.1 查看本地已安装</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#插件本地路径安装中文插件：</span><br>sonarqube@sonarqube:~$ ll /usr/<span class="hljs-built_in">local</span>/sonarqube/extensions/plugins/<br>total 40476<br>drwxr-xr-x 2 sonarqube sonarqube 4096 Jul 22 18:06 ./<br>drwxr-xr-x 5 sonarqube sonarqube 4096 Jul 22 18:07 ../<br>-rw-r--r-- 1 sonarqube sonarqube 92 Apr 16 15:39 README.txt<br>-rw-r--r-- 1 sonarqube sonarqube 2703958 Apr 15 18:38 sonar-csharp-plugin-6.5.0.3766.jar<br>-rw-r--r-- 1 sonarqube sonarqube 1618672 Apr 15 18:38 sonar-flex-plugin-2.3.jar<br>-rw-r--r-- 1 sonarqube sonarqube 6759535 Apr 15 18:38 sonar-java-plugin-4.15.0.12310.jar<br>-rw-r--r-- 1 sonarqube sonarqube 3355702 Apr 15 18:38 sonar-javascript-plugin-<br>3.2.0.5506.jar<br>-rw-r--r-- 1 sonarqube sonarqube 3022870 Apr 15 18:38 sonar-php-plugin-2.11.0.2485.jar<br>-rw-r--r-- 1 sonarqube sonarqube 4024311 Apr 15 18:38 sonar-python-plugin-1.8.0.1496.jar<br>-rw-r--r-- 1 sonarqube sonarqube 3625962 Apr 15 18:38 sonar-scm-git-plugin-1.3.0.869.jar<br>-rw-r--r-- 1 sonarqube sonarqube 6680471 Apr 15 18:38 sonar-scm-svn-plugin-1.6.0.860.jar<br>-rw-r--r-- 1 sonarqube sonarqube 2250667 Apr 15 18:38 sonar-typescript-plugin-<br>1.1.0.1079.jar<br>-rw-r--r-- 1 sonarqube sonarqube 7368250 Apr 15 18:38 sonar-xml-plugin-1.4.3.1027.jar<br></code></pre></td></tr></table></figure><h6 id="5-6-1-3-2-安装中文语言插件"><a href="#5-6-1-3-2-安装中文语言插件" class="headerlink" title="5.6.1.3.2 安装中文语言插件"></a>5.6.1.3.2 安装中文语言插件</h6><p>administration- Marketplace，在后面的搜索框搜索插件 chinese，然后点 install 安装，或在插件目录 /usr/local/sonarqube/extensions/plugins/ 执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://github.com/SonarQubeCommunity/sonar-l10n-zh/releases/download/sonar-l10n-zh-plugin-1.11/sonar-l10n-zh-plugin-1.11.jar<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-139.png"></p><h6 id="5-6-1-3-3-重启-sonarquebe"><a href="#5-6-1-3-3-重启-sonarquebe" class="headerlink" title="5.6.1.3.3 重启 sonarquebe"></a>5.6.1.3.3 重启 sonarquebe</h6><p>Web 界面安装完成插件后或者在插件目录下载插件后需要重启 sonarquebe 服务生效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">sonarqube@sonarqube:~$ /usr/<span class="hljs-built_in">local</span>/sonarqube/bin/linux-x86-64/sonar.sh restart<br>Stopping SonarQube...<br>Waiting <span class="hljs-keyword">for</span> SonarQube to <span class="hljs-built_in">exit</span>...<br>Stopped SonarQube.<br>Starting SonarQube...<br>Started SonarQube.<br></code></pre></td></tr></table></figure><p>或者在 web 界面重启：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-140.png"></p><h5 id="5-3-1-7-安装其他插件"><a href="#5-3-1-7-安装其他插件" class="headerlink" title="5.3.1.7 安装其他插件"></a>5.3.1.7 安装其他插件</h5><p>Sonarquebe 对代码的扫描都基于插件实现，因此要安装要扫描的开发语言插件：<br>Php<br>Java<br>Python<br>内存不足的截图：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-141.png"></p><h4 id="5-3-2-PostgreSQL-及-SonarQube-7-9-X-部署"><a href="#5-3-2-PostgreSQL-及-SonarQube-7-9-X-部署" class="headerlink" title="5.3.2 PostgreSQL 及 SonarQube 7.9.X 部署"></a>5.3.2 PostgreSQL 及 SonarQube 7.9.X 部署</h4><h5 id="5-3-2-1-安装-JDK-11"><a href="#5-3-2-1-安装-JDK-11" class="headerlink" title="5.3.2.1 安装 JDK 11"></a>5.3.2.1 安装 JDK 11</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube-server:~<span class="hljs-comment"># apt-cache madison openjdk-11-jdk #也可以使用oracle的jdk</span><br>openjdk-11-jdk | 11.0.6+10-1ubuntu1~18.04.1 | http://mirrors.aliyun.com/ubuntu bionic-security/main amd64 Packages<br>openjdk-11-jdk | 11.0.6+10-1ubuntu1~18.04.1 | http://mirrors.aliyun.com/ubuntu bionic-updates/main amd64 Packages<br>openjdk-11-jdk | 10.0.1+10-3ubuntu1 | http://mirrors.aliyun.com/ubuntu bionic/main amd64 Packages<br>openjdk-lts | 10.0.1+10-3ubuntu1 | http://mirrors.aliyun.com/ubuntu bionic/main Sources<br>openjdk-lts | 11.0.6+10-1ubuntu1~18.04.1 | http://mirrors.aliyun.com/ubuntu bionic-security/main Sources<br>openjdk-lts | 11.0.6+10-1ubuntu1~18.04.1 | http://mirrors.aliyun.com/ubuntu bionic-updates/main Sources<br>root@sonarqube-server:~<span class="hljs-comment"># apt install -y openjdk-11-jdk</span><br>root@sonarqube-server:~<span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;11.0.6&quot;</span> 2020-01-14<br>OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)<br>OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode,sharing)<br></code></pre></td></tr></table></figure><h5 id="5-3-2-1-部署-PostgreSQL-服务器"><a href="#5-3-2-1-部署-PostgreSQL-服务器" class="headerlink" title="5.3.2.1 部署 PostgreSQL 服务器"></a>5.3.2.1 部署 PostgreSQL 服务器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube-server:~<span class="hljs-comment"># apt-cache madison postgresql #需要和官方说的版本一致</span><br>postgresql | 10+190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic security/main amd64 Packages<br>postgresql | 10+190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic security/main i386 Packages<br>postgresql | 10+190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic updates/main amd64 Packages<br>postgresql | 10+190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic updates/main i386 Packages<br>postgresql | 10+190 | http://mirrors.aliyun.com/ubuntu bionic/main amd64 Packages<br>postgresql | 10+190 | http://mirrors.aliyun.com/ubuntu bionic/main i386 Packages<br>postgresql-common | 190 | http://mirrors.aliyun.com/ubuntu bionic/main Sources<br>postgresql-common | 190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic security/main Sources<br>postgresql-common | 190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic updates/main Sources<br><br>root@sonarqube-server:~<span class="hljs-comment"># apt install postgresql -y</span><br></code></pre></td></tr></table></figure><h5 id="5-3-2-2-配置-postgrepsql"><a href="#5-3-2-2-配置-postgrepsql" class="headerlink" title="5.3.2.2 配置 postgrepsql"></a>5.3.2.2 配置 postgrepsql</h5><p>切换到 postgres 操作，PostgresSQL 安装后会自动创建 postgres 用户且没有密码。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube-server:~<span class="hljs-comment"># su - postgres</span><br>postgres@sonarqube-server:~$<br><br><span class="hljs-comment">#登录 postgresql 数据库：</span><br>postgres@sonarqube-server:~$ psql -U postgres<br>psql (10.12 (Ubuntu 10.12-0ubuntu0.18.04.1))<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>.<br><br><span class="hljs-comment">#创建数据库并进行授权普通用户访问：</span><br>postgres=<span class="hljs-comment"># CREATE DATABASE sonar; #创建数据库</span><br>CREATE DATABASE<br><br>postgres=<span class="hljs-comment"># CREATE USER sonar WITH ENCRYPTED PASSWORD &#x27;123456&#x27;; #创建用户</span><br>CREATE ROLE<br><br>postgres=<span class="hljs-comment"># GRANT ALL PRIVILEGES ON DATABASE sonar TO sonar; #授权用户</span><br>GRANT<br><br>postgres=<span class="hljs-comment"># ALTER DATABASE sonar OWNER TO sonar; #执行变更</span><br>ALTER DATABASE<br><br>postgres=<span class="hljs-comment"># \q</span><br><br>postgres@sonarqube-server:~$ <span class="hljs-built_in">exit</span><br><span class="hljs-built_in">logout</span><br><br><span class="hljs-comment">#修改监听地址</span><br>root@sonarqube-server:~<span class="hljs-comment"># vim /etc/postgresql/10/main/postgresql.conf</span><br>59 listen_addresses = <span class="hljs-string">&#x27;*&#x27;</span><br><br><span class="hljs-comment">#开启远程访问</span><br>root@sonarqube-server:~<span class="hljs-comment"># vim /etc/postgresql/10/main/pg_hba.conf</span><br>85:<span class="hljs-built_in">local</span> all postgres peer<br>90:<span class="hljs-built_in">local</span> all all peer<br>92:host all all 0.0.0.0/0 md5<br>94:host all all ::1/128 md5<br>97:<span class="hljs-built_in">local</span> replication all peer<br>98:host replication all 127.0.0.1/32 md5<br>99:host replication all ::1/128 md5<br><br>root@sonarqube-server:~<span class="hljs-comment"># systemctl restart postgresql</span><br>root@sonarqube:~<span class="hljs-comment"># systemctl enable postgresql</span><br>Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.<br>Executing: /lib/systemd/systemd-sysv-install <span class="hljs-built_in">enable</span> postgresql<br><br><br>root@sonarqube:~<span class="hljs-comment"># ss -tnl #port=5432</span><br>State           Recv-Q           Send-Q                      Local Address:Port                       Peer Address:Port           <br>LISTEN          0                128                               0.0.0.0:111                             0.0.0.0:*              <br>LISTEN          0                128                         127.0.0.53%lo:53                              0.0.0.0:*              <br>LISTEN          0                128                               0.0.0.0:22                              0.0.0.0:*              <br>LISTEN          0                224                               0.0.0.0:5432                            0.0.0.0:*              <br>LISTEN          0                64                                0.0.0.0:29276                           0.0.0.0:*              <br>LISTEN          0                128                               0.0.0.0:12988                           0.0.0.0:*              <br>LISTEN          0                64                                0.0.0.0:2049                            0.0.0.0:*              <br>LISTEN          0                128                               0.0.0.0:61154                           0.0.0.0:*              <br>LISTEN          0                128                               0.0.0.0:21130                           0.0.0.0:*              <br>LISTEN          0                64                                   [::]:19310                              [::]:*              <br>LISTEN          0                128                                  [::]:111                                [::]:*              <br>LISTEN          0                128                                  [::]:22                                 [::]:*              <br>LISTEN          0                224                                  [::]:5432                               [::]:* <span class="hljs-comment">#postgresql已经启动</span><br><br>LISTEN          0                64                                   [::]:2049                               [::]:*              <br>LISTEN          0                128                                  [::]:27140                              [::]:*              <br>LISTEN          0                128                                  [::]:34790                              [::]:*              <br>LISTEN          0                128                                  [::]:37770                              [::]:* <br></code></pre></td></tr></table></figure><h5 id="5-3-2-2-部署-7-9-X-SonarQube"><a href="#5-3-2-2-部署-7-9-X-SonarQube" class="headerlink" title="5.3.2.2 部署 7.9.X SonarQube"></a>5.3.2.2 部署 7.9.X SonarQube</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># cd /usr/local/src/</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/src<br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># unzip sonarqube-7.9.2.zip</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/sonarqube-7.9.2 /usr/local/sonarqube </span><br><span class="hljs-string">&#x27;/usr/local/sonarqube&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/sonarqube-7.9.2&#x27;</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># useradd -r -m -s /bin/bash sonarqube</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># chown sonarqube.sonarqube /usr/local/sonarqube /usr/local/src/sonarqube-7.9.2 -R</span><br><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># su - sonarqube</span><br>sonarqube@sonarqube:~$ <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/sonarqube<br>sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ vim conf/sonar.properties<br>16 sonar.jdbc.username=sonar<br>17 sonar.jdbc.password=123456<br><span class="hljs-comment">#sonar.jdbc.url=jdbc:postgresql://172.31.0.106/sonarqube?currentSchema=my_schema</span><br>34 sonar.jdbc.url=jdbc:postgresql://10.0.0.108/sonar<br><br><br>sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ ./bin/linux-x86-64/sonar.sh --<span class="hljs-built_in">help</span><br>Usage: ./bin/linux-x86-64/sonar.sh &#123; console | start | stop | force-stop | restart | status | dump &#125;<br><br>sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ ./bin/linux-x86-64/sonar.sh start<br>Starting SonarQube...<br>Started SonarQube.<br>tail -f /usr/<span class="hljs-built_in">local</span>/sonarqube/logs/*.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-142.png"></p><h5 id="5-3-2-3-验证-SonarQube"><a href="#5-3-2-3-验证-SonarQube" class="headerlink" title="5.3.2.3 验证 SonarQube"></a>5.3.2.3 验证 SonarQube</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-143.png"></p><h5 id="5-3-2-4-访问-SonarQube-web-界面"><a href="#5-3-2-4-访问-SonarQube-web-界面" class="headerlink" title="5.3.2.4 访问 SonarQube web 界面"></a>5.3.2.4 访问 SonarQube web 界面</h5><p>浏览器访问：IP:9000</p><p>登录账户名和密码默认都是 admin</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-144.png"></p><h5 id="5-3-2-5-安装中文插件"><a href="#5-3-2-5-安装中文插件" class="headerlink" title="5.3.2.5 安装中文插件"></a>5.3.2.5 安装中文插件</h5><p>插件安装位置：/usr/local/sonarqube/xtensions/plugins/</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-145.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another98.png" alt="another98"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another99.png"></p><p>刷新网页，并重新登录</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-146.png"></p><h5 id="5-3-2-6-server脚本"><a href="#5-3-2-6-server脚本" class="headerlink" title="5.3.2.6 server脚本"></a>5.3.2.6 server脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># vim /etc/systemd/system/sonarqube.service</span><br>[Unit]<br>Description=SonarQube service<br>After=syslog.target network.target<br><br>[Service]<br>Type=simple<br>User=sonarqube<br>Group=sonarqube<br>PermissionsStartOnly=<span class="hljs-literal">true</span><br><span class="hljs-comment">#注意nohup，java 和sonar.jar的路径。最大内存和最小内存根据需要修改</span><br>ExecStart=/usr/bin/nohup /usr/bin/java -Xms2048m -Xmx2048m -Djava.net.preferIPv4Stack=<span class="hljs-literal">true</span> -jar /usr/<span class="hljs-built_in">local</span>/sonarqube/lib/sonar-application-7.9.2.jar<br>StandardOutput=syslog<br>LimitNOFILE=65536<br>LimitNPROC=8192<br>TimeoutStartSec=5<br>Restart=always<br><br>[Install]<br>WantedBy=multi-user.target<br><br>root@sonarqube:~<span class="hljs-comment"># systemctl daemon-reload</span><br>root@sonarqube:~<span class="hljs-comment"># systemctl start sonarqube</span><br>root@sonarqube:~<span class="hljs-comment"># systemctl status sonarqube</span><br>root@sonarqube:~<span class="hljs-comment"># systemctl enable sonarqube</span><br><span class="hljs-comment">#最后查看9000端口和网页即可</span><br></code></pre></td></tr></table></figure><h3 id="5-4-jenkins-服务器部署扫描器-sonar-scanner"><a href="#5-4-jenkins-服务器部署扫描器-sonar-scanner" class="headerlink" title="5.4 jenkins 服务器部署扫描器 sonar-scanner"></a>5.4 jenkins 服务器部署扫描器 sonar-scanner</h3><p>下载地址：<a href="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/">https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/</a><br>官方文档：<a href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/">https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/</a></p><p>生产环境流使用sonar-scanner流程图</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another148.png" alt="使用sonar-scanner流程图"></p><h4 id="5-4-1-部署-sonar-scanner"><a href="#5-4-1-部署-sonar-scanner" class="headerlink" title="5.4.1 部署 sonar-scanner"></a>5.4.1 部署 sonar-scanner</h4><p>sonarqube 通过调用扫描器 sonar-scanner 进行代码质量分析，即扫描器的具体工作就是扫描代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cd /usr/local/src/</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># unzip sonar-scanner-cli-4.3.0.2102-linux.zip</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/sonar-scanner-4.3.0.2102-linux /usr/local/sonar-scanner</span><br><span class="hljs-string">&#x27;/usr/local/sonar-scanner&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/sonar-scanner-4.3.0.2102-linux&#x27;</span><br><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># cd /usr/local/sonar-scanner</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/sonar-scanner<span class="hljs-comment"># ll</span><br>total 24<br>drwxr-xr-x 6 root root 4096 Feb 20  2020 ./<br>drwxr-xr-x 4 root root 4096 May  2 06:18 ../<br>drwxr-xr-x 2 root root 4096 Feb 20  2020 bin/<br>drwxr-xr-x 2 root root 4096 Feb 20  2020 conf/<br>drwxr-xr-x 6 root root 4096 Feb 20  2020 jre/<br>drwxr-xr-x 2 root root 4096 Feb 20  2020 lib/<br><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/sonar-scanner<span class="hljs-comment"># vim conf/sonar-scanner.properties</span><br><span class="hljs-comment">#----- Default SonarQube server</span><br>sonar.host.url=http://10.0.0.108:9000<br><span class="hljs-comment">#----- Default source code encoding</span><br>sonar.sourceEncoding=UTF-8<br></code></pre></td></tr></table></figure><h4 id="5-4-2-准备测试代码"><a href="#5-4-2-准备测试代码" class="headerlink" title="5.4.2 准备测试代码"></a>5.4.2 准备测试代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#解压测试代码</span><br><span class="hljs-comment"># unzip sonar-examples-master.zip</span><br><span class="hljs-comment"># cd sonar-examples-master/</span><br><br><span class="hljs-comment">#以php语言为作为测试代码</span><br><span class="hljs-comment"># cd projects/languages/php/php-sonar-runner</span><br><span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/php/php-sonar-runner<br><span class="hljs-comment"># ll</span><br>total 24<br>drwxr-xr-x 3 root root 4096 Jul 25 2016 ./<br>drwxr-xr-x 4 root root 4096 Jul 25 2016 ../<br>-rw-r--r-- 1 root root 453 Jul 25 2016 README.md<br>-rw-r--r-- 1 root root 331 Jul 25 2016 sonar-project.properties<br>drwxr-xr-x 2 root root 4096 Jul 25 2016 src/<br>-rw-r--r-- 1 root root 272 Jul 25 2016 validation.txt<br><br><span class="hljs-comment"># cat sonar-project.properties 以下为默认生成的配置文件</span><br><span class="hljs-comment"># Required metadata</span><br>sonar.projectKey=org.sonarqube:php-simple-sq-scanner <span class="hljs-comment">#自定义项目 key</span><br>sonar.projectName=PHP :: Simple Project :: SonarQube Scanner <span class="hljs-comment">#项目名称，会显示在web</span><br>sonar.projectVersion=1.0 <span class="hljs-comment">#项目版本</span><br><br><span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>sonar.sources=src <span class="hljs-comment">#源代码目录</span><br><br><span class="hljs-comment"># Language</span><br>sonar.language=php <span class="hljs-comment">#代码语言类型</span><br><br><span class="hljs-comment"># Encoding of the source files</span><br>sonar.sourceEncoding=UTF-8 <span class="hljs-comment">#编码格式</span><br></code></pre></td></tr></table></figure><h4 id="5-4-3-在源代码目录执行扫描"><a href="#5-4-3-在源代码目录执行扫描" class="headerlink" title="5.4.3 在源代码目录执行扫描"></a>5.4.3 在源代码目录执行扫描</h4><p>#手动在当前项目代码目录执行扫描，以下是扫描过程的提示信息，扫描的配置文件sonar-project.propertie 每个项目都要有</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube-server:/usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner<br>root@sonarqube-server:/usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner<span class="hljs-comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span><br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner/sonar-project.properties<br>INFO: SonarScanner 4.3.0.2102<br>INFO: Java 11.0.3 AdoptOpenJDK (64-bit)<br>INFO: Linux 4.15.0-55-generic amd64<br>INFO: User cache: /root/.sonar/cache<br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner/sonar-project.properties<br>INFO: Analyzing on SonarQube server 7.9.2<br>INFO: Default locale: <span class="hljs-string">&quot;en_HK&quot;</span>, <span class="hljs-built_in">source</span> code encoding: <span class="hljs-string">&quot;UTF-8&quot;</span><br>INFO: Load global settings<br>INFO: Load global settings (<span class="hljs-keyword">done</span>) | time=82ms<br>INFO: Server id: 9A84A96E-AXl6fM6ITuzQthHv-dgM<br>INFO: User cache: /root/.sonar/cache<br>INFO: Load/download plugins<br>INFO: Load plugins index<br>INFO: Load plugins index (<span class="hljs-keyword">done</span>) | time=35ms<br>INFO: Plugin [l10nzh] defines <span class="hljs-string">&#x27;l10nen&#x27;</span> as base plugin. This metadata can be removed from manifest of l10n plugins since version 5.2.<br>INFO: Load/download plugins (<span class="hljs-keyword">done</span>) | time=1211ms<br>INFO: Process project properties<br>INFO: Execute project builders<br>INFO: Execute project builders (<span class="hljs-keyword">done</span>) | time=3ms<br>INFO: Project key: org.sonarqube:python-simple-sonar-scanner<br>INFO: Base dir: /usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner<br>INFO: Working dir: /usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner/.scannerwork<br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;org.sonarqube:python-simple-sonar-scanner&#x27;</span><br>INFO: Load quality profiles<br>INFO: Load quality profiles (<span class="hljs-keyword">done</span>) | time=44ms<br>INFO: Load active rules<br>INFO: Load active rules (<span class="hljs-keyword">done</span>) | time=736ms<br>WARN: SCM provider autodetection failed. Please use <span class="hljs-string">&quot;sonar.scm.provider&quot;</span> to define SCM of your project, or <span class="hljs-built_in">disable</span> the SCM Sensor <span class="hljs-keyword">in</span> the project settings.<br>INFO: Indexing files...<br>INFO: Project configuration:<br>INFO: 9 files indexed<br>INFO: Quality profile <span class="hljs-keyword">for</span> py: Sonar way<br>INFO: ------------- Run sensors on module Python :: Simple Project : SonarQube Scanner<br>INFO: Load metrics repository<br>INFO: Load metrics repository (<span class="hljs-keyword">done</span>) | time=23ms<br>WARNING: An illegal reflective access operation has occurred<br>WARNING: Illegal reflective access by net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span> (file:/root/.sonar/cache/866bb1adbf016ea515620f1aaa15ec53/sonar-javascript-plugin.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain)<br>WARNING: Please consider reporting this to the maintainers of net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span><br>WARNING: Use --illegal-access=warn to <span class="hljs-built_in">enable</span> warnings of further illegal reflective access operations<br>WARNING: All illegal access operations will be denied <span class="hljs-keyword">in</span> a future release<br>INFO: Sensor Python Squid Sensor [python]<br>INFO: Load project repositories<br>INFO: Load project repositories (<span class="hljs-keyword">done</span>) | time=6ms<br>INFO: Sensor Python Squid Sensor [python] (<span class="hljs-keyword">done</span>) | time=201ms<br>INFO: Sensor Cobertura Sensor <span class="hljs-keyword">for</span> Python coverage [python]<br>INFO: Sensor Cobertura Sensor <span class="hljs-keyword">for</span> Python coverage [python] (<span class="hljs-keyword">done</span>) | time=8ms<br>INFO: Sensor PythonXUnitSensor [python]<br>INFO: Sensor PythonXUnitSensor [python] (<span class="hljs-keyword">done</span>) | time=0ms<br>INFO: Sensor JaCoCo XML Report Importer [jacoco]<br>INFO: Sensor JaCoCo XML Report Importer [jacoco] (<span class="hljs-keyword">done</span>) | time=2ms<br>INFO: Sensor JavaXmlSensor [java]<br>INFO: Sensor JavaXmlSensor [java] (<span class="hljs-keyword">done</span>) | time=1ms<br>INFO: Sensor HTML [web]<br>INFO: Sensor HTML [web] (<span class="hljs-keyword">done</span>) | time=6ms<br>INFO: ------------- Run sensors on project<br>INFO: Sensor Zero Coverage Sensor<br>INFO: Sensor Zero Coverage Sensor (<span class="hljs-keyword">done</span>) | time=6ms<br>INFO: No SCM system was detected. You can use the <span class="hljs-string">&#x27;sonar.scm.provider&#x27;</span> property to explicitly specify it.<br>INFO: 5 files had no CPD blocks<br>INFO: Calculating CPD <span class="hljs-keyword">for</span> 4 files<br>INFO: CPD calculation finished<br>INFO: Analysis report generated <span class="hljs-keyword">in</span> 39ms, dir size=106 KB<br>INFO: Analysis report compressed <span class="hljs-keyword">in</span> 10ms, zip size=30 KB<br>INFO: Analysis report uploaded <span class="hljs-keyword">in</span> 334ms<br>INFO: ANALYSIS SUCCESSFUL, you can browse http://localhost:9000/dashboard?id=org.sonarqube%3Apython-simple-sonar-scanner<br>INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report<br>INFO: More about the report processing at http://localhost:9000/api/ce/task?id=AXl6ojbr-PTo1GAXoFlA<br>INFO: Analysis total time: 2.508 s<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION SUCCESS<br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: 4.502s<br>INFO: Final Memory: 6M/27M<br>INFO: ------------------------------------------------------------------------<br></code></pre></td></tr></table></figure><p>结果一旦出现success就证明代码没有出错，但是不一定没有其他问题</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-147.png"></p><h4 id="5-4-4-sonarquebe-we-界面验证扫描结果"><a href="#5-4-4-sonarquebe-we-界面验证扫描结果" class="headerlink" title="5.4.4 sonarquebe we 界面验证扫描结果"></a>5.4.4 sonarquebe we 界面验证扫描结果</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-148.png"></p><h3 id="5-5-jenkins-执行代码扫描"><a href="#5-5-jenkins-执行代码扫描" class="headerlink" title="5.5 jenkins 执行代码扫描"></a>5.5 jenkins 执行代码扫描</h3><h4 id="5-5-1-配置扫描"><a href="#5-5-1-配置扫描" class="headerlink" title="5.5.1 配置扫描"></a>5.5.1 配置扫描</h4><p>下载自己的项目，将配置文件的内容修改成如下格式填写完成后点保存</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@web3:~<span class="hljs-comment"># git clone -b develop http://10.0.0.101/linux/web1.git</span><br>Cloning into <span class="hljs-string">&#x27;web1&#x27;</span>...<br>Username <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span>: rlin<br>Password <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://rlin@10.0.0.101&#x27;</span>: <br>remote: Enumerating objects: 54, <span class="hljs-keyword">done</span>.<br>remote: Counting objects: 100% (54/54), <span class="hljs-keyword">done</span>.<br>remote: Compressing objects: 100% (37/37), <span class="hljs-keyword">done</span>.<br>remote: Total 54 (delta 12), reused 52 (delta 11)<br>Unpacking objects: 100% (54/54), <span class="hljs-keyword">done</span>.<br>root@web3:~<span class="hljs-comment"># cd web1/</span><br><br>root@web3:~/web1<span class="hljs-comment"># vim sonar-project.properties</span><br><span class="hljs-comment"># Required metadata</span><br>sonar.projectKey=linux-web1<br>sonar.projectName=linux-web1<br>sonar.projectVersion=v0.1.1<br><br><span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br><span class="hljs-comment">#路径看着写</span><br>sonar.sources=<span class="hljs-built_in">source</span> <br><br><span class="hljs-comment"># Language</span><br>sonar.language=py<br><br><span class="hljs-comment"># Encoding of the source files</span><br>sonar.sourceEncoding=UTF-8<br><br><span class="hljs-comment">#下面为自己的目录添加一些脚本</span><br>root@web3:~/web1<span class="hljs-comment"># mkdir source</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/web1<span class="hljs-comment"># cd source/</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/web1/<span class="hljs-built_in">source</span><span class="hljs-comment"># vim linux.py</span><br><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-built_in">print</span> linux1<br><span class="hljs-built_in">print</span> linux2<br><span class="hljs-built_in">print</span> linux3<br>root@web3:/opt/<span class="hljs-built_in">source</span>/web1/<span class="hljs-built_in">source</span><span class="hljs-comment"># python3 linux.py</span><br>  File <span class="hljs-string">&quot;linux.py&quot;</span>, line 2<br>    <span class="hljs-built_in">print</span> linux1<br>               ^<br>SyntaxError: Missing parentheses <span class="hljs-keyword">in</span> call to <span class="hljs-string">&#x27;print&#x27;</span>. Did you mean <span class="hljs-built_in">print</span>(linux1)?<br><span class="hljs-comment">#上传</span><br></code></pre></td></tr></table></figure><h4 id="5-5-2-使用Jenkins手动扫描（通过命令行，推荐，前提Jenkins服务器里要安装sonarqube）"><a href="#5-5-2-使用Jenkins手动扫描（通过命令行，推荐，前提Jenkins服务器里要安装sonarqube）" class="headerlink" title="5.5.2 使用Jenkins手动扫描（通过命令行，推荐，前提Jenkins服务器里要安装sonarqube）"></a>5.5.2 使用Jenkins手动扫描（通过命令行，推荐，前提Jenkins服务器里要安装sonarqube）</h4><h4 id="5-5-2-1-Jenkins-master服务器安装sonarqube扫描器"><a href="#5-5-2-1-Jenkins-master服务器安装sonarqube扫描器" class="headerlink" title="5.5.2.1 Jenkins-master服务器安装sonarqube扫描器"></a>5.5.2.1 Jenkins-master服务器安装sonarqube扫描器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins:~<span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment">#下载sonarqube扫描器</span><br><span class="hljs-comment">#解压扫描器</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># unzip sonar-scanner-cli-4.3.0.2102-linux.zip</span><br><span class="hljs-comment">#制作软连接，解决以后版本升级的问题</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/sonar-scanner-4.3.0.2102-linux /usr/local/sonar-scanner</span><br><span class="hljs-string">&#x27;/usr/local/sonar-scanner&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/sonar-scanner-4.3.0.2102-linux&#x27;</span><br><span class="hljs-comment">#修改配置文件</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span><span class="hljs-comment"># cd /usr/local/sonar-scanner</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/sonar-scanner<span class="hljs-comment"># vim conf/sonar-scanner.properties</span><br><span class="hljs-comment">#Configure here general information about the environment, such as SonarQube server connection details for example</span><br><span class="hljs-comment">#No information about specific project should appear here</span><br><br><span class="hljs-comment">#----- Default SonarQube server</span><br><span class="hljs-comment">#sonar.host.url=http://localhost:9000</span><br>sonar.host.url=http://10.0.0.108:9000<br><br><span class="hljs-comment">#----- Default source code encoding</span><br><span class="hljs-comment">#sonar.sourceEncoding=UTF-8</span><br>sonar.sourceEncoding=UTF-8<br><br><span class="hljs-comment">#测试扫描</span><br>root@jenkins:~<span class="hljs-comment"># cd /data/</span><br><span class="hljs-comment">#下载sonar的一个代码样板包sonar-examples-master</span><br><span class="hljs-comment">#解压</span><br>root@jenkins-master:/data<span class="hljs-comment"># unzip sonar-examples-master.zip</span><br><span class="hljs-comment">#进入一个要测试的代码的文件夹（一定要进入到当前需要进行扫描的文件夹才可以进行扫描） #sonar-project.properties这个文件在这里是不用改</span><br>root@jenkins-master:/data<span class="hljs-comment"># cd sonar-examples-master/projects/languages/php/php-sonar-runner</span><br>root@jenkins-master:/data/sonar-examples-master/projects/languages/php/php-sonar-runner<span class="hljs-comment"># ls</span><br>README.md  sonar-project.properties  src  validation.txt<br><span class="hljs-comment">#进行测试</span><br>root@jenkins-master:/data/sonar-examples-master/projects/languages/php/php-sonar-runner<span class="hljs-comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span><br>........<br>INFO: Analysis total time: 4.522 s<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION SUCCESS <span class="hljs-comment">#最后会出现SUCCESS字样，就证明成功</span><br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: 10.638s<br>INFO: Final Memory: 6M/24M<br>INFO: ------------------------------------------------------------------------<br></code></pre></td></tr></table></figure><h4 id="5-2-2-2-在Jenkins里设置要扫描的项目"><a href="#5-2-2-2-在Jenkins里设置要扫描的项目" class="headerlink" title="5.2.2.2 在Jenkins里设置要扫描的项目"></a>5.2.2.2 在Jenkins里设置要扫描的项目</h4><p>进入Jenkins，进入到某个要进行代码扫描的项目，在构建里添加内容，最后构建项目</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another100.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-develop &amp;&amp; /usr/<span class="hljs-built_in">local</span>/sonar-scanner/bin/sonar-scanner &amp;&amp; tar czvf myapp.tar.gz ./*<br><br>scp myapp.tar.gz www@10.0.0.105:/data/tomcat/tomcat_appdir/<br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure><p>构建后sonarqube web界面</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another101.png"></p><h4 id="5-5-3-通过Jenkins插件进行扫描"><a href="#5-5-3-通过Jenkins插件进行扫描" class="headerlink" title="5.5.3 通过Jenkins插件进行扫描"></a>5.5.3 通过Jenkins插件进行扫描</h4><h5 id="5-5-3-1-jenkins-安装-SonarQube-插件"><a href="#5-5-3-1-jenkins-安装-SonarQube-插件" class="headerlink" title="5.5.3.1 jenkins 安装 SonarQube 插件"></a>5.5.3.1 jenkins 安装 SonarQube 插件</h5><p>安装插件 SonarQube Scanner，然后配置 SonarQube server，系统管理-系统设置。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-149.png"></p><h4 id="5-5-3-2-添加-sonarquebe-URL"><a href="#5-5-3-2-添加-sonarquebe-URL" class="headerlink" title="5.5.3.2 添加 sonarquebe URL"></a>5.5.3.2 添加 sonarquebe URL</h4><p>Jenkins—系统管理—系统设置–SonarQube servers-Add SonarQube</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-150.png"></p><h4 id="5-5-3-3-让-jenkins-添加-Sonar-scanner-扫描器"><a href="#5-5-3-3-让-jenkins-添加-Sonar-scanner-扫描器" class="headerlink" title="5.5.3.3 让 jenkins 添加 Sonar scanner 扫描器"></a>5.5.3.3 让 jenkins 添加 Sonar scanner 扫描器</h4><p>添加扫描器：<br>Jenkins–系统管理-全局工具配置：</p><h6 id="5-5-3-3-1-手动指定绝对路径-（和上一个手动扫描一样需要安装扫描器）"><a href="#5-5-3-3-1-手动指定绝对路径-（和上一个手动扫描一样需要安装扫描器）" class="headerlink" title="5.5.3.3.1 手动指定绝对路径 （和上一个手动扫描一样需要安装扫描器）"></a>5.5.3.3.1 手动指定绝对路径 （和上一个手动扫描一样需要安装扫描器）</h6><p>/usr/local/src/sonar-scanner-4.0.0.1744-linux</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-151.png"></p><h6 id="5-5-3-3-2-自动安装"><a href="#5-5-3-3-2-自动安装" class="headerlink" title="5.5.3.3.2 自动安装"></a>5.5.3.3.2 自动安装</h6><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-152.png"></p><h6 id="5-5-3-3-3-配置扫描"><a href="#5-5-3-3-3-配置扫描" class="headerlink" title="5.5.3.3.3 配置扫描"></a>5.5.3.3.3 配置扫描</h6><p>选择自己的项目 - 构建 -execute sonarqube scanner ，将配置文件的内容修改成如下格式填写完成后点保存：（要把扫描放在执行shell之前，Execute SonarQube Scanner拖上去即可）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another102.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Required metadata</span><br>sonar.projectKey=linux-web1<br>sonar.projectName=linux-web1<br>sonar.projectVersion=v0.1.2<br><br><span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>sonar.sources=<span class="hljs-built_in">source</span><br><br><span class="hljs-comment"># Language</span><br>sonar.language=py<br><br><span class="hljs-comment"># Encoding of the source files</span><br>sonar.sourceEncoding=UTF-8<br></code></pre></td></tr></table></figure><h6 id="5-5-3-3-4-配置项目进行扫描"><a href="#5-5-3-3-4-配置项目进行扫描" class="headerlink" title="5.5.3.3.4 配置项目进行扫描"></a>5.5.3.3.4 配置项目进行扫描</h6><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-153.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#详细内容，根据实际修改</span><br><span class="hljs-comment"># Required metadata</span><br>    sonar.projectKey=linux-web1<br>    sonar.projectName=linux-web1<br>    sonar.projectVersion=v0.1.2<br><br>    <span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>    sonar.sources=<span class="hljs-built_in">source</span><br><br>    <span class="hljs-comment"># Language</span><br>    sonar.language=py<br><br>    <span class="hljs-comment"># Encoding of the source files</span><br>    sonar.sourceEncoding=UTF-8<br></code></pre></td></tr></table></figure><h6 id="5-5-3-3-5-构建项目并测试-sonar-scanner-是否生效"><a href="#5-5-3-3-5-构建项目并测试-sonar-scanner-是否生效" class="headerlink" title="5.5.3.3.5 构建项目并测试 sonar-scanner 是否生效"></a>5.5.3.3.5 构建项目并测试 sonar-scanner 是否生效</h6><p>点击项目的立即构建（需要先把之前手动使用扫描器的那段代码删除），下图是执行成功的信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs bash">Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace /var/lib/jenkins/workspace/linux-web1-develop<br>[WS-CLEANUP] Deleting project workspace...<br>[WS-CLEANUP] Deferred wipeout is used...<br>[WS-CLEANUP] Done<br>The recommended git tool is: NONE<br>using credential a745d835-034e-4ec6-a5f8-93f436d3a35e<br>Cloning the remote Git repository<br>Cloning repository git@10.0.0.101:linux/web1.git<br> &gt; git init /var/lib/jenkins/workspace/linux-web1-develop <span class="hljs-comment"># timeout=10</span><br>Fetching upstream changes from git@10.0.0.101:linux/web1.git<br> &gt; git --version <span class="hljs-comment"># timeout=10</span><br> &gt; git --version <span class="hljs-comment"># &#x27;git version 2.17.1&#x27;</span><br>using GIT_SSH to <span class="hljs-built_in">set</span> credentials <br> &gt; git fetch --tags --progress -- git@10.0.0.101:linux/web1.git +refs/heads/*:refs/remotes/origin/* <span class="hljs-comment"># timeout=10</span><br> &gt; git config remote.origin.url git@10.0.0.101:linux/web1.git <span class="hljs-comment"># timeout=10</span><br> &gt; git config --add remote.origin.fetch +refs/heads/*:refs/remotes/origin/* <span class="hljs-comment"># timeout=10</span><br>Avoid second fetch<br> &gt; git rev-parse refs/remotes/origin/develop^&#123;commit&#125; <span class="hljs-comment"># timeout=10</span><br>Checking out Revision 4a03f9e0a8bc551e7b788ad70bf0eb4f70648c4d (refs/remotes/origin/develop)<br> &gt; git config core.sparsecheckout <span class="hljs-comment"># timeout=10</span><br> &gt; git checkout -f 4a03f9e0a8bc551e7b788ad70bf0eb4f70648c4d <span class="hljs-comment"># timeout=10</span><br>Commit message: <span class="hljs-string">&quot;python v3&quot;</span><br> &gt; git rev-list --no-walk 4a03f9e0a8bc551e7b788ad70bf0eb4f70648c4d <span class="hljs-comment"># timeout=10</span><br>[linux-web1-develop] $ /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/bin/sonar-scanner -Dsonar.host.url=http://10.0.0.108:9000/ -Dsonar.language=py -Dsonar.projectName=linux-web1 -Dsonar.projectVersion=v0.1.2 -Dsonar.sourceEncoding=UTF-8 -Dsonar.projectKey=linux-web1 -Dsonar.sources=<span class="hljs-built_in">source</span> -Dsonar.projectBaseDir=/var/lib/jenkins/workspace/linux-web1-develop<br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: NONE<br>INFO: SonarScanner 4.3.0.2102<br>INFO: Java 11.0.3 AdoptOpenJDK (64-bit)<br>INFO: Linux 4.15.0-55-generic amd64<br>INFO: User cache: /root/.sonar/cache<br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: NONE<br>INFO: Analyzing on SonarQube server 7.9.2<br>INFO: Default locale: <span class="hljs-string">&quot;en_HK&quot;</span>, <span class="hljs-built_in">source</span> code encoding: <span class="hljs-string">&quot;UTF-8&quot;</span><br>INFO: Load global settings<br>INFO: Load global settings (<span class="hljs-keyword">done</span>) | time=49ms<br>INFO: Server id: 9A84A96E-AXkxZMMhxe7GaeVzaKga<br>INFO: User cache: /root/.sonar/cache<br>INFO: Load/download plugins<br>INFO: Load plugins index<br>INFO: Load plugins index (<span class="hljs-keyword">done</span>) | time=37ms<br>INFO: Plugin [l10nzh] defines <span class="hljs-string">&#x27;l10nen&#x27;</span> as base plugin. This metadata can be removed from manifest of l10n plugins since version 5.2.<br>INFO: Load/download plugins (<span class="hljs-keyword">done</span>) | time=98ms<br>INFO: Process project properties<br>INFO: Execute project builders<br>INFO: Execute project builders (<span class="hljs-keyword">done</span>) | time=3ms<br>INFO: Project key: linux-web1<br>INFO: Base dir: /var/lib/jenkins/workspace/linux-web1-develop<br>INFO: Working dir: /var/lib/jenkins/workspace/linux-web1-develop/.scannerwork<br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;linux-web1&#x27;</span><br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;linux-web1&#x27;</span> (<span class="hljs-keyword">done</span>) | time=10ms<br>INFO: Load quality profiles<br>INFO: Load quality profiles (<span class="hljs-keyword">done</span>) | time=47ms<br>INFO: Detected Jenkins<br>INFO: Load active rules<br>INFO: Load active rules (<span class="hljs-keyword">done</span>) | time=551ms<br>INFO: Indexing files...<br>INFO: Project configuration:<br>INFO: 2 files indexed<br>INFO: 0 files ignored because of scm ignore settings<br>INFO: Quality profile <span class="hljs-keyword">for</span> py: Sonar way<br>INFO: ------------- Run sensors on module linux-web1<br>INFO: Load metrics repository<br>INFO: Load metrics repository (<span class="hljs-keyword">done</span>) | time=35ms<br>WARNING: An illegal reflective access operation has occurred<br>WARNING: Illegal reflective access by net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span> (file:/root/.sonar/cache/866bb1adbf016ea515620f1aaa15ec53/sonar-javascript-plugin.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain)<br>WARNING: Please consider reporting this to the maintainers of net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span><br>WARNING: Use --illegal-access=warn to <span class="hljs-built_in">enable</span> warnings of further illegal reflective access operations<br>WARNING: All illegal access operations will be denied <span class="hljs-keyword">in</span> a future release<br>INFO: Sensor Python Squid Sensor [python]<br>INFO: Load project repositories<br>INFO: Load project repositories (<span class="hljs-keyword">done</span>) | time=13ms<br>INFO: Sensor Python Squid Sensor [python] (<span class="hljs-keyword">done</span>) | time=116ms<br>INFO: Sensor Cobertura Sensor <span class="hljs-keyword">for</span> Python coverage [python]<br>INFO: Sensor Cobertura Sensor <span class="hljs-keyword">for</span> Python coverage [python] (<span class="hljs-keyword">done</span>) | time=19ms<br>INFO: Sensor PythonXUnitSensor [python]<br>INFO: Sensor PythonXUnitSensor [python] (<span class="hljs-keyword">done</span>) | time=3ms<br>INFO: Sensor JaCoCo XML Report Importer [jacoco]<br>INFO: Sensor JaCoCo XML Report Importer [jacoco] (<span class="hljs-keyword">done</span>) | time=3ms<br>INFO: Sensor JavaXmlSensor [java]<br>INFO: Sensor JavaXmlSensor [java] (<span class="hljs-keyword">done</span>) | time=4ms<br>INFO: Sensor HTML [web]<br>INFO: Sensor HTML [web] (<span class="hljs-keyword">done</span>) | time=11ms<br>INFO: ------------- Run sensors on project<br>INFO: Sensor Zero Coverage Sensor<br>INFO: Sensor Zero Coverage Sensor (<span class="hljs-keyword">done</span>) | time=9ms<br>INFO: 1 file had no CPD blocks<br>INFO: Calculating CPD <span class="hljs-keyword">for</span> 0 files<br>INFO: CPD calculation finished<br>INFO: Analysis report generated <span class="hljs-keyword">in</span> 99ms, dir size=72 KB<br>INFO: Analysis report compressed <span class="hljs-keyword">in</span> 15ms, zip size=10 KB<br>INFO: Analysis report uploaded <span class="hljs-keyword">in</span> 32ms<br>INFO: ANALYSIS SUCCESSFUL, you can browse http://10.0.0.108:9000/dashboard?id=linux-web1<br>INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report<br>INFO: More about the report processing at http://10.0.0.108:9000/api/ce/task?id=AXkykAQUruykkeP0Ih2x<br>INFO: Analysis total time: 3.393 s<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION SUCCESS<br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: 4.538s<br>INFO: Final Memory: 13M/60M<br>INFO: ------------------------------------------------------------------------<br>[linux-web1-develop] $ /bin/sh -xe /tmp/jenkins1117300433158617591.sh<br>+ <span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-develop<br>+ tar czvf myapp.tar.gz ./app ./index.html ./<span class="hljs-built_in">source</span><br>./app/<br>./app/index.html<br>./index.html<br>./<span class="hljs-built_in">source</span>/<br>./<span class="hljs-built_in">source</span>/linux.py<br>./<span class="hljs-built_in">source</span>/sonar-project.properties<br>+ scp myapp.tar.gz www@10.0.0.105:/data/tomcat/tomcat_appdir/<br>+ ssh www@10.0.0.105 /etc/init.d/tomcat stop<br>正在判断服务状态，请稍等3秒钟！<br>3<br>2<br>1<br>Tomcat运行中，1秒后关闭！<br>1<br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br>3<br>2<br>1<br>Tomcat 已经关闭完成！<br>3<br>2<br>1<br>+ ssh www@10.0.0.105 <span class="hljs-built_in">cd</span> /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/<br>./app/<br>./app/index.html<br>./index.html<br>./<span class="hljs-built_in">source</span>/<br>./<span class="hljs-built_in">source</span>/linux.py<br>./<span class="hljs-built_in">source</span>/sonar-project.properties<br>+ ssh www@10.0.0.105 /etc/init.d/tomcat start<br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为7397<br>Finished: SUCCESS<br></code></pre></td></tr></table></figure><h6 id="5-5-3-3-6-查看项目的构建历史"><a href="#5-5-3-3-6-查看项目的构建历史" class="headerlink" title="5.5.3.3.6 查看项目的构建历史"></a>5.5.3.3.6 查看项目的构建历史</h6><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-154.png"></p><h4 id="5-5-4-步骤总结"><a href="#5-5-4-步骤总结" class="headerlink" title="5.5.4 步骤总结"></a>5.5.4 步骤总结</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#Jenkinsshell基本实现代码扫描</span><br>cd <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-web1-develop &amp;&amp;/u</span>sr<span class="hljs-regexp">/local/</span>sonar-scanner<span class="hljs-regexp">/bin/</span>sonar-scanner<br><br><span class="hljs-comment">#Jenkins插件实现代码扫描</span><br><span class="hljs-number">1</span>.添加sonarqube server地址<br><span class="hljs-number">2</span>.配置sonar-scanner的扫描器<br>    jenkins安装sonar-scanner<br>    调用服务器的sonar-scanner<br><span class="hljs-number">3</span>.进行扫描配置<br>    <span class="hljs-comment"># Required metadata</span><br>    sonar.projectKey=linux-web1<br>    sonar.projectName=linux-web1<br>    sonar.projectVersion=v0.<span class="hljs-number">1.2</span><br><br>    <span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>    sonar.sources=source<br><br>    <span class="hljs-comment"># Language</span><br>    sonar.language=py<br><br>    <span class="hljs-comment"># Encoding of the source files</span><br>    sonar.sourceEncoding=UTF-<span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#Jenkinsshell基本实现代码扫描</span><br>cd <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-web1-develop &amp;&amp;/u</span>sr<span class="hljs-regexp">/local/</span>sonar-scanner<span class="hljs-regexp">/bin/</span>sonar-scanner<br><br><span class="hljs-comment">#Jenkins插件实现代码扫描</span><br><span class="hljs-number">1</span>.添加sonarqube server地址<br><span class="hljs-number">2</span>.配置sonar-scanner的扫描器<br>    jenkins安装sonar-scanner<br>    调用服务器的sonar-scanner<br><span class="hljs-number">3</span>.进行扫描配置<br>    <span class="hljs-comment"># Required metadata</span><br>    sonar.projectKey=linux-web1<br>    sonar.projectName=linux-web1<br>    sonar.projectVersion=v0.<span class="hljs-number">1.2</span><br><br>    <span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>    sonar.sources=source<br><br>    <span class="hljs-comment"># Language</span><br>    sonar.language=py<br><br>    <span class="hljs-comment"># Encoding of the source files</span><br>    sonar.sourceEncoding=UTF-<span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><h2 id="六、Jenkins继承Maven项目"><a href="#六、Jenkins继承Maven项目" class="headerlink" title="六、Jenkins继承Maven项目"></a>六、Jenkins继承Maven项目</h2><h3 id="6-1-java项目部署概述"><a href="#6-1-java项目部署概述" class="headerlink" title="6.1 java项目部署概述"></a>6.1 java项目部署概述</h3><h4 id="6-1-1-什么使java项目"><a href="#6-1-1-什么使java项目" class="headerlink" title="6.1.1 什么使java项目"></a>6.1.1 什么使java项目</h4><p>简单来说就是使用java编写的代码，我们将其称为java项目</p><h4 id="6-1-2-为什么java项目需要使用Maven编译"><a href="#6-1-2-为什么java项目需要使用Maven编译" class="headerlink" title="6.1.2 为什么java项目需要使用Maven编译"></a>6.1.2 为什么java项目需要使用Maven编译</h4><p>由于java编写的代码无法直接在服务器上运行，需要maven工具进行打包</p><p>简单理解：java源代码就像汽车的一堆散件，必须组装才是一辆完整的汽车。这里的组装汽车可以理解为使maven编译的过程</p><h4 id="6-1-3-手动实现java项目构建"><a href="#6-1-3-手动实现java项目构建" class="headerlink" title="6.1.3 手动实现java项目构建"></a>6.1.3 手动实现java项目构建</h4><p>首先对java项目不熟悉，其次要实现自动化发布代码，必须会手动。</p><p>一个完整的发布流程：拿到源码 –&gt; 然后提交到gitlab –&gt; 使用mvn手动构建 –&gt; 最后推送war至tomcat发布</p><h4 id="6-1-4-手动实现java项目架构图"><a href="#6-1-4-手动实现java项目架构图" class="headerlink" title="6.1.4 手动实现java项目架构图"></a>6.1.4 手动实现java项目架构图</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another151.png"></p><h3 id="6-2-java项目手动发布"><a href="#6-2-java项目手动发布" class="headerlink" title="6.2 java项目手动发布"></a>6.2 java项目手动发布</h3><h4 id="6-2-1-搭建nginx-tomcat集群架构"><a href="#6-2-1-搭建nginx-tomcat集群架构" class="headerlink" title="6.2.1 搭建nginx+tomcat集群架构"></a>6.2.1 搭建nginx+tomcat集群架构</h4><h5 id="6-2-1-1-安装nginx"><a href="#6-2-1-1-安装nginx" class="headerlink" title="6.2.1.1 安装nginx"></a>6.2.1.1 安装nginx</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.103安装nginx，事项反向代理负载均衡至tomcat服务器10.0.0.105 10.0.0.106 10.0.0.107</span><br><span class="hljs-comment">#安装过程略</span><br><span class="hljs-comment">#配置文件</span><br>vim proxy_java.com.conf<br>upstream java &#123;<br>    server 10.0.0.105:8080;<br>    server 10.0.0.106:8080;<br>    server 10.0.0.107:8080;<br>&#125;<br><br>server &#123;<br>    listen 80;<br>    server_name java.rlin.com;<br>    location / &#123;<br>        proxy_pass http://java;<br>        proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">#重启nginx</span><br></code></pre></td></tr></table></figure><h5 id="6-2-1-2-安装tomcat"><a href="#6-2-1-2-安装tomcat" class="headerlink" title="6.2.1.2 安装tomcat"></a>6.2.1.2 安装tomcat</h5><p>10.0.0.105 10.0.0.106 10.0.0.107 安装tomcat，安装过程略，并开启tomcat</p><h5 id="6-2-1-3-安装数据库和redis"><a href="#6-2-1-3-安装数据库和redis" class="headerlink" title="6.2.1.3 安装数据库和redis"></a>6.2.1.3 安装数据库和redis</h5><p>10.0.0.108 安装数据库和redis</p><h5 id="6-2-1-4-访问nginx检查集群是否布置成功"><a href="#6-2-1-4-访问nginx检查集群是否布置成功" class="headerlink" title="6.2.1.4 访问nginx检查集群是否布置成功"></a>6.2.1.4 访问nginx检查集群是否布置成功</h5><h4 id="6-2-2-开发人员java源代码至gitlab仓库"><a href="#6-2-2-开发人员java源代码至gitlab仓库" class="headerlink" title="6.2.2 开发人员java源代码至gitlab仓库"></a>6.2.2 开发人员java源代码至gitlab仓库</h4><h5 id="6-2-2-1-在gitlab创建项目仓库"><a href="#6-2-2-1-在gitlab创建项目仓库" class="headerlink" title="6.2.2.1 在gitlab创建项目仓库"></a>6.2.2.1 在gitlab创建项目仓库</h5><h5 id="6-2-2-2-推送java代码推送到gitlab"><a href="#6-2-2-2-推送java代码推送到gitlab" class="headerlink" title="6.2.2.2 推送java代码推送到gitlab"></a>6.2.2.2 推送java代码推送到gitlab</h5><p>java的代码下载网址：<a href="https://gitee.com/lupan/hello-world-web">https://gitee.com/lupan/hello-world-web</a></p><h4 id="6-2-3-手动获取java源代码，然后使用maven进行编译"><a href="#6-2-3-手动获取java源代码，然后使用maven进行编译" class="headerlink" title="6.2.3 手动获取java源代码，然后使用maven进行编译"></a>6.2.3 手动获取java源代码，然后使用maven进行编译</h4><h5 id="6-2-3-1-由于maven编译工具需要依赖java，所以需要先安装jdk"><a href="#6-2-3-1-由于maven编译工具需要依赖java，所以需要先安装jdk" class="headerlink" title="6.2.3.1 由于maven编译工具需要依赖java，所以需要先安装jdk"></a>6.2.3.1 由于maven编译工具需要依赖java，所以需要先安装jdk</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment">#下载jdk</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># tar xvf jdk-8u192-linux-x64.tar.gz</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/jdk1.8.0_192/ /usr/local/jdk</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/jdk/bin/java /usr/bin/ #java 命令软连接</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$JAVA_HOME</span>/jre/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> CLASSPATH=.<span class="hljs-variable">$CLASSPATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/lib:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># source /etc/profile</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_192&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_192-b12)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.192-b12, mixed mode)<br></code></pre></td></tr></table></figure><h5 id="6-2-3-2-安装maven编译打包工具"><a href="#6-2-3-2-安装maven编译打包工具" class="headerlink" title="6.2.3.2 安装maven编译打包工具"></a>6.2.3.2 安装maven编译打包工具</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装maven方法一：</span><br>yum install maven -y 或 apt install maven -y<br><br><span class="hljs-comment">#安装maven方法二：</span><br><span class="hljs-comment">#此方法用于安装高版本的maven</span><br><span class="hljs-comment">#1.下载maven，到清华源</span><br>root@jenkins-master:~<span class="hljs-comment"># cd /usr/local/src</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># wget https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz</span><br><br><span class="hljs-comment">#2.安装maven</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment">#tar xf apache-maven-3.6.3-bin.tar.gz</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/apache-maven-3.6.3/ /usr/local/maven</span><br><span class="hljs-string">&#x27;/usr/local/maven&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/apache-maven-3.6.3/&#x27;</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># /usr/local/maven/b</span><br>bin/  boot/ <br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># /usr/local/maven/bin/mvn -v</span><br>Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)<br>Maven home: /usr/<span class="hljs-built_in">local</span>/maven<br>Java version: 1.8.0_192, vendor: Oracle Corporation, runtime: /usr/<span class="hljs-built_in">local</span>/src/jdk1.8.0_192/jre<br>Default locale: en_US, platform encoding: UTF-8<br>OS name: <span class="hljs-string">&quot;linux&quot;</span>, version: <span class="hljs-string">&quot;4.15.0-55-generic&quot;</span>, arch: <span class="hljs-string">&quot;amd64&quot;</span>, family: <span class="hljs-string">&quot;unix&quot;</span><br><br><span class="hljs-comment">#配置环境变量</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-built_in">export</span> HISTTIMEFORMAT=<span class="hljs-string">&quot;%F %T `whoami` &quot;</span><br><span class="hljs-built_in">export</span> <span class="hljs-built_in">export</span> LANG=<span class="hljs-string">&quot;en_US.utf-8&quot;</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> MAVEN_HOME=/usr/<span class="hljs-built_in">local</span>/maven<br><span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/dt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$JAVA_HOME</span>/jre/bin:<span class="hljs-variable">$MAVEN_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># source /etc/profile</span><br></code></pre></td></tr></table></figure><h5 id="6-2-3-3-获取java代码，然后上传到gitlab里"><a href="#6-2-3-3-获取java代码，然后上传到gitlab里" class="headerlink" title="6.2.3.3 获取java代码，然后上传到gitlab里"></a>6.2.3.3 获取java代码，然后上传到gitlab里</h5><h6 id="6-2-3-3-1-创建项目"><a href="#6-2-3-3-1-创建项目" class="headerlink" title="6.2.3.3.1 创建项目"></a>6.2.3.3.1 创建项目</h6><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another152.png"></p><p>6.2.3.3.2 在网上获取java代码，并将java代码上传到gitlab里</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注意：所有代码不得用作商业</span><br><span class="hljs-comment">#下载git代码</span><br>git <span class="hljs-built_in">clone</span> https://gitee.com/lupan/hello-world-web.git<br><span class="hljs-comment">#将java代码上传到gitlab里</span><br>root@web3:~<span class="hljs-comment"># mkdir /opt/source -p</span><br>root@web3:~<span class="hljs-comment"># cd /opt/source</span><br>root@web3:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># git clone http://10.0.0.101/linux/linux-java-web1.git</span><br>root@web3:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># cd linux-java-web1</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># mv /root/hello-world-web/* .</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git add .</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git commit -m &quot;Initial commit&quot;</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git push -u origin master</span><br></code></pre></td></tr></table></figure><h6 id="6-2-3-3-3-gitlab项目图"><a href="#6-2-3-3-3-gitlab项目图" class="headerlink" title="6.2.3.3.3 gitlab项目图"></a>6.2.3.3.3 gitlab项目图</h6><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another153.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another154.png"></p><h5 id="6-2-3-3-拉去gtlab代码，然后手动编译成war包"><a href="#6-2-3-3-拉去gtlab代码，然后手动编译成war包" class="headerlink" title="6.2.3.3 拉去gtlab代码，然后手动编译成war包"></a>6.2.3.3 拉去gtlab代码，然后手动编译成war包</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># mkdir -p /data/git/</span><br>root@jenkins-master:~<span class="hljs-comment"># cd /data/git/</span><br>root@jenkins-master:/data/git<span class="hljs-comment"># git clone https://gitee.com/gxj_gitee/maven-test202004020.git</span><br>Cloning into <span class="hljs-string">&#x27;linux-java-web1&#x27;</span>...<br>Username <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span>: rlin<br>Password <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://rlin@10.0.0.101&#x27;</span>: <br>remote: Enumerating objects: 40, <span class="hljs-keyword">done</span>.<br>remote: Counting objects: 100% (40/40), <span class="hljs-keyword">done</span>.<br>remote: Compressing objects: 100% (25/25), <span class="hljs-keyword">done</span>.<br>remote: Total 40 (delta 3), reused 0 (delta 0)<br>Unpacking objects: 100% (40/40), done.git <span class="hljs-built_in">clone</span> http://10.0.0.101/linux/linux-java-web1.git<br>root@jenkins-master:/data/git<span class="hljs-comment"># cd linux-java-web1</span><br><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># mvn package -Dmaven.test.skip=true #跳过测试用例</span><br><span class="hljs-comment">#war包一般都在：项目名/target/项目名.war</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another155.png" alt="下载jar包"></p><p><strong>注意：java项目在编译过程中，需要安装很多依赖，依赖都会上maven官方下载，如果项目依赖的jar包较多，网络较差，可能需要很久的时间</strong></p><p><strong>建议将下载的地址调整为阿里云，具体操作如下：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#方法一：</span><br><span class="hljs-comment">#查看maven安装位置下的/conf/settings.xml</span><br><span class="hljs-comment">#修改setttings.xml</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># cd /usr/local/src/apache-maven-3.6.3/conf/</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src/apache-maven-3.6.3/conf<span class="hljs-comment"># vim settings.xml</span><br><span class="hljs-comment">#在159行的上面添加如下内容</span><br> &lt;mirrors&gt;<br>      &lt;mirror&gt;<br>         &lt;id&gt;nexus-aliyun&lt;/id&gt;<br>         &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;<br>         &lt;name&gt;Nexus aliyun&lt;/name&gt;<br>         &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;<br>      &lt;/mirror&gt; <br> &lt;/mirrors&gt;<br><br><span class="hljs-comment">#方法二：</span><br><span class="hljs-comment">#在项目的pom.xml里添加上面的内容</span><br></code></pre></td></tr></table></figure><h4 id="6-2-4-将编译后的war包部署至tomcat集群"><a href="#6-2-4-将编译后的war包部署至tomcat集群" class="headerlink" title="6.2.4 将编译后的war包部署至tomcat集群"></a>6.2.4 将编译后的war包部署至tomcat集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#方法一：</span><br><span class="hljs-comment">#如使用之前的tomcat环境，要清空tomcat_webapps/myapp/里面的内容</span><br><span class="hljs-comment">#注意：这里直接在/myapp里放.war包需要在tomcat的server.xml里的unpackWARs=&quot;false&quot;改为true（默认就是true）</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &#123;105..107&#125;;<span class="hljs-keyword">do</span> scp 完整的项目目录/target/项目名.war www@10.0.0.<span class="hljs-variable">$i</span>:/data/tomcat/tomcat_webapps/myapp/ROOT.war;<span class="hljs-keyword">done</span><br>Q:<br>为什么传送到tomcat服务器里的war包要交ROOT.war？<br>A：<br>因为tomcat一重启就访问该war包<br><br><span class="hljs-comment">#如使用apt或yum安装的tomcat就要将tomcat/webapps/下的ROOT包删除</span><br><br><span class="hljs-comment">#所有服务器重启tomcat</span><br><span class="hljs-comment">#方法二：</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># scp maven-Demo20200420.war www@10.0.0.105:/data/tomcat/tomcat_appdir/ROOT.war （后面的war包需要跟着规则改名）</span><br><br>root@web1:~<span class="hljs-comment"># cd /data/tomcat/tomcat_appdir/</span><br>root@web1:/data/tomcat/tomcat_appdir<span class="hljs-comment"># unzip ROOT.war -d /data/tomcat/tomcat_webdir/java-root/ （后面解压的包需要跟着规则改名）</span><br>root@web1:/data/tomcat/tomcat_appdir<span class="hljs-comment"># ln -sv /data/tomcat/tomcat_webdir/java-root /data/tomcat/tomcat_webapps/myapp</span><br><span class="hljs-comment">#所有服务器重启tomcat</span><br></code></pre></td></tr></table></figure><h4 id="6-2-5-最后通过浏览器访问测试，检测项目是否部署成功"><a href="#6-2-5-最后通过浏览器访问测试，检测项目是否部署成功" class="headerlink" title="6.2.5 最后通过浏览器访问测试，检测项目是否部署成功"></a>6.2.5 最后通过浏览器访问测试，检测项目是否部署成功</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another156.png"></p><h3 id="6-3-java项目自动发布"><a href="#6-3-java项目自动发布" class="headerlink" title="6.3 java项目自动发布"></a>6.3 java项目自动发布</h3><p>Jenkins实现Maven自动发布部署流程图</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another157.png"></p><h4 id="6-3-1-Jenkins安装maven插件，使其支持maven支持maven项目创建"><a href="#6-3-1-Jenkins安装maven插件，使其支持maven支持maven项目创建" class="headerlink" title="6.3.1 Jenkins安装maven插件，使其支持maven支持maven项目创建"></a>6.3.1 Jenkins安装maven插件，使其支持maven支持maven项目创建</h4><p>安装Maven Integration 插件，这样才能使用Jenkins构建一个maven的项目</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another158.png"></p><h4 id="6-3-2-Jenkins配置JDK路径和maven路径"><a href="#6-3-2-Jenkins配置JDK路径和maven路径" class="headerlink" title="6.3.2 Jenkins配置JDK路径和maven路径"></a>6.3.2 Jenkins配置JDK路径和maven路径</h4><p>JDK路径</p><p>Jenkins–&gt;系统管理–&gt;全局工具配置–&gt;JDK（不用自动安装）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another159.png"></p><p>maven</p><p>Jenkins–&gt;系统管理–&gt;全局工具配置–&gt;maven（不用自动安装）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another160.png"></p><h4 id="6-3-3-Jenkins创建maven项目，然后进行构建"><a href="#6-3-3-Jenkins创建maven项目，然后进行构建" class="headerlink" title="6.3.3 Jenkins创建maven项目，然后进行构建"></a>6.3.3 Jenkins创建maven项目，然后进行构建</h4><h5 id="6-3-3-1-创建一个项目，名字叫Linux-hello-world，风格选择构建一个maven项目"><a href="#6-3-3-1-创建一个项目，名字叫Linux-hello-world，风格选择构建一个maven项目" class="headerlink" title="6.3.3.1 创建一个项目，名字叫Linux-hello-world，风格选择构建一个maven项目"></a>6.3.3.1 创建一个项目，名字叫Linux-hello-world，风格选择构建一个maven项目</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another161.png"></p><h5 id="6-3-3-1-项目配置"><a href="#6-3-3-1-项目配置" class="headerlink" title="6.3.3.1 项目配置"></a>6.3.3.1 项目配置</h5><p>丢弃就的构建</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another162.png"></p><p>源码管理</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another163.png"></p><p>构建环境</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another166.png"></p><p>Build</p><p>构建参数：package -Dmaven.test.skip=true</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another167.png"></p><h5 id="6-3-3-2-立即构建"><a href="#6-3-3-2-立即构建" class="headerlink" title="6.3.3.2 立即构建"></a>6.3.3.2 立即构建</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another168.png"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#控制台输出</span><br>Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace/linux-hello-world<br>[WS-CLEANUP] Deleting project workspace...<br>[WS-CLEANUP] Deferred wipeout is used...<br>[WS-CLEANUP] Done<br>The recommended git tool is: NONE<br>using credential <span class="hljs-number">73</span>b70b5b-b09c-<span class="hljs-number">46</span>fd-<span class="hljs-number">8790</span>-<span class="hljs-number">3</span>a0eebf2b12c<br>Cloning the remote Git repository<br>Cloning repository git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git<br> &gt; git init <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace/linux-hello-world <span class="hljs-comment"># timeout=10</span><br>Fetching upstream changes from git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git<br> &gt; git --version <span class="hljs-comment"># timeout=10</span><br> &gt; git --version <span class="hljs-comment"># &#x27;git version 2.17.1&#x27;</span><br>using GIT_SSH to set credentials <br> &gt; git fetch --tags --progress -- git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux<span class="hljs-regexp">/linux-java-web1.git +refs/</span>heads<span class="hljs-regexp">/*:refs/</span>remotes<span class="hljs-regexp">/origin/</span>* <span class="hljs-comment"># timeout=10</span><br> &gt; git config remote.origin.url git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git <span class="hljs-comment"># timeout=10</span><br> &gt; git config --add remote.origin.fetch +refs<span class="hljs-regexp">/heads/</span>*:refs<span class="hljs-regexp">/remotes/</span>origin/* <span class="hljs-comment"># timeout=10</span><br>Avoid second fetch<br> &gt; git rev-parse refs<span class="hljs-regexp">/remotes/</span>origin/master^&#123;commit&#125; <span class="hljs-comment"># timeout=10</span><br>Checking out Revision <span class="hljs-number">1</span>acbfb5592e4f6d88319852f1cc75555f16c823c (refs<span class="hljs-regexp">/remotes/</span>origin/master)<br> &gt; git config core.sparsecheckout <span class="hljs-comment"># timeout=10</span><br> &gt; git checkout -f <span class="hljs-number">1</span>acbfb5592e4f6d88319852f1cc75555f16c823c <span class="hljs-comment"># timeout=10</span><br>Commit message: <span class="hljs-string">&quot;v4&quot;</span><br> &gt; git rev-list --no-walk <span class="hljs-number">1</span>acbfb5592e4f6d88319852f1cc75555f16c823c <span class="hljs-comment"># timeout=10</span><br>Parsing POMs<br>Established TCP socket on <span class="hljs-number">33026</span><br>[linux-hello-world] $ <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/jdk/</span>bin<span class="hljs-regexp">/java -cp /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/maven35-agent-1.13.jar:/u</span>sr<span class="hljs-regexp">/local/m</span>aven<span class="hljs-regexp">/boot/</span>plexus-classworlds-<span class="hljs-number">2.6</span>.<span class="hljs-number">0</span>.jar:<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/maven/</span>conf<span class="hljs-regexp">/logging jenkins.maven3.agent.Maven35Main /u</span>sr<span class="hljs-regexp">/local/m</span>aven <span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/jenkins/</span>war<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/remoting-4.2.1.jar /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/maven35-interceptor-1.13.jar /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib/maven3-interceptor-commons-<span class="hljs-number">1.13</span>.jar <span class="hljs-number">33026</span><br>&lt;===[JENKINS REMOTING CAPACITY]===&gt;channel started<br>Executing Maven:  -B -f <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>pom.xml package -Dmaven.test.skip=true<br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] <br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] Some problems were encountered <span class="hljs-keyword">while</span> building the effective settings<br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] Unrecognised tag: <span class="hljs-string">&#x27;mirrors&#x27;</span> (position: START_TAG seen ...&lt;<span class="hljs-regexp">/mirror&gt;\r\n     --&gt;\r\n\r\n&lt;mirrors&gt;... @160:10)  @ /u</span>sr<span class="hljs-regexp">/local/</span>src<span class="hljs-regexp">/apache-maven-3.6.3/</span>conf/settings.xml, line <span class="hljs-number">160</span>, column <span class="hljs-number">10</span><br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] <br>[INFO] Scanning <span class="hljs-keyword">for</span> projects...<br>[INFO] <br>[INFO] --------------------&lt; com.dzxy:maven-Demo20200420 &gt;---------------------<br>[INFO] Building maven-Demo20200420 Maven Webapp <span class="hljs-number">1.0</span>-SNAPSHOT<br>[INFO] --------------------------------[ war ]---------------------------------<br>[INFO] <br>[INFO] --- maven-resources-plugin:<span class="hljs-number">3.0</span>.<span class="hljs-number">2</span>:resources (default-resources) @ maven-Demo20200420 ---<br>[INFO] Using <span class="hljs-string">&#x27;UTF-8&#x27;</span> encoding to copy filtered resources.<br>[INFO] skip non existing resourceDirectory <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>src<span class="hljs-regexp">/main/</span>resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:<span class="hljs-number">3.8</span>.<span class="hljs-number">0</span>:compile (default-compile) @ maven-Demo20200420 ---<br>[INFO] No sources to compile<br>[INFO] <br>[INFO] --- maven-resources-plugin:<span class="hljs-number">3.0</span>.<span class="hljs-number">2</span>:testResources (default-testResources) @ maven-Demo20200420 ---<br>[INFO] Not copying test resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:<span class="hljs-number">3.8</span>.<span class="hljs-number">0</span>:testCompile (default-testCompile) @ maven-Demo20200420 ---<br>[INFO] Not compiling test sources<br>[INFO] <br>[INFO] --- maven-surefire-plugin:<span class="hljs-number">2.22</span>.<span class="hljs-number">1</span>:test (default-test) @ maven-Demo20200420 ---<br>[INFO] Tests are skipped.<br>[INFO] <br>[INFO] --- maven-war-plugin:<span class="hljs-number">3.2</span>.<span class="hljs-number">2</span>:war (default-war) @ maven-Demo20200420 ---<br>[INFO] Packaging webapp<br>[INFO] Assembling webapp [maven-Demo20200420] <span class="hljs-keyword">in</span> [<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target/maven-Demo20200420]<br>[INFO] Processing war project<br>[INFO] Copying webapp resources [<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>src<span class="hljs-regexp">/main/</span>webapp]<br>[INFO] Webapp assembled <span class="hljs-keyword">in</span> [<span class="hljs-number">10</span> msecs]<br>[INFO] Building war: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target/maven-Demo20200420.war<br>[INFO] ------------------------------------------------------------------------<br>[INFO] BUILD SUCCESS<br>[INFO] ------------------------------------------------------------------------<br>[INFO] Total time:  <span class="hljs-number">2.055</span> s<br>[INFO] Finished at: <span class="hljs-number">2021</span>-<span class="hljs-number">05</span>-<span class="hljs-number">29</span>T16:<span class="hljs-number">40</span>:<span class="hljs-number">34</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span><br>[INFO] ------------------------------------------------------------------------<br>Waiting <span class="hljs-keyword">for</span> Jenkins to finish collecting data<br>[JENKINS] Archiving <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>pom.xml to com.dzxy<span class="hljs-regexp">/maven-Demo20200420/</span><span class="hljs-number">1.0</span>-SNAPSHOT/maven-Demo20200420-<span class="hljs-number">1.0</span>-SNAPSHOT.pom<br>[JENKINS] Archiving <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target<span class="hljs-regexp">/maven-Demo20200420.war to com.dzxy/m</span>aven-Demo20200420<span class="hljs-regexp">/1.0-SNAPSHOT/m</span>aven-Demo20200420-<span class="hljs-number">1.0</span>-SNAPSHOT.war<br>channel stopped<br>Finished: SUCCESS<br></code></pre></td></tr></table></figure><h4 id="6-3-4-编写自动上线脚本推送至web集群，最后通过浏览器访问（建议现在Jenkins里把脚本写好在服务器里写shell脚本）"><a href="#6-3-4-编写自动上线脚本推送至web集群，最后通过浏览器访问（建议现在Jenkins里把脚本写好在服务器里写shell脚本）" class="headerlink" title="6.3.4 编写自动上线脚本推送至web集群，最后通过浏览器访问（建议现在Jenkins里把脚本写好在服务器里写shell脚本）"></a>6.3.4 编写自动上线脚本推送至web集群，最后通过浏览器访问（建议现在Jenkins里把脚本写好在服务器里写shell脚本）</h4><h5 id="6-3-4-1-编写上线脚本"><a href="#6-3-4-1-编写上线脚本" class="headerlink" title="6.3.4.1 编写上线脚本"></a>6.3.4.1 编写上线脚本</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@jenkins-master:~# cd /data/scripts/<br>root@jenkins-master:/data/scripts# vim linux-java-web.sh<br><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><span class="hljs-meta">#</span><span class="bash">进入目录，将内容进项打包</span><br>cd /var/lib/jenkins/workspace/linux-hello-world/<br>unzip target/*.war -d /var/lib/jenkins/workspace/linux-hello-world/java-code<br>zip -r java-code.zip java-code/<br><span class="hljs-meta">#</span><span class="bash">通过scp拷贝到web集群组</span><br>scp java-code.zip www@10.0.0.105:/data/tomcat/tomcat_appdir/java-code.zip<br><span class="hljs-meta">#</span><span class="bash">关闭tomcat</span><br>ssh www@10.0.0.105 &quot;/etc/init.d/tomcat stop&quot;<br><span class="hljs-meta">#</span><span class="bash">删除旧的项目，并将新的包解压到tomcat里</span><br>ssh www@10.0.0.105 &quot;rm -rf /data/tomcat/tomcat_webdir/java-code &amp;&amp; unzip /data/tomcat/tomcat_appdir/java-code.zip  -d /data/tomcat/tomcat_webdir/ &amp;&amp; rm -rf  /data/tomcat/tomcat_webapps/myapp &amp;&amp; ln -sv  /data/tomcat/tomcat_webdir/java-code /data/tomcat/tomcat_webapps/myapp&quot;<br><span class="hljs-meta">#</span><span class="bash">打开tomcat</span><br>ssh www@10.0.0.105 &quot;/etc/init.d/tomcat start&quot;<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another169.png"></p><p>注意：</p><ol><li>如果安装的tomcat，并且没有修改过tomcat的conf/server.xml里的 ” &lt;Host name=”localhost”  appBase=”/data/tomcat/webapps”<pre><code>        unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot; “ 这一行的话可以直接将编译好的war包直接复制到webapps文件夹下，并改名为ROOT.war，最后直接重启tomcat即可</code></pre></li><li>如果安装的tomcat，将修改过tomcat的conf/server.xml里的 ” &lt;Host name=”localhost”  appBase=”/data/tomcat/webapps”<pre><code>        unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot; “  修改为 ” &lt;Host name=&quot;localhost&quot;  appBase=&quot;/data/tomcat/tomcat_webapps&quot;        unpackWARs=&quot;false&quot; autoDeploy=&quot;false&quot; “ 的话就要将war包解压后做软连接到/data/tomcat/tomcat_webapps文件夹里（即上面的shell脚本类似），最后直接重启tomcat即可</code></pre></li></ol><h5 id="6-3-4-2-执行构建"><a href="#6-3-4-2-执行构建" class="headerlink" title="6.3.4.2 执行构建"></a>6.3.4.2 执行构建</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs bash">Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace /var/lib/jenkins/workspace/linux-hello-world<br>[WS-CLEANUP] Deleting project workspace...<br>[WS-CLEANUP] Deferred wipeout is used...<br>[WS-CLEANUP] Done<br>The recommended git tool is: NONE<br>using credential 73b70b5b-b09c-46fd-8790-3a0eebf2b12c<br>Cloning the remote Git repository<br>Cloning repository git@10.0.0.101:linux/linux-java-web1.git<br> &gt; git init /var/lib/jenkins/workspace/linux-hello-world <span class="hljs-comment"># timeout=10</span><br>Fetching upstream changes from git@10.0.0.101:linux/linux-java-web1.git<br> &gt; git --version <span class="hljs-comment"># timeout=10</span><br> &gt; git --version <span class="hljs-comment"># &#x27;git version 2.17.1&#x27;</span><br>using GIT_SSH to <span class="hljs-built_in">set</span> credentials <br> &gt; git fetch --tags --progress -- git@10.0.0.101:linux/linux-java-web1.git +refs/heads/*:refs/remotes/origin/* <span class="hljs-comment"># timeout=10</span><br> &gt; git config remote.origin.url git@10.0.0.101:linux/linux-java-web1.git <span class="hljs-comment"># timeout=10</span><br> &gt; git config --add remote.origin.fetch +refs/heads/*:refs/remotes/origin/* <span class="hljs-comment"># timeout=10</span><br>Avoid second fetch<br> &gt; git rev-parse refs/remotes/origin/master^&#123;commit&#125; <span class="hljs-comment"># timeout=10</span><br>Checking out Revision 1acbfb5592e4f6d88319852f1cc75555f16c823c (refs/remotes/origin/master)<br> &gt; git config core.sparsecheckout <span class="hljs-comment"># timeout=10</span><br> &gt; git checkout -f 1acbfb5592e4f6d88319852f1cc75555f16c823c <span class="hljs-comment"># timeout=10</span><br>Commit message: <span class="hljs-string">&quot;v4&quot;</span><br> &gt; git rev-list --no-walk 1acbfb5592e4f6d88319852f1cc75555f16c823c <span class="hljs-comment"># timeout=10</span><br>Parsing POMs<br>Established TCP socket on 29786<br>[linux-hello-world] $ /usr/<span class="hljs-built_in">local</span>/jdk/bin/java -cp /var/lib/jenkins/plugins/maven-plugin/WEB-INF/lib/maven35-agent-1.13.jar:/usr/<span class="hljs-built_in">local</span>/maven/boot/plexus-classworlds-2.6.0.jar:/usr/<span class="hljs-built_in">local</span>/maven/conf/logging jenkins.maven3.agent.Maven35Main /usr/<span class="hljs-built_in">local</span>/maven /var/cache/jenkins/war/WEB-INF/lib/remoting-4.2.1.jar /var/lib/jenkins/plugins/maven-plugin/WEB-INF/lib/maven35-interceptor-1.13.jar /var/lib/jenkins/plugins/maven-plugin/WEB-INF/lib/maven3-interceptor-commons-1.13.jar 29786<br>&lt;===[JENKINS REMOTING CAPACITY]===&gt;channel started<br>Executing Maven:  -B -f /var/lib/jenkins/workspace/linux-hello-world/pom.xml package -Dmaven.test.skip=<span class="hljs-literal">true</span><br>[[1;33mWARNING[m] <br>[[1;33mWARNING[m] Some problems were encountered <span class="hljs-keyword">while</span> building the effective settings<br>[[1;33mWARNING[m] Unrecognised tag: <span class="hljs-string">&#x27;mirrors&#x27;</span> (position: START_TAG seen ...&lt;/mirror&gt;\r\n     --&gt;\r\n\r\n&lt;mirrors&gt;... @160:10)  @ /usr/<span class="hljs-built_in">local</span>/src/apache-maven-3.6.3/conf/settings.xml, line 160, column 10<br>[[1;33mWARNING[m] <br>[INFO] Scanning <span class="hljs-keyword">for</span> projects...<br>[INFO] <br>[INFO] --------------------&lt; com.dzxy:maven-Demo20200420 &gt;---------------------<br>[INFO] Building maven-Demo20200420 Maven Webapp 1.0-SNAPSHOT<br>[INFO] --------------------------------[ war ]---------------------------------<br>[INFO] <br>[INFO] --- maven-resources-plugin:3.0.2:resources (default-resources) @ maven-Demo20200420 ---<br>[INFO] Using <span class="hljs-string">&#x27;UTF-8&#x27;</span> encoding to copy filtered resources.<br>[INFO] skip non existing resourceDirectory /var/lib/jenkins/workspace/linux-hello-world/src/main/resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:3.8.0:compile (default-compile) @ maven-Demo20200420 ---<br>[INFO] No sources to compile<br>[INFO] <br>[INFO] --- maven-resources-plugin:3.0.2:testResources (default-testResources) @ maven-Demo20200420 ---<br>[INFO] Not copying <span class="hljs-built_in">test</span> resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:3.8.0:testCompile (default-testCompile) @ maven-Demo20200420 ---<br>[INFO] Not compiling <span class="hljs-built_in">test</span> sources<br>[INFO] <br>[INFO] --- maven-surefire-plugin:2.22.1:<span class="hljs-built_in">test</span> (default-test) @ maven-Demo20200420 ---<br>[INFO] Tests are skipped.<br>[INFO] <br>[INFO] --- maven-war-plugin:3.2.2:war (default-war) @ maven-Demo20200420 ---<br>[INFO] Packaging webapp<br>[INFO] Assembling webapp [maven-Demo20200420] <span class="hljs-keyword">in</span> [/var/lib/jenkins/workspace/linux-hello-world/target/maven-Demo20200420]<br>[INFO] Processing war project<br>[INFO] Copying webapp resources [/var/lib/jenkins/workspace/linux-hello-world/src/main/webapp]<br>[INFO] Webapp assembled <span class="hljs-keyword">in</span> [11 msecs]<br>[INFO] Building war: /var/lib/jenkins/workspace/linux-hello-world/target/maven-Demo20200420.war<br>[INFO] ------------------------------------------------------------------------<br>[INFO] BUILD SUCCESS<br>[INFO] ------------------------------------------------------------------------<br>[INFO] Total time:  2.062 s<br>[INFO] Finished at: 2021-05-29T16:54:38+08:00<br>[INFO] ------------------------------------------------------------------------<br>Waiting <span class="hljs-keyword">for</span> Jenkins to finish collecting data<br>[JENKINS] Archiving /var/lib/jenkins/workspace/linux-hello-world/pom.xml to com.dzxy/maven-Demo20200420/1.0-SNAPSHOT/maven-Demo20200420-1.0-SNAPSHOT.pom<br>[JENKINS] Archiving /var/lib/jenkins/workspace/linux-hello-world/target/maven-Demo20200420.war to com.dzxy/maven-Demo20200420/1.0-SNAPSHOT/maven-Demo20200420-1.0-SNAPSHOT.war<br>[linux-hello-world] $ /bin/sh -xe /tmp/jenkins4386105400150637079.sh<br>channel stopped<br>+ bash /data/scripts/linux-java-web.sh<br>Archive:  target/maven-Demo20200420.war<br>  inflating: /var/lib/jenkins/workspace/linux-hello-world/java-code/META-INF/MANIFEST.MF  <br>   creating: /var/lib/jenkins/workspace/linux-hello-world/java-code/WEB-INF/<br>   creating: /var/lib/jenkins/workspace/linux-hello-world/java-code/WEB-INF/classes/<br>  inflating: /var/lib/jenkins/workspace/linux-hello-world/java-code/index.jsp  <br>  inflating: /var/lib/jenkins/workspace/linux-hello-world/java-code/WEB-INF/web.xml  <br>  inflating: /var/lib/jenkins/workspace/linux-hello-world/java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.xml  <br>  inflating: /var/lib/jenkins/workspace/linux-hello-world/java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.properties  <br>  adding: java-code/ (stored 0%)<br>  adding: java-code/WEB-INF/ (stored 0%)<br>  adding: java-code/WEB-INF/classes/ (stored 0%)<br>  adding: java-code/WEB-INF/web.xml (deflated 24%)<br>  adding: java-code/index.jsp (deflated 19%)<br>  adding: java-code/META-INF/ (stored 0%)<br>  adding: java-code/META-INF/MANIFEST.MF (deflated 7%)<br>  adding: java-code/META-INF/maven/ (stored 0%)<br>  adding: java-code/META-INF/maven/com.dzxy/ (stored 0%)<br>  adding: java-code/META-INF/maven/com.dzxy/maven-Demo20200420/ (stored 0%)<br>  adding: java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.xml (deflated 64%)<br>  adding: java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.properties (deflated 1%)<br>正在判断服务状态，请稍等3秒钟！<br>3<br>2<br>1<br>Tomcat运行中，1秒后关闭！<br>1<br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br>3<br>2<br>1<br>Tomcat 已经关闭完成！<br>3<br>2<br>1<br>Archive:  /data/tomcat/tomcat_appdir/java-code.zip<br>   creating: /data/tomcat/tomcat_webdir/java-code/<br>   creating: /data/tomcat/tomcat_webdir/java-code/WEB-INF/<br>   creating: /data/tomcat/tomcat_webdir/java-code/WEB-INF/classes/<br>  inflating: /data/tomcat/tomcat_webdir/java-code/WEB-INF/web.xml  <br>  inflating: /data/tomcat/tomcat_webdir/java-code/index.jsp  <br>   creating: /data/tomcat/tomcat_webdir/java-code/META-INF/<br>  inflating: /data/tomcat/tomcat_webdir/java-code/META-INF/MANIFEST.MF  <br>   creating: /data/tomcat/tomcat_webdir/java-code/META-INF/maven/<br>   creating: /data/tomcat/tomcat_webdir/java-code/META-INF/maven/com.dzxy/<br>   creating: /data/tomcat/tomcat_webdir/java-code/META-INF/maven/com.dzxy/maven-Demo20200420/<br>  inflating: /data/tomcat/tomcat_webdir/java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.xml  <br>  inflating: /data/tomcat/tomcat_webdir/java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.properties  <br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/java-code&#x27;</span><br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为6434<br>Finished: SUCCESS <span class="hljs-comment">#&lt;--执行成功</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another170.png"></p><h4 id="6-3-5-优化部署脚本，使其支持代码质量测试"><a href="#6-3-5-优化部署脚本，使其支持代码质量测试" class="headerlink" title="6.3.5 优化部署脚本，使其支持代码质量测试"></a>6.3.5 优化部署脚本，使其支持代码质量测试</h4><h5 id="6-3-5-1-直接使用maven里的sonar进行代码质量测试"><a href="#6-3-5-1-直接使用maven里的sonar进行代码质量测试" class="headerlink" title="6.3.5.1 直接使用maven里的sonar进行代码质量测试"></a>6.3.5.1 直接使用maven里的sonar进行代码质量测试</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cd /data/git/linux-java-web1/</span><br><span class="hljs-comment">#方法一：</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># mvn sonar:sonar \</span><br>-Dsonar.host.username=admin \<br>-Dsonar.host.password=admin \<br>-Dsonar.host.url=http://10.0.0.108:9000<br><br><span class="hljs-comment">#方法二：</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># mvn sonar:sonar \</span><br>-Dsonar.host.url=http://10.0.0.108:9000 \<br>-Dsonar.login=bc8c43a55d1752dba0edb11cfa374b6195074125 <span class="hljs-comment">#这个为账号的token</span><br><span class="hljs-comment">#-Dsonar.java.binaries=target/sonar</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another171.png"></p><h5 id="6-3-5-2-使用sonar插件进项代码测试"><a href="#6-3-5-2-使用sonar插件进项代码测试" class="headerlink" title="6.3.5.2 使用sonar插件进项代码测试"></a>6.3.5.2 使用sonar插件进项代码测试</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cd /data/git/linux-java-web1/</span><br><span class="hljs-comment">#方法一：</span><br><span class="hljs-comment">#只使用于项目中又target文件的java代码</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># vim sonar-project.properties</span><br><span class="hljs-comment"># Required metadata</span><br>sonar.projectKey=java-hello-world<br>sonar.projectName=java-hello-world<br>sonar.projectVersion=1.0<br><br><span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>sonar.sources=src<br><br><span class="hljs-comment"># Language</span><br>sonar.language=java<br><br><span class="hljs-comment"># Encoding of the source files</span><br>sonar.sourceEncoding=UTF-8<br><br>sonar.java.binaries=target/classes<br><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span><br><br><span class="hljs-comment">#方法二：</span><br><span class="hljs-comment">#使用于所有的java项目</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># /usr/local/sonar-scanner/bin/sonar-scanner \</span><br>-Dsonar.projectKey=项目名 \<br>-Dsonar.sources=. <br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another172.png"></p><h5 id="6-3-5-3-重新编写脚本使其支持代码质量测试"><a href="#6-3-5-3-重新编写脚本使其支持代码质量测试" class="headerlink" title="6.3.5.3 重新编写脚本使其支持代码质量测试"></a>6.3.5.3 重新编写脚本使其支持代码质量测试</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#给java项目添加sonar-project.properties，并上传</span><br>root@web3:~<span class="hljs-comment"># cd /opt/source/</span><br>root@web3:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># cd linux-java-web1/</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># ls</span><br>LICENSE  pom.xml  README.en.md  README.md  src<br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># vim sonar-project.properties</span><br><span class="hljs-comment"># Required metadata</span><br>sonar.projectKey=java-hello-world<br>sonar.projectName=java-hello-world-web1<br>sonar.projectVersion=1.0<br><br><span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>sonar.sources=src<br><br><span class="hljs-comment"># Language</span><br>sonar.language=java<br><br><span class="hljs-comment"># Encoding of the source files</span><br>sonar.sourceEncoding=UTF-8<br><br>sonar.java.binaries=target/classes<br><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git add .</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git commit -m &quot;add sonar.properties&quot;</span><br>[master c1ed0a0] add sonar.properties<br> 1 file changed, 15 insertions(+)<br> create mode 100644 sonar-project.properties<br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git push</span><br>Username <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span>: rlin<br>Password <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://rlin@10.0.0.101&#x27;</span>: <br>Counting objects: 3, <span class="hljs-keyword">done</span>.<br>Compressing objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>Writing objects: 100% (3/3), 517 bytes | 517.00 KiB/s, <span class="hljs-keyword">done</span>.<br>Total 3 (delta 1), reused 0 (delta 0)<br>To http://10.0.0.101/linux/linux-java-web1.git<br>   1acbfb5..c1ed0a0  master -&gt; master<br><br>root@jenkins-master:~<span class="hljs-comment"># cd /data/scripts/</span><br>root@jenkins-master:/data/scripts<span class="hljs-comment"># vim linux-java-web.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#进入目录</span><br><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-hello-world/<br><span class="hljs-comment">#扫描代码</span><br>/usr/<span class="hljs-built_in">local</span>/sonar-scanner/bin/sonar-scanner<br><span class="hljs-comment">#将代码打包</span><br>unzip target/*.war -d /var/lib/jenkins/workspace/linux-hello-world/java-code<br>zip -r java-code.zip java-code/<br><span class="hljs-comment">#通过scp拷贝到web集群组</span><br>scp java-code.zip www@10.0.0.105:/data/tomcat/tomcat_appdir/java-code.zip<br><span class="hljs-comment">#关闭tomcat</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><span class="hljs-comment">#删除旧的项目，并将新的包解压到tomcat里</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;rm -rf /data/tomcat/tomcat_webdir/java-code &amp;&amp; unzip /data/tomcat/tomcat_appdir/java-code.zip  -d /data/tomcat/tomcat_webdir/ &amp;&amp; rm -rf  /data/tomcat/tomcat_webapps/myapp &amp;&amp; ln -sv  /data/tomcat/tomcat_webdir/java-code /data/tomcat/tomcat_webapps/myapp&quot;</span><br><span class="hljs-comment">#打开tomcat</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure><h5 id="6-3-5-4-Jenkins立即构建"><a href="#6-3-5-4-Jenkins立即构建" class="headerlink" title="6.3.5.4 Jenkins立即构建"></a>6.3.5.4 Jenkins立即构建</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs awk">Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace/linux-hello-world<br>[WS-CLEANUP] Deleting project workspace...<br>[WS-CLEANUP] Deferred wipeout is used...<br>The recommended git tool is: NONE<br>using credential <span class="hljs-number">73</span>b70b5b-b09c-<span class="hljs-number">46</span>fd-<span class="hljs-number">8790</span>-<span class="hljs-number">3</span>a0eebf2b12c<br>Cloning the remote Git repository<br>Cloning repository git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git<br> &gt; git init <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace/linux-hello-world <span class="hljs-comment"># timeout=10</span><br>Fetching upstream changes from git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git<br> &gt; git --version <span class="hljs-comment"># timeout=10</span><br> &gt; git --version <span class="hljs-comment"># &#x27;git version 2.17.1&#x27;</span><br>using GIT_SSH to set credentials <br> &gt; git fetch --tags --progress -- git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux<span class="hljs-regexp">/linux-java-web1.git +refs/</span>heads<span class="hljs-regexp">/*:refs/</span>remotes<span class="hljs-regexp">/origin/</span>* <span class="hljs-comment"># timeout=10</span><br> &gt; git config remote.origin.url git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git <span class="hljs-comment"># timeout=10</span><br> &gt; git config --add remote.origin.fetch +refs<span class="hljs-regexp">/heads/</span>*:refs<span class="hljs-regexp">/remotes/</span>origin/* <span class="hljs-comment"># timeout=10</span><br>Avoid second fetch<br> &gt; git rev-parse refs<span class="hljs-regexp">/remotes/</span>origin/master^&#123;commit&#125; <span class="hljs-comment"># timeout=10</span><br>Checking out Revision c1ed0a0d6918d7ab1bb02d440e8074154bfa2b55 (refs<span class="hljs-regexp">/remotes/</span>origin/master)<br> &gt; git config core.sparsecheckout <span class="hljs-comment"># timeout=10</span><br> &gt; git checkout -f c1ed0a0d6918d7ab1bb02d440e8074154bfa2b55 <span class="hljs-comment"># timeout=10</span><br>Commit message: <span class="hljs-string">&quot;add sonar.properties&quot;</span><br> &gt; git rev-list --no-walk <span class="hljs-number">1</span>acbfb5592e4f6d88319852f1cc75555f16c823c <span class="hljs-comment"># timeout=10</span><br>Parsing POMs<br>Established TCP socket on <span class="hljs-number">36870</span><br>[linux-hello-world] $ <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/jdk/</span>bin<span class="hljs-regexp">/java -cp /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/maven35-agent-1.13.jar:/u</span>sr<span class="hljs-regexp">/local/m</span>aven<span class="hljs-regexp">/boot/</span>plexus-classworlds-<span class="hljs-number">2.6</span>.<span class="hljs-number">0</span>.jar:<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/maven/</span>conf<span class="hljs-regexp">/logging jenkins.maven3.agent.Maven35Main /u</span>sr<span class="hljs-regexp">/local/m</span>aven <span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/jenkins/</span>war<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/remoting-4.2.1.jar /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/maven35-interceptor-1.13.jar /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib/maven3-interceptor-commons-<span class="hljs-number">1.13</span>.jar <span class="hljs-number">36870</span><br>&lt;===[JENKINS REMOTING CAPACITY]===&gt;channel started<br>Executing Maven:  -B -f <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>pom.xml package -Dmaven.test.skip=true<br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] <br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] Some problems were encountered <span class="hljs-keyword">while</span> building the effective settings<br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] Unrecognised tag: <span class="hljs-string">&#x27;mirrors&#x27;</span> (position: START_TAG seen ...&lt;<span class="hljs-regexp">/mirror&gt;\r\n     --&gt;\r\n\r\n&lt;mirrors&gt;... @160:10)  @ /u</span>sr<span class="hljs-regexp">/local/</span>src<span class="hljs-regexp">/apache-maven-3.6.3/</span>conf/settings.xml, line <span class="hljs-number">160</span>, column <span class="hljs-number">10</span><br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] <br>[INFO] Scanning <span class="hljs-keyword">for</span> projects...<br>[INFO] <br>[INFO] --------------------&lt; com.dzxy:maven-Demo20200420 &gt;---------------------<br>[INFO] Building maven-Demo20200420 Maven Webapp <span class="hljs-number">1.0</span>-SNAPSHOT<br>[INFO] --------------------------------[ war ]---------------------------------<br>[INFO] <br>[INFO] --- maven-resources-plugin:<span class="hljs-number">3.0</span>.<span class="hljs-number">2</span>:resources (default-resources) @ maven-Demo20200420 ---<br>[INFO] Using <span class="hljs-string">&#x27;UTF-8&#x27;</span> encoding to copy filtered resources.<br>[INFO] skip non existing resourceDirectory <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>src<span class="hljs-regexp">/main/</span>resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:<span class="hljs-number">3.8</span>.<span class="hljs-number">0</span>:compile (default-compile) @ maven-Demo20200420 ---<br>[INFO] No sources to compile<br>[INFO] <br>[INFO] --- maven-resources-plugin:<span class="hljs-number">3.0</span>.<span class="hljs-number">2</span>:testResources (default-testResources) @ maven-Demo20200420 ---<br>[INFO] Not copying test resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:<span class="hljs-number">3.8</span>.<span class="hljs-number">0</span>:testCompile (default-testCompile) @ maven-Demo20200420 ---<br>[INFO] Not compiling test sources<br>[INFO] <br>[INFO] --- maven-surefire-plugin:<span class="hljs-number">2.22</span>.<span class="hljs-number">1</span>:test (default-test) @ maven-Demo20200420 ---<br>[INFO] Tests are skipped.<br>[INFO] <br>[INFO] --- maven-war-plugin:<span class="hljs-number">3.2</span>.<span class="hljs-number">2</span>:war (default-war) @ maven-Demo20200420 ---<br>[INFO] Packaging webapp<br>[INFO] Assembling webapp [maven-Demo20200420] <span class="hljs-keyword">in</span> [<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target/maven-Demo20200420]<br>[INFO] Processing war project<br>[INFO] Copying webapp resources [<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>src<span class="hljs-regexp">/main/</span>webapp]<br>[INFO] Webapp assembled <span class="hljs-keyword">in</span> [<span class="hljs-number">33</span> msecs]<br>[INFO] Building war: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target/maven-Demo20200420.war<br>[INFO] ------------------------------------------------------------------------<br>[INFO] BUILD SUCCESS<br>[INFO] ------------------------------------------------------------------------<br>[INFO] Total time:  <span class="hljs-number">2.220</span> s<br>[INFO] Finished at: <span class="hljs-number">2021</span>-<span class="hljs-number">05</span>-<span class="hljs-number">29</span>T21:<span class="hljs-number">50</span>:<span class="hljs-number">22</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span><br>[INFO] ------------------------------------------------------------------------<br>Waiting <span class="hljs-keyword">for</span> Jenkins to finish collecting data<br>[JENKINS] Archiving <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>pom.xml to com.dzxy<span class="hljs-regexp">/maven-Demo20200420/</span><span class="hljs-number">1.0</span>-SNAPSHOT/maven-Demo20200420-<span class="hljs-number">1.0</span>-SNAPSHOT.pom<br>[JENKINS] Archiving <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target<span class="hljs-regexp">/maven-Demo20200420.war to com.dzxy/m</span>aven-Demo20200420<span class="hljs-regexp">/1.0-SNAPSHOT/m</span>aven-Demo20200420-<span class="hljs-number">1.0</span>-SNAPSHOT.war<br>channel stopped<br>[linux-hello-world] $ <span class="hljs-regexp">/bin/</span>sh -xe <span class="hljs-regexp">/tmp/</span>jenkins9009198800243516851.sh<br>+ bash <span class="hljs-regexp">/data/</span>scripts/linux-java-web.sh<br>INFO: Scanner configuration file: <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/src/</span>sonar-scanner-<span class="hljs-number">4.3</span>.<span class="hljs-number">0.2102</span>-linux<span class="hljs-regexp">/conf/</span>sonar-scanner.properties<br>INFO: Project root configuration file: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>sonar-project.properties<br>INFO: SonarScanner <span class="hljs-number">4.3</span>.<span class="hljs-number">0.2102</span><br>INFO: Java <span class="hljs-number">11.0</span>.<span class="hljs-number">3</span> AdoptOpenJDK (<span class="hljs-number">64</span>-bit)<br>INFO: Linux <span class="hljs-number">4.15</span>.<span class="hljs-number">0</span>-<span class="hljs-number">55</span>-generic amd64<br>INFO: User cache: <span class="hljs-regexp">/root/</span>.sonar/cache<br>INFO: Scanner configuration file: <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/src/</span>sonar-scanner-<span class="hljs-number">4.3</span>.<span class="hljs-number">0.2102</span>-linux<span class="hljs-regexp">/conf/</span>sonar-scanner.properties<br>INFO: Project root configuration file: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>sonar-project.properties<br>INFO: Analyzing on SonarQube server <span class="hljs-number">7.9</span>.<span class="hljs-number">2</span><br>INFO: Default locale: <span class="hljs-string">&quot;en_US&quot;</span>, source code encoding: <span class="hljs-string">&quot;UTF-8&quot;</span><br>INFO: Load global settings<br>INFO: Load global settings (done) | time=<span class="hljs-number">36</span>ms<br>INFO: Server id: <span class="hljs-number">9</span>A84A96E-AXl6fM6ITuzQthHv-dgM<br>INFO: User cache: <span class="hljs-regexp">/root/</span>.sonar/cache<br>INFO: Load/download plugins<br>INFO: Load plugins index<br>INFO: Load plugins index (done) | time=<span class="hljs-number">25</span>ms<br>INFO: Plugin [l10nzh] defines <span class="hljs-string">&#x27;l10nen&#x27;</span> as base plugin. This metadata can be removed from manifest of l10n plugins since version <span class="hljs-number">5.2</span>.<br>INFO: Load/download plugins (done) | time=<span class="hljs-number">58</span>ms<br>INFO: Process project properties<br>INFO: Execute project builders<br>INFO: Execute project builders (done) | time=<span class="hljs-number">2</span>ms<br>INFO: Project key: java-hello-world<br>INFO: Base dir: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace/linux-hello-world<br>INFO: Working dir: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>.scannerwork<br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;java-hello-world&#x27;</span><br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;java-hello-world&#x27;</span> (done) | time=<span class="hljs-number">219</span>ms<br>INFO: Load quality profiles<br>INFO: Load quality profiles (done) | time=<span class="hljs-number">160</span>ms<br>INFO: Detected Jenkins<br>INFO: Load active rules<br>INFO: Load active rules (done) | time=<span class="hljs-number">2310</span>ms<br>INFO: Indexing files...<br>INFO: Project configuration:<br>INFO: <span class="hljs-number">2</span> files indexed<br>INFO: <span class="hljs-number">0</span> files ignored because of scm ignore settings<br>INFO: Quality profile <span class="hljs-keyword">for</span> jsp: Sonar way<br>INFO: Quality profile <span class="hljs-keyword">for</span> xml: Sonar way<br>INFO: ------------- Run sensors on module java-hello-world-web1<br>INFO: Load metrics repository<br>INFO: Load metrics repository (done) | time=<span class="hljs-number">13</span>ms<br>WARNING: An illegal reflective access operation has occurred<br>WARNING: Illegal reflective access by net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span> (file:<span class="hljs-regexp">/root/</span>.sonar<span class="hljs-regexp">/cache/</span><span class="hljs-number">866</span>bb1adbf016ea515620f1aaa15ec53/sonar-javascript-plugin.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain)<br>WARNING: Please consider reporting this to the maintainers of net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span><br>WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations<br>WARNING: All illegal access operations will be denied <span class="hljs-keyword">in</span> a future release<br>INFO: Sensor JaCoCo XML Report Importer [jacoco]<br>INFO: Sensor JaCoCo XML Report Importer [jacoco] (done) | time=<span class="hljs-number">1</span>ms<br>INFO: Sensor JavaXmlSensor [java]<br>INFO: <span class="hljs-number">1</span> source files to be analyzed<br>INFO: Load project repositories<br>INFO: Load project repositories (done) | time=<span class="hljs-number">10</span>ms<br>INFO: Sensor JavaXmlSensor [java] (done) | time=<span class="hljs-number">97</span>ms<br>INFO: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> source files have been analyzed<br>INFO: Sensor HTML [web]<br>INFO: Sensor HTML [web] (done) | time=<span class="hljs-number">43</span>ms<br>INFO: Sensor XML Sensor [xml]<br>INFO: <span class="hljs-number">1</span> source files to be analyzed<br>INFO: Sensor XML Sensor [xml] (done) | time=<span class="hljs-number">70</span>ms<br>INFO: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> source files have been analyzed<br>INFO: ------------- Run sensors on project<br>INFO: Sensor Zero Coverage Sensor<br>INFO: Sensor Zero Coverage Sensor (done) | time=<span class="hljs-number">1</span>ms<br>INFO: <span class="hljs-number">1</span> file had no CPD blocks<br>INFO: Calculating CPD <span class="hljs-keyword">for</span> <span class="hljs-number">0</span> files<br>INFO: CPD calculation finished<br>INFO: Analysis report generated <span class="hljs-keyword">in</span> <span class="hljs-number">45</span>ms, dir size=<span class="hljs-number">73</span> KB<br>INFO: Analysis report compressed <span class="hljs-keyword">in</span> <span class="hljs-number">7</span>ms, zip size=<span class="hljs-number">11</span> KB<br>INFO: Analysis report uploaded <span class="hljs-keyword">in</span> <span class="hljs-number">67</span>ms<br>INFO: ANALYSIS SUCCESSFUL, you can browse http:<span class="hljs-regexp">//</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.108</span>:<span class="hljs-number">9000</span>/dashboard?id=java-hello-world<br>INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report<br>INFO: More about the report processing at http:<span class="hljs-regexp">//</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.108</span>:<span class="hljs-number">9000</span><span class="hljs-regexp">/api/</span>ce/task?id=AXm4Y_ATHdpxPqjYNDnf<br>INFO: Analysis total time: <span class="hljs-number">4.232</span> s<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION SUCCESS<br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: <span class="hljs-number">4.831</span>s<br>INFO: Final Memory: <span class="hljs-number">12</span>M/<span class="hljs-number">44</span>M<br>INFO: ------------------------------------------------------------------------<br>Archive:  target/maven-Demo20200420.war<br>  inflating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/META-INF/</span>MANIFEST.MF  <br>   creating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/WEB-INF/</span><br>   creating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/WEB-INF/</span>classes/<br>  inflating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/WEB-INF/</span>web.xml  <br>  inflating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code/index.jsp  <br>  inflating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.properties  <br>  inflating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.xml  <br>  adding: java-code/ (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/WEB-INF/</span> (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/WEB-INF/</span>classes/ (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/WEB-INF/</span>web.xml (deflated <span class="hljs-number">24</span>%)<br>  adding: java-code/index.jsp (deflated <span class="hljs-number">19</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/</span> (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/</span>MANIFEST.MF (deflated <span class="hljs-number">7</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/m</span>aven/ (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/</span> (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/ (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.xml (deflated <span class="hljs-number">64</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.properties (deflated <span class="hljs-number">1</span>%)<br>正在判断服务状态，请稍等<span class="hljs-number">3</span>秒钟！<br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br>Tomcat运行中，<span class="hljs-number">1</span>秒后关闭！<br><span class="hljs-number">1</span><br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等<span class="hljs-number">5</span>秒钟！<br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br>Tomcat 已经关闭完成！<br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br>Archive:  <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_appdir/</span>java-code.zip<br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code/<br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/WEB-INF/</span><br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/WEB-INF/</span>classes/<br>  inflating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/WEB-INF/</span>web.xml  <br>  inflating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code/index.jsp  <br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/</span><br>  inflating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/</span>MANIFEST.MF  <br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven/<br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/</span><br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/<br>  inflating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.xml  <br>  inflating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.properties  <br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/java-code&#x27;</span><br>正在判断服务状态，请稍等！<br>请稍等<span class="hljs-number">3</span>秒钟<br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br>Tomcat没有运行，<span class="hljs-number">1</span>秒后启动！<br><span class="hljs-number">1</span><br>Tomcat started.<br>Tomcat 已经成功启动完成,<span class="hljs-number">5</span>秒后判断是否启动成功<br><span class="hljs-number">5</span><br><span class="hljs-number">4</span><br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br>Tomcat 已经成功启动<span class="hljs-number">1</span> 个Tomcat进程!,PID为<span class="hljs-number">7694</span><br>Finished: SUCCES<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another173.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another174.png"></p><h5 id="6-3-5-5-jenkins里使用maven插件进项代码扫描"><a href="#6-3-5-5-jenkins里使用maven插件进项代码扫描" class="headerlink" title="6.3.5.5 jenkins里使用maven插件进项代码扫描"></a>6.3.5.5 jenkins里使用maven插件进项代码扫描</h5><p>Jenkins–&gt;项目–&gt;Pre Steps–&gt;调用顶层Maven目标</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another175.png"></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">#目标内容<br>#方法一：<br>clean<br>verify<br>sonar:sonar<br>-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>host.username=admin<br>-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>host.password=admin<br>-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>host.url=http:<span class="hljs-comment">//10.0.0.108:9000</span><br><br>#方法二：<br>clean<br>verify<br>sonar:sonar<br>-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>host.url=http:<span class="hljs-comment">//10.0.0.108:9000</span><br>-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>login=bc8c43a55d1752dba0edb11cfa374b6195074125 #这个为账号的token<br>#-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>java.binaries=target/sonar<br></code></pre></td></tr></table></figure><h3 id="6-4-CMS建站系统自动发布"><a href="#6-4-CMS建站系统自动发布" class="headerlink" title="6.4 CMS建站系统自动发布"></a>6.4 CMS建站系统自动发布</h3><p>略</p><h3 id="6-5-ZRLOG博客系统自动发布"><a href="#6-5-ZRLOG博客系统自动发布" class="headerlink" title="6.5 ZRLOG博客系统自动发布"></a>6.5 ZRLOG博客系统自动发布</h3><p>略</p><h2 id="七、Jenkins集成钉钉"><a href="#七、Jenkins集成钉钉" class="headerlink" title="七、Jenkins集成钉钉"></a>七、Jenkins集成钉钉</h2><h3 id="7-1-Jenkins集成钉钉概述"><a href="#7-1-Jenkins集成钉钉概述" class="headerlink" title="7.1 Jenkins集成钉钉概述"></a>7.1 Jenkins集成钉钉概述</h3><h4 id="7-1-1Jenkins为什么要又通知？"><a href="#7-1-1Jenkins为什么要又通知？" class="headerlink" title="7.1.1Jenkins为什么要又通知？"></a>7.1.1Jenkins为什么要又通知？</h4><p>Jenkins 进行自动化部署代码后，项目发布的成功或失败，都没没有相应的通知，运维人员无法及时发现项目的部署情况，需要认为查看，比较麻烦。所以考虑项目部署后通过钉钉的方式将结果发送到钉钉的群聊中</p><h4 id="7-1-2-使用钉钉推送消息的优势"><a href="#7-1-2-使用钉钉推送消息的优势" class="headerlink" title="7.1.2 使用钉钉推送消息的优势"></a>7.1.2 使用钉钉推送消息的优势</h4><ol><li><h5 id="实现简单"><a href="#实现简单" class="headerlink" title="实现简单"></a>实现简单</h5></li><li><p>实时提醒</p></li><li><p>便于查看</p></li></ol><h4 id="7-1-3为什么不使用邮件通知，而使用钉钉通知？"><a href="#7-1-3为什么不使用邮件通知，而使用钉钉通知？" class="headerlink" title="7.1.3为什么不使用邮件通知，而使用钉钉通知？"></a>7.1.3为什么不使用邮件通知，而使用钉钉通知？</h4><ol><li>邮件配置复杂</li><li>邮件容易拒收</li></ol><h3 id="7-2-钉钉配置发消息机器人"><a href="#7-2-钉钉配置发消息机器人" class="headerlink" title="7.2 钉钉配置发消息机器人"></a>7.2 钉钉配置发消息机器人</h3><h4 id="7-2-1-创建钉钉群机器人"><a href="#7-2-1-创建钉钉群机器人" class="headerlink" title="7.2.1 创建钉钉群机器人"></a>7.2.1 创建钉钉群机器人</h4><p>打开钉钉群组，点击群机器人。（如果不是群主，且群主开启了仅群主可管理，anemic将无法创建机器人）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another176.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another177.png"></p><h4 id="7-2-2-添加一个自定义机器人"><a href="#7-2-2-添加一个自定义机器人" class="headerlink" title="7.2.2 添加一个自定义机器人"></a>7.2.2 添加一个自定义机器人</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another178.png"></p><h4 id="7-2-3-修改机器人名称，以及机器人的名字"><a href="#7-2-3-修改机器人名称，以及机器人的名字" class="headerlink" title="7.2.3 修改机器人名称，以及机器人的名字"></a>7.2.3 修改机器人名称，以及机器人的名字</h4><p>（安全设置自己设定）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another179.png"></p><h4 id="7-2-4-机器人修改成功后，会给出一个webhook地址。（此处的webhook后续Jenkins需要使用）"><a href="#7-2-4-机器人修改成功后，会给出一个webhook地址。（此处的webhook后续Jenkins需要使用）" class="headerlink" title="7.2.4 机器人修改成功后，会给出一个webhook地址。（此处的webhook后续Jenkins需要使用）"></a>7.2.4 机器人修改成功后，会给出一个webhook地址。（此处的webhook后续Jenkins需要使用）</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another180.png"></p><h3 id="7-3-Jenkins集成钉钉消息"><a href="#7-3-Jenkins集成钉钉消息" class="headerlink" title="7.3 Jenkins集成钉钉消息"></a>7.3 Jenkins集成钉钉消息</h3><h4 id="7-3-1-Jenkins安装钉钉插件"><a href="#7-3-1-Jenkins安装钉钉插件" class="headerlink" title="7.3.1 Jenkins安装钉钉插件"></a>7.3.1 Jenkins安装钉钉插件</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another181.png"></p><h4 id="7-3-2-项目配置钉钉"><a href="#7-3-2-项目配置钉钉" class="headerlink" title="7.3.2 项目配置钉钉"></a>7.3.2 项目配置钉钉</h4><p>jenkins–&gt;系统配置–&gt;钉钉–&gt;配置名称，webhook，安全策略（配置后进行测试）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another182.png"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another183.png" alt="测试结构"></p><p>Jenkins–&gt;项目–&gt;配置–&gt;General–&gt;顶i的那个配置</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another184.png"></p><h4 id="7-3-3-进行构建测试"><a href="#7-3-3-进行构建测试" class="headerlink" title="7.3.3 进行构建测试"></a>7.3.3 进行构建测试</h4><p>项目开始构建通知</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another185.png"></p><p>项目构建后通知</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another186.png" alt="项目成功构建通知"></p>]]></content>
    
    
    
    <tags>
      
      <tag>Linux Jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>企业级堡垒机JumpServer</title>
    <link href="/blog/2021/03/12/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%A0%A1%E5%9E%92%E6%9C%BAJumpServer/"/>
    <url>/blog/2021/03/12/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%A0%A1%E5%9E%92%E6%9C%BAJumpServer/</url>
    
    <content type="html"><![CDATA[<h1 id="企业级堡垒机-JumpServer"><a href="#企业级堡垒机-JumpServer" class="headerlink" title="企业级堡垒机 JumpServer"></a>企业级堡垒机 JumpServer</h1><h2 id="一、堡垒机和-JumpServer"><a href="#一、堡垒机和-JumpServer" class="headerlink" title="一、堡垒机和 JumpServer"></a>一、堡垒机和 JumpServer</h2><h3 id="1-1-跳板机和堡垒机"><a href="#1-1-跳板机和堡垒机" class="headerlink" title="1.1 跳板机和堡垒机"></a>1.1 跳板机和堡垒机</h3><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">跳板机<br>属于内控堡垒机范畴，是一种用于单点登陆的主机应用系统。跳板机就是一台服务器，维护人员在维护过程<br>中，首先要统一登录到这台服务器上，然后从这台服务器再登录到目标设备进行维护。但跳板机没有实现对运<br>维人员操作行为的控制和审计，此外，跳板机存在严重的安全风险，一旦跳板机系统被攻入，则将后端资源风<br>险完全暴露无遗。对于个别资源（如telnet）可以通过跳板机来完成一定的内控，但是对于更多更特殊的资源（<span class="hljs-keyword">ftp</span>、rdp等）来讲，就显得力不从心了。<br><br>堡垒机<br>在之前的发展过程中，人们逐渐认识到跳板机的不足，需要更新、更好的安全技术理念来实现运维操作管理。<br>堡垒机开始以独立的产品形态被广泛部署，有效降低了运维操作风险，使得运维操作管理变得更简单、更安<br>全。能满足角色管理与授权审批、信息资源访问控制、操作记录和审计、系统变更和维护控制要求，并生成一<br>些统计报表配合管理规范，来不断提升IT内控的合规性的产品。<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer1.jpg"></p><h3 id="1-2-JumpServer-简介"><a href="#1-2-JumpServer-简介" class="headerlink" title="1.2 JumpServer 简介"></a>1.2 JumpServer 简介</h3><p>JumpServer 是全球首款完全开源的堡垒机, 使用 GNU GPL v2.0 开源协议, 是符合 4A 的专业运维审计系统。为互联网企业提供了认证，授权，审计，自动化运维等功能。</p><p>JumpServer 使用 Python / Django 进行开发, 遵循 Web 2.0 规范, 配备了业界领先的 Web Terminal 解决方案, 交互界面美观、用户体验好。</p><p>JumpServer 采纳分布式架构, 支持多机房跨区域部署, 中心节点提供 API, 各机房部署登录节点, 可横向扩展、无并发访问限制。</p><p>JumpServer 现已支持管理 SSH、 Telnet、 RDP、 VNC 协议资产。</p><p><strong>JumpServer 历史</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer2.jpg"></p><p>官方地址： <a href="http://www.jumpserver.org/">http://www.jumpserver.org/</a><br>github项目: <a href="https://github.com/jumpserver">https://github.com/jumpserver</a></p><h3 id="1-3-JumpServer的优势和功能"><a href="#1-3-JumpServer的优势和功能" class="headerlink" title="1.3 JumpServer的优势和功能"></a>1.3 JumpServer的优势和功能</h3><h4 id="1-3-1-特色优势"><a href="#1-3-1-特色优势" class="headerlink" title="1.3.1 特色优势"></a>1.3.1 特色优势</h4><ul><li>开源: 零门槛，线上快速获取和安装；</li><li>分布式: 轻松支持大规模并发访问；</li><li>无插件: 仅需浏览器，极致的 Web Terminal 使用体验；</li><li>多云支持: 一套系统，同时管理不同云上面的资产；</li><li>云端存储: 审计录像云端存储，永不丢失；</li><li>多租户: 一套系统，多个子公司和部门同时使用。</li></ul><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer3.jpg"></p><h4 id="1-3-2-功能列表"><a href="#1-3-2-功能列表" class="headerlink" title="1.3.2 功能列表"></a>1.3.2 功能列表</h4><p>堡垒机四个核心能力: 运维安全审计的4A规范</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer4.jpg"></p><table><thead><tr><th align="center">身份认证 Authentication</th><th>登录认证</th><th>资源统一登录与认证</th></tr></thead><tbody><tr><td align="center">LDAP/AD 认证</td><td></td><td></td></tr><tr><td align="center">RADIUS 认证</td><td></td><td></td></tr><tr><td align="center">OpenID 认证（实现单点登录)</td><td></td><td></td></tr><tr><td align="center">CAS 认证 （实现单点登录）</td><td></td><td></td></tr><tr><td align="center">MFA认证</td><td>MFA 二次认证（GoogleAuthenticator）</td><td></td></tr><tr><td align="center">RADIUS 二次认证</td><td></td><td></td></tr><tr><td align="center">登录复核（X-PACK）</td><td>用户登录行为受管理员的监管与控制</td><td></td></tr><tr><td align="center">账号管理 Account</td><td>集中账号</td><td>管理用户管理</td></tr><tr><td align="center">系统用户管理</td><td></td><td></td></tr><tr><td align="center">统一密码</td><td>资产密码托管</td><td></td></tr><tr><td align="center">自动生成密码</td><td></td><td></td></tr><tr><td align="center">自动推送密码</td><td></td><td></td></tr><tr><td align="center">密码过期设置</td><td></td><td></td></tr><tr><td align="center">批量改密（X-PACK）</td><td>定期批量改密</td><td></td></tr><tr><td align="center">多种密码策略</td><td></td><td></td></tr><tr><td align="center">多云纳管（X-PACK）</td><td>对私有云、公有云资产自动统一纳管</td><td></td></tr><tr><td align="center">收集用户（X-PACK）</td><td>自定义任务定期收集主机用户</td><td></td></tr><tr><td align="center">密码匣子（X-PACK）</td><td>统一对资产主机的用户密码进行查看、更新、测试操作</td><td></td></tr><tr><td align="center">授权控制 Authorization</td><td>多维授权</td><td>对用户、用户组、资产、资产节点、应用以及系统用户进行授权</td></tr><tr><td align="center">资产授权</td><td>资产以树状结构进行展示</td><td></td></tr><tr><td align="center">资产和节点均可灵活授权</td><td></td><td></td></tr><tr><td align="center">节点内资产自动继承授权</td><td></td><td></td></tr><tr><td align="center">子节点自动继承父节点授权</td><td></td><td></td></tr><tr><td align="center">应用授权</td><td>实现更细粒度的应用级授<br/>权</td><td></td></tr></tbody></table><table><thead><tr><th>身份认证 Authentication</th><th align="center">登录认证</th><th>资源统一登录与认证</th></tr></thead><tbody><tr><td>MySQL 数据库应用、RemoteApp 远程应用（X-PACK）</td><td align="center"></td><td></td></tr><tr><td>动作授权</td><td align="center">实现对授权资产的文件上传、下载以及连接动作的控制</td><td></td></tr><tr><td>时间授权</td><td align="center">实现对授权资源使用时间段的限制</td><td></td></tr><tr><td>特权指令</td><td align="center">实现对特权指令的使用（支持黑白名单）</td><td></td></tr><tr><td>命令过滤</td><td align="center">实现对授权系统用户所执行的命令进行控制</td><td></td></tr><tr><td>文件传输</td><td align="center">SFTP 文件上传/下载</td><td></td></tr><tr><td>文件管理</td><td align="center">实现 Web SFTP 文件管理</td><td></td></tr><tr><td>工单管理（X-PACK）</td><td align="center">支持对用户登录请求行为进行控制</td><td></td></tr><tr><td>组织管理（X-PACK）</td><td align="center">实现多租户管理与权限隔离</td><td></td></tr><tr><td>安全审计 Audit</td><td align="center">操作审计</td><td>用户操作行为审计</td></tr><tr><td>会话审计</td><td align="center">在线会话内容审计</td><td></td></tr><tr><td>历史会话内容审计</td><td align="center"></td><td></td></tr><tr><td>录像审计</td><td align="center">支持对 Linux、Windows等资产操作的录像进行回放审计</td><td></td></tr><tr><td>支持对 RemoteApp（X-PACK）、MySQL 等应用操作的录像进行回放审计</td><td align="center"></td><td></td></tr><tr><td>指令审计</td><td align="center">支持对资产和应用等操作的命令进行审计</td><td></td></tr><tr><td>文件传输</td><td align="center">可对文件的上传、下载记录进行审计</td><td></td></tr></tbody></table><h3 id="1-4-JumpServer-组成"><a href="#1-4-JumpServer-组成" class="headerlink" title="1.4 JumpServer 组成"></a>1.4 JumpServer 组成</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer5.jpg"></p><h2 id="二、安装-JumpServer"><a href="#二、安装-JumpServer" class="headerlink" title="二、安装 JumpServer"></a>二、安装 JumpServer</h2><h3 id="2-1-安装要求"><a href="#2-1-安装要求" class="headerlink" title="2.1 安装要求"></a>2.1 安装要求</h3><p>JumpServer 环境要求:</p><ul><li>硬件配置: 2个CPU核心, 4G 内存, 50G 硬盘（最低）</li><li>操作系统: Linux 发行版 x86_64</li><li>Python = 3.6.x</li><li>Mysql Server ≥ 5.6 或者 Mariadb Server ≥ 5.5.56 数据库编码要求 uft8</li><li>Redis</li></ul><h3 id="2-2-安装方法介绍"><a href="#2-2-安装方法介绍" class="headerlink" title="2.2 安装方法介绍"></a>2.2 安装方法介绍</h3><p>官方提供了多种安装方法</p><ul><li>手动部署: 一步一步实现</li><li>极速部署: 资产数量不多，或者测试体验的用户请使用本脚本快速部署</li><li>容器部署: 基于docker 实现</li><li>分布式部署: 适用大型环境</li></ul><h3 id="2-3-基于容器部署"><a href="#2-3-基于容器部署" class="headerlink" title="2.3 基于容器部署"></a>2.3 基于容器部署</h3><p>官方文档:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>docs.jumpserver.org<span class="hljs-regexp">/zh/m</span>aster<span class="hljs-regexp">/install/</span>docker_install/<br></code></pre></td></tr></table></figure><h4 id="2-3-1-环境说明"><a href="#2-3-1-环境说明" class="headerlink" title="2.3.1 环境说明"></a>2.3.1 环境说明</h4><p><strong>外置数据库要求</strong></p><ul><li>mysql 版本需要大于等于 5.6</li><li>mariadb 版本需要大于等于 5.5.6</li><li>数据库编码要求 uft8</li></ul><p><strong>基于容器,安装完毕后可以通过以下方式访问</strong></p><ul><li>浏览器访问: http://&lt;容器所在服务器IP&gt;</li><li>默认管理员账户 admin 密码 admin</li><li>SSH 访问: ssh -p 2222 &lt;容器所在服务器IP&gt;</li><li>XShell 等工具请添加 connection 连接, 默认 ssh 端口 2222</li></ul><p>2.3.2 安装 MySQL 服务<br>官方说明:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>docs.jumpserver.org<span class="hljs-regexp">/zh/m</span>aster<span class="hljs-regexp">/install/</span>prod<span class="hljs-regexp">/distributed_03/</span><br></code></pre></td></tr></table></figure><h5 id="2-3-2-1-下载-MySQL-镜像查看默认配置"><a href="#2-3-2-1-下载-MySQL-镜像查看默认配置" class="headerlink" title="2.3.2.1 下载 MySQL 镜像查看默认配置"></a>2.3.2.1 下载 MySQL 镜像查看默认配置</h5><p>下载MySQL镜像并运行, 查看当前默认配置不符合JumpServer安装要求</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先安装docker</span><br><span class="hljs-comment">#下载MySQL镜像并启动</span><br>[root@centos8 ~]<span class="hljs-comment">#docker run --rm --name mysql -e MYSQL_ROOT_PASSWORD=123456 -e MYSQL_DATABASE=jumpserver -e MYSQL_USER=jumpserver -e MYSQL_PASSWORD=123456 -d -p 3306:3306 mysql:5.7.30</span><br>Unable to find image <span class="hljs-string">&#x27;mysql:5.7.30&#x27;</span> locally<br>5.7.30: Pulling from library/mysql<br>8559a31e96f4: Pull complete <br>d51ce1c2e575: Pull complete <br>c2344adc4858: Pull complete <br>fcf3ceff18fc: Pull complete <br>16da0c38dc5b: Pull complete <br>b905d1797e97: Pull complete <br>4b50d1c6b05c: Pull complete <br>d85174a87144: Pull complete <br>a4ad33703fa8: Pull complete <br>f7a5433ce20d: Pull complete <br>3dcd2a278b4a: Pull complete <br>Digest: sha256:32f9d9a069f7a735e28fd44ea944d53c61f990ba71460c5c183e610854ca4854<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> mysql:5.7.30<br>f9d98b5cff6064bf08db2f734ae5afbe83c40c49456376e3564adf2d5bf3e53d<br><br><span class="hljs-comment">#查看默认的MySQL容器配置不符合jumpserver要求</span><br>[root@centos8 ~]<span class="hljs-comment">#docker exec -it mysql bash</span><br>root@f44e1c85f088:/<span class="hljs-comment"># mysql -uroot -p123456</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor. Commands end with ; or \g.<br>Your MySQL connection id is 2<br>Server version: 5.7.30 MySQL Community Server (GPL)<br><br>Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; show create database jumpserver;<br>+------------+------------------------------------------------------------------<br>-----+<br>| Database  | Create Database                         <br>  |<br>+------------+------------------------------------------------------------------<br>-----+<br>| jumpserver | CREATE DATABASE `jumpserver` /*!40100 DEFAULT CHARACTER SET<br>latin1 */ |<br>+------------+------------------------------------------------------------------<br>-----+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br><br>mysql&gt; select user,host from mysql.user;<br>+---------------+-----------+<br>| user     | host   |<br>+---------------+-----------+<br>| jumpserver  | %     |<br>| root     | %     |<br>| mysql.session | localhost |<br>| mysql.sys   | localhost |<br>| root     | localhost |<br>+---------------+-----------+<br>5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br>mysql&gt; <span class="hljs-built_in">exit</span><br>Bye<br><br><span class="hljs-comment">#查看配置文件路径</span><br>root@f44e1c85f088:/<span class="hljs-comment"># cat /etc/mysql/mysql.cnf</span><br>......<br>!includedir /etc/mysql/conf.d/<br>!includedir /etc/mysql/mysql.conf.d/<br><br><span class="hljs-comment">#默认配置文件</span><br>root@f44e1c85f088:/<span class="hljs-comment"># tree /etc/mysql/</span><br>/etc/mysql/<br>|-- conf.d<br>|  |-- docker.cnf<br>|  |-- mysql.cnf<br>|  `-- mysqldump.cnf<br>|-- my.cnf -&gt; /etc/alternatives/my.cnf<br>|-- my.cnf.fallback<br>|-- mysql.cnf<br>`-- mysql.conf.d<br>  `-- mysqld.cnf<br>  <br>2 directories, 7 files<br>root@f44e1c85f088:/<span class="hljs-comment"># ls -R /etc/mysql</span><br>/etc/mysql:<br>conf.d my.cnf my.cnf.fallback mysql.cnf mysql.conf.d<br><br>/etc/mysql/conf.d:<br>docker.cnf mysql.cnf mysqldump.cnf<br><br>/etc/mysql/mysql.conf.d:<br>mysqld.cnf<br><br><span class="hljs-comment">#默认配置文件</span><br>root@f44e1c85f088:/<span class="hljs-comment"># grep &#x27;^[^#]&#x27; /etc/mysql/mysql.conf.d/mysqld.cnf</span><br>[mysqld]<br>pid-file = /var/run/mysqld/mysqld.pid<br>socket = /var/run/mysqld/mysqld.sock<br>datadir = /var/lib/mysql<br>symbolic-links=0<br><br><span class="hljs-comment">#默认配置文件</span><br>root@f44e1c85f088:/<span class="hljs-comment"># cat /etc/mysql/conf.d/mysql.cnf</span><br>[mysql]<br><br>root@f44e1c85f088:/<span class="hljs-comment"># exit</span><br><span class="hljs-built_in">exit</span><br>[root@centos8 ~]<span class="hljs-comment">#docker stop mysql</span><br></code></pre></td></tr></table></figure><h5 id="2-3-2-2-在宿主机准备MySQL配置文件"><a href="#2-3-2-2-在宿主机准备MySQL配置文件" class="headerlink" title="2.3.2.2 在宿主机准备MySQL配置文件"></a>2.3.2.2 在宿主机准备MySQL配置文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#准备相关目录</span><br>[root@centos8 ~]<span class="hljs-comment">#mkdir -p /etc/mysql/mysql.conf.d/</span><br>[root@centos8 ~]<span class="hljs-comment">#mkdir -p /etc/mysql/conf.d/</span><br><br><span class="hljs-comment">#生成配置文件,指定字符集</span><br>[root@centos8 ~]<span class="hljs-comment">#tee /etc/mysql/mysql.conf.d/mysqld.cnf &lt;&lt;EOF</span><br>[mysqld]<br>pid-file=/var/run/mysqld/mysqld.pid<br>socket=/var/run/mysqld/mysqld.sock<br>datadir=/var/lib/mysql<br>symbolic-links=0<br>character-set-server=utf8  <span class="hljs-comment">#添加此行,指定字符集</span><br>EOF<br><br><span class="hljs-comment">#生成配置文件,指定字符集</span><br>[root@centos8 ~]<span class="hljs-comment">#tee /etc/mysql/conf.d/mysql.cnf &lt;&lt;EOF</span><br>[mysql]<br>default-character-set=utf8  <span class="hljs-comment">#添加此行,指定字符集</span><br>EOF<br><br><span class="hljs-comment">#查看配置文件列表</span><br>[root@centos8 ~]<span class="hljs-comment">#tree /etc/mysql/</span><br>/etc/mysql/<br>├── conf.d<br>│  └── mysql.cnf<br>└── mysql.conf.d<br> └── mysqld.cnf<br> <br>2 directories, 2 files<br></code></pre></td></tr></table></figure><h5 id="2-3-2-3-启动-MySQL-容器"><a href="#2-3-2-3-启动-MySQL-容器" class="headerlink" title="2.3.2.3 启动 MySQL 容器"></a>2.3.2.3 启动 MySQL 容器</h5><p>将上面宿主机的设置好的配置文件挂载至MySQL容器（注意：生产环境需要复杂密码）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#docker run -d -p 3306:3306 --name mysql --restart always \</span><br>-e MYSQL_ROOT_PASSWORD=123456 \<br>-e MYSQL_DATABASE=jumpserver \<br>-e MYSQL_USER=jumpserver    \<br>-e MYSQL_PASSWORD=123456    \<br>-v /data/mysql:/var/lib/mysql  \<br>-v /etc/mysql/mysql.conf.d/mysqld.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf \<br>-v /etc/mysql/conf.d/mysql.cnf:/etc/mysql/conf.d/mysql.cnf mysql:5.7.30<br></code></pre></td></tr></table></figure><h5 id="2-3-2-4-验证-MySQL"><a href="#2-3-2-4-验证-MySQL" class="headerlink" title="2.3.2.4 验证 MySQL"></a>2.3.2.4 验证 MySQL</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#方法一</span><br>[root@centos8 ~]<span class="hljs-comment">#docker exec -it mysql sh</span><br><span class="hljs-comment"># mysql -p123456 -e &#x27;show variables like &quot;character%&quot;&#x27;</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>+--------------------------+----------------------------+<br>| Variable_name      | Value           |<br>+--------------------------+----------------------------+<br>| character_set_client   | utf8            |<br>| character_set_connection | utf8            |<br>| character_set_database  | utf8            |<br>| character_set_filesystem | binary           |<br>| character_set_results  | utf8            |<br>| character_set_server   | utf8            |<br>| character_set_system   | utf8            |<br>| character_sets_dir    | /usr/share/mysql/charsets/ |<br>+--------------------------+----------------------------+<br><span class="hljs-comment"># mysql -p123456 -e &#x27;show variables like &quot;collation%&quot;&#x27;             </span><br>    <br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>+----------------------+-----------------+<br>| Variable_name    | Value      |<br>+----------------------+-----------------+<br>| collation_connection | utf8_general_ci |<br>| collation_database  | utf8_general_ci |<br>| collation_server   | utf8_general_ci |<br>+----------------------+-----------------+<br><br><span class="hljs-comment"># cat /var/lib/mysql/jumpserver/db.opt</span><br>default-character-set=utf8<br>default-collation=utf8_general_ci<br><span class="hljs-comment"># cat /etc/mysql/mysql.conf.d/mysqld.cnf</span><br>[mysqld]<br>pid-file= /var/run/mysqld/mysqld.pid<br>socket= /var/run/mysqld/mysqld.sock<br>datadir= /var/lib/mysql<br>symbolic-links=0<br>character-set-server=utf8<br><span class="hljs-comment"># cat /etc/mysql/conf.d/mysql.cnf</span><br>[mysql]<br>default-character-set=utf8<br><span class="hljs-comment"># mysql -p123456 -e &#x27;select user,host from mysql.user&#x27;</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>+---------------+-----------+<br>| user          | host      |<br>+---------------+-----------+<br>| jumpserver    | %         |<br>| root          | %         |<br>| mysql.session | localhost |<br>| mysql.sys     | localhost |<br>| root          | localhost |<br>+---------------+-----------+<br><br><span class="hljs-comment"># mysql -p123456 -e &#x27;select user,host from mysql.user&#x27;</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>+---------------+-----------+<br>| user          | host      |<br>+---------------+-----------+<br>| jumpserver    | %         |<br>| root          | %         |<br>| mysql.session | localhost |<br>| mysql.sys     | localhost |<br>| root          | localhost |<br>+---------------+-----------+<br><span class="hljs-comment"># ls /var/lib/mysql/ -l</span><br>total 188484<br>-rw-r----- 1 mysql mysql    56 Aug 16 08:43 auto.cnf<br>-rw------- 1 mysql mysql   1680 Aug 16 08:43 ca-key.pem<br>-rw-r--r-- 1 mysql mysql   1112 Aug 16 08:43 ca.pem<br>-rw-r--r-- 1 mysql mysql   1112 Aug 16 08:43 client-cert.pem<br>-rw------- 1 mysql mysql   1676 Aug 16 08:43 client-key.pem<br>-rw-r----- 1 mysql mysql   1346 Aug 16 08:43 ib_buffer_pool<br>-rw-r----- 1 mysql mysql 50331648 Aug 16 08:43 ib_logfile0<br>-rw-r----- 1 mysql mysql 50331648 Aug 16 08:43 ib_logfile1<br>-rw-r----- 1 mysql mysql 79691776 Aug 16 08:43 ibdata1<br>-rw-r----- 1 mysql mysql 12582912 Aug 16 08:43 ibtmp1<br>drwxr-x--- 2 mysql mysql    20 Aug 16 08:43 jumpserver<br>drwxr-x--- 2 mysql mysql   4096 Aug 16 08:43 mysql<br>drwxr-x--- 2 mysql mysql   8192 Aug 16 08:43 performance_schema<br>-rw------- 1 mysql mysql   1676 Aug 16 08:43 private_key.pem<br>-rw-r--r-- 1 mysql mysql    452 Aug 16 08:43 public_key.pem<br>-rw-r--r-- 1 mysql mysql   1112 Aug 16 08:43 server-cert.pem<br>-rw------- 1 mysql mysql   1676 Aug 16 08:43 server-key.pem<br>drwxr-x--- 2 mysql mysql   8192 Aug 16 08:43 sys<br><br>[root@centos8 ~]<span class="hljs-comment">#ls /data/mysql/</span><br>auto.cnf  client-cert.pem ibdata1   ibtmp1   performance_schema<br>server-cert.pem<br>ca-key.pem client-key.pem  ib_logfile0 jumpserver private_key.pem  <br>server-key.pem<br>ca.pem   ib_buffer_pool  ib_logfile1 mysql    public_key.pem   sys<br><br><span class="hljs-comment">#方法二</span><br><span class="hljs-comment">#测试连接MySQL</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install mysql</span><br>root@ubuntu1804:~<span class="hljs-comment"># apt install mysql-client-core-5.7 -y</span><br>[root@centos7 ~]<span class="hljs-comment">#mysql -ujumpserver -p123456 -h10.0.0.8</span><br>Welcome to the MariaDB monitor. Commands end with ; or \g.<br>Your MySQL connection id is 8<br>Server version: 5.7.30 MySQL Community Server (GPL)<br><br>Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>MySQL [(none)]&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| jumpserver         |<br>+--------------------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>MySQL [(none)]&gt; use jumpserver;<br>Database changed<br>MySQL [jumpserver]&gt; show tables;<br>Empty <span class="hljs-built_in">set</span> (0.00 sec)<br><br></code></pre></td></tr></table></figure><h4 id="2-3-3-安装-redis-服务"><a href="#2-3-3-安装-redis-服务" class="headerlink" title="2.3.3 安装 redis 服务"></a>2.3.3 安装 redis 服务</h4><p>官方说明</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.jumpserver.org/zh/master/install/prod/distributed_04/<br></code></pre></td></tr></table></figure><h5 id="2-3-3-1-启动-redis"><a href="#2-3-3-1-启动-redis" class="headerlink" title="2.3.3.1 启动 redis"></a>2.3.3.1 启动 redis</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#docker run -d -p 6379:6379 --name redis --restart always redis:5.0.9</span><br><br>Unable to find image <span class="hljs-string">&#x27;redis:5.0.9&#x27;</span> locally<br>5.0.9: Pulling from library/redis<br>bb79b6b2107f: Pull complete <br>1ed3521a5dcb: Pull complete <br>5999b99cee8f: Pull complete <br>bfee6cb5fdad: Pull complete <br>fd36a1ebc672: Pull complete <br>97481c7992eb: Pull complete <br>Digest: sha256:2a9865e55c37293b71df051922022898d8e4ec0f579c9b53a0caee1b170bc81c<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> redis:5.0.9<br>8c0ef9dd29c09bc2a959b149b56a1893ca6f943fdc3db5b0256d80b4e2b2a01f<br><br></code></pre></td></tr></table></figure><h5 id="2-3-3-2-验证-redis连接"><a href="#2-3-3-2-验证-redis连接" class="headerlink" title="2.3.3.2 验证 redis连接"></a>2.3.3.2 验证 redis连接</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#yum -y install redis</span><br>[root@centos7 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.8</span><br>10.0.0.8:6379&gt; info<br><span class="hljs-comment"># Server</span><br>redis_version:5.0.9<br>redis_git_sha1:00000000<br>redis_git_dirty:0<br></code></pre></td></tr></table></figure><h4 id="2-3-4-部署-JumpServer"><a href="#2-3-4-部署-JumpServer" class="headerlink" title="2.3.4 部署 JumpServer"></a>2.3.4 部署 JumpServer</h4><h5 id="2-3-4-1-生成-key-和-token"><a href="#2-3-4-1-生成-key-和-token" class="headerlink" title="2.3.4.1 生成 key 和 token"></a>2.3.4.1 生成 key 和 token</h5><p>参考官方说明: <a href="https://docs.jumpserver.org/zh/master/install/docker_install/">https://docs.jumpserver.org/zh/master/install/docker_install/</a></p><p>需要先生成 key 和 token</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer6.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim key.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-keyword">if</span> [ ! <span class="hljs-string">&quot;<span class="hljs-variable">$SECRET_KEY</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>SECRET_KEY=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 50`;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;SECRET_KEY=<span class="hljs-variable">$SECRET_KEY</span>&quot;</span> &gt;&gt; ~/.bashrc;<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$SECRET_KEY</span>;<br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$SECRET_KEY</span>;<br><span class="hljs-keyword">fi</span> <br><span class="hljs-keyword">if</span> [ ! <span class="hljs-string">&quot;<span class="hljs-variable">$BOOTSTRAP_TOKEN</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>BOOTSTRAP_TOKEN=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 16`;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;BOOTSTRAP_TOKEN=<span class="hljs-variable">$BOOTSTRAP_TOKEN</span>&quot;</span> &gt;&gt; ~/.bashrc;<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$BOOTSTRAP_TOKEN</span>;<br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$BOOTSTRAP_TOKEN</span>;<br><span class="hljs-keyword">fi</span><br><br>[root@centos7 ~]<span class="hljs-comment">#bash key.sh</span><br><br>[root@centos7 ~]<span class="hljs-comment">#tail -n2 .bashrc</span><br>SECRET_KEY=9RTRBg3AjHjvUUNCUpHUH5LirSFazRozk1UyOQcoKkwMExeUEm<br>BOOTSTRAP_TOKEN=1OlaSdCoUpSQPjH6<br></code></pre></td></tr></table></figure><h5 id="2-3-4-2-运行容器"><a href="#2-3-4-2-运行容器" class="headerlink" title="2.3.4.2 运行容器"></a>2.3.4.2 运行容器</h5><p>范例: jumpserver 2.5.3版</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#docker run --name jms_all -d \</span><br>-v /opt/jumpserver/data:/opt/jumpserver/data \<br>-p 80:80 \<br>-p 2222:2222 \<br>--restart always \<br>-e SECRET_KEY=9RTRBg3AjHjvUUNCUpHUH5LirSFazRozk1UyOQcoKkwMExeUEm \<br>-e BOOTSTRAP_TOKEN=1OlaSdCoUpSQPjH6 \<br>-e DB_HOST=10.0.0.18 \  <span class="hljs-comment">#这里必须为mysql服务器地址</span><br>-e DB_PORT=3306 \<br>-e DB_USER=root \<br>-e DB_PASSWORD=123456 \<br>-e DB_NAME=jumpserver \<br>-e REDIS_HOST=10.0.0.18 \ <span class="hljs-comment">#如果所有东西都放在同一台服务器上这里可以是127.0.0.1，不然也是写安装redis的服务器地址</span><br>-e REDIS_PORT=6379 \<br>-e REDIS_PASSWORD=<span class="hljs-string">&#x27;&#x27;</span> \<br>--privileged=<span class="hljs-literal">true</span> \<br>jumpserver/jms_all:v2.5.3<br><br>Unable to find image <span class="hljs-string">&#x27;jumpserver/jms_all:v2.5.3&#x27;</span> locally<br>v2.5.3: Pulling from jumpserver/jms_all<br>2d473b07cdd5: Pull complete <br>eb360af8e881: Pull complete <br>3d760ba553e4: Pull complete <br>43cd78655795: Pull complete <br>790790002806: Pull complete <br>eca069b7f00b: Pull complete <br>Digest: sha256:40586bb03b009563882075f4f2d6bcc638005c7f0b8e05c0bfd88e1b5d9ba6d3<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> jumpserver/jms_all:v2.5.3<br>c677c812ccf9b1dd6846f92758eacdaca8c8978827076ef6868f5c7036776798<br><br><span class="hljs-comment">#初次启动容器需要等待一会儿才能完成</span><br></code></pre></td></tr></table></figure><p>范例: jumpserver 2.1.2版</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#docker run --name jms_all -d  -v /opt/jumpserver/data:/opt/jumpserver/data  -p 80:80  -p 2222:2222  -e SECRET_KEY=9RTRBg3AjHjvUUNCUpHUH5LirSFazRozk1UyOQcoKkwMExeUEm  -e BOOTSTRAP_TOKEN=1OlaSdCoUpSQPjH6  -e DB_HOST=10.0.0.8 -e DB_PORT=3306  -e DB_USER=root -e DB_PASSWORD=123456  -e DB_NAME=jumpserver  -e REDIS_HOST=10.0.0.8  -e REDIS_PORT=6379 -e REDIS_PASSWORD=&#x27;&#x27;  jumpserver/jms_all:v2.1.2</span><br></code></pre></td></tr></table></figure><h5 id="2-3-4-3-验证是否成功"><a href="#2-3-4-3-验证是否成功" class="headerlink" title="2.3.4.3 验证是否成功"></a>2.3.4.3 验证是否成功</h5><h6 id="2-3-4-3-1-查看日志"><a href="#2-3-4-3-1-查看日志" class="headerlink" title="2.3.4.3.1 查看日志"></a>2.3.4.3.1 查看日志</h6><p>范例: 查看jumpserver 2.5.3日志确认成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#docker logs -f jms_all</span><br>2020-12-08 15:35:31 Tue Dec  8 15:35:31 2020<br>2020-12-08 15:35:31 JumpServer version v2.5.3, more see<br>https://www.jumpserver.org<br>2020-12-08 15:35:31 Check database connection ...<br>users<br>[ ] 0001_initial<br>[ ] 0002_auto_20171225_1157_squashed_0019_auto_20190304_1459 (18 squashed<br>migrations)<br>[ ] 0020_auto_20190612_1825<br>[ ] 0021_auto_20190625_1104<br>[ ] 0022_auto_20190625_1105<br>[ ] 0023_auto_20190724_1525<br>[ ] 0024_auto_20191118_1612<br>[ ] 0025_auto_20200206_1216<br>[ ] 0026_auto_20200508_2105<br>[ ] 0027_auto_20200616_1503<br>[ ] 0028_auto_20200728_1805<br>[ ] 0029_auto_20200814_1650<br>[ ] 0030_auto_20200819_2041<br>2020-12-08 15:35:37 Database connect success<br>2020-12-08 15:35:37 Check database structure change ...<br>2020-12-08 15:35:37 Migrate model change to database ...<br>Operations to perform:<br>Apply all migrations: admin, applications, assets, audits, auth,<br>authentication, captcha, common, contenttypes, django_cas_ng,<br>django_celery_beat, jms_oidc_rp, ops, orgs, perms, sessions, settings, terminal,<br>tickets, users<br>Running migrations:<br>Applying contenttypes.0001_initial... OK<br>Applying contenttypes.0002_remove_content_type_name... OK<br>Applying auth.0001_initial... OK<br>Applying auth.0002_alter_permission_name_max_length... OK<br>Applying auth.0003_alter_user_email_max_length... OK<br>Applying auth.0004_alter_user_username_opts... OK<br>Applying auth.0005_alter_user_last_login_null... OK<br>Applying auth.0006_require_contenttypes_0002... OK<br>Applying auth.0007_alter_validators_add_error_messages... OK<br>Applying auth.0008_alter_user_username_max_length... OK<br>Applying users.0001_initial... OK<br>Applying admin.0001_initial... OK<br>Applying admin.0002_logentry_remove_auto_add... OK<br>Applying admin.0003_logentry_add_action_flag_choices... OK<br>Applying assets.0001_initial... OK<br>Applying assets.0002_auto_20180105_1807_squashed_0009_auto_20180307_1212... OK<br>Applying assets.0010_auto_20180307_1749_squashed_0019_auto_20180816_1320... OK<br>Applying assets.0020_auto_20180816_1652... OK<br>Applying assets.0021_auto_20180903_1132... OK<br>Applying assets.0022_auto_20181012_1717... OK<br>Applying assets.0023_auto_20181016_1650... OK<br>Applying assets.0024_auto_20181219_1614... OK<br>Applying assets.0025_auto_20190221_1902... OK<br>Applying assets.0026_auto_20190325_2035... OK<br>Applying assets.0027_auto_20190521_1703... OK<br>Applying assets.0028_protocol... OK<br>Applying assets.0029_auto_20190522_1114... OK<br>Applying assets.0030_auto_20190619_1135... OK<br>Applying assets.0031_auto_20190621_1332... OK<br>Applying assets.0032_auto_20190624_2108... OK<br>Applying assets.0033_auto_20190624_2108... OK<br>Applying assets.0034_auto_20190705_1348... OK<br>Applying assets.0035_auto_20190711_2018... OK<br>Applying assets.0036_auto_20190716_1535... OK<br>Applying assets.0037_auto_20190724_2002... OK<br>Applying assets.0038_auto_20190911_1634... OK<br>Applying assets.0039_authbook_is_active... OK<br>Applying assets.0040_auto_20190917_2056... OK<br>Applying assets.0041_gathereduser... OK<br>Applying assets.0042_favoriteasset... OK<br>Applying assets.0043_auto_20191114_1111... OK<br>Applying assets.0044_platform... OK<br>Applying assets.0045_auto_20191206_1607... OK<br>Applying assets.0046_auto_20191218_1705... OK<br>Applying assets.0047_assetuser... OK<br>Applying assets.0048_auto_20191230_1512... OK<br>Applying assets.0049_systemuser_sftp_root... OK<br>Applying assets.0050_auto_20200711_1740... OK<br>Applying assets.0051_auto_20200713_1143... OK<br>Applying assets.0052_auto_20200715_1535... OK<br>Applying assets.0053_auto_20200723_1232... OK<br>Applying assets.0054_auto_20200807_1032... OK<br>Applying assets.0055_auto_20200811_1845... OK<br>Applying assets.0056_auto_20200904_1751... OK<br>Applying assets.0057_fill_node_value_assets_amount_and_parent_key...<br><br>................................................................. OK<br>Applying users.0002_auto_20171225_1157_squashed_0019_auto_20190304_1459... OK<br>Applying perms.0001_initial... OK<br>Applying perms.0002_auto_20171228_0025_squashed_0009_auto_20180903_1132... OK<br>Applying perms.0003_action... OK<br>Applying perms.0004_assetpermission_actions... OK<br>Applying applications.0001_initial... OK<br>Applying perms.0005_auto_20190521_1619... OK<br>Applying perms.0006_auto_20190628_1921... OK<br>Applying perms.0007_remove_assetpermission_actions... OK<br>Applying perms.0008_auto_20190911_1907... OK<br>Applying perms.0009_remoteapppermission_system_users... OK<br>Applying applications.0002_remove_remoteapp_system_user... OK<br>Applying applications.0003_auto_20191210_1659... OK<br>Applying applications.0004_auto_20191218_1705... OK<br>Applying applications.0005_k8sapp... OK<br>Applying applications.0006_application... OK<br>Applying assets.0058_auto_20201023_1115... OK<br>Applying assets.0059_auto_20201027_1905... OK<br>Applying assets.0060_node_full_value...<br>- Start migrate node value <span class="hljs-keyword">if</span> has /<br>- Start migrate node full value<br>OK<br>Applying assets.0061_auto_20201116_1757... OK<br>Applying assets.0062_auto_20201117_1938... OK<br>Applying audits.0001_initial... OK<br>Applying audits.0002_ftplog_org_id... OK<br>Applying audits.0003_auto_20180816_1652... OK<br>Applying audits.0004_operatelog_passwordchangelog_userloginlog... OK<br>Applying audits.0005_auto_20190228_1715... OK<br>Applying audits.0006_auto_20190726_1753... OK<br>Applying audits.0007_auto_20191202_1010... OK<br>Applying audits.0008_auto_20200508_2105... OK<br>Applying audits.0009_auto_20200624_1654... OK<br>Applying audits.0010_auto_20200811_1122... OK<br>Applying auth.0009_alter_user_last_name_max_length... OK<br>Applying auth.0010_alter_group_name_max_length... OK<br>Applying auth.0011_update_proxy_permissions... OK<br>Applying authentication.0001_initial... OK<br>Applying authentication.0002_auto_20190729_1423... OK<br>Applying authentication.0003_loginconfirmsetting... OK<br>Applying authentication.0004_ssotoken... OK<br>Applying captcha.0001_initial... OK<br>Applying common.0001_initial... OK<br>Applying common.0002_auto_20180111_1407... OK<br>Applying common.0003_setting_category... OK<br>Applying common.0004_setting_encrypted... OK<br>Applying common.0005_auto_20190221_1902... OK<br>Applying common.0006_auto_20190304_1515... OK<br>Applying django_cas_ng.0001_initial... OK<br>Applying django_celery_beat.0001_initial... OK<br>Applying django_celery_beat.0002_auto_20161118_0346... OK<br>Applying django_celery_beat.0003_auto_20161209_0049... OK<br>Applying django_celery_beat.0004_auto_20170221_0000... OK<br>Applying django_celery_beat.0005_add_solarschedule_events_choices... OK<br>Applying django_celery_beat.0006_auto_20180322_0932... OK<br>Applying django_celery_beat.0007_auto_20180521_0826... OK<br>Applying django_celery_beat.0008_auto_20180914_1922... OK<br>Applying django_celery_beat.0006_auto_20180210_1226... OK<br>Applying django_celery_beat.0006_periodictask_priority... OK<br>Applying django_celery_beat.0009_periodictask_headers... OK<br>Applying django_celery_beat.0010_auto_20190429_0326... OK<br>Applying django_celery_beat.0011_auto_20190508_0153... OK<br>Applying django_celery_beat.0012_periodictask_expire_seconds... OK<br>Applying jms_oidc_rp.0001_initial... OK<br>Applying ops.0001_initial... OK<br>Applying ops.0002_celerytask... OK<br>Applying ops.0003_auto_20181207_1744... OK<br>Applying ops.0004_adhoc_run_as... OK<br>Applying ops.0005_auto_20181219_1807... OK<br>Applying ops.0006_auto_20190318_1023... OK<br>Applying ops.0007_auto_20190724_2002... OK<br>Applying ops.0008_auto_20190919_2100... OK<br>Applying ops.0009_auto_20191217_1713... OK<br>Applying ops.0010_auto_20191217_1758... OK<br>Applying ops.0011_auto_20200106_1534... OK<br>Applying ops.0012_auto_20200108_1659... OK<br>Applying ops.0013_auto_20200108_1706... OK<br>Applying ops.0014_auto_20200108_1749... OK<br>Applying ops.0015_auto_20200108_1809... OK<br>Applying ops.0016_commandexecution_org_id... OK<br>Applying ops.0017_auto_20200306_1747... OK<br>Applying ops.0018_auto_20200509_1434... OK<br>Applying orgs.0001_initial... OK<br>Applying orgs.0002_auto_20180903_1132... OK<br>Applying orgs.0003_auto_20190916_1057... OK<br>Applying orgs.0004_organizationmember... OK<br>Applying orgs.0005_auto_20200721_1937... OK<br>Applying orgs.0006_auto_20200721_1937... OK<br>Applying orgs.0007_auto_20200728_1805... OK<br>Applying orgs.0008_auto_20200819_2041... OK<br>Applying orgs.0009_auto_20201023_1628... OK<br>Applying users.0020_auto_20190612_1825... OK<br>Applying users.0021_auto_20190625_1104... OK<br>Applying users.0022_auto_20190625_1105... OK<br>Applying users.0023_auto_20190724_1525... OK<br>Applying users.0024_auto_20191118_1612... OK<br>Applying users.0025_auto_20200206_1216... OK<br>Applying users.0026_auto_20200508_2105... OK<br>Applying users.0027_auto_20200616_1503... OK<br>Applying users.0028_auto_20200728_1805... OK<br>Applying users.0029_auto_20200814_1650... OK<br>Applying users.0030_auto_20200819_2041... OK<br>Applying perms.0010_auto_20191218_1705... OK<br>Applying perms.0011_auto_20200721_1739... OK<br>Applying perms.0012_k8sapppermission... OK<br>2020-12-08 15:36:04 [node ERROR] Node parent node <span class="hljs-keyword">in</span> mapper: Default<br>Applying perms.0013_rebuildusertreetask_usergrantedmappingnode... OK<br>Applying perms.0014_build_users_perm_tree... OK<br>Applying perms.0015_auto_20200929_1728... OK<br>Applying perms.0016_applicationpermission... OK<br>Applying sessions.0001_initial... OK<br>Applying settings.0001_initial... OK<br>Applying terminal.0001_initial... OK<br>Applying terminal.0002_auto_20171228_0025_squashed_0009_auto_20180326_0957...<br>OK<br>Applying terminal.0010_auto_20180423_1140... OK<br>Applying terminal.0011_auto_20180807_1116... OK<br>Applying terminal.0012_auto_20180816_1652... OK<br>Applying terminal.0013_auto_20181123_1113... OK<br>Applying terminal.0014_auto_20181226_1441... OK<br>Applying terminal.0015_auto_20190923_1529... OK<br>Applying terminal.0016_commandstorage_replaystorage... OK<br>Applying terminal.0017_auto_20191125_0931... OK<br>Applying terminal.0018_auto_20191202_1010... OK<br>Applying terminal.0019_auto_20191206_1000... OK<br>Applying terminal.0020_auto_20191218_1721... OK<br>Applying terminal.0021_auto_20200213_1316... OK<br>Applying terminal.0022_session_is_success... OK<br>Applying terminal.0023_command_risk_level... OK<br>Applying terminal.0024_auto_20200715_1713... OK<br>Applying terminal.0025_auto_20200810_1735... OK<br>Applying terminal.0026_auto_20201027_1905... OK<br>Applying terminal.0027_auto_20201102_1651... OK<br>Applying terminal.0028_auto_20201110_1918... OK<br>Applying terminal.0029_auto_20201116_1757... OK<br>Applying tickets.0001_initial... OK<br>Applying tickets.0002_auto_20200728_1146... OK<br>Applying tickets.0003_auto_20200804_1551... OK<br>Applying tickets.0004_ticket_comment... OK<br>Applying tickets.0005_ticket_meta_confirmed_system_users... OK<br>Applying tickets.0006_auto_20201023_1628... OK<br>2020-12-08 15:36:06 Collect static files<br>2020-12-08 15:36:10 Collect static files <span class="hljs-keyword">done</span><br>Starting guacd: SUCCESS<br>guacd[89]: INFO: Guacamole proxy daemon (guacd) version 1.2.0 started<br>Tomcat started.<br>Jumpserver ALL v2.5.3<br>官网 http://www.jumpserver.org<br>文档 http://docs.jumpserver.org<br><br>进入容器命令 docker <span class="hljs-built_in">exec</span> -it jms_all /bin/bash<br></code></pre></td></tr></table></figure><p>范例: 查看 jumpserver 2.1.2版日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#docker logs -f jms_all</span><br>2020-08-16 17:40:00 Sun Aug 16 17:40:00 2020<br>2020-08-16 17:40:00 Jumpserver version v2.1.2, more see<br>https://www.jumpserver.org<br>2020-08-16 17:40:00 Check database connection ...<br>users<br>[ ] 0001_initial<br>[ ] 0002_auto_20171225_1157_squashed_0019_auto_20190304_1459 (18 squashed<br>migrations)<br>[ ] 0020_auto_20190612_1825<br>[ ] 0021_auto_20190625_1104<br>[ ] 0022_auto_20190625_1105<br>[ ] 0023_auto_20190724_1525<br>[ ] 0024_auto_20191118_1612<br>[ ] 0025_auto_20200206_1216<br>[ ] 0026_auto_20200508_2105<br>[ ] 0027_auto_20200616_1503<br>2020-08-16 17:40:06 Database connect success<br>2020-08-16 17:40:06 Check database structure change ...<br>2020-08-16 17:40:06 Migrate model change to database ...<br>Operations to perform:<br>Apply all migrations: admin, applications, assets, audits, auth,<br>authentication, captcha, common, contenttypes, django_cas_ng,<br>django_celery_beat, jms_oidc_rp, ops, orgs, perms, sessions, settings, terminal,<br>tickets, users<br>Running migrations:<br>Applying contenttypes.0001_initial... OK<br>Applying contenttypes.0002_remove_content_type_name... OK<br>Applying auth.0001_initial... OK<br>Applying auth.0002_alter_permission_name_max_length... OK<br>Applying auth.0003_alter_user_email_max_length... OK<br>Applying auth.0004_alter_user_username_opts... OK<br>Applying auth.0005_alter_user_last_login_null... OK<br>Applying auth.0006_require_contenttypes_0002... OK<br>Applying auth.0007_alter_validators_add_error_messages... OK<br>Applying auth.0008_alter_user_username_max_length... OK<br>Applying users.0001_initial... OK<br>Applying admin.0001_initial... OK<br>Applying admin.0002_logentry_remove_auto_add... OK<br>Applying admin.0003_logentry_add_action_flag_choices... OK<br>Applying users.0002_auto_20171225_1157_squashed_0019_auto_20190304_1459... OK<br>Applying assets.0001_initial... OK<br>Applying perms.0001_initial... OK<br>Applying assets.0002_auto_20180105_1807_squashed_0009_auto_20180307_1212... OK<br>Applying assets.0010_auto_20180307_1749_squashed_0019_auto_20180816_1320... OK<br>Applying perms.0002_auto_20171228_0025_squashed_0009_auto_20180903_1132... OK<br>Applying perms.0003_action... OK<br>Applying perms.0004_assetpermission_actions... OK<br>Applying assets.0020_auto_20180816_1652... OK<br>Applying assets.0021_auto_20180903_1132... OK<br>Applying assets.0022_auto_20181012_1717... OK<br>Applying assets.0023_auto_20181016_1650... OK<br>Applying assets.0024_auto_20181219_1614... OK<br>Applying assets.0025_auto_20190221_1902... OK<br>Applying assets.0026_auto_20190325_2035... OK<br>Applying applications.0001_initial... OK<br>Applying perms.0005_auto_20190521_1619... OK<br>Applying perms.0006_auto_20190628_1921... OK<br>Applying perms.0007_remove_assetpermission_actions... OK<br>Applying perms.0008_auto_20190911_1907... OK<br>Applying assets.0027_auto_20190521_1703... OK<br>Applying assets.0028_protocol... OK<br>Applying assets.0029_auto_20190522_1114... OK<br>Applying assets.0030_auto_20190619_1135... OK<br>Applying assets.0031_auto_20190621_1332... OK<br>Applying assets.0032_auto_20190624_2108... OK<br>Applying assets.0033_auto_20190624_2108... OK<br>Applying assets.0034_auto_20190705_1348... OK<br>Applying assets.0035_auto_20190711_2018... OK<br>Applying assets.0036_auto_20190716_1535... OK<br>Applying assets.0037_auto_20190724_2002... OK<br>Applying assets.0038_auto_20190911_1634... OK<br>Applying perms.0009_remoteapppermission_system_users... OK<br>Applying applications.0002_remove_remoteapp_system_user... OK<br>Applying applications.0003_auto_20191210_1659... OK<br>Applying applications.0004_auto_20191218_1705... OK<br>Applying assets.0039_authbook_is_active... OK<br>Applying assets.0040_auto_20190917_2056... OK<br>Applying assets.0041_gathereduser... OK<br>Applying assets.0042_favoriteasset... OK<br>Applying assets.0043_auto_20191114_1111... OK<br>Applying assets.0044_platform... OK<br>Applying assets.0045_auto_20191206_1607... OK<br>Applying assets.0046_auto_20191218_1705... OK<br>Applying assets.0047_assetuser... OK<br>Applying assets.0048_auto_20191230_1512... OK<br>Applying assets.0049_systemuser_sftp_root... OK<br>Applying assets.0050_auto_20200711_1740... OK<br>Applying assets.0051_auto_20200713_1143... OK<br>Applying assets.0052_auto_20200715_1535... OK<br>Applying audits.0001_initial... OK<br>Applying audits.0002_ftplog_org_id... OK<br>Applying audits.0003_auto_20180816_1652... OK<br>Applying audits.0004_operatelog_passwordchangelog_userloginlog... OK<br>Applying audits.0005_auto_20190228_1715... OK<br>Applying audits.0006_auto_20190726_1753... OK<br>Applying audits.0007_auto_20191202_1010... OK<br>Applying audits.0008_auto_20200508_2105... OK<br>Applying audits.0009_auto_20200624_1654... OK<br>Applying auth.0009_alter_user_last_name_max_length... OK<br>Applying auth.0010_alter_group_name_max_length... OK<br>Applying auth.0011_update_proxy_permissions... OK<br>Applying authentication.0001_initial... OK<br>Applying authentication.0002_auto_20190729_1423... OK<br>Applying authentication.0003_loginconfirmsetting... OK<br>Applying captcha.0001_initial... OK<br>Applying common.0001_initial... OK<br>Applying common.0002_auto_20180111_1407... OK<br>Applying common.0003_setting_category... OK<br>Applying common.0004_setting_encrypted... OK<br>Applying common.0005_auto_20190221_1902... OK<br>Applying common.0006_auto_20190304_1515... OK<br>Applying django_cas_ng.0001_initial... OK<br>Applying django_celery_beat.0001_initial... OK<br>Applying django_celery_beat.0002_auto_20161118_0346... OK<br>Applying django_celery_beat.0003_auto_20161209_0049... OK<br>Applying django_celery_beat.0004_auto_20170221_0000... OK<br>Applying<br>django_celery_beat.0005_add_solarschedule_events_choices_squashed_0009_merge_201<br>81012_1416... OK<br>Applying django_celery_beat.0006_periodictask_priority... OK<br>Applying jms_oidc_rp.0001_initial... OK<br>Applying ops.0001_initial... OK<br>Applying ops.0002_celerytask... OK<br>Applying ops.0003_auto_20181207_1744... OK<br>Applying ops.0004_adhoc_run_as... OK<br>Applying ops.0005_auto_20181219_1807... OK<br>Applying ops.0006_auto_20190318_1023... OK<br>Applying ops.0007_auto_20190724_2002... OK<br>Applying ops.0008_auto_20190919_2100... OK<br>Applying ops.0009_auto_20191217_1713... OK<br>Applying ops.0010_auto_20191217_1758... OK<br>Applying ops.0011_auto_20200106_1534... OK<br>Applying ops.0012_auto_20200108_1659... OK<br>Applying ops.0013_auto_20200108_1706... OK<br>Applying ops.0014_auto_20200108_1749... OK<br>Applying ops.0015_auto_20200108_1809... OK<br>Applying ops.0016_commandexecution_org_id... OK<br>Applying ops.0017_auto_20200306_1747... OK<br>Applying ops.0018_auto_20200509_1434... OK<br>Applying orgs.0001_initial... OK<br>Applying orgs.0002_auto_20180903_1132... OK<br>Applying orgs.0003_auto_20190916_1057... OK<br>Applying users.0020_auto_20190612_1825... OK<br>Applying users.0021_auto_20190625_1104... OK<br>Applying users.0022_auto_20190625_1105... OK<br>Applying users.0023_auto_20190724_1525... OK<br>Applying users.0024_auto_20191118_1612... OK<br>Applying perms.0010_auto_20191218_1705... OK<br>Applying sessions.0001_initial... OK<br>Applying settings.0001_initial... OK<br>Applying terminal.0001_initial... OK<br>Applying terminal.0002_auto_20171228_0025_squashed_0009_auto_20180326_0957...<br>OK<br>Applying terminal.0010_auto_20180423_1140... OK<br>Applying terminal.0011_auto_20180807_1116... OK<br>Applying terminal.0012_auto_20180816_1652... OK<br>Applying terminal.0013_auto_20181123_1113... OK<br>Applying terminal.0014_auto_20181226_1441... OK<br>Applying terminal.0015_auto_20190923_1529... OK<br>Applying terminal.0016_commandstorage_replaystorage... OK<br>Applying terminal.0017_auto_20191125_0931... OK<br>Applying terminal.0018_auto_20191202_1010... OK<br>Applying terminal.0019_auto_20191206_1000... OK<br>Applying terminal.0020_auto_20191218_1721... OK<br>Applying terminal.0021_auto_20200213_1316... OK<br>Applying terminal.0022_session_is_success... OK<br>Applying terminal.0023_command_risk_level... OK<br>Applying terminal.0024_auto_20200715_1713... OK<br>Applying tickets.0001_initial... OK<br>Applying users.0025_auto_20200206_1216... OK<br>Applying users.0026_auto_20200508_2105... OK<br>Applying users.0027_auto_20200616_1503... OK<br>2020-08-16 17:40:30 Collect static files<br>2020-08-16 17:40:34 Collect static files <span class="hljs-keyword">done</span><br>guacd[81]: INFO: Guacamole proxy daemon (guacd) version 1.2.0 started<br>Starting guacd: SUCCESS<br>Tomcat started.<br>Jumpserver ALL v2.1.2<br>官网 http://www.jumpserver.org<br>文档 http://docs.jumpserver.org<br>有问题请参考 http://docs.jumpserver.org/zh/docs/faq.html<br><br>进入容器命令 docker <span class="hljs-built_in">exec</span> -it jms_all /bin/bash<br>[root@centos7 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><h6 id="2-3-4-3-2-查看-MySQL-中生成相关表"><a href="#2-3-4-3-2-查看-MySQL-中生成相关表" class="headerlink" title="2.3.4.3.2 查看 MySQL 中生成相关表"></a>2.3.4.3.2 查看 MySQL 中生成相关表</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#docker exec -it mysql sh</span><br><span class="hljs-comment"># mysql -ujumpserver -p123456 jumperserver</span><br>mysql&gt; show tables;<br>+----------------------------------------------+<br>| Tables_in_jumpserver                         |<br>+----------------------------------------------+<br>| applications_databaseapp                     |<br>| applications_remoteapp                       |<br>| assets_adminuser                             |<br>| assets_asset                                 |<br>| assets_asset_labels                          |<br>| assets_asset_nodes                           |<br>| assets_assetgroup                            |<br>| assets_authbook                              |<br>| assets_cluster                               |<br>| assets_commandfilter                         |<br>| assets_commandfilterrule                     |<br>| assets_domain                                |<br>| assets_favoriteasset                         |<br>| assets_gateway                               |<br>| assets_gathereduser                          |<br>| assets_label                                 |<br>| assets_node                                  |<br>| assets_platform                              |<br>| assets_systemuser                            |<br>| assets_systemuser_assets                     |<br>| assets_systemuser_cmd_filters                |<br>| assets_systemuser_groups                     |<br>| assets_systemuser_nodes                      |<br>| assets_systemuser_users                      |<br>| audits_ftplog                                |<br>| audits_operatelog                            |<br>| audits_passwordchangelog                     |<br>| audits_userloginlog                          |<br>| auth_group                                   |<br>| auth_group_permissions                       |<br>| auth_permission                              |<br>| authentication_accesskey                     |<br>| authentication_loginconfirmsetting           |<br>| authentication_loginconfirmsetting_reviewers |<br>| authentication_privatetoken                  |<br>| captcha_captchastore                         |<br>| django_admin_log                             |<br>| django_cas_ng_proxygrantingticket            |<br>| django_cas_ng_sessionticket                  |<br>| django_celery_beat_crontabschedule           |<br>| django_celery_beat_intervalschedule          |<br>| django_celery_beat_periodictask              |<br>| django_celery_beat_periodictasks             |<br>| django_celery_beat_solarschedule             |<br>| django_content_type                          |<br>| django_migrations                            |<br>| django_session                               |<br>| jms_oidc_rp_oidcuser                         |<br>| ops_adhoc                                    |<br>| ops_adhoc_execution                          |<br>| ops_adhoc_hosts                              | <br>| ops_celerytask                               |<br>| ops_commandexecution                         |<br>| ops_commandexecution_hosts                   |<br>| ops_task                                     |<br>| orgs_organization                            |<br>| orgs_organization_admins                     |<br>| orgs_organization_auditors                   |<br>| orgs_organization_users                      |<br>| perms_assetpermission                        |<br>| perms_assetpermission_assets                 |<br>| perms_assetpermission_nodes                  |<br>| perms_assetpermission_system_users           |<br>| perms_assetpermission_user_groups            |<br>| perms_assetpermission_users                  |<br>| perms_databaseapppermission                  |<br>| perms_databaseapppermission_database_apps    |<br>| perms_databaseapppermission_system_users     |<br>| perms_databaseapppermission_user_groups      |<br>| perms_databaseapppermission_users            |<br>| perms_remoteapppermission                    |<br>| perms_remoteapppermission_remote_apps        |<br>| perms_remoteapppermission_system_users       |<br>| perms_remoteapppermission_user_groups        |<br>| perms_remoteapppermission_users              |<br>| settings_setting                             |<br>| terminal                                     |<br>| terminal_command                             |<br>| terminal_commandstorage                      |<br>| terminal_replaystorage                       |<br>| terminal_session                             |<br>| terminal_status                              |<br>| terminal_task                                |<br>| tickets_comment                              |<br>| tickets_ticket                               |<br>| tickets_ticket_assignees                     |<br>| users_user                                   |<br>| users_user_groups                            |<br>| users_user_user_permissions                  |<br>| users_usergroup                              |<br>+----------------------------------------------+<br>90 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>[root@centos7 ~]<span class="hljs-comment"># ll /data/mysql/jumpserver/</span><br>total 15424<br>-rw-r-----. 1 polkitd ssh_keys   8930 Mar 15 16:44 applications_application.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 applications_application.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8918 Mar 15 16:44 applications_databaseapp.frm<br>-rw-r-----. 1 polkitd ssh_keys 163840 Mar 15 16:44 applications_databaseapp.ibd<br>-rw-r-----. 1 polkitd ssh_keys  12994 Mar 15 16:44 applications_k8sapp.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 applications_k8sapp.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8876 Mar 15 16:44 applications_remoteapp.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 applications_remoteapp.ibd<br>-rw-r-----. 1 polkitd ssh_keys  13220 Mar 15 16:44 assets_adminuser.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_adminuser.ibd<br>-rw-r-----. 1 polkitd ssh_keys  21986 Mar 15 16:44 assets_asset.frm<br>-rw-r-----. 1 polkitd ssh_keys   8710 Mar 15 16:44 assets_assetgroup.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 assets_assetgroup.ibd<br>-rw-r-----. 1 polkitd ssh_keys 196608 Mar 15 16:44 assets_asset.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8632 Mar 15 16:44 assets_asset_labels.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_asset_labels.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8630 Mar 15 16:44 assets_asset_nodes.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_asset_nodes.ibd<br>-rw-r-----. 1 polkitd ssh_keys  13162 Mar 15 16:44 assets_authbook.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_authbook.ibd<br>-rw-r-----. 1 polkitd ssh_keys   9016 Mar 15 16:44 assets_cluster.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 assets_cluster.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8830 Mar 15 16:44 assets_commandfilter.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 assets_commandfilter.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8938 Mar 15 16:44 assets_commandfilterrule.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 assets_commandfilterrule.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8702 Mar 15 16:44 assets_domain.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 assets_domain.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8764 Mar 15 16:44 assets_favoriteasset.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_favoriteasset.ibd<br>-rw-r-----. 1 polkitd ssh_keys  13222 Mar 15 16:44 assets_gateway.frm<br>-rw-r-----. 1 polkitd ssh_keys 180224 Mar 15 16:44 assets_gateway.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8894 Mar 15 16:44 assets_gathereduser.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_gathereduser.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8812 Mar 15 16:44 assets_label.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 assets_label.ibd<br>-rw-r-----. 1 polkitd ssh_keys  21156 Mar 15 16:44 assets_node.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_node.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8756 Mar 15 16:44 assets_platform.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 assets_platform.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8642 Mar 15 16:44 assets_systemuser_assets.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_systemuser_assets.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8658 Mar 15 16:44 assets_systemuser_cmd_filters.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_systemuser_cmd_filters.ibd<br>-rw-r-----. 1 polkitd ssh_keys  38150 Mar 15 16:44 assets_systemuser.frm<br>-rw-r-----. 1 polkitd ssh_keys   8650 Mar 15 16:44 assets_systemuser_groups.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_systemuser_groups.ibd<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_systemuser.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8640 Mar 15 16:44 assets_systemuser_nodes.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_systemuser_nodes.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8640 Mar 15 16:44 assets_systemuser_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 assets_systemuser_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys  17090 Mar 15 16:44 audits_ftplog.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 audits_ftplog.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8822 Mar 15 16:44 audits_operatelog.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 audits_operatelog.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8708 Mar 15 16:44 audits_passwordchangelog.frm<br>-rw-r-----. 1 polkitd ssh_keys  98304 Mar 15 16:44 audits_passwordchangelog.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8856 Mar 15 16:44 audits_userloginlog.frm<br>-rw-r-----. 1 polkitd ssh_keys  98304 Mar 15 16:44 audits_userloginlog.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8712 Mar 15 16:44 authentication_accesskey.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:45 authentication_accesskey.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8766 Mar 15 16:44 authentication_loginconfirmsetting.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 authentication_loginconfirmsetting.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8658 Mar 15 16:44 authentication_loginconfirmsetting_reviewers.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 authentication_loginconfirmsetting_reviewers.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8630 Mar 15 16:44 authentication_privatetoken.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 authentication_privatetoken.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8814 Mar 15 16:44 authentication_ssotoken.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 authentication_ssotoken.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8586 Mar 15 16:44 auth_group.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 auth_group.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8642 Mar 15 16:44 auth_group_permissions.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 auth_group_permissions.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8676 Mar 15 16:44 auth_permission.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:45 auth_permission.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8712 Mar 15 16:44 captcha_captchastore.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 captcha_captchastore.ibd<br>-rw-r-----. 1 polkitd ssh_keys     61 Mar 15 16:10 db.opt<br>-rw-r-----. 1 polkitd ssh_keys   8866 Mar 15 16:44 django_admin_log.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 django_admin_log.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8728 Mar 15 16:44 django_cas_ng_proxygrantingticket.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 django_cas_ng_proxygrantingticket.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8634 Mar 15 16:44 django_cas_ng_sessionticket.frm<br>-rw-r-----. 1 polkitd ssh_keys  98304 Mar 15 16:44 django_cas_ng_sessionticket.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8638 Mar 15 16:44 django_celery_beat_clockedschedule.frm<br>-rw-r-----. 1 polkitd ssh_keys  98304 Mar 15 16:44 django_celery_beat_clockedschedule.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8796 Mar 15 16:44 django_celery_beat_crontabschedule.frm<br>-rw-r-----. 1 polkitd ssh_keys  98304 Mar 15 16:45 django_celery_beat_crontabschedule.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8622 Mar 15 16:44 django_celery_beat_intervalschedule.frm<br>-rw-r-----. 1 polkitd ssh_keys  98304 Mar 15 16:45 django_celery_beat_intervalschedule.ibd<br>-rw-r-----. 1 polkitd ssh_keys  13564 Mar 15 16:44 django_celery_beat_periodictask.frm<br>-rw-r-----. 1 polkitd ssh_keys 180224 Mar 15 16:45 django_celery_beat_periodictask.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8606 Mar 15 16:44 django_celery_beat_periodictasks.frm<br>-rw-r-----. 1 polkitd ssh_keys  98304 Mar 15 16:45 django_celery_beat_periodictasks.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8666 Mar 15 16:44 django_celery_beat_solarschedule.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 django_celery_beat_solarschedule.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8628 Mar 15 16:44 django_content_type.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:45 django_content_type.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8650 Mar 15 16:44 django_migrations.frm<br>-rw-r-----. 1 polkitd ssh_keys  98304 Mar 15 16:45 django_migrations.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8664 Mar 15 16:44 django_session.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:45 django_session.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8658 Mar 15 16:44 jms_oidc_rp_oidcuser.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 jms_oidc_rp_oidcuser.ibd<br>-rw-r-----. 1 polkitd ssh_keys   9042 Mar 15 16:44 ops_adhoc_execution.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 ops_adhoc_execution.ibd<br>-rw-r-----. 1 polkitd ssh_keys  17124 Mar 15 16:44 ops_adhoc.frm<br>-rw-r-----. 1 polkitd ssh_keys   8632 Mar 15 16:44 ops_adhoc_hosts.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 ops_adhoc_hosts.ibd<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 ops_adhoc.ibd<br>-rw-r-----. 1 polkitd ssh_keys  12894 Mar 15 16:44 ops_celerytask.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 ops_celerytask.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8918 Mar 15 16:44 ops_commandexecution.frm<br>-rw-r-----. 1 polkitd ssh_keys   8654 Mar 15 16:44 ops_commandexecution_hosts.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 ops_commandexecution_hosts.ibd<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 ops_commandexecution.ibd<br>-rw-r-----. 1 polkitd ssh_keys   9170 Mar 15 16:44 ops_task.frm<br>-rw-r-----. 1 polkitd ssh_keys 180224 Mar 15 16:44 ops_task.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8710 Mar 15 16:44 orgs_organization.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 orgs_organization.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8790 Mar 15 16:44 orgs_organization_members.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 orgs_organization_members.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8676 Mar 15 16:44 perms_applicationpermission_applications.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_applicationpermission_applications.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8940 Mar 15 16:44 perms_applicationpermission.frm<br>-rw-r-----. 1 polkitd ssh_keys 163840 Mar 15 16:44 perms_applicationpermission.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8674 Mar 15 16:44 perms_applicationpermission_system_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_applicationpermission_system_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8672 Mar 15 16:44 perms_applicationpermission_user_groups.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_applicationpermission_user_groups.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8662 Mar 15 16:44 perms_applicationpermission_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:45 perms_applicationpermission_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8652 Mar 15 16:44 perms_assetpermission_assets.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_assetpermission_assets.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8908 Mar 15 16:44 perms_assetpermission.frm<br>-rw-r-----. 1 polkitd ssh_keys 163840 Mar 15 16:44 perms_assetpermission.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8650 Mar 15 16:44 perms_assetpermission_nodes.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_assetpermission_nodes.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8662 Mar 15 16:44 perms_assetpermission_system_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_assetpermission_system_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8660 Mar 15 16:44 perms_assetpermission_user_groups.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 perms_assetpermission_user_groups.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8650 Mar 15 16:44 perms_assetpermission_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 perms_assetpermission_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8676 Mar 15 16:44 perms_databaseapppermission_database_apps.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_databaseapppermission_database_apps.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8872 Mar 15 16:44 perms_databaseapppermission.frm<br>-rw-r-----. 1 polkitd ssh_keys 163840 Mar 15 16:44 perms_databaseapppermission.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8674 Mar 15 16:44 perms_databaseapppermission_system_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_databaseapppermission_system_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8672 Mar 15 16:44 perms_databaseapppermission_user_groups.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 perms_databaseapppermission_user_groups.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8662 Mar 15 16:44 perms_databaseapppermission_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 perms_databaseapppermission_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8872 Mar 15 16:44 perms_k8sapppermission.frm<br>-rw-r-----. 1 polkitd ssh_keys 163840 Mar 15 16:44 perms_k8sapppermission.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8656 Mar 15 16:44 perms_k8sapppermission_k8s_apps.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_k8sapppermission_k8s_apps.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8664 Mar 15 16:44 perms_k8sapppermission_system_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_k8sapppermission_system_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8662 Mar 15 16:44 perms_k8sapppermission_user_groups.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 perms_k8sapppermission_user_groups.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8652 Mar 15 16:44 perms_k8sapppermission_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 perms_k8sapppermission_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8768 Mar 15 16:44 perms_rebuildusertreetask.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:45 perms_rebuildusertreetask.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8872 Mar 15 16:44 perms_remoteapppermission.frm<br>-rw-r-----. 1 polkitd ssh_keys 163840 Mar 15 16:44 perms_remoteapppermission.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8668 Mar 15 16:44 perms_remoteapppermission_remote_apps.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_remoteapppermission_remote_apps.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8670 Mar 15 16:44 perms_remoteapppermission_system_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 perms_remoteapppermission_system_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8668 Mar 15 16:44 perms_remoteapppermission_user_groups.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 perms_remoteapppermission_user_groups.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8658 Mar 15 16:44 perms_remoteapppermission_users.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 perms_remoteapppermission_users.ibd<br>-rw-r-----. 1 polkitd ssh_keys   9006 Mar 15 16:44 perms_usergrantedmappingnode.frm<br>-rw-r-----. 1 polkitd ssh_keys 196608 Mar 15 16:44 perms_usergrantedmappingnode.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8768 Mar 15 16:44 settings_setting.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:44 settings_setting.ibd<br>-rw-r-----. 1 polkitd ssh_keys  12976 Mar 15 16:44 terminal_command.frm<br>-rw-r-----. 1 polkitd ssh_keys 229376 Mar 15 16:45 terminal_command.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8816 Mar 15 16:44 terminal_commandstorage.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:45 terminal_commandstorage.ibd<br>-rw-r-----. 1 polkitd ssh_keys   9014 Mar 15 16:44 terminal.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:45 terminal.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8816 Mar 15 16:44 terminal_replaystorage.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:45 terminal_replaystorage.ibd<br>-rw-r-----. 1 polkitd ssh_keys  13336 Mar 15 16:44 terminal_session.frm<br>-rw-r-----. 1 polkitd ssh_keys 294912 Mar 15 16:45 terminal_session.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8898 Mar 15 16:44 terminal_status.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:45 terminal_status.ibd<br>-rw-r-----. 1 polkitd ssh_keys  12894 Mar 15 16:44 terminal_task.frm<br>-rw-r-----. 1 polkitd ssh_keys 114688 Mar 15 16:45 terminal_task.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8842 Mar 15 16:44 tickets_comment.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:45 tickets_comment.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8632 Mar 15 16:44 tickets_ticket_assignees.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:45 tickets_ticket_assignees.ibd<br>-rw-r-----. 1 polkitd ssh_keys   9186 Mar 15 16:44 tickets_ticket.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:45 tickets_ticket.ibd<br>-rw-r-----. 1 polkitd ssh_keys  13634 Mar 15 16:44 users_user.frm<br>-rw-r-----. 1 polkitd ssh_keys   8744 Mar 15 16:44 users_usergroup.frm<br>-rw-r-----. 1 polkitd ssh_keys 131072 Mar 15 16:44 users_usergroup.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8638 Mar 15 16:44 users_user_groups.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 users_user_groups.ibd<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:45 users_user.ibd<br>-rw-r-----. 1 polkitd ssh_keys   8640 Mar 15 16:44 users_user_user_permissions.frm<br>-rw-r-----. 1 polkitd ssh_keys 147456 Mar 15 16:44 users_user_user_permissions.ibd<br><br><br></code></pre></td></tr></table></figure><h6 id="2-3-4-3-3-查看端口"><a href="#2-3-4-3-3-查看端口" class="headerlink" title="2.3.4.3.3 查看端口"></a>2.3.4.3.3 查看端口</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#ss -ntl</span><br>State  Recv-Q Send-Q  Local Address:Port  Peer Address:Port     <br>LISTEN  0    128       0.0.0.0:22      0.0.0.0:*       <br>LISTEN  0    100      127.0.0.1:25      0.0.0.0:*       <br>LISTEN  0    128          *:2222       *:*       <br>LISTEN  0    128          *:80        *:*       <br>LISTEN  0    128        [::]:22       [::]:*       <br>LISTEN  0    100        [::1]:25       [::]:*  <br></code></pre></td></tr></table></figure><h6 id="2-3-4-3-4-验证登录"><a href="#2-3-4-3-4-验证登录" class="headerlink" title="2.3.4.3.4 验证登录"></a>2.3.4.3.4 验证登录</h6><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer7.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer8.jpg"></p><h2 id="三、使用-JumpServer"><a href="#三、使用-JumpServer" class="headerlink" title="三、使用 JumpServer"></a>三、使用 JumpServer</h2><p>官方文档:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.jumpserver.org/zh/master/<br></code></pre></td></tr></table></figure><h3 id="3-1-登录并初始化配置"><a href="#3-1-登录并初始化配置" class="headerlink" title="3.1 登录并初始化配置"></a>3.1 登录并初始化配置</h3><h4 id="3-1-1-首次登录"><a href="#3-1-1-首次登录" class="headerlink" title="3.1.1 首次登录"></a>3.1.1 首次登录</h4><h5 id="3-1-1-1-浏览器访问"><a href="#3-1-1-1-浏览器访问" class="headerlink" title="3.1.1.1 浏览器访问"></a>3.1.1.1 浏览器访问</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http:&lt;JumpServerIP&gt;<br></code></pre></td></tr></table></figure><p>登录 JumpServer 默认用户: admin 密码: admin</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer9.jpg"></p><p>第一次登录要求重置密码</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer10.jpg"></p><p>用新密码重新登录</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer11.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer12.jpg"></p><h5 id="3-1-1-2-ssh-登录"><a href="#3-1-1-2-ssh-登录" class="headerlink" title="3.1.1.2 ssh 登录"></a>3.1.1.2 ssh 登录</h5><p>可以用admin用户和修改过的新密码, 连接jumpserver的ssh端口2222/tcp进行连接访问</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer13.jpg"></p><h4 id="3-1-2-修改-admin-用户的密码"><a href="#3-1-2-修改-admin-用户的密码" class="headerlink" title="3.1.2 修改 admin 用户的密码"></a>3.1.2 修改 admin 用户的密码</h4><p>点击网页右上角 –&gt; 个人信息 –&gt; 登录密码设置</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer14.jpg"></p><h4 id="3-1-3-配置邮件"><a href="#3-1-3-配置邮件" class="headerlink" title="3.1.3 配置邮件"></a>3.1.3 配置邮件</h4><p>（左边最后一个）系统设置 –&gt; 邮件设置</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer15.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer16.jpg"></p><p>测试连接,可以收到邮件</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer17.jpg"></p><h3 id="3-2-创建用户和组"><a href="#3-2-创建用户和组" class="headerlink" title="3.2 创建用户和组"></a>3.2 创建用户和组</h3><p>JumpServer 支持三种用户</p><ul><li>系统管理员</li><li>用户</li><li>系统审计员</li></ul><h4 id="3-2-1-创建用户"><a href="#3-2-1-创建用户" class="headerlink" title="3.2.1 创建用户"></a>3.2.1 创建用户</h4><p>用户管理 –&gt; 用户列表 –&gt; 创建</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer18.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer19.jpg"></p><p><strong>相同方法再创建xiaoming用户</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer20.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer21.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer22.jpg"></p><h4 id="3-2-2-创建组并将用户加入组中"><a href="#3-2-2-创建组并将用户加入组中" class="headerlink" title="3.2.2 创建组并将用户加入组中"></a>3.2.2 创建组并将用户加入组中</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer23.jpg"></p><p>创建development组,并将前面创建的用户加入组中</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer24.jpg"></p><p>创建test组,将入用户</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer25.jpg"></p><p>查看创建的组</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer26.jpg"></p><h4 id="3-2-3-使用新用户登录"><a href="#3-2-3-使用新用户登录" class="headerlink" title="3.2.3 使用新用户登录"></a>3.2.3 使用新用户登录</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer27.jpg"></p><p>首次登录完善个人信息</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer28.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer29.jpg"></p><h4 id="3-2-4-禁用和启用用户"><a href="#3-2-4-禁用和启用用户" class="headerlink" title="3.2.4 禁用和启用用户"></a>3.2.4 禁用和启用用户</h4><p><strong>禁用用户</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer30.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer31.jpg"></p><p><strong>启用用户</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer32.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer33.jpg"></p><h4 id="3-2-5-启用用户多因子认证功能"><a href="#3-2-5-启用用户多因子认证功能" class="headerlink" title="3.2.5 启用用户多因子认证功能"></a>3.2.5 启用用户多因子认证功能</h4><p>多因子认证Multi-Factor Authentication (MFA) 是一种简单有效的最佳安全实践方法，用户要通过两种以上的认证机制之后，才能得到授权，使用计算机资源</p><p>JumpServer 启用 MFA 后，用户登录网站时，系统将要求输入用户名和密码（第一安全要素），然后要求输入来自其 MFA 设备的动态验证码（第二安全要素），双因素的安全认证将为您的账户提供更高的安全保护</p><h5 id="3-2-5-1-开启MFA"><a href="#3-2-5-1-开启MFA" class="headerlink" title="3.2.5.1 开启MFA"></a>3.2.5.1 开启MFA</h5><p>在用户列表中,对指定用户更新配置</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer34.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer35.jpg"></p><h5 id="3-2-5-2-绑定手机APP"><a href="#3-2-5-2-绑定手机APP" class="headerlink" title="3.2.5.2 绑定手机APP"></a>3.2.5.2 绑定手机APP</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer36.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer37.jpg"></p><p>按下图下载APP并安装</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer38.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer39.jpg"></p><h5 id="3-2-5-3-重新登录验证"><a href="#3-2-5-3-重新登录验证" class="headerlink" title="3.2.5.3 重新登录验证"></a>3.2.5.3 重新登录验证</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer40.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer41.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer42.jpg"></p><h4 id="3-2-6-创建系统审计员"><a href="#3-2-6-创建系统审计员" class="headerlink" title="3.2.6 创建系统审计员"></a>3.2.6 创建系统审计员</h4><p>系统审计员即查看录像带的人(M42期宽宽语录)</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer43.jpg"></p><p>使用审计员用户登录</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer44.jpg"></p><h3 id="3-3-管理资产"><a href="#3-3-管理资产" class="headerlink" title="3.3 管理资产"></a>3.3 管理资产</h3><p>JumpServer 可以管理各种类型的资产</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer45.jpg"></p><h4 id="3-3-1-创建管理用户"><a href="#3-3-1-创建管理用户" class="headerlink" title="3.3.1 创建管理用户"></a>3.3.1 创建管理用户</h4><p>管理用户是jumpServer用来管理后端服务器或其它资产的管理员用户,此用户必须对后端服务器有管理权限</p><p>管理用户特点:</p><ul><li>通常是后端服务器的root或者是具备root权限的超级用户</li><li>用于推送或者是创建系统用户</li><li>用于获取被管理的硬件资产信息</li></ul><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer46.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer47.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer48.jpg"></p><h4 id="3-3-2-创建资产"><a href="#3-3-2-创建资产" class="headerlink" title="3.3.2 创建资产"></a>3.3.2 创建资产</h4><p>创建可以被jumpServer用户访问的后端服务器和其它资产,比如:路由器,交换机等</p><h5 id="3-3-2-1-创建资产"><a href="#3-3-2-1-创建资产" class="headerlink" title="3.3.2.1 创建资产"></a>3.3.2.1 创建资产</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer49.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer50.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer51.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer52.jpg"></p><p>创建多个资产</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer53.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer54.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer55.jpg"></p><h5 id="3-3-2-2-创建节点实现资产分类"><a href="#3-3-2-2-创建节点实现资产分类" class="headerlink" title="3.3.2.2 创建节点实现资产分类"></a>3.3.2.2 创建节点实现资产分类</h5><p>创建节点将资产分类</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer56.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer57.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer58.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer59.jpg"></p><h3 id="3-4-授权管理"><a href="#3-4-授权管理" class="headerlink" title="3.4 授权管理"></a>3.4 授权管理</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer60.jpg"></p><h4 id="3-4-1-创建系统用户"><a href="#3-4-1-创建系统用户" class="headerlink" title="3.4.1 创建系统用户"></a>3.4.1 创建系统用户</h4><p>系统用户是分配给JumpServer用户,用来让JumpServer用户在连接后端服务器和其它资产,一般不会给管理权限</p><p>生产环境中,一般都会利用自动化运维工具提前在后端服务器创建好系统用户,在所有后端服务器统一用户ID信息,而非在jumpserver中创建</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer61.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer62.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer63.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer64.jpg"></p><h4 id="3-4-2-推送系统用户"><a href="#3-4-2-推送系统用户" class="headerlink" title="3.4.2 推送系统用户"></a>3.4.2 推送系统用户</h4><p>将前面创建的系统用户利用ansible推送到后端服务器并自动创建</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer65.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer66.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer67.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer68.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer69.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer70.jpg"></p><p>在后端服务器验证用户创建成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#id magedu</span><br>uid=1001(magedu) gid=1001(magedu) groups=1001(magedu)<br>[root@centos7 ~]<span class="hljs-comment">#id magedu</span><br>uid=1002(magedu) gid=1002(magedu) groups=1002(magedu)<br></code></pre></td></tr></table></figure><h4 id="3-4-3-创建授权规则"><a href="#3-4-3-创建授权规则" class="headerlink" title="3.4.3 创建授权规则"></a>3.4.3 创建授权规则</h4><p>通过授权规则, 为用户分配可以访问的资产</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer71.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer72.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer73.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer74.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer75.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer76.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer77.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer78.jpg"></p><p>同样再创建授权规则</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer79.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer80.jpg"></p><p>3.4.4 测试登录访问后端服务器</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer81.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer82.jpg"></p><p>选中主机后,输入命令,再执行</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer83.jpg"></p><p>点右上角的web终端,可以打开终端界面</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer84.jpg"></p><h4 id="3-4-5-测试上传和下载文件"><a href="#3-4-5-测试上传和下载文件" class="headerlink" title="3.4.5 测试上传和下载文件"></a>3.4.5 测试上传和下载文件</h4><p>可以通过web方式或者通过filezilla等工具直接连接jumpserver的2222端口都可以实现文件的上传下载</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer85.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer86.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer87.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer88.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer89.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer90.jpg"></p><h4 id="3-4-6-ssh连接JumpServer"><a href="#3-4-6-ssh连接JumpServer" class="headerlink" title="3.4.6 ssh连接JumpServer"></a>3.4.6 ssh连接JumpServer</h4><p>JumpServer 还支持用户通过ssh连接其2222/tcp端口进行访问</p><p>连接方式:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -p 2222 user@jumpserver<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer91.jpg"></p><h3 id="3-5-数据库授权"><a href="#3-5-数据库授权" class="headerlink" title="3.5 数据库授权"></a>3.5 数据库授权</h3><h4 id="3-5-1-在后端服务器安装MySQL并创建数据库和用户"><a href="#3-5-1-在后端服务器安装MySQL并创建数据库和用户" class="headerlink" title="3.5.1 在后端服务器安装MySQL并创建数据库和用户"></a>3.5.1 在后端服务器安装MySQL并创建数据库和用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.200<br>[root@centos8 ~]<span class="hljs-comment">#dnf -y install mariadb-server</span><br><br>[root@centos8 ~]<span class="hljs-comment">#systemctl enable --now mariadb</span><br>[root@centos8 ~]<span class="hljs-comment">#mysql</span><br>MariaDB [(none)]&gt; create database wordpress;<br>MariaDB [(none)]&gt; grant all on wordpress.* to wordpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified<br>by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>MariaDB [(none)]&gt; <span class="hljs-built_in">exit</span><br>Bye<br></code></pre></td></tr></table></figure><h4 id="3-5-2-创建数据库应用"><a href="#3-5-2-创建数据库应用" class="headerlink" title="3.5.2 创建数据库应用"></a>3.5.2 创建数据库应用</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer92.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer93.jpg"></p><h4 id="3-5-3-创建数据库的系统用户"><a href="#3-5-3-创建数据库的系统用户" class="headerlink" title="3.5.3 创建数据库的系统用户"></a>3.5.3 创建数据库的系统用户</h4><p>创建针对数据库的专用系统用户<br><strong>注意: 协议选择mysql</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer94.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer95.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer96.jpg"></p><h4 id="3-5-4-创建数据库授权规则"><a href="#3-5-4-创建数据库授权规则" class="headerlink" title="3.5.4 创建数据库授权规则"></a>3.5.4 创建数据库授权规则</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer97.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer98.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer99.jpg"></p><h4 id="3-5-5-测试数据库连接"><a href="#3-5-5-测试数据库连接" class="headerlink" title="3.5.5 测试数据库连接"></a>3.5.5 测试数据库连接</h4><h5 id="3-5-5-1-web-方式连接MySQL资产"><a href="#3-5-5-1-web-方式连接MySQL资产" class="headerlink" title="3.5.5.1 web 方式连接MySQL资产"></a>3.5.5.1 web 方式连接MySQL资产</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer100.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer101.jpg"></p><p>注意: v2.5.3有 bug,无法连接</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer102.jpg"></p><h5 id="3-5-5-2-用ssh连接MySQL资产"><a href="#3-5-5-2-用ssh连接MySQL资产" class="headerlink" title="3.5.5.2 用ssh连接MySQL资产"></a>3.5.5.2 用ssh连接MySQL资产</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer103.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer104.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer105.jpg"></p><h3 id="3-6-会话管理"><a href="#3-6-会话管理" class="headerlink" title="3.6 会话管理"></a>3.6 会话管理</h3><p>会话管理-命令记录、历史会话里面可以看到用户操作过并且已经退出的录像记录</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer106.jpg"></p><h4 id="3-6-1-查看在线会话"><a href="#3-6-1-查看在线会话" class="headerlink" title="3.6.1 查看在线会话"></a>3.6.1 查看在线会话</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer107.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer108.jpg"></p><h4 id="3-6-2-查看历史会话"><a href="#3-6-2-查看历史会话" class="headerlink" title="3.6.2 查看历史会话"></a>3.6.2 查看历史会话</h4><h5 id="3-6-2-1-在线回放"><a href="#3-6-2-1-在线回放" class="headerlink" title="3.6.2.1 在线回放"></a>3.6.2.1 在线回放</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer109.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer110.jpg"></p><p>3.6.2.2 离线查看录像<br>可以将历史会话过程下载再播放,但需要下载相关的播放器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://github.com/jumpserver/VideoPlayer/releases<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer111.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer112.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer113.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer114.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer115.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer116.jpg"></p><h4 id="3-6-3-查看命令历史"><a href="#3-6-3-查看命令历史" class="headerlink" title="3.6.3 查看命令历史"></a>3.6.3 查看命令历史</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer117.jpg"></p><h4 id="3-6-4-终端管理"><a href="#3-6-4-终端管理" class="headerlink" title="3.6.4 终端管理"></a>3.6.4 终端管理</h4><p>可以在线监控用户正在进行的操作,或者可以强制中断用户的连接</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer118.jpg"></p><h3 id="3-7-命令过滤器"><a href="#3-7-命令过滤器" class="headerlink" title="3.7 命令过滤器"></a>3.7 命令过滤器</h3><p>使用命令过滤器可以禁止用户执行特定的危险命令,防止误操作或恶意行为</p><p>系统用户可以绑定一些命令过滤器，一个过滤器可以定义一些规则 当用户使用这个系统用户登录资产，然后执行一个命令.这个命令需要被绑定过滤器的所有规则匹配，高优先级先被匹配， 当一个规则匹配到了，如果规则的动作是允许，这个命令会被放行， 如果规则的动作是禁止，命令将会被禁止执行，否则就匹配下一个规则，如果最后没有匹配到规则，则允许执行</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer119.jpg"></p><h4 id="3-7-1-创建命令过滤器"><a href="#3-7-1-创建命令过滤器" class="headerlink" title="3.7.1 创建命令过滤器"></a>3.7.1 创建命令过滤器</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer120.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer121.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer122.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer123.jpg"></p><h4 id="3-7-2-将过滤器绑定系统用户"><a href="#3-7-2-将过滤器绑定系统用户" class="headerlink" title="3.7.2 将过滤器绑定系统用户"></a>3.7.2 将过滤器绑定系统用户</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer124.jpg"></p><h4 id="3-7-3-测试"><a href="#3-7-3-测试" class="headerlink" title="3.7.3 测试"></a>3.7.3 测试</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer125.jpg"></p><h3 id="3-8-资产的批量导出和导入"><a href="#3-8-资产的批量导出和导入" class="headerlink" title="3.8 资产的批量导出和导入"></a>3.8 资产的批量导出和导入</h3><p>当后端服务器众多时,一台一台主机手动导入效率很低,可以利用资产的导出导入功能实现批量导入</p><h4 id="3-8-1-资产的批量导出"><a href="#3-8-1-资产的批量导出" class="headerlink" title="3.8.1 资产的批量导出"></a>3.8.1 资产的批量导出</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer126.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer127.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer128.jpg"></p><h4 id="3-8-2-批量导入资产"><a href="#3-8-2-批量导入资产" class="headerlink" title="3.8.2 批量导入资产"></a>3.8.2 批量导入资产</h4><p>参考上面导出的文件格式,生成导入的文件,再批量导入资产</p><p>注意: 删除id列,修改主机名和IP字段,再导入</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer129.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer130.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer131.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/JumpServer/JumpServer132.jpg"></p>]]></content>
    
    
    
    <tags>
      
      <tag>Linux JumpServer</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>运维自运化之ANSIBLE</title>
    <link href="/blog/2021/03/11/%E8%BF%90%E7%BB%B4%E8%87%AA%E8%BF%90%E5%8C%96%E4%B9%8BANSIBLE/"/>
    <url>/blog/2021/03/11/%E8%BF%90%E7%BB%B4%E8%87%AA%E8%BF%90%E5%8C%96%E4%B9%8BANSIBLE/</url>
    
    <content type="html"><![CDATA[<h1 id="运维自运化之ANSIBLE"><a href="#运维自运化之ANSIBLE" class="headerlink" title="运维自运化之ANSIBLE"></a>运维自运化之ANSIBLE</h1><h2 id="一、自动化运维应用场景"><a href="#一、自动化运维应用场景" class="headerlink" title="一、自动化运维应用场景"></a>一、自动化运维应用场景</h2><h3 id="1-1-云计算运维工程师核心职能"><a href="#1-1-云计算运维工程师核心职能" class="headerlink" title="1.1 云计算运维工程师核心职能"></a>1.1 云计算运维工程师核心职能</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible1.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible2.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible3.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible4.jpg"></p><p><strong>相关工具</strong></p><ul><li>代码管理（SCM）：GitHub、GitLab、BitBucket、SubVersion</li><li>构建工具：maven、Ant、Gradle</li><li>自动部署：Capistrano、CodeDeploy</li><li>持续集成（CI）：Jenkins、Travis</li><li>配置管理：Ansible、SaltStack、Chef、Puppet</li><li>容器：Docker、Podman、LXC、第三方厂商如AWS</li><li>编排：Kubernetes、Core、Apache Mesos</li><li>服务注册与发现：Zookeeper、etcd、Consul</li><li>脚本语言：python、ruby、shell</li><li>日志管理：ELK、Logentries</li><li>系统监控：Prometheus、Zabbix、Datadog、Graphite、Ganglia、Nagios</li><li>性能监控：AppDynamics、New Relic、Splunk</li><li>压力测试：JMeter、Blaze Meter、loader.io</li><li>应用服务器：Tomcat、JBoss、IIS</li><li>Web服务器：Apache、Nginx</li><li>数据库：MySQL、Oracle、PostgreSQL等关系型数据库；mongoDB、redis等NoSQL数据库</li><li>项目管理（PM）：Jira、Asana、Taiga、Trello、Basecamp、Pivotal Tracker</li></ul><h3 id="1-2-运维职业发展路线"><a href="#1-2-运维职业发展路线" class="headerlink" title="1.2 运维职业发展路线"></a>1.2 运维职业发展路线</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible5.jpg"></p><p><strong>运维的未来是什么？</strong><br><strong>一切皆自动化</strong><br>“运维的未来是，让研发人员能够借助工具、自动化和流程，并且让他们能够在运维干预极少的情况下部署和运营服务，从而实现自助服务。每个角色都应该努力使工作实现自动化。”——《运维的未来》</p><h3 id="1-3-企业实际应用场景分析"><a href="#1-3-企业实际应用场景分析" class="headerlink" title="1.3 企业实际应用场景分析"></a>1.3 企业实际应用场景分析</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible6.jpg"></p><h4 id="1-3-1-Dev开发环境"><a href="#1-3-1-Dev开发环境" class="headerlink" title="1.3.1 Dev开发环境"></a>1.3.1 Dev开发环境</h4><p>使用者：程序员<br>功能：程序员个人的办公电脑或项目的开发测试环境，部署开发软件，测试个人或项目整体的BUG的<br>环境<br>管理者：程序员</p><h4 id="1-3-2-测试环境"><a href="#1-3-2-测试环境" class="headerlink" title="1.3.2 测试环境"></a>1.3.2 测试环境</h4><p>使用者：QA测试工程师<br>功能：测试经过Dev环境测试通过的软件的功能和性能，判断是否达到项目的预期目标，生成测试报告<br>管理者：运维<br>说明：测试环境往往有多套,测试环境满足测试功能即可，不宜过多<br> 1、测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，意味着多个版本同步测试<br>2、通常测试环境有多少套和产品线数量保持一样</p><h4 id="1-3-3-预发布环境"><a href="#1-3-3-预发布环境" class="headerlink" title="1.3.3 预发布环境"></a>1.3.3 预发布环境</h4><p>使用者：运维<br>功能：使用和生产环境一样的数据库，缓存服务等配置，测试是否正常</p><h4 id="1-3-4-发布环境"><a href="#1-3-4-发布环境" class="headerlink" title="1.3.4 发布环境"></a>1.3.4 发布环境</h4><p>包括代码发布机，有些公司为堡垒机（安全屏障）<br>使用者：运维<br>功能：发布代码至生产环境<br>管理者：运维（有经验）<br>发布机：往往需要有2台（主备）</p><h4 id="1-3-5-生产环境"><a href="#1-3-5-生产环境" class="headerlink" title="1.3.5 生产环境"></a>1.3.5 生产环境</h4><p>使用者：运维，少数情况开放权限给核心开发人员，极少数公司将权限完全开放给开发人员并其维护<br>功能：对用户提供公司产品的服务<br>管理者：只能是运维<br>生产环境服务器数量：一般比较多，且应用非常重要。往往需要自动工具协助部署配置应用</p><h4 id="1-3-6-灰度环境"><a href="#1-3-6-灰度环境" class="headerlink" title="1.3.6 灰度环境"></a>1.3.6 灰度环境</h4><p>属于生产环境的一部分<br>使用者：运维<br>功能：在全量发布代码前将代码的功能面向少量精准用户发布的环境,可基于主机或用户执行灰度发布<br>案例：共100台生产服务器，先发布其中的10台服务器，这10台服务器就是灰度服务器<br>管理者：运维<br>灰度环境：往往该版本功能变更较大，为保险起见特意先让一部分用户优化体验该功能，待这部分用户使用没有重大问题的时候，再全量发布至所有服务器</p><h3 id="1-4-程序发布"><a href="#1-4-程序发布" class="headerlink" title="1.4 程序发布"></a>1.4 程序发布</h3><p>程序发布要求：<br>不能导致系统故障或造成系统完全不可用<br>不能影响用户体验<br>预发布验证：<br>新版本的代码先发布到服务器（跟线上环境配置完全相同，只是未接入到调度器）<br>灰度发布：<br>基于主机，用户，业务<br>发布路径：<br>/webapp/tuangou<br>/webapp/tuangou-1.1<br>/webapp/tuangou-1.2</p><p><strong>发布过程：</strong></p><ol><li>在调度器上下线一批主机(标记为maintenance 状态)</li><li>关闭服务</li><li>部署新版本的应用程序</li><li>启动服务</li><li>在调度器上启用这一批服务器</li></ol><p><strong>自动化灰度发布：</strong></p><ul><li>脚本</li><li>发布平台</li></ul><h3 id="1-5-自动化运维应用场景"><a href="#1-5-自动化运维应用场景" class="headerlink" title="1.5 自动化运维应用场景"></a>1.5 自动化运维应用场景</h3><ul><li>文件传输</li><li>应用部署</li><li>配置管理</li><li>任务流编排</li></ul><h3 id="1-6-常用自动化运维工具"><a href="#1-6-常用自动化运维工具" class="headerlink" title="1.6 常用自动化运维工具"></a>1.6 常用自动化运维工具</h3><ul><li>Ansible：python，Agentless，中小型应用环境</li><li>Saltstack：python，一般需部署agent，执行效率更高</li><li>Puppet：ruby, 功能强大，配置复杂，重型，适合大型环境</li><li>Fabric：python，agentless</li><li>Chef：ruby，国内应用少</li><li>Cfengine</li><li>func</li></ul><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible7.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible8.jpg"></p><p>同类自动化工具GitHub关注程度（2016-07-10）</p><table><thead><tr><th>自动化运维工具</th><th>Watch（关注）</th><th>Star（点赞）</th><th>Fork（复制）</th><th>Contributors(贡献者)</th></tr></thead><tbody><tr><td>Ansible</td><td>1387</td><td>17716</td><td>5356</td><td>1428</td></tr><tr><td>Saltstack</td><td>530</td><td>6678</td><td>3022</td><td>1520</td></tr><tr><td>Puppet</td><td>463</td><td>4044</td><td>1678</td><td>425</td></tr><tr><td>Chef</td><td>383</td><td>4333</td><td>1806</td><td>464</td></tr><tr><td>Fabric</td><td>379</td><td>7334</td><td>1235</td><td>116</td></tr></tbody></table><h2 id="二、Ansible-介绍和架构"><a href="#二、Ansible-介绍和架构" class="headerlink" title="二、Ansible 介绍和架构"></a>二、Ansible 介绍和架构</h2><p>公司计划在年底做一次大型市场促销活动，全面冲刺下交易额，为明年的上市做准备。公司要求各业务组对年底大促做准备，运维部要求所有业务容量进行三倍的扩容，并搭建出多套环境可以共开发和测试人员做测试，运维老大为了在年底有所表现，要求运维部门同学尽快实现，当你接到这个任务时，有没有更快的解决方案？</p><h3 id="2-1-Ansible发展史"><a href="#2-1-Ansible发展史" class="headerlink" title="2.1 Ansible发展史"></a>2.1 Ansible发展史</h3><p>作者：Michael DeHaan（ Cobbler 与 Func 作者）<br>ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗<br>2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购<br>官网：<a href="https://www.ansible.com/">https://www.ansible.com/</a><br>官方文档：<a href="https://docs.ansible.com/">https://docs.ansible.com/</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible9.jpg"></p><h3 id="2-2-Ansible-特性"><a href="#2-2-Ansible-特性" class="headerlink" title="2.2 Ansible 特性"></a>2.2 Ansible 特性</h3><ul><li>模块化：调用特定的模块完成特定任务，支持自定义模块，可使用任何编程语言写模块</li><li>Paramiko（python对ssh的实现），PyYAML，Jinja2（模板语言）三个关键模块</li><li>基于Python语言实现</li><li>部署简单，基于python和SSH(默认已安装)，agentless，无需代理不依赖PKI（无需ssl）</li><li>安全，基于OpenSSH</li><li>幂等性：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况,此特性非绝对</li><li>支持playbook编排任务，YAML格式，编排任务，支持丰富的数据结构</li><li>较强大的多层解决方案 role</li></ul><h3 id="2-3-Ansible-架构"><a href="#2-3-Ansible-架构" class="headerlink" title="2.3 Ansible 架构"></a>2.3 Ansible 架构</h3><h4 id="2-3-1-Ansible-组成"><a href="#2-3-1-Ansible-组成" class="headerlink" title="2.3.1 Ansible 组成"></a>2.3.1 Ansible 组成</h4><p>组合INVENTORY、API、MODULES、PLUGINS的绿框，为ansible命令工具，其为核心执行工具</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible10.jpg"></p><ul><li>INVENTORY：Ansible管理主机的清单/etc/anaible/hosts</li><li>MODULES：Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</li><li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</li><li>API：供第三方程序调用的应用程序编程接口</li></ul><h4 id="2-3-2-Ansible-命令执行来源"><a href="#2-3-2-Ansible-命令执行来源" class="headerlink" title="2.3.2 Ansible 命令执行来源"></a>2.3.2 Ansible 命令执行来源</h4><ul><li>USER 普通用户，即SYSTEM ADMINISTRATOR</li><li>PLAYBOOKS：任务剧本（任务集），编排定义Ansible任务集的配置文件，由Ansible顺序依次执行，通常是JSON格式的YML文件</li><li>CMDB（配置管理数据库） API 调用</li><li>PUBLIC/PRIVATE CLOUD API调用</li><li>USER-&gt; Ansible Playbook -&gt; Ansibile</li></ul><h4 id="2-3-3-注意事项"><a href="#2-3-3-注意事项" class="headerlink" title="2.3.3 注意事项"></a>2.3.3 注意事项</h4><ul><li>执行ansible的主机一般称为管理端, 主控端，中控，master或堡垒机</li><li>主控端Python版本需要2.6或以上</li><li>被控端Python版本小于2.4，需要安装python-simplejson</li><li>被控端如开启SELinux需要安装libselinux-python</li><li>windows 不能做为主控端</li></ul><h2 id="三、Ansible-安装和入门"><a href="#三、Ansible-安装和入门" class="headerlink" title="三、Ansible 安装和入门"></a>三、Ansible 安装和入门</h2><h3 id="3-1-Ansible安装"><a href="#3-1-Ansible安装" class="headerlink" title="3.1 Ansible安装"></a>3.1 Ansible安装</h3><p>ansible的安装方法有多种<br>官方方档</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html<br></code></pre></td></tr></table></figure><p>下载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://releases.ansible.com/ansible/<br></code></pre></td></tr></table></figure><p>pip 下载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://pypi.org/project/ansible/   <br></code></pre></td></tr></table></figure><h4 id="3-1-1-EPEL源的rpm包安装"><a href="#3-1-1-EPEL源的rpm包安装" class="headerlink" title="3.1.1 EPEL源的rpm包安装:"></a>3.1.1 EPEL源的rpm包安装:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install ansible -y<br></code></pre></td></tr></table></figure><h4 id="3-1-2-编译安装"><a href="#3-1-2-编译安装" class="headerlink" title="3.1.2 编译安装"></a>3.1.2 编译安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum -y install python-jinja2 PyYAML python-paramiko python-babel python-crypto<br><br>wget https://releases.ansible.com/ansible/ansible-1.5.4.tar.gz<br><br>tar xf ansible-1.5.4.tar.gz<br><span class="hljs-built_in">cd</span> ansible-1.5.4<br>python setup.py build<br>python setup.py install<br>mkdir /etc/ansible<br>cp -r examples/* /etc/ansible<br></code></pre></td></tr></table></figure><h4 id="3-1-3-Git方式"><a href="#3-1-3-Git方式" class="headerlink" title="3.1.3 Git方式"></a>3.1.3 Git方式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> git://github.com/ansible/ansible.git --recursive<br><span class="hljs-built_in">cd</span> ./ansible<br><span class="hljs-built_in">source</span> ./hacking/env-setup<br></code></pre></td></tr></table></figure><h4 id="3-1-4-pip-安装"><a href="#3-1-4-pip-安装" class="headerlink" title="3.1.4 pip 安装"></a>3.1.4 pip 安装</h4><p>pip 是安装Python包的管理器，类似 yum</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#yum install python-pip</span><br>[root@centos7 ~]<span class="hljs-comment">#pip install --upgrade pip</span><br>[root@centos7 ~]<span class="hljs-comment">#pip install ansible --upgrade</span><br>[root@centos7 ~]<span class="hljs-comment">#ansible --version</span><br>/usr/lib64/python2.7/site-packages/cryptography/__init__.py:39:<br>CryptographyDeprecationWarning: Python 2 is no longer supported by the Python<br>core team. Support <span class="hljs-keyword">for</span> it is now deprecated <span class="hljs-keyword">in</span> cryptography, and will be removedin a future release.<br>CryptographyDeprecationWarning,<br>ansible 2.9.12<br>config file = None<br>configured module search path = [u<span class="hljs-string">&#x27;/root/.ansible/plugins/modules&#x27;</span>,<br>u<span class="hljs-string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]<br>ansible python module location = /usr/lib/python2.7/site-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 2.7.5 (default, Apr  2 2020, 13:16:51) [GCC 4.8.5 20150623<br>(Red Hat 4.8.5-39)]<br><br>[root@centos7 ~]<span class="hljs-comment">#ll /opt/etc/ansible/ansible.cfg</span><br>-rw-r--r-- 1 wang bin 19980 Aug 11 21:34 /opt/etc/ansible/ansible.cfg<br></code></pre></td></tr></table></figure><h4 id="3-1-5-确认安装"><a href="#3-1-5-确认安装" class="headerlink" title="3.1.5 确认安装"></a>3.1.5 确认安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible --version</span><br>ansible 2.9.5<br>config file = /etc/ansible/ansible.cfg<br>configured module search path = [<span class="hljs-string">&#x27;/root/.ansible/plugins/modules&#x27;</span>,<br><span class="hljs-string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]<br>ansible python module location = /usr/lib/python3.6/site-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 3.6.8 (default, Nov 21 2019, 19:31:34) [GCC 8.3.1 20190507<br>(Red Hat 8.3.1-4)]<br></code></pre></td></tr></table></figure><h3 id="3-2-Ansible-相关文件"><a href="#3-2-Ansible-相关文件" class="headerlink" title="3.2 Ansible 相关文件"></a>3.2 Ansible 相关文件</h3><h4 id="3-2-1-配置文件"><a href="#3-2-1-配置文件" class="headerlink" title="3.2.1 配置文件"></a>3.2.1 配置文件</h4><ul><li>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性</li><li>/etc/ansible/hosts 主机清单</li><li>/etc/ansible/roles/ 存放角色的目录</li></ul><h4 id="3-2-2-ansible-主配置文件"><a href="#3-2-2-ansible-主配置文件" class="headerlink" title="3.2.2 ansible 主配置文件"></a>3.2.2 ansible 主配置文件</h4><p>Ansible 的配置文件 /etc/ansible/ansible.cfg ,其中大部分的配置内容无需进行修改</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/ansible/ansible.cfg<br>[defaults]<br><span class="hljs-comment">#inventory   = /etc/ansible/hosts # 主机列表配置文件</span><br><span class="hljs-comment">#library = /usr/share/my_modules/ # 库文件存放目录</span><br><span class="hljs-comment">#remote_tmp = $HOME/.ansible/tmp #临时py命令文件存放在远程主机目录</span><br><span class="hljs-comment">#local_tmp   = $HOME/.ansible/tmp # 本机的临时命令执行目录</span><br><span class="hljs-comment">#forks     = 5  # 默认并发数</span><br><span class="hljs-comment">#sudo_user   = root # 默认sudo 用户</span><br><span class="hljs-comment">#ask_sudo_pass = True #每次执行ansible命令是否询问ssh密码</span><br><span class="hljs-comment">#ask_pass   = True </span><br><span class="hljs-comment">#remote_port  = 22</span><br><span class="hljs-comment">#host_key_checking = False # 检查对应服务器的host_key，建议取消注释</span><br><span class="hljs-comment">#log_path=/var/log/ansible.log #日志文件，建议启用</span><br><span class="hljs-comment">#module_name = command  #默认模块，可以修改为shell模块</span><br></code></pre></td></tr></table></figure><h4 id="3-2-3-inventory-主机清单"><a href="#3-2-3-inventory-主机清单" class="headerlink" title="3.2.3 inventory 主机清单"></a>3.2.3 inventory 主机清单</h4><p>ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory file中将其分组命名<br>默认的inventory file为 /etc/ansible/hosts<br>inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成<br>官方文档:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html<br></code></pre></td></tr></table></figure><p><strong>主机清单文件格式</strong><br>inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中<br>此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明<br>如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/ansible/hosts<br>ntp.magedu.com<br><br>[webservers]<br>www1.magedu.com:2222<br>www2.magedu.com<br><br>[dbservers]<br>db1.magedu.com<br>db2.magedu.com<br>db3.magedu.com<br><br>[websrvs]<br>www[1:100].example.com<br><br>[dbsrvs]<br>db-[a:f].example.com<br><br>[appsrvs]<br>10.0.0.[1:100]<br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/ansible/hosts<br><br>[<span class="hljs-built_in">test</span>]<br>10.0.0.8  ansible_connection=<span class="hljs-built_in">local</span>  <span class="hljs-comment">#指定本地连接,无需ssh配置</span><br><br>[websrvs]<br>10.0.0.7<br>10.0.0.8<br><br>[appsrvs]<br>10.0.0.7<br>10.0.0.6<br><br>[dbsrvs]<br>10.0.0.8<br>10.0.0.18 ansible_connection=<span class="hljs-built_in">local</span><br><br><br><span class="hljs-comment">#ansible_connection=ssh 需要StrictHostKeyChecking no</span><br><span class="hljs-comment">#一般使用ansible控制别的主机都是使用root，所以后面的参数这些可以省略不写</span><br>10.0.0.7  ansible_connection=ssh  ansible_port=2222  ansible_user=wang<br>ansible_password=magedu <br>10.0.0.6  ansible_connection=ssh  ansible_user=root  ansible_password=123456<br><br><span class="hljs-comment">#查看可以连接的主机</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all --list-hosts</span><br>  hosts (4):<br>    10.0.0.7<br>    10.0.0.6<br>    10.0.0.8<br>    10.0.0.18<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs --list-hosts</span><br>  hosts (2):<br>    10.0.0.7<br>    10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment"># ansible appsrvs --list-hosts</span><br>  hosts (2):<br>    10.0.0.7<br>    10.0.0.6<br>[root@centos7 ~]<span class="hljs-comment"># ansible dbsrvs --list-hosts</span><br>  hosts (2):<br>    10.0.0.8<br>    10.0.0.18<br><br></code></pre></td></tr></table></figure><p>3.3 Ansible相关工具</p><ul><li><p>/usr/bin/ansible 主程序，临时命令执行工具</p></li><li><p>/usr/bin/ansible-doc 查看配置文档，模块功能查看工具,相当于man</p></li><li><p>/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具,相当于脚本</p></li><li><p>/usr/bin/ansible-pull 远程执行命令的工具</p></li><li><p>/usr/bin/ansible-vault 文件加密工具</p></li><li><p>/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</p></li><li><p>/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台</p></li></ul><p><strong>利用ansible实现管理的主要方式：</strong></p><ul><li>Ad-Hoc 即利用ansible命令，主要用于临时命令使用场景</li><li>Ansible-playbook 主要用于长期规划好的，大型项目的场景，需要有前期的规划过程</li></ul><h4 id="3-3-1-ansible-doc"><a href="#3-3-1-ansible-doc" class="headerlink" title="3.3.1 ansible-doc"></a>3.3.1 ansible-doc</h4><p>此工具用来显示模块帮助,相当于man<br>格式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible-doc [options] [module...]<br>-l, --list    <span class="hljs-comment">#列出可用模块</span><br>-s, --snippet <span class="hljs-comment">#显示指定模块的playbook片段</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#列出所有模块</span><br>[root@centos7 ~]<span class="hljs-comment">#ansible-doc -l </span><br>[root@centos7 ~]<span class="hljs-comment"># ansible-doc -l | wc -l</span><br>3387<br><br><span class="hljs-comment">#查看指定模块帮助用法</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible-doc ping </span><br><br><span class="hljs-comment">#查看指定模块帮助用法</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible-doc -s ping</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># date</span><br>Wed Jun 17 16:08:09 CST 2020<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible --version</span><br>ansible 2.9.9<br>config file = /etc/ansible/ansible.cfg<br>configured module search path = [<span class="hljs-string">&#x27;/root/.ansible/plugins/modules&#x27;</span>,<br><span class="hljs-string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]<br>ansible python module location = /usr/lib/python3.6/site-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 3.6.8 (default, Apr 16 2020, 01:36:27) [GCC 8.3.1 20191121<br>(Red Hat 8.3.1-5)]<br><br>[root@centos7 ~]<span class="hljs-comment">#ansible-doc -l|wc -l</span><br>3387<br></code></pre></td></tr></table></figure><h4 id="3-3-2-ansible"><a href="#3-3-2-ansible" class="headerlink" title="3.3.2 ansible"></a>3.3.2 ansible</h4><p>此工具通过ssh协议，实现对远程主机的配置管理、应用部署、任务执行等功能<br>建议：使用此工具前，先配置ansible主控端能基于密钥认证的方式联系各个被管理节点<br>范例：利用sshpass批量实现基于key验证脚本1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#其他被管理的主机</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/ssh/ssh_config</span><br><span class="hljs-comment">#修改下面一行</span><br>StrictHostKeyChecking no<br><br>[root@centos7 ~]<span class="hljs-comment">#cat hosts.list</span><br>10.0.0.18<br>10.0.0.28<br><br>[root@centos7 ~]<span class="hljs-comment">#vim push_ssh_key.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass <br>[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa  -P <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-built_in">export</span> SSHPASS=magedu<br><span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> IP;<span class="hljs-keyword">do</span><br> sshpass -e ssh-copy-id  -o StrictHostKeyChecking=no <span class="hljs-variable">$IP</span><br><span class="hljs-keyword">done</span> &lt; hosts.list<br></code></pre></td></tr></table></figure><p>范例: 实现基于key验证的脚本2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在控制的主机中使用</span><br>[root@centos7 ~]<span class="hljs-comment">#cat ssh_key.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#Author: wangxiaochun</span><br><span class="hljs-comment">#QQ: 29308620</span><br><span class="hljs-comment">#Date: 2020-08-11</span><br><span class="hljs-comment">#FileName： ssh_key.sh</span><br><span class="hljs-comment">#URL: http://www.wangxiaochun.com</span><br><span class="hljs-comment">#Description： The test script</span><br><span class="hljs-comment">#Copyright (C): 2020 All rights reserved</span><br><span class="hljs-comment">#********************************************************************</span><br>IPLIST=<span class="hljs-string">&quot;</span><br><span class="hljs-string">10.0.0.8</span><br><span class="hljs-string">10.0.0.18</span><br><span class="hljs-string">10.0.0.7</span><br><span class="hljs-string">10.0.0.6</span><br><span class="hljs-string">10.0.0.200&quot;</span><br><br>rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass <br>[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-built_in">export</span> SSHPASS=123456<br><span class="hljs-keyword">for</span> IP <span class="hljs-keyword">in</span> <span class="hljs-variable">$IPLIST</span>;<span class="hljs-keyword">do</span><br> sshpass -e ssh-copy-id -o StrictHostKeyChecking=no <span class="hljs-variable">$IP</span><br><span class="hljs-keyword">done</span><br><br>bash ssh_key.sh<br></code></pre></td></tr></table></figure><p>格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible &lt;host-pattern&gt; [-m module_name] [-a args]<br></code></pre></td></tr></table></figure><p>选项说明：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">--version <span class="hljs-comment">#显示版本</span><br>-m module  <span class="hljs-comment">#指定模块，默认为command</span><br>-v <span class="hljs-comment">#详细过程 –vv -vvv更详细</span><br>--list-hosts <span class="hljs-comment">#显示主机列表，可简写 --list</span><br>-C, --check  <span class="hljs-comment">#检查，并不执行</span><br>-T, --timeout=TIMEOUT <span class="hljs-comment">#执行命令的超时时间，默认10s</span><br>-k, --ask-pass   <span class="hljs-comment">#提示输入ssh连接密码，默认Key验证</span><br>-u, --user=REMOTE_USER <span class="hljs-comment">#执行远程执行的用户</span><br>-b, --become   <span class="hljs-comment">#代替旧版的sudo 切换</span><br>--become-user=USERNAME  <span class="hljs-comment">#指定sudo的runas用户，默认为root</span><br>-K, --ask-become-pass  <span class="hljs-comment">#提示输入sudo时的口令</span><br></code></pre></td></tr></table></figure><p><strong>ansible的Host-pattern</strong><br>用于匹配被控制的主机的列表<br>All ：表示所有Inventory中的所有主机<br>范例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#没有针对被管理的主机进行key验证</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m ping</span><br>The authenticity of host <span class="hljs-string">&#x27;10.0.0.7 (10.0.0.7)&#x27;</span> can<span class="hljs-string">&#x27;t be established.</span><br><span class="hljs-string">ECDSA key fingerprint is SHA256:/g7oV8Ok5sNGS6xH99L8QltH2EC3xhhP4p8agvdUV9s.</span><br><span class="hljs-string">ECDSA key fingerprint is MD5:2e:bd:75:ec:7d:0d:77:80:1e:90:ad:83:63:5e:4a:ac.</span><br><span class="hljs-string">Are you sure you want to continue connecting (yes/no)? The authenticity of host &#x27;</span>10.0.0.6 (10.0.0.6)<span class="hljs-string">&#x27; can&#x27;</span>t be established.<br>ECDSA key fingerprint is SHA256:/g7oV8Ok5sNGS6xH99L8QltH2EC3xhhP4p8agvdUV9s.<br>ECDSA key fingerprint is MD5:2e:bd:75:ec:7d:0d:77:80:1e:90:ad:83:63:5e:4a:ac.<br>Are you sure you want to <span class="hljs-built_in">continue</span> connecting (yes/no)? The authenticity of host <span class="hljs-string">&#x27;10.0.0.8 (10.0.0.8)&#x27;</span> can<span class="hljs-string">&#x27;t be established.</span><br><span class="hljs-string">ECDSA key fingerprint is SHA256:/g7oV8Ok5sNGS6xH99L8QltH2EC3xhhP4p8agvdUV9s.</span><br><span class="hljs-string">ECDSA key fingerprint is MD5:2e:bd:75:ec:7d:0d:77:80:1e:90:ad:83:63:5e:4a:ac.</span><br><span class="hljs-string">Are you sure you want to continue connecting (yes/no)? 10.0.0.18 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">yes</span><br><span class="hljs-string">10.0.0.7 | UNREACHABLE! =&gt; &#123;</span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;msg&quot;: &quot;Failed to connect to the host via ssh: Warning: Permanently added &#x27;</span>10.0.0.7<span class="hljs-string">&#x27; (ECDSA) to the list of known hosts.\r\nPermission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&quot;, </span><br><span class="hljs-string">    &quot;unreachable&quot;: true</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">yes</span><br><span class="hljs-string">10.0.0.6 | UNREACHABLE! =&gt; &#123;</span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;msg&quot;: &quot;Failed to connect to the host via ssh: Warning: Permanently added &#x27;</span>10.0.0.6<span class="hljs-string">&#x27; (ECDSA) to the list of known hosts.\r\nPermission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&quot;, </span><br><span class="hljs-string">    &quot;unreachable&quot;: true</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">yes</span><br><span class="hljs-string">10.0.0.8 | UNREACHABLE! =&gt; &#123;</span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;msg&quot;: &quot;Failed to connect to the host via ssh: Warning: Permanently added &#x27;</span>10.0.0.8<span class="hljs-string">&#x27; (ECDSA) to the list of known hosts.\r\nPermission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&quot;, </span><br><span class="hljs-string">    &quot;unreachable&quot;: true</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">#没有针对被管理的主机进行key验证，但是有输入密码的，默认是root</span><br><span class="hljs-string">[root@centos7 ~]# ansible 10.0.0.7 -k -m ping</span><br><span class="hljs-string">SSH password: </span><br><span class="hljs-string">10.0.0.7 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">#有对主机进行key验证</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible all -m ping</span><br><span class="hljs-string">10.0.0.18 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">10.0.0.7 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">10.0.0.8 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">10.0.0.6 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><p>*:通配符</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible &quot;*&quot; -m ping</span><br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible 10.0.0.* -m ping</span><br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;*srvs&quot; -m ping</span><br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;10.0.0.6 10.0.0.7&quot; -m ping</span><br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>或关系</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible &quot;websrvs:appsrvs&quot; -m ping</span><br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;10.0.0.6:10.0.0.7&quot; -m ping</span><br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;10.0.0.6:10.0.0.7:10.0.0.8&quot; -m ping</span><br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>逻辑与</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在websrvs组并且在dbsrvs组中的主机</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;websrvs:&amp;dbsrvs&quot; -m ping</span><br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>逻辑非</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在websrvs组，但不在dbsrvs组中的主机</span><br><span class="hljs-comment">#注意：此处为单引号</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible &#x27;websrvs:!dbsrvs&#x27; -m ping</span><br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>综合逻辑</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible &#x27;websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs&#x27; -m ping</span><br>[WARNING]: Could not match supplied host pattern, ignoring: ftpsrvs<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>正则表达式</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible &quot;websrvs:dbsrvs&quot; -m ping</span><br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;~(web|db).*&quot; -m ping</span><br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible &#x27;kube*:etcd:!10.0.0.101&#x27; -a reboot&amp;&amp;reboot</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible all --list-hosts </span><br>hosts (3):<br>  10.0.0.6<br>  10.0.0.7<br>  10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment">#ansible websrvs --list-hosts </span><br>hosts (3):<br>  10.0.0.6<br>  10.0.0.7<br>  10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment">#ansible appsrvs --list-hosts </span><br>hosts (2):<br>  10.0.0.7<br>  10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment">#ansible &quot;appsrvs:dbsrvs&quot; --list-hosts </span><br>hosts (3):<br>  10.0.0.7<br>  10.0.0.8<br>  10.0.0.6<br>[root@centos7 ~]<span class="hljs-comment">#ansible &quot;dbsrvs&quot; --list-hosts </span><br>hosts (2):<br>  10.0.0.6<br>  10.0.0.7<br>[root@centos7 ~]<span class="hljs-comment">#ansible appsrvs --list-hosts </span><br>hosts (2):<br>  10.0.0.7<br>  10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment">#ansible &quot;appsrvs:dbsrvs&quot; --list-hosts </span><br>hosts (3):<br>  10.0.0.7<br>  10.0.0.8<br>  10.0.0.6<br>[root@centos7 ~]<span class="hljs-comment">#ansible &quot;appsrvs:&amp;dbsrvs&quot; --list-hosts </span><br>hosts (1):<br>  10.0.0.7<br>[root@centos7 ~]<span class="hljs-comment">#ansible &quot;appsrvs:!dbsrvs&quot; --list-hosts </span><br>-bash: !dbsrvs: event not found<br>[root@centos7 ~]<span class="hljs-comment">#ansible &#x27;appsrvs:!dbsrvs&#x27; --list-hosts </span><br>hosts (1):<br>  10.0.0.8<br></code></pre></td></tr></table></figure><p><strong>ansible命令执行过程</strong></p><ol><li><p>加载自己的配置文件,默认/etc/ansible/ansible.cfg</p></li><li><p>加载自己对应的模块文件，如：command</p></li><li><p>通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服务器的对应执行用户<br>$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件</p></li><li><p>给文件+x执行</p></li><li><p>执行并返回结果</p></li><li><p>删除临时py文件，退出</p></li></ol><p><strong>ansible 的执行状态：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#grep -A 14 &#x27;\[colors\]&#x27; /etc/ansible/ansible.cfg</span><br>[colors]<br><span class="hljs-comment">#highlight = white</span><br><span class="hljs-comment">#verbose = blue</span><br><span class="hljs-comment">#warn = bright purple</span><br><span class="hljs-comment">#error = red</span><br><span class="hljs-comment">#debug = dark gray</span><br><span class="hljs-comment">#deprecate = purple</span><br><span class="hljs-comment">#skip = cyan</span><br><span class="hljs-comment">#unreachable = red</span><br><span class="hljs-comment">#ok = green</span><br><span class="hljs-comment">#changed = yellow</span><br><span class="hljs-comment">#diff_add = green</span><br><span class="hljs-comment">#diff_remove = red</span><br><span class="hljs-comment">#diff_lines = cyan</span><br></code></pre></td></tr></table></figure><ul><li>绿色：执行成功并且不需要做改变的操作</li><li>黄色：执行成功并且对目标主机做变更</li><li>红色：执行失败</li></ul><p><strong>ansible使用范例</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#以wang用户执行ping存活检测</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m ping -u rlin -k</span><br>SSH password: <br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">#以wang sudo至root执行ping存活检测</span><br><span class="hljs-string">ansible all -m ping -u rlin -k -b</span><br><span class="hljs-string">#以wang sudo至mage用户执行ping存活检测</span><br><span class="hljs-string">ansible all -m ping -u rlin -k -b --become-user=mage</span><br><span class="hljs-string">#以wang sudo至root用户执行ls</span><br><span class="hljs-string">ansible all -m command -u rlin -a &#x27;ls /root&#x27; -b --become-user=root -k -K</span><br></code></pre></td></tr></table></figure><h4 id="3-3-3-ansible-playbook"><a href="#3-3-3-ansible-playbook" class="headerlink" title="3.3.3 ansible-playbook"></a>3.3.3 ansible-playbook</h4><p>此工具用于执行编写好的 playbook 任务<br>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim hello.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment">#hello world yml file</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span> <span class="hljs-string">world</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/usr/bin/wall</span> <span class="hljs-string">hello</span> <span class="hljs-string">world</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook hello.yml</span><br><br><span class="hljs-string">PLAY</span> [<span class="hljs-string">websrvs</span>] <span class="hljs-string">******************************************************************************************************</span><br><br><span class="hljs-string">TASK</span> [<span class="hljs-string">hello</span> <span class="hljs-string">world</span>] <span class="hljs-string">**************************************************************************************************</span><br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span>]<br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span>]<br><br><span class="hljs-string">PLAY</span> <span class="hljs-string">RECAP</span> <span class="hljs-string">**********************************************************************************************************</span><br><span class="hljs-attr">10.0.0.7                   :</span> <span class="hljs-string">ok=1</span>    <span class="hljs-string">changed=1</span>    <span class="hljs-string">unreachable=0</span>    <span class="hljs-string">failed=0</span>    <span class="hljs-string">skipped=0</span>    <span class="hljs-string">rescued=0</span>    <span class="hljs-string">ignored=0</span>   <br><span class="hljs-attr">10.0.0.8                   :</span> <span class="hljs-string">ok=1</span>    <span class="hljs-string">changed=1</span>    <span class="hljs-string">unreachable=0</span>    <span class="hljs-string">failed=0</span>    <span class="hljs-string">skipped=0</span>    <span class="hljs-string">rescued=0</span>    <span class="hljs-string">ignored=0</span>   <br><br><br></code></pre></td></tr></table></figure><h4 id="3-3-4-ansible-vault"><a href="#3-3-4-ansible-vault" class="headerlink" title="3.3.4 ansible-vault"></a>3.3.4 ansible-vault</h4><p>此工具可以用于加密解密yml文件<br>格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible-vault [create|decrypt|edit|encrypt|rekey|view]<br></code></pre></td></tr></table></figure><p>范例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible-vault encrypt hello.yml <span class="hljs-comment">#加密</span><br>ansible-vault decrypt hello.yml <span class="hljs-comment">#解密</span><br>ansible-vault view hello.yml <span class="hljs-comment">#查看</span><br>ansible-vault edit hello.yml <span class="hljs-comment">#编辑加密文件</span><br>ansible-vault rekey hello.yml <span class="hljs-comment">#修改口令</span><br>ansible-vault create new.yml <span class="hljs-comment">#创建新文件</span><br></code></pre></td></tr></table></figure><p>范例：加密hello.yaml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible-vault encrypt hello.yml</span><br>New Vault password: <br>Confirm New Vault password: <br>Encryption successful<br><br><span class="hljs-comment">#查看加密后的yml文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cat hello.yml </span><br><span class="hljs-variable">$ANSIBLE_VAULT</span>;1.1;AES256<br>39643437646163303761663565383564383436346436646530363764356531613435653838306437<br>3165623061363337643163353533363738636232613561630a623766363132323064663963636631<br>36643637353835663065663530646161333839636165646530623964346564396562633237373962<br>3035636531336263310a393365333663613735626462373934616633653932336336656637663735<br>30306364656438623135396636623965306330393163656632666465616464656361363634373762<br>38643334333939326435396464313264323362626261366664613534623335336135333364643864<br>37343031396639626137383534383566353463366635633364363364643432376337646237366337<br>33353432366338346437643635363561623063316234383465643031363831386661343738336661<br>33356462303966376239626230313566663035636333666463623264333335303361356135373463<br>33616661633237326132623433633233633364376437666135306563636131396665393332363538<br>66653436623465343263636536626236343936353836383462323830613065306339646463633666<br>33636264643539386231<br><br></code></pre></td></tr></table></figure><p>范例：解密hello.yml文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible-vault decrypt hello.yml</span><br>Vault password: <br>Decryption successful<br><br><span class="hljs-comment">#查看解密后的yml文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cat hello.yml </span><br>---<br><span class="hljs-comment">#hello world yml file</span><br>- hosts: websrvs<br>  remote_user: root<br>  gather_facts: no<br>  tasks:<br>    - name: hello world<br>      <span class="hljs-built_in">command</span>: /usr/bin/wall hello world<br><br></code></pre></td></tr></table></figure><h4 id="3-3-5-ansible-console"><a href="#3-3-5-ansible-console" class="headerlink" title="3.3.5 ansible-console"></a>3.3.5 ansible-console</h4><p>此工具可交互执行命令，支持tab，ansible 2.0+新增<br>提示符格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$<br></code></pre></td></tr></table></figure><p><strong>常用子命令：</strong></p><ul><li>设置并发数： forks n 例如： forks 10</li><li>切换组： cd 主机组 例如： cd web</li><li>列出当前组主机列表： list</li><li>列出所有的内置命令： ?或help</li></ul><p>范例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-console</span><br><span class="hljs-string">Welcome</span> <span class="hljs-string">to</span> <span class="hljs-string">the</span> <span class="hljs-string">ansible</span> <span class="hljs-string">console.</span><br><span class="hljs-string">Type</span> <span class="hljs-string">help</span> <span class="hljs-string">or</span> <span class="hljs-string">?</span> <span class="hljs-string">to</span> <span class="hljs-string">list</span> <span class="hljs-string">commands.</span><br><br><span class="hljs-string">root@all</span> <span class="hljs-string">(3)[f:5]$</span> <span class="hljs-string">ping</span><br><span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span> <span class="hljs-string">|</span> <span class="hljs-string">SUCCESS</span> <span class="hljs-string">=&gt;</span> &#123;<br>  <span class="hljs-attr">&quot;ansible_facts&quot;:</span> &#123;<br>    <span class="hljs-attr">&quot;discovered_interpreter_python&quot;:</span> <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br> &#125;,<br>  <span class="hljs-attr">&quot;changed&quot;:</span> <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;ping&quot;:</span> <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.6</span> <span class="hljs-string">|</span> <span class="hljs-string">SUCCESS</span> <span class="hljs-string">=&gt;</span> &#123;<br>  <span class="hljs-attr">&quot;ansible_facts&quot;:</span> &#123;<br>    <span class="hljs-attr">&quot;discovered_interpreter_python&quot;:</span> <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br> &#125;,<br>  <span class="hljs-attr">&quot;changed&quot;:</span> <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;ping&quot;:</span> <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span> <span class="hljs-string">|</span> <span class="hljs-string">SUCCESS</span> <span class="hljs-string">=&gt;</span> &#123;<br>  <span class="hljs-attr">&quot;ansible_facts&quot;:</span> &#123;<br>    <span class="hljs-attr">&quot;discovered_interpreter_python&quot;:</span> <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span><br> &#125;,<br> <span class="hljs-attr">&quot;changed&quot;:</span> <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;ping&quot;:</span> <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><span class="hljs-string">root@all</span> <span class="hljs-string">(3)[f:5]$</span> <span class="hljs-string">list</span><br><span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span><br><span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span><br><span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.6</span><br><span class="hljs-string">root@all</span> <span class="hljs-string">(3)[f:5]$</span> <span class="hljs-string">cd</span> <span class="hljs-string">websrvs</span><br><span class="hljs-string">root@websrvs</span> <span class="hljs-string">(2)[f:5]$</span> <span class="hljs-string">list</span><br><span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span><br><span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span><br><span class="hljs-string">root@websrvs</span> <span class="hljs-string">(2)[f:5]$</span> <span class="hljs-string">forks</span> <span class="hljs-number">10</span><br><span class="hljs-string">root@websrvs</span> <span class="hljs-string">(2)[f:10]$</span> <span class="hljs-string">cd</span> <span class="hljs-string">appsrvs</span><br><span class="hljs-string">root@appsrvs</span> <span class="hljs-string">(2)[f:5]$</span> <span class="hljs-string">yum</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=present</span><br><span class="hljs-string">root@appsrvs</span> <span class="hljs-string">(2)[f:5]$</span> <span class="hljs-string">service</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span><br></code></pre></td></tr></table></figure><h4 id="3-3-6-ansible-galaxy"><a href="#3-3-6-ansible-galaxy" class="headerlink" title="3.3.6 ansible-galaxy"></a>3.3.6 ansible-galaxy</h4><p>此工具会连接 <a href="https://galaxy.ansible.com/">https://galaxy.ansible.com</a> 下载相应的roles<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#列出所有已安装的galaxy</span><br>ansible-galaxy list<br><span class="hljs-comment">#安装galaxy</span><br>ansible-galaxy install geerlingguy.mysql<br>ansible-galaxy install geerlingguy.redis<br><span class="hljs-comment">#删除galaxy</span><br>ansible-galaxy remove geerlingguy.redis<br>ansible-galaxy install geerlingguy.mysql<br></code></pre></td></tr></table></figure><h3 id="3-4-Ansible常用模块"><a href="#3-4-Ansible常用模块" class="headerlink" title="3.4 Ansible常用模块"></a>3.4 Ansible常用模块</h3><p>2015年底270多个模块，2016年达到540个，2018年01月12日有1378个模块，2018年07月15日1852个模块,2019年05月25日（ansible 2.7.10）时2080个模块，2020年03月02日有3387个模块<br>虽然模块众多，但最常用的模块也就2，30个而已，针对特定业务只用10几个模块<br>常用模块帮助文档参考：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.ansible.com/ansible/2.9/modules/modules_by_category.html<br>https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html<br><br>https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html<br>https://docs.ansible.com/ansible/latest/modules/modules_by_category.html<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible11.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible12.jpg"></p><h4 id="3-4-1-Command-模块"><a href="#3-4-1-Command-模块" class="headerlink" title="3.4.1 Command 模块"></a>3.4.1 Command 模块</h4><p>功能：在远程主机执行命令，此为默认模块，可忽略-m选项<br>注意：此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等，用shell模块实现<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible websrvs -m command -a &#x27;chdir=/etc cat centos-release&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>CentOS Linux release 7.7.1908 (Core)<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>CentOS Linux release 8.1.1911 (Core)<br>[root@centos7 ~]<span class="hljs-comment">#ansible websrvs -m command -a &#x27;chdir=/etc creates=/data/f1.txt cat centos-release&#x27;</span><br>cat centos-release<span class="hljs-string">&#x27;</span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">CentOS Linux release 7.7.1908 (Core)</span><br><span class="hljs-string">10.0.0.8 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="hljs-string">skipped, since /data/f1.txt exists</span><br><span class="hljs-string">[root@centos7 ~]#ansible websrvs -m command -a &#x27;</span><span class="hljs-built_in">chdir</span>=/etc removes=/data/f1.txt cat centos-release<span class="hljs-string">&#x27;</span><br><span class="hljs-string">10.0.0.7 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="hljs-string">skipped, since /data/f1.txt does not exist</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">CentOS Linux release 8.1.1911 (Core)</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible all -m command -a &#x27;</span>hostname<span class="hljs-string">&#x27;</span><br><span class="hljs-string">10.0.0.18 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">centos7.4</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">centos7.4</span><br><span class="hljs-string">10.0.0.6 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">centos7.4</span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">centos7.4</span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>mkdir -p /data<span class="hljs-string">&#x27;</span><br><span class="hljs-string">[WARNING]: Consider using the file module with state=directory rather than running &#x27;</span>mkdir<span class="hljs-string">&#x27;.  If you need to use</span><br><span class="hljs-string">command because file is insufficient you can add &#x27;</span>warn: <span class="hljs-literal">false</span><span class="hljs-string">&#x27; to this command task or set &#x27;</span>command_warnings=False<span class="hljs-string">&#x27;</span><br><span class="hljs-string">in ansible.cfg to get rid of this message.</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>touch /data/ansible.log<span class="hljs-string">&#x27;</span><br><span class="hljs-string">[WARNING]: Consider using the file module with state=touch rather than running &#x27;</span>touch<span class="hljs-string">&#x27;.  If you need to use command</span><br><span class="hljs-string">because file is insufficient you can add &#x27;</span>warn: <span class="hljs-literal">false</span><span class="hljs-string">&#x27; to this command task or set &#x27;</span>command_warnings=False<span class="hljs-string">&#x27; in</span><br><span class="hljs-string">ansible.cfg to get rid of this message.</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>ls /data -l<span class="hljs-string">&#x27;</span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">total 0</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:49 ansible.log</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">total 0</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:49 ansible.log</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>touch /data/hello.log<span class="hljs-string">&#x27;</span><br><span class="hljs-string">[WARNING]: Consider using the file module with state=touch rather than running &#x27;</span>touch<span class="hljs-string">&#x27;.  If you need to use command</span><br><span class="hljs-string">because file is insufficient you can add &#x27;</span>warn: <span class="hljs-literal">false</span><span class="hljs-string">&#x27; to this command task or set &#x27;</span>command_warnings=False<span class="hljs-string">&#x27; in</span><br><span class="hljs-string">ansible.cfg to get rid of this message.</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>creates=/data/ansible2.log touch /data/ansible2.log<span class="hljs-string">&#x27;</span><br><span class="hljs-string">[WARNING]: Consider using the file module with state=touch rather than running &#x27;</span>touch<span class="hljs-string">&#x27;.  If you need to use command</span><br><span class="hljs-string">because file is insufficient you can add &#x27;</span>warn: <span class="hljs-literal">false</span><span class="hljs-string">&#x27; to this command task or set &#x27;</span>command_warnings=False<span class="hljs-string">&#x27; in</span><br><span class="hljs-string">ansible.cfg to get rid of this message.</span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>ls -l /data<span class="hljs-string">&#x27;</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">total 0</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:52 ansible2.log</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:49 ansible.log</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:50 hello.log</span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">total 0</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:52 ansible2.log</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:49 ansible.log</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:50 hello.log</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><h4 id="3-4-2-Shell-模块"><a href="#3-4-2-Shell-模块" class="headerlink" title="3.4.2 Shell 模块"></a>3.4.2 Shell 模块</h4><p>功能：和command相似，用shell执行命令,支持各种符号,比如:*,$, &gt;<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m shell -a &quot;echo $HOSTNAME&quot;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>ansible<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>ansible<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m shell -a &#x27;echo $HOSTNAME&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>centos7.wangxiaochun.com<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>centos8.localdomain<br>[root@centos7 ~]<span class="hljs-comment">#ansible websrvs -m shell -a &#x27;echo centos | passwd --stdin wang&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>Changing password <span class="hljs-keyword">for</span> user wang.<br>passwd: all authentication tokens updated successfully.<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>Changing password <span class="hljs-keyword">for</span> user wang.<br>passwd: all authentication tokens updated successfully.<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m shell -a &#x27;ls -l /etc/shadow&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>---------- 1 root root 889 Mar  2 14:34 /etc/shadow<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>---------- 1 root root 944 Mar  2 14:34 /etc/shadow<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m shell -a &#x27;echo hello &gt; /data/hello.log&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m shell -a &#x27;cat /data/hello.log&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>hello<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>hello<br></code></pre></td></tr></table></figure><p>注意：调用bash执行命令 类似 cat /tmp/test.md | awk -F’|’ ‘{print $1,$2}’ &amp;&gt; /tmp/example.txt 这些复杂命令，即使使用shell也可能会失败，解决办法：写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器<br>范例：将shell模块代替command，设为模块</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># vim /etc/ansible/ansible.cfg</span><br><span class="hljs-comment">#修改下面一行</span><br>module_name = shell<br></code></pre></td></tr></table></figure><h4 id="3-4-3-Script-模块"><a href="#3-4-3-Script-模块" class="headerlink" title="3.4.3 Script 模块"></a>3.4.3 Script 模块</h4><p>功能：在远程主机上运行ansible服务器上的脚本(无需执行权限)<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># vim test.sh</span><br><span class="hljs-built_in">echo</span> `uname -a`<br><span class="hljs-built_in">echo</span> `hostname -I`<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m script -a test.sh</span><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;rc&quot;</span>: 0, <br>    <span class="hljs-string">&quot;stderr&quot;</span>: <span class="hljs-string">&quot;Shared connection to 10.0.0.7 closed.\r\n&quot;</span>, <br>    <span class="hljs-string">&quot;stderr_lines&quot;</span>: [<br>        <span class="hljs-string">&quot;Shared connection to 10.0.0.7 closed.&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;stdout&quot;</span>: <span class="hljs-string">&quot;Linux centos7.4 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n10.0.0.7\r\n&quot;</span>, <br>    <span class="hljs-string">&quot;stdout_lines&quot;</span>: [<br>        <span class="hljs-string">&quot;Linux centos7.4 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux&quot;</span>, <br>        <span class="hljs-string">&quot;10.0.0.7&quot;</span><br>    ]<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;rc&quot;</span>: 0, <br>    <span class="hljs-string">&quot;stderr&quot;</span>: <span class="hljs-string">&quot;Shared connection to 10.0.0.8 closed.\r\n&quot;</span>, <br>    <span class="hljs-string">&quot;stderr_lines&quot;</span>: [<br>        <span class="hljs-string">&quot;Shared connection to 10.0.0.8 closed.&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;stdout&quot;</span>: <span class="hljs-string">&quot;Linux centos7.4 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n10.0.0.8\r\n&quot;</span>, <br>    <span class="hljs-string">&quot;stdout_lines&quot;</span>: [<br>        <span class="hljs-string">&quot;Linux centos7.4 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux&quot;</span>, <br>        <span class="hljs-string">&quot;10.0.0.8&quot;</span><br>    ]<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="3-4-4-Copy-模块"><a href="#3-4-4-Copy-模块" class="headerlink" title="3.4.4 Copy 模块"></a>3.4.4 Copy 模块</h4><p>功能：从ansible服务器主控端复制文件到远程主机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#如目标存在，默认覆盖，此处指定先备份</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m copy -a &quot;src=/etc/centos-release dest=/data/release.txt  owner=wang mode=600 backup=yes&quot;</span><br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;0b2b27eb190f790ec5ff65897b3a1ef844f254c5&quot;</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/release.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;md5sum&quot;</span>: <span class="hljs-string">&quot;1bbbbf90102ed1317186597c4660e84a&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0600&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;wang&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;system_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 38, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615212848.14-8218-49950772426522/source&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1001<br>&#125;<br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;0b2b27eb190f790ec5ff65897b3a1ef844f254c5&quot;</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/release.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;md5sum&quot;</span>: <span class="hljs-string">&quot;1bbbbf90102ed1317186597c4660e84a&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0600&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;wang&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;system_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 38, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615212848.14-8217-112917478920795/source&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1001<br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs  -m command -a &#x27;ls -l /data&#x27;</span><br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>total 8<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>total 8<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br><br><br><span class="hljs-comment">#指定内容，直接生成目标文件  </span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m copy -a &quot;content=&#x27;test line1\ntest line2&#x27; dest=/data/test.txt&quot;</span><br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;43791ccbbcf72774b2bbbe6fe8d7ab488359b922&quot;</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;md5sum&quot;</span>: <span class="hljs-string">&quot;f0e596e1a1a3ef7d278f2dda4d4e6ec8&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;system_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 21, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615212961.65-8378-107969903896386/source&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;43791ccbbcf72774b2bbbe6fe8d7ab488359b922&quot;</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;md5sum&quot;</span>: <span class="hljs-string">&quot;f0e596e1a1a3ef7d278f2dda4d4e6ec8&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;system_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 21, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615212961.65-8377-267508619796205/source&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs  -m command -a &#x27;ls -l /data&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br><br><br><span class="hljs-comment">#复制/etc目录自身,注意/etc/后面没有/</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m copy -a &quot;src=/etc dest=/backup&quot;</span><br><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/backup/&quot;</span>, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/etc&quot;</span><br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/backup/&quot;</span>, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/etc&quot;</span><br>&#125;<br><br><span class="hljs-comment">#复制/etc/下的文件，不包括/etc/目录自身,注意/etc/后面有/</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m copy -a &quot;src=/etc/ dest=/backup&quot;</span><br><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/backup/&quot;</span>, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/etc/&quot;</span><br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/backup/&quot;</span>, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/etc/&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="3-4-5-Fetch-模块"><a href="#3-4-5-Fetch-模块" class="headerlink" title="3.4.5 Fetch 模块"></a>3.4.5 Fetch 模块</h4><p>功能：从远程主机提取文件至ansible的主控端，copy相反，目前不支持目录<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m fetch -a &#x27;src=/root/test.sh dest=/data/scripts&#x27;</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible  all -m fetch -a &#x27;src=/etc/redhat-release</span><br>dest=/data/os<span class="hljs-string">&#x27;</span><br><span class="hljs-string">[root@centos7 ~]#tree /data/os/</span><br><span class="hljs-string">/data/os/</span><br><span class="hljs-string">├── 10.0.0.6</span><br><span class="hljs-string">│  └── etc</span><br><span class="hljs-string">│    └── redhat-release</span><br><span class="hljs-string">├── 10.0.0.7</span><br><span class="hljs-string">│  └── etc</span><br><span class="hljs-string">│    └── redhat-release</span><br><span class="hljs-string">└── 10.0.0.8</span><br><span class="hljs-string"> └── etc</span><br><span class="hljs-string">   └── redhat-release</span><br><span class="hljs-string">6 directories, 3 files</span><br></code></pre></td></tr></table></figure><h4 id="3-4-6-File-模块"><a href="#3-4-6-File-模块" class="headerlink" title="3.4.6 File 模块"></a>3.4.6 File 模块</h4><p>功能：设置文件属性,创建软链接等<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建空文件</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m file -a &#x27;path=/data/test.txt state=touch&#x27;</span><br>10.0.0.18 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test1.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 0, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test1.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 0, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.6 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test1.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 0, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test1.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 0, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m file -a &quot;path=/root/test.sh owner=wang mode=755&quot;</span><br><br><span class="hljs-comment">#创建目录-例1</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m file -a &#x27;dest=/data/filedir state=directory&#x27;</span><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m command -a &#x27;ls -l /data&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>drwxr-xr-x. 2 root root  6 Mar  9 17:59 filedir<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>drwxr-xr-x. 2 root root  6 Mar  9 18:00 filedir<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br><br><span class="hljs-comment">#创建目录-例2</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m file -a &quot;path=/data/rlindir state=directory owner=rlin group=rlin&quot;</span><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 1000, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/rlindir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1000<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 1000, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/rlindir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1000<br>&#125;<br>10.0.0.18 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 1000, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/rlindir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1000<br>&#125;<br>10.0.0.6 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 1000, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/rlindir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1000<br>&#125;<br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m command -a &#x27;ls -l /data&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>drwxr-xr-x. 2 root root  6 Mar  9 17:59 filedir<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>drwxr-xr-x. 2 root root  6 Mar  9 18:01 mysql<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>drwxr-xr-x. 2 rlin rlin  6 Mar  9 18:01 rlindir<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br>10.0.0.6 | CHANGED | rc=0 &gt;&gt;<br>total 0<br>drwxr-xr-x. 2 rlin rlin 6 Mar  9 18:01 rlindir<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>drwxr-xr-x. 2 root root  6 Mar  9 18:00 filedir<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>drwxr-xr-x. 2 root root  6 Mar  9 18:01 mysql<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>drwxr-xr-x. 2 rlin rlin  6 Mar  9 18:01 rlindir<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br>10.0.0.18 | CHANGED | rc=0 &gt;&gt;<br>total 0<br>drwxr-xr-x. 2 rlin rlin 6 Mar  9 18:01 rlindir<br><br><br><span class="hljs-comment">#创建软链接</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m file -a &#x27;src=/data/testfile path|dest|name=/data/testfile-link state=link&#x27;</span><br><br><br><span class="hljs-comment">#递归修改目录属性</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m file -a &quot;path=/data/mysql state=directory owner=mysql group=mysql recurse=yes&quot;</span><br><br><span class="hljs-comment">#删除文件</span><br>[root@centos7 ~]<span class="hljs-comment">#  ansible websrvs -m file -a &#x27;dest=/data/filedir/a.txt state=absent&#x27;</span><br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir/a.txt&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;absent&quot;</span><br>&#125;<br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir/a.txt&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;absent&quot;</span><br>&#125;<br><br><span class="hljs-comment">#删除文件夹</span><br>[root@centos7 ~]<span class="hljs-comment">#  ansible websrvs -m file -a &#x27;dest=/data/filedir state=absent&#x27;</span><br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;absent&quot;</span><br>&#125;<br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;absent&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="3-4-7-unarchive-模块"><a href="#3-4-7-unarchive-模块" class="headerlink" title="3.4.7 unarchive 模块"></a>3.4.7 unarchive 模块</h4><p>功能：解包解压缩<br>实现有两种用法：<br>1、将ansible主机上的压缩包传到远程主机后解压缩至特定目录，设置copy=yes<br>2、将远程主机上的某个压缩包解压缩到指定路径下，设置copy=no<br>常见参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">copy：默认为yes，当copy=yes，拷贝的文件是从ansible主机复制到远程主机上，如果设置为<br>copy=no，会在远程主机上寻找src源文件<br>remote_src：和copy功能一样且互斥，yes表示在远程主机，不在ansible主机，no表示文件在ansible主机上<br>src：源路径，可以是ansible主机上的路径，也可以是远程主机(被管理端或者第三方主机)上的路径，如果是远程主机上的路径，则需要设置copy=no<br>dest：远程主机上的目标路径<br>mode：设置解压缩后的文件权限<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible all -m unarchive -a &#x27;src=/data/foo.tgz dest=/var/lib/foo owner=wang group=bin&#x27;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m unarchive -a &#x27;src=/tmp/foo.zip dest=/data copy=no mode=0777&#x27;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m unarchive -a &#x27;src=https://example.com/example.zip dest=/datacopy=no&#x27;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m unarchive -a &#x27;src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/data/  owner=mysql remote_src=yes&#x27;</span><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/&quot;</span>, <br>    <span class="hljs-string">&quot;extract_results&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;cmd&quot;</span>: [<br>            <span class="hljs-string">&quot;/usr/bin/gtar&quot;</span>, <br>            <span class="hljs-string">&quot;--extract&quot;</span>, <br>            <span class="hljs-string">&quot;-C&quot;</span>, <br>            <span class="hljs-string">&quot;/data/&quot;</span>, <br>            <span class="hljs-string">&quot;-z&quot;</span>, <br>            <span class="hljs-string">&quot;--owner=rlin&quot;</span>, <br>            <span class="hljs-string">&quot;-f&quot;</span>, <br>            <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615286342.0-95739-108372540609757/ansible-2.1.6.0-0.1.rc1.tar2EP0sV.gz&quot;</span><br>        ], <br>        <span class="hljs-string">&quot;err&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <br>        <span class="hljs-string">&quot;out&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <br>        <span class="hljs-string">&quot;rc&quot;</span>: 0<br>    &#125;, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;handler&quot;</span>: <span class="hljs-string">&quot;TgzArchive&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 165, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615286342.0-95739-108372540609757/ansible-2.1.6.0-0.1.rc1.tar2EP0sV.gz&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/&quot;</span>, <br>    <span class="hljs-string">&quot;extract_results&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;cmd&quot;</span>: [<br>            <span class="hljs-string">&quot;/usr/bin/gtar&quot;</span>, <br>            <span class="hljs-string">&quot;--extract&quot;</span>, <br>            <span class="hljs-string">&quot;-C&quot;</span>, <br>            <span class="hljs-string">&quot;/data/&quot;</span>, <br>            <span class="hljs-string">&quot;-z&quot;</span>, <br>            <span class="hljs-string">&quot;--owner=rlin&quot;</span>, <br>            <span class="hljs-string">&quot;-f&quot;</span>, <br>            <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615286341.99-95740-138957129216327/ansible-2.1.6.0-0.1.rc1.taro0JQVk.gz&quot;</span><br>        ], <br>        <span class="hljs-string">&quot;err&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <br>        <span class="hljs-string">&quot;out&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <br>        <span class="hljs-string">&quot;rc&quot;</span>: 0<br>    &#125;, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;handler&quot;</span>: <span class="hljs-string">&quot;TgzArchive&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 165, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615286341.99-95740-138957129216327/ansible-2.1.6.0-0.1.rc1.taro0JQVk.gz&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="3-4-8-Archive-模块"><a href="#3-4-8-Archive-模块" class="headerlink" title="3.4.8 Archive 模块"></a>3.4.8 Archive 模块</h4><p>功能：打包压缩保存在被管理节点<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m archive  -a &#x27;path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=wang mode=0600&#x27;</span><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;archived&quot;</span>: [<br>        <span class="hljs-string">&quot;/var/log/tallylog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/grubby_prune_debug&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/lastlog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/vmware-vgauthsvc.log.0&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/vmware-vmsvc.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/firewalld&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/yum.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/dmesg.old&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/dmesg&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/cron-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/cron&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/maillog-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/maillog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/messages-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/messages&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/secure-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/secure&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/spooler-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/spooler&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/btmp-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/btmp&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log-20210308&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log-20210309&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/wtmp-20210309&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/wtmp&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/tuned/tuned.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.4&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.3&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.2&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.1&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/anaconda.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/syslog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/X.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/program.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/packaging.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/storage.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ifcfg.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ks-script-14N23b.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ks-script-azeNm9.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/journal.log&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;arcroot&quot;</span>: <span class="hljs-string">&quot;/var/log/&quot;</span>, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/log.tar.bz2&quot;</span>, <br>    <span class="hljs-string">&quot;expanded_exclude_paths&quot;</span>: [], <br>    <span class="hljs-string">&quot;expanded_paths&quot;</span>: [<br>        <span class="hljs-string">&quot;/var/log/&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;missing&quot;</span>: [], <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0600&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;wang&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 1206553, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1001<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;archived&quot;</span>: [<br>        <span class="hljs-string">&quot;/var/log/tallylog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/grubby_prune_debug&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/lastlog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/vmware-vgauthsvc.log.0&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/vmware-vmsvc.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/firewalld&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/yum.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/dmesg.old&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/cron-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/cron&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/maillog-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/maillog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/messages-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/messages&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/secure-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/secure&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/spooler-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/spooler&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/btmp-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/btmp&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/dmesg&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log-20210309&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/wtmp-20210309&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/wtmp&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/tuned/tuned.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.4&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.3&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.2&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.1&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/anaconda.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/syslog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/X.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/program.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/packaging.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/storage.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ifcfg.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ks-script-14N23b.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ks-script-azeNm9.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/journal.log&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;arcroot&quot;</span>: <span class="hljs-string">&quot;/var/log/&quot;</span>, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/log.tar.bz2&quot;</span>, <br>    <span class="hljs-string">&quot;expanded_exclude_paths&quot;</span>: [], <br>    <span class="hljs-string">&quot;expanded_paths&quot;</span>: [<br>        <span class="hljs-string">&quot;/var/log/&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;missing&quot;</span>: [], <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0600&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;wang&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 1262391, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1001<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="3-4-9-Hostname-模块"><a href="#3-4-9-Hostname-模块" class="headerlink" title="3.4.9 Hostname 模块"></a>3.4.9 Hostname 模块</h4><p>功能：管理主机名<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible node1 -m hostname -a &quot;name=websrv&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible 10.0.0.8 -m hostname -a &#x27;name=node18.rlin.com&#x27;</span><br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;ansible_domain&quot;</span>: <span class="hljs-string">&quot;ilxnetworks.com&quot;</span>, <br>        <span class="hljs-string">&quot;ansible_fqdn&quot;</span>: <span class="hljs-string">&quot;cius-ilx-lc420401.ilxnetworks.com&quot;</span>, <br>        <span class="hljs-string">&quot;ansible_hostname&quot;</span>: <span class="hljs-string">&quot;node18&quot;</span>, <br>        <span class="hljs-string">&quot;ansible_nodename&quot;</span>: <span class="hljs-string">&quot;node18.rlin.com&quot;</span>, <br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;node18.rlin.com&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="3-4-10-Cron-模块"><a href="#3-4-10-Cron-模块" class="headerlink" title="3.4.10 Cron 模块"></a>3.4.10 Cron 模块</h4><p>功能：计划任务<br>支持时间：minute，hour，day，month，weekday<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#备份数据库脚本</span><br>[root@centos7 ~]<span class="hljs-comment">#cat /root/mysql_backup.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>mysqldump -A -F --single-transaction --master-data=2 -q -uroot |gzip &gt; /data/mysql_`date +%F_%T`.sql.gz<br><br><span class="hljs-comment">#创建任务</span><br>ansible dbsrvs -m cron -a <span class="hljs-string">&#x27;hour=2 minute=30 weekday=1-5 name=&quot;backup mysql&quot; job=/root/mysql_backup.sh&#x27;</span><br>ansible websrvs  -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate ntp.aliyun.com</span><br><span class="hljs-string">&amp;&gt;/dev/null&#x27; name=Synctime&quot;</span><br><br><span class="hljs-comment">#禁用计划任务</span><br>ansible websrvs  -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate 172.20.0.1</span><br><span class="hljs-string">&amp;&gt;/dev/null&#x27; name=Synctime disabled=yes&quot;</span><br><br><span class="hljs-comment">#启用计划任务</span><br>ansible websrvs  -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate 172.20.0.1</span><br><span class="hljs-string">&amp;&gt;/dev/null&#x27; name=Synctime disabled=no&quot;</span><br><br><span class="hljs-comment">#删除任务</span><br>ansible websrvs -m cron -a <span class="hljs-string">&quot;name=&#x27;backup mysql&#x27; state=absent&quot;</span><br>ansible websrvs -m cron -a <span class="hljs-string">&#x27;state=absent name=Synctime&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="3-4-11-Yum-和-Apt-模块"><a href="#3-4-11-Yum-和-Apt-模块" class="headerlink" title="3.4.11 Yum 和 Apt 模块"></a>3.4.11 Yum 和 Apt 模块</h4><p>功能：<br>yum 管理软件包，只支持RHEL，CentOS，fedora，不支持Ubuntu其它版本<br>apt 模块管理 Debian 相关版本的软件包<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=httpd state=present&#x27;  #安装</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=httpd state=absent&#x27;  #删除</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=sl,cowsay&#x27;</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible 10.0.0.100 -m apt -a &#x27;name=bb,sl,cowsay,cmatrix,oneko,hollywood,boxes,libaa-bin,x11-apps&#x27;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m apt -a &#x27;name=rsync,psmisc state=absent&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="3-4-12-Service-模块"><a href="#3-4-12-Service-模块" class="headerlink" title="3.4.12 Service 模块"></a>3.4.12 Service 模块</h4><p>功能：管理服务<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible all -m service -a &#x27;name=httpd state=started enabled=yes&#x27;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m service -a &#x27;name=httpd state=stopped&#x27;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m service -a &#x27;name=httpd state=reloaded&#x27;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m shell -a &quot;sed -i &#x27;s/^Listen 80/Listen 8080/&#x27; /etc/httpd/conf/httpd.conf&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m service -a &#x27;name=httpd state=restarted&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="3-4-13-User-模块"><a href="#3-4-13-User-模块" class="headerlink" title="3.4.13 User 模块"></a>3.4.13 User 模块</h4><p>功能：管理用户<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建用户</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m user -a &#x27;name=user1 comment=&quot;test user&quot; uid=2048 home=/app/user1 group=root&#x27;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m user -a &#x27;name=nginx comment=nginx uid=88 group=nginx groups=&quot;root,daemon&quot; shell=/sbin/nologin system=yes create_home=no home=/data/nginx non_unique=yes&#x27;</span><br><br><span class="hljs-comment">#remove=yes表示删除用户及家目录等数据,默认remove=no</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m user -a &#x27;name=nginx state=absent remove=yes&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="3-4-14-Group-模块"><a href="#3-4-14-Group-模块" class="headerlink" title="3.4.14 Group 模块"></a>3.4.14 Group 模块</h4><p>功能：管理组<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建组</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m group  -a &#x27;name=nginx gid=88 system=yes&#x27;</span><br><span class="hljs-comment">#删除组</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m group  -a &#x27;name=nginx state=absent&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="3-4-15-Lineinfile-模块"><a href="#3-4-15-Lineinfile-模块" class="headerlink" title="3.4.15 Lineinfile 模块"></a>3.4.15 Lineinfile 模块</h4><p>ansible在使用sed进行替换时，经常会遇到需要转义的问题，而且ansible在遇到特殊符号进行替换时，存在问题，无法正常进行替换 。其实在ansible自身提供了两个模块：lineinfile模块和replace模块，可以方便的进行替换</p><p>一般在ansible当中去修改某个文件的单行进行替换的时候需要使用lineinfile模块</p><p><strong>regexp参数 ：使用正则表达式匹配对应的行，当替换文本时，如果有多行文本都能被匹配，则只有最后面被匹配到的那行文本才会被替换，当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除。</strong></p><p><strong>如果想进行多行匹配进行替换需要使用replace模块</strong></p><p>功能：相当于sed，可以修改文件内容</p><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m lineinfile -a &quot;path=/etc/httpd/conf/httpd.conf regexp=&#x27;^Listen&#x27; line=&#x27;Listen 80&#x27;&quot;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m  lineinfile -a &quot;path=/etc/selinux/config regexp=&#x27;^SELINUX=&#x27; line=&#x27;SELINUX=disabled&#x27;&quot;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m lineinfile  -a &#x27;dest=/etc/fstab state=absent regexp=&quot;^#&quot;&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="3-4-16-Replace-模块"><a href="#3-4-16-Replace-模块" class="headerlink" title="3.4.16 Replace 模块"></a>3.4.16 Replace 模块</h4><p>该模块有点类似于sed命令，主要也是基于正则进行匹配和替换，建议使用<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible all -m replace -a &quot;path=/etc/fstab regexp=&#x27;^(UUID.*)&#x27; replace=&#x27;#\1&#x27;&quot; </span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m replace -a &quot;path=/etc/fstab regexp=&#x27;^#(UUID.*)&#x27; replace=&#x27;\1&#x27;&quot;</span><br></code></pre></td></tr></table></figure><h4 id="3-4-17-Setup-模块"><a href="#3-4-17-Setup-模块" class="headerlink" title="3.4.17 Setup 模块"></a>3.4.17 Setup 模块</h4><p>功能： setup 模块来收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机<br>较多，会影响执行速度，可以使用 gather_facts: no 来禁止 Ansible 收集 facts 信息<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_nodename&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_hostname&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_domain&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_memtotal_mb&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_memory_mb&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_memfree_mb&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_os_family&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_distribution_major_version&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_distribution_version&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_processor_vcpus&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_all_ipv4_addresses&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_architecture&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_processor*&quot;</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible all -m setup -a &#x27;filter=ansible_python_version&#x27;</span><br>10.0.0.7 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;ansible_python_version&quot;</span>: <span class="hljs-string">&quot;2.7.5&quot;</span>,<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br> &#125;,<br>  <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;ansible_python_version&quot;</span>: <span class="hljs-string">&quot;2.6.6&quot;</span>,<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br> &#125;,<br>  <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;ansible_python_version&quot;</span>: <span class="hljs-string">&quot;3.6.8&quot;</span>,<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span><br> &#125;,<br>  <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br>[root@centos7 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><p>范例：取IP地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#取所有IP</span><br>ansible 10.0.0.101 -m setup -a <span class="hljs-string">&#x27;filter=ansible_all_ipv4_addresses&#x27;</span><br>10.0.0.101 | SUCCESS =&gt; &#123;<br> <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>   <span class="hljs-string">&quot;ansible_all_ipv4_addresses&quot;</span>: [<br>      <span class="hljs-string">&quot;192.168.0.1&quot;</span>,<br>      <span class="hljs-string">&quot;192.168.0.2&quot;</span>,<br>      <span class="hljs-string">&quot;192.168.64.238&quot;</span>,<br>      <span class="hljs-string">&quot;192.168.13.36&quot;</span>,<br>      <span class="hljs-string">&quot;10.0.0.101&quot;</span>,<br>      <span class="hljs-string">&quot;172.16.1.0&quot;</span>,<br>      <span class="hljs-string">&quot;172.17.0.1&quot;</span><br>    ]<br>  &#125;,<br> <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">#取默认IP</span><br>ansible all -m setup -a <span class="hljs-string">&#x27;filter=&quot;ansible_default_ipv4&quot;&#x27;</span><br>10.0.0.101 | SUCCESS =&gt; &#123;<br> <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>   <span class="hljs-string">&quot;ansible_default_ipv4&quot;</span>: &#123;<br>     <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;10.0.0.101&quot;</span>,<br>     <span class="hljs-string">&quot;alias&quot;</span>: <span class="hljs-string">&quot;eth0&quot;</span>,<br>     <span class="hljs-string">&quot;broadcast&quot;</span>: <span class="hljs-string">&quot;10.0.0.255&quot;</span>,<br>     <span class="hljs-string">&quot;gateway&quot;</span>: <span class="hljs-string">&quot;10.0.0.2&quot;</span>,<br>     <span class="hljs-string">&quot;interface&quot;</span>: <span class="hljs-string">&quot;eth0&quot;</span>,<br>     <span class="hljs-string">&quot;macaddress&quot;</span>: <span class="hljs-string">&quot;00:0c:29:e8:c7:9b&quot;</span>,<br>     <span class="hljs-string">&quot;mtu&quot;</span>: 1500,<br>     <span class="hljs-string">&quot;netmask&quot;</span>: <span class="hljs-string">&quot;255.255.255.0&quot;</span>,<br>     <span class="hljs-string">&quot;network&quot;</span>: <span class="hljs-string">&quot;10.0.0.0&quot;</span>,<br>     <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;ether&quot;</span><br>    &#125;<br>  &#125;,<br> <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="四、Playbook"><a href="#四、Playbook" class="headerlink" title="四、Playbook"></a>四、Playbook</h2><h3 id="4-1-playbook介绍"><a href="#4-1-playbook介绍" class="headerlink" title="4.1 playbook介绍"></a>4.1 playbook介绍</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible13.jpg"></p><ul><li>playbook 剧本是由一个或多个”play”组成的列表</li><li>play的主要功能在于将预定义的一组主机，装扮成事先通过ansible中的task定义好的角色。Task实际是调用ansible的一个module，将多个play组织在一个playbook中，即可以让它们联合起来，按事先编排的机制执行预定义的动作</li><li>Playbook 文件是采用YAML语言编写的</li></ul><h3 id="4-2-YAML-语言"><a href="#4-2-YAML-语言" class="headerlink" title="4.2 YAML 语言"></a>4.2 YAML 语言</h3><h4 id="4-2-1-YAMl-语言介绍"><a href="#4-2-1-YAMl-语言介绍" class="headerlink" title="4.2.1 YAMl 语言介绍"></a>4.2.1 YAMl 语言介绍</h4><p>YAML：YAML Ain’t Markup Language，即YAML不是XML。不过，在开发的这种语言时，YAML的意思其实是：”Yet Another Markup Language”（仍是一种标记语言）<br>YAML是一个可读性高的用来表达资料序列的格式。YAML参考了其他多种语言，包括：XML、C语言、Python、Perl以及电子邮件格式RFC2822等。Clark Evans在2001年在首次发表了这种语言，另外Ingydöt Net与Oren Ben-Kiki也是这语言的共同设计者,目前很多最新的软件比较流行采用此格式的文件存放配置信息，如:ubuntu，anisble，docker，kubernetes等<br>YAML 官方网站：<a href="http://www.yaml.org/">http://www.yaml.org</a></p><h4 id="4-2-2-YAML-语言特性"><a href="#4-2-2-YAML-语言特性" class="headerlink" title="4.2.2 YAML 语言特性"></a>4.2.2 YAML 语言特性</h4><ul><li>YAML的可读性好</li><li>YAML和脚本语言的交互性好</li><li>YAML使用实现语言的数据类型</li><li>YAML有一个一致的信息模型</li><li>YAML易于实现</li><li>YAML可以基于流来处理</li><li>YAML表达能力强，扩展性好</li></ul><h4 id="4-2-3-YAML语法简介"><a href="#4-2-3-YAML语法简介" class="headerlink" title="4.2.3 YAML语法简介"></a>4.2.3 YAML语法简介</h4><ul><li>在单一文件第一行，用连续三个连字号”-“ 开始，还有选择性的连续三个点号( … )用来表示文件的结尾</li><li>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</li><li>使用#号注释代码</li><li>缩进必须是统一的，不能空格和tab混用</li><li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</li><li>YAML文件内容是区别大小写的，key/value的值均需大小写敏感</li><li>多个key/value可同行写也可换行写，同行使用，分隔</li><li>key后面冒号要加一个空格 比如: key: value</li><li>value可是个字符串，也可是另一个列表</li><li>YAML文件扩展名通常为yml或yaml</li></ul><h4 id="4-2-4-支持的数据类型"><a href="#4-2-4-支持的数据类型" class="headerlink" title="4.2.4 支持的数据类型"></a>4.2.4 支持的数据类型</h4><p>YAML 支持以下常用几种数据类型：</p><ul><li><p>标量：单个的、不可再分的值</p></li><li><p>对象：键值对的集合，又称为映射（mapping）/ 哈希（hashes） / 字典（dictionary）</p></li><li><p>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</p></li></ul><h5 id="4-2-4-1-scalar-标量"><a href="#4-2-4-1-scalar-标量" class="headerlink" title="4.2.4.1 scalar 标量"></a>4.2.4.1 scalar 标量</h5><p>key对应value</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">wang</span><br></code></pre></td></tr></table></figure><p>使用缩进的方式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span><br>  <span class="hljs-string">wang</span><br></code></pre></td></tr></table></figure><p>标量是最基本的，不可再分的值，包括：</p><ul><li>字符串</li><li>布尔值</li><li>整数</li><li>浮点数</li><li>Null</li><li>时间</li><li>日期</li></ul><h5 id="4-2-4-2-Dictionary-字典"><a href="#4-2-4-2-Dictionary-字典" class="headerlink" title="4.2.4.2 Dictionary 字典"></a>4.2.4.2 Dictionary 字典</h5><p>字典由多个key与value构成，key和value之间用 ：分隔, 并且 : 后面有一个空格，所有k/v可以放在一行，或者每个 k/v 分别放在不同行<br>格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">account:</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">wang</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">30</span> &#125;<br></code></pre></td></tr></table></figure><p>使用缩进方式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">account:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">wang</span><br>  <span class="hljs-attr">age:</span> <span class="hljs-number">30</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#不同行</span><br><span class="hljs-comment"># An employee record</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">Example</span> <span class="hljs-string">Developer</span><br><span class="hljs-attr">job:</span> <span class="hljs-string">Developer</span><br><span class="hljs-attr">skill:</span> <span class="hljs-string">Elite(社会精英)</span><br><br><span class="hljs-comment">#同一行,也可以将key:value放置于&#123;&#125;中进行表示，用,分隔多个key:value</span><br><span class="hljs-comment"># An employee record</span><br>&#123;<span class="hljs-attr">name:</span> <span class="hljs-string">&quot;Example Developer&quot;</span>, <span class="hljs-attr">job:</span> <span class="hljs-string">&quot;Developer&quot;</span>, <span class="hljs-attr">skill:</span> <span class="hljs-string">&quot;Elite&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-2-4-2-List-列表"><a href="#4-2-4-2-List-列表" class="headerlink" title="4.2.4.2 List 列表"></a>4.2.4.2 List 列表</h5><p>列表由多个元素组成，每个元素放在不同行，且元素前均使用”-“打头，并且 - 后有一个空格, 或者将所有元素用 [ ] 括起来放在同一行<br>格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">course:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">linux</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">golang</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">python</span><br></code></pre></td></tr></table></figure><p>也可以使用[ ]</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">course:</span> [ <span class="hljs-string">linux</span> , <span class="hljs-string">golang</span> , <span class="hljs-string">python</span> ]<br></code></pre></td></tr></table></figure><p>数据里面也可以包含对象</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">course:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">linux:</span> <span class="hljs-string">manjaro</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">golang:</span> <span class="hljs-string">gin</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">python:</span> <span class="hljs-string">django</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#不同行,行以-开头,后面有一个空格</span><br><span class="hljs-comment"># A list of tasty fruits</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Apple</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Orange</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Strawberry</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Mango</span><br><br><span class="hljs-comment">#同一行</span><br>[<span class="hljs-string">Apple</span>,<span class="hljs-string">Orange</span>,<span class="hljs-string">Strawberry</span>,<span class="hljs-string">Mango</span>]<br></code></pre></td></tr></table></figure><p>范例：YAML 表示一个家庭</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">John</span> <span class="hljs-string">Smith</span><br><span class="hljs-attr">age:</span> <span class="hljs-number">41</span><br><span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span><br><span class="hljs-attr">spouse:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">Jane</span> <span class="hljs-string">Smith</span><br>  <span class="hljs-attr">age:</span> <span class="hljs-number">37</span><br>  <span class="hljs-attr">gender:</span> <span class="hljs-string">Female</span><br>  <span class="hljs-attr">children:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Jimmy</span> <span class="hljs-string">Smith</span><br>      <span class="hljs-attr">age:</span> <span class="hljs-number">17</span><br>      <span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span><br>    <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">Jenny</span> <span class="hljs-string">Smith</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">13</span>, <span class="hljs-attr">gender:</span> <span class="hljs-string">Female</span>&#125;<br>    <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">hao</span> <span class="hljs-string">Smith</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">20</span>, <span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span> &#125;<br></code></pre></td></tr></table></figure><h4 id="4-2-5-三种常见的数据格式"><a href="#4-2-5-三种常见的数据格式" class="headerlink" title="4.2.5 三种常见的数据格式"></a>4.2.5 三种常见的数据格式</h4><ul><li>XML：Extensible Markup Language，可扩展标记语言，可用于数据交换和配置</li><li>JSON：JavaScript Object Notation, JavaScript 对象表记法，主要用来数据交换或配置，不支持注释</li><li>YAML：YAML Ain’t Markup Language YAML 不是一种标记语言， 主要用来配置，大小写敏感，不支持tab</li></ul><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible14.jpg"></p><p><strong>可以用工具互相转换，参考网站：</strong><br><a href="https://www.json2yaml.com/">https://www.json2yaml.com/</a><br><a href="http://www.bejson.com/json/json2yaml/">http://www.bejson.com/json/json2yaml/</a></p><h3 id="4-3-Playbook-核心组件"><a href="#4-3-Playbook-核心组件" class="headerlink" title="4.3 Playbook 核心组件"></a>4.3 Playbook 核心组件</h3><p>一个playbook 中由列表组成,其中所用到的常见组件类型如下:</p><ul><li>Hosts 执行的远程主机列表</li><li>Tasks 任务集,由多个task的元素组成的列表实现,每个task是一个字典,一个完整的代码块功能需最少元素需包括 name 和 task,一个name只能包括一个task</li><li>Variables 内置变量或自定义变量在playbook中调用</li><li>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li><li>Handlers 和 notify 结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li><li>tags 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断</li></ul><h4 id="4-3-1-hosts-组件"><a href="#4-3-1-hosts-组件" class="headerlink" title="4.3.1 hosts 组件"></a>4.3.1 hosts 组件</h4><p>Hosts：playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">one.example.com<br>one.example.com:two.example.com<br>192.168.1.50<br>192.168.1.*<br>Websrvs:dbsrvs   <span class="hljs-comment">#或者，两个组的并集</span><br>Websrvs:&amp;dbsrvs  <span class="hljs-comment">#与，两个组的交集</span><br>webservers:!dbsrvs  <span class="hljs-comment">#在websrvs组，但不在dbsrvs组</span><br></code></pre></td></tr></table></figure><p>案例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs:appsrvs</span><br></code></pre></td></tr></table></figure><h4 id="4-3-2-remote-user-组件"><a href="#4-3-2-remote-user-组件" class="headerlink" title="4.3.2 remote_user 组件"></a>4.3.2 remote_user 组件</h4><p>remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span> <span class="hljs-string">connection</span><br>      <span class="hljs-attr">ping:</span><br>      <span class="hljs-attr">remote_user:</span> <span class="hljs-string">magedu</span><br>      <span class="hljs-attr">sudo:</span> <span class="hljs-literal">yes</span> <span class="hljs-comment">#默认sudo为root</span><br>      <span class="hljs-string">sudo_user:wang</span>   <span class="hljs-comment">#sudo为wang</span><br></code></pre></td></tr></table></figure><h4 id="4-3-3-task列表和action组件"><a href="#4-3-3-task列表和action组件" class="headerlink" title="4.3.3 task列表和action组件"></a>4.3.3 task列表和action组件</h4><p>play的主体部分是task list，task list中有一个或多个task,各个task 按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个task后，再开始第二个task<br>task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致<br>每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤。<br>如果未提供name，则action的结果将用于输出<br><strong>task两种格式：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">action:</span> <span class="hljs-string">module</span> <span class="hljs-string">arguments</span><br><span class="hljs-attr">module:</span> <span class="hljs-string">arguments</span>  <span class="hljs-comment">#建议使用</span><br></code></pre></td></tr></table></figure><p>注意：shell和command模块后面跟命令，而非key=value</p><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#  vim install_httpd.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>      <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook -C install_httpd.yml </span><br><br><span class="hljs-string">PLAY</span> [<span class="hljs-string">websrvs</span>] <span class="hljs-string">*************************************************************************************************************</span><br><br><span class="hljs-string">TASK</span> [<span class="hljs-string">install</span> <span class="hljs-string">httpd</span>] <span class="hljs-string">*******************************************************************************************************</span><br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span>]<br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span>]<br><br><span class="hljs-string">TASK</span> [<span class="hljs-string">start</span> <span class="hljs-string">httpd</span>] <span class="hljs-string">*********************************************************************************************************</span><br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span>]<br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span>]<br><br><span class="hljs-string">PLAY</span> <span class="hljs-string">RECAP</span> <span class="hljs-string">*****************************************************************************************************************</span><br><span class="hljs-attr">10.0.0.7                   :</span> <span class="hljs-string">ok=2</span>    <span class="hljs-string">changed=2</span>    <span class="hljs-string">unreachable=0</span>    <span class="hljs-string">failed=0</span>    <span class="hljs-string">skipped=0</span>    <span class="hljs-string">rescued=0</span>    <span class="hljs-string">ignored=0</span>   <br><span class="hljs-attr">10.0.0.8                   :</span> <span class="hljs-string">ok=2</span>    <span class="hljs-string">changed=2</span>    <span class="hljs-string">unreachable=0</span>    <span class="hljs-string">failed=0</span>    <span class="hljs-string">skipped=0</span>    <span class="hljs-string">rescued=0</span>    <span class="hljs-string">ignored=0</span>   <br><br><br></code></pre></td></tr></table></figure><h4 id="4-3-4-其它组件"><a href="#4-3-4-其它组件" class="headerlink" title="4.3.4 其它组件"></a>4.3.4 其它组件</h4><p>某任务的状态在运行后为changed时，可通过”notify”通知给相应的handlers<br>任务可以通过”tags”打标签，可在ansible-playbook命令上使用-t指定进行调用</p><h4 id="4-3-5-ShellScripts-VS-Playbook-案例"><a href="#4-3-5-ShellScripts-VS-Playbook-案例" class="headerlink" title="4.3.5 ShellScripts VS Playbook 案例"></a>4.3.5 ShellScripts VS Playbook 案例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#SHELL脚本实现</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># 安装Apache</span><br><span class="hljs-string">yum</span> <span class="hljs-string">install</span> <span class="hljs-string">--quiet</span> <span class="hljs-string">-y</span> <span class="hljs-string">httpd</span><br><span class="hljs-comment"># 复制配置文件</span><br><span class="hljs-string">cp</span> <span class="hljs-string">/tmp/httpd.conf</span> <span class="hljs-string">/etc/httpd/conf/httpd.conf</span><br><span class="hljs-string">cp/tmp/vhosts.conf</span> <span class="hljs-string">/etc/httpd/conf.d/</span><br><span class="hljs-comment"># 启动Apache，并设置开机启动</span><br><span class="hljs-string">systemctl</span> <span class="hljs-string">enable</span> <span class="hljs-string">--now</span> <span class="hljs-string">httpd</span><br><br><span class="hljs-comment">#Playbook实现</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;安装Apache&quot;</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;复制配置文件&quot;</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/tmp/httpd.conf</span> <span class="hljs-string">dest=/etc/httpd/conf/</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;复制配置文件&quot;</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/tmp/vhosts.conf</span> <span class="hljs-string">dest=/etc/httpd/conf.d/</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;启动Apache，并设置开机启动&quot;</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br></code></pre></td></tr></table></figure><h3 id="4-4-playbook-命令"><a href="#4-4-playbook-命令" class="headerlink" title="4.4 playbook 命令"></a>4.4 playbook 命令</h3><p>格式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible-playbook &lt;filename.yml&gt; ... [options]</span><br></code></pre></td></tr></table></figure><p>常见选项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">--syntax-check    <span class="hljs-comment">#语法检查</span><br>-C --check <span class="hljs-comment">#只检测可能会发生的改变，但不真正执行操作</span><br>--list-hosts   <span class="hljs-comment">#列出运行任务的主机</span><br>--list-tags <span class="hljs-comment">#列出tag</span><br>--list-tasks <span class="hljs-comment">#列出task</span><br>--<span class="hljs-built_in">limit</span> 主机列表 <span class="hljs-comment">#只针对主机列表中的特定主机执行</span><br>-v -vv  -vvv <span class="hljs-comment">#显示过程</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ansible]<span class="hljs-comment"># cat hello.yml</span><br>---<br>- hosts: websrvs<br>  tasks:<br>    - name: hello<br>      <span class="hljs-built_in">command</span>: <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello ansible&quot;</span><br>[root@cetnso7 ansible]<span class="hljs-comment"># ansible-playbook hello.yml</span><br>[root@cetnso7 ansible]<span class="hljs-comment"># ansible-playbook -v hello.yml</span><br></code></pre></td></tr></table></figure><p>范例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@cetnso7 ansible]<span class="hljs-comment"># ansible-playbook file.yml  --check #只检测</span><br>[root@cetnso7 ansible]<span class="hljs-comment"># ansible-playbook file.yml </span><br>[root@cetnso7 ansible]<span class="hljs-comment"># ansible-playbook file.yml  --limit websrvs</span><br></code></pre></td></tr></table></figure><h3 id="4-5-Playbook-初步"><a href="#4-5-Playbook-初步" class="headerlink" title="4.5 Playbook 初步"></a>4.5 Playbook 初步</h3><h4 id="4-5-1-利用-playbook-创建-mysql-用户"><a href="#4-5-1-利用-playbook-创建-mysql-用户" class="headerlink" title="4.5.1 利用 playbook 创建 mysql 用户"></a>4.5.1 利用 playbook 创建 mysql 用户</h4><p>范例：mysql_user.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">group</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">system=yes</span> <span class="hljs-string">gid=306</span>&#125;<br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">shell=/sbin/nologin</span> <span class="hljs-string">system=yes</span> <span class="hljs-string">group=mysql</span> <span class="hljs-string">uid=306</span> <span class="hljs-string">home=/data/mysql</span> <span class="hljs-string">create_home=no</span> <br></code></pre></td></tr></table></figure><h4 id="4-5-2-利用-playbook-安装-nginx"><a href="#4-5-2-利用-playbook-安装-nginx" class="headerlink" title="4.5.2 利用 playbook 安装 nginx"></a>4.5.2 利用 playbook 安装 nginx</h4><p>范例：install_nginx.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">group</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">user</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span> <span class="hljs-string">group=nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web</span> <span class="hljs-string">page</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=files/index.html</span> <span class="hljs-string">dest=/usr/share/nginx/html/index.html</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Start</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br><br></code></pre></td></tr></table></figure><h4 id="4-5-3-利用-playbook-安装和卸载-httpd"><a href="#4-5-3-利用-playbook-安装和卸载-httpd" class="headerlink" title="4.5.3 利用 playbook 安装和卸载 httpd"></a>4.5.3 利用 playbook 安装和卸载 httpd</h4><p>范例：install_httpd.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment">#install httpd</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">configure</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=files/httpd.conf</span> <span class="hljs-string">dest=/etc/httpd/conf/</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">modify</span> <span class="hljs-string">config</span><br>      <span class="hljs-attr">lineinfile:</span> <span class="hljs-string">path=/etc/httpd/conf/httpd.conf</span> <span class="hljs-string">regexp=&#x27;^Listen&#x27;</span> <span class="hljs-string">line=&#x27;Listen</span> <span class="hljs-number">8080</span><span class="hljs-string">&#x27;  </span><br><span class="hljs-string">    - name: mkdir website dir</span><br><span class="hljs-string">      file: path=/data/html state=directory</span><br><span class="hljs-string">    - name: web html</span><br><span class="hljs-string">      copy: src=files/index.html  dest=/data/html/</span><br><span class="hljs-string">    - name: start service</span><br><span class="hljs-string">      service: name=httpd state=started enabled=yes </span><br><span class="hljs-string">     </span><br><span class="hljs-string">[root@cetnso7 ansible]# ansible-playbookinstall_httpd.yml --limit 10.0.0.8</span><br></code></pre></td></tr></table></figure><p>范例：remove_httpd.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#remove_httpd.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">httpd</span> <span class="hljs-string">package</span><br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=absent</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">apache</span> <span class="hljs-string">user</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">name=apache</span> <span class="hljs-string">state=absent</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>    <span class="hljs-attr">file:</span> <span class="hljs-string">name=/etc/httpd</span> <span class="hljs-string">state=absent</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">web</span> <span class="hljs-string">html</span><br>    <span class="hljs-attr">file:</span> <span class="hljs-string">name=/data/html/</span> <span class="hljs-string">state=absent</span><br></code></pre></td></tr></table></figure><h4 id="4-5-4-利用-playbook-安装-mysql"><a href="#4-5-4-利用-playbook-安装-mysql" class="headerlink" title="4.5.4 利用 playbook 安装 mysql"></a>4.5.4 利用 playbook 安装 mysql</h4><p><strong>范例：安装mysql-5.6.46-linux-glibc2.12</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ls -l /data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz</span><br>-rw-r--r-- 1 root root 403177622 Dec  4 13:05 /data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz<br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/files/my.cnf</span><br>[mysqld]<br>socket=/tmp/mysql.sock<br>user=mysql<br>symbolic-links=0<br>datadir=/data/mysql<br>innodb_file_per_table=1<br>log-bin<br>pid-file=/data/mysql/mysqld.pid<br><br>[client]<br>port=3306<br>socket=/tmp/mysql.sock<br><br>[mysqld_safe]<br>log-error=/var/<span class="hljs-built_in">log</span>/mysqld.log<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/files/secure_mysql.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>/usr/<span class="hljs-built_in">local</span>/mysql/bin/mysql_secure_installation &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string"></span><br><span class="hljs-string">y</span><br><span class="hljs-string">magedu</span><br><span class="hljs-string">magedu</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">EOF</span><br><br><br>[root@centos7 ~]<span class="hljs-comment">#tree /data/ansible/files/</span><br>/data/ansible/files/<br>├── my.cnf<br>├── mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz<br>└── secure_mysql.sh<br><br>0 directories, 3 files<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/install_mysql.yml</span><br>---<br><span class="hljs-comment"># install mysql-5.6.44-linux-glibc2.12-x86_64.tar.gz </span><br>- hosts: dbsrvs<br>  remote_user: root<br>  gather_facts: no<br><br>  tasks:<br>    - name: install packages<br>      yum: name=libaio,perl-Data-Dumper,perl-Getopt-Long<br>    - name: create mysql group<br>      group: name=mysql gid=306<br>    - name: create mysql user<br>      user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql<br>    - name: copy tar to remote host and file mode<br>      unarchive: src=/data/ansible/files/ql-5.6.44-linux-glibc2.12-x86_64.tar.gzdest=/usr/<span class="hljs-built_in">local</span>/ owner=root group=root<br>    - name: create linkfile /usr/<span class="hljs-built_in">local</span>/mysql<br>      file: src=/usr/<span class="hljs-built_in">local</span>/mysql-5.6.44-linux-glibc2.12-x86_64 dest=/usr/<span class="hljs-built_in">local</span>/mysql state=link<br>    - name: data dir<br>      shell: <span class="hljs-built_in">chdir</span>=/usr/<span class="hljs-built_in">local</span>/mysql/ ./scripts/mysql_install_db --datadir=/data/mysql --user=mysql<br>      tags: data<br>    - name: config my.cnf<br>      copy: src=/data/ansible/files/my.cnf  dest=/etc/my.cnf<br>    - name: service script<br>      shell: /bin/cp /usr/<span class="hljs-built_in">local</span>/mysql/support-files/mysql.server /etc/init.d/mysqld<br>    - name: <span class="hljs-built_in">enable</span> service<br>      shell: /etc/init.d/mysqld start;chkconfig --add mysqld;chkconfig mysqld on<br>      tags: service<br>    - name: PATH variable<br>      copy: content=<span class="hljs-string">&#x27;PATH=/usr/local/mysql/bin:$PATH&#x27;</span> dest=/etc/profile.d/mysql.sh<br>    - name: secure script<br>      script: /data/ansible/files/secure_mysql.sh<br>      tags: script<br><br></code></pre></td></tr></table></figure><p><strong>范例：install_mariadb.yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment">#Installing MariaDB Binary Tarballs</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">group</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">gid=27</span> <span class="hljs-string">system=yes</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">uid=27</span> <span class="hljs-string">system=yes</span> <span class="hljs-string">group=mysql</span> <span class="hljs-string">shell=/sbin/nologin</span> <span class="hljs-string">home=/data/mysql</span> <span class="hljs-string">create_home=no</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mkdir</span> <span class="hljs-string">datadir</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">path=/data/mysql</span> <span class="hljs-string">owner=mysql</span> <span class="hljs-string">group=mysql</span> <span class="hljs-string">state=directory</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">unarchive</span> <span class="hljs-string">package</span><br>      <span class="hljs-attr">unarchive:</span> <span class="hljs-string">src=/data/ansible/files/mariadb-10.2.27-linux-x86_64.tar.gz</span> <span class="hljs-string">dest=/usr/local/</span> <span class="hljs-string">owner=root</span> <span class="hljs-string">group=root</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">link</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">src=/usr/local/mariadb-10.2.27-linux-x86_64</span> <span class="hljs-string">path=/usr/local/mysql</span> <span class="hljs-string">state=link</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">database</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">chdir=/usr/local/mysql</span>  <span class="hljs-string">./scripts/mysql_install_db</span> <span class="hljs-string">--</span> <span class="hljs-string">datadir=/data/mysql</span> <span class="hljs-string">--user=mysql</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/data/ansible/files/my.cnf</span>  <span class="hljs-string">dest=/etc/</span> <span class="hljs-string">backup=yes</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">service</span> <span class="hljs-string">script</span><br>    <span class="hljs-attr">shell:</span> <span class="hljs-string">/bin/cp</span> <span class="hljs-string">/usr/local/mysql/support-files/mysql.server</span><br><span class="hljs-string">/etc/init.d/mysqld</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>     <span class="hljs-attr">service:</span> <span class="hljs-string">name=mysqld</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">PATH</span> <span class="hljs-string">variable</span><br>     <span class="hljs-attr">copy:</span> <span class="hljs-string">content=&#x27;PATH=/usr/local/mysql/bin:$PATH&#x27;</span> <span class="hljs-string">dest=/etc/profile.d/mysql.sh</span><br></code></pre></td></tr></table></figure><h3 id="4-6-Playbook中使用handlers和notify"><a href="#4-6-Playbook中使用handlers和notify" class="headerlink" title="4.6 Playbook中使用handlers和notify"></a>4.6 Playbook中使用handlers和notify</h3><p>Handlers本质是task list ，类似于MySQL中的触发器触发的行为，其中的task与前述的task并没有本质上的不同，主要用于当关注的资源发生变化时，才会采取一定的操作。而Notify对应的action可用于在每个play的最后被触发，这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作</p><p>案例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim install_httpd.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">configure</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=files/httpd.conf</span> <span class="hljs-string">dest=/etc/httpd/conf/</span><br>      <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">httpd</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ensure</span> <span class="hljs-string">apache</span> <span class="hljs-string">is</span> <span class="hljs-string">running</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>   <br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=restarted</span><br><br><span class="hljs-comment">#注意notify和handlers同时存在</span><br><br></code></pre></td></tr></table></figure><p>案例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">group</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">user</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span> <span class="hljs-string">group=nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/root/config.txt</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>      <span class="hljs-attr">notify:</span> [<span class="hljs-string">&quot;Restart Nginx&quot;</span>,<span class="hljs-string">&quot;Check Nginx Process&quot;</span>] <span class="hljs-comment">#或者下面格式</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Nginx</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">Check</span> <span class="hljs-string">Nginx</span> <span class="hljs-string">Process</span><br>        <br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=restarted</span> <span class="hljs-string">enabled=yes</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">Nginx</span> <span class="hljs-string">process</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">killall</span> <span class="hljs-number">-0</span> <span class="hljs-string">nginx</span> <span class="hljs-string">&amp;&gt;</span> <span class="hljs-string">/tmp/nginx.log</span><br></code></pre></td></tr></table></figure><h3 id="4-7-Playbook中使用tags组件"><a href="#4-7-Playbook中使用tags组件" class="headerlink" title="4.7 Playbook中使用tags组件"></a>4.7 Playbook中使用tags组件</h3><p>在playbook文件中，可以利用tags组件，为特定 task 指定标签，当在执行playbook时，可以只执行特定tags的task,而非整个playbook文件<br>案例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment"># tags example</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">configure</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=files/httpd.conf</span> <span class="hljs-string">dest=/etc/httpd/conf/</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">conf</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">httpd</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>      <br><span class="hljs-comment">#可以只执行playbook里的某个标签</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook –t conf,service httpd.yml</span><br></code></pre></td></tr></table></figure><h3 id="4-8-Playbook中使用变量"><a href="#4-8-Playbook中使用变量" class="headerlink" title="4.8 Playbook中使用变量"></a>4.8 Playbook中使用变量</h3><p>变量名：仅能由字母、数字和下划线组成，且只能以字母开头<br><strong>变量定义：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">variable=value<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http_port=80<br></code></pre></td></tr></table></figure><p><strong>变量调用方式：</strong><br>通过 调用变量，且变量名前后建议加空格，有时用”“才生效<br><strong>变量来源：</strong></p><ol><li>ansible 的 setup facts 远程主机的所有变量都可直接调用</li><li>通过命令行指定变量，优先级最高</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible-playbook -e varname=value test.yml<br></code></pre></td></tr></table></figure><ol start="3"><li>在playbook文件中定义</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">vars:</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">var1:</span> <span class="hljs-string">value1</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">var2:</span> <span class="hljs-string">value2</span><br></code></pre></td></tr></table></figure><ol start="4"><li>在独立的变量YAML文件中定义</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yacas">- hosts: all<br>  vars_files:<br>    - vars.yml<br></code></pre></td></tr></table></figure><ol start="5"><li><p>在 /etc/ansible/hosts 中定义<br>主机（普通）变量：主机组中主机单独定义，优先级高于公共变量<br>组（公共）变量：针对主机组中所有主机定义统一变量</p></li><li><p>在role中定义</p></li></ol><h4 id="4-8-1-使用-setup-模块中变量"><a href="#4-8-1-使用-setup-模块中变量" class="headerlink" title="4.8.1 使用 setup 模块中变量"></a>4.8.1 使用 setup 模块中变量</h4><p>本模块自动在playbook调用，不要用ansible命令调用<br>案例：使用setup变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 files]<span class="hljs-comment"># ansible 10.0.0.8 -m setup -a &#x27;filter=&quot;ansible_default_ipv4&quot;&#x27;</span><br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;ansible_default_ipv4&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;10.0.0.8&quot;</span>, <br>            <span class="hljs-string">&quot;alias&quot;</span>: <span class="hljs-string">&quot;eth0&quot;</span>, <br>            <span class="hljs-string">&quot;broadcast&quot;</span>: <span class="hljs-string">&quot;10.0.0.255&quot;</span>, <br>            <span class="hljs-string">&quot;gateway&quot;</span>: <span class="hljs-string">&quot;10.0.0.2&quot;</span>, <br>            <span class="hljs-string">&quot;interface&quot;</span>: <span class="hljs-string">&quot;eth0&quot;</span>, <br>            <span class="hljs-string">&quot;macaddress&quot;</span>: <span class="hljs-string">&quot;00:0c:29:cc:02:c4&quot;</span>, <br>            <span class="hljs-string">&quot;mtu&quot;</span>: 1500, <br>            <span class="hljs-string">&quot;netmask&quot;</span>: <span class="hljs-string">&quot;255.255.255.0&quot;</span>, <br>            <span class="hljs-string">&quot;network&quot;</span>: <span class="hljs-string">&quot;10.0.0.0&quot;</span>, <br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;ether&quot;</span><br>        &#125;, <br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible 10.0.0.9 -m setup -a &quot;filter=ansible_nodename&quot;</span><br>10.0.0.9 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;ansible_nodename&quot;</span>: <span class="hljs-string">&quot;centos8.magedu.org&quot;</span>,<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span>&#125;,<br>  <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment">#var1.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">yes</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">log</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">name=/data/&#123;&#123;</span> <span class="hljs-string">ansible_nodename</span> <span class="hljs-string">&#125;&#125;.log</span> <span class="hljs-string">state=touch</span> <span class="hljs-string">owner=wang</span> <span class="hljs-string">mode=600</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook var.yml</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim test.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span> <span class="hljs-string">var</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">path=/data/&#123;&#123;</span> <span class="hljs-string">ansible_facts[&quot;eth0&quot;][&quot;ipv4&quot;][&quot;address&quot;]</span> <span class="hljs-string">&#125;&#125;.log</span> <span class="hljs-string">state=touch</span><br>      <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook test.yml</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ll /data/10.0.0.8.log</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">0</span> <span class="hljs-string">Oct</span> <span class="hljs-number">16</span> <span class="hljs-number">18</span><span class="hljs-string">:22</span> <span class="hljs-string">/data/10.0.0.8.log</span><br></code></pre></td></tr></table></figure><h4 id="4-8-2-在playbook-命令行中定义变量"><a href="#4-8-2-在playbook-命令行中定义变量" class="headerlink" title="4.8.2 在playbook 命令行中定义变量"></a>4.8.2 在playbook 命令行中定义变量</h4><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">vim</span> <span class="hljs-string">var2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">package</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">pkname</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>  <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook –e &#x27;pkname=vsftpd&#x27; var2.yml</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># cat vars</span><br><span class="hljs-comment">#需要yaml格式</span><br><span class="hljs-attr">pkname:</span> <span class="hljs-string">memcached</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook -e &#x27;@vars&#x27; var2.yml</span><br></code></pre></td></tr></table></figure><h4 id="4-8-3-在playbook文件中定义变量"><a href="#4-8-3-在playbook文件中定义变量" class="headerlink" title="4.8.3 在playbook文件中定义变量"></a>4.8.3 在playbook文件中定义变量</h4><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim var3.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">user1</span><br>    <span class="hljs-attr">groupname:</span> <span class="hljs-string">group1</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">group</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">groupname</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">username</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">groupname</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>  <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook -e &quot;username=user2 groupname=group2&quot; var3.yml</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#cat var4.yaml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">collect_info:</span> <span class="hljs-string">&quot;/data/test/<span class="hljs-template-variable">&#123;&#123;ansible_default_ipv4[&#x27;address&#x27;]&#125;&#125;</span>/&quot;</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">IP</span> <span class="hljs-string">directory</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">name=&quot;&#123;&#123;collect_info&#125;&#125;&quot;</span> <span class="hljs-string">state=directory</span><br><br><span class="hljs-comment">#执行结果</span><br><span class="hljs-string">tree</span> <span class="hljs-string">/data/test/</span><br><span class="hljs-string">/data/test/</span><br><span class="hljs-string">└──</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.102</span><br><span class="hljs-number">1</span> <span class="hljs-string">directory,</span> <span class="hljs-number">0</span> <span class="hljs-string">files</span><br></code></pre></td></tr></table></figure><h4 id="4-8-4-使用变量文件"><a href="#4-8-4-使用变量文件" class="headerlink" title="4.8.4 使用变量文件"></a>4.8.4 使用变量文件</h4><p>可以在一个独立的playbook文件中定义变量，在另一个playbook文件中引用变量文件中的变量，比playbook中定义的变量优化级高</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim vars.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># variables file</span><br><span class="hljs-attr">package_name:</span> <span class="hljs-string">mariadb-server</span><br><span class="hljs-attr">service_name:</span> <span class="hljs-string">mariadb</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim var5.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment">#install package and start service</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars_files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">vars.yml</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">package</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">package_name</span> <span class="hljs-string">&#125;&#125;</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">install</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">service_name</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># cat vars2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">var1:</span> <span class="hljs-string">httpd</span><br><span class="hljs-attr">var2:</span> <span class="hljs-string">nginx</span><br>   <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># cat var6.yml</span><br><span class="hljs-meta">---    </span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">web</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars_files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">vars2.yml</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">httpd</span> <span class="hljs-string">log</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">name=/app/&#123;&#123;</span> <span class="hljs-string">var1</span> <span class="hljs-string">&#125;&#125;.log</span> <span class="hljs-string">state=touch</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">nginx</span> <span class="hljs-string">log</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">name=/app/&#123;&#123;</span> <span class="hljs-string">var2</span> <span class="hljs-string">&#125;&#125;.log</span> <span class="hljs-string">state=touch</span><br></code></pre></td></tr></table></figure><h4 id="4-8-5-主机清单文件中定义变量"><a href="#4-8-5-主机清单文件中定义变量" class="headerlink" title="4.8.5 主机清单文件中定义变量"></a>4.8.5 主机清单文件中定义变量</h4><h5 id="4-8-5-1-主机变量"><a href="#4-8-5-1-主机变量" class="headerlink" title="4.8.5.1 主机变量"></a>4.8.5.1 主机变量</h5><p>在inventory 主机清单文件中为指定的主机定义变量以便于在playbook中使用<br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[websrvs]<br>www1.magedu.com http_port=80 maxRequestsPerChild=808<br>www2.magedu.com http_port=8080 maxRequestsPerChild=909<br></code></pre></td></tr></table></figure><h5 id="4-8-5-2-组（公共）变量"><a href="#4-8-5-2-组（公共）变量" class="headerlink" title="4.8.5.2 组（公共）变量"></a>4.8.5.2 组（公共）变量</h5><p>在inventory 主机清单文件中赋予给指定组内所有主机上的在playbook中可用的变量，如果和主机变是同名，优先级低于主机变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[websrvs]<br>www1.magedu.com http_port=8080<br>www2.magedu.com<br><br>[websrvs:vars]<br>http_port=80<br>ntp_server=ntp.magedu.com<br>nfs_server=nfs.magedu.com<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/ansible/hosts</span><br>[websrvs]<br>10.0.0.8 hname=www1 domain=magedu.io<br>10.0.0.7 hname=www2<br><br>[websvrs:vars]<br>mark=<span class="hljs-string">&quot;-&quot;</span><br>domain=magedu.org<br><br>[root@centos7 ~]<span class="hljs-comment">#ansible websvrs –m hostname –a &#x27;name=&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123;</span><br>domain &#125;&#125;<span class="hljs-string">&#x27;</span><br><span class="hljs-string">#命令行指定变量：</span><br><span class="hljs-string">[root@centos7 ~]#ansible websvrs –e domain=magedu.cn –m hostname –a  &#x27;</span>name=<br>&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; domain &#125;&#125;<span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><p>范例: k8s 的ansible 变量文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[etcd]<br>10.0.0.104 NODE_NAME=etcd1<br>10.0.0.105 NODE_NAME=etcd2<br>10.0.0.106 NODE_NAME=etcd3<br><br>[kube-master]<br>10.0.0.103 NEW_MASTER=yes<br>10.0.0.101<br>10.0.0.102<br><br>[kube-node]<br>10.0.0.109 NEW_NODE=yes<br>10.0.0.107<br>10.0.0.108<br><br>[harbor]<br><br>[ex-lb]<br>10.0.0.111 LB_ROLE=master EX_APISERVER_VIP=10.0.0.100 EX_APISERVER_PORT=8443<br>10.0.0.112 LB_ROLE=backup EX_APISERVER_VIP=10.0.0.100 EX_APISERVER_PORT=8443<br><br>[chrony]<br><br>[all:vars]<br>CONTAINER_RUNTIME=<span class="hljs-string">&quot;docker&quot;</span><br>CLUSTER_NETWORK=<span class="hljs-string">&quot;calico&quot;</span><br>PROXY_MODE=<span class="hljs-string">&quot;ipvs&quot;</span><br>SERVICE_CIDR=<span class="hljs-string">&quot;192.168.0.0/16&quot;</span><br>CLUSTER_CIDR=<span class="hljs-string">&quot;172.16.0.0/16&quot;</span><br>NODE_PORT_RANGE=<span class="hljs-string">&quot;20000-60000&quot;</span><br>CLUSTER_DNS_DOMAIN=<span class="hljs-string">&quot;magedu.local.&quot;</span><br>bin_dir=<span class="hljs-string">&quot;/usr/bin&quot;</span><br>ca_dir=<span class="hljs-string">&quot;/etc/kubernetes/ssl&quot;</span><br>base_dir=<span class="hljs-string">&quot;/etc/ansible&quot;</span><br></code></pre></td></tr></table></figure><h3 id="4-9-template-模板"><a href="#4-9-template-模板" class="headerlink" title="4.9 template 模板"></a>4.9 template 模板</h3><p>模板是一个文本文件，可以做为生成文件的模版，并且模板文件中还可嵌套jinja语法</p><h4 id="4-9-1-jinja2语言"><a href="#4-9-1-jinja2语言" class="headerlink" title="4.9.1 jinja2语言"></a>4.9.1 jinja2语言</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible15.jpg"></p><p>官方网站：<br><a href="http://jinja.pocoo.org/">http://jinja.pocoo.org/</a><br><a href="https://jinja.palletsprojects.com/en/2.11.x/">https://jinja.palletsprojects.com/en/2.11.x/</a><br>jinja2 语言支持多种数据类型和操作:</p><p>字面量，如: 字符串：使用单引号或双引号,数字：整数，浮点数</p><p>列表：[item1, item2, …]</p><p>元组：(item1, item2, …)</p><p>字典：{key1:value1, key2:value2, …}</p><p>布尔型：true/false</p><p>算术运算：+, -, *, /, //, %, **</p><p>比较操作：==, !=, &gt;, &gt;=, &lt;, &lt;=</p><p>逻辑运算：and，or，not</p><p>流表达式：For，If，When</p><p><strong>字面量：</strong></p><p>表达式最简单的形式就是字面量。字面量表示诸如字符串和数值的 Python 对象。如”Hello World”<br>双引号或单引号中间的一切都是字符串。无论何时你需要在模板中使用一个字符串（比如函数调用、过滤器或只是包含或继承一个模板的参数），如42，42.23<br>数值可以为整数和浮点数。如果有小数点，则为浮点数，否则为整数。在 Python 里， 42 和 42.0 是不一样的</p><p><strong>算术运算：</strong><br>Jinja 允许用计算值。支持下面的运算符</p><p>+：把两个对象加到一起。通常对象是素质，但是如果两者是字符串或列表，你可以用这 种方式来衔接它们。无论如何这不是首选的连接字符串的方式！连接字符串见 ~ 运算符。 2 等于 2</p><p>-：用第一个数减去第二个数。 1 等于 1</p><p>/：对两个数做除法。返回值会是一个浮点数。 0.5 等于 0.5</p><p>//：对两个数做除法，返回整数商。 2 等于 2</p><p>%：计算整数除法的余数。 4 等于 4</p><p>*：用右边的数乘左边的操作数。 4 会返回 4 。也可以用于重 复一个字符串多次。 NaN会打印 80 个等号的横条\</p><p>**：取左操作数的右操作数次幂。 8 会返回 8</p><p><strong>比较操作符</strong></p><p>== 比较两个对象是否相等</p><p>!= 比较两个对象是否不等</p><p>&gt; 如果左边大于右边，返回 true</p><p>\ &gt; = 如果左边大于等于右边，返回 true</p><p>\ &lt; 如果左边小于右边，返回 true</p><p>\ &lt;= 如果左边小于等于右边，返回 true</p><p><strong>逻辑运算符</strong></p><p>对于 if 语句，在 for 过滤或 if 表达式中，它可以用于联合多个表达式</p><p>and 如果左操作数和右操作数同为真，返回 true</p><p>or 如果左操作数和右操作数有一个为真，返回 true</p><p>not 对一个表达式取反</p><p>(expr)表达式组</p><p>true / false true 永远是 true ，而 false 始终是 false</p><h4 id="4-9-2-template"><a href="#4-9-2-template" class="headerlink" title="4.9.2 template"></a>4.9.2 template</h4><p>template功能：可以根据和参考模块文件，动态生成相类似的配置文件<br>template文件必须存放于templates目录下，且命名为 .j2 结尾<br>yaml/yml 文件需和templates目录平级，目录结构如下示例：<br>./<br>├── temnginx.yml<br>└── templates<br>            └── nginx.conf.j2<br>范例：利用template 同步nginx配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#准备templates/nginx.conf.j2文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim temnginx.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">hosts</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook temnginx.yml</span><br></code></pre></td></tr></table></figure><p><strong>template变更替换</strong><br>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#修改文件nginx.conf.j2</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#mkdir templates</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim templates/nginx.conf.j2</span><br><span class="hljs-string">......</span><br><span class="hljs-comment">#setup的模块：ansible_processor_vcpus</span><br><span class="hljs-string">worker_processes</span> &#123;&#123; <span class="hljs-string">ansible_processor_vcpus</span> &#125;&#125;<span class="hljs-string">;</span><br><span class="hljs-string">......</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim temnginx2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">hosts</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>  <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook temnginx2.yml</span><br></code></pre></td></tr></table></figure><p><strong>template算术运算</strong><br>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim nginx.conf.j2<br>worker_processes &#123;&#123; ansible_processor_vcpus**2 &#125;&#125;;  <br>worker_processes &#123;&#123; ansible_processor_vcpus+2 &#125;&#125;;<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment">#vim templates/nginx.conf.j2</span><br><span class="hljs-string">worker_processes</span> &#123;&#123; <span class="hljs-string">ansible_processor_vcpus**3</span> &#125;&#125;<span class="hljs-string">;</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment">#cat templnginx.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">hosts</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>      <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br><br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=restarted</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#-playbook templnginx.yml --limit 10.0.0.8</span><br></code></pre></td></tr></table></figure><h4 id="4-9-3-template中使用流程控制-for-和-if"><a href="#4-9-3-template中使用流程控制-for-和-if" class="headerlink" title="4.9.3 template中使用流程控制 for 和 if"></a>4.9.3 template中使用流程控制 for 和 if</h4><p>template中也可以使用流程控制 for 循环和 if 条件判断，实现动态生成文件功能<br>范例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#temlnginx2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">nginx_vhosts:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">81</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">82</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">83</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf2.j2</span> <span class="hljs-string">dest=/data/nginx.conf</span><br><br><span class="hljs-comment">#templates/nginx.conf2.j2</span><br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">for</span> <span class="hljs-string">vhost</span> <span class="hljs-string">in</span> <span class="hljs-string">nginx_vhosts</span> <span class="hljs-string">%</span>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> &#123;&#123; <span class="hljs-string">vhost</span> &#125;&#125;<br>&#125;<br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">endfor</span> <span class="hljs-string">%</span>&#125;<br><br><span class="hljs-string">ansible-playbook</span> <span class="hljs-string">-C</span> <span class="hljs-string">templnginx2.yml</span> <span class="hljs-string">--limit</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span><br><br><span class="hljs-comment">#生成的结果：</span><br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">81</span> <br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">82</span> <br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">83</span> <br>&#125;<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#temlnginx3.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">nginx_vhosts:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-attr">listen:</span> <span class="hljs-number">8080</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf3.j2</span> <span class="hljs-string">dest=/data/nginx3.conf</span><br><br><span class="hljs-comment">#templates/nginx.conf3.j2</span><br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">for</span> <span class="hljs-string">vhost</span> <span class="hljs-string">in</span> <span class="hljs-string">nginx_vhosts</span> <span class="hljs-string">%</span>&#125; <br><span class="hljs-string">server</span> &#123;<br><span class="hljs-string">listen</span> &#123;&#123; <span class="hljs-string">vhost.listen</span> &#125;&#125;<br>&#125;<br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">endfor</span> <span class="hljs-string">%</span>&#125;<br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook  templnginx3.yml --limit 10.0.0.8</span><br><br><span class="hljs-comment">#生成的结果</span><br><span class="hljs-string">server</span> &#123;<br><span class="hljs-string">listen</span> <span class="hljs-number">8080</span> <br>&#125;<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#templnginx4.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">nginx_vhosts:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">listen:</span> <span class="hljs-number">8080</span><br>        <span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;web1.magedu.com&quot;</span><br>        <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web1/&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">listen:</span> <span class="hljs-number">8081</span><br>        <span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;web2.magedu.com&quot;</span><br>        <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web2/&quot;</span><br>      <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">listen:</span> <span class="hljs-number">8082</span>, <span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;web3.magedu.com&quot;</span>, <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web3/&quot;</span>&#125;<br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf4.j2</span> <span class="hljs-string">dest=/data/nginx4.conf</span><br>  <br><span class="hljs-comment"># templates/nginx.conf4.j2</span><br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">for</span> <span class="hljs-string">vhost</span> <span class="hljs-string">in</span> <span class="hljs-string">nginx_vhosts</span> <span class="hljs-string">%</span>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> &#123;&#123; <span class="hljs-string">vhost.listen</span> &#125;&#125;<br> <span class="hljs-string">server_name</span> &#123;&#123; <span class="hljs-string">vhost.server_name</span> &#125;&#125;<br> <span class="hljs-string">root</span> &#123;&#123; <span class="hljs-string">vhost.root</span> &#125;&#125; <br> &#125;<br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">endfor</span> <span class="hljs-string">%</span>&#125;<br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook templnginx4.yml --limit 10.0.0.8</span><br><br><span class="hljs-comment">#生成结果：</span><br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8080</span><br> <span class="hljs-string">server_name</span> <span class="hljs-string">web1.magedu.com</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web1/</span> <br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8081</span><br> <span class="hljs-string">server_name</span> <span class="hljs-string">web2.magedu.com</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web2/</span> <br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8082</span><br> <span class="hljs-string">server_name</span> <span class="hljs-string">web3.magedu.com</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web3/</span> <br>&#125;<br></code></pre></td></tr></table></figure><p>在模版文件中还可以使用 if条件判断，决定是否生成相关的配置信息</p><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#templnginx5.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">nginx_vhosts:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">web1:</span><br>        <span class="hljs-attr">listen:</span> <span class="hljs-number">8080</span><br>        <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web1/&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">web2:</span><br>        <span class="hljs-attr">listen:</span> <span class="hljs-number">8080</span><br>        <span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;web2.magedu.com&quot;</span><br>        <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web2/&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">web3:</span><br>        <span class="hljs-attr">listen:</span> <span class="hljs-number">8080</span><br>        <span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;web3.magedu.com&quot;</span><br>        <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web3/&quot;</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span> <span class="hljs-string">to</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf5.j2</span> <span class="hljs-string">dest=/data/nginx5.conf</span><br>    <br>    <br><span class="hljs-comment">#templates/nginx.conf5.j2</span><br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">for</span> <span class="hljs-string">vhost</span> <span class="hljs-string">in</span> <span class="hljs-string">nginx_vhosts</span> <span class="hljs-string">%</span>&#125;<br><span class="hljs-string">server</span> &#123;<br>   <span class="hljs-string">listen</span> &#123;&#123; <span class="hljs-string">vhost.listen</span> &#125;&#125;<br>   &#123;<span class="hljs-string">%</span> <span class="hljs-string">if</span> <span class="hljs-string">vhost.server_name</span> <span class="hljs-string">is</span> <span class="hljs-string">defined</span> <span class="hljs-string">%</span>&#125;<br><span class="hljs-string">server_name</span> &#123;&#123; <span class="hljs-string">vhost.server_name</span> &#125;&#125;  <span class="hljs-comment">#注意缩进</span><br>   &#123;<span class="hljs-string">%</span> <span class="hljs-string">endif</span> <span class="hljs-string">%</span>&#125;<br><span class="hljs-string">root</span>  &#123;&#123; <span class="hljs-string">vhost.root</span> &#125;&#125;         <span class="hljs-comment">#注意缩进</span><br>&#125;<br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">endfor</span> <span class="hljs-string">%</span>&#125;<br><br><span class="hljs-comment">#生成的结果</span><br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8080</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web1/</span><br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8080</span><br> <span class="hljs-string">server_name</span> <span class="hljs-string">web2.magedu.com</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web2/</span><br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8080</span><br> <span class="hljs-string">server_name</span> <span class="hljs-string">web3.magedu.com</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web3/</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-10-playbook使用-when"><a href="#4-10-playbook使用-when" class="headerlink" title="4.10 playbook使用 when"></a>4.10 playbook使用 when</h3><p>when语句，可以实现条件测试。如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试,通过在task后添加when子句即可使用条件测试，jinja2的语法格式</p><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;shutdown RedHat flavored systems&quot;</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-h</span> <span class="hljs-string">now</span><br>      <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_os_family</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;RedHat&quot;</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;shut down CentOS 6 and Debian 7 systems&quot;</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-t</span> <span class="hljs-string">now</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">(ansible_facts[&#x27;distribution&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;CentOS&quot;</span> <span class="hljs-string">and</span> <span class="hljs-string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span><span class="hljs-string">)</span> <span class="hljs-string">or</span> <span class="hljs-string">(ansible_facts[&#x27;distribution&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;Debian&quot;</span> <span class="hljs-string">and</span> <span class="hljs-string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;7&quot;</span><span class="hljs-string">)</span><br></code></pre></td></tr></table></figure><p>范例: 关闭CentOS 7 版本的主机</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;shut down CentOS 6 systems&quot;</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-r</span> <span class="hljs-string">now</span><br>      <span class="hljs-attr">when:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">ansible_facts[&#x27;distribution&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;CentOS&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;7&quot;</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">group</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">user</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span> <span class="hljs-string">group=nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=restarted</span><br>      <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br> <br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">conf</span> <span class="hljs-string">file</span> <span class="hljs-string">to</span> <span class="hljs-string">centos7</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.c7.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>      <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;7&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">conf</span> <span class="hljs-string">file</span> <span class="hljs-string">to</span> <span class="hljs-string">centos6</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.c6.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>      <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span><br></code></pre></td></tr></table></figure><h3 id="4-11-playbook-使用迭代-with-items-loop"><a href="#4-11-playbook-使用迭代-with-items-loop" class="headerlink" title="4.11 playbook 使用迭代 with_items(loop)"></a>4.11 playbook 使用迭代 with_items(loop)</h3><p>迭代：当有需要重复性执行的任务时，可以使用迭代机制<br>对迭代项的引用，固定内置变量名为”item”<br>要在task中使用with_items给定要迭代的元素列表<br>注意: ansible2.5版本后,可以用loop代替with_items<br><strong>列表元素格式：</strong></p><ul><li><p>字符串</p></li><li><p>字典</p></li></ul><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br><span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">several</span> <span class="hljs-string">users</span><br>  <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span> <span class="hljs-string">groups=wheel</span><br>  <span class="hljs-attr">with_items:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">testuser1</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">testuser2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">testuser3</span><br>    <span class="hljs-comment">#上面语句的功能等同于下面的语句</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">several</span> <span class="hljs-string">users</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">name=testuser1</span> <span class="hljs-string">state=present</span> <span class="hljs-string">groups=wheel</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">several</span> <span class="hljs-string">users</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">name=testuser2</span> <span class="hljs-string">state=present</span> <span class="hljs-string">groups=wheel</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">several</span> <span class="hljs-string">users</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">name=testuser3</span> <span class="hljs-string">state=present</span> <span class="hljs-string">groups=wheel</span><br></code></pre></td></tr></table></figure><p>范例：卸载 mariadb</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment">#remove mariadb server</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">appsrvs:!10.0.0.8</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">stop</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">/etc/init.d/mysqld</span> <span class="hljs-string">stop</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">delete</span> <span class="hljs-string">files</span> <span class="hljs-string">and</span> <span class="hljs-string">dir</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">path=&#123;&#123;item&#125;&#125;</span> <span class="hljs-string">state=absent</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/usr/local/mysql</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/usr/local/mariadb-10.2.27-linux-x86_64</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/init.d/mysqld</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/profile.d/mysql.sh</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/my.cnf</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/data/mysql</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">delete</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">state=absent</span> <span class="hljs-string">remove=yes</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">hosts：websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-string">tasks</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">some</span> <span class="hljs-string">packages</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">memcached</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">php-fpm</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br> <br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">dest=/tmp/&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">file1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">file2</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">file3</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">yum</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span>  <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">apr</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">apr-util</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">httpd</span><br></code></pre></td></tr></table></figure><p><strong>迭代嵌套子变量：</strong>在迭代中，还可以嵌套子变量，关联多个变量在一起使用</p><p>示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">groups</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">apache</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">users</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item.name</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">item.group</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;nginx&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;nginx&#x27;</span> &#125;<br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;mysql&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;mysql&#x27;</span> &#125;<br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;apache&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;apache&#x27;</span> &#125;<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># cat with_item2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">groups</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">g1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">g2</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">g3</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">users</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item.name</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">item.group</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">home=&#123;&#123;</span> <span class="hljs-string">item.home</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">create_home=yes</span> <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user1&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;g1&#x27;</span>, <span class="hljs-attr">home:</span> <span class="hljs-string">&#x27;/data/user1&#x27;</span> &#125;<br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user2&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;g2&#x27;</span>, <span class="hljs-attr">home:</span> <span class="hljs-string">&#x27;/data/user2&#x27;</span> &#125;<br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user3&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;g3&#x27;</span>, <span class="hljs-attr">home:</span> <span class="hljs-string">&#x27;/data/user3&#x27;</span> &#125;<br></code></pre></td></tr></table></figure><h3 id="4-12-管理节点过多导致的超时问题解决方法"><a href="#4-12-管理节点过多导致的超时问题解决方法" class="headerlink" title="4.12 管理节点过多导致的超时问题解决方法"></a>4.12 管理节点过多导致的超时问题解决方法</h3><p>默认情况下，Ansible将尝试并行管理playbook中所有的机器。对于滚动更新用例，可以使用serial关键字定义Ansible一次应管理多少主机，还可以将serial关键字指定为百分比，表示每次并行执行的主机数占总数的比例<br>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#vim test_serial.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">serial:</span> <span class="hljs-number">2</span>  <span class="hljs-comment">#每次只同时处理2个主机,将所有task执行完成后,再选下2个主机再执行所有task,直至所有主机</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">False</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task</span> <span class="hljs-string">one</span><br>      <span class="hljs-attr">comand:</span> <span class="hljs-string">hostname</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task</span> <span class="hljs-string">two</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">hostname</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span> <span class="hljs-string">serail</span><br>  <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">serial:</span> <span class="hljs-string">&quot;20%&quot;</span>  <span class="hljs-comment">#每次只同时处理20%的主机</span><br></code></pre></td></tr></table></figure><h2 id="五、Roles-角色"><a href="#五、Roles-角色" class="headerlink" title="五、Roles 角色"></a>五、Roles 角色</h2><p>角色是ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中运维复杂的场景：建议使用 roles，代码复用度高<br>roles：多个角色的集合目录， 可以将多个的role，分别放至roles目录下的独立子目录中,如下示例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">roles/</span><br>    <span class="hljs-string">mysql/</span><br>    <span class="hljs-string">nginx/</span><br>    <span class="hljs-string">tomcat/</span><br>    <span class="hljs-string">redis/</span><br></code></pre></td></tr></table></figure><p>默认roles存放路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">/root/.ansible/roles<br>/usr/share/ansible/roles<br>/etc/ansible/roles<br></code></pre></td></tr></table></figure><h3 id="5-1-Ansible-Roles目录编排"><a href="#5-1-Ansible-Roles目录编排" class="headerlink" title="5.1 Ansible Roles目录编排"></a>5.1 Ansible Roles目录编排</h3><p>roles目录结构如下所示</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible16.jpg"></p><p>每个角色，以特定的层级目录结构进行组织<br><strong>roles目录结构：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">playbook.yml</span><br><span class="hljs-string">roles/</span><br>  <span class="hljs-string">project/</span><br>  <span class="hljs-string">tasks/</span><br>  <span class="hljs-string">files/</span><br>  <span class="hljs-string">vars/</span>   <br>  <span class="hljs-string">templates/</span><br>  <span class="hljs-string">handlers/</span><br>  <span class="hljs-string">default/</span>  <br>  <span class="hljs-string">meta/</span><br></code></pre></td></tr></table></figure><p><strong>Roles各目录作用</strong><br>roles/project/ :项目名称,有以下子目录</p><ul><li>files/ ：存放由copy或script模块等调用的文件</li><li>templates/：template模块查找所需要模板文件的目录</li><li>tasks/：定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li><li>handlers/：至少应该包含一个名为main.yml的文件；此目录下的其它的文件需要在此文件中通过include进行包含</li><li>vars/：定义变量，至少应该包含一个名为main.yml的文件；此目录下的其它的变量文件需要在此文件中通过include进行包含</li><li>meta/：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含</li><li>default/：设定默认变量时使用此目录中的main.yml文件，比vars的优先级低</li></ul><h3 id="5-2-创建-role"><a href="#5-2-创建-role" class="headerlink" title="5.2 创建 role"></a>5.2 创建 role</h3><p>创建role的步骤</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">1 </span>创建以roles命名的目录<br><span class="hljs-symbol">2 </span>在roles目录中分别创建以各角色名称命名的目录，如mysql等<br><span class="hljs-symbol">3 </span>在每个角色命名的目录中分别创建<span class="hljs-keyword">files</span>、handlers、tasks、templates和vars等目录；用不到的目录可以创建为空目录，也可以不创建<br><span class="hljs-symbol">4 </span>在每个角色相关的子目录中创建相应的文件,如 tasks/main.yml,templates/nginx.conf.j2<br><span class="hljs-symbol">5 </span>在playbook文件中，调用需要的角色<br></code></pre></td></tr></table></figure><p>针对大型项目使用Roles进行编排<br>范例：roles的目录结构</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">nginx-role.yml</span><br><span class="hljs-string">roles/</span><br><span class="hljs-string">└──</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-string">├──</span> <span class="hljs-string">files</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br>  <span class="hljs-string">├──</span> <span class="hljs-string">tasks</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-string">groupadd.yml</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-string">install.yml</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-string">main.yml</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-string">restart.yml</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-string">useradd.yml</span><br>  <span class="hljs-string">└──</span> <span class="hljs-string">vars</span><br>    <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br></code></pre></td></tr></table></figure><h3 id="5-3-playbook-调用角色"><a href="#5-3-playbook-调用角色" class="headerlink" title="5.3 playbook 调用角色"></a>5.3 playbook 调用角色</h3><p><strong>调用角色方法1：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">memcached</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span> <br></code></pre></td></tr></table></figure><p><strong>调用角色方法2：</strong><br>键role用于指定角色名称，后续的k/v用于传递变量给角色</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">nginx</span>, <span class="hljs-attr">username:</span> <span class="hljs-string">nginx</span> &#125;<br></code></pre></td></tr></table></figure><p><strong>调用角色方法3：</strong><br>还可基于条件测试实现角色调用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">nginx</span>, <span class="hljs-attr">username:</span> <span class="hljs-string">nginx</span>, <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;7&#x27;</span> &#125;<br></code></pre></td></tr></table></figure><h3 id="5-4-roles-中-tags-使用"><a href="#5-4-roles-中-tags-使用" class="headerlink" title="5.4 roles 中 tags 使用"></a>5.4 roles 中 tags 使用</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vi app-role.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">appsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">nginx</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;nginx&#x27;</span>, <span class="hljs-string">&#x27;web&#x27;</span> ] ,<span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span> &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">httpd</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;httpd&#x27;</span>, <span class="hljs-string">&#x27;web&#x27;</span> ] &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">mysql</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;mysql&#x27;</span>, <span class="hljs-string">&#x27;db&#x27;</span> ] &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">mariadb</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;mariadb&#x27;</span>, <span class="hljs-string">&#x27;db&#x27;</span> ] &#125;<br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook --tags=&quot;nginx,httpd,mysql&quot; app-role.yml</span><br></code></pre></td></tr></table></figure><h3 id="5-5-实战案例"><a href="#5-5-实战案例" class="headerlink" title="5.5 实战案例"></a>5.5 实战案例</h3><h4 id="5-5-1-案例1：实现-httpd-角色"><a href="#5-5-1-案例1：实现-httpd-角色" class="headerlink" title="5.5.1 案例1：实现 httpd 角色"></a>5.5.1 案例1：实现 httpd 角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建角色相关的目录</span><br>[root@centos7 ~]<span class="hljs-comment">#mkdir -pv /data/ansible/roles/httpd/&#123;tasks,handlers,files&#125;</span><br><br><span class="hljs-comment">#创建角色相关的文件</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /data/ansible/roles/httpd/</span><br><br><span class="hljs-comment">#main.yml 是task的入口文件</span><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/main.yml</span><br>- include: group.yml<br>- include: user.yml<br>- include: install.yml<br>- include: config.yml<br>- include: index.yml<br>- include: service.yml<br><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/group.yml</span><br>- name: create apache group<br>  group: name=apache system=yes gid=80<br><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/user.yml</span><br>- name: create apache user<br>  user: name=apache system=yes shell=/sbin/nologin home=/var/www/ uid=80 group=apache<br><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/install.yml</span><br>- name: install httpd package<br>  yum: name=httpd<br><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/config.yml</span><br>- name: config file<br>  copy: src=httpd.conf dest=/etc/httpd/conf/ backup=yes<br>  notify: restart<br><br>[root@centos7 ~]<span class="hljs-comment"># tasks/index.yml</span><br>- name: index.html<br>  copy: src=index.html dest=/var/www/html/<br><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/service.yml</span><br>- name: start service<br>  service: name=httpd state=started enabled=yes<br><br>[root@centos7 ~]<span class="hljs-comment">#vim handlers/main.yml</span><br>- name: restart<br>  service: name=httpd state=restarted<br><br><span class="hljs-comment">#在files目录下准备两个文件</span><br>[root@centos7 ~]<span class="hljs-comment">#ls files/</span><br>httpd.conf index.html<br><br>[root@centos7 ~]<span class="hljs-comment">#tree /data/ansible/roles/httpd/</span><br>/data/ansible/roles/httpd/<br>├── files<br>│  ├── httpd.conf<br>│  └── index.html<br>├── handlers<br>│  └── main.yml<br>└── tasks<br> ├── config.yml<br> ├── group.yml<br> ├── index.yml<br> ├── install.yml<br> ├── main.yml<br> ├── service.yml<br> └── user.yml<br>3 directories, 10 files<br><br><span class="hljs-comment">#在playbook中调用角色</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /data/ansible/role_httpd.yml</span><br>---<br><span class="hljs-comment"># httpd role</span><br>- hosts: websrvs<br>  remote_user: root<br>  roles:<br>    - httpd<br> <br><span class="hljs-comment">#运行playbook</span><br>[root@centos7 ~]<span class="hljs-comment">#ansible-playbook /data/ansible/role_httpd.yml</span><br></code></pre></td></tr></table></figure><h4 id="5-5-2-案例2：实现-nginx-角色"><a href="#5-5-2-案例2：实现-nginx-角色" class="headerlink" title="5.5.2 案例2：实现 nginx 角色"></a>5.5.2 案例2：实现 nginx 角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#mkdir -pv</span><br>/data/ansible/roles/nginx/&#123;tasks,handlers,templates,vars&#125;<br><br><span class="hljs-comment">#创建task文件</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /data/ansible/roles/nginx/</span><br><br>[root@ansible nginx]<span class="hljs-comment">#vim tasks/main.yml</span><br>- include: install.yml<br>- include: config.yml<br>- include: index.yml<br>- include: service.yml<br><br>[root@centos7 nginx]<span class="hljs-comment">#vim tasks/install.yml</span><br>- name: install<br>  yum: name=nginx<br><br>[root@centos7 nginx]<span class="hljs-comment">#vim tasks/config.yml</span><br>- name: config file <span class="hljs-keyword">for</span> centos7<br>  template: src=nginx7.conf.j2 dest=/etc/nginx/nginx.conf<br>  when: ansible_distribution_major_version==<span class="hljs-string">&quot;7&quot;</span><br>  notify: restart<br>- name: config file <span class="hljs-keyword">for</span> centos8<br>  template: src=nginx8.conf.j2 dest=/etc/nginx/nginx.conf<br>  when: ansible_distribution_major_version==<span class="hljs-string">&quot;8&quot;</span><br>  notify: restart<br><br><span class="hljs-comment">#跨角色调用文件</span><br>[root@centos7 nginx]<span class="hljs-comment">#vim tasks/index.yml</span><br>- name: index.html<br>  copy: src=roles/httpd/files/index.html dest=/usr/share/nginx/html/<br><br>[root@centos7 nginx]<span class="hljs-comment">#vim tasks/service.yml</span><br>- name: start service<br>  service: name=nginx state=started enabled=yes<br><br><span class="hljs-comment">#创建handler文件</span><br>[root@centos7 nginx]<span class="hljs-comment">#cat handlers/main.yml</span><br>- name: restart<br>  service: name=nginx state=restarted<br><br><span class="hljs-comment">#创建两个template文件</span><br>[root@centos7 nginx]<span class="hljs-comment">#cat templates/nginx7.conf.j2</span><br>...省略...<br>user &#123;&#123;user&#125;&#125;;<br>worker_processes &#123;&#123;ansible_processor_vcpus+3&#125;&#125;;  <span class="hljs-comment">#修改此行</span><br>error_log /var/<span class="hljs-built_in">log</span>/nginx/error.log;<br>pid /run/nginx.pid;<br>...省略...<br><br>[root@centos7 nginx]<span class="hljs-comment">#cat templates/nginx8.conf.j2</span><br>...省略...<br>user nginx;<br>worker_processes &#123;&#123;ansible_processor_vcpus**3&#125;&#125;;  <span class="hljs-comment">#修改此行</span><br>error_log /var/<span class="hljs-built_in">log</span>/nginx/error.log;<br>pid /run/nginx.pid;<br>...省略...<br><br><span class="hljs-comment">#创建变量文件</span><br>[root@centos7 nginx]<span class="hljs-comment">#vim vars/main.yml</span><br>user: daemon<br><br><span class="hljs-comment">#目录结构如下</span><br>[root@centos7 ~]<span class="hljs-comment">#tree /data/ansible/roles/nginx/</span><br>/data/ansible/roles/nginx/<br>├── handlers<br>│  └── main.yml<br>├── tasks<br>│  ├── config.yml<br>│  ├── file.yml<br>│  ├── install.yml<br>│  ├── main.yml<br>│  └── service.yml<br>├── templates<br>│  ├── nginx7.conf.j2<br>│  └── nginx8.conf.j2<br>└── vars<br> └── main.yml<br>4 directories, 9 files<br><br><span class="hljs-comment">#在playbook中调用角色</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /data/ansible/role_nginx.yml</span><br>---<br><span class="hljs-comment">#nginx role</span><br>- hosts: websrvs<br>  roles:<br>    - role: nginx<br> <br><span class="hljs-comment">#运行playbook</span><br>[root@centos7 ~]<span class="hljs-comment">#ansible-playbook /data/ansible/role_nginx.yml</span><br></code></pre></td></tr></table></figure><h4 id="5-5-3-案例3：实现-memcached-角色"><a href="#5-5-3-案例3：实现-memcached-角色" class="headerlink" title="5.5.3 案例3：实现 memcached 角色"></a>5.5.3 案例3：实现 memcached 角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#mkdir -pv /data/ansible/roles/memcached/&#123;tasks,templates&#125;</span><br><br>[root@centos7 ~]<span class="hljs-comment">#cd /data/ansible/roles/memcached</span><br><br>[root@ansible memcached]<span class="hljs-comment">#vim tasks/main.yml</span><br>- include: install.yml<br>- include: config.yml<br>- include: service.yml<br><br>[root@centos7 memcached]<span class="hljs-comment">#vim tasks/install.yml</span><br>- name: install<br>  yum: name=memcached<br><br>[root@centos7 memcached]<span class="hljs-comment">#vim tasks/config.yml</span><br>- name: config file<br>  template: src=memcached.j2  dest=/etc/sysconfig/memcached<br><br>[root@centos7 memcached]<span class="hljs-comment">#vim tasks/service.yml</span><br>- name: service<br>  service: name=memcached state=started enabled=yes<br><br>[root@centos7 memcached]<span class="hljs-comment">#vim templates/memcached.j2</span><br>PORT=<span class="hljs-string">&quot;11211&quot;</span><br>USER=<span class="hljs-string">&quot;memcached&quot;</span><br>MAXCONN=<span class="hljs-string">&quot;1024&quot;</span><br>CACHESIZE=<span class="hljs-string">&quot;&#123;&#123;ansible_memtotal_mb//4&#125;&#125;&quot;</span><br>OPTIONS=<span class="hljs-string">&quot;&quot;</span><br><br>[root@centos7 memcached]<span class="hljs-comment">#tree /data/ansible/roles/memcached/</span><br>/data/ansible/roles/memcached/<br>├── tasks<br>│  ├── config.yml<br>│  ├── install.yml<br>│  ├── main.yml<br>│  └── service.yml<br>└── templates<br> └── memcached.j2<br>2 directories, 5 files<br><br>[root@centos7 ~]<span class="hljs-comment">#vim /data/ansible/role_memcached.yml</span><br>---<br>- hosts: appsrvs<br>  roles:<br>    - role: memcached<br> <br>[root@centos7 ~]<span class="hljs-comment">#ansible-play /data/ansible/role_memcached.yml</span><br></code></pre></td></tr></table></figure><h4 id="5-5-4-案例4：实现-mysql-5-6-的角色"><a href="#5-5-4-案例4：实现-mysql-5-6-的角色" class="headerlink" title="5.5.4 案例4：实现 mysql 5.6 的角色"></a>5.5.4 案例4：实现 mysql 5.6 的角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/files/my.cnf</span><br>[mysqld]<br>socket=/tmp/mysql.sock<br>user=mysql<br>symbolic-links=0<br>datadir=/data/mysql<br>innodb_file_per_table=1<br>log-bin<br>pid-file=/data/mysql/mysqld.pid<br>[client]<br>port=3306<br>socket=/tmp/mysql.sock<br>[mysqld_safe]<br>log-error=/var/<span class="hljs-built_in">log</span>/mysqld.log<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/files/secure_mysql.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>/usr/<span class="hljs-built_in">local</span>/mysql/bin/mysql_secure_installation &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">y</span><br><span class="hljs-string">magedu</span><br><span class="hljs-string">magedu</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">EOF</span><br><br>[root@centos7 ~]<span class="hljs-comment">#chmod +x /data/ansible/roles/mysql/files/secure_mysql.sh</span><br><br>[root@centos7 ~]<span class="hljs-comment">#ls /data/ansible/roles/mysql/files/</span><br>my.cnf mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz secure_mysql.sh<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/main.yml</span><br>- include: install.yml<br>- include: group.yml<br>- include: user.yml<br>- include: unarchive.yml<br>- include: link.yml<br>- include: data.yml<br>- include: config.yml<br>- include: service.yml<br>- include: path.yml<br>- include: secure.yml<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/install.yml</span><br>- name: install packages                      <br>  yum: name=libaio,perl-Data-Dumper,perl-Getopt-Long<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/group.yml</span><br>- name: create mysql group<br>  group: name=mysql gid=306<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/user.yml</span><br>- name: create mysql user<br>  user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/unarchive.yml</span><br>- name: copy tar to remote host and file mode<br>  unarchive: src=mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz dest=/usr/<span class="hljs-built_in">local</span>/ owner=root group=root<br><br>[root@ansible ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/link.yml</span><br>- name: mkdir /usr/<span class="hljs-built_in">local</span>/mysql<br>  file: src=/usr/<span class="hljs-built_in">local</span>/mysql-5.6.46-linux-glibc2.12-x86_64 dest=/usr/<span class="hljs-built_in">local</span>/mysql state=link<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ans</span><br>ible/roles/mysql/tasks/data.yml<br>- name: data dir<br>  shell: <span class="hljs-built_in">chdir</span>=/usr/<span class="hljs-built_in">local</span>/mysql/ ./scripts/mysql_install_db -- datadir=/data/mysql --user=mysql<br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/config.yml</span><br>- name: config my.cnf<br>  copy: src=my.cnf  dest=/etc/my.cnf<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/service.yml</span><br>- name: service script<br>  shell: /bin/cp /usr/<span class="hljs-built_in">local</span>/mysql/support-files/mysql.server<br>/etc/init.d/mysqld;chkconfig --add mysqld;chkconfig mysqld on;/etc/init.d/mysqld start<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/path.yml</span><br>- name: PATH variable<br>  copy: content=<span class="hljs-string">&#x27;PATH=/usr/local/mysql/bin:$PATH&#x27;</span> dest=/etc/profile.d/mysql.sh <br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/secure.yml</span><br>- name: secure script<br>  script: secure_mysql.sh<br><br>[root@centos7 ~]<span class="hljs-comment">#tree /data/ansible/roles/mysql/</span><br>/data/ansible/roles/mysql/<br>├── files<br>│  ├── my.cnf<br>│  ├── mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz<br>│  └── secure_mysql.sh<br>└── tasks<br> ├── config.yml<br> ├── data.yml<br> ├── group.yml<br> ├── install.yml<br> ├── link.yml<br> ├── main.yml<br> ├── path.yml<br> ├── secure.yml<br> ├── service.yml<br> ├── unarchive.yml<br> └── user.yml<br>2 directories, 14 files<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/mysql_roles.yml</span><br>- hosts: dbsrvs<br>  remote_user: root<br>  roles:<br>    - &#123;role: mysql,tags: [<span class="hljs-string">&quot;mysql&quot;</span>,<span class="hljs-string">&quot;db&quot;</span>]&#125;<br>    - &#123;role: nginx,tage: [<span class="hljs-string">&quot;nginx&quot;</span>,<span class="hljs-string">&quot;web&quot;</span>]&#125;<br> <br>[root@centos7 ~]<span class="hljs-comment">#ansible-playbook -t mysql /data/ansible/mysql_roles.yml</span><br></code></pre></td></tr></table></figure><h4 id="5-5-5-案例5-：实现多角色的选择"><a href="#5-5-5-案例5-：实现多角色的选择" class="headerlink" title="5.5.5 案例5 ：实现多角色的选择"></a>5.5.5 案例5 ：实现多角色的选择</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /data/ansible/role_httpd_nginx.yml</span><br>---<br>- hosts: websrvs<br>  roles:<br>    - &#123;role: httpd,tags: [httpd,web], when: ansible_distribution_major_version==<span class="hljs-string">&quot;7&quot;</span> &#125;<br>    - &#123;role: nginx,tags: [nginx,web], when: ansible_distribution_major_version==<span class="hljs-string">&quot;8&quot;</span> &#125;<br><br>[root@centos7 ~]<span class="hljs-comment">#ansible-playbook -t nginx /data/ansible/role_httpd_nginx.yml</span><br></code></pre></td></tr></table></figure><h2 id="六、Ansible-推荐学习资料"><a href="#六、Ansible-推荐学习资料" class="headerlink" title="六、Ansible 推荐学习资料"></a>六、Ansible 推荐学习资料</h2><p><a href="http://galaxy.ansible.com/">http://galaxy.ansible.com/</a></p><p><a href="https://galaxy.ansible.com/explore#/">https://galaxy.ansible.com/explore#/</a></p><p><a href="https://github.com/">https://github.com/</a></p><p><a href="http://ansible.com.cn/">http://ansible.com.cn/</a></p><p><a href="https://github.com/ansible/ansible">https://github.com/ansible/ansible</a></p><p><a href="https://github.com/ansible/ansible-examples">https://github.com/ansible/ansible-examples</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Linux ANSIBLE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>企业级VPN服务OpenVPN</title>
    <link href="/blog/2021/03/02/%E4%BC%81%E4%B8%9A%E7%BA%A7VPN%E6%9C%8D%E5%8A%A1OpenVPN/"/>
    <url>/blog/2021/03/02/%E4%BC%81%E4%B8%9A%E7%BA%A7VPN%E6%9C%8D%E5%8A%A1OpenVPN/</url>
    
    <content type="html"><![CDATA[<h1 id="企业级VPN服务-OpenVPN"><a href="#企业级VPN服务-OpenVPN" class="headerlink" title="企业级VPN服务 OpenVPN"></a>企业级VPN服务 OpenVPN</h1><h2 id="一、OpenVPN简介"><a href="#一、OpenVPN简介" class="headerlink" title="一、OpenVPN简介"></a>一、OpenVPN简介</h2><h3 id="1-1VPN-介绍"><a href="#1-1VPN-介绍" class="headerlink" title="1.1VPN 介绍"></a>1.1VPN 介绍</h3><p>专用网：专用网就是在两个网络（例如，北京和广州）之间架设一条专用线路，但是它并不需要真正地去铺设光缆之类的物理线路。虽然没有亲自去铺设，但是需要向电信运营商申请租用专线，在这条专用的线路上只传输自己的信息,所以安全稳定,同时也费用高昂</p><p>VPN：Virtual Private Network，虚拟私有网络，又称为虚拟专用网络，用于在不安全的线路上安全的传输数据。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-intrduce1.jpg"></p><h3 id="1-2-OpenVPN"><a href="#1-2-OpenVPN" class="headerlink" title="1.2 OpenVPN"></a>1.2 OpenVPN</h3><p>OpenVPN：一个实现VPN的开源软件，OpenVPN 是一个健壮的、高度灵活的 VPN 守护进程。它支持SSL/TLS 安全、Ethernet bridging、经由代理的 TCP 或 UDP 隧道和 NAT。另外，它也支持动态 IP 地址以及DHCP，可伸缩性足以支持数百或数千用户的使用场景，同时可移植至大多数主流操作系统平台上。</p><p>官网：<a href="https://openvpn.net/">https://openvpn.net</a><br>GitHub地址：<a href="https://github.com/OpenVPN/openvpn">https://github.com/OpenVPN/openvpn</a></p><p><strong>OpenVPN 示意图</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-intrduce2.jpg"></p><h2 id="二、OpenVPN-部署"><a href="#二、OpenVPN-部署" class="headerlink" title="二、OpenVPN 部署"></a>二、OpenVPN 部署</h2><h3 id="2-1-准备-OpenVPN-部署环境"><a href="#2-1-准备-OpenVPN-部署环境" class="headerlink" title="2.1 准备 OpenVPN 部署环境"></a>2.1 准备 OpenVPN 部署环境</h3><p>官文文档: <a href="https://openvpn.net/community-resources/how-to/">https://openvpn.net/community-resources/how-to/</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup1.jpg"></p><p><strong>可选择以下两套环境之一实现OpenVPN</strong></p><h4 id="2-1-1-环境1-阿里云OpenVPN-实战环境"><a href="#2-1-1-环境1-阿里云OpenVPN-实战环境" class="headerlink" title="2.1.1 环境1: 阿里云OpenVPN 实战环境"></a>2.1.1 环境1: 阿里云OpenVPN 实战环境</h4><p><strong>准备阿里云网络实验环境</strong></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-number">1</span> 阿里云创建专有网络<br>指定城市和可用区<span class="hljs-symbol">:</span>华北<span class="hljs-number">3</span>张家口可用区A区<br>网段名magedu-net1和地址段<span class="hljs-number">172.16</span>.0.0/<span class="hljs-number">12</span>,默认资源组<br>交换机名magedu-net1-sw1 可用区A IPv4的地址段 <span class="hljs-number">172.30</span>.0.0/<span class="hljs-number">24</span><br>安全组开放<span class="hljs-number">22</span>端口<br><br><span class="hljs-number">2</span> 创建OpenVPN服务器有公网IP的实例<span class="hljs-number">1</span>个<br>指定城市和可用区<span class="hljs-symbol">:</span>华北<span class="hljs-number">3</span>张家口可用区A区<br>计算型c6 <span class="hljs-number">2</span>vCPU <span class="hljs-number">4</span>G<br>网络<span class="hljs-symbol">:magedu-net1</span> 交换机<span class="hljs-symbol">:magedu-net1-sw1</span><br>公网IP 按量收费 <span class="hljs-number">10</span>M<br>默认安全组 默认配置 <span class="hljs-number">22</span>,<span class="hljs-number">3389</span>,icmp<br>centos8.<span class="hljs-number">2</span><br>系统盘 存储默认高效云盘<span class="hljs-number">40</span>G<br><br>0.<span class="hljs-number">3</span>元/小时 公网流量0.<span class="hljs-number">8</span>元/G<br><br><span class="hljs-number">3</span> 创建局域网的服务器无公网IP的实例<span class="hljs-number">2</span>个<br>按量付费<br>指定城市和可用区<span class="hljs-symbol">:</span>华北<span class="hljs-number">3</span>张家口可用区A区<br>共享型 <span class="hljs-number">2</span>vCPU2G<br>centos8.<span class="hljs-number">2</span><br><br>系统盘 存储默认高效云盘<span class="hljs-number">40</span>G<br>网络<span class="hljs-symbol">:magedu-net1</span> magedu-net1-sw1<br>无公网IP<br>默认安全组<br>主网卡sw1<br><br><span class="hljs-number">4</span> 重设所有实例密码<br><br><span class="hljs-number">5</span> 修改安全组打开 <span class="hljs-number">1194</span>/TCP/UDP<br></code></pre></td></tr></table></figure><h5 id="2-1-1-1-购买第一台有公网IP的ECS"><a href="#2-1-1-1-购买第一台有公网IP的ECS" class="headerlink" title="2.1.1.1 购买第一台有公网IP的ECS"></a>2.1.1.1 购买第一台有公网IP的ECS</h5><p>阿里云购买链接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://ecs-buy.aliyun.com/wizard?<br>spm=5176.8789780.1092585.1.1db055ca1sGhza<span class="hljs-comment">#/prepay/cn-hangzhou?</span><br>periodType=Yearly&amp;period=1&amp;instanceType=ecs.g5.large<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup2.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup3.jpg"></p><h5 id="2-1-1-2-先创建网络和交换机"><a href="#2-1-1-2-先创建网络和交换机" class="headerlink" title="2.1.1.2 先创建网络和交换机"></a>2.1.1.2 先创建网络和交换机</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup4.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup5.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup6.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup7.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup8.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup9.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup10.jpg"></p><h5 id="2-1-1-3-再购买两台内网无公网的ECS"><a href="#2-1-1-3-再购买两台内网无公网的ECS" class="headerlink" title="2.1.1.3 再购买两台内网无公网的ECS"></a>2.1.1.3 再购买两台内网无公网的ECS</h5><p>注意和第一台主机在同一个地域和可用区</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup11.jpg"></p><p>网络和第一台主机一样,无公网IP</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup12.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup13.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup14.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup15.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup16.jpg"></p><h5 id="2-1-1-4-验证主机配置"><a href="#2-1-1-4-验证主机配置" class="headerlink" title="2.1.1.4 验证主机配置"></a>2.1.1.4 验证主机配置</h5><p>创建完成,三台主机</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup17.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#有公网IP的ECS</span><br>ssh 39.100.145.14<br>root@39.100.145.14<span class="hljs-string">&#x27;s password:</span><br><span class="hljs-string">Welcome to Alibaba Cloud Elastic Compute Service !</span><br><span class="hljs-string">Activate the web console with: systemctl enable --now cockpit.socket</span><br><span class="hljs-string">Last failed login: Tue Sep 15 10:15:15 CST 2020 from 222.137.18.20 on ssh:notty</span><br><span class="hljs-string">There was 1 failed login attempt since the last successful login.</span><br><span class="hljs-string">Last login: Tue Sep 15 10:13:10 2020 from 222.137.18.20</span><br><span class="hljs-string"></span><br><span class="hljs-string">hostname -I</span><br><span class="hljs-string">172.30.0.1</span><br><span class="hljs-string"></span><br><span class="hljs-string">hostname</span><br><span class="hljs-string">vpn-server.magedu.org</span><br><span class="hljs-string"></span><br><span class="hljs-string">cat /etc/centos-release</span><br><span class="hljs-string">CentOS Linux release 8.2.2004 (Core)</span><br><span class="hljs-string"></span><br><span class="hljs-string">#无公网IP的ECS1</span><br><span class="hljs-string">hostname -I</span><br><span class="hljs-string">172.30.0.100</span><br><span class="hljs-string"></span><br><span class="hljs-string">hostname</span><br><span class="hljs-string">web1.magedu.org</span><br><span class="hljs-string"></span><br><span class="hljs-string">cat /etc/centos-release</span><br><span class="hljs-string">CentOS Linux release 8.2.2004 (Core)</span><br><span class="hljs-string"></span><br><span class="hljs-string">#无公网IP的ECS2</span><br><span class="hljs-string">hostname</span><br><span class="hljs-string">web2.magedu.org</span><br><span class="hljs-string"></span><br><span class="hljs-string">hostname -I</span><br><span class="hljs-string">172.30.0.200</span><br><span class="hljs-string"></span><br><span class="hljs-string">cat /etc/centos-release</span><br><span class="hljs-string">CentOS Linux release 8.2.2004 (Core)</span><br></code></pre></td></tr></table></figure><h5 id="2-1-1-5-修改网络防火墙规则"><a href="#2-1-1-5-修改网络防火墙规则" class="headerlink" title="2.1.1.5 修改网络防火墙规则"></a>2.1.1.5 修改网络防火墙规则</h5><p>默认VPN的端口无法访问,修改网络防火墙规则,添加1规则实现1194/TCP/UDP端口允许通过</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup18.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup19.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup20.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup21.jpg"></p><h4 id="2-1-2-环境2-局域网-OpenVPN-实战环境"><a href="#2-1-2-环境2-局域网-OpenVPN-实战环境" class="headerlink" title="2.1.2 环境2: 局域网 OpenVPN 实战环境"></a>2.1.2 环境2: 局域网 OpenVPN 实战环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">共四台主机<br>1 openvpn server：<br>CentOS 7.4<br>eth0:10.0.0.8/24 NAT模式,模拟公网IP<br>eth1:10.20.0.1/24 仅主机模式,私网IP<br><br>2 内网主机两台<br>第一台主机<br>eth0:10.20.0.100/24 仅主机模式,私网IP<br>第二台主机<br>eth0:10.20.0.200/24 仅主机模式,私网IP<br><br>3 Windows 客户端<br>Windows 10<br></code></pre></td></tr></table></figure><h3 id="2-2-安装-OpenVPN-软件包"><a href="#2-2-安装-OpenVPN-软件包" class="headerlink" title="2.2 安装 OpenVPN 软件包"></a>2.2 安装 OpenVPN 软件包</h3><h4 id="2-2-1查看版本"><a href="#2-2-1查看版本" class="headerlink" title="2.2.1查看版本"></a>2.2.1查看版本</h4><h5 id="2-2-1-1-查看官网的OpenVPN的版本"><a href="#2-2-1-1-查看官网的OpenVPN的版本" class="headerlink" title="2.2.1.1 查看官网的OpenVPN的版本"></a>2.2.1.1 查看官网的OpenVPN的版本</h5><p>访问官网：<a href="https://openvpn.net/">https://openvpn.net</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup22.jpg"></p><h5 id="2-2-1-2-在不同OS上查看OpenVPN版本"><a href="#2-2-1-2-在不同OS上查看OpenVPN版本" class="headerlink" title="2.2.1.2 在不同OS上查看OpenVPN版本"></a>2.2.1.2 在不同OS上查看OpenVPN版本</h5><p><strong>CentOS系统上的EPEL源OpenVPN版本比Ubuntu的仓库中版本更新,以下选择在CentOS7上部署OpenVPN</strong></p><p>范例: CentOS 查看OpenVPN版本</p><p>（注意：使用阿里云的epel源寻找openvpn的时，需要直接指定epel源的完整路径，不然会找不到包）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum list openvpn</span><br>openvpn.x86_64      2.4.10-1.el7                    epel<br>[root@centos7 ~]<span class="hljs-comment"># yum list easy-rsa</span><br>easy-rsa.noarch     3.0.8-1.el7                      epel<br></code></pre></td></tr></table></figure><p>范例: Ubuntu1804 查看OpenVPN版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt list openvpn<br>Listing... Done<br>openvpn/bionic-proposed 2.4.4-2ubuntu1.4 amd64<br>N: There are 2 additional versions. Please use the <span class="hljs-string">&#x27;-a&#x27;</span> switch to see the<br><br>apt-cache madison openvpn<br> openvpn | 2.4.4-2ubuntu1.4 | http://mirrors.aliyun.com/ubuntu bionic-<br>proposed/main amd64 Packages<br> openvpn | 2.4.4-2ubuntu1.3 | http://mirrors.aliyun.com/ubuntu bionic-<br>updates/main amd64 Packages<br> openvpn | 2.4.4-2ubuntu1 | http://mirrors.aliyun.com/ubuntu bionic/main amd64<br>Packages<br> openvpn | 2.4.4-2ubuntu1 | http://mirrors.aliyun.com/ubuntu bionic/main<br>Sources<br> openvpn | 2.4.4-2ubuntu1.3 | http://mirrors.aliyun.com/ubuntu bionic-<br>updates/main Sources<br> openvpn | 2.4.4-2ubuntu1.4 | http://mirrors.aliyun.com/ubuntu bionic-<br>proposed/main Sources<br><br>apt-cache madison easy-rsa<br>easy-rsa |   2.2.2-2 | http://mirrors.aliyun.com/ubuntu bionic/universe amd64<br>Packages<br>easy-rsa |   2.2.2-2 | http://mirrors.aliyun.com/ubuntu bionic/universe i386<br>Packages<br>easy-rsa |   2.2.2-2 | http://mirrors.aliyun.com/ubuntu bionic/universe<br>Sources<br></code></pre></td></tr></table></figure><h4 id="2-2-2-安装-OpenVPN"><a href="#2-2-2-安装-OpenVPN" class="headerlink" title="2.2.2 安装 OpenVPN"></a>2.2.2 安装 OpenVPN</h4><h5 id="2-2-2-1-安装OpenVPN和证书工具"><a href="#2-2-2-1-安装OpenVPN和证书工具" class="headerlink" title="2.2.2.1 安装OpenVPN和证书工具"></a>2.2.2.1 安装OpenVPN和证书工具</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#OpenVPN服务器端</span><br>[root@centos7 ~]<span class="hljs-comment"># yum -y install openvpn</span><br><br><span class="hljs-comment">#证书管理工具</span><br>[root@centos7 ~]<span class="hljs-comment"># yum -y install easy-rsa</span><br></code></pre></td></tr></table></figure><h5 id="2-2-2-2-查看包中相关文件"><a href="#2-2-2-2-查看包中相关文件" class="headerlink" title="2.2.2.2 查看包中相关文件"></a>2.2.2.2 查看包中相关文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># rpm -qi openvpn easy-rsa</span><br>Name        : openvpn<br>Version     : 2.4.10<br>Release     : 1.el7<br>Architecture: x86_64<br>Install Date: Wed 03 Mar 2021 11:33:01 AM CST<br>Group       : Unspecified<br>Size        : 1282923<br>License     : GPLv2<br>Signature   : RSA/SHA256, Thu 10 Dec 2020 02:15:14 AM CST, Key ID 6a2faea2352c64e5<br>Source RPM  : openvpn-2.4.10-1.el7.src.rpm<br>Build Date  : Thu 10 Dec 2020 01:00:01 AM CST<br>Build Host  : buildhw-x86-10.iad2.fedoraproject.org<br>Relocations : (not relocatable)<br>Packager    : Fedora Project<br>Vendor      : Fedora Project<br>URL         : https://community.openvpn.net/<br>Bug URL     : https://bugz.fedoraproject.org/openvpn<br>Summary     : A full-featured SSL VPN solution<br>Description :<br>OpenVPN is a robust and highly flexible tunneling application that uses all<br>of the encryption, authentication, and certification features of the<br>OpenSSL library to securely tunnel IP networks over a single UDP or TCP<br>port.  It can use the Marcus Franz Xaver Johannes Oberhumers LZO library<br><span class="hljs-keyword">for</span> compression.<br>Name        : easy-rsa<br>Version     : 3.0.8<br>Release     : 1.el7<br>Architecture: noarch<br>Install Date: Wed 03 Mar 2021 11:33:11 AM CST<br>Group       : Unspecified<br>Size        : 122756<br>License     : GPLv2<br>Signature   : RSA/SHA256, Thu 10 Sep 2020 09:23:24 PM CST, Key ID 6a2faea2352c64e5<br>Source RPM  : easy-rsa-3.0.8-1.el7.src.rpm<br>Build Date  : Thu 10 Sep 2020 09:21:31 PM CST<br>Build Host  : buildhw-x86-11.iad2.fedoraproject.org<br>Relocations : (not relocatable)<br>Packager    : Fedora Project<br>Vendor      : Fedora Project<br>URL         : https://github.com/OpenVPN/easy-rsa<br>Bug URL     : https://bugz.fedoraproject.org/easy-rsa<br>Summary     : Simple shell based CA utility<br>Description :<br>This is a small RSA key management package, based on the openssl<br><span class="hljs-built_in">command</span> line tool, that can be found <span class="hljs-keyword">in</span> the easy-rsa subdirectory<br>of the OpenVPN distribution. While this tool is primary concerned<br>with key management <span class="hljs-keyword">for</span> the SSL VPN application space, it can also<br>be used <span class="hljs-keyword">for</span> building web certificates.<br><br>[root@centos7 ~]<span class="hljs-comment"># rpm -ql openvpn</span><br>/etc/openvpn<br>/etc/openvpn/client<br>/etc/openvpn/server<br>/run/openvpn-client<br>/run/openvpn-server<br>/usr/lib/systemd/system/openvpn-client@.service<br>/usr/lib/systemd/system/openvpn-server@.service<br>/usr/lib/systemd/system/openvpn@.service<br>/usr/lib/tmpfiles.d/openvpn.conf<br>/usr/lib64/openvpn<br>/usr/lib64/openvpn/plugins<br>/usr/lib64/openvpn/plugins/openvpn-plugin-auth-pam.so<br>/usr/lib64/openvpn/plugins/openvpn-plugin-down-root.so<br>/usr/sbin/openvpn<br>/usr/share/doc/openvpn-2.4.10<br>/usr/share/doc/openvpn-2.4.10/AUTHORS<br>/usr/share/doc/openvpn-2.4.10/COPYING<br>/usr/share/doc/openvpn-2.4.10/COPYRIGHT.GPL<br>/usr/share/doc/openvpn-2.4.10/ChangeLog<br>/usr/share/doc/openvpn-2.4.10/Changes.rst<br>/usr/share/doc/openvpn-2.4.10/README<br>/usr/share/doc/openvpn-2.4.10/README.auth-pam<br>/usr/share/doc/openvpn-2.4.10/README.down-root<br>/usr/share/doc/openvpn-2.4.10/README.systemd<br>/usr/share/doc/openvpn-2.4.10/contrib<br>/usr/share/doc/openvpn-2.4.10/contrib/OCSP_check<br>/usr/share/doc/openvpn-2.4.10/contrib/OCSP_check/OCSP_check.sh<br>/usr/share/doc/openvpn-2.4.10/contrib/README<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/README<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/fwmarkroute.down<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/fwmarkroute.up<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf/client.down<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf/client.up<br>/usr/share/doc/openvpn-2.4.10/management-notes.txt<br>/usr/share/doc/openvpn-2.4.10/sample<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/README<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/client.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/firewall.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/home.up<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/loopback-client<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/loopback-server<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/office.up<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/openvpn-shutdown.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/openvpn-startup.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/roadwarrior-client.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/roadwarrior-server.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/server.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/static-home.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/static-office.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/tls-home.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/tls-office.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/xinetd-client-config<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/xinetd-server-config<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/auth-pam.pl<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/bridge-start<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/bridge-stop<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/ucn.pl<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/verify-cn<br>/usr/share/doc/openvpn-2.4.10/sample/sample-windows<br>/usr/share/doc/openvpn-2.4.10/sample/sample-windows/sample.ovpn<br>/usr/share/man/man8/openvpn.8.gz<br>/var/lib/openvpn<br><br>[root@centos7 ~]<span class="hljs-comment"># rpm -ql easy-rsa</span><br>/etc/openvpn<br>/etc/openvpn/client<br>/etc/openvpn/server<br>/run/openvpn-client<br>/run/openvpn-server<br>/usr/lib/systemd/system/openvpn-client@.service<br>/usr/lib/systemd/system/openvpn-server@.service<br>/usr/lib/systemd/system/openvpn@.service<br>/usr/lib/tmpfiles.d/openvpn.conf<br>/usr/lib64/openvpn<br>/usr/lib64/openvpn/plugins<br>/usr/lib64/openvpn/plugins/openvpn-plugin-auth-pam.so<br>/usr/lib64/openvpn/plugins/openvpn-plugin-down-root.so<br>/usr/sbin/openvpn<br>/usr/share/doc/openvpn-2.4.10<br>/usr/share/doc/openvpn-2.4.10/AUTHORS<br>/usr/share/doc/openvpn-2.4.10/COPYING<br>/usr/share/doc/openvpn-2.4.10/COPYRIGHT.GPL<br>/usr/share/doc/openvpn-2.4.10/ChangeLog<br>/usr/share/doc/openvpn-2.4.10/Changes.rst<br>/usr/share/doc/openvpn-2.4.10/README<br>/usr/share/doc/openvpn-2.4.10/README.auth-pam<br>/usr/share/doc/openvpn-2.4.10/README.down-root<br>/usr/share/doc/openvpn-2.4.10/README.systemd<br>/usr/share/doc/openvpn-2.4.10/contrib<br>/usr/share/doc/openvpn-2.4.10/contrib/OCSP_check<br>/usr/share/doc/openvpn-2.4.10/contrib/OCSP_check/OCSP_check.sh<br>/usr/share/doc/openvpn-2.4.10/contrib/README<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/README<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/fwmarkroute.down<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/fwmarkroute.up<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf/client.down<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf/client.up<br>/usr/share/doc/openvpn-2.4.10/management-notes.txt<br>/usr/share/doc/openvpn-2.4.10/sample<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/README<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/client.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/firewall.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/home.up<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/loopback-client<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/loopback-server<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/office.up<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/openvpn-shutdown.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/openvpn-startup.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/roadwarrior-client.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/roadwarrior-server.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/server.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/static-home.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/static-office.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/tls-home.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/tls-office.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/xinetd-client-config<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/xinetd-server-config<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/auth-pam.pl<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/bridge-start<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/bridge-stop<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/ucn.pl<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/verify-cn<br>/usr/share/doc/openvpn-2.4.10/sample/sample-windows<br>/usr/share/doc/openvpn-2.4.10/sample/sample-windows/sample.ovpn<br>/usr/share/man/man8/openvpn.8.gz<br>/var/lib/openvpn<br>[root@centos7 yum.repos.d]<span class="hljs-comment"># rpm -ql easy-rsa</span><br>/usr/share/doc/easy-rsa-3.0.8<br>/usr/share/doc/easy-rsa-3.0.8/COPYING.md<br>/usr/share/doc/easy-rsa-3.0.8/ChangeLog<br>/usr/share/doc/easy-rsa-3.0.8/README.md<br>/usr/share/doc/easy-rsa-3.0.8/README.quickstart.md<br>/usr/share/doc/easy-rsa-3.0.8/vars.example<br>/usr/share/easy-rsa<br>/usr/share/easy-rsa/3<br>/usr/share/easy-rsa/3.0<br>/usr/share/easy-rsa/3.0.8<br>/usr/share/easy-rsa/3.0.8/easyrsa<br>/usr/share/easy-rsa/3.0.8/openssl-easyrsa.cnf<br>/usr/share/easy-rsa/3.0.8/x509-types<br>/usr/share/easy-rsa/3.0.8/x509-types/COMMON<br>/usr/share/easy-rsa/3.0.8/x509-types/ca<br>/usr/share/easy-rsa/3.0.8/x509-types/client<br>/usr/share/easy-rsa/3.0.8/x509-types/code-signing<br>/usr/share/easy-rsa/3.0.8/x509-types/email<br>/usr/share/easy-rsa/3.0.8/x509-types/kdc<br>/usr/share/easy-rsa/3.0.8/x509-types/server<br>/usr/share/easy-rsa/3.0.8/x509-types/serverClient<br>/usr/share/licenses/easy-rsa-3.0.8<br>/usr/share/licenses/easy-rsa-3.0.8/gpl-2.0.txt<br></code></pre></td></tr></table></figure><h5 id="2-2-2-3-准备相关配置文件"><a href="#2-2-2-3-准备相关配置文件" class="headerlink" title="2.2.2.3 准备相关配置文件"></a>2.2.2.3 准备相关配置文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#生成服务器配置文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cp /usr/share/doc/openvpn-2.4.10/sample/sample-config-files/server.conf /etc/openvpn/</span><br><br><span class="hljs-comment">#准备证书签发相关文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server</span><br><br><span class="hljs-comment">#准备签发证书相关变量的配置文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cp /usr/share/doc/easy-rsa-3.0.8/vars.example /etc/openvpn/easy-rsa-server/3/vars</span><br><br><span class="hljs-comment">#建议修改给CA和OpenVPN服务器颁发的证书的有效期,可适当加长</span><br>[root@centos7 ~]<span class="hljs-comment"># vim /etc/openvpn/easy-rsa-server/3/vars</span><br><span class="hljs-comment">#CA的证书有效期默为为10年,可以适当延长,比如:36500天</span><br><span class="hljs-comment">#set_var EASYRSA_CA_EXPIRE   3650</span><br>set_var EASYRSA_CA_EXPIRE    36500<br><br><span class="hljs-comment">#服务器证书默为为825天,可适当加长,比如:3650天</span><br><span class="hljs-comment">#set_var EASYRSA_CERT_EXPIRE  825</span><br><span class="hljs-comment">#将上面行修改为下面</span><br>set_var EASYRSA_CERT_EXPIRE   3650<br><br>[root@centos7 ~]<span class="hljs-comment"># tree /etc/openvpn/</span><br>/etc/openvpn/<br>├── client<br>├── easy-rsa-server<br>│  ├── 3 -&gt; 3.0.7<br>│  ├── 3.0 -&gt; 3.0.7<br>│  └── 3.0.7<br>│    ├── easyrsa<br>│    ├── openssl-easyrsa.cnf<br>│    ├── vars<br>│    └── x509-types<br>│      ├── ca<br>│      ├── client<br>│      ├── code-signing<br>│      ├── COMMON<br>│      ├── email<br>│      ├── kdc<br>│      ├── server<br>│      └── serverClient<br>├── server<br>└── server.conf<br>7 directories, 12 files<br></code></pre></td></tr></table></figure><h3 id="2-3-准备证书相关文件"><a href="#2-3-准备证书相关文件" class="headerlink" title="2.3 准备证书相关文件"></a>2.3 准备证书相关文件</h3><h4 id="2-3-1-初始化PKI和CA签发机构环境"><a href="#2-3-1-初始化PKI和CA签发机构环境" class="headerlink" title="2.3.1 初始化PKI和CA签发机构环境"></a>2.3.1 初始化PKI和CA签发机构环境</h4><h5 id="2-3-1-1-脚本easyrsa帮助用法"><a href="#2-3-1-1-脚本easyrsa帮助用法" class="headerlink" title="2.3.1.1 脚本easyrsa帮助用法"></a>2.3.1.1 脚本easyrsa帮助用法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3/cd /etc/openvpn/easy-rsa-server/3/</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-server/3<br>[root@centos7 3]<span class="hljs-comment"># file ./easyrsa</span><br>./easyrsa: POSIX shell script, ASCII text executable<br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa </span><br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa/3.0.7/vars<br><br>Easy-RSA 3 usage and overview<br><br>USAGE: easyrsa [options] COMMAND [command-options]<br><br>A list of commands is shown below. To get detailed usage and <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> a<br><span class="hljs-built_in">command</span>, run:<br>./easyrsa <span class="hljs-built_in">help</span> COMMAND<br><br>For a listing of options that can be supplied before the <span class="hljs-built_in">command</span>, use:<br>./easyrsa <span class="hljs-built_in">help</span> options<br><br>Here is the list of commands available with a short syntax reminder. Use the<br><span class="hljs-string">&#x27;help&#x27;</span> <span class="hljs-built_in">command</span> above to get full usage details.<br><br>init-pki<br>build-ca [ cmd-opts ]<br>gen-dh<br>gen-req &lt;filename_base&gt; [ cmd-opts ]<br>sign-req &lt;<span class="hljs-built_in">type</span>&gt; &lt;filename_base&gt;<br>build-client-full &lt;filename_base&gt; [ cmd-opts ]<br>build-server-full &lt;filename_base&gt; [ cmd-opts ]<br>revoke &lt;filename_base&gt; [cmd-opts]<br>renew &lt;filename_base&gt; [cmd-opts]<br>build-serverClient-full &lt;filename_base&gt; [ cmd-opts ]<br>gen-crl<br>update-db<br>show-req &lt;filename_base&gt; [ cmd-opts ]<br>show-cert &lt;filename_base&gt; [ cmd-opts ]<br>show-ca [ cmd-opts ]<br>import-req &lt;request_file_path&gt; &lt;short_basename&gt;<br>export-p7 &lt;filename_base&gt; [ cmd-opts ]<br>export-p12 &lt;filename_base&gt; [ cmd-opts ]<br>set-rsa-pass &lt;filename_base&gt; [ cmd-opts ]<br>set-ec-pass &lt;filename_base&gt; [ cmd-opts ]<br>upgrade &lt;<span class="hljs-built_in">type</span>&gt;<br><br>DIRECTORY STATUS (commands would take effect on these locations)<br>EASYRSA: /etc/openvpn/easy-rsa/3.0.7<br>  PKI: /etc/openvpn/easy-rsa/3/pki<br></code></pre></td></tr></table></figure><h5 id="2-3-1-2-初始化PKI生成PKI相关目录和文件"><a href="#2-3-1-2-初始化PKI生成PKI相关目录和文件" class="headerlink" title="2.3.1.2 初始化PKI生成PKI相关目录和文件"></a>2.3.1.2 初始化PKI生成PKI相关目录和文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3/</span><br>root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-server/3<br><br>[root@centos7 3]<span class="hljs-comment"># ls</span><br>easyrsa openssl-easyrsa.cnf vars x509-types<br><span class="hljs-comment">#初始化数据,在当前目录下生成pki目录及相关文件</span><br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa init-pki</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>init-pki complete; you may now create a CA or requests.<br>Your newly created PKI dir is: /etc/openvpn/easy-rsa-server/3/pki<br><br>[root@centos7 3]<span class="hljs-comment"># tree</span><br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki      <span class="hljs-comment">#生成一个新目录及相关文件</span><br>│  ├── openssl-easyrsa.cnf<br>│  ├── private<br>│  ├── reqs<br>│  └── safessl-easyrsa.cnf<br>├── vars<br>└── x509-types<br> ├── ca<br> ├── client<br> ├── code-signing<br> ├── COMMON<br> ├── email<br> ├── kdc<br> ├── server<br> └── serverClient<br>4 directories, 13 files<br></code></pre></td></tr></table></figure><h4 id="2-3-2-创建CA机构"><a href="#2-3-2-创建CA机构" class="headerlink" title="2.3.2 创建CA机构"></a>2.3.2 创建CA机构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># tree pki</span><br>pki<br>├── openssl-easyrsa.cnf<br>├── private<br>├── reqs<br>└── safessl-easyrsa.cnf<br><br>2 directories, 2 files<br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa build-ca nopass</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating RSA private key, 2048 bit long modulus (2 primes)<br>...................................................+++++<br>........+++++<br>e is 65537 (0x010001)<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [Easy-RSA CA]: <span class="hljs-comment">#接受默认值,直接回车</span><br><br>CA creation complete and you may now import and sign cert requests.<br>Your new CA certificate file <span class="hljs-keyword">for</span> publishing is at:<br>/etc/openvpn/easy-rsa-server/3/pki/ca.crt  <span class="hljs-comment">#生成自签名的证书文件</span><br><br>[root@centos7 3]<span class="hljs-comment"># tree pki</span><br>pki<br>├── ca.crt <span class="hljs-comment">#生成自签名的证书文件</span><br>├── certs_by_serial<br>├── index.txt<br>├── index.txt.attr<br>├── issued<br>├── openssl-easyrsa.cnf<br>├── private<br>│  └── ca.key <span class="hljs-comment">#生成私钥文件</span><br>├── renewed<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── reqs<br>├── revoked<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>└── serial<br>12 directories, 7 files<br><br><span class="hljs-comment">#生成CA相关的文件</span><br>[root@centos7 3]<span class="hljs-comment"># cat pki/serial</span><br>01<br>[root@centos7 3]<span class="hljs-comment"># ll pki/index.txt</span><br>-rw------- 1 root root 0 Aug  2 16:42 pki/index.txt<br>[root@centos7 3]<span class="hljs-comment"># cat pki/serial</span><br>01<br>[root@centos7 3]<span class="hljs-comment"># ll pki/ca.crt pki/private/ca.key</span><br>-rw------- 1 root root 1204 Aug  2 16:42 pki/ca.crt<br>-rw------- 1 root root 1675 Aug  2 16:42 pki/private/ca.key<br><br><span class="hljs-comment">#查看生成的自签名证书</span><br>cat pki/ca.crt<br>-----BEGIN CERTIFICATE-----<br>MIIDSzCCAjOgAwIBAgIUfOBoVD77VY3WI6i+X6tUbayrRnowDQYJKoZIhvcNAQEL<br>BQAwFjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0EwHhcNMjAwODAyMDg0MjI3WhcNMzAw<br>NzMxMDg0MjI3WjAWMRQwEgYDVQQDDAtFYXN5LVJTQSBDQTCCASIwDQYJKoZIhvcN<br>AQEBBQADggEPADCCAQoCggEBAMejJZdSXakfGPfkSsXEzaIuVwMy7is9+DuhdxiZ<br>UiZfuLs7clzRtd0arSSytDQEn+Fjf0zc8HCqvtYjJ3HdXx0bhBkGX4ikszbGcBJD<br>JuE25Qu86P3CsNjhcSvAWTRlivKoYXJA1lIUNOXpBlUBA/7XbkvUdVM0CXechnSr<br>1sddffqISu/xnrsPpFsdjfgfwPRuYIUDiitozGk2jE8/fZo3VwwHbqe5GURFlv0k<br>Y6/afOP2YJBwOFcjvoa1p5+VOhsVG5lhLBdXKc0kHrchzXPLjTODOKoNW0xxCvty<br>B69b7l/t5HGNue2se3FuzH45mkQfNvi/t9Ms7F7FE4euuAsCAwEAAaOBkDCBjTAd<br>BgNVHQ4EFgQU7IEA8jlzixju11dvjoC65Ula6rIwUQYDVR0jBEowSIAU7IEA8jlz<br>ixju11dvjoC65Ula6rKhGqQYMBYxFDASBgNVBAMMC0Vhc3ktUlNBIENBghR84GhU<br>PvtVjdYjqL5fq1RtrKtGejAMBgNVHRMEBTADAQH/MAsGA1UdDwQEAwIBBjANBgkq<br>hkiG9w0BAQsFAAOCAQEAZjyvrAL23EONViFexiAwVN0ypAd7X8yMwSJsHz/uPg/N<br>HXBlEzFZLvny7hWcdoa3gaPOAawBR4ab2riuKFRiiqWu6VM9P/pGufGDBVXkYVnJ<br>buxHtA4kCbFIy1LlqHw9pfZbRJ4esprLfr5KSgqdqFf2v2Vwq3RlapFTiSjJsIWj<br>lsgboc2PtpXcB9YKN/x11Dqt1o15hmjjCHwFnE90NNQ/P/ENwhh2xZCfVVvg3Sr3<br>t/qwEi2uImBkBuJUhExykcl3jptwEse1Ql3SUs8VGkkCic03m8glwxjTGnaKNkG+<br>9DiTvn57iCoM+VtKDgkOeusl36PDvG86XUZZUD5Vww==<br>-----END CERTIFICATE-----<br>[root@centos7 3]<span class="hljs-comment"># openssl x509 -in pki/ca.crt -noout -text</span><br>Certificate:<br> Data:<br>   Version: 3 (0x2)<br>   Serial Number:<br>     7c:e0:68:54:3e:fb:55:8d:d6:23:a8:be:5f:ab:54:6d:ac:ab:46:7a<br>   Signature Algorithm: sha256WithRSAEncryption<br>   Issuer: CN = Easy-RSA CA<br>   Validity<br>     Not Before: Aug  2 08:42:27 2020 GMT<br>     Not After : Jul 31 08:42:27 2030 GMT<br>   Subject: CN = Easy-RSA CA<br>   Subject Public Key Info:<br>     Public Key Algorithm: rsaEncryption<br>       RSA Public-Key: (2048 bit)<br>       Modulus:<br>          00:c7:a3:25:97:52:5d:a9:1f:18:f7:e4:4a:c5:c4:<br>          <span class="hljs-built_in">cd</span>:a2:2e:57:03:32:ee:2b:3d:f8:3b:a1:77:18:99:<br>          52:26:5f:b8:bb:3b:72:5c:d1:b5:dd:1a:ad:24:b2:<br>          b4:34:04:9f:e1:63:7f:4c:dc:f0:70:aa:be:d6:23:<br>          27:71:dd:5f:1d:1b:84:19:06:5f:88:a4:b3:36:c6:<br>          70:12:43:26:e1:36:e5:0b:bc:e8:fd:c2:b0:d8:e1:<br>          71:2b:c0:59:34:65:8a:f2:a8:61:72:40:d6:52:14:<br>          34:e5:e9:06:55:01:03:fe:d7:6e:4b:d4:75:53:34:<br>          09:77:9c:86:74:ab:d6:c7:5d:7d:fa:88:4a:ef:f1:<br>         9e:bb:0f:a4:5b:1d:8d:f8:1f:c0:f4:6e:60:85:03:<br>         8a:2b:68:cc:69:36:8c:4f:3f:7d:9a:37:57:0c:07:<br>         6e:a7:b9:19:44:45:96:fd:24:63:af:da:7c:e3:f6:<br>          60:90:70:38:57:23:be:86:b5:a7:9f:95:3a:1b:15:<br>         1b:99:61:2c:17:57:29:<span class="hljs-built_in">cd</span>:24:1e:b7:21:<span class="hljs-built_in">cd</span>:73:cb:<br>         8d:33:83:38:aa:0d:5b:4c:71:0a:fb:72:07:af:5b:<br>         ee:5f:ed:e4:71:8d:b9:ed:ac:7b:71:6e:cc:7e:39:<br>         9a:44:1f:36:f8:bf:b7:d3:2c:ec:5e:c5:13:87:ae:<br>         b8:0b<br>       Exponent: 65537 (0x10001)<br>   X509v3 extensions:<br>     X509v3 Subject Key Identifier:<br>       EC:81:00:F2:39:73:8B:18:EE:D7:57:6F:8E:80:BA:E5:49:5A:EA:B2<br>     X509v3 Authority Key Identifier:<br>     <br>keyid:EC:81:00:F2:39:73:8B:18:EE:D7:57:6F:8E:80:BA:E5:49:5A:EA:B2<br>       DirName:/CN=Easy-RSA CA<br>       <br>serial:7C:E0:68:54:3E:FB:55:8D:D6:23:A8:BE:5F:AB:54:6D:AC:AB:46:7A<br><br>     X509v3 Basic Constraints:<br>       CA:TRUE<br>     X509v3 Key Usage:<br>       Certificate Sign, CRL Sign<br> Signature Algorithm: sha256WithRSAEncryption<br>    66:3c:af:ac:02:f6:dc:43:8d:56:21:5e:c6:20:30:54:dd:32:<br>    a4:07:7b:5f:cc:8c:c1:22:6c:1f:3f:ee:3e:0f:<span class="hljs-built_in">cd</span>:1d:70:65:<br>    13:31:59:2e:f9:f2:ee:15:9c:76:86:b7:81:a3:ce:01:ac:01:<br>    47:86:9b:da:b8:ae:28:54:62:8a:a5:ae:e9:53:3d:3f:fa:46:<br>    b9:f1:83:05:55:e4:61:59:c9:6e:ec:47:b4:0e:24:09:b1:48:<br>    cb:52:e5:a8:7c:3d:a5:f6:5b:44:9e:1e:b2:9a:cb:7e:be:4a:<br>    4a:0a:9d:a8:57:f6:bf:65:70:ab:74:65:6a:91:53:89:28:c9:<br>    b0:85:a3:96:c8:1b:a1:<span class="hljs-built_in">cd</span>:8f:b6:95:dc:07:d6:0a:37:<span class="hljs-built_in">fc</span>:75:<br>    d4:3a:ad:d6:8d:79:86:68:e3:08:7c:05:9c:4f:74:34:d4:3f:<br>    3f:f1:0d:c2:18:76:c5:90:9f:55:5b:e0:dd:2a:f7:b7:fa:b0:<br>    12:2d:ae:22:60:64:06:e2:54:84:4c:72:91:c9:77:8e:9b:70:<br>    12:c7:b5:42:5d:d2:52:cf:15:1a:49:02:89:<span class="hljs-built_in">cd</span>:37:9b:c8:25:<br>    c3:18:d3:1a:76:8a:36:41:be:f4:38:93:be:7e:7b:88:2a:0c:<br>    f9:5b:4a:0e:09:0e:7a:eb:25:df:a3:c3:bc:6f:3a:5d:46:59:<br>    50:3e:55:c3<br></code></pre></td></tr></table></figure><h4 id="2-3-3-创建服务端证书申请"><a href="#2-3-3-创建服务端证书申请" class="headerlink" title="2.3.3 创建服务端证书申请"></a>2.3.3 创建服务端证书申请</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-server/3<br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-req server nopass</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating a RSA private key<br>..................+++++<br>................................................................................<br>....................................................+++++<br>writing new private key to <span class="hljs-string">&#x27;/etc/openvpn/easy-rsa-server/3/pki/easy-rsa-</span><br><span class="hljs-string">2135.JNDCBg/tmp.6nXb8b&#x27;</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [server]: <span class="hljs-comment">#接受Common Name的默认值,直接回车</span><br><br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-server/3/pki/reqs/server.req      <span class="hljs-comment">#生成请求文件</span><br>key: /etc/openvpn/easy-rsa-server/3/pki/private/server.key    <span class="hljs-comment">#生成私钥文件</span><br><br>[root@centos7 3]<span class="hljs-comment"># tree pki</span><br>pki<br>├── ca.crt<br>├── certs_by_serial<br>├── index.txt<br>├── index.txt.attr<br>├── issued<br>├── openssl-easyrsa.cnf<br>├── private<br>│  ├── ca.key<br>│  └── server.key    <span class="hljs-comment">#生成私钥文件</span><br>├── renewed<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── reqs<br>│  └── server.req    <span class="hljs-comment">#生成请求文件</span><br>├── revoked<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>└── serial<br><br>12 directories, 9 files<br></code></pre></td></tr></table></figure><h4 id="2-3-4-签发服务端证书"><a href="#2-3-4-签发服务端证书" class="headerlink" title="2.3.4 签发服务端证书"></a>2.3.4 签发服务端证书</h4><h5 id="2-3-4-1-查看颁发证书命令用法"><a href="#2-3-4-1-查看颁发证书命令用法" class="headerlink" title="2.3.4.1 查看颁发证书命令用法"></a>2.3.4.1 查看颁发证书命令用法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa help sign</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>sign-req &lt;<span class="hljs-built_in">type</span>&gt; &lt;filename_base&gt;<br>  Sign a certificate request of the defined <span class="hljs-built_in">type</span>. &lt;<span class="hljs-built_in">type</span>&gt; must be a known<br>  <span class="hljs-built_in">type</span> such as <span class="hljs-string">&#x27;client&#x27;</span>, <span class="hljs-string">&#x27;server&#x27;</span>, <span class="hljs-string">&#x27;serverClient&#x27;</span>, or <span class="hljs-string">&#x27;ca&#x27;</span> (or a user-added<br><span class="hljs-built_in">type</span>.)<br>  This request file must exist <span class="hljs-keyword">in</span> the reqs/ dir and have a .req file<br>  extension. See import-req below <span class="hljs-keyword">for</span> importing reqs from other sources.<br></code></pre></td></tr></table></figure><h5 id="2-3-4-2-颁发服务端证书"><a href="#2-3-4-2-颁发服务端证书" class="headerlink" title="2.3.4.2 颁发服务端证书"></a>2.3.4.2 颁发服务端证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#将上面server.req的申请,颁发server类型的证书</span><br>[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa sign server server</span><br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br><br>You are about to sign the following certificate.<br>Please check over the details shown below <span class="hljs-keyword">for</span> accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br><span class="hljs-built_in">source</span> or that you have verified the request checksum with the sender.<br><br>Request subject, to be signed as a server certificate <span class="hljs-keyword">for</span> 3650 days:  <span class="hljs-comment">#可以看到vars文件指定的有效期</span><br><br>subject=<br> commonName         = server<br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Confirm request details: yes <span class="hljs-comment">#输入yes回车</span><br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-<br>2334.MEAQFE/tmp.SIdgaC<br>Check that the request matches the signature<br>Signature ok<br>The Subject<span class="hljs-string">&#x27;s Distinguished Name is as follows</span><br><span class="hljs-string">commonName      :ASN.1 12:&#x27;</span>server<span class="hljs-string">&#x27;</span><br><span class="hljs-string">Certificate is to be certified until Oct 31 09:19:43 2020 GMT (90 days)</span><br><span class="hljs-string"></span><br><span class="hljs-string">Write out database with 1 new entries</span><br><span class="hljs-string">Data Base Updated</span><br><span class="hljs-string"></span><br><span class="hljs-string">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt #生成服务器证书文件</span><br></code></pre></td></tr></table></figure><h5 id="2-3-4-3-验证结果"><a href="#2-3-4-3-验证结果" class="headerlink" title="2.3.4.3 验证结果"></a>2.3.4.3 验证结果</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># tree pki</span><br>pki<br>├── ca.crt<br>├── certs_by_serial<br>│  └── EDAEBAB8D65066D307AE58ADC1A56682.pem  <span class="hljs-comment">#服务器证书文件</span><br>├── index.txt<br>├── index.txt.attr<br>├── index.txt.attr.old<br>├── index.txt.old<br>├── issued<br>│  └── server.crt      <span class="hljs-comment">#服务器证书文件</span><br>├── openssl-easyrsa.cnf<br>├── private<br>│  ├── ca.key<br>│  └── server.key<br>├── renewed<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── reqs<br>│  └── server.req<br>├── revoked<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>├── serial<br>└── serial.old<br><br>12 directories, 14 files<br><br>[root@centos7 3]<span class="hljs-comment"># diff pki/certs_by_serial/EDAEBAB8D65066D307AE58ADC1A56682.pem pki/issued/server.crt</span><br><br><span class="hljs-comment">#ll !*</span><br>ll pki/certs_by_serial/EDAEBAB8D65066D307AE58ADC1A56682.pem<br>pki/issued/server.crt<br>-rw------- 1 root root 4608 Aug  2 17:19<br>pki/certs_by_serial/EDAEBAB8D65066D307AE58ADC1A56682.pem<br>-rw------- 1 root root 4608 Aug  2 17:19 pki/issued/server.crt<br><br>[root@centos7 3]<span class="hljs-comment"># cat pki/issued/server.crt</span><br>Certificate:<br> Data:<br>   Version: 3 (0x2)<br>   Serial Number:<br>     ed:ae:ba:b8:d6:50:66:d3:07:ae:58:ad:c1:a5:66:82<br>   Signature Algorithm: sha256WithRSAEncryption<br>   Issuer: CN=Easy-RSA CA<br>   Validity<br>     Not Before: Aug  2 09:19:43 2020 GMT<br>     Not After : Aug  2 09:19:43 2030 GMT<br>   Subject: CN=server<br>   Subject Public Key Info:<br>     Public Key Algorithm: rsaEncryption<br>       RSA Public-Key: (2048 bit)<br>       Modulus:<br>       00:e2:64:ae:f4:b2:5e:32:15:d6:4c:43:b3:24:79:<br>         d6:7c:44:5f:1b:d8:18:81:1a:e3:52:39:39:a3:11:<br>         c8:b8:ea:73:94:72:6f:af:ed:69:ab:4d:57:5e:53:<br>         e2:95:de:c4:c5:bd:58:77:ae:0e:56:a7:0b:46:81:<br>          13:b0:92:06:<span class="hljs-built_in">cd</span>:3a:f7:f7:ad:f2:39:4e:15:b4:16:<br>          24:8e:64:a6:bf:39:61:16:47:24:b1:67:3c:9a:d3:<br>         e3:e6:9e:f2:dc:9e:90:b3:14:95:af:00:b8:6a:e2:<br>         4a:83:3b:ff:5c:82:ef:5b:81:8f:b0:<span class="hljs-built_in">fc</span>:11:15:b6:<br>         2c:ac:e4:24:<span class="hljs-built_in">fc</span>:f8:15:6f:d6:8e:24:05:71:f7:63:<br>         dd:8e:62:eb:d3:11:33:d8:d4:5a:9e:6e:14:0d:f0:<br>         9a:db:3d:98:33:1f:a3:4e:aa:80:db:d1:63:1e:51:<br>          63:ac:ff:ca:9b:4c:3f:45:d7:e2:a1:11:a2:9c:ff:<br>         bd:fd:09:33:94:fd:da:96:4d:40:20:dc:1c:4f:1a:<br>         0d:52:93:ea:0d:30:6c:b6:b4:b6:7c:9e:f0:78:d7:<br>          44:2b:e2:90:fb:0b:20:e0:5f:fe:84:f2:3e:7f:d3:<br>         bf:88:f6:14:f2:a2:a0:7c:d1:bf:49:9e:c8:8f:51:<br>         d5:f0:08:c8:3f:e9:4f:b9:5b:27:a9:94:c5:74:9d:<br>         f4:5b<br>       Exponent: 65537 (0x10001)<br>   X509v3 extensions:<br>     X509v3 Basic Constraints:<br>       CA:FALSE<br>     X509v3 Subject Key Identifier:<br>       2B:96:04:F2:CC:99:52:8A:35:43:5A:AF:BC:8B:AE:F7:A4:21:19:AF<br>     X509v3 Authority Key Identifier:<br>     <br>keyid:EC:81:00:F2:39:73:8B:18:EE:D7:57:6F:8E:80:BA:E5:49:5A:EA:B2<br>       DirName:/CN=Easy-RSA CA<br>       <br>serial:7C:E0:68:54:3E:FB:55:8D:D6:23:A8:BE:5F:AB:54:6D:AC:AB:46:7A<br><br>     X509v3 Extended Key Usage:<br>       TLS Web Server Authentication<br>     X509v3 Key Usage:<br>       Digital Signature, Key Encipherment<br>     X509v3 Subject Alternative Name:<br>       DNS:server<br> Signature Algorithm: sha256WithRSAEncryption<br>    b4:1e:b2:57:2f:3d:6c:93:8f:38:7f:03:e6:50:51:50:35:51:<br>    21:ac:02:27:c4:01:68:8f:52:f9:55:7a:01:f3:8f:02:64:59:<br>    04:56:58:8c:44:43:31:f6:0e:0f:81:8a:97:3d:16:50:0a:40:<br>    5e:20:0c:18:23:d1:1c:3d:cf:92:9c:9f:75:62:58:e9:91:5f:<br>    7e:8a:a5:90:51:0e:34:5c:61:4b:00:7a:35:3b:3c:23:61:86:<br>    32:52:30:d3:50:de:51:e5:b8:b8:e5:3b:da:87:ce:94:1e:6b:<br>    c4:9e:f8:e2:a9:01:df:8a:21:38:8f:a9:09:81:87:<span class="hljs-built_in">fc</span>:9e:b0:<br>    a6:35:72:99:05:8e:06:a8:2b:49:ab:0b:89:92:<span class="hljs-built_in">fc</span>:fd:1a:02:<br>    20:23:c3:ef:d9:40:93:2e:b8:53:07:59:1e:94:7f:ec:41:55:<br>    2d:74:91:32:55:22:bb:da:b9:8b:4d:64:f0:ec:67:b5:9c:30:<br>    05:de:85:e1:9d:2e:31:86:66:0e:25:7c:82:a3:83:68:10:1b:<br>    a5:7a:45:f7:b7:e1:22:4b:0e:73:dd:14:6a:34:79:13:e6:10:<br>    62:2d:ff:44:8e:7b:ff:96:d7:40:5a:a6:ee:5b:53:e5:02:87:<br>    29:ab:5d:8c:fb:ed:16:38:7d:99:71:66:36:18:c0:e4:b9:a9:<br>    32:b8:ef:ce<br>-----BEGIN CERTIFICATE-----<br>MIIDaDCCAlCgAwIBAgIRAO2uurjWUGbTB65YrcGlZoIwDQYJKoZIhvcNAQELBQAw<br>FjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0EwHhcNMjAwODAyMDkxOTQzWhcNMjAxMDMx<br>MDkxOTQzWjARMQ8wDQYDVQQDDAZzZXJ2ZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IB<br>DwAwggEKAoIBAQDiZK70sl4yFdZMQ7MkedZ8RF8b2BiBGuNSOTmjEci46nOUcm+v<br>7WmrTVdeU+KV3sTFvVh3rg5WpwtGgROwkgbNOvf3rfI5ThW0FiSOZKa/OWEWRySx<br>Zzya0+PmnvLcnpCzFJWvALhq4kqDO/9cgu9bgY+w/BEVtiys5CT8+BVv1o4kBXH3<br>Y92OYuvTETPY1FqebhQN8JrbPZgzH6NOqoDb0WMeUWOs/8qbTD9F1+KhEaKc/739<br>CTOU/dqWTUAg3BxPGg1Sk+oNMGy2tLZ8nvB410Qr4pD7CyDgX/6E8j5/07+I9hTy<br>oqB80b9JnsiPUdXwCMg/6U+5WyeplMV0nfRbAgMBAAGjgbUwgbIwCQYDVR0TBAIw<br>ADAdBgNVHQ4EFgQUK5YE8syZUoo1Q1qvvIuu96QhGa8wUQYDVR0jBEowSIAU7IEA<br>8jlzixju11dvjoC65Ula6rKhGqQYMBYxFDASBgNVBAMMC0Vhc3ktUlNBIENBghR8<br>4GhUPvtVjdYjqL5fq1RtrKtGejATBgNVHSUEDDAKBggrBgEFBQcDATALBgNVHQ8E<br>BAMCBaAwEQYDVR0RBAowCIIGc2VydmVyMA0GCSqGSIb3DQEBCwUAA4IBAQC0HrJX<br>Lz1sk484fwPmUFFQNVEhrAInxAFoj1L5VXoB848CZFkEVliMREMx9g4PgYqXPRZQ<br>CkBeIAwYI9EcPc+SnJ91YljpkV9+iqWQUQ40XGFLAHo1OzwjYYYyUjDTUN5R5bi4<br>5Tvah86UHmvEnvjiqQHfiiE4j6kJgYf8nrCmNXKZBY4GqCtJqwuJkvz9GgIgI8Pv<br>2UCTLrhTB1kelH/sQVUtdJEyVSK72rmLTWTw7Ge1nDAF3oXhnS4xhmYOJXyCo4No<br>EBulekX3t+EiSw5z3RRqNHkT5hBiLf9Ejnv/ltdAWqbuW1PlAocpq12M++0WOH2Z<br>cWY2GMDkuakyuO/O<br>-----END CERTIFICATE-----<br><br><span class="hljs-comment">#证书相关文件</span><br>[root@centos7 3]<span class="hljs-comment"># cat pki/serial</span><br>EDAEBAB8D65066D307AE58ADC1A56683<br>[root@centos7 3]<span class="hljs-comment"># cat pki/index.txt</span><br>V 201031091943Z EDAEBAB8D65066D307AE58ADC1A56682 unknown /CN=server<br>[root@centos7 3]<span class="hljs-comment"># cat pki/serial.old</span><br>edaebab8d65066d307ae58adc1a56682<br></code></pre></td></tr></table></figure><h4 id="2-3-5-创建-Diffie-Hellman-密钥"><a href="#2-3-5-创建-Diffie-Hellman-密钥" class="headerlink" title="2.3.5 创建 Diffie-Hellman 密钥"></a>2.3.5 创建 Diffie-Hellman 密钥</h4><h5 id="2-3-5-1-Diffie-Hellman-算法"><a href="#2-3-5-1-Diffie-Hellman-算法" class="headerlink" title="2.3.5.1 Diffie-Hellman 算法"></a>2.3.5.1 Diffie-Hellman 算法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">Diffie-Hellman 密钥交换方法，由惠特菲尔德·迪菲（Bailey Whitfield Diffie）、马丁·赫尔曼<br>（Martin Edward Hellman）于1976年发表。它是一种安全协议，让双方在完全没有对方任何预先信息的条件下通过不安全信道建立起一个密钥，这个密钥一般作为“对称加密”的密钥而被双方在后续数据传输中使用。DH数学原理是base离散对数问题。做类似功能的还有非对称加密类算法，如：RSA。其应用非常广泛，在SSH、VPN、Https等都有应用。<br><br>wiki参考链接: https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange<br></code></pre></td></tr></table></figure><h5 id="2-3-5-2-创建-Diffie-Hellman-密钥"><a href="#2-3-5-2-创建-Diffie-Hellman-密钥" class="headerlink" title="2.3.5.2 创建 Diffie-Hellman 密钥"></a>2.3.5.2 创建 Diffie-Hellman 密钥</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>[root@centos7 3]<span class="hljs-comment"># /etc/openvpn/easy-rsa-server/3</span><br><br><span class="hljs-comment">#方法1</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-dh</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating DH parameters, 2048 bit long safe prime, generator 2<br>This is going to take a long time<br>................+..................................+............................<br>..........................++*++*++*++*<br>.......<span class="hljs-comment">#需要等待一会儿</span><br>DH parameters of size 2048 created at /etc/openvpn/easy-rsa-sever/3/pki/dh.pem<br><br><span class="hljs-comment">#查看生成的文件</span><br>[root@centos7 3]<span class="hljs-comment"># ll pki/dh.pem</span><br>-rw------- 1 root root 424 Aug  2 17:41 pki/dh.pem<br><br>[root@centos7 3]<span class="hljs-comment"># cat pki/dh.pem</span><br>-----BEGIN DH PARAMETERS-----<br>MIIBCAKCAQEAkOTKU13dlokdC6nPi/Saa3T0ubfb2k3YvbA+ZTSWKUPvtlzf7IC1<br>IF9XvWJO5jC7m2XL7Gld1i43GmUU+vYfyxQ9av6BgiT/Ug1BJbuQMtLzyS8O9zY/<br>nPw95ouT50y3SACe9BF+2mRm/91bX+XyrHG/XxpKpKN+6q1M4RwMFnE7iRpfUTUv<br>/DGml3pvLdtG7tMF5QOtmNlbRyA6iiuzABQ903tXQurOusQnDKolLp5DPgzSCKEQ<br>qMwMGapXzwtfk/wxsaiPHDh4Erjo4SMu4msRM9DY2Q6b5heidEihB5Ud0UXLSelg<br>vkqdEoqfWWzYZ5RKsugYgsIjc6uXhxxGiwIBAg==<br>-----END DH PARAMETERS-----<br><br><span class="hljs-comment">#方法2</span><br>[root@centos7 3]<span class="hljs-comment"># openssl dhparam -out /etc/openvpn/dh2048.pem 2048s</span><br>ll /etc/openvpn/dh2048.pem<br>-rw-r--r-- 1 root root 424 Aug  3 20:50 /etc/openvpn/dh2048.pem  <br></code></pre></td></tr></table></figure><h4 id="2-3-6-准备客户端证书环境"><a href="#2-3-6-准备客户端证书环境" class="headerlink" title="2.3.6 准备客户端证书环境"></a>2.3.6 准备客户端证书环境</h4><p><strong>上面服务端证书配置完成，下面是配置客户端证书</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 3]<span class="hljs-comment"># cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client</span><br><br>[root@centos7 3]<span class="hljs-comment"># cp /usr/share/doc/easy-rsa/vars.example /etc/openvpn//easy-rsa-client/3/vars</span><br><br>[root@centos7 3]<span class="hljs-comment"># cd /etc/openvpn//easy-rsa-client/3/</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>[root@centos7 3]<span class="hljs-comment"># /etc/openvpn/easy-rsa-client/3</span><br>[root@centos7 3]<span class="hljs-comment"># ls</span><br>easyrsa openssl-easyrsa.cnf vars x509-types<br><br>[root@centos7 3]<span class="hljs-comment"># tree</span><br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── vars<br>└── x509-types<br> ├── ca<br> ├── client<br> ├── code-signing<br> ├── COMMON<br> ├── email<br> ├── kdc<br> ├── server<br> └── serverClient<br> <br>1 directory, 11 files<br><br><span class="hljs-comment">#生成证书申请所需目录pki和文件</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa init-pki</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars<br><br>init-pki complete; you may now create a CA or requests.<br>Your newly created PKI dir is: /etc/openvpn/easy-rsa-client/3/pki  <span class="hljs-comment">#生成新目录</span><br><br>[root@centos7 3]<span class="hljs-comment"># tree</span><br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki                 <span class="hljs-comment">#生成新目录</span><br>│  ├── openssl-easyrsa.cnf<br>│  ├── private<br>│  ├── reqs<br>│  └── safessl-easyrsa.cnf<br>├── vars<br>└── x509-types<br> ├── ca<br> ├── client<br> ├── code-signing<br> ├── COMMON<br> ├── email<br> ├── kdc<br> ├── server<br> └── serverClient<br> <br>4 directories, 13 files<br></code></pre></td></tr></table></figure><h4 id="2-3-7-创建客户端证书申请"><a href="#2-3-7-创建客户端证书申请" class="headerlink" title="2.3.7 创建客户端证书申请"></a>2.3.7 创建客户端证书申请</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-client/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-client/3<br><span class="hljs-comment">#生成客户端用户的证书申请</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-req wangxiaochun nopass</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating a RSA private key<br>.......................................................+++++<br>................................................................................<br>.........................+++++<br>writing new private key to <span class="hljs-string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-</span><br><span class="hljs-string">3467.v5FPPS/tmp.GsttV6&#x27;</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [wangxiaochun]:  <span class="hljs-comment">#接受默认值,直接回车</span><br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-client/3/pki/reqs/wangxiaochun.req    <span class="hljs-comment">#私钥文件</span><br>key: /etc/openvpn/easy-rsa-client/3/pki/private/wangxiaochun.key   <span class="hljs-comment">#证书申请文件</span><br><br><span class="hljs-comment">#生成两个新文件</span><br>[root@centos7 3]<span class="hljs-comment"># tree</span><br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki<br>│  ├── openssl-easyrsa.cnf<br>│  ├── private<br>│  │  └── wangxiaochun.key  <span class="hljs-comment">#私钥文件</span><br>│  ├── reqs<br>│  │  └── wangxiaochun.req  <span class="hljs-comment">#证书申请文件</span><br>│  └── safessl-easyrsa.cnf<br>├── vars<br>└── x509-types<br> ├── ca<br> ├── client<br> ├── code-signing<br> ├── COMMON<br> ├── email<br> ├── kdc<br> ├── server<br> └── serverClient<br>4 directories, 15 files<br></code></pre></td></tr></table></figure><h4 id="2-3-8-签发客户端证书"><a href="#2-3-8-签发客户端证书" class="headerlink" title="2.3.8 签发客户端证书"></a>2.3.8 签发客户端证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-server/3<br><span class="hljs-comment">#将客户端证书请求文件复制到CA的工作目录</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/wangxiaochun.req wangxiaochun</span><br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br><br>The request has been successfully imported with a short name of: wangxiaochun<br>You may now use this name to perform signing operations on this request.<br><br>[root@centos7 3]<span class="hljs-comment"># tree pki</span><br>pki<br>├── ca.crt<br>├── certs_by_serial<br>│  └── EDAEBAB8D65066D307AE58ADC1A56682.pem<br>├── dh.pem<br>├── index.txt<br>├── index.txt.attr<br>├── index.txt.attr.old<br>├── index.txt.old<br>├── issued<br>│  └── server.crt<br>├── openssl-easyrsa.cnf<br>├── private<br>│  ├── ca.key<br>│  └── server.key<br>├── renewed<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── reqs<br>│  ├── server.req<br>│  └── wangxiaochun.req  <span class="hljs-comment">#导入文件</span><br>├── revoked<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>├── serial<br>└── serial.old<br><br>12 directories, 16 files<br><br>[root@centos7 3]<span class="hljs-comment"># ll pki/reqs/wangxiaochun.req /etc/openvpn/easy-rsa-client/3/pki/reqs/wangxiaochun.req</span><br>-rw------- 1 root root 895 Aug  2 23:22 /etc/openvpn/easy-rsa-<br>client/3/pki/reqs/wangxiaochun.req<br>-rw------- 1 root root 895 Aug  2 23:30 pki/reqs/wangxiaochun.req<br><br><span class="hljs-comment">#修改给客户端颁发的证书的有效期</span><br>[root@centos7 3]<span class="hljs-comment"># vim vars</span><br><span class="hljs-comment">#建议修改给客户端颁发证书的有效期,可适当减少,比如:90天</span><br><span class="hljs-comment">#set_var EASYRSA_CERT_EXPIRE  825</span><br><span class="hljs-comment">#将上面行修改为下面</span><br>set_var EASYRSA_CERT_EXPIRE 90<br><br><span class="hljs-comment">#签发客户端证书</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa sign client wangxiaochun</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br><br>You are about to sign the following certificate.<br>Please check over the details shown below <span class="hljs-keyword">for</span> accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br><span class="hljs-built_in">source</span> or that you have verified the request checksum with the sender.<br><br>Request subject, to be signed as a client certificate <span class="hljs-keyword">for</span> 90 days:<br><br>subject=<br> commonName         = wangxiaochun<br> <br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Confirm request details: yes            <span class="hljs-comment">#输入yes后回车</span><br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-<br>3617.XN7fIU/tmp.P7NKo8<br>Check that the request matches the signature<br>Signature ok<br>The Subject<span class="hljs-string">&#x27;s Distinguished Name is as follows</span><br><span class="hljs-string">commonName      :ASN.1 12:&#x27;</span>wangxiaochun<span class="hljs-string">&#x27;</span><br><span class="hljs-string">Certificate is to be certified until Oct 31 15:38:15 2020 GMT (90 days)</span><br><span class="hljs-string"></span><br><span class="hljs-string">Write out database with 1 new entries</span><br><span class="hljs-string">Data Base Updated</span><br><span class="hljs-string"></span><br><span class="hljs-string">Certificate created at: /etc/openvpn/easy-rsa-</span><br><span class="hljs-string">server/3/pki/issued/wangxiaochun.crt #证书文件</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# tree pki</span><br><span class="hljs-string">pki</span><br><span class="hljs-string">├── ca.crt</span><br><span class="hljs-string">├── certs_by_serial</span><br><span class="hljs-string">│  ├── 5FE114ACC4FE6AB89D17E1B0EECF2B78.pem</span><br><span class="hljs-string">│  └── EDAEBAB8D65066D307AE58ADC1A56682.pem</span><br><span class="hljs-string">├── dh.pem</span><br><span class="hljs-string">├── index.txt</span><br><span class="hljs-string">├── index.txt.attr</span><br><span class="hljs-string">├── index.txt.attr.old</span><br><span class="hljs-string">├── index.txt.old</span><br><span class="hljs-string">├── issued</span><br><span class="hljs-string">│  ├── server.crt</span><br><span class="hljs-string">│  └── wangxiaochun.crt #生成客户端证书</span><br><span class="hljs-string">├── openssl-easyrsa.cnf</span><br><span class="hljs-string">├── private</span><br><span class="hljs-string">│  ├── ca.key</span><br><span class="hljs-string">│  └── server.key</span><br><span class="hljs-string">├── renewed</span><br><span class="hljs-string">│  ├── certs_by_serial</span><br><span class="hljs-string">│  ├── private_by_serial</span><br><span class="hljs-string">│  └── reqs_by_serial</span><br><span class="hljs-string">├── reqs</span><br><span class="hljs-string">│  ├── server.req</span><br><span class="hljs-string">│  └── wangxiaochun.req</span><br><span class="hljs-string">├── revoked</span><br><span class="hljs-string">│  ├── certs_by_serial</span><br><span class="hljs-string">│  ├── private_by_serial</span><br><span class="hljs-string">│  └── reqs_by_serial</span><br><span class="hljs-string">├── safessl-easyrsa.cnf</span><br><span class="hljs-string">├── serial</span><br><span class="hljs-string">└── serial.old</span><br><span class="hljs-string">12 directories, 18 files</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# cat pki/index.txt</span><br><span class="hljs-string">V 201031091943Z EDAEBAB8D65066D307AE58ADC1A56682 unknown /CN=server</span><br><span class="hljs-string">V 201031153815Z 5FE114ACC4FE6AB89D17E1B0EECF2B78 unknown /CN=wangxiaochun</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# ll pki/issued/</span><br><span class="hljs-string">total 16</span><br><span class="hljs-string">-rw------- 1 root root 4608 Aug  2 17:19 server.crt</span><br><span class="hljs-string">-rw------- 1 root root 4506 Aug  2 23:38 wangxiaochun.crt</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# ll pki/certs_by_serial/</span><br><span class="hljs-string">total 16</span><br><span class="hljs-string">-rw------- 1 root root 4506 Aug  2 23:38 5FE114ACC4FE6AB89D17E1B0EECF2B78.pem</span><br><span class="hljs-string">-rw------- 1 root root 4608 Aug  2 17:19 EDAEBAB8D65066D307AE58ADC1A56682.pem</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# cat pki/issued/wangxiaochun.crt</span><br><span class="hljs-string">Certificate:</span><br><span class="hljs-string"> Data:</span><br><span class="hljs-string">   Version: 3 (0x2)</span><br><span class="hljs-string">   Serial Number:</span><br><span class="hljs-string">     5f:e1:14:ac:c4:fe:6a:b8:9d:17:e1:b0:ee:cf:2b:78</span><br><span class="hljs-string">   Signature Algorithm: sha256WithRSAEncryption</span><br><span class="hljs-string">   Issuer: CN=Easy-RSA CA</span><br><span class="hljs-string">   Validity</span><br><span class="hljs-string">     Not Before: Aug  2 15:38:15 2020 GMT</span><br><span class="hljs-string">     Not After : Oct 31 15:38:15 2020 GMT</span><br><span class="hljs-string">   Subject: CN=wangxiaochun</span><br><span class="hljs-string">   Subject Public Key Info:</span><br><span class="hljs-string">     Public Key Algorithm: rsaEncryption</span><br><span class="hljs-string">       RSA Public-Key: (2048 bit)</span><br><span class="hljs-string">       Modulus:</span><br><span class="hljs-string">          00:c9:86:68:4d:2b:b6:4d:f7:e0:05:97:01:fa:e0:</span><br><span class="hljs-string">         8d:a8:83:4c:67:e4:59:16:a8:78:37:85:8b:cf:74:</span><br><span class="hljs-string">          29:ca:24:71:27:c6:ff:71:ac:e6:2f:66:93:62:fb:</span><br><span class="hljs-string">          28:6b:c3:4a:b6:5e:9f:e8:14:a3:73:f8:f5:27:7a:</span><br><span class="hljs-string">         a3:80:4e:b3:51:e8:f8:92:63:a6:4a:f4:82:17:01:</span><br><span class="hljs-string">          26:a8:ad:ea:79:53:c0:51:ab:f6:82:d2:ae:26:27:</span><br><span class="hljs-string">          cd:67:ef:65:a3:60:1a:3d:4f:09:8f:22:74:c7:79:</span><br><span class="hljs-string">         b4:50:19:78:9c:4e:b3:d7:5f:ff:cb:3a:9a:b3:e5:</span><br><span class="hljs-string">         1c:75:b2:46:55:c4:c9:a5:8b:40:db:3d:75:a5:33:</span><br><span class="hljs-string">         d0:cf:97:bb:bc:d8:f1:57:f1:60:e2:a6:b9:bb:6c:</span><br><span class="hljs-string">          30:fd:d2:15:c4:f8:56:b0:31:c8:c8:2f:36:96:e7:</span><br><span class="hljs-string">          45:12:17:05:dd:bf:f2:1d:37:7b:be:de:df:f1:4c:</span><br><span class="hljs-string">         a9:e0:8a:a3:ea:96:6d:17:04:0b:1d:11:7f:96:97:</span><br><span class="hljs-string">         5e:f3:64:58:7c:8c:d8:f0:fa:20:31:9e:53:d4:1f:</span><br><span class="hljs-string">         7b:0b:39:2b:81:78:84:4e:81:34:42:c7:64:fb:ed:</span><br><span class="hljs-string">         9f:47:8b:34:10:80:56:f1:db:48:8f:f8:d4:49:a7:</span><br><span class="hljs-string">         f0:1c:50:9f:7a:e7:38:e4:a5:0f:cf:5b:eb:23:17:</span><br><span class="hljs-string">          23:59</span><br><span class="hljs-string">       Exponent: 65537 (0x10001)</span><br><span class="hljs-string">   X509v3 extensions:</span><br><span class="hljs-string">     X509v3 Basic Constraints:</span><br><span class="hljs-string">       CA:FALSE</span><br><span class="hljs-string">     X509v3 Subject Key Identifier:</span><br><span class="hljs-string">        33:B6:15:7C:7B:F5:C4:5C:97:4D:1F:0E:94:2D:1C:79:64:36:2E:39</span><br><span class="hljs-string">     X509v3 Authority Key Identifier:</span><br><span class="hljs-string">      </span><br><span class="hljs-string">keyid:EC:81:00:F2:39:73:8B:18:EE:D7:57:6F:8E:80:BA:E5:49:5A:EA:B2</span><br><span class="hljs-string">       DirName:/CN=Easy-RSA CA</span><br><span class="hljs-string">      </span><br><span class="hljs-string">serial:7C:E0:68:54:3E:FB:55:8D:D6:23:A8:BE:5F:AB:54:6D:AC:AB:46:7A</span><br><span class="hljs-string">     X509v3 Extended Key Usage:</span><br><span class="hljs-string">       TLS Web Client Authentication</span><br><span class="hljs-string">     X509v3 Key Usage:</span><br><span class="hljs-string">       Digital Signature</span><br><span class="hljs-string"> Signature Algorithm: sha256WithRSAEncryption</span><br><span class="hljs-string">    72:85:bf:0f:02:66:15:06:9d:60:8e:8f:99:54:63:4a:de:cc:</span><br><span class="hljs-string">    15:cb:a5:67:4b:15:90:09:c9:ff:bb:58:ec:c6:4d:39:b1:2b:</span><br><span class="hljs-string">    81:3c:cc:46:b8:0c:ab:10:b5:5a:1e:76:df:ed:56:1b:f5:77:</span><br><span class="hljs-string">    72:ff:b9:14:1e:9d:06:7d:a6:7a:04:6d:79:ab:25:38:36:67:</span><br><span class="hljs-string">    32:6b:ec:9b:95:67:7c:8b:3b:5a:e1:2d:97:85:a3:e5:91:da:</span><br><span class="hljs-string">    c2:eb:28:2e:d3:98:10:25:34:d1:2d:99:b9:64:d3:96:fa:c7:</span><br><span class="hljs-string">    69:2e:f0:58:78:9e:63:03:89:86:04:3c:9c:7f:cb:33:0e:95:</span><br><span class="hljs-string">    af:99:56:96:c9:73:9a:3a:ef:3b:7c:fc:92:f9:25:ac:63:46:</span><br><span class="hljs-string">    68:83:76:bf:4a:bf:8a:1d:6b:75:27:7a:40:3b:15:d2:53:29:</span><br><span class="hljs-string">    01:58:14:cf:9f:cb:25:81:47:ae:76:ba:1c:95:74:96:16:f5:</span><br><span class="hljs-string">    ee:5f:71:a7:32:b1:6b:0a:e8:c5:c0:e9:29:b4:45:b5:71:91:</span><br><span class="hljs-string">    6e:8d:be:48:99:c5:33:97:12:db:cb:60:6c:06:ed:5c:a9:23:</span><br><span class="hljs-string">    ee:40:a7:bc:00:bd:96:ed:9b:57:f0:49:b2:07:dc:dc:d7:06:</span><br><span class="hljs-string">    ce:08:18:5e:28:13:24:e5:0b:8d:e9:d4:45:f0:11:30:70:2d:</span><br><span class="hljs-string">    e4:a5:79:92</span><br><span class="hljs-string">-----BEGIN CERTIFICATE-----</span><br><span class="hljs-string">MIIDWjCCAkKgAwIBAgIQX+EUrMT+aridF+Gw7s8reDANBgkqhkiG9w0BAQsFADAW</span><br><span class="hljs-string">MRQwEgYDVQQDDAtFYXN5LVJTQSBDQTAeFw0yMDA4MDIxNTM4MTVaFw0yMDEwMzEx</span><br><span class="hljs-string">NTM4MTVaMBcxFTATBgNVBAMMDHdhbmd4aWFvY2h1bjCCASIwDQYJKoZIhvcNAQEB</span><br><span class="hljs-string">BQADggEPADCCAQoCggEBAMmGaE0rtk334AWXAfrgjaiDTGfkWRaoeDeFi890Kcok</span><br><span class="hljs-string">cSfG/3Gs5i9mk2L7KGvDSrZen+gUo3P49Sd6o4BOs1Ho+JJjpkr0ghcBJqit6nlT</span><br><span class="hljs-string">wFGr9oLSriYnzWfvZaNgGj1PCY8idMd5tFAZeJxOs9df/8s6mrPlHHWyRlXEyaWL</span><br><span class="hljs-string">QNs9daUz0M+Xu7zY8VfxYOKmubtsMP3SFcT4VrAxyMgvNpbnRRIXBd2/8h03e77e</span><br><span class="hljs-string">3/FMqeCKo+qWbRcECx0Rf5aXXvNkWHyM2PD6IDGeU9Qfews5K4F4hE6BNELHZPvt</span><br><span class="hljs-string">n0eLNBCAVvHbSI/41Emn8BxQn3rnOOSlD89b6yMXI1kCAwEAAaOBojCBnzAJBgNV</span><br><span class="hljs-string">HRMEAjAAMB0GA1UdDgQWBBQzthV8e/XEXJdNHw6ULRx5ZDYuOTBRBgNVHSMESjBI</span><br><span class="hljs-string">gBTsgQDyOXOLGO7XV2+OgLrlSVrqsqEapBgwFjEUMBIGA1UEAwwLRWFzeS1SU0Eg</span><br><span class="hljs-string">Q0GCFHzgaFQ++1WN1iOovl+rVG2sq0Z6MBMGA1UdJQQMMAoGCCsGAQUFBwMCMAsG</span><br><span class="hljs-string">A1UdDwQEAwIHgDANBgkqhkiG9w0BAQsFAAOCAQEAcoW/DwJmFQadYI6PmVRjSt7M</span><br><span class="hljs-string">FculZ0sVkAnJ/7tY7MZNObErgTzMRrgMqxC1Wh523+1WG/V3cv+5FB6dBn2megRt</span><br><span class="hljs-string">easlODZnMmvsm5VnfIs7WuEtl4Wj5ZHawusoLtOYECU00S2ZuWTTlvrHaS7wWHie</span><br><span class="hljs-string">YwOJhgQ8nH/LMw6Vr5lWlslzmjrvO3z8kvklrGNGaIN2v0q/ih1rdSd6QDsV0lMp</span><br><span class="hljs-string">AVgUz5/LJYFHrna6HJV0lhb17l9xpzKxawroxcDpKbRFtXGRbo2+SJnFM5cS28tg</span><br><span class="hljs-string">bAbtXKkj7kCnvAC9lu2bV/BJsgfc3NcGzggYXigTJOULjenURfARMHAt5KV5kg==</span><br><span class="hljs-string">-----END CERTIFICATE-----</span><br></code></pre></td></tr></table></figure><p>如果需要颁发的客户端证书较多,可以使用下面脚本实现客户端证书的批量颁发</p><p><strong>客户端证书自动颁发脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat openvpn-user-crt.sh<br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#Author: wangxiaochun</span><br><span class="hljs-comment">#QQ: 29308620</span><br><span class="hljs-comment">#Date: 2020-08-02</span><br><span class="hljs-comment">#FileName： openvpn-user-crt.sh</span><br><span class="hljs-comment">#URL: http://www.wangxiaochun.com</span><br><span class="hljs-comment">#Description： The test script</span><br><span class="hljs-comment">#Copyright (C): 2020 All rights reserved</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入用户的姓名拼音(如:<span class="hljs-variable">$&#123;NAME&#125;</span>): &quot;</span> NAME<br><span class="hljs-built_in">cd</span> /etc/openvpn/easy-rsa-client/3<br>./easyrsa gen-req <span class="hljs-variable">$&#123;NAME&#125;</span> nopass &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-built_in">cd</span> /etc/openvpn/easy-rsa-server/3<br>./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="hljs-variable">$&#123;NAME&#125;</span>.req <span class="hljs-variable">$&#123;NAME&#125;</span><br><br>./easyrsa sign client <span class="hljs-variable">$&#123;NAME&#125;</span> &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">yes</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><h4 id="2-3-9-将ca和服务器证书相关文件复制到服务器相应的目录"><a href="#2-3-9-将ca和服务器证书相关文件复制到服务器相应的目录" class="headerlink" title="2.3.9 将ca和服务器证书相关文件复制到服务器相应的目录"></a>2.3.9 将ca和服务器证书相关文件复制到服务器相应的目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 3]<span class="hljs-comment"># mkdir /etc/openvpn/certs</span><br><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/</span><br><br>[root@centos7 3]<span class="hljs-comment"># ll /etc/openvpn/certs/</span><br>total 20<br>-rw------- 1 root root 1204 Aug  3 20:34 ca.crt<br>-rw------- 1 root root  424 Aug  3 20:35 dh.pem<br>-rw------- 1 root root 4608 Aug  3 20:34 server.crt<br>-rw------- 1 root root 1704 Aug  3 20:35 server.key<br></code></pre></td></tr></table></figure><h4 id="2-3-10-将客户端私钥与证书相关文件复制到服务器相关的目录"><a href="#2-3-10-将客户端私钥与证书相关文件复制到服务器相关的目录" class="headerlink" title="2.3.10 将客户端私钥与证书相关文件复制到服务器相关的目录"></a>2.3.10 将客户端私钥与证书相关文件复制到服务器相关的目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 3]<span class="hljs-comment"># mkdir /etc/openvpn/client/wangxiaochun/</span><br><br>[root@centos7 3]<span class="hljs-comment"># find /etc/openvpn/ -name &quot;wangxiaochun.key&quot; -o -name &quot;wangxiaochun.crt&quot; -o -name ca.crt</span><br>/etc/openvpn/easy-rsa-client/3.0.7/pki/private/wangxiaochun.key<br>/etc/openvpn/easy-rsa-server/3.0.7/pki/issued/wangxiaochun.crt<br>/etc/openvpn/easy-rsa-server/3.0.7/pki/ca.crt<br>/etc/openvpn/certs/ca.crt<br><br>[root@centos7 3]<span class="hljs-comment"># find /etc/openvpn/ \( -name &quot;wangxiaochun.key&quot; -o -name &quot;wangxiaochun.crt&quot; -o -name ca.crt \) -exec cp &#123;&#125; /etc/openvpn/client/wangxiaochun \;</span><br><br>[root@centos7 3]<span class="hljs-comment"># ll /etc/openvpn/client/wangxiaochun/</span><br>total 16<br>-rw------- 1 root root 1204 Aug  3 21:05 ca.crt<br>-rw------- 1 root root 4506 Aug  3 21:05 wangxiaochun.crt<br>-rw------- 1 root root 1704 Aug  3 21:05 wangxiaochun.key<br></code></pre></td></tr></table></figure><h3 id="2-4-准备-OpenVPN-服务器配置文件"><a href="#2-4-准备-OpenVPN-服务器配置文件" class="headerlink" title="2.4 准备 OpenVPN 服务器配置文件"></a>2.4 准备 OpenVPN 服务器配置文件</h3><h3 id="2-4-1-服务器端配置文件说明"><a href="#2-4-1-服务器端配置文件说明" class="headerlink" title="2.4.1 服务器端配置文件说明"></a>2.4.1 服务器端配置文件说明</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#server.conf文件中以#或;开头的行都为注释</span><br><span class="hljs-comment">#grep -Ev &quot;^#|^$&quot; /etc/openvpn/server.conf</span><br>;<span class="hljs-built_in">local</span> a.b.c.d  <span class="hljs-comment">#本机监听IP,默认为本机所有IP</span><br>port 1194    <span class="hljs-comment">#端口</span><br>;proto tcp    <span class="hljs-comment">#协议,生产推荐使用TCP</span><br>proto udp <span class="hljs-comment">#默认协议</span><br>;dev tap  <span class="hljs-comment">#创建一个以太网隧道，以太网使用tap,一个tap设备允许完整的以太网帧通过Openvpn隧道，可提供非ip协议的支持，比如IPX协议和AppleTalk协议,tap等同于一个以太网设备，它操作第二层数据包如以太网数据帧。</span><br>dev tun   <span class="hljs-comment">#创建一个路由IP隧道，生产推存使用tun.互联网使用tun,一个tun设备大多时候，被用于基于IP协议的通讯。tun模拟了网络层设备，操作第三层数据包比如IP数据封包。</span><br>;dev-node MyTap  <span class="hljs-comment">#TAP-Win32适配器。非windows不需要配置</span><br>ca ca.crt    <span class="hljs-comment">#ca证书文件</span><br>cert server.crt  <span class="hljs-comment">#服务器证书文件</span><br>key server.key  <span class="hljs-comment">#服务器私钥文件</span><br>dh dh2048.pem   <span class="hljs-comment">#dh参数文件</span><br>;topology subnet<br>server 10.8.0.0 255.255.255.0  <span class="hljs-comment">#客户端连接后分配IP的地址池，服务器默认会占用第一个IP10.8.0.1将做为客户端的网关</span><br>ifconfig-pool-persist ipp.txt  <span class="hljs-comment">#为客户端分配固定IP，不需要配置,建议注释</span><br>;server-bridge 10.8.0.4 255.255.255.0 10.8.0.50 10.8.0.100  <span class="hljs-comment">#配置网桥模式，不需要配置,建议注释</span><br>;server-bridge<br>;push <span class="hljs-string">&quot;route 192.168.10.0 255.255.255.0&quot;</span>  <span class="hljs-comment">#给客户端生成的到达服务器后面网段的静态路由，</span><br>下一跳为openvpn服务器的10.8.0.1<br>;push <span class="hljs-string">&quot;route 192.168.20.0 255.255.255.0&quot;</span>  <span class="hljs-comment">#推送路由信息到客户端，以允许客户端能够连接到服务器背后的其它私有子网</span><br>;client-config-dir ccd <span class="hljs-comment">#为指定的客户端添加路由，此路由通常是客户端后面的内网</span><br>网段而不是服务端的，也不需要设置<br>;route 192.168.40.128 255.255.255.248<br>;client-config-dir ccd  <br>;route 10.9.0.0 255.255.255.252<br>;learn-address ./script         <span class="hljs-comment">#运行外部脚本，创建不同组的iptables规则，无需配置</span><br>;push <span class="hljs-string">&quot;redirect-gateway def1 bypass-dhcp&quot;</span> <span class="hljs-comment">#启用后，客户端所有流量都将通过VPN服务器，因此生产一般无需配置此项</span><br>;push <span class="hljs-string">&quot;dhcp-option DNS 208.67.222.222&quot;</span>  <span class="hljs-comment">#推送DNS服务器，不需要配置</span><br>;push <span class="hljs-string">&quot;dhcp-option DNS 208.67.220.220&quot;</span><br>;client-to-client            <span class="hljs-comment">#允许不同的client直接通信,不安全,生产环境一般无需要配置</span><br>;duplicate-cn              <span class="hljs-comment">#多个用户共用一个证书，一般用于测试环境，生产环境都是一个用户一个证书,无需开启</span><br>keepalive 10 120     <span class="hljs-comment">#设置服务端检测的间隔和超时时间，默认为每10秒ping一次，如果 120秒没有回应则认为对方已经down</span><br>tls-auth ta.key 0 <span class="hljs-comment">#访止DoS等攻击的安全增强配置,可以使用以下命令来生成：openvpn --</span><br>genkey --secret ta.key <span class="hljs-comment">#服务器和每个客户端都需要拥有该密钥的一个拷贝。第二个参数在服务器端应该为’0’，在客户端应该为’1’</span><br>cipher AES-256-CBC  <span class="hljs-comment">#加密算法</span><br>;compress lz4-v2   <span class="hljs-comment">#启用Openvpn2.4.X新版压缩算法</span><br>;push <span class="hljs-string">&quot;compress lz4-v2&quot;</span>  <span class="hljs-comment">#推送客户端使用新版压缩算法,和下面的comp-lzo不要同时使用</span><br>;comp-lzo      <span class="hljs-comment">#旧户端兼容的压缩配置，需要客户端配置开启压缩,openvpn2.4.X等新版可以不用开启</span><br>;max-clients 100  <span class="hljs-comment">#最大客户端数</span><br>;user nobody     <span class="hljs-comment">#运行openvpn服务的用户和组</span><br>;group nobody<br>persist-key      <span class="hljs-comment">#重启VPN服务时默认会重新读取key文件，开启此配置后保留使用第一次的key文件,生产环境无需开启</span><br>persist-tun      <span class="hljs-comment">#启用此配置后,当重启vpn服务时，一直保持tun或者tap设备是up的，否则会先down然后再up,生产环境无需开启</span><br>status openvpn-status.log <span class="hljs-comment">#openVPN状态记录文件，每分钟会记录一次</span><br>;<span class="hljs-built_in">log</span>     openvpn.log  <span class="hljs-comment">#第一种日志记录方式,并指定日志路径，log会在openvpn启动的时候清空日志文件,不建议使用</span><br>;log-append openvpn.log  <span class="hljs-comment">#第二种日志记录方式,并指定日志路径，重启openvpn后在之前的日志后面追加新的日志,生产环境建议使用</span><br>verb 3          <span class="hljs-comment">#设置日志级别，0-9，级别越高记录的内容越详细,0 表示静默运行，只记录致命错误,4 表示合理的常规用法,5 和 6 可以帮助调试连接错误。9 表示极度冗余，输出非常详细的日志信息</span><br><br>;mute 20         <span class="hljs-comment">#相同类别的信息只有前20条会输出到日志文件中</span><br>explicit-exit-notify 1  <span class="hljs-comment">#通知客户端，在服务端重启后自动重新连接，仅能用于udp模式，tcp模式不需要配置即可实现断开重新连接,且开启此项后tcp配置后将导致openvpn服务无法启动,所以tcp时必须不能开启此项</span><br></code></pre></td></tr></table></figure><h4 id="2-4-2-修改服务器端配置文件"><a href="#2-4-2-修改服务器端配置文件" class="headerlink" title="2.4.2 修改服务器端配置文件"></a>2.4.2 修改服务器端配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#参照/usr/share/doc/openvpn-2.4.10/sample/sample-config-files文件</span><br>[root@centos7 ~]<span class="hljs-comment"># vim /etc/openvpn/server.conf #这里可以将原来的文件备份后，删除原来文件的所有内容，粘贴下来</span><br>port 1194<br>proto tcp<br>dev tun<br>ca /etc/openvpn/certs/ca.crt<br>cert /etc/openvpn/certs/server.crt<br>key /etc/openvpn/certs/server.key  <span class="hljs-comment"># This file should be kept secret</span><br>dh /etc/openvpn/certs/dh.pem<br>server 10.8.0.0 255.255.255.0<br>push <span class="hljs-string">&quot;route 172.30.0.0 255.255.255.0&quot;</span><br>keepalive 10 120<br>cipher AES-256-CBC<br>compress lz4-v2<br>push <span class="hljs-string">&quot;compress lz4-v2&quot;</span><br>max-clients 2048<br>user openvpn<br>group openvpn<br>status /var/<span class="hljs-built_in">log</span>/openvpn/openvpn-status.log<br>log-append /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log<br>verb 3<br>mute 20<br><br><span class="hljs-comment">#准备目志相关目录</span><br>[root@centos7 ~]<span class="hljs-comment"># getent passwd openvpn</span><br>openvpn:x:993:990:OpenVPN:/etc/openvpn:/sbin/nologin<br>[root@centos7 ~]<span class="hljs-comment"># mkdir /var/log/openvpn</span><br>[root@centos7 ~]<span class="hljs-comment"># chown openvpn.openvpn /var/log/openvpn</span><br>[root@centos7 ~]<span class="hljs-comment"># ll -d /var/log/openvpn</span><br>drwxr-xr-x 2 openvpn openvpn 6 Aug  3 23:07 /var/<span class="hljs-built_in">log</span>/openvpn<br></code></pre></td></tr></table></figure><h3 id="2-5-准备-iptables-规则和内核参数"><a href="#2-5-准备-iptables-规则和内核参数" class="headerlink" title="2.5 准备 iptables 规则和内核参数"></a>2.5 准备 iptables 规则和内核参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在服务器开启ip_forward转发功能</span><br>[root@centos7 ~]<span class="hljs-comment"># echo net.ipv4.ip_forward = 1 &gt;&gt; /etc/sysctl.conf</span><br>root@centos7 ~]<span class="hljs-comment"># sysctl -p</span><br>net.ipv4.ip_forward = 1<br><br><span class="hljs-comment">#添加SNAT规则</span><br>[root@centos7 ~]<span class="hljs-comment"># echo &#x27;iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE&#x27; &gt;&gt; /etc/rc.d/rc.local</span><br>[root@centos7 ~]<span class="hljs-comment"># chmod +x /etc/rc.d/rc.local</span><br>[root@centos7 ~]<span class="hljs-comment"># /etc/rc.d/rc.local</span><br>[root@centos7 ~]<span class="hljs-comment"># iptables -vnL</span><br><br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br><br>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br>   <br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br><br>[root@centos7 ~]<span class="hljs-comment"># iptables -vnL -t nat</span><br>Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br>   <br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br>   <br>Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br>   <br>  0   0 MASQUERADE all  -- *   *    10.8.0.0/24      0.0.0.0/0 <br>   <br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br></code></pre></td></tr></table></figure><h3 id="2-6-启动-OpenVPN-服务"><a href="#2-6-启动-OpenVPN-服务" class="headerlink" title="2.6 启动 OpenVPN 服务"></a>2.6 启动 OpenVPN 服务</h3><h4 id="2-6-1-启动-OpenVPN-服务"><a href="#2-6-1-启动-OpenVPN-服务" class="headerlink" title="2.6.1 启动 OpenVPN 服务"></a>2.6.1 启动 OpenVPN 服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># rpm -ql openvpn|grep systemd</span><br>/usr/lib/systemd/system/openvpn-client@.service<br>/usr/lib/systemd/system/openvpn-server@.service<br>/usr/lib/systemd/system/openvpn@.service<br>/usr/share/doc/openvpn-2.4.9/README.systemd<br><span class="hljs-comment">#CentOS8 缺失unit文件,从CentOS7复制文件</span><br>[root@centos7 ~]<span class="hljs-comment"># rpm -ql openvpn|grep systemd</span><br>/usr/lib/systemd/system/openvpn-client@.service<br>/usr/lib/systemd/system/openvpn-server@.service<br>/usr/share/doc/openvpn/README.systemd<br><br>[root@centos7 ~]<span class="hljs-comment"># cat /usr/lib/systemd/system/openvpn@.service</span><br>[Unit]<br>Description=OpenVPN Robust And Highly Flexible Tunneling Application On %I<br>After=network.target<br>[Service]<br>Type=notify<br>PrivateTmp=<span class="hljs-literal">true</span><br>ExecStart=/usr/sbin/openvpn --<span class="hljs-built_in">cd</span> /etc/openvpn/ --config %i.conf<br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment">#centos8</span><br>[root@centos8 ~]<span class="hljs-comment"># scp /lib/systemd/system/openvpn@.service 10.0.0.8:/lib/systemd/system/</span><br><br>[root@centos7 ~]<span class="hljs-comment"># systemctl daemon-reload</span><br><br>[root@centos7 ~]<span class="hljs-comment"># systemctl enable --now openvpn@server</span><br><span class="hljs-comment">#如启动有错误请安装以下依赖包</span><br>yum install -y lz4-devel lzo-devel pam-devel openssl-devel systemd-devel sqlite-devel<br></code></pre></td></tr></table></figure><h4 id="2-6-2-查看服务状态"><a href="#2-6-2-查看服务状态" class="headerlink" title="2.6.2 查看服务状态"></a>2.6.2 查看服务状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># systemctl status  openvpn@server</span><br>● openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling<br>Application On server<br> Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; enabled; vendor<br>preset: disabled)<br> Active: active (running) since Tue 2020-08-04 00:30:12 CST; 31s ago<br>Main PID: 7340 (openvpn)<br> Status: <span class="hljs-string">&quot;Initialization Sequence Completed&quot;</span><br> Tasks: 1 (<span class="hljs-built_in">limit</span>: 5882)<br> Memory: 2.4M<br> CGroup: /system.slice/system-openvpn.slice/openvpn@server.service<br>     └─7340 /usr/sbin/openvpn --<span class="hljs-built_in">cd</span> /etc/openvpn/ --config server.conf<br>     <br>Aug 04 00:30:12 centos8.wangxiaochun.com systemd[1]: Starting OpenVPN Robust And<br>Highly Flexible Tunneling Application &gt;<br>Aug 04 00:30:12 centos8.wangxiaochun.com systemd[1]: Started OpenVPN Robust And<br>Highly Flexible Tunneling Application<br><br><span class="hljs-comment">#注意端口号</span><br>[root@centos7 ~]<span class="hljs-comment"># ss -ntlp</span><br>State  Recv-Q  Send-Q Local Address:Port Peer Address:Port         <br>         <br>LISTEN  0     32      0.0.0.0:1194    0.0.0.0:*    users:<br>((<span class="hljs-string">&quot;openvpn&quot;</span>,pid=7340,fd=9))<br>LISTEN  0     128      0.0.0.0:22     0.0.0.0:*    users:<br>((<span class="hljs-string">&quot;sshd&quot;</span>,pid=761,fd=4))  <br>LISTEN  0     100     127.0.0.1:25     0.0.0.0:*    users:<br>((<span class="hljs-string">&quot;master&quot;</span>,pid=1093,fd=16))<br>LISTEN  0     128       [::]:22      [::]:*    users:<br>((<span class="hljs-string">&quot;sshd&quot;</span>,pid=761,fd=6))  <br>LISTEN  0     100      [::1]:25      [::]:*    users:<br>((<span class="hljs-string">&quot;master&quot;</span>,pid=1093,fd=17))<br><br>[root@centos7 ~]<span class="hljs-comment"># ps -ef | grep &#x27;open&#x27;</span><br>openvpn    3310      1  0 13:22 ?        00:00:00 /usr/sbin/openvpn --<span class="hljs-built_in">cd</span> /etc/openvpn/ --config server.conf<br>root       3344   2260  0 13:25 pts/0    00:00:00 grep --color=auto open<br><br><br>[root@centos7 ~]<span class="hljs-comment"># cat /var/log/openvpn/openvpn.log</span><br>Tue Aug  4 00:30:12 2020 OpenVPN 2.4.9 x86_64-redhat-linux-gnu [SSL (OpenSSL)]<br>[LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Apr 24 2020<br>Tue Aug  4 00:30:12 2020 library versions: OpenSSL 1.1.1c FIPS  28 May 2019, LZO<br>2.08<br>Tue Aug  4 00:30:12 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-tun -- this may cause restarts to fail<br>Tue Aug  4 00:30:12 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-key -- this may cause restarts to fail<br>Tue Aug  4 00:30:12 2020 Diffie-Hellman initialized with 2048 bit key<br>Tue Aug  4 00:30:12 2020 ROUTE_GATEWAY 10.0.0.2/255.255.255.0 IFACE=eth0<br>HWADDR=00:0c:29:8a:51:21<br>Tue Aug  4 00:30:12 2020 TUN/TAP device tun0 opened<br>Tue Aug  4 00:30:12 2020 TUN/TAP TX queue length <span class="hljs-built_in">set</span> to 100<br>Tue Aug  4 00:30:12 2020 /sbin/ip link <span class="hljs-built_in">set</span> dev tun0 up mtu 1500<br>Tue Aug  4 00:30:12 2020 /sbin/ip addr add dev tun0 <span class="hljs-built_in">local</span> 10.8.0.1 peer 10.8.0.2<br>Tue Aug  4 00:30:12 2020 /sbin/ip route add 10.8.0.0/24 via 10.8.0.2<br>Tue Aug  4 00:30:12 2020 Could not determine IPv4/IPv6 protocol. Using AF_INET<br>Tue Aug  4 00:30:12 2020 Socket Buffers: R=[87380-&gt;87380] S=[16384-&gt;16384]<br>Tue Aug  4 00:30:12 2020 Listening <span class="hljs-keyword">for</span> incoming TCP connection on [AF_INET]<br>[undef]:1194<br>Tue Aug  4 00:30:12 2020 TCPv4_SERVER link <span class="hljs-built_in">local</span> (bound): [AF_INET][undef]:1194<br>Tue Aug  4 00:30:12 2020 TCPv4_SERVER link remote: [AF_UNSPEC]<br>Tue Aug  4 00:30:12 2020 GID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 00:30:12 2020 UID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 00:30:12 2020 MULTI: multi_init called, r=256 v=256<br>Tue Aug  4 00:30:12 2020 IFCONFIG POOL: base=10.8.0.4 size=62, ipv6=0<br>Tue Aug  4 00:30:12 2020 IFCONFIG POOL LIST<br>Tue Aug  4 00:30:12 2020 MULTI: TCP INIT maxclients=2048 maxevents=2052<br>Tue Aug  4 00:30:12 2020 Initialization Sequence Completed<br><br>[root@centos7 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe8a:5121/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state<br>UNKNOWN group default qlen 100<br> link/none<br> inet 10.8.0.1 peer 10.8.0.2/32 scope global tun0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::c8db:a8ca:b492:a3e0/64 scope link stable-privacy<br>        valid_lft forever preferred_lft forever<br>        <br>[root@centos7 ~]<span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination   Gateway     Genmask     Flags Metric Ref  Use Iface<br>0.0.0.0     172.30.0.253   0.0.0.0     UG   100   0     0 eth0<br>10.8.0.0     10.8.0.2     255.255.255.0  UG   0    0     0 tun0<br>10.8.0.2     0.0.0.0     255.255.255.255 UH   0    0     0 tun0<br>172.30.0.0    0.0.0.0     255.255.255.0  U   100   0     0 eth0<br></code></pre></td></tr></table></figure><p>验证tun网卡设备：</p><p>输入：ifconfig tun0</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup23.jpg"></p><h3 id="2-7-准备-OpenVPN-客户端配置文件"><a href="#2-7-准备-OpenVPN-客户端配置文件" class="headerlink" title="2.7 准备 OpenVPN 客户端配置文件"></a>2.7 准备 OpenVPN 客户端配置文件</h3><h4 id="2-7-1-客户端默认范例配置文件说明"><a href="#2-7-1-客户端默认范例配置文件说明" class="headerlink" title="2.7.1 客户端默认范例配置文件说明"></a>2.7.1 客户端默认范例配置文件说明</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&#x27;^[[:alpha:]].*&#x27;</span> /usr/share/doc/openvpn/sample/sample-<br>config-files/client.conf<br>client   <span class="hljs-comment">#声明自己是个客户端</span><br>dev tun   <span class="hljs-comment">#接口类型，必须和服务端保持一致</span><br>proto udp  <span class="hljs-comment">#协议类型，必须和服务端保持一致</span><br>remote my-server-1 1194 <span class="hljs-comment">#server端的ip和端口，可以写域名但是需要可以解析成IP</span><br>resolv-retry infinite  <span class="hljs-comment">#如果是写的server端的域名，那么就始终解析，如果域名发生变化，会重新连接到新的域名对应的IP</span><br>nobind          <span class="hljs-comment">#本机不绑定监听端口，客户端是随机打开端口连接到服务端的1194</span><br>persist-key<br>persist-tun<br>ca ca.crt<br>cert client.crt<br>key client.key<br>remote-cert-tls server  <span class="hljs-comment">#指定采用服务器证书校验方式</span><br>tls-auth ta.key 1<br>cipher AES-256-CBC<br>verb 3<br></code></pre></td></tr></table></figure><h3 id="2-7-2-生成客户端用户的配置文件"><a href="#2-7-2-生成客户端用户的配置文件" class="headerlink" title="2.7.2 生成客户端用户的配置文件"></a>2.7.2 生成客户端用户的配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#生成客户端文件,文件后缀必须为.ovpn</span><br>[root@centos7 ~]<span class="hljs-comment"># grep &#x27;^[[:alpha:]].*&#x27; /usr/share/doc/openvpn-2.4.10/sample/sample-config-files/client.conf &gt; /etc/openvpn/client/wangxiaochun/client.ovpn</span><br><br><span class="hljs-comment">#修改配置文件,内容如下</span><br>[root@centos7 ~]<span class="hljs-comment"># vim /etc/openvpn/client/wangxiaochun/client.ovpn</span><br>[root@centos7 ~]<span class="hljs-comment"># cat /etc/openvpn/client/wangxiaochun/client.ovpn</span><br>client<br>dev tun<br>proto tcp<br>remote  10.0.0.8  1194        <span class="hljs-comment">#生产中为OpenVPN公网IP</span><br>resolv-retry infinite<br>nobind<br><span class="hljs-comment">#persist-key</span><br><span class="hljs-comment">#persist-tun</span><br>ca ca.crt<br>cert wangxiaochun.crt<br>key wangxiaochun.key<br>remote-cert-tls server<br><span class="hljs-comment">#tls-auth ta.key 1</span><br>cipher AES-256-CBC<br>verb 3 <span class="hljs-comment">#此值不能随意指定,否则无法通信</span><br>compress lz4-v2 <span class="hljs-comment">#此项在OpenVPN2.4.X版本使用,需要和服务器端保持一致,如不指定,默认使用comp-lz压缩</span><br></code></pre></td></tr></table></figure><h3 id="2-8-Windows-配置部署-OpenVPN-客户端"><a href="#2-8-Windows-配置部署-OpenVPN-客户端" class="headerlink" title="2.8 Windows 配置部署 OpenVPN 客户端"></a>2.8 Windows 配置部署 OpenVPN 客户端</h3><h4 id="2-8-1-Windows-安装-OpenVPN-客户端"><a href="#2-8-1-Windows-安装-OpenVPN-客户端" class="headerlink" title="2.8.1 Windows 安装 OpenVPN 客户端"></a>2.8.1 Windows 安装 OpenVPN 客户端</h4><p>官方客户端下载地址：<br><a href="https://openvpn.net/community-downloads/">https://openvpn.net/community-downloads/</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup24.jpg"></p><p><strong>openvpn客户端安装过程：</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup25.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup26.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup27.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup28.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup29.jpg"></p><h4 id="2-8-2-Windows-客户端配置准备"><a href="#2-8-2-Windows-客户端配置准备" class="headerlink" title="2.8.2 Windows 客户端配置准备"></a>2.8.2 Windows 客户端配置准备</h4><p>保存证书到openvpn 客户端安装目录：C:\Program Files\OpenVPN\config</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在服务器打包证书并下载发送给windows客户端</span><br><span class="hljs-built_in">cd</span> /etc/openvpn/client/wangxiaochun/<br>[root@centos7 wangxiaochun]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/client/wangxiaochun<br>[root@centos7 wangxiaochun]<span class="hljs-comment">#tar cf wangxiaochun.tar ./</span><br>tar: ./wangxiaochun.tar: file is the archive; not dumped<br>ll<br>total 40<br>-rw------- 1 root root  1204 Aug  3 21:05 ca.crt<br>-rw-r--r-- 1 root root  231 Aug  3 23:31 client.ovpn<br>-rw------- 1 root root  4506 Aug  3 21:05 wangxiaochun.crt<br>-rw------- 1 root root  1704 Aug  3 21:05 wangxiaochun.key<br>-rw-r--r-- 1 root root 20480 Aug  4 10:48 wangxiaochun.tar<br><br>[root@centos7 wangxiaochun]<span class="hljs-comment"># tar tf wangxiaochun.tar</span><br>./<br>./wangxiaochun.key<br>./wangxiaochun.crt<br>./ca.crt<br>./client.ovpn<br></code></pre></td></tr></table></figure><p>放置到windows客户端的 C:\Program Files\OpenVPN\config 目录下（不能直接传输到C盘，需要传输出来后在放进C盘）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup30.jpg"></p><h4 id="2-8-3-Windows-客户端建立OpenVPN连接"><a href="#2-8-3-Windows-客户端建立OpenVPN连接" class="headerlink" title="2.8.3 Windows 客户端建立OpenVPN连接"></a>2.8.3 Windows 客户端建立OpenVPN连接</h4><p>在windows 程序中打开 OpenVPN GUI 工具</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup31.jpg"></p><p>稍等一会儿,在状态栏显示以下图标,右键点连接</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup32.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup33.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup34.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup35.jpg"></p><h3 id="2-8-4-Windows-客户端验证通信"><a href="#2-8-4-Windows-客户端验证通信" class="headerlink" title="2.8.4 Windows 客户端验证通信"></a>2.8.4 Windows 客户端验证通信</h3><h4 id="2-8-4-1-在Windows-客户端测试访问OpenVPN后端服务器"><a href="#2-8-4-1-在Windows-客户端测试访问OpenVPN后端服务器" class="headerlink" title="2.8.4.1 在Windows 客户端测试访问OpenVPN后端服务器"></a>2.8.4.1 在Windows 客户端测试访问OpenVPN后端服务器</h4><p><strong>后端服务器显示是来自于OpenVPN服务器的连接</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup36.jpg"></p><h5 id="2-8-4-2-观察OpenVPN服务器日志"><a href="#2-8-4-2-观察OpenVPN服务器日志" class="headerlink" title="2.8.4.2 观察OpenVPN服务器日志"></a>2.8.4.2 观察OpenVPN服务器日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># tail /var/log/openvpn/openvpn.log -f -n0</span><br>Tue Aug  4 11:57:44 2020 TCP connection established with [AF_INET]10.0.0.1:6913<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 TLS: Initial packet from<br>[AF_INET]10.0.0.1:6913, sid=6b727fec 8459dc55<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 VERIFY OK: depth=1, CN=Easy-RSA CA<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 VERIFY OK: depth=0, CN=wangxiaochun<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_VER=2.4.9<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_PLAT=win<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_PROTO=2<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_NCP=2<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_LZ4=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_LZ4v2=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_LZO=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_COMP_STUB=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_COMP_STUBv2=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_TCPNL=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_GUI_VER=OpenVPN_GUI_11<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 WARNING: <span class="hljs-string">&#x27;link-mtu&#x27;</span> is used<br>inconsistently, <span class="hljs-built_in">local</span>=<span class="hljs-string">&#x27;link-mtu 1560&#x27;</span>, remote=<span class="hljs-string">&#x27;link-mtu 1559&#x27;</span><br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 WARNING: <span class="hljs-string">&#x27;comp-lzo&#x27;</span> is present <span class="hljs-keyword">in</span> <span class="hljs-built_in">local</span><br>config but missing <span class="hljs-keyword">in</span> remote config, <span class="hljs-built_in">local</span>=<span class="hljs-string">&#x27;comp-lzo&#x27;</span><br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 Control Channel: TLSv1.3, cipher TLSv1.3<br>TLS_AES_256_GCM_SHA384, 2048 bit RSA<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 [wangxiaochun] Peer Connection Initiated<br>with [AF_INET]10.0.0.1:6913<br>Tue Aug  4 11:57:45 2020 wangxiaochun/10.0.0.1:6913 MULTI_sva: pool returned<br>IPv4=10.8.0.6, IPv6=(Not enabled)<br>Tue Aug  4 11:57:45 2020 wangxiaochun/10.0.0.1:6913 MULTI: Learn: 10.8.0.6 -&gt;<br>wangxiaochun/10.0.0.1:6913<br>Tue Aug  4 11:57:45 2020 wangxiaochun/10.0.0.1:6913 MULTI: primary virtual IP<br><span class="hljs-keyword">for</span> wangxiaochun/10.0.0.1:6913: 10.8.0.6<br>Tue Aug  4 11:57:46 2020 wangxiaochun/10.0.0.1:6913 PUSH: Received control<br>message: <span class="hljs-string">&#x27;PUSH_REQUEST&#x27;</span><br>Tue Aug  4 11:57:46 2020 wangxiaochun/10.0.0.1:6913 SENT CONTROL [wangxiaochun]:<br><span class="hljs-string">&#x27;PUSH_REPLY,route 172.30.0.0 255.255.0.0,compress lz4-v2,route 10.8.0.1,topology</span><br><span class="hljs-string">net30,ping 10,ping-restart 120,ifconfig 10.8.0.6 10.8.0.5,peer-id 0,cipher AES-</span><br><span class="hljs-string">256-GCM&#x27;</span> (status=1)<br>Tue Aug  4 11:57:46 2020 wangxiaochun/10.0.0.1:6913 Data Channel: using<br>negotiated cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span><br>Tue Aug  4 11:57:46 2020 wangxiaochun/10.0.0.1:6913 Outgoing Data Channel:<br>Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br>Tue Aug  4 11:57:46 2020 wangxiaochun/10.0.0.1:6913 Incoming Data Channel:<br>Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br><br>cat /var/<span class="hljs-built_in">log</span>/openvpn/openvpn-status.log<br>OpenVPN CLIENT LIST<br>Updated,Tue Aug  4 13:26:45 2020<br>Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since<br>wangxiaochun,10.0.0.1:6913,87125,41765,Tue Aug  4 11:57:44 2020<br>ROUTING TABLE<br>Virtual Address,Common Name,Real Address,Last Ref<br>10.8.0.6,wangxiaochun,10.0.0.1:6913,Tue Aug  4 12:52:44 2020<br>GLOBAL STATS<br>Max bcast/mcast queue length,1<br>END<br></code></pre></td></tr></table></figure><h5 id="2-8-4-3-验证OpenVPN服务器连接状态"><a href="#2-8-4-3-验证OpenVPN服务器连接状态" class="headerlink" title="2.8.4.3 验证OpenVPN服务器连接状态"></a>2.8.4.3 验证OpenVPN服务器连接状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">ss -nt<br>State     Recv-Q     Send-Q  Local Address:Port  Peer Address:Port <br>   <br>ESTAB      0        52       10.0.0.8:22     10.0.0.1:14009<br>   <br>ESTAB      0        0       10.0.0.8:1194    10.0.0.1:6913<br></code></pre></td></tr></table></figure><h5 id="2-8-4-4-验证-Windows-客户端的-IP地址"><a href="#2-8-4-4-验证-Windows-客户端的-IP地址" class="headerlink" title="2.8.4.4 验证 Windows 客户端的 IP地址"></a>2.8.4.4 验证 Windows 客户端的 IP地址</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup37.jpg"></p><h5 id="2-8-4-5-验证Windows-客户端的路由表"><a href="#2-8-4-5-验证Windows-客户端的路由表" class="headerlink" title="2.8.4.5 验证Windows 客户端的路由表"></a>2.8.4.5 验证Windows 客户端的路由表</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup38.jpg"></p><h3 id="2-9-Mac-OS-配置部署OpenVPN-客户端"><a href="#2-9-Mac-OS-配置部署OpenVPN-客户端" class="headerlink" title="2.9 Mac OS 配置部署OpenVPN 客户端"></a>2.9 Mac OS 配置部署OpenVPN 客户端</h3><p>官方没有提供基于Mac OS的OpenVPN的客户端<br>第三方OpenVPN 客户端参考链接: <a href="https://tunnelblick.net/downloads.html">https://tunnelblick.net/downloads.html</a><br>需要科学访问</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup39.jpg"></p><h2 id="三、-故障排错"><a href="#三、-故障排错" class="headerlink" title="三、 故障排错"></a>三、 故障排错</h2><h3 id="3-1-在tcp模式下开启explicit-exit-notify-导致无法启动"><a href="#3-1-在tcp模式下开启explicit-exit-notify-导致无法启动" class="headerlink" title="3.1 在tcp模式下开启explicit-exit-notify 导致无法启动"></a>3.1 在tcp模式下开启explicit-exit-notify 导致无法启动</h3><p>explicit-exit-notify 可以支持在UDP协议时,OpenVPN重启后,客户端自动重新连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/openvpn/server.conf<br><span class="hljs-comment">#在tcp模式下开启通知</span><br>proto tcp<br>explicit-exit-notify 1<br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart openvpn@server.service</span><br>Job <span class="hljs-keyword">for</span> openvpn@server.service failed because the control process exited with<br>error code.<br>See <span class="hljs-string">&quot;systemctl status openvpn@server.service&quot;</span> and <span class="hljs-string">&quot;journalctl -xe&quot;</span> <span class="hljs-keyword">for</span> details<br><br>tail /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log -f -n0<br>Tue Aug  4 13:29:52 2020 /sbin/ip route del 10.8.0.0/24<br>RTNETLINK answers: Operation not permitted<br>Tue Aug  4 13:29:52 2020 ERROR: Linux route delete <span class="hljs-built_in">command</span> failed: external<br>program exited with error status: 2<br>Tue Aug  4 13:29:52 2020 Closing TUN/TAP interface<br>Tue Aug  4 13:29:52 2020 /sbin/ip addr del dev tun0 <span class="hljs-built_in">local</span> 10.8.0.1 peer 10.8.0.2<br>RTNETLINK answers: Operation not permitted<br>Tue Aug  4 13:29:52 2020 Linux ip addr del failed: external program exited with<br>error status: 2<br>Tue Aug  4 13:29:52 2020 SIGTERM[hard,] received, process exiting<br>Options error: --explicit-exit-notify can only be used with --proto udp<br>Use --<span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> more information.<br></code></pre></td></tr></table></figure><p><strong>修改配置,选择UDP协议</strong><br><strong>注意: 需要在防火墙或安全组中开启1194/UDP端口</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/openvpn/server.conf<br>proto udp<br>explicit-exit-notify 1<br>systemctl restart openvpn@server.service<br></code></pre></td></tr></table></figure><p><strong>客户端也需要修改为UDP协议,否则会显示下面</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup40.jpg"></p><p><strong>修改客户端配置文件</strong></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup41.jpg"></p><p>重新连接成功</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup42.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup43.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">ss -ntua<br>Netid    State     Recv-Q    Send-Q  Local Address:Port  Peer<br>Address:Port    <br>udp     UNCONN    0       0        0.0.0.0:1194   <br>0.0.0.0:*     <br>udp     UNCONN    0       0       127.0.0.1:323    <br>0.0.0.0:*     <br>udp     UNCONN    0       0         [::1]:323     <br>[::]:*     <br>tcp     LISTEN    0       128       0.0.0.0:22    <br>0.0.0.0:*     <br>tcp     LISTEN    0       100      127.0.0.1:25    <br>0.0.0.0:*     <br>tcp     ESTAB     0       52       10.0.0.8:22    <br>10.0.0.1:14009   <br>tcp     LISTEN    0       128        [::]:22      <br>[::]:*     <br>tcp     LISTEN    0       100        [::1]:25      <br>[::]:* <br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup44.jpg"></p><h3 id="3-2-压缩算法错误导致连接失败"><a href="#3-2-压缩算法错误导致连接失败" class="headerlink" title="3.2 压缩算法错误导致连接失败"></a>3.2 压缩算法错误导致连接失败</h3><p><strong>OpenVPN 2.4.x 客户端支持更新的压缩算法lz4-v2, 而comp-lzo是为老版本兼容使用,两者不要在一起混用,否则可能会导致连接失败</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#开启兼容的压缩功能</span><br>vim /etc/openvpn/server.conf<br>compress lz4-v2<br>push <span class="hljs-string">&quot;compress lz4-v2&quot;</span> <br>comp-lzo<br>systemctl restart openvpn@server.service<br><br><span class="hljs-comment">#windows客户端连接后,服务器可以看到下面日志提示</span><br>tail /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log -f -n0<br>......<br>Tue Aug  4 13:35:40 2020 /sbin/ip route del 10.8.0.0/24<br>RTNETLINK answers: Operation not permitted<br>Tue Aug  4 13:35:40 2020 ERROR: Linux route delete <span class="hljs-built_in">command</span> failed: external<br>program exited with error status: 2<br>Tue Aug  4 13:35:40 2020 Closing TUN/TAP interface<br>Tue Aug  4 13:35:40 2020 /sbin/ip addr del dev tun0 <span class="hljs-built_in">local</span> 10.8.0.1 peer 10.8.0.2<br>RTNETLINK answers: Operation not permitted<br>Tue Aug  4 13:35:40 2020 Linux ip addr del failed: external program exited with<br>error status: 2<br>Tue Aug  4 13:35:40 2020 SIGTERM[hard,] received, process exiting<br>Tue Aug  4 13:35:40 2020 OpenVPN 2.4.9 x86_64-redhat-linux-gnu [SSL (OpenSSL)]<br>[LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Apr 24 2020<br>Tue Aug  4 13:35:40 2020 library versions: OpenSSL 1.1.1c FIPS  28 May 2019, LZO<br>2.08<br>Tue Aug  4 13:35:40 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-tun -- this may cause restarts to fail<br>Tue Aug  4 13:35:40 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-key -- this may cause restarts to fail<br>Tue Aug  4 13:35:40 2020 Diffie-Hellman initialized with 2048 bit key<br>Tue Aug  4 13:35:40 2020 ROUTE_GATEWAY 10.0.0.2/255.255.255.0 IFACE=eth0<br>HWADDR=00:0c:29:8a:51:21<br>Tue Aug  4 13:35:40 2020 TUN/TAP device tun0 opened<br>Tue Aug  4 13:35:40 2020 TUN/TAP TX queue length <span class="hljs-built_in">set</span> to 100<br>Tue Aug  4 13:35:40 2020 /sbin/ip link <span class="hljs-built_in">set</span> dev tun0 up mtu 1500<br>Tue Aug  4 13:35:40 2020 /sbin/ip addr add dev tun0 <span class="hljs-built_in">local</span> 10.8.0.1 peer 10.8.0.2<br>Tue Aug  4 13:35:40 2020 /sbin/ip route add 10.8.0.0/24 via 10.8.0.2<br>Tue Aug  4 13:35:40 2020 Could not determine IPv4/IPv6 protocol. Using AF_INET<br>Tue Aug  4 13:35:40 2020 Socket Buffers: R=[87380-&gt;87380] S=[16384-&gt;16384]<br>Tue Aug  4 13:35:40 2020 Listening <span class="hljs-keyword">for</span> incoming TCP connection on [AF_INET]<br>[undef]:1194<br>Tue Aug  4 13:35:40 2020 TCPv4_SERVER link <span class="hljs-built_in">local</span> (bound): [AF_INET][undef]:1194<br>Tue Aug  4 13:35:40 2020 TCPv4_SERVER link remote: [AF_UNSPEC]<br>Tue Aug  4 13:35:40 2020 GID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 13:35:40 2020 UID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 13:35:40 2020 MULTI: multi_init called, r=256 v=256<br>Tue Aug  4 13:35:40 2020 IFCONFIG POOL: base=10.8.0.4 size=62, ipv6=0<br>Tue Aug  4 13:35:40 2020 ifconfig_pool_read(), <span class="hljs-keyword">in</span>=<span class="hljs-string">&#x27;wangxiaochun,10.8.0.4&#x27;</span>, TODO:<br>IPv6<br>Tue Aug  4 13:35:40 2020 succeeded -&gt; ifconfig_pool_set()<br>Tue Aug  4 13:35:40 2020 IFCONFIG POOL LIST<br>Tue Aug  4 13:35:40 2020 wangxiaochun,10.8.0.4<br>Tue Aug  4 13:35:40 2020 MULTI: TCP INIT maxclients=2048 maxevents=2052<br>Tue Aug  4 13:35:40 2020 Initialization Sequence Completed<br>Tue Aug  4 13:36:11 2020 TCP connection established with [AF_INET]10.0.0.1:14124<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 TLS: Initial packet from<br>[AF_INET]10.0.0.1:14124, sid=7ebe3c44 bf2f7f6d<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 VERIFY OK: depth=1, CN=Easy-RSA CA<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 VERIFY OK: depth=0, CN=wangxiaochun<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_VER=2.4.9<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_PLAT=win<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_PROTO=2<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_NCP=2<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_LZ4=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_LZ4v2=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_LZO=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_COMP_STUB=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_COMP_STUBv2=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_TCPNL=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_GUI_VER=OpenVPN_GUI_11<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 WARNING: <span class="hljs-string">&#x27;link-mtu&#x27;</span> is used<br>inconsistently, <span class="hljs-built_in">local</span>=<span class="hljs-string">&#x27;link-mtu 1560&#x27;</span>, remote=<span class="hljs-string">&#x27;link-mtu 1559&#x27;</span><br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 WARNING: <span class="hljs-string">&#x27;comp-lzo&#x27;</span> is present <span class="hljs-keyword">in</span> <span class="hljs-built_in">local</span><br>config but missing <span class="hljs-keyword">in</span> remote config, <span class="hljs-built_in">local</span>=<span class="hljs-string">&#x27;comp-lzo&#x27;</span><br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 Control Channel: TLSv1.3, cipher TLSv1.3<br>TLS_AES_256_GCM_SHA384, 2048 bit RSA<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 [wangxiaochun] Peer Connection Initiated<br>with [AF_INET]10.0.0.1:14124<br>Tue Aug  4 13:36:12 2020 wangxiaochun/10.0.0.1:14124 MULTI_sva: pool returned<br>IPv4=10.8.0.6, IPv6=(Not enabled)<br>Tue Aug  4 13:36:12 2020 wangxiaochun/10.0.0.1:14124 MULTI: Learn: 10.8.0.6 -&gt;<br>wangxiaochun/10.0.0.1:14124<br>Tue Aug  4 13:36:12 2020 wangxiaochun/10.0.0.1:14124 MULTI: primary virtual IP<br><span class="hljs-keyword">for</span> wangxiaochun/10.0.0.1:14124: 10.8.0.6<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 PUSH: Received control<br>message: <span class="hljs-string">&#x27;PUSH_REQUEST&#x27;</span><br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 SENT CONTROL<br>[wangxiaochun]: <span class="hljs-string">&#x27;PUSH_REPLY,route 172.30.0.0 255.255.0.0,compress lz4-v2,route</span><br><span class="hljs-string">10.8.0.1,topology net30,ping 10,ping-restart 120,ifconfig 10.8.0.6</span><br><span class="hljs-string">10.8.0.5,peer-id 0,cipher AES-256-GCM&#x27;</span> (status=1)<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Data Channel: using<br>negotiated cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span><br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Outgoing Data Channel:<br>Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Incoming Data Channel:<br>Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 80<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 96<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 96<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 96<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 80<br>Tue Aug  4 13:36:18 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 96<br>Tue Aug  4 13:36:18 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 96<br></code></pre></td></tr></table></figure><p>在客户端可以看到面提示</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup45.jpg"></p><p>客户端无法访问后端服务器</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup46.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#关闭兼容的压缩功能</span><br>vim /etc/openvpn/server.conf<br>;comp-lzo<br>systemctl restart openvpn@server.service<br></code></pre></td></tr></table></figure><p>客户端重新连接,访问后端服务器成功</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup47.jpg"></p><h3 id="3-3-工作模式错误"><a href="#3-3-工作模式错误" class="headerlink" title="3.3 工作模式错误"></a>3.3 工作模式错误</h3><p><strong>OpenVPN两种工作模式:TUN和TAP,都可以支持TCP和UDP协议,但如果服务器和客户工作模式不同,比如服务器为TAP,客户端为TUN,会导致连接失败</strong></p><p>修改服务器端为TAP模式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/openvpn/server.conf<br>dev tap<br>;dev tun<br><br>systemctl restart openvpn@server.service<br>ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:8a:51:2b brd ff:ff:ff:ff:ff:ff<br> inet 172.30.0.1/24 brd 172.30.0.255 scope global noprefixroute eth1<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe8a:512b/64 scope link<br>   valid_lft forever preferred_lft forever<br>15: tap0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state<br>UNKNOWN group default qlen 100<br> link/ether 6a:5c:7d:7a:0d:6e brd ff:ff:ff:ff:ff:ff<br> inet 10.8.0.1/24 brd 10.8.0.255 scope global tap0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::685c:7dff:fe7a:d6e/64 scope link<br>   valid_lft forever preferred_lft forever<br>   <br>tail -n 20 /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log<br>Tue Aug  4 14:12:13 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-tun -- this may cause restarts to fail<br>Tue Aug  4 14:12:13 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-key -- this may cause restarts to fail<br>Tue Aug  4 14:12:13 2020 Diffie-Hellman initialized with 2048 bit key<br>Tue Aug  4 14:12:13 2020 TUN/TAP device tap0 opened<br>Tue Aug  4 14:12:13 2020 TUN/TAP TX queue length <span class="hljs-built_in">set</span> to 100<br>Tue Aug  4 14:12:13 2020 /sbin/ip link <span class="hljs-built_in">set</span> dev tap0 up mtu 1500<br>Tue Aug  4 14:12:13 2020 /sbin/ip addr add dev tap0 10.8.0.1/24 broadcast<br>10.8.0.255<br>Tue Aug  4 14:12:13 2020 Could not determine IPv4/IPv6 protocol. Using AF_INET<br>Tue Aug  4 14:12:13 2020 Socket Buffers: R=[212992-&gt;212992] S=[212992-&gt;212992]<br>Tue Aug  4 14:12:13 2020 UDPv4 link <span class="hljs-built_in">local</span> (bound): [AF_INET][undef]:1194<br>Tue Aug  4 14:12:13 2020 UDPv4 link remote: [AF_UNSPEC]<br>Tue Aug  4 14:12:13 2020 GID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 14:12:13 2020 UID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 14:12:13 2020 MULTI: multi_init called, r=256 v=256<br>Tue Aug  4 14:12:13 2020 IFCONFIG POOL: base=10.8.0.2 size=253, ipv6=0<br>Tue Aug  4 14:12:13 2020 ifconfig_pool_read(), <span class="hljs-keyword">in</span>=<span class="hljs-string">&#x27;wangxiaochun,10.8.0.4&#x27;</span>, TODO:<br>IPv6<br>Tue Aug  4 14:12:13 2020 succeeded -&gt; ifconfig_pool_set()<br>Tue Aug  4 14:12:13 2020 IFCONFIG POOL LIST<br>Tue Aug  4 14:12:13 2020 wangxiaochun,10.8.0.4<br>Tue Aug  4 14:12:13 2020 Initialization Sequence Completed<br><br>route -n<br>Kernel IP routing table<br>Destination   Gateway     Genmask     Flags Metric Ref  Use Iface<br>0.0.0.0     10.0.0.2     0.0.0.0     UG   102   0     0 eth0<br>10.0.0.0     0.0.0.0     255.255.255.0  U   102   0     0 eth0<br>10.8.0.0     0.0.0.0     255.255.255.0  U   0    0     0 tap0<br>172.30.0.0    0.0.0.0     255.255.255.0  U   101   0     0 eth1<br></code></pre></td></tr></table></figure><p>因为客户端为TUN模式,导致连接失败</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup48.jpg"></p><p>修改客户端也为TAP模式</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup49.jpg"></p><p>再次连接成功</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup50.jpg"></p><h2 id="四、-OpenVPN-高级功能"><a href="#四、-OpenVPN-高级功能" class="headerlink" title="四、 OpenVPN 高级功能"></a>四、 OpenVPN 高级功能</h2><p>本节介绍OpenVPN的高级功能,主要关于安全加强及客户端的管理功能,比如:员工入职、离职涉及到的创建账户与吊销账户证书。</p><h3 id="4-1-启用安全增强功能"><a href="#4-1-启用安全增强功能" class="headerlink" title="4.1 启用安全增强功能"></a>4.1 启用安全增强功能</h3><p>启用防止DoS攻击的安全增强配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># openvpn --genkey --secret /etc/openvpn/certs/ta.key</span><br>[root@centos7 ~]<span class="hljs-comment"># cat /etc/openvpn/certs/ta.key</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 2048 bit OpenVPN static key</span><br><span class="hljs-comment">#</span><br>-----BEGIN OpenVPN Static key V1-----<br>44a78a4b16b8fb4fa85f1c8af7bcae82<br>3b014ab75f50a24e13f8de798af070d3<br>7d29863fac94a6a4b28952bfeacb14b0<br>4e79a3ab790ce3d99eec0a6fdfbdb24d<br>c6bfca666e63de6d768aa25d145bd388<br>5dabb2b05ad27245eb37aa27f78e81b1<br>b8bcfd0d4e280bc02a51afb528d20955<br>d72d3578d269be2682ca468249888f3e<br>80c642d49238510ae6c50f8849739f75<br>b31d915ea4178977e246b5ec5e3298a5<br>822a74575c17348ae87e81f27732a325<br>8655a3d9aa0ee6aac3f68f6a45987561<br>cb1aed7be16824d56676ba406ea85f66<br>ad847f45dffff7b3e19bd6d6dd4406f1<br>3e0ad44f4f6ef9850e1556edad4b4280<br>49724f63a30780b91ecb0eddb07dfebc<br>-----END OpenVPN Static key V1-----<br><br>[root@centos7 ~]<span class="hljs-comment"># ll /etc/openvpn/certs</span><br>total 24<br>-rw------- 1 root root 1204 Aug  3 20:34 ca.crt<br>-rw------- 1 root root  424 Aug  3 20:35 dh.pem<br>-rw------- 1 root root 4608 Aug  3 20:34 server.crt<br>-rw------- 1 root root 1704 Aug  3 20:35 server.key<br>-rw------- 1 root root  636 Aug  4 15:53 ta.key<br><br>[root@centos7 ~]<span class="hljs-comment"># vim /etc/openvpn/server.conf</span><br><span class="hljs-comment">#tls-auth ta.key 0 # This file is secret</span><br>tls-auth /etc/openvpn/certs/ta.key 0  <span class="hljs-comment">#客户端为1,服务器端为0</span><br><br>[root@centos7 ~]<span class="hljs-comment"># systemctl restart openvpn@server.service</span><br><br><span class="hljs-comment">#日志提示出错</span><br>[root@centos7 ~]<span class="hljs-comment"># tail -n 20 /var/log/openvpn/openvpn.log -f</span><br>Tue Aug  4 15:56:30 2020 TLS Error: cannot locate HMAC <span class="hljs-keyword">in</span> incoming packet from<br>[AF_INET]10.0.0.1:59743<br>Tue Aug  4 15:56:39 2020 TLS Error: cannot locate HMAC <span class="hljs-keyword">in</span> incoming packet from<br>[AF_INET]10.0.0.1:59743<br>Tue Aug  4 15:56:45 2020 TLS Error: cannot locate HMAC <span class="hljs-keyword">in</span> incoming packet from<br>[AF_INET]10.0.0.1:59073<br></code></pre></td></tr></table></figure><p>客户端无法直接连接</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup51.jpg"></p><p>将ta.key 传到客户端相关目录下</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup52.jpg"></p><p>修改客户端配置文件clent.ovpn,添加一行</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup53.jpg"></p><p>客户端重新连接成功</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup54.jpg"></p><h3 id="4-2-设置私钥密码"><a href="#4-2-设置私钥密码" class="headerlink" title="4.2 设置私钥密码"></a>4.2 设置私钥密码</h3><p>新建一个账户magedu，并且设置证书密码，提高证书及登录VPN的安全性。</p><h4 id="4-2-1-创建新用户-生成对应的有密码的私钥和证书申请"><a href="#4-2-1-创建新用户-生成对应的有密码的私钥和证书申请" class="headerlink" title="4.2.1 创建新用户,生成对应的有密码的私钥和证书申请"></a>4.2.1 创建新用户,生成对应的有密码的私钥和证书申请</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-client/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-client/3<br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-req magedu</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating a RSA private key<br>...............................................................+++++<br>................+++++<br>writing new private key to <span class="hljs-string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-</span><br><span class="hljs-string">35371.iJfHbs/tmp.9lGUMy&#x27;</span><br>Enter PEM pass phrase: <br><span class="hljs-comment">#输入两遍密码，123456</span><br>Verifying - Enter PEM pass phrase:<br><span class="hljs-comment">#输入两遍密码</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [magedu]:  <span class="hljs-comment">#接受默认值,直接回车</span><br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-client/3/pki/reqs/magedu.req<br>key: /etc/openvpn/easy-rsa-client/3/pki/private/magedu.key<br></code></pre></td></tr></table></figure><h4 id="4-2-2-导入证书申请并颁发证书"><a href="#4-2-2-导入证书申请并颁发证书" class="headerlink" title="4.2.2 导入证书申请并颁发证书"></a>4.2.2 导入证书申请并颁发证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-server/3<br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/magedu.req magedu</span><br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>The request has been successfully imported with a short name of: magedu<br>You may now use this name to perform signing operations on this request.<br><br><span class="hljs-comment">#确保证书有效期是合理值</span><br>[root@centos7 3]<span class="hljs-comment"># grep EASYRSA_CERT_EXPIRE vars</span><br>set_var EASYRSA_CERT_EXPIRE 90<br><br><span class="hljs-comment">#颁发证书</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa sign client magedu</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>You are about to sign the following certificate.<br>Please check over the details shown below <span class="hljs-keyword">for</span> accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br><span class="hljs-built_in">source</span> or that you have verified the request checksum with the sender.<br>Request subject, to be signed as a client certificate <span class="hljs-keyword">for</span> 90 days:<br>subject=<br> commonName         = magedu<br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Confirm request details: yes  <span class="hljs-comment">#输入yes</span><br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-<br>36053.IQvyRq/tmp.5GkGy2<br>Check that the request matches the signature<br>Signature ok<br>The Subject<span class="hljs-string">&#x27;s Distinguished Name is as follows</span><br><span class="hljs-string">commonName      :ASN.1 12:&#x27;</span>magedu<span class="hljs-string">&#x27;</span><br><span class="hljs-string">Certificate is to be certified until Nov  2 08:30:43 2020 GMT (90 days)  #有效期</span><br><span class="hljs-string">Write out database with 1 new entries</span><br><span class="hljs-string">Data Base Updated</span><br><span class="hljs-string">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# cat /etc/openvpn/easy-rsa-server/3/pki/index.txt</span><br><span class="hljs-string">V 201031091943Z EDAEBAB8D65066D307AE58ADC1A56682 unknown /CN=server</span><br><span class="hljs-string">V 201031153815Z 5FE114ACC4FE6AB89D17E1B0EECF2B78 unknown</span><br><span class="hljs-string">/CN=wangxiaochun</span><br><span class="hljs-string">V 201102083043Z C971227DA77824C8ACB7D655D09D4081 unknown /CN=magedu</span><br></code></pre></td></tr></table></figure><h4 id="4-2-3-将用户的证书相关文件放在指定的目录中"><a href="#4-2-3-将用户的证书相关文件放在指定的目录中" class="headerlink" title="4.2.3 将用户的证书相关文件放在指定的目录中"></a>4.2.3 将用户的证书相关文件放在指定的目录中</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 3]<span class="hljs-comment"># mkdir /etc/openvpn/client/magedu</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt /etc/openvpn/client/magedu</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-client/3/pki/private/magedu.key /etc/openvpn/client/magedu</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/magedu/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/client/wangxiaochun/client.ovpn /etc/openvpn/client/magedu/</span><br>[root@centos7 3]<span class="hljs-comment"># ll /etc/openvpn/client/magedu/</span><br>total 28<br>-rw------- 1 root root 1204 Aug  4 16:41 ca.crt<br>-rw-r--r-- 1 root root  231 Aug  4 16:44 client.ovpn<br>-rw------- 1 root root  424 Aug  4 16:41 dh.pem<br>-rw------- 1 root root 4492 Aug  4 16:38 magedu.crt<br>-rw------- 1 root root 1854 Aug  4 16:38 magedu.key<br>-rw------- 1 root root  636 Aug  4 16:41 ta.key<br><br>[root@centos7 3]<span class="hljs-comment"># cd /etc/openvpn/client/magedu/</span><br><br><span class="hljs-comment">#根据服务器端修改下面配置,需要和服务器同步</span><br>[root@centos7 magedu]<span class="hljs-comment"># vim client.ovpn</span><br>client<br>dev tun<br>proto tcp<br>remote 10.0.0.8 1194<br>resolv-retry infinite<br>nobind<br><span class="hljs-comment">#persist-key</span><br><span class="hljs-comment">#persist-tun</span><br>ca ca.crt<br>cert magedu.crt<br>key magedu.key<br>remote-cert-tls server<br>tls-auth ta.key 1<br>cipher AES-256-CBC<br>verb 3<br>compress lz4-v2<br><br>[root@centos7 magedu]<span class="hljs-comment"># tar cf magedu.tar *</span><br>[root@centos7 magedu]<span class="hljs-comment"># tar tvf magedu.tar</span><br>-rw------- root/root    1204 2020-08-04 16:41 ca.crt<br>-rw-r--r-- root/root    225 2020-08-04 16:47 client.ovpn<br>-rw------- root/root    424 2020-08-04 16:41 dh.pem<br>-rw------- root/root    4492 2020-08-04 16:38 magedu.crt<br>-rw------- root/root    1854 2020-08-04 16:38 magedu.key<br>-rw------- root/root    636 2020-08-04 16:41 ta.key<br></code></pre></td></tr></table></figure><h4 id="4-2-4-将相关文件传给客户端主机相应目录"><a href="#4-2-4-将相关文件传给客户端主机相应目录" class="headerlink" title="4.2.4 将相关文件传给客户端主机相应目录"></a>4.2.4 将相关文件传给客户端主机相应目录</h4><p>放置到windows客户端的 C:\Program Files\OpenVPN\config 目录下</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup55.jpg"></p><h4 id="4-2-5-Windows-客户端重新连接"><a href="#4-2-5-Windows-客户端重新连接" class="headerlink" title="4.2.5 Windows 客户端重新连接"></a>4.2.5 Windows 客户端重新连接</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup56.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup57.jpg"></p><p>查看日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 magedu]<span class="hljs-comment"># tail -n0 /var/log/openvpn/openvpn.log -f</span><br><br>Tue Aug  4 17:31:39 2020 TCP connection established with [AF_INET]10.0.0.1:6915<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 TLS: Initial packet from<br>[AF_INET]10.0.0.1:6915, sid=32d69aea a611c78d<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 VERIFY OK: depth=1, CN=Easy-RSA CA<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 VERIFY OK: depth=0, CN=magedu<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_VER=2.4.9<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_PLAT=win<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_PROTO=2<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_NCP=2<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_LZ4=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_LZ4v2=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_LZO=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_COMP_STUB=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_COMP_STUBv2=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_TCPNL=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_GUI_VER=OpenVPN_GUI_11<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 Control Channel: TLSv1.3, cipher TLSv1.3<br>TLS_AES_256_GCM_SHA384, 2048 bit RSA<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 [magedu] Peer Connection Initiated with<br>[AF_INET]10.0.0.1:6915<br>Tue Aug  4 17:31:40 2020 magedu/10.0.0.1:6915 MULTI_sva: pool returned<br>IPv4=10.8.0.10, IPv6=(Not enabled)<br>Tue Aug  4 17:31:40 2020 magedu/10.0.0.1:6915 MULTI: Learn: 10.8.0.10 -&gt;<br>magedu/10.0.0.1:6915<br>Tue Aug  4 17:31:40 2020 magedu/10.0.0.1:6915 MULTI: primary virtual IP <span class="hljs-keyword">for</span><br>magedu/10.0.0.1:6915: 10.8.0.10<br>Tue Aug  4 17:31:41 2020 magedu/10.0.0.1:6915 PUSH: Received control message:<br><span class="hljs-string">&#x27;PUSH_REQUEST&#x27;</span><br>Tue Aug  4 17:31:41 2020 magedu/10.0.0.1:6915 SENT CONTROL [magedu]:<br><span class="hljs-string">&#x27;PUSH_REPLY,route 172.30.0.0 255.255.0.0,compress lz4-v2,route 10.8.0.1,topology</span><br><span class="hljs-string">net30,ping 10,ping-restart 120,ifconfig 10.8.0.10 10.8.0.9,peer-id 0,cipher AES-</span><br><span class="hljs-string">256-GCM&#x27;</span> (status=1)<br>Tue Aug  4 17:31:41 2020 magedu/10.0.0.1:6915 Data Channel: using negotiated<br>cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span><br>Tue Aug  4 17:31:41 2020 magedu/10.0.0.1:6915 Outgoing Data Channel: Cipher<br><span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br>Tue Aug  4 17:31:41 2020 magedu/10.0.0.1:6915 Incoming Data Channel: Cipher<br><span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup58.jpg"></p><h3 id="4-3-账户证书管理"><a href="#4-3-账户证书管理" class="headerlink" title="4.3 账户证书管理"></a>4.3 账户证书管理</h3><p>主要是证书的创建和吊销，对应的员工的入职和离职</p><h4 id="4-3-1-证书自动过期"><a href="#4-3-1-证书自动过期" class="headerlink" title="4.3.1 证书自动过期"></a>4.3.1 证书自动过期</h4><p>过期时间以服务器时间为准，如果过期,需要重新颁发证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#过期时间由以下设置决定</span><br>[root@centos7 ~]<span class="hljs-comment"># grep EASYRSA_CERT_EXPIRE /etc/openvpn/easy-rsa-server/3/vars </span><br>set_var EASYRSA_CERT_EXPIRE 90<br></code></pre></td></tr></table></figure><p>如果证书过期,在服务器端可以看到以下日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#让服务器时间改为2年后时间（改了记得改回来）</span><br>[root@centos7 ~]<span class="hljs-comment"># date -s &#x27;2 year&#x27;</span><br>Thu Aug  4 17:41:04 CST 2022<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup59.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#服务器端日志中会显示用户证书过期</span><br>[root@centos7 ~]<span class="hljs-comment"># tail -n0 /var/log/openvpn/openvpn.log -f</span><br>Thu Aug  4 17:42:22 2022 TCP connection established with [AF_INET]10.0.0.1:11324<br>Thu Aug  4 17:42:23 2022 10.0.0.1:11324 TLS: Initial packet from<br>[AF_INET]10.0.0.1:11324, sid=a2957674 874cf1f7<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 VERIFY OK: depth=1, CN=Easy-RSA CA<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 VERIFY ERROR: depth=0, error=certificate<br>has expired: CN=magedu<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 OpenSSL: error:1417C086:SSL<br>routines:tls_process_client_certificate:certificate verify failed<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 TLS_ERROR: BIO <span class="hljs-built_in">read</span> tls_read_plaintext<br>error<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 TLS Error: TLS object -&gt; incoming<br>plaintext <span class="hljs-built_in">read</span> error<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 TLS Error: TLS handshake failed<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 Fatal TLS error (check_tls_errors_co),<br>restarting<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 SIGUSR1[soft,tls-error] received,<br>client-instance restarting<br></code></pre></td></tr></table></figure><h4 id="4-3-2-证书手动注销"><a href="#4-3-2-证书手动注销" class="headerlink" title="4.3.2 证书手动注销"></a>4.3.2 证书手动注销</h4><h5 id="4-3-2-1-查看当前证书的有效性-有效为V-无效为R"><a href="#4-3-2-1-查看当前证书的有效性-有效为V-无效为R" class="headerlink" title="4.3.2.1 查看当前证书的有效性,有效为V,无效为R"></a>4.3.2.1 查看当前证书的有效性,有效为V,无效为R</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cat /etc/openvpn/easy-rsa-server/3/pki/index.txt</span><br>V 201031091943Z EDAEBAB8D65066D307AE58ADC1A56682 unknown /CN=server<br>V 201031153815Z 5FE114ACC4FE6AB89D17E1B0EECF2B78 unknown<br>/CN=wangxiaochun<br>V 201102083043Z C971227DA77824C8ACB7D655D09D4081 unknown /CN=magedu<br></code></pre></td></tr></table></figure><h5 id="4-3-2-2-吊销指定的用户的证书"><a href="#4-3-2-2-吊销指定的用户的证书" class="headerlink" title="4.3.2.2 吊销指定的用户的证书"></a>4.3.2.2 吊销指定的用户的证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa revoke magedu</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Please confirm you wish to revoke the certificate with the following subject:<br>subject=<br> commonName         = magedu<br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Continue with revocation: yes<br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-<br>3787.Q2lnW6/tmp.18ZdMO<br>Revoking Certificate C971227DA77824C8ACB7D655D09D4081.<br>Data Base Updated<br>IMPORTANT!!!<br>Revocation was successful. You must run gen-crl and upload a CRL to your<br>infrastructure <span class="hljs-keyword">in</span> order to prevent the revoked cert from being accepted.<br><br><span class="hljs-comment">#查看当前证书的有效性,有效为V,无效为R</span><br>[root@centos7 3]<span class="hljs-comment"># cat /etc/openvpn/easy-rsa-server/3/pki/index.txt</span><br>V 201031091943Z EDAEBAB8D65066D307AE58ADC1A56682 unknown /CN=server<br>V 201031153815Z 5FE114ACC4FE6AB89D17E1B0EECF2B78 unknown<br>/CN=wangxiaochun<br>R 201102083043Z 200805123127Z C971227DA77824C8ACB7D655D09D4081 unknown<br>/CN=magedu<br><br><span class="hljs-comment">#当前断开客户端连接,magedu用户仍然能连接成功</span><br></code></pre></td></tr></table></figure><h5 id="4-3-2-3-生成证书吊销列表"><a href="#4-3-2-3-生成证书吊销列表" class="headerlink" title="4.3.2.3 生成证书吊销列表"></a>4.3.2.3 生成证书吊销列表</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#每次吊销证书后都需要更新证书吊销列表文件,并且需要重启OpenVPN服务</span><br>[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-crl</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-<br>4323.gUt4WS/tmp.ybAcAU<br>An updated CRL has been created.<br>CRL file: /etc/openvpn/easy-rsa-server/3/pki/crl.pem<br><br>[root@centos7 3]<span class="hljs-comment"># cat pki/crl.pem</span><br>-----BEGIN X509 CRL-----<br>MIIB3DCBxQIBATANBgkqhkiG9w0BAQsFADAWMRQwEgYDVQQDDAtFYXN5LVJTQSBD<br>QRcNMjAwODA1MTIzNTUwWhcNMjEwMjAxMTIzNTUwWjAkMCICEQDJcSJ9p3gkyKy3<br>1lXQnUCBFw0yMDA4MDUxMjMxMjdaoFUwUzBRBgNVHSMESjBIgBTsgQDyOXOLGO7X<br>V2+OgLrlSVrqsqEapBgwFjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0GCFHzgaFQ++1WN<br>1iOovl+rVG2sq0Z6MA0GCSqGSIb3DQEBCwUAA4IBAQCMpTte/0ffpnC/ClU8GnBl<br>vnRLOmPZjvYHSoldZxZ+8PA1tKisu0r5k+V41oRxIpZeyvzwOI2SEqqqjN1BLcGj<br>4LX5exu49QlDYtAhJQ029nTQjtj5AqpcaEvID5eRTQqaX94Ykw3MVxdOqNRVjt46<br>AUTbAFrWmgAtcMbByZYtmd2h9kNwfSaJFEnJHgAqIdGJq+LnNJuHxuBWPXArtjyN<br>o5aUdhfSzEOnbRLgdwaRnsrW4K5EOFpETB7t0CQ9b+9X8fV5hqZmm6MlgI2dhLha<br>dsRkCZmdlMKvP8LjlFfy8E0rSss1jFmyvm/HRhqoIdOuQXWayryyfn6hfNyp5GMT<br>-----END X509 CRL-----<br><span class="hljs-comment">#传到windows上,修改文件后缀为crl,双击就可以打开此文件,看到下面显示信息</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup60.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup61.jpg"></p><h5 id="4-3-2-4-将吊销列表文件发布"><a href="#4-3-2-4-将吊销列表文件发布" class="headerlink" title="4.3.2.4 将吊销列表文件发布"></a>4.3.2.4 将吊销列表文件发布</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#第一次吊销证时需要编辑配置文件调用吊销证书的文件,后续吊销无需此步</span><br>[root@centos7 3]<span class="hljs-comment"># vim /etc/openvpn/server.conf</span><br>crl-verify /etc/openvpn/easy-rsa-server/3/pki/crl.pem<br><br><span class="hljs-comment">#每次吊销证书后,都需要重新启动才能生效</span><br>[root@centos7 3]<span class="hljs-comment"># systemctl restart openvpn@server.service</span><br></code></pre></td></tr></table></figure><h5 id="4-3-2-5-再次测试连接失败"><a href="#4-3-2-5-再次测试连接失败" class="headerlink" title="4.3.2.5 再次测试连接失败"></a>4.3.2.5 再次测试连接失败</h5><p>用户端再次连接失败</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup62.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#观察OpenVPN目志</span><br>tail -f /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log -n0<br>Wed Aug  5 21:13:25 2020 TCP connection established with [AF_INET]10.0.0.1:7419<br>Wed Aug  5 21:13:26 2020 10.0.0.1:7419 TLS: Initial packet from<br>[AF_INET]10.0.0.1:7419, sid=169fe75b 63908b79<br>Wed Aug  5 21:13:26 2020 10.0.0.1:7419 WARNING: Failed to <span class="hljs-built_in">stat</span> CRL file, not<br>(re)loading CRL.<br>Wed Aug  5 21:13:26 2020 10.0.0.1:7419 VERIFY ERROR: depth=0, error=certificate<br>revoked: CN=magedu<br>Wed Aug  5 21:13:26 2020 10.0.0.1:7419 OpenSSL: error:1417C086:SSL<br>routines:tls_process_client_certificate:certificate verify failed<br></code></pre></td></tr></table></figure><h4 id="4-3-3-账户重名证书签发"><a href="#4-3-3-账户重名证书签发" class="headerlink" title="4.3.3 账户重名证书签发"></a>4.3.3 账户重名证书签发</h4><p>假如公司已有员工叫magedu已经离职,且证书已被吊销，现在又新来一个员工仍叫magedu，那么一般的区分办法是在用户名后面加数字，如:magedu1、magedu2等，假如还想使用magedu这个账户名签发证书的话，那么需要删除服务器之前magedu的账户，并删除签发记录和证书，否则新用户的证书无法导入，并重新颁发证书</p><h5 id="4-3-3-1-手动重新颁发证书"><a href="#4-3-3-1-手动重新颁发证书" class="headerlink" title="4.3.3.1 手动重新颁发证书"></a>4.3.3.1 手动重新颁发证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#删除已离职备撤销的账户证书</span><br>[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-client/3/</span><br>[root@centos7 3]<span class="hljs-comment"># rm -f pki/private/magedu.key</span><br>[root@centos7 3]<span class="hljs-comment"># rm -f pki/reqs/magedu.req</span><br>[root@centos7 3]<span class="hljs-comment"># rm -rf /etc/openvpn/client/magedu/*</span><br>[root@centos7 3]<span class="hljs-comment"># rm -f /etc/openvpn/easy-rsa-server/3/pki/reqs/magedu.req</span><br>[root@centos7 3]<span class="hljs-comment"># rm -f /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt</span><br><br><span class="hljs-comment">#删除之前的带R的吊销记录,此为可选项</span><br>[root@centos7 3]<span class="hljs-comment"># vim /etc/openvpn/easy-rsa-server/3/pki/index.txt</span><br><br><span class="hljs-comment">#重新生成新的账户证书申请和私钥</span><br>[root@centos7 3]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-client/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-req magedu</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating a RSA private key<br>..................................+++++<br>.........+++++<br>writing new private key to <span class="hljs-string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-</span><br><span class="hljs-string">26582.hrORzD/tmp.bTOf5p&#x27;</span><br>Enter PEM pass phrase:<br>Verifying - Enter PEM pass phrase:<br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [magedu]:<span class="hljs-comment">#直接回车</span><br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-client/3/pki/reqs/magedu.req<br>key: /etc/openvpn/easy-rsa-client/3/pki/private/magedu.key<br><br><span class="hljs-comment">#CA导入证书并签发</span><br>[root@centos7 3]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/magedu.req magedu</span><br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa sign client magedu</span><br>......<br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Confirm request details: yes  <span class="hljs-comment">#输入yes</span><br>......<br>Write out database with 1 new entries<br>Data Base Updated<br>Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt<br><br><span class="hljs-comment">#生成相关文件</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt /etc/openvpn/client/magedu/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-client/3/pki/private/magedu.key /etc/openvpn/client/magedu/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/magedu/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/client/wangxiaochun/client.ovpn /etc/openvpn/client/magedu/</span><br><br><span class="hljs-comment">#修改客户端配置文件</span><br>[root@centos7 3]<span class="hljs-comment"># vim /etc/openvpn/client/magedu/client.ovpn</span><br>client<br>dev tun<br>proto tcp<br>remote 10.0.0.8 1194<br>resolv-retry infinite<br>nobind<br><span class="hljs-comment">#persist-key</span><br><span class="hljs-comment">#persist-tun</span><br>ca ca.crt<br>cert magedu.crt<br>key magedu.key<br>remote-cert-tls server<br>tls-auth ta.key 1<br>cipher AES-256-CBC<br>verb 3<br>compress lz4-v2<br><br>[root@centos7 3]<span class="hljs-comment"># tree /etc/openvpn/client/magedu</span><br>/etc/openvpn/client/magedu<br>├── ca.crt<br>├── client.ovpn<br>├── dh.pem<br>├── magedu.crt<br>├── magedu.key<br>└── ta.key<br>0 directories, 6 files<br><br><span class="hljs-comment">#将/etc/openvpn/client/magedu所有文件打包传到客户端用</span><br></code></pre></td></tr></table></figure><h4 id="4-3-3-2-自动化的证书颁发脚本"><a href="#4-3-3-2-自动化的证书颁发脚本" class="headerlink" title="4.3.3.2 自动化的证书颁发脚本"></a>4.3.3.2 自动化的证书颁发脚本</h4><p>通过脚本实现自动化的证书颁发</p><h5 id="4-3-3-2-1-脚本内容"><a href="#4-3-3-2-1-脚本内容" class="headerlink" title="4.3.3.2.1 脚本内容"></a>4.3.3.2.1 脚本内容</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat openvpn-user-crt.sh<br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#Author: wangxiaochun</span><br><span class="hljs-comment">#QQ: 29308620</span><br><span class="hljs-comment">#Date: 2020-08-02</span><br><span class="hljs-comment">#FileName： openvpn-user-crt.sh</span><br><span class="hljs-comment">#URL: http://www.wangxiaochun.com</span><br><span class="hljs-comment">#Description： The test script</span><br><span class="hljs-comment">#Copyright (C): 2020 All rights reserved</span><br><span class="hljs-comment">#********************************************************************</span><br>. /etc/init.d/<span class="hljs-built_in">functions</span><br>OPENVPN_SERVER=&lt;OpenVPN Server 公网IP&gt;<br>PASS=123456<br><span class="hljs-function"><span class="hljs-title">remove_cert</span></span> () &#123;<br>  rm -rf /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  find /etc/openvpn/ -name <span class="hljs-string">&quot;<span class="hljs-variable">$NAME</span>.*&quot;</span> -delete<br>  &#125;<br><span class="hljs-function"><span class="hljs-title">create_cert</span></span> () &#123;<br>  <span class="hljs-built_in">cd</span> /etc/openvpn/easy-rsa-client/3<br> ./easyrsa gen-req <span class="hljs-variable">$&#123;NAME&#125;</span> nopass &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">EOF</span><br>  <span class="hljs-built_in">cd</span> /etc/openvpn/easy-rsa-server/3<br> ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="hljs-variable">$&#123;NAME&#125;</span>.req<br><span class="hljs-variable">$&#123;NAME&#125;</span><br> ./easyrsa sign client <span class="hljs-variable">$&#123;NAME&#125;</span> &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">yes</span><br><span class="hljs-string">EOF</span><br>  mkdir /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  cp /etc/openvpn/easy-rsa-server/3/pki/issued/<span class="hljs-variable">$&#123;NAME&#125;</span>.crt<br>/etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  cp /etc/openvpn/easy-rsa-client/3/pki/private/<span class="hljs-variable">$&#123;NAME&#125;</span>.key<br>/etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  cp /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  cat &gt; /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span>/client.ovpn &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">client</span><br><span class="hljs-string">dev tun</span><br><span class="hljs-string">proto tcp</span><br><span class="hljs-string">remote 10.0.0.8 1194</span><br><span class="hljs-string">resolv-retry infinite</span><br><span class="hljs-string">nobind</span><br><span class="hljs-string">#persist-key</span><br><span class="hljs-string">#persist-tun</span><br><span class="hljs-string">ca ca.crt</span><br><span class="hljs-string">cert $NAME.crt</span><br><span class="hljs-string">key $NAME.key</span><br><span class="hljs-string">remote-cert-tls server</span><br><span class="hljs-string">tls-auth ta.key 1</span><br><span class="hljs-string">cipher AES-256-CBC</span><br><span class="hljs-string">verb 3</span><br><span class="hljs-string">compress lz4-v2</span><br><span class="hljs-string">EOF</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;证书存放路径:/etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span>,证书文件如下:&quot;</span><br>  <span class="hljs-built_in">echo</span> -e<br><span class="hljs-string">&quot;\E[1;32m******************************************************************\E[0m</span><br><span class="hljs-string">&quot;</span><br>  ls -l /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  <span class="hljs-built_in">echo</span> -e<br><span class="hljs-string">&quot;\E[1;32m******************************************************************\E[0m</span><br><span class="hljs-string">&quot;</span><br>  <span class="hljs-built_in">cd</span> /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br> zip -qP <span class="hljs-string">&quot;<span class="hljs-variable">$PASS</span>&quot;</span> /root/<span class="hljs-variable">$&#123;NAME&#125;</span>.zip *<br> action  <span class="hljs-string">&quot;证书的打包文件已生成: /root/<span class="hljs-variable">$&#123;NAME&#125;</span>.zip&quot;</span><br>&#125;<br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入用户的姓名拼音(如:wangxiaochun): &quot;</span> NAME<br>remove_cert<br>create_cert<br><br></code></pre></td></tr></table></figure><h5 id="4-3-3-2-2-执行脚本"><a href="#4-3-3-2-2-执行脚本" class="headerlink" title="4.3.3.2.2 执行脚本"></a>4.3.3.2.2 执行脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash openvpn-user-crt.sh<br>请输入用户的姓名拼音(如:): magedu<br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating a RSA private key<br>................................................................................<br>................................................................................<br>............................+++++<br>............................................................................++++<br>+<br>writing new private key to <span class="hljs-string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-</span><br><span class="hljs-string">13504.eqdKk5/tmp.kowkjQ&#x27;</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [magedu]:<br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-client/3/pki/reqs/magedu.req<br>key: /etc/openvpn/easy-rsa-client/3/pki/private/magedu.key<br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>The request has been successfully imported with a short name of: magedu<br>You may now use this name to perform signing operations on this request.<br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>You are about to sign the following certificate.<br>Please check over the details shown below <span class="hljs-keyword">for</span> accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br><span class="hljs-built_in">source</span> or that you have verified the request checksum with the sender.<br>Request subject, to be signed as a client certificate <span class="hljs-keyword">for</span> 90 days:<br>subject=<br> commonName         = magedu<br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Confirm request details: Using configuration from /etc/openvpn/easy-rsa-<br>server/3/pki/easy-rsa-13552.TvELex/tmp.Gx7dds<br>Check that the request matches the signature<br>Signature ok<br>The Subject<span class="hljs-string">&#x27;s Distinguished Name is as follows</span><br><span class="hljs-string">commonName      :ASN.1 12:&#x27;</span>magedu<span class="hljs-string">&#x27;</span><br><span class="hljs-string">Certificate is to be certified until Nov  3 13:50:50 2020 GMT (90 days)</span><br><span class="hljs-string">Write out database with 1 new entries</span><br><span class="hljs-string">Data Base Updated</span><br><span class="hljs-string">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt</span><br><span class="hljs-string">证书存放路径:/etc/openvpn/client/magedu,证书文件如下:</span><br><span class="hljs-string">******************************************************************</span><br><span class="hljs-string">total 28</span><br><span class="hljs-string">-rw------- 1 root root 1204 Aug  5 21:50 ca.crt</span><br><span class="hljs-string">-rw-r--r-- 1 root root  225 Aug  5 21:50 client.ovpn</span><br><span class="hljs-string">-rw------- 1 root root  424 Aug  5 21:50 dh.pem</span><br><span class="hljs-string">-rw------- 1 root root 4492 Aug  5 21:50 magedu.crt</span><br><span class="hljs-string">-rw------- 1 root root 1704 Aug  5 21:50 magedu.key</span><br><span class="hljs-string">-rw------- 1 root root  636 Aug  5 21:50 ta.key</span><br><span class="hljs-string">******************************************************************</span><br><span class="hljs-string">证书的打包文件已生成: /root/magedu.zip         [ OK ]</span><br></code></pre></td></tr></table></figure><h4 id="4-3-3-3-在Windows客户端用新证书连接登录"><a href="#4-3-3-3-在Windows客户端用新证书连接登录" class="headerlink" title="4.3.3.3 在Windows客户端用新证书连接登录"></a>4.3.3.3 在Windows客户端用新证书连接登录</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup63.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup64.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup65.jpg"></p><h3 id="4-4-生产推荐配置文件"><a href="#4-4-生产推荐配置文件" class="headerlink" title="4.4 生产推荐配置文件"></a>4.4 生产推荐配置文件</h3><p>server端和client端的生产推荐配置文件分别如下</p><h4 id="4-4-1-server-端配置"><a href="#4-4-1-server-端配置" class="headerlink" title="4.4.1 server 端配置"></a>4.4.1 server 端配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># grep &#x27;^[^#;]&#x27; /etc/openvpn/server.conf</span><br>port 1194<br>proto tcp<br>dev tun<br>ca /etc/openvpn/certs/ca.crt<br>cert /etc/openvpn/certs/server.crt<br>key /etc/openvpn/certs/server.key  <span class="hljs-comment"># This file should be kept secret</span><br>dh /etc/openvpn/certs/dh.pem<br>server 10.8.0.0 255.255.255.0<br>push <span class="hljs-string">&quot;route 172.30.0.0 255.255.0.0&quot;</span><br>keepalive 10 120<br>tls-auth /etc/openvpn/certs/ta.key 0<br>cipher AES-256-CBC<br>compress lz4-v2<br>push <span class="hljs-string">&quot;compress lz4-v2&quot;</span><br>max-clients 2048<br>user openvpn<br>group openvpn<br>status /var/<span class="hljs-built_in">log</span>/openvpn/openvpn-status.log<br>log-append /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log<br>verb 3<br>mute 200<br>crl-verify /etc/openvpn/easy-rsa-server/3/pki/crl.pem<br></code></pre></td></tr></table></figure><h4 id="4-4-2-client-端配置"><a href="#4-4-2-client-端配置" class="headerlink" title="4.4.2 client 端配置"></a>4.4.2 client 端配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cat /etc/openvpn/client/wangxiaochun/client.ovpn</span><br>client<br>dev tun<br>proto tcp<br>remote 10.0.0.8 1194<br>resolv-retry infinite<br>nobind<br><span class="hljs-comment">#persist-key</span><br><span class="hljs-comment">#persist-tun</span><br>ca ca.crt<br>cert magedu.crt<br>key magedu.key<br>remote-cert-tls server<br>tls-auth ta.key 1<br>cipher AES-256-CBC<br>verb 3<br>compress lz4-v2<br></code></pre></td></tr></table></figure><h2 id="五、-扩展知识"><a href="#五、-扩展知识" class="headerlink" title="五、 扩展知识"></a>五、 扩展知识</h2><h3 id="5-1-OpenVPN-Access-Server"><a href="#5-1-OpenVPN-Access-Server" class="headerlink" title="5.1 OpenVPN Access Server"></a>5.1 OpenVPN Access Server</h3><p>VPN Access Server 归属于 OpenVPN Solution，是官方推荐的VPN服务，它介于可收费与免费之间。</p><p>其实这个就是把 Openvpn Community 开源版做成了更方便，更稳定，优化过了的商业版。商业版有后台有基于Web的管理面板，也没有各种复杂和编译，而且只提供2个免费测试的USER，如果需要更多则需要购买许可证 5美元/用户。适合个人自用，不适合多人用。<br>参考文档: <a href="https://openvpn.net/vpn-server-resources/finishing-configuration-of-access-server/">https://openvpn.net/vpn-server-resources/finishing-configuration-of-access-server/</a></p><h4 id="5-1-1-安装-OpenVpn-Access-Server"><a href="#5-1-1-安装-OpenVpn-Access-Server" class="headerlink" title="5.1.1 安装 OpenVpn Access Server"></a>5.1.1 安装 OpenVpn Access Server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注意:CentOS8 不支持下面包</span><br>ll openvpn-as-*<br>-rw-r--r-- 1 root root  32742864 Apr 28 20:04 openvpn-as-2.8.3_f28d2eae-<br>CentOS7.x86_64.rpm<br>-rw-r--r-- 1 root root 130562200 Apr 28 20:03 openvpn-as-bundled-clients-8.rpm<br><br>[root@centos7 ~]<span class="hljs-comment"># yum -y install openvpn-as-2.8.3_f28d2eae-CentOS7.x86_64.rpm</span><br>openvpn-as-bundled-clients-8.rpm<br>To reconfigure manually, use the /usr/<span class="hljs-built_in">local</span>/openvpn_as/bin/ovpn-init tool.<br>+++++++++++++++++++++++++++++++++++++++++++++++<br>Access Server 2.8.3 has been successfully installed <span class="hljs-keyword">in</span> /usr/<span class="hljs-built_in">local</span>/openvpn_as<br>Configuration <span class="hljs-built_in">log</span> file has been written to /usr/<span class="hljs-built_in">local</span>/openvpn_as/init.log<br>Access Server Web UIs are available here:<br>Admin UI: https://10.0.0.17:943/admin<br>Client UI: https://10.0.0.17:943/<br>+++++++++++++++++++++++++++++++++++++++++++++++<br>Verifying : openvpn-as-2.8.3_f28d2eae-CentOS7.x86_64            <br>                  1/4<br>Verifying : MySQL-python-1.2.5-1.el7.x86_64                 <br>                  2/4<br>Verifying : openvpn-as-bundled-clients-8-1.noarch              <br>                  3/4<br>Verifying : cyrus-sasl-2.1.26-23.el7.x86_64                 <br>                  4/4<br>Installed:<br>openvpn-as.x86_64 0:2.8.3_f28d2eae-CentOS7          openvpn-as-<br>bundled-clients.noarch 0:8-1         <br>Dependency Installed:<br>MySQL-python.x86_64 0:1.2.5-1.el7             cyrus-sasl.x86_64<br>0:2.1.26-23.el7            <br>Complete!<br><br>getent passwd openvpn<br>openvpn:x:1002:1002::/home/openvpn:/sbin/nologin<br><br>passwd openvpn<br>Changing password <span class="hljs-keyword">for</span> user openvpn.<br>New password:<br>BAD PASSWORD: The password is shorter than 8 characters<br>Retype new password:<br>passwd: all authentication tokens updated successfully.<br><br><span class="hljs-comment">#安装包后openvpnas.service 自动启动</span><br>[root@centos7 ~]<span class="hljs-comment"># systemctl status openvpnas.service</span><br>● openvpnas.service - OpenVPN Access Server Service<br> Loaded: loaded (/usr/lib/systemd/system/openvpnas.service; enabled; vendor<br>preset: disabled)<br> Active: active (running) since Wed 2020-08-05 22:26:16 CST; 50min ago<br>Main PID: 1408 (python2)<br> CGroup: /system.slice/openvpnas.service<br>     ├─1408 python2 -c from pyovpn.sagent.sagent_entry import openvpnas ;<br>openvpnas() --logfile=/var/<span class="hljs-built_in">log</span>/openvp...<br>├─1439 /usr/bin/python2 -c from pyovpn.log.logworker import start ;<br>start()<br>     ├─1440 /usr/bin/python2 -c from pyovpn.cserv.wserv_entry import start<br>; start() -no -u openvpn_as -g openv...<br>     ├─1479 /usr/bin/python2 -c from pyovpn.sagent.iptworker import start6<br>; start6()<br>     ├─1486 /usr/bin/python2 -c from pyovpn.sagent.iptworker import start<br>; start()<br>     ├─1494 openvpn-openssl --errors-to-stderr --config stdin<br>     ├─1499 openvpn-openssl --errors-to-stderr --config stdin<br>     └─1502 openvpn-openssl --errors-to-stderr --config stdin<br>Aug 05 22:26:15 centos7.wangxiaochun.com systemd[1]: Starting OpenVPN Access<br>Server Service...<br>Aug 05 22:26:16 centos7.wangxiaochun.com systemd[1]: Started OpenVPN Access<br>Server Service.<br>Aug 05 22:28:11 centos7.wangxiaochun.com python2[1408]:<br>pam_unix(openvpnas:auth): authentication failure; logname...nvpn<br>Aug 05 22:28:31 centos7.wangxiaochun.com python2[1408]:<br>pam_unix(openvpnas:auth): authentication failure; logname...nvpn<br>Aug 05 22:28:48 centos7.wangxiaochun.com python2[1408]:<br>pam_unix(openvpnas:auth): authentication failure; logname...nvpn<br>Hint: Some lines were ellipsized, use -l to show <span class="hljs-keyword">in</span> full.<br><br><span class="hljs-comment">#查看打开的相关端口</span><br>[root@centos7 ~]<span class="hljs-comment"># ss -ntlp</span><br>State   Recv-Q Send-Q       Local Address:Port    Peer Address:Port<br>      <br>LISTEN   0    50 127.0.0.1:909      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=15))<br>LISTEN   0    50     *:943      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=8))<br>LISTEN   0    128    *:22      *:*          users:<br>((<span class="hljs-string">&quot;sshd&quot;</span>,pid=827,fd=3))<br>LISTEN   0    100127.0.0.1:25      *:*          users:<br>((<span class="hljs-string">&quot;master&quot;</span>,pid=962,fd=13))<br>LISTEN   0    1     *:443      *:*          users:<br>((<span class="hljs-string">&quot;openvpn-openssl&quot;</span>,pid=1481,fd=5))<br>LISTEN   0    50 127.0.0.1:904      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=10))<br>LISTEN   0    50 127.0.0.1:905      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=11))<br>LISTEN   0    50 127.0.0.1:906      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=12))<br>LISTEN   0    50 127.0.0.1:907      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=13))<br>LISTEN   0    50 127.0.0.1:908      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=14))<br>LISTEN   0    128   [::]:22     [::]:*          users:<br>((<span class="hljs-string">&quot;sshd&quot;</span>,pid=827,fd=4))<br>LISTEN   0    100  [::1]:25     [::]:*          users:<br>((<span class="hljs-string">&quot;master&quot;</span>,pid=962,fd=14))<br></code></pre></td></tr></table></figure><h4 id="5-1-2-登录服务器Admin-UI-进行管理"><a href="#5-1-2-登录服务器Admin-UI-进行管理" class="headerlink" title="5.1.2 登录服务器Admin UI 进行管理"></a>5.1.2 登录服务器Admin UI 进行管理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://openvpn-server:943/admin<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup66.jpg"></p><p>输入用户openvpn和上面设置的密码可以登录</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup67.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup68.jpg"></p><p>登录成功</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup69.jpg"></p><h4 id="5-1-3-从-Client-UI登录客户端连接地址下载相关文件"><a href="#5-1-3-从-Client-UI登录客户端连接地址下载相关文件" class="headerlink" title="5.1.3 从 Client UI登录客户端连接地址下载相关文件"></a>5.1.3 从 Client UI登录客户端连接地址下载相关文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://openvpn-server:943/<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup70.jpg"></p><p>选择下载相应的软件版本安装</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup71.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup72.jpg"></p><p>下载软件完成</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup73.jpg"></p><h4 id="5-1-4-安装客户端软件"><a href="#5-1-4-安装客户端软件" class="headerlink" title="5.1.4 安装客户端软件"></a>5.1.4 安装客户端软件</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup74.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup75.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup76.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup77.jpg"></p><p>安装完成</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup78.jpg"></p><h4 id="5-1-5-运行软件并登录"><a href="#5-1-5-运行软件并登录" class="headerlink" title="5.1.5 运行软件并登录"></a>5.1.5 运行软件并登录</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup79.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup80.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup81.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup82.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup83.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup84.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup85.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup86.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup87.jpg"></p><h4 id="5-1-6-验证登录"><a href="#5-1-6-验证登录" class="headerlink" title="5.1.6 验证登录"></a>5.1.6 验证登录</h4><h5 id="5-1-6-1-客户端查看登录"><a href="#5-1-6-1-客户端查看登录" class="headerlink" title="5.1.6.1 客户端查看登录"></a>5.1.6.1 客户端查看登录</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup88.jpg"></p><h5 id="5-1-6-2-服务器查看日志"><a href="#5-1-6-2-服务器查看日志" class="headerlink" title="5.1.6.2 服务器查看日志"></a>5.1.6.2 服务器查看日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># tail /var/log/openvpnas.log -f</span><br>2020-09-18T07:57:05+0800 [stdout<span class="hljs-comment">#info] [OVPN 0] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br>TCP connection established with [AF_INET]10.0.0.1:6503<span class="hljs-string">&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;</span>Thu Sep 17 23:57:05 2020<br>Socket flags: TCP_NODELAY=1 succeeded<span class="hljs-string">&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;</span>Thu Sep 17 23:57:05 2020<br>10.0.0.1:6503 Non-OpenVPN client protocol detected<span class="hljs-string">&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;</span>Thu Sep 17 23:57:05 2020<br>10.0.0.1:6503 SIGTERM[soft,port-share-redirect] received, client-instance<br>exiting<span class="hljs-string">&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;</span>2020-09-18T07:57:05+0800<br>[pyovpn.xml.udscli.UDSProxyQueryFactory<span class="hljs-comment">#info] Starting factory</span><br>&lt;pyovpn.xml.udscli.UDSProxyQueryFactory instance at 0x7f76d7d328c0&gt;<span class="hljs-string">&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [twisted.python.log#info] &quot;-&quot; - - [17/Sep/2020:23:57:05</span><br><span class="hljs-string">+0000] &quot;POST /RPC2 HTTP/1.0&quot; 200 1240 &quot;-&quot; &quot;Twisted/XMLRPClib&quot;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;</span>2020-09-18T07:57:05+0800<br>[twisted.python.log<span class="hljs-comment">#info] &quot;127.0.0.1&quot; - - [17/Sep/2020:23:57:05 +0000] &quot;POST</span><br>/RPC2 HTTP/1.1<span class="hljs-string">&quot; 200 297 &quot;</span>-<span class="hljs-string">&quot; &quot;</span>-<span class="hljs-string">&quot;&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;2020-09-18T07:57:05+0800</span><br><span class="hljs-string">[pyovpn.xml.udscli.UDSProxyQueryFactory#info] Stopping factory</span><br><span class="hljs-string">&lt;pyovpn.xml.udscli.UDSProxyQueryFactory instance at 0x7f76d7d328c0&gt;&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">TCP connection established with [AF_INET]10.0.0.1:6504&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">Socket flags: TCP_NODELAY=1 succeeded&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:6504 Non-OpenVPN client protocol detected&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:6504 SIGTERM[soft,port-share-redirect] received, client-instance</span><br><span class="hljs-string">exiting&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;2020-09-18T07:57:05+0800</span><br><span class="hljs-string">[pyovpn.xml.udscli.UDSProxyQueryFactory#info] Starting factory</span><br><span class="hljs-string">&lt;pyovpn.xml.udscli.UDSProxyQueryFactory instance at 0x7f76d7cfdef0&gt;&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [twisted.python.log#info] &quot;</span>-<span class="hljs-string">&quot; - - [17/Sep/2020:23:57:05</span><br><span class="hljs-string">+0000] &quot;</span>POST /RPC2 HTTP/1.0<span class="hljs-string">&quot; 200 10020 &quot;</span>-<span class="hljs-string">&quot; &quot;</span>Twisted/XMLRPClib<span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;2020-09-18T07:57:05+0800</span><br><span class="hljs-string">[twisted.python.log#info] &quot;</span>127.0.0.1<span class="hljs-string">&quot; - - [17/Sep/2020:23:57:05 +0000] &quot;</span>POST<br>/RPC2 HTTP/1.1<span class="hljs-string">&quot; 200 10020 &quot;</span>-<span class="hljs-string">&quot; &quot;</span>-<span class="hljs-string">&quot;&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;2020-09-18T07:57:05+0800</span><br><span class="hljs-string">[pyovpn.xml.udscli.UDSProxyQueryFactory#info] Stopping factory</span><br><span class="hljs-string">&lt;pyovpn.xml.udscli.UDSProxyQueryFactory instance at 0x7f76d7cfdef0&gt;&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 TLS: Initial packet from [AF_INET]10.0.0.1:65018 (via</span><br><span class="hljs-string">[AF_INET]10.0.0.7%eth0), sid=daedad3d 3c2e53b5&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 VERIFY OK: depth=1, /CN=OpenVPN CA&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 VERIFY OK: nsCertType=CLIENT&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 VERIFY OK: depth=0, /CN=openvpn&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_GUI_VER=OCmacOS_3.1.3-713&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_VER=3.git::f225fcd0&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_PLAT=win&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_NCP=2&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_TCPNL=1&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_PROTO=2&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_LZO_STUB=1&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_COMP_STUB=1&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_COMP_STUBv2=1&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_HWADDR=00:2b:67:bd:6b:d1&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:05 2020<br>10.0.0.1:65018 TLS: Username/Password authentication deferred <span class="hljs-keyword">for</span> username<br><span class="hljs-string">&#x27;openvpn&#x27;</span> <span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] AUTH SUCCESS &#123;&#x27;status&#x27;: 0, &#x27;session_id&#x27;:</span><br><span class="hljs-string">&#x27;[redacted]&#x27;, &#x27;reason&#x27;: &#x27;SESSION_ID found existing web authed session, allowing</span><br><span class="hljs-string">VPN session&#x27;, &#x27;serial_list&#x27;: [], &#x27;user&#x27;: &#x27;openvpn&#x27;, &#x27;proplist&#x27;:</span><br><span class="hljs-string">&#123;u&#x27;pvt_google_auth_secret_locked&#x27;: u&#x27;false&#x27;, u&#x27;prop_autogenerate&#x27;: u&#x27;true&#x27;,</span><br><span class="hljs-string">&#x27;prop_deny&#x27;: &#x27;false&#x27;, u&#x27;pvt_google_auth_secret&#x27;: &#x27;[redacted]&#x27;, u&#x27;type&#x27;:</span><br><span class="hljs-string">u&#x27;user_compile&#x27;, u&#x27;prop_superuser&#x27;: u&#x27;true&#x27;&#125;, &#x27;common_name&#x27;: u&#x27;openvpn&#x27;,</span><br><span class="hljs-string">&#x27;serial&#x27;: &#x27;2&#x27;, &#x27;create_new_session&#x27;: True&#125;</span><br><span class="hljs-string">cli=u&#x27;win&#x27;/u&#x27;3.git::f225fcd0&#x27;/u&#x27;OCmacOS_3.1.3-713&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:05 2020<br>MANAGEMENT: CMD <span class="hljs-string">&#x27;client-auth 1 0&#x27;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 Control Channel: TLSv1.2, cipher TLSv1/SSLv3 ECDHE-RSA-AES256-</span><br><span class="hljs-string">GCM-SHA384, 2048 bit RSA&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 [openvpn] Peer Connection Initiated with [AF_INET]10.0.0.1:65018</span><br><span class="hljs-string">(via [AF_INET]10.0.0.7%eth0)&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:05 2020<br>10.0.0.1:65018 PUSH: Received control message: <span class="hljs-string">&#x27;PUSH_REQUEST&#x27;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">openvpn/10.0.0.1:65018 OPTIONS IMPORT: compression parms modified&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">openvpn/10.0.0.1:65018 MULTI: Learn: 172.27.232.3 -&gt; openvpn/10.0.0.1:65018&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">openvpn/10.0.0.1:65018 MULTI: primary virtual IP for openvpn/10.0.0.1:65018:</span><br><span class="hljs-string">172.27.232.3&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:06+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:06 2020<br>openvpn/10.0.0.1:65018 PUSH: Received control message: <span class="hljs-string">&#x27;PUSH_REQUEST&#x27;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:06+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:06 2020<br>openvpn/10.0.0.1:65018 SENT CONTROL [openvpn]: <span class="hljs-string">&#x27;PUSH_REPLY,explicit-exit-</span><br><span class="hljs-string">notify,topology subnet,route-delay 5 30,dhcp-pre-release,dhcp-renew,dhcp-</span><br><span class="hljs-string">release,route-metric 101,ping 12,ping-restart 50,compress stub-v2,redirect-</span><br><span class="hljs-string">gateway def1,redirect-gateway bypass-dhcp,redirect-gateway autolocal,route-</span><br><span class="hljs-string">gateway 172.27.232.1,dhcp-option DNS 223.6.6.6,dhcp-option DNS</span><br><span class="hljs-string">180.76.76.76,register-dns,block-ipv6,ifconfig 172.27.232.3 255.255.248.0,peer-id</span><br><span class="hljs-string">0,auth-tokenSESS_ID,cipher AES-256-GCM&#x27;</span> (status=1)<span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:06+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:06 2020<br>openvpn/10.0.0.1:65018 Data Channel: using negotiated cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:06+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:06 2020<br>openvpn/10.0.0.1:65018 Outgoing Data Channel: Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized<br>with 256 bit key<span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:06+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:06 2020<br>openvpn/10.0.0.1:65018 Incoming Data Channel: Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized<br>with 256 bit key<span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:12+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:12 2020</span><br><span class="hljs-string">openvpn/10.0.0.1:65018 IP packet with unknown IP version=0 seen&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="5-2-docker-运行OpenVPN-Access-Server"><a href="#5-2-docker-运行OpenVPN-Access-Server" class="headerlink" title="5.2 docker 运行OpenVPN Access Server"></a>5.2 docker 运行OpenVPN Access Server</h3><p>参考链接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://hub.docker.com/r/linuxserver/openvpn-as<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Linux OpenVPN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nginx架构和安装</title>
    <link href="/blog/2021/02/28/Nginx%E6%9E%B6%E6%9E%84%E5%92%8C%E5%AE%89%E8%A3%85/"/>
    <url>/blog/2021/02/28/Nginx%E6%9E%B6%E6%9E%84%E5%92%8C%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h1 id="Nginx-架构和安装"><a href="#Nginx-架构和安装" class="headerlink" title="Nginx 架构和安装"></a>Nginx 架构和安装</h1><h2 id="一、Nginx-架构和安装"><a href="#一、Nginx-架构和安装" class="headerlink" title="一、Nginx 架构和安装"></a>一、Nginx 架构和安装</h2><h3 id="1-1-Nginx-概述"><a href="#1-1-Nginx-概述" class="headerlink" title="1.1 Nginx 概述"></a>1.1 Nginx 概述</h3><h4 id="1-1-1-Nginx-介绍"><a href="#1-1-1-Nginx-介绍" class="headerlink" title="1.1.1 Nginx 介绍"></a>1.1.1 Nginx 介绍</h4><p>Nginx：engine X ，2002年开发，分为社区版和商业版(nginx plus )</p><p>2019年3月11日 F5 Networks 6.7亿美元的价格收购</p><p>Nginx是免费的、开源的、高性能的HTTP和反向代理服务器、邮件代理服务器、以及TCP/UDP代理服务器</p><p>解决C10K问题（10K Connections）</p><p>解决C1000K问题参考链接: <a href="http://www.ideawu.net/blog/archives/740.html">http://www.ideawu.net/blog/archives/740.html</a></p><p>Nginx官网：<a href="http://nginx.org/">http://nginx.org</a></p><p>nginx的其它的二次发行版：</p><ul><li>Tengine：由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性。Tengine的性能和稳定性已经在大型的网站如淘宝网，天猫商城等得到了很好的检验。它的最终目标是打造一个高效、稳定、安全、易用的Web平台。从2011年12月开始，Tengine成为一个开源项目，官网: <a href="http://tengine.taobao.org/">http://tengine.taobao.org/</a></li><li>OpenResty：基于 Nginx 与 Lua 语言的高性能 Web 平台， 章亦春团队开发，官网：<a href="http://openresty.org/cn/">http://openresty.org/cn/</a></li></ul><h4 id="1-1-2-Nginx-功能介绍"><a href="#1-1-2-Nginx-功能介绍" class="headerlink" title="1.1.2 Nginx 功能介绍"></a>1.1.2 Nginx 功能介绍</h4><ul><li>静态的web资源服务器html，图片，js，css，txt等静态资源</li><li>http/https协议的反向代理</li><li>结合FastCGI/uWSGI/SCGI等协议反向代理动态资源请求</li><li>tcp/udp协议的请求转发（反向代理）</li><li>imap4/pop3协议的反向代理</li></ul><h4 id="1-1-3-基础特性"><a href="#1-1-3-基础特性" class="headerlink" title="1.1.3 基础特性"></a>1.1.3 基础特性</h4><ul><li>模块化设计，较好的扩展性</li><li>高可靠性</li><li>支持热部署：不停机更新配置文件，升级版本，更换日志文件</li><li>低内存消耗：10000个keep-alive连接模式下的非活动连接，仅需2.5M内存</li><li>event-driven,aio,mmap，sendfile</li></ul><h4 id="1-1-4-Web-服务相关的功能"><a href="#1-1-4-Web-服务相关的功能" class="headerlink" title="1.1.4 Web 服务相关的功能"></a>1.1.4 Web 服务相关的功能</h4><ul><li>虚拟主机（server）</li><li>支持 keep-alive 和管道连接(利用一个连接做多次请求)</li><li>访问日志（支持基于日志缓冲提高其性能）</li><li>url rewirte</li><li>路径别名</li><li>基于IP及用户的访问控制</li><li>支持速率限制及并发数限制</li><li>重新配置和在线升级而无须中断客户的工作进程</li></ul><h3 id="1-2-Nginx-架构和进程"><a href="#1-2-Nginx-架构和进程" class="headerlink" title="1.2 Nginx 架构和进程"></a>1.2 Nginx 架构和进程</h3><h4 id="1-2-1-Nginx-架构"><a href="#1-2-1-Nginx-架构" class="headerlink" title="1.2.1 Nginx 架构"></a>1.2.1 Nginx 架构</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-framework1.jpg"></p><h4 id="1-2-2-Nginx-进程结构"><a href="#1-2-2-Nginx-进程结构" class="headerlink" title="1.2.2 Nginx 进程结构"></a>1.2.2 Nginx 进程结构</h4><p>web请求处理机制</p><ul><li>多进程方式：服务器每接收到一个客户端请求就有服务器的主进程生成一个子进程响应客户端，直到用户关闭连接，这样的优势是处理速度快，子进程之间相互独立，但是如果访问过大会导致服务器资源耗尽而无法提供请求。</li><li>多线程方式：与多进程方式类似，但是每收到一个客户端请求会有服务进程派生出一个线程来个客户方进行交互，一个线程的开销远远小于一个进程，因此多线程方式在很大程度减轻了web服务器对系统资源的要求，但是多线程也有自己的缺点，即当多个线程位于同一个进程内工作的时候，可以相互访问同样的内存地址空间，所以他们相互影响，一旦主进程挂掉则所有子线程都不能工作了，IIS服务器使用了多线程的方式，需要间隔一段时间就重启一次才能稳定。</li></ul><p>Nginx是多进程组织模型，而且是一个由Master主进程和Worker工作进程组成。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-framework2.jpg"></p><p>主进程(master process)的功能：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">对外接口：接收外部的操作（信号）<br>对内转发：根据外部的操作的不同，通过信号管理 Worker<br>监控：监控 worker 进程的运行状态，worker 进程异常终止后，自动重启 worker 进程读取Nginx 配置文件并验证其有效性和正确性建立、绑定和关闭socket连接按照配置生成、管理和结束工作进程接受外界指令，比如重启、升级及退出服务器等指令不中断服务，实现平滑升级，重启服务并应用新的配置开启日志文件，获取文件描述符不中断服务，实现平滑升级，升级失败进行回滚处理编译和处理perl脚本<br></code></pre></td></tr></table></figure><p>工作进程（worker process）的功能：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">所有 Worker 进程都是平等的<br>实际处理：网络请求，由 Worker 进程处理<br>Worker 进程数量：在 nginx.conf 中配置，一般设置为核心数，充分利用 CPU 资源，同时，避免进程数量过多，避免进程竞争 CPU 资源，增加上下文切换的损耗接受处理客户的请求<br>将请求依次送入各个功能模块进行处理<br>I/O调用，获取响应数据<br>与后端服务器通信，接收后端服务器的处理结果<br>缓存数据，访问缓存索引，查询和调用缓存数据<br>发送请求结果，响应客户的请求<br>接收主程序指令，比如重启、升级和退出等<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-framework3.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-framework4.jpg"></p><h4 id="1-2-3-Nginx-进程间通信"><a href="#1-2-3-Nginx-进程间通信" class="headerlink" title="1.2.3 Nginx 进程间通信"></a>1.2.3 Nginx 进程间通信</h4><p>工作进程是由主进程生成的，主进程使用fork()函数，在Nginx服务器启动过程中主进程根据配置文件决定启动工作进程的数量，然后建立一张全局的工作表用于存放当前未退出的所有的工作进程，主进程生成工作进程后会将新生成的工作进程加入到工作进程表中，并建立一个单向的管道并将其传递给工作进程，该管道与普通的管道不同，它是由主进程指向工作进程的单向通道，包含了主进程向工作进程发出的指令、工作进程ID、工作进程在工作进程表中的索引和必要的文件描述符等信息。主进程与外界通过信号机制进行通信，当接收到需要处理的信号时，它通过管道向相关的工作进程发送正确的指令，每个工作进程都有能力捕获管道中的可读事件，当管道中有可读事件的时候，工作进程就会从管道中读取并解析指令，然后采取相应的执行动作，这样就完成了主进程与工作进程的交互。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">工作进程之间的通信原理基本上和主进程与工作进程之间的通信是一样的，只要工作进程之间能够取得彼此的信息，建立管道即可通信，但是由于工作进程之间是完全隔离的，因此一个进程想要知道另外一个进程的状态信息,就只能通过主进程来实现。<br>为了实现工作进程之间的交互，主进程在生成工作进程之后，在工作进程表中进行遍历，将该新进程的ID以及针对该进程建立的管道句柄传递给工作进程中的其他进程，为工作进程之间的通信做准备，当工作进程1向工作进程2发送指令的时候，首先在主进程给它的其他工作进程工作信息中找到2的进程ID，然后将正确的指令写入指向进程2的管道，工作进程2捕获到管道中的事件后，解析指令并进行相关操作，这样就完成了工作进程之间的通信。<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-framework5.jpg"></p><h4 id="1-2-4-HTTP-连接建立和请求处理过程"><a href="#1-2-4-HTTP-连接建立和请求处理过程" class="headerlink" title="1.2.4 HTTP 连接建立和请求处理过程"></a>1.2.4 HTTP 连接建立和请求处理过程</h4><ul><li><p>Nginx 启动时，Master 进程，加载配置文件</p></li><li><p>Master 进程，初始化监听的 socket</p></li><li><p>Master 进程，fork 出多个 Worker 进程</p></li><li><p>Worker 进程，竞争新的连接，获胜方通过三次握手，建立 Socket 连接，并处理请求</p></li></ul><h4 id="1-2-5-HTTP-处理过程"><a href="#1-2-5-HTTP-处理过程" class="headerlink" title="1.2.5 HTTP 处理过程"></a>1.2.5 HTTP 处理过程</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-framework6.jpg"></p><h3 id="1-3-Nginx-模块介绍"><a href="#1-3-Nginx-模块介绍" class="headerlink" title="1.3 Nginx 模块介绍"></a>1.3 Nginx 模块介绍</h3><p>nginx 有多种模块</p><ul><li>核心模块：是 Nginx 服务器正常运行必不可少的模块，提供错误日志记录 、配置文件解析 、事件驱动机制 、进程管理等核心功能</li><li>标准HTTP模块：提供 HTTP 协议解析相关的功能，比如： 端口配置 、 网页编码设置 、 HTTP响应头设置 等等</li><li>可选HTTP模块：主要用于扩展标准的 HTTP 功能，让 Nginx 能处理一些特殊的服务，比如：<br>Flash 多媒体传输 、解析 GeoIP 请求、 网络传输压缩 、 安全协议 SSL 支持等</li><li>邮件服务模块：主要用于支持 Nginx 的 邮件服务 ，包括对 POP3 协议、 IMAP 协议和 SMTP协议的支持</li><li>Stream服务模块: 实现反向代理功能,包括TCP协议代理</li><li>第三方模块：是为了扩展 Nginx 服务器应用，完成开发者自定义功能，比如： Json 支持、 Lua 支持等</li></ul><p>nginx高度模块化，但其模块早期不支持DSO机制;1.9.11 版本支持动态装载和卸载</p><p>模块分类：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">核心模块：core module<br>标准模块：<br>    HTTP 模块： ngx_http_*<br>    HTTP Core modules  <span class="hljs-comment">#默认功能</span><br>    HTTP Optional modules <span class="hljs-comment">#需编译时指定</span><br>  Mail 模块: ngx_mail_*<br>  Stream 模块 ngx_stream_*<br>第三方模块<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-framework7.jpg"></p><h3 id="1-4-Nginx-安装"><a href="#1-4-Nginx-安装" class="headerlink" title="1.4 Nginx 安装"></a>1.4 Nginx 安装</h3><p>Nginx版本分为Mainline version(主要开发版本)、Stable version(当前最新稳定版)和Legacy<br>versions(旧的稳定版)<br>Nginx安装可以使用yum或源码安装，但是推荐使用源码编译安装</p><ul><li><p>yum的版本比较旧</p></li><li><p>编译安装可以更方便自定义相关路径</p></li><li><p>使用源码编译可以自定义相关功能，更方便业务的上的使用</p></li></ul><p>源码安装需要提前准备标准的编译器，GCC的全称是（GNU Compiler collection），其有GNU开发，并以GPL即LGPL许可，是自由的类UNIX即苹果电脑Mac OS X操作系统的标准编译器，因为GCC原本只能处理C语言，所以原名为GNU C语言编译器，后来得到快速发展，可以处理C++,Fortran，pascal，objective-C，java以及Ada等其他语言，此外还需要Automake工具，以完成自动创建Makefile的工作，Nginx的一些模块需要依赖第三方库，比如: pcre（支持rewrite），zlib（支持gzip模块）和openssl（支持ssl模块）等。</p><h3 id="1-4-1-基于-yum-安装-Nginx"><a href="#1-4-1-基于-yum-安装-Nginx" class="headerlink" title="1.4.1 基于 yum 安装 Nginx"></a>1.4.1 基于 yum 安装 Nginx</h3><p>1.4.1.1 查看当前系统中的 nginx 版本</p><p>范例: 查看nginx版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#CentOS7</span><br>yum info nginx<br>Loaded plugins: fastestmirror, langpacks<br>Loading mirror speeds from cached hostfile<br> * base: mirrors.aliyun.com<br> * extras: mirrors.aliyun.com<br> * updates: mirrors.aliyun.com<br>Available Packages<br>Name        : nginx<br>Arch        : x86_64<br>Epoch       : 1<br>Version     : 1.16.1<br>Release     : 3.el7<br>Size        : 563 k<br>Repo        : epel/x86_64<br>Summary     : A high performance web server and reverse proxy server<br>URL         : http://nginx.org/<br>License     : BSD<br>Description : Nginx is a web server and a reverse proxy server <span class="hljs-keyword">for</span> HTTP, SMTP, POP3 and<br>            : IMAP protocols, with a strong focus on high concurrency, performance and low<br>            : memory usage.<br>            <br><span class="hljs-comment">#Ubuntu18.04 </span><br>apt -a show nginx<br>Package: nginx<br>Version: 1.14.0-0ubuntu1.7<br>Priority: optional<br>Section: web<br>Origin: Ubuntu<br>Maintainer: Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;<br>Original-Maintainer: Debian Nginx Maintainers &lt;pkg-nginx-maintainers@lists.alioth.debian.org&gt;<br>Bugs: https://bugs.launchpad.net/ubuntu/+filebug<br>Installed-Size: 44.0 kB<br>Depends: nginx-core (&lt;&lt; <span class="hljs-string">1.14.0-0ubuntu1.7.1</span>~) | nginx-full (&lt;&lt; <span class="hljs-string">1.14.0-0ubuntu1.7.1</span>~) | nginx-light (&lt;&lt; <span class="hljs-string">1.14.0-0ubuntu1.7.1</span>~) | nginx-extras (&lt;&lt; <span class="hljs-string">1.14.0-0ubuntu1.7.1</span>~), nginx-core (&gt;= 1.14.0-0ubuntu1.7) | nginx-full (&gt;= 1.14.0-0ubuntu1.7) | nginx-light (&gt;= 1.14.0-0ubuntu1.7) | nginx-extras (&gt;= 1.14.0-0ubuntu1.7)<br>Homepage: http://nginx.net<br>Supported: 5y<br>Download-Size: 3,596 B<br>APT-Sources: http://mirrors.aliyun.com/ubuntu bionic-security/main amd64 Packages<br>Description: small, powerful, scalable web/proxy server<br> Nginx (<span class="hljs-string">&quot;engine X&quot;</span>) is a high-performance web and reverse proxy server<br> created by Igor Sysoev. It can be used both as a standalone web server<br> and as a proxy to reduce the load on back-end HTTP or mail servers.<br> .<br> This is a dependency package to install either nginx-full (by default),<br> nginx-light or nginx-extras.<br><br>Package: nginx<br>Version: 1.14.0-0ubuntu1<br>Priority: optional<br>Section: web<br>Origin: Ubuntu<br>Maintainer: Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;<br>Original-Maintainer: Debian Nginx Maintainers &lt;pkg-nginx-maintainers@lists.alioth.debian.org&gt;<br>Bugs: https://bugs.launchpad.net/ubuntu/+filebug<br>Installed-Size: 43.0 kB<br>Depends: nginx-core (&lt;&lt; <span class="hljs-string">1.14.0-0ubuntu1.1</span>~) | nginx-full (&lt;&lt; <span class="hljs-string">1.14.0-0ubuntu1.1</span>~) | nginx-light (&lt;&lt; <span class="hljs-string">1.14.0-0ubuntu1.1</span>~) | nginx-extras (&lt;&lt; <span class="hljs-string">1.14.0-0ubuntu1.1</span>~), nginx-core (&gt;= 1.14.0-0ubuntu1) | nginx-full (&gt;= 1.14.0-0ubuntu1) | nginx-light (&gt;= 1.14.0-0ubuntu1) | nginx-extras (&gt;= 1.14.0-0ubuntu1)<br>Homepage: http://nginx.net<br>Supported: 5y<br>Download-Size: 3,596 B<br>APT-Sources: http://mirrors.aliyun.com/ubuntu bionic/main amd64 Packages<br>Description: small, powerful, scalable web/proxy server<br> Nginx (<span class="hljs-string">&quot;engine X&quot;</span>) is a high-performance web and reverse proxy server<br> created by Igor Sysoev. It can be used both as a standalone web server<br> and as a proxy to reduce the load on back-end HTTP or mail servers.<br> .<br> This is a dependency package to install either nginx-full (by default),<br> nginx-light or nginx-extras.<br></code></pre></td></tr></table></figure><h5 id="1-4-1-2-官方包源安装最新版本-nginx"><a href="#1-4-1-2-官方包源安装最新版本-nginx" class="headerlink" title="1.4.1.2 官方包源安装最新版本 nginx"></a>1.4.1.2 官方包源安装最新版本 nginx</h5><p>系统和EPEL源的中nignx版本较旧,可以安装官方源的最新版本</p><p>官方包链接:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://nginx.org/en/linux_packages.html<br></code></pre></td></tr></table></figure><p>官方 其他linux发行版 源链接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://nginx.org/en/linux_packages.html<span class="hljs-comment">#RHEL-CentOS</span><br></code></pre></td></tr></table></figure><p>范例: 通过官方 yum 源安装nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat /etc/yum.repos.d/nginx.repo<br>[nginx-stable]<br>name=nginx stable repo<br>baseurl=http://nginx.org/packages/centos/<span class="hljs-variable">$releasever</span>/<span class="hljs-variable">$basearch</span>/<br>gpgcheck=1<br>enabled=1<br>gpgkey=https://nginx.org/keys/nginx_signing.key<br>module_hotfixes=<span class="hljs-literal">true</span><br><br>[nginx-mainline]<br>name=nginx mainline repo<br>baseurl=http://nginx.org/packages/mainline/centos/<span class="hljs-variable">$releasever</span>/<span class="hljs-variable">$basearch</span>/<br>gpgcheck=1<br>enabled=0<br>gpgkey=https://nginx.org/keys/nginx_signing.key<br>module_hotfixes=<span class="hljs-literal">true</span><br><br><span class="hljs-comment">#列出所有版本</span><br>yum list nginx --showduplicates<br>Last metadata expiration check: 0:01:08 ago on Tue 22 Sep 2020 12:01:59 PM CST.<br>Available Packages<br>nginx.x86_64   1.16.0-1.el8.ngx             nginx-stable<br>nginx.x86_64   1:1.14.1-9.module_el8.0.0+184+e34fea82  AppStream <br>nginx.x86_64   1:1.16.1-1.el8.ngx            nginx-stable<br>nginx.x86_64   1:1.18.0-1.el8.ngx            nginx-stable<br><br><span class="hljs-comment">#查看版本信息</span><br>dnf info nginx<br>Last metadata expiration check: 0:02:50 ago on Tue 22 Sep 2020 12:01:59 PM CST.<br>Available Packages<br>Name     : nginx<br>Epoch    : 1<br>Version   : 1.18.0<br>Release   : 1.el8.ngx<br>Architecture : x86_64<br>Size     : 806 k<br>Source    : nginx-1.18.0-1.el8.ngx.src.rpm<br>Repository  : nginx-stable<br>Summary   : High performance web server<br>URL     : http://nginx.org/<br>License   : 2-clause BSD-like license<br>Description : nginx [engine x] is an HTTP and reverse proxy server, as well as<br>      : a mail proxy server.<br><br>yum -y install nginx<br></code></pre></td></tr></table></figure><h5 id="1-4-1-3-检查安装"><a href="#1-4-1-3-检查安装" class="headerlink" title="1.4.1.3 检查安装"></a>1.4.1.3 检查安装</h5><p>查看nginx安装包信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -q nginx<br>nginx-1.18.0-1.el8.ngx.x86_64<br><br>rpm -qi nginx<br>Name    : nginx<br>Epoch    : 1<br>Version   : 1.18.0<br>Release   : 1.el8.ngx<br>Architecture: x86_64<br>Install Date: Tue 22 Sep 2020 12:05:14 PM CST<br>Group    : System Environment/Daemons<br>Size    : 3815084<br>License   : 2-clause BSD-like license<br>Signature  : RSA/SHA1, Tue 21 Apr 2020 11:19:19 PM CST, Key ID abf5bd827bd9bf62<br>Source RPM : nginx-1.18.0-1.el8.ngx.src.rpm<br>Build Date : Tue 21 Apr 2020 11:07:57 PM CST<br>Build Host : ip-10-1-17-47.eu-central-1.compute.internal<br>Relocations : (not relocatable)<br>Vendor   : Nginx, Inc.<br>URL     : http://nginx.org/<br>Summary   : High performance web server<br>Description :<br>nginx [engine x] is an HTTP and reverse proxy server, as well as<br>a mail proxy server.<br><br>rpm -ql nginx<br>/etc/logrotate.d/nginx<br>/etc/nginx<br>/etc/nginx/conf.d<br>/etc/nginx/conf.d/default.conf<br>/etc/nginx/fastcgi_params<br>/etc/nginx/koi-utf<br>/etc/nginx/koi-win<br>/etc/nginx/mime.types<br>/etc/nginx/modules<br>/etc/nginx/nginx.conf<br>/etc/nginx/scgi_params<br>/etc/nginx/uwsgi_params<br>/etc/nginx/win-utf<br>/etc/sysconfig/nginx<br>/etc/sysconfig/nginx-debug<br>/usr/lib/.build-id<br>/usr/lib/.build-id/72<br>/usr/lib/.build-id/72/32b3d274d95e3739c1690a6344d3aac4c6272b<br>/usr/lib/.build-id/7f<br>/usr/lib/.build-id/7f/0259e101e7ab850dee7e6ac2907ac62f6f5917<br>/usr/lib/systemd/system/nginx-debug.service<br>/usr/lib/systemd/system/nginx.service<br>/usr/lib64/nginx<br>/usr/lib64/nginx/modules<br>/usr/libexec/initscripts/legacy-actions/nginx<br>/usr/libexec/initscripts/legacy-actions/nginx/check-reload<br>/usr/libexec/initscripts/legacy-actions/nginx/upgrade<br>/usr/sbin/nginx<br>/usr/sbin/nginx-debug<br>/usr/share/doc/nginx-1.18.0<br>/usr/share/doc/nginx-1.18.0/COPYRIGHT<br>/usr/share/man/man8/nginx.8.gz<br>/usr/share/nginx<br>/usr/share/nginx/html<br>/usr/share/nginx/html/50x.html<br>/usr/share/nginx/html/index.html<br>/var/cache/nginx<br>/var/<span class="hljs-built_in">log</span>/nginx<br></code></pre></td></tr></table></figure><h5 id="1-4-1-4-Nginx-程序用法帮助"><a href="#1-4-1-4-Nginx-程序用法帮助" class="headerlink" title="1.4.1.4 Nginx 程序用法帮助"></a>1.4.1.4 Nginx 程序用法帮助</h5><p>使用安装完成的二进制文件nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">nginx -h<br>nginx version: nginx/1.18.0<br>Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]<br>Options:<br> -?,-h     : this <span class="hljs-built_in">help</span><br> -v      : show version and <span class="hljs-built_in">exit</span><br> -V      : show version and configure options <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span> <span class="hljs-comment">#显示版本和编译参数</span><br> -t      : <span class="hljs-built_in">test</span> configuration and <span class="hljs-built_in">exit</span> <span class="hljs-comment">#测试配置文件是否异常</span><br> -T      : <span class="hljs-built_in">test</span> configuration, dump it and <span class="hljs-built_in">exit</span> <span class="hljs-comment">#测试并打印</span><br> -q      : suppress non-error messages during configuration testing <span class="hljs-comment">#静默模式</span><br> -s signal   : send signal to a master process: stop, quit, reopen, reload <span class="hljs-comment">#发送信号,reload信号 会生成新的worker,但master不会重新生成</span><br> -p prefix   : <span class="hljs-built_in">set</span> prefix path (default: /etc/nginx/) <span class="hljs-comment">#指定Nginx 目录</span><br> -c filename  : <span class="hljs-built_in">set</span> configuration file (default: /etc/nginx/nginx.conf)<br><span class="hljs-comment">#配置文件路径</span><br> -g directives : <span class="hljs-built_in">set</span> global directives out of configuration file<span class="hljs-comment">#设置全局指令,注意和配置文件不要同时配置,否则冲突</span><br></code></pre></td></tr></table></figure><p>范例: nginx 命令使用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">nginx -g <span class="hljs-string">&quot;worker_processes 6;&quot;</span><br>nginx: [emerg] <span class="hljs-string">&quot;worker_processes&quot;</span> directive is duplicate <span class="hljs-keyword">in</span><br>/apps/nginx/conf/nginx.conf:3<br><br>vim /apps/nginx/conf/nginx.conf<br><span class="hljs-comment">#worker_processes 1;</span><br><br>nginx -g <span class="hljs-string">&quot;worker_processes 6;&quot;</span><br>ps aux|grep nginx<br>root     8843  0.0  0.0  41048  844 ?    Ss  18:53  0:00 nginx: master<br>process nginx -g worker_processes 6;<br>nginx    8844  0.0  0.4  74572  4832 ?    S   18:53  0:00 nginx: worker<br>process<br>nginx    8845  0.0  0.4  74572  4832 ?    S   18:53  0:00 nginx: worker<br>process<br>nginx    8846  0.0  0.4  74572  4832 ?    S   18:53  0:00 nginx: worker<br>process<br>nginx    8847  0.0  0.4  74572  4832 ?    S   18:53  0:00 nginx: worker<br>process<br>nginx    8848  0.0  0.4  74572  4832 ?    S   18:53  0:00 nginx: worker<br>process<br>nginx    8849  0.0  0.4  74572  4832 ?    S   18:53  0:00 nginx: worker<br>process<br>root     8851  0.0  0.1  12108  1076 pts/1  S+  18:53  0:00 grep --<br>color=auto nginx<br><br>nginx -s quit<br>ps aux|grep nginx<br>root     8858  0.0  0.1  12108  1100 pts/1  S+  18:54  0:00 grep --<br>color=auto nginx<br><br><span class="hljs-comment">#前台运行</span><br>nginx -g <span class="hljs-string">&#x27;daemon off;&#x27;</span><br></code></pre></td></tr></table></figure><h5 id="1-4-1-5-验证-Nginx"><a href="#1-4-1-5-验证-Nginx" class="headerlink" title="1.4.1.5 验证 Nginx"></a>1.4.1.5 验证 Nginx</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">nginx -t<br>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok<br>nginx: configuration file /etc/nginx/nginx.conf <span class="hljs-built_in">test</span> is successful<br><br>nginx -V<br>nginx version: nginx/1.18.0<br>built by gcc 8.3.1 20190507 (Red Hat 8.3.1-4) (GCC)<br>built with OpenSSL 1.1.1c FIPS  28 May 2019<br>TLS SNI support enabled<br>configure arguments: --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-<br>path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-<br>path=/var/<span class="hljs-built_in">log</span>/nginx/error.log --http-log-path=/var/<span class="hljs-built_in">log</span>/nginx/access.log --pid-<br>path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-<br>path=/var/cache/nginx/client_temp --http-proxy-temp-<br>path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-<br>path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-<br>path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-<br>path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail<br>--with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=<span class="hljs-string">&#x27;-O2 -g -pipe -</span><br><span class="hljs-string">Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -</span><br><span class="hljs-string">specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -fPIC&#x27;</span> --with-ld-opt=<span class="hljs-string">&#x27;-Wl,-z,relro -Wl,-z,now -pie&#x27;</span><br></code></pre></td></tr></table></figure><h5 id="1-4-1-6-Nginx-启动文件"><a href="#1-4-1-6-Nginx-启动文件" class="headerlink" title="1.4.1.6 Nginx 启动文件"></a>1.4.1.6 Nginx 启动文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat /usr/lib/systemd/system/nginx.service<br>[Unit]<br>Description=nginx - high performance web server<br>Documentation=http://nginx.org/en/docs/<br>After=network-online.target remote-fs.target nss-lookup.target<br>Wants=network-online.target<br>[Service]<br>Type=forking<br>PIDFile=/var/run/nginx.pid<br>ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf<br>ExecReload=/bin/<span class="hljs-built_in">kill</span> -s HUP <span class="hljs-variable">$MAINPID</span><br>ExecStop=/bin/<span class="hljs-built_in">kill</span> -s TERM <span class="hljs-variable">$MAINPID</span><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure><h5 id="1-4-1-7-Nginx-配置文件"><a href="#1-4-1-7-Nginx-配置文件" class="headerlink" title="1.4.1.7 Nginx 配置文件"></a>1.4.1.7 Nginx 配置文件</h5><p>范例: 查看配置文件列表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -qc nginx<br>/etc/logrotate.d/nginx<br>/etc/nginx/conf.d/default.conf<br>/etc/nginx/fastcgi_params<br>/etc/nginx/koi-utf<br>/etc/nginx/koi-win<br>/etc/nginx/mime.types<br>/etc/nginx/nginx.conf<br>/etc/nginx/scgi_params<br>/etc/nginx/uwsgi_params<br>/etc/nginx/win-utf<br>/etc/sysconfig/nginx<br>/etc/sysconfig/nginx-debug<br><br>cat /etc/sysconfig/nginx<br><span class="hljs-comment"># Configuration file for the nginx service.</span><br><br>NGINX=/usr/sbin/nginx<br>CONFFILE=/etc/nginx/nginx.conf<br><br>tree /etc/nginx/<br>/etc/nginx/<br>├── conf.d<br>│  └── default.conf<br>├── fastcgi_params<br>├── koi-utf<br>├── koi-win<br>├── mime.types<br>├── modules -&gt; ../../usr/lib64/nginx/modules<br>├── nginx.conf<br>├── scgi_params<br>├── uwsgi_params<br>└── win-utf<br>2 directories, 9 files<br></code></pre></td></tr></table></figure><p>范例: 配置文件/etc/nginx/nginx.conf 默认配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">grep</span> -Ev <span class="hljs-string">&quot;^ *#|^$&quot;</span> /etc/nginx/nginx.conf<br>user nginx;<br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><span class="hljs-attribute">error_log</span> /var/log/nginx/error.log <span class="hljs-literal">warn</span>;<br><span class="hljs-attribute">pid</span>    /var/run/nginx.pid;<br><span class="hljs-section">events</span> &#123;<br> <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><span class="hljs-section">http</span> &#123;<br> <span class="hljs-attribute">include</span>    /etc/nginx/mime.types;<br> <span class="hljs-attribute">default_type</span> application/octet-stream;<br> <span class="hljs-attribute">log_format</span> main  <span class="hljs-string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>           <span class="hljs-string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>           <span class="hljs-string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;<br> <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log main;<br> <span class="hljs-attribute">sendfile</span>    <span class="hljs-literal">on</span>;<br> <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br> <span class="hljs-attribute">include</span> /etc/nginx/conf.d/<span class="hljs-regexp">*.conf</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="1-4-1-8-启动-Nginx"><a href="#1-4-1-8-启动-Nginx" class="headerlink" title="1.4.1.8 启动 Nginx"></a>1.4.1.8 启动 Nginx</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">enable</span> --now nginx<br>Created symlink /etc/systemd/system/multi-user.target.wants/nginx.service →<br>/usr/lib/systemd/system/nginx.service.<br><br>[root@centos8 ~]<span class="hljs-comment">#systemctl status nginx</span><br>● nginx.service - nginx - high performance web server<br> Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor<br>preset: disabled)<br> Active: active (running) since Tue 2020-09-22 12:24:19 CST; 4s ago<br>  Docs: http://nginx.org/en/docs/<br>Process: 24584 ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf<br>(code=exited, status=0/SUCCESS)<br>Main PID: 24585 (nginx)<br> Tasks: 2 (<span class="hljs-built_in">limit</span>: 5882)<br> Memory: 2.4M<br> CGroup: /system.slice/nginx.service<br>     ├─24585 nginx: master process /usr/sbin/nginx -c<br>/etc/nginx/nginx.conf<br>     └─24586 nginx: worker process<br>Sep 22 12:24:19 centos8.wangxiaochun.com systemd[1]: Starting nginx - high performance web server...<br>Sep 22 12:24:19 centos8.wangxiaochun.com systemd[1]: Started nginx - high performance web server.<br><br>ps aux|grep nginx<br>root    24585  0.0  0.0  41312  860 ?    Ss  12:24  0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf<br>nginx    24586  0.0  0.5  74896  4884 ?    S   12:24  0:00 nginx: worker process<br>root    24590  0.0  0.1  12108  1088 pts/0  S+  12:24  0:00 grep --color=auto nginx<br><br>pstree -p |grep nginx<br>     |-nginx(24585)---nginx(24586)<br></code></pre></td></tr></table></figure><p>1.4.1.9 访问 Nginx</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-framework8.jpg"></p><h4 id="1-4-2-Nginx-编译安装"><a href="#1-4-2-Nginx-编译安装" class="headerlink" title="1.4.2 Nginx 编译安装"></a>1.4.2 Nginx 编译安装</h4><h5 id="1-4-2-1-编译安装-Nginx"><a href="#1-4-2-1-编译安装-Nginx" class="headerlink" title="1.4.2.1 编译安装 Nginx"></a>1.4.2.1 编译安装 Nginx</h5><p>官方源码包下载地址：</p><p><a href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a></p><p>范例: CentOS编译安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装编译软件</span><br>yum -y install gcc pcre-devel openssl-devel zlib-devel<br><span class="hljs-comment">#创建nginx用户</span><br>useradd -s /sbin/nologin nginx<br><span class="hljs-comment">#下载nginx并解压</span><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/<br>wget https://nginx.org/download/nginx-1.16.1.tar.gz<br>tar xf nginx-1.16.1.tar.gz<br><span class="hljs-built_in">cd</span> nginx-1.16.1/<br><span class="hljs-comment">#创建nginx安装路径</span><br>mkdir -p /apps/nginx<br><span class="hljs-comment">#编译是为了检查系统环境是否符合编译安装的要求，⽐如是否有gcc编译⼯具，是否⽀持编译参数当中的模块，并根据开启的参数等⽣成Makefile⽂件为下⼀步做准备：</span><br>./configure --prefix=/apps/nginx  --with-http_ssl_module \<br>            --with-http_v2_module  \<br>            --with-http_realip_module \<br>            --with-http_addition_module  \<br>            --with-http_image_filter_module \<br>            --with-h ttp_geoip_module \<br>            --with-http_gunzip_module \<br>            --with-http_stub_status_module \<br>            --with-http_gzip_static_module \<br>            --with-pcre \<br>            --with-stream \<br>            --with-stream_ssl_module \<br>            --with-stream_realip_module <br>            ......<br><br>make <span class="hljs-comment">#编译步骤，根据Makefile⽂件⽣成相应的模块</span><br>make install <span class="hljs-comment">#创建⽬录，并将⽣成的模块和⽂件复制到相应的⽬录</span><br><span class="hljs-comment">#修改权限</span><br>chown nginx.nginx -R /apps/nginx/<br></code></pre></td></tr></table></figure><p>范例:Ubuntu编译安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/<br>wget https://nginx.org/download/nginx-1.16.1.tar.gz<br>tar xf nginx-1.16.1.tar.gz<br><span class="hljs-built_in">cd</span> nginx-1.16.1/<br>apt install  libgd-dev libgeoip-dev -y<br>mkdir -p /apps/nginx<br>编译是为了检查系统环境是否符合编译安装的要求，⽐如是否有gcc编译⼯具，是否⽀持编译参数当中的模块，并根据开启的参数等⽣成Makefile⽂件为下⼀步做准备：<br>./configure --prefix=/apps/nginx  --with-http_ssl_module \<br>            --with-http_v2_module  \<br>            --with-http_realip_module \<br>            --with-http_addition_module  \<br>            --with-http_image_filter_module \<br>            --with-h ttp_geoip_module \<br>            --with-http_gunzip_module \<br>            --with-http_stub_status_module \<br>            --with-http_gzip_static_module \<br>            --with-pcre \<br>            --with-stream \<br>            --with-stream_ssl_module \<br>            --with-stream_realip_module <br>.....<br>make <span class="hljs-comment">#编译步骤，根据Makefile⽂件⽣成相应的模块</span><br>make install <span class="hljs-comment">#创建⽬录，并将⽣成的模块和⽂件复制到相应的⽬录：</span><br>addgroup --gid 2019 nginx<br>useradd -m -r -s /bin/bash -u 2019 -g 2019 nginx <span class="hljs-comment">#以普通⽤⼾启动nginx</span><br><span class="hljs-comment">#修改权限</span><br>chown nginx.nginx -R /apps/nginx/<br></code></pre></td></tr></table></figure><p>nginx完成安装以后，有四个主要的目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#生成目录</span><br>[root@centos8 nginx-1.18.0]<span class="hljs-comment">#ll /apps/nginx/</span><br>total 0<br>drwxr-xr-x 2 root root 333 Sep 22 12:49 conf<br>drwxr-xr-x 2 root root  40 Sep 22 12:49 html<br>drwxr-xr-x 2 root root  6 Sep 22 12:49 logs<br>drwxr-xr-x 2 root root  19 Sep 22 12:49 sbin<br>conf：保存nginx所有的配置文件，其中nginx.conf是nginx服务器的最核心最主要的配置文件，其他的.conf则是用来配置nginx相关的功能的，例如fastcgi功能使用的是fastcgi.conf和fastcgi_params两个文件，配置文件一般都有个样板配置文件，是文件名.default结尾，使用的使用将其<br>复制为并将default去掉即可。<br>html目录中保存了nginx服务器的web文件，但是可以更改为其他目录保存web文件,另外还有一个50x的web文件是默认的错误页面提示页面。<br>logs：用来保存nginx服务器的访问日志错误日志等日志，logs目录可以放在其他路径，比如/var/logs/nginx里面。<br>sbin：保存nginx二进制启动脚本，可以接受不同的参数以实现不同的功能。<br></code></pre></td></tr></table></figure><h5 id="1-4-2-2-验证版本及编译参数"><a href="#1-4-2-2-验证版本及编译参数" class="headerlink" title="1.4.2.2 验证版本及编译参数"></a>1.4.2.2 验证版本及编译参数</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs BASH">ls /apps/nginx/sbin/<br>nginx<br>ln -s /apps/nginx/sbin/nginx /usr/sbin/<br><br><span class="hljs-comment">#查看版本</span><br>nginx -v<br>nginx version: nginx/1.16.1<br><br><span class="hljs-comment">#centos查看编译参数</span><br>nginx -V<br>nginx version: nginx/1.16.1<br>built by gcc 8.3.1 20191121 (Red Hat 8.3.1-5) (GCC)<br>built with OpenSSL 1.1.1c FIPS  28 May 2019<br>TLS SNI support enabled<br>configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-<br>http_ssl_module --with-http_v2_module --with-http_realip_module --with-<br>http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream--with-stream_ssl_module --with-stream_realip_module<br><br><span class="hljs-comment">#ubuntu查看编译参数</span><br>nginx -V<br>nginx version: nginx/1.16.1<br>built by gcc 7.5.0 (Ubuntu 7.5.0-3ubuntu1~18.04) <br>built with OpenSSL 1.1.1  11 Sep 2018<br>TLS SNI support enabled<br>configure arguments: --prefix=/apps/nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_image_filter_module --with-http_geoip_module --with-http_gunzip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module<br></code></pre></td></tr></table></figure><h5 id="1-4-2-3-启动和停止-nginx-测试访问-web-界面"><a href="#1-4-2-3-启动和停止-nginx-测试访问-web-界面" class="headerlink" title="1.4.2.3 启动和停止 nginx 测试访问 web 界面"></a>1.4.2.3 启动和停止 nginx 测试访问 web 界面</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启动nginx</span><br>nginx<br><br><span class="hljs-comment">#浏览器可以访问看到下面图示</span><br>ss -ntl<br>State       Recv-Q      Send-Q   Local Address:Port  Peer<br>Address:Port     <br>LISTEN       0         100       127.0.0.1:25    <br> 0.0.0.0:*       <br>LISTEN       0         128        0.0.0.0:80    <br> 0.0.0.0:*       <br>LISTEN       0         128        0.0.0.0:22    <br> 0.0.0.0:*  <br> LISTEN       0         100         [::1]:25      <br>[::]:*       <br>LISTEN       0         128         [::]:22      <br>[::]:*<br><br><span class="hljs-comment">#关闭nginx</span><br>nginx -s stop<br><span class="hljs-comment">#ss -ntl</span><br>State       Recv-Q      Send-Q  Local Address:Port  Peer<br>Address:Port     <br>LISTEN       0         100      127.0.0.1:25    <br> 0.0.0.0:*       <br>LISTEN       0         128       0.0.0.0:22    <br> 0.0.0.0:*       <br>LISTEN       0         100        [::1]:25      <br>[::]:*       <br>LISTEN       0         128        [::]:22      <br>[::]:*  <br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-framework8.jpg"></p><h5 id="1-4-2-4-创建-Nginx-自启动文件"><a href="#1-4-2-4-创建-Nginx-自启动文件" class="headerlink" title="1.4.2.4 创建 Nginx 自启动文件"></a>1.4.2.4 创建 Nginx 自启动文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#复制同一版本的nginx的yum安装生成的service文件</span><br>vim /usr/lib/systemd/system/nginx.service<br>[Unit]<br>Description=nginx - high performance web server<br>Documentation=http://nginx.org/en/docs/<br>After=network-online.target remote-fs.target nss-lookup.target<br>Wants=network-online.target<br>[Service]<br>Type=forking<br>PIDFile=/apps/nginx/run/nginx.pid<br>ExecStart=/apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf<br>ExecReload=/bin/<span class="hljs-built_in">kill</span> -s HUP <span class="hljs-variable">$MAINPID</span><br>ExecStop=/bin/<span class="hljs-built_in">kill</span> -s TERM <span class="hljs-variable">$MAINPID</span><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment">#创建目录</span><br>mkdir /apps/nginx/run/<br><br><span class="hljs-comment">#修改配置文件</span><br>vim /apps/nginx/conf/nginx.conf<br>pid  /apps/nginx/run/nginx.pid;<br></code></pre></td></tr></table></figure><h5 id="1-4-2-5-验证-Nginx-自启动文件"><a href="#1-4-2-5-验证-Nginx-自启动文件" class="headerlink" title="1.4.2.5 验证 Nginx 自启动文件"></a>1.4.2.5 验证 Nginx 自启动文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> --now nginx<br>Created symlink /etc/systemd/system/multi-user.target.wants/nginx.service → <br><br>ll /apps/nginx/run/<br>total 4<br>-rw-r--r-- 1 root root 5 Sep 22 13:01 nginx.pid<br><br>ss -ntl<br>State       Recv-Q      Send-Q Local Address:Port  Peer<br>Address:Port     <br>LISTEN       0         100     127.0.0.1:25      0.0.0.0:*<br>      <br>LISTEN       0         128      0.0.0.0:80      0.0.0.0:*<br>      <br>LISTEN       0         128      0.0.0.0:22      0.0.0.0:*<br>      <br>LISTEN       0         100       [::1]:25       [::]:*<br>      <br>LISTEN       0         128       [::]:22       [::]:*<br><br>systemctl stop nginx<br><br>systemctl status nginx<br>● nginx.service - The nginx HTTP and reverse proxy server<br> Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor<br>preset: disabled)<br> Active: inactive (dead) since Tue 2020-09-22 13:01:49 CST; 1s ago<br>Process: 8113 ExecStart=/apps/nginx/sbin/nginx (code=exited, status=0/SUCCESS)<br>Process: 8112 ExecStartPre=/apps/nginx/sbin/nginx -t (code=exited, status=0/SUCCESS)<br>Process: 8110 ExecStartPre=/usr/bin/rm -f /apps/nginx/logs/nginx.pid<br>(code=exited, status=0/SUCCESS)<br>Main PID: 8115 (code=exited, status=0/SUCCESS)<br>Sep 22 12:58:53 centos8.wangxiaochun.com systemd[1]: Starting The nginx HTTP and reverse proxy server...<br>Sep 22 12:58:53 centos8.wangxiaochun.com nginx[8112]: nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>Sep 22 12:58:53 centos8.wangxiaochun.com nginx[8112]: nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>Sep 22 12:58:53 centos8.wangxiaochun.com systemd[1]: Started The nginx HTTP and reverse proxy server.<br>Sep 22 13:01:49 centos8.wangxiaochun.com systemd[1]: Stopping The nginx HTTP and reverse proxy server...<br>Sep 22 13:01:49 centos8.wangxiaochun.com systemd[1]: Stopped The nginx HTTP and reverse proxy server.<br><br>ss -ntl<br>State       Recv-Q      Send-Q  Local Address:Port  Peer<br>Address:Port     <br>LISTEN       0         100     127.0.0.1:25      0.0.0.0:*<br>      <br>LISTEN       0         128      0.0.0.0:22      0.0.0.0:*<br>      <br>LISTEN       0         100       [::1]:25       [::]:*<br>      <br>LISTEN       0         128       [::]:22       [::]:*<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Linux Nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nginx核心配置</title>
    <link href="/blog/2021/02/27/Nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/"/>
    <url>/blog/2021/02/27/Nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="Nginx核心配置"><a href="#Nginx核心配置" class="headerlink" title="Nginx核心配置"></a>Nginx核心配置</h1><h2 id="一、Nginx文件配置说明"><a href="#一、Nginx文件配置说明" class="headerlink" title="一、Nginx文件配置说明"></a>一、Nginx文件配置说明</h2><h3 id="1-1-Nginx官方帮助文档"><a href="#1-1-Nginx官方帮助文档" class="headerlink" title="1.1 Nginx官方帮助文档"></a>1.1 Nginx官方帮助文档</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://nginx.org/en/docs/<br></code></pre></td></tr></table></figure><h3 id="1-2-tengine-帮助文档"><a href="#1-2-tengine-帮助文档" class="headerlink" title="1.2 tengine 帮助文档"></a>1.2 tengine 帮助文档</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://tengine.taobao.org/nginx_docs/cn/docs/<br></code></pre></td></tr></table></figure><h3 id="1-3-Nginx的配置文件组成部分"><a href="#1-3-Nginx的配置文件组成部分" class="headerlink" title="1.3 Nginx的配置文件组成部分"></a>1.3 Nginx的配置文件组成部分</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stata">主配置文件：nginx.<span class="hljs-keyword">conf</span><br>子配置文件: <span class="hljs-keyword">include</span> <span class="hljs-keyword">conf</span>.<span class="hljs-keyword">d</span><span class="hljs-comment">/*.conf</span><br><span class="hljs-comment">fastcgi， uwsgi，scgi 等协议相关的配置文件</span><br><span class="hljs-comment">nternet Mail Extensions)多用途互联网</span><br><span class="hljs-comment">邮件扩展类型，MIME消息能包含文本、图像、音频、视频以及其他应用程序专用的数据，是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。</span><br></code></pre></td></tr></table></figure><p>MIME参考文档： <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types</a></p><p>Nginx 主配置文件的配置指令方式</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">directive</span> value [value2 ...];<br><span class="hljs-comment">#注意</span><br>(1) 指令必须以分号结尾<br>(2) 支持使用配置变量<br>内建变量：由Nginx模块引入，可直接引用<br>自定义变量：由用户使用set命令定义,格式: <span class="hljs-attribute">set</span> variable_name value;<br>引用变量：$variable_name<br></code></pre></td></tr></table></figure><p>主配置文件结构：四部分</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">main block：主配置段，即全局配置段，对http,mail都有效<br><span class="hljs-comment">#事件驱动相关的配置</span><br>event &#123;<br>...<br>&#125; <br><span class="hljs-comment">#http/https 协议相关配置段</span><br>http &#123;<br>...<br>&#125;     <br><span class="hljs-comment">#默认配置文件不包括下面两个块</span><br><span class="hljs-comment">#mail 协议相关配置段</span><br>mail &#123;<br>...<br>&#125;  <br><span class="hljs-comment">#stream 服务器相关配置段</span><br>stream &#123;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>默认的nginx.conf 配置文件格式说明</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#全局配置端，对全局生效，主要设置nginx的启动用户/组，启动的工作进程数量，工作模式，Nginx的PID路径，日志路径等。</span><br>user nginx nginx;<br>worker_processes  1;  <span class="hljs-comment">#启动工作进程数数量</span><br>events &#123; <span class="hljs-comment">#events设置快，主要影响nginx服务器与用户的网络连接，比如是否允许同时接受多个网络连接，使用哪种事件驱动模型处理请求，每个工作进程可以同时支持的最大连接数，是否开启对多工作进程下的网络连接进行序列化等。</span><br>  worker_connections  1024;  <span class="hljs-comment">#设置单个nginx工作进程可以接受的最大并发，作为web服务器的时候最大并发数为worker_connections * worker_processes，作为反向代理的时候为(worker_connections * worker_processes)/2</span><br>&#125;<br>http &#123; <span class="hljs-comment">#http块是Nginx服务器配置中的重要部分，缓存、代理和日志格式定义等绝大多数功能和第三方模块都可以在这设置，http块可以包含多个server块，而一个server块中又可以包含多个location块，server块可以配置文件引入、MIME-Type定义、日志自定义、是否启用sendfile、连接超时时间和单个链接的请求上限等。</span><br> include    mime.types;<br> default_type application/octet-stream;<br> sendfile    on; <span class="hljs-comment">#作为web服务器的时候打开sendfile加快静态文件传输，指定是否使用sendfile系统调用来传输文件,sendfile系统调用在两个文件描述符之间直接传递数据(完全在内核中操作)，从而避免了数据在内核缓冲区和用户缓冲区之间的拷贝，操作效率很高，被称之为零拷贝，硬盘 &gt;&gt;kernel buffer (快速拷贝到kernelsocket buffer) &gt;&gt;协议栈。</span><br> keepalive_timeout  65;  <span class="hljs-comment">#长连接超时时间，单位是秒</span><br> server &#123; <span class="hljs-comment">#设置一个虚拟机主机，可以包含自己的全局快，同时也可以包含多个location模块。比如本虚拟机监听的端口、本虚拟机的名称和IP配置，多个server 可以使用一个端口，比如都使用80端口提供web服务、</span><br>   listen    80;  <span class="hljs-comment">#配置server监听的端口</span><br>   server_name localhost; <span class="hljs-comment">#本server的名称，当访问此名称的时候nginx会调用当前serevr内部的配置进程匹配。</span><br>   location / &#123; <span class="hljs-comment">#location其实是server的一个指令，为nginx服务器提供比较多而且灵活的指令，都是在location中体现的，主要是基于nginx接受到的请求字符串，对用户请求的UIL进行匹配，并对特定的指令进行处理，包括地址重定向、数据缓存和应答控制等功能都是在这部分实现，另外很多第三方模块的配置也是在location模块中配置。</span><br>     root  html; <span class="hljs-comment">#相当于默认页面的目录名称，默认是安装目录的相对路径，可以使用绝对路径配置。</span><br>     index index.html index.htm; <span class="hljs-comment">#默认的页面文件名称</span><br>   &#125;<br>   error_page  500 502 503 504 /50x.html; <span class="hljs-comment">#错误页面的文件名称</span><br>   location = /50x.html &#123; <span class="hljs-comment">#location处理对应的不同错误码的页面定义到/50x.html，这个跟对应其server中定义的目录下。</span><br>     root  html;  <span class="hljs-comment">#定义默认页面所在的目录</span><br>   &#125;<br> &#125;<br> <br><span class="hljs-comment">#和邮件相关的配置</span><br><span class="hljs-comment">#mail &#123;</span><br><span class="hljs-comment">#        ...</span><br><span class="hljs-comment">#    &#125;     mail 协议相关配置段</span><br><br><span class="hljs-comment">#tcp代理配置，1.9版本以上支持</span><br><span class="hljs-comment">#stream &#123;</span><br><span class="hljs-comment">#        ...</span><br><span class="hljs-comment">#    &#125;    stream 服务器相关配置段</span><br><br><span class="hljs-comment">#导入其他路径的配置文件</span><br><span class="hljs-comment">#include /apps/nginx/conf.d/*.conf</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-4-全局配置"><a href="#1-4-全局配置" class="headerlink" title="1.4 全局配置"></a>1.4 全局配置</h3><p>Main 全局配置段常见的配置指令分类</p><ul><li>正常运行必备的配置</li><li>优化性能相关的配置</li><li>用于调试及定位问题相关的配置</li><li>事件驱动相关的配置</li></ul><p>全局配置说明：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">user</span> nginx nginx; <span class="hljs-comment">#启动Nginx工作进程的用户和组</span><br><span class="hljs-attribute">worker_processes</span> [number | auto]; <span class="hljs-comment">#启动Nginx工作进程的数量,一般设为和CPU核心数相同</span><br><span class="hljs-attribute">worker_cpu_affinity</span> <span class="hljs-number">00000001</span> <span class="hljs-number">00000010</span> <span class="hljs-number">00000100</span> <span class="hljs-number">00001000</span>; <span class="hljs-comment">#将Nginx工作进程绑定到指定的CPU核心，默认Nginx是不进行进程绑定的，绑定并不是意味着当前nginx进程独占以一核心CPU，但是可以保证此进程不会运行在其他核心上，这就极大减少了nginx的工作进程在不同的cpu核心上的来回跳转，减少了CPU对进程的资源分配与回收以及内存管理等，因此可以有效的提升nginx服务器的性能。</span><br><span class="hljs-attribute">CPU</span> MASK: <span class="hljs-number">00000001</span>：<span class="hljs-number">0</span>号CPU<br>          <span class="hljs-number">00000010</span>：<span class="hljs-number">1</span>号CPU<br>                       <span class="hljs-number">10000000</span>：<span class="hljs-number">7</span>号CPU<br><span class="hljs-comment">#示例:</span><br>worker_cpu_affinity <span class="hljs-number">0001</span> <span class="hljs-number">0010</span> <span class="hljs-number">0100</span> <span class="hljs-number">1000</span>;第0号---第3号<span class="hljs-attribute">CPU</span><br>worker_cpu_affinity <span class="hljs-number">0101</span> <span class="hljs-number">1010</span><br><br><span class="hljs-comment">#示例</span><br>worker_processes  <span class="hljs-number">4</span>;<br><span class="hljs-attribute">worker_cpu_affinity</span> <span class="hljs-number">00000010</span> <span class="hljs-number">00001000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">10000000</span>;<br><span class="hljs-attribute">ps</span> axo pid,cmd,psr | grep nginx<br><span class="hljs-number">31093</span> nginx: master process /apps  <span class="hljs-number">1</span><br><span class="hljs-number">34474</span> nginx: worker process     <span class="hljs-number">1</span><br><span class="hljs-number">34475</span> nginx: worker process     <span class="hljs-number">3</span><br><span class="hljs-number">34476</span> nginx: worker process     <span class="hljs-number">5</span><br><span class="hljs-number">34477</span> nginx: worker process     <span class="hljs-number">7</span><br><span class="hljs-number">35751</span> grep nginx<br><br><span class="hljs-comment">#错误日志记录配置，语法：error_log file [debug | info | notice | warn | error |crit | alert | emerg]</span><br><span class="hljs-comment">#error_log logs/error.log;</span><br><span class="hljs-comment">#error_log logs/error.log notice;</span><br>error_log /apps/nginx/logs/error.log <span class="hljs-literal">error</span>;<br><br><span class="hljs-comment">#pid文件保存路径</span><br><span class="hljs-attribute">pid</span>    /apps/nginx/logs/nginx.pid;<br><span class="hljs-attribute">worker_priority</span> <span class="hljs-number">0</span>; <span class="hljs-comment">#工作进程优先级，-20~20(19) 一般不用配</span><br><span class="hljs-attribute">worker_rlimit_nofile</span> <span class="hljs-number">65536</span>; <span class="hljs-comment">#所有worker进程能打开的文件数量上限,包括:Nginx的所有连接（例如与代理服务器的连接等），而不仅仅是与客户端的连接,另一个考虑因素是实际的并发连接数不能超过系统级别的最大打开文件数的限制.最好与ulimit -n 或者limits.conf的值保持一致,</span><br><span class="hljs-comment">#修改pam限制</span><br><span class="hljs-attribute">cat</span> /etc/security/limits.conf<br>*        soft  nofile      <span class="hljs-number">1000000</span><br>*        hard  nofile      <span class="hljs-number">1000000</span><br><br>watch -n1 <span class="hljs-string">&#x27;ps -axo pid,cmd,nice | grep nginx #验证进程优先级</span><br><span class="hljs-string"></span><br><span class="hljs-string">daemon off;  #前台运行Nginx服务用于测试、docker等环境。一般不用配</span><br><span class="hljs-string">master_process off|on; #是否开启Nginx的master-worker工作模式，仅用于开发调试场景,默认为on</span><br><span class="hljs-string"></span><br><span class="hljs-string">events &#123;</span><br><span class="hljs-string"> worker_connections  65536;  #设置单个工作进程的最大并发连接数</span><br><span class="hljs-string"> use epoll; #使用epoll事件驱动，Nginx支持众多的事件驱动，比如:select、poll、epoll，只能设置在events模块中设置。</span><br><span class="hljs-string"> accept_mutex on; #on为同一时刻一个请求轮流由work进程处理,而防止被同时唤醒所有worker,避免多个睡眠进程被唤醒的设置，默认为off，新请求会唤醒所有worker进程,此过程也称为&quot;惊群&quot;，因此nginx刚安装完以后要进行适当的优化。建议设置为on</span><br><span class="hljs-string"> multi_accept on; #ON时Nginx服务器的每个工作进程可以同时接受多个新的网络连接，此指令默认为off，即默认为一个工作进程只能一次接受一个新的网络连接，打开后几个同时接受多个。建议设置为on</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure><p>范例：实现nginx的搞并发配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ulimit</span> -n 102400<br><span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>;<span class="hljs-keyword">do</span> ab -c 5000 -n 10000 http://10.0.0.8/;sleep 0.5;<span class="hljs-keyword">done</span><br><br><span class="hljs-comment">#默认配置不支持高并发,会出现以下错误日志</span><br>tail /apps/nginx/logs/error.log<br>2020/09/24 21:19:33 [crit] 41006<span class="hljs-comment">#0: *1105860 open() &quot;/apps/nginx/html/50x.html&quot;failed (24: Too many open files), client: 10.0.0.7, server: localhost, request:&quot;GET / HTTP/1.0&quot;, host: &quot;10.0.0.8&quot;</span><br>2020/09/24 21:19:33 [crit] 41006<span class="hljs-comment">#0: accept4() failed (24: Too many open files)</span><br>2020/09/24 21:19:33 [crit] 41006<span class="hljs-comment">#0: *1114177 open()</span><br><span class="hljs-string">&quot;/apps/nginx/html/index.html&quot;</span> failed (24: Too many open files), client:<br>10.0.0.7, server: localhost, request: <span class="hljs-string">&quot;GET / HTTP/1.0&quot;</span>, host: <span class="hljs-string">&quot;10.0.0.8&quot;</span><br><br><span class="hljs-comment">#修改配置</span><br>vim /etc/security/limits.conf<br>*  - nproc 100000<br><br>vim /apps/nginx/conf/nginx.conf<br>worker_rlimit_nofile 100000;<br><br>systemctl restart nginx<br></code></pre></td></tr></table></figure><h3 id="1-5-http配置块"><a href="#1-5-http配置块" class="headerlink" title="1.5 http配置块"></a>1.5 http配置块</h3><p>http 协议相关的配置结构</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">http</span> &#123;<br>    ...;<br>    ...;  <span class="hljs-comment">#各server的公共配置</span><br>    <span class="hljs-section">server</span> &#123;   <span class="hljs-comment">#每个server用于定义一个虚拟主机,第一个server为默认虚拟服务器</span><br>        ...;<br>&#125;<br>    <span class="hljs-section">server</span> &#123;  <br>        ...;<br>        <span class="hljs-attribute">server_name</span> ; <span class="hljs-comment">#虚拟主机名</span><br>        <span class="hljs-attribute">root</span> ;  <span class="hljs-comment">#主目录</span><br>        <span class="hljs-attribute">alias</span> ;   <span class="hljs-comment">#路径别名</span><br>        <span class="hljs-attribute">location</span> [OPERATOR] URL &#123;   <span class="hljs-comment">#指定URL的特性</span><br>            ...;<br>            <span class="hljs-attribute">if</span> CONDITION &#123;<br>                ...;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>http 协议配置说明</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">http</span> &#123;<br> <span class="hljs-attribute">include</span>    mime.types; <span class="hljs-comment">#导入支持的文件类型,是相对于/apps/nginx/conf的目录</span><br> <span class="hljs-attribute">default_type</span> application/octet-stream; <span class="hljs-comment">#除mime.types中文件类型外,设置其它文件默认类型，访问其它类型时会提示下载不匹配的类型文件</span><br><span class="hljs-comment">#日志配置部分</span><br>  <span class="hljs-comment">#log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>  <span class="hljs-comment">#         &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>  <span class="hljs-comment">#         &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br>  <span class="hljs-comment">#access_log logs/access.log main;</span><br><span class="hljs-comment">#自定义优化参数</span><br> <span class="hljs-attribute">sendfile</span>    <span class="hljs-literal">on</span>;<br>  <span class="hljs-comment">#tcp_nopush   on; #在开启了sendfile的情况下，合并请求后统一发送给客户端。</span><br>  <span class="hljs-comment">#tcp_nodelay  off; #在开启了keepalived模式下的连接是否启用TCP_NODELAY选项，当为off时，延迟0.2s发送，默认On时，不延迟发送，立即发送用户响应报文。</span><br>  <span class="hljs-comment">#keepalive_timeout 0;</span><br> <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span> <span class="hljs-number">65</span>; <span class="hljs-comment">#设置会话保持时间,第二个值为响应首部:keep-Alived:timeout=65,可以和第一个值不同</span><br>  <span class="hljs-comment">#gzip on; #开启文件压缩</span><br> <span class="hljs-section">server</span> &#123;<br>   <span class="hljs-attribute">listen</span>    <span class="hljs-number">80</span>; <span class="hljs-comment">#设置监听地址和端口</span><br>   <span class="hljs-attribute">server_name</span> localhost; <span class="hljs-comment">#设置server name，可以以空格隔开写多个并支持正则表达式，如:*.magedu.com www.magedu.* ~^www\d+\.magedu\.com$ default_server</span><br>    <span class="hljs-comment">#charset koi8-r; #设置编码格式，默认是俄语格式，建议改为utf-8</span><br>    <span class="hljs-comment">#access_log logs/host.access.log main;</span><br>   <span class="hljs-attribute">location</span> / &#123;<br>     <span class="hljs-attribute">root</span>  html;<br>     <span class="hljs-attribute">index</span> index.html index.htm;<br>   &#125;<br>    <span class="hljs-comment">#error_page 404       /404.html;</span><br>    <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span><br>    <span class="hljs-comment">#</span><br>   <span class="hljs-attribute">error_page</span>  <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span> /50x.html; <span class="hljs-comment">#定义错误页面</span><br>   <span class="hljs-attribute">location</span> = /50x.html &#123;<br>     <span class="hljs-attribute">root</span>  html;<br>   &#125;<br>    <span class="hljs-comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#location ~ \.php$ &#123; #以http的方式转发php请求到指定web服务器</span><br>    <span class="hljs-comment">#  proxy_pass  http://127.0.0.1;</span><br>    <span class="hljs-comment">#&#125;</span><br>    <span class="hljs-comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#location ~ \.php$ &#123; #以fastcgi的方式转发php请求到php处理</span><br>    <span class="hljs-comment">#  root      html;</span><br>    <span class="hljs-comment">#  fastcgi_pass  127.0.0.1:9000;</span><br>    <span class="hljs-comment">#  fastcgi_index index.php;</span><br>    <span class="hljs-comment">#  fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;</span><br>    <span class="hljs-comment">#  include    fastcgi_params;</span><br>    <span class="hljs-comment">#&#125;</span><br>    <span class="hljs-comment"># deny access to .htaccess files, if Apache&#x27;s document root</span><br>    <span class="hljs-comment"># concurs with nginx&#x27;s one</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#location ~ /\.ht &#123; #拒绝web形式访问指定文件，如很多的网站都是通过.htaccess文件来改变自己的重定向等功能。</span><br>    <span class="hljs-comment">#  deny all;</span><br>    <span class="hljs-comment">#&#125;</span><br>   <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /passwd.html</span> &#123;<br>     <span class="hljs-attribute">deny</span> all;<br>   &#125;<br> &#125;<br>  <span class="hljs-comment"># another virtual host using mix of IP-, name-, and port-based configuration</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-comment">#server &#123; #自定义虚拟server</span><br>  <span class="hljs-comment">#  listen    8000;</span><br>  <span class="hljs-comment">#  listen    somename:8080;</span><br>  <span class="hljs-comment">#  server_name somename alias another.alias;</span><br>  <span class="hljs-comment">#  location / &#123;</span><br>  <span class="hljs-comment">#    root  html;</span><br>  <span class="hljs-comment">#    index index.html index.htm; #指定默认网页文件，此指令由ngx_http_index_module模块提供</span><br>  <span class="hljs-comment">#  &#125;</span><br>  <span class="hljs-comment">#&#125;</span><br>  <span class="hljs-comment"># HTTPS server</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-comment">#server &#123; #https服务器配置</span><br>  <span class="hljs-comment">#  listen    443 ssl;</span><br>  <span class="hljs-comment">#  server_name localhost;</span><br>  <span class="hljs-comment">#  ssl_certificate   cert.pem;</span><br>  <span class="hljs-comment">#  ssl_certificate_key cert.key;</span><br>  <span class="hljs-comment">#  ssl_session_cache  shared:SSL:1m;</span><br>  <span class="hljs-comment">#  ssl_session_timeout 5m;</span><br>  <span class="hljs-comment">#  ssl_ciphers HIGH:!aNULL:!MD5;</span><br>  <span class="hljs-comment">#  ssl_prefer_server_ciphers on;</span><br>  <span class="hljs-comment">#  location / &#123;</span><br>  <span class="hljs-comment">#    root  html;</span><br>  <span class="hljs-comment">#    index index.html index.htm;</span><br>  <span class="hljs-comment">#  &#125;</span><br>  <span class="hljs-comment">#&#125;</span><br></code></pre></td></tr></table></figure><h4 id="1-5-1-MIME"><a href="#1-5-1-MIME" class="headerlink" title="1.5.1 MIME"></a>1.5.1 MIME</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#在响应报文中将指定的文件扩展名映射至MIME对应的类型</span><br><span class="hljs-attribute">include</span>      /etc/nginx/mime.types;<br><span class="hljs-attribute">default_type</span>   application/octet-stream;<span class="hljs-comment">#除mime.types中的类型外，指定其它文件的默</span><br>认MIME类型，浏览器一般会提示下载<br><span class="hljs-section">types</span> &#123;<br> text/<span class="hljs-attribute">html</span> html;<br> image/<span class="hljs-attribute">gif</span> gif;<br> image/<span class="hljs-attribute">jpeg</span> jpg;<br>&#125;<br><br><span class="hljs-comment">#MIME参考文档</span><br>https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types<br></code></pre></td></tr></table></figure><p>范例：识别php文件为text/html</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">cat</span> /apps/nginx/html/test.php<br>&lt;?php<br>phpinfo();<br>?&gt;<br><br>/apps/nginx/html<span class="hljs-comment"># curl 10.0.0.101/test.php -I</span><br>HTTP/1.1 200 <span class="hljs-attribute">OK</span><br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: Thu, <span class="hljs-number">11</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">30</span>:<span class="hljs-number">25</span> GMT<br>Content-Type: application/octet-stream<br>Content-Length: <span class="hljs-number">20</span><br>Last-Modified: Thu, <span class="hljs-number">11</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">29</span>:<span class="hljs-number">05</span> GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;6024a481-14&quot;</span><br>Accept-Ranges: bytes<br><br>vim /apps/nginx/conf/nginx.conf<br>http &#123;<br> <span class="hljs-attribute">include</span>    mime.types;<br> <span class="hljs-attribute">default_type</span> text/html;<br> ......<br> &#125;<br> <br> /apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br> /apps.nginx/sbin/nginx -s reload<br> <br>/apps/nginx/conf<span class="hljs-comment"># curl 10.0.0.101/test.php -I</span><br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: Thu, <span class="hljs-number">11</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">42</span>:<span class="hljs-number">52</span> GMT<br>Content-Type: text/html<br>Content-Length: <span class="hljs-number">20</span><br>Last-Modified: Thu, <span class="hljs-number">11</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">29</span>:<span class="hljs-number">05</span> GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;6024a481-14&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure><h4 id="指定响应报文server首部"><a href="#指定响应报文server首部" class="headerlink" title="指定响应报文server首部"></a>指定响应报文server首部</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#是否在响应报文中的Content-Type显示指定的字符集，默认off不显示</span><br>charset charset | off;<br><br><span class="hljs-comment">#示例</span><br>charset utf-8;<br><br><span class="hljs-comment">#是否在响应报文的Server首部显示nginx版本</span><br>server_tokens on | off | build | string;<br></code></pre></td></tr></table></figure><p>范例: 修改server字段</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">如果想自定义响应报文的nginx版本信息，需要修改源码文件，重新编译<br>如果server_tokens on，修改 src/core/nginx.h 修改第13-14行，如下示例<br><span class="hljs-comment">#define NGINX_VERSION   &quot;1.68.9&quot;</span><br><span class="hljs-comment">#define NGINX_VER     &quot;wanginx/&quot; NGINX_VERSION</span><br>如果server_tokens off，修改 src/http/ngx_http_header_filter_module.c<br>第49行，如下示例：<br>static char ngx_http_server_string[] = <span class="hljs-string">&quot;Server: nginx&quot;</span> CRLF;<br>把其中的nginx改为自己想要的文字即可,如：wanginx<br></code></pre></td></tr></table></figure><p>范例: 修改 Server 头部信息</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#修改前</span><br><span class="hljs-attribute">curl</span> -I www.rlinpc.net<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: Fri, <span class="hljs-number">12</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">24</span> GMT<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 8<br>Last-Modified: Tue, 09 <span class="hljs-attribute">Feb</span> <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">36</span>:<span class="hljs-number">10</span> GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;6022032a-8&quot;</span><br>Accept-Ranges: bytes<br><br><span class="hljs-comment">#修改版本信息</span><br><span class="hljs-comment">#修改nginx.h文件</span><br>vim /usr/local/src/nginx-<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span>/src/core/nginx.h<br><span class="hljs-comment">#define NGINX_VERSION      &quot;9.99&quot;</span><br><span class="hljs-comment">#define NGINX_VER          &quot;rlin/&quot; NGINX_VERSION</span><br><span class="hljs-comment">#重新编译 (使用nginx -V获取当时编译的参数重新编译一次)</span><br>curl -I www.rlinpc.net<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: rlin/<span class="hljs-number">9</span>.<span class="hljs-number">99</span> <span class="hljs-comment">#这里的Server发生了变化</span><br>Date: Fri, <span class="hljs-number">12</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">02</span>:<span class="hljs-number">14</span>:<span class="hljs-number">15</span> GMT<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 8<br>Last-Modified: Tue, 09 <span class="hljs-attribute">Feb</span> <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">36</span>:<span class="hljs-number">10</span> GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;6022032a-8&quot;</span><br>Accept-Ranges: bytes<br><br><span class="hljs-comment">#修改ngx_http_header_filter_module.c文件</span><br>vim /usr/local/src/nginx-<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span>/src/http/ngx_http_header_filter_module.c<br>static u_char ngx_http_server_string[] = <span class="hljs-string">&quot;Server: rlin-nginx&quot;</span> CRLF;<br><span class="hljs-comment"># 重新编译</span><br><br><span class="hljs-comment">#修改配置文件</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.c/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><br>curl -I www.rlinpc.net<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: rlin-nginx <span class="hljs-comment">#server 发生改变</span><br>Date: Fri, <span class="hljs-number">12</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">02</span>:<span class="hljs-number">23</span>:<span class="hljs-number">55</span> GMT<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 8<br>Last-Modified: Tue, 09 <span class="hljs-attribute">Feb</span> <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">36</span>:<span class="hljs-number">10</span> GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;6022032a-8&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure><h3 id="1-6-核心配置示例"><a href="#1-6-核心配置示例" class="headerlink" title="1.6 核心配置示例"></a>1.6 核心配置示例</h3><p>基于不同的IP、不同的端口以及不用得域名实现不同的虚拟主机，依赖于核心模块<br>ngx_http_core_module实现。</p><h4 id="1-6-1-新建一个-PC-web站点"><a href="#1-6-1-新建一个-PC-web站点" class="headerlink" title="1.6.1 新建一个 PC web站点"></a>1.6.1 新建一个 PC web站点</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#定义子配置文件路径</span><br><span class="hljs-attribute">mkdir</span> /apps/nginx/conf/conf.d<br>vim /apps/nginx/conf/nginx.conf<br>http &#123;<br>  ......;<br>  <span class="hljs-attribute">include</span> /apps/nginx/conf/conf.d/<span class="hljs-regexp">*.conf</span>； <span class="hljs-comment">#在配置文件的最后面添加此行</span><br>&#125;<br><br><span class="hljs-comment">#创建PC网站配置        </span><br>vim /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br>    <br><span class="hljs-attribute">mkdir</span> -p /data/nginx/html/pc<br>echo <span class="hljs-string">&quot;rlin的PC网站&quot;</span> &gt; /data/nginx/html/pc/index.html<br>/apps/nginx/sbin/nginx -t<br>/apps/nginx/sbin/nginx -s reload<br>mkdir -p /data/nginx/html/pc<br>chown -R nginx.nginx /data/nginx/<br><span class="hljs-comment">#访问测试</span><br>Linux访问<br>vim /etc/hosts<br><span class="hljs-comment">#添加</span><br><span class="hljs-number">10.0.0.101</span> www.rlinpc.net<br>curl www.rlinpc.net<br>window浏览器访问（要先将自己网站的地址添加到C:\WINDOWS\System32\drivers\etc\hosts里）<br>如：<br><span class="hljs-number">10.0.0.101</span> www.rlinpc.net<br>浏览器访问 www.rlinpc.net   <br></code></pre></td></tr></table></figure><h4 id="1-6-2-新建一个Mobile-web站点"><a href="#1-6-2-新建一个Mobile-web站点" class="headerlink" title="1.6.2 新建一个Mobile web站点"></a>1.6.2 新建一个Mobile web站点</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /app/snginx/conf/conf.d/mobile.conf<br>server &#123;<br><span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinmobile.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/mobile;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br>&#125;<br><br><span class="hljs-attribute">mkdir</span> -p /data/nginx/html/mobile<br>echo <span class="hljs-string">&quot;rlin mobile web&quot;</span> &gt; /data/nginx/html/mobile/index.html<br>/apps/nginx/sbin/nginx -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinmobile.net</span><br></code></pre></td></tr></table></figure><h4 id="1-6-3-root与alias"><a href="#1-6-3-root与alias" class="headerlink" title="1.6.3 root与alias"></a>1.6.3 root与alias</h4><h5 id="root：指定web的家目录，在定义location的时候，文件的绝对路径等于-root-location，如："><a href="#root：指定web的家目录，在定义location的时候，文件的绝对路径等于-root-location，如：" class="headerlink" title="root：指定web的家目录，在定义location的时候，文件的绝对路径等于 root+location，如："></a>root：指定web的家目录，在定义location的时候，文件的绝对路径等于 root+location，如：</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>&#125;<br>    <span class="hljs-attribute">location</span> /about &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc; <span class="hljs-comment">#必须要在html目录中创建一个about目录才可以访问，否则报错。</span><br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>&#125;<br><br><span class="hljs-attribute">mkdir</span> -p /data/nginx/html/pc/about<br>echo about &gt; /data/nginx/html/pc/about/index.html<br>/apps/nginx/sbin/nginx -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#访问测试</span><br></code></pre></td></tr></table></figure><h5 id="alias：定义路径别名，会把访问的路径重新定义到其指定的路径，如："><a href="#alias：定义路径别名，会把访问的路径重新定义到其指定的路径，如：" class="headerlink" title="alias：定义路径别名，会把访问的路径重新定义到其指定的路径，如："></a>alias：定义路径别名，会把访问的路径重新定义到其指定的路径，如：</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /about &#123; <span class="hljs-comment">#使用alias的时候uri后面如果加了斜杠则下面的路径配置必须加斜杠，否则403</span><br>        <span class="hljs-attribute">alias</span> /data/nginx/html/pc; <span class="hljs-comment">#当访问about的时候，会显示alias定义的/data/nginx/html/pc里面的内容。</span><br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>&#125;<br>重启Nginx并访问测试<br>http://www.rlinpc.net/about/index.<span class="hljs-attribute">html</span> <span class="hljs-comment">#访问指定文件资源</span><br></code></pre></td></tr></table></figure><h3 id="1-7-location的详细使用"><a href="#1-7-location的详细使用" class="headerlink" title="1.7 location的详细使用"></a>1.7 location的详细使用</h3><p>在没有使用正则表达式的时候，nginx会先在server中的多个location选取匹配度最高的一个uri，uri是用户请求的字符串，即域名后面的web文件路径，然后使用该location模块中的正则url和字符串，如果匹配成功就结束搜索，并使用此location处理此请求。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">语法规则： location [=|~|~*|^~] /uri/ &#123; … &#125;<br>=  <span class="hljs-comment">#用于标准uri前，需要请求字串与uri精确匹配，如果匹配成功就停止向下匹配并立即处理请求。</span><br>~  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且区分大小写，并且匹配</span><br>!~  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且区分大小写，并且不匹配</span><br>~*  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且不区分大写，并且匹配</span><br>!~* <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且不区分大小写,并且不匹配</span><br>^~  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且匹配以什么开头</span><br>$  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且匹配以什么结尾</span><br>\  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且转义字符。可以转. * ?等</span><br>*  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且代表任意长度的任意字符</span><br></code></pre></td></tr></table></figure><h4 id="1-7-1-匹配案例-精确匹配"><a href="#1-7-1-匹配案例-精确匹配" class="headerlink" title="1.7.1 匹配案例-精确匹配"></a>1.7.1 匹配案例-精确匹配</h4><p>在server部分使用location配置一个web界面，要求：当访问nginx 服务器的/login的时候要显示指定html文件的内容<br>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server  &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br>    <span class="hljs-attribute">location</span> = /<span class="hljs-number">1</span>.jpg&#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/static;<br>    &#125;<br>&#125;<br><br><span class="hljs-attribute">mkdir</span> /data/nginx/static/<br>cd /data/nginx/static/<br><span class="hljs-comment">#存放一个1.jpg的图片</span><br>/apps/nginx/sbin/nginx -t<br>/apps/nginx/sbin/nginx -r reload<br><span class="hljs-comment">#浏览器访问(在window里)</span><br>www.rlinpc.net/<span class="hljs-number">1</span>.jpg<br></code></pre></td></tr></table></figure><p><strong>注意：精确匹配的优先级比模糊匹配的优先级高</strong></p><h4 id="1-7-2-匹配案例-区分大小写"><a href="#1-7-2-匹配案例-区分大小写" class="headerlink" title="1.7.2 匹配案例-区分大小写"></a>1.7.2 匹配案例-区分大小写</h4><p>如果uri中包含大写字母，则以下location匹配Ax.jpg条件不成功，因为~为区分大小写，那么当用户的请求被执行匹配时发现location中定义的是大写的A，则匹配失败，即要么继续往下匹配其他的location（如果有），要么报错给客户端。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#区分大小写</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /A.?\.txt</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/static;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -r reload<br>cd /data.nginx/static<br><span class="hljs-comment">#存放AA.txt</span><br><span class="hljs-comment">#存放Aa.txt</span><br><span class="hljs-comment">#浏览器访问图片</span><br>www.rlinpc.net/AA.txt (结果访问失败)<br>www.rlinpc.net/Aa.txt (结果访问成功)<br></code></pre></td></tr></table></figure><h4 id="1-7-3-匹配案例-不区分大小写"><a href="#1-7-3-匹配案例-不区分大小写" class="headerlink" title="1.7.3 匹配案例-不区分大小写"></a>1.7.3 匹配案例-不区分大小写</h4><p>对用户请求的uri做模糊匹配，也就是uri中无论都是大写、都是小写或者大小写混合，此模式也都会匹配，通常使用此模式匹配用户request中的静态资源并继续做下一步操作。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#选用一下其中一个都可以达到效果</span><br><span class="hljs-comment">#正则表达式匹配</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* /A.?\.txt</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/static;<br>    &#125;<br>&#125;<br><span class="hljs-comment">#精确匹配指定名称</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* /aa.jpg</span> &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /opt/nginx/html/image;<br>    &#125;<br>&#125;<br><span class="hljs-comment">#重启Nginx</span><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -r reload<br>cd /data.nginx/static<br><span class="hljs-comment">#存放AA.txt</span><br><span class="hljs-comment">#存放Aa.txt</span><br><span class="hljs-comment">#存放aA.txt</span><br><span class="hljs-comment">#存放aa.txt</span><br><span class="hljs-comment">#浏览器访问图片</span><br>www.rlinpc.net/AA.txt (结果访问成功)<br>www.rlinpc.net/Aa.txt (结果访问成功)<br>www.rlinpc.net/aa.txt (结果访问成功)<br>www.rlinpc.net/aA.txt (结果访问成功)<br></code></pre></td></tr></table></figure><h4 id="1-7-4匹配案例-URI开始"><a href="#1-7-4匹配案例-URI开始" class="headerlink" title="1.7.4匹配案例-URI开始"></a>1.7.4匹配案例-URI开始</h4><p>范例:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /static &#123;<br>        <span class="hljs-attribute">root</span> /opt/rlin;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br>mkdir -p /opt/rlin/static&#123;1..3&#125;<br><span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;static1&quot;</span> &gt; /opt/rlin/static1/index.html<br>echo <span class="hljs-string">&quot;stattic2&quot;</span> &gt; /opt/rlin/static2/index.html<br>echo <span class="hljs-string">&quot;stattic3&quot;</span> &gt; /opt/rlin/static3/index.html<br><span class="hljs-comment">#浏览器访问</span><br>www.rlinpc.net/static1<br>结果：<br>static1<br>www.rlinpc.net/static2<br>结果：<br>static2<br>www.rlinpc.net/static3<br>结果：<br>static3<br></code></pre></td></tr></table></figure><h4 id="1-7-5-匹配案例-文件名后缀"><a href="#1-7-5-匹配案例-文件名后缀" class="headerlink" title="1.7.5 匹配案例-文件名后缀"></a>1.7.5 匹配案例-文件名后缀</h4><p><strong>大部分公司都是基于这种模式实现动静分离</strong><br>范例4：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(gif|jpg|jpeg|bmp|png|tiff|tif|ico|wmf|js|css)$</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/static;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125; <br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br>mkdir /data/nginx/static<br>cd /data/nginx/static<br><span class="hljs-comment">#存放1.jpg文件</span><br><span class="hljs-comment">#存放1.gif文件</span><br><span class="hljs-comment">#存放1.png文件</span><br><span class="hljs-comment">#....</span><br>浏览器访问<br>www.rlinpc.net/<span class="hljs-number">1</span>.jpg<br>www.rlinpc.net/<span class="hljs-number">1</span>.gif<br>www.rlinpc.net/<span class="hljs-number">1</span>.png<br>.....<br></code></pre></td></tr></table></figure><h4 id="1-7-6-匹配案例-优先级"><a href="#1-7-6-匹配案例-优先级" class="headerlink" title="1.7.6 匹配案例-优先级"></a>1.7.6 匹配案例-优先级</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nginx">匹配优先级：=, ^~, ～/～*，/<br>location优先级：(<span class="hljs-attribute">location</span> =) &gt; (location 完整路径) &gt; (location<span class="hljs-regexp"> ^~</span> 路径) &gt; (location ~,<span class="hljs-regexp">~* 正则顺序)</span> &gt; (location 部分起始路径) &gt; (/)<br><br>vim /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* /1.jpg</span> &#123;<br>    <span class="hljs-attribute">root</span> /data/nginx/html/images;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> = /<span class="hljs-number">1</span>.jpg &#123; <span class="hljs-comment">#通常用于精确匹配指定文件，如favicon.ico、employcode.js、index.jsp等</span><br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/static;<br>    &#125;<br>&#125;<br><br><span class="hljs-attribute">mkdir</span> -p /data/nginx/html/images<br>mkdir -p /data/nginx/html/static<br><span class="hljs-comment">#分别上传1.jpg图片到/data/nginx/html/images和/data/nginx/html/static</span><br><span class="hljs-comment">#重启nginx</span><br>/apps/nginx/sbin/nginx -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net/1.jpg，结果显示是static里的1.jpg会被调用</span><br></code></pre></td></tr></table></figure><h4 id="1-7-7-生产使用案例"><a href="#1-7-7-生产使用案例" class="headerlink" title="1.7.7 生产使用案例"></a>1.7.7 生产使用案例</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#直接匹配网站根会加速Nginx访问处理:</span><br><span class="hljs-attribute">location</span> = / &#123;<br> ......;<br>&#125;<br><span class="hljs-attribute">location</span> / &#123;<br> ......;<br>&#125;<br><span class="hljs-comment">#静态资源配置：</span><br><span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /static/ &#123;<br> ......;<br>&#125;<br><span class="hljs-comment"># 或者</span><br><span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(gif|jpg|jpeg|png|css|js|ico)$</span> &#123;<br> ......;<br>&#125;<br><span class="hljs-comment">#多应用配置</span><br><span class="hljs-attribute">location</span> <span class="hljs-regexp">~* /app1</span> &#123;<br>  ......;<br>&#125;<br><span class="hljs-attribute">location</span> <span class="hljs-regexp">~* /app2</span> &#123;<br>  ......;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-8-Nginx-四层访问控制"><a href="#1-8-Nginx-四层访问控制" class="headerlink" title="1.8 Nginx 四层访问控制"></a>1.8 Nginx 四层访问控制</h3><p>访问控制基于模块ngx_http_access_module实现，可以通过匹配客户端源IP地址进行限制。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> /about &#123;<br> <span class="hljs-attribute">alias</span> /data/nginx/html/pc;<br> <span class="hljs-attribute">index</span> index.html;<br> <span class="hljs-attribute">deny</span>  <span class="hljs-number">10.0.0.5</span>;<br> <span class="hljs-attribute">allow</span> <span class="hljs-number">10.0.0.101</span>/<span class="hljs-number">24</span>;<br> <span class="hljs-attribute">allow</span> <span class="hljs-number">10.0.0.102</span>/<span class="hljs-number">16</span>;<br> <span class="hljs-attribute">allow</span> <span class="hljs-number">2001</span>:0db8::/<span class="hljs-number">32</span>;<br> <span class="hljs-attribute">deny</span> all;  <span class="hljs-comment">#先允许小部分，再拒绝大部分</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-9-nginx账户认证功能（一般用户公司内部）"><a href="#1-9-nginx账户认证功能（一般用户公司内部）" class="headerlink" title="1.9 nginx账户认证功能（一般用户公司内部）"></a>1.9 nginx账户认证功能（一般用户公司内部）</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">yum</span> install httpd-tools -y <span class="hljs-comment">#Centos</span><br>apt install apache2-utils -y <span class="hljs-comment">#Ubuntu</span><br><span class="hljs-comment">#首次添加账户密码</span><br>htpasswd -cbm /apps/nginx/conf/.htpasswd rlin <span class="hljs-number">123456</span><br>cat /apps/nginx/conf/.htpasswd <br>rlin:$apr1$USjpH9t3$ii.ZijTLeGUiR0CtpGkw7/<br><span class="hljs-comment">#再次添加账户密码</span><br>htpasswd -bm /apps/nginx/conf/.htpasswd ubuntu <span class="hljs-number">123456</span><br>cat /apps/nginx/conf/.htpasswd <br>rlin:$apr1$USjpH9t3$ii.ZijTLeGUiR0CtpGkw7/<br>ubuntu:$apr1$RFmN9kmx$W2gL9VWPa1xTCLKPDy6y51<br><br>vim /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>     <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>     <span class="hljs-attribute">location</span> = /login/ &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">auth_basic</span> <span class="hljs-string">&quot;login password&quot;</span>;<br>        <span class="hljs-attribute">auth_basic_user_file</span> /apps/nginx/conf/.htpasswd;<br>    &#125;<br>&#125;<br><br><span class="hljs-attribute">mkdir</span> -p /data/nginx/html/pc/login<br>echo <span class="hljs-string">&quot;login page&quot;</span> &gt; /data/nginx/html/pc/login/index.html<br>/apps/nginx/sbin/nginx -t <br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问</span><br>www.rlinpc.net/login<br></code></pre></td></tr></table></figure><h3 id="1-10-自定义错误页面"><a href="#1-10-自定义错误页面" class="headerlink" title="1.10 自定义错误页面"></a>1.10 自定义错误页面</h3><p>定义错误页，以指定的响应状态码进行响应, 可用位置：http, server, location, if in location</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">error_page code ... [=[response]] uri;<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br><span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span> /error.html;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> = /error.html &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/error;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问不存在的页面，如：www.rlinpc.net/12324888.jpg</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br><span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> /40x.html;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> = /40x.html &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/error;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问不存在的页面，如：www.rlinpc.net/12324888.jpg</span><br></code></pre></td></tr></table></figure><p>范例：浏览器”截胡”<br>使用360浏览器访问基于IP的不存在页面时会自动用广告页面代替错误页面</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#404转为302</span><br><span class="hljs-attribute">vim</span> /data/nginx/conf.d/pc.conf<br>server &#123;<br><span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> =<span class="hljs-number">302</span> /index.html; <span class="hljs-comment">#这里是跳到主页面</span><br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问不存在的页面，如：www.rlinpc.net/12324888.jpg</span><br></code></pre></td></tr></table></figure><h3 id="1-11-自定义错误日志"><a href="#1-11-自定义错误日志" class="headerlink" title="1.11 自定义错误日志"></a>1.11 自定义错误日志</h3><p>语法格式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">Syntax: error_log file [level];<br>Default:<br>error_log logs/error.log error;<br>Context: main, http, mail, stream, server, location<br>level: debug, info, notice, warn, error, crit, alert, emerg<br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /data/nginx/conf.d/pc.conf<br>server&#123;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> /error.html; <span class="hljs-comment">#默认⽬录下⾯创建error.html⻚⾯</span><br>    <span class="hljs-comment">#自定义日志多用于单独统计某个域名的访问量和日志非常有用</span><br>    <span class="hljs-attribute">access_log</span> /apps/nginx/logs/www.rlinpc.net_access.log;<br>    <span class="hljs-attribute">error_log</span> /apps/nginx/logs/www.rlinpc.net_error.log;<br>    <span class="hljs-attribute">location</span> = /error.html&#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>&#125;<br><span class="hljs-attribute">vim</span> /data/nginx/html/pc/error.html<br>qq123456789<br><span class="hljs-number">404</span><br>mkdir /apps/nginx/logs   <span class="hljs-comment">#启动nginx的账号对这个路径要有权限</span><br>/apps/nginx/sbin/nginx -t<br>/apps/nginx/sbin/nginx -r reload<br><span class="hljs-comment">#浏览器访问不存在的页面,并查看 /apps/nginx/log/www.rlinpc.net_error.log 文件</span><br></code></pre></td></tr></table></figure><h3 id="1-12-检测文件是否存在"><a href="#1-12-检测文件是否存在" class="headerlink" title="1.12 检测文件是否存在"></a>1.12 检测文件是否存在</h3><p>try_files会按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如果所有文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。只有最后一个参数可以引起一个内部重定向，之前的参数只设置内部URI的指向。最后一个参数是回退URI且必须存在，否则会出现内部500错误。<br>语法格式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">Syntax: try_files file ... uri;<br>try_files file ... =code;<br>Default: —<br>Context: server, location<br></code></pre></td></tr></table></figure><p>范例：如果不存在页面, 就转到default.html页面</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /data/nginx/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>        <span class="hljs-attribute">try_files</span> $uri  $uri.html $uri/index.html /about/default.html;<br>  <span class="hljs-comment">#try_files $uri $uri/index.html $uri.html =489;</span><br>    &#125;<br>&#125;<br><br><span class="hljs-attribute">mkdir</span> -p /data/nginx/html/pc/about<br>echo <span class="hljs-string">&quot;default page&quot;</span> &gt;&gt; /data/nginx/html/pc/about/default.html<br>/apps/nginx/sbin/nginx -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#当访问到http://www.magedu.org/about/xx.html 等不存在的uri会显示default.html，如果是自定义的状态码则会显示在返回数据的状态码中</span><br><br><span class="hljs-comment">#注释default.html行,启用上面489行生效后,再观察结果</span><br>vim /data/nginx/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>        <span class="hljs-comment">#try_files $uri  $uri.html $uri/index.html /about/default.html;</span><br>        <span class="hljs-attribute">try_files</span> $uri $uri/index.html $uri.html =<span class="hljs-number">489</span>;<br>    &#125;<br>&#125;<br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br>curl -I www.rlinpc.net/about/xx.html<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">489</span> <br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: Sun, <span class="hljs-number">14</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">04</span>:<span class="hljs-number">01</span>:<span class="hljs-number">41</span> GMT<br>Content-Length: <span class="hljs-number">0</span><br>Connection: keep-alive<br></code></pre></td></tr></table></figure><h3 id="1-13-长连接配置"><a href="#1-13-长连接配置" class="headerlink" title="1.13 长连接配置"></a>1.13 长连接配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">keepalive_timeout timeout [            header_timeout];  <span class="hljs-comment">#设定保持连接超时时长，0表示禁止长连接，默认为75s，通常配置在http字段作为站点全局配置</span><br>keepalive_requests number;  <span class="hljs-comment">#在一次长连接上所允许请求的资源的最大数量，默认为100次,建议适当调大,比如:500</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">keepalive_requests</span> <span class="hljs-number">3</span>;<br><span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span> <span class="hljs-number">60</span>;<br><span class="hljs-comment">#开启长连接后，返回客户端的会话保持时间为60s，单次长连接累计请求达到指定次数请求或65秒就会被断开，后面的60为发送给客户端应答报文头部中显示的超时时间设置为60s：如不设置客户端将不显示超时时间。</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">keepalive_requests</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-attribute">keepalive_timeout</span> <span class="hljs-number">65</span> <span class="hljs-number">60</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br>&#125;<br><br>apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br>curl www.rlinpc.net -I<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: Sun, <span class="hljs-number">14</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">09</span>:<span class="hljs-number">22</span>:<span class="hljs-number">16</span> GMT<br>Content-Type: text/html<br>Content-Length: <span class="hljs-number">16</span><br>Last-Modified: Sat, <span class="hljs-number">13</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">02</span>:<span class="hljs-number">50</span>:<span class="hljs-number">18</span> GMT<br>Connection: keep-alive<br>Keep-Alive: timeout=<span class="hljs-number">60</span><br>ETag: <span class="hljs-string">&quot;60273e6a-10&quot;</span><br>Accept-Ranges: bytes<br><br>Keep-Alive:timeout=<span class="hljs-number">60</span>  <span class="hljs-comment">#浏览器收到的服务器返回的报文</span><br><br><span class="hljs-comment">#如果设置为0表示关闭会话保持功能，将如下显示：</span><br>Connection:close  <span class="hljs-comment">#浏览器收到的服务器返回的报文</span><br></code></pre></td></tr></table></figure><h3 id="1-14-作为下载服务器配置"><a href="#1-14-作为下载服务器配置" class="headerlink" title="1.14 作为下载服务器配置"></a>1.14 作为下载服务器配置</h3><p>ngx_http_autoindex_module 模块处理以斜杠字符 “/“ 结尾的请求，并生成目录列表,可以做为下载服务配置使用<br>官方文档:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://nginx.org/en/docs/http/ngx_http_autoindex_module.html<br></code></pre></td></tr></table></figure><p>相关指令:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">autoindex</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span>;<span class="hljs-comment">#自动文件索引功能，默为off</span><br><span class="hljs-attribute">autoindex_exact_size</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span>;  <span class="hljs-comment">#计算文件确切大小（单位bytes），off 显示大概大小（单位K、M)，默认on</span><br><span class="hljs-attribute">autoindex_localtime</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span> ; <span class="hljs-comment">#显示本机时间而非GMT(格林威治)时间，默认off</span><br><span class="hljs-attribute">autoindex_format</span> html | xml | json | jsonp; <span class="hljs-comment">#显示索引的页面文件风格，默认html</span><br><span class="hljs-attribute">limit_rate</span> rate; <span class="hljs-comment">#限制响应客户端传输速率(除GET和HEAD以外的所有方法)，单位B/s,即bytes/second，默认值0,表示无限制,此指令由ngx_http_core_module提供</span><br></code></pre></td></tr></table></figure><p>范例：实现下载站点</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#注意:download不需要index.html文件</span><br><span class="hljs-attribute">mkdir</span> -p /data/nginx/html/pc/download<br><br>vim /apps/nginx/conf/conf.d/pc.conf<br>server&#123;<br>    ......<br>        <span class="hljs-attribute">location</span> /download &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc/;<br>        <span class="hljs-attribute">autoindex</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#自动索引功能</span><br>        <span class="hljs-attribute">autoindex_localtime</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#计算文件确切大小，on显示精确大小（单位byte），off只显示大概大小（单位kb、mb、gb）</span><br>        <span class="hljs-comment">#autoindex_localtime off;</span><br>        <span class="hljs-attribute">autoindex_locatime</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#显示本机时间而非GMT（格林威治）时间</span><br>        <span class="hljs-attribute">limit_rate</span> <span class="hljs-number">10k</span>; <span class="hljs-comment">#限制响应给客⼾端的传输速率，单位是bytes/second，默认值0表⽰⽆限制</span><br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -r reload<br>mkdir -p /data/nginx/html/pc/download<br><span class="hljs-comment">#往/data/nginx/html/pc/download添加文件</span><br><span class="hljs-comment">#访问浏览器www.rlinpc.net/download</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-download.png" title="下载页面"></p><h3 id="1-15-作为上传服务器"><a href="#1-15-作为上传服务器" class="headerlink" title="1.15 作为上传服务器"></a>1.15 作为上传服务器</h3><p>以下指令控制上传数据</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">1m</span>; <span class="hljs-comment">#设置允许客户端上传单个文件的最大值，默认值为1m,上传文件超过此值会出413错误</span><br><span class="hljs-attribute">client_body_buffer_size</span> size; <span class="hljs-comment">#用于接收每个客户端请求报文的body部分的缓冲区大小;默认16k;超出此大小时，其将被暂存到磁盘上的由下面client_body_temp_path指令所定义的位置</span><br><span class="hljs-attribute">client_body_temp_path</span> path [level1 [level2 [level3]]];<br><span class="hljs-comment">#设定存储客户端请求报文的body部分的临时存储路径及子目录结构和数量，目录名为16进制的数字，使用hash之后的值从后往前截取1位、2位、2位作为目录名</span><br><span class="hljs-attribute">md5sum</span> /data/nginx/html/pc/index.html<br>95f6f65f498c74938064851b1bb <span class="hljs-number">96</span> <span class="hljs-number">3d</span> <span class="hljs-number">4</span> /data/nginx/html/pc/index.html<br><span class="hljs-number">1</span>级目录占<span class="hljs-number">1</span>位<span class="hljs-number">16</span>进制，即<span class="hljs-number">2</span>^<span class="hljs-number">4</span>=<span class="hljs-number">16</span>个目录  <span class="hljs-number">0</span>-f<br><span class="hljs-number">2</span>级目录占<span class="hljs-number">2</span>位<span class="hljs-number">16</span>进制，即<span class="hljs-number">2</span>^<span class="hljs-number">8</span>=<span class="hljs-number">256</span>个目录 <span class="hljs-number">00</span>-ff<br><span class="hljs-number">3</span>级目录占<span class="hljs-number">2</span>位<span class="hljs-number">16</span>进制，即<span class="hljs-number">2</span>^<span class="hljs-number">8</span>=<span class="hljs-number">256</span>个目录 <span class="hljs-number">00</span>-ff<br><br><span class="hljs-comment">#配置示例：</span><br>client_max_body_size <span class="hljs-number">100m</span>; <span class="hljs-comment">#如果太大，上传时会出现下图的413错误,注意:如果php上传,还需要修改php.ini的相关配置</span><br><span class="hljs-attribute">client_body_buffer_size</span> <span class="hljs-number">1024k</span>;<br><span class="hljs-attribute">client_body_temp_path</span>  /apps/nginx/client_body_temp/ <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span>; <span class="hljs-comment">#上传时,Nginx会自动创建相关目录,1 2 2 表示2^4*2^8*2^8=2^20</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#上传超过nginx指定client_max_body_size值会出413错误</span><br>[root@wang-liyun-pc ~]<span class="hljs-comment"># tail /apps/nginx/logs/nginx.access.log</span><br>125.41.184.117 - - [27/Sep/2020:00:09:00 +0800] <span class="hljs-string">&quot;POST /wp-admin/async-upload.php HTTP/1.1&quot;</span> 413 578 <span class="hljs-string">&quot;http://www.wangxiaochun.com/wp-admin/post-new.php&quot;</span><br><span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36 Edg/85.0.564.63&quot;</span> <span class="hljs-string">&quot;-&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">tree /apps/nginx/client_body_temp/<br>/apps/nginx/client_body_temp/<br>├── 5<br>│  └── 00<br>│    └── 00<br>└── 6<br> └── 00<br>   └── 00<br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nging/conf/nginx.conf<br>http&#123;<br>    ......<br>        <span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">10m</span>;<br><span class="hljs-attribute">client_body_buffer_size</span> <span class="hljs-number">16k</span>;<br><span class="hljs-attribute">client_body_temp_path</span> /apps/nginx/temp <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span>; <span class="hljs-comment">#/apps/nginx/temp要注意权限</span><br>&#125;<br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h3 id="1-16-其他配置"><a href="#1-16-其他配置" class="headerlink" title="1.16 其他配置"></a>1.16 其他配置</h3><h4 id="1-16-1-对哪种浏览器禁用长链接"><a href="#1-16-1-对哪种浏览器禁用长链接" class="headerlink" title="1.16.1 对哪种浏览器禁用长链接"></a>1.16.1 对哪种浏览器禁用长链接</h4><p>模块语法：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">keepalive_disable</span> <span class="hljs-literal">none</span> | browser ...;<br></code></pre></td></tr></table></figure><p>范例1：对ie6禁用长链接</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/nginx.conf<br>http &#123;<br>    ......<br>        <span class="hljs-attribute">keepalive_disable</span> mise6; <span class="hljs-comment">#禁止ie6浏览器访问。 MSIE 名词释义： Microsoft Internet Explorer，简称MSIE。MSIE是微软公司推出的一款网页浏览器</span><br>&#125;<br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h4 id="1-16-2-限制客⼾端使⽤除了指定的请求⽅法之外的其它⽅法"><a href="#1-16-2-限制客⼾端使⽤除了指定的请求⽅法之外的其它⽅法" class="headerlink" title="1.16.2 限制客⼾端使⽤除了指定的请求⽅法之外的其它⽅法"></a>1.16.2 限制客⼾端使⽤除了指定的请求⽅法之外的其它⽅法</h4><p>模块语法：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">limit_except</span> method ... &#123; ... &#125;，仅⽤于<span class="hljs-attribute">location</span><br>method:GET, HEAD, POST, PUT, DELETE，MKCOL, COPY, MOVE, OPTIONS, PROPFIND,PROPPATCH, LOCK, UNLOCK, PATCH<br>注意：HEAD是默认允许，如果使用了这个模块，除了GET和HEAD之外所有的方法都会限制访问<br></code></pre></td></tr></table></figure><p>范例1：除了GET和HEAD 之外其它⽅法仅允许10.0.0.102/24⽹段主机使⽤</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> /upload &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">limit_except</span> GET &#123;<br>            <span class="hljs-attribute">allow</span> <span class="hljs-number">10.0.0.102</span>;<br>            <span class="hljs-attribute">deny</span> all;<br>        &#125;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin -s reload<br>mkdir -p /data/nginx/html/pc/upload<br>echo <span class="hljs-string">&quot;upload&quot;</span> &gt; /data/nginx/pc/upload/index.html<br><br><span class="hljs-comment">#测试上传文件</span><br><span class="hljs-comment">#10.0.0.102主机</span><br>curl -XPUT /etc/issue http://www.rlinpc.net<br>curl: (<span class="hljs-number">3</span>) &lt;url&gt; malformed<br>&lt;html&gt;<br>&lt;head&gt;&lt;title&gt;<span class="hljs-number">405</span> Not Allowed&lt;/title&gt;&lt;/head&gt; <span class="hljs-comment">#Nginx已经允许但是程序未⽀持上传功能</span><br>&lt;body bgcolor=<span class="hljs-string">&quot;white&quot;</span>&gt;<br>&lt;center&gt;&lt;h1&gt;<span class="hljs-number">405</span> Not Allowed&lt;/h1&gt;&lt;/center&gt;<br>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><span class="hljs-comment">#非10.0.0.102主机</span><br>curl -XPUT /etc/issue http://www.rlinpc/upload<br>curl: (<span class="hljs-number">3</span>) &lt;url&gt; malformed<br>&lt;html&gt;<br>&lt;head&gt;&lt;title&gt;<span class="hljs-number">403</span> Forbidden&lt;/title&gt;&lt;/head&gt; <span class="hljs-comment">#Nginx拒绝上传</span><br>&lt;body bgcolor=<span class="hljs-string">&quot;white&quot;</span>&gt;<br>&lt;center&gt;&lt;h1&gt;<span class="hljs-number">403</span> Forbidden&lt;/h1&gt;&lt;/center&gt;<br>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h4 id="1-16-3-是否启⽤asynchronous-file-I-O-AIO-功能，需要编译开启（一般少用）"><a href="#1-16-3-是否启⽤asynchronous-file-I-O-AIO-功能，需要编译开启（一般少用）" class="headerlink" title="1.16.3 是否启⽤asynchronous file I/O(AIO)功能，需要编译开启（一般少用）"></a>1.16.3 是否启⽤asynchronous file I/O(AIO)功能，需要编译开启（一般少用）</h4><p>模块语法：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">aio</span> <span class="hljs-literal">on</span>|<span class="hljs-literal">off</span> <span class="hljs-comment">#是否启用asynchronous file I/O(AIO)功能，需要编译开启 --with-file-aio</span><br>linux <span class="hljs-number">2</span>.<span class="hljs-number">6</span>以上内核提供以下⼏个系统调⽤来⽀持aio：<br><span class="hljs-number">1</span>、SYS_io_setup：建⽴aio 的context<br><span class="hljs-number">2</span>、SYS_io_submit: 提交I/O操作请求<br><span class="hljs-number">3</span>、SYS_io_getevents：获取已完成的I/O事件<br><span class="hljs-number">4</span>、SYS_io_cancel：取消I/O操作请求<br><span class="hljs-number">5</span>、SYS_io_destroy：毁销aio的context<br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">directio</span> size | <span class="hljs-literal">off</span>; <span class="hljs-comment">#操作完全和aio相反，aio是读取⽂件⽽directio是写⽂件到磁盘，启⽤直接I/O，默认为关闭，当⽂件⼤于等于给定⼤⼩时，例如directio 4m，同步（直接）写磁盘，⽽⾮写缓存。</span><br></code></pre></td></tr></table></figure><p>范例：开启aio（需要配合directio一起开启）</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">aio</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">directio</span> <span class="hljs-number">4m</span>;<br>&#125;<br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h4 id="1-16-4-是否缓存打开过的文件信息（一般是打开）"><a href="#1-16-4-是否缓存打开过的文件信息（一般是打开）" class="headerlink" title="1.16.4 是否缓存打开过的文件信息（一般是打开）"></a>1.16.4 是否缓存打开过的文件信息（一般是打开）</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">open_file_cache</span> <span class="hljs-literal">off</span>;  <span class="hljs-comment">#是否缓存打开过的文件信息</span><br><span class="hljs-attribute">open_file_cache</span> max=N [inactive=time];<br><span class="hljs-comment">#nginx可以缓存以下三种信息：</span><br>(1) 文件元数据：文件的描述符、文件大小和最近一次的修改时间<br>(2) 打开的目录结构<br>(3) 没有找到的或者没有权限访问的文件的相关信息<br>max=N：<span class="hljs-comment">#可缓存的缓存项上限数量;达到上限后会使用LRU(Least recently used，最近最少使用)算法</span><br>实现管理<br>inactive=time：<span class="hljs-comment">#缓存项的非活动时长，在此处指定的时长内未被命中的或命中的次数少于</span><br>open_file_cache_min_uses指令所指定的次数的缓存项即为非活动项，将被删除<br><span class="hljs-attribute">open_file_cache_valid</span> time; <span class="hljs-comment">#缓存项有效性的检查验证频率，默认值为60s</span><br><span class="hljs-attribute">open_file_cache_errors</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span>; <span class="hljs-comment">#是否缓存查找时发生错误的文件一类的信息,默认值为off</span><br><span class="hljs-attribute">open_file_cache_min_uses</span> number; <span class="hljs-comment">#open_file_cache指令的inactive参数指定的时长内，至少被命中此处指定的次数方可被归类为活动项,默认值为1</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/nginx.conf<br>http &#123;<br>    ......<br>        <span class="hljs-attribute">open_file_cache</span> max=<span class="hljs-number">10000</span> inactive=<span class="hljs-number">60s</span>; <span class="hljs-comment">#最⼤缓存10000个⽂件，⾮活动数据超时时⻓60s</span><br>        <span class="hljs-attribute">open_file_cache_valid</span> <span class="hljs-number">60s</span>; <span class="hljs-comment">#每间隔60s检查⼀下缓存数据有效性</span><br>        <span class="hljs-attribute">open_file_cache_min_uses</span> <span class="hljs-number">5</span>; <span class="hljs-comment">#60秒内⾄少被命中访问5次才被标记为活动数据</span><br>        <span class="hljs-attribute">open_file_cache_errors</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#缓存错误信息</span><br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h4 id="1-16-5-隐藏nginx的版本号"><a href="#1-16-5-隐藏nginx的版本号" class="headerlink" title="1.16.5 隐藏nginx的版本号"></a>1.16.5 隐藏nginx的版本号</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/nginx.conf<br>http &#123;<br>    ......<br>        <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>; <span class="hljs-comment">#隐藏Nginx server版本。</span><br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h2 id="二、Nginx高级配置"><a href="#二、Nginx高级配置" class="headerlink" title="二、Nginx高级配置"></a>二、Nginx高级配置</h2><h3 id="2-1-Nginx-状态页"><a href="#2-1-Nginx-状态页" class="headerlink" title="2.1 Nginx 状态页"></a>2.1 Nginx 状态页</h3><p>基于nginx 模块 ngx_http_stub_status_module 实现，在编译安装nginx的时候需要添加编译参数–with-http_stub_status_module，否则配置完成之后监测会是提⽰语法错误。</p><p>注意: 状态页显示的是整个服务器的状态,而非虚拟主机的状态</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#配置⽰例：</span><br><span class="hljs-attribute">location</span> /nginx_status &#123;<br>    stub_status;<br>    <span class="hljs-attribute">auth_basic</span>      <span class="hljs-string">&quot;auth login&quot;</span>;<br>    <span class="hljs-attribute">auth_basic_user_file</span> /apps/nginx/conf/.htpasswd;<br>    <span class="hljs-attribute">allow</span> <span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">16</span>;<br>    <span class="hljs-attribute">allow</span> <span class="hljs-number">127.0.0.1</span>;<br>    <span class="hljs-attribute">deny</span> all;<br>&#125;<br><br><span class="hljs-comment">#状态⻚⽤于输出nginx的基本状态信息：</span><br><span class="hljs-comment">#输出信息⽰例：</span><br><span class="hljs-attribute">Active</span> connections: <span class="hljs-number">291</span><br>server accepts handled requests<br><span class="hljs-number">16630948</span> <span class="hljs-number">16630948</span> <span class="hljs-number">31070465</span><br>上⾯三个数字分别对应accepts,handled,requests三个值<br>Reading: <span class="hljs-number">6</span> Writing: <span class="hljs-number">179</span> Waiting: <span class="hljs-number">106</span><br><br>Active connections： <span class="hljs-comment">#当前处于活动状态的客⼾端连接数，包括连接等待空闲连接数=reading+writing+waiting</span><br>accepts：<span class="hljs-comment">#统计总值，Nginx⾃启动后已经接受的客⼾端请求的总数。</span><br>handled：<span class="hljs-comment">#统计总值，Nginx⾃启动后已经处理完成的客⼾端请求的总数，通常等于accepts，除⾮有因worker_connections限制等被拒绝的连接。</span><br>requests：<span class="hljs-comment">#统计总值，Nginx⾃启动后客⼾端发来的总的请求数。</span><br>Reading：<span class="hljs-comment">#当前状态，正在读取客⼾端请求报⽂⾸部的连接的连接数。</span><br>Writing：<span class="hljs-comment">#当前状态，正在向客⼾端发送响应报⽂过程中的连接数。</span><br>Waiting：<span class="hljs-comment">#当前状态，正在等待客⼾端发出请求的空闲连接数，开启 keep-alive的情况下,这个值等于 active –(reading+writing),</span><br></code></pre></td></tr></table></figure><p>范例：分析网站当前访问量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl http://www.wangxiaochun.com/nginx_status 2&gt; /dev/null |awk <span class="hljs-string">&#x27;/Reading/&#123;print $2,$4,$6&#125;&#x27;</span><br>0 1 1<br></code></pre></td></tr></table></figure><h3 id="2-2-Nginx第三方模块"><a href="#2-2-Nginx第三方模块" class="headerlink" title="2.2 Nginx第三方模块"></a>2.2 Nginx第三方模块</h3><p>第三模块是对nginx 的功能扩展，第三方模块需要在编译安装Nginx 的时候使用参数–add-<br>module=PATH指定路径添加，有的模块是由公司的开发人员针对业务需求定制开发的，有的模块是开源爱好者开发好之后上传到github进行开源的模块，nginx支持第三方模块需要从源码重新编译支持，比如:开源的echo模块 <a href="https://github.com/openresty/echo-nginx-module">https://github.com/openresty/echo-nginx-module</a><br>范例：第三方模块echo如何加入到nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在github里复制下载地址</span><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br>git <span class="hljs-built_in">clone</span> https://github.com/openresty/echo-nginx-module.git<br>/apps/nginx/sbin/nginx -s stop<br><span class="hljs-built_in">cd</span> nginx-1.16.1/<br><span class="hljs-comment">#获取以前编译nginx的参数</span><br>/apps/nginx/sbin/nginx -V<br><span class="hljs-comment">#复制参数并添加新参数重新编译</span><br>./configure --prefix=/apps/nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_image_filter_module --with-http_geoip_module --with-http_gunzip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/<span class="hljs-built_in">local</span>/src/echo-nginx-module<br>make <br>make install<br></code></pre></td></tr></table></figure><p>范例：nginx如何使用第三方模块（如何使用在github里参考，这里以echo为例）</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net<br>        location / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> hello world;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问http://www.rlinpc.net/</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>      <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>      <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>      <span class="hljs-attribute">location</span> /main &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">default_type</span> text/html;<br>        <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;hello world,main--&gt;&quot;</span>;<br>        <span class="hljs-attribute">echo</span> $remote_addr ;<br>        echo_reset_timer;  <span class="hljs-comment">#将计时器开始时间重置为当前时间</span><br>        <span class="hljs-attribute">echo_location</span> /sub1;<br>        <span class="hljs-attribute">echo_location</span> /sub2;<br>        <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;took $echo_timer_elapsed sec for total.&quot;</span>;<br>      &#125;<br>    <br>      <span class="hljs-attribute">location</span> /sub1 &#123;<br>        <span class="hljs-attribute">echo_sleep</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-attribute">echo</span> sub1;<br>      &#125;<br>    <br>      <span class="hljs-attribute">location</span> /sub2 &#123;<br>        <span class="hljs-attribute">echo_sleep</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-attribute">echo</span> sub2;<br>      &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#测试是查看结果</span><br>curl www.rlinpc.net/main<br>hello world,main--&gt;<br><span class="hljs-number">10.0.0.101</span><br>sub1<br>sub2<br>took <span class="hljs-number">2</span>.<span class="hljs-number">004</span> sec for total.<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-disanfangtest.png" title="第三方测试"></p><h3 id="2-3-Nginx变量使用"><a href="#2-3-Nginx变量使用" class="headerlink" title="2.3 Nginx变量使用"></a>2.3 Nginx变量使用</h3><ul><li>nginx的变量可以在配置文件中引用，作为功能判断或者日志等场景使用</li><li>变量可以分为内置变量和自定义变量</li><li>内置变量是由nginx模块自带，通过变量可以获取到众多的与客户端访问相关的值。<h4 id="2-3-1-内置变量"><a href="#2-3-1-内置变量" class="headerlink" title="2.3.1 内置变量"></a>2.3.1 内置变量</h4>官方文档<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://nginx.org/en/docs/varindex.html<br></code></pre></td></tr></table></figure><strong>常用内置变量</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$remote_addr</span>;<br><span class="hljs-comment">#存放了客⼾端的地址，注意是客⼾端的公⽹IP，也就是⼀家⼈访问⼀个⽹站，则会显⽰为路由器的公⽹IP。</span><br></code></pre></td></tr></table></figure>范例：<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $remote_addr;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$args</span>；<br><span class="hljs-comment">#变量中存放了URL中的指令，例如 http://www.magedu.net/main/index.do?id=20190221&amp;partner=search中的id=20190221&amp;partner=search </span><br><span class="hljs-comment">#返回结果为: id=20190221&amp;partner=search</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $args;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$document_root</span>；<br><span class="hljs-comment">#保存了针对当前资源的请求的系统根⽬录，如/apps/nginx/html。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $document_root;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$document_uri</span>；<br><span class="hljs-comment">#保存了当前请求中不包含指令的URI，注意是不包含请求的指令，⽐如http://www.magedu.net/main/index.do?id=20190221&amp;partner=search会被定义为/main/index.do</span><br><span class="hljs-comment">#返回结果为:/main/index.do</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $document_uri;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$host</span>；<br><span class="hljs-comment">#存放了请求的host名称。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $host;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$http_user_agent</span>；<br><span class="hljs-comment">#客⼾端浏览器的详细信息</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $http_user_agent;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$http_cookie</span>；<br><span class="hljs-comment">#客⼾端的cookie信息。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $http_cookie;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">limit_rate 10240;<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$limit_rate</span>; (一般不用)<br><span class="hljs-comment">#如果nginx服务器使⽤limit_rate配置了显⽰⽹络速率，则会显⽰，如果没有设置， 则显⽰0。</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$remote_port</span>；<br><span class="hljs-comment">#客⼾端请求Nginx服务器时随机打开的端⼝，这是每个客⼾端⾃⼰的端⼝。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $remote_port;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$remote_user</span>；<br><span class="hljs-comment">#已经经过Auth Basic Module验证的⽤⼾名。</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $remote_user;<br>        &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$request_body_file</span>；<br><span class="hljs-comment">#做反向代理时发给后端服务器的本地资源的名称。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $request_body_file;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$request_method</span>；<br><span class="hljs-comment">#请求资源的⽅式，GET/PUT/DELETE等</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $request_method;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$request_filename</span>；<br><span class="hljs-comment">#当前请求的资源⽂件的路径名称，由root或alias指令与URI请求⽣成的⽂件绝对路径，如/apps/nginx/html/main/index.html</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $request_filename;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$request_uri</span>；<br><span class="hljs-comment">#包含请求参数的原始URI，不包含主机名，如：/main/index.do?id=20190221&amp;partner=search 。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $request_uri;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$scheme</span>；<br><span class="hljs-comment">#请求的协议，如ftp，https，http等。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $scheme;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$server_protocol</span>；<br><span class="hljs-comment">#保存了客⼾端请求资源使⽤的协议的版本，如HTTP/1.0，HTTP/1.1，HTTP/2.0等。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $server_protocol;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$server_addr</span>；<br><span class="hljs-comment">#保存了服务器的IP地址。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $server_addr;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net;</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$server_name</span>；<br><span class="hljs-comment">#请求的服务器的主机名。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $server_name;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$server_port</span>；<br><span class="hljs-comment">#请求的服务器的端⼝号。</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $server_port;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$http_</span>&lt;name&gt;<br><span class="hljs-comment">#name为任意请求报文首部字段,表示记录请求报文的首部字段</span><br>arbitrary request header field; the last part of a variable name is the fieldname converted to lower <span class="hljs-keyword">case</span> with dashes replaced by underscores <span class="hljs-comment">#用下划线代替横线</span><br><span class="hljs-comment">#示例: echo $http_User_Agent;</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $http_&lt;name&gt;;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$http_user_agent</span>;<br><span class="hljs-comment">#客户端浏览器的详细信息</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $http_user_agent;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$proxy_add_x_forwarded_for</span><br><span class="hljs-comment">#此变量表示将客户端IP追加请求报文中X-Forwarded-For首部字段,多个IP之间用逗号分隔,如果请求中没有X-Forwarded-For,就使用$remote_addr</span><br>the “X-Forwarded-For” client request header field with the <span class="hljs-variable">$remote_addr</span> variable<br>appended to it, separated by a comma. If the “X-Forwarded-For” field is notpresent <span class="hljs-keyword">in</span> the client request header, the <span class="hljs-variable">$proxy_add_x_forwarded_for</span> variable isequal to the <span class="hljs-variable">$remote_addr</span> variable.<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $proxy_add_x_forwarded_for;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><h4 id="2-3-2-自定义变量"><a href="#2-3-2-自定义变量" class="headerlink" title="2.3.2 自定义变量"></a>2.3.2 自定义变量</h4><p>假如需要⾃定义变量名称和值，使⽤指令set $variable value;，则⽅法如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">Syntax: <span class="hljs-built_in">set</span> <span class="hljs-variable">$variable</span> value;<br>Default: —<br>Context: server, location, <span class="hljs-keyword">if</span><br></code></pre></td></tr></table></figure><p>范例：自定义值范例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> <span class="hljs-variable">$NAME</span> rlin; <span class="hljs-comment">#自定义定义值</span><br><span class="hljs-built_in">set</span> <span class="hljs-variable">$IP</span> <span class="hljs-variable">$remote_addr</span>; <span class="hljs-comment">#使用nginx内置变量</span><br></code></pre></td></tr></table></figure><p>范例：在配置文件中使用</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">set</span> $NAME rlin;<br>        <span class="hljs-attribute">echo</span> $NAME;<br>        <span class="hljs-attribute">set</span> $my_port $server_port;<br>        <span class="hljs-attribute">echo</span> $my_port;<br>        <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;$server_name:$server_port&quot;</span>;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">set</span> $IP $remote_addr;<br>        <span class="hljs-attribute">echo</span> $IP;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><h3 id="2-4-Nginx自定义访问日志"><a href="#2-4-Nginx自定义访问日志" class="headerlink" title="2.4 Nginx自定义访问日志"></a>2.4 Nginx自定义访问日志</h3><p>访问⽇志是记录客⼾端即⽤⼾的具体请求内容信息，全局配置模块中的error_log是记录nginx服务器运⾏时的⽇志保存路径和记录⽇志的level，因此有着本质的区别，⽽且Nginx的错误⽇志⼀般只有⼀个，但是访问⽇志可以在不同server中定义多个，定义⼀个⽇志需要使⽤access_log指定⽇志的保存路径，使⽤log_format指定⽇志的格式，格式中定义要保存的具体⽇志内容。<br>访问日志由 ngx_http_log_module 模块实现<br>官方帮助文档:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://nginx.org/en/docs/http/ngx_http_log_module.html<br></code></pre></td></tr></table></figure><p>语法格式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">Syntax: access_log path [format [buffer=size] [gzip[=level]] [flush=time]<br>[<span class="hljs-keyword">if</span>=condition]];<br>access_log off;<br>Default:<br>access_log logs/access.log combined;<br>Context: http, server, location, <span class="hljs-keyword">if</span> <span class="hljs-keyword">in</span> location, limit_except<br></code></pre></td></tr></table></figure><h4 id="2-4-1-自定义默认格式日志"><a href="#2-4-1-自定义默认格式日志" class="headerlink" title="2.4.1 自定义默认格式日志"></a>2.4.1 自定义默认格式日志</h4><p>如果是要保留日志的源格式，只是添加相应的日志内容，则配置如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/nginx.conf<br>http &#123;<br>......<br><span class="hljs-attribute">log_format</span> nginx_format1  <span class="hljs-string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot;&#x27;</span><br>           <span class="hljs-string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>           <span class="hljs-string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><br>           <span class="hljs-string">&#x27;$server_name:$server_port&#x27;</span>;<br>           <br><span class="hljs-attribute">access_log</span> logs/access.log nginx_format1;<br>&#125;<br><br><span class="hljs-comment">#重启nginx并访问测试日志格式</span><br>==&gt; /apps/nginx/logs/access.<span class="hljs-attribute">log</span> &lt;==<br><span class="hljs-number">10.0.0.1</span> - - [<span class="hljs-number">22</span>/Feb/<span class="hljs-number">2019</span>:<span class="hljs-number">08</span>:<span class="hljs-number">44</span>:<span class="hljs-number">14</span> +<span class="hljs-number">0800</span>] <span class="hljs-string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> <span class="hljs-number">404</span> <span class="hljs-number">162</span> <span class="hljs-string">&quot;-</span><br><span class="hljs-string">&quot;</span> <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:65.0) Gecko/2</span><br><span class="hljs-string">0100101 Firefox/65.0&quot;</span> <span class="hljs-string">&quot;-&quot;</span>www.magedu.org:<span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><h4 id="2-4-2-⾃定义json格式⽇志"><a href="#2-4-2-⾃定义json格式⽇志" class="headerlink" title="2.4.2 ⾃定义json格式⽇志"></a>2.4.2 ⾃定义json格式⽇志</h4><p>Nginx 的默认访问⽇志记录内容相对⽐较单⼀，默认的格式也不⽅便后期做⽇志统计分析，⽣产环境中通常将nginx⽇志转换为json⽇志，然后配合使⽤ELK做⽇志收集-统计-分析<br>范例：自定义json日志格式</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/nginx.conf<br>http &#123;<br>    ......<br>        <span class="hljs-attribute">log_format</span> access_json   <br>        <span class="hljs-string">&#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;responsetime&quot;:$request_time,&#x27;</span> <span class="hljs-comment">#总的处理时间</span><br>        <span class="hljs-string">&#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span> <span class="hljs-comment">#后端应用服务器处理时间</span><br>        <span class="hljs-string">&#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;uri&quot;:&quot;$uri&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;tcp_xff&quot;:&quot;$proxy_protocol_addr&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;</span>;<br>        <br>        <span class="hljs-attribute">access_log</span> /apps/nginx/logs/access_json.log access_json;<br>&#125;<br><span class="hljs-comment">#重启Nginx并访问测试日志格式,参考链接:http://json.cn/</span><br>&#123;&quot;@timestamp&quot;:&quot;2019-02-<br>22T08:55:32+08:00&quot;,&quot;host&quot;:&quot;10.0.0.8&quot;,&quot;clientip&quot;:&quot;10.0.0.1&quot;,&quot;size&quot;:162,&quot;<span class="hljs-attribute">responset</span><br>ime<span class="hljs-string">&quot;:0.000,&quot;</span>upstreamtime<span class="hljs-string">&quot;:&quot;</span>-<span class="hljs-string">&quot;,&quot;</span>upstreamhost<span class="hljs-string">&quot;:&quot;</span>-<br><span class="hljs-string">&quot;,&quot;</span>http_host<span class="hljs-string">&quot;:&quot;</span>www.magedu.org<span class="hljs-string">&quot;,&quot;</span>uri<span class="hljs-string">&quot;:&quot;</span>/favicon.ico<span class="hljs-string">&quot;,&quot;</span>xff<span class="hljs-string">&quot;:&quot;</span>-<span class="hljs-string">&quot;,&quot;</span>referer<span class="hljs-string">&quot;:&quot;</span>-<br><span class="hljs-string">&quot;,&quot;</span>tcp_xff<span class="hljs-string">&quot;:&quot;</span><span class="hljs-string">&quot;,&quot;</span>http_user_agent<span class="hljs-string">&quot;:&quot;</span>Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span> (Windows NT <span class="hljs-number">6</span>.<span class="hljs-number">1</span>; Win64; x64;<br>rv:65.0) Gecko/20100101 Firefox/65.0&quot;,&quot;status&quot;:&quot;404&quot;&#125;<br></code></pre></td></tr></table></figure><p>范例：其他pc端使用自定义的hson日志格式</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    ......<br>        <span class="hljs-attribute">access_log</span> /apps/nginx/logs/access_rlinpc_json.log access_json;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/ngins -s reload<br><span class="hljs-comment">#浏览器访问测试，然后查看日志，百度json校验，将日志复制完整的一段到到校验那里查看是否是jason格式</span><br></code></pre></td></tr></table></figure><h4 id="2-4-3-json格式的日志访问统计"><a href="#2-4-3-json格式的日志访问统计" class="headerlink" title="2.4.3 json格式的日志访问统计"></a>2.4.3 json格式的日志访问统计</h4><p>范例1：统计日志里200和404有多少个</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#python3</span><br>apt install -y python3  <span class="hljs-comment">#ubuntu</span><br>yum install -y python3  <span class="hljs-comment">#centos</span><br><br>vim /apps/log.py<br><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#coding:utf-8</span><br>status_200= []<br>status_404= []<br>with open(<span class="hljs-string">&quot;access_json.log&quot;</span>) as f:<br>  <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>    line = <span class="hljs-built_in">eval</span>(line)<br>    <span class="hljs-keyword">if</span> line.get(<span class="hljs-string">&quot;status&quot;</span>) == <span class="hljs-string">&quot;200&quot;</span>:<br>      status_200.append(line.get)<br>    <span class="hljs-keyword">elif</span> line.get(<span class="hljs-string">&quot;status&quot;</span>) == <span class="hljs-string">&quot;404&quot;</span>:<br>      status_404.append(line.get)<br>    <span class="hljs-keyword">else</span>:<br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;状态码 ERROR&quot;</span>)<br>    <span class="hljs-built_in">print</span>((line.get(<span class="hljs-string">&quot;clientip&quot;</span>)))<br>f.close()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;状态码200的有--:&quot;</span>,len(status_200))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;状态码404的有--:&quot;</span>,len(status_404))<br><br><span class="hljs-comment">#python2</span><br>apt install -y python2 <span class="hljs-comment">#ubuntn</span><br>yum install -y python2 <span class="hljs-comment">#centos</span><br>vim /apps/log.py<br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br>status_200= []<br>status_404= []<br>with open(<span class="hljs-string">&quot;access_json.log&quot;</span>) as f:<br>  <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>    line = <span class="hljs-built_in">eval</span>(line)<br>    <span class="hljs-keyword">if</span> line.get(<span class="hljs-string">&quot;status&quot;</span>) == <span class="hljs-string">&quot;200&quot;</span>:<br>      status_200.append(line.get)<br>    <span class="hljs-keyword">elif</span> line.get(<span class="hljs-string">&quot;status&quot;</span>) == <span class="hljs-string">&quot;404&quot;</span>:<br>      status_404.append(line.get)<br>    <span class="hljs-keyword">else</span>:<br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;状态码 ERROR&quot;</span>)<br>    <span class="hljs-built_in">print</span>(line.get(<span class="hljs-string">&quot;clientip&quot;</span>))<br>    f.close()<br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;状态码200的有--:&quot;</span>,len(status_200)<br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;状态码404的有--:&quot;</span>,len(status_404)<br><br><span class="hljs-comment">#保存日志文件到指定路径并进测试：</span><br>python nginx_json.py<br>状态码200的有--: 1910<br>状态码404的有--: 13<br><br><span class="hljs-comment">#转换python2语法到python3</span><br>pip3 install 2to3<br>2to3 -w log.py<br></code></pre></td></tr></table></figure><p>范例2：获取日志中用户访问的ip地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /apps/log.py<br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br><span class="hljs-comment">#Author:Zhang ShiJie</span><br>status_200= []<br>status_404= []<br>with open(<span class="hljs-string">&quot;access_json.log&quot;</span>) as f:<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>        line = <span class="hljs-built_in">eval</span>(line)<br>        <span class="hljs-built_in">print</span>(line.get(<span class="hljs-string">&quot;clientip&quot;</span>))<br>f.close()<br><br><span class="hljs-comment">#因为此脚本是用python2来写的，所以需要安装python2.7</span><br>apt install python2<br><span class="hljs-comment">#执行脚本</span><br>python2.7 log.py<br></code></pre></td></tr></table></figure><h3 id="2-5-Nginx压缩功能"><a href="#2-5-Nginx压缩功能" class="headerlink" title="2.5 Nginx压缩功能"></a>2.5 Nginx压缩功能</h3><p>Nginx⽀持对指定类型的⽂件进⾏压缩然后再传输给客⼾端，⽽且压缩还可以设置压缩⽐例，压缩后的⽂件⼤⼩将⽐源⽂件显著变⼩，这样有助于降低出⼝带宽的利⽤率，降低企业的IT⽀出，不过会占⽤相应的CPU资源。<br><strong>注意：需要在编译的时候加上压缩的参数</strong><br>Nginx对文件的压缩功能是以来于模块ngx_http_gzip_module<br>官方文档：<a href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html">https://nginx.org/en/docs/http/ngx_http_gzip_module.html</a><br>配置指令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启⽤或禁⽤gzip压缩，默认关闭</span><br>gzip on | off;<br><br><span class="hljs-comment">#压缩⽐由低到⾼从1到9，默认为1，推荐3-5，不要超过5</span><br>gzip_comp_level level; <br><br><span class="hljs-comment">#禁⽤IE6 gzip功能</span><br>gzip_disable <span class="hljs-string">&quot;MSIE [1-6]\.&quot;</span>;<br><br><span class="hljs-comment">#gzip压缩的最⼩⽂件，⼩于设置值的⽂件将不会压缩</span><br>gzip_min_length 1k;<br><br><span class="hljs-comment">#启⽤压缩功能时，协议的最⼩版本，默认HTTP/1.1</span><br>gzip_http_version 1.0 | 1.1;<br><br><span class="hljs-comment">#指定Nginx服务需要向服务器申请的缓存空间的个数*⼤⼩，默认32 4k|16 8k;</span><br>gzip_buffers number size;<br><br><span class="hljs-comment">#指明仅对哪些类型的资源执⾏压缩操作；默认为gzip_types text/html，不⽤显⽰指定，否则出错，可以在/apps/nginx/conf/mine.type里查看类型</span><br>gzip_types mime-type ...;<br><br><span class="hljs-comment">#如果启⽤压缩，是否在响应报⽂⾸部插⼊“Vary: Accept-Encoding”</span><br>gzip_vary on | off;<br></code></pre></td></tr></table></figure><p>范例：开启压缩功能，并测试</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/nginx.conf<br>http &#123;<br>    ......<br>    <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">gzip_buffers</span> <span class="hljs-number">128</span> <span class="hljs-number">4k</span><br>    gzip_comp_level <span class="hljs-number">5</span>;<br>    <span class="hljs-attribute">gzip_min_length</span> <span class="hljs-number">1k</span>;<br>    <span class="hljs-attribute">gzip_types</span> text/plain application/javascript application/x-javascript text/cssapplication/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;<br>    <span class="hljs-attribute">gzip_vary</span> <span class="hljs-literal">on</span>;<br>&#125;<br><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> /download &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;     <br>        <span class="hljs-attribute">default_type</span> text/html;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#测试</span><br>cd /data/nginx/html/pc/download/<br>cp /apps/nginx/logs/access.log /data/nginx/html/pc/download/m.txt<br>echo <span class="hljs-string">&quot;test&quot;</span> &gt; /data/nginx/html/pc/download/test.html <span class="hljs-comment">#小于1k的文件测试是否会压缩</span><br><span class="hljs-comment">#查看文件</span><br>ls<br>.....<br>-rw-r--r-- <span class="hljs-number">1</span> root  root  <span class="hljs-number">5918</span> Feb <span class="hljs-number">15</span> <span class="hljs-number">22</span>:<span class="hljs-number">23</span> m.txt<br>-rw-r--r-- <span class="hljs-number">1</span> root  root     <span class="hljs-number">5</span> Feb <span class="hljs-number">15</span> <span class="hljs-number">22</span>:<span class="hljs-number">23</span> test.html<br><span class="hljs-comment">#curl测试是否有开启压缩</span><br>curl --head --compressed http://www.rlinpc.net/test.html<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: M<span class="hljs-literal">on</span>, <span class="hljs-number">15</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">19</span> GMT<br>Content-Type: text/html<br>Content-Length: <span class="hljs-number">5</span><br>Last-Modified: M<span class="hljs-literal">on</span>, <span class="hljs-number">15</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">23</span>:<span class="hljs-number">44</span> GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;602a83f0-5&quot;</span><br>Accept-Ranges: bytes<br><span class="hljs-comment">#文件太小没有开启压缩</span><br><br>curl --head --compressed http://www.rlinpc.net/m.txt<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: M<span class="hljs-literal">on</span>, <span class="hljs-number">15</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">32</span> GMT<br>Content-Type: text/plain<br>Last-Modified: M<span class="hljs-literal">on</span>, <span class="hljs-number">15</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">23</span>:<span class="hljs-number">38</span> GMT<br>Connection: keep-alive<br>Vary: Accept-Encoding<br>ETag: W/<span class="hljs-string">&quot;602a83ea-171e&quot;</span><br>Content-Encoding: gzip <span class="hljs-comment">#有开启压缩</span><br></code></pre></td></tr></table></figure><h3 id="2-6-https功能"><a href="#2-6-https功能" class="headerlink" title="2.6 https功能"></a>2.6 https功能</h3><p>Web⽹站的登录⻚⾯都是使⽤https加密传输的，加密数据以保障数据的安全，HTTPS能够加密信息，以免敏感信息被第三⽅获取，所以很多银⾏⽹站或电⼦邮箱等等安全级别较⾼的服务都会采⽤HTTPS协议，HTTPS其实是有两部分组成：HTTP + SSL / TLS，也就是在HTTP上⼜加了⼀层处理加密信息的模块。服务端和客⼾端的信息传输都会通过TLS进⾏加密，所以传输的数据都是加密后的数据。</p><p>![](<a href="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce.jpg">https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce.jpg</a> https实现过程图例)</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-keyword">https</span> 实现过程如下：<br><span class="hljs-number">1.</span>客户端发起HTTPS请求：<br>客户端访问某个web端的<span class="hljs-keyword">https</span>地址，一般都是<span class="hljs-number">443</span>端口<br><br><span class="hljs-number">2.</span>服务端的配置：<br>采用<span class="hljs-keyword">https</span>协议的服务器必须要有一套证书，可以通过一些组织申请，也可以自己制作，目前国内很多网站都自己做的，当你访问一个网站的时候提示证书不可信任就表示证书是自己做的，证书就是一个公钥和私钥匙，就像一把锁和钥匙，正常情况下只有你的钥匙可以打开你的锁，你可以把这个送给别人让他锁住一个箱子，里面放满了钱或秘密，别人不知道里面放了什么而且别人也打不开，只有你的钥匙是可以打开的。<br><br><span class="hljs-number">3.</span>传送证书：<br>服务端给客户端传递证书，其实就是公钥，里面包含了很多信息，例如证书得到颁发机构、过期时间等等。<br><br><span class="hljs-number">4.</span>客户端解析证书：<br>这部分工作是有客户端完成的，首先回验证公钥的有效性，比如颁发机构、过期时间等等，如果发现异常则会弹出一个警告框提示证书可能存在问题，如果证书没有问题就生成一个随机值，然后用证书对该随机值进行加密，就像<span class="hljs-number">2</span>步骤所说把随机值锁起来，不让别人看到。<br><br><span class="hljs-number">5.</span>传送<span class="hljs-number">4</span>步骤的加密数据：<br>就是将用证书加密后的随机值传递给服务器，目的就是为了让服务器得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值进行加密解密了。<br><br><span class="hljs-number">6.</span>服务端解密信息：<br>服务端用私钥解密<span class="hljs-number">5</span>步骤加密后的随机值之后，得到了客户端传过来的随机值(私钥)，然后把内容通过该值进行对称加密，对称加密就是将信息和私钥通过算法混合在一起，这样除非你知道私钥，不然是无法获取其内部的内容，而正好客户端和服务端都知道这个私钥，所以只要机密算法够复杂就可以保证数据的安全性。<br><br><span class="hljs-number">7.</span>传输加密后的信息:<br>服务端将用私钥加密后的数据传递给客户端，在客户端可以被还原出原数据内容。<br><br><span class="hljs-number">8.</span>客户端解密信息：<br>客户端用之前生成的私钥获解密服务端传递过来的数据，由于数据一直是加密的，因此即使第三方获取到数据也无法知道其详细内容。<br></code></pre></td></tr></table></figure><h4 id="2-6-1-https-配置参数"><a href="#2-6-1-https-配置参数" class="headerlink" title="2.6.1 https 配置参数"></a>2.6.1 https 配置参数</h4><p>nginx 的https 功能基于模块ngx_http_ssl_module实现，因此如果是编译安装的nginx要使⽤参数ngx_http_ssl_module开启ssl功能，但是作为nginx的核⼼功能，yum安装的nginx默认就是开启的，编译安装的nginx需要指定编译参数–with-http)ssl_module开启。<br>官方文档：<a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html">https://nginx.org/en/docs/http/ngx_http_ssl_module.html</a></p><p>配置参数如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ssl</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span>;<br><span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br><span class="hljs-comment">#为指定的虚拟主机配置是否启⽤ssl功能，此功能在1.15.0废弃，使⽤listen [ssl]替代。</span><br><br><span class="hljs-attribute">ssl_certificate</span> /path/to/file;<br><span class="hljs-comment">#当前虚拟主机使⽤使⽤的公钥⽂件，⼀般是crt⽂件</span><br><br><span class="hljs-attribute">ssl_certificate_key</span> /path/to/file;<br><span class="hljs-comment">#当前虚拟主机使⽤的私钥⽂件，⼀般是key⽂件</span><br><br><span class="hljs-attribute">ssl_protocols</span> [SSLv2] [SSLv3] [TLSv1] [TLSv1.<span class="hljs-number">1</span>] [TLSv1.<span class="hljs-number">2</span>];<br><span class="hljs-comment">#⽀持ssl协议版本，早期为ssl,现在是TSL，默认为后三个</span><br><br><span class="hljs-attribute">ssl_session_cache</span> <span class="hljs-literal">off</span> | <span class="hljs-literal">none</span> | [builtin[:size]] [shared:name:size];<br><span class="hljs-comment">#配置ssl缓存</span><br>off： <span class="hljs-comment">#关闭缓存</span><br>none: <span class="hljs-comment">#通知客⼾端⽀持ssl session cache，但实际不⽀持</span><br>builtin[:size]：<span class="hljs-comment">#使⽤OpenSSL内建缓存，为每worker进程私有</span><br>[shared:name:size]：<span class="hljs-comment">#在各worker之间使⽤⼀个共享的缓存，需要定义⼀个缓存名称和缓存空间⼤⼩，⼀兆可以存储4000个会话信息，多个虚拟主机可以使⽤相同的缓存名称。</span><br><br><span class="hljs-attribute">ssl_session_timeout</span> time; <span class="hljs-comment">#客⼾端连接可以复⽤ssl session cache中缓存的有效时⻓，默认5m</span><br></code></pre></td></tr></table></figure><h4 id="2-6-2-自签名证书"><a href="#2-6-2-自签名证书" class="headerlink" title="2.6.2 自签名证书"></a>2.6.2 自签名证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#⾃签名CA证书</span><br>mkdir /apps/nginx/certs -p<br><span class="hljs-built_in">cd</span> /apps/nginx/certs<br>openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 3650 -out ca.crt<br>Generating a 4096 bit RSA private key<br>.................++<br>.....<br>Country Name (2 letter code) [XX]:CN <span class="hljs-comment">#国家代码,https://country-code.cl/</span><br>State or Province Name (full name) []:BeiJing <span class="hljs-comment">#省份</span><br>Locality Name (eg, city) [Default City]:Beijing <span class="hljs-comment">#城市名称</span><br>Organization Name (eg, company) [Default Company Ltd]:rlin.Ltd <span class="hljs-comment">#公司名称</span><br>Organizational Unit Name (eg, section) []:rlin <span class="hljs-comment">#部⻔</span><br>Common Name (eg, your name or your server<span class="hljs-string">&#x27;s hostname) []:ca.rlin.org #通⽤名称</span><br><span class="hljs-string">Email Address []:346636558@qq.com #邮箱</span><br><span class="hljs-string"></span><br><span class="hljs-string">ll ca.crt #查看生成的文件</span><br><span class="hljs-string">-rw-r--r--  1 root  root  2130 Feb 16 06:28 ca.crt</span><br><span class="hljs-string">-rw-------  1 root  root  3272 Feb 16 06:28 ca.key</span><br><span class="hljs-string"></span><br><span class="hljs-string">#⾃制key和csr⽂件</span><br><span class="hljs-string">[root@s2 certs]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout www.rlinpc.net.key -out www.rlinpc.net.csr</span><br><span class="hljs-string">Generating a 4096 bit RSA private key</span><br><span class="hljs-string">........................................................................++</span><br><span class="hljs-string">......</span><br><span class="hljs-string">Country Name (2 letter code) [XX]:CN</span><br><span class="hljs-string">State or Province Name (full name) []:BeiJing</span><br><span class="hljs-string">Locality Name (eg, city) [Default City]:BeiJing</span><br><span class="hljs-string">Organization Name (eg, company) [Default Company Ltd]:rlinpc.net</span><br><span class="hljs-string">Organizational Unit Name (eg, section) []:rlinpc.net</span><br><span class="hljs-string">Common Name (eg, your name or your server&#x27;</span>s hostname) []:www.rlinpc.net<br>Email Address []:346636558@qq.com<br>Please enter the following <span class="hljs-string">&#x27;extra&#x27;</span> attributes<br>to be sent with your certificate request<br>A challenge password []:<br>An optional company name []:<br>注意：密码不用填直接回车<br>ls <br>ca.crt<br>ca.key<br>www.rlin.net.csr<br>www.rlin.net.key<br><br><span class="hljs-comment">#签发证书</span><br>openssl x509 -req -days 3650 -<span class="hljs-keyword">in</span> www.rlinpc.net.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out www.rlinpc.net.crt<br>Signature ok<br>subject=C = CN, ST = BeiJing, L = BeiJing, O = rlinpc.net, OU = rlinpc.net, CN = www.rlinpc.net, emailAddress = 346636558@.qq.com<br>Getting CA Private Key<br><br><span class="hljs-comment">#验证证书内容</span><br>openssl x509 -<span class="hljs-keyword">in</span> www.rlinpc.net.crt -noout -text<br>Certificate:<br>    Data:<br>        Version: 1 (0x0)<br>        Serial Number:<br>            2a:bf:c2:c4:7b:b8:63:4b:90:55:ff:30:61:36:59:76:28:d8:03:bf<br>        Signature Algorithm: sha256WithRSAEncryption<br>        Issuer: C = CN, ST = BeiJing, L = Beijing, O = rlin.Ltd, OU = rlin, CN = ca.rlin.org, emailAddress = 346636558@qq.com<br>        Validity<br>            Not Before: Feb 15 22:39:04 2021 GMT<br>            Not After : Feb 13 22:39:04 2031 GMT<br>        Subject: C = CN, ST = BeiJing, L = BeiJing, O = rlinpc.net, OU = rlinpc.net, CN = www.rlinpc.net, emailAddress = 346636558@.qq.com<br>        Subject Public Key Info:<br>            Public Key Algorithm: rsaEncryption<br>                RSA Public-Key: (4096 bit)<br>                ......<br></code></pre></td></tr></table></figure><h4 id="2-6-3-nginx证书配置"><a href="#2-6-3-nginx证书配置" class="headerlink" title="2.6.3 nginx证书配置"></a>2.6.3 nginx证书配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>    <span class="hljs-attribute">ssl_certificate</span> /apps/nginx/certs/www.rlinpc.net.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> /apps/nginx/certs/www.rlinpc.net.key;<br>    <span class="hljs-attribute">ssl_session_cache</span> shared:sslcache:<span class="hljs-number">20m</span>;<br>    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br>浏览器访问 https://www.rlinpc.net ，出现不信任，就在高级里点击继续访问<br></code></pre></td></tr></table></figure><p>![](<a href="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-zhengshuyanzheng.jpg">https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-zhengshuyanzheng.jpg</a> Nginx证书验证)</p><h4 id="2-6-4-实现多域名https"><a href="#2-6-4-实现多域名https" class="headerlink" title="2.6.4 实现多域名https"></a>2.6.4 实现多域名https</h4><p>Nginx⽀持基于单个IP实现多域名的功能，并且还⽀持单IP多域名的基础之上实现HTTPS，其实是基于Nginx的SNI（Server Name Indication）功能实现，SNI是为了解决⼀个Nginx服务器内使⽤⼀个IP绑定多个域名和证书的功能，其具体功能是客⼾端在连接到服务器建⽴SSL链接之前先发送要访问站点的域名（Hostname），这样服务器再根据这个域名返回给客⼾端⼀个合适的证书。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#制作key和csr⽂件</span><br>openssl req -newkey rsa:4096 -nodes -sha256 -keyout mobile.rlin.net.key -out mobile.rlin.net.csr<br>Generating a 4096 bit RSA private key<br>..........<br>Country Name (2 letter code) [XX]:CN<br>State or Province Name (full name) []:BeiJing<br>Locality Name (eg, city) [Default City]:BeiJing<br>Organization Name (eg, company) [Default Company Ltd]:rlin<br>Organizational Unit Name (eg, section) []:rlin<br>Common Name (eg, your name or your server<span class="hljs-string">&#x27;s hostname) []:mobile.rlin.net</span><br><span class="hljs-string">Email Address []:346636558@qq.com</span><br><span class="hljs-string">Please enter the following &#x27;</span>extra<span class="hljs-string">&#x27; attributes</span><br><span class="hljs-string">to be sent with your certificate request</span><br><span class="hljs-string">A challenge password []:</span><br><span class="hljs-string">An optional company name []:</span><br><span class="hljs-string"></span><br><span class="hljs-string">#签名证书</span><br><span class="hljs-string">openssl x509 -req -days 3650 -in mobile.rlin.net.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out mobile.rlin.net.crt</span><br><span class="hljs-string">reateserial -out mobile.rlin.net.crt</span><br><span class="hljs-string">Signature ok</span><br><span class="hljs-string">subject=C = CN, ST = BeiJing, L = BeiJing, O = rlin, OU = rlin, CN = mobile.rlin.net, emailAddress = 346636558@qq.com</span><br><span class="hljs-string">Getting CA Private Key</span><br><span class="hljs-string"></span><br><span class="hljs-string">#验证证书内容</span><br><span class="hljs-string">openssl x509 -in mobile.rlin.net.crt -noout -text</span><br><span class="hljs-string">Certificate:</span><br><span class="hljs-string">    Data:</span><br><span class="hljs-string">        Version: 1 (0x0)</span><br><span class="hljs-string">        Serial Number:</span><br><span class="hljs-string">            2a:bf:c2:c4:7b:b8:63:4b:90:55:ff:30:61:36:59:76:28:d8:03:c0</span><br><span class="hljs-string">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="hljs-string">        Issuer: C = CN, ST = BeiJing, L = Beijing, O = rlin.Ltd, OU = rlin, CN = ca.rlin.org, emailAddress = 346636558@qq.com</span><br><span class="hljs-string">        Validity</span><br><span class="hljs-string">            Not Before: Feb 15 22:53:52 2021 GMT</span><br><span class="hljs-string">            Not After : Feb 13 22:53:52 2031 GMT</span><br><span class="hljs-string">        Subject: C = CN, ST = BeiJing, L = BeiJing, O = rlin, OU = rlin, CN = mobile.rlin.net, emailAddress = 346636558@qq.com</span><br><span class="hljs-string">        Subject Public Key Info:</span><br><span class="hljs-string">            Public Key Algorithm: rsaEncryption</span><br><span class="hljs-string">                RSA Public-Key: (4096 bit)</span><br><span class="hljs-string"></span><br><span class="hljs-string">..............</span><br><span class="hljs-string"></span><br><span class="hljs-string">#Nginx 配置</span><br><span class="hljs-string">vim /apps/nginx/conf/conf.d/mobile.conf</span><br><span class="hljs-string">server &#123;</span><br><span class="hljs-string">listen 80;</span><br><span class="hljs-string">server_name mobile.rlin.net;</span><br><span class="hljs-string">location / &#123;</span><br><span class="hljs-string">root html;</span><br><span class="hljs-string">index index.html index.htm;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">location /linux38 &#123;</span><br><span class="hljs-string">root /data/nginx/html/mobile;</span><br><span class="hljs-string">index index.html index.htm;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">location /python &#123;</span><br><span class="hljs-string">root /data/nginx/html/mobile;</span><br><span class="hljs-string">index index.html index.htm;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">server &#123;</span><br><span class="hljs-string">#一般公司的中小型网站值需要配置listen、ssl_certificate、ssl_certificate_key</span><br><span class="hljs-string">listen 443 ssl; </span><br><span class="hljs-string">server_name mobile.rlin.net;</span><br><span class="hljs-string">ssl_certificate /apps/nginx/certs/mobile.rlin.net.crt;</span><br><span class="hljs-string">ssl_certificate_key /apps/nginx/certs/mobile.rlin.net.key;</span><br><span class="hljs-string">ssl_session_cache shared:sslcache:20m;</span><br><span class="hljs-string">ssl_session_timeout 10m;</span><br><span class="hljs-string">location / &#123;</span><br><span class="hljs-string">root /data/nginx/html/mobile;</span><br><span class="hljs-string">index index.html index.htm;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">/apps/nginx/sbin/nginx -t</span><br><span class="hljs-string">/apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-string">#浏览器使用移动端访问 mobile.rlin.net.key</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-mobilessl.png"></p><h4 id="2-6-5-实现-HSTS"><a href="#2-6-5-实现-HSTS" class="headerlink" title="2.6.5 实现 HSTS"></a>2.6.5 实现 HSTS</h4><p>官方文档:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/<br></code></pre></td></tr></table></figure><p><strong>注意: 配置rewrite才能实现http跳转到https</strong><br>范例:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>         <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>                    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>         <span class="hljs-attribute">ssl_certificate</span> /apps/nginx/certs/www.rlin.net.crt;<br>         <span class="hljs-attribute">ssl_certificate_key</span> /apps/nginx/certs/www.rlin.net.key;<br>         <span class="hljs-attribute">ssl_session_cache</span> shared:sslcache:<span class="hljs-number">20m</span>;<br>         <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;<br>         <span class="hljs-attribute">add_header</span> Strict-Transport-Security <span class="hljs-string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;<br>         <span class="hljs-attribute">location</span> / &#123;<br>              <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>                              <span class="hljs-attribute">if</span> ( $scheme = http ) &#123;<br>                                        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(.*)$</span> https://www.rlinpc.net/<span class="hljs-variable">$1</span> <span class="hljs-literal">redirect</span>;    <br>                                &#125;<br>          &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br>curl -ikL https://www.rlinpc.net<br><br></code></pre></td></tr></table></figure><h3 id="2-6-关于favicon-ico"><a href="#2-6-关于favicon-ico" class="headerlink" title="2.6 关于favicon.ico"></a>2.6 关于favicon.ico</h3><p>favicon.ico 文件是浏览器收藏网址时显示的图标，当客户端使用浏览器问页面时，浏览器会自己主动发起请求获取页面的favicon.ico文件，但是当浏览器请求的favicon.ico文件不存在时，服务器会记录404日志，而且浏览器也会显示404报错<br>下载ico图片，将图片放在/opt/static<br>解决方法：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#方法一：服务器不记录访问日志：</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>                    <span class="hljs-attribute">server_name</span> www.magedu.org;<br>        <span class="hljs-attribute">location</span> = /favicon.ico &#123;<br>                  <span class="hljs-attribute">log_not_found</span> <span class="hljs-literal">off</span>;<br>                  <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;<br>        &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#方法二：将图标保存到指定目录访问</span><br><span class="hljs-attribute">mkdir</span> -p /opt/static<br>cd /opt/static<br>wget ico图片地址<br><br>vim /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>                   <span class="hljs-attribute">server_name</span> www.magedu.org;<br>        <span class="hljs-attribute">location</span> = /favicon.ico&#123;<br>        <span class="hljs-attribute">root</span> /opt/static;<br>        <span class="hljs-attribute">expires</span> <span class="hljs-number">90d</span>; <span class="hljs-comment">#设置⽂件过期时间</span><br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h3 id="2-7-安全选项"><a href="#2-7-安全选项" class="headerlink" title="2.7 安全选项"></a>2.7 安全选项</h3><h4 id="2-7-1-隐藏nginx版本号"><a href="#2-7-1-隐藏nginx版本号" class="headerlink" title="2.7.1 隐藏nginx版本号"></a>2.7.1 隐藏nginx版本号</h4><p>更改nginx源码信息并重新编译nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#更改nginx源码信息</span><br>vim /usr/<span class="hljs-built_in">local</span>/src/nginx-1.6.1/src/http/ngx_http_header_filter_module.c<br><span class="hljs-comment">#在第49行，定义响应报⽂中的server字段信息</span><br>static u_char ngx_http_server_string[] = <span class="hljs-string">&quot;Server: rlin-nginx&quot;</span> CRLF; <span class="hljs-comment">#定义响应报文中的server字段信息</span><br><br><span class="hljs-comment">#获取原nginx编译信息</span><br>/apps/nginx/sbin/nginx -V<br><br><span class="hljs-comment">#关闭nginx</span><br>/apps/nginx/sbin/nginx -s stop<br><br><span class="hljs-comment">#重新编译</span><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1/<br>./configure --prefix=/apps/nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_image_filter_module --with-http_geoip_module --with-http_gunzip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/<span class="hljs-built_in">local</span>/src/echo-nginx-module<br>make<br>make install<br><br>/apps/nginx/sbin/nginx <br><span class="hljs-comment">#浏览器访问https://www.rlinpc.net</span><br></code></pre></td></tr></table></figure><h4 id="2-7-2-升级OpenSSL版本"><a href="#2-7-2-升级OpenSSL版本" class="headerlink" title="2.7.2 升级OpenSSL版本"></a>2.7.2 升级OpenSSL版本</h4><p>⼼脏出⾎（英语：Heartbleed），也简称为⼼⾎漏洞，是⼀个出现在加密程序库OpenSSL的安全漏洞，该程序库⼴泛⽤于实现互联⽹的传输层安全（TLS）协议。它于2012年被引⼊了软件中，2014年4⽉⾸次向公众披露。只要使⽤的是存在缺陷的OpenSSL实例，⽆论是服务器还是客⼾端，都可能因此⽽受到攻击。此问题的原因是在实现TLS的⼼跳扩展时没有对输⼊进⾏适当验证（缺少边界检查），因此漏洞的名称来源于“⼼跳”（heartbeat）。该程序错误属于缓冲区过读，即可以读取的数据⽐应该允许读取的还多。</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#关闭nginx</span><br>/apps/nginx/sbin/nginx -s stop<br><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br><span class="hljs-comment">#在官网上找到源码包，并且下载到这个目录下</span><br><span class="hljs-comment">#解压</span><br>tar xvf openssl-1.1.1d<br><br><span class="hljs-comment">#重新编译nginx</span><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/nginx-1.6.1<br>/apps/nginx/sbin/nginx -V<br>./configure --prefix=/apps/nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_image_filter_module --with-http_geoip_module --with-http_gunzip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/<span class="hljs-built_in">local</span>/src/echo-nginx-module --with-openssl=/usr/<span class="hljs-built_in">local</span>/src/openssl-1.1.1d<br><br>make<br>make install<br><br><span class="hljs-comment">#验证并启动Nginx：</span><br>/apps/nginx/sbin/nginx -t<br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>/apps/nginx/sbin/nginx<br></code></pre></td></tr></table></figure><h2 id="三、Nginx-rewrite-相关功能"><a href="#三、Nginx-rewrite-相关功能" class="headerlink" title="三、Nginx rewrite 相关功能"></a>三、Nginx rewrite 相关功能</h2><p>Nginx服务器利⽤ngx_http_rewrite_module 模块解析和处理rewrite请求，此功能依靠 PCRE(perl compatibleregularexpression)，因此编译之前要安装PCRE库，rewrite是nginx服务器的重要功能之⼀，⽤于实现URL的重写，URL的重写是⾮常有⽤的功能，⽐如它可以在我们改变⽹站结构之后，不需要客⼾端修改原来的书签，也⽆需其他⽹站修改我们的链接，就可以设置为访问，另外还可以在⼀定程度上提⾼⽹站的安全性。</p><h3 id="3-1-ngx-http-rewrite-module模块指令：https-nginx-org-en-docs-http-ngx-http-rewrite-module-html"><a href="#3-1-ngx-http-rewrite-module模块指令：https-nginx-org-en-docs-http-ngx-http-rewrite-module-html" class="headerlink" title="3.1 ngx_http_rewrite_module模块指令：https://nginx.org/en/docs/http/ngx_http_rewrite_module.html"></a>3.1 ngx_http_rewrite_module模块指令：<a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html</a></h3><h4 id="3-1-1-if指令"><a href="#3-1-1-if指令" class="headerlink" title="3.1.1 if指令"></a>3.1.1 if指令</h4><p>⽤于条件匹配判断，并根据条件判断结果选择不同的Nginx配置，可以配置在server或location块中进⾏配置，Nginx的if语法仅能使⽤if做单次判断，不⽀持使⽤if else或者if elif这样的多重判断，⽤法如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span> （条件匹配） &#123;<br>action<br>&#125;<br></code></pre></td></tr></table></figure><p>使⽤正则表达式对变量进⾏匹配，匹配成功时if指令认为条件为true，否则认为false，变量与表达式之间使⽤以下符号链接：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">=： <span class="hljs-comment">#⽐较变量和字符串是否相等，相等时if指令认为该条件为true，反之为false。</span><br>!=: <span class="hljs-comment">#⽐较变量和字符串是否不相等，不相等时if指令认为条件为true，反之为false。</span><br>~： <span class="hljs-comment">#表⽰在匹配过程中区分⼤⼩写字符，（可以通过正则表达式匹配），满⾜匹配条件为真，不满⾜为假。</span><br>!~：<span class="hljs-comment">#为区分⼤⼩写字符且匹配结果不匹配，不满⾜为真，满⾜为假。</span><br>~*: <span class="hljs-comment">#表⽰在匹配过程中不区分⼤⼩写字符，（可以通过正则表达式匹配），满⾜匹配条件为真，不满⾜为假。</span><br>!~*: <span class="hljs-comment">#为不区分⼤⼩字符且匹配结果不匹配，满⾜为假，不满⾜为真。</span><br>-f 和 ! -f: <span class="hljs-comment">#判断请求的⽂件是否存在和是否不存在</span><br>-d 和 ! -d: <span class="hljs-comment">#判断请求的⽬录是否存在和是否不存在。</span><br>-x 和 ! -x: <span class="hljs-comment">#判断⽂件是否可执⾏和是否不可执⾏。</span><br>-e 和 ! -e: <span class="hljs-comment">#判断请求的⽂件或⽬录是否存在和是否不存在(包括⽂件，⽬录，软链接)。</span><br><span class="hljs-comment">#实例-1：</span><br>location /main &#123;<br>index index.html;<br>default_type text/html;<br><span class="hljs-keyword">if</span> ( <span class="hljs-variable">$scheme</span> = http )&#123;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;if-----&gt; <span class="hljs-variable">$scheme</span>&quot;</span>;<br>&#125;<br><span class="hljs-keyword">if</span> ( <span class="hljs-variable">$scheme</span> = https )&#123;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;if ----&gt; <span class="hljs-variable">$scheme</span>&quot;</span>;<br>&#125;<br><span class="hljs-comment">#if (-f $request_filename) &#123;</span><br><span class="hljs-comment"># echo &quot;file is exist&quot;;</span><br><span class="hljs-comment">#&#125;</span><br><span class="hljs-keyword">if</span> (!-f <span class="hljs-variable">$request_filename</span>) &#123;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;file is not exist&quot;</span>;<br><span class="hljs-comment">#return 409;</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>注： 如果$变量的值为空字符串或是以0开头的任意字符串，则if指令认为该条件为false，其他条件为true。<br>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">if</span> ( $scheme = http )&#123;<br>            <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;if-----&gt; $scheme&quot;</span>;<br>        &#125;<br>        <span class="hljs-attribute">if</span> ( $scheme = https )&#123;<br>            <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;if--rlin---&gt; $scheme&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问</span><br>http://www.rlinpc.conf<br>https://www.rilnpc.conf<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">if</span> (-f $request_filename) &#123;<br>            <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;file is exist&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">if</span> (!-f $request_filename) &#123;<br>            <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;file is not exist&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure><h4 id="3-1-2-set指令"><a href="#3-1-2-set指令" class="headerlink" title="3.1.2 set指令"></a>3.1.2 set指令</h4><p>指定key并给其定义⼀个变量，变量可以调⽤Nginx内置变量赋值给key，另外set定义格式为set $key $value，及⽆论是key还是value都要加$符号。（类似nginx的自定义变量）</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /&#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">default_type</span> text/html;<br>        <span class="hljs-attribute">set</span> $NAME rlin;<br>        <span class="hljs-attribute">echo</span> $NAME;<br>        <span class="hljs-attribute">set</span> $MY_PORT $server_port;<br>        <span class="hljs-attribute">echo</span> $MY_PORT;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><h4 id="3-1-3-break指令"><a href="#3-1-3-break指令" class="headerlink" title="3.1.3 break指令"></a>3.1.3 break指令</h4><p>⽤于__中断__当前相同作⽤域(location)中的其他Nginx配置，与该指令处于同⼀作⽤域的Nginx配置中，位于它前⾯的配置⽣效，位于后⾯的指令配置就不再⽣效了，Nginx服务器在根据配置处理请求的过程中遇到该指令的时候，回到上⼀层作⽤域继续向下读取配置，该指令可以在server块和location块以及if块中使⽤，使⽤语法如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">location</span> /main &#123;<br>  <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>  <span class="hljs-attribute">index</span> index.html;<br>  <span class="hljs-attribute">default_type</span> text/html;<br>  <span class="hljs-attribute">set</span> $name magedu;<br>     <span class="hljs-attribute">echo</span> $name;<br>  break;<br>  <span class="hljs-attribute">set</span> $my_port $server_port;<br>  <span class="hljs-attribute">echo</span> $my_port;<br> &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><h4 id="3-1-4-return指令"><a href="#3-1-4-return指令" class="headerlink" title="3.1.4 return指令"></a>3.1.4 return指令</h4><p>从nginx版本0.8.2开始⽀持，return⽤于完成对请求的处理，并直接向客⼾端返回响应状态码，⽐如其可以指定重定向URL(对于特殊重定向状态码，301/302等) 或者是指定提⽰⽂本内容(对于特殊状态码403/500等)，处于此指令后的所有配置都将不被执⾏，return可以在server、if和location块进⾏配置，⽤法如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">return</span> code; <span class="hljs-comment">#返回给客⼾端指定的HTTP状态码</span><br><span class="hljs-attribute">return</span> code (text); <span class="hljs-comment">#返回给客⼾端的状态码及响应体内容，可以调⽤变量</span><br><span class="hljs-attribute">return</span> code URL； <span class="hljs-comment">#返回给客⼾端的URL地址</span><br>例如：<br>server &#123;<br>     <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>     <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>     <span class="hljs-attribute">location</span> /main &#123;<br>     <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>     <span class="hljs-attribute">default_type</span> text/html;<br>     <span class="hljs-attribute">index</span> index.html;<br>     <span class="hljs-attribute">if</span> ( $scheme = http )&#123;<br>        <span class="hljs-comment">#return 666;</span><br>        <span class="hljs-comment">#return 666 &quot;not allow http&quot;;</span><br>        <span class="hljs-comment">#return 301 http://www.baidu.com;</span><br>        <span class="hljs-attribute">return</span> <span class="hljs-number">500</span> <span class="hljs-string">&quot;service error&quot;</span>;<br>         <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;if-----&gt; $scheme&quot;</span>; <span class="hljs-comment">#return后⾯的将不再执⾏</span><br>     &#125;<br>     <span class="hljs-attribute">if</span> ( $scheme = https )&#123;<br>        <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;if ----&gt; $scheme&quot;</span>;<br>     &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net<br>    location /index2 &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html<br>        retuen <span class="hljs-number">999</span> <span class="hljs-string">&quot;rlin&quot;</span>;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br>mkdir -p /data/nginx/html/pc/index2/<br>echo <span class="hljs-string">&quot;index2&quot;</span> &gt; /data/nginx/html/pc/index2/index.html<br><span class="hljs-comment">#浏览器访问www.rlinpc.net/index2</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /index2 &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html；<br>        retuen <span class="hljs-number">301</span> http://www.jd.com;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net/index2</span><br></code></pre></td></tr></table></figure><p>范例：简单实现https全栈</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html;<br>        <span class="hljs-attribute">if</span> ( $scheme = http )&#123;<br>            <span class="hljs-attribute">retuen</span> <span class="hljs-number">301</span> https://www.bilibili.com;<br>        &#125;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><h4 id="3-1-5-rewrite-log指令"><a href="#3-1-5-rewrite-log指令" class="headerlink" title="3.1.5 rewrite_log指令"></a>3.1.5 rewrite_log指令</h4><p>设置是否开启记录ngx_http_rewrite_module模块日志记录到error_log日志文件当中，可以配置在http、server、location或if当中。</p><p><strong>注意：需要日志级别为notice 。</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>     <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>     <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>     <span class="hljs-attribute">location</span> /main &#123;<br>     <span class="hljs-attribute">index</span> index.html;<br>     <span class="hljs-attribute">default_type</span> text/html;<br>     <span class="hljs-attribute">set</span> $name rlin;<br>     <span class="hljs-attribute">echo</span> $name;<br>     <span class="hljs-attribute">rewrite_log</span> <span class="hljs-literal">on</span>;<br>     break;<br>     <span class="hljs-attribute">set</span> $my_port $server_port;<br>     <span class="hljs-attribute">echo</span> $my_port;<br>     &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nignx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问网站，并验证error_log</span><br>tail -f /apps/nginx/logs/error.log<br></code></pre></td></tr></table></figure><h3 id="3-2-rewrite指令"><a href="#3-2-rewrite指令" class="headerlink" title="3.2 rewrite指令"></a>3.2 rewrite指令</h3><p>通过正则表达式的匹配来改变URI，可以同时存在⼀个或多个指令，按照顺序依次对URI进⾏匹配，rewrite主要是针对⽤⼾请求的URL或者是URI做具体处理，以下是URL和URI的具体介绍：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">URI(universal resource identifier)：通⽤资源标识符，标识⼀个资源的路径，可以不带协议。<br>URL(uniform resource location):统⼀资源定位符，是⽤于在Internet中描述资源的字符串，是URI的⼦集，主要包括传输协议(scheme)、主机(IP、端⼝号或者域名)和资源具体地址(⽬录和⽂件名)等三部分，⼀般格式为scheme://主机名[:端⼝号][/资源路径],如http://www.a.com:8080/path/file/index.html就是⼀个URL路径，URL必须带访问协议。<br>每个URL都是⼀个URI，但是URI不都是URL。<br>例如：<br>http://example.org:8080/path/to/resource.txt <span class="hljs-comment">#URI/URL</span><br>ftp://example.org/resource.txt <span class="hljs-comment">#URI/URL</span><br>/absolute/path/to/resource.txt <span class="hljs-comment">#URI</span><br></code></pre></td></tr></table></figure><p>rewrite的官⽅介绍地址<a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite%EF%BC%8C">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite，</a> rewrite可以配置在server、location、if，其具体使⽤⽅式为</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rewrite regex replacement [flag];<br></code></pre></td></tr></table></figure><p>rewrite将⽤⼾请求的URI基于regex所描述的模式进⾏检查，匹配到时将其替换为表达式指定的新的URI。 注意：如果在同⼀级配置块中存在多个rewrite规则，那么会⾃下⽽下逐个检查；被某条件规则替换完成后，会重新⼀轮的替换检查，隐含有循环机制,但不超过10次；如果超过，提⽰500响应码，[flag]所表⽰的标志位⽤于控制此循环机制，如果替换后的URL是以http://或https://开头，则替换结果会直接以重向返回给客⼾端, 即永久重定向301<br><strong>正则表达式格式</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">. <span class="hljs-comment">#匹配除换行符以外的任意字符</span><br>\w <span class="hljs-comment">#匹配字母或数字或下划线或汉字</span><br>\s <span class="hljs-comment">#匹配任意的空白符</span><br>\d <span class="hljs-comment">#匹配数字</span><br>\b <span class="hljs-comment">#匹配单词的开始或结束</span><br>^ <span class="hljs-comment">#匹配字付串的开始</span><br>$ <span class="hljs-comment">#匹配字符串的结束</span><br>* <span class="hljs-comment">#匹配重复零次或更多次</span><br>+ <span class="hljs-comment">#匹配重复一次或更多次</span><br>? <span class="hljs-comment">#匹配重复零次或一次</span><br>(n) <span class="hljs-comment">#匹配重复n次</span><br>&#123;n,&#125; <span class="hljs-comment">#匹配重复n次或更多次</span><br>&#123;n,m&#125; <span class="hljs-comment">#匹配重复n到m次</span><br>*? <span class="hljs-comment">#匹配重复任意次，但尽可能少重复</span><br>+? <span class="hljs-comment">#匹配重复1次或更多次，但尽可能少重复</span><br>?? <span class="hljs-comment">#匹配重复0次或1次，但尽可能少重复</span><br>&#123;n,m&#125;? <span class="hljs-comment">#匹配重复n到m次，但尽可能少重复</span><br>&#123;n,&#125;? <span class="hljs-comment">#匹配重复n次以上，但尽可能少重复</span><br>\W  <span class="hljs-comment">#匹配任意不是字母，数字，下划线，汉字的字符</span><br>\S <span class="hljs-comment">#匹配任意不是空白符的字符</span><br>\D <span class="hljs-comment">#匹配任意非数字的字符</span><br>\B <span class="hljs-comment">#匹配不是单词开头或结束的位置</span><br>[^x] <span class="hljs-comment">#匹配除了x以外的任意字符</span><br>[^magedu] <span class="hljs-comment">#匹配除了magedu 这几个字母以外的任意字符</span><br></code></pre></td></tr></table></figure><h4 id="3-2-1-rewrite-flag使⽤介绍"><a href="#3-2-1-rewrite-flag使⽤介绍" class="headerlink" title="3.2.1 rewrite flag使⽤介绍"></a>3.2.1 rewrite flag使⽤介绍</h4><p>利⽤nginx的rewrite的指令，可以实现url的重新跳转，rewrtie有四种不同的flag，分别是redirect(临时重定向)、permanent(永久重定向)、break和last。其中前两种是跳转型的flag，后两种是代理型。</p><ul><li>跳转型是指有客⼾端浏览器重新对新地址进⾏请求。</li><li>代理型是在WEB服务器内部实现跳转的。<br>rewrite 格式<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">Syntax: rewrite regex replacement [flag]; <span class="hljs-comment">#通过正则表达式处理⽤⼾请求并返回替换后的数据包。</span><br>Default: — <br>Context: server, location, <span class="hljs-keyword">if</span><br></code></pre></td></tr></table></figure>flag 说明<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">redirect；<br><span class="hljs-comment">#临时重定向，重写完成后以临时重定向⽅式直接返回重写后⽣成的新URL给客⼾端，由客⼾端重新发起请求；使⽤相对路径,或者http://或https://开头，状态码：302</span><br><br>permanent；<br><span class="hljs-comment">#重写完成后以永久重定向⽅式直接返回重写后⽣成的新URL给客⼾端，由客⼾端重新发起请求，状态码：301</span><br><br>last；<br><span class="hljs-comment">#重写完成后停⽌对当前URI在当前location中后续的其它重写操作，⽽后对新的URL启动新⼀轮重写检查，不建议在location中使⽤</span><br><br><span class="hljs-built_in">break</span>；<br><span class="hljs-comment">#重写完成后停⽌对当前URL在当前location中后续的其它重写操作，⽽后直接将匹配结果返还给客⼾端即结束循环并返回数据给客⼾端，建议在location中使⽤</span><br></code></pre></td></tr></table></figure>要求：因业务需要，将访问源域名 <a href="http://www.rlinpc.net/">www.rlinpc.net</a> 的请求永久重定向到<a href="https://www.bilibili.com/">https://www.bilibili.com</a> 。<br>范例：rewrite案例1-域名临时重定向<br>临时重定向不会缓存域名解析记录(A记录)，但是永久重定向会缓存。<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net<br>    location / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">if</span> ( $scheme = http )<br>            &#123;<br>            <span class="hljs-attribute">rewrite</span> / https://www.bilibili.com <span class="hljs-literal">redirect</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问 www.rlinpc.net</span><br></code></pre></td></tr></table></figure>范例：rewrite案例2-域名永久重定向<br>临时重定向不会缓存域名解析记录(A记录)，但是永久重定向会缓存。<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    ......<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">if</span> ( $scheme = http )<br>            &#123;<br>            <span class="hljs-attribute">rewrite</span> / https://www.bilibili.com permanet;<br>        &#125;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问 www.rlinpc.net</span><br></code></pre></td></tr></table></figure><h4 id="3-2-3-rewrite案例–brak与last"><a href="#3-2-3-rewrite案例–brak与last" class="headerlink" title="3.2.3 rewrite案例–brak与last"></a>3.2.3 rewrite案例–brak与last</h4>要求：访问about的请求被转发至images，而访问images传递请求再次被转发至images1，以此测试last和break分别有什么区别<h5 id="3-2-3-1-break案例1"><a href="#3-2-3-1-break案例1" class="headerlink" title="3.2.3.1 break案例1"></a>3.2.3.1 break案例1</h5>范例1：<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#Nginx配置：</span><br>break测试案例：当客户端访问break的时候，测试通过rewrite将URL重写为test1，然后再通过rewrite将<span class="hljs-attribute">test1</span><br>重写为test2测试两条write规则最终哪一条生效，并且测试重写后的URL会不会到其他location重新匹配。<br>vim /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /break &#123;<br>    <span class="hljs-comment">#return 666 &quot;break&quot;;</span><br>    <span class="hljs-attribute">root</span> /data/nginx;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/break/(.*)</span> /test1/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;  <span class="hljs-comment">#break匹配成功后不再向下匹配，也不会跳转到其他的location，即直接结束匹配并给客户端返回结果数据。</span><br>    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/test1/(.*)</span> /test2/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;  <span class="hljs-comment">#break不会匹配后面的rewrite规则也不匹配其他location</span><br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> = /test1 &#123;<br>    <span class="hljs-attribute">return</span> <span class="hljs-number">999</span> <span class="hljs-string">&quot;new test1&quot;</span>;<br>    <span class="hljs-comment">#index index.html;</span><br>    <span class="hljs-comment">#root /data/nginx;</span><br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> = /test2 &#123;<br>    <span class="hljs-attribute">return</span> <span class="hljs-number">666</span> <span class="hljs-string">&quot;new test2&quot;</span>;<br>    <span class="hljs-comment">#root /opt/nginx;</span><br>    <span class="hljs-comment">#index index.html;</span><br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br>curl -L http://www.rlinpc.net/test1 <span class="hljs-comment">#看返回结果是否是new test1</span><br>curl -L http://www.rlinpc.net/test2 <span class="hljs-comment">#看返回结果是否是new test2</span><br><br><span class="hljs-comment">#创建资源路径：</span><br>mkdir /data/nginx/break<br>mkdir /data/nginx/test1<br>mkdir /data/nginx/test2<br>cat /data/nginx/break/index.html<br><span class="hljs-literal">break</span><br>cat /data/nginx/test1/index.html<br>test1<br>cat /data/nginx/test2/index.html<br>test2 <br>/apps/nginx/sbin/nginx -t <br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#break访问测试：</span><br>curl  -L http://www.magedu.net/break/index.html<br>test1 <span class="hljs-comment">#最终的结果不会超出当前break的location，并且不会继续匹配当前location后续的write规则，而是直接返回数据给客户端。</span><br></code></pre></td></tr></table></figure><h5 id="3-2-3-2-break案例"><a href="#3-2-3-2-break案例" class="headerlink" title="3.2.3.2 break案例"></a>3.2.3.2 break案例</h5>范例2：<br>break适用于不改变客户端访问方式，但是要将访问的目的URL做单次重写的场景，比如有V1/V2两个版本的网站前端页面并存，旧版本的网站数据已经保存到了statics不能丢失，但是要将访问新版本的资源重写到新的静态资源路径到新的目录static：<br>就算是访问旧的网站，也会帮你跳转到新的网站上<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">mkdir</span> /data/nginx/static -p<br>mkdir /data/nginx/statics -p<br>echo <span class="hljs-string">&quot;v1&quot;</span> /data/nginx/statics/rlin.js<br>echo <span class="hljs-string">&quot;v2&quot;</span> /data/nginx/static/rlin.js<br><br>vim /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /statics &#123;<br>    <span class="hljs-attribute">root</span> /data/nginx;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-comment">#rewrite ^/statics/(.*) /static/$1 break;</span><br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net/statics/rlin.js</span><br><br>vim /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /statics &#123;<br>    <span class="hljs-attribute">root</span> /data/nginx;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/statics/(.*)</span> /static/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net/statics/rlin.js</span><br><br><span class="hljs-comment">#对比两次浏览器显示的结果</span><br></code></pre></td></tr></table></figure><h5 id="3-2-3-3-last案例"><a href="#3-2-3-3-last案例" class="headerlink" title="3.2.3.3 last案例"></a>3.2.3.3 last案例</h5>last：对某个location的URL匹配成功后会停止当前location的后续rewrite规则，并结束当前location，然后将匹配生成的新URL跳转至其他location继续匹配，直到没有location可匹配后将最后一次location的数据返回给客户端。（在多个location之中来回匹配）<br>last 适用于要不改变客户端访问方式但是需做多次目的URL重写的场景，使用场景不是很多。<br>范例：<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /last &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/last/(.*)</span> /test1/<span class="hljs-variable">$1</span> <span class="hljs-literal">last</span>;<br>        <span class="hljs-comment">#rewrite ^/test1/(.*) /test2/$1 last; #如果第一条rewrite规则匹配成功则不执行本条，否则执行本条rewrite规则。</span><br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /test1 &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx;<br>        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/test1/(.*)</span> /test2/<span class="hljs-variable">$1</span> <span class="hljs-literal">last</span>;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /test2 &#123;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">666</span> <span class="hljs-string">&quot;new test2&quot;</span>;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问</span><br>curl -L http://www.rlinpc.net/last/index.html<br>new test2 <span class="hljs-comment">#会匹配多个location，直到最终全部匹配完成，返回最后一个location的匹配结果给客户端。</span><br><span class="hljs-comment">#last适用于要不改变客户端访问方式但是需做多次目的URL重写的场景，场景不是很多。</span><br></code></pre></td></tr></table></figure><h4 id="3-2-4-rewrite案例-自动跳转https"><a href="#3-2-4-rewrite案例-自动跳转https" class="headerlink" title="3.2.4 rewrite案例: 自动跳转https"></a>3.2.4 rewrite案例: 自动跳转https</h4>要求：基于通信安全考虑公司网站要求全站https，因此要求将在不影响用户请求的情况下将http请求全部自动跳转至https，另外也可以实现部分location跳转<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>    <span class="hljs-attribute">ssl_certificate</span> /apps/nginx/certs/www.rlinpc.net.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> /apps/nginx/certs/www.rlinpc.net.key;<br>    <span class="hljs-attribute">ssl_session_cache</span> shared:sslcache:<span class="hljs-number">20m</span>;<br>    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">location</span> / &#123;   <span class="hljs-comment">#针对全站跳转</span><br>       <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>       <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">if</span> ($scheme = http )&#123;  <span class="hljs-comment">#如果没有加条件判断，会导致死循环</span><br>                          <span class="hljs-attribute">rewrite</span> / https://$host <span class="hljs-literal">redirect</span>;<br>                 &#125; <br>     &#125;<br>     <span class="hljs-attribute">location</span> /login &#123;   <span class="hljs-comment">#针对特定的URL进行跳转https</span><br>        <span class="hljs-attribute">if</span> ($scheme = http )&#123;  <span class="hljs-comment">#如果没有加条件判断，会导致死循环</span><br>        <span class="hljs-attribute">rewrite</span> / https://$host/login <span class="hljs-literal">redirect</span>;<br>        &#125;<br>     &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><br>curl -ikL www.rlinpc.net<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">302</span> Moved Temporarily<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: Wed, <span class="hljs-number">17</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">42</span>:<span class="hljs-number">35</span> GMT<br>Content-Type: text/html<br>Content-Length: <span class="hljs-number">145</span><br>Connection: keep-alive<br>Location: https://www.rlinpc.net<br><br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: Wed, <span class="hljs-number">17</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">42</span>:<span class="hljs-number">35</span> GMT<br>Content-Type: text/html<br>Content-Length: <span class="hljs-number">14</span><br>Last-Modified: M<span class="hljs-literal">on</span>, <span class="hljs-number">15</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">22</span>:<span class="hljs-number">46</span>:<span class="hljs-number">17</span> GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;602af9b9-e&quot;</span><br>Accept-Ranges: bytes<br><br>rlin test web<br></code></pre></td></tr></table></figure>范例: 如果是因为规则匹配问题导致的陷入死循环<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -IkL http://www.magedu.org<br>HTTP/1.1 302 Moved Temporarily<br>Server: nginx/1.18.0<br>Date: Thu, 08 Oct 2020 13:07:19 GMT<br>Content-Type: text/html<br>Content-Length: 145<br>Connection: keep-alive<br>Location: https://www.magedu.org/<br>HTTP/1.1 302 Moved Temporarily<br>Server: nginx/1.18.0<br>Date: Thu, 08 Oct 2020 13:07:19 GMT<br>Content-Type: text/html<br>Content-Length: 145<br>Connection: keep-alive<br>Location: https://www.magedu.org/<br>HTTP/1.1 302 Moved Temporarily<br>Server: nginx/1.18.0<br>Date: Thu, 08 Oct 2020 13:07:19 GMT<br>Content-Type: text/html<br>Content-Length: 145<br>Connection: keep-alive<br>Location: https://www.magedu.org/<br>HTTP/1.1 302 Moved Temporarily<br>Server: nginx/1.18.0<br>Date: Thu, 08 Oct 2020 13:39:59 GMT<br>Content-Type: text/html<br>Content-Length: 145<br>Connection: keep-alive<br>Location: https://www.magedu.org<br><br>curl: (47) Maximum (50) redirects followed<br></code></pre></td></tr></table></figure><h4 id="3-2-5-rewrite-案例-判断文件是否存在"><a href="#3-2-5-rewrite-案例-判断文件是否存在" class="headerlink" title="3.2.5 rewrite 案例: 判断文件是否存在"></a>3.2.5 rewrite 案例: 判断文件是否存在</h4>要求：当用户访问到公司网站的时输入了一个错误的URL，可以将用户重定向至官网首页<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    server_name: www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">if</span> ( !-f $request_filename )&#123;<br>            <span class="hljs-attribute">rewrite</span> (.*) https://www.rlin.net/index.html; <span class="hljs-comment">#实现客户端浏览器的302跳转</span><br>            <span class="hljs-comment">#rewrite .* /index.html; #web服务器内部跳转</span><br>        &#125;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure><h4 id="3-2-6-其它案例"><a href="#3-2-6-其它案例" class="headerlink" title="3.2.6 其它案例"></a>3.2.6 其它案例</h4>范例：如果客户端浏览器包含MSIE，则rewrite客户端请求到/msie目录下<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>     <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>     <span class="hljs-attribute">server_name</span> www.rlinpc.net<br>     location / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">if</span> ( $http_user_agent <span class="hljs-regexp">~ MSIE)</span>&#123;<br>        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^(.*)$</span> /msie/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;<br>        &#125;<br>     &#125;<br>     <br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>范例：更换目录访问方式,目录转换为对象存储形式<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#要求:</span><br><span class="hljs-comment">#/20200106/static -&gt;/static?id=20200106</span><br><span class="hljs-comment">#/20200123/image -&gt;/image?id=20200123</span><br></code></pre></td></tr></table></figure>范例:多目录转换访问方式<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#要求: www.rlinpc.net/images/20200106/1.jpg =&gt; www.rlinpc.net/index.do?name=images&amp;dir=20200106=&amp;file=1.jpg</span><br><span class="hljs-comment">#规则配置:</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>     <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>     <span class="hljs-attribute">server_name</span> www.rlinpc.net<br>     location / &#123;<br>         <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>         <span class="hljs-attribute">index</span> index.html;<br>         <span class="hljs-attribute">if</span> ($host <span class="hljs-regexp">~* (.*)\.rlinpc\.com)</span> &#123;<br>         <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(.*)/(\d+)/(.*)$</span>  /index.do?name=<span class="hljs-variable">$1</span>&amp;dir=<span class="hljs-variable">$2</span>&amp;file=<span class="hljs-variable">$3</span> <span class="hljs-literal">last</span>;<br>         &#125;<br>     &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问测试</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="3-3-nginx-防盗链"><a href="#3-3-nginx-防盗链" class="headerlink" title="3.3 nginx 防盗链"></a>3.3 nginx 防盗链</h3><p>防盗链基于客户端携带的referer实现，referer是记录打开一个页面之前记录是从哪个页面跳转过来的标记信息，如果别人只链接了自己网站图片或某个单独的资源，而不是打开了网站的整个页面，这就是盗链，referer就是之前的那个网站域名，正常的referer信息有以下几种：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">none：请求报文首部没有referer首部，比如用户直接在浏览器输入域名访问web网站，就没有referer信息。<br>blocked：请求报文有referer首部，但无有效值，比如为空。<br>server_names：referer首部中包含本主机名及即nginx 监听的server_name。<br>arbitrary_string：自定义指定字符串，但可使用*作通配符。<br>regular expression：被指定的正则表达式模式匹配到的字符串,要使用~开头，例如~.*\.magedu\.com。<br></code></pre></td></tr></table></figure><p>正常通过搜索引擎搜索web网站并访问该网站的referer信息如下：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">#通过搜索引擎访问web网站的referer信息：</span><br>==&gt; <span class="hljs-regexp">/apps/nginx</span><span class="hljs-regexp">/logs/a</span>ccess_json.log &lt;==<br>&#123;<span class="hljs-string">&quot;@timestamp&quot;</span>:<span class="hljs-string">&quot;2019-02-28T13:58:46+08:00&quot;</span>,<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;192.168.7.102&quot;</span>,<span class="hljs-string">&quot;clientip&quot;</span>:<span class="hljs-string">&quot;192.168.0.1&quot;</span>,<span class="hljs-string">&quot;siz</span><br><span class="hljs-string">e&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;responsetime&quot;</span>:<span class="hljs-number">0</span>.<span class="hljs-number">000</span>,<span class="hljs-string">&quot;upstreamtime&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;upstreamhost&quot;</span>:<span class="hljs-string">&quot;-</span><br><span class="hljs-string">&quot;</span>,<span class="hljs-string">&quot;http_host&quot;</span>:<span class="hljs-string">&quot;www.magedu.net&quot;</span>,<span class="hljs-string">&quot;uri&quot;</span>:<span class="hljs-string">&quot;/index.html&quot;</span>,<span class="hljs-string">&quot;domain&quot;</span>:<span class="hljs-string">&quot;www.magedu.net&quot;</span>,<span class="hljs-string">&quot;xff&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;referer&quot;</span>:<span class="hljs-string">&quot;https://www.baidu.com/s?ie=utf-</span><br><span class="hljs-string">8&amp;f=8&amp;rsv_bp=1&amp;rsv_idx=1&amp;tn=baidu&amp;wd=www.magedu.net&amp;oq=www.mageedu.net&amp;rsv_pq=d63060680002eb69&amp;rsv_t=de01TWnmyTdcJqph7SfI1hXgXLJxSSfUPcQ3QkWdJk%2FLNrN95ih3XOhbRs4&amp;rqlang=cn&amp;rsv_enter=1&amp;inputT=321&amp;rsv_sug3=41&amp;rsv_sug2=0&amp;rsv_sug4=1626&quot;</span>,<span class="hljs-string">&quot;tcp_xff&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;http_user_agent&quot;</span>:<span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64)AppleWebKit/537.36 (KHTML, like Gecko)Chrome/72.0.3626.119 Safari/537.36&quot;</span>,<span class="hljs-string">&quot;status&quot;</span>:<span class="hljs-string">&quot;304&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-1-实现web盗链"><a href="#3-3-1-实现web盗链" class="headerlink" title="3.3.1 实现web盗链"></a>3.3.1 实现web盗链</h4><p>在一个web 站点盗链另一个站点的资源信息，比如图片、视频等。</p><p>范例：实现简单盗链</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#前期准备</span><br>主机1：10.0.0.101<br>主机2：10.0.0.102<br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#主机2</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>  <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>  <span class="hljs-attribute">server_name</span> www.rlinnpc.com;<br>  <span class="hljs-attribute">location</span> / &#123;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">root</span> <span class="hljs-string">&quot;/data/nginx/html/pc&quot;</span>;<br>        <span class="hljs-attribute">access_log</span> /apps/nginx/logs/www.rlinpc.com.log access_json;<br>   &#125;<br>&#125;<br><br><span class="hljs-comment">#准备盗链web页面：</span><br><span class="hljs-attribute">mkdir</span> -p /data/nginx/html/pc<br>vim /data/nginx/html/pc/index.html<br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br> &lt;title&gt;盗链页面&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;a href=<span class="hljs-string">&quot;http://www.rlinpc.net&quot;</span>&gt;测试盗链&lt;/a&gt;<br>&lt;img src=<span class="hljs-string">&quot;http://www.rlinpc.net/images/1.jpg&quot;</span>/&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br><span class="hljs-comment">#主机1</span><br>mkdir -p /data/nginx/html/images<br><span class="hljs-comment">#存放1.jpg</span><br>vim /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /images &#123;<br>       <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>       <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>&#125;<br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#浏览器访问http://www.rlinnpc.net/ ,查看图片是否正常显示</span><br><span class="hljs-comment">#验证两个域名的日志，是否会在被盗连的web站点的日志中出现以下盗链日志信息：</span><br>（主要还是看referer信息后面的网址是否是搜索引擎或者是已知的地址）<br>==&gt; /apps/nginx/logs/www.rlinpc.com_access.log &lt;==<br>&#123;&quot;@timestamp&quot;:&quot;2021-02-18T22:17:58+08:00&quot;,&quot;host&quot;:&quot;10.0.0.102&quot;,&quot;clientip&quot;:&quot;10.0.0.1&quot;,&quot;size&quot;:34,&quot;responsetime&quot;:0.000,&quot;upstreamtime&quot;:&quot;-&quot;,&quot;upstreamhost&quot;:&quot;-&quot;,&quot;http_host&quot;:&quot;www.rlinpc.com&quot;,&quot;uri&quot;:&quot;/favicon.ico&quot;,&quot;domain&quot;:&quot;www.rlinpc.com&quot;,&quot;xff&quot;:&quot;-&quot;,&quot;referer&quot;:&quot;http://www.rlinpc.com/&quot;,&quot;tcp_xff&quot;:&quot;&quot;,&quot;http_user_agent&quot;:&quot;Mozilla/5.0 (<span class="hljs-attribute">Windows</span> NT <span class="hljs-number">10</span>.<span class="hljs-number">0</span>; Win64; x64) AppleWebKit/537.36 (KHTML, <span class="hljs-attribute">like</span> Gecko) Chrome/<span class="hljs-number">88</span>.<span class="hljs-number">0</span>.<span class="hljs-number">4324</span>.<span class="hljs-number">150</span> Safari/<span class="hljs-number">537</span>.<span class="hljs-number">36</span><span class="hljs-string">&quot;,&quot;</span>status<span class="hljs-string">&quot;:&quot;</span><span class="hljs-number">200</span><span class="hljs-string">&quot;&#125;</span><br></code></pre></td></tr></table></figure><h4 id="3-3-2-实现防盗链"><a href="#3-3-2-实现防盗链" class="headerlink" title="3.3.2 实现防盗链"></a>3.3.2 实现防盗链</h4><p>基于访问安全考虑，nginx支持通过ungx_http_referer_module模块 <a href="https://nginx.org/en/docs/http/ngx_http_referer_module.html#valid_referers">https://nginx.org/en/docs/http/ngx_http_referer_module.html#valid_referers</a> 检查访问请求的referer信息是否有效实现防盗链功能</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /images &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">valid_referers</span> <span class="hljs-literal">none</span> <span class="hljs-literal">blocked</span> server_names <span class="hljs-regexp">*.magedu.com</span> <span class="hljs-regexp">*.magedu.org</span> ~\.google\. ~\.baidu\. ~\.bing\. ~\.so\. ~\.dogedoge\. ; <span class="hljs-comment">#定义有效的referer</span><br>        <br>        <span class="hljs-attribute">if</span> ($invalid_referer)&#123; <span class="hljs-comment">#假如是使用其他的无效的referer访问</span><br>            <span class="hljs-attribute">return</span> <span class="hljs-number">403</span> <span class="hljs-string">&quot;Forbidden Access&quot;</span>; <span class="hljs-comment">#返回状态码403</span><br>        &#125;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/ngins -s reload<br><span class="hljs-comment">#浏览器访问盗链网址</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fangdaolian1.jpg"><br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fangdaolian2.jpg"><br>范例：定义防盗链</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    ......<br>    <span class="hljs-attribute">location</span> /images &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">valid_referers</span> <span class="hljs-literal">none</span> <span class="hljs-literal">blocked</span> server_names<br>            <span class="hljs-regexp">*.example.com</span> <span class="hljs-regexp">example.*</span> www.example.org/galleries/<br>            ~\.google\. ~\.baidu\.; <span class="hljs-comment">#定义有效的referer</span><br>        <br>        <span class="hljs-attribute">if</span> ($invalid_referer)&#123; <span class="hljs-comment">#假如是使用其他的无效的referer访问：</span><br>            <span class="hljs-attribute">return</span> <span class="hljs-number">403</span>; <span class="hljs-comment">#返回状态码403</span><br>        &#125;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/ngins -s reload<br><span class="hljs-comment">#浏览器访问盗链网址</span><br></code></pre></td></tr></table></figure><p>在被盗链的nginx服务器查看日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">tail  /apps/nginx/logs/www.rlinpc.net_access.log<br>10.0.0.1 - - [18/Feb/2021:22:23:43 +0800] <span class="hljs-string">&quot;GET /images/1.jpg HTTP/1.1&quot;</span> 403 16 <span class="hljs-string">&quot;http://www.rlinpc.com/&quot;</span> <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36&quot;</span><br></code></pre></td></tr></table></figure><h3 id="3-4-其它相关高级功能"><a href="#3-4-其它相关高级功能" class="headerlink" title="3.4 其它相关高级功能"></a>3.4 其它相关高级功能</h3><p>第三方模块</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/agile6v/</span>awesome-nginx/<br></code></pre></td></tr></table></figure><p>Lua 参考网站</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.runoob.com<span class="hljs-regexp">/lua/</span>lua-tutorial.html<br></code></pre></td></tr></table></figure><p>自动生成 nginx 配置文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#需要科学上网</span><br>https:<span class="hljs-regexp">//</span>www.digitalocean.com<span class="hljs-regexp">/community/</span>tools/nginx<br></code></pre></td></tr></table></figure><h2 id="四、-Nginx反向代理功能"><a href="#四、-Nginx反向代理功能" class="headerlink" title="四、 Nginx反向代理功能"></a>四、 Nginx反向代理功能</h2><p>反向代理：反向代理也叫reverse proxy，指的是代理外网用户的请求到内部的指定web服务器，并将数据返回给用户的一种方式，这是用的比较多的一种方式。</p><p>Nginx除了可以在企业提供高性能的web服务之外，另外还可以将本身不具备的请求通过某种预定义的协议转发至其它服务器处理，不同的协议就是Nginx服务器与其他服务器进行通信的一种规范，主要在不同的场景使用以下模块实现不同的功能：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx">ngx_http_proxy_module： <span class="hljs-comment">#将客户端的请求以http协议转发至指定服务器进行处理。</span><br><span class="hljs-attribute">ngx_http_upstream_module</span> <span class="hljs-comment">#用于定义proxy_pass,fastcgi_pass,uwsgi_pass等指令引用的后端服务器分组</span><br>ngx_stream_proxy_module：<span class="hljs-comment">#将客户端的请求以tcp协议转发至指定服务器处理。</span><br>ngx_http_fastcgi_module：<span class="hljs-comment">#将客户端对php的请求以fastcgi协议转发至指定服务器助理。</span><br>ngx_http_uwsgi_module：<span class="hljs-comment">#将客户端对Python的请求以uwsgi协议转发至指定服务器处理。</span><br></code></pre></td></tr></table></figure><p>逻辑调用关系：<br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili1.jpg"><br>生产环境部署结构：<br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili2.jpg"><br>访问逻辑图：<br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili3.jpg"></p><h3 id="4-1-实现http反向代理"><a href="#4-1-实现http反向代理" class="headerlink" title="4.1 实现http反向代理"></a>4.1 实现http反向代理</h3><p>官方文档： <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html">https://nginx.org/en/docs/http/ngx_http_proxy_module.html</a></p><h4 id="4-1-1-Nginx-http-协议反向代理入门"><a href="#4-1-1-Nginx-http-协议反向代理入门" class="headerlink" title="4.1.1 Nginx http 协议反向代理入门"></a>4.1.1 Nginx http 协议反向代理入门</h4><h5 id="4-1-1-1-反向代理配置参数"><a href="#4-1-1-1-反向代理配置参数" class="headerlink" title="4.1.1.1 反向代理配置参数"></a>4.1.1.1 反向代理配置参数</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#官方文档：https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass proxy_pass;</span><br><span class="hljs-comment">#用来设置将客户端请求转发给的后端服务器的主机，可以是主机名(将转发至后端服务做为主机头首部)、IP地址：端口的方式</span><br><span class="hljs-comment">#也可以代理到预先设置的主机群组，需要模块ngx_http_upstream_module支持</span><br><span class="hljs-comment">#示例:</span><br><span class="hljs-attribute">location</span>/web &#123; <br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">proxy_pass</span> http://10.0.0.18:8080; <span class="hljs-comment">#8080后面无 / 符号,需要将location后面 url 附加到proxy_pass指定的url后面,类似于root</span><br>    <span class="hljs-comment">#proxy_pass指定的URI不带斜线将访问的/web,等于访问后端服务器http://10.0.0.18:8080/web/index.html，即后端服务器配置的站点根目录要有web目录才可以被访问</span><br>    <span class="hljs-comment"># http://nginx/web/index.html ==&gt; http://10.0.0.18:8080/web/index.html</span><br><br>    <span class="hljs-attribute">proxy_pass</span> http://10.0.0.18:8080/;<span class="hljs-comment">#8080后面有 / 符号,相当于置换,即访问/web时实际返回proxy_pass后面uri内容.类似于alias</span><br>    <span class="hljs-comment">#proxy_pass指定的URI带斜线，等于访问后端服务器的http://10.0.0.18:8080/index.html 内容返回给客户端</span><br>&#125;<span class="hljs-comment"># http://nginx/web/index.html ==&gt; http://10.0.0.18:8080</span><br><br><span class="hljs-comment">#重启Nginx测试访问效果：</span><br><span class="hljs-comment">#curl -Lhttp://www.magedu.org/web</span><br><br><br><span class="hljs-comment">#如果location定义其uri时使用了正则表达式模式(包括~,~*,但不包括^~)，则proxy_pass之后必须不  能使用uri; 用户请求时传递的uri将直接附加至后端服务器之后</span><br><span class="hljs-section">server</span> &#123;<br>    ...<br>    <span class="hljs-attribute">server_name</span> HOSTNAME; <br>    <span class="hljs-attribute">location</span> ~|<span class="hljs-regexp">~* /uri/</span> &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://host:port; <span class="hljs-comment">#proxy_pass后面的url 不能加/</span><br>     &#125;<br>    ...<br>&#125;<br>http://HOSTNAME/uri/ --&gt; http://hosturi/<br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_hide_header</span> field;<br><span class="hljs-comment">#用于nginx作为反向代理的时候，在返回给客户端http响应时，隐藏后端服务器相应头部的信息，可以设置在http,server或location块，</span><br><span class="hljs-comment">#示例: 隐藏后端服务器ETag首部字段</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /web &#123;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>    <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_pass_header</span> field;<br><span class="hljs-comment">#默认nginx在响应报文中不传递后端服务器的首部字段Date, Server, X-Pad, X-Accel等参数，如果要传递的话则要使用 proxy_pass_header field声明将后端服务器返回的值传递给客户端</span><br><span class="hljs-comment">#field 首部字段大小不敏感</span><br><br><span class="hljs-comment">#示例:透传后端服务器的Server和Date首部,同时不再显示前端服务器的Server字段</span><br><br><span class="hljs-attribute">proxy_pass_header</span> Server;<br><span class="hljs-attribute">proxy_pass_header</span> Date;<br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_pass_request_body</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span>;<br><span class="hljs-comment">#是否向后端服务器发送HTTP实体部分,可以设置在http,server或location块，默认即为开启</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_pass_request_headers</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span>;<br><span class="hljs-comment">#是否将客户端的请求头部转发给后端服务器，可以设置在http,server或location块，默认即为开启</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx">proxy_set_header;<br><span class="hljs-comment">#可更改或添加客户端的请求头部信息内容并转发至后端服务器，比如在后端服务器想要获取客户端的真实IP的时候，就要更改每一个报文的头部</span><br><br><span class="hljs-comment">#示例:</span><br><span class="hljs-comment">#proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br>$<span class="hljs-attribute">proxy_add_x_forwarded_for</span> $remote_addr;<br><span class="hljs-attribute">the</span> “X-Forwarded-For” client request header field with the $remote_addr variable appended to it, separated by a comma. If the “X-Forwarded-For” field is not present in the client request header, the $proxy_add_x_forwarded_for variable is equal to the $remote_addr variable.<br><br>proxy_set_header X-Real-IP  $remote_addr; <br><span class="hljs-comment">#添加HOST到报文头部，如果客户端为NAT上网那么其值为客户端的共用的公网IP地址，常用于在日之中记录客户端的真实IP地址。</span><br><span class="hljs-comment">#在后端httpd服务器修改配置,添加日志记录X-Forwarded-For字段</span><br><span class="hljs-attribute">LogFormat</span> <span class="hljs-string">&quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot; \&quot;%&#123;X-Real-IP&#125;i\&quot;&quot;</span> combined <br><br><span class="hljs-comment">#在后端服务器查看日志</span><br>[root@centos8 ~]<span class="hljs-comment">#tail /var/log/httpd/access_log  -f</span><br><span class="hljs-number">10.0.0.8</span> - - [<span class="hljs-number">09</span>/Oct/<span class="hljs-number">2020</span>:<span class="hljs-number">21</span>:<span class="hljs-number">50</span>:<span class="hljs-number">57</span> +<span class="hljs-number">0800</span>] <span class="hljs-string">&quot;HEAD /static/index.html HTTP/1.0&quot;</span> <span class="hljs-number">200</span> - <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span> <span class="hljs-string">&quot;10.0.0.7&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_connect_timeout</span> time;<br><span class="hljs-comment">#配置nginx服务器与后端服务器尝试建立连接的超时时间，默认为60秒，用法如下：</span><br><span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">6s</span>;<br><span class="hljs-comment">#60s为自定义nginx与后端服务器建立连接的超时时间,超时会返回客户端504响应码</span><br><span class="hljs-attribute">proxy_read_timeout</span> time;<br><span class="hljs-comment">#配置nginx服务器向后端服务器或服务器组发起read请求后，等待的超时时间，默认60s</span><br><span class="hljs-attribute">proxy_send_timeout</span> time;<br><span class="hljs-comment">#配置nginx项后端服务器或服务器组发起write请求后，等待的超时 时间，默认60s</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">0</span>;<br><span class="hljs-comment">#用于设置nginx提供代理服务的HTTP协议的版本，默认http 1.0nginx</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_ignore_client_abort</span> <span class="hljs-literal">off</span>;<br><span class="hljs-comment">#当客户端网络中断请求时，nginx服务器中断其对后端服务器的请求。即如果此项设置为on开启，则服务器会忽略客户端中断并一直等着代理服务执行返回，如果设置为off，则客户端中断后Nginx也会中断客户端请求并立即记录499日志，默认为off。</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_headers_hash_bucket_size</span> <span class="hljs-number">128</span>;<br><span class="hljs-comment">#当配置了 proxy_hide_header和proxy_set_header的时候，用于设置nginx保存HTTP报文头的hash表的上限</span><br><br><span class="hljs-attribute">proxy_headers_hash_max_size</span> <span class="hljs-number">512</span>;<br><span class="hljs-comment">#设置proxy_headers_hash_bucket_size的最大可用空间</span><br><br><span class="hljs-attribute">server_namse_hash_bucket_size</span> <span class="hljs-number">512</span>;<br><span class="hljs-comment">#server_name hash表申请空间大小</span><br><br><span class="hljs-attribute">server_names_hash_max_size</span>  <span class="hljs-number">512</span>;<br><span class="hljs-comment">#设置服务器名称hash表的上限大小</span><br></code></pre></td></tr></table></figure><h4 id="4-1-2-实战案例-反向代理单台-web-服务器"><a href="#4-1-2-实战案例-反向代理单台-web-服务器" class="headerlink" title="4.1.2 实战案例: 反向代理单台 web 服务器"></a>4.1.2 实战案例: 反向代理单台 web 服务器</h4><h5 id="4-1-2-1-要求和准备"><a href="#4-1-2-1-要求和准备" class="headerlink" title="4.1.2.1 要求和准备"></a>4.1.2.1 要求和准备</h5><p>要求：将用户对域 <a href="http://www.rlinpc.net/">www.rlinpc.net</a> 的请求转发值后端服务器处理</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">10.0.0.101</span>   #nginx 代理服务器         hostname改名为web1    <br><span class="hljs-number">10.0.0.102</span>   #后端web A，aoache部署    hostname改名为web2<br><span class="hljs-number">10.0.0.103</span>   #后端web B，apache部署    hostname改名为web3<br>#浏览器要配置好域名<br></code></pre></td></tr></table></figure><h5 id="4-1-2-2-部署后端Apache服务器"><a href="#4-1-2-2-部署后端Apache服务器" class="headerlink" title="4.1.2.2 部署后端Apache服务器"></a>4.1.2.2 部署后端Apache服务器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.102</span><br>apt install apache2 -y <span class="hljs-comment">#ubuntu</span><br>yum install httpd -y <span class="hljs-comment">#centos</span><br><span class="hljs-built_in">cd</span> /var/www/html<br>cp index.html index.html.bak<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;web2 10.0.0.102&quot;</span> &gt; /var/www/html/index.html<br>systemctl start apache2<br><span class="hljs-comment">#浏览器访问 10.0.0.102，查看网页内容</span><br><span class="hljs-comment">#模拟tomcat</span><br><span class="hljs-built_in">cd</span> /etc/apache2<br>vim ports.conf<br>Listen 80 改为 Listen 8080<br>systemctl restart apache2 <br><span class="hljs-comment">#查看是否有8080端口</span><br>ss -tnl <br><br><span class="hljs-comment">#10.0.0.103</span><br>apt install apache2 -y<br>yum install httpd -y <span class="hljs-comment">#centos</span><br><span class="hljs-built_in">cd</span> /var/www/html<br>cp index.html index.html.bak<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;web3 10.0.0.103&quot;</span> &gt; /var/www/html/index.html<br>systemctl start apache2<br><span class="hljs-comment">#浏览器访问 10.0.0.103，查看网页内容</span><br></code></pre></td></tr></table></figure><h5 id="4-1-2-3-Nginx配置文件配置"><a href="#4-1-2-3-Nginx配置文件配置" class="headerlink" title="4.1.2.3 Nginx配置文件配置"></a>4.1.2.3 Nginx配置文件配置</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">access_log</span> /apps/nginx/logs/www.rlinpc.net_access.log;<br>    <span class="hljs-attribute">error_log</span> /apps/nginx/logs/www.rlinpc.net_error.log;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> /web &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>    &#125;<br>&#125;<br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net/web ，此时会报apache的错误。是因为apache里没有类似于nginx里root的文件路径，所以10.0.0.102要添加web文件夹及index.html文件</span><br><br><span class="hljs-comment">#10.0.0.102 </span><br>cd /var/www/html<br>mkdir web<br>vim web/index.html<br>web page for apache <span class="hljs-number">10.0.0.102</span><br>````<br><span class="hljs-comment">#### 4.1.3 实战案例: 指定 location 实现反向代理</span><br>```nginx<br><span class="hljs-comment">#10.0.0.103</span><br><span class="hljs-comment">#设定web3为python页面</span><br>cd /var/www/html<br>mkdir python<br>vim python/index.html<br>python web3 <span class="hljs-number">10.0.0.103</span><br><span class="hljs-comment">#改端口号为8080</span><br>vim /etc/apache2/ports.conf<br>Listen <span class="hljs-number">80</span> 改为 Listen <span class="hljs-number">8080</span><br>systemctl restart apache2 <br><span class="hljs-comment">#查看是否有8080端口</span><br>ss -tnl <br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /web &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /python &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.103:8080;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net/python</span><br></code></pre></td></tr></table></figure><h4 id="4-1-4-反向代理示例–缓存功能"><a href="#4-1-4-反向代理示例–缓存功能" class="headerlink" title="4.1.4 反向代理示例–缓存功能"></a>4.1.4 反向代理示例–缓存功能</h4><p>缓存功能默认关闭状态,需要先动配置才能启用</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_cache</span> zone_name | <span class="hljs-literal">off</span>; 默认<span class="hljs-attribute">off</span><br><span class="hljs-comment">#指明调用的缓存，或关闭缓存机制;Context:http, server, location</span><br><span class="hljs-comment">#zone_name 表示缓存的名称.需要由proxy_cache_path事先定义</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_cache_key</span> string;<br><span class="hljs-comment">#缓存中用于“键”的内容，默认值：proxy_cache_key $scheme$proxy_host$request_uri</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_cache_valid</span> [code ...] time;<br><span class="hljs-comment">#定义对特定响应码的响应内容的缓存时长，定义在http&#123;...&#125;中</span><br>示例:<br><span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">10m</span>;<br><span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">404</span> <span class="hljs-number">1m</span>;<br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx">proxy_cache_path;<br><span class="hljs-comment">#定义可用于proxy功能的缓存;Context:http</span><br><span class="hljs-attribute">proxy_cache_path</span> path [levels=levels] [use_temp_path=<span class="hljs-literal">on</span>|<span class="hljs-literal">off</span>]<br>keys_zone=zone_name:size [inactive=time] [max_size=size] [manager_files=number]<br>[manager_sleep=time] [manager_threshold=time] [loader_files=number]<br>[loader_sleep=time] [loader_threshold=time] [purger=<span class="hljs-literal">on</span>|<span class="hljs-literal">off</span>]<br>[purger_files=number] [purger_sleep=time] [purger_threshold=time];<br><br><span class="hljs-comment">#示例：在http配置定义缓存信息</span><br><span class="hljs-attribute">proxy_cache_path</span> /var/cache/nginx/proxy_cache <span class="hljs-comment">#定义缓存保存路径，proxy_cache会自动创建</span><br>levels=<span class="hljs-number">1</span>:<span class="hljs-number">2</span>:<span class="hljs-number">2</span> <span class="hljs-comment">#定义缓存目录结构层次，1:2:2可以生成2^4x2^8x2^8=2^20=1048576个目录</span><br> keys_zone=proxycache:<span class="hljs-number">20m</span> <span class="hljs-comment">#指内存中缓存的大小，主要用于存放key和metadata（如：使用次数） </span><br> inactive=<span class="hljs-number">120s</span>  <span class="hljs-comment">#缓存有效时间 </span><br> max_size=<span class="hljs-number">1g</span>; <span class="hljs-comment">#最大磁盘占用空间，磁盘存入文件内容的缓存空间最大值</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"> <span class="hljs-comment">#调用缓存功能，需要定义在相应的配置段，如server&#123;...&#125;;或者location等</span><br><span class="hljs-attribute">proxy_cache</span> proxycache;<br><span class="hljs-attribute">proxy_cache_key</span> $request_uri; <span class="hljs-comment">#对指定的数据进行MD5的运算做为缓存的key</span><br><span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">301</span> <span class="hljs-number">10m</span>; <span class="hljs-comment">#指定的状态码返回的数据缓存多长时间</span><br><span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">1m</span>;  <span class="hljs-comment">#除指定的状态码返回的数据以外的缓存多长时间,必须设置,否则不会缓存</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">nginx</span><br>proxy_cache_use_stale <span class="hljs-literal">error</span> | timeout | invalid_header | updating | http_500 |<br>http_502 | http_503 | http_504 | http_403 | http_404 | <span class="hljs-literal">off</span> ; <span class="hljs-comment">#默认是off</span><br><span class="hljs-comment">#在被代理的后端服务器出现哪种情况下，可直接使用过期的缓存响应客户端</span><br><span class="hljs-comment">#示例</span><br><span class="hljs-attribute">proxy_cache_use_stale</span> <span class="hljs-literal">error</span> http_502 http_503;<br><br>​```<span class="hljs-attribute">nginx</span><br>proxy_cache_methods GET | HEAD | POST ...;<br><span class="hljs-comment">#对哪些客户端请求方法对应的响应进行缓存，GET和HEAD方法总是被缓存</span><br></code></pre></td></tr></table></figure><p>范例：非缓存场景压测</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-built_in">cd</span> /var/www/html/web<br>tail /var/<span class="hljs-built_in">log</span>/syslog &gt; cache.log<br>chmod 644 cache.log<br><br><span class="hljs-comment">#10.0.0.103</span><br>yum install -y httpd-tools <span class="hljs-comment">#centos需要安装</span><br>vim /etc/hosts<br>10.0.0.101 www.rlinpc.net<br>ab -n 2000 -c200 http://www.rlinpc.net/web/cache.log<br><span class="hljs-comment">#经过三次测试</span><br>Requests per second:    120.39 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       1661.306 [ms] (mean)<br><br>Requests per second:    121.20 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       1650.161 [ms] (mean)<br><br><br>Requests per second:    113.48 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       1762.431 [ms] (mean)<br></code></pre></td></tr></table></figure><p>范例：准备缓存配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/nginx.conf<br>http &#123;<br>.....<br>    <span class="hljs-comment">#cache setting</span><br>    <span class="hljs-attribute">proxy_cache_path</span> /apps/nginx/proxy_cache levels=<span class="hljs-number">2</span>:<span class="hljs-number">2</span>:<span class="hljs-number">2</span> keys_zone=rlinpccache:<span class="hljs-number">128m</span> inactive=<span class="hljs-number">180s</span> max_size=<span class="hljs-number">5g</span>; <br>&#125;<br><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123; <br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /web &#123; <span class="hljs-comment">#要缓存的URL 或者放在server配置项对所有URL都进行缓存</span><br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_cache</span> rlinpccache; <span class="hljs-comment">#这里的名字要跟刚刚keys_zone=定义的名字一样</span><br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>        <span class="hljs-attribute">proxy_cache_key</span> $request_uri;<br>        <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">301</span> <span class="hljs-number">10m</span>; <span class="hljs-comment">#指定的状态码返回的数据缓存多长时间</span><br>        <span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">1m</span>;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /python &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.103:8080;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>        <span class="hljs-attribute">proxy_cache</span> rlinpccache;<br>        <span class="hljs-attribute">proxy_cache_key</span> $request_uri;<br>        <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">301</span> <span class="hljs-number">10m</span>;<br>        <span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">1m</span>;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/ngins -s reload<br></code></pre></td></tr></table></figure><p>范例：访问并验证缓存文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-comment">#先验证/apps/nginx/proxy_cache的文件</span><br><span class="hljs-built_in">cd</span> /apps/nginx/proxy_cache<br>root@web1:/apps/nginx/proxy_cache<span class="hljs-comment"># ll</span><br>total 8<br>drwx------  2 nginx root  4096 Feb 21 22:16 ./<br>drwxr-xr-x 13 nginx nginx 4096 Feb 21 22:16 ../<br><br><span class="hljs-comment">#10.0.0.103</span><br>ab -n2000 -c200 http://www.rlinpc.net/web/cache.log<br><span class="hljs-comment">#经过三次测试</span><br>Requests per second:    260.56 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       767.574 [ms] (mean)<br><br>Requests per second:    333.10 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       600.423 [ms] (mean)<br><br>Requests per second:    236.04 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       847.314 [ms] (mean)<br><br><span class="hljs-comment">#验证缓存目录结构及文件大小 </span><br><span class="hljs-built_in">cd</span> /apps/nginx/proxy_cache<br>root@web1:/apps/nginx/proxy_cache<span class="hljs-comment"># tree </span><br>.<br>└── b5<br>    └── 3d<br>        └── ce<br>            └── 6fc1e543ceb12a0cfb476e4335ce3db5 <br><span class="hljs-comment">#文件夹的名称和缓存文件的名称的最后几位有关</span><br></code></pre></td></tr></table></figure><h4 id="4-1-5-添加头部报文信息"><a href="#4-1-5-添加头部报文信息" class="headerlink" title="4.1.5 添加头部报文信息"></a>4.1.5 添加头部报文信息</h4><p>nginx基于模块ngx_http_headers_module可实现对头部报文添加指定的key与值， <a href="https://nginx.org/en/docs/http/ngx_http_headers_module.html">https://nginx.org/en/docs/http/ngx_http_headers_module.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">Syntax: add_header name value [always];<br>Default: —<br>Context: http, server, location, <span class="hljs-keyword">if</span> <span class="hljs-keyword">in</span> location<br><br><span class="hljs-comment">#添加自定义首部，如下：</span><br>add_header name value [always];<br><span class="hljs-comment">#示例</span><br>add_header X-Via  <span class="hljs-variable">$server_addr</span>; <span class="hljs-comment">#当前nginx主机的IP</span><br>add_header X-Cache <span class="hljs-variable">$upstream_cache_status</span>; <span class="hljs-comment">#是否缓存命中</span><br>add_header X-Accel <span class="hljs-variable">$server_name</span>; <span class="hljs-comment">#客户访问的FQDN</span><br><br><span class="hljs-comment">#添加自定义响应信息的尾部， 1.13.2版后支持</span><br>add_trailer name value [always];<br></code></pre></td></tr></table></figure><p>范例：添加头部信息</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123; <br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /web &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>        <span class="hljs-attribute">proxy_cache</span> rlinpccache;<br>        <span class="hljs-attribute">proxy_cache_key</span> $request_uri;<br>        <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">301</span> <span class="hljs-number">10m</span>;<br>        <span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">1m</span>;<br>        <span class="hljs-attribute">add_header</span> X-Via  $server_addr;<br>        <span class="hljs-attribute">add_header</span> X-Cache $upstream_cache_status;<br>        <span class="hljs-attribute">add_header</span> X-Accel $server_name;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /python &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.103:8080;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>        <span class="hljs-attribute">proxy_cache</span> rlinpccache;<br>        <span class="hljs-attribute">proxy_cache_key</span> $request_uri;<br>        <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">301</span> <span class="hljs-number">10m</span>;<br>        <span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">1m</span>;<br>        <span class="hljs-attribute">add_header</span> X-Via  $server_addr;<br>        <span class="hljs-attribute">add_header</span> X-Cache $upstream_cache_status;<br>        <span class="hljs-attribute">add_header</span> X-Accel $server_name;<br>    &#125;<br><br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/ngins -s reload<br><br><span class="hljs-comment">#验证头部信息</span><br><span class="hljs-comment">#10.0.0.103</span><br>curl -I http://www.rlinpc.net/web/cache.log<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: M<span class="hljs-literal">on</span>, <span class="hljs-number">22</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">05</span>:<span class="hljs-number">23</span>:<span class="hljs-number">41</span> GMT<br>Content-Length: <span class="hljs-number">1523628</span><br>Connection: keep-alive<br>Last-Modified: M<span class="hljs-literal">on</span>, <span class="hljs-number">22</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">39</span>:<span class="hljs-number">51</span> GMT<br>X-Via:  <span class="hljs-number">10.0.0.101</span><br>X-Cache: MISS          <span class="hljs-comment">#第一次无缓存</span><br>X-Accel: www.rlinpc.net<br>Accept-Ranges: bytes<br><br>curl -I http://www.rlinpc.net/web/cache.log<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: M<span class="hljs-literal">on</span>, <span class="hljs-number">22</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">05</span>:<span class="hljs-number">23</span>:<span class="hljs-number">44</span> GMT<br>Content-Length: <span class="hljs-number">1523628</span><br>Connection: keep-alive<br>Last-Modified: M<span class="hljs-literal">on</span>, <span class="hljs-number">22</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">39</span>:<span class="hljs-number">51</span> GMT<br>X-Via:  <span class="hljs-number">10.0.0.101</span><br>X-Cache: HIT           <span class="hljs-comment">#第二次命令缓存</span><br>X-Accel: www.rlinpc.net<br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure><h4 id="4-1-6-expires延长图片的有效期"><a href="#4-1-6-expires延长图片的有效期" class="headerlink" title="4.1.6 expires延长图片的有效期"></a>4.1.6 expires延长图片的有效期</h4><p>范例：expires延长图片的有效期（同样也是在ngx_http_headers_module模块里，详细打开网页查看）</p><p>expires作用：可以在用户第一次访问网页的时候将一些图片之类的静态资源缓存到自己的电脑里，然后下次访问相同的域名的时候，只要在有效的时期里就不用再次缓存，可以有效的较少缓存的时间</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listne</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rilnpc.net;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(gif|jpg|jepg|bmp|png|tiff|tif|ico|wmf|js)$</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/static;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">expires</span> <span class="hljs-number">30d</span>;<br>        .....<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h3 id="4-2-Nginx-http-反向代理高级应用"><a href="#4-2-Nginx-http-反向代理高级应用" class="headerlink" title="4.2 Nginx http 反向代理高级应用"></a>4.2 Nginx http 反向代理高级应用</h3><p>在上一个章节中Nginx可以将客户端的请求转发至单台后端服务器但是无法转发至特定的一组的服务器，而且不能对后端服务器提供相应的服务器状态监测，但是Nginx可以基于ngx_http_upstream_module模块提供服务器分组转发、权重分配、状态检测、调度算法等高级功能，官方文档： <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html">https://nginx.org/en/docs/http/ngx_http_upstream_module.html</a></p><h4 id="4-2-1-http-upstream配置参数"><a href="#4-2-1-http-upstream配置参数" class="headerlink" title="4.2.1 http upstream配置参数"></a>4.2.1 http upstream配置参数</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#自定义一组服务器，配置在http块内</span><br><span class="hljs-attribute">upstream</span> name &#123;<br>     <span class="hljs-attribute">server</span> .....<br>     ......<br>&#125;<br><br><span class="hljs-comment">#示例</span><br>upstream backend &#123;<br>     <span class="hljs-attribute">server</span> backend1.example.com weight=<span class="hljs-number">5</span>;<br>     <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8080</span>    max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>     <span class="hljs-attribute">server</span> unix:/tmp/backend3;<br>     <span class="hljs-attribute">server</span> backup1.example.com backup;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">server</span> address [parameters];<br><span class="hljs-comment">#配置一个后端web服务器，配置在upstream内，至少要有一个server服务器配置。</span><br><span class="hljs-comment">#server支持的parameters如下：</span><br>weight=<span class="hljs-attribute">number</span> <span class="hljs-comment">#设置权重，默认为1,实现类似于LVS中的WRR,WLC等</span><br>max_conns=number  <span class="hljs-comment">#给当前server设置最大活动链接数，默认为0表示没有限制</span><br>max_fails=number  <span class="hljs-comment">#对后端服务器连续监测失败多少次就标记为不可用,默认为1次,当客户端访问时,才</span><br>会利用TCP触发对探测后端服务器健康性检查,而非周期性的探测<br>fail_timeout=time <span class="hljs-comment">#对后端服务器的单次监测超时时间，默认为10秒</span><br>backup  <span class="hljs-comment">#设置为备份服务器，当所有服务器不可用时将重新启用次服务器</span><br>down   <span class="hljs-comment">#标记为down状态</span><br>resolve <span class="hljs-comment">#当server定义的是主机名的时候，当A记录发生变化会自动应用新IP而不用重启Nginx</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">hash</span> KEY [consistent];<br><span class="hljs-comment">#基于指定请求报文中首部字段或者URI等key做hash计算，使用consistent参数，将使用ketama一致性hash算法，适用于后端是Cache服务器（如varnish）时使用，consistent定义使用一致性hash运算，一致性hash基于取模运算</span><br><br><span class="hljs-attribute">hash</span> $request_uri consistent; <span class="hljs-comment">#基于用户请求的uri做hash</span><br><span class="hljs-attribute">hash</span> $cookie_sessionid  <span class="hljs-comment">#基于cookie中的sessionid这个key进行hash调度,实现会话绑定</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx">ip_hash;<br><span class="hljs-comment">#源地址hash调度方法，基于的客户端的remote_addr(源地址IPv4的前24位或整个IPv6地址)做hash计算，以实现会话保持</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx">least_conn;<br><span class="hljs-comment">#最少连接调度算法，优先将客户端请求调度到当前连接最少的后端服务器,相当于LVS中的WLC</span><br></code></pre></td></tr></table></figure><p><strong>基于 hash 的调度算法</strong><br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili4.jpg"><br><strong>添加节点后,会导致很多的调度的缓存信息失效</strong><br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili5.jpg"><br><strong>一致性hash 算法</strong><br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili6.jpg"></p><h4 id="4-2-2-反向代理示例：后端多台web服务器"><a href="#4-2-2-反向代理示例：后端多台web服务器" class="headerlink" title="4.2.2 反向代理示例：后端多台web服务器"></a>4.2.2 反向代理示例：后端多台web服务器</h4><h5 id="4-2-2-1-环境说明"><a href="#4-2-2-1-环境说明" class="headerlink" title="4.2.2.1 环境说明"></a>4.2.2.1 环境说明</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">10.0.0.101   <span class="hljs-comment">#Nginx 代理服务器</span><br>10.0.0.102   <span class="hljs-comment">#后端web A，Apache部署</span><br>10.0.0.103   <span class="hljs-comment">#后端web B，Apache部署</span><br><span class="hljs-comment">#详细的部署后端apache服务器跟前面的一样</span><br></code></pre></td></tr></table></figure><h5 id="4-2-2-2-配置Nginx反向代理"><a href="#4-2-2-2-配置Nginx反向代理" class="headerlink" title="4.2.2.2 配置Nginx反向代理"></a>4.2.2.2 配置Nginx反向代理</h5><p><strong>注意：本节实验过程中先关闭缓存</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>upstream rlin-web &#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.102:80</span> weight=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">5s</span> max_fails=<span class="hljs-number">3</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.103:80</span> weight=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">5s</span> max_fails=<span class="hljs-number">3</span>;<br>    <span class="hljs-comment">#下面的三个算法都可以试一试</span><br>    <span class="hljs-comment">#hash $request_uri consistent;</span><br>    <span class="hljs-comment">#ip_hash;</span><br>    <span class="hljs-comment">#least_conn;</span><br>&#125;<br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /web &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://rlin-web;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>        <span class="hljs-comment">#proxy_cache rlinpccache;</span><br>        <span class="hljs-comment">#proxy_cache_key $request_uri;</span><br>        <span class="hljs-comment">#proxy_cache_valid 200 302 301 10m;</span><br>        <span class="hljs-comment">#proxy_cache_valid any 1m;</span><br>        <span class="hljs-attribute">add_header</span> X-Via  $server_addr;<br>        <span class="hljs-attribute">add_header</span> X-Cache $upstream_cache_status;<br>        <span class="hljs-attribute">add_header</span> X-Accel $server_name;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#10.0.0.103</span><br>mkdir /var/www/html/web<br>vim /var/www/html/web/index.html<br>web for rlin <span class="hljs-number">10.0.0.103</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net/web</span><br><span class="hljs-comment">#linux curl http://www.rlinpc.net/web/index.html</span><br></code></pre></td></tr></table></figure><h4 id="4-2-3-实战案例-实现反向代理客户端-IP-透传"><a href="#4-2-3-实战案例-实现反向代理客户端-IP-透传" class="headerlink" title="4.2.3 实战案例: 实现反向代理客户端 IP 透传"></a>4.2.3 实战案例: 实现反向代理客户端 IP 透传</h4><h5 id="4-2-3-1-一级代理实现客户端IP透传"><a href="#4-2-3-1-一级代理实现客户端IP透传" class="headerlink" title="4.2.3.1 一级代理实现客户端IP透传"></a>4.2.3.1 一级代理实现客户端IP透传</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>upstream rlin-web &#123;<br> <span class="hljs-comment">#hash $request_uri consistent; #consistent 一致性hash算法</span><br>  <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.101:80</span> weight=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">5s</span> max_fails=<span class="hljs-number">3</span>;<br>  <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.102:80</span> weight=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">5s</span> max_fails=<span class="hljs-number">3</span> backup;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>  <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>  <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>  <span class="hljs-attribute">location</span> / &#123;<br>    <span class="hljs-attribute">index</span> index.html index.php;<br>    <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>  &#125;<br>  <br>  <span class="hljs-attribute">location</span> /web &#123;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">proxy_pass</span> http://rlin-web/;<br>    <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For-rlinpc  $remote_addr; <span class="hljs-comment">#添加客户端IP到报文头部</span><br>  &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#后端web配置,10.0.0.102,10.0.0.103</span><br><span class="hljs-number">1</span>.apache<br>vim /etc/httpd/conf/http.conf <span class="hljs-comment">#centos</span><br>vim /etc/apache2/apache2.conf <span class="hljs-comment">#ubuntu</span><br><span class="hljs-comment">#找到那一行直接备份更改</span><br>LogFormat <span class="hljs-string">&quot;%&#123;X-Forwarded-For-rlinpc&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot; &#123;Referer&#125;i\&quot; \&quot;% &#123;User-Agent&#125;i\&quot;&quot;</span> combined<br><span class="hljs-comment">#注意，新加的IP报文名称要一样</span><br><span class="hljs-comment">#重启apache，访问web界面并验证apache日志</span><br>tail -f /var/log/http/access_log<br><br><span class="hljs-number">2</span>.nginx <br>cat /apps/nginx/conf/nginx.conf<br><span class="hljs-string">&quot;$http_x_forwarded_for&quot;</span><span class="hljs-string">&#x27; #默认日志格式就有此配置</span><br><span class="hljs-string">#重启nginx访问web界面并验证日志格式：</span><br></code></pre></td></tr></table></figure><h4 id="4-2-3-2-多级代理实现客户端-IP-透传"><a href="#4-2-3-2-多级代理实现客户端-IP-透传" class="headerlink" title="4.2.3.2  多级代理实现客户端 IP 透传"></a>4.2.3.2  多级代理实现客户端 IP 透传</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili7.jpg"><br>环境准备</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">10.0.0.101      <span class="hljs-comment">#Nginx1 代理服务器1 hostname Nginx1</span><br>10.0.0.102      <span class="hljs-comment">#Nginx2 代理服务器2 hostname Nginx2</span><br>10.0.0.103      <span class="hljs-comment">#httpd  后端服务器  hostname apache</span><br><span class="hljs-comment">#环境部署：各自安装相应的Nginx或httpd</span><br></code></pre></td></tr></table></figure><p>代理服务器和后端配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101 第一个代理服务器</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>   <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>   <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>   <span class="hljs-attribute">location</span> /web &#123;<br>      <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102;<br>      <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;<br>   &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#10.0.0.102 第二个代理服务器</span><br>server &#123;<br>   <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>   <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>   <span class="hljs-attribute">location</span> /web &#123;<br>      <span class="hljs-attribute">proxy_pass</span> http://10.0.0.103;<br>      <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;<br>   &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#10.0.0.103 后端服务器</span><br>vim /etc/httpd/conf/http.conf <span class="hljs-comment">#centos</span><br>vim /etc/apache2/apache2.conf <span class="hljs-comment">#ubuntu</span><br><span class="hljs-comment">#找到那一行直接备份更改</span><br>LogFormat <span class="hljs-string">&quot;%&#123;X-Forwarded-For-rlinpc&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot; &#123;Referer&#125;i\&quot; \&quot;% &#123;User-Agent&#125;i\&quot;&quot;</span> combined<br>systemctl restart apache2<br><br><span class="hljs-comment">#测试访问</span><br>curl www.rlinpc.net/web/index.html<br><br><span class="hljs-comment">#后端服务器查看日志</span><br>tail -f /var/log/httpd/access_log<br></code></pre></td></tr></table></figure><h4 id="4-2-3-3-实战案例-基于Cookie-实现会话绑定"><a href="#4-2-3-3-实战案例-基于Cookie-实现会话绑定" class="headerlink" title="4.2.3.3 实战案例: 基于Cookie 实现会话绑定"></a>4.2.3.3 实战案例: 基于Cookie 实现会话绑定</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#省略102，103的配置</span><br><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/nginx.conf<br>http &#123;<br>    <span class="hljs-attribute">upstream</span> websrvs &#123;<br>        <span class="hljs-attribute">hash</span> $cookie_hello;  <span class="hljs-comment">#hello是cookie的key的名称</span><br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.102:8080</span> weight=<span class="hljs-number">2</span>;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.103:8080</span> weight-<span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /&#123;<br>        <span class="hljs-comment">#proxy_cache mycache;</span><br>        <span class="hljs-attribute">proxy_pass</span> http://websrvs;<br>        &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#测试</span><br>curl -b hello=wang http://www.rlinpc.net<br></code></pre></td></tr></table></figure><h3 id="4-3-实现-Nginx-tcp-负载均衡"><a href="#4-3-实现-Nginx-tcp-负载均衡" class="headerlink" title="4.3 实现 Nginx tcp 负载均衡"></a>4.3 实现 Nginx tcp 负载均衡</h3><p>Nginx在1.9.0版本开始支持tcp模式的负载均衡，在1.9.13版本开始支持udp协议的负载，udp主要用于DNS的域名解析，其配置方式和指令和http 代理类似，其基于ngx_stream_proxy_module模块实现tcp负载，另外基于模块ngx_stream_upstream_module实现后端服务器分组转发、权重分配、状态监测、调度算法等高级功能。</p><p>如果编译安装,需要指定 –with-stream 选项才能支持ngx_stream_proxy_module模块</p><p>一般都是使用lvs和haproxy来作为负载均衡</p><p>官方文档：<br><a href="https://nginx.org/en/docs/stream/ngx_stream_proxy_module.html">https://nginx.org/en/docs/stream/ngx_stream_proxy_module.html</a></p><p><a href="http://nginx.org/en/docs/stream/ngx_stream_upstream_module.html">http://nginx.org/en/docs/stream/ngx_stream_upstream_module.html</a></p><h4 id="4-3-1tcp负载均衡配置参数-了解一下，一般会用HAProxy或keepalived代替"><a href="#4-3-1tcp负载均衡配置参数-了解一下，一般会用HAProxy或keepalived代替" class="headerlink" title="4.3.1tcp负载均衡配置参数(了解一下，一般会用HAProxy或keepalived代替)"></a>4.3.1tcp负载均衡配置参数(了解一下，一般会用HAProxy或keepalived代替)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /apps/nginx/conf/nginx.conf<br>include /apps/nginx/conf/tcp/*.conf; <span class="hljs-comment">#注意此处的include与http模块平级</span><br>mkdir /apps/nginx/conf/tcp -p<br><br>vim /apps/nginx/conf/tcp/pc.conf<br>stream &#123; <span class="hljs-comment">#定义stream相关的服务；Context:main</span><br>    upstream backend &#123; <span class="hljs-comment">#定义后端服务器</span><br>        <span class="hljs-built_in">hash</span> <span class="hljs-variable">$remote_addr</span> consistent; <span class="hljs-comment">#定义调度算法</span><br>        server backend1.example.com:12345 weight=5; <span class="hljs-comment">#定义具体server</span><br>        server 127.0.0.1:12345    max_fails=3 fail_timeout=30s;<br>        server unix:/tmp/backend3;<br>    &#125;<br>    <br>    upstream dns &#123; <span class="hljs-comment">#定义后端服务器</span><br>        server 10.0.0.1:53535;  <span class="hljs-comment">#定义具体server</span><br>        server dns.example.com:53;<br>    &#125;<br>    <br>    server &#123; <span class="hljs-comment">#定义server</span><br>        listen 12345; <span class="hljs-comment">#监听IP:PORT</span><br>        proxy_connect_timeout 1s; <span class="hljs-comment">#连接超时时间</span><br>        proxy_timeout 3s; <span class="hljs-comment">#转发超时时间</span><br>        proxy_pass backend; <span class="hljs-comment">#转发到具体服务器组</span><br>    &#125;<br>    <br>    server &#123;<br>        listen 127.0.0.1:53 udp reuseport;<br>                   proxy_timeout 20s;<br>                   proxy_pass dns;<br>    &#125;<br>    <br>    server &#123;<br>        listen [::1]:12345;<br>        proxy_pass unix:/tmp/stream.socket;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="4-3-2-负载均衡实例-Redis"><a href="#4-3-2-负载均衡实例-Redis" class="headerlink" title="4.3.2 负载均衡实例 : Redis"></a>4.3.2 负载均衡实例 : Redis</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili8.jpg"></p><h5 id="4-3-2-1-后端服务器安装-redis"><a href="#4-3-2-1-后端服务器安装-redis" class="headerlink" title="4.3.2.1 后端服务器安装 redis"></a>4.3.2.1 后端服务器安装 redis</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装两台redis服务器</span><br>yum -y install redis <span class="hljs-comment">#centos</span><br>apt -y install redis <span class="hljs-comment">#ubuntu</span><br>sed -i <span class="hljs-string">&#x27;/^bind /c bind 0.0.0.0&#x27;</span> /etc/redis.conf<br><span class="hljs-comment">#注意：redis如果监听的地址不为*要在配置文件里将hosts修改为0.0.0.0</span><br><br>systemctl <span class="hljs-built_in">enable</span> --now redis<br>ss -tnl | grep 6379<br></code></pre></td></tr></table></figure><h5 id="4-3-2-2-nginx配置"><a href="#4-3-2-2-nginx配置" class="headerlink" title="4.3.2.2 nginx配置"></a>4.3.2.2 nginx配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /apps/nginx/conf/nginx.conf<br>include /apps/nginx/conf/tcp/*.conf<br><br>mkdir /apps/nginx/conf/tcp<br>vim /apps/nginx/conf/tcp/tcp.conf<br>stream &#123;<br>    upstream redis_Server &#123;<br>        server 10.0.0.102:6379 max_fails=3 fail_timeout=30s;<br>        server 10.0.0.103:6379 max_fails=3 fail_timeout=30s;<br>    &#125;<br>    <br>    server &#123;<br>        listen 10.0.0.101:6379;<br>        proxy_connect_timeout 3s;<br>        proxy_timeout 3s;<br>        proxy_pass redis_server;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/nginx -t <br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h5 id="4-3-2-3-测试"><a href="#4-3-2-3-测试" class="headerlink" title="4.3.2.3 测试"></a>4.3.2.3 测试</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.101，重启nginx并访问测试</span><br>/apps/nginx/sbin/nginx -t<br>/apps/nginx/sbin/nginx -s reload<br>ss -tnl | grep 6379<br><br><span class="hljs-comment">#测试通过nginx 负载链接redis</span><br>redis-cli -h 10.0.0.102 <span class="hljs-built_in">set</span> name rlin<br>redis-cli -h 10.0.0.102 get name<br>redis-cli -h 10.0.0.102 get name<br></code></pre></td></tr></table></figure><h4 id="4-3-3-负载均衡实例：MySQL"><a href="#4-3-3-负载均衡实例：MySQL" class="headerlink" title="4.3.3 负载均衡实例：MySQL"></a>4.3.3 负载均衡实例：MySQL</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili9.jpg"></p><h5 id="4-3-3-1-后端服务器安装MySQL"><a href="#4-3-3-1-后端服务器安装MySQL" class="headerlink" title="4.3.3.1 后端服务器安装MySQL"></a>4.3.3.1 后端服务器安装MySQL</h5><p>环境配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">10.0.0.101     <span class="hljs-comment">#配置Nginx hostnamectl set-hostname Nginx</span><br>10.0.0.102     <span class="hljs-comment">#配置MySQL hostnamectl set-hostname mysql-server1</span><br>10.0.0.103     <span class="hljs-comment">#配置MySQL hostnamectl set-hostname mysql-server2</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br><span class="hljs-comment">#102，103 安装MySQL服务</span><br>apt -y install mysql-server mysql <span class="hljs-comment">#ubuntu</span><br>yum -y install mariadb-server mysql <span class="hljs-comment">#centos</span><br>systemctl start mysqld <span class="hljs-comment">#ubuntu</span><br>systemclt start mariadb <span class="hljs-comment">#centos</span><br>ss -tnl <br><span class="hljs-comment">#查看监听的IP地址端口是不是*:3306</span><br><br>mysql<br>create user rlin@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>flush privileges;<br><span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure><h5 id="4-3-3-2-nginx配置"><a href="#4-3-3-2-nginx配置" class="headerlink" title="4.3.3.2 nginx配置"></a>4.3.3.2 nginx配置</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nging/conf/tcp/tcp.conf<br>stream &#123;<br>    <span class="hljs-attribute">upstream</span> redis_server &#123;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.102:6379</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.103:6379</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>    &#125;<br>    <br>    <span class="hljs-attribute">upstream</span> mysql_server &#123;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.102:3306</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.103:3306</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>    &#125;<br>    <br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">10.0.0.101:3306</span>;<br>        <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">6s</span>;<br>        <span class="hljs-attribute">proxy_timeout</span> <span class="hljs-number">15s</span>;<br>        <span class="hljs-attribute">proxy_pass</span> mysql_server;<br>    &#125;<br>    <br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">10.0.0.101:6379</span>;<br>        <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">3s</span>;<br>        <span class="hljs-attribute">proxy_timeout</span> <span class="hljs-number">3s</span>;<br>        <span class="hljs-attribute">proxy_pass</span> redis_server;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t <br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><h5 id="7-3-3-3-测试"><a href="#7-3-3-3-测试" class="headerlink" title="7.3.3.3 测试"></a>7.3.3.3 测试</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#测试通过nginx负载链接MySQL</span><br><span class="hljs-comment">#10.0.0.103 测试</span><br>mysql -urlin -p123456 -h10.0.0.101 -e <span class="hljs-string">&#x27;show variables like &quot;hostname&quot;&#x27;</span> <span class="hljs-comment">#多输入几次看结果</span><br><br><span class="hljs-comment">#10.0.0.104 测试</span><br>mysql -urlin -p123456 -h10.0.0.101 -e <span class="hljs-string">&#x27;show variables like &quot;hostname&quot;&#x27;</span> <span class="hljs-comment">#多输入几次看结果</span><br><br><span class="hljs-comment">#停止其中一个服务器的MySQL服务,停止那一台就在另一台进行测试</span><br>systemctl stop mysqld<br><br><span class="hljs-comment">#再次测试访问,只会看到mysql-server1进行响应</span><br>mysql -urlin -p123456 -h10.0.0.101 -e <span class="hljs-string">&#x27;show variables like &quot;hostname&quot;&#x27;</span>  <span class="hljs-comment">#多输入几次看结果</span><br></code></pre></td></tr></table></figure><h4 id="4-3-4-负载均衡实例：redis和MySQL"><a href="#4-3-4-负载均衡实例：redis和MySQL" class="headerlink" title="4.3.4 负载均衡实例：redis和MySQL"></a>4.3.4 负载均衡实例：redis和MySQL</h4><h4 id="4-3-4-1-后端服务器安装MySQL"><a href="#4-3-4-1-后端服务器安装MySQL" class="headerlink" title="4.3.4.1 后端服务器安装MySQL"></a>4.3.4.1 后端服务器安装MySQL</h4><p>环境配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">10.0.0.101 <span class="hljs-comment">#Ningx hostnamectl set-hostname nginx</span><br>10.0.0.102 <span class="hljs-comment">#redis hostnamectl set-hostname reids</span><br>10.0.0.103 <span class="hljs-comment">#mysql hostnamectl set-hostname mysql</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装MySQL服务</span><br>apt -y install mysql-server mysql <span class="hljs-comment">#ubuntu</span><br>yum -y install mariadb-server mysql <span class="hljs-comment">#centos</span><br>systemctl start mysqld <span class="hljs-comment">#ubuntu</span><br>systemclt start mariadb <span class="hljs-comment">#centos</span><br>ss -tnl <br><span class="hljs-comment">#查看监听的IP地址端口是不是*:3306</span><br><br>mysql<br>create user rlin@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>flush privileges;<br><span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure><h4 id="4-3-4-2-后端服务器安装redis"><a href="#4-3-4-2-后端服务器安装redis" class="headerlink" title="4.3.4.2 后端服务器安装redis"></a>4.3.4.2 后端服务器安装redis</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum -y install redis <span class="hljs-comment">#centos</span><br>apt -y install redis <span class="hljs-comment"># ubuntu</span><br>sed -i <span class="hljs-string">&#x27;/^bind /c bind 0.0.0.0&#x27;</span> /etc/redis.conf<br><span class="hljs-comment">#注意：redis如果监听的地址不为*要在配置文件里将hosts修改为0.0.0.0</span><br><br>systemctl <span class="hljs-built_in">enable</span> --now redis<br>ss -tnl | grep 6379<br></code></pre></td></tr></table></figure><h4 id="4-3-4-3-nginx配置"><a href="#4-3-4-3-nginx配置" class="headerlink" title="4.3.4.3 nginx配置"></a>4.3.4.3 nginx配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /apps/nginx/conf/nginx.conf<br>include /apps/nginx/conf/tcp/*.conf;  <span class="hljs-comment">#注意此处的include与http模块平级</span><br>mkdir /apps/nginx/conf/tcp -p<br>vim /apps/nginx/conf/tcp/tcp.conf<br>stream &#123;<br>    <span class="hljs-comment">#只有一个就不指定算法了</span><br>    upstream redis_server&#123;<br>        server 10.0.0.102:6379 max_fails=3 fail_timeout=30s;<br>    &#125;<br>    <br>    upstream mysql_server &#123;<br>        server 10.0.0.103:3306 max_fails=3 fail_timeout=30s;<br>    &#125;<br>    <br>    <span class="hljs-comment">#监听redis</span><br>    server &#123;<br>        listen 10.0.0.101:6379;<br>        proxy_connect_timeout 3s;<br>        proxy_timeout 3s;<br>        proxy_pass redis_server;<br>    &#125;<br>    <br>    <span class="hljs-comment">#监听MySQL</span><br>    server &#123;<br>        listen 10.0.0.101:6379;<br>        proxy_connect_timeout 3s;<br>        proxy_timeout 3s;<br>        proxy_pass mysql_server;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/nginx -t <br>/apps/nginx/sbin/nginx -s reload<br><br><br></code></pre></td></tr></table></figure><h3 id="4-4-实现FastCGI"><a href="#4-4-实现FastCGI" class="headerlink" title="4.4 实现FastCGI"></a>4.4 实现FastCGI</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi1.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi2.jpg"></p><p>CGI的由来：<br>最早的Web服务器只能简单地响应浏览器发来的HTTP请求，并将存储在服务器上的HTML文件返回给浏览器，也就是静态html文件，但是后期随着网站功能增多网站开发也越来越复杂，以至于出现动态技术，比如像php(1995年)、java(1995)、python(1991)语言开发的网站，但是nginx/apache服务器并不能直接运行 php、java这样的文件，apache实现的方式是打补丁，但是nginx缺通过与第三方基于协议实现，即通过某种特定协议将客户端请求转发给第三方服务处理，第三方服务器会新建新的进程处理用户的请求，处理完成后返回数据给Nginx并回收进程，最后nginx在返回给客户端，那这个约定就是通用网关接口(common gateway interface，简称CGI)，CGI（协议） 是web服务器和外部应用程序之间的接口标准，是cgi程序和web服务器之间传递信息的标准化接口。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi3.jpg"></p><p>为什么会有FastCGI？<br>CGI协议虽然解决了语言解析器和 Web Server 之间通讯的问题，但是它的效率很低，因为 Web Server每收到一个请求都会创建一个CGI进程，PHP解析器都会解析php.ini文件，初始化环境，请求结束的时候再关闭进程，对于每一个创建的CGI进程都会执行这些操作，所以效率很低，而FastCGI是用来提高CGI性能的，FastCGI每次处理完请求之后不会关闭掉进程，而是保留这个进程，使这个进程可以处理多个请求。这样的话每个请求都不用再重新创建一个进程了，大大提升了处理效率。</p><p>什么是PHP-FPM？<br>PHP-FPM(FastCGI Process Manager：FastCGI进程管理器)是一个实现了Fastcgi的程序，并且提供进程管理的功能。进程包括master进程和worker进程。master进程只有一个，负责监听端口，接受来自web server的请求。worker进程一般会有多个，每个进程中会嵌入一个PHP解析器，进行PHP代码的处理。</p><h4 id="4-4-1-FastCGI配置指令"><a href="#4-4-1-FastCGI配置指令" class="headerlink" title="4.4.1 FastCGI配置指令"></a>4.4.1 FastCGI配置指令</h4><p>Nginx基于模块ngx_http_fastcgi_module实现通过fastcgi协议将指定的客户端请求转发至php-fpm处理，其配置指令如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">fastcgi_pass address:port;<br><span class="hljs-comment">#转发请求到后端服务器，address为后端的fastcgi server的地址，可用位置：location, if inlocation</span><br><br>fastcgi_index name;<br><span class="hljs-comment">#fastcgi默认的主页资源，示例：fastcgi_index index.php;</span><br><br>fastcgi_param parameter value [if_not_empty];<br><span class="hljs-comment">#设置传递给FastCGI服务器的参数值，可以是文本，变量或组合，可用于将Nginx的内置变量赋值给自定义key</span><br><br>fastcgi_param REMOTE_ADDR     <span class="hljs-variable">$remote_addr</span>; <span class="hljs-comment">#客户端源IP</span><br>fastcgi_param REMOTE_PORT     <span class="hljs-variable">$remote_port</span>; <span class="hljs-comment">#客户端源端口</span><br>fastcgi_param SERVER_ADDR     <span class="hljs-variable">$server_addr</span>; <span class="hljs-comment">#请求的服务器IP地址</span><br>fastcgi_param SERVER_PORT     <span class="hljs-variable">$server_port</span>; <span class="hljs-comment">#请求的服务器端口</span><br>fastcgi_param SERVER_NAME     <span class="hljs-variable">$server_name</span>; <span class="hljs-comment">#请求的server name</span><br><br>Nginx默认配置示例：<br> location ~ \.php$ &#123;<br>           root      /scripts;<br>     <span class="hljs-comment">#对于PHP来讲只需要配置以下三行，最后一行加上去就行</span><br>           fastcgi_pass  127.0.0.1:9000;<br>          fastcgi_index index.php;<br>     <span class="hljs-comment">#下面两种选择文件路径二选一</span><br>          fastcgi_param SCRIPT_FILENAME /scripts<span class="hljs-variable">$fastcgi_script_name</span>; <span class="hljs-comment">#默认脚本路径(PHP文件路径)</span><br>          <span class="hljs-comment">#fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br>          include    fastcgi_params;<br> &#125;<br></code></pre></td></tr></table></figure><p>fastcgi 缓存定义指令：注意使用fastcgi缓存, 可能会导致源代码更新失败,生产慎用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">fastcgi_cache_path path [levels=levels] [use_temp_path=on|off]<br>keys_zone=name:size [inactive=time] [max_size=size] [manager_files=number]<br>[manager_sleep=time] [manager_threshold=time] [loader_files=number]<br>[loader_sleep=time] [loader_threshold=time] [purger=on|off]<br>[purger_files=number] [purger_sleep=time] [purger_threshold=time];<br><span class="hljs-comment">#定义fastcgi的缓存;</span><br>    path  <span class="hljs-comment">#缓存位置为磁盘上的文件系统路径</span><br>    max_size=size <span class="hljs-comment">#磁盘path路径中用于缓存数据的缓存空间上限</span><br>    levels=levels：缓存目录的层级数量，以及每一级的目录数量<br>    levels=ONE:TWO:THREE，示例：<br>    leves=1:2:2<br>    keys_zone=name:size <span class="hljs-comment">#设置缓存名称及k/v映射的内存空间的名称及大小</span><br>    inactive=time <span class="hljs-comment">#缓存有效时间，默认10分钟，需要在指定时间满足fastcgi_cache_min_uses次数被视为活动缓存。</span><br></code></pre></td></tr></table></figure><p>缓存调用指令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">fastcgi_cache zone | off;<br><span class="hljs-comment">#调用指定的缓存空间来缓存数据，可用位置：http, server, location</span><br><br>fastcgi_cache_key string;<br><span class="hljs-comment">#定义用作缓存项的key的字符串，示例：fastcgi_cache_key $request_uri;</span><br><br>fastcgi_cache_methods GET | HEAD | POST ...;<br><span class="hljs-comment">#为哪些请求方法使用缓存</span><br><br>fastcgi_cache_min_uses number;<br><span class="hljs-comment">#缓存空间中的缓存项在inactive定义的非活动时间内至少要被访问到此处所指定的次数方可被认作活动项</span><br><br>fastcgi_keep_conn on | off; <br><span class="hljs-comment">#收到后端服务器响应后，fastcgi服务器是否关闭连接，建议启用长连接</span><br><br>fastcgi_cache_valid [code ...] time;<br><span class="hljs-comment">#不同的响应码各自的缓存时长</span><br><br>fastcgi_hide_header field; <span class="hljs-comment">#隐藏响应头指定信息</span><br>fastcgi_pass_header field; <span class="hljs-comment">#返回响应头指定信息，默认不会将Status、X-Accel-...返回</span><br></code></pre></td></tr></table></figure><h4 id="4-4-2-FastCGI实战案例-Nginx与php-fpm在同一服务器"><a href="#4-4-2-FastCGI实战案例-Nginx与php-fpm在同一服务器" class="headerlink" title="4.4.2 FastCGI实战案例 : Nginx与php-fpm在同一服务器"></a>4.4.2 FastCGI实战案例 : Nginx与php-fpm在同一服务器</h4><p>php安装可以通过yum或者编译安装，使用yum安装相对比较简单，编译安装更方便自定义参数或选项。<br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi4.jpg"></p><h5 id="4-4-2-1-环境准备"><a href="#4-4-2-1-环境准备" class="headerlink" title="4.4.2.1 环境准备"></a>4.4.2.1 环境准备</h5><p>使用base源自带的php版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-comment">#yum或apt安装默认版本php和相关APP依赖的包</span><br>yum -y install php-fpm php-mysqlnd php-json <span class="hljs-comment">#centos</span><br>apt -y install php-fpm php-mysqlnd php-json <span class="hljs-comment">#Ubuntu</span><br><span class="hljs-comment">#或者安装清华的php源</span><br>yum install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm<br><br><span class="hljs-comment">#开启php-fpm</span><br>systemclt start php-fpm <span class="hljs-comment">#centos</span><br>systemctl start php7.2-fpm <span class="hljs-comment">#ubuntu</span><br><br><span class="hljs-comment">#查看php-fpm是否开启成功</span><br>ps -ef | grep php-fpm<br>root      24262      1  0 18:18 ?        00:00:00 php-fpm: master process (/etc/php/7.2/fpm/php-fpm.conf)<br>nginx     24263  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24264  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24265  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24266  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24267  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>root      24486  23795  0 20:09 pts/1    00:00:00 grep --color=auto php-fpm<br><br></code></pre></td></tr></table></figure><h5 id="4-4-2-2-php相关配置优化"><a href="#4-4-2-2-php相关配置优化" class="headerlink" title="4.4.2.2 php相关配置优化"></a>4.4.2.2 php相关配置优化</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.101</span><br>vim /etc/php-fpm.conf  <span class="hljs-comment">#centos</span><br>include=/etc/php-fpm.d/*.conf<br>pid = /run/php-fpm/php-fpm.pid<br>error_log = /var/<span class="hljs-built_in">log</span>/php-fpm/error.log<br>daemonize = yes <span class="hljs-comment">#是否后台启动</span><br>vim /etc/php/7.2/fpm/php-fpm.conf  <span class="hljs-comment">#ubuntu</span><br>pid = /run/php/php7.2-fpm.pid<br>error_log = /var/<span class="hljs-built_in">log</span>/php7.2-fpm.log<br>include=/etc/php/7.2/fpm/pool.d/*.conf<br><br>vim /etc/php-fpm.d/www.conf <span class="hljs-comment">#centos</span><br>vim /etc/php/7.2/fpm/pool.d <span class="hljs-comment">#ubuntu</span><br>[www]<br>user = nginx<br>group = nginx<br>listen = /run/php-fpm/www.sock  <span class="hljs-comment">#指定使用UDS,或者使用下面形式</span><br>;listen = 127.0.0.1:9000  <span class="hljs-comment">#监听地址及IP</span><br>listen.acl_users = apache,nginx<br>listen.allowed_clients = 127.0.0.1<br>pm = dynamic<br>pm.max_children = 50<br>pm.start_servers = 5<br>pm.min_spare_servers = 5<br>pm.max_spare_servers = 35<br>pm.status_path = /pm_status  <span class="hljs-comment">#修改此行</span><br><br>systemctl start php-fpm <span class="hljs-comment">#centos</span><br>systemctl start php7.2-fpm <span class="hljs-comment"># ubuntu</span><br></code></pre></td></tr></table></figure><h5 id="4-4-2-3准备php测试页面"><a href="#4-4-2-3准备php测试页面" class="headerlink" title="4.4.2.3准备php测试页面"></a>4.4.2.3准备php测试页面</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.101</span><br>mkdir -p /data/php<br>vim /data/php/index.php <span class="hljs-comment">#php测试页面</span><br>&lt;?php<br>phpinfo();<br>?&gt;<br></code></pre></td></tr></table></figure><h5 id="4-4-2-4-Nginx配置转发"><a href="#4-4-2-4-Nginx配置转发" class="headerlink" title="4.4.2.4 Nginx配置转发"></a>4.4.2.4 Nginx配置转发</h5><p>Nginx安装完成之后默认生成了与fastcgi的相关配置文件，一般保存在nginx的安装路径的conf目录当中，比如/apps/nginx/conf/fastcgi.conf、/apps/nginx/conf/fastcgi_params。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$|status|ping</span> &#123;<br>            <span class="hljs-attribute">root</span>           /data/php; <span class="hljs-comment">#$document_root调用root目录</span><br>            <span class="hljs-attribute">fastcgi_pass</span>  unix:/run/php-fpm/www.sock;<br>            <span class="hljs-comment">#fastcgi_pass   127.0.0.1:9000;</span><br>            <span class="hljs-attribute">fastcgi_index</span>  index.php;<br>            <span class="hljs-attribute">fastcgi_param</span>  SCRIPT_FILENAME  /data/php$fastcgi_script_name;<br>            <span class="hljs-comment">#fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br>            <span class="hljs-comment">#如果SCRIPT_FILENAME是绝对路径则可以省略root /data/php;</span><br>            <span class="hljs-attribute">include</span>        fastcgi_params;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><span class="hljs-comment">#浏览器访问www.rlinpc.net/index.php</span><br></code></pre></td></tr></table></figure><h5 id="4-4-2-5-访问验证php测试页面"><a href="#4-4-2-5-访问验证php测试页面" class="headerlink" title="4.4.2.5 访问验证php测试页面"></a>4.4.2.5 访问验证php测试页面</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi7.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#常见的错误：</span><br>File not found.  <span class="hljs-comment">#路径不对</span><br>502  <span class="hljs-comment">#php-fpm处理超时、服务停止运行等原因导致的无法连接或请求超时</span><br></code></pre></td></tr></table></figure><h5 id="4-4-2-6-php-fpm-的运行状态页面"><a href="#4-4-2-6-php-fpm-的运行状态页面" class="headerlink" title="4.4.2.6 php-fpm 的运行状态页面"></a>4.4.2.6 php-fpm 的运行状态页面</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(ping|pm_status)$</span> &#123;<br>             <span class="hljs-attribute">include</span> fastcgi_params;<br>             <span class="hljs-comment">#fastcgi_pass unix:/run/php-fpm/www.sock;</span><br>             <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">127.0.0.1:9000</span>;<br>             <span class="hljs-attribute">fastcgi_param</span> PATH_TRANSLATED $document_root$fastcgi_script_name;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#测试</span><br>curl http://www.rlinpc.net/ping<br>pong<br><br>curl http://www.rlinpc.net/pm_status<br>pool:                 www<br>process manager:      dynamic<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8436</span><br>accepted conn:        <span class="hljs-number">5</span><br>listen queue:         <span class="hljs-number">0</span><br>max listen queue:     <span class="hljs-number">0</span><br>listen queue len:     <span class="hljs-number">511</span><br>idle processes:       <span class="hljs-number">4</span><br>active processes:     <span class="hljs-number">1</span><br>total processes:      <span class="hljs-number">5</span><br>max active processes: <span class="hljs-number">1</span><br>max children reached: <span class="hljs-number">0</span><br>slow requests:        <span class="hljs-number">0</span><br><br>curl http://www.rlinpc.net/pm_status?full<br>pool:                 www<br>process manager:      dynamic<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>accepted conn:        <span class="hljs-number">6</span><br>listen queue:         <span class="hljs-number">0</span><br>max listen queue:     <span class="hljs-number">0</span><br>listen queue len:     <span class="hljs-number">511</span><br>idle processes:       <span class="hljs-number">4</span><br>active processes:     <span class="hljs-number">1</span><br>total processes:      <span class="hljs-number">5</span><br>max active processes: <span class="hljs-number">1</span><br>max children reached: <span class="hljs-number">0</span><br>slow requests:        <span class="hljs-number">0</span><br><br>************************<br>pid:                  <span class="hljs-number">24263</span><br>state:                Running<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>requests:             <span class="hljs-number">2</span><br>request duration:     <span class="hljs-number">268</span><br>request method:       GET<br>request URI:          /pm_status?full<br>content length:       <span class="hljs-number">0</span><br>user:                 -<br>script:               -<br><span class="hljs-literal">last</span> request cpu:     <span class="hljs-number">0</span>.<span class="hljs-number">00</span><br><span class="hljs-literal">last</span> request memory:  <span class="hljs-number">0</span><br><br>************************<br>pid:                  <span class="hljs-number">24264</span><br>state:                Idle<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>requests:             <span class="hljs-number">1</span><br>request duration:     <span class="hljs-number">13377</span><br>request method:       GET<br>request URI:          /pm_status<br>content length:       <span class="hljs-number">0</span><br>user:                 -<br>script:               -<br><span class="hljs-literal">last</span> request cpu:     <span class="hljs-number">0</span>.<span class="hljs-number">00</span><br><span class="hljs-literal">last</span> request memory:  <span class="hljs-number">2097152</span><br><br>************************<br>pid:                  <span class="hljs-number">24265</span><br>state:                Idle<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>requests:             <span class="hljs-number">1</span><br>request duration:     <span class="hljs-number">532</span><br>request method:       GET<br>request URI:          /ping<br>content length:       <span class="hljs-number">0</span><br>user:                 -<br>script:               -<br><span class="hljs-literal">last</span> request cpu:     <span class="hljs-number">0</span>.<span class="hljs-number">00</span><br><span class="hljs-literal">last</span> request memory:  <span class="hljs-number">2097152</span><br><br>************************<br>pid:                  <span class="hljs-number">24266</span><br>state:                Idle<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>requests:             <span class="hljs-number">1</span><br>request duration:     <span class="hljs-number">580</span><br>request method:       GET<br>request URI:          /ping<br>content length:       <span class="hljs-number">0</span><br>user:                 -<br>script:               -<br><span class="hljs-literal">last</span> request cpu:     <span class="hljs-number">0</span>.<span class="hljs-number">00</span><br><span class="hljs-literal">last</span> request memory:  <span class="hljs-number">2097152</span><br><br>************************<br>pid:                  <span class="hljs-number">24267</span><br>state:                Idle<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>requests:             <span class="hljs-number">1</span><br>request duration:     <span class="hljs-number">426</span><br>request method:       GET<br>request URI:          /pm_status<br>content length:       <span class="hljs-number">0</span><br>user:                 -<br>script:               -<br><span class="hljs-literal">last</span> request cpu:     <span class="hljs-number">0</span>.<span class="hljs-number">00</span><br><span class="hljs-literal">last</span> request memory:  <span class="hljs-number">2097152</span><br><br>curl http://www.rlinpc.net/pm_status?html<br>&lt;!DOCTYPE html PUBLIC <span class="hljs-string">&quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;</span> <span class="hljs-string">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;</span>&gt;<br>&lt;html xmlns=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span> xml:lang=<span class="hljs-string">&quot;en&quot;</span> lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;&lt;title&gt;PHP-FPM Status Page&lt;/title&gt;&lt;/head&gt;<br>&lt;body&gt;<br>&lt;table&gt;<br>&lt;tr&gt;&lt;th&gt;pool&lt;/th&gt;&lt;td&gt;www&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;process manager&lt;/th&gt;&lt;td&gt;dynamic&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;start time&lt;/th&gt;&lt;td&gt;<span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;start since&lt;/th&gt;&lt;td&gt;<span class="hljs-number">8487</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;accepted conn&lt;/th&gt;&lt;td&gt;<span class="hljs-number">7</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;listen queue&lt;/th&gt;&lt;td&gt;<span class="hljs-number">0</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;max listen queue&lt;/th&gt;&lt;td&gt;<span class="hljs-number">0</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;listen queue len&lt;/th&gt;&lt;td&gt;<span class="hljs-number">511</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;idle processes&lt;/th&gt;&lt;td&gt;<span class="hljs-number">4</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;active processes&lt;/th&gt;&lt;td&gt;<span class="hljs-number">1</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;total processes&lt;/th&gt;&lt;td&gt;<span class="hljs-number">5</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;max active processes&lt;/th&gt;&lt;td&gt;<span class="hljs-number">1</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;max children reached&lt;/th&gt;&lt;td&gt;<span class="hljs-number">0</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;slow requests&lt;/th&gt;&lt;td&gt;<span class="hljs-number">0</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;/table&gt;<br>&lt;/body&gt;&lt;/html&gt;<br><br>curl http://www.rlinpc.net/pm_status?json<br>&#123;&quot;pool&quot;:&quot;www&quot;,&quot;<span class="hljs-attribute">process</span> manager<span class="hljs-string">&quot;:&quot;</span>dynamic<span class="hljs-string">&quot;,&quot;</span>start time<span class="hljs-string">&quot;:1614075531,&quot;</span>start since<span class="hljs-string">&quot;:8517,&quot;</span>accepted conn<span class="hljs-string">&quot;:8,&quot;</span>listen queue<span class="hljs-string">&quot;:0,&quot;</span>max listen queue<span class="hljs-string">&quot;:0,&quot;</span>listen queue len<span class="hljs-string">&quot;:511,&quot;</span>idle processes<span class="hljs-string">&quot;:4,&quot;</span>active processes<span class="hljs-string">&quot;:1,&quot;</span>total processes<span class="hljs-string">&quot;:5,&quot;</span>max active processes<span class="hljs-string">&quot;:1,&quot;</span>max children reached<span class="hljs-string">&quot;:0,&quot;</span>slow requests<span class="hljs-string">&quot;:0&#125;</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi8.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi9.jpg"></p><h5 id="4-4-2-7-安装数据库"><a href="#4-4-2-7-安装数据库" class="headerlink" title="4.4.2.7 安装数据库"></a>4.4.2.7 安装数据库</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.101</span><br>yum install -y mariadb-server <span class="hljs-comment">#centos</span><br>apt isntall -y mysql-server <span class="hljs-comment">#ubuntu</span><br><br><span class="hljs-comment">#ubuntu</span><br>vim /etc/mysql/mysql.conf.d/mysqld.cnf<br><span class="hljs-comment">#bind-address           = 127.0.0.1</span><br>bind-address            = *  <span class="hljs-comment">#将本地地址改为*</span><br><br><span class="hljs-comment">#开启数据库</span><br>systemctl start mariadb <span class="hljs-comment">#centos</span><br>systemctl start mysql <span class="hljs-comment">#ubuntu</span><br>mysql<br>create database wordpress;<br>grant all on wordpress.* to wordpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure><h5 id="4-4-2-8-布置wordpress"><a href="#4-4-2-8-布置wordpress" class="headerlink" title="4.4.2.8 布置wordpress"></a>4.4.2.8 布置wordpress</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-attribute">cd</span> /data/php<br>wget https://cn.wordpress.org/latest-zh_CN.tar.gz<br>tar xvf latest-zh_CN.tar.gz<br>chown nginx.nginx -R wordpress<br>vim /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /wordpress &#123;<br>        <span class="hljs-attribute">root</span> /data/php;<br>        <span class="hljs-attribute">index</span> index.php;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment">#浏览器访问www.rlinpc.net/wordpress/index.php，按着安装(注意chrome的缓存会是wordpress/index.php一直出现下载文件的状态，这是需要清理缓存或更换浏览器)</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi10.jpg"></p><h4 id="4-4-3-FastCGI实战案例-Nginx与php不在同一个服务器"><a href="#4-4-3-FastCGI实战案例-Nginx与php不在同一个服务器" class="headerlink" title="4.4.3 FastCGI实战案例 : Nginx与php不在同一个服务器"></a>4.4.3 FastCGI实战案例 : Nginx与php不在同一个服务器</h4><p>nginx会处理静态请求，但是会转发动态请求到后端指定的php-fpm服务器，因此代码也需要放在后端的php-fpm服务器，即静态页面放在Nginx服务器上,而动态页面放在后端php-fpm服务器，正常情况下，一般都是采用在同一个服务器<br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi5.jpg"></p><h5 id="4-4-3-1-安装较新版本php-fpm"><a href="#4-4-3-1-安装较新版本php-fpm" class="headerlink" title="4.4.3.1 安装较新版本php-fpm"></a>4.4.3.1 安装较新版本php-fpm</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-comment">#yum或apt安装默认版本php和相关APP依赖的包</span><br>yum -y install php-fpm php-mysqlnd php-json <span class="hljs-comment">#centos</span><br>apt -y install php-fpm php-mysqlnd php-json <span class="hljs-comment">#Ubuntu</span><br><span class="hljs-comment">#或者安装清华的php源</span><br>yum install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm<br><br><span class="hljs-comment">#centos验证安装路径</span><br>rpm -ql php-fpm<br>/etc/httpd/conf.d/php.conf<br>/etc/logrotate.d/php-fpm<br>/etc/nginx/conf.d/php-fpm.conf<br>/etc/nginx/default.d/php.conf<br>/etc/php-fpm.conf<br>/etc/php-fpm.d<br>/etc/php-fpm.d/www.conf<br>/etc/systemd/system/php-fpm.service.d<br>/run/php-fpm<br>/usr/lib/.build-id<br>/usr/lib/.build-id/bf<br>/usr/lib/.build-id/bf/8d6b2bca109fb20f8037d72220670f2d6cc954<br>/usr/lib/systemd/system/httpd.service.d/php-fpm.conf<br>/usr/lib/systemd/system/nginx.service.d/php-fpm.conf<br>/usr/lib/systemd/system/php-fpm.service<br>/usr/sbin/php-fpm<br>/usr/share/doc/php-fpm<br>/usr/share/doc/php-fpm/php-fpm.conf.default<br>/usr/share/doc/php-fpm/www.conf.default<br>/usr/share/fpm<br>/usr/share/fpm/status.html<br>/usr/share/licenses/php-fpm<br>/usr/share/licenses/php-fpm/fpm_LICENSE<br>/usr/share/man/man8/php-fpm.8.gz<br>/var/lib/php/opcache<br>/var/lib/php/session<br>/var/lib/php/wsdlcache<br>/var/<span class="hljs-built_in">log</span>/php-fpm<br><br><span class="hljs-comment">#ubuntu验证安装路径</span><br>dpkg -L php7.2-fpm<br>/.<br>/etc<br>/etc/apache2<br>/etc/apache2/conf-available<br>/etc/apache2/conf-available/php7.2-fpm.conf<br>/etc/init<br>/etc/init/php7.2-fpm.conf<br>/etc/init.d<br>/etc/init.d/php7.2-fpm<br>/etc/logrotate.d<br>/etc/logrotate.d/php7.2-fpm<br>/etc/php<br>/etc/php/7.2<br>/etc/php/7.2/fpm<br>/etc/php/7.2/fpm/conf.d<br>/etc/php/7.2/fpm/php-fpm.conf<br>/etc/php/7.2/fpm/pool.d<br>/etc/php/7.2/fpm/pool.d/www.conf<br>/lib<br>/lib/systemd<br>/lib/systemd/system<br>/lib/systemd/system/php7.2-fpm.service<br>/usr<br>/usr/lib<br>/usr/lib/php<br>/usr/lib/php/7.2<br>/usr/lib/php/7.2/sapi<br>/usr/lib/php/7.2/sapi/fpm<br>/usr/lib/php/php7.2-fpm-reopenlogs<br>/usr/lib/tmpfiles.d<br>/usr/lib/tmpfiles.d/php7.2-fpm.conf<br>/usr/sbin<br>/usr/sbin/php-fpm7.2<br>/usr/share<br>/usr/share/bug<br>/usr/share/bug/php7.2-fpm<br>/usr/share/bug/php7.2-fpm/control<br>/usr/share/bug/php7.2-fpm/script<br>/usr/share/doc<br>/usr/share/lintian<br>/usr/share/lintian/overrides<br>/usr/share/lintian/overrides/php7.2-fpm<br>/usr/share/man<br>/usr/share/man/man8<br>/usr/share/man/man8/php-fpm7.2.8.gz<br>/usr/share/php<br>/usr/share/php/7.2<br>/usr/share/php/7.2/fpm<br>/usr/share/php/7.2/fpm/status.html<br>/usr/share/doc/php7.2-fpm<br><br><span class="hljs-comment">#开启php-fpm</span><br>systemclt start php-fpm <span class="hljs-comment">#centos</span><br>systemctl start php7.2-fpm <span class="hljs-comment">#ubuntu</span><br><br><span class="hljs-comment">#查看php-fpm是否开启成功</span><br>ps -ef | grep php-fpm<br>root      24262      1  0 18:18 ?        00:00:00 php-fpm: master process (/etc/php/7.2/fpm/php-fpm.conf)<br>nginx     24263  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24264  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24265  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24266  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24267  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>root      24486  23795  0 20:09 pts/1    00:00:00 grep --color=auto php-fpm<br></code></pre></td></tr></table></figure><h5 id="4-4-3-2-修改php-fpm监听配置"><a href="#4-4-3-2-修改php-fpm监听配置" class="headerlink" title="4.4.3.2 修改php-fpm监听配置"></a>4.4.3.2 修改php-fpm监听配置</h5><p>php-fpm默认监听在127.0.0.1的9000端口，也就是无法远程连接，因此要做相应的修改。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-comment">#修改监听配置</span><br><span class="hljs-comment">#centos</span><br>vim /etc/php-fpm.d/www.conf<br>;listen = /run/php-fpm/www.sock <span class="hljs-comment">#注释此行</span><br>listen = 9000  <span class="hljs-comment">#指定监听端口</span><br>;listen.allowed_clients = 127.0.0.1  <span class="hljs-comment">#注释此行</span><br><br><span class="hljs-comment">#ubuntu</span><br>vim /etc/php/7.2/fpm/pool.d/www.conf <br>;listen = /run/php/php7.2-fpm.sock <span class="hljs-comment">#注释此行</span><br>listen = 9000<br>;listen.allowed_clients = 127.0.0.1  <span class="hljs-comment">#注释此行</span><br></code></pre></td></tr></table></figure><h5 id="4-4-3-3-准备php测试页面"><a href="#4-4-3-3-准备php测试页面" class="headerlink" title="4.4.3.3 准备php测试页面"></a>4.4.3.3 准备php测试页面</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-comment">#准备php数据目录</span><br>mkdir -p /data/php<br>vim /data/php/index.php<br>&lt;?php<br>phpinfo();<br>?&gt;<br></code></pre></td></tr></table></figure><h5 id="4-4-3-4-启动并验证php-fpm"><a href="#4-4-3-4-启动并验证php-fpm" class="headerlink" title="4.4.3.4 启动并验证php-fpm"></a>4.4.3.4 启动并验证php-fpm</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-comment">#启动php-fpm</span><br>systemctl <span class="hljs-built_in">enable</span> --now php-fpm.service <span class="hljs-comment">#centos</span><br>systemctl <span class="hljs-built_in">enable</span> --now php7.2-fpm.service <span class="hljs-comment">#ubuntu</span><br><br><span class="hljs-comment">#验证php-fpm进程及端口</span><br>ps -ef | grep php-fpm<br>root        775      1  0 21:43 ?        00:00:00 php-fpm: master process (/etc/php/7.2/fpm/php-fpm.conf)<br>nginx       855    775  0 21:44 ?        00:00:00 php-fpm: pool www<br>nginx       856    775  0 21:44 ?        00:00:00 php-fpm: pool www<br>nginx       857    775  0 21:44 ?        00:00:00 php-fpm: pool www<br>nginx       858    775  0 21:44 ?        00:00:00 php-fpm: pool www<br>nginx       859    775  0 21:44 ?        00:00:00 php-fpm: pool www<br>root       1154   1051  0 21:53 pts/0    00:00:00 grep --color=auto php-fpm<br><br>ss -tnl | grep 9000<br>LISTEN   0         511                       *:9000                   *:* <br><br>lsof -i :9000<br>COMMAND   PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>php-fpm7. 775  root    7u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 855 nginx    9u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 856 nginx    9u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 857 nginx    9u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 858 nginx    9u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 859 nginx    9u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br></code></pre></td></tr></table></figure><h5 id="4-4-3-5-Nginx配置转发"><a href="#4-4-3-5-Nginx配置转发" class="headerlink" title="4.4.3.5 Nginx配置转发"></a>4.4.3.5 Nginx配置转发</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">index</span> index.php;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$|status|ping</span> &#123;<br>            <span class="hljs-attribute">root</span>           html;<br>            <span class="hljs-attribute">fastcgi_pass</span>   <span class="hljs-number">10.0.0.102:9000</span>;<br>            <span class="hljs-attribute">fastcgi_index</span>  index.php;<br>            <span class="hljs-attribute">fastcgi_param</span>  SCRIPT_FILENAME  /data/php$fastcgi_script_name;<br>            <span class="hljs-comment">#fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br>            <span class="hljs-attribute">include</span>        fastcgi_params;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(ping|pm_status)$</span> &#123;<br>             <span class="hljs-attribute">include</span> fastcgi_params;<br>             <span class="hljs-comment">#fastcgi_pass unix:/run/php-fpm/www.sock;</span><br>             <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">10.0.0.102:9000</span>;<br>             <span class="hljs-attribute">fastcgi_param</span> PATH_TRANSLATED $document_root$fastcgi_script_name;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h5 id="4-4-3-6-访问验证php测试页面"><a href="#4-4-3-6-访问验证php测试页面" class="headerlink" title="4.4.3.6 访问验证php测试页面"></a>4.4.3.6 访问验证php测试页面</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi11.jpg"></p><h4 id="4-4-4-实现动静分离"><a href="#4-4-4-实现动静分离" class="headerlink" title="4.4.4 实现动静分离"></a>4.4.4 实现动静分离</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi6.jpg"></p><p>要求：将客户端对除php以外的资源的访问转发至后端服务器 10.0.0.103上</p><h5 id="4-4-4-1-配置-Nginx-实现反向代理的动静分离"><a href="#4-4-4-1-配置-Nginx-实现反向代理的动静分离" class="headerlink" title="4.4.4.1 配置 Nginx 实现反向代理的动静分离"></a>4.4.4.1 配置 Nginx 实现反向代理的动静分离</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101 </span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.103; <span class="hljs-comment">#注意端口</span><br>    &#125;<br>   <br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$|status|ping</span> &#123;<br>            <span class="hljs-attribute">root</span>           /data/php;<br>            <span class="hljs-attribute">fastcgi_pass</span>   <span class="hljs-number">10.0.0.102:9000</span>;<br>            <span class="hljs-attribute">fastcgi_index</span>  index.php;<br>            <span class="hljs-comment">#fastcgi_param  SCRIPT_FILENAME  /data/php$fastcgi_script_name;</span><br>            <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME  $document_root$fastcgi_script_name;<br>            <span class="hljs-attribute">include</span>        fastcgi_params;<br>    &#125;<br>&#125;<br><br>/apps/nginx/sbin/<span class="hljs-attribute">nginx</span> -t<br>/apps/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h5 id="4-4-4-2-准备后端php服务器"><a href="#4-4-4-2-准备后端php服务器" class="headerlink" title="4.4.4.2 准备后端php服务器"></a>4.4.4.2 准备后端php服务器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.102安装php服务</span><br><span class="hljs-comment">#yum或apt安装默认版本php和相关APP依赖的包</span><br>yum -y install php-fpm php-mysqlnd php-json <span class="hljs-comment">#centos</span><br>apt -y install php-fpm php-mysqlnd php-json <span class="hljs-comment">#Ubuntu</span><br><span class="hljs-comment">#或者安装清华的php源</span><br>yum install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm<br><br><span class="hljs-comment">#centos验证安装路径</span><br>rpm -ql php-fpm<br>/etc/httpd/conf.d/php.conf<br>/etc/logrotate.d/php-fpm<br>/etc/nginx/conf.d/php-fpm.conf<br>/etc/nginx/default.d/php.conf<br>/etc/php-fpm.conf<br>/etc/php-fpm.d<br>/etc/php-fpm.d/www.conf<br>/etc/systemd/system/php-fpm.service.d<br>/run/php-fpm<br>/usr/lib/.build-id<br>/usr/lib/.build-id/bf<br>/usr/lib/.build-id/bf/8d6b2bca109fb20f8037d72220670f2d6cc954<br>/usr/lib/systemd/system/httpd.service.d/php-fpm.conf<br>/usr/lib/systemd/system/nginx.service.d/php-fpm.conf<br>/usr/lib/systemd/system/php-fpm.service<br>/usr/sbin/php-fpm<br>/usr/share/doc/php-fpm<br>/usr/share/doc/php-fpm/php-fpm.conf.default<br>/usr/share/doc/php-fpm/www.conf.default<br>/usr/share/fpm<br>/usr/share/fpm/status.html<br>/usr/share/licenses/php-fpm<br>/usr/share/licenses/php-fpm/fpm_LICENSE<br>/usr/share/man/man8/php-fpm.8.gz<br>/var/lib/php/opcache<br>/var/lib/php/session<br>/var/lib/php/wsdlcache<br>/var/<span class="hljs-built_in">log</span>/php-fpm<br><br><span class="hljs-comment">#ubuntu验证安装路径</span><br>dpkg -L php7.2-fpm<br>/.<br>/etc<br>/etc/apache2<br>/etc/apache2/conf-available<br>/etc/apache2/conf-available/php7.2-fpm.conf<br>/etc/init<br>/etc/init/php7.2-fpm.conf<br>/etc/init.d<br>/etc/init.d/php7.2-fpm<br>/etc/logrotate.d<br>/etc/logrotate.d/php7.2-fpm<br>/etc/php<br>/etc/php/7.2<br>/etc/php/7.2/fpm<br>/etc/php/7.2/fpm/conf.d<br>/etc/php/7.2/fpm/php-fpm.conf<br>/etc/php/7.2/fpm/pool.d<br>/etc/php/7.2/fpm/pool.d/www.conf<br>/lib<br>/lib/systemd<br>/lib/systemd/system<br>/lib/systemd/system/php7.2-fpm.service<br>/usr<br>/usr/lib<br>/usr/lib/php<br>/usr/lib/php/7.2<br>/usr/lib/php/7.2/sapi<br>/usr/lib/php/7.2/sapi/fpm<br>/usr/lib/php/php7.2-fpm-reopenlogs<br>/usr/lib/tmpfiles.d<br>/usr/lib/tmpfiles.d/php7.2-fpm.conf<br>/usr/sbin<br>/usr/sbin/php-fpm7.2<br>/usr/share<br>/usr/share/bug<br>/usr/share/bug/php7.2-fpm<br>/usr/share/bug/php7.2-fpm/control<br>/usr/share/bug/php7.2-fpm/script<br>/usr/share/doc<br>/usr/share/lintian<br>/usr/share/lintian/overrides<br>/usr/share/lintian/overrides/php7.2-fpm<br>/usr/share/man<br>/usr/share/man/man8<br>/usr/share/man/man8/php-fpm7.2.8.gz<br>/usr/share/php<br>/usr/share/php/7.2<br>/usr/share/php/7.2/fpm<br>/usr/share/php/7.2/fpm/status.html<br>/usr/share/doc/php7.2-fpm<br><br><span class="hljs-comment">#开启php-fpm</span><br>systemclt start php-fpm <span class="hljs-comment">#centos</span><br>systemctl start php7.2-fpm <span class="hljs-comment">#ubuntu</span><br><br><span class="hljs-comment">#查看php-fpm是否开启成功</span><br>ps -ef | grep php-fpm<br>root      24262      1  0 18:18 ?        00:00:00 php-fpm: master process (/etc/php/7.2/fpm/php-fpm.conf)<br>nginx     24263  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24264  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24265  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24266  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24267  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>root      24486  23795  0 20:09 pts/1    00:00:00 grep --color=auto php-fpm<br><br><span class="hljs-comment">#准备php数据目录</span><br>mkdir -p /data/php<br>vim /data/php/index.php<br>&lt;?php<br>phpinfo();<br>?&gt;<br><br><span class="hljs-comment">#修改监听配置</span><br><span class="hljs-comment">#centos</span><br>vim /etc/php-fpm.d/www.conf<br>;listen = /run/php-fpm/www.sock <span class="hljs-comment">#注释此行</span><br>listen = 9000  <span class="hljs-comment">#指定监听端口</span><br>;listen.allowed_clients = 127.0.0.1  <span class="hljs-comment">#注释此行</span><br>systemctl restart php-fpm<br><br><span class="hljs-comment">#ubuntu</span><br>vim /etc/php/7.2/fpm/pool.d/www.conf <br>;listen = /run/php/php7.2-fpm.sock <span class="hljs-comment">#注释此行</span><br>listen = 9000<br>;listen.allowed_clients = 127.0.0.1  <span class="hljs-comment">#注释此行</span><br>systemctl restart php7.2-fpm<br><br><span class="hljs-comment">#启动php-fpm</span><br>systemctl <span class="hljs-built_in">enable</span> --now php-fpm.service <span class="hljs-comment">#centos</span><br>systemctl <span class="hljs-built_in">enable</span> --now php7.2-fpm.service <span class="hljs-comment">#ubuntu</span><br><br><span class="hljs-comment">#验证php-fpm进程及端口</span><br>ps -ef | grep php-fpm<br>root       9775      1  0 20:13 ?        00:00:00 php-fpm: master process (/etc/php/7.2/fpm/php-fpm.conf)<br>www-data   9776   9775  0 20:13 ?        00:00:00 php-fpm: pool www<br>www-data   9777   9775  0 20:13 ?        00:00:00 php-fpm: pool www<br>root       9805   1409  0 20:18 pts/0    00:00:00 grep --color=auto php-fpm<br><br><br>ss -tnl | grep 9000<br>LISTEN   0         511                       *:9000                   *:* <br><br>lsof -i :9000<br>COMMAND    PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>php-fpm7. 9775     root    7u  IPv6  59755      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 9776 www-data    9u  IPv6  59755      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 9777 www-data    9u  IPv6  59755      0t0  TCP *:9000 (LISTEN)<br><br></code></pre></td></tr></table></figure><h5 id="4-4-4-3-准备后端-httpd-服务器"><a href="#4-4-4-3-准备后端-httpd-服务器" class="headerlink" title="4.4.4.3 准备后端 httpd 服务器"></a>4.4.4.3 准备后端 httpd 服务器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.103安装httpd服务</span><br>yum -y install httpd <span class="hljs-comment">#centos</span><br>apt -y install apache2 <span class="hljs-comment">#ubuntu</span><br><br>systemctl <span class="hljs-built_in">enable</span> --now httpd <span class="hljs-comment">#centos</span><br>systemctl <span class="hljs-built_in">enable</span> --now apache2 <span class="hljs-comment">#ubuntu</span><br><br>mkdir /var/www/html/images -p <br><span class="hljs-built_in">cd</span> /var/www/html/images <br><span class="hljs-comment">#存放一张1.jpg的图片</span><br></code></pre></td></tr></table></figure><h5 id="4-4-4-4-测试"><a href="#4-4-4-4-测试" class="headerlink" title="4.4.4.4 测试"></a>4.4.4.4 测试</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi11.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi12.jpg"></p><h2 id="五、Nginx-二次开发版本"><a href="#五、Nginx-二次开发版本" class="headerlink" title="五、Nginx 二次开发版本"></a>五、Nginx 二次开发版本</h2><h3 id="5-1-Tengine"><a href="#5-1-Tengine" class="headerlink" title="5.1 Tengine"></a>5.1 Tengine</h3><h4 id="5-1-1-Tengine-介绍"><a href="#5-1-1-Tengine-介绍" class="headerlink" title="5.1.1 Tengine 介绍"></a>5.1.1 Tengine 介绍</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-tengine1.jpg"><br>Tengine是由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性。Tengine的性能和稳定性已经在大型的网站如淘宝网，天猫商城等得到了很好的检验。它的最终目标是打造一个高效、稳定、安全、易用的Web平台。</p><p>官网：<a href="http://tengine.taobao.org/">http://tengine.taobao.org/</a></p><p>官方文档：<br><a href="http://tengine.taobao.org/documentation_cn.html">http://tengine.taobao.org/documentation_cn.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">继承Nginx-1.16.0的所有特性，兼容nginx的配置<br>支持HTTP的CONNECT方法，可用于正向代理场景<br>支持异步OpenSSL，可使用硬件如:QAT进行HTTPS的加速与卸载<br>增强相关运维、监控能力,比如异步打印日志及回滚,本地DNS缓存,内存监控等<br>Stream模块支持server_name指令<br>更加强大的负载均衡能力，包括一致性<span class="hljs-built_in">hash</span>模块、会话保持模块，还可以对后端的服务器进行主动健康检查，<br>根据服务器状态自动上线下线，以及动态解析upstream中出现的域名<br>输入过滤器机制支持。通过使用这种机制Web应用防火墙的编写更为方便<br>支持设置proxy、memcached、fastcgi、scgi、uwsgi在后端失败时的重试次数<br>动态脚本语言Lua支持。扩展功能非常高效简单<br>支持按指定关键字(域名，url等)收集Tengine运行状态<br>组合多个CSS、JavaScript文件的访问请求变成一个请求<br>自动去除空白字符和注释从而减小页面的体积<br>自动根据CPU数目设置进程个数和绑定CPU亲缘性;<br>监控系统的负载和资源占用从而对系统进行保护<br>显示对运维人员更友好的出错信息，便于定位出错机器<br>更强大的防攻击（访问速度限制）模块<br>更方便的命令行参数，如列出编译的模块列表、支持的指令等<br>可以根据访问文件类型设置过期时间<br></code></pre></td></tr></table></figure><h4 id="5-1-2-动态模块"><a href="#5-1-2-动态模块" class="headerlink" title="5.1.2 动态模块"></a>5.1.2 动态模块</h4><p><a href="http://tengine.taobao.org/document_cn/dso_cn.html">http://tengine.taobao.org/document_cn/dso_cn.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">这个模块主要是用来运行时动态加载模块，而不用每次都要重新编译Tengine.<br>如果你想要编译官方模块为动态模块，你需要在configure的时候加上类似这样的指令(--with-http_xxx_module),./configure --<span class="hljs-built_in">help</span>可以看到更多的细节.<br>如果只想要安装官方模块为动态模块(不安装Nginx)，那么就只需要configure之后，执行 make dso_install命令.<br>动态加载模块的个数限制为128个.<br>如果已经加载的动态模块有修改，那么必须重起Tengine才会生效.<br>只支持HTTP模块.<br>模块 在Linux/FreeBSD/MacOS下测试成功.<br>例子:<br>worker_processes  1;<br>dso &#123;<br>      load ngx_http_lua_module.so;<br>      load ngx_http_memcached_module.so;<br>&#125;<br>events &#123;<br>      worker_connections  1024;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="5-1-2-1-编译安装-tengine-2-1-2"><a href="#5-1-2-1-编译安装-tengine-2-1-2" class="headerlink" title="5.1.2.1 编译安装 tengine-2.1.2"></a>5.1.2.1 编译安装 tengine-2.1.2</h5><p>注意: 不支持CentOS8，ubuntu1804，稳定版只支持2015年12月21日之前发布的系统</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#前期准备，安装相应的软件</span><br>yum -y install gcc pcre-devel openssl-devel <span class="hljs-comment">#centos</span><br>apt-get install -y iproute2 ntpdate tcpdump telnet traceroute nfs-kernel-server nfs-common lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev ntpdate tcpdump telnet traceroute gcc openssh-server lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev ntpdate tcpdump telnet traceroute iotop unzip zip <span class="hljs-comment">#ubuntu</span><br>useradd -r nginx<br><br><span class="hljs-comment">#编译tengine</span><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br>wget http://tengine.taobao.org/download/tengine-2.1.2.tar.gz<br>tar xf tengine-2.1.2.tar.gz<br><span class="hljs-built_in">cd</span> tengine-2.1.2/<br>./configure --prefix=/apps/tengine-2.1.2 --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre<br>make &amp;&amp; make install<br><br><span class="hljs-comment">#查看tengine文件目录</span><br>tree /apps/tengine-2.1.2/<br>/apps/tengine-2.1.2/<br>├── conf<br>│  ├── browsers<br>│  ├── fastcgi.conf<br>│  ├── fastcgi.conf.default<br>│  ├── fastcgi_params<br>│  ├── fastcgi_params.default<br>│  ├── koi-utf<br>│  ├── koi-win<br>│  ├── mime.types<br>│  ├── mime.types.default<br>│  ├── module_stubs<br>│  ├── nginx.conf<br>│  ├── nginx.conf.default<br>│  ├── scgi_params<br>│  ├── scgi_params.default<br>│  ├── uwsgi_params<br>│  ├── uwsgi_params.default<br>│  └── win-utf<br>├── html<br>│  ├── 50x.html<br>│  └── index.html<br>├── include<br>│  ├── nginx.h<br>│  ├── ngx_alloc.h<br>│  ├── ngx_array.h<br>│  ├── ngx_atomic.h<br>│  ├── ngx_auto_config.h<br>│  ├── ngx_auto_headers.h<br>│  ├── ngx_buf.h<br>│  ├── ngx_channel.h<br>│  ├── ngx_conf_file.h<br>│  ├── ngx_config.h<br>│  ├── ngx_connection.h<br>│  ├── ngx_core.h<br>│  ├── ngx_crc32.h<br>│  ├── ngx_crc.h<br>│  ├── ngx_crypt.h<br>│  ├── ngx_cycle.h<br>│  ├── ngx_errno.h<br>│  ├── ngx_event_busy_lock.h<br>│  ├── ngx_event_connect.h<br>│  ├── ngx_event.h<br>│  ├── ngx_event_openssl.h<br>│  ├── ngx_event_pipe.h<br>│  ├── ngx_event_posted.h<br>│  ├── ngx_event_timer.h<br>│  ├── ngx_file.h<br>│  ├── ngx_files.h<br>│  ├── ngx_gcc_atomic_x86.h<br>│  ├── ngx_hash.h<br>│  ├── ngx_http_busy_lock.h<br>│  ├── ngx_http_cache.h<br>│  ├── ngx_http_config.h<br>│  ├── ngx_http_core_module.h<br>│  ├── ngx_http.h<br>│  ├── ngx_http_reqstat.h<br>│  ├── ngx_http_request.h<br>│  ├── ngx_http_script.h<br>│  ├── ngx_http_ssi_filter_module.h<br>│  ├── ngx_http_ssl_module.h<br>│  ├── ngx_http_upstream.h<br>│  ├── ngx_http_upstream_round_robin.h<br>│  ├── ngx_http_v2.h<br>│  ├── ngx_http_v2_module.h<br>│  ├── ngx_http_variables.h<br>│  ├── ngx_inet.h<br>│  ├── ngx_linux_config.h<br>│  ├── ngx_linux.h<br>│  ├── ngx_list.h<br>│  ├── ngx_log.h<br>│  ├── ngx_md5.h<br>│  ├── ngx_murmurhash.h<br>│  ├── ngx_open_file_cache.h<br>│  ├── ngx_os.h<br>│  ├── ngx_palloc.h<br>│  ├── ngx_parse.h<br>│  ├── ngx_pipe.h<br>│  ├── ngx_process_cycle.h<br>│  ├── ngx_process.h<br>│  ├── ngx_proc.h<br>│  ├── ngx_proxy_protocol.h<br>│  ├── ngx_queue.h<br>│  ├── ngx_radix_tree.h<br>│  ├── ngx_rbtree.h<br>│  ├── ngx_regex.h<br>│  ├── ngx_resolver.h<br>│  ├── ngx_segment_tree.h<br>│  ├── ngx_setaffinity.h<br>│  ├── ngx_setproctitle.h<br>│  ├── ngx_sha1.h<br>│  ├── ngx_shmem.h<br>│  ├── ngx_shmtx.h<br>│  ├── ngx_slab.h<br>│  ├── ngx_socket.h<br>│  ├── ngx_string.h<br>│  ├── ngx_sysinfo.h<br>│  ├── ngx_syslog.h<br>│  ├── ngx_thread.h<br>│  ├── ngx_time.h<br>│  ├── ngx_times.h<br>│  ├── ngx_trie.h<br>│  └── ngx_user.h<br>├── logs<br>├── modules<br>└── sbin<br> ├── dso_tool<br> └── nginx<br>6 directories, 101 files<br><br><span class="hljs-comment">#建立tengine软连接</span><br>ln -s /apps/tengine-2.1.2/sbin/* /usr/sbin/<br>nginx -v<br>Tengine version: Tengine/2.1.2 (nginx/1.6.2)<br><br><span class="hljs-comment">#开启tengine</span><br>nginx<br><br><span class="hljs-comment">#查看端口号</span><br>ss -tnl<br>State   Recv-Q Send-Q  Local Address:Port Peer Address:Port       <br>LISTEN   0    128         *:80        *:*         <br>LISTEN   0    128         *:22        *:*         <br>LISTEN   0    100      127.0.0.1:25        *:*         <br>LISTEN   0    128        [::]:22      [::]:*         <br>LISTEN   0    100       [::1]:25      [::]:* <br><br><span class="hljs-comment">#测试tengine</span><br>curl 10.0.0.104<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;Welcome to tengine!&lt;/title&gt;<br>&lt;style&gt;<br>    body &#123;<br>        width: 35em;<br>        margin: 0 auto;<br>        font-family: Tahoma, Verdana, Arial, sans-serif;<br>    &#125;<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to tengine!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the tengine web server is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">&quot;http://tengine.taobao.org/&quot;</span>&gt;tengine.taobao.org&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using tengine.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br>curl -I 10.0.0.201<br>HTTP/1.1 200 OK<br>Server: Tengine/2.1.2<br>Date: Wed, 24 Feb 2021 14:22:31 GMT<br>Content-Type: text/html<br>Content-Length: 555<br>Last-Modified: Wed, 24 Feb 2021 14:17:12 GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;60365fe8-22b&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure><h5 id="5-1-2-2-在tengine-2-1-2中添加-lua-动态模块"><a href="#5-1-2-2-在tengine-2-1-2中添加-lua-动态模块" class="headerlink" title="5.1.2.2 在tengine-2.1.2中添加 lua 动态模块"></a>5.1.2.2 在tengine-2.1.2中添加 lua 动态模块</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#基于上一小节继续以下操作</span><br><span class="hljs-comment">#安装lua模块</span><br>yum -y install lua-devel<br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/tengine-2.1.2<br><br><span class="hljs-comment">#查看帮助</span><br>./configure --<span class="hljs-built_in">help</span> |grep http_lua<br> --with-http_lua_module             <span class="hljs-built_in">enable</span> ngx_http_lua_module (will also <span class="hljs-built_in">enable</span> --with-md5 and --with-sha1)<br>  --with-http_lua_module=shared      <span class="hljs-built_in">enable</span> ngx_http_lua_module (shared) (will also <span class="hljs-built_in">enable</span> --with-md5 and --with-sha1)<br><br><span class="hljs-comment">#重新编译</span><br>./configure --prefix=/apps/tengine-2.1.2 --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-http_lua_module=shared<br><br>make dso_install<br><br><span class="hljs-comment">#查看重新编译的的文件</span><br>tree /apps/tengine-2.1.2/modules/<br>/apps/tengine-2.1.2/modules/<br>└── ngx_http_lua_module.so<br><br>0 directories, 1 file<br><br><span class="hljs-comment">#修改配置文件，是tnegine能加载lua模块</span><br>vim /apps/tengine-2.1.2/conf/nginx.conf<br>......<br>events &#123;<br> worker_connections  1024;<br>&#125;<br><span class="hljs-comment"># load modules compiled as Dynamic Shared Object (DSO)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#dso &#123;</span><br><span class="hljs-comment">#  load ngx_http_fastcgi_module.so;</span><br><span class="hljs-comment">#  load ngx_http_rewrite_module.so;</span><br><span class="hljs-comment">#&#125;</span><br>dso &#123;              <br>     load ngx_http_lua_module.so;<br>&#125;<br>http &#123;<br>......<br>nginx -t<br>the configuration file /apps/tengine-2.1.2/conf/nginx.conf syntax is ok<br>configuration file /apps/tengine-2.1.2/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br><br>nginx -V |&amp; grep share<br> ngx_http_lua_module (shared, 3.1)<br></code></pre></td></tr></table></figure><h5 id="5-1-2-3-编译安装-tengine-2-3-2"><a href="#5-1-2-3-编译安装-tengine-2-3-2" class="headerlink" title="5.1.2.3 编译安装 tengine-2.3.2"></a>5.1.2.3 编译安装 tengine-2.3.2</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装相应的编译工具</span><br>yum -y install gcc pcre-devel openssl-devel <span class="hljs-comment">#centos</span><br><br><span class="hljs-comment">#申请账号</span><br>useradd -r -s /sbin/nologin nginx     <span class="hljs-comment">#centos</span><br>useradd -m -r -s /sbin/nologin nginx  <span class="hljs-comment">#ubuntu</span><br><br><span class="hljs-comment">#编译tengine</span><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br>wget http://tengine.taobao.org/download/tengine-2.3.2.tar.gz<br>tar xvf tengine-2.3.2.tar.gz<br><span class="hljs-built_in">cd</span> tengine-2.3.2/<br>./configure --prefix=/apps/tengine-2.3.2 --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module<br>make &amp;&amp; make install<br><br><span class="hljs-comment">#查看tengine文件</span><br>tree /apps/tengine-2.3.2/<br>/apps/tengine-2.3.2/<br>├── conf<br>│  ├── fastcgi.conf<br>│  ├── fastcgi.conf.default<br>│  ├── fastcgi_params<br>│  ├── fastcgi_params.default<br>│  ├── koi-utf<br>│  ├── koi-win<br>│  ├── mime.types<br>│  ├── mime.types.default<br>│  ├── nginx.conf<br>│  ├── nginx.conf.default<br>│  ├── scgi_params<br>│  ├── scgi_params.default<br>│  ├── uwsgi_params<br>│  ├── uwsgi_params.default<br>│  └── win-utf<br>├── html<br>│  ├── 50x.html<br>│  └── index.html<br>├── logs<br>└── sbin<br> └── nginx<br>4 directories, 18 files<br><br><span class="hljs-comment">#创建软连接，方便启动</span><br>ln -s /apps/tengine-2.3.2/sbin/* /usr/sbin/<br><br><span class="hljs-comment">#查看tengine版本</span><br>nginx -v<br>Tengine version: Tengine/2.3.2<br>nginx version: nginx/1.17.3<br><br><span class="hljs-comment">#开启tengine</span><br>nginx<br><br><span class="hljs-comment">#查看端口</span><br>ss -ntl<br>State         Recv-Q         Send-Q                  Local Address:Port                    Peer Address:Port         <br>LISTEN        0              128                           0.0.0.0:111                          0.0.0.0:*            <br>LISTEN        0              511                           0.0.0.0:80                           0.0.0.0:*            <br>LISTEN        0              128                     127.0.0.53%lo:53                           0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:22                           0.0.0.0:*            <br>LISTEN        0              64                            0.0.0.0:30808                        0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:48728                        0.0.0.0:*            <br>LISTEN        0              64                            0.0.0.0:2049                         0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:26632                        0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:14856                        0.0.0.0:*            <br>LISTEN        0              128                              [::]:45614                           [::]:*            <br>LISTEN        0              128                              [::]:111                             [::]:*            <br>LISTEN        0              128                              [::]:22                              [::]:*            <br>LISTEN        0              128                              [::]:58138                           [::]:*            <br>LISTEN        0              64                               [::]:2049                            [::]:*            <br>LISTEN        0              64                               [::]:21962                           [::]:*            <br>LISTEN        0              128                              [::]:19500                           [::]:*    <br><br>curl 10.0.0.104<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;Welcome to tengine!&lt;/title&gt;<br>&lt;style&gt;<br>    body &#123;<br>        width: 35em;<br>        margin: 0 auto;<br>        font-family: Tahoma, Verdana, Arial, sans-serif;<br>    &#125;<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to tengine!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the tengine web server is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">&quot;http://tengine.taobao.org/&quot;</span>&gt;tengine.taobao.org&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using tengine.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h4 id="5-1-3-concat-模块使用"><a href="#5-1-3-concat-模块使用" class="headerlink" title="5.1.3 concat 模块使用"></a>5.1.3 concat 模块使用</h4><h5 id="5-1-3-1-concat模块说明"><a href="#5-1-3-1-concat模块说明" class="headerlink" title="5.1.3.1 concat模块说明"></a>5.1.3.1 concat模块说明</h5><p>网站中的css、js等文件都是小文件，单个文件大小几k甚至几十个字节，所以文件的特点是小而多，会造成网站加载时http请求较多，且网络传输时间比较短，甚至有时候请求时间比传输时间还长，当公司网站中的这类小文件很多时，大量的http请求就会造成传输效率低，影响网站的访问速度和客户端体验，这时合并http请求就非常有必要了，concat模块就提供了合并文件http请求的功能，这个模块由淘宝开发，功能和apache的mod_concat模块类似</p><p>模块说明</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>tengine.taobao.org<span class="hljs-regexp">/document_cn/</span>http_concat_cn.html<br></code></pre></td></tr></table></figure><p>访问方式</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">请求参数需要用两个问号（<span class="hljs-string">&#x27;??&#x27;</span>）例如：<br>http:<span class="hljs-regexp">//</span>example.com<span class="hljs-regexp">/??style1.css,style2.css,foo/</span>style3.css<br><br>参数中某位置只包含一个‘?’，则<span class="hljs-string">&#x27;?&#x27;</span>后表示文件的版本，例如：<br>http:<span class="hljs-regexp">//</span>example.com<span class="hljs-regexp">/??style1.css,style2.css,foo/</span>style3.css?v=<span class="hljs-number">102234</span><br></code></pre></td></tr></table></figure><h5 id="5-1-3-2-编译安装-concat-模块"><a href="#5-1-3-2-编译安装-concat-模块" class="headerlink" title="5.1.3.2 编译安装 concat 模块"></a>5.1.3.2 编译安装 concat 模块</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#基于上一小节继续以下操作</span><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/tengine-2.1.2<br><br><span class="hljs-comment">#tengine-2.1.2有此模块</span><br>./configure --<span class="hljs-built_in">help</span> |grep http_concat<br> --with-http_concat_module     <span class="hljs-built_in">enable</span> ngx_http_concat_module<br> --with-http_concat_module=shared  <span class="hljs-built_in">enable</span> ngx_http_concat_module (shared)<br> <br><span class="hljs-comment">#tengine-2.3.2无此模块</span><br>./configure --<span class="hljs-built_in">help</span> |grep http_concat<br> <br>./configure --prefix=/apps/tengine-2.1.2 --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-http_lua_module=shared --with-http_concat_module=shared<br><br>make dso_install<br> <br>tree /apps/tengine-2.1.2/modules/<br>/apps/tengine-2.1.2/modules/<br>├── ngx_http_concat_module.so<br>└── ngx_http_lua_module.so<br><br>0 directories, 2 files<br><br><span class="hljs-comment">#通过动态模块实现concat功能：</span><br>vim /apps/tengine-2.1.2/conf/nginx.conf<br>dso &#123;<br> load ngx_http_lua_module.so;<br> load ngx_http_concat_module.so;<br>&#125;<br><br>nginx -t<br>the configuration file /apps/tengine-2.1.2/conf/nginx.conf syntax is ok<br>configuration file /apps/tengine-2.1.2/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>nginx -s reload<br>nginx -V 2&gt;&amp;1| grep share<br> ngx_http_concat_module (shared, 3.1)<br> ngx_http_lua_module (shared, 3.1)<br> <br> <span class="hljs-comment">#通过重新编译tengine实现concat功能：</span><br>./configure ... --with-http_concat_module<br></code></pre></td></tr></table></figure><h4 id="5-1-4-tengine配置文件"><a href="#5-1-4-tengine配置文件" class="headerlink" title="5.1.4 tengine配置文件"></a>5.1.4 tengine配置文件</h4><p>tengine兼容Nginx指定版本的配置参数</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/tenginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpe.net <span class="hljs-regexp">*.www.rlinpe.net</span> pc.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">concat</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">root</span> html;<br>        <span class="hljs-attribute">index</span> index.html index.htm;<br>    &#125;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/php;<br>        <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">10.0.0.18:9000</span>;<br>        <span class="hljs-attribute">fastcgi_index</span> index.php;<br>        <span class="hljs-comment">#fastcgi_param SCRIPT_FILENAME /data/nginx/php$fastcgi_script_name;</span><br>        <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME $document_root$fastcgi_script_name;<br>        <span class="hljs-attribute">include</span> fastcgi_params;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-2-openresty"><a href="#5-2-openresty" class="headerlink" title="5.2 openresty"></a>5.2 openresty</h3><h4 id="5-2-1-openresty-介绍"><a href="#5-2-1-openresty-介绍" class="headerlink" title="5.2.1 openresty 介绍"></a>5.2.1 openresty 介绍</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-openresty.jpg"></p><p>Nginx 是俄罗斯人发明的， Lua 是巴西几个教授发明的，中国人章亦春把 LuaJIT VM 嵌入到 Nginx<br>中，实现了 OpenResty 这个高性能服务端解决方案</p><p>OpenResty® 是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web服务和动态网关。</p><p>OpenResty® 通过汇聚各种设计精良的 Nginx 模块（主要由 OpenResty 团队自主开发），从而将<br>Nginx 有效地变成一个强大的通用 Web 应用平台。这样，Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 10K 乃至 1000K 以上单机并发连接的高性能 Web 应用系统。</p><p>OpenResty® 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及Redis 等都进行一致的高性能响应。</p><p>官网: <a href="http://openresty.org/cn/">http://openresty.org/cn/</a></p><h4 id="5-2-2-编译安装-openresty"><a href="#5-2-2-编译安装-openresty" class="headerlink" title="5.2.2 编译安装 openresty"></a>5.2.2 编译安装 openresty</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装必要的编译软件</span><br>yum install -y gcc pcre-devel openssl-devel <span class="hljs-comment">#centos</span><br><br><span class="hljs-comment">#创建用户并下载文件</span><br>useradd -r -s /sbin/nologin nginx <span class="hljs-comment">#centos</span><br>useradd  -m -r -s /sbin/nologin nginx <span class="hljs-comment">#ubuntu</span><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br>wget https://openresty.org/download/openresty-1.17.8.2.tar.gz<br>tar xf openresty-1.17.8.2.tar.gz<br><span class="hljs-built_in">cd</span> openresty-1.17.8.2/<br>yum -y install make <span class="hljs-comment">#centos</span><br>apt -y install make <span class="hljs-comment"># ubuntu</span><br>./configure --prefix=/apps/openresty --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module<br>make &amp;&amp; make install<br><br><span class="hljs-comment">#查看安装之后的文件</span><br>tree /apps/openresty/<br>./apps/openresty/<br>├── bin<br>│  ├── md2pod.pl<br>│  ├── nginx-xml2pod<br>│  ├── openresty -&gt; /apps/openresty/nginx/sbin/nginx<br>│  ├── opm<br>│  ├── resty<br>│  ├── restydoc<br>│  └── restydoc-index<br>├── COPYRIGHT<br>├── luajit<br>│  ├── bin<br>│  │  ├── luajit -&gt; luajit-2.1.0-beta3<br>│  │  └── luajit-2.1.0-beta3<br>│  ├── include<br>│  │  └── luajit-2.1<br>│  │    ├── lauxlib.h<br>│  │    ├── luaconf.h<br>│  │    ├── lua.h<br>│  │    ├── lua.hpp<br>│  │    ├── luajit.h<br>│  │    └── lualib.h<br>│  ├── lib<br>│  │  ├── libluajit-5.1.a<br>│  │  ├── libluajit-5.1.so -&gt; libluajit-5.1.so.2.1.0<br>│  │  ├── libluajit-5.1.so.2 -&gt; libluajit-5.1.so.2.1.0<br>│  │  ├── libluajit-5.1.so.2.1.0<br>│  │  ├── lua<br>│  │  │  └── 5.1<br>│  │  └── pkgconfig<br>│  │    └── luajit.pc<br>│  └── share<br>│    ├── lua<br>│    │  └── 5.1<br>│    ├── luajit-2.1.0-beta3<br>│    │  └── jit<br>│    │    ├── bc.lua<br>│    │    ├── bcsave.lua<br>│    │    ├── dis_arm64be.lua<br>│    │    ├── dis_arm64.lua<br>│    │    ├── dis_arm.lua<br>│    │    ├── dis_mips64el.lua<br>│    │    ├── dis_mips64.lua<br>│    │    ├── dis_mipsel.lua<br>│    │    ├── dis_mips.lua<br>│    │    ├── dis_ppc.lua<br>│    │    ├── dis_x64.lua<br>│    │    ├── dis_x86.lua<br>│    │    ├── dump.lua<br>│    │    ├── p.lua<br>│    │    ├── v.lua<br>│    │    ├── vmdef.lua<br>│    │    └── zone.lua<br>│    └── man<br>│      └── man1<br>│        └── luajit.1<br>├── lualib<br>│  ├── cjson.so<br>│  ├── librestysignal.so<br>│  ├── ngx<br>│  │  ├── balancer.lua<br>│  │  ├── base64.lua<br>│  │  ├── errlog.lua<br>│  │  ├── ocsp.lua<br>│  │  ├── pipe.lua<br>│  │  ├── process.lua<br>│  │  ├── re.lua<br>│  │  ├── req.lua<br>│  │  ├── resp.lua<br>│  │  ├── semaphore.lua<br>│  │  ├── ssl<br>│  │  │  └── session.lua<br>│  │  └── ssl.lua<br>│  ├── rds<br>│  │  └── parser.so<br>│  ├── redis<br>│  │  └── parser.so<br>│  ├── resty<br>│  │  ├── aes.lua<br>│  │  ├── core<br>│  │  │  ├── base64.lua<br>│  │  │  ├── base.lua<br>│  │  │  ├── ctx.lua<br>│  │  │  ├── exit.lua<br>│  │  │  ├── hash.lua<br>│  │  │  ├── misc.lua<br>│  │  │  ├── ndk.lua<br>│  │  │  ├── phase.lua<br>│  │  │  ├── regex.lua<br>│  │  │  ├── request.lua<br>│  │  │  ├── response.lua<br>│  │  │  ├── shdict.lua<br>│  │  │  ├── time.lua<br>│  │  │  ├── uri.lua<br>│  │  │  ├── utils.lua<br>│  │  │  ├── var.lua<br>│  │  │  └── worker.lua<br>│  │  ├── core.lua<br>│  │  ├── dns<br>│  │  │  └── resolver.lua<br>│  │  ├── <span class="hljs-built_in">limit</span><br>│  │  │  ├── conn.lua<br>│  │  │  ├── count.lua<br>│  │  │  ├── req.lua<br>│  │  │  └── traffic.lua<br>│  │  ├── lock.lua<br>│  │  ├── lrucache<br>│  │  │  └── pureffi.lua<br>│  │  ├── lrucache.lua<br>│  │  ├── md5.lua<br>│  │  ├── memcached.lua<br>│  │  ├── mysql.lua<br>│  │  ├── random.lua<br>│  │  ├── redis.lua<br>│  │  ├── sha1.lua<br>│  │  ├── sha224.lua<br>│  │  ├── sha256.lua<br>│  │  ├── sha384.lua<br>│  │  ├── sha512.lua<br>│  │  ├── sha.lua<br>│  │  ├── shell.lua<br>│  │  ├── signal.lua<br>│  │  ├── string.lua<br>│  │  ├── upload.lua<br>│  │  ├── upstream<br>│  │  │  └── healthcheck.lua<br>│  │  └── websocket<br>│  │    ├── client.lua<br>│  │    ├── protocol.lua<br>│  │    └── server.lua<br>│  └── tablepool.lua<br>├── nginx<br>│  ├── conf<br>│  │  ├── fastcgi.conf<br>│  │  ├── fastcgi.conf.default<br>│  │  ├── fastcgi_params<br>│  │  ├── fastcgi_params.default<br>│  │  ├── koi-utf<br>│  │  ├── koi-win<br>│  │  ├── mime.types<br>│  │  ├── mime.types.default<br>│  │  ├── nginx.conf<br>│  │  ├── nginx.conf.default<br>│  │  ├── scgi_params<br>│  │  ├── scgi_params.default<br>│  │  ├── uwsgi_params<br>│  │  ├── uwsgi_params.default<br>│  │  └── win-utf<br>│  ├── html<br>│  │  ├── 50x.html<br>│  │  └── index.html<br>│  ├── logs<br>│  └── sbin<br>│    └── nginx<br>├── pod<br>│  ├── array-var-nginx-module-0.05<br>│  │  └── array-var-nginx-module-0.05.pod<br>│  ├── drizzle-nginx-module-0.1.11<br>│  │  └── drizzle-nginx-module-0.1.11.pod<br>│  ├── echo-nginx-module-0.62<br>│  │  └── echo-nginx-module-0.62.pod<br>│  ├── encrypted-session-nginx-module-0.08<br>│  │  └── encrypted-session-nginx-module-0.08.pod<br>│  ├── form-input-nginx-module-0.12<br>│  │  └── form-input-nginx-module-0.12.pod<br>│  ├── headers-more-nginx-module-0.33<br>│  │  └── headers-more-nginx-module-0.33.pod<br>│  ├── iconv-nginx-module-0.14<br>│  │  └── iconv-nginx-module-0.14.pod<br>│  ├── lua-5.1.5<br>│  │  └── lua-5.1.5.pod<br>│  ├── lua-cjson-2.1.0.8<br>│  │  └── lua-cjson-2.1.0.8.pod<br>│  ├── luajit-2.1<br>│  │  ├── changes.pod<br>│  │  ├── contact.pod<br>│  │  ├── ext_c_api.pod<br>│  │  ├── extensions.pod<br>│  │  ├── ext_ffi_api.pod<br>│  │  ├── ext_ffi.pod<br>│  │  ├── ext_ffi_semantics.pod<br>│  │  ├── ext_ffi_tutorial.pod<br>│  │  ├── ext_jit.pod<br>│  │  ├── ext_profiler.pod<br>│  │  ├── faq.pod<br>│  │  ├── install.pod<br>│  │  ├── luajit-2.1.pod<br>│  │  ├── running.pod<br>│  │  └── status.pod<br>│  ├── luajit-2.1-20200102<br>│  │  └── luajit-2.1-20200102.pod<br>│  ├── lua-rds-parser-0.06<br>│  ├── lua-redis-parser-0.13<br>│  │  └── lua-redis-parser-0.13.pod<br>│  ├── lua-resty-core-0.1.19<br>│  │  ├── lua-resty-core-0.1.19.pod<br>│  │  ├── ngx.balancer.pod<br>│  │  ├── ngx.base64.pod<br>│  │  ├── ngx.errlog.pod<br>│  │  ├── ngx.ocsp.pod<br>│  │  ├── ngx.pipe.pod<br>│  │  ├── ngx.process.pod<br>│  │  ├── ngx.re.pod<br>│  │  ├── ngx.req.pod<br>│  │  ├── ngx.resp.pod<br>│  │  ├── ngx.semaphore.pod<br>│  │  ├── ngx.ssl.pod<br>│  │  └── ngx.ssl.session.pod<br>│  ├── lua-resty-dns-0.21<br>│  │  └── lua-resty-dns-0.21.pod<br>│  ├── lua-resty-limit-traffic-0.07<br>│  │  ├── lua-resty-limit-traffic-0.07.pod<br>│  │  ├── resty.limit.conn.pod<br>│  │  ├── resty.limit.count.pod<br>│  │  ├── resty.limit.req.pod<br>│  │  └── resty.limit.traffic.pod<br>│  ├── lua-resty-lock-0.08<br>│  │  └── lua-resty-lock-0.08.pod<br>│  ├── lua-resty-lrucache-0.10<br>│  │  └── lua-resty-lrucache-0.10.pod<br>│  ├── lua-resty-memcached-0.15<br>│  │  └── lua-resty-memcached-0.15.pod<br>│  ├── lua-resty-mysql-0.21<br>│  │  └── lua-resty-mysql-0.21.pod<br>│  ├── lua-resty-redis-0.28<br>│  │  └── lua-resty-redis-0.28.pod<br>│  ├── lua-resty-shell-0.03<br>│  │  └── lua-resty-shell-0.03.pod<br>│  ├── lua-resty-signal-0.02<br>│  │  └── lua-resty-signal-0.02.pod<br>│  ├── lua-resty-string-0.12<br>│  │  └── lua-resty-string-0.12.pod<br>│  ├── lua-resty-upload-0.10<br>│  │  └── lua-resty-upload-0.10.pod<br>│  ├── lua-resty-upstream-healthcheck-0.06<br>│  │  └── lua-resty-upstream-healthcheck-0.06.pod<br>│  ├── lua-resty-websocket-0.07<br>│  │  └── lua-resty-websocket-0.07.pod<br>│  ├── lua-tablepool-0.01<br>│  │  └── lua-tablepool-0.01.pod<br>│  ├── memc-nginx-module-0.19<br>│  │  └── memc-nginx-module-0.19.pod<br>│  ├── nginx<br>│  │  ├── accept_failed.pod<br>│  │  ├── beginners_guide.pod<br>│  │  ├── chunked_encoding_from_backend.pod<br>│  │  ├── configure.pod<br>│  │  ├── configuring_https_servers.pod<br>│  │  ├── contributing_changes.pod<br>│  │  ├── control.pod<br>│  │  ├── converting_rewrite_rules.pod<br>│  │  ├── daemon_master_process_off.pod<br>│  │  ├── debugging_log.pod<br>│  │  ├── development_guide.pod<br>│  │  ├── events.pod<br>│  │  ├── example.pod<br>│  │  ├── faq.pod<br>│  │  ├── freebsd_tuning.pod<br>│  │  ├── hash.pod<br>│  │  ├── howto_build_on_win32.pod<br>│  │  ├── install.pod<br>│  │  ├── license_copyright.pod<br>│  │  ├── load_balancing.pod<br>│  │  ├── nginx_dtrace_pid_provider.pod<br>│  │  ├── nginx.pod<br>│  │  ├── ngx_core_module.pod<br>│  │  ├── ngx_google_perftools_module.pod<br>│  │  ├── ngx_http_access_module.pod<br>│  │  ├── ngx_http_addition_module.pod<br>│  │  ├── ngx_http_api_module_head.pod<br>│  │  ├── ngx_http_auth_basic_module.pod<br>│  │  ├── ngx_http_auth_jwt_module.pod<br>│  │  ├── ngx_http_auth_request_module.pod<br>│  │  ├── ngx_http_autoindex_module.pod<br>│  │  ├── ngx_http_browser_module.pod<br>│  │  ├── ngx_http_charset_module.pod<br>│  │  ├── ngx_http_core_module.pod<br>│  │  ├── ngx_http_dav_module.pod<br>│  │  ├── ngx_http_empty_gif_module.pod<br>│  │  ├── ngx_http_f4f_module.pod<br>│  │  ├── ngx_http_fastcgi_module.pod<br>│  │  ├── ngx_http_flv_module.pod<br>│  │  ├── ngx_http_geoip_module.pod<br>│  │  ├── ngx_http_geo_module.pod<br>│  │  ├── ngx_http_grpc_module.pod<br>│  │  ├── ngx_http_gunzip_module.pod<br>│  │  ├── ngx_http_gzip_module.pod<br>│  │  ├── ngx_http_gzip_static_module.pod<br>│  │  ├── ngx_http_headers_module.pod<br>│  │  ├── ngx_http_hls_module.pod<br>│  │  ├── ngx_http_image_filter_module.pod<br>│  │  ├── ngx_http_index_module.pod<br>│  │  ├── ngx_http_js_module.pod<br>│  │  ├── ngx_http_keyval_module.pod<br>│  │  ├── ngx_http_limit_conn_module.pod<br>│  │  ├── ngx_http_limit_req_module.pod<br>│  │  ├── ngx_http_log_module.pod<br>│  │  ├── ngx_http_map_module.pod<br>│  │  ├── ngx_http_memcached_module.pod<br>│  │  ├── ngx_http_mirror_module.pod<br>│  │  ├── ngx_http_mp4_module.pod<br>│  │  ├── ngx_http_perl_module.pod<br>│  │  ├── ngx_http_proxy_module.pod<br>│  │  ├── ngx_http_random_index_module.pod<br>│  │  ├── ngx_http_realip_module.pod<br>│  │  ├── ngx_http_referer_module.pod<br>│  │  ├── ngx_http_rewrite_module.pod<br>│  │  ├── ngx_http_scgi_module.pod<br>│  │  ├── ngx_http_secure_link_module.pod<br>│  │  ├── ngx_http_session_log_module.pod<br>│  │  ├── ngx_http_slice_module.pod<br>│  │  ├── ngx_http_spdy_module.pod<br>│  │  ├── ngx_http_split_clients_module.pod<br>│  │  ├── ngx_http_ssi_module.pod<br>│  │  ├── ngx_http_ssl_module.pod<br>│  │  ├── ngx_http_status_module.pod<br>│  │  ├── ngx_http_stub_status_module.pod<br>│  │  ├── ngx_http_sub_module.pod<br>│  │  ├── ngx_http_upstream_conf_module.pod<br>│  │  ├── ngx_http_upstream_hc_module.pod<br>│  │  ├── ngx_http_upstream_module.pod<br>│  │  ├── ngx_http_userid_module.pod<br>│  │  ├── ngx_http_uwsgi_module.pod<br>│  │  ├── ngx_http_v2_module.pod<br>│  │  ├── ngx_http_xslt_module.pod<br>│  │  ├── ngx_mail_auth_http_module.pod<br>│  │  ├── ngx_mail_core_module.pod<br>│  │  ├── ngx_mail_imap_module.pod<br>│  │  ├── ngx_mail_pop3_module.pod<br>│  │  ├── ngx_mail_proxy_module.pod<br>│  │  ├── ngx_mail_smtp_module.pod<br>│  │  ├── ngx_mail_ssl_module.pod<br>│  │  ├── ngx_stream_access_module.pod<br>│  │  ├── ngx_stream_core_module.pod<br>│  │  ├── ngx_stream_geoip_module.pod<br>│  │  ├── ngx_stream_geo_module.pod<br>│  │  ├── ngx_stream_js_module.pod<br>│  │  ├── ngx_stream_keyval_module.pod<br>│  │  ├── ngx_stream_limit_conn_module.pod<br>│  │  ├── ngx_stream_log_module.pod<br>│  │  ├── ngx_stream_map_module.pod<br>│  │  ├── ngx_stream_proxy_module.pod<br>│  │  ├── ngx_stream_realip_module.pod<br>│  │  ├── ngx_stream_return_module.pod<br>│  │  ├── ngx_stream_split_clients_module.pod<br>│  │  ├── ngx_stream_ssl_module.pod<br>│  │  ├── ngx_stream_ssl_preread_module.pod<br>│  │  ├── ngx_stream_upstream_hc_module.pod<br>│  │  ├── ngx_stream_upstream_module.pod<br>│  │  ├── ngx_stream_zone_sync_module.pod<br>│  │  ├── request_processing.pod<br>│  │  ├── server_names.pod<br>│  │  ├── stream_processing.pod<br>│  │  ├── switches.pod<br>│  │  ├── syntax.pod<br>│  │  ├── sys_errlist.pod<br>│  │  ├── syslog.pod<br>│  │  ├── variables_in_config.pod<br>│  │  ├── websocket.pod<br>│  │  ├── welcome_nginx_facebook.pod<br>│  │  └── windows.pod<br>│  ├── ngx_coolkit-0.2<br>│  ├── ngx_devel_kit-0.3.1<br>│  │  ├── ngx_devel_kit-0.3.1.pod<br>│  │  └── readme_auto_lib.pod<br>│  ├── ngx_lua-0.10.17<br>│  │  └── ngx_lua-0.10.17.pod<br>│  ├── ngx_lua_upstream-0.07<br>│  │  └── ngx_lua_upstream-0.07.pod<br>│  ├── ngx_postgres-1.0<br>│  │  ├── ngx_postgres-1.0.pod<br>│  │  └── todo.pod<br>│  ├── ngx_stream_lua-0.0.8<br>│  │  ├── dev_notes.pod<br>│  │  └── ngx_stream_lua-0.0.8.pod<br>│  ├── opm-0.0.5<br>│  │  └── opm-0.0.5.pod<br>│  ├── rds-csv-nginx-module-0.09<br>│  │  └── rds-csv-nginx-module-0.09.pod<br>│  ├── rds-json-nginx-module-0.15<br>│  │  └── rds-json-nginx-module-0.15.pod<br>│  ├── redis2-nginx-module-0.15<br>│  │  └── redis2-nginx-module-0.15.pod<br>│  ├── redis-nginx-module-0.3.7<br>│  ├── resty-cli-0.25<br>│  │  └── resty-cli-0.25.pod<br>│  ├── set-misc-nginx-module-0.32<br>│  │  └── set-misc-nginx-module-0.32.pod<br>│  ├── srcache-nginx-module-0.32<br>│  │  └── srcache-nginx-module-0.32.pod<br>│  └── xss-nginx-module-0.06<br>│    └── xss-nginx-module-0.06.pod<br>├── resty.index<br>└── site<br> ├── lualib<br> ├── manifest<br> └── pod<br>83 directories, 313 files<br><br>ln -s /apps/openresty/bin/* /usr/bin/<br>openresty -v<br>nginx version: openresty/1.17.8.2<br><br>openresty<br>ss -ntl<br>State         Recv-Q         Send-Q                  Local Address:Port                    Peer Address:Port         <br>LISTEN        0              128                           0.0.0.0:111                          0.0.0.0:*            <br>LISTEN        0              511                           0.0.0.0:80                           0.0.0.0:*            <br>LISTEN        0              128                     127.0.0.53%lo:53                           0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:22                           0.0.0.0:*            <br>LISTEN        0              64                            0.0.0.0:27932                        0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:46750                        0.0.0.0:*            <br>LISTEN        0              64                            0.0.0.0:2049                         0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:21442                        0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:61732                        0.0.0.0:*            <br>LISTEN        0              128                              [::]:111                             [::]:*            <br>LISTEN        0              128                              [::]:22                              [::]:*            <br>LISTEN        0              128                              [::]:17526                           [::]:*            <br>LISTEN        0              64                               [::]:20984                           [::]:*            <br>LISTEN        0              128                              [::]:33184                           [::]:*            <br>LISTEN        0              64                               [::]:2049                            [::]:*            <br>LISTEN        0              128                              [::]:53414                           [::]:* <br><br>ps -ef |grep nginx<br>root      17739      1  0 21:50 ?        00:00:00 nginx: master process openresty<br>nginx     17740  17739  0 21:50 ?        00:00:00 nginx: worker process<br>root      17747   1592  0 21:51 pts/0    00:00:00 grep --color=auto nginx<br><br>curl 10.0.0.18<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;Welcome to OpenResty!&lt;/title&gt;<br>&lt;style&gt;<br>    body &#123;<br>        width: 35em;<br>        margin: 0 auto;<br>        font-family: Tahoma, Verdana, Arial, sans-serif;<br>    &#125;<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to OpenResty!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the OpenResty web platform is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">&quot;https://openresty.org/&quot;</span>&gt;openresty.org&lt;/a&gt;.&lt;br/&gt;<br>Commercial support is available at<br>&lt;a href=<span class="hljs-string">&quot;https://openresty.com/&quot;</span>&gt;openresty.com&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> flying OpenResty.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-openresty2.jpg"></p><h2 id="六、系统参数优化"><a href="#六、系统参数优化" class="headerlink" title="六、系统参数优化"></a>六、系统参数优化</h2><p>默认的Linux内核参数考虑的是最通用场景，不符合用于支持高并发访问的Web服务器的定义，根据业务特点来进行调整，当Nginx作为静态web内容服务器、反向代理或者提供压缩服务器的服务器时，内核参数的调整都是不同的，此处针对最通用的、使Nginx支持更多并发请求的TCP网络参数做简单的配置</p><h3 id="6-1优化内核参数"><a href="#6-1优化内核参数" class="headerlink" title="6.1优化内核参数"></a>6.1优化内核参数</h3><p>修改/etc/sysctl.conf </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#centos优化</span><br>fs.file-max = 1000000<br><span class="hljs-comment">#表示单个进程较大可以打开的句柄数</span><br><br>net.ipv4.tcp_tw_reuse = 1<br><span class="hljs-comment">#参数设置为 1 ，表示允许将TIME_WAIT状态的socket重新用于新的TCP链接，这对于服务器来说意义重大，因为总有大量TIME_WAIT状态的链接存在</span><br><br>net.ipv4.tcp_keepalive_time = 600<br><span class="hljs-comment">#当keepalive启动时，TCP发送keepalive消息的频度;默认是2小时，将其设置为10分钟，可更快的清理无效链接</span><br><br>net.ipv4.tcp_fin_timeout = 30<br><span class="hljs-comment">#当服务器主动关闭链接时，socket保持在FIN_WAIT_2状态的较大时间</span><br><br>net.ipv4.tcp_max_tw_buckets = 5000<br><span class="hljs-comment">#表示操作系统允许TIME_WAIT套接字数量的较大值，如超过此值，TIME_WAIT套接字将立刻被清除并打印警告信息,默认为8000，过多的TIME_WAIT套接字会使Web服务器变慢</span><br><br>net.ipv4.ip_local_port_range = 1024 65000<br><span class="hljs-comment">#定义UDP和TCP链接的本地端口的取值范围</span><br><br>net.ipv4.tcp_rmem = 10240 87380 12582912<br><span class="hljs-comment">#定义了TCP接受缓存的最小值、默认值、较大值</span><br><br>net.ipv4.tcp_wmem = 10240 87380 12582912<br><span class="hljs-comment">#定义TCP发送缓存的最小值、默认值、较大值</span><br><br>net.core.netdev_max_backlog = 8096<br><span class="hljs-comment">#当网卡接收数据包的速度大于内核处理速度时，会有一个列队保存这些数据包。这个参数表示该列队的较大值</span><br><br>net.core.rmem_default = 6291456<br><span class="hljs-comment">#表示内核套接字接受缓存区默认大小</span><br><br>net.core.wmem_default = 6291456<br><span class="hljs-comment">#表示内核套接字发送缓存区默认大小</span><br><br>net.core.rmem_max = 12582912<br><span class="hljs-comment">#表示内核套接字接受缓存区较大大小</span><br><br>net.core.wmem_max = 12582912<br><span class="hljs-comment">#表示内核套接字发送缓存区较大大小</span><br>注意：以上的四个参数，需要根据业务逻辑和实际的硬件成本来综合考虑<br><br>net.ipv4.tcp_syncookies = 1<br><span class="hljs-comment">#与性能无关。用于解决TCP的SYN攻击</span><br><br>net.ipv4.tcp_max_syn_backlog = 8192<br><span class="hljs-comment">#这个参数表示TCP三次握手建立阶段接受SYN请求列队的较大长度，默认1024，将其设置的大一些可使出现Nginx繁忙来不及accept新连接时，Linux不至于丢失客户端发起的链接请求</span><br><br>net.ipv4.tcp_tw_recycle = 1<br><span class="hljs-comment">#这个参数用于设置启用timewait快速回收</span><br><br>net.core.somaxconn=262114<br><span class="hljs-comment">#选项默认值是128，这个参数用于调节系统同时发起的TCP连接数，在高并发的请求中，默认的值可能会导致链接超时或者重传，因此需要结合高并发请求数来调节此值。</span><br><br>net.ipv4.tcp_max_orphans=262114<br><span class="hljs-comment">#选项用于设定系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤立链接将立即被复位并输出警告信息。这个限制指示为了防止简单的DOS攻击，不用过分依靠这个限制甚至认为的减小这个值，更多的情况是增加这个值</span><br><br><span class="hljs-comment">#ubuntu优化</span><br>vim /etc/sysctl.conf<br><span class="hljs-comment"># Controls source route verification</span><br>net.ipv4.conf.default.rp_filter = 1<br>net.ipv4.ip_nonlocal_bind = 1<br>net.ipv4.ip_forward = 1<br><span class="hljs-comment"># Do not accept source routing</span><br>net.ipv4.conf.default.accept_source_route = 0<br><span class="hljs-comment"># Controls the System Request debugging functionality of the kernel</span><br>kernel.sysrq = 0<br><span class="hljs-comment"># Controls whether core dumps will append the PID to the core filename.</span><br><span class="hljs-comment"># Useful for debugging multi-threaded applications.</span><br>kernel.core_uses_pid = 1<br><span class="hljs-comment"># Controls the use of TCP syncookies</span><br>net.ipv4.tcp_syncookies = 1<br><span class="hljs-comment"># Disable netfilter on bridges.</span><br>net.bridge.bridge-nf-call-ip6tables = 0<br>net.bridge.bridge-nf-call-iptables = 0<br>net.bridge.bridge-nf-call-arptables = 0<br><span class="hljs-comment"># Controls the default maxmimum size of a mesage queue</span><br>kernel.msgmnb = 65536<br><span class="hljs-comment"># # Controls the maximum size of a message, in bytes</span><br>kernel.msgmax = 65536<br><span class="hljs-comment"># Controls the maximum shared segment size, in bytes</span><br>kernel.shmmax = 68719476736<br><span class="hljs-comment"># # Controls the maximum number of shared memory segments, in pages</span><br>kernel.shmall = 4294967296<br><span class="hljs-comment"># TCP kernel paramater</span><br>net.ipv4.tcp_mem = 786432 1048576 1572864<br>net.ipv4.tcp_rmem = 4096 87380 4194304<br>net.ipv4.tcp_wmem = 4096 16384 4194304<br>net.ipv4.tcp_window_scaling = 1<br>net.ipv4.tcp_sack = 1<br><span class="hljs-comment"># socket buffer</span><br>net.core.wmem_default = 8388608<br>net.core.rmem_default = 8388608<br>net.core.rmem_max = 16777216<br>net.core.wmem_max = 16777216<br>net.core.netdev_max_backlog = 262144<br>net.core.somaxconn = 20480<br>net.core.optmem_max = 81920<br><span class="hljs-comment"># TCP conn</span><br>net.ipv4.tcp_max_syn_backlog = 262144<br>net.ipv4.tcp_syn_retries = 3<br>net.ipv4.tcp_retries1 = 3<br>net.ipv4.tcp_retries2 = 15<br><span class="hljs-comment"># tcp conn reuse</span><br>net.ipv4.tcp_timestamps = 0<br>net.ipv4.tcp_tw_reuse = 0<br>net.ipv4.tcp_tw_recycle = 0<br>net.ipv4.tcp_fin_timeout = 1<br>net.ipv4.tcp_max_tw_buckets = 20000<br>net.ipv4.tcp_max_orphans = 3276800<br>net.ipv4.tcp_synack_retries = 1<br>net.ipv4.tcp_syncookies = 1<br><span class="hljs-comment"># keepalive conn</span><br>net.ipv4.tcp_keepalive_time = 300<br>net.ipv4.tcp_keepalive_intvl = 30<br>net.ipv4.tcp_keepalive_probes = 3<br>net.ipv4.ip_local_port_range = 10001 65000<br><span class="hljs-comment"># swap</span><br>vm.overcommit_memory = 0<br>vm.swappiness = 10<br><span class="hljs-comment">#net.ipv4.conf.eth1.rp_filter = 0</span><br><span class="hljs-comment">#net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="hljs-comment">#net.ipv4.conf.lo.arp_announce = 2</span><br><span class="hljs-comment">#net.ipv4.conf.all.arp_ignore = 1</span><br><span class="hljs-comment">#net.ipv4.conf.all.arp_announce = 2</span><br>root@ubuntu-1804-rlin:~<span class="hljs-comment"># apt update</span><br></code></pre></td></tr></table></figure><h3 id="6-2-PAM-资源限制优化"><a href="#6-2-PAM-资源限制优化" class="headerlink" title="6.2 PAM 资源限制优化"></a>6.2 PAM 资源限制优化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#centos</span><br>vim /etc/security/limits.conf<br>在/etc/security/limits.conf 最后增加：<br>* soft nofile 65535<br>* hard nofile 65535<br>* soft nproc 65535<br>* hard nproc 65535<br><br><span class="hljs-comment">#ubuntu</span><br>vim /etc/security/limits.conf<br><span class="hljs-comment">#root账⼾的资源软限制和硬限制</span><br>root soft core unlimited<br>root hard core unlimited<br>root soft nproc 1000000<br>root hard nproc 1000000<br>root soft nofile 1000000<br>root hard nofile 1000000<br>root soft memlock 32000<br>root hard memlock 32000<br>root soft msgqueue 8192000<br>root hard msgqueue 8192000<br><span class="hljs-comment">#其他账⼾的资源软限制和硬限制</span><br>* soft core unlimited<br>* hard core unlimited<br>* soft nproc 1000000<br>* hard nproc 1000000<br>* soft nofile 1000000<br>* hard nofile 1000000<br>* soft memlock 32000<br>* hard memlock 32000<br>* soft msgqueue 8192000<br>* hard msgqueue 8192000<br></code></pre></td></tr></table></figure><h2 id="七、项目实战-利用-LNMP-实现WordPress站点搭建"><a href="#七、项目实战-利用-LNMP-实现WordPress站点搭建" class="headerlink" title="七、项目实战 : 利用 LNMP 实现WordPress站点搭建"></a>七、项目实战 : 利用 LNMP 实现WordPress站点搭建</h2><h3 id="7-1-LNMP项目实战环境说明"><a href="#7-1-LNMP项目实战环境说明" class="headerlink" title="7.1 LNMP项目实战环境说明"></a>7.1 LNMP项目实战环境说明</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">L：Linux（CentOS7）https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/centos/</span><span class="hljs-number">7</span><span class="hljs-regexp">/isos/</span>x86_64/<br>N：Nginx（<span class="hljs-number">1.18</span>.<span class="hljs-number">0</span>） https:<span class="hljs-regexp">//</span>nginx.org<span class="hljs-regexp">/en/</span>download.html<br>M：MySQL（<span class="hljs-number">8.0</span>.<span class="hljs-number">19</span>） https:<span class="hljs-regexp">//</span>dev.mysql.com<span class="hljs-regexp">/downloads/my</span>sql/ <br>                  https:<span class="hljs-regexp">//</span>downloads.mysql.com<span class="hljs-regexp">/archives/</span>community/<br>P：PHP（<span class="hljs-number">7.4</span>.<span class="hljs-number">10</span>） http:<span class="hljs-regexp">//</span>php.net/downloads.php<br>Wordpress（<span class="hljs-number">5.4</span>.<span class="hljs-number">2</span>）：https:<span class="hljs-regexp">//</span>cn.wordpress.org<span class="hljs-regexp">/download/</span><br><span class="hljs-comment">#部署规划：</span><br><span class="hljs-number">10.0</span>.<span class="hljs-number">0.7</span>：Nginx php-fpm 运行web服务<br><span class="hljs-number">10.0</span>.<span class="hljs-number">0.17</span>：运行MySQL数据库,Redis服务<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp1.jpg"></p><h3 id="7-2-部署数据库"><a href="#7-2-部署数据库" class="headerlink" title="7.2 部署数据库"></a>7.2 部署数据库</h3><p>在10.0.0.17主机部署MySQL服务</p><h4 id="7-2-1-二进制部署MySQL数据库"><a href="#7-2-1-二进制部署MySQL数据库" class="headerlink" title="7.2.1 二进制部署MySQL数据库"></a>7.2.1 二进制部署MySQL数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br><span class="hljs-comment">#下载mysql-8.0.19</span><br>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz<br><br><span class="hljs-comment">#编写一键安装脚本</span><br>vim install_mysql5.7or8.0_for_centos.sh<br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#Author: wangxiaochun</span><br><span class="hljs-comment">#QQ: 29308620</span><br><span class="hljs-comment">#Date: 2020-02-12</span><br><span class="hljs-comment">#FileName： install_mysql5.7_for_centos.sh</span><br><span class="hljs-comment">#URL: http://www.magedu.com</span><br><span class="hljs-comment">#Description： The test script</span><br><span class="hljs-comment">#Copyright (C): 2020 All rights reserved</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#MySQL Download URL: https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.29-linux-glibc2.12-x86_64.tar.gz</span><br><br>. /etc/init.d/<span class="hljs-built_in">functions</span> <br>SRC_DIR=`<span class="hljs-built_in">pwd</span>`<br>MYSQL=<span class="hljs-string">&#x27;mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz&#x27;</span><br>COLOR=<span class="hljs-string">&quot;echo -e \\033[01;31m&quot;</span><br>END=<span class="hljs-string">&#x27;\033[0m&#x27;</span><br>MYSQL_ROOT_PASSWORD=123456<br>DIR=/data/mysql<br><br><span class="hljs-function"><span class="hljs-title">check</span></span> ()&#123;<br><span class="hljs-built_in">cd</span>  <span class="hljs-variable">$SRC_DIR</span><br><span class="hljs-keyword">if</span> [ !  -e <span class="hljs-variable">$MYSQL</span> ];<span class="hljs-keyword">then</span><br>        <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;缺少<span class="hljs-variable">$&#123;MYSQL&#125;</span>文件&quot;</span><span class="hljs-variable">$END</span><br>        <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;请将相关软件放在<span class="hljs-variable">$&#123;SRC_DIR&#125;</span>目录下&quot;</span><span class="hljs-variable">$END</span><br>        <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">elif</span> [ -e /usr/<span class="hljs-built_in">local</span>/mysql ];<span class="hljs-keyword">then</span><br>        action <span class="hljs-string">&quot;数据库已存在，安装失败&quot;</span> <span class="hljs-literal">false</span><br>        <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">elif</span> [ ! -e DIR ];<span class="hljs-keyword">then</span>   <span class="hljs-comment">#检查是否缺少/data/mysql文件，没有会安装失败</span><br>        <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;缺少<span class="hljs-variable">$DIR</span>文件&quot;</span><span class="hljs-variable">$END</span><br>        mkdir -p <span class="hljs-variable">$DIR</span><br>        <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;已自动创建<span class="hljs-variable">$DIR</span>文件&quot;</span><span class="hljs-variable">$END</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">return</span><br><span class="hljs-keyword">fi</span><br><br>&#125;   <br><br><span class="hljs-function"><span class="hljs-title">install_mysql</span></span>()&#123;<br>    <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;开始安装MySQL数据库...&quot;</span><span class="hljs-variable">$END</span><br>     yum  -y -q install libaio numactl-libs   libaio &amp;&gt; /dev/null<br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$SRC_DIR</span><br>    tar xf <span class="hljs-variable">$MYSQL</span> -C /usr/<span class="hljs-built_in">local</span>/<br>    MYSQL_DIR=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MYSQL</span>| sed -nr <span class="hljs-string">&#x27;s/^(.*[0-9]).*/\1/p&#x27;</span>`<br>    ln -s  /usr/<span class="hljs-built_in">local</span>/<span class="hljs-variable">$MYSQL_DIR</span> /usr/<span class="hljs-built_in">local</span>/mysql<br>    chown -R  root.root /usr/<span class="hljs-built_in">local</span>/mysql/<br>    id mysql &amp;&gt; /dev/null || &#123; useradd -s /sbin/nologin -r  mysql ; action <span class="hljs-string">&quot;创建mysql用户&quot;</span>; &#125;<br><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;PATH=/usr/local/mysql/bin/:$PATH&#x27;</span> &gt; /etc/profile.d/mysql.sh<br>    .  /etc/profile.d/mysql.sh<br>    cat &gt; /etc/my.cnf &lt;&lt;-<span class="hljs-string">EOF</span><br><span class="hljs-string">[mysqld]</span><br><span class="hljs-string">server-id=1</span><br><span class="hljs-string">log-bin</span><br><span class="hljs-string">datadir=/data/mysql</span><br><span class="hljs-string">socket=/data/mysql/mysql.sock                                                                                                   </span><br><span class="hljs-string">log-error=/data/mysql/mysql.log</span><br><span class="hljs-string">pid-file=/data/mysql/mysql.pid</span><br><span class="hljs-string">[client]</span><br><span class="hljs-string">socket=/data/mysql/mysql.sock</span><br><span class="hljs-string">EOF</span><br>    mysqld --initialize --user=mysql --datadir=/data/mysql <br>    cp /usr/<span class="hljs-built_in">local</span>/mysql/support-files/mysql.server  /etc/init.d/mysqld<br>    chkconfig --add mysqld<br>    chkconfig mysqld on<br>    service mysqld start<br>    [ $? -ne 0 ] &amp;&amp; &#123; <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;数据库启动失败，退出!&quot;</span><span class="hljs-variable">$END</span>;<span class="hljs-built_in">exit</span>; &#125;<br>    MYSQL_OLDPASSWORD=`awk <span class="hljs-string">&#x27;/A temporary password/&#123;print $NF&#125;&#x27;</span> /data/mysql/mysql.log`<br>    mysqladmin  -uroot -p<span class="hljs-variable">$MYSQL_OLDPASSWORD</span> password <span class="hljs-variable">$MYSQL_ROOT_PASSWORD</span> &amp;&gt;/dev/null<br>    action <span class="hljs-string">&quot;数据库安装完成&quot;</span> <br>&#125;<br><br>check<br><br>install_mysql<br><br><span class="hljs-comment">#查看文件</span><br>ll<br><br><span class="hljs-comment">#检查脚本语法是否有错误</span><br>bash -n install_mysql5.7or8.0_for_centos.sh<br><br><span class="hljs-comment">#调试脚本</span><br>bash -x install_mysql5.7or8.0_for_centos.sh<br><br><span class="hljs-comment">#删除调试脚本是创建的mysql文件夹</span><br>mv /usr/<span class="hljs-built_in">local</span> mysql mysql.bak<br><br><span class="hljs-comment">#运行脚本安装数据库</span><br>bash install_mysql5.7or8.0_for_centos.sh<br></code></pre></td></tr></table></figure><h4 id="7-2-2-创建wordpress数据库和用户并授权"><a href="#7-2-2-创建wordpress数据库和用户并授权" class="headerlink" title="7.2.2 创建wordpress数据库和用户并授权"></a>7.2.2 创建wordpress数据库和用户并授权</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql -uroot -p123456<br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection id is 10<br>Server version: 8.0.19 MySQL Community Server - GPL<br><br>Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; create database wordpress;<br>Query OK, 1 row affected (0.06 sec)<br><br>mysql&gt; create user wordpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; grant all on wordpress.* to wordpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure><h4 id="7-2-3-验证MySQL账户权限"><a href="#7-2-3-验证MySQL账户权限" class="headerlink" title="7.2.3 验证MySQL账户权限"></a>7.2.3 验证MySQL账户权限</h4><p>在WordPress服务器使用授权的MySQL账户远程登录测试权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql -uwordpress -p123456 -h10.0.0.17<br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor. Commands end with ; or \g.<br>Your MySQL connection id is 13<br>Server version: 8.0.19 MySQL Community Server - GPL<br><br>Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; show databases;<br>+--------------------+<br>| Database      |<br>+--------------------+<br>| information_schema |<br>| wordpress     |<br>+--------------------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="7-3-部署PHP"><a href="#7-3-部署PHP" class="headerlink" title="7.3 部署PHP"></a>7.3 部署PHP</h3><p>在10.0.0.7主机部署php-fpm服务</p><h4 id="7-3-1-编译安装-php"><a href="#7-3-1-编译安装-php" class="headerlink" title="7.3.1 编译安装 php"></a>7.3.1 编译安装 php</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum -y install gcc openssl-devel libxml2-devel bzip2-devel libmcrypt-devel sqlite-devel oniguruma-devel<br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br>wget https://www.php.net/distributions/php-7.4.11.tar.xz<br>ll -h php-7.4.11.tar.xz<br>-rw-r--r--. 1 root root 9.9M Feb 27 08:42 php-7.4.11.tar.xz<br>tar xf php-7.4.11.tar.xz<br><span class="hljs-built_in">cd</span> php-7.4.11<br>./configure --prefix=/apps/php74 --enable-mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-openssl --with-zlib --with-config-file-path=/etc --with-config-file-scan-dir=/etc/php.d --enable-mbstring --enable-xml --enable-sockets --enable-fpm --enable-maintainer-zts --disable-fileinfo<br><br>......<br>config.status: creating main/php_config.h<br>config.status: executing default commands<br><br>+--------------------------------------------------------------------+<br>| License:                              |<br>| This software is subject to the PHP License, available <span class="hljs-keyword">in</span> this   |<br>| distribution <span class="hljs-keyword">in</span> the file LICENSE. By continuing this installation |<br>| process, you are bound by the terms of this license agreement.   |<br>| If you <span class="hljs-keyword">do</span> not agree with the terms of this license, you must abort |<br>| the installation process at this point.              |<br>+--------------------------------------------------------------------+<br><br>Thank you <span class="hljs-keyword">for</span> using PHP.<br><br>make -j 8 &amp;&amp; make install <span class="hljs-comment">#看条件是否能加-j </span><br></code></pre></td></tr></table></figure><h4 id="7-3-2-准备PHP配置文件"><a href="#7-3-2-准备PHP配置文件" class="headerlink" title="7.3.2 准备PHP配置文件"></a>7.3.2 准备PHP配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">cp /usr/<span class="hljs-built_in">local</span>/src/php-7.4.11/php.ini-production /etc/php.ini<br><span class="hljs-built_in">cd</span> /apps/php74/etc<br>cp php-fpm.conf.default php-fpm.conf<br><span class="hljs-built_in">cd</span> php-fpm.d/<br>cp www.conf.default www.conf<br>vim www.conf<br>[www]<br>user = nginx<br>group = nginx<br>listen = 127.0.0.1:9000<br>pm = dynamic<br>pm.max_children = 5<br>pm.start_servers = 2<br>pm.min_spare_servers = 1<br>pm.max_spare_servers = 3<br>pm.status_path = /pm_status<br>ping.path = /ping<br>access.log = <span class="hljs-built_in">log</span>/<span class="hljs-variable">$pool</span>.access.log<br>slowlog = <span class="hljs-built_in">log</span>/<span class="hljs-variable">$pool</span>.log.slow<br><br><span class="hljs-comment">#创建用户</span><br>useradd -r -s /sbin/nologin nginx<br><br><span class="hljs-comment">#创建访问日志文件路径</span><br>mkdir /apps/php74/<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><h4 id="7-3-3-启动并验证-php-fpm服务"><a href="#7-3-3-启动并验证-php-fpm服务" class="headerlink" title="7.3.3 启动并验证 php-fpm服务"></a>7.3.3 启动并验证 php-fpm服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#检查配置文件</span><br>/apps/php74/sbin/php-fpm -t<br>[27-Feb-2021 11:53:51] NOTICE: configuration file /apps/php74/etc/php-fpm.conf <span class="hljs-built_in">test</span> is successful<br><br><span class="hljs-comment">#复制文件</span><br>cp /usr/<span class="hljs-built_in">local</span>/src/php-7.4.11/sapi/fpm/php-fpm.service /usr/lib/systemd/system/<br><br><span class="hljs-comment">#加载配置文件，将php设置为开机启动，启动php</span><br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> --now php-fpm<br>Created symlink from /etc/systemd/system/multi-user.target.wants/php-fpm.service to /usr/lib/systemd/system/php-fpm.service.<br><br><span class="hljs-comment">#出现9000端口证明成功</span><br>ss -tnl<br>State       Recv-Q Send-Q             Local Address:Port                            Peer Address:Port              <br>LISTEN      0      128                            *:22                                         *:*                  <br>LISTEN      0      128                    127.0.0.1:9000                                       *:*                  <br>LISTEN      0      128                           :::22                                        :::*   <br><br>pstree -p |grep php<br>           |-php-fpm(116240)-+-php-fpm(116241)<br>           |                 `-php-fpm(116242)<br><br>ps -ef |grep php<br>root     116240      1  0 11:59 ?        00:00:00 php-fpm: master process (/apps/php74/etc/php-fpm.conf)<br>nginx    116241 116240  0 11:59 ?        00:00:00 php-fpm: pool www<br>nginx    116242 116240  0 11:59 ?        00:00:00 php-fpm: pool www<br>root     116245   1342  0 12:00 pts/0    00:00:00 grep --color=auto php<br></code></pre></td></tr></table></figure><h3 id="7-4-部署-Nginx"><a href="#7-4-部署-Nginx" class="headerlink" title="7.4 部署 Nginx"></a>7.4 部署 Nginx</h3><p>在10.0.0.7主机部署nginx服务</p><h4 id="7-4-1-编译安装-nginx"><a href="#7-4-1-编译安装-nginx" class="headerlink" title="7.4.1 编译安装 nginx"></a>7.4.1 编译安装 nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum -y install gcc pcre-devel openssl-devel zlib-devel<br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/<br>wget http://nginx.org/download/nginx-1.18.0.tar.gz<br>tar xf nginx-1.18.0.tar.gz<br><span class="hljs-built_in">cd</span> nginx-1.18.0/<br>./configure --prefix=/apps/nginx \<br>--user=nginx \<br>--group=nginx \<br>--with-http_ssl_module \<br>--with-http_v2_module \<br>--with-http_realip_module \<br>--with-http_stub_status_module \<br>--with-http_gzip_static_module \<br>--with-pcre \<br>--with-stream \<br>--with-stream_ssl_module \<br>--with-stream_realip_module<br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure><h4 id="7-4-2-准备服务文件并启动-nginx"><a href="#7-4-2-准备服务文件并启动-nginx" class="headerlink" title="7.4.2 准备服务文件并启动 nginx"></a>7.4.2 准备服务文件并启动 nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /usr/lib/systemd/system/nginx.service<br>[Unit]<br>Description=nginx - high performance web server<br>Documentation=http://nginx.org/en/docs/<br>After=network-online.target remote-fs.target nss-lookup.target<br>Wants=network-online.target<br>[Service]<br>Type=forking<br>PIDFile=/apps/nginx/run/nginx.pid<br>ExecStart=/apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf<br>ExecReload=/bin/<span class="hljs-built_in">kill</span> -s HUP <span class="hljs-variable">$MAINPID</span><br>ExecStop=/bin/<span class="hljs-built_in">kill</span> -s TERM <span class="hljs-variable">$MAINPID</span><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment">#创建目录</span><br>mkdir /apps/nginx/run/<br><br><span class="hljs-comment">#修改配置文件</span><br>vim /apps/nginx/conf/nginx.conf<br>pid /apps/nginx/run/nginx.pid;<br><br><span class="hljs-comment">#创建软连接</span><br>ln -s /apps/nginx/sbin/nginx /usr/sbin/<br><br><span class="hljs-comment">#检查配置文件是否有错误</span><br>nginx -t<br><br><span class="hljs-comment">#加载配置文件并启动nginx</span><br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> --now nginx<br><br><span class="hljs-comment">#查看端口</span><br>ss -ntl<br>State       Recv-Q Send-Q             Local Address:Port                            Peer Address:Port              <br>LISTEN      0      128                            *:80                                         *:*                  <br>LISTEN      0      128                            *:22                                         *:*                  <br>LISTEN      0      128                    127.0.0.1:9000                                       *:*                  <br>LISTEN      0      128                           :::22                                        :::*                  <br><br></code></pre></td></tr></table></figure><h4 id="7-4-3-配置-Nginx-支持-fastcgi"><a href="#7-4-3-配置-Nginx-支持-fastcgi" class="headerlink" title="7.4.3 配置 Nginx 支持 fastcgi"></a>7.4.3 配置 Nginx 支持 fastcgi</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /apps/nginx/conf/nginx.conf<br>worker_processes  1;<br><br>pid    /apps/nginx/run/nginx.pid;<br><br>events &#123;<br> worker_connections  1024;<br>&#125;<br><br>http &#123;<br> include    mime.types;<br> default_type application/octet-stream;<br> sendfile    on;<br> keepalive_timeout  65;<br> server &#123;<br>   listen    80;<br>   server_name www.rlinpc.org;  <span class="hljs-comment">#指定主机名</span><br>   location / &#123;<br>     root  /data/nginx/wordpress;  <span class="hljs-comment">#指定数据目录</span><br>     index index.php index.html index.htm;      <span class="hljs-comment">#指定默认主页</span><br>   &#125;<br>   error_page  500 502 503 504 /50x.html;<br>   location = /50x.html &#123;<br>     root  html;<br>   &#125;<br>   location ~ \.php$ &#123;             <span class="hljs-comment">#实现php-fpm</span><br>     root      /data/nginx/wordpress;<br>     fastcgi_pass  127.0.0.1:9000;<br>     fastcgi_index index.php;<br>     fastcgi_param SCRIPT_FILENAME  $document_root<span class="hljs-variable">$fastcgi_script_name</span>;<br>     include    fastcgi_params;<br>   &#125;<br>   location ~ ^/(ping|pm_status)$ &#123;       <span class="hljs-comment">#实现状态页</span><br>     include fastcgi_params;<br>     fastcgi_pass 127.0.0.1:9000;<br>     fastcgi_param PATH_TRANSLATED $document_root<span class="hljs-variable">$fastcgi_script_name</span>;<br>   &#125;<br> &#125;<br>&#125;<br><br>/apps/nginx/sbin/nginx -t<br>systemctl reload nginx<br></code></pre></td></tr></table></figure><h4 id="7-4-4-准备-php-测试页"><a href="#7-4-4-准备-php-测试页" class="headerlink" title="7.4.4 准备 php 测试页"></a>7.4.4 准备 php 测试页</h4><p>准备测试页</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkdir -p /data/nginx/wordpress<br>vim /data/nginx/wordpress/test.php<br>&lt;?php<br>phpinfo();<br>?&gt;<br></code></pre></td></tr></table></figure><h4 id="7-4-5-验证-php-测试页"><a href="#7-4-5-验证-php-测试页" class="headerlink" title="7.4.5 验证 php 测试页"></a>7.4.5 验证 php 测试页</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp2.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp3.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp4.jpg"></p><h3 id="7-5-部署-WordPress"><a href="#7-5-部署-WordPress" class="headerlink" title="7.5 部署 WordPress"></a>7.5 部署 WordPress</h3><p>在10.0.0.7主机部署 wordpress</p><h4 id="7-5-1-准备-WordPress-文件"><a href="#7-5-1-准备-WordPress-文件" class="headerlink" title="7.5.1 准备 WordPress 文件"></a>7.5.1 准备 WordPress 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br>wget https://cn.wordpress.org/wordpress-5.4.2-zh_CN.tar.gzz<br>tar xf wordpress-5.4.2-zh_CN.tar.gz<br>cp -r wordpress/* /data/nginx/wordpress<br>chown -R nginx.nginx /data/nginx/wordpress/<br></code></pre></td></tr></table></figure><h4 id="7-5-2-初始化web页面"><a href="#7-5-2-初始化web页面" class="headerlink" title="7.5.2 初始化web页面"></a>7.5.2 初始化web页面</h4><p>打开浏览器访问下面链接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://www.rlinpc.org/<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp5.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp6.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp7.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp8.jpg"></p><h4 id="7-5-3-登录后台管理界面并发表文章"><a href="#7-5-3-登录后台管理界面并发表文章" class="headerlink" title="7.5.3 登录后台管理界面并发表文章"></a>7.5.3 登录后台管理界面并发表文章</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp9.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp10.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp11.jpg"></p><h4 id="7-5-4-验证发表的文章"><a href="#7-5-4-验证发表的文章" class="headerlink" title="7.5.4 验证发表的文章"></a>7.5.4 验证发表的文章</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp12.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">tree /data/nginx/wordpress/wp-content/uploads/<br>/data/nginx/wordpress/wp-content/uploads/<br>└── 2021<br>    └── 02<br>        └── 20151221-03131.jpg<br><br>2 directories, 1 file<br></code></pre></td></tr></table></figure><h4 id="7-5-5-配置允许上传大文件"><a href="#7-5-5-配置允许上传大文件" class="headerlink" title="7.5.5 配置允许上传大文件"></a>7.5.5 配置允许上传大文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注意:默认只支持1M以下文件上传,要上传大图片,需要修改下面三项配置,最大上传由三项值的最小值决定</span><br><span class="hljs-comment">#直接上传大于1M文件,会出现下面413错误</span><br>tail -f /apps/nginx/logs/access.log<br><br>vim /apps/nginx/conf/nginx.conf<br>server &#123;<br>   client_max_body_size 10m; <span class="hljs-comment">#默认值为1M</span><br>.....<br>&#125;<br><br><span class="hljs-comment">#检查nginx配置文件是否有错误</span><br>nginx -t<br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br><br>vim /etc/php.ini<br>post_max_size = 30M  <span class="hljs-comment">#默认值为8M</span><br>upload_max_filesize = 20M  <span class="hljs-comment">#默认值为2M</span><br><br><span class="hljs-comment">#检查php配置文件是否有错误</span><br>/apps/php74/sbin/php-fpm -t<br>[27-Feb-2021 16:48:02] NOTICE: configuration file /apps/php74/etc/php-fpm.conf <span class="hljs-built_in">test</span> is successful<br><br>systemctl restart nginx php-fpm<br></code></pre></td></tr></table></figure><h4 id="7-5-6-安全加固"><a href="#7-5-6-安全加固" class="headerlink" title="7.5.6 安全加固"></a>7.5.6 安全加固</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp13.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /apps/nginx/conf/nginx.conf<br><span class="hljs-comment">#grep -Ev &#x27;#|^$&#x27; /apps/nginx/conf/nginx.conf</span><br>worker_processes  1;<br>pid    /apps/nginx/run/nginx.pid;<br>events &#123;<br> worker_connections  1024;<br>&#125;<br>http &#123;<br> include    mime.types;<br> default_type application/octet-stream;<br> sendfile    on; <br> keepalive_timeout  65;<br> server &#123;<br>   listen    80;<br>   server_name www.magedu.org;<br>   server_tokens off; <span class="hljs-comment">#添加此行</span><br>   location / &#123;<br>     root  /data/nginx/wordpress;<br>     index index.php index.html index.htm;<br>   &#125;<br>   error_page  500 502 503 504 /50x.html;<br>   location = /50x.html &#123;<br>     root  html;<br>   &#125;<br>   location ~ \.php$ &#123;<br>     root      /data/nginx/wordpress;<br>     fastcgi_pass  127.0.0.1:9000;<br>     fastcgi_index index.php;<br>     fastcgi_param SCRIPT_FILENAME  $document_root<span class="hljs-variable">$fastcgi_script_name</span>;<br>     include    fastcgi_params;<br>     fastcgi_hide_header X-Powered-By;  <span class="hljs-comment">#添加此行</span><br>   &#125;<br>   location ~ ^/(ping|pm_status)$ &#123;<br>     include fastcgi_params;<br>     fastcgi_pass 127.0.0.1:9000;<br>     fastcgi_param PATH_TRANSLATED $document_root<span class="hljs-variable">$fastcgi_script_name</span>;<br>   &#125;<br> &#125;<br>&#125;<br><br>systemctl reload nginx<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp14.jpg"></p><h4 id="7-5-7-配置-php-开启-opcache-加速"><a href="#7-5-7-配置-php-开启-opcache-加速" class="headerlink" title="7.5.7 配置 php 开启 opcache 加速"></a>7.5.7 配置 php 开启 opcache 加速</h4><p>在10.0.0.7主机进行以下修改配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#编辑php.ini配置文件</span><br>vim /etc/php.ini<br>[opcache]<br>; Determines <span class="hljs-keyword">if</span> Zend OPCache is enabled<br>zend_extension=opcache.so                           <br>opcache.enable=1<br>.....<br><br>/apps/php74/sbin/php-fpm -t<br>[27-Feb-2021 17:04:54] NOTICE: configuration file /apps/php74/etc/php-fpm.conf <span class="hljs-built_in">test</span> is successful<br><br>systemctl restart php-fpm<br><span class="hljs-comment">#访问测试页确认开启opcache加速</span><br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp15.jpg"></p><h3 id="7-6-PHP-扩展session模块支持redis"><a href="#7-6-PHP-扩展session模块支持redis" class="headerlink" title="7.6 PHP 扩展session模块支持redis"></a>7.6 PHP 扩展session模块支持redis</h3><p>PECL是 PHP 扩展的存储库，提供用于下载和开发 PHP 扩展的所有已知扩展和托管功能的目录<br>官方链接: <a href="http://pecl.php.net/package-stats.php">http://pecl.php.net/package-stats.php</a><br>github: <a href="https://github.com/phpredis/phpredis">https://github.com/phpredis/phpredis</a><br>github安装文档: <a href="https://github.com/phpredis/phpredis/blob/develop/INSTALL.markdown">https://github.com/phpredis/phpredis/blob/develop/INSTALL.markdown</a><br>开始在 PHP 中使用 Redis 前， 需要确保已经安装了 redis 服务及 PHP redis 驱动，<br>PHP redis 驱动下载地址为:<a href="https://github.com/phpredis/phpredis/releases">https://github.com/phpredis/phpredis/releases</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp16.jpg"></p><h4 id="7-6-1-编译安装PHP-redis"><a href="#7-6-1-编译安装PHP-redis" class="headerlink" title="7.6.1 编译安装PHP redis"></a>7.6.1 编译安装PHP redis</h4><p><strong>在10.0.0.7主机进行以下编译安装</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br>ls<br>wget http://pecl.php.net/get/redis-5.3.1.tgz<br>tar xf redis-5.3.1.tgz<br><span class="hljs-built_in">cd</span> redis-5.3.1/<br>ls<br>arrays.markdown    config.w32        library.c        redis_array_impl.c  redis_commands.h    sentinel_library.h<br>cluster_library.c  COPYING           library.h        redis_array_impl.h  redis_sentinel.c    sentinel.markdown<br>cluster_library.h  crc16.h           php_redis.h      redis.c             redis_sentinel.h    tests<br>cluster.markdown   CREDITS           README.markdown  redis_cluster.c     redis_session.c<br>common.h           INSTALL.markdown  redis_array.c    redis_cluster.h     redis_session.h<br>config.m4          liblzf            redis_array.h    redis_commands.c    sentinel_library.c<br><br><span class="hljs-comment">#如果是yum安装php,需要执行yum -y install php-cli php-devel</span><br><span class="hljs-comment">#以下为编译安装php的对应方式</span><br>/apps/php74/bin/phpize<br>Configuring <span class="hljs-keyword">for</span>:<br>PHP Api Version:         20190902<br>Zend Module Api No:      20190902<br>Zend Extension Api No:   320190902<br>Cannot find autoconf. Please check your autoconf installation and the <span class="hljs-comment">#报错提示</span><br><span class="hljs-variable">$PHP_AUTOCONF</span> environment variable. Then, rerun this script.<br><br>yum -y install autoconf<br>/apps/php74/bin/phpize<br>Configuring <span class="hljs-keyword">for</span>:<br>PHP Api Version:         20190902<br>Zend Module Api No:      20190902<br>Zend Extension Api No:   320190902<br><br><span class="hljs-comment">#查看生成configure脚本</span><br>ls<br>arrays.markdown    config.h.in   CREDITS           redis_array.c       redis_commands.c  sentinel_library.c<br>autom4te.cache     config.m4     INSTALL.markdown  redis_array.h       redis_commands.h  sentinel_library.h<br>build              configure     liblzf            redis_array_impl.c  redis_sentinel.c  sentinel.markdown<br>cluster_library.c  configure.ac  library.c         redis_array_impl.h  redis_sentinel.h  tests<br>cluster_library.h  config.w32    library.h         redis.c             redis_session.c<br>cluster.markdown   COPYING       php_redis.h       redis_cluster.c     redis_session.h<br>common.h           crc16.h       README.markdown   redis_cluster.h     run-tests.php<br><br><span class="hljs-comment">#yum安装php,无需指定--with-php-config</span><br>./configure --with-php-config=/apps/php74/bin/php-config --enable-redis<br>make &amp;&amp; make install<br>......<br>See any operating system documentation about shared libraries <span class="hljs-keyword">for</span><br>more information, such as the ld(1) and ld.so(8) manual pages.<br>----------------------------------------------------------------------<br><br>Build complete.<br>Don<span class="hljs-string">&#x27;t forget to run &#x27;</span>make <span class="hljs-built_in">test</span><span class="hljs-string">&#x27;.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Installing shared extensions:     /apps/php74/lib/php/extensions/no-debug-zts-20190902/</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">#验证redis模块</span><br><span class="hljs-string">#yum安装php,模块文件默认存放在 /usr/lib64/php/modules/redis.so</span><br><span class="hljs-string">ll /apps/php74/lib/php/extensions/no-debug-zts-20190902/</span><br><span class="hljs-string">total 9584</span><br><span class="hljs-string">-rwxr-xr-x. 1 root root 4647932 Feb 27 11:38 opcache.a</span><br><span class="hljs-string">-rwxr-xr-x. 1 root root 2509608 Feb 27 11:38 opcache.so</span><br><span class="hljs-string">-rwxr-xr-x. 1 root root 2651376 Feb 27 17:18 redis.so</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><h4 id="7-6-2-编辑php配置文件支持redis"><a href="#7-6-2-编辑php配置文件支持redis" class="headerlink" title="7.6.2 编辑php配置文件支持redis"></a>7.6.2 编辑php配置文件支持redis</h4><p><strong>在10.0.0.7主机进行以下修改配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#编辑php.ini配置文件，扩展redis.so模块</span><br>vim /etc/php.ini<br>.....<br><span class="hljs-comment">#extension=/apps/php74/lib/php/extensions/no-debug-zts-20190902/redis.so</span><br>extension=redis.so   <span class="hljs-comment">#文件最后一行添加此行,路径可省略</span><br>systemctl restart php-fpm<br></code></pre></td></tr></table></figure><h4 id="7-6-3-验证加载-redis-模块"><a href="#7-6-3-验证加载-redis-模块" class="headerlink" title="7.6.3 验证加载 redis 模块"></a>7.6.3 验证加载 redis 模块</h4><p>访问测试页确认redis模块开启</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp17.jpg"></p><h4 id="7-6-4-安装和配置-redis-服务"><a href="#7-6-4-安装和配置-redis-服务" class="headerlink" title="7.6.4 安装和配置 redis 服务"></a>7.6.4 安装和配置 redis 服务</h4><p><strong>在10.0.0.17主机进行安装redis 服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在10.0.0.17主机安装redis服务</span><br>yum -y install redis<br>vim /etc/redis.conf<br><span class="hljs-built_in">bind</span> 0.0.0.0<br>requirepass 123456<br><br>systemctl <span class="hljs-built_in">enable</span> --now redis<br><br><span class="hljs-comment">#端口号6379</span><br>ss -tnl<br>State       Recv-Q Send-Q             Local Address:Port                            Peer Address:Port              <br>LISTEN      0      128                            *:6379                                       *:*                  <br>LISTEN      0      128                            *:22                                         *:*                  <br>LISTEN      0      128                           :::22                                        :::*                  <br>LISTEN      0      70                            :::33060                                     :::*                  <br>LISTEN      0      128                           :::3306                                      :::*                  <br><br></code></pre></td></tr></table></figure><h4 id="7-6-5-配置-php-支持-redis-保存-session"><a href="#7-6-5-配置-php-支持-redis-保存-session" class="headerlink" title="7.6.5 配置 php 支持 redis 保存 session"></a>7.6.5 配置 php 支持 redis 保存 session</h4><p><strong>在10.0.0.7 主机进行以下配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在10.0.0.7主机配置php的session保存在redis服务</span><br>vim /etc/php.ini<br>[Session]<br>; Handler used to store/retrieve data.<br>; http://php.net/session.save-handler<br>session.save_handler = redis<br>session.save_path = <span class="hljs-string">&quot;tcp://10.0.0.17:6379?auth=123456&quot;</span> <br><br>systemctl restart php-fpm<br></code></pre></td></tr></table></figure><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp18.jpg"></p><h4 id="7-6-6-准备-php实现-session-的测试页面"><a href="#7-6-6-准备-php实现-session-的测试页面" class="headerlink" title="7.6.6 准备 php实现 session 的测试页面"></a>7.6.6 准备 php实现 session 的测试页面</h4><p><strong>在10.0.0.7主机进行准备相关文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /data/nginx/wordpress/session.php<br>&lt;?php<br>session_start();<br>//redis用session_id作为key 并且是以string的形式存储<br><span class="hljs-variable">$redisKey</span> = <span class="hljs-string">&#x27;PHPREDIS_SESSION:&#x27;</span> . session_id();<br><br>// SESSION 赋值测试<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&quot;Hello, I&#x27;m in redis&quot;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;arr&#x27;</span>] = [1, 2, 3, 4, 5, 6];<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;message&quot;</span>] , <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Redis key =  &quot;</span> . <span class="hljs-variable">$redisKey</span> . <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;以下是从Redis获取的数据&quot;</span>, <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><br>// 取数据<span class="hljs-string">&#x27;</span><br><span class="hljs-string">$redis = new Redis();</span><br><span class="hljs-string">$redis-&gt;connect(&#x27;</span>10.0.0.17<span class="hljs-string">&#x27;, 6379);</span><br><span class="hljs-string">$redis-&gt;auth(&#x27;</span>123456<span class="hljs-string">&#x27;);</span><br><span class="hljs-string"></span><br><span class="hljs-string">echo $redis-&gt;get($redisKey);</span><br><span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="7-6-7-访问-web-页面测试实现session保存在redis服务"><a href="#7-6-7-访问-web-页面测试实现session保存在redis服务" class="headerlink" title="7.6.7 访问 web 页面测试实现session保存在redis服务"></a>7.6.7 访问 web 页面测试实现session保存在redis服务</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp19.jpg"></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp20.jpg"></p><h4 id="7-6-8-redis-主机验证-session-数据"><a href="#7-6-8-redis-主机验证-session-数据" class="headerlink" title="7.6.8 redis 主机验证 session 数据"></a>7.6.8 redis 主机验证 session 数据</h4><p><strong>在10.0.0.17主机进行验证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">redis-cli -h 10.0.0.17 -a 123456<br>redis-cli -h 10.0.0.17 -a 123456<br>10.0.0.17:6379&gt; keys *<br>1) <span class="hljs-string">&quot;PHPREDIS_SESSION:t4q6udsscerbnb35lm215jojrl&quot;</span> <span class="hljs-comment">#要根据获得的key来输入</span><br>10.0.0.17:6379&gt; get PHPREDIS_SESSION:t4q6udsscerbnb35lm215jojrl<br><span class="hljs-string">&quot;message|s:19:\&quot;Hello, I&#x27;m in redis\&quot;;arr|a:6:&#123;i:0;i:1;i:1;i:2;i:2;i:3;i:3;i:4;i:4;i:5;i:5;i:6;&#125;&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Linux Nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>高性能WEB服务NGINX介绍</title>
    <link href="/blog/2021/02/27/%E9%AB%98%E6%80%A7%E8%83%BDWEB%E6%9C%8D%E5%8A%A1NGINX%E4%BB%8B%E7%BB%8D/"/>
    <url>/blog/2021/02/27/%E9%AB%98%E6%80%A7%E8%83%BDWEB%E6%9C%8D%E5%8A%A1NGINX%E4%BB%8B%E7%BB%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="高性能WEB服务NGINX"><a href="#高性能WEB服务NGINX" class="headerlink" title="高性能WEB服务NGINX"></a>高性能WEB服务NGINX</h1><h2 id="一、Web-基础介绍"><a href="#一、Web-基础介绍" class="headerlink" title="一、Web 基础介绍"></a>一、Web 基础介绍</h2><p>正常情况下的单词web服务访问流程：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce1.jpg"></p><h3 id="1-1-互联网发展历程回顾"><a href="#1-1-互联网发展历程回顾" class="headerlink" title="1.1 互联网发展历程回顾"></a>1.1 互联网发展历程回顾</h3><p>1993年3月2日，中国科学院高能物理研究所租用AT&amp;T公司的国际卫星信道建立的接入美国SLAC国家实<br>验室的64K专线正式开通，成为我国连入Internet的第一根专线。<br>参考链接: <a href="http://www.ihep.cas.cn/kxcb/kpcg/jsywl/201407/t20140714_4156699.html">http://www.ihep.cas.cn/kxcb/kpcg/jsywl/201407/t20140714_4156699.html</a><br>1995年马云开始创业并推出了一个web网站 中国黄页<br>1999年创建阿里巴巴 <a href="http://www.alibabagroup.com/">www.alibabagroup.com</a><br>2003年5月10日创立淘宝网<br>2004年12月，马云创立第三方网上支付平台支付宝（蚂蚁金服旗下，共有蚂蚁金服支付宝、余额宝、招财宝、蚂蚁聚宝、网商银行、蚂蚁花呗、芝麻信用等子业务板块）<br>2009年开始举办双十一购物狂欢节，以下是历年交易成交额：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">2009年双十一：5000万元<br>2010年双十一：9.36亿元<br>2011年双十一：33.6亿元<br>2012年双十一：191亿元<br>2013年双十一：350亿元<br>2014年双十一：571亿元<br>2015年双十一：912.17亿元<br>2016年双十一：1207亿元<br>2017年双十一：1682.69亿元<br>2018年双十一：2135亿元<br>2019年双十一：2684亿元<br>2020年双十一：4982亿元<br></code></pre></td></tr></table></figure><p>2012年1月11日淘宝商城正式更名为“天猫”<br>2014年9月19日里巴巴集团于纽约证券交易所正式挂牌上市</p><h3 id="1-2-Web-服务介绍"><a href="#1-2-Web-服务介绍" class="headerlink" title="1.2 Web 服务介绍"></a>1.2 Web 服务介绍</h3><p>Netcraft公司于1994年底在英国成立，多年来一直致力于互联网市场以及在线安全方面的咨询服务，其中在国际上最具影响力的当属其针对网站服务器，域名解析/主机提供商，以及SSL市场所做的客观严谨的分析研究。</p><p><a href="https://news.netcraft.com/">https://news.netcraft.com/</a></p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce2.jpg"></p><h4 id="1-2-1-Apache-经典的-Web-服务端"><a href="#1-2-1-Apache-经典的-Web-服务端" class="headerlink" title="1.2.1 Apache 经典的 Web 服务端"></a>1.2.1 Apache 经典的 Web 服务端</h4><p>Apache起初由美国的伊利诺伊大学香槟分校的国家超级计算机应用中心开发，目前经历了两大版本分别是1.X和2.X，其可以通过编译安装实现特定的功能，官方网站：<a href="http://www.apache.org/">http://www.apache.org</a></p><h5 id="1-2-1-1-Apache-prefork-模型"><a href="#1-2-1-1-Apache-prefork-模型" class="headerlink" title="1.2.1.1 Apache prefork 模型"></a>1.2.1.1 Apache prefork 模型</h5><p>预派生模式，有一个主控制进程，然后生成多个子进程，使用select模型，最大并发1024，每个子进程有一个独立的线程响应用户请求，相对比较占用内存，但是比较稳定，可以设置最大和最小进程数，是最古老的一种模式，也是最稳定的模式，适用于访问量不是很大的场景。<br>优点：稳定<br>缺点：慢，占用资源，1024个进程不适用于高并发场景</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce3.jpg"></p><h5 id="1-2-1-2-Apache-worker-模型"><a href="#1-2-1-2-Apache-worker-模型" class="headerlink" title="1.2.1.2 Apache worker 模型"></a>1.2.1.2 Apache worker 模型</h5><p>一种多进程和多线程混合的模型，有一个控制进程，启动多个子进程，每个子进程里面包含固定的线程，使用线程程来处理请求，当线程不够使用的时候会再启动一个新的子进程，然后在进程里面再启动线程处理请求，由于其使用了线程处理请求，因此可以承受更高的并发。<br>优点：相比prefork 占用的内存较少，可以同时处理更多的请求<br>缺点：使用keepalive的长连接方式，某个线程会一直被占据，即使没有传输数据，也需要一直等待到超时才会被释放。如果过多的线程，被这样占据，也会导致在高并发场景下的无服务线程可用。（该问题在prefork模式下，同样会发生）</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce4.jpg"></p><h5 id="1-2-1-3-Apache-event模型"><a href="#1-2-1-3-Apache-event模型" class="headerlink" title="1.2.1.3 Apache event模型"></a>1.2.1.3 Apache event模型</h5><p>Apache中最新的模式，2012年发布的apache 2.4.X系列正式支持event 模型，属于事件驱动模型<br>(epoll)，每个进程响应多个请求，在现在版本里的已经是稳定可用的模式。它和worker模式很像，最大的区别在于，它解决了keepalive场景下，长期被占用的线程的资源浪费问题（某些线程因为被keepalive，空挂在哪里等待，中间几乎没有请求过来，甚至等到超时）。event MPM中，会有一个专门的线程来管理这些keepalive类型的线程，当有真实请求过来的时候，将请求传递给服务线程，执行完毕后，又允许它释放。这样增强了高并发场景下的请求处理能力。<br>优点：单线程响应多请求，占据更少的内存，高并发下表现更优秀，会有一个专门的线程来管理keep-alive类型的线程，当有真实请求过来的时候，将请求传递给服务线程，执行完毕后，又允许它释放<br>缺点：没有线程安全控制</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce5.jpg"></p><h4 id="1-2-2-Nginx-高性能的-Web-服务端"><a href="#1-2-2-Nginx-高性能的-Web-服务端" class="headerlink" title="1.2.2 Nginx-高性能的 Web 服务端"></a>1.2.2 Nginx-高性能的 Web 服务端</h4><p>Ninx是由1994年毕业于俄罗斯国立莫斯科鲍曼科技大学的同学为俄罗斯rambler.ru公司开发的，开发<br>工作最早从2002年开始，第一次公开发布时间是2004年10月4日，版本号是0.1.0，官网地址 <a href="http://www.nginx.org/">www.nginx.org</a><br>Nginx历经十几年的迭代更新（<a href="https://nginx.org/en/CHANGES%EF%BC%89%EF%BC%8C">https://nginx.org/en/CHANGES），</a> 目前功能已经非常完善且运行稳定，另外Nginx的版本分为开发版、稳定版和过期版，nginx以功能丰富著称，它即可以作为http服务器，也可以作为反向代理服务器或者邮件服务器，能够快速的响应静态网页的请求，支持<br>FastCGI/SSL/Virtual Host/URL Rwrite/Gzip/HTTP Basic Auth/http或者TCP的负载均衡(1.9版本以上且开启stream模块)等功能，并且支持第三方的功能扩展。<br>为什么使用Nginx：<br>天猫 淘宝 京东 小米 163 新浪等一线互联网公司都在用Nginx或者进行二次开发<br>基于Nginx的工作场景：</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce6.jpg"></p><h4 id="1-2-3-用户访问体验和性能"><a href="#1-2-3-用户访问体验和性能" class="headerlink" title="1.2.3 用户访问体验和性能"></a>1.2.3 用户访问体验和性能</h4><h5 id="1-2-3-1-用户访问体验统计"><a href="#1-2-3-1-用户访问体验统计" class="headerlink" title="1.2.3.1 用户访问体验统计"></a>1.2.3.1 用户访问体验统计</h5><p>互联网存在用户速度体验的1-3-10原则，即1秒最优，1-3秒较优，3~10秒比较慢，10秒以上用户无法接受。用户放弃一个产品的代价很低，只是换一个URL而已。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce7.jpg"></p><p>全球最大搜索引擎 Google：慢500ms = 20% 将放弃访问。<br>全球最大的电商零售网站亚马逊：慢100ms = 1% 将放弃交易<br>有很多研究都表明，性能对用户的行为有很大的影响：<br>79%的用户表示不太可能再次打开一个缓慢的网站<br>47%的用户期望网页能在2秒钟以内加载<br>40%的用户表示如果加载时间超过三秒钟，就会放弃这个网站<br>页面加载时间延迟一秒可能导致转换损失7%，页面浏览量减少11%<br>8秒定律：用户访问一个网站时，如果等待网页打开的时间超过8秒，会有超过30%的用户放弃等待<br>请珍惜每一毫秒的时间 !</p><h5 id="1-2-3-2-影响用户体验的因素"><a href="#1-2-3-2-影响用户体验的因素" class="headerlink" title="1.2.3.2 影响用户体验的因素"></a>1.2.3.2 影响用户体验的因素</h5><p>据说马云在刚开始创业在给客户演示时，打开一个网站花了不到四个小时。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://www.shuimiao.net/NjHaO/<br></code></pre></td></tr></table></figure><p><strong>影响用户体验的因素</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">客户端硬件配置<br>客户端网络速率<br>客户端与服务端距离<br><br>服务端网络速率<br>服务端硬件配置<br>服务端架构设计<br>服务端应用程序工作模式<br>服务端并发数量<br>服务端响应文件大小及数量<br>服务端I/O压力<br></code></pre></td></tr></table></figure><h4 id="1-2-4-服务端-I-O-流程"><a href="#1-2-4-服务端-I-O-流程" class="headerlink" title="1.2.4 服务端 I/O 流程"></a>1.2.4 服务端 I/O 流程</h4><p>I/O在计算机中指Input/Output， IOPS (Input/Output Per Second)即每秒的输入输出量(或读写次数)，是衡量磁盘性能的主要指标之一。IOPS是指单位时间内系统能处理的I/O请求数量，一般以每秒处理的I/O请求数量为单位，I/O请求通常为读或写数据操作请求。<br>一次完整的I/O是用户空间的进程数据与内核空间的内核数据的报文的完整交换，但是由于内核空间与用户空间是严格隔离的，所以其数据交换过程中不能由用户空间的进程直接调用内核空间的内存数据，而是需要经历一次从内核空间中的内存数据copy到用户空间的进程内存当中，所以简单说I/O就是把数据从内核空间中的内存数据复制到用户空间中进程的内存当中。<br>Linux 的 I/O</p><ul><li>磁盘I/O</li><li>网络I/O : 一切皆文件,本质为对socket文件的读写</li></ul><h5 id="1-2-4-1-磁盘-I-O"><a href="#1-2-4-1-磁盘-I-O" class="headerlink" title="1.2.4.1 磁盘 I/O"></a>1.2.4.1 磁盘 I/O</h5><p>磁盘I/O是进程向内核发起系统调用，请求磁盘上的某个资源比如是html 文件或者图片，然后内核通过相应的驱动程序将目标文件加载到内核的内存空间，加载完成之后把数据从内核内存再复制给进程内存，如果是比较大的数据也需要等待时间</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">机械磁盘的寻道时间、旋转延迟和数据传输时间：<br>寻道时间：是指磁头移动到正确的磁道上所花费的时间，寻道时间越短则I/O处理就越快，目前磁盘的寻道时<br>间一般在3-15毫秒左右。<br><br>旋转延迟：是指将磁盘片旋转到数据所在的扇区到磁头下面所花费的时间，旋转延迟取决于磁盘的转速，通常<br>使用磁盘旋转一周所需要时间的1/2之一表示，比如7200转的磁盘平均训传延迟大约为<br>60*1000/7200/2=4.17毫秒，公式的意思为 （每分钟60秒*1000毫秒每秒/7200转每分/2），如果是<br>15000转的则为60*1000/15000/2=2毫秒。<br><br>数据传输时间：指的是读取到数据后传输数据的时间，主要取决于传输速率，这个值等于数据大小除以传输速<br>率，目前的磁盘接口每秒的传输速度可以达到600MB，因此可以忽略不计。<br><br>常见的机械磁盘平均寻道时间值：<br>7200转/分的磁盘平均物理寻道时间：9毫秒<br>10000转/分的磁盘平均物理寻道时间：6毫秒<br>15000转/分的磁盘平均物理寻道时间：4毫秒<br><br>常见磁盘的平均延迟时间：<br>7200转的机械盘平均延迟：60*1000/7200/2 = 4.17ms<br>10000转的机械盘平均延迟：60*1000/10000/2 = 3ms<br>15000转的机械盘平均延迟：60*1000/15000/2 = 2ms<br><br>每秒最大IOPS的计算方法：<br>7200转的磁盘IOPS计算方式：1000毫秒/(9毫秒的寻道时间+4.17毫秒的平均旋转延迟时间)=1000/13.13=75.9 IOPS<br>10000转的磁盘的IOPS计算方式：1000毫秒/(6毫秒的寻道时间+3毫秒的平均旋转延迟间)=1000/9=111<br>IOPS<br>15000转的磁盘的IOPS计算方式：15000毫秒/(4毫秒的寻道时间+2毫秒的平均旋转延迟时间)=1000/6=166.6 IOPS<br></code></pre></td></tr></table></figure><h5 id="1-2-4-2-网络-I-O"><a href="#1-2-4-2-网络-I-O" class="headerlink" title="1.2.4.2 网络 I/O"></a>1.2.4.2 网络 I/O</h5><p>网络通信就是网络协议栈到用户空间进程的IO就是网络IO</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce8.jpg"></p><p>网络I/O 处理过程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">获取请求数据，客户端与服务器建立连接发出请求，服务器接受请求（1-3）<br>构建响应，当服务器接收完请求，并在用户空间处理客户端的请求，直到构建响应完成（4）<br>返回数据，服务器将已构建好的响应再通过内核空间的网络 I/O 发还给客户端（5-7）<br></code></pre></td></tr></table></figure><p>不论磁盘和网络I/O</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">每次I/O，都要经由两个阶段：<br>第一步：将数据从文件先加载至内核内存空间（缓冲区），等待数据准备完成，时间较长<br>第二步：将数据从内核缓冲区复制到用户空间的进程的内存中，时间较短<br></code></pre></td></tr></table></figure><h3 id="1-3-I-O-模型"><a href="#1-3-I-O-模型" class="headerlink" title="1.3 I/O 模型"></a>1.3 I/O 模型</h3><h4 id="1-3-1-I-O-模型相关概念"><a href="#1-3-1-I-O-模型相关概念" class="headerlink" title="1.3.1 I/O 模型相关概念"></a>1.3.1 I/O 模型相关概念</h4><p>同步/异步：关注的是消息通信机制，即调用者在等待一件事情的处理结果时，被调用者是否提供完成状态的通知。</p><ul><li>同步：synchronous，被调用者并不提供事件的处理结果相关的通知消息，需要调用者主动询问事情是否处理完成</li><li>异步：asynchronous，被调用者通过状态、通知或回调机制主动通知调用者被调用者的运行状态</li></ul><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce9.jpg"></p><p>阻塞/非阻塞：关注调用者在等待结果返回之前所处的状态</p><ul><li>阻塞：blocking，指IO操作需要彻底完成后才返回到用户空间，调用结果返回之前，调用者被挂<br>起，干不了别的事情。</li><li>非阻塞：nonblocking，指IO操作被调用后立即返回给用户一个状态值，而无需等到IO操作彻底完成，在最终的调用结果返回之前，调用者不会被挂起，可以去做别的事情。</li></ul><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce10.jpg"></p><h4 id="1-3-2-网络-I-O-模型"><a href="#1-3-2-网络-I-O-模型" class="headerlink" title="1.3.2 网络 I/O 模型"></a>1.3.2 网络 I/O 模型</h4><p>阻塞型、非阻塞型、复用型、信号驱动型、异步</p><h5 id="1-3-2-1-阻塞型-I-O-模型（blocking-IO）"><a href="#1-3-2-1-阻塞型-I-O-模型（blocking-IO）" class="headerlink" title="1.3.2.1 阻塞型 I/O 模型（blocking IO）"></a>1.3.2.1 阻塞型 I/O 模型（blocking IO）</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce11.jpg"></p><p>阻塞IO模型是最简单的I/O模型，用户线程在内核进行IO操作时被阻塞<br>用户线程通过系统调用read发起I/O读操作，由用户空间转到内核空间。内核等到数据包到达后，然后将接收的数据拷贝到用户空间，完成read操作<br>用户需要等待read将数据读取到buffer后，才继续处理接收的数据。整个I/O请求的过程中，用户线程是被阻塞的，这导致用户在发起IO请求时，不能做任何事情，对CPU的资源利用率不够<br>优点：程序简单，在阻塞等待数据期间进程/线程挂起，基本不会占用 CPU 资源<br>缺点：每个连接需要独立的进程/线程单独处理，当并发请求量大时为了维护程序，内存、线程切换开销较大，apache 的preforck使用的是这种模式。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">同步阻塞：程序向内核发送I/O请求后一直等待内核响应，如果内核处理请求的IO操作不能立即返回,则进程<br>将一直等待并不再接受新的请求，并由进程轮训查看I/O是否完成，完成后进程将I/O结果返回给Client，在IO没有返回期间进程不能接受其他客户的请求，而且是有进程自己去查看I/O是否完成，这种方式简单，但是比较慢，用的比较少。<br></code></pre></td></tr></table></figure><h5 id="1-3-2-2-非阻塞型-I-O-模型-nonblocking-IO"><a href="#1-3-2-2-非阻塞型-I-O-模型-nonblocking-IO" class="headerlink" title="1.3.2.2 非阻塞型 I/O 模型 (nonblocking IO)"></a>1.3.2.2 非阻塞型 I/O 模型 (nonblocking IO)</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce12.jpg"></p><p>用户线程发起IO请求时立即返回。但并未读取到任何数据，用户线程需要不断地发起IO请求，直到数据到达后，才真正读取到数据，继续执行。即 “轮询”机制存在两个问题：如果有大量文件描述符都要等，那么就得一个一个的read。这会带来大量的Context Switch（read是系统调用，每调用一次就得在用户态和核心态切换一次）。轮询的时间不好把握。这里是要猜多久之后数据才能到。等待时间设的太长，程序响应延迟就过大;设的太短，就会造成过于频繁的重试，干耗CPU而已，是比较浪费CPU的方式，一般很少直接使用这种模型，而是在其他IO模型中使用非阻塞IO这一特性。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">非阻塞：程序向内核发送请I/O求后一直等待内核响应，如果内核处理请求的IO操作不能立即返回IO结果，进程将不再等待，而且继续处理其他请求，但是仍然需要进程隔一段时间就要查看内核I/O是否完成。<br></code></pre></td></tr></table></figure><p>查看上图可知，在设置连接为非阻塞时，当应用进程系统调用 recvfrom 没有数据返回时，内核会立即返回一个 EWOULDBLOCK 错误，而不会一直阻塞到数据准备好。如上图在第四次调用时有一个数据报准备好了，所以这时数据会被复制到 应用进程缓冲区 ，于是 recvfrom 成功返回数据</p><p>当一个应用进程这样循环调用 recvfrom 时，称之为轮询 polling 。这么做往往会耗费大量CPU时间，实际使用很少</p><h5 id="1-3-2-3-多路复用-I-O-型-I-O-multiplexing"><a href="#1-3-2-3-多路复用-I-O-型-I-O-multiplexing" class="headerlink" title="1.3.2.3 多路复用 I/O 型(I/O multiplexing)"></a>1.3.2.3 多路复用 I/O 型(I/O multiplexing)</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce13.jpg"> </p><p>I/O multiplexing 主要包括:select，poll，epoll三种系统调用，select/poll/epoll的好处就在于单个<br>process就可以同时处理多个网络连接的IO。它的基本原理就是select/poll/epoll这个function会不断的轮询所负责的所有socket，当某个socket有数据到达了，就通知用户进程。<br>当用户进程调用了select，那么整个进程会被block，而同时，kernel会“监视”所有select负责的<br>socket，当任何一个socket中的数据准备好了，select就会返回。这个时候用户进程再调用read操作，将数据从kernel拷贝到用户进程。<br>Apache prefork是此模式的select，work是poll模式。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">IO多路复用（IO Multiplexing) ：是一种机制，程序注册一组socket文件描述符给操作系统，表示“我要监视这些fd是否有IO事件发生，有了就告诉程序处理”。<br>IO多路复用一般和NIO一起使用的。NIO和IO多路复用是相对独立的。NIO仅仅是指IO API总是能立刻返回，不会被Blocking;而IO多路复用仅仅是操作系统提供的一种便利的通知机制。操作系统并不会强制这俩必须得一起用，可以只用IO多路复用 + BIO，这时还是当前线程被卡住。IO多路复用和NIO是要配合一起使用才有实际意义。<br>IO多路复用是指内核一旦发现进程指定的一个或者多个IO条件准备读取，就通知该进程。<br>多个连接共用一个等待机制，本模型会阻塞进程，但是进程是阻塞在select或者poll这两个系统调用上，而不是阻塞在真正的IO操作上。<br>用户首先将需要进行IO操作添加到select中，同时等待select系统调用返回。当数据到达时，IO被激活，<br>select函数返回。用户线程正式发起<span class="hljs-built_in">read</span>请求，读取数据并继续执行。<br><br>从流程上来看，使用select函数进行IO请求和同步阻塞模型没有太大的区别，甚至还多了添加监视IO，以及调用select函数的额外操作，效率更差。并且阻塞了两次，但是第一次阻塞在select上时，select可以监控多个IO上是否已有IO操作准备就绪，即可达到在同一个线程内同时处理多个IO请求的目的。而不像阻塞IO那种，一次只能监控一个IO。<br>虽然上述方式允许单线程内处理多个IO请求，但是每个IO请求的过程还是阻塞的（在select函数上阻塞），平均时间甚至比同步阻塞IO模型还要长。如果用户线程只是注册自己需要的IO请求，然后去做自己的事情，等到数据到来时再进行处理，则可以提高CPU的利用率。<br>IO多路复用是最常使用的IO模型，但是其异步程度还不够“彻底”，因它使用了会阻塞线程的select系统调<br>用。因此IO多路复用只能称为异步阻塞IO模型，而非真正的异步IO。<br></code></pre></td></tr></table></figure><p>优缺点</p><ul><li>优点：可以基于一个阻塞对象，同时在多个描述符上等待就绪，而不是使用多个线程(每个文件描述符一个线程)，这样可以大大节省系统资源。</li><li>缺点：当连接数较少时效率相比多线程+阻塞 I/O 模型效率较低，可能延迟更大，因为单个连接处理需要 2 次系统调用，占用时间会有增加。</li></ul><p>IO多路复用适用如下场合：</p><ul><li>当客户端处理多个描述符时（一般是交互式输入和网络套接口），必须使用I/O复用。</li><li>当一个客户端同时处理多个套接字时，此情况可能的但很少出现。</li><li>当一个服务器既要处理监听套接字，又要处理已连接套接字，一般也要用到I/O复用。</li><li>当一个服务器即要处理TCP，又要处理UDP，一般要使用I/O复用。</li><li>当一个服务器要处理多个服务或多个协议，一般要使用I/O复用。</li></ul><h5 id="1-3-2-4-信号驱动式-I-O-模型-signal-driven-IO"><a href="#1-3-2-4-信号驱动式-I-O-模型-signal-driven-IO" class="headerlink" title="1.3.2.4 信号驱动式 I/O 模型 (signal-driven IO)"></a>1.3.2.4 信号驱动式 I/O 模型 (signal-driven IO)</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce14.jpg"></p><p>信号驱动I/O的意思就是我们现在不用傻等着了，也不用去轮询。而是让内核在数据就绪时，发送信号通知我们。</p><p>调用的步骤是，通过系统调用 sigaction ，并注册一个信号处理的回调函数，该调用会立即返回，然后主程序可以继续向下执行，当有I/O操作准备就绪,即内核数据就绪时，内核会为该进程产生一个SIGIO 信号，并回调注册的信号回调函数，这样就可以在信号回调函数中系统调用 recvfrom 获取数据,将用户进程所需要的数据从内核空间拷贝到用户空间此模型的优势在于等待数据报到达期间进程不被阻塞。用户主程序可以继续执行，只要等待来自信号处理函数的通知。</p><p>在信号驱动式 I/O 模型中，应用程序使用套接口进行信号驱动 I/O，并安装一个信号处理函数，进程继续运行并不阻塞。<br>当数据准备好时，进程会收到一个 SIGIO 信号，可以在信号处理函数中调用 I/O 操作函数处理数据。</p><p>优点：线程并没有在等待数据时被阻塞，内核直接返回调用接收信号，不影响进程继续处理其他请求因此可以提高资源的利用率。<br>缺点：信号 I/O 在大量 IO 操作时可能会因为信号队列溢出导致没法通知。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">异步阻塞：程序进程向内核发送IO调用后，不用等待内核响应，可以继续接受其他请求，内核收到进程请求后进行的IO如果不能立即返回，就由内核等待结果，直到IO完成后内核再通知进程，apache event是此模<br>式。<br></code></pre></td></tr></table></figure><h5 id="1-3-2-5-异步-I-O-模型-asynchronous-IO"><a href="#1-3-2-5-异步-I-O-模型-asynchronous-IO" class="headerlink" title="1.3.2.5 异步 I/O 模型 (asynchronous IO)"></a>1.3.2.5 异步 I/O 模型 (asynchronous IO)</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce15.jpg"></p><p>异步I/O 与 信号驱动I/O最大区别在于，信号驱动是内核通知我们何时开始一个I/O操作，而异步I/O是由内核通知我们I/O操作何时完成，两者有本质区别,相当于不用去饭店场吃饭，直接点个外卖，把等待上 菜的时间也给省了。</p><p>相对于同步I/O，异步I/O不是顺序执行。用户进程进行aio_read系统调用之后，无论内核数据是否准备 好，都会直接返回给用户进程，然后用户态进程可以去做别的事情。等到socket数据准备好了，内核直接复制数据给进程，然后从内核向进程发送通知。IO两个阶段，进程都是非阻塞的。</p><p>异步IO与信号驱动IO最主要的区别是信号驱动IO是由内核通知应用程序何时可以进行IO操作，而异步IO 则是由内核告诉用户线程IO操作何时完成。信号驱动IO当内核通知触发信号处理程序时，信号处理程序 还需要阻塞在从内核空间缓冲区拷贝数据到用户空间缓冲区这个阶段，而异步IO直接是在第二个阶段完成后，内核直接通知用户线程可以进行后续操作了。</p><p>优点：异步 I/O 能够充分利用DMA 特性，让 I/O操作与计算重叠。</p><p>缺点：要实现真正的异步 I/O，操作系统需要做大量的工作。目前 Windows下通过IOCP实现了真正的异步 I/O，在 Linux 系统下，Linux 2.6才引入，目前 AIO 并不完善，因此在 Linux 下实现高并发网络编程时以 IO 复用模型模式+多线程任务的架构基本可以满足需求。</p><p>Linux提供了AIO库函数实现异步，但是用的很少。目前有很多开源的异步IO库，例如libevent、libev、libuv。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">异步非阻塞：程序进程向内核发送IO调用后，不用等待内核响应，可以继续接受其他请求，内核调用的IO如果不能立即返回，内核会继续处理其他事物，直到IO完成后将结果通知给内核，内核在将IO完成的结果返回给进程，期间进程可以接受新的请求，内核也可以处理新的事物，因此相互不影响，可以实现较大的同时并实现较高的IO复用，因此异步非阻塞使用最多的一种通信方式。<br></code></pre></td></tr></table></figure><h4 id="1-3-3-五种-IO-对比"><a href="#1-3-3-五种-IO-对比" class="headerlink" title="1.3.3  五种 IO 对比"></a>1.3.3  五种 IO 对比</h4><p>这五种 I/O 模型中，越往后，阻塞越少，理论上效率也是最优前四种属于同步 I/O，因为其中真正的I/O 操作(recvfrom)将阻塞进程/线程，只有异步 I/O 模型才与 POSIX 定义的异步 I/O 相匹配。</p><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce16.jpg"></p><h4 id="1-3-4-I-O-的具体实现方式"><a href="#1-3-4-I-O-的具体实现方式" class="headerlink" title="1.3.4  I/O 的具体实现方式"></a>1.3.4  I/O 的具体实现方式</h4><h5 id="1-3-4-1-I-O常见实现"><a href="#1-3-4-1-I-O常见实现" class="headerlink" title="1.3.4.1  I/O常见实现"></a>1.3.4.1  I/O常见实现</h5><p>Nginx支持在多种不同的操作系统实现不同的事件驱动模型，但是其在不同的操作系统甚至是不同的系  统版本上面的实现方式不尽相同，主要有以下实现方式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">1、select：<br>select库是在linux和windows平台都基本支持的  事件驱动模型库，并且在接口的定义也基本相同，只是部分参数的含义略有差异，最大并发限制1024，是最早期的事件驱动模型。<br><br>2、poll：<br>在Linux的基本驱动模型，windows不支持此驱动模型，是select的升级版，取消了最大的并发限制，在编译nginx的时候可以使用--with-poll_module和--without-poll_module这两个指定是否编译select库。<br><br>3、epoll：<br>epoll是库是Nginx服务器支持的最高性能的事件驱动库之一，是公认的非常优秀的事件驱动模型，它和select和poll有很大的区别，epoll是poll的升级版，但是与poll有很大的区别。<br>epoll的处理方式是创建一个待处理的事件列表，然后把这个列表发给内核，返回的时候在去轮训检查这个  表，以判断事件是否发生，epoll支持一个进程打开的最大事件描述符的上限是系统可以打开的文件的最大  数，同时epoll库的I/O效率不随描述符数目增加而线性下降，因为它只会对内核上报的“活跃”的描述符进行操作。<br>4、rtsig：<br>不是一个常用事件驱动，最大队列1024，不是很常用<br><br>5、kqueue：<br>用于支持BSD系列平台的高校事件驱动模型，主要用在FreeBSD 4.1及以上版本、OpenBSD 2.0级以上版本，NetBSD级以上版本及Mac OS X 平台上，该模型也是poll库的变种，因此和epoll没有本质上的区别， 都是通过避免轮训操作提供效率。<br><br>6、/dev/poll:<br>用于支持unix衍生平台的高效事件驱动模型，主要在Solaris 平台、HP/UX，该模型是sun公司在开发Solaris系列平台的时候提出的用于完成事件驱动机制的方案，它使用了虚拟的/dev/poll设备，开发人员  将要见识的文件描述符加入这个设备，然后通过ioctl()调用来获取事件通知，因此运行在以上系列平台的时候请使用/dev/poll事件驱动机制。<br><br>7、eventport：<br>该方案也是sun公司在开发Solaris的时候提出的事件驱动库，只是Solaris  10以上的版本，该驱动库看防止内核崩溃等情况的发生。<br><br>8、Iocp：<br>Windows系统上的实现方式，对应第5种（异步I/O）模型。<br></code></pre></td></tr></table></figure><h5 id="1-3-1-1-常用I-O模型比较"><a href="#1-3-1-1-常用I-O模型比较" class="headerlink" title="1.3.1.1  常用I/O模型比较"></a>1.3.1.1  常用I/O模型比较</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce17.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">Select：<br>POSIX所规定，目前几乎在所有的平台上支持，其良好跨平台支持也是它的一个优点，本质上是通过设置或者检查存放fd标志位的数据结构来进行下一步处理。<br>缺点<br>单个进程能够监视的文件描述符的数量存在最大限制，在Linux上一般为1024，可以通过修改宏定义FD_SETSIZE，再重新编译内核实现，但是这样也会造成效率的降低。<br>单个进程可监视的fd数量被限制，默认是1024，修改此值需要重新编译内核。<br>对socket是线性扫描，即采用轮询的方法，效率较低。<br>select 采取了内存拷贝方法来实现内核将 FD 消息通知给用户空间，这样一个用来存放大量fd的数据结<br>构，这样会使得用户空间和内核空间在传递该结构时复制开销大。<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">poll：<br>本质上和select没有区别，它将用户传入的数组拷贝到内核空间，然后查询每个fd对应的设备状态。<br>其没有最大连接数的限制，原因是它是基于链表来存储的。<br>大量的fd的数组被整体复制于用户态和内核地址空间之间，而不管这样的复制是不是有意义。<br>poll特点是“水平触发”，如果报告了fd后，没有被处理，那么下次poll时会再次报告该fd。<br>select是边缘触发即只通知一次。<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">epoll：<br>在Linux 2.6内核中提出的select和poll的增强版本。<br>支持水平触发LT和边缘触发ET，最大的特点在于边缘触发，它只告诉进程哪些fd刚刚变为就需态，并且只会<br>通知一次。<br>使用“事件”的就绪通知方式，通过epoll_ctl注册fd，一旦该fd就绪，内核就会采用类似callback的回调机制来激活该fd，epoll_wait便可以收到通知。<br>优点:<br>没有最大并发连接的限制：能打开的FD的上限远大于1024(1G的内存能监听约10万个端口)，具体查<br>看/proc/sys/fs/file-max，此值和系统内存大小相关。<br>效率提升：非轮询的方式，不会随着FD数目的增加而效率下降;只有活跃可用的FD才会调用callback函数，<br>即epoll最大的优点就在于它只管理“活跃”的连接，而跟连接总数无关。<br>内存拷贝，利用mmap(Memory Mapping)加速与内核空间的消息传递;即epoll使用mmap减少复制开销。<br></code></pre></td></tr></table></figure><p>范例: 最大并发连接数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#内存1G</span><br>free -h<br>              total        used        free      shared  buff/cache   available<br>Mem:           976M        490M        145M        6.7M        339M        307M<br>Swap:          1.5G          0B        1.5G<br>cat /proc/sys/fs/file-max<br>96105<br><br><span class="hljs-comment">#内存2G</span><br>free -h<br>      total    used    free   shared buff/cache  available<br>Mem:      1.9Gi    258Mi    1.3Gi    12Mi    341Mi    1.6Gi<br>Swap:     2.0Gi     0B    2.0Gi<br>cat /proc/sys/fs/file-max<br>195920<br></code></pre></td></tr></table></figure><p>范例: 内核限制</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep -R FD_SETSIZE linux-5.8/*<br>linux-5.8/Documentation/userspace-api/media/v4l/func-select.rst: <br> ``FD_SETSIZE``.<br>linux-5.8/include/uapi/linux/posix_types.h:<span class="hljs-comment">#undef __FD_SETSIZE</span><br>linux-5.8/include/uapi/linux/posix_types.h:<span class="hljs-comment">#define __FD_SETSIZE 1024 #单个进程能够监视的文件描述符的文件最大数量</span><br>linux-5.8/include/uapi/linux/posix_types.h: unsigned long fds_bits[__FD_SETSIZE<br>/ (8 * sizeof(long))];<br>linux-5.8/tools/include/nolibc/nolibc.h:<span class="hljs-comment">#define FD_SETSIZE 256</span><br>linux-5.8/tools/include/nolibc/nolibc.h:typedef struct &#123; uint32_t<br>fd32[FD_SETSIZE/32]; &#125; fd_set;<br>linux-5.8/tools/include/nolibc/nolibc.h: <span class="hljs-keyword">if</span> (fd &lt; 0 || fd &gt;= FD_SETSIZE)<br>linux-5.8/tools/testing/selftests/net/nettest.c: rc = select(FD_SETSIZE,<br>NULL, &amp;wfd, NULL, tv);<br></code></pre></td></tr></table></figure><p>范例: select 和epoll 帮助</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">whatis epoll<br>epoll (7)       - I/O event notification facility<br><br>whatis select<br>select (2)      - synchronous I/O multiplexing<br>select (3)      - synchronous I/O multiplexing<br>select (3p)      - synchronous I/O multiplexing<br><br>whatis poll<br>poll (2)       - <span class="hljs-built_in">wait</span> <span class="hljs-keyword">for</span> some event on a file descriptor<br>poll (3p)       - input/output multiplexing<br><br>man 2 select<br>SELECT(2)                        Linux Programmer<span class="hljs-string">&#x27;s</span><br><span class="hljs-string">Manual                        SELECT(2)</span><br><span class="hljs-string">NAME</span><br><span class="hljs-string">   select, pselect, FD_CLR, FD_ISSET, FD_SET, FD_ZERO - synchronous I/O</span><br><span class="hljs-string">multiplexing</span><br><span class="hljs-string"></span><br><span class="hljs-string">man 2 poll</span><br><span class="hljs-string">POLL(2)                         Linux Programmer&#x27;</span>s<br>Manual                         POLL(2)<br>NAME<br>   poll, ppoll - <span class="hljs-built_in">wait</span> <span class="hljs-keyword">for</span> some event on a file descriptor<br></code></pre></td></tr></table></figure><h3 id="1-4-零拷贝"><a href="#1-4-零拷贝" class="headerlink" title="1.4 零拷贝"></a>1.4 零拷贝</h3><h4 id="1-4-1-零拷贝介绍"><a href="#1-4-1-零拷贝介绍" class="headerlink" title="1.4.1 零拷贝介绍"></a>1.4.1 零拷贝介绍</h4><h5 id="1-4-1-1-传统-Linux中-I-O-的问题"><a href="#1-4-1-1-传统-Linux中-I-O-的问题" class="headerlink" title="1.4.1.1 传统 Linux中 I/O 的问题"></a>1.4.1.1 传统 Linux中 I/O 的问题</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce18.jpg"></p><p>传统的 Linux 系统的标准 I/O 接口（read、write）是基于数据拷贝的，也就是数据都是 copy_to_user或者 copy_from_user，这样做的好处是，通过中间缓存的机制，减少磁盘 I/O 的操作，但是坏处也很明显，大量数据的拷贝，用户态和内核态的频繁切换，会消耗大量的 CPU 资源，严重影响数据传输的性能，统计表明，在Linux协议栈中，数据包在内核态和用户态之间的拷贝所用的时间甚至占到了数据包整个处理流程时间的57.1%。</p><h5 id="1-4-1-2-什么是零拷贝"><a href="#1-4-1-2-什么是零拷贝" class="headerlink" title="1.4.1.2 什么是零拷贝"></a>1.4.1.2 什么是零拷贝</h5><p>零拷贝就是上述问题的一个解决方案，通过尽量避免拷贝操作来缓解 CPU 的压力。零拷贝并没有真正做到“0”拷贝，它更多是一种思想，很多的零拷贝技术都是基于这个思想去做的优化。</p><h4 id="1-4-2-零拷页相关技术"><a href="#1-4-2-零拷页相关技术" class="headerlink" title="1.4.2 零拷页相关技术"></a>1.4.2 零拷页相关技术</h4><h5 id="1-4-2-1-MMAP-Memory-Mapping"><a href="#1-4-2-1-MMAP-Memory-Mapping" class="headerlink" title="1.4.2.1 MMAP ( Memory Mapping )"></a>1.4.2.1 MMAP ( Memory Mapping )</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce19.jpg"></p><p>mmap()系统调用使得进程之间通过映射同一个普通文件实现共享内存。普通文件被映射到进程地址空间后，进程可以向访问普通内存一样对文件进行访问。</p><p>mmap是一种内存映射文件的方法，即将一个文件或者其它对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间中一段虚拟地址的一一对映关系。</p><p>实现这样的映射关系后，进程就可以采用指针的方式读写操作这一段内存，而系统会自动回写脏页面到对应的文件磁盘上，即完成了对文件的操作而不必再调用read,write等系统调用函数。相反，内核空间对这段区域的修改也直接反映用户空间，从而可以实现不同进程间的文件共享。</p><p>内存映射减少数据在用户空间和内核空间之间的拷贝操作,适合大量数据传输。</p><h5 id="1-4-2-2-SENDFILE"><a href="#1-4-2-2-SENDFILE" class="headerlink" title="1.4.2.2 SENDFILE"></a>1.4.2.2 SENDFILE</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce20.jpg"></p><h5 id="1-4-2-3-DMA-辅助的-SENDFILE"><a href="#1-4-2-3-DMA-辅助的-SENDFILE" class="headerlink" title="1.4.2.3 DMA 辅助的 SENDFILE"></a>1.4.2.3 DMA 辅助的 SENDFILE</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce21.jpg"></p>]]></content>
    
    
    
    <tags>
      
      <tag>Linux Nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
