

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>Devops之基于Jenkins的CI与CD - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Devops之基于Jenkins的CI与CD">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-05-24 06:02" pubdate>
        2021年5月24日 早上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      36.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      592
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Devops之基于Jenkins的CI与CD</h1>
            
            <div class="markdown-body">
              <h1 id="Devops之基于Jenkins的CI与CD"><a href="#Devops之基于Jenkins的CI与CD" class="headerlink" title="Devops之基于Jenkins的CI与CD"></a>Devops之基于Jenkins的CI与CD</h1><h1 id="一、DevOps简介"><a href="#一、DevOps简介" class="headerlink" title="一、DevOps简介"></a>一、DevOps简介</h1><p><a target="_blank" rel="noopener" href="https://www.bagevent.com/event/6243820?bag_track=bagevent">https://www.bagevent.com/event/6243820?bag_track=bagevent</a> #Gdevops2020<br><a target="_blank" rel="noopener" href="https://www.bagevent.com/event/DevOpsDays-SH">https://www.bagevent.com/event/DevOpsDays-SH</a> #DevOpsDays 2019</p>
<p>DevOps 是 Development 和 Operations 的组合，也就是开发和运维的简写。</p>
<p>DevOps 是针对企业中的研发人员、运维人员和测试人员的工作理念，是他们在应用开发、代码部署和质量测试等整条生命周期中协作和沟通的最佳实践，</p>
<p>DevOps 强调整个组织的合作以及交付和基础设施变更的自动化、从而实现持续集成、持续部署和持续交付。</p>
<p>DevOps 四大平台：代码托管(gitlab/svn)、项目管理(jira)、运维平台(腾讯蓝鲸/开源平台)、持续交付(Jenkins/gitlab)</p>
<h2 id="1-1-什么是DevOps"><a href="#1-1-什么是DevOps" class="headerlink" title="1.1 什么是DevOps"></a>1.1 什么是DevOps</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-1.png" srcset="/blog/img/loading.gif"></p>
<h2 id="1-2-为什么要推广-DevOps-？"><a href="#1-2-为什么要推广-DevOps-？" class="headerlink" title="1.2 为什么要推广 DevOps ？"></a>1.2 为什么要推广 DevOps ？</h2><p>DevOps 强调团队协作、相互协助、持续发展，然而传统的模式是开发人员只顾开发程序，运维只负责基础环境管理和代码部署及监控等，其并不是为了一个共同的目标而共同实现最终的目的，而 DevOps 则实现团队作战，即无论是开发、运维还是测试，都为了最终的代码发布，持续部署和业务稳定而付出各自的努力，从而实现产品设计、开发、测试和部署的良性循环，实现产品的最终持续交付。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-2.png" srcset="/blog/img/loading.gif"></p>
<h2 id="1-3-传统技术团队"><a href="#1-3-传统技术团队" class="headerlink" title="1.3 传统技术团队"></a>1.3 传统技术团队</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-3.png" srcset="/blog/img/loading.gif"></p>
<h2 id="1-4-DevOps技术团队"><a href="#1-4-DevOps技术团队" class="headerlink" title="1.4 DevOps技术团队"></a>1.4 DevOps技术团队</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-4.png" srcset="/blog/img/loading.gif"></p>
<h2 id="1-5-什么是持续集成-CI-Continuous-integration"><a href="#1-5-什么是持续集成-CI-Continuous-integration" class="headerlink" title="1.5 什么是持续集成 (CI- - Continuous integration)"></a>1.5 什么是持续集成 (CI- - Continuous integration)</h2><p>持续集成是指多名开发者在开发不同功能代码的过程当中，可以频繁的将代码行合并到一起并切相互不影响工作。</p>
<h2 id="1-6-什么是持续部署-CD-continuous-deployment"><a href="#1-6-什么是持续部署-CD-continuous-deployment" class="headerlink" title="1.6 什么是持续部署( CD- - continuous deployment)"></a>1.6 什么是持续部署( CD- - continuous deployment)</h2><p>是基于某种工具或平台实现代码自动化的构建、测试和部署到线上环境以实现交付高质量的产品,持续部署在某种程度上代表了一个开发团队的更新迭代速率。</p>
<h2 id="1-7-什么是持续交付-Continuous-Delivery"><a href="#1-7-什么是持续交付-Continuous-Delivery" class="headerlink" title="1.7 什么是持续交付( Continuous Delivery)"></a>1.7 什么是持续交付( Continuous Delivery)</h2><p>持续交付是在持续部署的基础之上，将产品交付到线上环境，因此持续交付是产品价值的一种交付，是产品价值的一种盈利的实现。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-5.png" srcset="/blog/img/loading.gif"></p>
<h2 id="1-8-常见的部署方式"><a href="#1-8-常见的部署方式" class="headerlink" title="1.8 常见的部署方式"></a>1.8 常见的部署方式</h2><p>开发自己上传–最原始的方案</p>
<p>开发给运维手动上传–运维自己手动部署</p>
<p>运维使用脚本复制–半自动化</p>
<p>结合 web 界面一键部署–自动化</p>
<h2 id="1-9-常见的持续集成开源工具"><a href="#1-9-常见的持续集成开源工具" class="headerlink" title="1.9 常见的持续集成开源工具"></a>1.9 常见的持续集成开源工具</h2><p>在公司的服务器安装某种程序，该程序用于按照特定格式和方式记录和保存公司多名开发人员不定期提交的源代码，且后期可以按照某种标记及方式对用户提交的数据进行还原。</p>
<h3 id="1-9-1-CVS-Concurrent-Version-System"><a href="#1-9-1-CVS-Concurrent-Version-System" class="headerlink" title="1.9.1 CVS(Concurrent Version System)"></a>1.9.1 CVS(Concurrent Version System)</h3><p>早期的集中式版本控制系统，现已基本淘汰</p>
<p>会出现数据提交后不完整的情况</p>
<h3 id="1-9-2-SVN-Subversion-–集中式版本控制系统"><a href="#1-9-2-SVN-Subversion-–集中式版本控制系统" class="headerlink" title="1.9.2 SVN(Subversion)–集中式版本控制系统"></a>1.9.2 SVN(Subversion)–集中式版本控制系统</h3><p>2000 年开始开发，目标就是替代 CVS 集中式管理，依赖于网络，一台服务器集中管理目前依然有部分公司在使用</p>
<h3 id="1-9-3-Gitlib—分布式版本控制系统"><a href="#1-9-3-Gitlib—分布式版本控制系统" class="headerlink" title="1.9.3 Gitlib—分布式版本控制系统"></a>1.9.3 Gitlib—分布式版本控制系统</h3><p>Linus 在 1991 年创建了开源的 Linux 内核，从此 Linux 便不断快速发展，不过 Linux 的壮大是离不开全世界的开发者的参与，这么多人在世界各地为 Linux 编写代码，那Linux 内核的代码是如何管理的呢？事实是，在 2002 年以前，世界各地的志愿者把源代码文件通过 diff 的方式发给 Linus，然后由 Linus 本人通过手工方式合并代码！你也许会想，为什么 Linus 不把 Linux 代码放到版本控制系统里呢？不是有 CVS、SVN 这些免费的版本控制系统吗？因为 Linus 坚定地反对 CVS 和 SVN，这些集中式的版本控制系统不但速度慢，且必须联网才能使用，但是也有一些商用的版本控制系统，虽然比CVS、SVN 好用，但那是付费的，和 Linux 的开源精神不符,不过，到了 2002 年，Linux 系统已经发展了十年了，代码库之大让 Linus 很难继续通过手工方式管理了，社区的弟兄们也对这种方式表达了强烈不满，于是 Linus 选择了一个商业的版本控制系统BitKeeper，BitKeeper 的东家 BitMover 公司出于人道主义精神，授权 Linux 社区免费使用这个版本控制系统，但是安定团结的大好局面在 2005 年就被打破了，原因是 Linux 社区牛人聚集，不免沾染了一些梁山好汉的江湖习气，开发 Samba 的 Andrew 试图破解 BitKeeper 的协议（这么干的其实也不只他一个），被 BitMover 公司发现了（监控工作做得不错！），于是 BitMover 公司怒了，要收回 Linux 社区的免费使用权，这时候其实 Linus 可以向 BitMover 公司道个歉，保证以后严格管教弟兄们，但这是不可能的，而且实际情况是 Linus 自己花了两周时间自己用C写了一个分布式版本控制系统， 这就是 Git！一个月之内，Linux 内核的源码已经由 Git 管理了！牛是怎么定义的呢？ 大家可以体会一下,然后Git迅速成为最流行的分布式版本控制系统，尤其是2008 年， GitHub 网站上线了，它为开源项目免费提供Git 存储，无数开源项目开始迁移至GitHub， 包括 jQuery，PHP，Ruby 等等。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-6.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-7.png" srcset="/blog/img/loading.gif"></p>
<h2 id="1-10-版本控制系统分类"><a href="#1-10-版本控制系统分类" class="headerlink" title="1.10 版本控制系统分类"></a>1.10 版本控制系统分类</h2><h3 id="1-10-1-集中式版本控制系统"><a href="#1-10-1-集中式版本控制系统" class="headerlink" title="1.10.1 集中式版本控制系统"></a>1.10.1 集中式版本控制系统</h3><p>任何的提交和回滚都依赖于连接服务器 SVN 服务器是单点</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-8.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-10-2-分布式版本控制系统"><a href="#1-10-2-分布式版本控制系统" class="headerlink" title="1.10.2 分布式版本控制系统"></a>1.10.2 分布式版本控制系统</h3><p>Git 在每个用户都有一个完整的服务器，然后在有一个中央服务器，用户可以先将代码提交到本地，没有网络也可以先提交到本地，然后在有网络的时候再提交到中央服务器，这样就大大方便了开发者的代码提交和回滚，而相比 CVS 和 SVN 都是集中式的版本控制系统，工作的时候需要先从中央服务器获取最新的代码，改完之后需要提交，如果是一个比较大的文件则需要足够快的网络才能快速提交完成，而使用分布式的版本控制系统，每个用户都是一个完整的版本库，即使没有中央服务器也可以提交代码或者回滚，最终再把改好的代码提交至中央服务器进行合并即可。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-9.png" srcset="/blog/img/loading.gif"></p>
<h1 id="二、Gitlab部署与使用"><a href="#二、Gitlab部署与使用" class="headerlink" title="二、Gitlab部署与使用"></a>二、Gitlab部署与使用</h1><p><a target="_blank" rel="noopener" href="https://about.gitlab.com/install/">https://about.gitlab.com/install/</a> # Gitlab 服务的安装文档</p>
<p><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ce/install/requirements.html">https://docs.gitlab.com/ce/install/requirements.html</a> #安装环境要求</p>
<h2 id="2-1-下载署并部署-gitlab"><a href="#2-1-下载署并部署-gitlab" class="headerlink" title="2.1 下载署并部署 gitlab"></a>2.1 下载署并部署 gitlab</h2><p>硬件配置：</p>
<p>CPU：4C（小公司），8C（大公司）</p>
<p>内存：16G（小公司），32G（大公司）</p>
<p>硬盘：</p>
<p>​           本地硬盘：IO要快（使用RAID 10），空间要大，最好使用NAS（创建一个2T卷）</p>
<h3 id="2-1-1-Ubuntu-系统环境准备"><a href="#2-1-1-Ubuntu-系统环境准备" class="headerlink" title="2.1.1 Ubuntu 系统环境准备"></a>2.1.1 Ubuntu 系统环境准备</h3><h4 id="2-1-1-1-Ubuntu-系统环境准备Ubuntu-系统环境准备"><a href="#2-1-1-1-Ubuntu-系统环境准备Ubuntu-系统环境准备" class="headerlink" title="2.1.1.1 Ubuntu 系统环境准备Ubuntu 系统环境准备"></a>2.1.1.1 Ubuntu 系统环境准备Ubuntu 系统环境准备</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#连接root</span><br><span class="hljs-comment">#更改密码</span><br>root@ubuntu:~<span class="hljs-comment"># passwd</span><br>Enter new UNIX password:<br>Retype new UNIX password:<br>passwd: password updated successfully<br><br>root@ubuntu:~<span class="hljs-comment"># vim /etc/ssh/sshd_config</span><br>PermitRootLogin yes<br>PasswordAuthentication yes<br></code></pre></td></tr></table></figure>

<h4 id="2-1-1-2-配置-ubuntu-网卡和主机名"><a href="#2-1-1-2-配置-ubuntu-网卡和主机名" class="headerlink" title="2.1.1.2 配置 ubuntu 网卡和主机名"></a>2.1.1.2 配置 ubuntu 网卡和主机名</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@ubuntu:~<span class="hljs-comment"># cat /etc/netplan/01-netcfg.yaml</span><br><span class="hljs-comment"># This file describes the network interfaces available on your system</span><br><span class="hljs-comment"># For more information, see netplan(5).</span><br>network:<br>  version: 2<br>  renderer: networkd<br>  ethernets:<br>    eth0:<br>      dhcp4: no<br>      addresses: [192.168.8.2/21]<br>      gateway4: 192.168.15.254<br>      nameservers:<br>        addresses: [192.168.15.254]<br>root@ubuntu:~<span class="hljs-comment"># cat /etc/hostname</span><br>jenkins.example.com<br>root@ubuntu:~<span class="hljs-comment"># reboot</span><br></code></pre></td></tr></table></figure>

<h4 id="2-1-1-3-配置-ubuntu-仓库"><a href="#2-1-1-3-配置-ubuntu-仓库" class="headerlink" title="2.1.1.3 配置 ubuntu 仓库"></a>2.1.1.3 配置 ubuntu 仓库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#配置apt源</span><br>root@ubuntu:~<span class="hljs-comment">#vim /etc/apt/sources.list</span><br>deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse<br>deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse<br>deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse<br>deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse<br>deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse<br><br><span class="hljs-comment">#更新apt</span><br>root@jenkins:~<span class="hljs-comment"># apt update</span><br><br><span class="hljs-comment">#安装必要的工具</span><br>root@jenkins:~<span class="hljs-comment"># apt install -y iproute2 ntpdate tcpdump telnet traceroute nfs-kernel-server nfs-common lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev ntpdate tcpdump telnet traceroute gcc openssh-server lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev ntpdate tcpdump telnet traceroute iotop unzip zip ipmitool</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-10.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-1-2-Centos-系统环境在准备"><a href="#2-1-2-Centos-系统环境在准备" class="headerlink" title="2.1.2 Centos 系统环境在准备"></a>2.1.2 Centos 系统环境在准备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#最小化服务器安装，配置如下</span><br>[root@centos7 ~]<span class="hljs-comment"># yum install vim gcc gcc-c++ wget net-tools lrzsz iotop lsof iotop bash-completion -y</span><br>[root@centos7 ~]<span class="hljs-comment"># yum install curl policycoreutils openssh-server openssh-clients postfix -y</span><br>[root@centos7 ~]<span class="hljs-comment"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br>[root@centos7 ~]<span class="hljs-comment"># systemctl disable firewalld</span><br>[root@centos7 ~]<span class="hljs-comment"># sed -i &#x27;/SELINUX/s/enforcing/disabled/&#x27; /etc/sysconfig/selinux</span><br>[root@centos7 ~]<span class="hljs-comment"># hostnamectl set-hostname gitlab.example.com</span><br>[root@centos7 ~]<span class="hljs-comment"># reboot</span><br></code></pre></td></tr></table></figure>

<h3 id="2-1-3-gitlab-安装及使用"><a href="#2-1-3-gitlab-安装及使用" class="headerlink" title="2.1.3 gitlab 安装及使用"></a>2.1.3 gitlab 安装及使用</h3><p>安装包下载地址：<a target="_blank" rel="noopener" href="https://packages.gitlab.com/gitlab/gitlab-ce">https://packages.gitlab.com/gitlab/gitlab-ce</a></p>
<p>rpm 包国内下载地址：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/</a></p>
<p>ubuntu 国内下载地址：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu/pool/">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu/pool/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#Ubuntu安装</span><br>root@gitlab:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment">#下载 gitlabdeb包</span><br>root@gitlab:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># dpkg -i gitlab-ce_11.11.8-ce.0_amd64.deb</span><br><span class="hljs-comment">#下面为安装完成的模样</span><br>(Reading database ... 71502 files and directories currently installed.)<br>Preparing to unpack gitlab-ce_11.11.8-ce.0_amd64.deb ...<br>gitlab preinstall: <br>gitlab preinstall: This node does not appear to be running a database<br>gitlab preinstall: Skipping version check, <span class="hljs-keyword">if</span> you think this is an error <span class="hljs-built_in">exit</span> now<br>gitlab preinstall: <br>Unpacking gitlab-ce (11.11.8-ce.0) over (11.11.8-ce.0) ...<br>Setting up gitlab-ce (11.11.8-ce.0) ...<br><br>gitlab: GitLab now ships with a newer version of PostgreSQL (10.7), but it is not yet<br>gitlab: enabled by default. To upgrade, RUN THE FOLLOWING COMMAND:<br><br>sudo gitlab-ctl pg-upgrade<br><br>gitlab: Note: This <span class="hljs-built_in">command</span> does not support Geo instances yet. So we don<span class="hljs-string">&#x27;t</span><br><span class="hljs-string">gitlab: recommend running this command on Geo nodes. It will be supported</span><br><span class="hljs-string">gitlab: in GitLab 12.0.</span><br><span class="hljs-string"></span><br><span class="hljs-string">gitlab: For more details, please see:</span><br><span class="hljs-string">gitlab: https://docs.gitlab.com/omnibus/settings/database.html#upgrade-packaged-postgresql-server</span><br><span class="hljs-string">gitlab: </span><br><span class="hljs-string">It looks like GitLab has not been configured yet; skipping the upgrade script.</span><br><span class="hljs-string"></span><br><span class="hljs-string">       *.                  *.</span><br><span class="hljs-string">      ***                 ***</span><br><span class="hljs-string">     *****               *****</span><br><span class="hljs-string">    .******             *******</span><br><span class="hljs-string">    ********            ********</span><br><span class="hljs-string">   ,,,,,,,,,***********,,,,,,,,,</span><br><span class="hljs-string">  ,,,,,,,,,,,*********,,,,,,,,,,,</span><br><span class="hljs-string">  .,,,,,,,,,,,*******,,,,,,,,,,,,</span><br><span class="hljs-string">      ,,,,,,,,,*****,,,,,,,,,.</span><br><span class="hljs-string">         ,,,,,,,****,,,,,,</span><br><span class="hljs-string">            .,,,***,,,,</span><br><span class="hljs-string">                ,*,.</span><br><span class="hljs-string">  </span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">     _______ __  __          __</span><br><span class="hljs-string">    / ____(_) /_/ /   ____ _/ /_</span><br><span class="hljs-string">   / / __/ / __/ /   / __ `/ __ \</span><br><span class="hljs-string">  / /_/ / / /_/ /___/ /_/ / /_/ /</span><br><span class="hljs-string">  \____/_/\__/_____/\__,_/_.___/</span><br><span class="hljs-string">  </span><br><span class="hljs-string"></span><br><span class="hljs-string">Thank you for installing GitLab!</span><br><span class="hljs-string">GitLab was unable to detect a valid hostname for your instance.</span><br><span class="hljs-string">Please configure a URL for your GitLab instance by setting `external_url`</span><br><span class="hljs-string">configuration in /etc/gitlab/gitlab.rb file.</span><br><span class="hljs-string">Then, you can start your GitLab instance by running the following command:</span><br><span class="hljs-string">  sudo gitlab-ctl reconfigure</span><br><span class="hljs-string"></span><br><span class="hljs-string">For a comprehensive list of configuration options please see the Omnibus GitLab readme</span><br><span class="hljs-string">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md</span><br><span class="hljs-string"></span><br><span class="hljs-string">#Centos安装</span><br><span class="hljs-string">。。。。。。。</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-11.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-1-gitlab-配置使用"><a href="#2-1-3-1-gitlab-配置使用" class="headerlink" title="2.1.3.1 gitlab 配置使用"></a>2.1.3.1 gitlab 配置使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># vim /etc/gitlab/gitlab.rb</span><br>（修改一下配置）<br>external_url <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span><br><span class="hljs-comment">#可选邮件通知设置</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_enable&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_address&#x27;</span>] = <span class="hljs-string">&quot;smtp.qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_port&#x27;</span>] = 465<br>gitlab_rails[<span class="hljs-string">&#x27;smtp_user_name&#x27;</span>] = <span class="hljs-string">&quot;346636558@qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_password&#x27;</span>] = <span class="hljs-string">&quot;olvjldsvshrlbgjc&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_domain&#x27;</span>] = <span class="hljs-string">&quot;qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_authentication&#x27;</span>] = :login<br>gitlab_rails[<span class="hljs-string">&#x27;smtp_enable_starttls_auto&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_tls&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;gitlab_email_from&#x27;</span>] = <span class="hljs-string">&quot;346636558@qq.com&quot;</span><br><span class="hljs-comment">#user[&quot;git_user_email&quot;] = &quot;346636558@qq.com&quot;</span><br><br>root@gitlab:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># grep &quot;^[a-Z]&quot; /etc/gitlab/gitlab.rb</span><br>external_url <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_enable&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_address&#x27;</span>] = <span class="hljs-string">&quot;smtp.qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_port&#x27;</span>] = 465<br>gitlab_rails[<span class="hljs-string">&#x27;smtp_user_name&#x27;</span>] = <span class="hljs-string">&quot;346636558@qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_password&#x27;</span>] = <span class="hljs-string">&quot;olvjldsvshrlbgjc&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_domain&#x27;</span>] = <span class="hljs-string">&quot;qq.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_authentication&#x27;</span>] = :login<br>gitlab_rails[<span class="hljs-string">&#x27;smtp_enable_starttls_auto&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;gitlab_email_from&#x27;</span>] = <span class="hljs-string">&quot;346636558@qq.com&quot;</span><br><br><span class="hljs-comment">#使用smtp邮件的前提是能ping通smtp.qq.com</span><br>root@gitlab:~<span class="hljs-comment"># ping smtp.qq.com</span><br>PING smtp.qq.com (183.3.225.42) 56(84) bytes of data.<br>64 bytes from 183.3.225.42 (183.3.225.42): icmp_seq=1 ttl=128 time=24.9 ms<br>64 bytes from 183.3.225.42 (183.3.225.42): icmp_seq=2 ttl=128 time=22.2 ms<br>^C<br>--- smtp.qq.com ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1001ms<br>rtt min/avg/max/mdev = 22.200/23.566/24.933/1.375 ms<br></code></pre></td></tr></table></figure>

<h4 id="2-1-3-2-初始化服务"><a href="#2-1-3-2-初始化服务" class="headerlink" title="2.1.3.2  初始化服务"></a>2.1.3.2  初始化服务</h4><p>执行配置并启动服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># gitlab-ctl reconfigure #修改完配置文件要执行此操作</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-12.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#gitlab 相关的目录有哪些：</span><br>(以下目录都不能动)<br>/etc/gitlab <span class="hljs-comment">#配置文件目录</span><br>/run/gitlab <span class="hljs-comment">#运行 pid 目录</span><br>/opt/gitlab <span class="hljs-comment">#安装目录</span><br>/var/opt/gitlab <span class="hljs-comment">#数据目录</span><br>/var/<span class="hljs-built_in">log</span>/gitlab <span class="hljs-comment">#日志目录</span><br></code></pre></td></tr></table></figure>

<h4 id="2-1-3-3-常用命令"><a href="#2-1-3-3-常用命令" class="headerlink" title="2.1.3.3  常用命令"></a>2.1.3.3  常用命令</h4><p>gitlab-rails #用于启动控制台进行特殊操作，比如修改管理员密码、打开数据库控制台( gitlab-rails dbconsole)等</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:~<span class="hljs-comment"># gitlab-rails dbconsole</span><br>psql (9.6.11)<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>.<br><br>gitlabhq_production=&gt; <span class="hljs-built_in">help</span><br>You are using psql, the command-line interface to PostgreSQL.<br>Type:  \copyright <span class="hljs-keyword">for</span> distribution terms<br>       \h <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> with SQL commands<br>       \? <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> with psql commands<br>       \g or terminate with semicolon to execute query<br>       \q to quit<br>gitlabhq_production-&gt; \q<br>could not save <span class="hljs-built_in">history</span> to file <span class="hljs-string">&quot;/var/opt/gitlab/.psql_history&quot;</span>: Permission denied<br><br>root@gitlab:~<span class="hljs-comment"># gitlab-rails --help</span><br>The most common rails commands are:<br> generate     Generate new code (short-cut <span class="hljs-built_in">alias</span>: <span class="hljs-string">&quot;g&quot;</span>)<br> console      Start the Rails console (short-cut <span class="hljs-built_in">alias</span>: <span class="hljs-string">&quot;c&quot;</span>)<br> server       Start the Rails server (short-cut <span class="hljs-built_in">alias</span>: <span class="hljs-string">&quot;s&quot;</span>)<br> <span class="hljs-built_in">test</span>         Run tests except system tests (short-cut <span class="hljs-built_in">alias</span>: <span class="hljs-string">&quot;t&quot;</span>)<br> <span class="hljs-built_in">test</span>:system  Run system tests<br> dbconsole    Start a console <span class="hljs-keyword">for</span> the database specified <span class="hljs-keyword">in</span> config/database.yml<br>              (short-cut <span class="hljs-built_in">alias</span>: <span class="hljs-string">&quot;db&quot;</span>)<br><br> new          Create a new Rails application. <span class="hljs-string">&quot;rails new my_app&quot;</span> creates a<br>              new application called MyApp <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;./my_app&quot;</span><br><br><br>All commands can be run with -h (or --<span class="hljs-built_in">help</span>) <span class="hljs-keyword">for</span> more information.<br>In addition to those commands, there are:<br><br>-------------------------------------------------------------------------------------<br> GitLab:       11.11.8 (1d18d065069)<br> GitLab Shell: 9.1.0<br> PostgreSQL:   9.6.11<br>-------------------------------------------------------------------------------------<br>Rails:<br>  console<br>  dbconsole<br>  destroy<br>  generate<br>  new<br>  runner<br>  secrets:edit<br>  secrets:setup<br>  server<br>  <span class="hljs-built_in">test</span><br>  version<br><br>Rake:<br>  about<br>  acts_as_taggable_on_engine:install:migrations<br>  acts_as_taggable_on_engine:tag_names:collate_bin<br>  acts_as_taggable_on_engine:tag_names:collate_ci<br>  add_limits_mysql<br>  app:template<br>  app:update<br>  assets:clean[keep]<br>  assets:clobber<br>  assets:environment<br>  assets:precompile<br>  brakeman<br>  cache:clear:redis<br>  cache_digests:dependencies<br>  cache_digests:nested_dependencies<br>  ci:cleanup:builds<br>  clean<br>  clobber<br>  config_lint<br>  db:create<br>  db:drop<br>  db:environment:<span class="hljs-built_in">set</span><br>  db:fixtures:load<br>  db:load_config<br>  db:migrate<br>  db:migrate:status<br>  db:rollback<br>  db:schema:cache:clear<br>  db:schema:cache:dump<br>  db:schema:dump<br>  db:schema:load<br>  db:seed<br>  db:seed_fu<br>  db:setup<br>  db:structure:dump<br>  db:structure:load<br>  db:version<br>  dev:cache<br>  dev:load<br>  dev:setup<br>  downtime_check<br>  ee_compat_check<br>  gemojione:aliases<br>  gemojione:install_assets<br>  gettext:add_language[language]<br>  gettext:find<br>  gettext:lint<br>  gettext:pack<br>  gettext:po_to_json<br>  gettext:store_model_attributes<br>  gitlab:app:check<br>  gitlab:artifacts:check<br>  gitlab:artifacts:migrate<br>  gitlab:assets:clean<br>  gitlab:assets:compile<br>  gitlab:assets:fix_urls<br>  gitlab:assets:purge<br>  gitlab:assets:purge_modules<br>  gitlab:backup:create<br>  gitlab:backup:restore<br>  gitlab:check<br>  gitlab:cleanup:block_removed_ldap_users<br>  gitlab:cleanup:<span class="hljs-built_in">dirs</span><br>  gitlab:cleanup:project_uploads<br>  gitlab:cleanup:remote_upload_files<br>  gitlab:cleanup:repos<br>  gitlab:db:composite_primary_keys_add<br>  gitlab:db:composite_primary_keys_drop<br>  gitlab:db:configure<br>  gitlab:db:downtime_check[ref]<br>  gitlab:db:drop_tables<br>  gitlab:db:mark_migration_complete[version]<br>  gitlab:dev:ee_compat_check[branch]<br>  gitlab:env:info<br>  gitlab:exclusive_lease:clear[scope]<br>  gitlab:features:enable_rugged<br>  gitlab:git:fsck<br>  gitlab:gitaly:check<br>  gitlab:gitaly:install[dir,storage_path,repo]<br>  gitlab:gitlab_shell:check<br>  gitlab:import:all_users_to_all_groups<br>  gitlab:import:all_users_to_all_projects<br>  gitlab:import:repos[import_path]<br>  gitlab:import:user_to_groups[email]<br>  gitlab:import:user_to_projects[email]<br>  gitlab:import_export:bump_version<br>  gitlab:import_export:data<br>  gitlab:import_export:version<br>  gitlab:incoming_email:check<br>  gitlab:ldap:rename_provider[old_provider,new_provider]<br>  gitlab:lfs:check<br>  gitlab:lfs:migrate<br>  gitlab:orphans:check<br>  gitlab:orphans:check_namespaces<br>  gitlab:orphans:check_repositories<br>  gitlab:pages:admin_ping<br>  gitlab:seed:issues[project_full_path]<br>  gitlab:setup<br>  gitlab:shell:build_missing_projects<br>  gitlab:shell:create_hooks<br>  gitlab:shell:install[repo]<br>  gitlab:shell:setup<br>  gitlab:sidekiq:check<br>  gitlab:storage:hashed_attachments<br>  gitlab:storage:hashed_projects<br>  gitlab:storage:legacy_attachments<br>  gitlab:storage:legacy_projects<br>  gitlab:storage:list_hashed_attachments<br>  gitlab:storage:list_hashed_projects<br>  gitlab:storage:list_legacy_attachments<br>  gitlab:storage:list_legacy_projects<br>  gitlab:storage:migrate_to_hashed<br>  gitlab:storage:rollback_to_legacy<br>  gitlab:tcp_check[host,port]<br>  gitlab:<span class="hljs-built_in">test</span><br>  gitlab:traces:archive<br>  gitlab:track_deployment<br>  gitlab:two_factor:disable_for_all_users<br>  gitlab:two_factor:rotate_key:apply<br>  gitlab:two_factor:rotate_key:rollback<br>  gitlab:update_project_templates<br>  gitlab:update_templates<br>  gitlab:uploads:check<br>  gitlab:uploads:migrate:all<br>  gitlab:uploads:migrate[uploader_class,model_class,mounted_as]<br>  gitlab:uploads:sanitize:remove_exif[start_id,stop_id,dry_run,sleep_time]<br>  gitlab:web_hook:add<br>  gitlab:web_hook:list<br>  gitlab:web_hook:rm<br>  gitlab:workhorse:install[dir,repo]<br>  grape:path_helpers<br>  grape:routes<br>  hipchat:send[message]<br>  import:github[token,gitlab_username,project_path]<br>  initializers<br>  jira:generate_consumer_key<br>  jira:generate_public_cert<br>  <span class="hljs-built_in">log</span>:clear<br>  middleware<br>  migrate_iids<br>  notes<br>  notes:custom<br>  plugins:validate<br>  postgresql_md5_hash<br>  restart<br>  routes<br>  secret<br>  setup<br>  setup_postgresql<br>  sidekiq:launchd<br>  sidekiq:restart<br>  sidekiq:start<br>  sidekiq:stop<br>  spec<br>  spec:api<br>  spec:feature<br>  spec:lib<br>  spec:models<br>  spec:other<br>  spec:services<br>  stats<br>  <span class="hljs-built_in">test</span><br>  <span class="hljs-built_in">test</span>:db<br>  <span class="hljs-built_in">test</span>:system<br>  time:zones[country_or_offset]<br>  tmp:clear<br>  tmp:create<br>  tokens:reset_all_email<br>  tokens:reset_all_feed<br>  webpack:compile<br>  yarn<br>  yarn:available<br>  yarn:check<br>  yarn:clobber<br>  yarn:install<br></code></pre></td></tr></table></figure>

<p><strong>gitlab-psql #数据库命令行</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:~<span class="hljs-comment"># gitlab-psql</span><br>psql (9.6.11)<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>.<br><br>gitlabhq_production=<span class="hljs-comment"># \db</span><br>         List of tablespaces<br>    Name    |    Owner    | Location <br>------------+-------------+----------<br> pg_default | gitlab-psql | <br> pg_global  | gitlab-psql | <br>(2 rows)<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># gitlab-rake #数据备份恢复等数据操作</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-rake --help</span><br>rake [-f rakefile] &#123;options&#125; targets...<br><br>Options are ...<br>        --backtrace=[OUT]            Enable full backtrace.  OUT can be stderr (default) or stdout.<br>        --comments                   Show commented tasks only<br>        --job-stats [LEVEL]          Display job statistics. LEVEL=<span class="hljs-built_in">history</span> displays a complete job list<br>        --rules                      Trace the rules resolution.<br>        --suppress-backtrace PATTERN Suppress backtrace lines matching regexp PATTERN. Ignored <span class="hljs-keyword">if</span> --trace is on.<br>    -A, --all                        Show all tasks, even uncommented ones (<span class="hljs-keyword">in</span> combination with -T or -D)<br>    -B, --build-all                  Build all prerequisites, including those <span class="hljs-built_in">which</span> are up-to-date.<br>    -D, --describe [PATTERN]         Describe the tasks (matching optional PATTERN), <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span>.<br>    -e, --execute CODE               Execute some Ruby code and <span class="hljs-built_in">exit</span>.<br>    -E, --execute-continue CODE      Execute some Ruby code, <span class="hljs-keyword">then</span> <span class="hljs-built_in">continue</span> with normal task processing.<br>    -f, --rakefile [FILENAME]        Use FILENAME as the rakefile to search <span class="hljs-keyword">for</span>.<br>    -G, --no-system, --nosystem      Use standard project Rakefile search paths, ignore system wide rakefiles.<br>    -g, --system                     Using system wide (global) rakefiles (usually <span class="hljs-string">&#x27;~/.rake/*.rake&#x27;</span>).<br>    -I, --libdir LIBDIR              Include LIBDIR <span class="hljs-keyword">in</span> the search path <span class="hljs-keyword">for</span> required modules.<br>    -j, --<span class="hljs-built_in">jobs</span> [NUMBER]              Specifies the maximum number of tasks to execute <span class="hljs-keyword">in</span> parallel. (default is number of CPU cores + 4)<br>    -m, --multitask                  Treat all tasks as multitasks.<br>    -n, --dry-run                    Do a dry run without executing actions.<br>    -N, --no-search, --nosearch      Do not search parent directories <span class="hljs-keyword">for</span> the Rakefile.<br>    -P, --prereqs                    Display the tasks and dependencies, <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span>.<br>    -p, --execute-print CODE         Execute some Ruby code, <span class="hljs-built_in">print</span> the result, <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span>.<br>    -q, --quiet                      Do not <span class="hljs-built_in">log</span> messages to standard output.<br>    -r, --require MODULE             Require MODULE before executing rakefile.<br>    -R, --rakelibdir RAKELIBDIR,     Auto-import any .rake files <span class="hljs-keyword">in</span> RAKELIBDIR. (default is <span class="hljs-string">&#x27;rakelib&#x27;</span>)<br>        --rakelib<br>    -s, --silent                     Like --quiet, but also suppresses the <span class="hljs-string">&#x27;in directory&#x27;</span> announcement.<br>    -t, --trace=[OUT]                Turn on invoke/execute tracing, <span class="hljs-built_in">enable</span> full backtrace. OUT can be stderr (default) or stdout.<br>    -T, --tasks [PATTERN]            Display the tasks (matching optional PATTERN) with descriptions, <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span>. -AT combination displays all of tasks contained no description.<br>    -v, --verbose                    Log message to standard output.<br>    -V, --version                    Display the program version.<br>    -W, --<span class="hljs-built_in">where</span> [PATTERN]            Describe the tasks (matching optional PATTERN), <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span>.<br>    -X, --no-deprecation-warnings    Disable the deprecation warnings.<br>    -h, -H, --<span class="hljs-built_in">help</span>                   Display this <span class="hljs-built_in">help</span> message.<br><br><span class="hljs-comment"># gitlab-ctl #客户端命令行操作行</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl --help</span><br>omnibus-ctl: <span class="hljs-built_in">command</span> (subcommand)<br>check-config<br>  Check <span class="hljs-keyword">if</span> there are any configuration <span class="hljs-keyword">in</span> gitlab.rb that is removed <span class="hljs-keyword">in</span> specified version<br>deploy-page<br>  Put up the deploy page<br>diff-config<br>  Compare the user configuration with package available configuration<br>prometheus-upgrade<br>  Upgrade the Prometheus data to the latest supported version<br>remove-accounts<br>  Delete *all* users and groups used by this package<br>upgrade<br>  Run migrations after a package upgrade<br>General Commands:<br>  cleanse<br>    Delete *all* gitlab data, and start from scratch.<br>  <span class="hljs-built_in">help</span><br>    Print this <span class="hljs-built_in">help</span> message.<br>  reconfigure<br>    Reconfigure the application.<br>  show-config<br>    Show the configuration that would be generated by reconfigure.<br>  uninstall<br>    Kill all processes and uninstall the process supervisor (data will be preserved).<br>Service Management Commands:<br>  graceful-kill<br>    Attempt a graceful stop, <span class="hljs-keyword">then</span> SIGKILL the entire process group.<br>  hup<br>    Send the services a HUP.<br>  int<br>    Send the services an INT.<br>  <span class="hljs-built_in">kill</span><br>    Send the services a KILL.<br>  once<br>    Start the services <span class="hljs-keyword">if</span> they are down. Do not restart them <span class="hljs-keyword">if</span> they stop.<br>  restart<br>    Stop the services <span class="hljs-keyword">if</span> they are running, <span class="hljs-keyword">then</span> start them again.<br>  service-list<br>    List all the services (enabled services appear with a *.)<br>  start<br>    Start services <span class="hljs-keyword">if</span> they are down, and restart them <span class="hljs-keyword">if</span> they stop.<br>  status<br>    Show the status of all the services.<br>  stop<br>    Stop the services, and <span class="hljs-keyword">do</span> not restart them.<br>  tail<br>    Watch the service logs of all enabled services.<br>  term<br>    Send the services a TERM.<br>  usr1<br>    Send the services a USR1.<br>  usr2<br>    Send the services a USR2.<br>Database Commands:<br>  pg-password-md5<br>    Generate MD5 Hash of user password <span class="hljs-keyword">in</span> PostgreSQL format<br>  pg-upgrade<br>    Upgrade the PostgreSQL DB to the latest supported version<br>  revert-pg-upgrade<br>    Run this to revert to the previous version of the database<br>  set-replication-password<br>    Set database replication password<br>Let<span class="hljs-string">&#x27;s Encrypt Commands:</span><br><span class="hljs-string">  renew-le-certs</span><br><span class="hljs-string">    Renew the existing Let&#x27;</span>s Encrypt certificates<br>Container Registry Commands:<br>  registry-garbage-collect<br>    Run Container Registry garbage collection.<br><br><span class="hljs-comment"># gitlab-ctl stop #停止 gitlab</span><br><span class="hljs-comment"># gitlab-ctl start #启动 gitlab</span><br><span class="hljs-comment"># gitlab-ctl restar #重启 gitlab</span><br><span class="hljs-comment"># gitlab-ctl status #查看组件运行状态</span><br><span class="hljs-comment"># gitlab-ctl tail nginx #查看某个组件的日志</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-14.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-4-验证-gitlab-启动完成"><a href="#2-1-3-4-验证-gitlab-启动完成" class="headerlink" title="2.1.3.4 验证 gitlab 启动完成"></a>2.1.3.4 验证 gitlab 启动完成</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-13.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-5-验证端口及状态："><a href="#2-1-3-5-验证端口及状态：" class="headerlink" title="2.1.3.5  验证端口及状态："></a>2.1.3.5  验证端口及状态：</h4><p>80端口是在初始化 gitlib 的时候启动的，因此如果之前的有程序占用会导致初始化失败或无法访问！</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-15.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-6-登录-gitlab-web-界面-："><a href="#2-1-3-6-登录-gitlab-web-界面-：" class="headerlink" title="2.1.3.6 登录 gitlab web 界面 ："></a>2.1.3.6 登录 gitlab web 界面 ：</h4><p><a target="_blank" rel="noopener" href="http://x.x.x.x/">http://x.x.x.x/</a><br>登录 web 页面并设置密码,最少 8 位：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-16.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-7-登录-gitlab-："><a href="#2-1-3-7-登录-gitlab-：" class="headerlink" title="2.1.3.7 登录 gitlab ："></a>2.1.3.7 登录 gitlab ：</h4><p>登录，默认用户为 root：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-17.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-8-默认首页"><a href="#2-1-3-8-默认首页" class="headerlink" title="2.1.3.8 默认首页"></a>2.1.3.8 默认首页</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-18.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-9-关闭账号注册"><a href="#2-1-3-9-关闭账号注册" class="headerlink" title="2.1.3.9  关闭账号注册"></a>2.1.3.9  关闭账号注册</h4><p><font color="red">默认情况下可以直接注册账号，生产环境都关闭此功能</font></p>
<p><strong>注意：修改这些功能一定要长点心，推荐同时开两个网页，一个到登录页面，一个在修改页面，在修改保存后使用另外以恶搞页面登录，如果发现不能登录就立刻进行修改。</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-19.png" srcset="/blog/img/loading.gif"></p>
<p><strong>取消账户注册功能之后点 save</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-20.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-10-验证是否还有注册选项"><a href="#2-1-3-10-验证是否还有注册选项" class="headerlink" title="2.1.3.10 验证是否还有注册选项"></a>2.1.3.10 验证是否还有注册选项</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-21.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-11建创建-git-账户"><a href="#2-1-3-11建创建-git-账户" class="headerlink" title="2.1.3.11建创建 git 账户"></a>2.1.3.11建创建 git 账户</h4><p>Admin area – Dashboard – New user</p>
<p>（通常运维只是创建用户，权限都是由开发老大自己设定）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-22.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-23.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-12-重新设置密码"><a href="#2-1-3-12-重新设置密码" class="headerlink" title="2.1.3.12 重新设置密码"></a>2.1.3.12 重新设置密码</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-24.png" srcset="/blog/img/loading.gif"></p>
<p>通过邮件重置用户密码</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-25.png" srcset="/blog/img/loading.gif"></p>
<p>在收件箱打开邮件设置密码</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-26.png" srcset="/blog/img/loading.gif"></p>
<p>设置密码</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-27.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-13-创建组"><a href="#2-1-3-13-创建组" class="headerlink" title="2.1.3.13 创建组"></a>2.1.3.13 创建组</h4><p>使用管理员 root 创建组，一个组里面可以有多个项目分支，可以将开发添加到组里面进行设置权限，不同的组就是公司不同的开发项目或者服务模块，不同的组添加不同的开发即可实现对开发设置权限的管理。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-28.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-14-使用管理员创建项目"><a href="#2-1-3-14-使用管理员创建项目" class="headerlink" title="2.1.3.14 使用管理员创建项目"></a>2.1.3.14 使用管理员创建项目</h4><p>（创建项目的名称也是由开发决定的）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-29.png" srcset="/blog/img/loading.gif"></p>
<p>使用管理员创建项目（创建项目的时候注意在填写项目的名称之后也要选择由哪个组来管理项目，即在Project URL下IP地址后点击就有的选择）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-30.png" srcset="/blog/img/loading.gif"></p>
<p>创建后的项目效果</p>
<p>（一般开发都有自己的项目开发工具来配置地址然后上传代码到gitlab）</p>
<p>python开发工具：pycharm</p>
<p>java开发工具：eclipse，intellij idea</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-31.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-15-将用户添加到组"><a href="#2-1-3-15-将用户添加到组" class="headerlink" title="2.1.3.15 将用户添加到组"></a>2.1.3.15 将用户添加到组</h4><p><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/user/permissions.html">https://docs.gitlab.com/ee/user/permissions.html</a> (更多权限)</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-32.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-33.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-34.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-16-创建一个测试页面"><a href="#2-1-3-16-创建一个测试页面" class="headerlink" title="2.1.3.16 创建一个测试页面"></a>2.1.3.16 创建一个测试页面</h4><p>找到项目界面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-35.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-36.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-37.png" srcset="/blog/img/loading.gif"></p>
<p>添加一个页面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-38.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-39.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-17-git-客户端测试-clone-项目"><a href="#2-1-3-17-git-客户端测试-clone-项目" class="headerlink" title="2.1.3.17 git 客户端测试 clone 项目"></a>2.1.3.17 git 客户端测试 clone 项目</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># git clone http://10.0.0.101/linux/web1.git</span><br>Cloning into <span class="hljs-string">&#x27;web1&#x27;</span>...<br>Username <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span>: rlin          <br>Password <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://rlin@10.0.0.101&#x27;</span>: <br>remote: Enumerating objects: 3, <span class="hljs-keyword">done</span>.<br>remote: Counting objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>remote: Total 3 (delta 0), reused 0 (delta 0)<br>Unpacking objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>root@gitlab:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># cat web1/README.md </span><br>&lt;h1&gt;This is a README&lt;/h1&gt;<br><br><span class="hljs-comment">#编辑文件并测试提交：</span><br>root@jenkins:/<span class="hljs-built_in">source</span><span class="hljs-comment"># cd test-project/</span><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># git config --global user.name &quot;jack&quot;</span><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># git config --global user.email 346636558@qq.com</span><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># vim index.html</span><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># cat index.html</span><br>&lt;h1&gt;11111111111&lt;/h1&gt;<br>&lt;h1&gt;22222222222&lt;/h1&gt;<br><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># git add index.html</span><br>root@jenkins:/<span class="hljs-built_in">source</span>/test-project<span class="hljs-comment"># git commit -m &quot;v1&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-40.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-18-git-web-端验证数据"><a href="#2-1-3-18-git-web-端验证数据" class="headerlink" title="2.1.3.18 git web 端验证数据"></a>2.1.3.18 git web 端验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-41.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-19-gitblab-使用"><a href="#2-1-3-19-gitblab-使用" class="headerlink" title="2.1.3.19 gitblab 使用"></a>2.1.3.19 gitblab 使用</h4><h5 id="2-1-3-19-1-数据保方式"><a href="#2-1-3-19-1-数据保方式" class="headerlink" title="2.1.3.19.1 数据保方式"></a>2.1.3.19.1 数据保方式</h5><p>SVN 与 CVS</p>
<p>每次提交的文件都单独保存，即按照文件的提交时间区分不同的版本，保存至不同的逻辑存储区域，后期恢复的时候直接基于之前版本恢复。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-42.png" srcset="/blog/img/loading.gif"></p>
<p>Gitlab：<br>Gitlab 与 SVN 的数据保存方式不一样，gitlab 虽然也会在内部对数据进行逻辑划分保存，但是当后期提交的数据如果和之前提交过的数据没有变化，其就直接快照之前的文件，而不是在将文件重新上传一份在保存一遍，这样既节省了空间又加快了代码提交速度。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-43.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-1-3-19-2-用常用-git-命令"><a href="#2-1-3-19-2-用常用-git-命令" class="headerlink" title="2.1.3.19.2 用常用 git 命令"></a>2.1.3.19.2 用常用 git 命令</h5><p>使用 git 命令下载代码与提交代码等操作。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-44.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">git config --global user.name “name“ <span class="hljs-comment">#设置全局用户名</span><br>git config --global user.email xxx@xx.com <span class="hljs-comment">#设置全局邮箱</span><br>git config --global --list <span class="hljs-comment">#列出用户全局设置</span><br>git add index.html  . <span class="hljs-comment">#添加指定文件、目录或到暂存区</span><br>git add . <span class="hljs-comment">#添加当前目录下所有数据到暂存区</span><br>git commit -m <span class="hljs-string">&quot;...&quot;</span> <span class="hljs-comment">#提交文件到工作区,并添加注释</span><br>git status <span class="hljs-comment">#查看工作区的状态</span><br>git push <span class="hljs-comment">#提交代码到服务器</span><br>git pull <span class="hljs-comment">#获取代码到本地</span><br>git <span class="hljs-built_in">log</span> <span class="hljs-comment">#查看操作日志</span><br>vim .gitignore <span class="hljs-comment">#定义忽略文件</span><br>git reset --hard HEAD^^ <span class="hljs-comment">#git 版本回滚， HEAD 为当前版本，加一个^为上一个，^^为上上一个版本，通常只用一个^</span><br>git reflog <span class="hljs-comment"># #获取每次提交的 ID，可以使用--hard 根据提交的 ID 进行版本回退</span><br>git reset --hard 5ae4b06 <span class="hljs-comment">#回退到指定 id 的版本</span><br>git branch <span class="hljs-comment">#查看当前所处的分支</span><br>git checkout -b develop <span class="hljs-comment">#创建并切换到一个新分支</span><br>git checkout develop <span class="hljs-comment">#切换分支</span><br></code></pre></td></tr></table></figure>

<h5 id="2-1-3-19-3-git-缓存区与工作区等概念："><a href="#2-1-3-19-3-git-缓存区与工作区等概念：" class="headerlink" title="2.1.3.19.3 git 缓存区与工作区等概念："></a>2.1.3.19.3 git 缓存区与工作区等概念：</h5><p>工作区：clone 的代码或者开发自己编写的代码文件所在的目录，通常是代码所在的一个服务的目录名称。</p>
<p>暂存区：用于存储在工作区中对代码进行修改后的文件所保存的地方，使用 git add 添加。</p>
<p>本地仓库：用于提交存储在工作区和暂存区中改过的文件地方，使用 git commit 提交。</p>
<p>远程仓库：多个开发共同协作提交代码的仓库，即 gitlab 服务器。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-45.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-3-20-gitlab-数据备份恢复"><a href="#2-1-3-20-gitlab-数据备份恢复" class="headerlink" title="2.1.3.20 gitlab 数据备份恢复"></a>2.1.3.20 gitlab 数据备份恢复</h4><h5 id="2-1-3-20-1-停止-gitlab-数据服务"><a href="#2-1-3-20-1-停止-gitlab-数据服务" class="headerlink" title="2.1.3.20.1 停止 gitlab 数据服务"></a>2.1.3.20.1 停止 gitlab 数据服务</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@s1:~<span class="hljs-comment"># gitlab-ctl stop unicorn</span><br>ok: down: unicorn: 1s, normally up<br>root@s1:~<span class="hljs-comment"># gitlab-ctl stop sidekiq</span><br>ok: down: sidekiq: 0s, normally up<br></code></pre></td></tr></table></figure>

<h5 id="2-1-3-20-2-手动备份数据"><a href="#2-1-3-20-2-手动备份数据" class="headerlink" title="2.1.3.20.2 手动备份数据"></a>2.1.3.20.2 手动备份数据</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:~<span class="hljs-comment"># gitlab-rake gitlab:backup:create #在任意目录即可备份当前 gitlab 数据</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl start #备份完成后启动 gitlab</span><br></code></pre></td></tr></table></figure>

<h5 id="2-1-3-20-3-查看要恢复的文件："><a href="#2-1-3-20-3-查看要恢复的文件：" class="headerlink" title="2.1.3.20.3 查看要恢复的文件："></a>2.1.3.20.3 查看要恢复的文件：</h5><p>/var/opt/gitlab/backups/ # Gitlab 数据备份目录，需要使用命令备份的</p>
<p>/var/opt/gitlab/nginx/conf #nginx 配置文件</p>
<p>/etc/gitlab/gitlab.rb #gitlab 配置文件</p>
<p>/etc/gitlab/gitlab-secrets.json #key 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@s1:~<span class="hljs-comment"># ll /var/opt/gitlab/backups/</span><br>total 408<br>drwx------ 4 git root 4096 Jul 17 10:42 ./<br>drwxr-xr-x 20 root root 4096 Jul 17 10:11 ../<br>-rw------- 1 git git 92160 Jul 17 10:20 1563330030_2019_07_17_11.11.5_gitlab_backup.tar<br>-rw------- 1 git git 92160 Jul 17 10:23 1563330216_2019_07_17_11.11.5_gitlab_backup.tar<br>-rw------- 1 git git 92160 Jul 17 10:30 1563330647_2019_07_17_11.11.5_gitlab_backup.tar<br>-rw------- 1 git git 92160 Jul 17 10:32 1563330751_2019_07_17_11.11.5_gitlab_backup.tar<br></code></pre></td></tr></table></figure>

<h5 id="2-1-3-20-4-执行恢复"><a href="#2-1-3-20-4-执行恢复" class="headerlink" title="2.1.3.20.4 执行恢复"></a>2.1.3.20.4 执行恢复</h5><p>删除一些数据，测试能否恢复</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:~<span class="hljs-comment"># gitlab-ctl stop unicorn</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl stop sidekiq #恢复数据之前停止服务</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-rake gitlab:backup:restore BACKUP=备份文件名</span><br>如：<br>root@gitlab:~<span class="hljs-comment"># gitlab-rake gitlab:backup:restore BACKUP=1617453050_2021_04_03_11.11.8</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-46.png" srcset="/blog/img/loading.gif"></p>
<p>确认恢复数据</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-47.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-1-3-20-5-启动服务"><a href="#2-1-3-20-5-启动服务" class="headerlink" title="2.1.3.20.5 启动服务"></a>2.1.3.20.5 启动服务</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@s1:~<span class="hljs-comment"># gitlab-ctl start sidekiq</span><br>ok: run: sidekiq: (pid 16859) 0s<br>root@s1:~<span class="hljs-comment"># gitlab-ctl start unicorn</span><br>ok: run: unicorn: (pid 16882) 1s<br></code></pre></td></tr></table></figure>

<h5 id="2-1-3-20-6-gitlab简单的备份脚本"><a href="#2-1-3-20-6-gitlab简单的备份脚本" class="headerlink" title="2.1.3.20.6 gitlab简单的备份脚本"></a>2.1.3.20.6 gitlab简单的备份脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>gitlab-ctl stop unicorn<br>gitlab-ctl stop sidekiq<br>gitlab-rake gitlab:backup:create<br>gitlab-ctl start sidekiq<br>gitlab-ctl start unicorn<br></code></pre></td></tr></table></figure>

<h4 id="2-1-3-21-gitlab-汉化"><a href="#2-1-3-21-gitlab-汉化" class="headerlink" title="2.1.3.21 gitlab 汉化"></a>2.1.3.21 gitlab 汉化</h4><p>虽然不推荐，但是有需求，基于第三方开发爱好者实现</p>
<h5 id="2-1-3-21-1-载语言包替换"><a href="#2-1-3-21-1-载语言包替换" class="headerlink" title="2.1.3.21.1 载语言包替换"></a>2.1.3.21.1 载语言包替换</h5><p>通过指定版本的语言包汉化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://gitlab.com/xhang/gitlab/-/archive/v12.3.5-zh/gitlab-v12.3.5-zh.tar.gz<br>https://gitlab.com/xhang/gitlab/-/archive/v11.11.5-zh/gitlab-v11.11.5-zh.tar<br>https://gitlab.com/xhang/gitlab/-/archive/v11.9.8-zh/gitlab-v11.9.8-zh.tar<br>https://gitlab.com/xhang/gitlab/-/tree/v11.11.8-zh<br>https://gitlab.com/xhang/gitlab/ <span class="hljs-comment">#gitlab中文社区</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-48.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#首次安装 gitlab 步骤</span><br>root@gitlab:~<span class="hljs-comment"># vim /etc/gitlab/gitlab.rb #修改配置</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl reconfigure</span><br><br><span class="hljs-comment">#查看gitlab版本</span><br>root@gitlab:~<span class="hljs-comment"># cat /opt/gitlab/version-manifest.txt</span><br>gitlab-ce 11.11.8<br>..........<br><br><span class="hljs-comment">#已经安装 gitlab 步骤</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl stop</span><br>root@gitlab:~<span class="hljs-comment"># tar xvf gitlab-vX.Y.Z-zh.tar</span><br>root@gitlab:~<span class="hljs-comment"># cp -rp /opt/gitlab/embedded/service/gitlab-rails /opt/gitlab-rails.bak #备份源文件</span><br>root@gitlab:~<span class="hljs-comment"># cp -rf gitlab-vX.Y.Z-zh/* /opt/gitlab/embedded/service/gitlab-rails/ #替换文件(拷贝后会出现两个报错，但是不用理会)</span><br>cp: cannot overwrite non-directory <span class="hljs-string">&#x27;/opt/gitlab/embedded/service/gitlab-rails/log&#x27;</span> with directory <span class="hljs-string">&#x27;gitlab-v11.11.8-zh/log&#x27;</span><br>cp: cannot overwrite non-directory <span class="hljs-string">&#x27;/opt/gitlab/embedded/service/gitlab-rails/tmp&#x27;</span> with directory <span class="hljs-string">&#x27;gitlab-v11.11.8-zh/tmp&#x27;</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl reconfigure</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl start</span><br><span class="hljs-comment">#如果重新打开gitlab会出现502就稍等一下</span><br></code></pre></td></tr></table></figure>

<p>Web 界面更改语言：右上角的账户下拉框选 Settings 然后左侧 Preferences 设置项，然后语言选择中文,保存后刷新界面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-49.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-1-3-21-2-通过源码汉化"><a href="#2-1-3-21-2-通过源码汉化" class="headerlink" title="2.1.3.21.2 通过源码汉化"></a>2.1.3.21.2 通过源码汉化</h5><p><strong>如果语言包的汉化不能使用再使用源码汉化</strong></p>
<p><a target="_blank" rel="noopener" href="https://gitlab.com/xhang/gitlab">https://gitlab.com/xhang/gitlab</a> #汉化包地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@gitlab:~<span class="hljs-comment"># gitlab-ctl stop</span><br>root@gitlab:~<span class="hljs-comment"># git clone https://gitlab.com/xhang/gitlab.git</span><br>root@gitlab:~<span class="hljs-comment"># head -1 /opt/gitlab/version-manifest.txt #查看当前 gitlab 版本</span><br>root@gitlab:~<span class="hljs-comment"># cd gitlab</span><br>root@gitlab:~<span class="hljs-comment"># git diff v11.9.8 v11.9.8-zh （英文版本和中文版本的对比）</span><br>root@gitlab:~<span class="hljs-comment"># git diff v12.3.5 v12.3.5-zh （英文版本和中文版本的对比）</span><br>root@gitlab:~<span class="hljs-comment"># git diff v11.9.8 v11.9.8-zh &gt; /root/v11.9.8-zh.diff</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl stop</span><br>root@gitlab:~<span class="hljs-comment"># patch -f -d /opt/gitlab/embedded/service/gitlab-rails -p1 &lt; /root/v11.9.8-zh.diff （打补丁）</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl reconfigure</span><br>root@gitlab:~<span class="hljs-comment"># gitlab-ctl start</span><br></code></pre></td></tr></table></figure>

<p>gatlab v11.11.8 汉化效果：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-50.png" srcset="/blog/img/loading.gif"></p>
<p>gatlab V12.3.5：汉化效果:</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-51.png" srcset="/blog/img/loading.gif"></p>
<h2 id="2-2-常见的代码部署方式"><a href="#2-2-常见的代码部署方式" class="headerlink" title="2.2 常见的代码部署方式"></a>2.2 常见的代码部署方式</h2><h3 id="2-2-1-蓝绿部署"><a href="#2-2-1-蓝绿部署" class="headerlink" title="2.2.1 蓝绿部署"></a>2.2.1 蓝绿部署</h3><p>蓝绿部署指的是不停老版本代码(不影响上一个版本访问)，而是在另外一套环境部署新版本然后进行测试，测试通过后将用户流量切到新版本，其特点为业务无中断，升级风险相对较小。</p>
<p>具体过程：</p>
<ol>
<li>当前版本业务正常访问(V1)</li>
<li>在另外一套环境部署新代码(V2)，代码可能是增加了功能或者是修复了某些 bug</li>
<li>测试通过之后将用户请求流量切到新版本环境</li>
<li>观察一段时间，如有异常直接切换旧版本</li>
<li>下次升级，将旧版本升级到新版本(V3)</li>
</ol>
<p>蓝绿部署适用的场景：</p>
<ol>
<li>不停止老版本，额外部署一套新版本，等测试发现新版本 OK 后，删除老版本。</li>
<li>蓝绿发布是一种用于升级与更新的发布策略，部署的最小维度是容器，而发布的最小维度是应用。</li>
<li>蓝绿发布对于增量升级有比较好的支持，但是对于涉及数据表结构变更等等不可逆转的升级，并不完全合适用蓝绿发布来实现，需要结合一些业务的逻辑以及数据迁移与回滚的策略才可以完全满足需求。</li>
</ol>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-52.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-2-2-金丝雀发布"><a href="#2-2-2-金丝雀发布" class="headerlink" title="2.2.2 金丝雀发布"></a>2.2.2 金丝雀发布</h3><p>金丝雀发布也叫灰度发布，是指在黑与白之间，能够平滑过渡的一种发布方式，灰度发布是增量发布的一种类型，灰度发布是在原有版本可用的情况下，同时部署一个新版本应用作为“金丝雀”(小白鼠)，测试新版本的性能和表现，以保障整体系统稳定的情况下，尽早发现、调整问题。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">金丝雀”的由来：17 世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；而当瓦斯含量超过一定限度时，虽然鲁钝的人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为“瓦斯检测指标”，以便在危险状况下紧急撤离。<br></code></pre></td></tr></table></figure>

<p>金丝雀发布、灰度发布步骤组成：</p>
<ol>
<li>准备好部署各个阶段的工件，包括：构建工件，测试脚本，配置文件和部署清单文件。</li>
<li>从负载均衡列表中移除掉“金丝雀”服务器。</li>
<li>升级“金丝雀”应用（排掉原有流量并进行部署）。</li>
<li>对应用进行自动化测试。</li>
<li>将“金丝雀”服务器重新添加到负载均衡列表中（连通性和健康检查）。</li>
<li>如果“金丝雀”在线使用测试成功，升级剩余的其他服务器。（否则就回滚）灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。</li>
</ol>
<p>灰度发布/金丝雀部署适用的场景：</p>
<ol>
<li>不停止老版本，额外搞一套新版本，不同版本应用共存。</li>
<li>灰度发布中，常常按照用户设置路由权重，例如 90%的用户维持使用老版本，10%的用户尝鲜新版本。</li>
<li>经常与 A/B 测试一起使用，用于测试选择多种方案。</li>
</ol>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-53.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-2-3-滚动发布"><a href="#2-2-3-滚动发布" class="headerlink" title="2.2.3 滚动发布"></a>2.2.3 滚动发布</h3><p>滚动发布，一般是取出一个或者多个服务器停止服务，执行更新，并重新将其投入使用。周而复始，直到集群中所有的实例都更新成新版本。</p>
<h3 id="2-2-4-A-B-测试"><a href="#2-2-4-A-B-测试" class="headerlink" title="2.2.4 A/B 测试"></a>2.2.4 A/B 测试</h3><p>A/B 测试也是同时运行两个 APP 环境，但是蓝绿部署完全是两码事，A/B 测试是用来测试应用功能表现的方法，例如可用性、受欢迎程度、可见性等等，蓝绿部署的目的是安全稳定地发布新版本应用，并在必要时回滚，即蓝绿部署是一套正式环境环境在线，而A/B 测试是两套正式环境在线。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-54.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-55.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-2-5-稳定性排序"><a href="#2-2-5-稳定性排序" class="headerlink" title="2.2.5 稳定性排序"></a>2.2.5 稳定性排序</h3><p><strong>A/B测试&gt;蓝绿部署&gt;金丝雀发布&gt;A/B测试</strong></p>
<h1 id="三、部署web服务器环境"><a href="#三、部署web服务器环境" class="headerlink" title="三、部署web服务器环境"></a>三、部署web服务器环境</h1><h2 id="3-1-一般小公司架构图"><a href="#3-1-一般小公司架构图" class="headerlink" title="3.1 一般小公司架构图"></a>3.1 一般小公司架构图</h2><table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">安装的服务</th>
<th align="center">服务器名称</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.0.0.101</td>
<td align="center">gitlab</td>
<td align="center">gitlab</td>
</tr>
<tr>
<td align="center">10.0.0.102</td>
<td align="center">Jenkins</td>
<td align="center">jenkins-master</td>
</tr>
<tr>
<td align="center">10.0.0.103</td>
<td align="center">keepalived，HAproxy</td>
<td align="center">jenkins-slave1</td>
</tr>
<tr>
<td align="center">10.0.0.104</td>
<td align="center">keepalived，HAproxy</td>
<td align="center">jenkins-slave2</td>
</tr>
<tr>
<td align="center">10.0.0105</td>
<td align="center">tomcat</td>
<td align="center">web1（测试环境）</td>
</tr>
<tr>
<td align="center">10.0.0.106</td>
<td align="center">tomcat</td>
<td align="center">web2（生产环境）</td>
</tr>
<tr>
<td align="center">10.0.0.107</td>
<td align="center">tomcat</td>
<td align="center">web3（生产环境）</td>
</tr>
<tr>
<td align="center">10.0.0.108</td>
<td align="center">sonarqube</td>
<td align="center">sonarqube</td>
</tr>
</tbody></table>
<h2 id="3-2-安装Haproxy"><a href="#3-2-安装Haproxy" class="headerlink" title="3.2 安装Haproxy"></a>3.2 安装Haproxy</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># yum -y install libnfnetlink-devel libnfnetlink ipvsadm libnl libnl-devel libnl3 libnl3-devel lm_sensors-libs net-snmp-agent-libs net-snmp-libs open server openssh-clients openssl openssl-devel automake iproute</span><br><br><span class="hljs-comment">#安装HAProxy</span><br>root@jenkins-slave1:~<span class="hljs-comment"># apt install haproxy -y</span><br><br><span class="hljs-comment">#haproxy.cfg修改成以下模样</span><br>root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>global<br>	<span class="hljs-built_in">log</span> /dev/<span class="hljs-built_in">log</span>	local0<br>	<span class="hljs-built_in">log</span> /dev/<span class="hljs-built_in">log</span>	local1 notice<br>	chroot /var/lib/haproxy<br>	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners<br>	stats timeout 30s<br>	user haproxy<br>	group haproxy<br>	daemon<br><br>	<span class="hljs-comment"># Default SSL material locations</span><br>	ca-base /etc/ssl/certs<br>	crt-base /etc/ssl/private<br><br>	<span class="hljs-comment"># Default ciphers to use on SSL-enabled listening sockets.</span><br>	<span class="hljs-comment"># For more information, see ciphers(1SSL). This list is from:</span><br>	<span class="hljs-comment">#  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/</span><br>	<span class="hljs-comment"># An alternative list with additional directives can be obtained from</span><br>	<span class="hljs-comment">#  https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy</span><br>	ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS<br>	ssl-default-bind-options no-sslv3<br><br>defaults<br>	<span class="hljs-built_in">log</span>	global<br>	mode	http<br>	option	httplog<br>	option	dontlognull<br>        timeout connect 5000<br>        timeout client  50000<br>        timeout server  50000<br>	errorfile 400 /etc/haproxy/errors/400.http<br>	errorfile 403 /etc/haproxy/errors/403.http<br>	errorfile 408 /etc/haproxy/errors/408.http<br>	errorfile 500 /etc/haproxy/errors/500.http<br>	errorfile 502 /etc/haproxy/errors/502.http<br>	errorfile 503 /etc/haproxy/errors/503.http<br>	errorfile 504 /etc/haproxy/errors/504.http<br><br>listen linux-web-80-develop<br>  <span class="hljs-built_in">bind</span> 10.0.0.249:80<br>  mode http<br>  server 10.0.0.105 10.0.0.105:8080 check inter 2s fall 3 rise 5<br><br>listen linux-web-80-master<br>  <span class="hljs-built_in">bind</span> 10.0.0.248:80<br>  mode http<br>  server 10.0.0.106 10.0.0.106:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.107 10.0.0.107:8080 check inter 2s fall 3 rise 5<br><br>root@jenkins-slave1:~<span class="hljs-comment">#systemctl restart haproxy.service</span><br>root@jenkins-slave1:~<span class="hljs-comment">#systemctl enable haproxy.service</span><br>Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.<br>Executing: /lib/systemd/systemd-sysv-install <span class="hljs-built_in">enable</span> haproxy<br><span class="hljs-comment">#发送到10.0.0.104</span><br>root@jenkins-slave1:~<span class="hljs-comment"># scp /etc/haproxy/haproxy.cfg 10.0.0.104:/etc/haproxy/</span><br>root@jenkins-slave2:~<span class="hljs-comment"># sysctl -a | grep local</span><br>fs.nfs.nsm_local_state = 0<br>net.ipv4.conf.all.accept_local = 0<br>net.ipv4.conf.all.route_localnet = 0<br>net.ipv4.conf.default.accept_local = 0<br>net.ipv4.conf.default.route_localnet = 0<br>net.ipv4.conf.eth0.accept_local = 0<br>net.ipv4.conf.eth0.route_localnet = 0<br>net.ipv4.conf.lo.accept_local = 0<br>net.ipv4.conf.lo.route_localnet = 0<br>net.ipv4.igmp_link_local_mcast_reports = 1<br>net.ipv4.ip_local_port_range = 10001	<br>net.ipv4.ip_local_reserved_ports = 65000<br>net.ipv4.ip_nonlocal_bind = 0<br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.all.stable_secret&quot;</span><br>net.ipv6.conf.all.accept_ra_from_local = 0<br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.default.stable_secret&quot;</span><br>net.ipv6.conf.default.accept_ra_from_local = 0<br>sysctl: net.ipv6.conf.eth0.accept_ra_from_local = 0<br>reading key <span class="hljs-string">&quot;net.ipv6.conf.eth0.stable_secret&quot;</span><br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.lo.stable_secret&quot;</span><br>net.ipv6.conf.lo.accept_ra_from_local = 0<br>net.ipv6.ip_nonlocal_bind = 0<br><span class="hljs-comment">#slave1和slave2都要修改</span><br>root@jenkins-slave2:~<span class="hljs-comment"># vim /etc/sysctl.conf</span><br><span class="hljs-comment">#添加</span><br>net.ipv4.ip_nonlocal_bind = 1<br>root@jenkins-slave2:~<span class="hljs-comment"># sysctl -p</span><br>root@jenkins-slave2:~<span class="hljs-comment"># systemctl restart haproxy.service</span><br>root@jenkins-slave2:~<span class="hljs-comment"># systemctl enable haproxy.service</span><br></code></pre></td></tr></table></figure>

<h2 id="3-3-安装并确认KeepAlived"><a href="#3-3-安装并确认KeepAlived" class="headerlink" title="3.3 安装并确认KeepAlived"></a>3.3 安装并确认KeepAlived</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># apt install keepalived -y</span><br><span class="hljs-comment">#复制Keepalived配置文件并修改</span><br>root@jenkins-slave1:~<span class="hljs-comment"># cp /usr/share/doc/keepalived/samples/keepalived.conf.vrrp /etc/keepalived/keepalived.conf</span><br><span class="hljs-comment">#keepalived.conf修改成以下的模样</span><br>root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>     acassen<br>   &#125;<br>   notification_email_from Alexandre.Cassen@firewall.loc<br>   smtp_server 192.168.200.1<br>   smtp_connect_timeout 30<br>   router_id LVS_DEVEL<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER<br>    interface eth0<br>    garp_master_delay 10<br>    smtp_alert<br>    virtual_router_id 51<br>    priority 100<br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.248 dev eth0 label eth0:1 <br>        10.0.0.249 dev eth0 label eth0:2<br>    &#125;<br>&#125;<br><br>root@jenkins-slave1:~<span class="hljs-comment"># systemctl restart keepalived.service</span><br>root@jenkins-slave1:~<span class="hljs-comment"># systemctl enable keepalived.service</span><br><span class="hljs-comment">#发送到10.0.0.104</span><br>root@jenkins-slave2:~<span class="hljs-comment"># apt install keepalived haproxy -y</span><br>root@jenkins-slave1:~<span class="hljs-comment"># scp /etc/keepalived/keepalived.conf 10.0.0.104:/etc/keepalived/</span><br>root@jenkins-slave2:~<span class="hljs-comment"># systemctl restart keepalived.service</span><br>root@jenkins-slave2:~<span class="hljs-comment"># systemctl enable keepalived.service</span><br><span class="hljs-comment">#确认jenkins-slave1服务器配置keepalived是否成功</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ping 10.0.0.248</span><br>PING 10.0.0.248 (10.0.0.248) 56(84) bytes of data.<br>64 bytes from 10.0.0.248: icmp_seq=1 ttl=64 time=0.431 ms<br>64 bytes from 10.0.0.248: icmp_seq=2 ttl=64 time=0.331 ms<br>64 bytes from 10.0.0.248: icmp_seq=3 ttl=64 time=0.326 ms<br>^C<br>--- 10.0.0.248 ping statistics ---<br>3 packets transmitted, 3 received, 0% packet loss, time 2053ms<br>rtt min/avg/max/mdev = 0.326/0.362/0.431/0.053 ms<br><br>root@jenkins-slave2:~<span class="hljs-comment"># ifconfig </span><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.104  netmask 255.255.0.0  broadcast 10.0.255.255<br>        inet6 fe80::20c:29ff:fe2b:9b02  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        ether 00:0c:29:2b:9b:02  txqueuelen 1000  (Ethernet)<br>        RX packets 9064  bytes 11704527 (11.7 MB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 3105  bytes 274585 (274.5 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 127.0.0.1  netmask 255.0.0.0<br>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;<br>        loop  txqueuelen 1000  (Local Loopback)<br>        RX packets 137  bytes 11552 (11.5 KB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 137  bytes 11552 (11.5 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br><span class="hljs-comment">#测试Keepalived有没有Ip漂移，先将jenkins-slave1的keepalived停掉，然后再观察本机是否出现eth0:1</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ifconfig </span><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.104  netmask 255.255.0.0  broadcast 10.0.255.255<br>        inet6 fe80::20c:29ff:fe2b:9b02  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        ether 00:0c:29:2b:9b:02  txqueuelen 1000  (Ethernet)<br>        RX packets 9093  bytes 11706447 (11.7 MB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 3128  bytes 277253 (277.2 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>eth0:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.248  netmask 255.255.255.255  broadcast 0.0.0.0<br>        ether 00:0c:29:2b:9b:02  txqueuelen 1000  (Ethernet)<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 127.0.0.1  netmask 255.0.0.0<br>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;<br>        loop  txqueuelen 1000  (Local Loopback)<br>        RX packets 137  bytes 11552 (11.5 KB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 137  bytes 11552 (11.5 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>root@jenkins-slave2:~<span class="hljs-comment"># sysctl -a | grep local</span><br>fs.nfs.nsm_local_state = 0<br>net.ipv4.conf.all.accept_local = 0<br>net.ipv4.conf.all.route_localnet = 0<br>net.ipv4.conf.default.accept_local = 0<br>net.ipv4.conf.default.route_localnet = 0<br>net.ipv4.conf.eth0.accept_local = 0<br>net.ipv4.conf.eth0.route_localnet = 0<br>net.ipv4.conf.lo.accept_local = 0<br>net.ipv4.conf.lo.route_localnet = 0<br>net.ipv4.igmp_link_local_mcast_reports = 1<br>net.ipv4.ip_local_port_range = 10001	65000<br>net.ipv4.ip_local_reserved_ports = <br>net.ipv4.ip_nonlocal_bind = 0<br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.all.stable_secret&quot;</span><br>net.ipv6.conf.all.accept_ra_from_local = 0<br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.default.stable_secret&quot;</span><br>net.ipv6.conf.default.accept_ra_from_local = 0<br>sysctl: net.ipv6.conf.eth0.accept_ra_from_local = 0<br>reading key <span class="hljs-string">&quot;net.ipv6.conf.eth0.stable_secret&quot;</span><br>sysctl: reading key <span class="hljs-string">&quot;net.ipv6.conf.lo.stable_secret&quot;</span><br>net.ipv6.conf.lo.accept_ra_from_local = 0<br>net.ipv6.ip_nonlocal_bind = 0<br>root@jenkins-slave2:~<span class="hljs-comment"># vim /etc/sysctl.conf</span><br><span class="hljs-comment">#添加</span><br>net.ipv4.ip_nonlocal_bind = 1<br>root@jenkins-slave2:~<span class="hljs-comment"># sysctl -p</span><br></code></pre></td></tr></table></figure>

<h2 id="3-4-java-环境"><a href="#3-4-java-环境" class="headerlink" title="3.4 java 环境"></a>3.4 java 环境</h2><p>各 web 服务器准备 tomcat 运行环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#全部web服务器都要配置，只演示web1</span><br>root@web1:~<span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment">#下载jdk</span><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># tar xf jdk-8u241-linux-x64.tar.gz</span><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/jdk1.8.0_241 /usr/local/jdk</span><br><span class="hljs-string">&#x27;/usr/local/jdk&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/jdk1.8.0_241&#x27;</span><br><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># vim /etc/profile</span><br>（直接在最后添加）<br><span class="hljs-built_in">export</span> HISTTIMEFORMAT=<span class="hljs-string">&quot;%F %T `whoami` &quot;</span><br><span class="hljs-built_in">export</span> <span class="hljs-built_in">export</span> LANG=<span class="hljs-string">&quot;en_US.utf-8&quot;</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/dt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin<br><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># source /etc/profile &amp;&amp; java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_241&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_241-b07)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.241-b07, mixed mode)<br><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># mkdir /apps</span><br>root@web1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># cd /apps/</span><br><span class="hljs-comment">#下载tomcat</span><br>root@web1:/apps<span class="hljs-comment"># tar xf apache-tomcat-8.5.46.tar.gz</span><br>root@web1:/apps<span class="hljs-comment"># ln -sv apache-tomcat-8.5.46 /apps/tomcat</span><br><span class="hljs-string">&#x27;/apps/tomcat&#x27;</span> -&gt; <span class="hljs-string">&#x27;apache-tomcat-8.5.46&#x27;</span><br>root@web1:/apps<span class="hljs-comment"># ll</span><br>total 11364<br>drwxr-xr-x  3 root root     4096 Apr 11 12:33 ./<br>drwxr-xr-x 24 root root     4096 Apr 11 12:33 ../<br>drwxr-xr-x  9 root root     4096 Apr 11 12:33 apache-tomcat-8.5.46/<br>-rw-r--r--  1 root root 11623939 Apr 11 12:33 apache-tomcat-8.5.46.tar.gz<br>lrwxrwxrwx  1 root root       20 Apr 11 12:33 tomcat -&gt; apache-tomcat-8.5.46/<br></code></pre></td></tr></table></figure>

<h2 id="3-4-准备-tomcat-启动脚本"><a href="#3-4-准备-tomcat-启动脚本" class="headerlink" title="3.4 准备 tomcat 启动脚本"></a>3.4 准备 tomcat 启动脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@web1:/apps<span class="hljs-comment"># vim /etc/init.d/tomcat</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># #########################################################</span><br><span class="hljs-comment"># Tomcat init script for     &quot;中企动力科技股份有限公司&quot;####</span><br><span class="hljs-comment">###########################################################</span><br><span class="hljs-comment"># chkconfig: 2345 96 14 ###################################</span><br><span class="hljs-comment"># description: 2016/11/1.  张士杰##########################</span><br><span class="hljs-comment"># #########################################################</span><br><br>JDK_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br>CATALINA_HOME=/apps/tomcat<br><span class="hljs-built_in">export</span> JDK_HOME CATALINA_HOME<br><span class="hljs-built_in">source</span> /etc/profile<br><span class="hljs-comment">#PID=`ps -ef  | grep  -v grep  | grep java | awk  &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="hljs-comment">#NUM=`ps -ef  | grep  -v grep  | grep java | awk  &#x27;&#123;print $2&#125;&#x27; | wc -l`</span><br><br><span class="hljs-comment">#case $1 in</span><br><span class="hljs-function"><span class="hljs-title">start</span></span>() &#123;<br>    	<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;正在判断服务状态，请稍等！&quot;</span>	<br>    	<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;请稍等3秒钟&quot;</span><br>    	<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span>;sleep 1<br>   	<span class="hljs-keyword">if</span>	netstat -an | grep 8080 | grep LISTEN &gt;/dev/null<br>     	<span class="hljs-keyword">then</span><br>   		<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat已经正在运行了！&quot;</span>  <br>  	<span class="hljs-keyword">else</span> <br>   		<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat没有运行，1秒后启动！&quot;</span><br>		<span class="hljs-built_in">echo</span> 1;sleep 1  <br>  		<span class="hljs-variable">$CATALINA_HOME</span>/bin/catalina.sh start <br>  		<span class="hljs-built_in">echo</span>  <span class="hljs-string">&quot;Tomcat 已经成功启动完成,5秒后判断是否启动成功&quot;</span><br>  		<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;5&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;4&quot;</span>;sleep 1<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span>;sleep 1<br>	<span class="hljs-keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null<br>	    <span class="hljs-keyword">then</span><br>		PID=`ps -ef | grep  tomcat | grep jdk | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>		NUM=`ps -ef | grep  tomcat | grep jdk | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | wc -l`<br>		<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat 已经成功启动<span class="hljs-variable">$&#123;NUM&#125;</span> 个Tomcat进程!,PID为<span class="hljs-variable">$&#123;PID&#125;</span>&quot;</span><br>	    <span class="hljs-keyword">else</span><br>		<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat启动失败，请重新启动！&quot;</span><br>        	<span class="hljs-built_in">echo</span> 1<br>	<span class="hljs-keyword">fi</span><br> 	<span class="hljs-keyword">fi</span><br>	&#125;<br><span class="hljs-function"><span class="hljs-title">stop</span></span>() &#123;<br>		PID=`ps -ef  | grep  -v grep  | grep java | awk  <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>		NUM=`ps -ef | grep  -v <span class="hljs-string">&quot;color&quot;</span>  | grep tomcat | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | wc -l`<br>		<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;正在判断服务状态，请稍等3秒钟！&quot;</span>	<br>		<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span>;sleep 1<br>	<span class="hljs-keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null <br>	   <span class="hljs-keyword">then</span>	<br>		<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat运行中，1秒后关闭！&quot;</span><br>		<span class="hljs-built_in">echo</span>  1;sleep 1 <br>		<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;即将关闭Tomcat服务，请稍等！&quot;</span> <br>        <span class="hljs-variable">$CATALINA_HOME</span>/bin/catalina.sh stop ;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！&quot;</span> <span class="hljs-comment">#公司用设置为30秒</span><br>		sleep 2 <span class="hljs-comment">#公司用设置为27</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span>;sleep 1<br>		pkill java &amp;&amp; pkill tomcat<br>		<span class="hljs-keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null;<span class="hljs-keyword">then</span><br>			PID=`ps -ef  | grep  -v grep  | grep java | awk  <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>			NUM=`ps -ef | grep  -v <span class="hljs-string">&quot;color&quot;</span>  | grep tomcat | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | wc -l`<br>			<span class="hljs-built_in">kill</span> -9 <span class="hljs-variable">$PID</span> ;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;已成功关闭<span class="hljs-variable">$&#123;NUM&#125;</span> 个tomcat进程&quot;</span><br>		<span class="hljs-keyword">else</span><br>  			<span class="hljs-built_in">echo</span>  <span class="hljs-string">&quot;Tomcat 已经关闭完成！&quot;</span> <br>        	<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2&quot;</span>;sleep 1;<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span>;sleep 1 <br>		<span class="hljs-keyword">fi</span><br>	<span class="hljs-keyword">else</span><br>		<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Tomcat 没有运行&quot;</span><br>		<span class="hljs-built_in">echo</span> 1<br>	<span class="hljs-keyword">fi</span><br>	<span class="hljs-keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null;<span class="hljs-keyword">then</span><br>            PID=`ps -ef  | grep  -v grep  | grep java | awk  <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>            <span class="hljs-comment">#NUM=`ps -ef | grep  -v &quot;color&quot;  | grep tomcat | awk &#x27;&#123;print $2&#125;&#x27; | wc -l`</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;关闭失败，即将强制删除tomcat进程!&quot;</span><br>            sleep 2<br>            pkill tomcat ;sleep 2 <br>            <span class="hljs-keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null;<span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;强制关闭失败，即将再次强制删除tomcat进程!&quot;</span><br>                pkill java; sleep 2<br>            <span class="hljs-keyword">fi</span><br>	<span class="hljs-keyword">fi</span><br>	&#125;<br><span class="hljs-function"><span class="hljs-title">restart</span></span>() &#123;<br>	stop <br>	start <br> &#125;<br><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-keyword">in</span> <br>start) <br>start <br>;; <br><br>stop) <br>stop <br>;; <br><br>restart) <br>restart <br>;; <br><br>*) <br><span class="hljs-built_in">echo</span> $<span class="hljs-string">&quot;Usage: <span class="hljs-variable">$0</span> &#123;start|stop|restart|status&#125;&quot;</span> <br><span class="hljs-keyword">esac</span><br><br>root@web1:/apps<span class="hljs-comment"># scp /etc/init.d/tomcat 10.0.0.106:/etc/init.d/</span><br>root@web1:/apps<span class="hljs-comment"># scp /etc/init.d/tomcat 10.0.0.107:/etc/init.d/</span><br>root@web1:/apps<span class="hljs-comment"># chmod a+x /etc/init.d/tomcat</span><br>root@web2:/apps<span class="hljs-comment"># chmod a+x /etc/init.d/tomcat</span><br>root@web3:/apps<span class="hljs-comment"># chmod a+x /etc/init.d/tomcat</span><br></code></pre></td></tr></table></figure>

<h2 id="3-5-web-部署"><a href="#3-5-web-部署" class="headerlink" title="3.5 web 部署"></a>3.5 web 部署</h2><p><strong>部署 web 服务器并确认各 web 服务器访问正常</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#全部web服务器都要配置，只演示web1</span><br>root@web1:/apps<span class="hljs-comment"># useradd -m www -u 2020 -s /bin/bash #创建账户</span><br>root@web1:/apps<span class="hljs-comment"># chown www.www /apps/ -R #修改属主和属组</span><br><span class="hljs-comment">#测试tomcat是否能成功启动</span><br>root@web1:/apps<span class="hljs-comment"># su - www</span><br>www@web1:~$ /etc/init.d/tomcat start<br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Using CATALINA_BASE:   /apps/tomcat<br>Using CATALINA_HOME:   /apps/tomcat<br>Using CATALINA_TMPDIR: /apps/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为1486<br>www@web1:~$ ps -ef | grep tomcat<br>www        1486      1  2 12:59 pts/0    00:00:02 /usr/<span class="hljs-built_in">local</span>/jdk/bin/java -Djava.util.logging.config.file=/apps/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/apps/tomcat -Dcatalina.home=/apps/tomca -Djava.io.tmpdir=/apps/tomcat/temp org.apache.catalina.startup.Bootstrap start<br>www        1552   1455  0 13:01 pts/0    00:00:00 grep --color=auto tomcat<br><span class="hljs-comment">#使用浏览器访问10.0.0.105:8080 10.0.0.106:8080 10.0.0.107:8080，可以看见tomcat的页面</span><br><span class="hljs-comment">#使用浏览器访问10.0.0.248（使用负载均衡访问）</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another1.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another2.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another3.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another4.png" srcset="/blog/img/loading.gif"></p>
<h2 id="3-6-配置-tomcat-配置文件"><a href="#3-6-配置-tomcat-配置文件" class="headerlink" title="3.6 配置 tomcat 配置文件"></a>3.6 配置 tomcat 配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@web1:~<span class="hljs-comment"># mkdir /data/tomcat/tomcat_appdir -p </span><br><span class="hljs-comment">#保存 web 压缩包，同时保存之前版本的备份，保存5个版本之后每多出一个版本就删除最前的一个版本</span><br><span class="hljs-comment">#例如：文件夹中保存了 #myapp_2020_04_01-14-04-50.tar.gz #myapp_2020_04_01-14-30-40.tar.gz</span><br><br>root@web1:~<span class="hljs-comment"># mkdir /data/tomcat/tomcat_webdir </span><br><span class="hljs-comment">#保存解压后的 web 目录，同时保存之前版本的备份，保存5个版本之后每多出一个版本就删除最前的一个版本</span><br><span class="hljs-comment">#例如：文件夹中保存了 #myapp_2020_04_01-14-04-50 #myapp_2020_04_01-14-30-40</span><br><br>root@web1:~<span class="hljs-comment"># mkdir /data/tomcat/tomcat_webapps </span><br><span class="hljs-comment">#tomcat app 加载目录，在 server.xml 定义</span><br><span class="hljs-comment">#在 &lt;Host name=&quot;localhost&quot; appBase=&quot;/data/tomcat/tomcat_webapps&quot; unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt; </span><br><span class="hljs-comment">#/data/tomcat/tomcat_Webapps --&gt; /data/tomcat/tomcat_webdir/myapp_2020_04_01-14-30-40</span><br><br>root@web1:~<span class="hljs-comment"># vim /apps/tomcat/conf/server.xml</span><br>......<br><span class="hljs-comment">#只要修改appBase那里的地址就可以</span><br> &lt;Host name=<span class="hljs-string">&quot;localhost&quot;</span>  appBase=<span class="hljs-string">&quot;/data/tomcat/tomcat_webapps&quot;</span><br>            unpackWARs=<span class="hljs-string">&quot;false&quot;</span> autoDeploy=<span class="hljs-string">&quot;false&quot;</span>&gt;<br><br>root@web1:~<span class="hljs-comment"># mkdir /data/tomcat/tomcat_webapps/myapp #Java 代码目录</span><br><span class="hljs-comment">#根据各自服务器IP输入内容</span><br>root@web1:~<span class="hljs-comment"># echo 10.0.0.105 &gt; /data/tomcat/tomcat_webapps/myapp/index.html</span><br><br>root@web1:~<span class="hljs-comment"># chown www.www /data/tomcat/ -R</span><br>root@web1:~<span class="hljs-comment"># ll /data/tomcat/</span><br>total 20<br>drwxr-xr-x 5 www  www  4096 Apr 11 22:22 ./<br>drwxr-xr-x 3 root root 4096 Apr 11 22:21 ../<br>drwxr-xr-x 2 www  www  4096 Apr 11 22:21 tomcat_appdir/<br>drwxr-xr-x 2 www  www  4096 Apr 11 22:22 tomcat_webapps/<br>drwxr-xr-x 2 www  www  4096 Apr 11 22:22 tomcat_webdir/<br></code></pre></td></tr></table></figure>

<h2 id="3-7-启动-tomcat"><a href="#3-7-启动-tomcat" class="headerlink" title="3.7 启动 tomcat"></a>3.7 启动 tomcat</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#重启tomcat</span><br>root@web1:~<span class="hljs-comment"># su - www</span><br>www@web1:~$ /etc/init.d/tomcat restart<br>正在判断服务状态，请稍等3秒钟！<br>3<br>2<br>1<br>Tomcat运行中，1秒后关闭！<br>1<br>即将关闭Tomcat服务，请稍等！<br>Using CATALINA_BASE:   /apps/tomcat<br>Using CATALINA_HOME:   /apps/tomcat<br>Using CATALINA_TMPDIR: /apps/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br>3<br>2<br>1<br>Tomcat 已经关闭完成！<br>3<br>2<br>1<br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Using CATALINA_BASE:   /apps/tomcat<br>Using CATALINA_HOME:   /apps/tomcat<br>Using CATALINA_TMPDIR: /apps/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为2013<br></code></pre></td></tr></table></figure>

<h2 id="3-8-确认各-web-服务器访问正常"><a href="#3-8-确认各-web-服务器访问正常" class="headerlink" title="3.8 确认各 web 服务器访问正常"></a>3.8 确认各 web 服务器访问正常</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#浏览器访问</span><br><span class="hljs-comment">#10.0.0.105:8080,10.0.0.106:8080,10.0.0.107:8080</span><br><span class="hljs-comment">#对比</span><br><span class="hljs-comment">#10.0.0.105:8080/myapp,10.0.0.106:8080/myapp,10.0.0.107:8080/myapp</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another5.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another6.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another7.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another8.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another9.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another10.png" srcset="/blog/img/loading.gif"></p>
<h2 id="3-9-测试访问"><a href="#3-9-测试访问" class="headerlink" title="3.9 测试访问"></a>3.9 测试访问</h2><p><strong>测试 haproxy 反向代理 web 服务器：</strong></p>
<p>编辑本机 hosts 文件，将 myapp.web.com 解析到对应的 IP 负载 IP：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">C:\Windows\System32\drivers\etc\hosts<br>10.0.0.248 myapp.web.com<br></code></pre></td></tr></table></figure>

<p>开启日志文件服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/rsyslog.conf </span><br>14 <span class="hljs-comment"># Provides UDP syslog reception</span><br>15 <span class="hljs-variable">$ModLoad</span> imudp <span class="hljs-comment">#去掉注释</span><br>16 <span class="hljs-variable">$UDPServerRun</span> 514 <span class="hljs-comment">#去掉注释</span><br>18 <span class="hljs-comment"># Provides TCP syslog reception</span><br>19 <span class="hljs-variable">$ModLoad</span> imtcp <span class="hljs-comment">#去掉注释</span><br>20 <span class="hljs-variable">$InputTCPServerRun</span> 514 <span class="hljs-comment">#去掉注释</span><br>93 local3.* /var/<span class="hljs-built_in">log</span>/haproxy.log<br><br>root@jenkins-slave1:~<span class="hljs-comment"># systemctl restart rsyslog</span><br></code></pre></td></tr></table></figure>

<p>配置 HAProxy 访问日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>......<br>listen linux-web-80<br>  <span class="hljs-built_in">bind</span> 10.0.0.248:80<br>  mode http<br>  server 10.0.0.105 10.0.0.105:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.106 10.0.0.106:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.107 10.0.0.107:8080 check inter 2s fall 3 rise 5<br><br><span class="hljs-built_in">log</span> 127.0.0.1 local3 info <br>  listen web_port<br>  <span class="hljs-built_in">bind</span> 0.0.0.0:80<br>  mode http<br>  <span class="hljs-built_in">log</span> global<br>  option httplog<br>  server 10.0.0.105 10.0.0.105:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.106 10.0.0.106:8080 check inter 2s fall 3 rise 5<br>  server 10.0.0.107 10.0.0.107:8080 check inter 2s fall 3 rise 5<br></code></pre></td></tr></table></figure>

<p><strong>重启 rsyslog 和 haproxy 服务，验证/var/log/haproxy.log 可以记录日志：</strong></p>
<p>浏览器访问：<a target="_blank" rel="noopener" href="http://myapp.web.com/myapp/">http://myapp.web.com/myapp/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-56.png" srcset="/blog/img/loading.gif"></p>
<h2 id="3-10-验证-HAProxy-统计页面"><a href="#3-10-验证-HAProxy-统计页面" class="headerlink" title="3.10 验证 HAProxy 统计页面"></a>3.10 验证 HAProxy 统计页面</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>.....<br>        errorfile 504 /etc/haproxy/errors/504.http<br><br>listen stats<br> mode http<br> <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br> stats <span class="hljs-built_in">enable</span><br> <span class="hljs-built_in">log</span> global<br> stats uri     /haproxy-status<br> stats auth    haadmin:q1w2e3r4ys <span class="hljs-comment">#账号和密码</span><br><br><br>listen linux-web-80<br>  <span class="hljs-built_in">bind</span> 10.0.0.248:80<br>......<br>root@jenkins-slave1:~<span class="hljs-comment"># systemctl restart haproxy</span><br><br>root@jenkins-slave2:~<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>.....<br>        errorfile 504 /etc/haproxy/errors/504.http<br><br>listen stats<br> mode http<br> <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br> stats <span class="hljs-built_in">enable</span><br> <span class="hljs-built_in">log</span> global<br> stats uri     /haproxy-status<br> stats auth    haadmin:q1w2e3r4ys <span class="hljs-comment">#账号和密码</span><br><br><br>listen linux-web-80<br>  <span class="hljs-built_in">bind</span> 10.0.0.248:80<br>......<br>root@jenkins-slave2:~<span class="hljs-comment"># systemctl restart haproxy</span><br></code></pre></td></tr></table></figure>

<p>浏览器访问：</p>
<p><a target="_blank" rel="noopener" href="http://10.0.0.103:9999/haproxy-status">http://10.0.0.103:9999/haproxy-status</a></p>
<p><a target="_blank" rel="noopener" href="http://10.0.0.104:9999/haproxy-status">http://10.0.0.104:9999/haproxy-status</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-57.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-58.png" srcset="/blog/img/loading.gif"></p>
<h2 id="3-11-验证-haproxy-代理-web-服务器"><a href="#3-11-验证-haproxy-代理-web-服务器" class="headerlink" title="3.11 验证 haproxy 代理 web 服务器"></a>3.11 验证 haproxy 代理 web 服务器</h2><p><a target="_blank" rel="noopener" href="http://myapp.web.com/myapp/">http://myapp.web.com/myapp/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-59.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-60.png" srcset="/blog/img/loading.gif"></p>
<h1 id="四、Jenkins部署于基础配置"><a href="#四、Jenkins部署于基础配置" class="headerlink" title="四、Jenkins部署于基础配置"></a>四、Jenkins部署于基础配置</h1><p><a target="_blank" rel="noopener" href="https://www.jenkins.io/zh/">https://www.jenkins.io/zh/</a></p>
<p>基于java开发，每12周（3个月或一个季度）发布一个TLS版本</p>
<p>公司配置：</p>
<p>4核CPU 8G内存 60G磁盘</p>
<p>8核CPU 16G内存 60G以上的磁盘</p>
<h2 id="4-1-配置-java-环境并署部署-jenkins"><a href="#4-1-配置-java-环境并署部署-jenkins" class="headerlink" title="4.1 配置 java 环境并署部署 jenkins"></a>4.1 配置 java 环境并署部署 jenkins</h2><h3 id="4-1-1-java-环境配置（在公司一定要用oracale的jdk）"><a href="#4-1-1-java-环境配置（在公司一定要用oracale的jdk）" class="headerlink" title="4.1.1 java 环境配置（在公司一定要用oracale的jdk）"></a>4.1.1 java 环境配置（在公司一定要用oracale的jdk）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment">#下载jdk</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># tar xvf jdk-8u192-linux-x64.tar.gz</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/jdk1.8.0_192/ /usr/local/jdk</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/jdk/bin/java /usr/bin/ #java 命令软连接</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$JAVA_HOME</span>/jre/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> CLASSPATH=.<span class="hljs-variable">$CLASSPATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/lib:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># source /etc/profile</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_192&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_192-b12)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.192-b12, mixed mode)<br></code></pre></td></tr></table></figure>

<h3 id="4-1-2-启动-Jenkins"><a href="#4-1-2-启动-Jenkins" class="headerlink" title="4.1.2 启动 Jenkins"></a>4.1.2 启动 Jenkins</h3><h4 id="4-1-2-1-下载并安装jenkins"><a href="#4-1-2-1-下载并安装jenkins" class="headerlink" title="4.1.2.1 下载并安装jenkins"></a>4.1.2.1 下载并安装jenkins</h4><p>下载安装包地址</p>
<p><a target="_blank" rel="noopener" href="https://www.jenkins.io/zh/download/">https://www.jenkins.io/zh/download/</a></p>
<p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/debian-stable/">https://mirrors.tuna.tsinghua.edu.cn/jenkins/debian-stable/</a> #ubuntu 安装包下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载daemon</span><br>root@jenkins-master:~<span class="hljs-comment"># apt install -y daemon</span><br><span class="hljs-comment">#安装Jenkins</span><br>root@jenkins-master:~<span class="hljs-comment"># dpkg -i jenkins_2.222.4_all.deb</span><br><span class="hljs-comment">#如有报错如下</span><br>Mar 08 20:53:10 jenkins-master.magedu.net systemd[1]: Starting LSB: Start Jenkins atboot time...<br>Mar 08 20:53:10 jenkins-master.magedu.net jenkins[17981]: ERROR: No Java executablefound <span class="hljs-keyword">in</span> current PATH: /bin:/usr/bin:/sbin:/usr/sbin<br>Mar 08 20:53:10 jenkins-master.magedu.net jenkins[17981]: If you actually have javainstalled on the system make sure the executable is <span class="hljs-keyword">in</span> the aforementioned path and that<span class="hljs-string">&#x27;type -p java&#x27;</span> returns the java executable path<br>Mar 08 20:53:10 jenkins-master.magedu.net systemd[1]: jenkins.service: Control processexited, code=exited status=1<br>Mar 08 20:53:10 jenkins-master.magedu.net systemd[1]: jenkins.service: Failed withresult <span class="hljs-string">&#x27;exit-code&#x27;</span>.<br><span class="hljs-comment">#解决方案：</span><br>root@jenkins-master:/var/<span class="hljs-built_in">log</span><span class="hljs-comment"># ln -sv /usr/local/jdk/bin/java /usr/bin/</span><br><span class="hljs-string">&#x27;/usr/bin/java&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/jdk/bin/java&#x27;</span><br><br><span class="hljs-comment">#查看安装的路径及文件</span><br>root@jenkins-master:~<span class="hljs-comment"># dpkg -c jenkins_2.222.4_all.deb </span><br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./etc/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./etc/default/<br>-rw-r--r-- root/root      2775 2020-03-04 02:00 ./etc/default/jenkins<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./etc/init.d/<br>-rwxr-xr-x root/root      7860 2020-03-04 02:00 ./etc/init.d/jenkins<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./etc/logrotate.d/<br>-rw-r--r-- root/root       191 2020-03-04 02:00 ./etc/logrotate.d/jenkins<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./usr/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./usr/share/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./usr/share/doc/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./usr/share/doc/jenkins/<br>-rw-r--r-- root/root       138 2020-03-04 02:00 ./usr/share/doc/jenkins/changelog.gz<br>-rw-r--r-- root/root      1498 2020-03-04 02:00 ./usr/share/doc/jenkins/copyright<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./usr/share/jenkins/<br>-rw-r--r-- root/root  64118165 2020-03-04 02:00 ./usr/share/jenkins/jenkins.war<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/cache/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/cache/jenkins/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/lib/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/lib/jenkins/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/<span class="hljs-built_in">log</span>/<br>drwxr-xr-x root/root         0 2020-03-04 02:00 ./var/<span class="hljs-built_in">log</span>/jenkins/<br><span class="hljs-comment">#jenkins配置文件</span><br>root@jenkins-master:~<span class="hljs-comment"># vim /etc/default/jenkins</span><br><span class="hljs-comment">#（修改的参数参考下面，但是一般就修改MAXOPENFILES）</span><br>root@jenkins-master:~<span class="hljs-comment"># grep &quot;^[a-Z]&quot; /etc/default/jenkins</span><br>NAME=jenkins<br>JAVA_ARGS=<span class="hljs-string">&quot;-Djava.awt.headless=true&quot;</span><br>PIDFILE=/var/run/<span class="hljs-variable">$NAME</span>/<span class="hljs-variable">$NAME</span>.pid<br>JENKINS_USER=<span class="hljs-variable">$NAME</span><br>JENKINS_GROUP=<span class="hljs-variable">$NAME</span><br>JENKINS_WAR=/usr/share/<span class="hljs-variable">$NAME</span>/<span class="hljs-variable">$NAME</span>.war<br>JENKINS_HOME=/var/lib/<span class="hljs-variable">$NAME</span><br>RUN_STANDALONE=<span class="hljs-literal">true</span><br>JENKINS_LOG=/var/<span class="hljs-built_in">log</span>/<span class="hljs-variable">$NAME</span>/<span class="hljs-variable">$NAME</span>.<span class="hljs-built_in">log</span><br>JENKINS_ENABLE_ACCESS_LOG=<span class="hljs-string">&quot;no&quot;</span><br>MAXOPENFILES=65536<br>HTTP_PORT=8080<br>PREFIX=/<span class="hljs-variable">$NAME</span><br>JENKINS_ARGS=<span class="hljs-string">&quot;--webroot=/var/cache/<span class="hljs-variable">$NAME</span>/war --httpPort=<span class="hljs-variable">$HTTP_PORT</span>&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-2-2-启动并验证Jenkins"><a href="#4-1-2-2-启动并验证Jenkins" class="headerlink" title="4.1.2.2 启动并验证Jenkins"></a>4.1.2.2 启动并验证Jenkins</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启动jenkins</span><br>root@jenkins-master:~<span class="hljs-comment"># systemctl start jenkins</span><br><span class="hljs-comment">#设置为开机启动</span><br>root@jenkins-master:~<span class="hljs-comment"># systemctl enable jenkins</span><br>jenkins.service is not a native service, redirecting to systemd-sysv-install.<br>Executing: /lib/systemd/systemd-sysv-install <span class="hljs-built_in">enable</span> jenkins<br><br><span class="hljs-comment">#检查Jenkins是否启动成功</span><br>root@jenkins-master:/<span class="hljs-comment"># ps -ef|grep jenkins</span><br>jenkins    4759      1  0 22:14 ?        00:00:00 /lib/systemd/systemd --user<br>jenkins    4760   4759  0 22:14 ?        00:00:00 (sd-pam)<br>jenkins    4774      1  0 22:14 ?        00:00:00 /usr/bin/daemon --name=jenkins --inherit --env=JENKINS_HOME=/var/lib/jenkins --output=/var/<span class="hljs-built_in">log</span>/jenkins/jenkins.log --pidfile=/var/run/jenkins/jenkins.pid -- /usr/bin/java -Djava.awt.headless=<span class="hljs-literal">true</span> -jar /usr/share/jenkins/jenkins.war --webroot=/var/cache/jenkins/war --httpPort=8080<br>jenkins    4776   4774 99 22:14 ?        00:00:10 /usr/bin/java -Djava.awt.headless=<span class="hljs-literal">true</span> -jar /usr/share/jenkins/jenkins.war --webroot=/var/cache/jenkins/war --httpPort=8080<br>root       4826   3091  0 22:14 pts/1    00:00:00 grep --color=auto jenkins<br><br><span class="hljs-comment">#jenkins默认监听8080端口</span><br>root@jenkins-master:/<span class="hljs-comment"># lsof -i:8080</span><br>COMMAND  PID    USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>java    5207 jenkins  155u  IPv6  83563      0t0  TCP *:http-alt (LISTEN)<br></code></pre></td></tr></table></figure>

<h4 id="4-1-2-3-验证Jenkins启动日志"><a href="#4-1-2-3-验证Jenkins启动日志" class="headerlink" title="4.1.2.3 验证Jenkins启动日志"></a>4.1.2.3 验证Jenkins启动日志</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:/<span class="hljs-comment"># vim /var/log/jenkins/jenkins.log</span><br>*************************************************************<br>*************************************************************<br>*************************************************************<br>Jenkins initial setup is required. An admin user has been created and a password generated.<br>Please use the following password to proceed to installation: d2ef5aeb070b476f81b84c51b598582b<br>This may also be found at: /var/lib/jenkins/secrets/initialAdminPassword<br>*************************************************************<br>*************************************************************<br>*************************************************************<br>2020-03-08 12:54:48.118+0000 [id=28]  INFO  hudson.model.UpdateSite<span class="hljs-comment">#updateData: Obtained the latest update center data file for UpdateSource default</span><br>2020-03-08 12:54:48.310+0000 [id=25]  INFO  jenkins.InitReactorRunner<span class="hljs-variable">$1</span><span class="hljs-comment">#onAttained: Completed initialization</span><br>2020-03-08 12:54:48.319+0000 [id=19]  INFO  hudson.WebAppMain<span class="hljs-variable">$3</span><span class="hljs-comment">#run: Jenkins is fully up and running</span><br>2020-03-08 12:56:16.536+0000 [id=41]  INFO  hudson.model.UpdateSite<span class="hljs-comment">#updateData: Obtained the latest update center data file for UpdateSource default</span><br>2020-03-08 12:56:17.711+0000 [id=41]  INFO  h.m.DownloadService<span class="hljs-variable">$Downloadable</span><span class="hljs-comment">#load: Obtained the updated data file for hudson.tasks.Maven.MavenInstaller</span><br>2020-03-08 12:56:17.711+0000 [id=41]  INFO  hudson.util.Retrier<span class="hljs-comment">#start: Performed the action check updates server successfully at the attempt #1</span><br>2020-03-08 12:56:17.713+0000 [id=41]  INFO hudson.model.AsyncPeriodicWork<span class="hljs-comment">#lambda$doRun$0: Finished Download metadata. 103,150 ms</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-2-4-访问web界面"><a href="#4-1-2-4-访问web界面" class="headerlink" title="4.1.2.4 访问web界面"></a>4.1.2.4 访问web界面</h4><p>浏览器访问：10.0.0.102:8080</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another12.png" srcset="/blog/img/loading.gif"></p>
<p>获取密码的地址</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another13.png" srcset="/blog/img/loading.gif" alt="another13"></p>
<p>查看密码，并粘贴到浏览器里</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another14.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-1-2-2-通过-jar-包直接启动-jenkins"><a href="#4-1-2-2-通过-jar-包直接启动-jenkins" class="headerlink" title="4.1.2.2 通过 jar 包直接启动 jenkins"></a>4.1.2.2 通过 jar 包直接启动 jenkins</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载jdk-8u241-linux-x64.tar.gz，jenkins.war</span><br><br><span class="hljs-comment">#解压jdk，设置软连接</span><br><br><span class="hljs-comment">#配置环境变量</span><br><br><span class="hljs-comment">#安装Jenkins</span><br>java -jar jenkins.war &amp;<br><span class="hljs-comment">#或（添加参数）</span><br>java \<br>-Dcom.sun.management.jmxremote \<br>-Dcom.sun.management.jmxremote.port=12345 \<br>-Dcom.sun.management.jmxremote.authenticate=<span class="hljs-literal">false</span> \<br>-Dcom.sun.management.jmxremote.ssl=<span class="hljs-literal">false</span> \<br>-Djava.rmi.server.hostname=<span class="hljs-string">&quot;192.168.8.2 &quot;</span> \<br>-jar jenkins-2.138.3.war &amp;<br><span class="hljs-comment">#详细的参数添加：java -jar jenkins.war --help</span><br><br><span class="hljs-comment">#使用nginx反向代理，修改hosts文件</span><br><br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-2-3-使用-tomcat-安装-Jenkins"><a href="#4-1-2-3-使用-tomcat-安装-Jenkins" class="headerlink" title="4.1.2.3 使用 tomcat 安装 Jenkins"></a>4.1.2.3 使用 tomcat 安装 Jenkins</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkdir /apps<br><span class="hljs-comment">#下载tomcat(如：apache-tpmcat-8.5.46.tar.gz)和jenkins.war到/apps里</span><br><span class="hljs-comment">#解压tomcat</span><br><span class="hljs-comment">#将jenkins.war拷贝到apache-tomcat-8.5.46/webapps里</span><br><span class="hljs-comment">#解压jenkins.war</span><br>unzip jenkins.war -d jenkins<br><span class="hljs-comment">#修改tomcat的server.xml</span><br>&lt;Host name=<span class="hljs-string">&quot;localhost&quot;</span>  appBase=<span class="hljs-string">&quot;webapps&quot;</span> unpackWARs=<span class="hljs-string">&quot;false&quot;</span> autoDeploy=<span class="hljs-string">&quot;false&quot;</span>&gt;<br><span class="hljs-comment">#开启tomcat /apps/apache-tomcat-8.5.46/bin/catalina.sh start</span><br><span class="hljs-comment">#浏览器打开ip:8080/Jenkins</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-2-4-rpm-包装安装-jenkins-配置"><a href="#4-1-2-4-rpm-包装安装-jenkins-配置" class="headerlink" title="4.1.2.4 rpm 包装安装 jenkins 配置"></a>4.1.2.4 rpm 包装安装 jenkins 配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@s1 ~]<span class="hljs-comment"># grep -v &quot;#&quot; /etc/sysconfig/jenkins | grep -v &quot;^$&quot;</span><br>JENKINS_HOME=<span class="hljs-string">&quot;/var/lib/jenkins&quot;</span><br>JENKINS_JAVA_CMD=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_USER=<span class="hljs-string">&quot;jenkins&quot;</span><br>JENKINS_JAVA_OPTIONS=<span class="hljs-string">&quot;-Djava.awt.headless=true \</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote \</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.port=12345 \</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.authenticate=false \</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.ssl=false \</span><br><span class="hljs-string">-Djava.rmi.server.hostname=&quot;</span>192.168.7.101<span class="hljs-string">&quot; \</span><br><span class="hljs-string">&quot;</span><br>JENKINS_PORT=<span class="hljs-string">&quot;8080&quot;</span><br>JENKINS_LISTEN_ADDRESS=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_HTTPS_PORT=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_HTTPS_KEYSTORE=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_HTTPS_KEYSTORE_PASSWORD=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_HTTPS_LISTEN_ADDRESS=<span class="hljs-string">&quot;&quot;</span><br>JENKINS_DEBUG_LEVEL=<span class="hljs-string">&quot;5&quot;</span><br>JENKINS_ENABLE_ACCESS_LOG=<span class="hljs-string">&quot;no&quot;</span><br>JENKINS_HANDLER_MAX=<span class="hljs-string">&quot;100&quot;</span><br>JENKINS_HANDLER_IDLE=<span class="hljs-string">&quot;20&quot;</span><br>JENKINS_ARGS=<span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment">#可选启动参数：</span><br>JENKINS_JAVA_OPTIONS=<span class="hljs-string">&quot;--server -Xms1g -Xmx1g -Xss512k -Xmn1g</span><br><span class="hljs-string">-XX:CMSInitiatingOccupancyFraction=65</span><br><span class="hljs-string">-XX:+UseFastAccessorMethods</span><br><span class="hljs-string">-XX:+AggressiveOpts -XX:+UseBiasedLocking</span><br><span class="hljs-string">-XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10</span><br><span class="hljs-string">-XX:NewSize=2048M -XX:MaxNewSize=2048M -XX:NewRatio=2</span><br><span class="hljs-string">-XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5</span><br><span class="hljs-string">-XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC</span><br><span class="hljs-string">-XX:+CMSParallelRemarkEnabled -Djava.awt.headless=true</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.port=12345</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.authenticate=false</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.ssl=false</span><br><span class="hljs-string">-Djava.rmi.server.hostname=&quot;</span>192.168.7.102<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="4-1-3-Jenkins-启动过程"><a href="#4-1-3-Jenkins-启动过程" class="headerlink" title="4.1.3 Jenkins 启动过程"></a>4.1.3 Jenkins 启动过程</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-61.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-1-4-访问-jenkins-页面"><a href="#4-1-4-访问-jenkins-页面" class="headerlink" title="4.1.4 访问 jenkins 页面"></a>4.1.4 访问 jenkins 页面</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-62.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-1-5-选择安装-jenkins-插件"><a href="#4-1-5-选择安装-jenkins-插件" class="headerlink" title="4.1.5 选择安装 jenkins 插件"></a>4.1.5 选择安装 jenkins 插件</h3><h4 id="4-1-5-0-Jenkins安装插件提速（直接使用最后一种）"><a href="#4-1-5-0-Jenkins安装插件提速（直接使用最后一种）" class="headerlink" title="4.1.5.0 Jenkins安装插件提速（直接使用最后一种）"></a>4.1.5.0 Jenkins安装插件提速（直接使用最后一种）</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hellxz/p/jenkins_install_plugins_faster.html">https://www.cnblogs.com/hellxz/p/jenkins_install_plugins_faster.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> <span class="hljs-variable">$JENKINS_HOME</span><br>curl -Lo update-center.json https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json<br>sed -i <span class="hljs-string">&#x27;s#http://updates.jenkins-ci.org/download#https://mirrors.tuna.tsinghua.edu.cn/jenkins#g&#x27;</span> update-center.json &amp;&amp; sed -i <span class="hljs-string">&#x27;s#http://www.google.com#https://www.baidu.com#g&#x27;</span> update-center.json<br><span class="hljs-comment">#安装Nginx</span><br>sudo apt install nginx -y<br><span class="hljs-comment">#移动配置到nginx默认web目录</span><br>sudo mv update-center.json /var/www/html/<br><span class="hljs-comment">#修改Jenkins配置文件</span><br>sed -i <span class="hljs-string">&quot;s#https://updates.jenkins.io/update-center.json#http://10.0.0.102/update-center.json#g&quot;</span> hudson.model.UpdateCenter.xml<br></code></pre></td></tr></table></figure>

<h4 id="4-1-5-1-解决插件安装慢的解决方式，通过-Nginx-进行-rewrite-或者反向代理"><a href="#4-1-5-1-解决插件安装慢的解决方式，通过-Nginx-进行-rewrite-或者反向代理" class="headerlink" title="4.1.5.1 解决插件安装慢的解决方式，通过 Nginx 进行 rewrite 或者反向代理"></a>4.1.5.1 解决插件安装慢的解决方式，通过 Nginx 进行 rewrite 或者反向代理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装nginx，最好是选择在其他服务器安装</span><br>root@web2:~<span class="hljs-comment"># cd /usr/local/src/</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># </span><br><span class="hljs-comment">#下载nginx</span><br><br><span class="hljs-comment">#解压nginx</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># tar xf nginx-1.16.1.tar.gz</span><br><br><span class="hljs-comment">#安装nginx</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># cd nginx-1.16.1/</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># ./configure --prefix=/apps/nginx</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># apt install -y make</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># make</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># make install</span><br><br><span class="hljs-comment">#修改nginx配置文件</span><br>root@web2:/usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1<span class="hljs-comment"># cd /apps/nginx/conf/</span><br>root@web2:/apps/nginx/conf<span class="hljs-comment"># vim nginx.conf</span><br>......<br>location /download/plugins &#123;<br>      proxy_set_header Host mirrors.tuna.tsinghua.edu.cn;<br>      proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>      proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>      rewrite /download/plugins(.*) /jenkins/plugins/<span class="hljs-variable">$1</span> <span class="hljs-built_in">break</span>;<br>      proxy_pass http://mirrors.tuna.tsinghua.edu.cn;<br>&#125;<br><br><span class="hljs-comment">#开启nginx</span><br>root@web2:/apps/nginx/conf<span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>root@web2:/apps/nginx/conf<span class="hljs-comment"># /apps/nginx/sbin/nginx</span><br><br>root@jenkins-master:~<span class="hljs-comment"># vim /etc/hosts</span><br>.....<br>10.0.0.106 updates.jenkins-ci.org <span class="hljs-comment">#添加hosts解析</span><br><br><span class="hljs-comment">#重启Jenkins</span><br>root@jenkins-master:~<span class="hljs-comment"># systemctl restart jenkins.service </span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-63.png" srcset="/blog/img/loading.gif"></p>
<p>如果现实 jenkins 已离线，将以下文件中的更新检查地址改成国内清华大学地址，然后重启 jenkins 即可：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cat /var/lib/jenkins/hudson.model.UpdateCenter.xml</span><br>&lt;?xml version=<span class="hljs-string">&#x27;1.1&#x27;</span> encoding=<span class="hljs-string">&#x27;UTF-8&#x27;</span>?&gt;<br>&lt;sites&gt;<br>&lt;site&gt;<br>&lt;id&gt;default&lt;/id&gt;<br>&lt;url&gt;https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json&lt;/url&gt;<br>&lt;/site&gt;<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-64.png" srcset="/blog/img/loading.gif"></p>
<p>注意：如重新刷新网页后还是离线状态，可以使用这个方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#寻找有关Jenkins的defalut.json文件</span><br>root@jenkins-master:~<span class="hljs-comment"># find / -name &quot;default.json&quot;</span><br>/var/lib/jenkins/updates/default.json<br><br><span class="hljs-comment">#先备份后修改文件</span><br>root@jenkins-master:~<span class="hljs-comment"># cd  /var/lib/jenkins/updates/</span><br>root@jenkins-master:/var/lib/jenkins/updates<span class="hljs-comment"># cp default.json default.json.bak</span><br>root@jenkins-master:/var/lib/jenkins/updates<span class="hljs-comment"># sed -i &#x27;s/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g&#x27; /var/lib/jenkins/updates/default.json &amp;&amp; sed -i &#x27;s/http:\/\/www.google.com/https:\/\/www.baidu.com/g&#x27; /var/lib/jenkins/updates/default.json</span><br><br><span class="hljs-comment">#重启Jenkins</span><br>root@jenkins-master:/var/lib/jenkins/updates<span class="hljs-comment"># systemctl restart jenkins.service</span><br></code></pre></td></tr></table></figure>

<p><strong>刷新浏览器</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another15.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-1-5-2-通过在jenkins网页里设置安装路径来安装插件"><a href="#4-1-5-2-通过在jenkins网页里设置安装路径来安装插件" class="headerlink" title="4.1.5.2 通过在jenkins网页里设置安装路径来安装插件"></a>4.1.5.2 通过在jenkins网页里设置安装路径来安装插件</h4><ol>
<li><p>跳过安装插件，直接设置账号密码，最后进入到jenkins界面</p>
</li>
<li><p>点击Manager Jenkins（插件管理）</p>
</li>
<li><p>点击Manage Plugins</p>
</li>
<li><p>点击Available，然后等待网页中插件目录加载完成</p>
</li>
<li><p>```bash<br>#回到xshell里<br>root@jenkins-master:~# cd /var/lib/jenkins/updates/<br>root@jenkins-master:/var/lib/jenkins/updates# sed -i ‘s/http://updates.jenkins-ci.org/download/https://mirrors.tuna.tsinghua.edu.cn/jenkins/g’ default.json &amp;&amp; sed -i ‘s/http://<a target="_blank" rel="noopener" href="http://www.google.com/https:////www.baidu.com/g&#39;">www.google.com/https:\/\/www.baidu.com/g&#39;</a> default.json</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br><span class="hljs-number">6</span>. Manage Plugins点击Advanced，把Update Site改为国内插件下载地址<br><br><span class="hljs-number">7</span>. 下载中文汉化插件 Jenkins-&gt;Manage Jenkins-&gt;Manage Plugins，点击Available，搜索<span class="hljs-string">&quot;Chinese&quot;</span><br><br>   ![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-another16.png)<br><br>   完成后如下图：<br><br>   ![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-another17.png)<br><br>   重启Jenkins后，就看到Jenkins汉化了！（PS：但可能部分菜单汉化会失败）<br><br>   ![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-another18.png)<br><br><span class="hljs-comment">### 4.1.6 插件安装过程中</span><br><br>http:<span class="hljs-regexp">//u</span>pdates.jenkins-ci.org<span class="hljs-regexp">/download/</span>plugins/ <span class="hljs-comment">#插件下载地址，在插件安装过程中如果因为某种原因导致有有安装失败的插件，没有关系，可以后期再单独安装。</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">65</span>.png)<br><br><span class="hljs-comment">### 4.1.7 创建 jenkins 管理员</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">66</span>.png)<br><br><span class="hljs-comment">### 4.1.8 配置 jenkins URL</span><br><br>（通常不需要更改，直接点击保存并完成即可）<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">67</span>.png)<br><br><span class="hljs-comment">### 4.1.9 配置完成并登陆 jenkins</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">68</span>.png)<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">69</span>.png)<br><br><span class="hljs-comment">### 4.1.10 登陆 jenkins 界面</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">70</span>.png)<br><br><span class="hljs-comment">### 4.1.11 jenkins 插件管理及安装</span><br><br><span class="hljs-comment">#### 4.1.11.1 插件安装目录 ：</span><br><br>插件下载地址： http:<span class="hljs-regexp">//u</span>pdates.jenkins-ci.org<span class="hljs-regexp">/download/</span>plugins/<br><br>安装插件的目录：<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>plugins<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">71</span>.png)<br><br><span class="hljs-comment">#### 4.1.11.2 安装插件</span><br><br>搜索需要 gitlab 的插件并安装：&lt;font color=<span class="hljs-string">&quot;red&quot;</span>&gt;gitlab 和 Blue Ocean&lt;/font&gt;<br><br>**在安装插件的过程中可以点击“安装完成后重启Jenkins”**<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">72</span>.png)<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">73</span>.png)<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">74</span>.png)<br><br><span class="hljs-comment">### 4.1.12 配置 jenkins 权限管理</span><br><br>基于角色的权限管理，先创建角色和用户，给角色授权，然后把用户管理到角色。<br><br><span class="hljs-comment">#### 4.1.12.1安装插件</span><br><br>**Role- - based:基于角色的认证**<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">75</span>.png)<br><br><span class="hljs-comment">#### 4.1.12.2 创建新用户</span><br><br>Jenkins—系统管理—管理用户—新建用户：<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">76</span>.png)<br><br><span class="hljs-comment">#### 4.1.12.3 更改认证方式</span><br><br>Jenkins—系统管理—全局安全配置<br><br>默认创建的用户登录后可以做任何操作，取决于默认的认证授权方式。<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">77</span>.png)<br><br><span class="hljs-comment">#### 4.1.12.4 创建角色</span><br><br>Jenkins—系统管理--Manage and Assign Roles(管理和分配角色)<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">78</span>.png)<br><br><span class="hljs-comment">#### 4.1.12.5 添加角色</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">79</span>.png)<br><br><span class="hljs-comment">#### 4.1.12.6 对角色分配权限</span><br><br>**注意：只分配Read权限**<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">80</span>.png)<br><br><span class="hljs-comment">#### 4.1.12.7 将用户关联到角色</span><br><br>Jenkins—系统管理--Manage and Assign Roles(管理和分配角色)--Assign Role<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">81</span>.png)<br><br><span class="hljs-comment">#### 4.1.12.8 测试普通用户登录</span><br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">82</span>.png)<br><br>登录成功之的界面，没有系统管理权限，只能执行被授权过的job且没有了管理员权限。<br><br>![](https:<span class="hljs-regexp">//</span>lwx-<span class="hljs-number">1304975851</span>.cos.ap-guangzhou.myqcloud.com<span class="hljs-regexp">/myblog/</span>devopts/devpots-<span class="hljs-number">83</span>.png)<br><br><span class="hljs-comment">#### 4.1.12.9 Jenkins 运行权限问题</span><br><br>默认jenkins服务以jenkins用户运行，这时在jenkins执行maven脚本时可能会发生没有权限操作某个目录下的文件，覆盖文件等情况，就会出现因权限问题而产生的执行错误，同时在编写脚本时也要考虑权限问题。<br><br>解决方法：可以让Jenkins以root用户运行来解决<br><br>```bash<br><span class="hljs-comment">#方法一：</span><br><span class="hljs-number">1</span>.修改<span class="hljs-regexp">/etc/</span>default/jenkins文件中的内容（将用户改成root）<br><span class="hljs-comment">#user id to be invoked as (otherwise will run as root; not wise!)</span><br>JENKINS_USER=root<br>JENKINS_GROUP=root<br><span class="hljs-number">2</span>.重启服务<br><span class="hljs-comment">#方法二：</span><br><span class="hljs-number">1</span>.将jenkins账号分别加入到root组中<br>gpasswd -a jenkins root<br><span class="hljs-number">2</span>.修改<span class="hljs-regexp">/etc/</span>sysconfig/jenkins文件中的内容（将用户改成root）<br><span class="hljs-comment">#user id to be invoked as (otherwise will run as root; not wise!)</span><br>JENKINS_USER=root<br>JENKINS_GROUP=root<br><span class="hljs-number">3</span>.重启服务<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="4-1-13-jenkins-邮箱配置"><a href="#4-1-13-jenkins-邮箱配置" class="headerlink" title="4.1.13 jenkins 邮箱配置"></a>4.1.13 jenkins 邮箱配置</h3><h4 id="4-1-13-1-使用QQ邮箱进行邮箱配置"><a href="#4-1-13-1-使用QQ邮箱进行邮箱配置" class="headerlink" title="4.1.13.1 使用QQ邮箱进行邮箱配置"></a>4.1.13.1 使用QQ邮箱进行邮箱配置</h4><h5 id="生成-QQ-邮箱登录授权码"><a href="#生成-QQ-邮箱登录授权码" class="headerlink" title="生成 QQ 邮箱登录授权码"></a>生成 QQ 邮箱登录授权码</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-84.png" srcset="/blog/img/loading.gif"></p>
<h5 id="配置-jenkins-管理员邮箱"><a href="#配置-jenkins-管理员邮箱" class="headerlink" title="配置 jenkins 管理员邮箱"></a>配置 jenkins 管理员邮箱</h5><p><strong>Jenkins—系统管理—系统设置：</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-85.png" srcset="/blog/img/loading.gif"></p>
<h5 id="发件配置"><a href="#发件配置" class="headerlink" title="发件配置"></a>发件配置</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-86.png" srcset="/blog/img/loading.gif"></p>
<h5 id="测试发送邮件"><a href="#测试发送邮件" class="headerlink" title="测试发送邮件"></a>测试发送邮件</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-87.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-1-13-2-使用outlook进行邮箱配置"><a href="#4-1-13-2-使用outlook进行邮箱配置" class="headerlink" title="4.1.13.2 使用outlook进行邮箱配置"></a>4.1.13.2 使用outlook进行邮箱配置</h4><h5 id="配置-jenkins-管理员邮箱-1"><a href="#配置-jenkins-管理员邮箱-1" class="headerlink" title="配置 jenkins 管理员邮箱"></a>配置 jenkins 管理员邮箱</h5><p><strong>Jenkins—系统管理—系统设置：</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another19.png" srcset="/blog/img/loading.gif"></p>
<p><strong>发件配置</strong></p>
<p><strong><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another20.png" srcset="/blog/img/loading.gif"></strong></p>
<p><strong>测试发送邮件</strong></p>
<p><strong><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another21.png" srcset="/blog/img/loading.gif"></strong></p>
<h2 id="4-2-基于-ssh-key-拉取代码"><a href="#4-2-基于-ssh-key-拉取代码" class="headerlink" title="4.2 基于 ssh key 拉取代码"></a>4.2 基于 ssh key 拉取代码</h2><h3 id="4-2-1-添加-ssh-key"><a href="#4-2-1-添加-ssh-key" class="headerlink" title="4.2.1 添加 ssh key"></a>4.2.1 添加 ssh key</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-88.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#获取ssh key</span><br>root@jenkins-master:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># ssh-keygen </span><br>Generating public/private rsa key pair.<br>Enter file <span class="hljs-keyword">in</span> <span class="hljs-built_in">which</span> to save the key (/root/.ssh/id_rsa): <br>Enter passphrase (empty <span class="hljs-keyword">for</span> no passphrase): <br>Enter same passphrase again: <br>Your identification has been saved <span class="hljs-keyword">in</span> /root/.ssh/id_rsa.<br>Your public key has been saved <span class="hljs-keyword">in</span> /root/.ssh/id_rsa.pub.<br>The key fingerprint is:<br>SHA256:J/GdA4pUT98eo5zURJa/76oXliREQRZyxDG6zjRFF0Y root@jenkins-master<br>The key<span class="hljs-string">&#x27;s randomart image is:</span><br><span class="hljs-string">+---[RSA 2048]----+</span><br><span class="hljs-string">|        . o=%*Eo |</span><br><span class="hljs-string">|       . o BoO.  |</span><br><span class="hljs-string">|      . . +.+ =. |</span><br><span class="hljs-string">|     . . + B.=.o.|</span><br><span class="hljs-string">|      . S * Bo...|</span><br><span class="hljs-string">|         * . .+. |</span><br><span class="hljs-string">|          o  . ..|</span><br><span class="hljs-string">|              . .|</span><br><span class="hljs-string">|            .o.o.|</span><br><span class="hljs-string">+----[SHA256]-----+</span><br><span class="hljs-string"></span><br><span class="hljs-string">root@jenkins-master:/opt/source# cat /root/.ssh/id_rsa.pub </span><br><span class="hljs-string">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCk3+NqtDgb2/cHOdcu0PXP3k7IvWHkuPsPALwrKMiOgHJFad+sYP/yAhiyUGFnH8O0wCuX6sHiD5Q4TclWC/U96ablYK4VOLaKEr5LMY74pBx1xdyGYEpjA0JFXcAUrC3cM+YqrYjr1bjNZQ+KPVp0Rmu2c29/mm7lQcamM7KyryQrgn1ikWldWlkmxySZQisB4gDBssKvQo5liFg4o2rUnBqKXVwkC45htiRaq4tPiniwdcoR/O5qSxpqtW5lQZz4/zEuAYFt0belf2hKhJ1CwtpkX/+pjPACXnsuf6YodWujIXLxUvC0B9KqTKDV3cfxiM0mgd9BTOwasfHnZ4mX root@jenkins-master</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>

<h3 id="4-2-2-添加-ssh-key"><a href="#4-2-2-添加-ssh-key" class="headerlink" title="4.2.2 添加 ssh key"></a>4.2.2 添加 ssh key</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-89.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-2-3-创建-ssh-key"><a href="#4-2-3-创建-ssh-key" class="headerlink" title="4.2.3 创建 ssh key"></a>4.2.3 创建 ssh key</h3><p>ssh key 只用于免认证获取代码</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-90.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-2-4-测试-ssh-key"><a href="#4-2-4-测试-ssh-key" class="headerlink" title="4.2.4 测试 ssh key"></a>4.2.4 测试 ssh key</h3><p>测试可以不使用用户名密码后直接获取代码</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-91.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-3-配置-jenkins-到-gitlab-非交互拉取代码"><a href="#4-3-配置-jenkins-到-gitlab-非交互拉取代码" class="headerlink" title="4.3 配置 jenkins 到 gitlab 非交互拉取代码"></a>4.3 配置 jenkins 到 gitlab 非交互拉取代码</h2><h3 id="4-3-1-非交互拉取代码方法一：通过脚本或命令clone代码（仅限克隆代码，后面其他操作还是由shell执行）"><a href="#4-3-1-非交互拉取代码方法一：通过脚本或命令clone代码（仅限克隆代码，后面其他操作还是由shell执行）" class="headerlink" title="4.3.1 非交互拉取代码方法一：通过脚本或命令clone代码（仅限克隆代码，后面其他操作还是由shell执行）"></a>4.3.1 非交互拉取代码方法一：通过脚本或命令clone代码（仅限克隆代码，后面其他操作还是由shell执行）</h3><p><strong>通过shell命令clone代码，scp到各个web服务器，停止tomcat服务，代码替换，启动tomcat服务</strong></p>
<h4 id="4-3-1-1-Jenkins-项目添加shell构建"><a href="#4-3-1-1-Jenkins-项目添加shell构建" class="headerlink" title="4.3.1.1 Jenkins 项目添加shell构建"></a>4.3.1.1 Jenkins 项目添加shell构建</h4><p><strong>Jenkins-项目-构建触发器-构建-执行shell</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another22.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-3-1-2-添加需要执行的shell命令"><a href="#4-3-1-2-添加需要执行的shell命令" class="headerlink" title="4.3.1.2 添加需要执行的shell命令"></a>4.3.1.2 添加需要执行的shell命令</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another23.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#shell命令内容</span><br><span class="hljs-built_in">cd</span> /data/git/linux &amp;&amp; rm -rf web1 &amp;&amp; git <span class="hljs-built_in">clone</span> git@10.0.0.101:linux/web1.git<br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br>scp -r /data/git/linux/web1/* www@10.0.0.105:/data/tomcat/tomcat_webapps/myapp/<br>scp -r /data/git/linux/web1/* www@10.0.0.106:/data/tomcat/tomcat_webapps/myapp/<br>scp -r /data/git/linux/web1/* www@10.0.0.107:/data/tomcat/tomcat_webapps/myapp/<br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure>

<p><strong>添加完成后点击保存</strong></p>
<p><strong>将Jenkins服务器的公钥复制到web服务器上去</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#web服务器需要提前设置密码</span><br>root@web1:~<span class="hljs-comment"># passwd www</span><br>Enter new UNIX password: <br>Retype new UNIX password: <br>passwd: password updated successfully<br><br>root@web2:~<span class="hljs-comment"># passwd www</span><br>Enter new UNIX password: <br>Retype new UNIX password: <br>passwd: password updated successfully<br><br>root@web3:~<span class="hljs-comment"># passwd www</span><br>Enter new UNIX password: <br>Retype new UNIX password: <br>passwd: password updated successfully<br><br>root@jenkins-master:/data/git/linux/web1<span class="hljs-comment"># ssh-copy-id www@10.0.0.105</span><br>/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: <span class="hljs-string">&quot;/root/.ssh/id_rsa.pub&quot;</span><br>/usr/bin/ssh-copy-id: INFO: attempting to <span class="hljs-built_in">log</span> <span class="hljs-keyword">in</span> with the new key(s), to filter out any that are already installed<br>/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="hljs-keyword">if</span> you are prompted now it is to install the new keys<br>www@10.0.0.105<span class="hljs-string">&#x27;s password: </span><br><span class="hljs-string"></span><br><span class="hljs-string">Number of key(s) added: 1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>www@10.0.0.105<span class="hljs-string">&#x27;&quot;</span><br><span class="hljs-string">and check to make sure that only the key(s) you wanted were added.</span><br><span class="hljs-string"></span><br><span class="hljs-string">root@jenkins-master:/data/git/linux/web1# ssh-copy-id www@10.0.0.106</span><br><span class="hljs-string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span><br><span class="hljs-string">The authenticity of host &#x27;</span>10.0.0.106 (10.0.0.106)<span class="hljs-string">&#x27; can&#x27;</span>t be established.<br>ECDSA key fingerprint is SHA256:tLe8oiREqQLendzAnl1I3ydeXtXXSYaWogXpP8pfifI.<br>Are you sure you want to <span class="hljs-built_in">continue</span> connecting (yes/no)? yes<br>/usr/bin/ssh-copy-id: INFO: attempting to <span class="hljs-built_in">log</span> <span class="hljs-keyword">in</span> with the new key(s), to filter out any that are already installed<br>/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="hljs-keyword">if</span> you are prompted now it is to install the new keys<br>www@10.0.0.106<span class="hljs-string">&#x27;s password: </span><br><span class="hljs-string"></span><br><span class="hljs-string">Number of key(s) added: 1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>www@10.0.0.106<span class="hljs-string">&#x27;&quot;</span><br><span class="hljs-string">and check to make sure that only the key(s) you wanted were added.</span><br><span class="hljs-string"></span><br><span class="hljs-string">root@jenkins-master:/data/git/linux/web1# ssh-copy-id www@10.0.0.107</span><br><span class="hljs-string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span><br><span class="hljs-string">The authenticity of host &#x27;</span>10.0.0.107 (10.0.0.107)<span class="hljs-string">&#x27; can&#x27;</span>t be established.<br>ECDSA key fingerprint is SHA256:tLe8oiREqQLendzAnl1I3ydeXtXXSYaWogXpP8pfifI.<br>Are you sure you want to <span class="hljs-built_in">continue</span> connecting (yes/no)? yes<br>/usr/bin/ssh-copy-id: INFO: attempting to <span class="hljs-built_in">log</span> <span class="hljs-keyword">in</span> with the new key(s), to filter out any that are already installed<br>/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="hljs-keyword">if</span> you are prompted now it is to install the new keys<br>www@10.0.0.107<span class="hljs-string">&#x27;s password: </span><br><span class="hljs-string"></span><br><span class="hljs-string">Number of key(s) added: 1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>www@10.0.0.107<span class="hljs-string">&#x27;&quot;</span><br><span class="hljs-string">and check to make sure that only the key(s) you wanted were added.</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-1-3-立即构建"><a href="#4-3-1-3-立即构建" class="headerlink" title="4.3.1.3 立即构建"></a>4.3.1.3 立即构建</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another24.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-3-1-4-使用控制台查看结果"><a href="#4-3-1-4-使用控制台查看结果" class="headerlink" title="4.3.1.4 使用控制台查看结果"></a>4.3.1.4 使用控制台查看结果</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another25.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another26.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another27.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-3-1-5-通过服务器查看是否开启成功"><a href="#4-3-1-5-通过服务器查看是否开启成功" class="headerlink" title="4.3.1.5 通过服务器查看是否开启成功"></a>4.3.1.5 通过服务器查看是否开启成功</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another28.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-3-1-6-通过查看网页是否构建成功"><a href="#4-3-1-6-通过查看网页是否构建成功" class="headerlink" title="4.3.1.6 通过查看网页是否构建成功"></a>4.3.1.6 通过查看网页是否构建成功</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another29.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-3-2-非交互拉取代码方法二：通过Jenkins-clone代码（仅限克隆代码，后面其他操作还是由shell执行）"><a href="#4-3-2-非交互拉取代码方法二：通过Jenkins-clone代码（仅限克隆代码，后面其他操作还是由shell执行）" class="headerlink" title="4.3.2 非交互拉取代码方法二：通过Jenkins clone代码（仅限克隆代码，后面其他操作还是由shell执行）"></a>4.3.2 非交互拉取代码方法二：通过Jenkins clone代码（仅限克隆代码，后面其他操作还是由shell执行）</h3><p><strong>通过Jenkins clone代码，对代码打包，scp到各个web服务器里，停服务，做代码替换，启动服务</strong></p>
<h4 id="4-3-2-1-jenkins-服务器添加证书"><a href="#4-3-2-1-jenkins-服务器添加证书" class="headerlink" title="4.3.2.1 jenkins 服务器添加证书"></a>4.3.2.1 jenkins 服务器添加证书</h4><p>Jenkins-凭据-jenkins—全局凭据—添加凭据</p>
<p>或</p>
<p>Jenkins-系统管理-Manage Credentials-全局-添加凭据</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another106.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another107.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another108.png" srcset="/blog/img/loading.gif"></p>
<p><strong>关于private key</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#需要Jenkins服务器里的私钥</span><br>root@jenkins-master:/data/git/linux/web1<span class="hljs-comment"># cat /root/.ssh/id_rsa</span><br>-----BEGIN RSA PRIVATE KEY-----<br>MIIEowIBAAKCAQEApN/jarQ4G9v3BznXLtD1z95OyL1h5Lj7DwC8KyjIjoByRWnf<br>rGD/8gIYslBhZx/DtMArl+rB4g+UOE3JVgv1Pemm5WCuFTi2ihK+SzGO+KQcdcXc<br>hmBKYwNCRV3AFKwt3DPmKq2I69W4zWUPij1adEZrtnNvf5pu5UHGpjOysq8kK4J9<br>YpFpXVpZJsckmUIrAeIAwbLCr0KOZYhYOKNq1Jwail1cJAuOYbYkWquLT4p4sHXK<br>EfzuaksaarVuZUGc+P8xLgGBbdG3pX9oSoSdQsLaZF//qYzwAl57Ln+mKHVroyFy<br>8VLwtAfSqkyg1d3H8YjNJoHfQUzsGrHx52eJlwIDAQABAoIBAQCX4XdJ0ILvhw5l<br>Ja9IfU40EwJYgb0wSgdcprywtX0raL/bmdBmp2Sft7awbMONkAFk/LIr3CKG8PsF<br>cwLJtXJRenA4VXuIKRpezy1lb13ZRrTA+WhQkVt1IodmBxru8D2+4EBjiEDdn6AB<br>9dr+6c3t1wFarbRExCrsHk+0w2MWni1hwf9u1QogysWcwAJ/DoMd2M4dwtIqTVfz<br>Nqi/Pi3or3jx7HtU28NJc9L6wNipGMtacVasgBBfrs2kzHDhTd2P0GxK9Hv/7xIu<br>AZixJqxmZg/sZgA5NrOSrNJQnRI/mUJfld8C1YDSsXl+a+xIu1lF0eL0po4Jxhk7<br>AB9PWsrBAoGBANqVxaGvsgOBWT2+4q79xT7HCUuKYjt4wwMOtZnTX0PYt1EIlGZk<br>wk+PluGA0qBthjZAvXthiUltkky6+KCw6C451UtTMWyEG2t76jy009Mn5NUuBSVv<br>0zXFJ2K1IybZYEmZfHlOK9TJhmiTw0F2tiLhLvaTkIUDsBHTZ4jDyZuJAoGBAMEY<br>kH+yLNtlFVlRPe8+BptoIlIqvfsoL06L+DHlNh7HhxW53uLHUBA0lmFE27Ohii+H<br>DlkuPl1cHewd+nxD0Kjq5iLeL1MxnakSr4RZfzRUj1N6r0RoaHqCR+IfkdiXaJNA<br>jDv4hJGCYtT/MQriN8zzzuuPw7tLAv/CPSdqXxQfAoGAOsVsVvXbgi/EI+LwJibb<br>Yu63JBV4Jg9pN6g70blQcviRCXuqEwHicOvloIo3l6T7Ihk0GTl3ZUPNw02+Tc5j<br>DxLDs7YRouC+Up8Fsv7XuX2PfHYcMh2oB1wUI+kaI3bs+b0IB8Gp7VOmDPY12KMn<br>g6dSLkAs6ma8b36M5uvliCkCgYBYf/6yWCJRB7pKLn8ZaK80iPy59hcOxrMv590A<br>WVJ9tutF3OO3wqwCUWfe+uVLJi2kbNz5qMUymuan8nF8hMRctxR1RKoiEip1dDf3<br>i+FORbdPBnrP+p5wD8gMbnW09GgcnUfosJVp732Gq9N5bocuq0vaEREfhVjBie/n<br>Ycxj9wKBgA80/IiRHJA37tMcI9SP95VKlMfYnvbtHOFsgYgbNVdUX4mt2LJncaWG<br>TjuiiVJe40XQaPyjRyUSLQjKyfaFlHsAB5WjlFKv4V++vMsKp3JUNgUd0OKrjaVz<br>qn0kXUy5MA7/BsQGnw0lwZRDToRtw47uInNPmrLDR+uXquCZTu65<br>-----END RSA PRIVATE KEY-----<br></code></pre></td></tr></table></figure>

<h4 id="4-3-2-2-jenkins-创建-project"><a href="#4-3-2-2-jenkins-创建-project" class="headerlink" title="4.3.2.2 jenkins 创建 project"></a>4.3.2.2 jenkins 创建 project</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-92.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-3-2-3-配置-git-项目地址和用户"><a href="#4-3-2-3-配置-git-项目地址和用户" class="headerlink" title="4.3.2.3 配置 git 项目地址和用户"></a>4.3.2.3 配置 git 项目地址和用户</h4><p>添加完成的证书没有报错表示认证通过</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-93.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another30.png" srcset="/blog/img/loading.gif"></p>
<p>没有Delete workspace before build starts，就安装workspace cleanup插件</p>
<h4 id="4-3-2-4-测试构建项目"><a href="#4-3-2-4-测试构建项目" class="headerlink" title="4.3.2.4 测试构建项目"></a>4.3.2.4 测试构建项目</h4><p>构建注意：在配置-General-选择丢弃旧的构建</p>
<p>没有必要留着那么多的构建记录</p>
<p>七天</p>
<p>最多五个</p>
<p>​    七天内不足五个</p>
<p>​        最近七天上线不足五次，但是上一周或者以前有历史记录，这些记录加上七天内的超过五次，那么还是显示五次记录</p>
<p>​        最近七天上线不足五次，但是上一周或者以前有历史记录，这些记录加上七天内的也不足五次，那么就显示实际数量</p>
<p>​        最近七天没有上线，那就是最多五次记录，有可能是一到五当中任何一个，如果历史记录超过五次，那么就是最近的五次记录</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another97.png" srcset="/blog/img/loading.gif"></p>
<h5 id="4-3-4-2-1-点击立即构建"><a href="#4-3-4-2-1-点击立即构建" class="headerlink" title="4.3.4.2.1 点击立即构建"></a>4.3.4.2.1 点击立即构建</h5><p><strong>如果使用旧项目的话，需要把构建里的shell全部注释或删除</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-94.png" srcset="/blog/img/loading.gif"></p>
<h5 id="4-3-4-2-2-验证构建结果"><a href="#4-3-4-2-2-验证构建结果" class="headerlink" title="4.3.4.2.2 验证构建结果"></a>4.3.4.2.2 验证构建结果</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-95.png" srcset="/blog/img/loading.gif"></p>
<h5 id="4-3-4-2-3-服务器验证数据"><a href="#4-3-4-2-3-服务器验证数据" class="headerlink" title="4.3.4.2.3 服务器验证数据"></a>4.3.4.2.3 服务器验证数据</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-96.png" srcset="/blog/img/loading.gif"></p>
<h5 id="4-3-4-2-4-将代码部署至后端服务器"><a href="#4-3-4-2-4-将代码部署至后端服务器" class="headerlink" title="4.3.4.2.4 将代码部署至后端服务器"></a>4.3.4.2.4 将代码部署至后端服务器</h5><p>构建-&gt;执行 shell，脚本内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#进入到Jenkins服务器项目文件夹，并将所有文件打包</span><br><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1 &amp;&amp; tar czvf myapp.tar.gz ./*<br><br><span class="hljs-comment">#打包文件发送到tomcat服务器</span><br>scp myapp.tar.gz www@10.0.0.105:/data/tomcat/tomcat_appdir/<br>scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/<br>scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/<br><br><span class="hljs-comment">#停止tomcat运行</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br><span class="hljs-comment">#删除存放项目目录里的所有文件，进入到存放项目压缩包文件夹，将压缩包解压到项目目录里</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br><br><span class="hljs-comment">#运行tomcat</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure>

<h2 id="4-4-gitlab分支管理"><a href="#4-4-gitlab分支管理" class="headerlink" title="4.4 gitlab分支管理"></a>4.4 gitlab分支管理</h2><p>账户权限：<a target="_blank" rel="noopener" href="https://gitlab.com/xhang/gitlab/-/blob/12-3-stable-zh/doc/user/permissions.md">https://gitlab.com/xhang/gitlab/-/blob/12-3-stable-zh/doc/user/permissions.md</a></p>
<h3 id="4-4-1-gitlab-新建-develop-分支"><a href="#4-4-1-gitlab-新建-develop-分支" class="headerlink" title="4.4.1 gitlab 新建 develop 分支"></a>4.4.1 gitlab 新建 develop 分支</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-97.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-98.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-4-2-指定克隆分支下载gtilab文件"><a href="#4-4-2-指定克隆分支下载gtilab文件" class="headerlink" title="4.4.2 指定克隆分支下载gtilab文件"></a>4.4.2 指定克隆分支下载gtilab文件</h3><p>基于develop分支下载gitlab文件</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another31.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-4-3-上传代码到develop分支"><a href="#4-4-3-上传代码到develop分支" class="headerlink" title="4.4.3 上传代码到develop分支"></a>4.4.3 上传代码到develop分支</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another32.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another33.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another34.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-5-gitlab代码合并"><a href="#4-5-gitlab代码合并" class="headerlink" title="4.5 gitlab代码合并"></a>4.5 gitlab代码合并</h2><h3 id="4-5-1-开发环境代码部署到测试环境（10-0-0-105当作测试环境）"><a href="#4-5-1-开发环境代码部署到测试环境（10-0-0-105当作测试环境）" class="headerlink" title="4.5.1 开发环境代码部署到测试环境（10.0.0.105当作测试环境）"></a>4.5.1 开发环境代码部署到测试环境（10.0.0.105当作测试环境）</h3><p>进入Jenkins develop项目-配置-源码管理</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another35.png" srcset="/blog/img/loading.gif"></p>
<p>进入Jenkins develop项目-配置-构建</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another36.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-develop &amp;&amp; tar czvf myapp.tar.gz ./*<br><br>scp myapp.tar.gz www@10.0.0.105:/data/tomcat/tomcat_appdir/<br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure>

<p><strong>注意：保存后，立即构建（注意执行shell里的路径名称）</strong></p>
<h3 id="4-5-2-开发环境代码部署到生产环境"><a href="#4-5-2-开发环境代码部署到生产环境" class="headerlink" title="4.5.2 开发环境代码部署到生产环境"></a>4.5.2 开发环境代码部署到生产环境</h3><h4 id="4-5-2-1-创建生产环境Jenkins，可以基于开发环境进行复制"><a href="#4-5-2-1-创建生产环境Jenkins，可以基于开发环境进行复制" class="headerlink" title="4.5.2.1 创建生产环境Jenkins，可以基于开发环境进行复制"></a>4.5.2.1 创建生产环境Jenkins，可以基于开发环境进行复制</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another37.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-5-2-2-修改生产环境的配置"><a href="#4-5-2-2-修改生产环境的配置" class="headerlink" title="4.5.2.2 修改生产环境的配置"></a>4.5.2.2 修改生产环境的配置</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another38.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another39.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-develop &amp;&amp; tar czvf myapp.tar.gz ./*<br><br>scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/<br>scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/<br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure>

<p>**注意：所有Jenkins目录里构建的shell脚本都可以在 **/var/lib/jenkins/jobs 里的对应项目查看</p>
<h4 id="4-5-2-3-开发人员合并代码"><a href="#4-5-2-3-开发人员合并代码" class="headerlink" title="4.5.2.3 开发人员合并代码"></a>4.5.2.3 开发人员合并代码</h4><p>gitlab–linux–web1–合并请求–新建合并请求</p>
<p>Merge Requests-New merge request</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another40.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another41.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-5-2-4-开发领导会受到代码合并的邮件"><a href="#4-5-2-4-开发领导会受到代码合并的邮件" class="headerlink" title="4.5.2.4 开发领导会受到代码合并的邮件"></a>4.5.2.4 开发领导会受到代码合并的邮件</h4><p>开发领导收到邮件，且开发领导和开发在gitlab网页上也会看到合并的提示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another42.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another43.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another44.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another45.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-5-2-5-使用Jenkins部署合并后的代码"><a href="#4-5-2-5-使用Jenkins部署合并后的代码" class="headerlink" title="4.5.2.5 使用Jenkins部署合并后的代码"></a>4.5.2.5 使用Jenkins部署合并后的代码</h4><p>在Jenkins里的开发环境立即构建，部署完成后即可到生产环境验证</p>
<h4 id="4-5-2-6-公司代码部署流程"><a href="#4-5-2-6-公司代码部署流程" class="headerlink" title="4.5.2.6 公司代码部署流程"></a>4.5.2.6 公司代码部署流程</h4><p>" srcset="/blog/img/loading.gif<img src=""></p>
<h2 id="4-6-构建触发器-钩子"><a href="#4-6-构建触发器-钩子" class="headerlink" title="4.6 构建触发器(钩子)"></a>4.6 构建触发器(钩子)</h2><p><strong>只使用于测试环境</strong></p>
<p>构建触发器(webhook)，有的人称为钩子，实际上是一个 HTTP 回调,其用于<strong>在开发人员向 gitlab 提交代码后能够触发 jenkins 自动执行代码构建操作。</strong></p>
<p>以下为新建一个开发分支，只有在开发人员向开发(develop)分支提交代码的时候才会触发代码构建，而向主分支提交的代码不会自动构建，需要运维人员手动部署代码到生产环境。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-99.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-6-1-jenkins-安装插件"><a href="#4-6-1-jenkins-安装插件" class="headerlink" title="4.6.1 jenkins 安装插件"></a>4.6.1 jenkins 安装插件</h3><p><strong>系统管理-管理插件-可选插件-Gitlab Hook 和 Gitlab Authentication</strong><br>注意事项：<br><a target="_blank" rel="noopener" href="https://jenkins.io/security/advisory/2018-05-09/#SECURITY-263">https://jenkins.io/security/advisory/2018-05-09/#SECURITY-263</a></p>
<ul>
<li>在 jenkins 系统管理–全局安全设置，认证改为登录用户可以做任何事情</li>
<li>取消跨站请求伪造保护的勾选项</li>
<li>Gitlab Hook Plugin 以纯文本形式存储和显示 GitLab API 令牌</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-100.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-6-2-jenkins-修改登录认证方式"><a href="#4-6-2-jenkins-修改登录认证方式" class="headerlink" title="4.6.2 jenkins 修改登录认证方式"></a>4.6.2 jenkins 修改登录认证方式</h3><p>系统管理—全局安全设置–保存以上配置</p>
<p><strong>注意：高版本无法关闭跨站请求伪造保护方法</strong></p>
<p>参考博客：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/panchanggui/p/13557155.html">https://www.cnblogs.com/panchanggui/p/13557155.html</a> （只使用centos）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ubuntu</span><br>root@jenkins-master:~<span class="hljs-comment"># vim /etc/default/jenkins</span><br>1 <span class="hljs-comment"># defaults for Jenkins automation server</span><br>2 <br>3 <span class="hljs-comment"># pulled in from the init script; makes things easier.</span><br>4 NAME=jenkins<br>5 <br>6 <span class="hljs-comment"># arguments to pass to java</span><br>7 <br>8 <span class="hljs-comment"># Allow graphs etc. to work even when an X server is present</span><br>9 <span class="hljs-comment">#JAVA_ARGS=&quot;-Djava.awt.headless=true&quot;</span><br>10 JAVA_ARGS=<span class="hljs-string">&quot;-Djava.awt.headless=true -Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=true&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-101.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-6-3-jenkins-配置构建触发器"><a href="#4-6-3-jenkins-配置构建触发器" class="headerlink" title="4.6.3 jenkins 配置构建触发器"></a>4.6.3 jenkins 配置构建触发器</h3><p>生产 token 认证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># openssl rand -hex 12</span><br>aa9ef9c4d39268b6d0756a1c<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-102.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-6-4-curl-命令测试触发并验证远程触发构建："><a href="#4-6-4-curl-命令测试触发并验证远程触发构建：" class="headerlink" title="4.6.4 curl 命令测试触发并验证远程触发构建："></a>4.6.4 curl 命令测试触发并验证远程触发构建：</h3><ul>
<li><p>使用浏览器直接访问 URL 地址</p>
</li>
<li><p>使用 curl 命令访问 URL</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#使用ping来确认Jenkins服务器是否能连通</span><br>root@web1:~<span class="hljs-comment"># ping 10.0.0.102</span><br>PING 10.0.0.102 (10.0.0.102) 56(84) bytes of data.<br>64 bytes from 10.0.0.102: icmp_seq=1 ttl=64 time=0.210 ms<br>64 bytes from 10.0.0.102: icmp_seq=2 ttl=64 time=0.258 ms<br>^C<br>--- 10.0.0.102 ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1019ms<br>rtt min/avg/max/mdev = 0.210/0.234/0.258/0.024 ms<br>root@jenkins-master:~<span class="hljs-comment"># curl http://10.0.0.102:8080/job/linux-web1-develop/build?token=aa9ef9c4d39268b6d0756a1c</span><br></code></pre></td></tr></table></figure>

<h3 id="4-6-5-jenkins-验证-develop-是否自动构建"><a href="#4-6-5-jenkins-验证-develop-是否自动构建" class="headerlink" title="4.6.5 jenkins 验证 develop 是否自动构建"></a>4.6.5 jenkins 验证 develop 是否自动构建</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another46.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-6-6-gitlab-配置-webhook"><a href="#4-6-6-gitlab-配置-webhook" class="headerlink" title="4.6.6 gitlab 配置 webhook"></a>4.6.6 gitlab 配置 webhook</h3><p>管理中心–系统钩子</p>
<p>Admin area—groups/project—System Hooks</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another47.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-6-7-测试钩子可用性"><a href="#4-6-7-测试钩子可用性" class="headerlink" title="4.6.7 测试钩子可用性"></a>4.6.7 测试钩子可用性</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another48.png" srcset="/blog/img/loading.gif"></p>
<p>执行结果：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-103.png" srcset="/blog/img/loading.gif"></p>
<p>Jenkins-项目运行结果</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another49.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-6-8-gitlab-开发分支-develop-测试提交代码"><a href="#4-6-8-gitlab-开发分支-develop-测试提交代码" class="headerlink" title="4.6.8 gitlab 开发分支 develop 测试提交代码"></a>4.6.8 gitlab 开发分支 develop 测试提交代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#往gitlab中develop分支上传代码</span><br>root@jenkins-slave1:~/web1<span class="hljs-comment"># vim index.html </span><br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v1&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v2&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v3&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v4&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v5&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v6&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v7&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v8&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v9&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v10&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v11&lt;/h1&gt;<br>&lt;h1&gt;linux gitlab <span class="hljs-built_in">test</span> page v12&lt;/h1&gt; <span class="hljs-comment">#新添加的一行</span><br><br>root@jenkins-slave1:~/web1<span class="hljs-comment"># git add .</span><br>root@jenkins-slave1:~/web1<span class="hljs-comment"># git commit -m &quot;v12&quot;</span><br>[develop 48eeb9d] v12<br> 1 file changed, 1 insertion(+)<br>root@jenkins-slave1:~/web1<span class="hljs-comment"># git push</span><br>Username <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span>: laosong<br>Password <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://laosong@10.0.0.101&#x27;</span>: <br>3Counting objects: 3, <span class="hljs-keyword">done</span>.<br>Delta compression using up to 4 threads.<br>Compressing objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>Writing objects: 100% (3/3), 298 bytes | 298.00 KiB/s, <span class="hljs-keyword">done</span>.<br>Total 3 (delta 1), reused 0 (delta 0)<br>remote: <br>remote: To create a merge request <span class="hljs-keyword">for</span> develop, visit:<br>remote:   http://10.0.0.101/linux/web1/merge_requests/new?merge_request%5Bsource_branch%5D=develop<br>remote: <br>To http://10.0.0.101/linux/web1.git<br>   518bfd5..48eeb9d  develop -&gt; develop   <br></code></pre></td></tr></table></figure>

<h3 id="4-6-9-jenkins-验证-develop-自动构建"><a href="#4-6-9-jenkins-验证-develop-自动构建" class="headerlink" title="4.6.9 jenkins 验证 develop 自动构建"></a>4.6.9 jenkins 验证 develop 自动构建</h3><p>Jenkins自动构建</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another50.png" srcset="/blog/img/loading.gif"></p>
<p>测试web服务器网页</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another51.png" srcset="/blog/img/loading.gif"></p>
<p><strong>注意：生产环境还得是用人工请求来进行代码合并和代码部署</strong>*</p>
<p><strong>注意：Jenkins任务名称出现中文触发器网址就会有问题</strong></p>
<h2 id="4-7-构建后Jenkins项目关联（一般公司很少用）"><a href="#4-7-构建后Jenkins项目关联（一般公司很少用）" class="headerlink" title="4.7 构建后Jenkins项目关联（一般公司很少用）"></a>4.7 构建后Jenkins项目关联（一般公司很少用）</h2><p>用于多个 job 相互关联，需要串行执行多个 job 的场景，可以通过安装插件 Parameterized Trigger 触发执行其他 project。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-104.png" srcset="/blog/img/loading.gif"></p>
<p>原develop作为打包任务</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another56.png" srcset="/blog/img/loading.gif" alt="another56"></p>
<p>新建停止服务任务</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another52.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another53.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another54.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another55.png" srcset="/blog/img/loading.gif"></p>
<p>新建代码拷贝任务</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another61.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another62.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another63.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another64.png" srcset="/blog/img/loading.gif"></p>
<p>新建启动服务任务</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another57.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another58.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another59.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another60.png" srcset="/blog/img/loading.gif"></p>
<p>将所有的任务串联：</p>
<p>develop任务里的配置-构建后操作-构建其他工程-要构建的项目（填写停止服务任务）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another65.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another66.png" srcset="/blog/img/loading.gif"></p>
<p>停止服务任务里的配置-构建后操作-构建其他工程-要构建的项目（填写代码拷贝任务）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another67.png" srcset="/blog/img/loading.gif"></p>
<p>代码拷贝任务里的配置-构建后操作-构建其他工程-要构建的项目（填写启动服务任务）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another68.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-7-1-配置构建后操作"><a href="#4-7-1-配置构建后操作" class="headerlink" title="4.7.1 配置构建后操作"></a>4.7.1 配置构建后操作</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another69.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-7-2-验证构建后操作"><a href="#4-7-2-验证构建后操作" class="headerlink" title="4.7.2 验证构建后操作"></a>4.7.2 验证构建后操作</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another70.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another71.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-8-Jenkins视图"><a href="#4-8-Jenkins视图" class="headerlink" title="4.8 Jenkins视图"></a>4.8 Jenkins视图</h2><p>图可用于归档 job 进行分组显示，比如将一个业务的视图放在一个视图显示，安装完成 build pipeline 插件之后将会有一个+号用于创建视图。</p>
<h3 id="4-8-1-创建列表视图（基本上用这个）"><a href="#4-8-1-创建列表视图（基本上用这个）" class="headerlink" title="4.8.1 创建列表视图（基本上用这个）"></a>4.8.1 创建列表视图（基本上用这个）</h3><h4 id="4-8-1-1-点击“-”号"><a href="#4-8-1-1-点击“-”号" class="headerlink" title="4.8.1.1 点击“+”号"></a>4.8.1.1 点击“+”号</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another72.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-1-2-输入列表名和选择列表视图"><a href="#4-8-1-2-输入列表名和选择列表视图" class="headerlink" title="4.8.1.2 输入列表名和选择列表视图"></a>4.8.1.2 输入列表名和选择列表视图</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another73.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-1-3-任务任务过滤器-任务列表里选择任务"><a href="#4-8-1-3-任务任务过滤器-任务列表里选择任务" class="headerlink" title="4.8.1.3 任务任务过滤器-任务列表里选择任务"></a>4.8.1.3 任务任务过滤器-任务列表里选择任务</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another74.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-1-4-显示的结果"><a href="#4-8-1-4-显示的结果" class="headerlink" title="4.8.1.4 显示的结果"></a>4.8.1.4 显示的结果</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another75.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-1-5-在视图里添加新的任务"><a href="#4-8-1-5-在视图里添加新的任务" class="headerlink" title="4.8.1.5 在视图里添加新的任务"></a>4.8.1.5 在视图里添加新的任务</h4><p>选择列表-编辑视图-任务过滤器-任务列表添加需要的任务</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another76.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another77.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-8-2-创建-build-pipeline-视图（用的不多）"><a href="#4-8-2-创建-build-pipeline-视图（用的不多）" class="headerlink" title="4.8.2 创建 build pipeline 视图（用的不多）"></a>4.8.2 创建 build pipeline 视图（用的不多）</h3><p>视图可用于归档 job 进行分组显示，比如将一个业务的视图放在一个视图显示，安装完成 build pipeline 插件之后将会有一个+号用于创建视图。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-105.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-2-1-安装-build-pipeline-插件"><a href="#4-8-2-1-安装-build-pipeline-插件" class="headerlink" title="4.8.2.1 安装 build pipeline 插件"></a>4.8.2.1 安装 build pipeline 插件</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-106.png" srcset="/blog/img/loading.gif"></p>
<p>插件安装完成</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-107.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-2-2-创建新的视图"><a href="#4-8-2-2-创建新的视图" class="headerlink" title="4.8.2.2 创建新的视图"></a>4.8.2.2 创建新的视图</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-108.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-8-3-创建-pipline-视图"><a href="#4-8-3-创建-pipline-视图" class="headerlink" title="4.8.3 创建 pipline 视图"></a>4.8.3 创建 pipline 视图</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-109.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-3-1-定义视图配置信息"><a href="#4-8-3-1-定义视图配置信息" class="headerlink" title="4.8.3.1 定义视图配置信息"></a>4.8.3.1 定义视图配置信息</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-110.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-3-2-web-显示界面"><a href="#4-8-3-2-web-显示界面" class="headerlink" title="4.8.3.2 web 显示界面"></a>4.8.3.2 web 显示界面</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-111.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-8-4-列表视图"><a href="#4-8-4-列表视图" class="headerlink" title="4.8.4 列表视图"></a>4.8.4 列表视图</h3><p>列表视图使用场景比较多，用于将一个业务的job保存至一个列表视图进行分类管理，即不同业务的 job 放在不同的列表视图中。</p>
<h4 id="4-8-4-1-定义视图名称"><a href="#4-8-4-1-定义视图名称" class="headerlink" title="4.8.4.1 定义视图名称"></a>4.8.4.1 定义视图名称</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-112.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-4-2-选择任务"><a href="#4-8-4-2-选择任务" class="headerlink" title="4.8.4.2 选择任务"></a>4.8.4.2 选择任务</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-113.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-4-3-最终状态"><a href="#4-8-4-3-最终状态" class="headerlink" title="4.8.4.3 最终状态"></a>4.8.4.3 最终状态</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-114.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-8-5-我的视图"><a href="#4-8-5-我的视图" class="headerlink" title="4.8.5 我的视图"></a>4.8.5 我的视图</h3><p>我的视图会显示当前账户有权限访问的 job，因此需要提前划分好权限。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-115.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-8-5-2-最终状态"><a href="#4-8-5-2-最终状态" class="headerlink" title="4.8.5.2 最终状态"></a>4.8.5.2 最终状态</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-116.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-9-jenkins-分布式"><a href="#4-9-jenkins-分布式" class="headerlink" title="4.9 jenkins 分布式"></a>4.9 jenkins 分布式</h2><p>在众多 Job 的场景下，单台 jenkins master 同时执行代码 clone、编译、打包及构建，其性能可能会出现瓶颈从而会影响代码部署效率，影响 jenkins 官方提供了 jenkins 分布式构建，将众多 job 分散运行到不同的 jenkins slave 节点，大幅提高并行 job 的处理能力。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another78.png" srcset="/blog/img/loading.gif" alt="公司分布式图例"></p>
<p>Jenkins推荐配置：</p>
<p>小项目：配置2C 4G 60G（可以用数据盘，挂载到/var/lib/jenkins，项目都放在jobs里）</p>
<p>大项目：4C 8G 60G（可以用数据盘，挂载到/var/lib/jenkins，项目都放在jobs里，配置可用于几百个job）</p>
<h3 id="4-9-1-配置-slave-节点-java-环境"><a href="#4-9-1-配置-slave-节点-java-环境" class="headerlink" title="4.9.1 配置 slave 节点 java 环境"></a>4.9.1 配置 slave 节点 java 环境</h3><p>Slave 服务器创建工作目录，如果 slave 需要执行编译 job，则也需要配置 java 环境并且安装 git、svn、maven 等与 master 相同的基础运行环境，另外也要创建与 master 相同的数据目录，因为脚本中调用的路径只有相对 master 的一个路径，此路径在master 与各 node 节点必须保持一致。</p>
<p>slave1和slave2同时执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-slave1:~<span class="hljs-comment"># mkdir -p /var/lib/jenkins #创建数据目录，slave节点目录最好跟master保持一致</span><br><br><span class="hljs-comment">#下载并安装jdk</span><br>root@jenkins-slave1:~<span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment">#下载并解压jdk</span><br>root@jenkins-slave1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># tar xf jdk-8u241-linux-x64.tar.gz</span><br>root@jenkins-slave1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/jdk1.8.0_241/ /usr/local/jdk</span><br><span class="hljs-string">&#x27;/usr/local/jdk&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/jdk1.8.0_241/&#x27;</span><br><br><span class="hljs-comment">#修改环境配置</span><br>root@jenkins-slave1:~<span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$JAVA_HOME</span>/jre/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> CLASSPATH=.<span class="hljs-variable">$CLASSPATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/lib:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br>root@jenkins-slave1:~<span class="hljs-comment"># source /etc/profile</span><br><br>root@jenkins-slave1:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_241&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_241-b07)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.241-b07, mixed mode)<br></code></pre></td></tr></table></figure>

<h3 id="4-9-2-添加-slave-节点"><a href="#4-9-2-添加-slave-节点" class="headerlink" title="4.9.2 添加 slave 节点"></a>4.9.2 添加 slave 节点</h3><p>Jenkins—系统管理—节点管理—新建节点</p>
<p>添加 slave 节点：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another79.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another80.png" srcset="/blog/img/loading.gif"></p>
<p>部分 jenkins slave 信息：</p>
<p>需要安装SSH Build Agents插件</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-117.png" srcset="/blog/img/loading.gif" alt="注意：如没有Launch agent agents via SSH 就安装SSH Build Agents插件"></p>
<p>或者选择不校验证书：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-118.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-9-3-添加-slave-认证凭据"><a href="#4-9-3-添加-slave-认证凭据" class="headerlink" title="4.9.3 添加 slave 认证凭据"></a>4.9.3 添加 slave 认证凭据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another81.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-119.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-9-4-slave-节点最终信息"><a href="#4-9-4-slave-节点最终信息" class="headerlink" title="4.9.4 slave 节点最终信息"></a>4.9.4 slave 节点最终信息</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-120.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-9-5-jenkins-slave-创建日志"><a href="#4-9-5-jenkins-slave-创建日志" class="headerlink" title="4.9.5 jenkins slave 创建日志"></a>4.9.5 jenkins slave 创建日志</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-121.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-9-6-添加新的-slave"><a href="#4-9-6-添加新的-slave" class="headerlink" title="4.9.6 添加新的 slave"></a>4.9.6 添加新的 slave</h3><p>Jenkins—系统管理—节点管理—新建节点</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another82.png" srcset="/blog/img/loading.gif"></p>
<p>修改一点信息</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another83.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another84.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-9-6-如果-slave-没有-java-环境则报错如下"><a href="#4-9-6-如果-slave-没有-java-环境则报错如下" class="headerlink" title="4.9.6 如果 slave 没有 java 环境则报错如下"></a>4.9.6 如果 slave 没有 java 环境则报错如下</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-122.png" srcset="/blog/img/loading.gif"></p>
<p>解决方法：根据日志中，系统会检查哪里由java文件，所以就在哪里创建软连接，最后再启动代理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#这里只选择了其中的一个路径</span><br>root@jenkins-slave1:/usr/bin<span class="hljs-comment"># ln -sv /usr/local/jdk/bin/java /usr/bin/java</span><br><span class="hljs-string">&#x27;/usr/bin/java&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/jdk/bin/java&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="4-9-7-验证-slave-web-状态"><a href="#4-9-7-验证-slave-web-状态" class="headerlink" title="4.9.7 验证 slave web 状态"></a>4.9.7 验证 slave web 状态</h3><p>正常状态：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-123.png" srcset="/blog/img/loading.gif"></p>
<p>时间不同步状态：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-124.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-10-代码回滚"><a href="#4-10-代码回滚" class="headerlink" title="4.10 代码回滚"></a>4.10 代码回滚</h2><h3 id="4-10-1-创建回滚的任务"><a href="#4-10-1-创建回滚的任务" class="headerlink" title="4.10.1 创建回滚的任务"></a>4.10.1 创建回滚的任务</h3><p>创建任务</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another85.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another86.png" srcset="/blog/img/loading.gif"></p>
<p>修改配置</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another87.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another88.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#主要思路是删除原来的代码，将上一版本的代码下载并重新发送到测试环境或生产环境中</span><br><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-master &amp;&amp; rm -rf myapp.tar.gz &amp;&amp; git reset --hard HEAD^ &amp;&amp; tar czvf myapp.tar.gz ./*<br><br>scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/<br>scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/<br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br><br>ssh www@10.0.0.106 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br>ssh www@10.0.0.107 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="4-10-2-构建任务"><a href="#4-10-2-构建任务" class="headerlink" title="4.10.2 构建任务"></a>4.10.2 构建任务</h3><h2 id="4-11-pipline"><a href="#4-11-pipline" class="headerlink" title="4.11 pipline"></a>4.11 pipline</h2><p>官方介绍；<a target="_blank" rel="noopener" href="https://jenkins.io/2.0/">https://jenkins.io/2.0/</a><br>pipline 是帮助 Jenkins 实现 CI 到 CD 转变的重要角色，是运行在 jenkins 2.X 版本的核心插件，简单来说 Pipline 就是一套运行于 Jenkins 上的工作流框架，将原本独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂发布流程，从而实现单个任务很难实现的复杂流程编排和任务可视化，Pipeline 的实现方式是一套Groovy DSL，任何发布流程都可以表述为一段 Groovy 脚本。</p>
<h3 id="4-11-1-pipline-语法"><a href="#4-11-1-pipline-语法" class="headerlink" title="4.11.1 pipline 语法"></a>4.11.1 pipline 语法</h3><p>Stage：阶段，一个 pipline 可以划分为若干个 stage，每个 stage 都是一个操作步骤，比如 clone 代码、代码编译、代码测试和代码部署，阶段是一个逻辑分组，可以跨多个 node 执行。<br>Node：节点，每个 node 都是一个 jenkins 节点，可以是 jenkins master 也可以是jenkins agent，node 是执行 step 的具体服务器。<br>Step：步骤，step 是 jenkins pipline 最基本的操作单元，从在服务器创建目录到构建容器镜像，由各类 Jenkins 插件提供实现，一个 stage 中可以有多个 step，例如： sh “make”</p>
<h3 id="4-11-2-pipline-优势"><a href="#4-11-2-pipline-优势" class="headerlink" title="4.11.2 pipline 优势"></a>4.11.2 pipline 优势</h3><p>可持续性：jenkins 的重启或者中断后不影响已经执行的 Pipline Job<br>支持暂停：pipline 可以选择停止并等待人工输入或批准后再继续执行。<br>可扩展：通过 groovy 的编程更容易的扩展插件。<br>并行执行：通过 groovy 脚本可以实现 step，stage 间的并行执行，和更复杂的相互依赖关系。</p>
<h3 id="4-11-3-pipline-job-测试"><a href="#4-11-3-pipline-job-测试" class="headerlink" title="4.11.3 pipline job 测试"></a>4.11.3 pipline job 测试</h3><h4 id="4-11-3-1-创建-pipline-job"><a href="#4-11-3-1-创建-pipline-job" class="headerlink" title="4.11.3.1 创建 pipline job"></a>4.11.3.1 创建 pipline job</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another89.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-11-3-2-测试简单-pipline-job-运行"><a href="#4-11-3-2-测试简单-pipline-job-运行" class="headerlink" title="4.11.3.2 测试简单 pipline job 运行"></a>4.11.3.2 测试简单 pipline job 运行</h4><p>Pipeline 测试命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;clone 代码&quot;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码打包&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码拷贝&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码部署&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<p>Jenkins Web 界面配置：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-125.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-11-3-3-执行-pipline-job"><a href="#4-11-3-3-执行-pipline-job" class="headerlink" title="4.11.3.3 执行 pipline job"></a>4.11.3.3 执行 pipline job</h4><p>先安装Stage View插件，才会有阶段视图</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another92.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-11-3-4-自动生成拉取的代码的-pipline-脚本"><a href="#4-11-3-4-自动生成拉取的代码的-pipline-脚本" class="headerlink" title="4.11.3.4 自动生成拉取的代码的  pipline 脚本"></a>4.11.3.4 自动生成拉取的代码的  pipline 脚本</h4><p>点击流水线语法跳转至生成脚本 URL：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-126.png" srcset="/blog/img/loading.gif"></p>
<p>生成流水线脚本：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another90.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another91.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-11-3-5-更改-pipline-job"><a href="#4-11-3-5-更改-pipline-job" class="headerlink" title="4.11.3.5  更改 pipline job"></a>4.11.3.5  更改 pipline job</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码打包&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码拷贝&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码部署&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-11-3-6-执行-jenkins-job"><a href="#4-11-3-6-执行-jenkins-job" class="headerlink" title="4.11.3.6 执行 jenkins job"></a>4.11.3.6 执行 jenkins job</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another94.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-11-3-7-验证-git-clone-日志"><a href="#4-11-3-7-验证-git-clone-日志" class="headerlink" title="4.11.3.7 验证 git clone 日志"></a>4.11.3.7 验证 git clone 日志</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another93.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-11-3-8-jenkins-服务器验证-clone-代码数据"><a href="#4-11-3-8-jenkins-服务器验证-clone-代码数据" class="headerlink" title="4.11.3.8 jenkins 服务器验证 clone 代码数据"></a>4.11.3.8 jenkins 服务器验证 clone 代码数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another95.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-11-3-9-pipline-代码打包"><a href="#4-11-3-9-pipline-代码打包" class="headerlink" title="4.11.3.9 pipline  代码打包"></a>4.11.3.9 pipline  代码打包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      sh label: <span class="hljs-string">&#x27;&#x27;</span>, script: <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; rm -rf ./*&#x27;</span><br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; tar czvf myapp.tar.gz ./*&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码拷贝&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      ehco <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码部署&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      ehco <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-11-3-10-pipline-代码拷贝"><a href="#4-11-3-10-pipline-代码拷贝" class="headerlink" title="4.11.3.10 pipline 代码拷贝"></a>4.11.3.10 pipline 代码拷贝</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      sh label: <span class="hljs-string">&#x27;&#x27;</span>, script: <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; rm -rf ./*&#x27;</span><br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; tar czvf myapp.tar.gz ./*&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/&#x27;</span><br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      ehco <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码部署&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      ehco <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-11-3-11-pipline-停止web服务"><a href="#4-11-3-11-pipline-停止web服务" class="headerlink" title="4.11.3.11 pipline 停止web服务"></a>4.11.3.11 pipline 停止web服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      sh label: <span class="hljs-string">&#x27;&#x27;</span>, script: <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; rm -rf ./*&#x27;</span><br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; tar czvf myapp.tar.gz ./*&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/&#x27;</span><br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;代码部署&quot;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-11-3-12-pipline-代码部署"><a href="#4-11-3-12-pipline-代码部署" class="headerlink" title="4.11.3.12 pipline 代码部署"></a>4.11.3.12 pipline 代码部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      sh label: <span class="hljs-string">&#x27;&#x27;</span>, script: <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; rm -rf ./*&#x27;</span><br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; tar czvf myapp.tar.gz ./*&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/&#x27;</span><br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>  &#125; <br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动web服务&quot;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-11-3-13-pipline-启动服务"><a href="#4-11-3-13-pipline-启动服务" class="headerlink" title="4.11.3.13 pipline 启动服务"></a>4.11.3.13 pipline 启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">node &#123;<br>  stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>      sh label: <span class="hljs-string">&#x27;&#x27;</span>, script: <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; rm -rf ./*&#x27;</span><br>      git credentialsId: <span class="hljs-string">&#x27;a745d835-034e-4ec6-a5f8-93f436d3a35e&#x27;</span>, url: <span class="hljs-string">&#x27;git@10.0.0.101:linux/web1.git&#x27;</span><br>  &#125;<br>   stage(<span class="hljs-string">&quot;代码打包&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; tar czvf myapp.tar.gz ./*&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;代码拷贝&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.106:/data/tomcat/tomcat_appdir/&#x27;</span><br>      sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/linux-web1-master-pipline &amp;&amp; scp myapp.tar.gz www@10.0.0.107:/data/tomcat/tomcat_appdir/&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;停止web服务&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>  &#125; <br>  stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;&#x27;</span><br>  &#125;<br>  stage(<span class="hljs-string">&quot;启动web服务&quot;</span>)&#123;<br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.106 &quot;/etc/init.d/tomcat start&quot;&#x27;</span><br>      sh <span class="hljs-string">&#x27;ssh www@10.0.0.107 &quot;/etc/init.d/tomcat start&quot;&#x27;</span><br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-11-3-14-执行证并验证-pipline-job"><a href="#4-11-3-14-执行证并验证-pipline-job" class="headerlink" title="4.11.3.14 执行证并验证 pipline job"></a>4.11.3.14 执行证并验证 pipline job</h4><p>在 gitlab 提交代码，执行 pipline job 并验证代码是否最终部署到了 web 服务器。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another96.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-11-3-15-指定-node-节点运行-job"><a href="#4-11-3-15-指定-node-节点运行-job" class="headerlink" title="4.11.3.15 指定 node 节点运行 job"></a>4.11.3.15 指定 node 节点运行 job</h4><p>node 节点需要安装 git 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#jenkins node1：</span><br><span class="hljs-comment"># apt-get install git -y</span><br><span class="hljs-comment">#jenkins node2：</span><br><span class="hljs-comment"># apt-get install git -y</span><br></code></pre></td></tr></table></figure>

<p>node 节点需要打通与 web server 免密钥登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#jenkins slave1：</span><br>root@jenkins-slave1:~<span class="hljs-comment"># ssh-keygen</span><br>root@jenkins-slave1:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.105</span><br>root@jenkins-slave1:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.106</span><br>root@jenkins-slave1:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.107</span><br><br><span class="hljs-comment">#jenkins slave2：</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ssh-keygen</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.105</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.106</span><br>root@jenkins-slave2:~<span class="hljs-comment"># ssh-copy-id www@10.0.0.107</span><br><br><span class="hljs-comment">#jenkins pipeline 代码：</span><br>node(<span class="hljs-string">&quot;jenkins-slave1&quot;</span>)&#123;<br>    stage(<span class="hljs-string">&quot;clone 代码&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;rm -rf /var/lib/jenkins/workspace/pipline-test/*&#x27;</span><br>        git branch: <span class="hljs-string">&#x27;develop&#x27;</span>, credentialsId: <span class="hljs-string">&#x27;0e23c215-2853-4bdf-9198-481f28ac0e1b&#x27;</span>,<br>        url: <span class="hljs-string">&#x27;git@192.168.7.101:linux36/web1.git&#x27;</span><br>    &#125;<br>    stage(<span class="hljs-string">&quot;代码构建&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/pipline-test/ &amp;&amp; tar czvf code.tar.gz ./index.html&#x27;</span><br>    &#125;<br>    stage(<span class="hljs-string">&quot;代码复制&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/pipline-test/ &amp;&amp; scp code.tar.gz www@192.168.7.105:/data/tomcat/tomcat_appdir/&#x27;</span><br>        sh <span class="hljs-string">&#x27;cd /var/lib/jenkins/workspace/pipline-test/ &amp;&amp; scp code.tar.gz www@192.168.7.105:/data/tomcat/tomcat_appdir/&#x27;</span><br>    &#125;<br>    stage(<span class="hljs-string">&quot;停止 tomcat 服务&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.105 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.106 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span><br>    &#125;<br>    stage(<span class="hljs-string">&quot;代码部署&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.105 &quot;rm -rf /data/tomcat/tomcat_webdir/myapp/* &amp;&amp; cd /data/tomcat/tomcat_appdir &amp;&amp; tar xvf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/&quot;&#x27;</span><br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.106 &quot;rm -rf /data/tomcat/tomcat_webdir/myapp/* &amp;&amp; cd /data/tomcat/tomcat_appdir &amp;&amp; tar xvf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/&quot;&#x27;</span><br>    &#125;<br>    stage(<span class="hljs-string">&quot;启动 tomcat 服务&quot;</span>)&#123;<br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.105 &quot;/etc/init.d/tomcat start&quot;&#x27;</span><br>        sh <span class="hljs-string">&#x27;ssh www@192.168.7.106 &quot;/etc/init.d/tomcat start&quot;&#x27;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-11-3-16-验证-slave-执行构建"><a href="#4-11-3-16-验证-slave-执行构建" class="headerlink" title="4.11.3.16 验证 slave 执行构建"></a>4.11.3.16 验证 slave 执行构建</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-127.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-128.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-11-3-17-验证-web-服务器代码版本"><a href="#4-11-3-17-验证-web-服务器代码版本" class="headerlink" title="4.11.3.17 验证 web 服务器代码版本"></a>4.11.3.17 验证 web 服务器代码版本</h4><p>Gitlab 重新提交代码并测试代码部署</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-129.png" srcset="/blog/img/loading.gif"></p>
<h1 id="五、代码质量测试"><a href="#五、代码质量测试" class="headerlink" title="五、代码质量测试"></a>五、代码质量测试</h1><p>官方网站：<a target="_blank" rel="noopener" href="http://www.sonarqube.org/">http://www.sonarqube.org/</a><br>SonarQube 是一个用于代码质量管理的开放平台，通过插件机制，SonarQube 可以集成不同的测试工具，代码分析工具，以及持续集成工具，例如 Hudson/Jenkins 等。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://www.sonarqube.org/downloads/">https://www.sonarqube.org/downloads/</a></p>
<p>七个维度检测代码质量</p>
<ul>
<li>复杂度分布：代码复杂度过高将难以理解</li>
<li>重复代码：程序中包含大量复制、粘贴的代码而导致代码臃肿，sonar 可以展示源码中重复严重的地方</li>
<li>单元测试统计：统计并展示单元测试覆盖率，开发或测试可以清楚测试代码的覆盖情况</li>
<li>代码规则检查：检查代码是否符合规范</li>
<li>注释率：若代码注释过少，特别是人员变动后，其他人接手比较难接手；若过多，又不利于阅读潜在的 Bug：检测潜在的 bug</li>
<li>结构与设计：找出循环，展示包与包、类与类之间的依赖、检查程序之间耦合度</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-130.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-1-代码测试具-工具-SonarQube-简介"><a href="#5-1-代码测试具-工具-SonarQube-简介" class="headerlink" title="5.1 代码测试具 工具 SonarQube 简介"></a>5.1 代码测试具 工具 SonarQube 简介</h2><p>7.9.x 版本不再支持 MySQL<br><a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/setup/upgrade-notes/">https://docs.sonarqube.org/latest/setup/upgrade-notes/</a><br><strong>MySQL No Longer Supported</strong><br>SonarQube no longer supports MySQL. To migrate from MySQL to a supported database, see the free MySQL Migrator tool.</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-131.png" srcset="/blog/img/loading.gif"></p>
<p>下载官方安装文件：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-132.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-2-基础环境依赖"><a href="#5-2-基础环境依赖" class="headerlink" title="5.2 基础环境依赖"></a>5.2 基础环境依赖</h2><h3 id="5-2-1-数据库环境依赖："><a href="#5-2-1-数据库环境依赖：" class="headerlink" title="5.2.1 数据库环境依赖："></a>5.2.1 数据库环境依赖：</h3><p><a target="_blank" rel="noopener" href="https://docs.sonarqube.org/6.7/Requirements.html">https://docs.sonarqube.org/6.7/Requirements.html</a><br>SonarQube 6.7.X LTS 版本要求数据库要使用 MySQ 5.6 及以上版本，不支持 5.5 及更早的版本， 7.9.X LTS 版本不再使用 MySQL 。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-133.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-2-java-环境依赖"><a href="#5-2-2-java-环境依赖" class="headerlink" title="5.2.2 java 环境依赖"></a>5.2.2 java 环境依赖</h3><p><font color="red">6.7.X 需要使用 Oracle JRE8</font></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-134.png" srcset="/blog/img/loading.gif"></p>
<p><font color="red">7.9.X 需要使用jdk8或jdk11</font></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-135.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-3-系统及内核参数"><a href="#5-2-3-系统及内核参数" class="headerlink" title="5.2.3 系统及内核参数"></a>5.2.3 系统及内核参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># useradd -s /bin/bash -m sonarqube #使用普通账户启动 sonarqube</span><br>root@sonarqube:~<span class="hljs-comment"># vim /etc/sysctl.conf</span><br>vm.max_map_count=262144<br>fs.file-max=65536<br>root@sonarqube:~<span class="hljs-comment"># sysctl -p</span><br><br>root@sonarqube:~<span class="hljs-comment"># vim /etc/security/limits.conf</span><br>sonarqube - nofile 65536<br>sonarqube - nproc 65536<br><br><span class="hljs-comment">#重新登录或重启生效limits.conf</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-136.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-4-硬件依赖"><a href="#5-2-4-硬件依赖" class="headerlink" title="5.2.4 硬件依赖"></a>5.2.4 硬件依赖</h3><p>CPU/内存/磁盘</p>
<h2 id="5-3-部署-SonarQube"><a href="#5-3-部署-SonarQube" class="headerlink" title="5.3 部署 SonarQube"></a>5.3 部署 SonarQube</h2><h3 id="5-3-1-MySQL-数据库及-SonarQube-6-7-X-部署"><a href="#5-3-1-MySQL-数据库及-SonarQube-6-7-X-部署" class="headerlink" title="5.3.1 MySQL 数据库及 SonarQube 6.7.X 部署"></a>5.3.1 MySQL 数据库及 SonarQube 6.7.X 部署</h3><h4 id="5-3-1-1-安装-MySQL"><a href="#5-3-1-1-安装-MySQL" class="headerlink" title="5.3.1.1 安装 MySQL"></a>5.3.1.1 安装 MySQL</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># apt-get install mysql-server mysql-client</span><br>root@sonarqube:~<span class="hljs-comment"># vim /etc/mysql/mysql.conf.d/mysqld.cnf #配置文件路径</span><br>root@sonarqube:~<span class="hljs-comment"># mysql</span><br>Welcome to the MySQL monitor. Commands end with ; or \g.<br>Your MySQL connection id is 3<br>Server version: 5.7.26-0ubuntu0.18.04.1 (Ubuntu)<br>Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.<br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><span class="hljs-comment">#创建数据库默认编码 utf-8 并授权</span><br>mysql&gt; create database sonar default character <span class="hljs-built_in">set</span> utf8 collate utf8_general_ci;<br>Query OK, 1 row affected (0.00 sec)<br>mysql&gt; GRANT ALL PRIVILEGES ON sonar.* TO <span class="hljs-string">&#x27;sonar&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED BY<br><span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected, 1 warning (0.00 sec)<br></code></pre></td></tr></table></figure>

<h4 id="5-3-1-2-测试-sonar-账户连接-mysql"><a href="#5-3-1-2-测试-sonar-账户连接-mysql" class="headerlink" title="5.3.1.2 测试 sonar 账户连接 mysql"></a>5.3.1.2 测试 sonar 账户连接 mysql</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># mysql -usonar -p123456</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor. Commands end with ; or \g.<br>Your MySQL connection id is 6<br>Server version: 5.7.26-0ubuntu0.18.04.1 (Ubuntu)<br>Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.<br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; show databases;<br>+--------------------+<br>| Database |<br>+--------------------+<br>| information_schema |<br>| sonar |<br>+--------------------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h4 id="5-3-1-3-解压-sonarqube-并配置文件"><a href="#5-3-1-3-解压-sonarqube-并配置文件" class="headerlink" title="5.3.1.3 解压 sonarqube 并配置文件"></a>5.3.1.3 解压 sonarqube 并配置文件</h4><p>sonar 依赖于 java 环境，而且 java 版本必须是 1.8 版本或更高，否则 sonar 启动失败6.7.X 版本的 sonar 需要调用 elasticsearch ，而且默认需要使用普通用户启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># cd /usr/local/src/</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># unzip sonarqube-6.7.7.zip</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/sonarqube-6.7.7 /usr/local/sonarqube</span><br><span class="hljs-string">&#x27;/usr/local/sonarqube&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/sonarqube-6.7.7&#x27;</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># chown sonarqube.sonarqube /usr/local/src/sonarqube-6.7.7</span><br>/usr/<span class="hljs-built_in">local</span>/sonarqube -R <span class="hljs-comment">#更改目录权限属主和属组为 sonarqube</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># cd /usr/local/sonarqube</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube<span class="hljs-comment"># ll #验证权限属主和属组都为 sonarqube</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube<span class="hljs-comment"># su – sonarqube # 切换为 sonarqube 账户</span><br>sonarqube@sonarqube:~$ <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/sonarqube<br>sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ vim conf/sonar.properties<br>sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ grep <span class="hljs-string">&quot;^[a-Z]&quot;</span> conf/sonar.properties<br>sonar.jdbc.username=sonar<br>sonar.jdbc.password=123456<br>sonar.jdbc.url=jdbc:mysql://127.0.0.1:3306/sonar?useUnicode=<span class="hljs-literal">true</span>&amp;characterEncoding =utf8&amp;rewriteBatchedStatements=<span class="hljs-literal">true</span>&amp;useConfigs=maxPerformance&amp;useSSL=<span class="hljs-literal">false</span><br>sonar.web.host=0.0.0.0<br>sonar.web.port=9000<br></code></pre></td></tr></table></figure>

<h4 id="5-3-14-启动-sonarqube"><a href="#5-3-14-启动-sonarqube" class="headerlink" title="5.3.14 启动 sonarqube"></a>5.3.14 启动 sonarqube</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ ./bin/linux-x86-64/sonar.sh start<br>Starting SonarQube...<br>Started SonarQube.<br>tail -f <span class="hljs-built_in">log</span>/*.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure>

<p>验证日志：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-137.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-1-5-登录到-到-web-界面-："><a href="#5-3-1-5-登录到-到-web-界面-：" class="headerlink" title="5.3.1.5 登录到 到 web 界面 ："></a>5.3.1.5 登录到 到 web 界面 ：</h4><p>点击有上角 login 登录，默认用户名密码都是 admin</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-138.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-1-6-安装中文支持"><a href="#5-3-1-6-安装中文支持" class="headerlink" title="5.3.1.6 安装中文支持"></a>5.3.1.6 安装中文支持</h4><h5 id="5-3-1-6-1-查看本地已安装"><a href="#5-3-1-6-1-查看本地已安装" class="headerlink" title="5.3.1.6.1 查看本地已安装"></a>5.3.1.6.1 查看本地已安装</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#插件本地路径安装中文插件：</span><br>sonarqube@sonarqube:~$ ll /usr/<span class="hljs-built_in">local</span>/sonarqube/extensions/plugins/<br>total 40476<br>drwxr-xr-x 2 sonarqube sonarqube 4096 Jul 22 18:06 ./<br>drwxr-xr-x 5 sonarqube sonarqube 4096 Jul 22 18:07 ../<br>-rw-r--r-- 1 sonarqube sonarqube 92 Apr 16 15:39 README.txt<br>-rw-r--r-- 1 sonarqube sonarqube 2703958 Apr 15 18:38 sonar-csharp-plugin-6.5.0.3766.jar<br>-rw-r--r-- 1 sonarqube sonarqube 1618672 Apr 15 18:38 sonar-flex-plugin-2.3.jar<br>-rw-r--r-- 1 sonarqube sonarqube 6759535 Apr 15 18:38 sonar-java-plugin-4.15.0.12310.jar<br>-rw-r--r-- 1 sonarqube sonarqube 3355702 Apr 15 18:38 sonar-javascript-plugin-<br>3.2.0.5506.jar<br>-rw-r--r-- 1 sonarqube sonarqube 3022870 Apr 15 18:38 sonar-php-plugin-2.11.0.2485.jar<br>-rw-r--r-- 1 sonarqube sonarqube 4024311 Apr 15 18:38 sonar-python-plugin-1.8.0.1496.jar<br>-rw-r--r-- 1 sonarqube sonarqube 3625962 Apr 15 18:38 sonar-scm-git-plugin-1.3.0.869.jar<br>-rw-r--r-- 1 sonarqube sonarqube 6680471 Apr 15 18:38 sonar-scm-svn-plugin-1.6.0.860.jar<br>-rw-r--r-- 1 sonarqube sonarqube 2250667 Apr 15 18:38 sonar-typescript-plugin-<br>1.1.0.1079.jar<br>-rw-r--r-- 1 sonarqube sonarqube 7368250 Apr 15 18:38 sonar-xml-plugin-1.4.3.1027.jar<br></code></pre></td></tr></table></figure>

<h5 id="5-6-1-3-2-安装中文语言插件"><a href="#5-6-1-3-2-安装中文语言插件" class="headerlink" title="5.6.1.3.2 安装中文语言插件"></a>5.6.1.3.2 安装中文语言插件</h5><p>administration- Marketplace，在后面的搜索框搜索插件 chinese，然后点 install 安装，或在插件目录 /usr/local/sonarqube/extensions/plugins/ 执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://github.com/SonarQubeCommunity/sonar-l10n-zh/releases/download/sonar-l10n-zh-plugin-1.11/sonar-l10n-zh-plugin-1.11.jar<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-139.png" srcset="/blog/img/loading.gif"></p>
<h5 id="5-6-1-3-3-重启-sonarquebe"><a href="#5-6-1-3-3-重启-sonarquebe" class="headerlink" title="5.6.1.3.3 重启 sonarquebe"></a>5.6.1.3.3 重启 sonarquebe</h5><p>Web 界面安装完成插件后或者在插件目录下载插件后需要重启 sonarquebe 服务生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">sonarqube@sonarqube:~$ /usr/<span class="hljs-built_in">local</span>/sonarqube/bin/linux-x86-64/sonar.sh restart<br>Stopping SonarQube...<br>Waiting <span class="hljs-keyword">for</span> SonarQube to <span class="hljs-built_in">exit</span>...<br>Stopped SonarQube.<br>Starting SonarQube...<br>Started SonarQube.<br></code></pre></td></tr></table></figure>

<p>或者在 web 界面重启：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-140.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-1-7-安装其他插件"><a href="#5-3-1-7-安装其他插件" class="headerlink" title="5.3.1.7 安装其他插件"></a>5.3.1.7 安装其他插件</h4><p>Sonarquebe 对代码的扫描都基于插件实现，因此要安装要扫描的开发语言插件：<br>Php<br>Java<br>Python<br>内存不足的截图：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-141.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-3-2-PostgreSQL-及-SonarQube-7-9-X-部署"><a href="#5-3-2-PostgreSQL-及-SonarQube-7-9-X-部署" class="headerlink" title="5.3.2 PostgreSQL 及 SonarQube 7.9.X 部署"></a>5.3.2 PostgreSQL 及 SonarQube 7.9.X 部署</h3><h4 id="5-3-2-1-安装-JDK-11"><a href="#5-3-2-1-安装-JDK-11" class="headerlink" title="5.3.2.1 安装 JDK 11"></a>5.3.2.1 安装 JDK 11</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube-server:~<span class="hljs-comment"># apt-cache madison openjdk-11-jdk #也可以使用oracle的jdk</span><br>openjdk-11-jdk | 11.0.6+10-1ubuntu1~18.04.1 | http://mirrors.aliyun.com/ubuntu bionic-security/main amd64 Packages<br>openjdk-11-jdk | 11.0.6+10-1ubuntu1~18.04.1 | http://mirrors.aliyun.com/ubuntu bionic-updates/main amd64 Packages<br>openjdk-11-jdk | 10.0.1+10-3ubuntu1 | http://mirrors.aliyun.com/ubuntu bionic/main amd64 Packages<br>openjdk-lts | 10.0.1+10-3ubuntu1 | http://mirrors.aliyun.com/ubuntu bionic/main Sources<br>openjdk-lts | 11.0.6+10-1ubuntu1~18.04.1 | http://mirrors.aliyun.com/ubuntu bionic-security/main Sources<br>openjdk-lts | 11.0.6+10-1ubuntu1~18.04.1 | http://mirrors.aliyun.com/ubuntu bionic-updates/main Sources<br>root@sonarqube-server:~<span class="hljs-comment"># apt install -y openjdk-11-jdk</span><br>root@sonarqube-server:~<span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;11.0.6&quot;</span> 2020-01-14<br>OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)<br>OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode,sharing)<br></code></pre></td></tr></table></figure>

<h4 id="5-3-2-1-部署-PostgreSQL-服务器"><a href="#5-3-2-1-部署-PostgreSQL-服务器" class="headerlink" title="5.3.2.1 部署 PostgreSQL 服务器"></a>5.3.2.1 部署 PostgreSQL 服务器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube-server:~<span class="hljs-comment"># apt-cache madison postgresql #需要和官方说的版本一致</span><br>postgresql | 10+190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic security/main amd64 Packages<br>postgresql | 10+190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic security/main i386 Packages<br>postgresql | 10+190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic updates/main amd64 Packages<br>postgresql | 10+190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic updates/main i386 Packages<br>postgresql | 10+190 | http://mirrors.aliyun.com/ubuntu bionic/main amd64 Packages<br>postgresql | 10+190 | http://mirrors.aliyun.com/ubuntu bionic/main i386 Packages<br>postgresql-common | 190 | http://mirrors.aliyun.com/ubuntu bionic/main Sources<br>postgresql-common | 190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic security/main Sources<br>postgresql-common | 190ubuntu0.1 | http://mirrors.aliyun.com/ubuntu bionic updates/main Sources<br><br>root@sonarqube-server:~<span class="hljs-comment"># apt install postgresql -y</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-2-2-配置-postgrepsql"><a href="#5-3-2-2-配置-postgrepsql" class="headerlink" title="5.3.2.2 配置 postgrepsql"></a>5.3.2.2 配置 postgrepsql</h4><p>切换到 postgres 操作，PostgresSQL 安装后会自动创建 postgres 用户且没有密码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube-server:~<span class="hljs-comment"># su - postgres</span><br>postgres@sonarqube-server:~$<br><br><span class="hljs-comment">#登录 postgresql 数据库：</span><br>postgres@sonarqube-server:~$ psql -U postgres<br>psql (10.12 (Ubuntu 10.12-0ubuntu0.18.04.1))<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>.<br><br><span class="hljs-comment">#创建数据库并进行授权普通用户访问：</span><br>postgres=<span class="hljs-comment"># CREATE DATABASE sonar; #创建数据库</span><br>CREATE DATABASE<br><br>postgres=<span class="hljs-comment"># CREATE USER sonar WITH ENCRYPTED PASSWORD &#x27;123456&#x27;; #创建用户</span><br>CREATE ROLE<br><br>postgres=<span class="hljs-comment"># GRANT ALL PRIVILEGES ON DATABASE sonar TO sonar; #授权用户</span><br>GRANT<br><br>postgres=<span class="hljs-comment"># ALTER DATABASE sonar OWNER TO sonar; #执行变更</span><br>ALTER DATABASE<br><br>postgres=<span class="hljs-comment"># \q</span><br><br>postgres@sonarqube-server:~$ <span class="hljs-built_in">exit</span><br><span class="hljs-built_in">logout</span><br><br><span class="hljs-comment">#修改监听地址</span><br>root@sonarqube-server:~<span class="hljs-comment"># vim /etc/postgresql/10/main/postgresql.conf</span><br>59 listen_addresses = <span class="hljs-string">&#x27;*&#x27;</span><br><br><span class="hljs-comment">#开启远程访问</span><br>root@sonarqube-server:~<span class="hljs-comment"># vim /etc/postgresql/10/main/pg_hba.conf</span><br>85:<span class="hljs-built_in">local</span> all postgres peer<br>90:<span class="hljs-built_in">local</span> all all peer<br>92:host all all 0.0.0.0/0 md5<br>94:host all all ::1/128 md5<br>97:<span class="hljs-built_in">local</span> replication all peer<br>98:host replication all 127.0.0.1/32 md5<br>99:host replication all ::1/128 md5<br><br>root@sonarqube-server:~<span class="hljs-comment"># systemctl restart postgresql</span><br>root@sonarqube:~<span class="hljs-comment"># systemctl enable postgresql</span><br>Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.<br>Executing: /lib/systemd/systemd-sysv-install <span class="hljs-built_in">enable</span> postgresql<br><br><br>root@sonarqube:~<span class="hljs-comment"># ss -tnl #port=5432</span><br>State           Recv-Q           Send-Q                      Local Address:Port                       Peer Address:Port           <br>LISTEN          0                128                               0.0.0.0:111                             0.0.0.0:*              <br>LISTEN          0                128                         127.0.0.53%lo:53                              0.0.0.0:*              <br>LISTEN          0                128                               0.0.0.0:22                              0.0.0.0:*              <br>LISTEN          0                224                               0.0.0.0:5432                            0.0.0.0:*              <br>LISTEN          0                64                                0.0.0.0:29276                           0.0.0.0:*              <br>LISTEN          0                128                               0.0.0.0:12988                           0.0.0.0:*              <br>LISTEN          0                64                                0.0.0.0:2049                            0.0.0.0:*              <br>LISTEN          0                128                               0.0.0.0:61154                           0.0.0.0:*              <br>LISTEN          0                128                               0.0.0.0:21130                           0.0.0.0:*              <br>LISTEN          0                64                                   [::]:19310                              [::]:*              <br>LISTEN          0                128                                  [::]:111                                [::]:*              <br>LISTEN          0                128                                  [::]:22                                 [::]:*              <br>LISTEN          0                224                                  [::]:5432                               [::]:* <span class="hljs-comment">#postgresql已经启动</span><br><br>LISTEN          0                64                                   [::]:2049                               [::]:*              <br>LISTEN          0                128                                  [::]:27140                              [::]:*              <br>LISTEN          0                128                                  [::]:34790                              [::]:*              <br>LISTEN          0                128                                  [::]:37770                              [::]:* <br></code></pre></td></tr></table></figure>

<h4 id="5-3-2-2-部署-7-9-X-SonarQube"><a href="#5-3-2-2-部署-7-9-X-SonarQube" class="headerlink" title="5.3.2.2 部署 7.9.X SonarQube"></a>5.3.2.2 部署 7.9.X SonarQube</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># cd /usr/local/src/</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/src<br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># unzip sonarqube-7.9.2.zip</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/sonarqube-7.9.2 /usr/local/sonarqube </span><br><span class="hljs-string">&#x27;/usr/local/sonarqube&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/sonarqube-7.9.2&#x27;</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># useradd -r -m -s /bin/bash sonarqube</span><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># chown sonarqube.sonarqube /usr/local/sonarqube /usr/local/src/sonarqube-7.9.2 -R</span><br><br>root@sonarqube:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># su - sonarqube</span><br>sonarqube@sonarqube:~$ <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/sonarqube<br>sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ vim conf/sonar.properties<br>16 sonar.jdbc.username=sonar<br>17 sonar.jdbc.password=123456<br><span class="hljs-comment">#sonar.jdbc.url=jdbc:postgresql://172.31.0.106/sonarqube?currentSchema=my_schema</span><br>34 sonar.jdbc.url=jdbc:postgresql://10.0.0.108/sonar<br><br><br>sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ ./bin/linux-x86-64/sonar.sh --<span class="hljs-built_in">help</span><br>Usage: ./bin/linux-x86-64/sonar.sh &#123; console | start | stop | force-stop | restart | status | dump &#125;<br><br>sonarqube@sonarqube:/usr/<span class="hljs-built_in">local</span>/sonarqube$ ./bin/linux-x86-64/sonar.sh start<br>Starting SonarQube...<br>Started SonarQube.<br>tail -f /usr/<span class="hljs-built_in">local</span>/sonarqube/logs/*.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-142.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-2-3-验证-SonarQube"><a href="#5-3-2-3-验证-SonarQube" class="headerlink" title="5.3.2.3 验证 SonarQube"></a>5.3.2.3 验证 SonarQube</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-143.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-2-4-访问-SonarQube-web-界面"><a href="#5-3-2-4-访问-SonarQube-web-界面" class="headerlink" title="5.3.2.4 访问 SonarQube web 界面"></a>5.3.2.4 访问 SonarQube web 界面</h4><p>浏览器访问：IP:9000</p>
<p>登录账户名和密码默认都是 admin</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-144.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-2-5-安装中文插件"><a href="#5-3-2-5-安装中文插件" class="headerlink" title="5.3.2.5 安装中文插件"></a>5.3.2.5 安装中文插件</h4><p>插件安装位置：/usr/local/sonarqube/xtensions/plugins/</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-145.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another98.png" srcset="/blog/img/loading.gif" alt="another98"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another99.png" srcset="/blog/img/loading.gif"></p>
<p>刷新网页，并重新登录</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-146.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-2-6-server脚本"><a href="#5-3-2-6-server脚本" class="headerlink" title="5.3.2.6 server脚本"></a>5.3.2.6 server脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube:~<span class="hljs-comment"># vim /etc/systemd/system/sonarqube.service</span><br>[Unit]<br>Description=SonarQube service<br>After=syslog.target network.target<br><br>[Service]<br>Type=simple<br>User=sonarqube<br>Group=sonarqube<br>PermissionsStartOnly=<span class="hljs-literal">true</span><br><span class="hljs-comment">#注意nohup，java 和sonar.jar的路径。最大内存和最小内存根据需要修改</span><br>ExecStart=/usr/bin/nohup /usr/bin/java -Xms2048m -Xmx2048m -Djava.net.preferIPv4Stack=<span class="hljs-literal">true</span> -jar /usr/<span class="hljs-built_in">local</span>/sonarqube/lib/sonar-application-7.9.2.jar<br>StandardOutput=syslog<br>LimitNOFILE=65536<br>LimitNPROC=8192<br>TimeoutStartSec=5<br>Restart=always<br><br>[Install]<br>WantedBy=multi-user.target<br><br>root@sonarqube:~<span class="hljs-comment"># systemctl daemon-reload</span><br>root@sonarqube:~<span class="hljs-comment"># systemctl start sonarqube</span><br>root@sonarqube:~<span class="hljs-comment"># systemctl status sonarqube</span><br>root@sonarqube:~<span class="hljs-comment"># systemctl enable sonarqube</span><br><span class="hljs-comment">#最后查看9000端口和网页即可</span><br></code></pre></td></tr></table></figure>

<h2 id="5-4-jenkins-服务器部署扫描器-sonar-scanner"><a href="#5-4-jenkins-服务器部署扫描器-sonar-scanner" class="headerlink" title="5.4 jenkins 服务器部署扫描器 sonar-scanner"></a>5.4 jenkins 服务器部署扫描器 sonar-scanner</h2><p>下载地址：<a target="_blank" rel="noopener" href="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/">https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/">https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/</a></p>
<p>生产环境流使用sonar-scanner流程图</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another148.png" srcset="/blog/img/loading.gif" alt="使用sonar-scanner流程图"></p>
<h3 id="5-4-1-部署-sonar-scanner"><a href="#5-4-1-部署-sonar-scanner" class="headerlink" title="5.4.1 部署 sonar-scanner"></a>5.4.1 部署 sonar-scanner</h3><p>sonarqube 通过调用扫描器 sonar-scanner 进行代码质量分析，即扫描器的具体工作就是扫描代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cd /usr/local/src/</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># unzip sonar-scanner-cli-4.3.0.2102-linux.zip</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/sonar-scanner-4.3.0.2102-linux /usr/local/sonar-scanner</span><br><span class="hljs-string">&#x27;/usr/local/sonar-scanner&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/sonar-scanner-4.3.0.2102-linux&#x27;</span><br><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># cd /usr/local/sonar-scanner</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/sonar-scanner<span class="hljs-comment"># ll</span><br>total 24<br>drwxr-xr-x 6 root root 4096 Feb 20  2020 ./<br>drwxr-xr-x 4 root root 4096 May  2 06:18 ../<br>drwxr-xr-x 2 root root 4096 Feb 20  2020 bin/<br>drwxr-xr-x 2 root root 4096 Feb 20  2020 conf/<br>drwxr-xr-x 6 root root 4096 Feb 20  2020 jre/<br>drwxr-xr-x 2 root root 4096 Feb 20  2020 lib/<br><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/sonar-scanner<span class="hljs-comment"># vim conf/sonar-scanner.properties</span><br><span class="hljs-comment">#----- Default SonarQube server</span><br>sonar.host.url=http://10.0.0.108:9000<br><span class="hljs-comment">#----- Default source code encoding</span><br>sonar.sourceEncoding=UTF-8<br></code></pre></td></tr></table></figure>

<h3 id="5-4-2-准备测试代码"><a href="#5-4-2-准备测试代码" class="headerlink" title="5.4.2 准备测试代码"></a>5.4.2 准备测试代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#解压测试代码</span><br><span class="hljs-comment"># unzip sonar-examples-master.zip</span><br><span class="hljs-comment"># cd sonar-examples-master/</span><br><br><span class="hljs-comment">#以php语言为作为测试代码</span><br><span class="hljs-comment"># cd projects/languages/php/php-sonar-runner</span><br><span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/php/php-sonar-runner<br><span class="hljs-comment"># ll</span><br>total 24<br>drwxr-xr-x 3 root root 4096 Jul 25 2016 ./<br>drwxr-xr-x 4 root root 4096 Jul 25 2016 ../<br>-rw-r--r-- 1 root root 453 Jul 25 2016 README.md<br>-rw-r--r-- 1 root root 331 Jul 25 2016 sonar-project.properties<br>drwxr-xr-x 2 root root 4096 Jul 25 2016 src/<br>-rw-r--r-- 1 root root 272 Jul 25 2016 validation.txt<br><br><span class="hljs-comment"># cat sonar-project.properties 以下为默认生成的配置文件</span><br><span class="hljs-comment"># Required metadata</span><br>sonar.projectKey=org.sonarqube:php-simple-sq-scanner <span class="hljs-comment">#自定义项目 key</span><br>sonar.projectName=PHP :: Simple Project :: SonarQube Scanner <span class="hljs-comment">#项目名称，会显示在web</span><br>sonar.projectVersion=1.0 <span class="hljs-comment">#项目版本</span><br><br><span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>sonar.sources=src <span class="hljs-comment">#源代码目录</span><br><br><span class="hljs-comment"># Language</span><br>sonar.language=php <span class="hljs-comment">#代码语言类型</span><br><br><span class="hljs-comment"># Encoding of the source files</span><br>sonar.sourceEncoding=UTF-8 <span class="hljs-comment">#编码格式</span><br></code></pre></td></tr></table></figure>

<h3 id="5-4-3-在源代码目录执行扫描"><a href="#5-4-3-在源代码目录执行扫描" class="headerlink" title="5.4.3 在源代码目录执行扫描"></a>5.4.3 在源代码目录执行扫描</h3><p>手动在当前项目代码目录执行扫描，以下是扫描过程的提示信息，扫描的配置文件sonar-project.propertie 每个项目都要有</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@sonarqube-server:/usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner<br>root@sonarqube-server:/usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner<span class="hljs-comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span><br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner/sonar-project.properties<br>INFO: SonarScanner 4.3.0.2102<br>INFO: Java 11.0.3 AdoptOpenJDK (64-bit)<br>INFO: Linux 4.15.0-55-generic amd64<br>INFO: User cache: /root/.sonar/cache<br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner/sonar-project.properties<br>INFO: Analyzing on SonarQube server 7.9.2<br>INFO: Default locale: <span class="hljs-string">&quot;en_HK&quot;</span>, <span class="hljs-built_in">source</span> code encoding: <span class="hljs-string">&quot;UTF-8&quot;</span><br>INFO: Load global settings<br>INFO: Load global settings (<span class="hljs-keyword">done</span>) | time=82ms<br>INFO: Server id: 9A84A96E-AXl6fM6ITuzQthHv-dgM<br>INFO: User cache: /root/.sonar/cache<br>INFO: Load/download plugins<br>INFO: Load plugins index<br>INFO: Load plugins index (<span class="hljs-keyword">done</span>) | time=35ms<br>INFO: Plugin [l10nzh] defines <span class="hljs-string">&#x27;l10nen&#x27;</span> as base plugin. This metadata can be removed from manifest of l10n plugins since version 5.2.<br>INFO: Load/download plugins (<span class="hljs-keyword">done</span>) | time=1211ms<br>INFO: Process project properties<br>INFO: Execute project builders<br>INFO: Execute project builders (<span class="hljs-keyword">done</span>) | time=3ms<br>INFO: Project key: org.sonarqube:python-simple-sonar-scanner<br>INFO: Base dir: /usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner<br>INFO: Working dir: /usr/<span class="hljs-built_in">local</span>/src/sonar-examples-master/projects/languages/python/python-sonar-runner/.scannerwork<br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;org.sonarqube:python-simple-sonar-scanner&#x27;</span><br>INFO: Load quality profiles<br>INFO: Load quality profiles (<span class="hljs-keyword">done</span>) | time=44ms<br>INFO: Load active rules<br>INFO: Load active rules (<span class="hljs-keyword">done</span>) | time=736ms<br>WARN: SCM provider autodetection failed. Please use <span class="hljs-string">&quot;sonar.scm.provider&quot;</span> to define SCM of your project, or <span class="hljs-built_in">disable</span> the SCM Sensor <span class="hljs-keyword">in</span> the project settings.<br>INFO: Indexing files...<br>INFO: Project configuration:<br>INFO: 9 files indexed<br>INFO: Quality profile <span class="hljs-keyword">for</span> py: Sonar way<br>INFO: ------------- Run sensors on module Python :: Simple Project : SonarQube Scanner<br>INFO: Load metrics repository<br>INFO: Load metrics repository (<span class="hljs-keyword">done</span>) | time=23ms<br>WARNING: An illegal reflective access operation has occurred<br>WARNING: Illegal reflective access by net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span> (file:/root/.sonar/cache/866bb1adbf016ea515620f1aaa15ec53/sonar-javascript-plugin.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain)<br>WARNING: Please consider reporting this to the maintainers of net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span><br>WARNING: Use --illegal-access=warn to <span class="hljs-built_in">enable</span> warnings of further illegal reflective access operations<br>WARNING: All illegal access operations will be denied <span class="hljs-keyword">in</span> a future release<br>INFO: Sensor Python Squid Sensor [python]<br>INFO: Load project repositories<br>INFO: Load project repositories (<span class="hljs-keyword">done</span>) | time=6ms<br>INFO: Sensor Python Squid Sensor [python] (<span class="hljs-keyword">done</span>) | time=201ms<br>INFO: Sensor Cobertura Sensor <span class="hljs-keyword">for</span> Python coverage [python]<br>INFO: Sensor Cobertura Sensor <span class="hljs-keyword">for</span> Python coverage [python] (<span class="hljs-keyword">done</span>) | time=8ms<br>INFO: Sensor PythonXUnitSensor [python]<br>INFO: Sensor PythonXUnitSensor [python] (<span class="hljs-keyword">done</span>) | time=0ms<br>INFO: Sensor JaCoCo XML Report Importer [jacoco]<br>INFO: Sensor JaCoCo XML Report Importer [jacoco] (<span class="hljs-keyword">done</span>) | time=2ms<br>INFO: Sensor JavaXmlSensor [java]<br>INFO: Sensor JavaXmlSensor [java] (<span class="hljs-keyword">done</span>) | time=1ms<br>INFO: Sensor HTML [web]<br>INFO: Sensor HTML [web] (<span class="hljs-keyword">done</span>) | time=6ms<br>INFO: ------------- Run sensors on project<br>INFO: Sensor Zero Coverage Sensor<br>INFO: Sensor Zero Coverage Sensor (<span class="hljs-keyword">done</span>) | time=6ms<br>INFO: No SCM system was detected. You can use the <span class="hljs-string">&#x27;sonar.scm.provider&#x27;</span> property to explicitly specify it.<br>INFO: 5 files had no CPD blocks<br>INFO: Calculating CPD <span class="hljs-keyword">for</span> 4 files<br>INFO: CPD calculation finished<br>INFO: Analysis report generated <span class="hljs-keyword">in</span> 39ms, dir size=106 KB<br>INFO: Analysis report compressed <span class="hljs-keyword">in</span> 10ms, zip size=30 KB<br>INFO: Analysis report uploaded <span class="hljs-keyword">in</span> 334ms<br>INFO: ANALYSIS SUCCESSFUL, you can browse http://localhost:9000/dashboard?id=org.sonarqube%3Apython-simple-sonar-scanner<br>INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report<br>INFO: More about the report processing at http://localhost:9000/api/ce/task?id=AXl6ojbr-PTo1GAXoFlA<br>INFO: Analysis total time: 2.508 s<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION SUCCESS<br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: 4.502s<br>INFO: Final Memory: 6M/27M<br>INFO: ------------------------------------------------------------------------<br></code></pre></td></tr></table></figure>

<p>结果一旦出现success就证明代码没有出错，但是不一定没有其他问题</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-147.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-4-4-sonarquebe-界面验证扫描结果"><a href="#5-4-4-sonarquebe-界面验证扫描结果" class="headerlink" title="5.4.4 sonarquebe 界面验证扫描结果"></a>5.4.4 sonarquebe 界面验证扫描结果</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-148.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-5-jenkins-执行代码扫描"><a href="#5-5-jenkins-执行代码扫描" class="headerlink" title="5.5 jenkins 执行代码扫描"></a>5.5 jenkins 执行代码扫描</h2><h3 id="5-5-1-配置扫描"><a href="#5-5-1-配置扫描" class="headerlink" title="5.5.1 配置扫描"></a>5.5.1 配置扫描</h3><p>下载自己的项目，将配置文件的内容修改成如下格式填写完成后点保存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@web3:~<span class="hljs-comment"># git clone -b develop http://10.0.0.101/linux/web1.git</span><br>Cloning into <span class="hljs-string">&#x27;web1&#x27;</span>...<br>Username <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span>: rlin<br>Password <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://rlin@10.0.0.101&#x27;</span>: <br>remote: Enumerating objects: 54, <span class="hljs-keyword">done</span>.<br>remote: Counting objects: 100% (54/54), <span class="hljs-keyword">done</span>.<br>remote: Compressing objects: 100% (37/37), <span class="hljs-keyword">done</span>.<br>remote: Total 54 (delta 12), reused 52 (delta 11)<br>Unpacking objects: 100% (54/54), <span class="hljs-keyword">done</span>.<br>root@web3:~<span class="hljs-comment"># cd web1/</span><br><br>root@web3:~/web1<span class="hljs-comment"># vim sonar-project.properties</span><br><span class="hljs-comment"># Required metadata</span><br>sonar.projectKey=linux-web1<br>sonar.projectName=linux-web1<br>sonar.projectVersion=v0.1.1<br><br><span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br><span class="hljs-comment">#路径看着写</span><br>sonar.sources=<span class="hljs-built_in">source</span> <br><br><span class="hljs-comment"># Language</span><br>sonar.language=py<br><br><span class="hljs-comment"># Encoding of the source files</span><br>sonar.sourceEncoding=UTF-8<br><br><span class="hljs-comment">#下面为自己的目录添加一些脚本</span><br>root@web3:~/web1<span class="hljs-comment"># mkdir source</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/web1<span class="hljs-comment"># cd source/</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/web1/<span class="hljs-built_in">source</span><span class="hljs-comment"># vim linux.py</span><br><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-built_in">print</span> linux1<br><span class="hljs-built_in">print</span> linux2<br><span class="hljs-built_in">print</span> linux3<br>root@web3:/opt/<span class="hljs-built_in">source</span>/web1/<span class="hljs-built_in">source</span><span class="hljs-comment"># python3 linux.py</span><br>  File <span class="hljs-string">&quot;linux.py&quot;</span>, line 2<br>    <span class="hljs-built_in">print</span> linux1<br>               ^<br>SyntaxError: Missing parentheses <span class="hljs-keyword">in</span> call to <span class="hljs-string">&#x27;print&#x27;</span>. Did you mean <span class="hljs-built_in">print</span>(linux1)?<br><span class="hljs-comment">#上传</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-2-使用Jenkins手动扫描（通过命令行，推荐，前提Jenkins服务器里要安装sonarqube扫描器）"><a href="#5-5-2-使用Jenkins手动扫描（通过命令行，推荐，前提Jenkins服务器里要安装sonarqube扫描器）" class="headerlink" title="5.5.2 使用Jenkins手动扫描（通过命令行，推荐，前提Jenkins服务器里要安装sonarqube扫描器）"></a>5.5.2 使用Jenkins手动扫描（通过命令行，推荐，前提Jenkins服务器里要安装sonarqube扫描器）</h3><h4 id="5-5-2-1-Jenkins-master服务器安装sonarqube扫描器"><a href="#5-5-2-1-Jenkins-master服务器安装sonarqube扫描器" class="headerlink" title="5.5.2.1 Jenkins-master服务器安装sonarqube扫描器"></a>5.5.2.1 Jenkins-master服务器安装sonarqube扫描器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins:~<span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment">#下载sonarqube扫描器</span><br><span class="hljs-comment">#解压扫描器</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># unzip sonar-scanner-cli-4.3.0.2102-linux.zip</span><br><span class="hljs-comment">#制作软连接，解决以后版本升级的问题</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/sonar-scanner-4.3.0.2102-linux /usr/local/sonar-scanner</span><br><span class="hljs-string">&#x27;/usr/local/sonar-scanner&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/sonar-scanner-4.3.0.2102-linux&#x27;</span><br><span class="hljs-comment">#修改配置文件</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span><span class="hljs-comment"># cd /usr/local/sonar-scanner</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/sonar-scanner<span class="hljs-comment"># vim conf/sonar-scanner.properties</span><br><span class="hljs-comment">#Configure here general information about the environment, such as SonarQube server connection details for example</span><br><span class="hljs-comment">#No information about specific project should appear here</span><br><br><span class="hljs-comment">#----- Default SonarQube server</span><br><span class="hljs-comment">#sonar.host.url=http://localhost:9000</span><br>sonar.host.url=http://10.0.0.108:9000<br><br><span class="hljs-comment">#----- Default source code encoding</span><br><span class="hljs-comment">#sonar.sourceEncoding=UTF-8</span><br>sonar.sourceEncoding=UTF-8<br><br><span class="hljs-comment">#测试扫描</span><br>root@jenkins:~<span class="hljs-comment"># cd /data/</span><br><span class="hljs-comment">#下载sonar的一个代码样板包sonar-examples-master</span><br><span class="hljs-comment">#解压</span><br>root@jenkins-master:/data<span class="hljs-comment"># unzip sonar-examples-master.zip</span><br><span class="hljs-comment">#进入一个要测试的代码的文件夹（一定要进入到当前需要进行扫描的文件夹才可以进行扫描） #sonar-project.properties这个文件在这里是不用改</span><br>root@jenkins-master:/data<span class="hljs-comment"># cd sonar-examples-master/projects/languages/php/php-sonar-runner</span><br>root@jenkins-master:/data/sonar-examples-master/projects/languages/php/php-sonar-runner<span class="hljs-comment"># ls</span><br>README.md  sonar-project.properties  src  validation.txt<br><span class="hljs-comment">#进行测试</span><br>root@jenkins-master:/data/sonar-examples-master/projects/languages/php/php-sonar-runner<span class="hljs-comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span><br>........<br>INFO: Analysis total time: 4.522 s<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION SUCCESS <span class="hljs-comment">#最后会出现SUCCESS字样，就证明成功</span><br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: 10.638s<br>INFO: Final Memory: 6M/24M<br>INFO: ------------------------------------------------------------------------<br></code></pre></td></tr></table></figure>

<h4 id="5-2-2-2-在Jenkins里设置要扫描的项目"><a href="#5-2-2-2-在Jenkins里设置要扫描的项目" class="headerlink" title="5.2.2.2 在Jenkins里设置要扫描的项目"></a>5.2.2.2 在Jenkins里设置要扫描的项目</h4><p>进入Jenkins，进入到某个要进行代码扫描的项目，在构建里添加内容，最后构建项目</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another100.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-develop &amp;&amp; /usr/<span class="hljs-built_in">local</span>/sonar-scanner/bin/sonar-scanner &amp;&amp; tar czvf myapp.tar.gz ./*<br><br>scp myapp.tar.gz www@10.0.0.105:/data/tomcat/tomcat_appdir/<br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;cd /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/&quot;</span><br><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure>

<p>构建后sonarqube web界面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another101.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-5-3-通过Jenkins插件进行扫描"><a href="#5-5-3-通过Jenkins插件进行扫描" class="headerlink" title="5.5.3 通过Jenkins插件进行扫描"></a>5.5.3 通过Jenkins插件进行扫描</h3><h4 id="5-5-3-1-jenkins-安装-SonarQube-插件"><a href="#5-5-3-1-jenkins-安装-SonarQube-插件" class="headerlink" title="5.5.3.1 jenkins 安装 SonarQube 插件"></a>5.5.3.1 jenkins 安装 SonarQube 插件</h4><p>安装插件 SonarQube Scanner，然后配置 SonarQube server，系统管理-系统设置。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-149.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-5-3-2-添加-sonarquebe-URL"><a href="#5-5-3-2-添加-sonarquebe-URL" class="headerlink" title="5.5.3.2 添加 sonarquebe URL"></a>5.5.3.2 添加 sonarquebe URL</h4><p>Jenkins—系统管理—系统设置–SonarQube servers-Add SonarQube</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-150.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-5-3-3-让-jenkins-添加-Sonar-scanner-扫描器"><a href="#5-5-3-3-让-jenkins-添加-Sonar-scanner-扫描器" class="headerlink" title="5.5.3.3 让 jenkins 添加 Sonar scanner 扫描器"></a>5.5.3.3 让 jenkins 添加 Sonar scanner 扫描器</h4><p>添加扫描器：<br>Jenkins–系统管理-全局工具配置：</p>
<h5 id="5-5-3-3-1-手动指定绝对路径-（和上一个手动扫描一样需要安装扫描器）"><a href="#5-5-3-3-1-手动指定绝对路径-（和上一个手动扫描一样需要安装扫描器）" class="headerlink" title="5.5.3.3.1 手动指定绝对路径 （和上一个手动扫描一样需要安装扫描器）"></a>5.5.3.3.1 手动指定绝对路径 （和上一个手动扫描一样需要安装扫描器）</h5><p>/usr/local/src/sonar-scanner-4.0.0.1744-linux</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-151.png" srcset="/blog/img/loading.gif"></p>
<h5 id="5-5-3-3-2-自动安装"><a href="#5-5-3-3-2-自动安装" class="headerlink" title="5.5.3.3.2 自动安装"></a>5.5.3.3.2 自动安装</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-152.png" srcset="/blog/img/loading.gif"></p>
<h5 id="5-5-3-3-3-配置扫描"><a href="#5-5-3-3-3-配置扫描" class="headerlink" title="5.5.3.3.3 配置扫描"></a>5.5.3.3.3 配置扫描</h5><p>选择自己的项目 - 构建 -execute sonarqube scanner ，将配置文件的内容修改成如下格式填写完成后点保存：（要把扫描放在执行shell之前，Execute SonarQube Scanner拖上去即可）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another102.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#(以下内容是写在Analysis properties)</span><br><span class="hljs-comment"># Required metadata</span><br>sonar.projectKey=linux-web1<br>sonar.projectName=linux-web1<br>sonar.projectVersion=v0.1.2<br><br><span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>sonar.sources=<span class="hljs-built_in">source</span><br><br><span class="hljs-comment"># Language</span><br>sonar.language=py<br><br><span class="hljs-comment"># Encoding of the source files</span><br>sonar.sourceEncoding=UTF-8<br></code></pre></td></tr></table></figure>

<h5 id="5-5-3-3-4-配置项目进行扫描"><a href="#5-5-3-3-4-配置项目进行扫描" class="headerlink" title="5.5.3.3.4 配置项目进行扫描"></a>5.5.3.3.4 配置项目进行扫描</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-153.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#详细内容，根据实际修改</span><br><span class="hljs-comment"># Required metadata</span><br>    sonar.projectKey=linux-web1<br>    sonar.projectName=linux-web1<br>    sonar.projectVersion=v0.1.2<br><br>    <span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>    sonar.sources=<span class="hljs-built_in">source</span><br><br>    <span class="hljs-comment"># Language</span><br>    sonar.language=py<br><br>    <span class="hljs-comment"># Encoding of the source files</span><br>    sonar.sourceEncoding=UTF-8<br></code></pre></td></tr></table></figure>

<h5 id="5-5-3-3-5-构建项目并测试-sonar-scanner-是否生效"><a href="#5-5-3-3-5-构建项目并测试-sonar-scanner-是否生效" class="headerlink" title="5.5.3.3.5 构建项目并测试 sonar-scanner 是否生效"></a>5.5.3.3.5 构建项目并测试 sonar-scanner 是否生效</h5><p>点击项目的立即构建<font color="red">（需要先把之前手动使用扫描器的那段代码删除）</font>，下图是执行成功的信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs bash">Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace /var/lib/jenkins/workspace/linux-web1-develop<br>[WS-CLEANUP] Deleting project workspace...<br>[WS-CLEANUP] Deferred wipeout is used...<br>[WS-CLEANUP] Done<br>The recommended git tool is: NONE<br>using credential a745d835-034e-4ec6-a5f8-93f436d3a35e<br>Cloning the remote Git repository<br>Cloning repository git@10.0.0.101:linux/web1.git<br> &gt; git init /var/lib/jenkins/workspace/linux-web1-develop <span class="hljs-comment"># timeout=10</span><br>Fetching upstream changes from git@10.0.0.101:linux/web1.git<br> &gt; git --version <span class="hljs-comment"># timeout=10</span><br> &gt; git --version <span class="hljs-comment"># &#x27;git version 2.17.1&#x27;</span><br>using GIT_SSH to <span class="hljs-built_in">set</span> credentials <br> &gt; git fetch --tags --progress -- git@10.0.0.101:linux/web1.git +refs/heads/*:refs/remotes/origin/* <span class="hljs-comment"># timeout=10</span><br> &gt; git config remote.origin.url git@10.0.0.101:linux/web1.git <span class="hljs-comment"># timeout=10</span><br> &gt; git config --add remote.origin.fetch +refs/heads/*:refs/remotes/origin/* <span class="hljs-comment"># timeout=10</span><br>Avoid second fetch<br> &gt; git rev-parse refs/remotes/origin/develop^&#123;commit&#125; <span class="hljs-comment"># timeout=10</span><br>Checking out Revision 4a03f9e0a8bc551e7b788ad70bf0eb4f70648c4d (refs/remotes/origin/develop)<br> &gt; git config core.sparsecheckout <span class="hljs-comment"># timeout=10</span><br> &gt; git checkout -f 4a03f9e0a8bc551e7b788ad70bf0eb4f70648c4d <span class="hljs-comment"># timeout=10</span><br>Commit message: <span class="hljs-string">&quot;python v3&quot;</span><br> &gt; git rev-list --no-walk 4a03f9e0a8bc551e7b788ad70bf0eb4f70648c4d <span class="hljs-comment"># timeout=10</span><br>[linux-web1-develop] $ /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/bin/sonar-scanner -Dsonar.host.url=http://10.0.0.108:9000/ -Dsonar.language=py -Dsonar.projectName=linux-web1 -Dsonar.projectVersion=v0.1.2 -Dsonar.sourceEncoding=UTF-8 -Dsonar.projectKey=linux-web1 -Dsonar.sources=<span class="hljs-built_in">source</span> -Dsonar.projectBaseDir=/var/lib/jenkins/workspace/linux-web1-develop<br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: NONE<br>INFO: SonarScanner 4.3.0.2102<br>INFO: Java 11.0.3 AdoptOpenJDK (64-bit)<br>INFO: Linux 4.15.0-55-generic amd64<br>INFO: User cache: /root/.sonar/cache<br>INFO: Scanner configuration file: /usr/<span class="hljs-built_in">local</span>/src/sonar-scanner-4.3.0.2102-linux/conf/sonar-scanner.properties<br>INFO: Project root configuration file: NONE<br>INFO: Analyzing on SonarQube server 7.9.2<br>INFO: Default locale: <span class="hljs-string">&quot;en_HK&quot;</span>, <span class="hljs-built_in">source</span> code encoding: <span class="hljs-string">&quot;UTF-8&quot;</span><br>INFO: Load global settings<br>INFO: Load global settings (<span class="hljs-keyword">done</span>) | time=49ms<br>INFO: Server id: 9A84A96E-AXkxZMMhxe7GaeVzaKga<br>INFO: User cache: /root/.sonar/cache<br>INFO: Load/download plugins<br>INFO: Load plugins index<br>INFO: Load plugins index (<span class="hljs-keyword">done</span>) | time=37ms<br>INFO: Plugin [l10nzh] defines <span class="hljs-string">&#x27;l10nen&#x27;</span> as base plugin. This metadata can be removed from manifest of l10n plugins since version 5.2.<br>INFO: Load/download plugins (<span class="hljs-keyword">done</span>) | time=98ms<br>INFO: Process project properties<br>INFO: Execute project builders<br>INFO: Execute project builders (<span class="hljs-keyword">done</span>) | time=3ms<br>INFO: Project key: linux-web1<br>INFO: Base dir: /var/lib/jenkins/workspace/linux-web1-develop<br>INFO: Working dir: /var/lib/jenkins/workspace/linux-web1-develop/.scannerwork<br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;linux-web1&#x27;</span><br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;linux-web1&#x27;</span> (<span class="hljs-keyword">done</span>) | time=10ms<br>INFO: Load quality profiles<br>INFO: Load quality profiles (<span class="hljs-keyword">done</span>) | time=47ms<br>INFO: Detected Jenkins<br>INFO: Load active rules<br>INFO: Load active rules (<span class="hljs-keyword">done</span>) | time=551ms<br>INFO: Indexing files...<br>INFO: Project configuration:<br>INFO: 2 files indexed<br>INFO: 0 files ignored because of scm ignore settings<br>INFO: Quality profile <span class="hljs-keyword">for</span> py: Sonar way<br>INFO: ------------- Run sensors on module linux-web1<br>INFO: Load metrics repository<br>INFO: Load metrics repository (<span class="hljs-keyword">done</span>) | time=35ms<br>WARNING: An illegal reflective access operation has occurred<br>WARNING: Illegal reflective access by net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span> (file:/root/.sonar/cache/866bb1adbf016ea515620f1aaa15ec53/sonar-javascript-plugin.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain)<br>WARNING: Please consider reporting this to the maintainers of net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span><br>WARNING: Use --illegal-access=warn to <span class="hljs-built_in">enable</span> warnings of further illegal reflective access operations<br>WARNING: All illegal access operations will be denied <span class="hljs-keyword">in</span> a future release<br>INFO: Sensor Python Squid Sensor [python]<br>INFO: Load project repositories<br>INFO: Load project repositories (<span class="hljs-keyword">done</span>) | time=13ms<br>INFO: Sensor Python Squid Sensor [python] (<span class="hljs-keyword">done</span>) | time=116ms<br>INFO: Sensor Cobertura Sensor <span class="hljs-keyword">for</span> Python coverage [python]<br>INFO: Sensor Cobertura Sensor <span class="hljs-keyword">for</span> Python coverage [python] (<span class="hljs-keyword">done</span>) | time=19ms<br>INFO: Sensor PythonXUnitSensor [python]<br>INFO: Sensor PythonXUnitSensor [python] (<span class="hljs-keyword">done</span>) | time=3ms<br>INFO: Sensor JaCoCo XML Report Importer [jacoco]<br>INFO: Sensor JaCoCo XML Report Importer [jacoco] (<span class="hljs-keyword">done</span>) | time=3ms<br>INFO: Sensor JavaXmlSensor [java]<br>INFO: Sensor JavaXmlSensor [java] (<span class="hljs-keyword">done</span>) | time=4ms<br>INFO: Sensor HTML [web]<br>INFO: Sensor HTML [web] (<span class="hljs-keyword">done</span>) | time=11ms<br>INFO: ------------- Run sensors on project<br>INFO: Sensor Zero Coverage Sensor<br>INFO: Sensor Zero Coverage Sensor (<span class="hljs-keyword">done</span>) | time=9ms<br>INFO: 1 file had no CPD blocks<br>INFO: Calculating CPD <span class="hljs-keyword">for</span> 0 files<br>INFO: CPD calculation finished<br>INFO: Analysis report generated <span class="hljs-keyword">in</span> 99ms, dir size=72 KB<br>INFO: Analysis report compressed <span class="hljs-keyword">in</span> 15ms, zip size=10 KB<br>INFO: Analysis report uploaded <span class="hljs-keyword">in</span> 32ms<br>INFO: ANALYSIS SUCCESSFUL, you can browse http://10.0.0.108:9000/dashboard?id=linux-web1<br>INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report<br>INFO: More about the report processing at http://10.0.0.108:9000/api/ce/task?id=AXkykAQUruykkeP0Ih2x<br>INFO: Analysis total time: 3.393 s<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION SUCCESS<br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: 4.538s<br>INFO: Final Memory: 13M/60M<br>INFO: ------------------------------------------------------------------------<br>[linux-web1-develop] $ /bin/sh -xe /tmp/jenkins1117300433158617591.sh<br>+ <span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-develop<br>+ tar czvf myapp.tar.gz ./app ./index.html ./<span class="hljs-built_in">source</span><br>./app/<br>./app/index.html<br>./index.html<br>./<span class="hljs-built_in">source</span>/<br>./<span class="hljs-built_in">source</span>/linux.py<br>./<span class="hljs-built_in">source</span>/sonar-project.properties<br>+ scp myapp.tar.gz www@10.0.0.105:/data/tomcat/tomcat_appdir/<br>+ ssh www@10.0.0.105 /etc/init.d/tomcat stop<br>正在判断服务状态，请稍等3秒钟！<br>3<br>2<br>1<br>Tomcat运行中，1秒后关闭！<br>1<br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br>3<br>2<br>1<br>Tomcat 已经关闭完成！<br>3<br>2<br>1<br>+ ssh www@10.0.0.105 <span class="hljs-built_in">cd</span> /data/tomcat/tomcat_appdir &amp;&amp; rm -rf /data/tomcat/tomcat_webapps/myapp/* &amp;&amp; tar xvf myapp.tar.gz -C /data/tomcat/tomcat_webapps/myapp/<br>./app/<br>./app/index.html<br>./index.html<br>./<span class="hljs-built_in">source</span>/<br>./<span class="hljs-built_in">source</span>/linux.py<br>./<span class="hljs-built_in">source</span>/sonar-project.properties<br>+ ssh www@10.0.0.105 /etc/init.d/tomcat start<br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为7397<br>Finished: SUCCESS<br></code></pre></td></tr></table></figure>

<h5 id="5-5-3-3-6-查看项目的构建历史"><a href="#5-5-3-3-6-查看项目的构建历史" class="headerlink" title="5.5.3.3.6 查看项目的构建历史"></a>5.5.3.3.6 查看项目的构建历史</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-154.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-5-4-步骤总结"><a href="#5-5-4-步骤总结" class="headerlink" title="5.5.4 步骤总结"></a>5.5.4 步骤总结</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#Jenkinsshell基本实现代码扫描</span><br><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-web1-develop &amp;&amp;/usr/<span class="hljs-built_in">local</span>/sonar-scanner/bin/sonar-scanner<br><br><span class="hljs-comment">#Jenkins插件实现代码扫描</span><br>1.添加sonarqube server地址<br>2.配置sonar-scanner的扫描器<br>    jenkins安装sonar-scanner<br>    调用服务器的sonar-scanner<br>3.进行扫描配置<br>    <span class="hljs-comment"># Required metadata</span><br>    sonar.projectKey=linux-web1<br>    sonar.projectName=linux-web1<br>    sonar.projectVersion=v0.1.2<br><br>    <span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>    sonar.sources=<span class="hljs-built_in">source</span><br><br>    <span class="hljs-comment"># Language</span><br>    sonar.language=py<br><br>    <span class="hljs-comment"># Encoding of the source files</span><br>    sonar.sourceEncoding=UTF-8<br></code></pre></td></tr></table></figure>



<h1 id="六、Jenkins继承Maven项目"><a href="#六、Jenkins继承Maven项目" class="headerlink" title="六、Jenkins继承Maven项目"></a>六、Jenkins继承Maven项目</h1><h2 id="6-1-java项目部署概述"><a href="#6-1-java项目部署概述" class="headerlink" title="6.1 java项目部署概述"></a>6.1 java项目部署概述</h2><h3 id="6-1-1-什么使java项目"><a href="#6-1-1-什么使java项目" class="headerlink" title="6.1.1 什么使java项目"></a>6.1.1 什么使java项目</h3><p>简单来说就是使用java编写的代码，我们将其称为java项目</p>
<h3 id="6-1-2-为什么java项目需要使用Maven编译"><a href="#6-1-2-为什么java项目需要使用Maven编译" class="headerlink" title="6.1.2 为什么java项目需要使用Maven编译"></a>6.1.2 为什么java项目需要使用Maven编译</h3><p>由于java编写的代码无法直接在服务器上运行，需要maven工具进行打包</p>
<p>简单理解：java源代码就像汽车的一堆散件，必须组装才是一辆完整的汽车。这里的组装汽车可以理解为使maven编译的过程</p>
<h3 id="6-1-3-手动实现java项目构建"><a href="#6-1-3-手动实现java项目构建" class="headerlink" title="6.1.3 手动实现java项目构建"></a>6.1.3 手动实现java项目构建</h3><p>首先对java项目不熟悉，其次要实现自动化发布代码，必须会手动。</p>
<p>一个完整的发布流程：拿到源码 –&gt; 然后提交到gitlab –&gt; 使用mvn手动构建 –&gt; 最后推送war至tomcat发布</p>
<h3 id="6-1-4-手动实现java项目架构图"><a href="#6-1-4-手动实现java项目架构图" class="headerlink" title="6.1.4 手动实现java项目架构图"></a>6.1.4 手动实现java项目架构图</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another151.png" srcset="/blog/img/loading.gif"></p>
<h2 id="6-2-java项目手动发布"><a href="#6-2-java项目手动发布" class="headerlink" title="6.2 java项目手动发布"></a>6.2 java项目手动发布</h2><h3 id="6-2-1-搭建nginx-tomcat集群架构"><a href="#6-2-1-搭建nginx-tomcat集群架构" class="headerlink" title="6.2.1 搭建nginx+tomcat集群架构"></a>6.2.1 搭建nginx+tomcat集群架构</h3><h4 id="6-2-1-1-安装nginx"><a href="#6-2-1-1-安装nginx" class="headerlink" title="6.2.1.1 安装nginx"></a>6.2.1.1 安装nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.103安装nginx，事项反向代理负载均衡至tomcat服务器10.0.0.105 10.0.0.106 10.0.0.107</span><br><span class="hljs-comment">#安装过程略</span><br><span class="hljs-comment">#配置文件</span><br>vim proxy_java.com.conf<br>upstream java &#123;<br>    server 10.0.0.105:8080;<br>    server 10.0.0.106:8080;<br>    server 10.0.0.107:8080;<br>&#125;<br><br>server &#123;<br>    listen 80;<br>    server_name java.rlin.com;<br>    location / &#123;<br>        proxy_pass http://java;<br>        proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">#重启nginx</span><br></code></pre></td></tr></table></figure>

<h4 id="6-2-1-2-安装tomcat"><a href="#6-2-1-2-安装tomcat" class="headerlink" title="6.2.1.2 安装tomcat"></a>6.2.1.2 安装tomcat</h4><p>10.0.0.105 10.0.0.106 10.0.0.107 安装tomcat，安装过程略，并开启tomcat</p>
<h4 id="6-2-1-3-安装数据库和redis"><a href="#6-2-1-3-安装数据库和redis" class="headerlink" title="6.2.1.3 安装数据库和redis"></a>6.2.1.3 安装数据库和redis</h4><p>10.0.0.108 安装数据库和redis</p>
<h4 id="6-2-1-4-访问nginx检查集群是否布置成功"><a href="#6-2-1-4-访问nginx检查集群是否布置成功" class="headerlink" title="6.2.1.4 访问nginx检查集群是否布置成功"></a>6.2.1.4 访问nginx检查集群是否布置成功</h4><h3 id="6-2-2-开发人员java源代码至gitlab仓库"><a href="#6-2-2-开发人员java源代码至gitlab仓库" class="headerlink" title="6.2.2 开发人员java源代码至gitlab仓库"></a>6.2.2 开发人员java源代码至gitlab仓库</h3><h4 id="6-2-2-1-在gitlab创建项目仓库"><a href="#6-2-2-1-在gitlab创建项目仓库" class="headerlink" title="6.2.2.1 在gitlab创建项目仓库"></a>6.2.2.1 在gitlab创建项目仓库</h4><h4 id="6-2-2-2-推送java代码推送到gitlab"><a href="#6-2-2-2-推送java代码推送到gitlab" class="headerlink" title="6.2.2.2 推送java代码推送到gitlab"></a>6.2.2.2 推送java代码推送到gitlab</h4><p>java的代码下载网址：<a target="_blank" rel="noopener" href="https://gitee.com/lupan/hello-world-web">https://gitee.com/lupan/hello-world-web</a></p>
<h3 id="6-2-3-手动获取java源代码，然后使用maven进行编译"><a href="#6-2-3-手动获取java源代码，然后使用maven进行编译" class="headerlink" title="6.2.3 手动获取java源代码，然后使用maven进行编译"></a>6.2.3 手动获取java源代码，然后使用maven进行编译</h3><h4 id="6-2-3-1-由于maven编译工具需要依赖java，所以需要先安装jdk"><a href="#6-2-3-1-由于maven编译工具需要依赖java，所以需要先安装jdk" class="headerlink" title="6.2.3.1 由于maven编译工具需要依赖java，所以需要先安装jdk"></a>6.2.3.1 由于maven编译工具需要依赖java，所以需要先安装jdk</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment">#下载jdk</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># tar xvf jdk-8u192-linux-x64.tar.gz</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/jdk1.8.0_192/ /usr/local/jdk</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/jdk/bin/java /usr/bin/ #java 命令软连接</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$JAVA_HOME</span>/jre/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> CLASSPATH=.<span class="hljs-variable">$CLASSPATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/lib:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># source /etc/profile</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_192&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_192-b12)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.192-b12, mixed mode)<br></code></pre></td></tr></table></figure>

<h4 id="6-2-3-2-安装maven编译打包工具"><a href="#6-2-3-2-安装maven编译打包工具" class="headerlink" title="6.2.3.2 安装maven编译打包工具"></a>6.2.3.2 安装maven编译打包工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装maven方法一：</span><br>yum install maven -y 或 apt install maven -y<br><br><span class="hljs-comment">#安装maven方法二：</span><br><span class="hljs-comment">#此方法用于安装高版本的maven</span><br><span class="hljs-comment">#1.下载maven，到清华源</span><br>root@jenkins-master:~<span class="hljs-comment"># cd /usr/local/src</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># wget https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz</span><br><br><span class="hljs-comment">#2.安装maven</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># tar xf apache-maven-3.6.3-bin.tar.gz</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># ln -sv /usr/local/src/apache-maven-3.6.3/ /usr/local/maven</span><br><span class="hljs-string">&#x27;/usr/local/maven&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/src/apache-maven-3.6.3/&#x27;</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># /usr/local/maven/b</span><br>bin/  boot/ <br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># /usr/local/maven/bin/mvn -v</span><br>Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)<br>Maven home: /usr/<span class="hljs-built_in">local</span>/maven<br>Java version: 1.8.0_192, vendor: Oracle Corporation, runtime: /usr/<span class="hljs-built_in">local</span>/src/jdk1.8.0_192/jre<br>Default locale: en_US, platform encoding: UTF-8<br>OS name: <span class="hljs-string">&quot;linux&quot;</span>, version: <span class="hljs-string">&quot;4.15.0-55-generic&quot;</span>, arch: <span class="hljs-string">&quot;amd64&quot;</span>, family: <span class="hljs-string">&quot;unix&quot;</span><br><br><span class="hljs-comment">#配置环境变量</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-built_in">export</span> HISTTIMEFORMAT=<span class="hljs-string">&quot;%F %T `whoami` &quot;</span><br><span class="hljs-built_in">export</span> <span class="hljs-built_in">export</span> LANG=<span class="hljs-string">&quot;en_US.utf-8&quot;</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> MAVEN_HOME=/usr/<span class="hljs-built_in">local</span>/maven<br><span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/dt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$JAVA_HOME</span>/jre/bin:<span class="hljs-variable">$MAVEN_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src<span class="hljs-comment"># source /etc/profile</span><br></code></pre></td></tr></table></figure>

<h4 id="6-2-3-3-获取java代码，然后上传到gitlab里"><a href="#6-2-3-3-获取java代码，然后上传到gitlab里" class="headerlink" title="6.2.3.3 获取java代码，然后上传到gitlab里"></a>6.2.3.3 获取java代码，然后上传到gitlab里</h4><h5 id="6-2-3-3-1-创建项目"><a href="#6-2-3-3-1-创建项目" class="headerlink" title="6.2.3.3.1 创建项目"></a>6.2.3.3.1 创建项目</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another152.png" srcset="/blog/img/loading.gif"></p>
<p>6.2.3.3.2 在网上获取java代码，并将java代码上传到gitlab里</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注意：所有代码不得用作商业</span><br><span class="hljs-comment">#下载git代码</span><br>git <span class="hljs-built_in">clone</span> https://gitee.com/lupan/hello-world-web.git<br><span class="hljs-comment">#将java代码上传到gitlab里</span><br>root@web3:~<span class="hljs-comment"># mkdir /opt/source -p</span><br>root@web3:~<span class="hljs-comment"># cd /opt/source</span><br>root@web3:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># git clone http://10.0.0.101/linux/linux-java-web1.git</span><br>root@web3:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># cd linux-java-web1</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># mv /root/hello-world-web/* .</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git add .</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git commit -m &quot;Initial commit&quot;</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git push -u origin master</span><br></code></pre></td></tr></table></figure>

<h5 id="6-2-3-3-3-gitlab项目图"><a href="#6-2-3-3-3-gitlab项目图" class="headerlink" title="6.2.3.3.3 gitlab项目图"></a>6.2.3.3.3 gitlab项目图</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another153.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another154.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-2-3-3-拉去gtlab代码，然后手动编译成war包"><a href="#6-2-3-3-拉去gtlab代码，然后手动编译成war包" class="headerlink" title="6.2.3.3 拉去gtlab代码，然后手动编译成war包"></a>6.2.3.3 拉去gtlab代码，然后手动编译成war包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># mkdir -p /data/git/</span><br>root@jenkins-master:~<span class="hljs-comment"># cd /data/git/</span><br>root@jenkins-master:/data/git<span class="hljs-comment"># git clone https://gitee.com/gxj_gitee/maven-test202004020.git</span><br>Cloning into <span class="hljs-string">&#x27;linux-java-web1&#x27;</span>...<br>Username <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span>: rlin<br>Password <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://rlin@10.0.0.101&#x27;</span>: <br>remote: Enumerating objects: 40, <span class="hljs-keyword">done</span>.<br>remote: Counting objects: 100% (40/40), <span class="hljs-keyword">done</span>.<br>remote: Compressing objects: 100% (25/25), <span class="hljs-keyword">done</span>.<br>remote: Total 40 (delta 3), reused 0 (delta 0)<br>Unpacking objects: 100% (40/40), done.git <span class="hljs-built_in">clone</span> http://10.0.0.101/linux/linux-java-web1.git<br>root@jenkins-master:/data/git<span class="hljs-comment"># cd linux-java-web1</span><br><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># mvn package -Dmaven.test.skip=true #跳过测试用例</span><br><span class="hljs-comment">#war包一般都在：项目名/target/项目名.war</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another155.png" srcset="/blog/img/loading.gif" alt="下载jar包"></p>
<p><strong>注意：java项目在编译过程中，需要安装很多依赖，依赖都会上maven官方下载，如果项目依赖的jar包较多，网络较差，可能需要很久的时间</strong></p>
<p><strong>建议将下载的地址调整为阿里云，具体操作如下：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#方法一：</span><br><span class="hljs-comment">#查看maven安装位置下的/conf/settings.xml</span><br><span class="hljs-comment">#修改setttings.xml</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># cd /usr/local/src/apache-maven-3.6.3/conf/</span><br>root@jenkins-master:/usr/<span class="hljs-built_in">local</span>/src/apache-maven-3.6.3/conf<span class="hljs-comment"># vim settings.xml</span><br><span class="hljs-comment">#在159行的上面添加如下内容</span><br> &lt;mirrors&gt;<br>      &lt;mirror&gt;<br>         &lt;id&gt;nexus-aliyun&lt;/id&gt;<br>         &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;<br>         &lt;name&gt;Nexus aliyun&lt;/name&gt;<br>         &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;<br>      &lt;/mirror&gt; <br> &lt;/mirrors&gt;<br><br><span class="hljs-comment">#方法二：</span><br><span class="hljs-comment">#在项目的pom.xml里添加上面的内容</span><br></code></pre></td></tr></table></figure>

<h3 id="6-2-4-将编译后的war包部署至tomcat集群"><a href="#6-2-4-将编译后的war包部署至tomcat集群" class="headerlink" title="6.2.4 将编译后的war包部署至tomcat集群"></a>6.2.4 将编译后的war包部署至tomcat集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#方法一：</span><br><span class="hljs-comment">#如使用之前的tomcat环境，要清空tomcat_webapps/myapp/里面的内容</span><br><span class="hljs-comment">#注意：这里直接在/myapp里放.war包需要在tomcat的server.xml里的unpackWARs=&quot;false&quot;改为true（默认就是true）</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &#123;105..107&#125;;<span class="hljs-keyword">do</span> scp 完整的项目目录/target/项目名.war www@10.0.0.<span class="hljs-variable">$i</span>:/data/tomcat/tomcat_webapps/myapp/ROOT.war;<span class="hljs-keyword">done</span><br>Q:为什么传送到tomcat服务器里的war包要交ROOT.war？<br>A：因为tomcat一重启就访问该war包<br><br><span class="hljs-comment">#如使用apt或yum安装的tomcat就要将tomcat/webapps/下的ROOT包删除</span><br><br><span class="hljs-comment">#所有服务器重启tomcat</span><br><span class="hljs-comment">#方法二：</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># scp maven-Demo20200420.war www@10.0.0.105:/data/tomcat/tomcat_appdir/ROOT.war （后面的war包需要跟着规则改名）</span><br><br>root@web1:~<span class="hljs-comment"># cd /data/tomcat/tomcat_appdir/</span><br>root@web1:/data/tomcat/tomcat_appdir<span class="hljs-comment"># unzip ROOT.war -d /data/tomcat/tomcat_webdir/java-root/ （后面解压的包需要跟着规则改名）</span><br>root@web1:/data/tomcat/tomcat_appdir<span class="hljs-comment"># ln -sv /data/tomcat/tomcat_webdir/java-root /data/tomcat/tomcat_webapps/myapp</span><br><span class="hljs-comment">#所有服务器重启tomcat</span><br></code></pre></td></tr></table></figure>

<h3 id="6-2-5-最后通过浏览器访问测试，检测项目是否部署成功"><a href="#6-2-5-最后通过浏览器访问测试，检测项目是否部署成功" class="headerlink" title="6.2.5 最后通过浏览器访问测试，检测项目是否部署成功"></a>6.2.5 最后通过浏览器访问测试，检测项目是否部署成功</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another156.png" srcset="/blog/img/loading.gif"></p>
<h2 id="6-3-java项目自动发布"><a href="#6-3-java项目自动发布" class="headerlink" title="6.3 java项目自动发布"></a>6.3 java项目自动发布</h2><p>Jenkins实现Maven自动发布部署流程图</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another157.png" srcset="/blog/img/loading.gif"></p>
<h3 id="6-3-1-Jenkins安装maven插件，使其支持maven支持maven项目创建"><a href="#6-3-1-Jenkins安装maven插件，使其支持maven支持maven项目创建" class="headerlink" title="6.3.1 Jenkins安装maven插件，使其支持maven支持maven项目创建"></a>6.3.1 Jenkins安装maven插件，使其支持maven支持maven项目创建</h3><p>安装Maven Integration 插件，这样才能使用Jenkins构建一个maven的项目</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another158.png" srcset="/blog/img/loading.gif"></p>
<h3 id="6-3-2-Jenkins配置JDK路径和maven路径"><a href="#6-3-2-Jenkins配置JDK路径和maven路径" class="headerlink" title="6.3.2 Jenkins配置JDK路径和maven路径"></a>6.3.2 Jenkins配置JDK路径和maven路径</h3><p>JDK路径</p>
<p>Jenkins–&gt;系统管理–&gt;全局工具配置–&gt;JDK（不用自动安装）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another159.png" srcset="/blog/img/loading.gif"></p>
<p>maven</p>
<p>Jenkins–&gt;系统管理–&gt;全局工具配置–&gt;maven（不用自动安装）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another160.png" srcset="/blog/img/loading.gif"></p>
<h3 id="6-3-3-Jenkins创建maven项目，然后进行构建"><a href="#6-3-3-Jenkins创建maven项目，然后进行构建" class="headerlink" title="6.3.3 Jenkins创建maven项目，然后进行构建"></a>6.3.3 Jenkins创建maven项目，然后进行构建</h3><h4 id="6-3-3-1-创建一个项目，名字叫Linux-hello-world，风格选择构建一个maven项目"><a href="#6-3-3-1-创建一个项目，名字叫Linux-hello-world，风格选择构建一个maven项目" class="headerlink" title="6.3.3.1 创建一个项目，名字叫Linux-hello-world，风格选择构建一个maven项目"></a>6.3.3.1 创建一个项目，名字叫Linux-hello-world，风格选择构建一个maven项目</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another161.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-3-3-1-项目配置"><a href="#6-3-3-1-项目配置" class="headerlink" title="6.3.3.1 项目配置"></a>6.3.3.1 项目配置</h4><p>丢弃就的构建</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another162.png" srcset="/blog/img/loading.gif"></p>
<p>源码管理</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another163.png" srcset="/blog/img/loading.gif"></p>
<p>构建环境</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another166.png" srcset="/blog/img/loading.gif"></p>
<p>Build</p>
<p>构建参数：package -Dmaven.test.skip=true</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another167.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-3-3-2-立即构建"><a href="#6-3-3-2-立即构建" class="headerlink" title="6.3.3.2 立即构建"></a>6.3.3.2 立即构建</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another168.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#控制台输出</span><br>Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace/linux-hello-world<br>[WS-CLEANUP] Deleting project workspace...<br>[WS-CLEANUP] Deferred wipeout is used...<br>[WS-CLEANUP] Done<br>The recommended git tool is: NONE<br>using credential <span class="hljs-number">73</span>b70b5b-b09c-<span class="hljs-number">46</span>fd-<span class="hljs-number">8790</span>-<span class="hljs-number">3</span>a0eebf2b12c<br>Cloning the remote Git repository<br>Cloning repository git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git<br> &gt; git init <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace/linux-hello-world <span class="hljs-comment"># timeout=10</span><br>Fetching upstream changes from git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git<br> &gt; git --version <span class="hljs-comment"># timeout=10</span><br> &gt; git --version <span class="hljs-comment"># &#x27;git version 2.17.1&#x27;</span><br>using GIT_SSH to set credentials <br> &gt; git fetch --tags --progress -- git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux<span class="hljs-regexp">/linux-java-web1.git +refs/</span>heads<span class="hljs-regexp">/*:refs/</span>remotes<span class="hljs-regexp">/origin/</span>* <span class="hljs-comment"># timeout=10</span><br> &gt; git config remote.origin.url git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git <span class="hljs-comment"># timeout=10</span><br> &gt; git config --add remote.origin.fetch +refs<span class="hljs-regexp">/heads/</span>*:refs<span class="hljs-regexp">/remotes/</span>origin/* <span class="hljs-comment"># timeout=10</span><br>Avoid second fetch<br> &gt; git rev-parse refs<span class="hljs-regexp">/remotes/</span>origin/master^&#123;commit&#125; <span class="hljs-comment"># timeout=10</span><br>Checking out Revision <span class="hljs-number">1</span>acbfb5592e4f6d88319852f1cc75555f16c823c (refs<span class="hljs-regexp">/remotes/</span>origin/master)<br> &gt; git config core.sparsecheckout <span class="hljs-comment"># timeout=10</span><br> &gt; git checkout -f <span class="hljs-number">1</span>acbfb5592e4f6d88319852f1cc75555f16c823c <span class="hljs-comment"># timeout=10</span><br>Commit message: <span class="hljs-string">&quot;v4&quot;</span><br> &gt; git rev-list --no-walk <span class="hljs-number">1</span>acbfb5592e4f6d88319852f1cc75555f16c823c <span class="hljs-comment"># timeout=10</span><br>Parsing POMs<br>Established TCP socket on <span class="hljs-number">33026</span><br>[linux-hello-world] $ <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/jdk/</span>bin<span class="hljs-regexp">/java -cp /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/maven35-agent-1.13.jar:/u</span>sr<span class="hljs-regexp">/local/m</span>aven<span class="hljs-regexp">/boot/</span>plexus-classworlds-<span class="hljs-number">2.6</span>.<span class="hljs-number">0</span>.jar:<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/maven/</span>conf<span class="hljs-regexp">/logging jenkins.maven3.agent.Maven35Main /u</span>sr<span class="hljs-regexp">/local/m</span>aven <span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/jenkins/</span>war<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/remoting-4.2.1.jar /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/maven35-interceptor-1.13.jar /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib/maven3-interceptor-commons-<span class="hljs-number">1.13</span>.jar <span class="hljs-number">33026</span><br>&lt;===[JENKINS REMOTING CAPACITY]===&gt;channel started<br>Executing Maven:  -B -f <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>pom.xml package -Dmaven.test.skip=true<br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] <br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] Some problems were encountered <span class="hljs-keyword">while</span> building the effective settings<br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] Unrecognised tag: <span class="hljs-string">&#x27;mirrors&#x27;</span> (position: START_TAG seen ...&lt;<span class="hljs-regexp">/mirror&gt;\r\n     --&gt;\r\n\r\n&lt;mirrors&gt;... @160:10)  @ /u</span>sr<span class="hljs-regexp">/local/</span>src<span class="hljs-regexp">/apache-maven-3.6.3/</span>conf/settings.xml, line <span class="hljs-number">160</span>, column <span class="hljs-number">10</span><br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] <br>[INFO] Scanning <span class="hljs-keyword">for</span> projects...<br>[INFO] <br>[INFO] --------------------&lt; com.dzxy:maven-Demo20200420 &gt;---------------------<br>[INFO] Building maven-Demo20200420 Maven Webapp <span class="hljs-number">1.0</span>-SNAPSHOT<br>[INFO] --------------------------------[ war ]---------------------------------<br>[INFO] <br>[INFO] --- maven-resources-plugin:<span class="hljs-number">3.0</span>.<span class="hljs-number">2</span>:resources (default-resources) @ maven-Demo20200420 ---<br>[INFO] Using <span class="hljs-string">&#x27;UTF-8&#x27;</span> encoding to copy filtered resources.<br>[INFO] skip non existing resourceDirectory <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>src<span class="hljs-regexp">/main/</span>resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:<span class="hljs-number">3.8</span>.<span class="hljs-number">0</span>:compile (default-compile) @ maven-Demo20200420 ---<br>[INFO] No sources to compile<br>[INFO] <br>[INFO] --- maven-resources-plugin:<span class="hljs-number">3.0</span>.<span class="hljs-number">2</span>:testResources (default-testResources) @ maven-Demo20200420 ---<br>[INFO] Not copying test resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:<span class="hljs-number">3.8</span>.<span class="hljs-number">0</span>:testCompile (default-testCompile) @ maven-Demo20200420 ---<br>[INFO] Not compiling test sources<br>[INFO] <br>[INFO] --- maven-surefire-plugin:<span class="hljs-number">2.22</span>.<span class="hljs-number">1</span>:test (default-test) @ maven-Demo20200420 ---<br>[INFO] Tests are skipped.<br>[INFO] <br>[INFO] --- maven-war-plugin:<span class="hljs-number">3.2</span>.<span class="hljs-number">2</span>:war (default-war) @ maven-Demo20200420 ---<br>[INFO] Packaging webapp<br>[INFO] Assembling webapp [maven-Demo20200420] <span class="hljs-keyword">in</span> [<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target/maven-Demo20200420]<br>[INFO] Processing war project<br>[INFO] Copying webapp resources [<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>src<span class="hljs-regexp">/main/</span>webapp]<br>[INFO] Webapp assembled <span class="hljs-keyword">in</span> [<span class="hljs-number">10</span> msecs]<br>[INFO] Building war: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target/maven-Demo20200420.war<br>[INFO] ------------------------------------------------------------------------<br>[INFO] BUILD SUCCESS<br>[INFO] ------------------------------------------------------------------------<br>[INFO] Total time:  <span class="hljs-number">2.055</span> s<br>[INFO] Finished at: <span class="hljs-number">2021</span>-<span class="hljs-number">05</span>-<span class="hljs-number">29</span>T16:<span class="hljs-number">40</span>:<span class="hljs-number">34</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span><br>[INFO] ------------------------------------------------------------------------<br>Waiting <span class="hljs-keyword">for</span> Jenkins to finish collecting data<br>[JENKINS] Archiving <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>pom.xml to com.dzxy<span class="hljs-regexp">/maven-Demo20200420/</span><span class="hljs-number">1.0</span>-SNAPSHOT/maven-Demo20200420-<span class="hljs-number">1.0</span>-SNAPSHOT.pom<br>[JENKINS] Archiving <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target<span class="hljs-regexp">/maven-Demo20200420.war to com.dzxy/m</span>aven-Demo20200420<span class="hljs-regexp">/1.0-SNAPSHOT/m</span>aven-Demo20200420-<span class="hljs-number">1.0</span>-SNAPSHOT.war<br>channel stopped<br>Finished: SUCCESS<br></code></pre></td></tr></table></figure>

<h3 id="6-3-4-编写自动上线脚本推送至web集群，最后通过浏览器访问（建议现在Jenkins里把脚本写好在服务器里写shell脚本）"><a href="#6-3-4-编写自动上线脚本推送至web集群，最后通过浏览器访问（建议现在Jenkins里把脚本写好在服务器里写shell脚本）" class="headerlink" title="6.3.4 编写自动上线脚本推送至web集群，最后通过浏览器访问（建议现在Jenkins里把脚本写好在服务器里写shell脚本）"></a>6.3.4 编写自动上线脚本推送至web集群，最后通过浏览器访问（建议现在Jenkins里把脚本写好在服务器里写shell脚本）</h3><h4 id="6-3-4-1-编写上线脚本"><a href="#6-3-4-1-编写上线脚本" class="headerlink" title="6.3.4.1 编写上线脚本"></a>6.3.4.1 编写上线脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@jenkins-master:~# cd /data/scripts/<br>root@jenkins-master:/data/scripts# vim linux-java-web.sh<br><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><span class="hljs-meta">#</span><span class="bash">进入目录，将内容进项打包</span><br>cd /var/lib/jenkins/workspace/linux-hello-world/<br>unzip target/*.war -d /var/lib/jenkins/workspace/linux-hello-world/java-code<br>zip -r java-code.zip java-code/<br><span class="hljs-meta">#</span><span class="bash">通过scp拷贝到web集群组</span><br>scp java-code.zip www@10.0.0.105:/data/tomcat/tomcat_appdir/java-code.zip<br><span class="hljs-meta">#</span><span class="bash">关闭tomcat</span><br>ssh www@10.0.0.105 &quot;/etc/init.d/tomcat stop&quot;<br><span class="hljs-meta">#</span><span class="bash">删除旧的项目，并将新的包解压到tomcat里</span><br>ssh www@10.0.0.105 &quot;rm -rf /data/tomcat/tomcat_webdir/java-code &amp;&amp; unzip /data/tomcat/tomcat_appdir/java-code.zip  -d /data/tomcat/tomcat_webdir/ &amp;&amp; rm -rf  /data/tomcat/tomcat_webapps/myapp &amp;&amp; ln -sv  /data/tomcat/tomcat_webdir/java-code /data/tomcat/tomcat_webapps/myapp&quot;<br><span class="hljs-meta">#</span><span class="bash">打开tomcat</span><br>ssh www@10.0.0.105 &quot;/etc/init.d/tomcat start&quot;<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another169.png" srcset="/blog/img/loading.gif"></p>
<p>注意：</p>
<ol>
<li>如果安装的tomcat，并且没有修改过tomcat的conf/server.xml里的 ” &lt;Host name=”localhost”  appBase=”/data/tomcat/webapps”<pre><code>        unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot; “ 这一行的话可以直接将编译好的war包直接复制到webapps文件夹下，并改名为ROOT.war，最后直接重启tomcat即可
</code></pre>
</li>
<li>如果安装的tomcat，将修改过tomcat的conf/server.xml里的 ” &lt;Host name=”localhost”  appBase=”/data/tomcat/webapps”<pre><code>        unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot; “  修改为 ” &lt;Host name=&quot;localhost&quot;  appBase=&quot;/data/tomcat/tomcat_webapps&quot;
        unpackWARs=&quot;false&quot; autoDeploy=&quot;false&quot; “ 的话就要将war包解压后做软连接到/data/tomcat/tomcat_webapps文件夹里（即上面的shell脚本类似），最后直接重启tomcat即可
</code></pre>
</li>
</ol>
<h4 id="6-3-4-2-执行构建"><a href="#6-3-4-2-执行构建" class="headerlink" title="6.3.4.2 执行构建"></a>6.3.4.2 执行构建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs bash">Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace /var/lib/jenkins/workspace/linux-hello-world<br>[WS-CLEANUP] Deleting project workspace...<br>[WS-CLEANUP] Deferred wipeout is used...<br>[WS-CLEANUP] Done<br>The recommended git tool is: NONE<br>using credential 73b70b5b-b09c-46fd-8790-3a0eebf2b12c<br>Cloning the remote Git repository<br>Cloning repository git@10.0.0.101:linux/linux-java-web1.git<br> &gt; git init /var/lib/jenkins/workspace/linux-hello-world <span class="hljs-comment"># timeout=10</span><br>Fetching upstream changes from git@10.0.0.101:linux/linux-java-web1.git<br> &gt; git --version <span class="hljs-comment"># timeout=10</span><br> &gt; git --version <span class="hljs-comment"># &#x27;git version 2.17.1&#x27;</span><br>using GIT_SSH to <span class="hljs-built_in">set</span> credentials <br> &gt; git fetch --tags --progress -- git@10.0.0.101:linux/linux-java-web1.git +refs/heads/*:refs/remotes/origin/* <span class="hljs-comment"># timeout=10</span><br> &gt; git config remote.origin.url git@10.0.0.101:linux/linux-java-web1.git <span class="hljs-comment"># timeout=10</span><br> &gt; git config --add remote.origin.fetch +refs/heads/*:refs/remotes/origin/* <span class="hljs-comment"># timeout=10</span><br>Avoid second fetch<br> &gt; git rev-parse refs/remotes/origin/master^&#123;commit&#125; <span class="hljs-comment"># timeout=10</span><br>Checking out Revision 1acbfb5592e4f6d88319852f1cc75555f16c823c (refs/remotes/origin/master)<br> &gt; git config core.sparsecheckout <span class="hljs-comment"># timeout=10</span><br> &gt; git checkout -f 1acbfb5592e4f6d88319852f1cc75555f16c823c <span class="hljs-comment"># timeout=10</span><br>Commit message: <span class="hljs-string">&quot;v4&quot;</span><br> &gt; git rev-list --no-walk 1acbfb5592e4f6d88319852f1cc75555f16c823c <span class="hljs-comment"># timeout=10</span><br>Parsing POMs<br>Established TCP socket on 29786<br>[linux-hello-world] $ /usr/<span class="hljs-built_in">local</span>/jdk/bin/java -cp /var/lib/jenkins/plugins/maven-plugin/WEB-INF/lib/maven35-agent-1.13.jar:/usr/<span class="hljs-built_in">local</span>/maven/boot/plexus-classworlds-2.6.0.jar:/usr/<span class="hljs-built_in">local</span>/maven/conf/logging jenkins.maven3.agent.Maven35Main /usr/<span class="hljs-built_in">local</span>/maven /var/cache/jenkins/war/WEB-INF/lib/remoting-4.2.1.jar /var/lib/jenkins/plugins/maven-plugin/WEB-INF/lib/maven35-interceptor-1.13.jar /var/lib/jenkins/plugins/maven-plugin/WEB-INF/lib/maven3-interceptor-commons-1.13.jar 29786<br>&lt;===[JENKINS REMOTING CAPACITY]===&gt;channel started<br>Executing Maven:  -B -f /var/lib/jenkins/workspace/linux-hello-world/pom.xml package -Dmaven.test.skip=<span class="hljs-literal">true</span><br>[[1;33mWARNING[m] <br>[[1;33mWARNING[m] Some problems were encountered <span class="hljs-keyword">while</span> building the effective settings<br>[[1;33mWARNING[m] Unrecognised tag: <span class="hljs-string">&#x27;mirrors&#x27;</span> (position: START_TAG seen ...&lt;/mirror&gt;\r\n     --&gt;\r\n\r\n&lt;mirrors&gt;... @160:10)  @ /usr/<span class="hljs-built_in">local</span>/src/apache-maven-3.6.3/conf/settings.xml, line 160, column 10<br>[[1;33mWARNING[m] <br>[INFO] Scanning <span class="hljs-keyword">for</span> projects...<br>[INFO] <br>[INFO] --------------------&lt; com.dzxy:maven-Demo20200420 &gt;---------------------<br>[INFO] Building maven-Demo20200420 Maven Webapp 1.0-SNAPSHOT<br>[INFO] --------------------------------[ war ]---------------------------------<br>[INFO] <br>[INFO] --- maven-resources-plugin:3.0.2:resources (default-resources) @ maven-Demo20200420 ---<br>[INFO] Using <span class="hljs-string">&#x27;UTF-8&#x27;</span> encoding to copy filtered resources.<br>[INFO] skip non existing resourceDirectory /var/lib/jenkins/workspace/linux-hello-world/src/main/resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:3.8.0:compile (default-compile) @ maven-Demo20200420 ---<br>[INFO] No sources to compile<br>[INFO] <br>[INFO] --- maven-resources-plugin:3.0.2:testResources (default-testResources) @ maven-Demo20200420 ---<br>[INFO] Not copying <span class="hljs-built_in">test</span> resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:3.8.0:testCompile (default-testCompile) @ maven-Demo20200420 ---<br>[INFO] Not compiling <span class="hljs-built_in">test</span> sources<br>[INFO] <br>[INFO] --- maven-surefire-plugin:2.22.1:<span class="hljs-built_in">test</span> (default-test) @ maven-Demo20200420 ---<br>[INFO] Tests are skipped.<br>[INFO] <br>[INFO] --- maven-war-plugin:3.2.2:war (default-war) @ maven-Demo20200420 ---<br>[INFO] Packaging webapp<br>[INFO] Assembling webapp [maven-Demo20200420] <span class="hljs-keyword">in</span> [/var/lib/jenkins/workspace/linux-hello-world/target/maven-Demo20200420]<br>[INFO] Processing war project<br>[INFO] Copying webapp resources [/var/lib/jenkins/workspace/linux-hello-world/src/main/webapp]<br>[INFO] Webapp assembled <span class="hljs-keyword">in</span> [11 msecs]<br>[INFO] Building war: /var/lib/jenkins/workspace/linux-hello-world/target/maven-Demo20200420.war<br>[INFO] ------------------------------------------------------------------------<br>[INFO] BUILD SUCCESS<br>[INFO] ------------------------------------------------------------------------<br>[INFO] Total time:  2.062 s<br>[INFO] Finished at: 2021-05-29T16:54:38+08:00<br>[INFO] ------------------------------------------------------------------------<br>Waiting <span class="hljs-keyword">for</span> Jenkins to finish collecting data<br>[JENKINS] Archiving /var/lib/jenkins/workspace/linux-hello-world/pom.xml to com.dzxy/maven-Demo20200420/1.0-SNAPSHOT/maven-Demo20200420-1.0-SNAPSHOT.pom<br>[JENKINS] Archiving /var/lib/jenkins/workspace/linux-hello-world/target/maven-Demo20200420.war to com.dzxy/maven-Demo20200420/1.0-SNAPSHOT/maven-Demo20200420-1.0-SNAPSHOT.war<br>[linux-hello-world] $ /bin/sh -xe /tmp/jenkins4386105400150637079.sh<br>channel stopped<br>+ bash /data/scripts/linux-java-web.sh<br>Archive:  target/maven-Demo20200420.war<br>  inflating: /var/lib/jenkins/workspace/linux-hello-world/java-code/META-INF/MANIFEST.MF  <br>   creating: /var/lib/jenkins/workspace/linux-hello-world/java-code/WEB-INF/<br>   creating: /var/lib/jenkins/workspace/linux-hello-world/java-code/WEB-INF/classes/<br>  inflating: /var/lib/jenkins/workspace/linux-hello-world/java-code/index.jsp  <br>  inflating: /var/lib/jenkins/workspace/linux-hello-world/java-code/WEB-INF/web.xml  <br>  inflating: /var/lib/jenkins/workspace/linux-hello-world/java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.xml  <br>  inflating: /var/lib/jenkins/workspace/linux-hello-world/java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.properties  <br>  adding: java-code/ (stored 0%)<br>  adding: java-code/WEB-INF/ (stored 0%)<br>  adding: java-code/WEB-INF/classes/ (stored 0%)<br>  adding: java-code/WEB-INF/web.xml (deflated 24%)<br>  adding: java-code/index.jsp (deflated 19%)<br>  adding: java-code/META-INF/ (stored 0%)<br>  adding: java-code/META-INF/MANIFEST.MF (deflated 7%)<br>  adding: java-code/META-INF/maven/ (stored 0%)<br>  adding: java-code/META-INF/maven/com.dzxy/ (stored 0%)<br>  adding: java-code/META-INF/maven/com.dzxy/maven-Demo20200420/ (stored 0%)<br>  adding: java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.xml (deflated 64%)<br>  adding: java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.properties (deflated 1%)<br>正在判断服务状态，请稍等3秒钟！<br>3<br>2<br>1<br>Tomcat运行中，1秒后关闭！<br>1<br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等5秒钟！<br>3<br>2<br>1<br>Tomcat 已经关闭完成！<br>3<br>2<br>1<br>Archive:  /data/tomcat/tomcat_appdir/java-code.zip<br>   creating: /data/tomcat/tomcat_webdir/java-code/<br>   creating: /data/tomcat/tomcat_webdir/java-code/WEB-INF/<br>   creating: /data/tomcat/tomcat_webdir/java-code/WEB-INF/classes/<br>  inflating: /data/tomcat/tomcat_webdir/java-code/WEB-INF/web.xml  <br>  inflating: /data/tomcat/tomcat_webdir/java-code/index.jsp  <br>   creating: /data/tomcat/tomcat_webdir/java-code/META-INF/<br>  inflating: /data/tomcat/tomcat_webdir/java-code/META-INF/MANIFEST.MF  <br>   creating: /data/tomcat/tomcat_webdir/java-code/META-INF/maven/<br>   creating: /data/tomcat/tomcat_webdir/java-code/META-INF/maven/com.dzxy/<br>   creating: /data/tomcat/tomcat_webdir/java-code/META-INF/maven/com.dzxy/maven-Demo20200420/<br>  inflating: /data/tomcat/tomcat_webdir/java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.xml  <br>  inflating: /data/tomcat/tomcat_webdir/java-code/META-INF/maven/com.dzxy/maven-Demo20200420/pom.properties  <br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/java-code&#x27;</span><br>正在判断服务状态，请稍等！<br>请稍等3秒钟<br>3<br>2<br>1<br>Tomcat没有运行，1秒后启动！<br>1<br>Tomcat started.<br>Tomcat 已经成功启动完成,5秒后判断是否启动成功<br>5<br>4<br>3<br>2<br>1<br>Tomcat 已经成功启动1 个Tomcat进程!,PID为6434<br>Finished: SUCCESS <span class="hljs-comment">#&lt;--执行成功</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another170.png" srcset="/blog/img/loading.gif"></p>
<h3 id="6-3-5-优化部署脚本，使其支持代码质量测试"><a href="#6-3-5-优化部署脚本，使其支持代码质量测试" class="headerlink" title="6.3.5 优化部署脚本，使其支持代码质量测试"></a>6.3.5 优化部署脚本，使其支持代码质量测试</h3><h4 id="6-3-5-1-直接使用maven里的sonar进行代码质量测试"><a href="#6-3-5-1-直接使用maven里的sonar进行代码质量测试" class="headerlink" title="6.3.5.1 直接使用maven里的sonar进行代码质量测试"></a>6.3.5.1 直接使用maven里的sonar进行代码质量测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cd /data/git/linux-java-web1/</span><br><span class="hljs-comment">#方法一：</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># mvn sonar:sonar \</span><br>-Dsonar.host.username=admin \<br>-Dsonar.host.password=admin \<br>-Dsonar.host.url=http://10.0.0.108:9000<br><br><span class="hljs-comment">#方法二：</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># mvn sonar:sonar \</span><br>-Dsonar.host.url=http://10.0.0.108:9000 \<br>-Dsonar.login=bc8c43a55d1752dba0edb11cfa374b6195074125 <span class="hljs-comment">#这个为账号的token</span><br><span class="hljs-comment">#-Dsonar.java.binaries=target/sonar</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another171.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-3-5-2-使用sonar插件进项代码测试"><a href="#6-3-5-2-使用sonar插件进项代码测试" class="headerlink" title="6.3.5.2 使用sonar插件进项代码测试"></a>6.3.5.2 使用sonar插件进项代码测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@jenkins-master:~<span class="hljs-comment"># cd /data/git/linux-java-web1/</span><br><span class="hljs-comment">#方法一：</span><br><span class="hljs-comment">#只使用于项目中又target文件的java代码</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># vim sonar-project.properties</span><br><span class="hljs-comment"># Required metadata</span><br>sonar.projectKey=java-hello-world<br>sonar.projectName=java-hello-world<br>sonar.projectVersion=1.0<br><br><span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>sonar.sources=src<br><br><span class="hljs-comment"># Language</span><br>sonar.language=java<br><br><span class="hljs-comment"># Encoding of the source files</span><br>sonar.sourceEncoding=UTF-8<br><br>sonar.java.binaries=target/classes<br><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span><br><br><span class="hljs-comment">#方法二：</span><br><span class="hljs-comment">#使用于所有的java项目</span><br>root@jenkins-master:/data/git/linux-java-web1<span class="hljs-comment"># /usr/local/sonar-scanner/bin/sonar-scanner \</span><br>-Dsonar.projectKey=项目名 \<br>-Dsonar.sources=. <br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another172.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-3-5-3-重新编写脚本使其支持代码质量测试"><a href="#6-3-5-3-重新编写脚本使其支持代码质量测试" class="headerlink" title="6.3.5.3 重新编写脚本使其支持代码质量测试"></a>6.3.5.3 重新编写脚本使其支持代码质量测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#给java项目添加sonar-project.properties，并上传</span><br>root@web3:~<span class="hljs-comment"># cd /opt/source/</span><br>root@web3:/opt/<span class="hljs-built_in">source</span><span class="hljs-comment"># cd linux-java-web1/</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># ls</span><br>LICENSE  pom.xml  README.en.md  README.md  src<br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># vim sonar-project.properties</span><br><span class="hljs-comment"># Required metadata</span><br>sonar.projectKey=java-hello-world<br>sonar.projectName=java-hello-world-web1<br>sonar.projectVersion=1.0<br><br><span class="hljs-comment"># Comma-separated paths to directories with sources (required)</span><br>sonar.sources=src<br><br><span class="hljs-comment"># Language</span><br>sonar.language=java<br><br><span class="hljs-comment"># Encoding of the source files</span><br>sonar.sourceEncoding=UTF-8<br><br>sonar.java.binaries=target/classes<br><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git add .</span><br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git commit -m &quot;add sonar.properties&quot;</span><br>[master c1ed0a0] add sonar.properties<br> 1 file changed, 15 insertions(+)<br> create mode 100644 sonar-project.properties<br>root@web3:/opt/<span class="hljs-built_in">source</span>/linux-java-web1<span class="hljs-comment"># git push</span><br>Username <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://10.0.0.101&#x27;</span>: rlin<br>Password <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;http://rlin@10.0.0.101&#x27;</span>: <br>Counting objects: 3, <span class="hljs-keyword">done</span>.<br>Compressing objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>Writing objects: 100% (3/3), 517 bytes | 517.00 KiB/s, <span class="hljs-keyword">done</span>.<br>Total 3 (delta 1), reused 0 (delta 0)<br>To http://10.0.0.101/linux/linux-java-web1.git<br>   1acbfb5..c1ed0a0  master -&gt; master<br><br>root@jenkins-master:~<span class="hljs-comment"># cd /data/scripts/</span><br>root@jenkins-master:/data/scripts<span class="hljs-comment"># vim linux-java-web.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#进入目录</span><br><span class="hljs-built_in">cd</span> /var/lib/jenkins/workspace/linux-hello-world/<br><span class="hljs-comment">#扫描代码</span><br>/usr/<span class="hljs-built_in">local</span>/sonar-scanner/bin/sonar-scanner<br><span class="hljs-comment">#将代码打包</span><br>unzip target/*.war -d /var/lib/jenkins/workspace/linux-hello-world/java-code<br>zip -r java-code.zip java-code/<br><span class="hljs-comment">#通过scp拷贝到web集群组</span><br>scp java-code.zip www@10.0.0.105:/data/tomcat/tomcat_appdir/java-code.zip<br><span class="hljs-comment">#关闭tomcat</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat stop&quot;</span><br><span class="hljs-comment">#删除旧的项目，并将新的包解压到tomcat里</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;rm -rf /data/tomcat/tomcat_webdir/java-code &amp;&amp; unzip /data/tomcat/tomcat_appdir/java-code.zip  -d /data/tomcat/tomcat_webdir/ &amp;&amp; rm -rf  /data/tomcat/tomcat_webapps/myapp &amp;&amp; ln -sv  /data/tomcat/tomcat_webdir/java-code /data/tomcat/tomcat_webapps/myapp&quot;</span><br><span class="hljs-comment">#打开tomcat</span><br>ssh www@10.0.0.105 <span class="hljs-string">&quot;/etc/init.d/tomcat start&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="6-3-5-4-Jenkins立即构建"><a href="#6-3-5-4-Jenkins立即构建" class="headerlink" title="6.3.5.4 Jenkins立即构建"></a>6.3.5.4 Jenkins立即构建</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs awk">Started by user jenkinsadmin<br>Running as SYSTEM<br>Building on master <span class="hljs-keyword">in</span> workspace <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace/linux-hello-world<br>[WS-CLEANUP] Deleting project workspace...<br>[WS-CLEANUP] Deferred wipeout is used...<br>The recommended git tool is: NONE<br>using credential <span class="hljs-number">73</span>b70b5b-b09c-<span class="hljs-number">46</span>fd-<span class="hljs-number">8790</span>-<span class="hljs-number">3</span>a0eebf2b12c<br>Cloning the remote Git repository<br>Cloning repository git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git<br> &gt; git init <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace/linux-hello-world <span class="hljs-comment"># timeout=10</span><br>Fetching upstream changes from git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git<br> &gt; git --version <span class="hljs-comment"># timeout=10</span><br> &gt; git --version <span class="hljs-comment"># &#x27;git version 2.17.1&#x27;</span><br>using GIT_SSH to set credentials <br> &gt; git fetch --tags --progress -- git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux<span class="hljs-regexp">/linux-java-web1.git +refs/</span>heads<span class="hljs-regexp">/*:refs/</span>remotes<span class="hljs-regexp">/origin/</span>* <span class="hljs-comment"># timeout=10</span><br> &gt; git config remote.origin.url git@<span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span>:linux/linux-java-web1.git <span class="hljs-comment"># timeout=10</span><br> &gt; git config --add remote.origin.fetch +refs<span class="hljs-regexp">/heads/</span>*:refs<span class="hljs-regexp">/remotes/</span>origin/* <span class="hljs-comment"># timeout=10</span><br>Avoid second fetch<br> &gt; git rev-parse refs<span class="hljs-regexp">/remotes/</span>origin/master^&#123;commit&#125; <span class="hljs-comment"># timeout=10</span><br>Checking out Revision c1ed0a0d6918d7ab1bb02d440e8074154bfa2b55 (refs<span class="hljs-regexp">/remotes/</span>origin/master)<br> &gt; git config core.sparsecheckout <span class="hljs-comment"># timeout=10</span><br> &gt; git checkout -f c1ed0a0d6918d7ab1bb02d440e8074154bfa2b55 <span class="hljs-comment"># timeout=10</span><br>Commit message: <span class="hljs-string">&quot;add sonar.properties&quot;</span><br> &gt; git rev-list --no-walk <span class="hljs-number">1</span>acbfb5592e4f6d88319852f1cc75555f16c823c <span class="hljs-comment"># timeout=10</span><br>Parsing POMs<br>Established TCP socket on <span class="hljs-number">36870</span><br>[linux-hello-world] $ <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/jdk/</span>bin<span class="hljs-regexp">/java -cp /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/maven35-agent-1.13.jar:/u</span>sr<span class="hljs-regexp">/local/m</span>aven<span class="hljs-regexp">/boot/</span>plexus-classworlds-<span class="hljs-number">2.6</span>.<span class="hljs-number">0</span>.jar:<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/maven/</span>conf<span class="hljs-regexp">/logging jenkins.maven3.agent.Maven35Main /u</span>sr<span class="hljs-regexp">/local/m</span>aven <span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/jenkins/</span>war<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/remoting-4.2.1.jar /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib<span class="hljs-regexp">/maven35-interceptor-1.13.jar /</span>var<span class="hljs-regexp">/lib/</span>jenkins<span class="hljs-regexp">/plugins/m</span>aven-plugin<span class="hljs-regexp">/WEB-INF/</span>lib/maven3-interceptor-commons-<span class="hljs-number">1.13</span>.jar <span class="hljs-number">36870</span><br>&lt;===[JENKINS REMOTING CAPACITY]===&gt;channel started<br>Executing Maven:  -B -f <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>pom.xml package -Dmaven.test.skip=true<br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] <br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] Some problems were encountered <span class="hljs-keyword">while</span> building the effective settings<br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] Unrecognised tag: <span class="hljs-string">&#x27;mirrors&#x27;</span> (position: START_TAG seen ...&lt;<span class="hljs-regexp">/mirror&gt;\r\n     --&gt;\r\n\r\n&lt;mirrors&gt;... @160:10)  @ /u</span>sr<span class="hljs-regexp">/local/</span>src<span class="hljs-regexp">/apache-maven-3.6.3/</span>conf/settings.xml, line <span class="hljs-number">160</span>, column <span class="hljs-number">10</span><br>[[<span class="hljs-number">1</span>;<span class="hljs-number">33</span>mWARNING[m] <br>[INFO] Scanning <span class="hljs-keyword">for</span> projects...<br>[INFO] <br>[INFO] --------------------&lt; com.dzxy:maven-Demo20200420 &gt;---------------------<br>[INFO] Building maven-Demo20200420 Maven Webapp <span class="hljs-number">1.0</span>-SNAPSHOT<br>[INFO] --------------------------------[ war ]---------------------------------<br>[INFO] <br>[INFO] --- maven-resources-plugin:<span class="hljs-number">3.0</span>.<span class="hljs-number">2</span>:resources (default-resources) @ maven-Demo20200420 ---<br>[INFO] Using <span class="hljs-string">&#x27;UTF-8&#x27;</span> encoding to copy filtered resources.<br>[INFO] skip non existing resourceDirectory <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>src<span class="hljs-regexp">/main/</span>resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:<span class="hljs-number">3.8</span>.<span class="hljs-number">0</span>:compile (default-compile) @ maven-Demo20200420 ---<br>[INFO] No sources to compile<br>[INFO] <br>[INFO] --- maven-resources-plugin:<span class="hljs-number">3.0</span>.<span class="hljs-number">2</span>:testResources (default-testResources) @ maven-Demo20200420 ---<br>[INFO] Not copying test resources<br>[INFO] <br>[INFO] --- maven-compiler-plugin:<span class="hljs-number">3.8</span>.<span class="hljs-number">0</span>:testCompile (default-testCompile) @ maven-Demo20200420 ---<br>[INFO] Not compiling test sources<br>[INFO] <br>[INFO] --- maven-surefire-plugin:<span class="hljs-number">2.22</span>.<span class="hljs-number">1</span>:test (default-test) @ maven-Demo20200420 ---<br>[INFO] Tests are skipped.<br>[INFO] <br>[INFO] --- maven-war-plugin:<span class="hljs-number">3.2</span>.<span class="hljs-number">2</span>:war (default-war) @ maven-Demo20200420 ---<br>[INFO] Packaging webapp<br>[INFO] Assembling webapp [maven-Demo20200420] <span class="hljs-keyword">in</span> [<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target/maven-Demo20200420]<br>[INFO] Processing war project<br>[INFO] Copying webapp resources [<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>src<span class="hljs-regexp">/main/</span>webapp]<br>[INFO] Webapp assembled <span class="hljs-keyword">in</span> [<span class="hljs-number">33</span> msecs]<br>[INFO] Building war: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target/maven-Demo20200420.war<br>[INFO] ------------------------------------------------------------------------<br>[INFO] BUILD SUCCESS<br>[INFO] ------------------------------------------------------------------------<br>[INFO] Total time:  <span class="hljs-number">2.220</span> s<br>[INFO] Finished at: <span class="hljs-number">2021</span>-<span class="hljs-number">05</span>-<span class="hljs-number">29</span>T21:<span class="hljs-number">50</span>:<span class="hljs-number">22</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span><br>[INFO] ------------------------------------------------------------------------<br>Waiting <span class="hljs-keyword">for</span> Jenkins to finish collecting data<br>[JENKINS] Archiving <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>pom.xml to com.dzxy<span class="hljs-regexp">/maven-Demo20200420/</span><span class="hljs-number">1.0</span>-SNAPSHOT/maven-Demo20200420-<span class="hljs-number">1.0</span>-SNAPSHOT.pom<br>[JENKINS] Archiving <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>target<span class="hljs-regexp">/maven-Demo20200420.war to com.dzxy/m</span>aven-Demo20200420<span class="hljs-regexp">/1.0-SNAPSHOT/m</span>aven-Demo20200420-<span class="hljs-number">1.0</span>-SNAPSHOT.war<br>channel stopped<br>[linux-hello-world] $ <span class="hljs-regexp">/bin/</span>sh -xe <span class="hljs-regexp">/tmp/</span>jenkins9009198800243516851.sh<br>+ bash <span class="hljs-regexp">/data/</span>scripts/linux-java-web.sh<br>INFO: Scanner configuration file: <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/src/</span>sonar-scanner-<span class="hljs-number">4.3</span>.<span class="hljs-number">0.2102</span>-linux<span class="hljs-regexp">/conf/</span>sonar-scanner.properties<br>INFO: Project root configuration file: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>sonar-project.properties<br>INFO: SonarScanner <span class="hljs-number">4.3</span>.<span class="hljs-number">0.2102</span><br>INFO: Java <span class="hljs-number">11.0</span>.<span class="hljs-number">3</span> AdoptOpenJDK (<span class="hljs-number">64</span>-bit)<br>INFO: Linux <span class="hljs-number">4.15</span>.<span class="hljs-number">0</span>-<span class="hljs-number">55</span>-generic amd64<br>INFO: User cache: <span class="hljs-regexp">/root/</span>.sonar/cache<br>INFO: Scanner configuration file: <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/src/</span>sonar-scanner-<span class="hljs-number">4.3</span>.<span class="hljs-number">0.2102</span>-linux<span class="hljs-regexp">/conf/</span>sonar-scanner.properties<br>INFO: Project root configuration file: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>sonar-project.properties<br>INFO: Analyzing on SonarQube server <span class="hljs-number">7.9</span>.<span class="hljs-number">2</span><br>INFO: Default locale: <span class="hljs-string">&quot;en_US&quot;</span>, source code encoding: <span class="hljs-string">&quot;UTF-8&quot;</span><br>INFO: Load global settings<br>INFO: Load global settings (done) | time=<span class="hljs-number">36</span>ms<br>INFO: Server id: <span class="hljs-number">9</span>A84A96E-AXl6fM6ITuzQthHv-dgM<br>INFO: User cache: <span class="hljs-regexp">/root/</span>.sonar/cache<br>INFO: Load/download plugins<br>INFO: Load plugins index<br>INFO: Load plugins index (done) | time=<span class="hljs-number">25</span>ms<br>INFO: Plugin [l10nzh] defines <span class="hljs-string">&#x27;l10nen&#x27;</span> as base plugin. This metadata can be removed from manifest of l10n plugins since version <span class="hljs-number">5.2</span>.<br>INFO: Load/download plugins (done) | time=<span class="hljs-number">58</span>ms<br>INFO: Process project properties<br>INFO: Execute project builders<br>INFO: Execute project builders (done) | time=<span class="hljs-number">2</span>ms<br>INFO: Project key: java-hello-world<br>INFO: Base dir: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace/linux-hello-world<br>INFO: Working dir: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>.scannerwork<br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;java-hello-world&#x27;</span><br>INFO: Load project settings <span class="hljs-keyword">for</span> component key: <span class="hljs-string">&#x27;java-hello-world&#x27;</span> (done) | time=<span class="hljs-number">219</span>ms<br>INFO: Load quality profiles<br>INFO: Load quality profiles (done) | time=<span class="hljs-number">160</span>ms<br>INFO: Detected Jenkins<br>INFO: Load active rules<br>INFO: Load active rules (done) | time=<span class="hljs-number">2310</span>ms<br>INFO: Indexing files...<br>INFO: Project configuration:<br>INFO: <span class="hljs-number">2</span> files indexed<br>INFO: <span class="hljs-number">0</span> files ignored because of scm ignore settings<br>INFO: Quality profile <span class="hljs-keyword">for</span> jsp: Sonar way<br>INFO: Quality profile <span class="hljs-keyword">for</span> xml: Sonar way<br>INFO: ------------- Run sensors on module java-hello-world-web1<br>INFO: Load metrics repository<br>INFO: Load metrics repository (done) | time=<span class="hljs-number">13</span>ms<br>WARNING: An illegal reflective access operation has occurred<br>WARNING: Illegal reflective access by net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span> (file:<span class="hljs-regexp">/root/</span>.sonar<span class="hljs-regexp">/cache/</span><span class="hljs-number">866</span>bb1adbf016ea515620f1aaa15ec53/sonar-javascript-plugin.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain)<br>WARNING: Please consider reporting this to the maintainers of net.sf.cglib.core.ReflectUtils<span class="hljs-variable">$1</span><br>WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations<br>WARNING: All illegal access operations will be denied <span class="hljs-keyword">in</span> a future release<br>INFO: Sensor JaCoCo XML Report Importer [jacoco]<br>INFO: Sensor JaCoCo XML Report Importer [jacoco] (done) | time=<span class="hljs-number">1</span>ms<br>INFO: Sensor JavaXmlSensor [java]<br>INFO: <span class="hljs-number">1</span> source files to be analyzed<br>INFO: Load project repositories<br>INFO: Load project repositories (done) | time=<span class="hljs-number">10</span>ms<br>INFO: Sensor JavaXmlSensor [java] (done) | time=<span class="hljs-number">97</span>ms<br>INFO: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> source files have been analyzed<br>INFO: Sensor HTML [web]<br>INFO: Sensor HTML [web] (done) | time=<span class="hljs-number">43</span>ms<br>INFO: Sensor XML Sensor [xml]<br>INFO: <span class="hljs-number">1</span> source files to be analyzed<br>INFO: Sensor XML Sensor [xml] (done) | time=<span class="hljs-number">70</span>ms<br>INFO: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> source files have been analyzed<br>INFO: ------------- Run sensors on project<br>INFO: Sensor Zero Coverage Sensor<br>INFO: Sensor Zero Coverage Sensor (done) | time=<span class="hljs-number">1</span>ms<br>INFO: <span class="hljs-number">1</span> file had no CPD blocks<br>INFO: Calculating CPD <span class="hljs-keyword">for</span> <span class="hljs-number">0</span> files<br>INFO: CPD calculation finished<br>INFO: Analysis report generated <span class="hljs-keyword">in</span> <span class="hljs-number">45</span>ms, dir size=<span class="hljs-number">73</span> KB<br>INFO: Analysis report compressed <span class="hljs-keyword">in</span> <span class="hljs-number">7</span>ms, zip size=<span class="hljs-number">11</span> KB<br>INFO: Analysis report uploaded <span class="hljs-keyword">in</span> <span class="hljs-number">67</span>ms<br>INFO: ANALYSIS SUCCESSFUL, you can browse http:<span class="hljs-regexp">//</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.108</span>:<span class="hljs-number">9000</span>/dashboard?id=java-hello-world<br>INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report<br>INFO: More about the report processing at http:<span class="hljs-regexp">//</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.108</span>:<span class="hljs-number">9000</span><span class="hljs-regexp">/api/</span>ce/task?id=AXm4Y_ATHdpxPqjYNDnf<br>INFO: Analysis total time: <span class="hljs-number">4.232</span> s<br>INFO: ------------------------------------------------------------------------<br>INFO: EXECUTION SUCCESS<br>INFO: ------------------------------------------------------------------------<br>INFO: Total time: <span class="hljs-number">4.831</span>s<br>INFO: Final Memory: <span class="hljs-number">12</span>M/<span class="hljs-number">44</span>M<br>INFO: ------------------------------------------------------------------------<br>Archive:  target/maven-Demo20200420.war<br>  inflating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/META-INF/</span>MANIFEST.MF  <br>   creating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/WEB-INF/</span><br>   creating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/WEB-INF/</span>classes/<br>  inflating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/WEB-INF/</span>web.xml  <br>  inflating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code/index.jsp  <br>  inflating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.properties  <br>  inflating: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>workspace<span class="hljs-regexp">/linux-hello-world/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.xml  <br>  adding: java-code/ (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/WEB-INF/</span> (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/WEB-INF/</span>classes/ (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/WEB-INF/</span>web.xml (deflated <span class="hljs-number">24</span>%)<br>  adding: java-code/index.jsp (deflated <span class="hljs-number">19</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/</span> (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/</span>MANIFEST.MF (deflated <span class="hljs-number">7</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/m</span>aven/ (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/</span> (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/ (stored <span class="hljs-number">0</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.xml (deflated <span class="hljs-number">64</span>%)<br>  adding: java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.properties (deflated <span class="hljs-number">1</span>%)<br>正在判断服务状态，请稍等<span class="hljs-number">3</span>秒钟！<br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br>Tomcat运行中，<span class="hljs-number">1</span>秒后关闭！<br><span class="hljs-number">1</span><br>即将关闭Tomcat服务，请稍等！<br>已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等<span class="hljs-number">5</span>秒钟！<br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br>Tomcat 已经关闭完成！<br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br>Archive:  <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_appdir/</span>java-code.zip<br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code/<br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/WEB-INF/</span><br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/WEB-INF/</span>classes/<br>  inflating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/WEB-INF/</span>web.xml  <br>  inflating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code/index.jsp  <br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/</span><br>  inflating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/</span>MANIFEST.MF  <br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven/<br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/</span><br>   creating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/<br>  inflating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.xml  <br>  inflating: <span class="hljs-regexp">/data/</span>tomcat<span class="hljs-regexp">/tomcat_webdir/</span>java-code<span class="hljs-regexp">/META-INF/m</span>aven<span class="hljs-regexp">/com.dzxy/m</span>aven-Demo20200420/pom.properties  <br><span class="hljs-string">&#x27;/data/tomcat/tomcat_webapps/myapp&#x27;</span> -&gt; <span class="hljs-string">&#x27;/data/tomcat/tomcat_webdir/java-code&#x27;</span><br>正在判断服务状态，请稍等！<br>请稍等<span class="hljs-number">3</span>秒钟<br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br>Tomcat没有运行，<span class="hljs-number">1</span>秒后启动！<br><span class="hljs-number">1</span><br>Tomcat started.<br>Tomcat 已经成功启动完成,<span class="hljs-number">5</span>秒后判断是否启动成功<br><span class="hljs-number">5</span><br><span class="hljs-number">4</span><br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br>Tomcat 已经成功启动<span class="hljs-number">1</span> 个Tomcat进程!,PID为<span class="hljs-number">7694</span><br>Finished: SUCCES<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another173.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another174.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-3-5-5-jenkins里使用maven插件进项代码扫描"><a href="#6-3-5-5-jenkins里使用maven插件进项代码扫描" class="headerlink" title="6.3.5.5 jenkins里使用maven插件进项代码扫描"></a>6.3.5.5 jenkins里使用maven插件进项代码扫描</h4><p>Jenkins–&gt;项目–&gt;Pre Steps–&gt;调用顶层Maven目标</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another175.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">#目标内容<br>#方法一：<br>clean<br>verify<br>sonar:sonar<br>-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>host.username=admin<br>-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>host.password=admin<br>-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>host.url=http:<span class="hljs-comment">//10.0.0.108:9000</span><br><br>#方法二：<br>clean<br>verify<br>sonar:sonar<br>-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>host.url=http:<span class="hljs-comment">//10.0.0.108:9000</span><br>-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>login=bc8c43a55d1752dba0edb11cfa374b6195074125 #这个为账号的token<br>#-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Dsonar</span>.</span></span>java.binaries=target/sonar<br></code></pre></td></tr></table></figure>

<h2 id="6-4-CMS建站系统自动发布"><a href="#6-4-CMS建站系统自动发布" class="headerlink" title="6.4 CMS建站系统自动发布"></a>6.4 CMS建站系统自动发布</h2><p>略</p>
<h2 id="6-5-ZRLOG博客系统自动发布"><a href="#6-5-ZRLOG博客系统自动发布" class="headerlink" title="6.5 ZRLOG博客系统自动发布"></a>6.5 ZRLOG博客系统自动发布</h2><p>略</p>
<h1 id="七、Jenkins集成钉钉"><a href="#七、Jenkins集成钉钉" class="headerlink" title="七、Jenkins集成钉钉"></a>七、Jenkins集成钉钉</h1><h2 id="7-1-Jenkins集成钉钉概述"><a href="#7-1-Jenkins集成钉钉概述" class="headerlink" title="7.1 Jenkins集成钉钉概述"></a>7.1 Jenkins集成钉钉概述</h2><h3 id="7-1-1Jenkins为什么要又通知？"><a href="#7-1-1Jenkins为什么要又通知？" class="headerlink" title="7.1.1Jenkins为什么要又通知？"></a>7.1.1Jenkins为什么要又通知？</h3><p>Jenkins 进行自动化部署代码后，项目发布的成功或失败，都没没有相应的通知，运维人员无法及时发现项目的部署情况，需要认为查看，比较麻烦。所以考虑项目部署后通过钉钉的方式将结果发送到钉钉的群聊中</p>
<h3 id="7-1-2-使用钉钉推送消息的优势"><a href="#7-1-2-使用钉钉推送消息的优势" class="headerlink" title="7.1.2 使用钉钉推送消息的优势"></a>7.1.2 使用钉钉推送消息的优势</h3><ol>
<li><h5 id="实现简单"><a href="#实现简单" class="headerlink" title="实现简单"></a>实现简单</h5></li>
<li><p>实时提醒</p>
</li>
<li><p>便于查看</p>
</li>
</ol>
<h3 id="7-1-3为什么不使用邮件通知，而使用钉钉通知？"><a href="#7-1-3为什么不使用邮件通知，而使用钉钉通知？" class="headerlink" title="7.1.3为什么不使用邮件通知，而使用钉钉通知？"></a>7.1.3为什么不使用邮件通知，而使用钉钉通知？</h3><ol>
<li>邮件配置复杂</li>
<li>邮件容易拒收</li>
</ol>
<h2 id="7-2-钉钉配置发消息机器人"><a href="#7-2-钉钉配置发消息机器人" class="headerlink" title="7.2 钉钉配置发消息机器人"></a>7.2 钉钉配置发消息机器人</h2><h3 id="7-2-1-创建钉钉群机器人"><a href="#7-2-1-创建钉钉群机器人" class="headerlink" title="7.2.1 创建钉钉群机器人"></a>7.2.1 创建钉钉群机器人</h3><p>打开钉钉群组，点击群机器人。（如果不是群主，且群主开启了仅群主可管理，anemic将无法创建机器人）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another176.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another177.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-2-2-添加一个自定义机器人"><a href="#7-2-2-添加一个自定义机器人" class="headerlink" title="7.2.2 添加一个自定义机器人"></a>7.2.2 添加一个自定义机器人</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another178.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-2-3-修改机器人名称，以及机器人的名字"><a href="#7-2-3-修改机器人名称，以及机器人的名字" class="headerlink" title="7.2.3 修改机器人名称，以及机器人的名字"></a>7.2.3 修改机器人名称，以及机器人的名字</h3><p>（安全设置自己设定）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another179.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-2-4-机器人修改成功后，会给出一个webhook地址。（此处的webhook后续Jenkins需要使用）"><a href="#7-2-4-机器人修改成功后，会给出一个webhook地址。（此处的webhook后续Jenkins需要使用）" class="headerlink" title="7.2.4 机器人修改成功后，会给出一个webhook地址。（此处的webhook后续Jenkins需要使用）"></a>7.2.4 机器人修改成功后，会给出一个webhook地址。（此处的webhook后续Jenkins需要使用）</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another180.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-3-Jenkins集成钉钉消息"><a href="#7-3-Jenkins集成钉钉消息" class="headerlink" title="7.3 Jenkins集成钉钉消息"></a>7.3 Jenkins集成钉钉消息</h2><h3 id="7-3-1-Jenkins安装钉钉插件"><a href="#7-3-1-Jenkins安装钉钉插件" class="headerlink" title="7.3.1 Jenkins安装钉钉插件"></a>7.3.1 Jenkins安装钉钉插件</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another181.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-3-2-项目配置钉钉"><a href="#7-3-2-项目配置钉钉" class="headerlink" title="7.3.2 项目配置钉钉"></a>7.3.2 项目配置钉钉</h3><p>jenkins–&gt;系统配置–&gt;钉钉–&gt;配置名称，webhook，安全策略（配置后进行测试）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another182.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another183.png" srcset="/blog/img/loading.gif" alt="测试结构"></p>
<p>Jenkins–&gt;项目–&gt;配置–&gt;General–&gt;顶i的那个配置</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another184.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-3-3-进行构建测试"><a href="#7-3-3-进行构建测试" class="headerlink" title="7.3.3 进行构建测试"></a>7.3.3 进行构建测试</h3><p>项目开始构建通知</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another185.png" srcset="/blog/img/loading.gif"></p>
<p>项目构建后通知</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/devopts/devpots-another186.png" srcset="/blog/img/loading.gif" alt="项目成功构建通知"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/Linux-Jenkins/">Linux Jenkins</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/05/24/Devops%E4%B9%8B%E5%9F%BA%E4%BA%8EJenkins%E7%9A%84CI%E4%B8%8ECD%E5%AE%9E%E6%88%98/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Devops之基于Jenkins的CI与CD实战</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/03/12/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%A0%A1%E5%9E%92%E6%9C%BAJumpServer/">
                        <span class="hidden-mobile">企业级堡垒机JumpServer</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
