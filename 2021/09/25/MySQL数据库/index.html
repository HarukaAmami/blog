

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>MySQL数据库 - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="MySQL数据库">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-25 12:12" pubdate>
        2021年9月25日 中午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      56.7k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      818
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">MySQL数据库</h1>
            
            <div class="markdown-body">
              <h1 id="MySQL数据库"><a href="#MySQL数据库" class="headerlink" title="MySQL数据库"></a>MySQL数据库</h1><p>不足之处：</p>
<p>DQL应用缺少内容，根据老王的pdf进行补充（老王例子需要的数据库在：D:\Linux\马哥Linux2020视频\文档+笔记\马哥教育Linux云计算就业班M41实验环境文档\上课实验环境文件\第二部分）</p>
<h1 id="一、中级DBA职业规划"><a href="#一、中级DBA职业规划" class="headerlink" title="一、中级DBA职业规划"></a>一、中级DBA职业规划</h1><h2 id="1-1-需要学会的内容（“-”表示重要程度）"><a href="#1-1-需要学会的内容（“-”表示重要程度）" class="headerlink" title="1.1 需要学会的内容（“*”表示重要程度）"></a>1.1 需要学会的内容（“*”表示重要程度）</h2><ol>
<li><p>MySQL 5.7 安装部署（二进制） 编译自己扩展 *****</p>
</li>
<li><p> MySQL升级步骤扩展 ***</p>
</li>
<li><p> MySQL5.7 体系结构原理 *</p>
</li>
<li><p> MySQL基础管理*</p>
</li>
<li><p> MySQL基础语句使用*</p>
</li>
<li><p> SQL高级应用 ***</p>
</li>
<li><p> information_schema获取元数据***</p>
</li>
<li><p> 索引执行计划管理（基础优化)*</p>
</li>
<li><p>存储引擎*****</p>
</li>
<li><p>日志管理*****</p>
</li>
<li><p>备份与恢复******</p>
</li>
<li><p>主从复制及架构演变******</p>
</li>
<li><p>传统的高可用及读写分离（MHA&amp;Atlas*****</p>
</li>
<li><p><em>传统分布式架构设计与实现-扩展（Mycat—&gt;DBLE，DRDS）*</em></p>
</li>
<li><p>MySQL 5.7 高可用及分布式架构-扩展（MGR,InnoDB Cluster）*</p>
</li>
<li><p><strong>MySQL优化（安全、性能）*</strong>*</p>
</li>
<li><p>MySQL 监控（zabbix、Open-falcon）*****</p>
</li>
<li><p>RDB（阿里云课程）*****</p>
</li>
<li><p>额外要会（NoSQL）</p>
</li>
</ol>
<ul>
<li>Redis</li>
<li>mongodb</li>
<li>ES</li>
</ul>
<ol start="20">
<li>了解：</li>
</ol>
<ul>
<li><p>PG</p>
</li>
<li><p>Oracle</p>
</li>
</ul>
<h1 id="二、了解数据库"><a href="#二、了解数据库" class="headerlink" title="二、了解数据库"></a>二、了解数据库</h1><h2 id="2-1-什么是数据？"><a href="#2-1-什么是数据？" class="headerlink" title="2.1 什么是数据？"></a>2.1 什么是数据？</h2><p>电脑上的所有的东西都可以说是数据</p>
<h2 id="2-2-数据库的发展史"><a href="#2-2-数据库的发展史" class="headerlink" title="2.2 数据库的发展史"></a>2.2 数据库的发展史</h2><ol>
<li>萌芽阶段：文件系统，使用磁盘文件来存储数据</li>
<li>初级阶段：第一代数据库 出现了网状模型、层次模型的数据库 </li>
<li>中级阶段：第二代数据库 关系型数据库和结构化查询语言 </li>
<li>高级阶段：新一代数据库 “关系-对象”型数据库 </li>
</ol>
<h2 id="2-3-使用文件管理系统的缺点"><a href="#2-3-使用文件管理系统的缺点" class="headerlink" title="2.3 使用文件管理系统的缺点"></a>2.3 使用文件管理系统的缺点</h2><ol>
<li>编写应用程序不方便 </li>
<li>数据冗余不可避免 </li>
<li>应用程序依赖性 </li>
<li>不支持对文件的并发访问 </li>
<li>数据间联系弱 </li>
<li>难以按用户视图表示数据  </li>
<li>无安全控制功能 </li>
</ol>
<h2 id="2-4-使用数据库管理系统的优点"><a href="#2-4-使用数据库管理系统的优点" class="headerlink" title="2.4 使用数据库管理系统的优点"></a>2.4 使用数据库管理系统的优点</h2><ol>
<li>相互关联的数据的集合 </li>
<li>较少的数据冗余 </li>
<li>程序与数据相互独立 </li>
<li>保证数据的安全、可靠 </li>
<li>最大限度地保证数据的正确性 </li>
<li>数据可以并发使用并能同时保证一致性 </li>
</ol>
<h2 id="2-5-数据库管理系统的的基本功能"><a href="#2-5-数据库管理系统的的基本功能" class="headerlink" title="2.5 数据库管理系统的的基本功能"></a>2.5 数据库管理系统的的基本功能</h2><ol>
<li>数据定义</li>
<li>数据处理</li>
<li>数据安全</li>
<li>数据备份 </li>
</ol>
<h2 id="2-6-网状数据库介绍"><a href="#2-6-网状数据库介绍" class="headerlink" title="2.6 网状数据库介绍"></a>2.6 网状数据库介绍</h2><p>最早出现的是网状DBMS，1964年通用电气公司的Charles Bachman成功地开发出世界上第一 个网状IDS，也是第一个数据库管理系统，IDS 具有数据模式和日志的特征，只能在GE主机运行 </p>
<p>" srcset="/blog/img/loading.gif<img src=""> </p>
<h2 id="2-7-层次数据库介绍"><a href="#2-7-层次数据库介绍" class="headerlink" title="2.7 层次数据库介绍"></a>2.7 层次数据库介绍</h2><p><img src="file:///C:\Users\kinci\AppData\Local\Temp\ksohtml\wps3760.tmp.png" srcset="/blog/img/loading.gif" alt="img"> </p>
<h2 id="2-8-关系型数据库属性介绍"><a href="#2-8-关系型数据库属性介绍" class="headerlink" title="2.8 关系型数据库属性介绍"></a>2.8 关系型数据库属性介绍</h2><p>（关系型数据库主要有以下属性）</p>
<ol>
<li>关系：关系就是二维表。并满足如下性质： 表中的行、列次序并不重要 </li>
<li>行row：表中的每一行，又称为一条记录 </li>
<li>列column：表中的每一列，称为属性，字段 </li>
<li>主键primary key：用于惟一确定一个记录的字段 </li>
<li>域domain：属性的取值范围，如，性别只能是‘男’和‘女’两个值  </li>
</ol>
<h2 id="2-9-关系型数据库主要有哪些（RDBMS）？"><a href="#2-9-关系型数据库主要有哪些（RDBMS）？" class="headerlink" title="2.9 关系型数据库主要有哪些（RDBMS）？"></a>2.9 关系型数据库主要有哪些（RDBMS）？</h2><ul>
<li><p>MySQL: MySQL, MariaDB, Percona Server </p>
</li>
<li><p>PostgreSQL: 简称为pgsql，EnterpriseDB </p>
</li>
<li><p>Oracle </p>
</li>
<li><p>MSSQL </p>
</li>
<li><p>DB2  </p>
</li>
</ul>
<h2 id="2-10-数据库排名"><a href="#2-10-数据库排名" class="headerlink" title="2.10 数据库排名"></a>2.10 数据库排名</h2><p><a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking">https://db-engines.com/en/ranking</a> （上这个网页浏览）</p>
<h2 id="2-11-数据库系统结构"><a href="#2-11-数据库系统结构" class="headerlink" title="2.11 数据库系统结构"></a>2.11 数据库系统结构</h2><ol>
<li><p>单机架构 </p>
</li>
<li><p>大型主机/终端架构 </p>
</li>
<li><p>主从式架构（C/S）  </p>
</li>
<li><p>分布式架构 </p>
</li>
</ol>
<h2 id="2-12-数据库的联系类型"><a href="#2-12-数据库的联系类型" class="headerlink" title="2.12 数据库的联系类型"></a>2.12 数据库的联系类型</h2><ul>
<li>一对一联系(1:1) </li>
<li>一对多联系(1:n) </li>
<li>多对多联系(m:n)  </li>
</ul>
<h2 id="2-13-数据库的操作"><a href="#2-13-数据库的操作" class="headerlink" title="2.13 数据库的操作"></a>2.13 数据库的操作</h2><p>数据提取：在数据集合中提取感兴趣的内容。SELECT </p>
<p>数据更新：变更数据库中的数据。INSERT、DELETE、UPDATE  </p>
<h2 id="2-14-数据的约束条件"><a href="#2-14-数据的约束条件" class="headerlink" title="2.14 数据的约束条件"></a>2.14 数据的约束条件</h2><p>是一组完整性规则的集合 </p>
<ol>
<li>实体（行）完整性 Entity integrity </li>
<li>域（列）完整性 Domain Integrity </li>
<li>参考完整性 Referential Integrity </li>
</ol>
<h2 id="2-15-简易数据库规划流程"><a href="#2-15-简易数据库规划流程" class="headerlink" title="2.15 简易数据库规划流程"></a>2.15 简易数据库规划流程</h2><ol>
<li><p>收集数据，得到字段 </p>
<ul>
<li>收集必要且完整的数据项  </li>
<li>转换成数据表的字段</li>
</ul>
</li>
<li><p>把字段分类，归入表，建立表的关联  </p>
<ul>
<li>关联：表和表间的关系 </li>
<li>分割数据表并建立关联的优点 </li>
<li>节省空间 </li>
<li>减少输入错误 </li>
<li>2.15.2.5 方便数据修改 </li>
</ul>
</li>
<li><p>规范化数据库</p>
</li>
</ol>
<h2 id="2-16-数据库的正规化分析"><a href="#2-16-数据库的正规化分析" class="headerlink" title="2.16 数据库的正规化分析"></a>2.16 数据库的正规化分析</h2><p>**RDMBS设计范式基础概念 **</p>
<p>设计关系数据库时，遵从不同的规范要求，设计出合理的关系型数据库，这些不 同的规范要求被称为不同范式，各种范式呈递次规范，越高的范式数据库冗余越小 </p>
<p><strong>目前关系数据库有六种范式</strong></p>
<p>满足最低要求的范式是第一范式（1NF）。在第一范式的基础上 进一步满足更多规范要求的称为第二范式（2NF），其余范式以次类推。一般数据库只需满足第三范式(3NF）即可 </p>
<ul>
<li>第一范式（1NF）</li>
<li>第二范式（2NF）</li>
<li>第三范式 （3NF）、巴德斯科范式（BCNF）</li>
<li>第四范式(4NF）</li>
<li>第五范式（5NF，又称 完美范式） </li>
</ul>
<h2 id="2-17-第一范式（1NF）介绍"><a href="#2-17-第一范式（1NF）介绍" class="headerlink" title="2.17 第一范式（1NF）介绍"></a>2.17 第一范式（1NF）介绍</h2><p>无重复的列，每一列都是不可分割的基本数据项，同一列中不能有多个 值，即实体中的某个属性不能有多个值或者不能有重复的属性。除去同类型的 字段，就是无重复的列   </p>
<p>说明：第一范式（1NF）是对关系模式的基本要求，不满足第一范式（1NF）的数据库就不是关系数据库  </p>
<h2 id="2-18-第二范式（2NF）介绍"><a href="#2-18-第二范式（2NF）介绍" class="headerlink" title="2.18 第二范式（2NF）介绍"></a>2.18 第二范式（2NF）介绍</h2><p>属性完全依赖于主键，第二范式必须先满足第一范式，要求表中的每个 行必须可以被唯一地区分。通常为表加上一个列，以存储各个实例的唯一标识 PK，非PK的字段需要与整个PK有直接相关性  </p>
<h2 id="2-19-第三范式-（3NF）介绍"><a href="#2-19-第三范式-（3NF）介绍" class="headerlink" title="2.19 第三范式 （3NF）介绍"></a>2.19 第三范式 （3NF）介绍</h2><p>属性不依赖于其它非主属性，满足第三范式必须先满足第二范式。第三 范式要求一个数据库表中不包含已在其它表中已包含的非主关键字信息，非PK 的字段间不能有从属关系  </p>
<h2 id="2-20-数据模型"><a href="#2-20-数据模型" class="headerlink" title="2.20 数据模型"></a>2.20 数据模型</h2><p><strong>数据抽象</strong></p>
<ul>
<li>物理层：数据存储格式，即RDBMS在磁盘上如何组织文件 </li>
<li>2.20.1.2 逻辑层：DBA角度，描述存储什么数据，以及数据间存在什么样的关系 </li>
<li>视图层：用户角度，描述DB中的部分数据 </li>
</ul>
<p><strong>关系模型分类</strong></p>
<ul>
<li><p>关系模型  </p>
</li>
<li><p>基于对象的关系模型 </p>
</li>
<li><p>半结构化的关系模型：XML数据 </p>
</li>
</ul>
<h2 id="2-21-MySQL-企业版本GA选择"><a href="#2-21-MySQL-企业版本GA选择" class="headerlink" title="2.21 MySQL 企业版本GA选择"></a>2.21 MySQL 企业版本GA选择</h2><p>5.6 ： 5.6.34 5.6.36 5.6.38（2017913） 5.6.40 </p>
<p>5.7 ： 5.7.18 ，5.7.20（2017913） ，24 ，（上课版本：5.7.26）</p>
<p>8.0 ： 8014， 8015 ，8016</p>
<h2 id="2-22-关于数据库版本面试"><a href="#2-22-关于数据库版本面试" class="headerlink" title="2.22 关于数据库版本面试"></a>2.22 关于数据库版本面试</h2><p>你们公司用的什么版本的MySQL？ 你在公司干几年了？</p>
<h1 id="三、MySQL简介与安装"><a href="#三、MySQL简介与安装" class="headerlink" title="三、MySQL简介与安装"></a>三、MySQL简介与安装</h1><h2 id="3-1-MySQL介绍"><a href="#3-1-MySQL介绍" class="headerlink" title="3.1 MySQL介绍"></a>3.1 MySQL介绍</h2><h2 id="3-1-1-MySQL历史"><a href="#3-1-1-MySQL历史" class="headerlink" title="3.1.1 MySQL历史"></a>3.1.1 MySQL历史</h2><p>1979年：TcX公司 Monty Widenius，Unireg<br>1996年：发布MySQL1.0，Solaris版本，Linux版本<br>1999年：MySQL AB公司，瑞典<br>2003年：MySQL 5.0版本，提供视图、存储过程等功能<br>2008年：Sun 10亿美元收购MySQL<br>2009年：Oracle 75亿美元收购sun<br>2009年：Monty成立MariaDB</p>
<h2 id="3-1-2-MySQL系列"><a href="#3-1-2-MySQL系列" class="headerlink" title="3.1.2 MySQL系列"></a>3.1.2 MySQL系列</h2><h4 id="3-1-2-1MySQL-的三大主要分支"><a href="#3-1-2-1MySQL-的三大主要分支" class="headerlink" title="3.1.2.1MySQL 的三大主要分支"></a>3.1.2.1MySQL 的三大主要分支</h4><ul>
<li>mysql</li>
<li>mariadb</li>
<li>percona Server</li>
</ul>
<h4 id="3-1-2-2-官方网址"><a href="#3-1-2-2-官方网址" class="headerlink" title="3.1.2.2 官方网址"></a>3.1.2.2 官方网址</h4><p><a target="_blank" rel="noopener" href="https://www.mysql.com/">https://www.mysql.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://mariadb.org/">https://mariadb.org/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.percona.com/software/mysql-database/percona-server">https://www.percona.com/software/mysql-database/percona-server</a></p>
<h4 id="3-1-2-3-官方文档"><a href="#3-1-2-3-官方文档" class="headerlink" title="3.1.2.3 官方文档"></a>3.1.2.3 官方文档</h4><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/">https://dev.mysql.com/doc/</a></p>
<p><a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/">https://mariadb.com/kb/en/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.percona.com/software/mysql-database/percona-server">https://www.percona.com/software/mysql-database/percona-server</a></p>
<h4 id="3-1-2-4-版本演变"><a href="#3-1-2-4-版本演变" class="headerlink" title="3.1.2.4 版本演变"></a>3.1.2.4 版本演变</h4><p>MySQL：5.1 –&gt; 5.5 –&gt; 5.6 –&gt; 5.7 –&gt;8.0<br>MariaDB：5.1 –&gt;5.5 –&gt;10.0–&gt; 10.1 –&gt; 10.2 –&gt; 10.3 –&gt; 10.4 –&gt; 10.5</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">MySQL被Sun收购后，搞了个过渡的<span class="hljs-number">6</span>.<span class="hljs-number">0</span>版本，没多久就下线了,后来被Oracle收购后，终于迎来了像样的<br><span class="hljs-number">5</span>.<span class="hljs-number">6</span>版本，之后就是<span class="hljs-number">5.7、8.0</span>版本。由于<span class="hljs-number">6</span>.<span class="hljs-number">0</span>版本号已被用过，<span class="hljs-number">7</span>.x系列版本专用于NDB Cluster，因而新<br>版本号从<span class="hljs-number">8</span>.<span class="hljs-number">0</span>开始。<br></code></pre></td></tr></table></figure>

<h3 id="3-1-3-MYSQL的特性"><a href="#3-1-3-MYSQL的特性" class="headerlink" title="3.1.3 MYSQL的特性"></a>3.1.3 MYSQL的特性</h3><ul>
<li>插件式存储引擎：也称为“表类型”，存储管理器有多种实现版本，功能和特性可能均略有差别；用<br>户可根据需要灵活选择,Mysql5.5.5开始innoDB引擎是MYSQL默认引擎</li>
<li>单进程，多线程</li>
<li>诸多扩展和新特性</li>
<li>提供了较多测试组件</li>
<li>开源</li>
</ul>
<h2 id="3-2-MySQL安装方式介绍和快速安装"><a href="#3-2-MySQL安装方式介绍和快速安装" class="headerlink" title="3.2 MySQL安装方式介绍和快速安装"></a>3.2 MySQL安装方式介绍和快速安装</h2><h3 id="3-2-1-安装方式介绍"><a href="#3-2-1-安装方式介绍" class="headerlink" title="3.2.1 安装方式介绍"></a>3.2.1 安装方式介绍</h3><ul>
<li>源代码：编译安装</li>
<li>二进制格式的程序包：展开至特定路径，并经过简单配置后即可使用</li>
<li>程序包管理器管理的程序包</li>
</ul>
<h3 id="3-2-2-RPM包安装MySQL"><a href="#3-2-2-RPM包安装MySQL" class="headerlink" title="3.2.2 RPM包安装MySQL"></a>3.2.2 RPM包安装MySQL</h3><p>项目官方：<a target="_blank" rel="noopener" href="https://downloads.mariadb.org/mariadb/repositories/">https://downloads.mariadb.org/mariadb/repositories/</a></p>
<p>​                   <a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/mysql/">https://dev.mysql.com/downloads/mysql/</a></p>
<p>国内镜像：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/mariadb/yum/">https://mirrors.tuna.tsinghua.edu.cn/mariadb/yum/</a></p>
<p>​                   <a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/">https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/</a></p>
<p>CentOS 8：安装光盘直接提供</p>
<ul>
<li>mysql-server：8.0</li>
<li>mariadb-server : 10.3.17</li>
</ul>
<p>CentOS 7：安装光盘直接提供</p>
<ul>
<li>mariadb-server：5.5 服务器包</li>
<li>mariadb 客户端工具包 </li>
</ul>
<p>CentOS 6：</p>
<ul>
<li>mysql-server：5.1 服务器包</li>
<li>mysql 客户端工具包</li>
</ul>
<h2 id="3-3-初始化脚本提高安全性"><a href="#3-3-初始化脚本提高安全性" class="headerlink" title="3.3 初始化脚本提高安全性"></a>3.3 初始化脚本提高安全性</h2><p>运行脚本：mysql_secure_installation</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xquery">设置数据库管理<span class="hljs-built_in">员root</span>口令<br>禁<span class="hljs-built_in">止root</span>远程登录<br>删除anonymous用户帐号<br>删除test数据库<br></code></pre></td></tr></table></figure>

<h2 id="3-4-MySQL-组成"><a href="#3-4-MySQL-组成" class="headerlink" title="3.4 MySQL 组成"></a>3.4 MySQL 组成</h2><h3 id="3-4-1客户端程序"><a href="#3-4-1客户端程序" class="headerlink" title="3.4.1客户端程序"></a>3.4.1客户端程序</h3><ul>
<li><p>mysql: 交互式的CLI工具</p>
</li>
<li><p>mysqldump：备份工具，基于mysql协议向mysqld发起查询请求，并将查得的所有数据转换成insert等写操作语句保存文本文件中</p>
</li>
<li><p>mysqladmin：基于mysql协议管理mysqld</p>
</li>
<li><p>mysqlimport：数据导入工具</p>
</li>
</ul>
<p>MyISAM存储引擎的管理工具：</p>
<ul>
<li>myisamchk：检查MyISAM库</li>
<li>myisampack：打包MyISAM表，只读</li>
</ul>
<h3 id="3-4-2-服务器端程序"><a href="#3-4-2-服务器端程序" class="headerlink" title="3.4.2 服务器端程序"></a>3.4.2 服务器端程序</h3><ul>
<li>mysqld_safe</li>
<li>mysqld</li>
<li>mysqld_multi 多实例 ，示例：mysqld_multi –example</li>
</ul>
<h3 id="3-4-3-用户账号"><a href="#3-4-3-用户账号" class="headerlink" title="3.4.3 用户账号"></a>3.4.3 用户账号</h3><p>mysql用户账号由两部分组成：‘USERNAME‘@’HOST’</p>
<p>说明：</p>
<ol>
<li>HOST限制此用户可通过哪些远程主机连接mysql服务器</li>
<li>支持使用通配符：<ul>
<li>% 匹配任意长度的任意字符</li>
<li>172.16.0.0/255.255.0.0 或 172.16.%.%</li>
<li>_ 匹配任意单个字符</li>
</ul>
</li>
</ol>
<h3 id="3-4-4-mysql-客户端命令"><a href="#3-4-4-mysql-客户端命令" class="headerlink" title="3.4.4 mysql 客户端命令"></a>3.4.4 mysql 客户端命令</h3><h4 id="3-4-4-1-mysql-运行命令类型"><a href="#3-4-4-1-mysql-运行命令类型" class="headerlink" title="3.4.4.1 mysql 运行命令类型"></a>3.4.4.1 mysql 运行命令类型</h4><ul>
<li>客户端命令：本地执行，每个命令都完整形式和简写格式</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">mysql&gt;</span><span class="bash"> \h, <span class="hljs-built_in">help</span></span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> \u，use</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> \s，status</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> \!，system</span><br></code></pre></td></tr></table></figure>

<ul>
<li>服务端命令：通过mysql协议发往服务器执行并取回结果，命令末尾都必须使用命令结束符号，默认为分号</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#示例：</span><br>mysql&gt;SELECT VERSION();<br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-2-mysql-使用模式"><a href="#3-4-4-2-mysql-使用模式" class="headerlink" title="3.4.4.2 mysql 使用模式"></a>3.4.4.2 mysql 使用模式</h4><ul>
<li>交互模式</li>
<li>脚本模式</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql -uUSERNAME -pPASSWORD &lt; /path/somefile.sql<br><br>cat /path/somefile.sql | mysql -uUSERNAME -pPASSWORD<br><br>mysql&gt;<span class="hljs-built_in">source</span>  /path/from/somefile.sql<br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-3-mysql命令使用格式"><a href="#3-4-4-3-mysql命令使用格式" class="headerlink" title="3.4.4.3 mysql命令使用格式"></a>3.4.4.3 mysql命令使用格式</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql [OPTIONS] [database]<br></code></pre></td></tr></table></figure>

<p>mysql客户端常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">-A, --no-auto-rehash 禁止补全<br>-u, --user= 用户名,默认为root<br>-h, --host= 服务器主机,默认为localhost<br>-p, --passowrd= 用户密码,建议使用-p,默认为空密码<br>-P, --port= 服务器端口<br>-S, --socket= 指定连接socket文件路径<br>-D, --database= 指定默认数据库<br>-C, --compress 启用压缩<br>-e  “SQL“ 执行SQL命令<br>-V, --version 显示版本<br>-v  --verbose 显示详细信息<br>--print-defaults 获取程序默认使用的配置<br></code></pre></td></tr></table></figure>

<p>登录系统</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#默认空密码登录</span><br>mysql  -uroot  -p<br></code></pre></td></tr></table></figure>

<p>运行mysql命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt;use mysql<br>mysql&gt;select user(); <span class="hljs-comment">#查看当前用户</span><br>mysql&gt;SELECT User,Host FROM mysql.user;<br></code></pre></td></tr></table></figure>

<p>范例：mysql的配置文件，修改提示符</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#查看mysql版本</span><br>[root@centos8 ~]<span class="hljs-comment">#mysql -V</span><br>mysql Ver 15.1 Distrib 10.3.11-MariaDB, <span class="hljs-keyword">for</span> Linux (x86_64) using readline 5.1<br><br><span class="hljs-comment">#临时修改mysql提示符</span><br>[root@centos8 ~]<span class="hljs-comment">#mysql -uroot -pcentos --prompt=&quot;\\r:\\m:\\s(\\u@\\h) [\\d]&gt;\\_&quot;</span><br><br><span class="hljs-comment">#临时修改mysql提示符</span><br>[root@centos8 ~]<span class="hljs-comment">#export MYSQL_PS1=&quot;\\r:\\m:\\s(\\u@\\h) [\\d]&gt;\\_&quot; </span><br><br><span class="hljs-comment">#持久修改mysql提示符</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/my.cnf.d/mysql-clients.cnf</span><br>[mysql]<br>prompt=<span class="hljs-string">&quot;\\r:\\m:\\s(\\u@\\h) [\\d]&gt;\\_&quot;</span>                    <br>    <br>[root@centos8 ~]<span class="hljs-comment">#mysql --print-defaults -v</span><br>mysql would have been started with the following arguments:<br>--prompt=\r:\m:\s(\u@\h) [\d]&gt;\_ -v<br>[root@centos8 ~]<span class="hljs-comment">#mysql</span><br>Welcome to the MariaDB monitor. Commands end with ; or \g.<br><br>Your MariaDB connection id is 11<br>Server version: 10.3.11-MariaDB MariaDB Server<br><br>Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>10:29:30(root@localhost) [(none)]&gt; use mysql<br>Reading table information <span class="hljs-keyword">for</span> completion of table and column names<br>You can turn off this feature to get a quicker startup with -A<br><br>Database changed<br>10:29:34(root@localhost) [mysql]&gt; <span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>

<p>范例：配置客户端mysql的自动登录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/my.cnf.d/client.conf <span class="hljs-comment">#配置文件路径并不唯一，注意my.cnf配置文件指定的内容</span><br>[client]<br>user=rlin<br>password=123456<br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-4-mysqladmin命令"><a href="#3-4-4-4-mysqladmin命令" class="headerlink" title="3.4.4.4 mysqladmin命令"></a>3.4.4.4 mysqladmin命令</h4><p>mysqladmin 命令格式</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">mysqladmin [OPTIONS] <span class="hljs-keyword">command</span> <span class="hljs-keyword">command</span>.<span class="hljs-string">...</span><br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#查看mysql服务是否正常，如果正常提示mysqld is alive</span><br>mysqladmin -uroot -pcentos  ping<br><br><span class="hljs-comment">#关闭mysql服务，但mysqladmin命令无法开启</span><br>mysqladmin -uroot -pcentos shutdown<br><br><span class="hljs-comment">#创建数据库testdb</span><br>mysqladmin -uroot -pcentos  create testdb<br><br><span class="hljs-comment">#删除数据库testdb</span><br>mysqladmin -uroot -pcentos  drop testdb<br><br><span class="hljs-comment">#修改root密码</span><br>mysqladmin -uroot -pcentos password <span class="hljs-string">&#x27;magedu&#x27;</span><br><br><span class="hljs-comment">#日志滚动,生成新文件/var/lib/mysql/mariadb-bin.00000N</span><br>mysqladmin -uroot -pcentos flush-logs<br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-5-服务器端配置"><a href="#3-4-4-5-服务器端配置" class="headerlink" title="3.4.4.5 服务器端配置"></a>3.4.4.5 服务器端配置</h4><p>服务器端(mysqld)：工作特性有多种配置方式<br>1、命令行选项：<br>2、配置文件：类ini格式,集中式的配置，能够为mysql的各应用程序提供配置信息</p>
<p>服务器端配置文件：<br>/etc/my.cnf     #Global选项<br>/etc/mysql/my.cnf     #Global选项<br>~/.my.cnf     #User-specific 选项</p>
<p>配置文件格式：</p>
<p>[mysqld]<br>[mysqld_safe]<br>[mysqld_multi]<br>[mysql]<br>[mysqldump]<br>[server]<br>[client]<br>格式：parameter = value<br>说明：_和- 相同<br>1，ON，TRUE意义相同， 0，OFF，FALSE意义相同,无区分大小写</p>
<h4 id="3-4-4-6-socket地址"><a href="#3-4-4-6-socket地址" class="headerlink" title="3.4.4.6 socket地址"></a>3.4.4.6 socket地址</h4><p>服务器监听的两种socket地址：</p>
<ul>
<li>ip socket: 监听在tcp的3306端口，支持远程通信 ，侦听3306/tcp端口可以在绑定有一个或全部接口IP上</li>
<li>unix sock: 监听在sock文件上，仅支持本机通信, 如：/var/lib/mysql/mysql.sock)<br>说明：host为localhost 时自动使用unix sock</li>
</ul>
<h4 id="3-4-4-7-关闭mysqld网络连接"><a href="#3-4-4-7-关闭mysqld网络连接" class="headerlink" title="3.4.4.7 关闭mysqld网络连接"></a>3.4.4.7 关闭mysqld网络连接</h4><p>只侦听本地客户端， 所有客户端和服务器的交互都通过一个socket文件实现，socket的配置存放在/var/lib/mysql/mysql.sock） 可在/etc/my.cnf修改</p>
<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/my.cnf<br>[mysqld]<br>skip-networking=1<br>bind_address=127.0.0.1<br></code></pre></td></tr></table></figure>

<h2 id="3-5-二进制格式安装-MySQL方式1"><a href="#3-5-二进制格式安装-MySQL方式1" class="headerlink" title="3.5 二进制格式安装 MySQL方式1"></a>3.5 二进制格式安装 MySQL方式1</h2><h3 id="3-5-1-下载并上传至-server-tools"><a href="#3-5-1-下载并上传至-server-tools" class="headerlink" title="3.5.1 下载并上传至/server/tools"></a>3.5.1 下载并上传至/server/tools</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -p /server/tools</span><br><br><span class="hljs-comment"># cd /server/tools/</span><br><br><span class="hljs-comment">#ls</span><br>mysql-5.7.26-linux-glibc2.12-x86_64.tar.gz<br></code></pre></td></tr></table></figure>

<h3 id="3-5-2-解压到指定文件夹-（可以理解为安装完成数据库了）"><a href="#3-5-2-解压到指定文件夹-（可以理解为安装完成数据库了）" class="headerlink" title="3.5.2 解压到指定文件夹 （可以理解为安装完成数据库了）"></a>3.5.2 解压到指定文件夹 （可以理解为安装完成数据库了）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir /application</span><br><span class="hljs-comment"># tar xf mysql-5.7.26-linux-glibc2.12-x86_64.tar.gz </span><br><br><span class="hljs-comment">#改名或做软链接（推荐软连接）</span><br><span class="hljs-comment"># mv mysql-5.7.26-linux-glibc2.12-x86_64 /application/mysql</span><br><br><span class="hljs-comment"># mv mysql-5.7.26-linux-glibc2.12-x86_64 /application/</span><br><span class="hljs-comment"># ln -s /application/mysql-5.7.26-linux-glibc2.12-x86_64/ /application/mysql</span><br></code></pre></td></tr></table></figure>

<h3 id="3-5-3-用户的创建处理原始环境"><a href="#3-5-3-用户的创建处理原始环境" class="headerlink" title="3.5.3 用户的创建处理原始环境"></a>3.5.3 用户的创建处理原始环境</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># rpm -qa |grep mariadb （查看当前主机是否还有mysql）</span><br><br><span class="hljs-comment"># yum remove -y mariadb-libs-5.5.56-2.el7.x86_64 （如果有就删除）</span><br><br><span class="hljs-comment"># useradd -s /sbin/nologin mysql （创建mysql用户，mysql自己使用的用户，二进制安装是不会创建mysql用户）</span><br></code></pre></td></tr></table></figure>

<h3 id="3-5-4-设置环境变量"><a href="#3-5-4-设置环境变量" class="headerlink" title="3.5.4 设置环境变量"></a>3.5.4 设置环境变量</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-built_in">export</span> PATH=/application/mysql/bin:<span class="hljs-variable">$PATH</span> （再最后一行添加即可）<br><span class="hljs-comment"># source /etc/profile （使文件生效）</span><br><span class="hljs-comment"># mysql -V</span><br>mysql Ver 14.14 Distrib 5.7.26, <span class="hljs-keyword">for</span> linux-glibc2.12 (x86_64) using EditLine wrapper<br></code></pre></td></tr></table></figure>

<h3 id="3-5-5-创建数据路径并授权"><a href="#3-5-5-创建数据路径并授权" class="headerlink" title="3.5.5 创建数据路径并授权"></a>3.5.5 创建数据路径并授权</h3><ol>
<li><p>关机添加磁盘</p>
</li>
<li><p>格式化挂载磁盘</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkfs.xfs /dev/sdb （格式化磁盘并添加文件系统，可以使用fdisk -l来查看磁盘）</span><br><br><span class="hljs-comment"># mkdir /data （创建存储目录）</span><br><br><span class="hljs-comment"># blkid （查看磁盘信息）</span><br><br><span class="hljs-comment"># vim /etc/fstab （修改挂载配置文件，使得每次开机都会自动挂载）</span><br>UUID=<span class="hljs-string">&quot;dfa226fb-9185-4b50-a0d9-cc8e5701509d&quot;</span> /data xfs defaults 0 0 （这里使用blkid查看UUID后将UUID复制来这里后直接粘贴）<br><br><span class="hljs-comment"># mount -a （挂载配置文件里没有挂载的设备）</span><br><br><span class="hljs-comment"># df -h </span><br></code></pre></td></tr></table></figure>

<p>" srcset="/blog/img/loading.gif<img src="" alt="1"> </p>
<h3 id="3-5-6-授权"><a href="#3-5-6-授权" class="headerlink" title="3.5.6 授权"></a>3.5.6 授权</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># chown -R mysql.mysql /application/*</span><br><br><span class="hljs-comment"># chown -R mysql.mysql /data</span><br></code></pre></td></tr></table></figure>

<h3 id="3-5-7-初始化数据-（创建系统数据）"><a href="#3-5-7-初始化数据-（创建系统数据）" class="headerlink" title="3.5.7 初始化数据 （创建系统数据）"></a>3.5.7 初始化数据 （创建系统数据）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#5.6版本初始化</span><br><span class="hljs-comment"># /application/mysql/scripts/mysql_install_db</span><br><span class="hljs-comment">#5.7版本初始化</span><br><span class="hljs-comment"># mkdir /data/mysql/data -p </span><br><span class="hljs-comment"># chown -R mysql.mysql /data</span><br><span class="hljs-comment"># yum install -y libaio-devel numactl</span><br><span class="hljs-comment">#清空存储数据的文件夹</span><br><span class="hljs-comment"># rm -rf /data/mysql/data/*</span><br><span class="hljs-comment"># mysqld --initialize-insecure --user=mysql --basedir=/application/mysql --datadir=/data/mysql/data</span><br><br>注意以下两种初始方式：<br>mysqld --initialize --user=mysql --basedir=/application/mysql --datadir=/data/mysql/data<br>说明：<br>--initialize 参数：<br>\1. 对于密码复杂度进行定制：12位，4种 <br>\2. 密码过期时间：180<br>\3. 给root@localhost用户设置临时密码<br><br>mysqld --initialize-insecure --user=mysql --basedir=/application/mysql --datadir=/data/mysql/data<br>说明：<br>--initialize-insecure 参数：无限制，无临时密码<br></code></pre></td></tr></table></figure>

<h3 id="3-5-8-配置文件的准备"><a href="#3-5-8-配置文件的准备" class="headerlink" title="3.5.8 配置文件的准备"></a>3.5.8 配置文件的准备</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cat &gt;/etc/my.cnf &lt;&lt;EOF</span><br>[mysqld]<br>user=mysql<br>basedir=/application/mysql<br>datadir=/data/mysql/data<br>socket=/tmp/mysql.sock<br>server_id=6<br>port=3306<br>[mysql]<br>socket=/tmp/mysql.sock<br>EOF<br></code></pre></td></tr></table></figure>

<h3 id="3-5-9-启动数据库"><a href="#3-5-9-启动数据库" class="headerlink" title="3.5.9 启动数据库"></a>3.5.9 启动数据库</h3><h4 id="3-5-9-1-mysqld启动"><a href="#3-5-9-1-mysqld启动" class="headerlink" title="3.5.9.1 mysqld启动"></a>3.5.9.1 mysqld启动</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp /application/mysql/support-files/mysql.server /etc/init.d/mysqld </span><br><br><span class="hljs-comment"># service mysqld restart （或/etc/init.d/mysqld restart）</span><br></code></pre></td></tr></table></figure>

<h4 id="3-5-9-2-systemd"><a href="#3-5-9-2-systemd" class="headerlink" title="3.5.9.2 systemd"></a>3.5.9.2 systemd</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#注意：mysqld方式启动过的话，需要先提前关闭，才能以下方式登录</span><br><span class="hljs-comment"># cat &gt; /usr/lib/systemd/system/mysqld.service&lt;&lt;EOF</span><br>[Unit]<br>Description=MySQL Server<br>Documentation=man:mysqld(8)<br>Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html<br>After=network.target<br>After=syslog.target<br>[Install]<br>WantedBy=multi-user.target<br>[Service]<br>User=mysql<br>Group=mysql<br>ExecStart=/application/mysql/bin/mysqld --defaults-file=/etc/my.cnf （生产环境只需要改这个路径）<br>LimitNOFILE = 5000<br>EOF<br></code></pre></td></tr></table></figure>

<h3 id="3-5-10-如何分析处理MySQL数据库无法启动"><a href="#3-5-10-如何分析处理MySQL数据库无法启动" class="headerlink" title="3.5.10 如何分析处理MySQL数据库无法启动"></a>3.5.10 如何分析处理MySQL数据库无法启动</h3><h4 id="3-5-10-1-without-updating-PID-类似错误"><a href="#3-5-10-1-without-updating-PID-类似错误" class="headerlink" title="3.5.10.1 without updating PID 类似错误"></a>3.5.10.1 without updating PID 类似错误</h4><p>查看日志：</p>
<p>​    在哪？</p>
<p>​    /data/mysql/data/主机名.err </p>
<p>​    [ERROR] 上下文</p>
<p>可能情况：</p>
<p>​    /etc/my.cnf 路径不对等</p>
<p>​    /tmp/mysql.sock文件修改过 或 删除过 </p>
<p>​    数据目录权限不是mysql</p>
<p>​    参数改错了</p>
<p>日志不能查看（使用这条命令直接查看启动日志：/application/mysql/bin/mysqld –defaults-file=/etc/my.cnf）</p>
<h3 id="3-5-11-管理员密码设定（也可以当作修改密码）"><a href="#3-5-11-管理员密码设定（也可以当作修改密码）" class="headerlink" title="3.5.11 管理员密码设定（也可以当作修改密码）"></a>3.5.11 管理员密码设定（也可以当作修改密码）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mysqladmin -uroot -p password 123456</span><br>Enter password: <span class="hljs-comment">#（第一次设置密码就直接按回车，之后更改密码就要输入旧密码，之后会出现警告，但是不用理他）</span><br></code></pre></td></tr></table></figure>

<h3 id="3-5-12-管理员用户密码忘记，怎么恢复？"><a href="#3-5-12-管理员用户密码忘记，怎么恢复？" class="headerlink" title="3.5.12 管理员用户密码忘记，怎么恢复？"></a>3.5.12 管理员用户密码忘记，怎么恢复？</h3><h4 id="3-5-12-1-关闭数据库"><a href="#3-5-12-1-关闭数据库" class="headerlink" title="3.5.12.1 关闭数据库"></a>3.5.12.1 关闭数据库</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /etc/init.d/mysqld stop </span><br><span class="hljs-comment">#或</span><br><span class="hljs-comment"># systemctl stop mysqld</span><br></code></pre></td></tr></table></figure>

<h4 id="3-5-12-2-启动数据库到维护模式"><a href="#3-5-12-2-启动数据库到维护模式" class="headerlink" title="3.5.12.2 启动数据库到维护模式"></a>3.5.12.2 启动数据库到维护模式</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mysqld_safe --skip-grant-tables --skip-networking &amp;</span><br>注意：<br>--skip-grant-tables <span class="hljs-comment">#跳过授权表</span><br>--skip-networking  <span class="hljs-comment">#跳过远程登录</span><br></code></pre></td></tr></table></figure>

<h4 id="3-5-12-3-登录数据库并修改密码"><a href="#3-5-12-3-登录数据库并修改密码" class="headerlink" title="3.5.12.3 登录数据库并修改密码"></a>3.5.12.3 登录数据库并修改密码</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mysql</span><br>mysql&gt;flush privileges; （手工加载授权表）<br><span class="hljs-comment">#注意：如果没有手工开启授权表，直接改密码会报错：</span><br>（ERROR 1290 (HY000): The MySQL server is running with the --skip-grant-tables option so it cannot execute this statement）<br><span class="hljs-comment">#输入命令</span><br>mysql&gt;alter user root@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;1（密码）&#x27;</span>;<br>或<br>mysql&gt;grant all on *.* to root@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;1&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="3-5-12-4-退出数据库，并重启数据库"><a href="#3-5-12-4-退出数据库，并重启数据库" class="headerlink" title="3.5.12.4 退出数据库，并重启数据库"></a>3.5.12.4 退出数据库，并重启数据库</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /etc/init.d/mysqld restart</span><br></code></pre></td></tr></table></figure>

<h4 id="3-5-12-5-另一种方法"><a href="#3-5-12-5-另一种方法" class="headerlink" title="3.5.12.5 另一种方法"></a>3.5.12.5 另一种方法</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#修改my.cnf文件，在my.cnf文件中的[mysqld]中添加以下内容</span><br><span class="hljs-comment"># vim /etc/my.cnf</span><br>skip-grant-tables<br><br><span class="hljs-comment">#重启MySQL</span><br><span class="hljs-comment"># systemctl restart mysqld</span><br><br><span class="hljs-comment">#登录数据库，修改root@localhost密码</span><br><span class="hljs-comment"># mysql</span><br><span class="hljs-comment">#第一步</span><br>mysql&gt;flush privileges<br><span class="hljs-comment">#第二部</span><br>mysql&gt;alter user root@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;1（密码）&#x27;</span>;<br>或<br>mysql&gt;grant all on *.* to root@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;1&#x27;</span>;<br><span class="hljs-comment">#第三步</span><br>mysql&gt;flush privileges<br><span class="hljs-comment">#退出mysql</span><br><span class="hljs-comment">#注释在my.cnf中刚刚添加的内容</span><br><span class="hljs-comment"># vim /etc/my.cnf</span><br><span class="hljs-comment">#skip-grant-tables</span><br><br><span class="hljs-comment">#最后重启数据库</span><br><span class="hljs-comment"># systemctl restart mysqld</span><br></code></pre></td></tr></table></figure>



<h2 id="3-6-二进制格式安装-MySQL方式2"><a href="#3-6-二进制格式安装-MySQL方式2" class="headerlink" title="3.6 二进制格式安装 MySQL方式2"></a>3.6 二进制格式安装 MySQL方式2</h2><h3 id="3-6-1准备用户"><a href="#3-6-1准备用户" class="headerlink" title="3.6.1准备用户"></a>3.6.1准备用户</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># groupadd -r -g 306 mysql</span><br><span class="hljs-comment"># useradd -r -g 306 -u 306 -d /data/mysql mysql</span><br></code></pre></td></tr></table></figure>

<h3 id="3-6-2-准备数据目录，建议使用逻辑卷"><a href="#3-6-2-准备数据目录，建议使用逻辑卷" class="headerlink" title="3.6.2 准备数据目录，建议使用逻辑卷"></a>3.6.2 准备数据目录，建议使用逻辑卷</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#可选做，后面的脚本mysql_install_db可自动生成此目录</span><br><span class="hljs-comment"># mkdir /data/mysql</span><br><span class="hljs-comment"># chown mysql:mysql /data/mysql</span><br></code></pre></td></tr></table></figure>

<h3 id="3-6-3-准备二进制程序"><a href="#3-6-3-准备二进制程序" class="headerlink" title="3.6.3 准备二进制程序"></a>3.6.3 准备二进制程序</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tar xf mysql-VERSION-linux-x86_64.tar.gz -C /usr/local</span><br><span class="hljs-comment"># cd /usr/local</span><br><span class="hljs-comment"># ln -sv mysql-VERSION mysql</span><br><span class="hljs-comment"># chown -R root:root /usr/local/mysql/</span><br></code></pre></td></tr></table></figure>

<h3 id="3-6-4-准备配置文件"><a href="#3-6-4-准备配置文件" class="headerlink" title="3.6.4 准备配置文件"></a>3.6.4 准备配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/mysql</span><br><span class="hljs-comment"># cp -b support-files/my-large.cnf  /etc/my.cnf</span><br><span class="hljs-comment"># vim /etc/my.cnf</span><br><span class="hljs-comment">#mysql语句块中添加以下三个选项</span><br>[mysqld]<br>datadir = /data/mysql<br>innodb_file_per_table = on <span class="hljs-comment">#在mariadb5.5以上版的是默认值，可不加</span><br>skip_name_resolve = on   <span class="hljs-comment">#禁止主机名解析，建议使用</span><br></code></pre></td></tr></table></figure>

<h3 id="3-6-5-创建数据库文件"><a href="#3-6-5-创建数据库文件" class="headerlink" title="3.6.5 创建数据库文件"></a>3.6.5 创建数据库文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/mysql/</span><br><span class="hljs-comment"># ./scripts/mysql_install_db --datadir=/data/mysql --user=mysql</span><br><br><span class="hljs-comment"># ls /data/mysql/ -l</span><br>total 110604<br>-rw-rw---- 1 mysql mysql 12582912 Jun  1 16:44 ibdata1<br>-rw-rw---- 1 mysql mysql 50331648 Jun  1 16:44 ib_logfile0<br>-rw-rw---- 1 mysql mysql 50331648 Jun  1 16:44 ib_logfile1<br>drwx------ 2 mysql mysql   4096 Jun  1 16:44 mysql<br>drwx------ 2 mysql mysql   4096 Jun  1 16:44 performance_schema<br>drwx------ 2 mysql mysql   4096 Jun  1 16:44 <span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure>

<h3 id="3-6-6-准备服务脚本，并启动服务"><a href="#3-6-6-准备服务脚本，并启动服务" class="headerlink" title="3.6.6 准备服务脚本，并启动服务"></a>3.6.6 准备服务脚本，并启动服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp ./support-files/mysql.server /etc/rc.d/init.d/mysqld</span><br><span class="hljs-comment"># chkconfig --add mysqld</span><br><span class="hljs-comment"># service mysqld start</span><br><span class="hljs-comment">#如果有对应的service 文件可以执行下面</span><br><span class="hljs-comment"># cp support-files/systemd/mariadb.service /usr/lib/systemd/system/</span><br><span class="hljs-comment"># systemctl daemon-reload</span><br><span class="hljs-comment"># systemctl enable --now mariadb</span><br></code></pre></td></tr></table></figure>

<h3 id="3-6-7-PATH路径"><a href="#3-6-7-PATH路径" class="headerlink" title="3.6.7 PATH路径"></a>3.6.7 PATH路径</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># echo &#x27;PATH=/user/local/mysql/bin:$PATH&#x27; &gt; /etc/profile.d/mysql.sh</span><br><span class="hljs-comment"># . /etc/profile.d/mysql.sh</span><br></code></pre></td></tr></table></figure>

<h3 id="3-6-8-安全初始化"><a href="#3-6-8-安全初始化" class="headerlink" title="3.6.8 安全初始化"></a>3.6.8 安全初始化</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/user/<span class="hljs-built_in">local</span>/mysql/bin/mysql_secure_installation<br></code></pre></td></tr></table></figure>

<h2 id="3-7-实战案例：一键安装mysql-5-6二进制包的脚本"><a href="#3-7-实战案例：一键安装mysql-5-6二进制包的脚本" class="headerlink" title="3.7 实战案例：一键安装mysql-5.6二进制包的脚本"></a>3.7 实战案例：一键安装mysql-5.6二进制包的脚本</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim install_mysql5.6.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>DIR=`<span class="hljs-built_in">pwd</span>`<br>NAME=<span class="hljs-string">&quot;mysql-5.6.47-linux-glibc2.12-x86_64.tar.gz&quot;</span><br>FULL_NAME=<span class="hljs-variable">$&#123;DIR&#125;</span>/<span class="hljs-variable">$&#123;NAME&#125;</span><br>DATA_DIR=<span class="hljs-string">&quot;/data/mysql&quot;</span><br><br>yum install -y libaio perl-Data-Dumper <br><br><span class="hljs-keyword">if</span> [ -f <span class="hljs-variable">$&#123;FULL_NAME&#125;</span> ];<span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装文件存在&quot;</span><br><span class="hljs-keyword">else</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装文件不存在&quot;</span><br>  <span class="hljs-built_in">exit</span> 3<br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">if</span> [ -h /usr/<span class="hljs-built_in">local</span>/mysql ];<span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Mysql 已经安装&quot;</span><br>  <span class="hljs-built_in">exit</span> 3<br><span class="hljs-keyword">else</span><br>  tar xvf <span class="hljs-variable">$&#123;FULL_NAME&#125;</span>  -C /usr/<span class="hljs-built_in">local</span>/src<br>  ln -sv /usr/<span class="hljs-built_in">local</span>/src/mysql-5.6.47-linux-glibc2.12-x86_64 /usr/<span class="hljs-built_in">local</span>/mysql<br>  <br>  <span class="hljs-keyword">if</span> id mysql;<span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;mysql 用户已经存在，跳过创建用户过程&quot;</span><br>  <span class="hljs-keyword">else</span><br>    useradd  -r  -s /sbin/nologin mysql<br>  <span class="hljs-keyword">fi</span><br>  <br>  <span class="hljs-keyword">if</span> id mysql;<span class="hljs-keyword">then</span><br>    chown  -R mysql.mysql /usr/<span class="hljs-built_in">local</span>/mysql/*<br>    <span class="hljs-keyword">if</span> [ ! -d /data/mysql ];<span class="hljs-keyword">then</span><br>      mkdir -pv /data/mysql &amp;&amp; chown  -R mysql.mysql /data  -R /usr/<span class="hljs-built_in">local</span>/mysql/scripts/mysql_install_db  --user=mysql --datadir=/data/mysql  --basedir=/usr/<span class="hljs-built_in">local</span>/mysql/<br>      cp /usr/<span class="hljs-built_in">local</span>/src/mysql-5.6.47-linux-glibc2.12-x86_64/support-<br>files/mysql.server /etc/init.d/mysqld<br>      chmod a+x /etc/init.d/mysqld<br>      cp <span class="hljs-variable">$&#123;DIR&#125;</span>/my.cnf  /etc/my.cnf<br>      ln -sv /usr/<span class="hljs-built_in">local</span>/mysql/bin/mysql /usr/bin/mysql<br>      /etc/init.d/mysqld start<br>      chkconfig --add mysqld<br><span class="hljs-keyword">else</span><br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;MySQL数据目录已经存在,&quot;</span><br>      <span class="hljs-built_in">exit</span> 3<br>    <span class="hljs-keyword">fi</span><br>  <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># cat /etc/my.cnf</span><br>[mysqld]<br>socket=/data/mysql.sock<br>user=mysql<br>symbolic-links=0<br>datadir=/data/mysql<br>innodb_file_per_table=1<br>[client]<br>port=3306<br>socket=/data/mysql.sock<br>[mysqld_safe]<br>log-error=/var/<span class="hljs-built_in">log</span>/mysqld.log<br>pid-file=/tmp/mysql.sock<br><br><span class="hljs-comment"># ls</span><br>install_mysql5.6.sh my.cnf mysql-5.6.47-linux-glibc2.12-x86_64.tar.gz<br></code></pre></td></tr></table></figure>

<h2 id="3-8-实战案例：二进制安装安装MySQL-5-7-和-MySQL8-0"><a href="#3-8-实战案例：二进制安装安装MySQL-5-7-和-MySQL8-0" class="headerlink" title="3.8 实战案例：二进制安装安装MySQL 5.7 和 MySQL8.0"></a>3.8 实战案例：二进制安装安装MySQL 5.7 和 MySQL8.0</h2><h3 id="3-8-1-安装相关包"><a href="#3-8-1-安装相关包" class="headerlink" title="3.8.1 安装相关包"></a>3.8.1 安装相关包</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum  -y install libaio numactl-libs</span><br></code></pre></td></tr></table></figure>

<h3 id="3-8-2-用户和组"><a href="#3-8-2-用户和组" class="headerlink" title="3.8.2 用户和组"></a>3.8.2 用户和组</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># groupadd mysql</span><br><span class="hljs-comment"># useradd -r -g mysql -s /bin/false mysql</span><br></code></pre></td></tr></table></figure>

<h3 id="3-8-3-准备程序文件"><a href="#3-8-3-准备程序文件" class="headerlink" title="3.8.3 准备程序文件"></a>3.8.3 准备程序文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tar xf mysql-5.7.29-linux-glibc2.12-x86_64.tar.gz -C /usr/local</span><br><span class="hljs-comment"># cd /usr/local/</span><br><span class="hljs-comment"># ln -s mysql-5.7.29-linux-glibc2.12-x86_64/ mysql</span><br><span class="hljs-comment"># chown -R root.root /usr/local/mysql/</span><br></code></pre></td></tr></table></figure>

<h3 id="3-8-4-准备环境变量"><a href="#3-8-4-准备环境变量" class="headerlink" title="3.8.4 准备环境变量"></a>3.8.4 准备环境变量</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># echo &#x27;PATH=/usr/local/mysql/bin:$PATH&#x27; &gt; /etc/profile.d/mysql.sh</span><br><span class="hljs-comment"># . /etc/profile.d/mysql.sh</span><br></code></pre></td></tr></table></figure>

<h3 id="3-8-5-准备配置文件"><a href="#3-8-5-准备配置文件" class="headerlink" title="3.8.5 准备配置文件"></a>3.8.5 准备配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp /etc/my.cnf&#123;,.bak&#125;</span><br><span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>datadir=/data/mysql<br>skip_name_resolve=1<br>socket=/data/mysql/mysql.sock    <br>log-error=/data/mysql/mysql.log<br>pid-file=/data/mysql/mysql.pid<br></code></pre></td></tr></table></figure>

<h3 id="3-8-6-生成数据库文件-并提取root密码"><a href="#3-8-6-生成数据库文件-并提取root密码" class="headerlink" title="3.8.6 生成数据库文件,并提取root密码"></a>3.8.6 生成数据库文件,并提取root密码</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#三种方式提取root密码</span><br><span class="hljs-comment"># mysqld --initialize --user=mysql --datadir=/data/mysql</span><br>...省略...<br>2019-07-04T13:03:54.258140Z 1 [Note] A temporary password is generated <span class="hljs-keyword">for</span> root@localhost: LufavlMka6,!  <span class="hljs-comment">#注意生成root的初始密码</span><br><br><span class="hljs-comment"># grep password /data/mysql/mysql.log</span><br>2019-12-26T13:31:30.458826Z 1 [Note] A temporary password is generated <span class="hljs-keyword">for</span><br>root@localhost: LufavlMka6,!<br><br><span class="hljs-comment"># awk &#x27;/temporary password/&#123;print $NF&#125;&#x27; /data/mysql/mysql.log</span><br>LufavlMka6,!<br></code></pre></td></tr></table></figure>

<h3 id="3-8-7-准备服务脚本和启动"><a href="#3-8-7-准备服务脚本和启动" class="headerlink" title="3.8.7 准备服务脚本和启动"></a>3.8.7 准备服务脚本和启动</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="hljs-comment"># chkconfig --add mysqld</span><br><span class="hljs-comment"># service mysqld start</span><br></code></pre></td></tr></table></figure>

<h3 id="3-8-8-修改口令"><a href="#3-8-8-修改口令" class="headerlink" title="3.8.8 修改口令"></a>3.8.8 修改口令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqladmin -uroot -p<span class="hljs-string">&#x27;LufavlMka6,!&#x27;</span>  password 123456<br></code></pre></td></tr></table></figure>

<h3 id="3-8-9-测试登录"><a href="#3-8-9-测试登录" class="headerlink" title="3.8.9 测试登录"></a>3.8.9 测试登录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql -uroot -p123456<br></code></pre></td></tr></table></figure>

<h2 id="3-9-一键安装MySQL5-7-和-MySQL8-0-二进制包的脚本"><a href="#3-9-一键安装MySQL5-7-和-MySQL8-0-二进制包的脚本" class="headerlink" title="3.9 一键安装ＭySQL5.7 和 MySQL8.0 二进制包的脚本"></a>3.9 一键安装ＭySQL5.7 和 MySQL8.0 二进制包的脚本</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#MySQL5.7 Download URL: https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.29-linux-glibc2.12-x86_64.tar.gz</span><br><span class="hljs-comment">#MySQL8.0 Download URL:</span><br>https://downloads.mysql.com/archives/get/p/23/file/mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz<br><br>. /etc/init.d/<span class="hljs-built_in">functions</span><br>SRC_DIR=`<span class="hljs-built_in">pwd</span>`<br><span class="hljs-comment">#MYSQL=&#x27;mysql-5.7.29-linux-glibc2.12-x86_64.tar.gz&#x27;</span><br>MYSQL=<span class="hljs-string">&#x27;mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz&#x27;</span><br>COLOR=<span class="hljs-string">&#x27;echo -e \E[01;31m&#x27;</span><br>END=<span class="hljs-string">&#x27;\E[0m&#x27;</span><br>MYSQL_ROOT_PASSWORD=123456<br><br><span class="hljs-function"><span class="hljs-title">check</span></span> ()&#123;<br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$UID</span> -ne 0 ]; <span class="hljs-keyword">then</span><br>  action <span class="hljs-string">&quot;当前用户不是root,安装失败&quot;</span> <span class="hljs-literal">false</span><br>   <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">cd</span>  <span class="hljs-variable">$SRC_DIR</span><br><br><span class="hljs-keyword">if</span> [ !  -e <span class="hljs-variable">$MYSQL</span> ];<span class="hljs-keyword">then</span><br>  <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;缺少<span class="hljs-variable">$&#123;MYSQL&#125;</span>文件&quot;</span><span class="hljs-variable">$END</span><br>  <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;请将相关软件放在<span class="hljs-variable">$&#123;SRC_DIR&#125;</span>目录下&quot;</span><span class="hljs-variable">$END</span><br>  <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">elif</span> [ -e /usr/<span class="hljs-built_in">local</span>/mysql ];<span class="hljs-keyword">then</span><br>  action <span class="hljs-string">&quot;数据库已存在，安装失败&quot;</span> <span class="hljs-literal">false</span><br>  <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">else</span><br>  <span class="hljs-built_in">return</span><br><span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">install_mysql</span></span>()&#123;<br>  <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;开始安装MySQL数据库...&quot;</span><span class="hljs-variable">$END</span><br>  yum  -y -q install libaio numactl-libs &amp;&gt; /dev/null<br>  <span class="hljs-built_in">cd</span> <span class="hljs-variable">$SRC_DIR</span><br>  tar xf <span class="hljs-variable">$MYSQL</span> -C /usr/<span class="hljs-built_in">local</span>/<br>  MYSQL_DIR=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MYSQL</span>| sed -nr <span class="hljs-string">&#x27;s/^(.*[0-9]).*/\1/p&#x27;</span>`<br>  ln -s /usr/<span class="hljs-built_in">local</span>/<span class="hljs-variable">$MYSQL_DIR</span> /usr/<span class="hljs-built_in">local</span>/mysql<br>  chown -R root.root /usr/<span class="hljs-built_in">local</span>/mysql/<br>  id mysql &amp;&gt; /dev/null || &#123; useradd -s /sbin/nologin -r mysql ; action <span class="hljs-string">&quot;创建mysql用户&quot;</span>; &#125;<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;PATH=/usr/local/mysql/bin/:$PATH&#x27;</span> &gt; /etc/profile.d/mysql.sh<br>  . /etc/profile.d/mysql.sh<br>  ln -s /usr/<span class="hljs-built_in">local</span>/mysql/bin/* /usr/bin/<br>  cat &gt; /etc/my.cnf &lt;&lt;-<span class="hljs-string">EOF</span><br><span class="hljs-string">[mysqld]</span><br><span class="hljs-string">server-id=1</span><br><span class="hljs-string">log-bin</span><br><span class="hljs-string">datadir=/data/mysql</span><br><span class="hljs-string">socket=/data/mysql/mysql.sock                         </span><br><span class="hljs-string">                       </span><br><span class="hljs-string">log-error=/data/mysql/mysql.log</span><br><span class="hljs-string">pid-file=/data/mysql/mysql.pid</span><br><span class="hljs-string">[client]</span><br><span class="hljs-string">socket=/data/mysql/mysql.sock</span><br><span class="hljs-string">EOF</span><br>  [ -d /data ] || mkdir /data<br>  mysqld --initialize --user=mysql --datadir=/data/mysql<br>  cp /usr/<span class="hljs-built_in">local</span>/mysql/support-files/mysql.server /etc/init.d/mysqld<br>  chkconfig --add mysqld<br>  chkconfig mysqld on<br>  service mysqld start<br>  [ $? -ne 0 ] &amp;&amp; &#123; <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;数据库启动失败，退出!&quot;</span><span class="hljs-variable">$END</span>;<span class="hljs-built_in">exit</span>; &#125;<br>  MYSQL_OLDPASSWORD=`awk <span class="hljs-string">&#x27;/A temporary password/&#123;print $NF&#125;&#x27;</span> /data/mysql/mysql.log`<br>  mysqladmin  -uroot -p<span class="hljs-variable">$MYSQL_OLDPASSWORD</span> password <span class="hljs-variable">$MYSQL_ROOT_PASSWORD</span> &amp;&gt; /dev/null<br>  action <span class="hljs-string">&quot;数据库安装完成&quot;</span><br>&#125;<br><br>check<br>install_mysql<br></code></pre></td></tr></table></figure>

<h2 id="3-10-源码编译安装-mariadb"><a href="#3-10-源码编译安装-mariadb" class="headerlink" title="3.10 源码编译安装 mariadb"></a>3.10 源码编译安装 mariadb</h2><p><strong>建议：内存4G以上</strong></p>
<h3 id="3-10-1-安装相关依赖包"><a href="#3-10-1-安装相关依赖包" class="headerlink" title="3.10.1 安装相关依赖包"></a>3.10.1 安装相关依赖包</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum -y install gcc gcc-c++ cmake bison bison-devel zlib-devel libcurl-devel libarchive-devel boost-devel  ncurses-devel gnutls-devel libxml2-devel openssl-devel libevent-devel libaio-devel</span><br></code></pre></td></tr></table></figure>

<h3 id="3-10-2-做准备用户和数据目录"><a href="#3-10-2-做准备用户和数据目录" class="headerlink" title="3.10.2 做准备用户和数据目录"></a>3.10.2 做准备用户和数据目录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># useradd -r -s /sbin/nologin -d /data/mysql mysql</span><br></code></pre></td></tr></table></figure>

<h3 id="3-10-3-准备数据库目录"><a href="#3-10-3-准备数据库目录" class="headerlink" title="3.10.3 准备数据库目录"></a>3.10.3 准备数据库目录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir  /data/mysql</span><br><span class="hljs-comment"># chown mysql.mysql /data/mysql</span><br></code></pre></td></tr></table></figure>

<h3 id="3-10-4-源码编译安装"><a href="#3-10-4-源码编译安装" class="headerlink" title="3.10.4 源码编译安装"></a>3.10.4 源码编译安装</h3><p><strong>编译安装说明</strong></p>
<p>利用cmake编译,而利用传统方法，cmake的重要特性之一是其独立于源码(out-of-source)的编译功能，即编译工作可以在另一个指定的目录中而非源码目录中进行，这可以保证源码目录不受任何一次编译的影响，因此在同一个源码树上可以进行多次不同的编译，如针对于不同平台编译</p>
<p>编译选项:<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/source-configuration-options.html">https://dev.mysql.com/doc/refman/5.7/en/source-configuration-options.html</a></p>
<h4 id="3-10-4-1-下载并解压缩源码包"><a href="#3-10-4-1-下载并解压缩源码包" class="headerlink" title="3.10.4.1 下载并解压缩源码包"></a>3.10.4.1 下载并解压缩源码包</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tar xvf mariadb-10.2.18.tar.gz</span><br></code></pre></td></tr></table></figure>

<h4 id="3-10-4-2-源码编译安装mariadb"><a href="#3-10-4-2-源码编译安装mariadb" class="headerlink" title="3.10.4.2 源码编译安装mariadb"></a>3.10.4.2 源码编译安装mariadb</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd mariadb-10.2.18/</span><br><span class="hljs-comment"># cmake . \</span><br>-DCMAKE_INSTALL_PREFIX=/app/mysql \<br>-DMYSQL_DATADIR=/data/mysql/ \<br>-DSYSCONFDIR=/etc/ \<br>-DMYSQL_USER=mysql \<br>-DWITH_INNOBASE_STORAGE_ENGINE=1 \<br>-DWITH_ARCHIVE_STORAGE_ENGINE=1 \<br>-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \<br>-DWITH_PARTITION_STORAGE_ENGINE=1 \<br>-DWITHOUT_MROONGA_STORAGE_ENGINE=1 \<br>-DWITH_DEBUG=0 \<br>-DWITH_READLINE=1 \<br>-DWITH_SSL=system \<br>-DWITH_ZLIB=system \<br>-DWITH_LIBWRAP=0 \<br>-DENABLED_LOCAL_INFILE=1 \<br>-DMYSQL_UNIX_ADDR=/data/mysql/mysql.sock \<br>-DDEFAULT_CHARSET=utf8 \<br>-DDEFAULT_COLLATION=utf8_general_ci<br><span class="hljs-comment"># make &amp;&amp; make install</span><br></code></pre></td></tr></table></figure>

<p><strong>提示：如果出错，执行rm -f CMakeCache.txt</strong></p>
<h3 id="3-10-5-准备环境变量"><a href="#3-10-5-准备环境变量" class="headerlink" title="3.10.5 准备环境变量"></a>3.10.5 准备环境变量</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># echo &#x27;PATH=/app/mysql/bin:$PATH&#x27; &gt; /etc/profile.d/mysql.sh</span><br><span class="hljs-comment"># . /etc/profile.d/mysql.sh</span><br></code></pre></td></tr></table></figure>

<h3 id="3-10-6-生成数据库文件"><a href="#3-10-6-生成数据库文件" class="headerlink" title="3.10.6 生成数据库文件"></a>3.10.6 生成数据库文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd  /app/mysql/</span><br><span class="hljs-comment"># scripts/mysql_install_db --datadir=/data/mysql/ --user=mysql</span><br></code></pre></td></tr></table></figure>

<h3 id="3-10-7-准备启动脚本-并启动服务"><a href="#3-10-7-准备启动脚本-并启动服务" class="headerlink" title="3.10.7 准备启动脚本,并启动服务"></a>3.10.7 准备启动脚本,并启动服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp /app/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="hljs-comment"># chkconfig --add mysqld</span><br><span class="hljs-comment"># service mysqld start</span><br></code></pre></td></tr></table></figure>

<h3 id="3-10-8-安全初始化"><a href="#3-10-8-安全初始化" class="headerlink" title="3.10.8 安全初始化"></a>3.10.8 安全初始化</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mysql_secure_installation</span><br></code></pre></td></tr></table></figure>



<h1 id="四、MySQL体系结构与基础管理"><a href="#四、MySQL体系结构与基础管理" class="headerlink" title="四、MySQL体系结构与基础管理"></a>四、MySQL体系结构与基础管理</h1><h2 id="4-1-MySQL-C-S结构介绍"><a href="#4-1-MySQL-C-S结构介绍" class="headerlink" title="4.1 MySQL C/S结构介绍 ***"></a>4.1 MySQL C/S结构介绍 ***</h2><p>mysql的两种连接方式：</p>
<ul>
<li>使用TCP/IP连接MySQL：mysql -uroot -poldboy123 -h 10.0.0.51 -P3306</li>
<li>使用Socket连接MySQL：mysql -uroot -poldboy123 -S /tmp/mysql.sock </li>
</ul>
<h2 id="4-2-MySQL实例的构成"><a href="#4-2-MySQL实例的构成" class="headerlink" title="4.2 MySQL实例的构成 ***"></a>4.2 MySQL实例的构成 ***</h2><p>公司： 老板 + 经理 + 员工 + 办公区</p>
<p>实例： mysqld + master thread  + 干活的Thread + 预分配的内存 </p>
<h2 id="4-3-MySQL中mysqld服务器进程结构"><a href="#4-3-MySQL中mysqld服务器进程结构" class="headerlink" title="4.3 MySQL中mysqld服务器进程结构"></a>4.3 MySQL中mysqld服务器进程结构</h2><h3 id="4-3-1-mysqld程序结构"><a href="#4-3-1-mysqld程序结构" class="headerlink" title="4.3.1 mysqld程序结构"></a>4.3.1 mysqld程序结构</h3><p><img src="file:///C:\Users\kinci\AppData\Local\Temp\ksohtml\wps3771.tmp.png" srcset="/blog/img/loading.gif" alt="img"> </p>
<h3 id="4-3-2-应用程序输入"><a href="#4-3-2-应用程序输入" class="headerlink" title="4.3.2 应用程序输入"></a>4.3.2 应用程序输入</h3><p><strong>（这里代表了4.3.1图中的应用程序的输入）</strong></p>
<p>应用程序输入SQL语句结构化的查询语言 </p>
<p>SQL语句分别是：</p>
<p>DQL  数据查询(query)语言</p>
<p>DDL  数据定义(definition)语言</p>
<p>DML  数据操作(manipulate)语言</p>
<p>DCL  数据控制(control)语言</p>
<h3 id="4-3-3-mysqld连接层作用"><a href="#4-3-3-mysqld连接层作用" class="headerlink" title="4.3.3 mysqld连接层作用"></a>4.3.3 mysqld连接层作用</h3><p><strong>（这里代表了4.3.1图中的连接层）</strong></p>
<ol>
<li>提供连接协议</li>
</ol>
<p>​        Socket </p>
<p>​        TCPIP</p>
<ol start="2">
<li><p>验证用户名（root@localhost）密码合法性，进行匹配专门的授权表。</p>
</li>
<li><p>派生一个专用连接线程（接收SQL，返回结果）</p>
</li>
</ol>
<p>​         mysql&gt; show processlist;</p>
<ol start="4">
<li>思考： 忘记密码的参数在哪做的手脚？</li>
</ol>
<p>​                    –skip-grant-tables</p>
<p>​                    –skip-networking</p>
<h3 id="4-3-4-mysqldSQL层作用（优化方面至关重要的）"><a href="#4-3-4-mysqldSQL层作用（优化方面至关重要的）" class="headerlink" title="4.3.4 mysqldSQL层作用（优化方面至关重要的）"></a>4.3.4 mysqldSQL层作用（优化方面至关重要的）</h3><p><strong>（这里代表了4.3.1图中的SQL层）</strong></p>
<ol>
<li>验证SQL语法和SQL_MODE.</li>
<li>验证语义</li>
<li>验证权限</li>
<li>解析器进行语句解析，生成执行计划（解析树）</li>
<li>优化器（各种算法，基于执行代价），根据算法，找到代价最低的执行计划。</li>
</ol>
<p>​        代价：CPU IO MEM</p>
<ol start="6">
<li><p>执行器按照优化器选择执行计划，执行SQL语句，得出获取数据的方法。</p>
</li>
<li><p>提供query cache(默认不开)，一般不开，会用redis</p>
</li>
<li><p>记录操作日志（binlog），默认没开</p>
</li>
</ol>
<h3 id="4-3-5-存储引擎层"><a href="#4-3-5-存储引擎层" class="headerlink" title="4.3.5 存储引擎层"></a>4.3.5 存储引擎层</h3><p><strong>（这里代表了4.3.1图中的存储引擎层）</strong></p>
<p>存储引擎层是真正和磁盘打交道的一个层次，根据SQL层提供的取数据的方法，拿到数据，返回给SQL，结构化成表，再又连接层线程返回给用户。 </p>
<h2 id="4-4-MySQL逻辑存储结构"><a href="#4-4-MySQL逻辑存储结构" class="headerlink" title="4.4 MySQL逻辑存储结构"></a>4.4 MySQL逻辑存储结构</h2><p>库                                     ≈    Linux目录</p>
<p>create databse wordbpress charset utf8mb4;     ≈    mkdir /wordpress</p>
<p>show databases;                         ≈    ls /</p>
<p>use wordbpress;                         ≈    cd /wordpress</p>
<p>表                                     ≈    Linux文件</p>
<p>列（字段）                                    无</p>
<p>列属性                                        五</p>
<p>数据行（记录）                         ≈    Linux数据行</p>
<p>表属性（元数据）                            ≈    Linux 文件属性 </p>
<h2 id="4-5-MySQL物理存储结构"><a href="#4-5-MySQL物理存储结构" class="headerlink" title="4.5 MySQL物理存储结构"></a>4.5 MySQL物理存储结构</h2><p>库： 使用FileSystem上的目录来表示 </p>
<p>表： </p>
<p>MyISAM(ext2)（数据库引擎）</p>
<ul>
<li><p>user.frm ： 存储的表结构（列，列属性）</p>
</li>
<li><p>user.MYD : 存储的数据记录</p>
</li>
<li><p>user.MYI ： 存储索引 </p>
</li>
</ul>
<p>InnoDB(XFS)（数据库引擎）</p>
<ul>
<li><p>time_zone.frm ： 存储的表结构（列，列属性）</p>
</li>
<li><p>time_zone.ibd ： 存储的数据记录和索引</p>
</li>
<li><p>ibdata1    :  数据字典信息 </p>
</li>
</ul>
<h2 id="4-6-innodb-段-区-页"><a href="#4-6-innodb-段-区-页" class="headerlink" title="4.6 innodb 段 区 页"></a>4.6 innodb 段 区 页</h2><p>一般情况下（非分区表）</p>
<p>一个表就是一个段</p>
<p>一个段由多个区构成</p>
<p>一个区在（16k），64个连续的页，1M大小 </p>
<h2 id="4-7-用户和权限管理"><a href="#4-7-用户和权限管理" class="headerlink" title="4.7 用户和权限管理"></a>4.7 用户和权限管理</h2><h3 id="4-7-1-用户作用"><a href="#4-7-1-用户作用" class="headerlink" title="4.7.1 用户作用"></a>4.7.1 用户作用</h3><p>登录MySQL </p>
<p>管理MySQL </p>
<h3 id="4-7-2-用户的定义"><a href="#4-7-2-用户的定义" class="headerlink" title="4.7.2 用户的定义"></a>4.7.2 用户的定义</h3><p>格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">用户名@&#x27;白名单&#x27;<br></code></pre></td></tr></table></figure>

<p>例子：（可以查看3.4.4节内容）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">wordpress@<span class="hljs-string">&#x27;%&#x27;</span><br>wordpress@<span class="hljs-string">&#x27;localhost&#x27;</span><br>wordpress@<span class="hljs-string">&#x27;127.0.0.1&#x27;</span><br>wordpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span><br>wordpress@<span class="hljs-string">&#x27;10.0.0.5%&#x27;</span><br>wordpress@<span class="hljs-string">&#x27;10.0.0.0/255.255.254.0&#x27;</span><br>wordpress@<span class="hljs-string">&#x27;10.0.%&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="4-7-3-用户的操作"><a href="#4-7-3-用户的操作" class="headerlink" title="4.7.3 用户的操作"></a>4.7.3 用户的操作</h3><h4 id="4-7-3-1-创建用户（增）"><a href="#4-7-3-1-创建用户（增）" class="headerlink" title="4.7.3.1 创建用户（增）"></a>4.7.3.1 创建用户（增）</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; create user rlin@<span class="hljs-string">&#x27;192.168.27.%&#x27;</span> identified by <span class="hljs-string">&#x27;123&#x27;</span>;<br><br>Query OK, 0 rows affected (0.00 sec)<br><br>说明：<br>8.0以前，可以自动创建用户并授权.<br>如：<br>mysql&gt; grant all on *.* to oldguo@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="4-7-3-2-查询用户（查）"><a href="#4-7-3-2-查询用户（查）" class="headerlink" title="4.7.3.2 查询用户（查）"></a>4.7.3.2 查询用户（查）</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; select user,host from mysql.user;<br></code></pre></td></tr></table></figure>

<h4 id="4-7-3-3-修改用户密码（改）"><a href="#4-7-3-3-修改用户密码（改）" class="headerlink" title="4.7.3.3 修改用户密码（改）"></a>4.7.3.3 修改用户密码（改）</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; alter user rlin@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="4-7-3-4-删除用户（删）"><a href="#4-7-3-4-删除用户（删）" class="headerlink" title="4.7.3.4 删除用户（删）"></a>4.7.3.4 删除用户（删）</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; drop user rlin@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> ;<br></code></pre></td></tr></table></figure>

<h3 id="4-7-4-权限管理"><a href="#4-7-4-权限管理" class="headerlink" title="4.7.4 权限管理"></a>4.7.4 权限管理</h3><h4 id="4-7-4-1-权限列表"><a href="#4-7-4-1-权限列表" class="headerlink" title="4.7.4.1 权限列表"></a>4.7.4.1 权限列表</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">#获得全部权限<br><span class="hljs-keyword">ALL</span><br>#获得某种权限<br><span class="hljs-keyword">SELECT</span>,<span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span>, <span class="hljs-keyword">CREATE</span>, <span class="hljs-keyword">DROP</span>, RELOAD, SHUTDOWN, PROCESS, FILE, <span class="hljs-keyword">REFERENCES</span>, <span class="hljs-keyword">INDEX</span>, <span class="hljs-keyword">ALTER</span>, <span class="hljs-keyword">SHOW</span> DATABASES, SUPER, <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLES</span>, <span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLES</span>, <span class="hljs-keyword">EXECUTE</span>, <span class="hljs-keyword">REPLICATION</span> SLAVE, <span class="hljs-keyword">REPLICATION</span> CLIENT, <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span>, <span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">VIEW</span>, <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROUTINE</span>, <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">ROUTINE</span>, <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span>, EVENT, <span class="hljs-keyword">TRIGGER</span>, <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLESPACE</span><br></code></pre></td></tr></table></figure>

<h4 id="4-7-4-2-授权命令"><a href="#4-7-4-2-授权命令" class="headerlink" title="4.7.4.2 授权命令"></a>4.7.4.2 授权命令</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">例子：<br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> rlin@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;123&#x27;</span> <span class="hljs-keyword">with</span> <span class="hljs-keyword">grant</span> <span class="hljs-keyword">option</span>;<br><br>格式：<br><span class="hljs-keyword">grant</span> 权限 <span class="hljs-keyword">on</span> 作用目标（数据库对象） <span class="hljs-keyword">to</span> 用户 identified <span class="hljs-keyword">by</span> 密码 <span class="hljs-keyword">with</span> <span class="hljs-keyword">grant</span> <span class="hljs-keyword">option</span>（用于给别人授权，添加到末尾）;<br><br>解释：<br>作用目标：数据库所有表或数据库下的某个表（如：wordpress.* 或 wordpress.student ）（一般都是使用第一种）<br>如：<br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">SELECT</span>,<span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span>, <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">on</span> wordpress.* <span class="hljs-keyword">to</span> <br><br>作用目标和linxu文件系统对比:<br>*.* 			≈	chomd -R <span class="hljs-number">777</span> /<br>wordpress.* 	≈	chmod -R <span class="hljs-number">777</span> /wordpress<span class="hljs-comment">/*</span><br><span class="hljs-comment">worpress.t1 	≈   chmod -R 777 /wordpress/t1</span><br></code></pre></td></tr></table></figure>

<h4 id="4-7-4-3-授权范例"><a href="#4-7-4-3-授权范例" class="headerlink" title="4.7.4.3 授权范例"></a>4.7.4.3 授权范例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#创建一个管理员用户root，可以通过10网段，管理数据库.</span><br>grant all on *.* to root@<span class="hljs-string">&#x27;192.168.27.%&#x27;</span> identified by <span class="hljs-string">&#x27;123&#x27;</span> with grant option;<br><br><span class="hljs-comment">#创建一个应用用户wordpress，可以通过10网段，wordpress库下的所有表进行SELECT,INSERT, UPDATE, DELETE.</span><br>grant SELECT,INSERT, UPDATE, DELETE on wordpress.* to wordpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="4-7-4-4-查看权限"><a href="#4-7-4-4-查看权限" class="headerlink" title="4.7.4.4 查看权限"></a>4.7.4.4 查看权限</h4><p>格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">Help SHOW GRANTS<br>SHOW GRANTS FOR <span class="hljs-string">&#x27;user&#x27;</span>@<span class="hljs-string">&#x27;host&#x27;</span>;<br>SHOW GRANTS FOR CURRENT_USER[()];<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<p>查看wordpress@’10.0.0.%’权限<br>mysql&gt; show grants for wordpress@’10.0.0.%’;</p>
<p>+—————————————————————————————————————————–+<br>| Grants for <a href="mailto:&#119;&#x6f;&#114;&#x64;&#112;&#114;&#x65;&#115;&#x73;&#x40;&#49;&#x30;&#x2e;&#x30;&#x2e;&#48;">&#119;&#x6f;&#114;&#x64;&#112;&#114;&#x65;&#115;&#x73;&#x40;&#49;&#x30;&#x2e;&#x30;&#x2e;&#48;</a>.%                                                                                                 |<br>+—————————————————————————————————————————–+<br>| GRANT USAGE ON <em>.</em> TO ‘wordpress‘@’10.0.0.%’                                                                       |<br>| GRANT SELECT, INSERT, UPDATE, DELETE ON ‘wordpress’.* TO ‘wordpress‘@’10.0.0.%’ |<br>+—————————————————————————————————————————–+</p>
<p><font color='red'>注意：MariaDB服务进程启动时会读取mysql库中所有授权表至内存</font></p>
<ol>
<li>GRANT或REVOKE等执行权限操作会保存于系统表中，MariaDB的服务进程通常会自动重读授权表，使之生效</li>
<li>对于不能够或不能及时重读授权表的命令，可手动让MariaDB的服务进程重读授权表：mysql&gt;FLUSH PRIVILEGES;</li>
</ol>
<h4 id="4-7-4-5-收回权限"><a href="#4-7-4-5-收回权限" class="headerlink" title="4.7.4.5 收回权限"></a>4.7.4.5 收回权限</h4><p>格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">evoke delete on 作用对象（数据库对象）from <span class="hljs-string">&#x27;用户&#x27;</span>@<span class="hljs-string">&#x27;网段&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<p>mysql&gt; revoke delete on wordpress.* from ‘wordpress‘@’10.0.0.%’;</p>
<p>mysql&gt; show grants for wordpress@’10.0.0.%’;</p>
<p>+—————————————————————————————————————-+</p>
<p>| Grants for <a href="mailto:&#x77;&#x6f;&#114;&#x64;&#x70;&#x72;&#101;&#x73;&#x73;&#64;&#x31;&#48;&#x2e;&#x30;&#46;&#48;">&#x77;&#x6f;&#114;&#x64;&#x70;&#x72;&#101;&#x73;&#x73;&#64;&#x31;&#48;&#x2e;&#x30;&#46;&#48;</a>.%                                                                                 |</p>
<p>+—————————————————————————————————————-+</p>
<p>| GRANT USAGE ON <em>.</em> TO ‘wordpress‘@’10.0.0.%’                                                        |</p>
<p>| GRANT SELECT, INSERT, UPDATE ON ‘wordpress’.* TO ‘wordpress‘@’10.0.0.%’ |</p>
<p>+—————————————————————————————————————–+</p>
<h3 id="4-7-5-关于生产中开用户"><a href="#4-7-5-关于生产中开用户" class="headerlink" title="4.7.5 关于生产中开用户"></a>4.7.5 关于生产中开用户</h3><p>如何沟通开用户</p>
<ol>
<li>是否有邮件批复</li>
<li>对哪些库和表做操作</li>
<li>做什么操作</li>
<li>从什么地址来登录</li>
</ol>
<p>开发人员找你要root用户密码，要如何操作？</p>
<ol>
<li><p>走流程拒绝他</p>
</li>
<li><p>如果是金融类的公司</p>
</li>
</ol>
<p>​    （1）原则上是不允许任何非DBA人员持有或申请root</p>
<p>​    （2）如果有人私下索要root密码，即时举报。</p>
<h2 id="4-8-MySQL的启动和关闭"><a href="#4-8-MySQL的启动和关闭" class="headerlink" title="4.8 MySQL的启动和关闭"></a>4.8 MySQL的启动和关闭</h2><h3 id="4-8-1-启动过程"><a href="#4-8-1-启动过程" class="headerlink" title="4.8.1 启动过程"></a>4.8.1 启动过程</h3><p>mysql启动过程方式1：mysql.server start —&gt; mysqld_safe —&gt; mysqld</p>
<p>解释：</p>
<p>执行mysql.server start (mysqld start)就会启动mysqld_safe最后启动mysqld</p>
<p>mysql启动过程方式2：systemctl start mysql.service —&gt; mysqld</p>
<p>解释：执行systemctl start mysql.service就会直接启动mysqld</p>
<p><strong>注意：所有的启动过程都依赖于 /etc/my.cnf</strong></p>
<h3 id="4-8-2-维护性的任务"><a href="#4-8-2-维护性的任务" class="headerlink" title="4.8.2 维护性的任务"></a>4.8.2 维护性的任务</h3><p>mysqld_safe –skip-grant-tables –skip-networking &amp;</p>
<p>我们一般会将我们需要的参数临时加到命令行.</p>
<p>也会读取/etc/my.cnf的内容,但是如果冲突,命令行优先级最高</p>
<p>使用mysql_safe 开启mysql</p>
<p>mysqld_safe &amp;</p>
<p>关闭（使用以下这种方式关闭）：mysqladmin -uroot -p123 shutdown </p>
<h2 id="4-9-MySQL初始化配置"><a href="#4-9-MySQL初始化配置" class="headerlink" title="4.9 MySQL初始化配置"></a>4.9 MySQL初始化配置</h2><h3 id="4-9-1-初始化配置是作用"><a href="#4-9-1-初始化配置是作用" class="headerlink" title="4.9.1 初始化配置是作用"></a>4.9.1 初始化配置是作用</h3><ol>
<li><p>影响数据库的启动</p>
</li>
<li><p>影响到客户端的功能</p>
</li>
</ol>
<h3 id="4-9-2-初始化配置的方法"><a href="#4-9-2-初始化配置的方法" class="headerlink" title="4.9.2 初始化配置的方法"></a>4.9.2 初始化配置的方法</h3><ol>
<li>初始化配置文件(例如/etc/my.cnf) </li>
<li>启动命令行上进行设置(例如:mysqld_safe mysqld)</li>
<li>预编译时设置(仅限于编译安装时设置)</li>
</ol>
<h3 id="4-9-3-初始化配置文件的书写格式"><a href="#4-9-3-初始化配置文件的书写格式" class="headerlink" title="4.9.3 初始化配置文件的书写格式"></a>4.9.3 初始化配置文件的书写格式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">[标签]<br>xxx=xxx<br>[标签]<br>xxx=xxx<br></code></pre></td></tr></table></figure>

<h3 id="4-9-4-配置文件标签的归类"><a href="#4-9-4-配置文件标签的归类" class="headerlink" title="4.9.4 配置文件标签的归类"></a>4.9.4 配置文件标签的归类</h3><p><strong>服务器端:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">[mysqld]<br>[mysqld_safe]<br>[server]<br></code></pre></td></tr></table></figure>

<p>**客户端: **</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">[mysql]<br>[mysqladmin]<br>[mysqldump]<br>[client]<br></code></pre></td></tr></table></figure>

<h3 id="4-9-5-配置文件设置样板-5-7"><a href="#4-9-5-配置文件设置样板-5-7" class="headerlink" title="4.9.5 配置文件设置样板(5.7)"></a>4.9.5 配置文件设置样板(5.7)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#服务器端配置</span><br>[mysqld]<br><span class="hljs-comment">#用户</span><br>user=mysql<br><span class="hljs-comment">#软件安装目录</span><br>basedir=/application/mysql<br><span class="hljs-comment">#数据路径</span><br>datadir=/data/mysql/data<br><span class="hljs-comment">#socket文件位置</span><br>socket=/tmp/mysql.sock<br><span class="hljs-comment">#服务器id号（1~65535）</span><br>server_id=6<br><span class="hljs-comment">#端口号</span><br>port=3306<br><span class="hljs-comment">#客户端配置</span><br>[mysql]<br><span class="hljs-comment">#socket文件位置</span><br>socket=/tmp/mysql.sock<br></code></pre></td></tr></table></figure>

<h2 id="4-10-配置文件读取顺序-（后面覆盖前面的配置文件）"><a href="#4-10-配置文件读取顺序-（后面覆盖前面的配置文件）" class="headerlink" title="4.10 配置文件读取顺序 （后面覆盖前面的配置文件）"></a>4.10 配置文件读取顺序 （后面覆盖前面的配置文件）</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqld --<span class="hljs-built_in">help</span> --verbose |grep my.cnf （查看配置文件读取路径）<br>/etc/my.cnf --&gt; /etc/mysql/my.cnf --&gt; /usr/<span class="hljs-built_in">local</span>/mysql/etc/my.cnf --&gt; ~/.my.cnf <br></code></pre></td></tr></table></figure>

<h2 id="4-11-强制使用自定义配置文件"><a href="#4-11-强制使用自定义配置文件" class="headerlink" title="4.11 强制使用自定义配置文件"></a>4.11 强制使用自定义配置文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#使用这个参数：--defautls-file </span><br><span class="hljs-comment"># mysqld_safe --defaults-file=/tmp/aa.txt &amp;</span><br></code></pre></td></tr></table></figure>

<h2 id="4-12-MySQL的连接管理"><a href="#4-12-MySQL的连接管理" class="headerlink" title="4.12 MySQL的连接管理"></a>4.12 MySQL的连接管理</h2><h3 id="4-12-1-MySQL连接方式"><a href="#4-12-1-MySQL连接方式" class="headerlink" title="4.12.1 MySQL连接方式"></a>4.12.1 MySQL连接方式</h3><p><strong>（前提条件：提前应该将用户授权做好，先把用户创建了）</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#TCPIP 登录:</span><br><span class="hljs-comment"># mysql -uroot -p -h 10.0.0.51 -P3306 </span><br><span class="hljs-comment">#Socket 登录：</span><br><span class="hljs-comment"># mysql -uroot -p -S /tmp/mysql.sock</span><br><span class="hljs-comment">#使用客户端工具登录</span><br>sqlyog<br>navicat<br></code></pre></td></tr></table></figure>

<h2 id="4-13-Centos7实现MySQL多实例"><a href="#4-13-Centos7实现MySQL多实例" class="headerlink" title="4.13 Centos7实现MySQL多实例"></a>4.13 Centos7实现MySQL多实例</h2><p><strong>这次的实例在已经安装过mysql上的主机上执行，所以某些初始化工作省略</strong></p>
<h3 id="4-13-1-准备多个目录"><a href="#4-13-1-准备多个目录" class="headerlink" title="4.13.1 准备多个目录"></a>4.13.1 准备多个目录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -p /data/330&#123;7,8,9&#125;/data</span><br></code></pre></td></tr></table></figure>

<h3 id="4-13-2-准备配置文件"><a href="#4-13-2-准备配置文件" class="headerlink" title="4.13.2 准备配置文件"></a>4.13.2 准备配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cat &gt; /data/3307/my.cnf &lt;&lt;EOF</span><br>[mysqld]<br>basedir=/application/mysql<br>datadir=/data/3307/data<br>socket=/data/3307/mysql.sock<br>log_error=/data/3307/mysql.log<br>port=3307<br>server_id=7<br>log_bin=/data/3307/mysql-bin<br>EOF<br><br><span class="hljs-comment"># cat &gt; /data/3308/my.cnf &lt;&lt;EOF</span><br>[mysqld]<br>basedir=/application/mysql<br>datadir=/data/3308/data<br>socket=/data/3308/mysql.sock<br>log_error=/data/3308/mysql.log<br>port=3308<br>server_id=8<br>log_bin=/data/3308/mysql-bin<br>EOF<br><br><span class="hljs-comment"># cat &gt; /data/3309/my.cnf &lt;&lt;EOF</span><br>[mysqld]<br>basedir=/application/mysql<br>datadir=/data/3309/data<br>socket=/data/3309/mysql.sock<br>log_error=/data/3309/mysql.log<br>port=3309<br>server_id=9<br>log_bin=/data/3309/mysql-bin<br>EOF<br></code></pre></td></tr></table></figure>

<h3 id="4-13-3-初始化三套数据"><a href="#4-13-3-初始化三套数据" class="headerlink" title="4.13.3 初始化三套数据"></a>4.13.3 初始化三套数据</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mv /etc/my.cnf /etc/my.cnf.bak(将原来安装的my.cnf文件改名，避免初始化的时候会使用到这个文件)</span><br><span class="hljs-comment"># mysqld --initialize-insecure --user=mysql --datadir=/data/3307/data --basedir=/application/mysql</span><br><span class="hljs-comment"># mysqld --initialize-insecure --user=mysql --datadir=/data/3308/data --basedir=/application/mysql</span><br><span class="hljs-comment"># mysqld --initialize-insecure --user=mysql --datadir=/data/3309/data --basedir=/application/mysql</span><br></code></pre></td></tr></table></figure>

<h3 id="4-13-4-systemd管理多实例"><a href="#4-13-4-systemd管理多实例" class="headerlink" title="4.13.4 systemd管理多实例"></a>4.13.4 systemd管理多实例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /etc/systemd/system</span><br><span class="hljs-comment"># cp mysqld.service mysqld3307.service</span><br><span class="hljs-comment"># cp mysqld.service mysqld3308.service</span><br><span class="hljs-comment"># cp mysqld.service mysqld3309.service</span><br><br><span class="hljs-comment"># vim mysqld3307.service</span><br><span class="hljs-comment"># 修改为:</span><br>ExecStart=/application/mysql/bin/mysqld --defaults-file=/data/3307/my.cnf<br><br><span class="hljs-comment"># vim mysqld3308.service</span><br><span class="hljs-comment"># 修改为:</span><br>ExecStart=/application/mysql/bin/mysqld --defaults-file=/data/3308/my.cnf<br><br><span class="hljs-comment"># vim mysqld3309.service</span><br><span class="hljs-comment">#修改为:</span><br>ExecStart=/application/mysql/bin/mysqld --defaults-file=/data/3309/my.cnf<br></code></pre></td></tr></table></figure>

<h3 id="4-13-5-授权"><a href="#4-13-5-授权" class="headerlink" title="4.13.5 授权"></a>4.13.5 授权</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># chown -R mysql.mysql /data/* </span><br></code></pre></td></tr></table></figure>

<h3 id="4-13-6-启动"><a href="#4-13-6-启动" class="headerlink" title="4.13.6 启动"></a>4.13.6 启动</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl start mysqld3307.service</span><br><span class="hljs-comment"># systemctl start mysqld3308.service</span><br><span class="hljs-comment"># systemctl start mysqld3309.service</span><br></code></pre></td></tr></table></figure>

<h3 id="4-13-7-验证多实例"><a href="#4-13-7-验证多实例" class="headerlink" title="4.13.7 验证多实例"></a>4.13.7 验证多实例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># netstat -lnp|grep 330</span><br><span class="hljs-comment"># mysql -S /data/3307/mysql.sock -e &quot;select @@server_id&quot;</span><br><span class="hljs-comment"># mysql -S /data/3308/mysql.sock -e &quot;select @@server_id&quot;</span><br><span class="hljs-comment"># mysql -S /data/3309/mysql.sock -e &quot;select @@server_id&quot;</span><br></code></pre></td></tr></table></figure>

<h2 id="4-14-Centos6-MySQL多实例"><a href="#4-14-Centos6-MySQL多实例" class="headerlink" title="4.14 Centos6 MySQL多实例"></a>4.14 Centos6 MySQL多实例</h2><p><strong>这次的实例在已经安装过mysql上的主机上执行，所以某些初始化工作省略</strong></p>
<h3 id="4-14-1-准备多个目录"><a href="#4-14-1-准备多个目录" class="headerlink" title="4.14.1 准备多个目录"></a>4.14.1 准备多个目录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -p /data/330&#123;7,8,9&#125;/data</span><br></code></pre></td></tr></table></figure>

<h3 id="4-14-2-准备配置文件"><a href="#4-14-2-准备配置文件" class="headerlink" title="4.14.2 准备配置文件"></a>4.14.2 准备配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cat &gt; /data/3307/my.cnf &lt;&lt;EOF</span><br>[mysqld]<br>basedir=/application/mysql<br>datadir=/data/3307/data<br>socket=/data/3307/mysql.sock<br>log_error=/data/3307/mysql.log<br>port=3307<br>server_id=7<br>log_bin=/data/3307/mysql-bin<br>EOF<br><br><span class="hljs-comment"># cat &gt; /data/3308/my.cnf &lt;&lt;EOF</span><br>[mysqld]<br>basedir=/application/mysql<br>datadir=/data/3308/data<br>socket=/data/3308/mysql.sock<br>log_error=/data/3308/mysql.log<br>port=3308<br>server_id=8<br>log_bin=/data/3308/mysql-bin<br>EOF<br><br><span class="hljs-comment"># cat &gt; /data/3309/my.cnf &lt;&lt;EOF</span><br>[mysqld]<br>basedir=/application/mysql<br>datadir=/data/3309/data<br>socket=/data/3309/mysql.sock<br>log_error=/data/3309/mysql.log<br>port=3309<br>server_id=9<br>log_bin=/data/3309/mysql-bin<br>EOF<br></code></pre></td></tr></table></figure>

<h3 id="4-14-3-初始化三套数据"><a href="#4-14-3-初始化三套数据" class="headerlink" title="4.14.3 初始化三套数据"></a>4.14.3 初始化三套数据</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mv /etc/my.cnf /etc/my.cnf.bak</span><br><span class="hljs-comment"># mysqld --initialize-insecure --user=mysql --datadir=/data/3307/data --basedir=/application/mysql</span><br><span class="hljs-comment"># mysqld --initialize-insecure --user=mysql --datadir=/data/3308/data --basedir=/application/mysql</span><br><span class="hljs-comment"># mysqld --initialize-insecure --user=mysql --datadir=/data/3309/data --basedir=/application/mysql</span><br></code></pre></td></tr></table></figure>

<h3 id="4-14-4-复制启动脚本到-etc-init-d"><a href="#4-14-4-复制启动脚本到-etc-init-d" class="headerlink" title="4.14.4 复制启动脚本到/etc/init.d/"></a>4.14.4 复制启动脚本到/etc/init.d/</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp /application/mysql/support-files/mysql.server /etc/init.d/mysqld3307</span><br><span class="hljs-comment"># cp /application/mysql/support-files/mysql.server /etc/init.d/mysqld3308</span><br><span class="hljs-comment"># cp /application/mysql/support-files/mysql.server /etc/init.d/mysqld3308</span><br></code></pre></td></tr></table></figure>

<h3 id="4-14-5-修改3启动脚本启动脚本"><a href="#4-14-5-修改3启动脚本启动脚本" class="headerlink" title="4.14.5 修改3启动脚本启动脚本"></a>4.14.5 修改3启动脚本启动脚本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/init.d/mysqld330（7，8，9）<br>第47行 datadir= 改为 datadir=/data/330(7,8,9)/data <br>第63行 mysqld_pid_file_path= 改为 mysqld_pid_file_path=<span class="hljs-variable">$datadir</span>/`hostname`.pid <br>第266行 <span class="hljs-variable">$bindir</span>/mysqld_safe --datadir=<span class="hljs-string">&quot;<span class="hljs-variable">$datadir</span>&quot;</span> --pid-file=<span class="hljs-string">&quot;<span class="hljs-variable">$mysqld_pid_file_path</span>&quot;</span> <span class="hljs-variable">$other_args</span> &gt;/dev/null &amp; 修改为 <span class="hljs-variable">$bindir</span>/mysqld_safe --defaults-file=/data/330(7,8,9)/my.cnf --pid-file=<span class="hljs-string">&quot;<span class="hljs-variable">$mysqld_pid_file_path</span>&quot;</span> <span class="hljs-variable">$other_args</span> &gt;/dev/null &amp;<br></code></pre></td></tr></table></figure>

<h3 id="4-14-6-创建mysql-log"><a href="#4-14-6-创建mysql-log" class="headerlink" title="4.14.6 创建mysql.log"></a>4.14.6 创建mysql.log</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># touch /data/330&#123;7,8,9&#125;/mysql.log</span><br></code></pre></td></tr></table></figure>

<h3 id="4-14-7-授权"><a href="#4-14-7-授权" class="headerlink" title="4.14.7 授权"></a>4.14.7 授权</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># chown -R mysql.mysql /data/*</span><br></code></pre></td></tr></table></figure>

<h3 id="4-14-8-启动mysqld"><a href="#4-14-8-启动mysqld" class="headerlink" title="4.14.8 启动mysqld"></a>4.14.8 启动mysqld</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># service mysqld3307 start</span><br><span class="hljs-comment"># service mysqld3308 start</span><br><span class="hljs-comment"># service mysqld3309 start</span><br></code></pre></td></tr></table></figure>

<h3 id="4-14-9-验证多实例"><a href="#4-14-9-验证多实例" class="headerlink" title="4.14.9 验证多实例"></a>4.14.9 验证多实例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># netstat -lnp|grep 330</span><br><span class="hljs-comment"># mysql -S /data/3307/mysql.sock -e &quot;select @@server_id&quot;</span><br><span class="hljs-comment"># mysql -S /data/3308/mysql.sock -e &quot;select @@server_id&quot;</span><br><span class="hljs-comment"># mysql -S /data/3309/mysql.sock -e &quot;select @@server_id&quot;</span><br></code></pre></td></tr></table></figure>

<p><strong>注意：此时密码还是空的</strong></p>
<h2 id="4-15-Centos8-Mariadb多实例"><a href="#4-15-Centos8-Mariadb多实例" class="headerlink" title="4.15 Centos8 Mariadb多实例"></a>4.15 Centos8 Mariadb多实例</h2><h3 id="4-15-1-实验目的"><a href="#4-15-1-实验目的" class="headerlink" title="4.15.1 实验目的"></a>4.15.1 实验目的</h3><p> CentOS 8 yum安装mariadb-10.3.17并实现三个实例</p>
<h3 id="4-15-2-环境要求"><a href="#4-15-2-环境要求" class="headerlink" title="4.15.2 环境要求"></a>4.15.2 环境要求</h3><p>一台系统CentOS 8.X主机</p>
<h3 id="4-15-3-前提准备"><a href="#4-15-3-前提准备" class="headerlink" title="4.15.3 前提准备"></a>4.15.3 前提准备</h3><p>关闭SElinux<br>关闭防火墙<br>时间同步</p>
<h3 id="4-15-4-实现步骤"><a href="#4-15-4-实现步骤" class="headerlink" title="4.15.4 实现步骤"></a>4.15.4 实现步骤</h3><h4 id="4-15-4-1-安装mariadb"><a href="#4-15-4-1-安装mariadb" class="headerlink" title="4.15.4.1  安装mariadb"></a>4.15.4.1  安装mariadb</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum -y install mariadb-server</span><br></code></pre></td></tr></table></figure>

<h4 id="4-15-4-2-准备三个实例的目录"><a href="#4-15-4-2-准备三个实例的目录" class="headerlink" title="4.15.4.2 准备三个实例的目录"></a>4.15.4.2 准备三个实例的目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -pv /mysql/&#123;3306,3307,3308&#125;/&#123;data,etc,socket,log,bin,pid&#125;</span><br><span class="hljs-comment"># chown -R mysql.mysql /mysql</span><br><span class="hljs-comment"># tree -d /mysql/</span><br>/mysql/<br>├── 3306<br>│  ├── bin<br>│  ├── data<br>│  ├── etc<br>│  ├── <span class="hljs-built_in">log</span><br>│  ├── pid<br>│  └── socket<br>├── 3307<br>│  ├── bin<br>│  ├── data<br>│  ├── etc<br>│  ├── <span class="hljs-built_in">log</span><br>│  ├── pid<br>│  └── socket<br>└── 3308<br> ├── bin<br> ├── data<br> ├── etc<br> ├── <span class="hljs-built_in">log</span><br> ├── pid<br> └── socket<br> <br>21 directories<br></code></pre></td></tr></table></figure>

<h4 id="4-15-4-3-生成数据库文件"><a href="#4-15-4-3-生成数据库文件" class="headerlink" title="4.15.4.3 生成数据库文件"></a>4.15.4.3 生成数据库文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mysql_install_db --datadir=/mysql/3306/data --user=mysql</span><br><span class="hljs-comment"># mysql_install_db --datadir=/mysql/3307/data --user=mysql</span><br><span class="hljs-comment"># mysql_install_db --datadir=/mysql/3308/data --user=mysql</span><br></code></pre></td></tr></table></figure>

<h4 id="4-15-4-4-准备配置文件"><a href="#4-15-4-4-准备配置文件" class="headerlink" title="4.15.4.4 准备配置文件"></a>4.15.4.4 准备配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /mysql/3306/etc/my.cnf</span><br>[mysqld]<br>port=3306<br>datadir=/mysql/3306/data<br>socket=/mysql/3306/socket/mysql.sock<br>log-error=/mysql/3306/<span class="hljs-built_in">log</span>/mysql.log<br>pid-file=/mysql/3306/pid/mysql.pid<br><br><span class="hljs-comment">#重复上面步骤设置3307，3308</span><br><span class="hljs-comment"># sed &#x27;s/3306/3307/&#x27; /mysql/3306/etc/my.cnf &gt; /mysql/3307/etc/my.cnf</span><br><span class="hljs-comment"># sed &#x27;s/3306/3308/&#x27; /mysql/3306/etc/my.cnf &gt; /mysql/3308/etc/my.cnf</span><br></code></pre></td></tr></table></figure>

<h4 id="4-15-4-5-准备启动脚本"><a href="#4-15-4-5-准备启动脚本" class="headerlink" title="4.15.4.5 准备启动脚本"></a>4.15.4.5 准备启动脚本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /mysql/3306/bin/mysqld</span><br><span class="hljs-comment">#!/bin/bash</span><br>port=3306<br>mysql_user=<span class="hljs-string">&quot;root&quot;</span><br>mysql_pwd=<span class="hljs-string">&quot;123456&quot;</span><br>cmd_path=<span class="hljs-string">&quot;/usr/bin&quot;</span><br>mysql_basedir=<span class="hljs-string">&quot;/mysql&quot;</span><br>mysql_sock=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;mysql_basedir&#125;</span>/<span class="hljs-variable">$&#123;port&#125;</span>/socket/mysql.sock&quot;</span><br><br><span class="hljs-function"><span class="hljs-title">function_start_mysql</span></span>()<br>&#123;<br>  <span class="hljs-keyword">if</span> [ ! -e <span class="hljs-string">&quot;<span class="hljs-variable">$mysql_sock</span>&quot;</span> ];<span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Starting MySQL...\n&quot;</span><br>    <span class="hljs-variable">$&#123;cmd_path&#125;</span>/mysqld_safe --defaults-<br>    file=<span class="hljs-variable">$&#123;mysql_basedir&#125;</span>/<span class="hljs-variable">$&#123;port&#125;</span>/etc/my.cnf &amp;&gt; /dev/null &amp;<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;MySQL is running...\n&quot;</span><br>    <span class="hljs-built_in">exit</span><br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">function_stop_mysql</span></span>()<br>&#123;<br>  <span class="hljs-keyword">if</span> [ ! -e <span class="hljs-string">&quot;<span class="hljs-variable">$mysql_sock</span>&quot;</span> ];<span class="hljs-keyword">then</span><br>     <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;MySQL is stopped...\n&quot;</span><br>     <span class="hljs-built_in">exit</span><br>  <span class="hljs-keyword">else</span><br>     <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Stoping MySQL...\n&quot;</span><br>     <span class="hljs-variable">$&#123;cmd_path&#125;</span>/mysqladmin -u <span class="hljs-variable">$&#123;mysql_user&#125;</span> -p<span class="hljs-variable">$&#123;mysql_pwd&#125;</span> -S <span class="hljs-variable">$&#123;mysql_sock&#125;</span> shutdown<br> <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">function_restart_mysql</span></span>()<br>&#123;<br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Restarting MySQL...\n&quot;</span><br>  function_stop_mysql<br>  sleep 2<br>  function_start_mysql<br>&#125;<br><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>start)<br>  function_start_mysql<br>  ;;<br>stop)<br>  function_stop_mysql<br>  ;;<br>restart)<br>  function_restart_mysql<br>  ;;<br>*)<br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Usage: <span class="hljs-variable">$&#123;mysql_basedir&#125;</span>/<span class="hljs-variable">$&#123;port&#125;</span>/bin/mysqld &#123;start|stop|restart&#125;\n&quot;</span> <span class="hljs-keyword">esac</span><br><br><span class="hljs-comment"># chmod +x /mysql/3306/bin/mysqld</span><br><span class="hljs-comment">#重复上述过程，分别建立3307，3308的启动脚本</span><br></code></pre></td></tr></table></figure>

<h4 id="4-15-4-6-启动服务"><a href="#4-15-4-6-启动服务" class="headerlink" title="4.15.4.6 启动服务"></a>4.15.4.6 启动服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /mysql/3306/bin/mysqld start</span><br><span class="hljs-comment"># /mysql/3307/bin/mysqld start </span><br><span class="hljs-comment"># /mysql/3308/bin/mysqld start</span><br></code></pre></td></tr></table></figure>

<h4 id="4-15-4-7-登录实例"><a href="#4-15-4-7-登录实例" class="headerlink" title="4.15.4.7 登录实例"></a>4.15.4.7 登录实例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /mysql/3308/bin/mysqld start</span><br><span class="hljs-comment">#两种连接方法</span><br><span class="hljs-comment"># mysql -h127.0.0.1 -P3308</span><br><span class="hljs-comment"># mysql -uroot -S /mysqldb/3306/socket/mysql.sock</span><br><span class="hljs-comment">#确认连接的端口</span><br>MariaDB [(none)]&gt; show variables like <span class="hljs-string">&#x27;port&#x27;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| port          | 3308 |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.001 sec)<br><br>MariaDB [(none)]&gt;<br><br><span class="hljs-comment">#关闭数据库，需要手动输入root的密码</span><br><span class="hljs-comment"># /mysql/3308/bin/mysqld stop</span><br>Stoping MySQL...<br>Enter password:<br><span class="hljs-comment"># /mysql/3308/bin/mysqld start</span><br>Starting MySQL...<br></code></pre></td></tr></table></figure>

<h4 id="4-15-4-8-修改root密码"><a href="#4-15-4-8-修改root密码" class="headerlink" title="4.15.4.8 修改root密码"></a>4.15.4.8 修改root密码</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#加上root的口令</span><br><span class="hljs-comment"># mysqladmin -uroot -S /mysql/3306/socket/mysql.sock password &#x27;magedu&#x27;</span><br><span class="hljs-comment"># mysqladmin -uroot -S /mysql/3307/socket/mysql.sock password &#x27;magedu&#x27;</span><br><span class="hljs-comment"># mysqladmin -uroot -S /mysql/3308/socket/mysql.sock password &#x27;magedu&#x27;</span><br><br><span class="hljs-comment">#或者登录mysql,执行下面也可以</span><br>Mariadb&gt;update mysql.user <span class="hljs-built_in">set</span> password=password(“centos”) <span class="hljs-built_in">where</span> user=<span class="hljs-string">&#x27;root&#x27;</span>;<br>Mariadb&gt;flush privileges;<br><span class="hljs-comment">#重复步骤，分别修改别外两个实例3307，3308对应root口令</span><br></code></pre></td></tr></table></figure>

<h4 id="4-15-4-9-测试连接"><a href="#4-15-4-9-测试连接" class="headerlink" title="4.15.4.9 测试连接"></a>4.15.4.9 测试连接</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mysql -uroot -p -S /mysql/3306/socket/mysql.sock #提示输入口令才能登录</span><br></code></pre></td></tr></table></figure>

<h2 id="4-16-Centos7-Mariadb多实例"><a href="#4-16-Centos7-Mariadb多实例" class="headerlink" title="4.16 Centos7 Mariadb多实例"></a>4.16 Centos7 Mariadb多实例</h2><h3 id="4-16-1-实验目的"><a href="#4-16-1-实验目的" class="headerlink" title="4.16.1 实验目的"></a>4.16.1 实验目的</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">CentOS 7 yum安装mariadb并实现三个实例<br></code></pre></td></tr></table></figure>

<h3 id="4-16-2-环境要求"><a href="#4-16-2-环境要求" class="headerlink" title="4.16.2 环境要求"></a>4.16.2 环境要求</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">一台主机<br>系统：CentOS 7.X<br></code></pre></td></tr></table></figure>

<h3 id="4-16-3-前提准备"><a href="#4-16-3-前提准备" class="headerlink" title="4.16.3 前提准备"></a>4.16.3 前提准备</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">关闭SElinux<br>关闭防火墙<br>时间同步<br></code></pre></td></tr></table></figure>

<h3 id="4-16-4-实现步骤"><a href="#4-16-4-实现步骤" class="headerlink" title="4.16.4 实现步骤"></a>4.16.4 实现步骤</h3><h4 id="4-16-4-1-安装mariadb"><a href="#4-16-4-1-安装mariadb" class="headerlink" title="4.16.4.1 安装mariadb"></a>4.16.4.1 安装mariadb</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install mariadb-server</span><br><span class="hljs-comment"># systemctl start mariadb</span><br></code></pre></td></tr></table></figure>

<h4 id="4-16-4-2-准备三个实例的目录"><a href="#4-16-4-2-准备三个实例的目录" class="headerlink" title="4.16.4.2 准备三个实例的目录"></a>4.16.4.2 准备三个实例的目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -pv /mysql/&#123;3306,3307,3308&#125;/&#123;data,etc,socket,log,bin,pid&#125;</span><br><span class="hljs-comment"># chown -R mysql.mysql /mysql</span><br></code></pre></td></tr></table></figure>

<h4 id="4-16-4-3-生成数据库文件"><a href="#4-16-4-3-生成数据库文件" class="headerlink" title="4.16.4.3 生成数据库文件"></a>4.16.4.3 生成数据库文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mysql_install_db --datadir=/mysql/3306/data --user=mysql</span><br><span class="hljs-comment"># mysql_install_db --datadir=/mysql/3307/data --user=mysql</span><br><span class="hljs-comment"># mysql_install_db --datadir=/mysql/3308/data --user=mysql</span><br></code></pre></td></tr></table></figure>

<h4 id="4-16-4-4-准备配置文件"><a href="#4-16-4-4-准备配置文件" class="headerlink" title="4.16.4.4 准备配置文件"></a>4.16.4.4 准备配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp /etc/my.cnf /mysql/3306/etc/</span><br><span class="hljs-comment"># vim /mysql/3306/etc/my.cnf</span><br>[mysqld]<br><span class="hljs-comment">#加此行，如果port是3306可省略此行</span><br>port=3306 <br>datadir=/mysql/3306/data/<br>socket=/mysql/3306/socket/mysql.sock<br>[mysqld_safe]<br>log-error=/mysql/3306/<span class="hljs-built_in">log</span>/mariadb.log<br>pid-file=/mysql/3306/pid/mariadb.pid<br><span class="hljs-comment">#重复上面步骤设置3307，3308</span><br></code></pre></td></tr></table></figure>

<h4 id="4-16-4-5-准备启动脚本"><a href="#4-16-4-5-准备启动脚本" class="headerlink" title="4.16.4.5 准备启动脚本"></a>4.16.4.5 准备启动脚本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /mysql/3306/bin/mysqld<br><span class="hljs-comment">#!/bin/bash</span><br>port=3306<br>mysql_user=<span class="hljs-string">&quot;root&quot;</span><br>mysql_pwd=<span class="hljs-string">&quot;123456&quot;</span><br>cmd_path=<span class="hljs-string">&quot;/usr/bin&quot;</span><br>mysql_basedir=<span class="hljs-string">&quot;/mysql&quot;</span><br>mysql_sock=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;mysql_basedir&#125;</span>/<span class="hljs-variable">$&#123;port&#125;</span>/socket/mysql.sock&quot;</span><br><br><span class="hljs-function"><span class="hljs-title">function_start_mysql</span></span>()<br>&#123;<br>  <span class="hljs-keyword">if</span> [ ! -e <span class="hljs-string">&quot;<span class="hljs-variable">$mysql_sock</span>&quot;</span> ];<span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Starting MySQL...\n&quot;</span><br>     <span class="hljs-variable">$&#123;cmd_path&#125;</span>/mysqld_safe --defaults-file=<span class="hljs-variable">$&#123;mysql_basedir&#125;</span>/<span class="hljs-variable">$&#123;port&#125;</span>/etc/my.cnf &amp;&gt; /dev/null &amp;<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;MySQL is running...\n&quot;</span><br>    <span class="hljs-built_in">exit</span><br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">function_stop_mysql</span></span>()<br>&#123;<br>  <span class="hljs-keyword">if</span> [ ! -e <span class="hljs-string">&quot;<span class="hljs-variable">$mysql_sock</span>&quot;</span> ];<span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;MySQL is stopped...\n&quot;</span><br>    <span class="hljs-built_in">exit</span><br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Stoping MySQL...\n&quot;</span><br>     <span class="hljs-variable">$&#123;cmd_path&#125;</span>/mysqladmin -u <span class="hljs-variable">$&#123;mysql_user&#125;</span> -p<span class="hljs-variable">$&#123;mysql_pwd&#125;</span> -S <span class="hljs-variable">$&#123;mysql_sock&#125;</span> shutdown<br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">function_restart_mysql</span></span>()<br>&#123;<br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Restarting MySQL...\n&quot;</span><br>  function_stop_mysql<br>  sleep 2<br>  function_start_mysql<br>&#125;<br><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>start)<br>  function_start_mysql<br>  ;;<br>stop)<br>  function_stop_mysql<br>  ;;<br>restart)<br>  function_restart_mysql<br>  ;;<br>*)<br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Usage: <span class="hljs-variable">$&#123;mysql_basedir&#125;</span>/<span class="hljs-variable">$&#123;port&#125;</span>/bin/mysqld &#123;start|stop|restart&#125;\n&quot;</span><br><span class="hljs-keyword">esac</span><br><span class="hljs-comment">#重复上述过程，分别建立3307，3308的启动脚本</span><br></code></pre></td></tr></table></figure>

<h4 id="4-16-4-6-启动关闭服务"><a href="#4-16-4-6-启动关闭服务" class="headerlink" title="4.16.4.6 启动关闭服务"></a>4.16.4.6 启动关闭服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /mysql/3306/bin/mysqld  start</span><br><span class="hljs-comment"># /mysql/3307/bin/mysqld  start</span><br><span class="hljs-comment"># /mysql/3308/bin/mysqld  start</span><br></code></pre></td></tr></table></figure>

<h4 id="4-16-4-7-登录实例"><a href="#4-16-4-7-登录实例" class="headerlink" title="4.16.4.7 登录实例"></a>4.16.4.7 登录实例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /mysql/3306/bin/mysqld  start</span><br><span class="hljs-comment"># mysql -uroot -S /mysql/3306/socket/mysql.sock</span><br><span class="hljs-comment"># mariadb &gt; show variables like &#x27;port&#x27;  #确认连接的端口</span><br></code></pre></td></tr></table></figure>

<h4 id="4-16-4-8-修改root密码"><a href="#4-16-4-8-修改root密码" class="headerlink" title="4.16.4.8 修改root密码"></a>4.16.4.8 修改root密码</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqladmin -uroot -S /mysql/3306/socket/mysql.sock password <span class="hljs-string">&#x27;123456&#x27;</span>  <span class="hljs-comment">#加上新口令</span><br><span class="hljs-comment">#或者登录mysql,执行下面也可以</span><br>Mariadb&gt;update mysql.user <span class="hljs-built_in">set</span> password=password(“centos”) <span class="hljs-built_in">where</span> user=<span class="hljs-string">&#x27;root&#x27;</span>;<br>Mariadb&gt;flush privileges;<br><span class="hljs-comment">#重复步骤，分别修改别外两个实例3307，3308对应root口令</span><br></code></pre></td></tr></table></figure>

<h4 id="4-16-4-9-测试连接"><a href="#4-16-4-9-测试连接" class="headerlink" title="4.16.4.9 测试连接"></a>4.16.4.9 测试连接</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mysql -uroot -S /mysql/3306/socket/mysql.sock -p #提示输入口令才能登录</span><br></code></pre></td></tr></table></figure>



<h1 id="五、MySQL内置功能"><a href="#五、MySQL内置功能" class="headerlink" title="五、MySQL内置功能"></a>五、MySQL内置功能</h1><h2 id="5-1-mysql内置的功能"><a href="#5-1-mysql内置的功能" class="headerlink" title="5.1 mysql内置的功能"></a>5.1 mysql内置的功能</h2><h3 id="5-1-1-连接数据库"><a href="#5-1-1-连接数据库" class="headerlink" title="5.1.1 连接数据库"></a>5.1.1 连接数据库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">-u ：用户<br>-p ：密码<br>-S ：socket登录（输入socket存放的位置）<br>-h ：ip登录 （输入ip地址）<br>-P ：ip登录 （输入端口）<br>-e ：免交互执行sql语句<br>&lt;  ：重定向<br></code></pre></td></tr></table></figure>

<p>例子:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#socket登录</span><br><span class="hljs-comment"># mysql -uroot -p -S /tmp/mysql.sock</span><br><span class="hljs-comment">#ip+端口登录</span><br><span class="hljs-comment"># mysql -uroot -p -h10.0.0.51 -P3306</span><br><span class="hljs-comment">#-e 免交互执行sql语句</span><br><span class="hljs-comment"># mysql -uroot -p -e &quot;show databases;&quot;</span><br><span class="hljs-comment">#&lt; 恢复数据</span><br><span class="hljs-comment"># mysql -uroot -p123  /root/world.sql</span><br></code></pre></td></tr></table></figure>

<h3 id="5-1-2-常用内置命令"><a href="#5-1-2-常用内置命令" class="headerlink" title="5.1.2 常用内置命令"></a>5.1.2 常用内置命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">\? ; <span class="hljs-built_in">help</span> ：打印mysql帮助<br><br>\c ; ctrl+c ：结束上个命令运行<br><br>\q ; quit; <span class="hljs-built_in">exit</span>; ctrl+d ：退出mysql<br><br>\G ：将数据竖起来显示<br><br><span class="hljs-built_in">source</span> ：恢复备份文件（和“&lt;”差不多，一般使用<span class="hljs-built_in">source</span>来恢复数据）<br></code></pre></td></tr></table></figure>

<h1 id="六、SQL基础应用"><a href="#六、SQL基础应用" class="headerlink" title="六、SQL基础应用"></a>六、SQL基础应用</h1><h2 id="6-1-SQL介绍"><a href="#6-1-SQL介绍" class="headerlink" title="6.1 SQL介绍"></a>6.1 SQL介绍</h2><p>结构化的查询语言</p>
<p>关系型数据库通用的命令</p>
<p>遵循SQL92的标准(SQL_MODE)</p>
<h2 id="6-2-SQL常用种类"><a href="#6-2-SQL常用种类" class="headerlink" title="6.2 SQL常用种类"></a>6.2 SQL常用种类</h2><p>DDL 数据定义语言</p>
<p>DCL 数据控制语言</p>
<p>DML 数据操作语言</p>
<p>DQL 数据查询语言 </p>
<h2 id="6-3-SQL引入-数据库的逻辑结构"><a href="#6-3-SQL引入-数据库的逻辑结构" class="headerlink" title="6.3 SQL引入-数据库的逻辑结构"></a>6.3 SQL引入-数据库的逻辑结构</h2><p>库</p>
<p>​    库名字</p>
<p>​    库属性:字符集,排序规则</p>
<p> 表</p>
<p>​    表名</p>
<p>​    表属性:存储引擎类型,字符集,排序规则</p>
<p>​    列名</p>
<p>​    列属性:数据类型,约束,其他属性</p>
<p>​    数据行 </p>
<h2 id="6-4-字符集-charset"><a href="#6-4-字符集-charset" class="headerlink" title="6.4 字符集 (charset)"></a>6.4 字符集 (charset)</h2><p>相当于MySQL的密码本(编码表)</p>
<p>mysql&gt; show charset;</p>
<p>utf8 : 3个字节</p>
<p>utf8mb4 (建议): 4个字节,支持emoji </p>
<h2 id="6-5-排序（校对）规则-collation"><a href="#6-5-排序（校对）规则-collation" class="headerlink" title="6.5 排序（校对）规则 (collation)"></a>6.5 排序（校对）规则 (collation)</h2><p>对于英文字符串的,大小写的敏感</p>
<p>mysql&gt; show collation;</p>
<p>utf8mb4_general_ci  #大小写不敏感</p>
<p>utf8mb4_bin #大小写敏感(存拼音,日文) </p>
<h2 id="6-6-数据类型介绍"><a href="#6-6-数据类型介绍" class="headerlink" title="6.6 数据类型介绍"></a>6.6 数据类型介绍</h2><h3 id="6-5-1-数字"><a href="#6-5-1-数字" class="headerlink" title="6.5.1 数字"></a>6.5.1 数字</h3><ul>
<li>整数</li>
<li>tinyint </li>
<li>int  </li>
<li>浮点数</li>
</ul>
<p>略</p>
<h3 id="6-6-2-字符串-（注意：变长：字符串长度变化）"><a href="#6-6-2-字符串-（注意：变长：字符串长度变化）" class="headerlink" title="6.6.2 字符串 （注意：变长：字符串长度变化）"></a>6.6.2 字符串 （注意：变长：字符串长度变化）</h3><p>char(100) ：定长字符串类型,不管字符串长度多长,都立即分配100个字符长度的存储空间,未占满的空间使用”空格”填充</p>
<p>varchar(100) ：变长字符串类型,每次存储数据之前,都要先判断一下长度,按需分配此盘空间.会单独申请一个字符长度的空间存储字符长度(少于255,如果超过255以上,会占用两个存储空间)</p>
<p><strong>如何选择这两个数据类型?</strong></p>
<ol>
<li>少于255个字符串长度,定长的列值,选择char</li>
<li>多于255字符长度,变长的字符串,可以选择varchar</li>
</ol>
<h3 id="6-6-3-enum-枚举数据类型-（有限个数的字符串）"><a href="#6-6-3-enum-枚举数据类型-（有限个数的字符串）" class="headerlink" title="6.6.3 enum 枚举数据类型 （有限个数的字符串）"></a>6.6.3 enum 枚举数据类型 （有限个数的字符串）</h3><p>address enum（‘sz’，‘sh’，‘bj’……）</p>
<p><strong>枚举数据类型可能会影响到索引的性能</strong></p>
<h3 id="6-5-4-时间"><a href="#6-5-4-时间" class="headerlink" title="6.5.4 时间"></a>6.5.4 时间</h3><p>datetime </p>
<p>范围为从 1000-01-01 00:00:00.000000 至 9999-12-31 23:59:59.999999。</p>
<p>timestamp</p>
<p>范围为从 1970-01-01 00:00:00.000000 至 2038-01-19 03:14:07.999999。</p>
<h3 id="6-6-5-二进制"><a href="#6-6-5-二进制" class="headerlink" title="6.6.5 二进制"></a>6.6.5 二进制</h3><p>略。</p>
<p><strong>所有ALTER命令都会进行锁表</strong></p>
<h1 id="七、DDL的应用"><a href="#七、DDL的应用" class="headerlink" title="七、DDL的应用"></a>七、DDL的应用</h1><h2 id="7-1-数据库的定义"><a href="#7-1-数据库的定义" class="headerlink" title="7.1 数据库的定义"></a>7.1 数据库的定义</h2><h3 id="7-1-1创建数据库"><a href="#7-1-1创建数据库" class="headerlink" title="7.1.1创建数据库"></a>7.1.1创建数据库</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">格式：create database 库名 charset 字符集 collate 校对规则;<br>注意：校对规则不是必须的<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE DATABASE zabbix CHARSET utf8mb4 COLLATE utf8mb4_bin;<br></code></pre></td></tr></table></figure>

<h3 id="7-1-2-查看库情况-（查看不属于DDL）"><a href="#7-1-2-查看库情况-（查看不属于DDL）" class="headerlink" title="7.1.2 查看库情况 （查看不属于DDL）"></a>7.1.2 查看库情况 （查看不属于DDL）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">格式：show create database 库名;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW DATABASES; <br>SHOW CREATE DATABASE zabbix;<br></code></pre></td></tr></table></figure>

<h3 id="7-1-3-删除数据库-不代表生产操作"><a href="#7-1-3-删除数据库-不代表生产操作" class="headerlink" title="7.1.3 删除数据库(不代表生产操作)"></a>7.1.3 删除数据库(不代表生产操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP DATABASE zabbix;<br></code></pre></td></tr></table></figure>

<h3 id="7-1-4-修改数据库字符集（修改校对规则也是一样）"><a href="#7-1-4-修改数据库字符集（修改校对规则也是一样）" class="headerlink" title="7.1.4 修改数据库字符集（修改校对规则也是一样）"></a>7.1.4 修改数据库字符集（修改校对规则也是一样）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE DATABASE oldguo;<br><br>SHOW CREATE DATABASE oldguo;<br><br>ALTER DATABASE oldguo CHARSET utf8mb4;<br></code></pre></td></tr></table></figure>

<p>注意:</p>
<ol>
<li>一定是从小往大了改,比如utf8—&gt;utf8mb4.</li>
<li>目标字符集一定是源字符集的严格超级.</li>
</ol>
<h4 id="7-1-5-关于库定义规范"><a href="#7-1-5-关于库定义规范" class="headerlink" title="7.1.5 关于库定义规范 *****"></a>7.1.5 关于库定义规范 *****</h4><ol>
<li>库名使用小写字符</li>
<li>库名不能以数字开头</li>
<li>不能是数据库内部的关键字</li>
<li>必须设置字符集.</li>
</ol>
<h2 id="7-2-表定义"><a href="#7-2-表定义" class="headerlink" title="7.2 表定义"></a>7.2 表定义</h2><h3 id="7-2-1-建表包含以下属性"><a href="#7-2-1-建表包含以下属性" class="headerlink" title="7.2.1 建表包含以下属性"></a>7.2.1 建表包含以下属性</h3><p>表名，列名，列属性，表属性</p>
<h3 id="7-2-2-列属性"><a href="#7-2-2-列属性" class="headerlink" title="7.2.2 列属性"></a>7.2.2 列属性</h3><p>PRIMARY KEY : 主键约束,表中只能有一个,非空且唯一.</p>
<p>NOT NULL  : 非空约束,不允许空值</p>
<p>UNIQUE KEY : 唯一键约束,不允许重复值 （可以通过删除索引的形式将表中的unique删除）</p>
<p>DEFAULT   : 一般配合 NOT NULL 一起使用.</p>
<p>UNSIGNED  : 无符号,一般是配合数字列,非负数</p>
<p>COMMENT   : 注释</p>
<p>AUTO_INCREMENT : 自增长的列</p>
<h3 id="7-2-3-手写建表例子"><a href="#7-2-3-手写建表例子" class="headerlink" title="7.2.3 手写建表例子"></a>7.2.3 手写建表例子</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">格式：<br>CREATE TABLE 表名(<br>列名(必写) 数据类型(必写) 列属性(有需要就写)... COMMENT &#x27;注释&#x27; (必写),<br>......<br>列名(必写) 数据类型(必写) 列属性(有需要就写)... COMMENT &#x27;注释&#x27; (必写) (最后一行不用写逗号)<br>)ENGINE 引擎名（一般InnoDB） CHAARSET 字符集;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE stu (<br>id INT PRIMARY KEY NOT NULL AUTO_INCREMENT COMMENT &#x27;学号&#x27;,<br>sname VARCHAR(255) NOT NULL COMMENT &#x27;姓名&#x27;,<br>age TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT &#x27;年龄&#x27;,<br>gender ENUM(&#x27;m&#x27;,&#x27;f&#x27;,&#x27;n&#x27;) NOT NULL DEFAULT &#x27;n&#x27; COMMENT &#x27;性别&#x27;,<br>intime DATETIME NOT NULL DEFAULT NOW() COMMENT &#x27;入学时间&#x27;<br>)ENGINE INNODB CHARSET utf8mb4;<br></code></pre></td></tr></table></figure>

<h3 id="7-2-4-创建一个表结构一样的表"><a href="#7-2-4-创建一个表结构一样的表" class="headerlink" title="7.2.4 创建一个表结构一样的表"></a>7.2.4 创建一个表结构一样的表</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">格式：<br>CREATE TABLE 表名 LIKE 已存在的表的表名;<br>#范例<br>CREATE TABLE test LIKE stu;<br></code></pre></td></tr></table></figure>

<h3 id="7-2-4-建表规范"><a href="#7-2-4-建表规范" class="headerlink" title="7.2.4 建表规范 *****"></a>7.2.4 建表规范 *****</h3><ul>
<li>表名小写字母,不能数字开头,</li>
<li>不能是保留字符,使用和业务有关的表名</li>
<li>选择合适的数据类型及长度</li>
<li>每个列设置 NOT NULL + DEFAULT .对于数字0填充,对于字符使用有效字符串填充</li>
<li>没个列设置注释</li>
<li>表必须设置存储引擎和字符集</li>
<li>主键列尽量是无关列数字列,最好是自增长</li>
<li>enum类型不要保存数字,只能是字符串类型 </li>
</ul>
<h2 id="7-3-查询建表信息"><a href="#7-3-查询建表信息" class="headerlink" title="7.3 查询建表信息"></a>7.3 查询建表信息</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>show create table 表名;<br>SHWO CREATE TABLE 表名;<br>desc 表名;<br>#范例：<br>SHOW TABLES;<br>SHOW CREATE TABLE stu;<br>desc stu; （这种格式更容易看）<br></code></pre></td></tr></table></figure>

<h2 id="7-4-删表"><a href="#7-4-删表" class="headerlink" title="7.4 删表"></a>7.4 删表</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>drop table 表名;<br>#范例：<br>drop table test;<br></code></pre></td></tr></table></figure>

<h2 id="7-5-修改表"><a href="#7-5-修改表" class="headerlink" title="7.5 修改表"></a>7.5 修改表</h2><h3 id="7-5-1-在stu表中添加qq列（一般使用在生产中）"><a href="#7-5-1-在stu表中添加qq列（一般使用在生产中）" class="headerlink" title="7.5.1 在stu表中添加qq列（一般使用在生产中） *****"></a>7.5.1 在stu表中添加qq列（一般使用在生产中） *****</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>alter table 表名 add 列名 一系列属性....;<br>#范例：<br>ALTER TABLE stu ADD qq VARCHAR(20) NOT NULL COMMENT &#x27;qq号&#x27;;<br></code></pre></td></tr></table></figure>

<h3 id="7-5-2-在sname后加微信列（一般生产不会这样添加）"><a href="#7-5-2-在sname后加微信列（一般生产不会这样添加）" class="headerlink" title="7.5.2 在sname后加微信列（一般生产不会这样添加） ***"></a>7.5.2 在sname后加微信列（一般生产不会这样添加） ***</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>atler table 表名 add 列名 一系列属性... after 列名(在哪个列的后面);<br>#范例：<br>ALTER TABLE stu ADD wechat VARCHAR(64) NOT NULL UNIQUE COMMENT &#x27;微信号&#x27; AFTER sname;<br></code></pre></td></tr></table></figure>

<h3 id="7-5-3-在id列前加一个新列num（一般生产不会这样添加）"><a href="#7-5-3-在id列前加一个新列num（一般生产不会这样添加）" class="headerlink" title="7.5.3 在id列前加一个新列num（一般生产不会这样添加）***"></a>7.5.3 在id列前加一个新列num（一般生产不会这样添加）***</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>alter table 表名 add 一系列属性 first;<br>#范例：<br>ALTER TABLE stu ADD num INT NOT NULL UNIQUE COMMENT &#x27;身份证&#x27; FIRST ;<br></code></pre></td></tr></table></figure>

<h3 id="7-5-4-把刚才添加的列都删掉-危险-不代表生产操作"><a href="#7-5-4-把刚才添加的列都删掉-危险-不代表生产操作" class="headerlink" title="7.5.4 把刚才添加的列都删掉(危险,不代表生产操作) ***"></a>7.5.4 把刚才添加的列都删掉(危险,不代表生产操作) ***</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>alter table 表名 drop 列名;<br>#范例：<br>ALTER TABLE stu DROP num;<br>ALTER TABLE stu DROP qq;<br>ALTER TABLE stu DROP wechat;<br></code></pre></td></tr></table></figure>

<h3 id="7-5-5-修改sname数据类型的属性"><a href="#7-5-5-修改sname数据类型的属性" class="headerlink" title="7.5.5 修改sname数据类型的属性 ***"></a>7.5.5 修改sname数据类型的属性 ***</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>alter table 表名 modify 列名 一系列属性;<br>#范例：<br>ALTER TABLE stu MODIFY sname VARCHAR(64) NOT NULL COMMENT &#x27;姓名&#x27;;<br></code></pre></td></tr></table></figure>

<h3 id="7-5-6-将gender改为sex数据类型改为-CHAR-类型"><a href="#7-5-6-将gender改为sex数据类型改为-CHAR-类型" class="headerlink" title="7.5.6 将gender改为sex数据类型改为 CHAR 类型 ***"></a>7.5.6 将gender改为sex数据类型改为 CHAR 类型 ***</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>alter table 表名 chage 旧列名 新列名 一系列属性;<br>#范例：<br>ALTER TABLE stu CHANGE gender sex CHAR(4) NOT NULL COMMENT &#x27;性别&#x27;;<br>注意：<br>modify：用于修改数据类型的属性（列名除外）<br>change：用于修改数据类型（包含列名）<br></code></pre></td></tr></table></figure>

<h1 id="八、DCL的应用"><a href="#八、DCL的应用" class="headerlink" title="八、DCL的应用"></a>八、DCL的应用</h1><p><strong>使用 show privileges; 查看权限</strong></p>
<h2 id="8-1-grant授权"><a href="#8-1-grant授权" class="headerlink" title="8.1 grant授权"></a>8.1 grant授权</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>grant 权限 on 数据库对象 to 用户<br>#范例：<br>grant select,insert,update,delete on testdb.* to oldboy@&#x27;%&#x27;;<br>（查看用户获得的权限：show grants for oldboy@&#x27;%&#x27;;）<br></code></pre></td></tr></table></figure>

<h2 id="8-2-revoke回收权限"><a href="#8-2-revoke回收权限" class="headerlink" title="8.2 revoke回收权限"></a>8.2 revoke回收权限</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>revoke 权限 on 数据库对象 to 用户<br>#范例：<br>revoke delete on testdb.* to oldboy@&#x27;%&#x27;;<br></code></pre></td></tr></table></figure>



<h1 id="九、DML的应用"><a href="#九、DML的应用" class="headerlink" title="九、DML的应用"></a>九、DML的应用</h1><p><strong>使用 select * from stu（表名）;  #查看插入的数据</strong></p>
<h2 id="9-1-insert-插入数据"><a href="#9-1-insert-插入数据" class="headerlink" title="9.1 insert 插入数据"></a>9.1 insert 插入数据</h2><h3 id="9-1-1-最偷懒方式"><a href="#9-1-1-最偷懒方式" class="headerlink" title="9.1.1 最偷懒方式"></a>9.1.1 最偷懒方式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>INSERT 表名 VALUES(内容1,内容2,......);<br>#范例：<br>INSERT stu VALUES(1,&#x27;zs&#x27;,18,&#x27;m&#x27;,NOW());<br></code></pre></td></tr></table></figure>

<h3 id="9-1-2-最规范"><a href="#9-1-2-最规范" class="headerlink" title="9.1.2 最规范"></a>9.1.2 最规范</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>INSERT INTO 表名(表头1,表头2,......)<br>VALUES(内容1,内容2,......);<br>#范例：<br>INSERT INTO stu(id,sname,age,sex,intime)<br>VALUES (2,&#x27;ls&#x27;,19,&#x27;f&#x27;,NOW());<br></code></pre></td></tr></table></figure>

<h3 id="9-1-3-针对性的录入数据（有default属性的可以不输入）"><a href="#9-1-3-针对性的录入数据（有default属性的可以不输入）" class="headerlink" title="9.1.3 针对性的录入数据（有default属性的可以不输入）"></a>9.1.3 针对性的录入数据（有default属性的可以不输入）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#范例：<br>INSERT INTO stu(sname,age,sex)<br>VALUES (&#x27;w5&#x27;,11,&#x27;m&#x27;);<br></code></pre></td></tr></table></figure>

<h3 id="9-1-4-一次性录入多行"><a href="#9-1-4-一次性录入多行" class="headerlink" title="9.1.4 一次性录入多行"></a>9.1.4 一次性录入多行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>INSERT INTO 表名(表头1,表头2,......)<br>VALUES<br>(内容1,内容2,......),<br>(内容3,内容4,......),<br>(内容6,内容5,......);<br><br>#范例：<br>INSERT INTO stu(sname,age,sex)<br>VALUES <br>(&#x27;aa&#x27;,11,&#x27;m&#x27;),<br>(&#x27;bb&#x27;,12,&#x27;f&#x27;),<br>(&#x27;cc&#x27;,13,&#x27;m&#x27;);<br></code></pre></td></tr></table></figure>

<h2 id="9-2-update-更新数据"><a href="#9-2-update-更新数据" class="headerlink" title="9.2 update 更新数据"></a>9.2 update 更新数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#范例：<br>UPDATE stu SET sname=&#x27;bb&#x27; WHERE id=6;<br>#注意：update一定要加where条件<br></code></pre></td></tr></table></figure>

<h2 id="9-3-delete-删除数据"><a href="#9-3-delete-删除数据" class="headerlink" title="9.3 delete 删除数据"></a>9.3 delete 删除数据</h2><h2 id="9-3-1-delete删除表的内容"><a href="#9-3-1-delete删除表的内容" class="headerlink" title="9.3.1 delete删除表的内容"></a>9.3.1 delete删除表的内容</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#范例：<br>DELETE FROM stu WHERE id=9;<br>#注意：一定要有where条件<br></code></pre></td></tr></table></figure>

<h3 id="9-3-2-生产中屏蔽delete功能"><a href="#9-3-2-生产中屏蔽delete功能" class="headerlink" title="9.3.2 生产中屏蔽delete功能"></a>9.3.2 生产中屏蔽delete功能</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#使用update替代delete <br>ALTER TABLE stu ADD is_del TINYINT DEFAULT 0 ;<br>UPDATE stu SET is_del=1 WHERE id=7;<br>SELECT * FROM stu WHERE is_del=0;<br></code></pre></td></tr></table></figure>

<h3 id="9-3-3-delete-删除数据"><a href="#9-3-3-delete-删除数据" class="headerlink" title="9.3.3 delete 删除数据"></a>9.3.3 delete 删除数据</h3><h4 id="9-3-3-1-删除表中数据"><a href="#9-3-3-1-删除表中数据" class="headerlink" title="9.3.3.1 删除表中数据"></a>9.3.3.1 删除表中数据</h4><p><strong>但不会自动缩减数据文件的大小。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#语法:<br>DELETE [LOW_PRIORITY] [QUICK] [IGNORE] FROM tbl_name [WHERE where_condition] [ORDER BY ...] [LIMIT row_count] #可先排序再指定删除的行数<br></code></pre></td></tr></table></figure>

<p><strong>注意：一定要有限制条件，否则将清空表中的所有数据</strong></p>
<h4 id="9-3-3-2-清空表"><a href="#9-3-3-2-清空表" class="headerlink" title="9.3.3.2 清空表"></a>9.3.3.2 清空表</h4><p>保留表结构，也可以使用下面语句，此语句会自动缩减数据文件的大小。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#语法:<br>TRUNCATE TABLE tbl_name;<br></code></pre></td></tr></table></figure>

<h4 id="9-3-3-3-缩减表大小"><a href="#9-3-3-3-缩减表大小" class="headerlink" title="9.3.3.3 缩减表大小"></a>9.3.3.3 缩减表大小</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#语法:<br>OPTIMIZE TABLE tb_name<br></code></pre></td></tr></table></figure>

<h1 id="十、DQL的应用"><a href="#十、DQL的应用" class="headerlink" title="十、DQL的应用"></a>十、DQL的应用</h1><h2 id="10-1-select单独使用的情况"><a href="#10-1-select单独使用的情况" class="headerlink" title="10.1 select单独使用的情况***"></a>10.1 select单独使用的情况***</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; select @@basedir;<br>mysql&gt; select @@port;<br>mysql&gt; select @@innodb_flush_log_at_trx_commit;<br>mysql&gt; show variables like &#x27;innodb%&#x27;;<br>mysql&gt; select database();<br>mysql&gt; select now();<br></code></pre></td></tr></table></figure>

<h2 id="10-2-select-通用语法-单表"><a href="#10-2-select-通用语法-单表" class="headerlink" title="10.2 select 通用语法(单表) *****"></a>10.2 select 通用语法(单表) *****</h2><p><strong>严格按照有上到下的顺序</strong></p>
<p>select 列  </p>
<p>from 表  </p>
<p>where 条件 </p>
<p>group by 条件 </p>
<p>having  条件 </p>
<p>order by 条件</p>
<p>limit</p>
<h2 id="10-3-SELECT-配合-FROM-子句使用"><a href="#10-3-SELECT-配合-FROM-子句使用" class="headerlink" title="10.3 SELECT 配合 FROM 子句使用"></a>10.3 SELECT 配合 FROM 子句使用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">格式：<br>select 列,列,列 from 表<br></code></pre></td></tr></table></figure>

<h3 id="10-3-1-查询表中所有的信息-生产中几乎是没有这种需求的"><a href="#10-3-1-查询表中所有的信息-生产中几乎是没有这种需求的" class="headerlink" title="10.3.1 查询表中所有的信息(生产中几乎是没有这种需求的)"></a>10.3.1 查询表中所有的信息(生产中几乎是没有这种需求的)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">USE world;<br>SELECT id,NAME,countrycode,district,population FROM city;<br>#或者:<br>SELECT *  FROM city;<br></code></pre></td></tr></table></figure>

<h2 id="10-4-查询表中name和population的值"><a href="#10-4-查询表中name和population的值" class="headerlink" title="10.4 查询表中name和population的值"></a>10.4 查询表中name和population的值</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>select 值1,值2... from 表;<br>#范例：<br>SELECT NAME,population FROM city;<br></code></pre></td></tr></table></figure>

<h2 id="10-5-SELECT-配合-WHERE-子句使用"><a href="#10-5-SELECT-配合-WHERE-子句使用" class="headerlink" title="10.5 SELECT 配合 WHERE 子句使用"></a>10.5 SELECT 配合 WHERE 子句使用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>select 列,列,列 from 表 where 过滤条件<br></code></pre></td></tr></table></figure>

<h3 id="10-5-1-where等值条件查询"><a href="#10-5-1-where等值条件查询" class="headerlink" title="10.5.1 where等值条件查询 *****"></a>10.5.1 where等值条件查询 *****</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#范例：查询中国所有的城市名和人口数<br>SELECT NAME,population FROM city <br>WHERE countrycode=&#x27;CHN&#x27;;<br></code></pre></td></tr></table></figure>

<h3 id="10-5-2-where-配合比较判断查询-gt-lt-gt-lt"><a href="#10-5-2-where-配合比较判断查询-gt-lt-gt-lt" class="headerlink" title="10.5.2 where 配合比较判断查询(&gt; &lt; &gt;= &lt;=) *****"></a>10.5.2 where 配合比较判断查询(&gt; &lt; &gt;= &lt;=) *****</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#范例：世界上小于100人的城市名和人口数<br>SELECT NAME,population FROM city <br>WHERE population&lt;100;<br></code></pre></td></tr></table></figure>

<h3 id="10-5-3-where-配合逻辑连接符-and-or"><a href="#10-5-3-where-配合逻辑连接符-and-or" class="headerlink" title="10.5.3 where 配合逻辑连接符(and or)"></a>10.5.3 where 配合逻辑连接符(and or)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#范例1：查询中国人口数量大于1000w的城市名和人口<br>SELECT NAME,population FROM city <br>WHERE countrycode=&#x27;CHN&#x27; AND population&gt;8000000;<br>#范例2：查询中国或美国的城市名和人口数<br>SELECT NAME,population FROM city <br>WHERE countrycode=&#x27;CHN&#x27; OR countrycode=&#x27;USA&#x27;;<br>#范例3：查询人口数量在500w到600w之间的城市名和人口数<br>SELECT NAME,population FROM city <br>WHERE population&gt;5000000 AND population&lt;6000000;<br>#或者:<br>SELECT NAME,population FROM city<br>WHERE population BETWEEN 5000000 AND 6000000;<br></code></pre></td></tr></table></figure>

<h3 id="10-5-4-where-配合-like-子句-模糊查询"><a href="#10-5-4-where-配合-like-子句-模糊查询" class="headerlink" title="10.5.4 where 配合 like 子句 模糊查询 *****"></a>10.5.4 where 配合 like 子句 模糊查询 *****</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#范例:查询一下contrycode中带有CH开头,城市信息<br>SELECT * FROM city <br>WHERE countrycode LIKE &#x27;CH%&#x27;;<br>#注意:不要出现类似于%CH%,前后都有百分号的语句,因为不走索引,性能极差.如果业务中有大量需求,我们用&quot;ES&quot;来替代<br></code></pre></td></tr></table></figure>

<h3 id="10-5-5-where-配合-in-语句"><a href="#10-5-5-where-配合-in-语句" class="headerlink" title="10.5.5 where 配合 in 语句"></a>10.5.5 where 配合 in 语句</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#范例:查询中国或美国的城市信息.<br>SELECT NAME,population FROM city <br>WHERE countrycode=&#x27;CHN&#x27; OR countrycode=&#x27;USA&#x27;;<br>#或者:<br>SELECT NAME,population FROM city<br>WHERE countrycode IN (&#x27;CHN&#x27; ,&#x27;USA&#x27;);<br></code></pre></td></tr></table></figure>

<h2 id="10-6-SELECT-配合-GROUP-BY-聚合函数应用"><a href="#10-6-SELECT-配合-GROUP-BY-聚合函数应用" class="headerlink" title="10.6 SELECT 配合 GROUP BY + 聚合函数应用"></a>10.6 SELECT 配合 GROUP BY + 聚合函数应用</h2><h3 id="10-6-1-常用聚合函数介绍"><a href="#10-6-1-常用聚合函数介绍" class="headerlink" title="10.6.1 常用聚合函数介绍"></a>10.6.1 常用聚合函数介绍</h3><p>MAX()，MIN()，AVG()，COUNT()，SUM()，GROUP_CONCAT()</p>
<h3 id="10-6-2-GROUP-BY作用"><a href="#10-6-2-GROUP-BY作用" class="headerlink" title="10.6.2 GROUP BY作用"></a>10.6.2 GROUP BY作用</h3><p>将某列中有共同条件的数据行,分成一组,然后在进行聚合函数操作</p>
<h3 id="10-6-3-统计每个国家-城市的个数"><a href="#10-6-3-统计每个国家-城市的个数" class="headerlink" title="10.6.3 统计每个国家,城市的个数"></a>10.6.3 统计每个国家,城市的个数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT countrycode ,COUNT(id) FROM city<br>GROUP BY countrycode;<br></code></pre></td></tr></table></figure>

<h3 id="10-6-4-统计每个国家的总人口数"><a href="#10-6-4-统计每个国家的总人口数" class="headerlink" title="10.6.4 统计每个国家的总人口数"></a>10.6.4 统计每个国家的总人口数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT countrycode,SUM(population) FROM city <br>GROUP BY countrycode;<br></code></pre></td></tr></table></figure>

<h3 id="10-6-5-统计每个”国家”-”省”-的个数"><a href="#10-6-5-统计每个”国家”-”省”-的个数" class="headerlink" title="10.6.5 统计每个”国家”,”省” 的个数"></a>10.6.5 统计每个”国家”,”省” 的个数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT countrycode,COUNT(DISTINCT district) FROM city<br>GROUP BY countrycode;<br>#distinct：用于去重复<br></code></pre></td></tr></table></figure>

<h3 id="10-6-6-统计中国每个省的总人口数"><a href="#10-6-6-统计中国每个省的总人口数" class="headerlink" title="10.6.6 统计中国每个省的总人口数"></a>10.6.6 统计中国每个省的总人口数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT district, SUM(population) FROM city<br>WHERE countrycode=&#x27;CHN&#x27;<br>GROUP BY district ;<br></code></pre></td></tr></table></figure>

<h3 id="10-6-7-统计中国每个省城市的个数"><a href="#10-6-7-统计中国每个省城市的个数" class="headerlink" title="10.6.7 统计中国每个省城市的个数"></a>10.6.7 统计中国每个省城市的个数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT district, COUNT(NAME) FROM city <br>WHERE countrycode=&#x27;CHN&#x27;<br>GROUP BY district;<br></code></pre></td></tr></table></figure>

<h3 id="10-6-8-统计中国每个省城市的名字列表GROUP-CONCAT"><a href="#10-6-8-统计中国每个省城市的名字列表GROUP-CONCAT" class="headerlink" title="10.6.8 统计中国每个省城市的名字列表GROUP_CONCAT()"></a>10.6.8 统计中国每个省城市的名字列表GROUP_CONCAT()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">例如：guangdong  guangzhou,shenzhen,foshan.... <br>SELECT district,GROUP_CONCAT(NAME) FROM city <br>WHERE countrycode=&#x27;CHN&#x27;<br>GROUP BY district ;<br></code></pre></td></tr></table></figure>

<h3 id="10-6-9-小扩展"><a href="#10-6-9-小扩展" class="headerlink" title="10.6.9 小扩展"></a>10.6.9 小扩展</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">anhui : hefei,huaian ....<br>SELECT CONCAT(district,&quot;:&quot;,GROUP_CONCAT(NAME)) FROM city <br>WHERE countrycode=&#x27;CHN&#x27;<br>GROUP BY district ;<br></code></pre></td></tr></table></figure>

<h2 id="10-7-SELECT-配合-HAVING-子句"><a href="#10-7-SELECT-配合-HAVING-子句" class="headerlink" title="10.7 SELECT 配合 HAVING 子句"></a>10.7 SELECT 配合 HAVING 子句</h2><p>HAGING：用于GROUP BY之后再进行判断</p>
<h3 id="10-7-1-统计所有国家的总人口数，将总人口数大于1亿的过滤出来"><a href="#10-7-1-统计所有国家的总人口数，将总人口数大于1亿的过滤出来" class="headerlink" title="10.7.1 统计所有国家的总人口数，将总人口数大于1亿的过滤出来"></a>10.7.1 统计所有国家的总人口数，将总人口数大于1亿的过滤出来</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT CountryCode,SUM(Population) FROM city<br>GROUP BY CountryCode<br>HAVING SUM(Population)&gt;100000000;<br></code></pre></td></tr></table></figure>

<h2 id="10-8-SELECT-配合-ORDER-BY-子句"><a href="#10-8-SELECT-配合-ORDER-BY-子句" class="headerlink" title="10.8 SELECT 配合 ORDER BY 子句"></a>10.8 SELECT 配合 ORDER BY 子句</h2><p><strong>order by：用于排序，默认由小到大，加desc变大到小</strong></p>
<h3 id="10-8-1-统计所有国家的总人口数量"><a href="#10-8-1-统计所有国家的总人口数量" class="headerlink" title="10.8.1 统计所有国家的总人口数量,"></a>10.8.1 统计所有国家的总人口数量,</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">将总人口数大于5000w的过滤出来,并且按照从大到小顺序排列<br>SELECT countrycode,SUM(population) FROM city<br>GROUP BY countrycode<br>HAVING SUM(population)&gt;50000000<br>ORDER BY SUM(population) DESC ;<br></code></pre></td></tr></table></figure>

<h2 id="10-9-关于group-by的sql-mode"><a href="#10-9-关于group-by的sql-mode" class="headerlink" title="10.9 关于group by的sql_mode"></a>10.9 关于group by的sql_mode</h2><p><strong>only_full_group_by</strong></p>
<p>说明：</p>
<ol>
<li>在5.7版本中MySQL sql_mode参数中自带，5.6和8.0都没有</li>
<li> 对于group by聚合操作，如果select中的列，没有在group by中出现，那么将认为这个SQL时不合法的</li>
</ol>
<h2 id="10-10-group-concat"><a href="#10-10-group-concat" class="headerlink" title="10.10 group_concat"></a>10.10 group_concat</h2><p>列转行聚合函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select user,group_concat(host) from mysql.user group by user;<br></code></pre></td></tr></table></figure>

<h2 id="10-11-concat"><a href="#10-11-concat" class="headerlink" title="10.11 concat"></a>10.11 concat</h2><p>做列值拼接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select concat(user,&quot;@&quot;,host) from mysql.user;<br></code></pre></td></tr></table></figure>

<h2 id="10-12-练习题"><a href="#10-12-练习题" class="headerlink" title="10.12 练习题"></a>10.12 练习题</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#统计中国每个省的总人口数，只打印总人口数小于100w的<br>SELECT district,SUM(population) FROM city <br>WHERE countrycode=&#x27;CHN&#x27;<br>GROUP BY district<br>HAVING SUM(population)&lt;1000000;<br><br>#查看中国所有的城市，并按人口数进行排序(从大到小)<br>SELECT * FROM city WHERE countrycode=&#x27;CHN&#x27;<br>ORDER BY population DESC;<br><br>#统计中国各个省的总人口数量，按照总人口从大到小排序<br>SELECT district,SUM(population) FROM city <br>WHERE countrycode=&#x27;CHN&#x27;<br>GROUP BY district<br>ORDER BY SUM(population) DESC; <br><br>#统计中国,每个省的总人口,找出总人口大于500w的,并按总人口从大到小排序,只显示前三名<br>SELECT district,SUM(population) FROM city<br>WHERE countrycode=&#x27;CHN&#x27;<br>GROUP BY district<br>HAVING SUM(population)&gt;5000000<br>ORDER BY SUM(population) DESC<br>LIMIT 3;<br></code></pre></td></tr></table></figure>

<h2 id="10-13-union-和-union-all"><a href="#10-13-union-和-union-all" class="headerlink" title="10.13 union 和 union all"></a>10.13 union 和 union all</h2><p><strong>作用: 多个结果集合并查询的功能</strong></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#查询中国者美国的城市信息<br>SELECT * FROM city WHERE countrycode=&#x27;CHN&#x27; OR countrycode=&#x27;USA&#x27;;<br><br>#改写为:<br>SELECT * FROM city WHERE countrycode=&#x27;CHN&#x27;<br>UNION ALL<br>SELECT * FROM city WHERE countrycode=&#x27;USA&#x27;; <br></code></pre></td></tr></table></figure>

<p><strong>面试题: union 和 union all 的区别 ?</strong></p>
<p>union all  不做去重复</p>
<p>union 会做去重操作</p>
<h2 id="10-14-多表连接查询-内连接"><a href="#10-14-多表连接查询-内连接" class="headerlink" title="10.14 多表连接查询(内连接)"></a>10.14 多表连接查询(内连接)</h2><h3 id="10-14-1-单表数据不能满足查询需求时"><a href="#10-14-1-单表数据不能满足查询需求时" class="headerlink" title="10.14.1 单表数据不能满足查询需求时"></a>10.14.1 单表数据不能满足查询需求时</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#范例：查询世界上小于100人的城市,所在的国家名,国土面积,城市名,人口数<br>#city:<br>SELECT countrycode,NAME,population FROM city WHERE population&lt;100;<br>#结果：PCN Adamstown  42<br><br>#country：<br>SELECT NAME,SurfaceArea FROM country WHERE CODE=&#x27;PCN&#x27;;<br>#结果：Pitcairn 49.00<br></code></pre></td></tr></table></figure>

<h3 id="10-14-2-多表查询"><a href="#10-14-2-多表查询" class="headerlink" title="10.14.2 多表查询"></a>10.14.2 多表查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT<br>country.name,<br>country.surfacearea,<br>city.name,<br>city.population<br>FROM city<br>JOIN country<br>ON city.countrycode=country.code<br>WHERE city.population&lt;100;<br></code></pre></td></tr></table></figure>

<h3 id="10-14-3-多表连接基本语法要求"><a href="#10-14-3-多表连接基本语法要求" class="headerlink" title="10.14.3 多表连接基本语法要求"></a>10.14.3 多表连接基本语法要求</h3><ol>
<li>最核心的是找到多表之前的关联条件列</li>
<li>列书写时，下必须是：表名.列</li>
<li>所有涉及到的查询列，都放在select后</li>
<li>将所有的过滤，分组，排序等条件按顺序写在on后面</li>
<li>多表如何连接：from A join B on A=B join C B=C</li>
<li>注意：对多表连接中，驱动表选择数据行少的表。后续所有表的关联列尽量是主键或唯一键（表设计），至少建立一个索引</li>
</ol>
<h2 id="10-15-多表连接例子"><a href="#10-15-多表连接例子" class="headerlink" title="10.15 多表连接例子"></a>10.15 多表连接例子</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs mysql">use school<br>student：学生表<br>sno    ：学号<br>sname  ：学生姓名<br>sage   ：学生年龄<br>ssex   ：学生性别<br><br>teacher：教师表<br>tno    ：教师编号<br>tname  ：教师名字<br><br>course ：课程表<br>cno    ：课程编号<br>cname  ：课程名字<br>tno    ：教师编号<br><br>score  ：成绩表<br>sno    ：学号<br>cno    ：课程编号<br>score  ：成绩<br><br>#项目构建<br>drop database school;<br>CREATE DATABASE school CHARSET utf8;<br>USE school<br><br>CREATE TABLE student(<br>sno INT NOT NULL PRIMARY KEY AUTO_INCREMENT COMMENT &#x27;学号&#x27;,<br>sname VARCHAR(20) NOT NULL COMMENT &#x27;姓名&#x27;,<br>sage TINYINT UNSIGNED  NOT NULL COMMENT &#x27;年龄&#x27;,<br>ssex  ENUM(&#x27;f&#x27;,&#x27;m&#x27;) NOT NULL DEFAULT &#x27;m&#x27; COMMENT &#x27;性别&#x27;<br>)ENGINE=INNODB CHARSET=utf8;<br><br>CREATE TABLE course(<br>cno INT NOT NULL PRIMARY KEY COMMENT &#x27;课程编号&#x27;,<br>cname VARCHAR(20) NOT NULL COMMENT &#x27;课程名字&#x27;,<br>tno INT NOT NULL  COMMENT &#x27;教师编号&#x27;<br>)ENGINE=INNODB CHARSET utf8;<br><br>CREATE TABLE sc (<br>sno INT NOT NULL COMMENT &#x27;学号&#x27;,<br>cno INT NOT NULL COMMENT &#x27;课程编号&#x27;,<br>score INT  NOT NULL DEFAULT 0 COMMENT &#x27;成绩&#x27;<br>)ENGINE=INNODB CHARSET=utf8;<br><br>CREATE TABLE teacher(<br>tno INT NOT NULL PRIMARY KEY COMMENT &#x27;教师编号&#x27;,<br>tname VARCHAR(20) NOT NULL COMMENT &#x27;教师名字&#x27;<br>)ENGINE=INNODB CHARSET utf8;<br><br>INSERT INTO student(sno,sname,sage,ssex)<br>VALUES (1,&#x27;zhang3&#x27;,18,&#x27;m&#x27;);<br><br>INSERT INTO student(sno,sname,sage,ssex)<br>VALUES<br>(2,&#x27;zhang4&#x27;,18,&#x27;m&#x27;),<br>(3,&#x27;li4&#x27;,18,&#x27;m&#x27;),<br>(4,&#x27;wang5&#x27;,19,&#x27;f&#x27;);<br><br>INSERT INTO student<br>VALUES<br>(5,&#x27;zh4&#x27;,18,&#x27;m&#x27;),<br>(6,&#x27;zhao4&#x27;,18,&#x27;m&#x27;),<br>(7,&#x27;ma6&#x27;,19,&#x27;f&#x27;);<br><br>INSERT INTO student(sname,sage,ssex)<br>VALUES<br>(&#x27;oldboy&#x27;,20,&#x27;m&#x27;),<br>(&#x27;oldgirl&#x27;,20,&#x27;f&#x27;),<br>(&#x27;oldp&#x27;,25,&#x27;m&#x27;);<br><br>INSERT INTO teacher(tno,tname) VALUES<br>(101,&#x27;oldboy&#x27;),<br>(102,&#x27;hesw&#x27;),<br>(103,&#x27;oldguo&#x27;);<br><br>DESC course;<br>INSERT INTO course(cno,cname,tno)<br>VALUES<br>(1001,&#x27;linux&#x27;,101),<br>(1002,&#x27;python&#x27;,102),<br>(1003,&#x27;mysql&#x27;,103);<br><br>DESC sc;<br>INSERT INTO sc(sno,cno,score)<br>VALUES<br>(1,1001,80),<br>(1,1002,59),<br>(2,1002,90),<br>(2,1003,100),<br>(3,1001,99),<br>(3,1003,40),<br>(4,1001,79),<br>(4,1002,61),<br>(4,1003,99),<br>(5,1003,40),<br>(6,1001,89),<br>(6,1003,77),<br>(7,1001,67),<br>(7,1003,82),<br>(8,1001,70),<br>(9,1003,80),<br>(10,1003,96);<br><br>SELECT * FROM student;<br>SELECT * FROM teacher;<br>SELECT * FROM course;<br>SELECT * FROM sc;<br></code></pre></td></tr></table></figure>

<h3 id="10-15-1-统计zhang3-学习了几门课"><a href="#10-15-1-统计zhang3-学习了几门课" class="headerlink" title="10.15.1 统计zhang3,学习了几门课"></a>10.15.1 统计zhang3,学习了几门课</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT student.sname,COUNT(sc.cno)<br>FROM student JOIN sc<br>ON student.sno=sc.sno<br>WHERE student.sname=&#x27;zhang3&#x27;;<br></code></pre></td></tr></table></figure>

<h3 id="10-15-2-查询zhang3-学习的课程名称有哪些"><a href="#10-15-2-查询zhang3-学习的课程名称有哪些" class="headerlink" title="10.15.2 查询zhang3,学习的课程名称有哪些?"></a>10.15.2 查询zhang3,学习的课程名称有哪些?</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT student.sname,GROUP_CONCAT(course.cname)<br>FROM student<br>JOIN sc<br>ON student.sno=sc.sno<br>JOIN course<br>ON sc.cno=course.cno<br>WHERE student.sname=&#x27;zhang3&#x27;<br>GROUP BY student.sname;<br></code></pre></td></tr></table></figure>

<h3 id="10-15-3-查询oldguo老师教的学生名和个数"><a href="#10-15-3-查询oldguo老师教的学生名和个数" class="headerlink" title="10.15.3 查询oldguo老师教的学生名和个数"></a>10.15.3 查询oldguo老师教的学生名和个数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT teacher.tname,GROUP_CONCAT(student.sname),COUNT(student.sname)<br>FROM teacher<br>JOIN course<br>ON teacher.tno=course.tno<br>JOIN sc<br>ON course.cno=sc.cno<br>JOIN student<br>ON sc.sno=student.sno<br>WHERE teacher.tname=&#x27;oldguo&#x27;<br>GROUP BY teacher.tname;<br></code></pre></td></tr></table></figure>

<h3 id="10-15-4-查询oldguo所教课程的平均分数"><a href="#10-15-4-查询oldguo所教课程的平均分数" class="headerlink" title="10.15.4 查询oldguo所教课程的平均分数"></a>10.15.4 查询oldguo所教课程的平均分数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT teacher.tname,AVG(sc.score)<br>FROM teacher<br>JOIN course<br>ON teacher.tno=course.tno<br>JOIN sc<br>ON course.cno=sc.cno<br>WHERE teacher.tname=&#x27;oldguo&#x27;<br>GROUP BY sc.cno;<br></code></pre></td></tr></table></figure>

<h3 id="10-15-5-每位老师所教课程的平均分-并按平均分排序"><a href="#10-15-5-每位老师所教课程的平均分-并按平均分排序" class="headerlink" title="10.15.5 每位老师所教课程的平均分,并按平均分排序"></a>10.15.5 每位老师所教课程的平均分,并按平均分排序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT teacher.tname,course.cname,AVG(sc.score)<br>FROM teacher<br>JOIN course<br>ON teacher.tno=course.tno<br>JOIN sc<br>ON course.cno=sc.cno <br>GROUP BY teacher.tname,course.cname<br>ORDER BY AVG(sc.score);<br></code></pre></td></tr></table></figure>

<h3 id="10-15-6-查询oldguo所教的不及格的学生姓名"><a href="#10-15-6-查询oldguo所教的不及格的学生姓名" class="headerlink" title="10.15.6 查询oldguo所教的不及格的学生姓名"></a>10.15.6 查询oldguo所教的不及格的学生姓名</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT teacher.tname,student.sname,sc.score<br>FROM teacher<br>JOIN course<br>ON teacher.tno=course.tno<br>JOIN sc<br>ON course.cno=sc.cno<br>JOIN student<br>ON sc.sno=student.sno<br>WHERE teacher.tname=&#x27;oldguo&#x27; AND sc.score&lt;60;<br></code></pre></td></tr></table></figure>

<h3 id="10-15-7-查询所有老师所教学生不及格的信息-扩展"><a href="#10-15-7-查询所有老师所教学生不及格的信息-扩展" class="headerlink" title="10.15.7 查询所有老师所教学生不及格的信息(扩展)"></a>10.15.7 查询所有老师所教学生不及格的信息(扩展)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT teacher.tname,GROUP_CONCAT(CONCAT(student.sname,&quot;:&quot;,sc.score))<br>FROM teacher<br>JOIN course<br>ON teacher.tno=course.tno<br>JOIN sc<br>ON course.cno=sc.cno<br>JOIN student<br>ON sc.sno=student.sno<br>WHERE sc.score&lt;60<br>GROUP BY teacher.tno;<br></code></pre></td></tr></table></figure>

<h2 id="10-16-别名应用"><a href="#10-16-别名应用" class="headerlink" title="10.16 别名应用"></a>10.16 别名应用</h2><h3 id="10-16-1-表别名"><a href="#10-16-1-表别名" class="headerlink" title="10.16.1 表别名"></a>10.16.1 表别名</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：表名 as 表别名<br>#范例：<br>SELECT t.tname,GROUP_CONCAT(CONCAT(st.sname,&quot;:&quot;,sc.score))<br>FROM teacher as t<br>JOIN course as c<br>ON t.tno=c.tno<br>JOIN sc <br>ON c.cno=sc.cno<br>JOIN student as st<br>ON sc.sno=st.sno<br>WHERE sc.score&lt;60<br>GROUP BY t.tno<br></code></pre></td></tr></table></figure>

<p><strong>注意：表别名是全局调用的.</strong></p>
<h3 id="10-16-2-列别名"><a href="#10-16-2-列别名" class="headerlink" title="10.16.2 列别名"></a>10.16.2 列别名</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：列名 as 列别名<br>#范例：<br>SELECT t.tname as 讲师名 ,GROUP_CONCAT(CONCAT(st.sname,&quot;:&quot;,sc.score)) as 不及格的<br>FROM teacher as t<br>JOIN course as c<br>ON t.tno=c.tno<br>JOIN sc <br>ON c.cno=sc.cno<br>JOIN student as st<br>ON sc.sno=st.sno<br>WHERE sc.score&lt;60<br>GROUP BY t.tno<br>列别名可以被 having 和 order by 调用<br></code></pre></td></tr></table></figure>

<h2 id="10-17-扩展类内容-元数据获取"><a href="#10-17-扩展类内容-元数据获取" class="headerlink" title="10.17 扩展类内容-元数据获取 ***"></a>10.17 扩展类内容-元数据获取 ***</h2><h3 id="10-17-1-元数据介绍及获取介绍"><a href="#10-17-1-元数据介绍及获取介绍" class="headerlink" title="10.17.1 元数据介绍及获取介绍"></a>10.17.1 元数据介绍及获取介绍</h3><p>元数据是存储在”基表”中。</p>
<p>通过专用的DDL语句，DCL语句进行修改</p>
<p>通过专用视图和命令进行元数据的查询</p>
<p>information_schema中保存了大量元数据查询的试图</p>
<p>show 命令是封装好功能，提供元数据查询基础功能</p>
<h3 id="10-17-2-information-schema的基本应用"><a href="#10-17-2-information-schema的基本应用" class="headerlink" title="10.17.2 information_schema的基本应用 ***"></a>10.17.2 information_schema的基本应用 ***</h3><p><strong>tables 视图的应用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; use information_schema;<br>mysql&gt; desc tables;<br>TABLE_SCHEMA        表所在的库名<br>TABLE_NAME			表名<br>ENGINE				存储引擎<br>TABLE_ROWS			数据行<br>AVG_ROW_LENGTH		平均行长度<br>INDEX_LENGTH        索引长度<br><br>#使用格式：..... from inforrmation_schema.tables<br></code></pre></td></tr></table></figure>

<h3 id="10-17-3-显示所有的库和表的信息"><a href="#10-17-3-显示所有的库和表的信息" class="headerlink" title="10.17.3 显示所有的库和表的信息"></a>10.17.3 显示所有的库和表的信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT table_schema,table_name FROM information_schema.tables;<br></code></pre></td></tr></table></figure>

<h3 id="10-17-4-以下模式，显示所有的库和表的信息"><a href="#10-17-4-以下模式，显示所有的库和表的信息" class="headerlink" title="10.17.4 以下模式，显示所有的库和表的信息"></a>10.17.4 以下模式，显示所有的库和表的信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#world city,country,countrylanguage<br>SELECT table_schema,GROUP_CONCAT(table_name) <br>FROM information_schema.tables<br>GROUP BY table_schema;<br></code></pre></td></tr></table></figure>

<h3 id="10-17-5-查询所有innodb引擎的表"><a href="#10-17-5-查询所有innodb引擎的表" class="headerlink" title="10.17.5 查询所有innodb引擎的表"></a>10.17.5 查询所有innodb引擎的表</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT table_schema,table_name,ENGINE<br>FROM information_schema.tables <br>WHERE ENGINE=&#x27;innodb&#x27;;<br></code></pre></td></tr></table></figure>

<h3 id="10-17-6-统计world下的city表占用空间大小"><a href="#10-17-6-统计world下的city表占用空间大小" class="headerlink" title="10.17.6 统计world下的city表占用空间大小"></a>10.17.6 统计world下的city表占用空间大小</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#表的数据量=平均行长度*行数+索引长度<br>#提示：AVG_ROW_LENGTH*TABLE_ROWS+INDEX_LENGTH<br>SELECT table_name,(AVG_ROW_LENGTH*TABLE_ROWS+INDEX_LENGTH)/1024<br>FROM information_schema.TABLES<br>WHERE table_schema=&#x27;world&#x27; AND table_name=&#x27;city&#x27;;<br></code></pre></td></tr></table></figure>

<h3 id="10-17-7-统计world库数据量总大小"><a href="#10-17-7-统计world库数据量总大小" class="headerlink" title="10.17.7 统计world库数据量总大小"></a>10.17.7 统计world库数据量总大小</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT table_schema,SUM((AVG_ROW_LENGTH*TABLE_ROWS+INDEX_LENGTH))/1024<br>FROM information_schema.TABLES<br>WHERE table_schema=&#x27;world&#x27;;<br></code></pre></td></tr></table></figure>

<h3 id="10-17-8-统计每个库的数据量大小，并按数据量从大到小排序"><a href="#10-17-8-统计每个库的数据量大小，并按数据量从大到小排序" class="headerlink" title="10.17.8 统计每个库的数据量大小，并按数据量从大到小排序"></a>10.17.8 统计每个库的数据量大小，并按数据量从大到小排序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT table_schema,SUM((AVG_ROW_LENGTH*TABLE_ROWS+INDEX_LENGTH))/1024 AS total_KB<br>FROM information_schema.TABLES<br>GROUP BY table_schema<br>ORDER BY total_KB DESC;<br></code></pre></td></tr></table></figure>

<h2 id="10-18-配合concat-函数拼接语句或命令"><a href="#10-18-配合concat-函数拼接语句或命令" class="headerlink" title="10.18 配合concat()函数拼接语句或命令"></a>10.18 配合concat()函数拼接语句或命令</h2><h3 id="10-18-1-模仿以下语句-进行数据库的分库分表备份"><a href="#10-18-1-模仿以下语句-进行数据库的分库分表备份" class="headerlink" title="10.18.1 模仿以下语句,进行数据库的分库分表备份"></a>10.18.1 模仿以下语句,进行数据库的分库分表备份</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysqldump -uroot -p123 world city &gt;/bak/world_city.sql<br><br>SELECT <br>CONCAT(&quot;mysqldump -uroot -p123 &quot;,table_schema,&quot; &quot;,table_name,&quot; &gt;/bak/&quot;,table_schema,&quot;_&quot;,table_name,&quot;.sql&quot;)<br>FROM information_schema.tables;<br></code></pre></td></tr></table></figure>

<h3 id="10-18-2-模仿以下语句-进行批量生成对world库下所有表进行操作"><a href="#10-18-2-模仿以下语句-进行批量生成对world库下所有表进行操作" class="headerlink" title="10.18.2 模仿以下语句,进行批量生成对world库下所有表进行操作"></a>10.18.2 模仿以下语句,进行批量生成对world库下所有表进行操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">ALTER TABLE world.city DISCARD TABLESPACE;<br><br>SELECT<br>CONCAT(&quot;ALTER TABLE &quot;,table_schema,&quot;.&quot;,table_name,&quot; DISCARD TABLESPACE;&quot;)<br>FROM information_schema.tables<br>WHERE table_schema=&#x27;world&#x27;;<br></code></pre></td></tr></table></figure>

<h2 id="10-19show介绍"><a href="#10-19show介绍" class="headerlink" title="10.19show介绍*****"></a>10.19show介绍*****</h2><table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>show databases;</td>
<td>查看数据库名</td>
</tr>
<tr>
<td>show tables;</td>
<td>查看表名</td>
</tr>
<tr>
<td>show create database xx;</td>
<td>查看建库语句</td>
</tr>
<tr>
<td>show create table xx;</td>
<td>查看建表语句</td>
</tr>
<tr>
<td>show processlist;</td>
<td>查看所有用户连接情况</td>
</tr>
<tr>
<td>show charset;</td>
<td>查看支持的字符集</td>
</tr>
<tr>
<td>show collation;</td>
<td>查看所有支持的校对规则</td>
</tr>
<tr>
<td>show grants for xx;</td>
<td>查看用户的权限信息</td>
</tr>
<tr>
<td>show variables like ‘%xx%’</td>
<td>查看参数信息</td>
</tr>
<tr>
<td>show engines;</td>
<td>查看所有支持的存储引擎类型</td>
</tr>
<tr>
<td>show index from xxx;</td>
<td>查看表的索引信息</td>
</tr>
<tr>
<td>show engine innodb status\G;</td>
<td>查看innoDB引擎详细状态信息</td>
</tr>
<tr>
<td>show binary logs;</td>
<td>查看二进制日志的列表信息</td>
</tr>
<tr>
<td>show binlog events in ‘xxx’;</td>
<td>查看二进制日志的事件信息</td>
</tr>
<tr>
<td>show master status ;</td>
<td>查看mysql当前使用二进制日志信息</td>
</tr>
<tr>
<td>show slave status\G;</td>
<td>查看从库状态信息</td>
</tr>
<tr>
<td>show relaylog events in ‘ ‘;</td>
<td>查看中继日志的事件信息</td>
</tr>
<tr>
<td>show status like ‘xxx’;</td>
<td>查看数据库整体状态信息</td>
</tr>
</tbody></table>
<h1 id="十一、索引"><a href="#十一、索引" class="headerlink" title="十一、索引"></a>十一、索引</h1><h2 id="11-1-索引的作用"><a href="#11-1-索引的作用" class="headerlink" title="11.1 索引的作用"></a>11.1 索引的作用</h2><p><strong>类似于一本书中的目录,起到优化查询的作用</strong></p>
<h2 id="11-2-索引的分类-算法"><a href="#11-2-索引的分类-算法" class="headerlink" title="11.2. 索引的分类(算法)"></a>11.2. 索引的分类(算法)</h2><p>B树  默认使用的索引类型</p>
<p>R树</p>
<p>Hash</p>
<p>FullText </p>
<p>GIS 索引</p>
<h2 id="11-3-BTREE索引算法演变（了解）"><a href="#11-3-BTREE索引算法演变（了解）" class="headerlink" title="11.3 BTREE索引算法演变（了解）"></a>11.3 BTREE索引算法演变（了解）</h2><p><img src="file:///C:\Users\kinci\AppData\Local\Temp\ksohtml\wps3782.tmp.png" srcset="/blog/img/loading.gif" alt="img"> </p>
<h2 id="11-4-Btree索引功能上的分类"><a href="#11-4-Btree索引功能上的分类" class="headerlink" title="11.4 Btree索引功能上的分类"></a>11.4 Btree索引功能上的分类</h2><h3 id="11-4-1-辅助索引"><a href="#11-4-1-辅助索引" class="headerlink" title="11.4.1 辅助索引"></a>11.4.1 辅助索引</h3><ol>
<li>提取索引列的所有值,进行排序</li>
<li>将排好序的值,均匀的存放在叶子节点,进一步生成枝节点和根节点</li>
<li>在叶子节点中的值,都会对应存储主键ID</li>
</ol>
<h3 id="11-4-2-聚集索引"><a href="#11-4-2-聚集索引" class="headerlink" title="11.4.2 聚集索引"></a>11.4.2 聚集索引</h3><ol>
<li>MySQL 会自动选择主键作为聚集索引列,没有主键会选择唯一键,如果都没有会生成隐藏的.</li>
<li>MySQL进行存储数据时,会按照聚集索引列值得顺序,有序存储数据行</li>
<li>聚集索引直接将原表数据页,作为叶子节点,然后提取聚集索引列向上生成枝和根</li>
</ol>
<h3 id="11-4-3-聚集索引和辅助索引的区别"><a href="#11-4-3-聚集索引和辅助索引的区别" class="headerlink" title="11.4.3 聚集索引和辅助索引的区别"></a>11.4.3 聚集索引和辅助索引的区别</h3><ol>
<li>表中任何一个列都可以创建辅助索引,在你有需要的时候,只要名字不同即可</li>
<li>在一张表中,聚集索引只能有一个,一般是主键.</li>
<li>辅助索引,叶子节点只存储索引列的有序值+聚集索引列值.</li>
<li>聚集索引,叶子节点存储的时有序的整行数据.</li>
<li>MySQL 的表数据存储是聚集索引组织表</li>
</ol>
<h2 id="11-5-辅助索引细分"><a href="#11-5-辅助索引细分" class="headerlink" title="11.5 辅助索引细分"></a>11.5 辅助索引细分</h2><ul>
<li>单列辅助索引</li>
<li>联合索引(覆盖索引) *</li>
<li>唯一索引</li>
<li>前缀索引</li>
</ul>
<h2 id="11-6-索引树高度"><a href="#11-6-索引树高度" class="headerlink" title="11.6. 索引树高度"></a>11.6. 索引树高度</h2><p><strong>索引树高度应当越低越好,一般维持在3-4最佳</strong></p>
<h3 id="11-6-1-数据行数较多"><a href="#11-6-1-数据行数较多" class="headerlink" title="11.6.1 数据行数较多"></a>11.6.1 数据行数较多</h3><p>分表 : parttion用的比较少了.</p>
<p>分片,分布式架构.</p>
<h3 id="11-6-2-字段长度"><a href="#11-6-2-字段长度" class="headerlink" title="11.6.2 字段长度"></a>11.6.2 字段长度</h3><p>业务允许,尽量选择字符长度短的列作为索引列</p>
<p>业务不允许,采用前缀索引.</p>
<h3 id="11-6-3-数据类型"><a href="#11-6-3-数据类型" class="headerlink" title="11.6.3 数据类型"></a>11.6.3 数据类型</h3><p>char 和 varchar </p>
<p>enum </p>
<h2 id="11-7-索引的命令操作"><a href="#11-7-索引的命令操作" class="headerlink" title="11.7. 索引的命令操作"></a>11.7. 索引的命令操作</h2><h3 id="11-7-1-查询索引"><a href="#11-7-1-查询索引" class="headerlink" title="11.7.1 查询索引"></a>11.7.1 查询索引</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>SHOW INDEXES FROM [db_name.]tbl_name;<br><br>#例子：<br>show index from city\G<br>desc city;<br><br>PRI  ==&gt; 主键索引 <br>MUL  ==&gt; 辅助索引<br>UNI  ==&gt; 唯一索引 <br></code></pre></td></tr></table></figure>

<h2 id="11-7-2-创建索引"><a href="#11-7-2-创建索引" class="headerlink" title="11.7.2 创建索引"></a>11.7.2 创建索引</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>CREATE [UNIQUE] INDEX index_name ON tbl_name (index_col_name[(length)],...);<br>ALTER TABLE tbl_name ADD INDEX index_name(index_col_name[(length)]);<br>help CREATE INDEX;<br><br>#例子：<br>#单列的辅助索引:<br>mysql&gt; alter table city add index idx_name(name);<br><br>#多列的联合索引:<br>mysql&gt; alter table city add index idx_c_p(countrycode,population);<br><br>#唯一索引: <br>mysql&gt; alter table city add unique index uidx_dis(district);<br>mysql&gt; select count(district) from city;<br>mysql&gt; select count(distinct district) from city;<br><br>#前缀索引:<br>mysql&gt; alter table city add index idx_dis(district(5));<br></code></pre></td></tr></table></figure>

<h3 id="11-7-3-删除索引"><a href="#11-7-3-删除索引" class="headerlink" title="11.7.3 删除索引"></a>11.7.3 删除索引</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>DROP INDEX index_name ON tbl_name;<br>ALTER TABLE tbl_name DROP INDEX index_name(index_col_name);<br><br>#例子：<br>mysql&gt; alter table city drop index idx_name;<br>mysql&gt; alter table city drop index idx_c_p;<br>#mysql&gt; alter table city drop index idx_dis;<br></code></pre></td></tr></table></figure>

<h3 id="11-7-4-优化表空间"><a href="#11-7-4-优化表空间" class="headerlink" title="11.7.4 优化表空间"></a>11.7.4 优化表空间</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式：<br>OPTIMIZE TABLE tb_name;<br></code></pre></td></tr></table></figure>

<h3 id="11-7-5-查看索引的使用"><a href="#11-7-5-查看索引的使用" class="headerlink" title="11.7.5 查看索引的使用"></a>11.7.5 查看索引的使用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SET GLOBAL userstat=1;<br>SHOW INDEX_STATISTICS;<br></code></pre></td></tr></table></figure>

<h2 id="11-8-压力测试"><a href="#11-8-压力测试" class="headerlink" title="11.8. 压力测试"></a>11.8. 压力测试</h2><h3 id="11-8-1-准备"><a href="#11-8-1-准备" class="headerlink" title="11.8.1 准备"></a>11.8.1 准备</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; use test<br>mysql&gt; source /tmp/t100w.sql<br></code></pre></td></tr></table></figure>

<h3 id="11-8-2-未做优化之前测试"><a href="#11-8-2-未做优化之前测试" class="headerlink" title="11.8.2 未做优化之前测试"></a>11.8.2 未做优化之前测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqlslap --defaults-file=/etc/my.cnf \<br>--concurrency=100 --iterations=1 --create-schema=<span class="hljs-string">&#x27;test&#x27;</span> \<br>--query=<span class="hljs-string">&quot;select * from test.t100w where k2=&#x27;MN89&#x27;&quot;</span> engine=innodb \<br>--number-of-queries=2000 -uroot -p123 -verbose<br><br><span class="hljs-comment">#结果：</span><br>[root@db01 ~]<span class="hljs-comment"># mysqlslap --defaults-file=/etc/my.cnf \</span><br>\&gt; --concurrency=100 --iterations=1 --create-schema=<span class="hljs-string">&#x27;test&#x27;</span> \<br>\&gt; --query=<span class="hljs-string">&quot;select * from test.t100w where k2=&#x27;MN89&#x27;&quot;</span> engine=innodb \<br>\&gt; --number-of-queries=2000 -uroot -p123 -verbose<br>mysqlslap: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Benchmark<br>​	Running <span class="hljs-keyword">for</span> engine rbose<br>​	Average number of seconds to run all queries: 755.861 seconds<br>​	Minimum number of seconds to run all queries: 755.861 seconds<br>​	Maximum number of seconds to run all queries: 755.861 seconds<br>​	Number of clients running queries: 100<br>​	Average number of queries per client: 20<br></code></pre></td></tr></table></figure>

<h3 id="11-8-3-索引优化后"><a href="#11-8-3-索引优化后" class="headerlink" title="11.8.3 索引优化后"></a>11.8.3 索引优化后</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">[root@db01 ~]# mysqlslap --defaults-file=/etc/my.cnf --concurrency=100 --iterations=1 --create-schema=&#x27;test&#x27; --query=&quot;select * from test.t100w where k2=&#x27;MN89&#x27;&quot; engine=innodb --number-of-queries=2000 -uroot -p123 -verbose<br><br>mysqlslap: [Warning] Using a password on the command line interface can be insecure.<br>Benchmark<br>​	Running for engine rbose<br>​	Average number of seconds to run all queries: 1.678 seconds<br>​	Minimum number of seconds to run all queries: 1.678 seconds<br>​	Maximum number of seconds to run all queries: 1.678 seconds<br>​	Number of clients running queries: 100<br>​	Average number of queries per client: 20<br></code></pre></td></tr></table></figure>

<h2 id="11-9-执行计划分析"><a href="#11-9-执行计划分析" class="headerlink" title="11.9 执行计划分析"></a>11.9 执行计划分析</h2><h3 id="11-9-1-作用"><a href="#11-9-1-作用" class="headerlink" title="11.9.1 作用"></a>11.9.1 作用</h3><p>选择优化器后的执行计划,将结果截取出来.便于管理管判断语句得执行效率.</p>
<h3 id="11-9-2-获取执行"><a href="#11-9-2-获取执行" class="headerlink" title="11.9.2 获取执行"></a>11.9.2 获取执行</h3><p>格式：</p>
<p>desc  SQL语句</p>
<p>explain SQL 语句</p>
<p>范例：</p>
<p>mysql&gt; desc select * from test.t100w where k2=’MN89’;</p>
<p>+—-+——————+———-+—————-+——-+———————-+———-+————+——–+—————+———–+——————-+</p>
<p>| id | select_type | table   | partitions | type | possible_keys | key     | key_len | ref     | rows        | filtered | Extra             |</p>
<p>+—-+——————+——–+—————-+——–+———————–+———-+————+———+————–+———–+——————–+</p>
<p>| 1 |     SIMPLE     | t100w |     NULL    |  ALL  | NULL                | NULL | NULL     | NULL | 1027638 |10.00    | Using where |</p>
<p>+—-+——————+———-+—————+———+———————+———-+————+———-+————–+———–+——————–+</p>
<h3 id="11-9-3-分析执行计划"><a href="#11-9-3-分析执行计划" class="headerlink" title="11.9.3 分析执行计划"></a>11.9.3 分析执行计划</h3><h4 id="11-9-3-1-table"><a href="#11-9-3-1-table" class="headerlink" title="11.9.3.1 table"></a>11.9.3.1 table</h4><p>表名</p>
<h4 id="11-9-3-2-type"><a href="#11-9-3-2-type" class="headerlink" title="11.9.3.2 type"></a>11.9.3.2 type</h4><p>查询的类型:</p>
<p>全表扫描      : ALL </p>
<p>索引扫描      : index,range,ref,eq_ref,const(system),NULL （越往右效率越高）</p>
<h4 id="11-9-3-3-范例"><a href="#11-9-3-3-范例" class="headerlink" title="11.9.3.3 范例"></a>11.9.3.3 范例</h4><p><strong>ALL：全表扫描</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select * from t1;<br>select * from t1 where t1 where xxx where 条件无索引<br>select * from t1 where t1 where != not in like &#x27;%xaa%&#x27; <br></code></pre></td></tr></table></figure>

<p><strong>index: 全索引扫描</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">desc select countrycode from city;<br></code></pre></td></tr></table></figure>

<p><strong>range: 索引范围扫描(&gt; &lt; &gt;= &lt;= , between and ,or,in,like )</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">desc select * from city where id&gt;2000;<br>desc select * from city where countrycode like &#x27;CH%&#x27;;<br></code></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<p><strong>对于辅助索引来讲,!= 和not in等语句是不走索引的</strong></p>
<p><strong>对于主键索引列来讲,!= 和not in等语句是走range</strong></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#将以上两种含有“in”或“or”一般改写为 union all <br>#修改前<br>desc select * from city where countrycode=&#x27;CHN&#x27; or countrycode=&#x27;USA&#x27;;<br>desc select * from city where countrycode in (&#x27;CHN&#x27;,&#x27;USA&#x27;);<br><br>#修改后<br>desc <br>select * from city where countrycode=&#x27;CHN&#x27; <br>union all <br>select * from city where countrycode=&#x27;USA&#x27;;<br></code></pre></td></tr></table></figure>

<p><strong>ref: 辅助索引等值查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">desc <br>select * from city where countrycode=&#x27;CHN&#x27; <br>union all <br>select * from city where countrycode=&#x27;USA&#x27;;<br></code></pre></td></tr></table></figure>

<p><strong>eq_ref : 多表连接时,子表使用主键列或唯一列作为连接条件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#格式<br>A join B <br>on a.x = B.y <br><br>#范例<br>desc select b.name,a.name ,a.population <br>from city as a <br>join country as b <br>on a.countrycode=b.code <br>where a.population&lt;100;<br></code></pre></td></tr></table></figure>

<p><strong>const(system) : 主键或者唯一键的等值查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">desc select * from city where id=100;<br></code></pre></td></tr></table></figure>

<h2 id="11-10-possible-key"><a href="#11-10-possible-key" class="headerlink" title="11.10 possible_key"></a>11.10 possible_key</h2><p>可能会用到的索引 </p>
<h2 id="11-11-key"><a href="#11-11-key" class="headerlink" title="11.11 key"></a>11.11 key</h2><p>真正选择了哪个索引</p>
<h2 id="11-12-key-len"><a href="#11-12-key-len" class="headerlink" title="11.12 key_len"></a>11.12 key_len</h2><p>索引覆盖长度</p>
<p>如：</p>
<p>varchar(20) utf8mb4</p>
<ol>
<li><p>能存20个任意字符</p>
</li>
<li><p>不管存储的是字符,数字,中文,每1个字符最大预留长度是4个字节</p>
</li>
<li><p>对于中文,1个占4个字节 </p>
</li>
<li><p>对于数字和字母,1个实际占用大小是1个字节</p>
</li>
</ol>
<p>select length() from test;</p>
<h2 id="11-13-联合索引应用细节"><a href="#11-13-联合索引应用细节" class="headerlink" title="11.13 联合索引应用细节"></a>11.13 联合索引应用细节</h2><h3 id="11-13-1-只要我们将来的查询-所有索引列都是-lt-等值-gt-查询条件下-无关排列顺序"><a href="#11-13-1-只要我们将来的查询-所有索引列都是-lt-等值-gt-查询条件下-无关排列顺序" class="headerlink" title="11.13.1 只要我们将来的查询,所有索引列都是&lt;等值&gt;查询条件下,无关排列顺序"></a>11.13.1 只要我们将来的查询,所有索引列都是&lt;等值&gt;查询条件下,无关排列顺序</h3><p>注意：要把唯一值多的列放在最左侧</p>
<p>原因: 优化器,自动做查询条件的排列</p>
<p>abcd </p>
<p>acbd</p>
<p>adbc</p>
<p>acbd</p>
<p>等等</p>
<p>desc select * from test where k1=’aa’ and k2=’中国’ and k3=’aaaa’ and k4=’中国你好’;</p>
<p>desc select * from test where k2=’中国’ and k3=’aaaa’ and k4=’中国你好’ and k1=’aa’;</p>
<h3 id="11-13-2-不连续部分条件"><a href="#11-13-2-不连续部分条件" class="headerlink" title="11.13.2 不连续部分条件"></a>11.13.2 不连续部分条件</h3><p>注意：不连续中找到两连的列排再左侧</p>
<p>cda  —-&gt; acd  —&gt; a —–&gt; idx(c,d,a)</p>
<p>dba  —-&gt; abd  —&gt; ab —-&gt; idx(d,b,a)</p>
<h3 id="11-13-3-在where查询中如果出现-gt-lt-gt-lt-like"><a href="#11-13-3-在where查询中如果出现-gt-lt-gt-lt-like" class="headerlink" title="11.13.3 在where查询中如果出现&gt; &lt; &gt;= &lt;= like"></a>11.13.3 在where查询中如果出现&gt; &lt; &gt;= &lt;= like</h3><p>**注意：把这种不等值的列放到最后，建索引也要放到最后 **</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#范例1：<br>desc select * from test where k1=&#x27;aa&#x27; and k3=&#x27;aaaa&#x27; and k4=&#x27;中国你好&#x27; and k2&gt;&#x27;中国&#x27;;<br><br>#范例2：<br>alter table test add index idx1(k1,k3,k4,k2);<br></code></pre></td></tr></table></figure>

<h3 id="11-13-4-多子句查询-应用联合索引"><a href="#11-13-4-多子句查询-应用联合索引" class="headerlink" title="11.13.4 多子句查询,应用联合索引"></a>11.13.4 多子句查询,应用联合索引</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">desc select * from test where k1=&#x27;aa&#x27; order by k2;<br>alter table test add index idx3(k1,k2);<br></code></pre></td></tr></table></figure>

<h3 id="11-13-5-Extra：Using-filesort"><a href="#11-13-5-Extra：Using-filesort" class="headerlink" title="11.13.5 Extra：Using filesort"></a>11.13.5 Extra：Using filesort</h3><p><strong>出现Using filesort，说明在查询中有关排序的条件列没有合理的应用索引</strong></p>
<p>order by</p>
<p>group by</p>
<p>distinct</p>
<p>union </p>
<p>关注key_len应用的长度</p>
<h2 id="11-14-explain-desc-使用场景（面试题）"><a href="#11-14-explain-desc-使用场景（面试题）" class="headerlink" title="11.14 explain(desc)使用场景（面试题）"></a>11.14 explain(desc)使用场景（面试题）</h2><p>你做过哪些优化?</p>
<p>你用过什么优化工具?</p>
<p>你对索引这块怎么优化的?</p>
<p>题目意思: 我们公司业务慢,请你从数据库的角度分析原因</p>
<p>mysql出现性能问题,我总结有两种情况:</p>
<p>（1）应急性的慢：突然夯住</p>
<p>应急情况:数据库hang(卡了,资源耗尽)</p>
<p>处理过程:</p>
<ol>
<li><p>show processlist; 获取到导致数据库hang的语句</p>
</li>
<li><p>explain 分析SQL的执行计划,有没有走索引,索引的类型情况</p>
</li>
<li><p>建索引,改语句</p>
</li>
</ol>
<p>（2）一段时间慢(持续性的):</p>
<ol>
<li><p>记录慢日志slowlog,分析slowlog</p>
</li>
<li><p>explain 分析SQL的执行计划,有没有走索引,索引的类型情况</p>
</li>
<li><p>建索引,改语句 </p>
</li>
</ol>
<h2 id="11-15-索引应用规范"><a href="#11-15-索引应用规范" class="headerlink" title="11.15 索引应用规范"></a>11.15 索引应用规范</h2><p>建立索引的原则（DBA运维规范）</p>
<ol>
<li><p>建表必须要有主键,一般是无关列,自增长</p>
</li>
<li><p>经常做为where条件列 order by group by join on, distinct 的条件</p>
</li>
<li><p>最好使用唯一值多的列作为联合索引前导列,其他的按照联合索引优化细节来做</p>
</li>
<li><p>列值长度较长的索引列,我们建议使用前缀索引.</p>
</li>
<li><p>降低索引条目,一方面不要创建没用索引,不常使用的索引清理,percona toolkit(xxxxx)</p>
</li>
<li><p>索引维护要避开业务繁忙期</p>
</li>
<li><p>小表不建索引</p>
</li>
</ol>
<h2 id="11-16-不走索引的情况（开发规范）"><a href="#11-16-不走索引的情况（开发规范）" class="headerlink" title="11.16 不走索引的情况（开发规范）"></a>11.16 不走索引的情况（开发规范）</h2><ol>
<li><p>没有查询条件，或者查询条件没有建立索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select * from city;<br>select * from city where 1=1;<br></code></pre></td></tr></table></figure></li>
<li><p>查询结果集是原表中的大部分数据，应该是25％以上。</p>
</li>
<li><p>索引本身失效，统计数据不真实</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">面试题:同一个语句突然变慢?<br>统计信息过旧,导致的索引失效<br></code></pre></td></tr></table></figure></li>
<li><p>查询条件使用函数在索引列上，或者对索引列进行运算，运算包括(+，-，*，/，! 等)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">desc select * from city where id-99=1;<br></code></pre></td></tr></table></figure></li>
<li><p>隐式转换导致索引失效.</p>
</li>
<li><p> &lt;&gt; ，not in 不走索引（辅助索引）</p>
</li>
<li><p> like “%aa” 百分号在最前面不走</p>
</li>
<li><p>联合索引</p>
</li>
</ol>
<h1 id="十二、存储引擎"><a href="#十二、存储引擎" class="headerlink" title="十二、存储引擎"></a>十二、存储引擎</h1><h2 id="12-1-简介"><a href="#12-1-简介" class="headerlink" title="12.1 简介"></a>12.1 简介</h2><p>相当于Linux文件系统，只不过比文件系统强大</p>
<h2 id="12-2-功能了解"><a href="#12-2-功能了解" class="headerlink" title="12.2 功能了解"></a>12.2 功能了解</h2><ul>
<li>数据读写</li>
<li>数据安全和一致性</li>
<li>提高性能</li>
<li>热备份</li>
<li>自动故障恢复</li>
<li>高可用方面支持</li>
<li>等.</li>
</ul>
<h2 id="12-3-存储引擎介绍"><a href="#12-3-存储引擎介绍" class="headerlink" title="12.3 存储引擎介绍"></a>12.3 存储引擎介绍</h2><p>show engies;</p>
<p>CSV        </p>
<p>MRG_MYISAM    </p>
<p>MyISAM      </p>
<p>BLACKHOLE     </p>
<p>PERFORMANCE_SCHEMA</p>
<p>MEMORY      </p>
<p>ARCHIVE      </p>
<p>InnoDB      </p>
<p>FEDERATED  </p>
<blockquote>
<p>笔试题:</p>
<p>问：你知道mysql有什么存储引擎 </p>
<p>答：InnoDB ,MyISAM ,MEMORY,CSV</p>
</blockquote>
<p>MySQL默认的存储引擎是：InnoDB</p>
<p>PerconaDB默认的存储引擎是：XtraDB</p>
<p>MariaDB默认的存储引擎是：InnoDB</p>
<p>第三方的存储引擎:</p>
<p>RocksDB MyRocks TokuDB</p>
<p>压缩比较高,数据的插入性能高.其他功能和InnoDB没差. </p>
<h2 id="12-4-简历案例—zabbix监控系统架构整改-真实案例"><a href="#12-4-简历案例—zabbix监控系统架构整改-真实案例" class="headerlink" title="12.4 简历案例—zabbix监控系统架构整改(真实案例)"></a>12.4 简历案例—zabbix监控系统架构整改(真实案例)</h2><p>环境: zabbix 3.2  mariaDB 5.5 centos 7.3</p>
<p><font color="red">现象 : zabbix卡的要死 , 每隔3-4个月,都要重新搭建一遍zabbix,存储空间经常爆满.</font></p>
<blockquote>
<p>问题分析 :</p>
<ol>
<li><p>zabbix 版本低</p>
</li>
<li><p>数据库版本低</p>
</li>
<li><p>zabbix数据库500G,存在一个文件里</p>
</li>
</ol>
<p>优化建议:</p>
<ol>
<li><p>数据库版本升级到mariaDB最新版本,zabbix升级更高版本</p>
</li>
<li><p>存储引擎改为tokudb</p>
</li>
<li><p>监控数据按月份进行切割(二次开发:zabbix 数据保留机制功能重写,数据库分表)</p>
</li>
<li><p>关闭binlog和双1</p>
</li>
<li><p>参数调整….</p>
</li>
</ol>
<p>优化结果:</p>
<p>监控状态良好</p>
<p><font color="red">优化原因（为什么这样优化）</font></p>
<ol>
<li><p>原生态支持TokuDB,另外经过测试环境,10版本要比5.5 版本性能 高 2-3倍</p>
</li>
<li><p>TokuDB:insert数据比Innodb快的多，数据压缩比要Innodb高</p>
</li>
<li><p>监控数据按月份进行切割,为了能够truncate每个分区表,立即释放空间</p>
</li>
<li><p>关闭binlog —–&gt;减少无关日志的记录.</p>
</li>
<li><p>参数调整…—–&gt;安全性参数关闭,提高性能.</p>
</li>
</ol>
</blockquote>
<h2 id="12-5-InnoDB-存储引擎核心特性说明（innodb和myisam的区别）"><a href="#12-5-InnoDB-存储引擎核心特性说明（innodb和myisam的区别）" class="headerlink" title="12.5 InnoDB 存储引擎核心特性说明（innodb和myisam的区别）"></a>12.5 InnoDB 存储引擎核心特性说明（innodb和myisam的区别）</h2><p>详细参考博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35642036/article/details/82820178">https://blog.csdn.net/qq_35642036/article/details/82820178</a></p>
<p>事务 </p>
<p>行锁</p>
<p>MVCC </p>
<p>外键</p>
<p>ACSR自动故障恢复</p>
<p>热备</p>
<p>复制(多线程,GTID,MTS)</p>
<h2 id="12-6-InnoDB和MyISAM存储引擎的替换-客户案例"><a href="#12-6-InnoDB和MyISAM存储引擎的替换-客户案例" class="headerlink" title="12.6 InnoDB和MyISAM存储引擎的替换(客户案例)"></a>12.6 InnoDB和MyISAM存储引擎的替换(客户案例)</h2><p>环境: centos 5.8 ,MySQL 5.0版本,MyISAM存储引擎,网站业务(LNMP),数据量50G左右</p>
<p>现象问题: 业务压力大的时候,非常卡;经历过宕机,会有部分数据丢失.</p>
<p><font color="red"><strong>问题分析:</strong></font></p>
<ol>
<li><p>MyISAM存储引擎表级锁,在高并发时,会有很高锁等待</p>
</li>
<li><p>MyISAM存储引擎不支持事务,在断电时,会有可能丢失数据</p>
</li>
</ol>
<p>职责</p>
<ol>
<li><p>监控锁的情况:有很多的表锁等待</p>
</li>
<li><p>存储引擎查看:所有表默认是MyISAM</p>
</li>
</ol>
<p><font color="green"><strong>解决方案:</strong></font></p>
<ol>
<li><p>升级MySQL 5.6.10版本（先升级到5.5，然后再升级到5.6）</p>
</li>
<li><p>迁移所有表到新环境</p>
</li>
<li><p>开启双1安全参数</p>
</li>
</ol>
<h2 id="12-7-查看存储引擎"><a href="#12-7-查看存储引擎" class="headerlink" title="12.7 查看存储引擎"></a>12.7 查看存储引擎</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">show engines;<br>#或<br>select @@default_storage_engine;<br><br>#且可以再配置文件里设定存储引擎<br>vim /etc/my.cnf<br>[mysqld]<br>default_storage_engine=innodb<br></code></pre></td></tr></table></figure>

<h2 id="12-8-查看表存储引擎状态"><a href="#12-8-查看表存储引擎状态" class="headerlink" title="12.8 查看表存储引擎状态"></a>12.8 查看表存储引擎状态</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW CREATE TABLE City\G; SHOW TABLE STATUS LIKE &#x27;CountryLanguage&#x27;\G;<br><br>select table_schema,table_name ,engine from information_schema.tables where table_schema not in (&#x27;sys&#x27;,&#x27;mysql&#x27;,&#x27;information_schema&#x27;,&#x27;performance_schema&#x27;);<br></code></pre></td></tr></table></figure>

<h2 id="12-9-修改存储引擎"><a href="#12-9-修改存储引擎" class="headerlink" title="12.9 修改存储引擎"></a>12.9 修改存储引擎</h2><h3 id="12-9-1-修改存储引擎"><a href="#12-9-1-修改存储引擎" class="headerlink" title="12.9.1 修改存储引擎"></a>12.9.1 修改存储引擎</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">alter table t111 engine=innodb; #修改引擎<br>show create table t111;<br></code></pre></td></tr></table></figure>

<h3 id="12-9-2-整理碎片（常用命令）（只限制innodb引擎）"><a href="#12-9-2-整理碎片（常用命令）（只限制innodb引擎）" class="headerlink" title="12.9.2 整理碎片（常用命令）（只限制innodb引擎）"></a>12.9.2 整理碎片（常用命令）（只限制innodb引擎）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">alter table t111（表名） engine=innodb;<br></code></pre></td></tr></table></figure>

<p><strong>面试问题：</strong></p>
<p>环境:</p>
<p>centos7.4,MySQL 5.7.20,InnoDB存储引擎 </p>
<p>业务特点:</p>
<p>数据量级较大,经常需要按月删除历史数据. </p>
<p>问题:</p>
<p>磁盘空间占用很大,不释放 </p>
<p>处理方法: </p>
<ol>
<li>将数据逻辑导出,手工truncat表,然后导入进去 现在: 对表进行按月进行分表(partition,中间件) 业务替换为truncate方式</li>
<li>定期进行碎片整理</li>
</ol>
<h3 id="12-9-3-批量将zabbix-100多张表的存储引擎从innodb改为为tokudb"><a href="#12-9-3-批量将zabbix-100多张表的存储引擎从innodb改为为tokudb" class="headerlink" title="12.9.3 批量将zabbix 100多张表的存储引擎从innodb改为为tokudb"></a>12.9.3 批量将zabbix 100多张表的存储引擎从innodb改为为tokudb</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#每一个表修改<br>alter table zabbix.a engine=tokudb;<br><br>#批量修改<br>select concat(&quot;alter table &quot;,table_schema,&quot;.&quot;,table_name,&quot; engine=tokudb&quot;)<br>from information_schema.tables<br>where table_name=&#x27;zabbix&#x27;;<br></code></pre></td></tr></table></figure>

<h2 id="12-10-InnoDB存储引擎物理存储结构"><a href="#12-10-InnoDB存储引擎物理存储结构" class="headerlink" title="12.10 InnoDB存储引擎物理存储结构"></a>12.10 InnoDB存储引擎物理存储结构</h2><h3 id="12-10-1-最直观的存储方式（-data-mysql-data）"><a href="#12-10-1-最直观的存储方式（-data-mysql-data）" class="headerlink" title="12.10.1 最直观的存储方式（/data/mysql/data）"></a>12.10.1 最直观的存储方式（/data/mysql/data）</h3><p>ibdata1：系统数据字典信息(统计信息)，UNDO表空间等数据 </p>
<p>ib_logfile0 ~ ib_logfile1: REDO日志文件，事务日志文件。</p>
<p>ibtmp1： 临时表空间磁盘位置，存储临时表 </p>
<p>frm：存储表的列信息 </p>
<p>ibd：表的数据行和索引 </p>
<h2 id="12-11-表空间（Tablespace）"><a href="#12-11-表空间（Tablespace）" class="headerlink" title="12.11 表空间（Tablespace）"></a>12.11 表空间（Tablespace）</h2><h3 id="12-11-1-表空间数据问题"><a href="#12-11-1-表空间数据问题" class="headerlink" title="12.11.1 表空间数据问题"></a>12.11.1 表空间数据问题</h3><p>idbdata1：整个库的统计信息+Undo</p>
<p>ibd：数据行和索引</p>
<h3 id="12-11-2-共享表空间"><a href="#12-11-2-共享表空间" class="headerlink" title="12.11.2 共享表空间"></a>12.11.2 共享表空间</h3><h4 id="12-11-2-1-共享表空间介绍"><a href="#12-11-2-1-共享表空间介绍" class="headerlink" title="12.11.2.1 共享表空间介绍"></a>12.11.2.1 共享表空间介绍</h4><p>5.5版本的默认模式，5.6中转换为独立表空间</p>
<p>需要将所有数据存储到同一个表空间中 ，管理比较混乱 5.5版本出现的管理模式，也是默认的管理模式。 </p>
<p>5.6版本，共享表空间保留，只用来存储数据字典信息,undo,临时表。 </p>
<p>5.7 版本,临时表被独立出来了 </p>
<p>8.0版本,undo也被独立出去了</p>
<p>具体变换参考官方文档</p>
<p><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://dev.mysql.com/doc/refman/5.6/en/innodb-architecture.html">https://dev.mysql.com/doc/refman/5.6/en/innodb-architecture.html</a></p>
<p><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://dev.mysql.com/doc/refman/5.7/en/innodb-architecture.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-architecture.html</a></p>
<p><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://dev.mysql.com/doc/refman/5.8/en/innodb-architecture.html">https://dev.mysql.com/doc/refman/5.8/en/innodb-architecture.html</a></p>
<h4 id="12-11-2-2-共享表空间设置（在搭建MySQL时，初始化数据之前设置到参数文件中）"><a href="#12-11-2-2-共享表空间设置（在搭建MySQL时，初始化数据之前设置到参数文件中）" class="headerlink" title="12.11.2.2 共享表空间设置（在搭建MySQL时，初始化数据之前设置到参数文件中）"></a>12.11.2.2 共享表空间设置（在搭建MySQL时，初始化数据之前设置到参数文件中）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">[(none)]&gt;select @@innodb_data_file_path; <br>[(none)]&gt;show variables like &#x27;%extend%&#x27;; <br>innodb_data_file_path=ibdata1:512M:ibdata2:512M:autoextend innodb_autoextend_increment=64<br><br>#例如：<br>mysqld --initialize-insecure --user=mysql --basedir=xxxxx....<br>innodb_data_file_path=ibdata1:512M:ibdata2:512M:autoextend<br></code></pre></td></tr></table></figure>

<h2 id="12-12-独立表空间"><a href="#12-12-独立表空间" class="headerlink" title="12.12 独立表空间"></a>12.12 独立表空间</h2><h3 id="12-12-1-独立表空间介绍"><a href="#12-12-1-独立表空间介绍" class="headerlink" title="12.12.1 独立表空间介绍"></a>12.12.1 独立表空间介绍</h3><p>从5.6，默认表空间不再使用共享表空间，替换为独立表空间。 </p>
<p>主要存储的是用户数据 </p>
<p>存储特点为：一个表一个ibd文件，存储数据行和索引信息 </p>
<p>基本表结构元数据存储： xxx.frm </p>
<p>最终结论： 一张InnoDB表=frm+idb+ibdata1 </p>
<h3 id="12-12-2-MySQL的存储引擎日志："><a href="#12-12-2-MySQL的存储引擎日志：" class="headerlink" title="12.12.2 MySQL的存储引擎日志："></a>12.12.2 MySQL的存储引擎日志：</h3><p>Redo Log: ib_logfile0 ib_logfile1，重做日志 </p>
<p>Undo Log: ibdata1 ibdata2(存储在共享表空间中)，回滚日志 </p>
<p>临时表:ibtmp1，在做join union操作产生临时数据，用完就自动释放</p>
<h3 id="12-12-3-独立表空间设置问题"><a href="#12-12-3-独立表空间设置问题" class="headerlink" title="12.12.3 独立表空间设置问题"></a>12.12.3 独立表空间设置问题</h3><p>db01 [(none)]&gt;select @@innodb_file_per_table; </p>
<p>+————————————–+ </p>
<p>| @@innodb_file_per_table | </p>
<p>+————————————–+ </p>
<p>|           1                                  | </p>
<p>+————————————–+</p>
<h3 id="12-12-4-独立表空间迁移命令（单表恢复迁移）"><a href="#12-12-4-独立表空间迁移命令（单表恢复迁移）" class="headerlink" title="12.12.4 独立表空间迁移命令（单表恢复迁移）"></a>12.12.4 独立表空间迁移命令（单表恢复迁移）</h3><ol>
<li>创建和原表结构一致的空表</li>
<li>将空表的idb文件删除 alter table city dicard tablespace;</li>
<li>将原表的idb拷贝过来，并且修改权限</li>
<li>将原表idb进行导入 alter table city import tablespace;</li>
</ol>
<h2 id="12-13-真实案例"><a href="#12-13-真实案例" class="headerlink" title="12.13 真实案例"></a>12.13 真实案例</h2><p><strong>案例背景:</strong></p>
<p>硬件及软件环境: </p>
<p>联想服务器（IBM） </p>
<p>磁盘500G 没有raid centos 6.8 </p>
<p>mysql 5.6.33 innodb引擎 独立表空间 </p>
<p>备份没有，日志也没开 </p>
<p>开发用户专用库: jira(bug追踪) 、 confluence(内部知识库)  ——&gt;LNMT</p>
<p><font color="red"><strong>故障描述:</strong></font></p>
<p>断电了，启动完成后“/” 只读 </p>
<p>fsck 重启,系统成功启动,mysql启动不了。 </p>
<p>结果：confulence库在 ， jira库不见了</p>
<p><font color="red">学员求助内容:</font></p>
<p>求助： 这种情况怎么恢复？ </p>
<p>我问： 有备份没 </p>
<p>求助： 连二进制日志都没有，没有备份，没有主从 </p>
<p>我说： 没招了，jira需要硬盘恢复了。 </p>
<p>求助： </p>
<ol>
<li><p>jira问题拉到中关村了 </p>
</li>
<li><p>能不能暂时把confulence库先打开用着 将生产库confulence，拷贝到1:1虚拟机上/var/lib/mysql,直接访问时访问不了的 </p>
</li>
</ol>
<p>问：有没有工具能直接读取ibd<br>我说：我查查，最后发现没有</p>
<p><font color="green"><strong>我想出一个办法来：</strong></font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#表空间迁移: <br>#虚拟机测试可行。<br>create table xxx; <br>alter table confulence.t1 discard tablespace; <br>alter table confulence.t1 import tablespace; <br></code></pre></td></tr></table></figure>

<p>处理问题思路:</p>
<p>confulence库中一共有107张表。 </p>
<p>1、创建107张和和原来一模一样的表。 </p>
<p>他有2016年的历史库，我让他去他同时电脑上mysqldump备份confulence库 </p>
<p>mysqldump -uroot -ppassword -B confulence –no-data &gt; test.sql </p>
<p>拿到你的测试库，进行恢复,到这步为止，表结构有了。 </p>
<p>2、表空间删除。 </p>
<p>select </p>
<p>concat(‘alter table ‘,table_schema,’.’table_name,’ discard tablespace;’) </p>
<p>from information_schema.tables</p>
<p>where table_schema=’confluence’ into outfile ‘/tmp/discad.sql’; </p>
<p>source /tmp/discard.sql </p>
<p>执行过程中发现，有20-30个表无法成功。<font color="red">原因：主外键关系 </font></p>
<p>很绝望，需要一个表一个表分析表结构，很痛苦。 </p>
<p>set foreign_key_checks=0 </p>
<p>跳过外键检查。 把有问题的表表空间也删掉了。 </p>
<p>3、拷贝生产中confulence库下的所有表的ibd文件拷贝到准备好的环境中 </p>
<p>select </p>
<p>concat(‘alter table ‘,table_schema,’.’table_name,’ import tablespace;’) </p>
<p>from information_schema.tables </p>
<p>where table_schema=’confluence’ into outfile ‘/tmp/import.sql’; </p>
<p>4、验证数据 表都可以访问了，数据挽回到了出现问题时刻的状态</p>
<h2 id="12-15-InnoDB-核心特性"><a href="#12-15-InnoDB-核心特性" class="headerlink" title="12.15 InnoDB 核心特性*****"></a>12.15 InnoDB 核心特性*****</h2><h3 id="12-15-1-事务"><a href="#12-15-1-事务" class="headerlink" title="12.15.1 事务"></a>12.15.1 事务</h3><h4 id="12-15-1-1-事务的ACID特性"><a href="#12-15-1-1-事务的ACID特性" class="headerlink" title="12.15.1.1 事务的ACID特性"></a>12.15.1.1 事务的ACID特性</h4><table>
<thead>
<tr>
<th>名称</th>
<th>特性</th>
</tr>
</thead>
<tbody><tr>
<td>Atomic（原子性）</td>
<td>所有语句作为一个单元全部成功执行或全部取消。不能出现中间状态。</td>
</tr>
<tr>
<td>Consistent（一致性）</td>
<td>如果数据库在事务开始时处于一致状态，则在执行该事务期间将保留一致状态。</td>
</tr>
<tr>
<td>Isolated（隔离性）</td>
<td>事务之间不相互影响。</td>
</tr>
<tr>
<td>Durable（持久性）</td>
<td>事务成功完成后，所做的所有更改都会准确地记录在数据库中。所做的更改不会丢失。</td>
</tr>
</tbody></table>
<h3 id="12-15-2-事务的生命周期（事务控制语句）"><a href="#12-15-2-事务的生命周期（事务控制语句）" class="headerlink" title="12.15.2 事务的生命周期（事务控制语句）"></a>12.15.2 事务的生命周期（事务控制语句）</h3><h4 id="12-15-2-1-如何开启事务"><a href="#12-15-2-1-如何开启事务" class="headerlink" title="12.15.2.1 如何开启事务"></a>12.15.2.1 如何开启事务</h4><p>begin;</p>
<h4 id="12-15-2-2-标准的事务语句"><a href="#12-15-2-2-标准的事务语句" class="headerlink" title="12.15.2.2 标准的事务语句"></a>12.15.2.2 标准的事务语句</h4><p>DML： insert updata delte</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">如：<br>mysql&gt; update city set countrycode=&#x27;CHN&#x27; where id=1;<br>mysql&gt; update city set countrycode=&#x27;CHN&#x27; where id=2;<br>mysql&gt; update city set countrycode=&#x27;CHN&#x27; where id=3;<br></code></pre></td></tr></table></figure>

<h4 id="12-15-2-3-标准的事务的结束"><a href="#12-15-2-3-标准的事务的结束" class="headerlink" title="12.15.2.3 标准的事务的结束"></a>12.15.2.3 标准的事务的结束</h4><p>提交：</p>
<p>commit;</p>
<p>回滚：</p>
<p>rollback;</p>
<h3 id="12-15-3-自动提交机制（autocommit）"><a href="#12-15-3-自动提交机制（autocommit）" class="headerlink" title="12.15.3 自动提交机制（autocommit）"></a>12.15.3 自动提交机制（autocommit）</h3><p>mysql&gt; select @@autocommit;<br>+————————-+<br>| @@autocommit |<br>+————————-+<br>|              1               |<br>+————————-+</p>
<p><font color="red">在线修改参数：会话级别（即时生效，不会影响别的会话）</font></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">set</span> <span class="hljs-attribute">autocommit</span>=0;<br></code></pre></td></tr></table></figure>

<p><font color="red">全局级别（断开窗口后重连生效，影响新开的所有会话）</font></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> autocommit;<br></code></pre></td></tr></table></figure>

<p><font color="red">永久修改 （需重启MySQL）</font></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/etc/my</span>.cnf<br>autocommit=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p><strong>注： 自动提交是否打开，一般在有事务需求的MySQL中，将其关闭不管有没有事务需求，我们一般也都建议设置为0，可以很大程度上提高数据库性能</strong></p>
<h2 id="12-16-隐式提交的情况"><a href="#12-16-隐式提交的情况" class="headerlink" title="12.16 隐式提交的情况"></a>12.16 隐式提交的情况</h2><p>触发隐式提交的语句：</p>
<p>begin</p>
<p>a</p>
<p>b</p>
<p>[commit]（自动输入）</p>
<p>create database…</p>
<p>导致提交的非事务语句： </p>
<p>DDL语句： （ALTER、CREATE 和 DROP） </p>
<p>DCL语句： （GRANT、REVOKE 和 SET PASSWORD） </p>
<p>锁定语句：（LOCK TABLES 和 UNLOCK TABLES） </p>
<p>导致隐式提交的语句示例： TRUNCATE TABLE LOAD DATA INFILE SELECT FOR UPDATE</p>
<h2 id="12-17-InnoDB事务的ACID如何保证"><a href="#12-17-InnoDB事务的ACID如何保证" class="headerlink" title="12.17 InnoDB事务的ACID如何保证"></a>12.17 InnoDB事务的ACID如何保证</h2><h3 id="12-17-1-一些概念名词"><a href="#12-17-1-一些概念名词" class="headerlink" title="12.17.1 一些概念名词"></a>12.17.1 一些概念名词</h3><ul>
<li><p>redo log：重做日志</p>
</li>
<li><p>ib_logfile0~1：默认50M，轮询使用，可以修改</p>
</li>
<li><p>redo log buffer：redo内存区域</p>
</li>
<li><p>ibd：存储 数据行和索引</p>
</li>
<li><p>data buffer poll：缓冲区池，数据和索引的缓冲</p>
</li>
<li><p>LSN：日志序列号</p>
</li>
<li><p>ibd，redo log，data buffer pool，redo buffer （这四个都有LSN序列号）</p>
</li>
</ul>
<p><strong>说明：MySQL 每次数据库启动，都会对比ibd（较磁盘数据页）和redolog的LSN，必须要求两者LSN一致数据库才能正常启动</strong></p>
<ul>
<li>WAL：write ahead log 日志优先写的方式实现持久化</li>
</ul>
<p><strong>说明：总之日志是有限于数据写入磁盘的</strong></p>
<ul>
<li><p>脏页: 内存脏页,内存中发生了修改,没写入到磁盘之前,我们把内存页称之为脏页.</p>
</li>
<li><p>CKPT：Checkpoint,检查点,就是将脏页刷写到磁盘的动作 TXID：事务号,InnoDB会为每一个事务生成一个事务号,伴随着整个事务.</p>
</li>
</ul>
<h3 id="12-17-2-事务日志–redo-重做日志"><a href="#12-17-2-事务日志–redo-重做日志" class="headerlink" title="12.17.2 事务日志–redo 重做日志"></a>12.17.2 事务日志–redo 重做日志</h3><h4 id="12-17-2-1-作用"><a href="#12-17-2-1-作用" class="headerlink" title="12.17.2.1 作用"></a>12.17.2.1 作用</h4><p><font color="red"><strong>主要功能 保证 “Durable（持久性）”，对Atomic（原子性）和Consistent（一致性）也有一定的作用</strong></font></p>
<h4 id="12-17-2-2-功能"><a href="#12-17-2-2-功能" class="headerlink" title="12.17.2.2 功能"></a>12.17.2.2 功能</h4><ol>
<li>记录了内存数据页的变化</li>
<li>提供快速的持久化功能（WAL）</li>
<li>CSR过程中实现前滚的操作（磁盘数据页和redo日志LSN一致）</li>
</ol>
<h4 id="12-17-2-3-redo-日志位置"><a href="#12-17-2-3-redo-日志位置" class="headerlink" title="12.17.2.3 redo 日志位置"></a>12.17.2.3 redo 日志位置</h4><p>redo 低日志文件：iblogfile0 iblogfile1</p>
<h4 id="12-17-2-4-redo-buffer"><a href="#12-17-2-4-redo-buffer" class="headerlink" title="12.17.2.4 redo buffer"></a>12.17.2.4 redo buffer</h4><p>redo的buffer：数据页的变化信息+数据页当时的LSN号</p>
<h4 id="12-17-2-5-redo的刷写策略"><a href="#12-17-2-5-redo的刷写策略" class="headerlink" title="12.17.2.5 redo的刷写策略"></a>12.17.2.5 redo的刷写策略</h4><p>commit;</p>
<p>刷新当前事务的redo buffer到磁盘</p>
<p>还会顺便将一部分redo buffer中没有添加的事务日志页刷新到磁盘</p>
<p>" srcset="/blog/img/loading.gif<img src="">  </p>
<h2 id="12-18-MySQL-CSR前滚"><a href="#12-18-MySQL-CSR前滚" class="headerlink" title="12.18 MySQL CSR前滚"></a>12.18 MySQL CSR前滚</h2><p>MySQL：在启动时，必须保证redo日志文件和数据文件LSN必须一致，如果不一致就会触发CSR，最终保证一致</p>
<h3 id="12-18-1-在MySQL发生前滚操作的步骤"><a href="#12-18-1-在MySQL发生前滚操作的步骤" class="headerlink" title="12.18.1 在MySQL发生前滚操作的步骤"></a>12.18.1 在MySQL发生前滚操作的步骤</h3><p>前提：我们做了一个事务,begin;update;commit. </p>
<ol>
<li>在begin ,会立即分配一个TXID=tx_01. </li>
<li>update时,会将需要修改的数据页(dp_01,LSN=101),加载到data buffer中 </li>
<li>DBWR线程,会进行dp_01数据页修改更新,并更新LSN=102 </li>
<li>LOGBWR日志写线程,会将dp_01数据页的变化+LSN+TXID存储到redobuffer </li>
<li>执行commit时,LGWR日志写线程会将redobuffer信息写入redolog日志文件中,基于WAL原则, 在日志完全写入磁盘后,commit命令才执行成功,(会将此日志打上commit标记) </li>
<li>假如此时宕机,内存脏页没有来得及写入磁盘,内存数据全部丢失 </li>
<li>MySQL再次重启时,必须要redolog和磁盘数据页的LSN是一致的.但是,此时dp_01,TXID=tx_01磁盘是LSN=101,dp_01,TXID=tx_01,redolog中LSN=102，MySQL此时无法正常启动,MySQL触发CSR.在内存追平LSN号,触发ckpt,将内存数据页更新到磁盘,从而保证磁盘数据页和redolog LSN一值.这时MySQL正长启动 </li>
</ol>
<p><strong>以上的工作过程,我们把它称之为基于REDO的”前滚操作”</strong> </p>
<h2 id="12-19-undo-回滚日志"><a href="#12-19-undo-回滚日志" class="headerlink" title="12.19 undo 回滚日志"></a>12.19 undo 回滚日志</h2><h3 id="12-19-1-作用"><a href="#12-19-1-作用" class="headerlink" title="12.19.1 作用"></a>12.19.1 作用</h3><ol>
<li>在ACID特性中，主要保证A的特性，同时对CI也有一定功效</li>
<li>记录了数据修改之前的状态</li>
<li>rollback 将内存的数据修改恢复到修改之前</li>
<li>在CSR中实现为未提交数据的回滚操作</li>
<li>实现一致性快照，配合隔离级别保证MVCC，读和写的操作不会相互阻塞 </li>
</ol>
<h2 id="12-20-锁"><a href="#12-20-锁" class="headerlink" title="12.20 锁"></a>12.20 锁</h2><p>简介：</p>
<p>实现了事务之间的隔离功能，InnoDB中实现的是行级锁</p>
<p>row-level lock</p>
<p>gap</p>
<p>next-lock </p>
<h2 id="12-21-隔离级别"><a href="#12-21-隔离级别" class="headerlink" title="12.21 隔离级别 *****"></a>12.21 隔离级别 *****</h2><p>影响到数据的读取,默认的级别是RR模式. </p>
<p>transaction_isolation:隔离级别(参数),负责的是,MVCC,读一致性问题 </p>
<p>RU : 读未提交,可脏读,幻读，不可重复读 </p>
<p>RC : 读已提交，会出现不可重复读，会出现幻读,可以防止脏读，在大部分互联网企业中式可以容忍的.    * </p>
<p>RR（默认） : 可重复读,功能是防止”幻读”现象 ,利用的是undo的快照技术+GAP(间隙锁)+NextLock(下键锁)    ***** </p>
<p>SR  : 可串行化,可以防止死锁,但是并发事务性能较差 </p>
<p>补充: 在RC级别下,可以减轻GAP+NextLock锁的问题,但是会出现幻读现象,一般在为了读一致性会在正常select后添加for update语句.但是,请记住执行完一定要commit 否则容易出现所等待比较严重. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#例如: <br>[world]&gt;select * from city where id=999 for update; <br>[world]&gt;commit;<br></code></pre></td></tr></table></figure>

<p><font color="red"><strong>如何修改隔离级别？</strong></font></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/my.cnf<br>transaction_isolation=read-uncommitted<br>transaction_isolation=read-committed<br>transaction_isolation=REPEATABLE-READ<br></code></pre></td></tr></table></figure>

<h2 id="12-22-InnoDB核心参数"><a href="#12-22-InnoDB核心参数" class="headerlink" title="12.22 InnoDB核心参数"></a>12.22 InnoDB核心参数</h2><h3 id="12-22-1-存储引擎默认设置"><a href="#12-22-1-存储引擎默认设置" class="headerlink" title="12.22.1 存储引擎默认设置"></a>12.22.1 存储引擎默认设置</h3><p><font color="green"><strong>default_storage_engine=innodb</strong></font></p>
<h3 id="12-22-2-表空间模式"><a href="#12-22-2-表空间模式" class="headerlink" title="12.22.2 表空间模式"></a>12.22.2 表空间模式</h3><p><font color="green"><strong>innodb_file_per_table=1</strong></font></p>
<h3 id="12-22-3-共享表空间文件个数和大小"><a href="#12-22-3-共享表空间文件个数和大小" class="headerlink" title="12.22.3 共享表空间文件个数和大小"></a>12.22.3 共享表空间文件个数和大小</h3><p>innodb_data_file_path=ibdata1:512M:ibdata2:512M:autoextend</p>
<h3 id="12-22-4-“双一”-标准的其中一个"><a href="#12-22-4-“双一”-标准的其中一个" class="headerlink" title="12.22.4 “双一” 标准的其中一个 **********"></a>12.22.4 “双一” 标准的其中一个 **********</h3><p>innodb_flush_log_at_trx_commit=1 （默认1）</p>
<p><strong>innodb_flush_log_at_trx_commit有以下几个参数：</strong></p>
<p>1:每次事物的提交都会引起日志文件写入、flush磁盘的操作，确保了事务的ACID；flush 到操作系统的文件系统缓存 fsync到物理磁盘. </p>
<p>0:表示当事务提交时，不做日志写入操作，而是每秒钟将log buffer中的数据写入文件系统缓存并且秒fsync磁盘一次； </p>
<p>2:每次事务提交引起写入文件系统缓存,但每秒钟完成一次fsync磁盘操作。 </p>
<p>——– The default setting of 1 is required for full ACID compliance. Logs are written and flushed to disk at each transaction commit. With a setting of 0, logs are written and flushed to disk once per second. Transactions for which logs have not been flushed can be lost in a crash. With a setting of 2, logs are w</p>
<p>-——-</p>
<h3 id="12-22-5-Innodb-flush-method-O-DIRECT-fsync"><a href="#12-22-5-Innodb-flush-method-O-DIRECT-fsync" class="headerlink" title="12.22.5 Innodb_flush_method=(O_DIRECT, fsync) *****"></a>12.22.5 Innodb_flush_method=(O_DIRECT, fsync) *****</h3><p>作用：控制的式 Redo buffer 和 buffer pool</p>
<p>fsync：</p>
<p>" srcset="/blog/img/loading.gif<img src=""> </p>
<p>O_DIRECT（建议模式）：</p>
<p>" srcset="/blog/img/loading.gif<img src=""> </p>
<p>O_DSYNC：</p>
<p>" srcset="/blog/img/loading.gif<img src=""> </p>
<h3 id="12-22-6-innodb-flush-log-at-trx-commit与Innodb-flush-method的组合使用"><a href="#12-22-6-innodb-flush-log-at-trx-commit与Innodb-flush-method的组合使用" class="headerlink" title="12.22.6 innodb_flush_log_at_trx_commit与Innodb_flush_method的组合使用"></a>12.22.6 innodb_flush_log_at_trx_commit与Innodb_flush_method的组合使用</h3><h4 id="12-22-6-1-最高安全模式"><a href="#12-22-6-1-最高安全模式" class="headerlink" title="12.22.6.1 最高安全模式"></a>12.22.6.1 最高安全模式</h4><p>innodb_flush_log_at_trx_commit=1</p>
<p>Innodb_flush_method=O_DIRECT</p>
<h4 id="12-22-6-2-最高性能"><a href="#12-22-6-2-最高性能" class="headerlink" title="12.22.6.2 最高性能"></a>12.22.6.2 最高性能</h4><p>innodb_flush_log_at_trx_commit=0</p>
<p>Innodb_flush_method=fsync</p>
<h3 id="12-22-7-redo日志设置有关的"><a href="#12-22-7-redo日志设置有关的" class="headerlink" title="12.22.7 redo日志设置有关的"></a>12.22.7 redo日志设置有关的</h3><p>innodb_log_buffer_size=16777216</p>
<p>innodb_log_file_size=50331648</p>
<p>innodb_log_files_in_group = 3 </p>
<h3 id="12-22-8-脏页刷写策略"><a href="#12-22-8-脏页刷写策略" class="headerlink" title="12.22.8 脏页刷写策略"></a>12.22.8 脏页刷写策略</h3><p>innodb_max_dirty_pages_pct=75</p>
<h3 id="12-22-9-还有哪些机制会触发写磁盘"><a href="#12-22-9-还有哪些机制会触发写磁盘" class="headerlink" title="12.22.9 还有哪些机制会触发写磁盘?"></a>12.22.9 还有哪些机制会触发写磁盘?</h3><p>CSR </p>
<p>redo满了</p>
<h1 id="十三、日志管理"><a href="#十三、日志管理" class="headerlink" title="十三、日志管理"></a>十三、日志管理</h1><h2 id="13-1-错误日志"><a href="#13-1-错误日志" class="headerlink" title="13.1 错误日志 ***"></a>13.1 错误日志 ***</h2><h3 id="13-1-1-作用"><a href="#13-1-1-作用" class="headerlink" title="13.1.1 作用"></a>13.1.1 作用</h3><p>排查MySQL运行过程的故障.</p>
<h3 id="13-1-2-默认配置"><a href="#13-1-2-默认配置" class="headerlink" title="13.1.2 默认配置"></a>13.1.2 默认配置</h3><p>默认就开启了.</p>
<p>默认路径和名字: datadir/hostname.err</p>
<p>查看方法: [ERROR]</p>
<h3 id="13-1-3-人为定制位置"><a href="#13-1-3-人为定制位置" class="headerlink" title="13.1.3 人为定制位置"></a>13.1.3 人为定制位置</h3><p>log_error=/tmp/mysql3306.log</p>
<p>重启生效.</p>
<h3 id="13-1-4-查看错误日志存放的位置"><a href="#13-1-4-查看错误日志存放的位置" class="headerlink" title="13.1.4 查看错误日志存放的位置"></a>13.1.4 查看错误日志存放的位置</h3><p>select @@log_error; </p>
<h2 id="13-2-二进制日志-binlog"><a href="#13-2-二进制日志-binlog" class="headerlink" title="13.2 二进制日志(binlog)**********"></a>13.2 二进制日志(binlog)**********</h2><h3 id="13-2-1-作用"><a href="#13-2-1-作用" class="headerlink" title="13.2.1 作用"></a>13.2.1 作用</h3><ul>
<li>主从要依赖二进制日志</li>
<li>数据恢复时需要依赖于二进制日志 </li>
</ul>
<h3 id="13-2-2-如何配置"><a href="#13-2-2-如何配置" class="headerlink" title="13.2.2 如何配置?"></a>13.2.2 如何配置?</h3><h4 id="13-2-2-1-参数介绍"><a href="#13-2-2-1-参数介绍" class="headerlink" title="13.2.2.1 参数介绍"></a>13.2.2.1 参数介绍</h4><p><strong>默认没有开启.</strong></p>
<p>server_id=6</p>
<p>log_bin=/data/binlog/mysql-bin</p>
<p>说明: </p>
<p>/data/binlog : 提前定制好的目录,而且要有mysql.mysql的权限</p>
<p>mysql-bin  : 二进制日志文件名的前缀</p>
<p>例如: mysql-bin.000001 ,mysql-bin.000002 ……</p>
<p>binlog_format=row：5.7版本默认配置是row,可以省略.</p>
<h4 id="13-2-2-2-参数配置"><a href="#13-2-2-2-参数配置" class="headerlink" title="13.2.2.2 参数配置"></a>13.2.2.2 参数配置</h4><p>server_id=6</p>
<p>log_bin=/data/binlog/mysql-bin</p>
<p>sync_binlog=1</p>
<p>说明：</p>
<p>/data/binlog：提前定制号的目录，而且要有mysql.mysql的权限</p>
<p>mysql-bin：二进制日志文件名的前缀。例如：mysql-bin.000001，mysql-bin.0000002…..</p>
<p>binlog_format=row：5.7版本后的默认配置式row，可以省略</p>
<p>sync_binlog=1：每次事务提交都立即刷写到binlog到磁盘（双一其中一个） </p>
<h4 id="13-2-2-3-创建目录和授权"><a href="#13-2-2-3-创建目录和授权" class="headerlink" title="13.2.2.3 创建目录和授权"></a>13.2.2.3 创建目录和授权</h4><p>mkdir -p /data/binlog/</p>
<p>chown -R mysql.mysql /data</p>
<h4 id="13-2-2-4-重启生效"><a href="#13-2-2-4-重启生效" class="headerlink" title="13.2.2.4 重启生效"></a>13.2.2.4 重启生效</h4><p>[root@db01 tmp]# /etc/init.d/mysqld restart</p>
<p>Shutting down MySQL.. SUCCESS! </p>
<p>Starting MySQL. SUCCESS!  </p>
<h3 id="13-2-3-二进制日志记录了什么"><a href="#13-2-3-二进制日志记录了什么" class="headerlink" title="13.2.3 二进制日志记录了什么?"></a>13.2.3 二进制日志记录了什么?</h3><h4 id="13-2-3-1-总结"><a href="#13-2-3-1-总结" class="headerlink" title="13.2.3.1 总结"></a>13.2.3.1 总结</h4><p>记录的数据库所有变更类的操作日志.</p>
<p>(即以下三种操作)</p>
<p>DDL</p>
<p>DCL</p>
<p>DML </p>
<h4 id="13-2-3-2-DDL-和-DCL"><a href="#13-2-3-2-DDL-和-DCL" class="headerlink" title="13.2.3.2 DDL 和 DCL"></a>13.2.3.2 DDL 和 DCL</h4><p>以语句的方式,原模原样的记录. </p>
<h4 id="13-2-3-3-DML"><a href="#13-2-3-3-DML" class="headerlink" title="13.2.3.3 DML"></a>13.2.3.3 DML</h4><ol>
<li>记录的已提交的事务</li>
<li>DML记录格式(statement,row,mixed),通过binlog_format=row参数控制</li>
</ol>
<p>说明:</p>
<p>​    statement :SBR,语句模式记录日志,做什么命令,记录什么命令.</p>
<p>​    row            :RBR,行模式,数据行的变化</p>
<p>​    mixed        :MBR,混合模式</p>
<p><font color="red"><strong>面试问题: SBR和RBR什么区别?怎么选择?</strong>*</font></p>
<p>SBR和RBR解释</p>
<p>SBR: 可读性较强,对于范围操作日志量少,但是可能会出现记录不准确的情况.</p>
<p>RBR: 可读性较弱,对于范围操作日志大,不会出现记录错误.</p>
<p>高可用环境中的新特性要依赖于RBR</p>
<p><font color="green"><strong>答：我们公司对数据的严谨性要求较高,也用到了新型的架构,所以选择RBR</strong></font> </p>
<h3 id="13-2-4-二进制日志记录单元"><a href="#13-2-4-二进制日志记录单元" class="headerlink" title="13.2.4 二进制日志记录单元"></a>13.2.4 二进制日志记录单元</h3><h4 id="13-2-4-1-event-事件"><a href="#13-2-4-1-event-事件" class="headerlink" title="13.2.4.1 event 事件"></a>13.2.4.1 event 事件</h4><p>event 事件：二进制日志的最小单元</p>
<p>DDL : </p>
<p>create database oldguo; 事件1</p>
<p>（对于DDL等语句是每一个语句就是一个事件）</p>
<p>DML: 一个事务包含了多个语句</p>
<p>begin;       事件1</p>
<p>a                事件2</p>
<p>b                事件3</p>
<p>commit;   事件4  </p>
<h4 id="13-2-4-2-event事件的开始和结束号码"><a href="#13-2-4-2-event事件的开始和结束号码" class="headerlink" title="13.2.4.2 event事件的开始和结束号码"></a>13.2.4.2 event事件的开始和结束号码</h4><p>作用：方便我们从日志中截取我们想要的日志事件. </p>
<h3 id="13-2-5-二进制日志的管理"><a href="#13-2-5-二进制日志的管理" class="headerlink" title="13.2.5 二进制日志的管理"></a>13.2.5 二进制日志的管理</h3><h4 id="13-2-5-1-查看二进制日志位置"><a href="#13-2-5-1-查看二进制日志位置" class="headerlink" title="13.2.5.1 查看二进制日志位置"></a>13.2.5.1 查看二进制日志位置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show variables like &#x27;%log_bin%&#x27;;<br></code></pre></td></tr></table></figure>

<h4 id="13-2-5-2-查看所有已存在的二进制日志"><a href="#13-2-5-2-查看所有已存在的二进制日志" class="headerlink" title="13.2.5.2 查看所有已存在的二进制日志"></a>13.2.5.2 查看所有已存在的二进制日志</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show binary logs;<br>mysql&gt; flush logs; （滚动新的日志）<br>mysql&gt; show binary logs;<br></code></pre></td></tr></table></figure>

<h4 id="13-2-5-3-查看正在使用的二进制日志"><a href="#13-2-5-3-查看正在使用的二进制日志" class="headerlink" title="13.2.5.3 查看正在使用的二进制日志"></a>13.2.5.3 查看正在使用的二进制日志</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show master status ;<br></code></pre></td></tr></table></figure>

<h4 id="13-2-5-4-查看二进制日志事件"><a href="#13-2-5-4-查看二进制日志事件" class="headerlink" title="13.2.5.4 查看二进制日志事件"></a>13.2.5.4 查看二进制日志事件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; create database binlog charset utf8mb4;<br>mysql&gt; use binlog<br>mysql&gt; create table t1(id int);<br>mysql&gt; insert into t1 values(1);<br>mysql&gt; show master status ;	（确认当前使用的二进制日志文件）<br><br>+------------------+----------+--------------+------------------+-------------------+<br><br>| File       | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br><br>+------------------+----------+--------------+------------------+-------------------+<br><br>| mysql-bin.000004 |   501 |       |         |          |<br><br>+------------------+----------+--------------+------------------+-------------------+<br><br>1 row in set (0.00 sec)<br><br>mysql&gt; show binlog events in &#x27;mysql-bin.000004&#x27;;	（查看二进制日志）<br>mysql&gt; show binlog events in &#x27;mysql-bin.000004&#x27; limit 5;<br></code></pre></td></tr></table></figure>

<h4 id="13-2-5-5-查看二进制日志内容"><a href="#13-2-5-5-查看二进制日志内容" class="headerlink" title="13.2.5.5 查看二进制日志内容"></a>13.2.5.5 查看二进制日志内容</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 binlog]<span class="hljs-comment"># mysqlbinlog mysql-bin.000004（直接看）</span><br>[root@db01 binlog]<span class="hljs-comment"># mysqlbinlog --base64-output=decode-rows -vvv mysql-bin.000004 （MySQL翻译后看）</span><br>[root@db01 binlog]<span class="hljs-comment"># mysqlbinlog -d haoge mysql-bin.000004 </span><br></code></pre></td></tr></table></figure>

<h4 id="13-2-5-6-截取二进制日志"><a href="#13-2-5-6-截取二进制日志" class="headerlink" title="13.2.5.6 截取二进制日志"></a>13.2.5.6 截取二进制日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 binlog]<span class="hljs-comment"># mysqlbinlog --start-position=219 --stop-position=335 mysql-bin.000004 &gt;/tmp/a.sql</span><br></code></pre></td></tr></table></figure>

<h4 id="13-2-5-7-通过binlog恢复数据"><a href="#13-2-5-7-通过binlog恢复数据" class="headerlink" title="13.2.5.7 通过binlog恢复数据"></a>13.2.5.7 通过binlog恢复数据</h4><h5 id="13-2-5-7-1-模拟数据"><a href="#13-2-5-7-1-模拟数据" class="headerlink" title="13.2.5.7.1 模拟数据"></a>13.2.5.7.1 模拟数据</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; create database haoge charset utf8mb4;<br>mysql&gt; use haoge;<br>mysql&gt; create table t1(id int);<br>mysql&gt; insert into t1 values(1);<br>mysql&gt; commit;<br></code></pre></td></tr></table></figure>

<h5 id="13-2-5-7-2-模拟故障"><a href="#13-2-5-7-2-模拟故障" class="headerlink" title="13.2.5.7.2 模拟故障"></a>13.2.5.7.2 模拟故障</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; drop database haoge;<br></code></pre></td></tr></table></figure>

<h5 id="13-2-5-7-3-分析和截取binlog"><a href="#13-2-5-7-3-分析和截取binlog" class="headerlink" title="13.2.5.7.3 分析和截取binlog"></a>13.2.5.7.3 分析和截取binlog</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show master status; #确认使用的是哪一个日志<br>mysql&gt; show binlog events in &#x27;mysql-bin.000004&#x27;; #查看事件<br></code></pre></td></tr></table></figure>

<p>说明: 找到起点和终点,进行截取（创建表的操作的pos作为起点，删除表前的操作的pos作为终点）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqlbinlog --start-position=823 --stop-position=1420 /data/binlog/mysql-bin.000004 &gt;/tmp/bin.sql<br></code></pre></td></tr></table></figure>

<h4 id="13-2-5-7-4-恢复binlog"><a href="#13-2-5-7-4-恢复binlog" class="headerlink" title="13.2.5.7.4 恢复binlog"></a>13.2.5.7.4 恢复binlog</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; set sql_log_bin=0;  #临时关闭恢复时产生的新日志<br>mysql&gt; source /tmp/bin.sql<br>mysql&gt; set sql_log_bin=1; set sql_log_bin=1;  #改回来<br></code></pre></td></tr></table></figure>

<h3 id="13-2-6-binlog的gtid记录模式的管理"><a href="#13-2-6-binlog的gtid记录模式的管理" class="headerlink" title="13.2.6 binlog的gtid记录模式的管理 ****"></a>13.2.6 binlog的gtid记录模式的管理 ****</h3><h4 id="13-2-6-1-GTID介绍"><a href="#13-2-6-1-GTID介绍" class="headerlink" title="13.2.6.1 GTID介绍"></a>13.2.6.1 GTID介绍</h4><p>对于binlog中的每一个事务,都会生成一个GTID号码</p>
<p>DDL ,DCL 一个event就是一个事务,就会有一个GTID号.</p>
<p>DML语句来讲,begin到commit,是一个事务,就是一个GTID号</p>
<h4 id="13-2-6-2-GTID的组成"><a href="#13-2-6-2-GTID的组成" class="headerlink" title="13.2.6.2 GTID的组成"></a>13.2.6.2 GTID的组成</h4><p>severi_uuid:TID</p>
<p>severi_uuid? </p>
<p>[root@db01 data]# cat auto.cnf </p>
<p>[auto]</p>
<p>server-uuid=d60b549f-9e10-11e9-ab04-000c294a1b3b</p>
<p>TID是一个:自增长的数据,从1开始</p>
<p>d60b549f-9e10-11e9-ab04-000c294a1b3b:1-15 </p>
<h4 id="13-2-6-3-GTID的幂等性"><a href="#13-2-6-3-GTID的幂等性" class="headerlink" title="13.2.6.3 GTID的幂等性"></a>13.2.6.3 GTID的幂等性</h4><p>如果拿有GTID的日志去恢复时,检查当前系统中是否有相同GTID号,有相同的就自动跳过</p>
<p>会影响到binlog恢复和主从复制. </p>
<h4 id="13-2-6-4-GTID的开启和配置"><a href="#13-2-6-4-GTID的开启和配置" class="headerlink" title="13.2.6.4 GTID的开启和配置"></a>13.2.6.4 GTID的开启和配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/my.cnf<br>gtid-mode=on	（开启GTID）<br>enforce-gtid-consistency=<span class="hljs-literal">true</span>	（强制GTID一致性）<br></code></pre></td></tr></table></figure>

<h4 id="13-2-6-5-查看GTID信息"><a href="#13-2-6-5-查看GTID信息" class="headerlink" title="13.2.6.5 查看GTID信息"></a>13.2.6.5 查看GTID信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#要执行过一个事件才会有GTID号<br>mysql&gt; create database gtid charset utf8mb4;	<br>mysql&gt; show master status;<br>mysql&gt; use gtid;<br>mysql&gt; create table t1(id int);<br>mysql&gt; show master status;<br>mysql&gt; insert into t1 values(1);<br>mysql&gt; commit;<br>mysql&gt; show master status;<br>mysql&gt; drop database gtid;<br></code></pre></td></tr></table></figure>

<h4 id="13-2-6-6-基于GTID-binlog恢复"><a href="#13-2-6-6-基于GTID-binlog恢复" class="headerlink" title="13.2.6.6 基于GTID,binlog恢复"></a>13.2.6.6 基于GTID,binlog恢复</h4><h5 id="13-2-6-6-1-错误示范"><a href="#13-2-6-6-1-错误示范" class="headerlink" title="13.2.6.6.1 错误示范"></a>13.2.6.6.1 错误示范</h5><ol>
<li>截取日志</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 data]<span class="hljs-comment"># cd /data/binlog/</span><br>[root@db01 binlog]<span class="hljs-comment"># mysqlbinlog --include-gtids=&#x27;d60b549f-9e10-11e9-ab04-000c294a1b3b:1-3&#x27; mysql-bin.000005 &gt;/tmp/gtid.sql	（请看第四步，这里是错误写法）</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>恢复 </li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; set sql_log_bin=0;<br>mysql&gt; source /tmp/gtid.sql<br>mysql&gt; set sql_log_bin=1;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>报错</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">ERROR 1049 (42000): Unknown database &#x27;gtid&#x27;<br>Query OK, 0 rows affected (0.00 sec)<br>ERROR 1046 (3D000): No database selected<br></code></pre></td></tr></table></figure>

<p><font color="red"><strong>为什么报错?</strong></font></p>
<p><font color="green"><strong>因为幂等性的检查,1-3事务已经做过了.</strong></font></p>
<h4 id="13-2-2-6-2-正确的做法"><a href="#13-2-2-6-2-正确的做法" class="headerlink" title="13.2.2.6.2 正确的做法"></a>13.2.2.6.2 正确的做法</h4><ol>
<li>截取日志</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqlbinlog --skip-gtids --include-gtids=<span class="hljs-string">&#x27;d60b549f-9e10-11e9-ab04-000c294a1b3b:1-3&#x27;</span> mysql-bin.000005 &gt;/tmp/gtid.sql<br><br><span class="hljs-comment">#--skip-gtids 作用:在导出时,忽略原有的gtid信息,恢复时生成最新的gtid信息</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>恢复</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set sql_log_bin=0;<br>source /tmp/gtid.sql<br>set sql_log_bin=1;<br></code></pre></td></tr></table></figure>

<h4 id="13-2-6-7-GTID相关的参数"><a href="#13-2-6-7-GTID相关的参数" class="headerlink" title="13.2.6.7 GTID相关的参数"></a>13.2.6.7 GTID相关的参数</h4><p>–skip-gtids </p>
<p>–include-gtids=’d60b549f-9e10-11e9-ab04-000c294a1b3b:6’,’d60b549f-9e10-11e9-ab04-000c294a1b3b:8’</p>
<p>–exclude-gtids=’d60b549f-9e10-11e9-ab04-000c294a1b3b:6’,’d60b549f-9e10-11e9-ab04-000c294a1b3b:8’ </p>
<h2 id="13-3-慢日志-slow-log"><a href="#13-3-慢日志-slow-log" class="headerlink" title="13.3 慢日志(slow-log)"></a>13.3 慢日志(slow-log)</h2><h3 id="13-3-1-作用"><a href="#13-3-1-作用" class="headerlink" title="13.3.1 作用"></a>13.3.1 作用</h3><p>记录运行较慢的语句,优化过程中常用的工具日志.</p>
<h3 id="13-3-2-如何配置"><a href="#13-3-2-如何配置" class="headerlink" title="13.3.2 如何配置"></a>13.3.2 如何配置</h3><ul>
<li>开关</li>
</ul>
<p>slow_query_log=1 </p>
<ul>
<li>文件位置及名字 </li>
</ul>
<p>slow_query_log_file=/data/mysql/slow.log</p>
<ul>
<li>设定慢查询时间</li>
</ul>
<p>long_query_time=0.1</p>
<ul>
<li>没走索引的语句也记录</li>
</ul>
<p>log_queries_not_using_indexes</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#范例：</span><br>vim /etc/my.cnf<br>slow_query_log=1 <br>slow_query_log_file=/data/mysql/slow.log<br>long_query_time=0.1<br>log_queries_not_using_indexes<br></code></pre></td></tr></table></figure>

<h3 id="13-3-3-模拟慢查询"><a href="#13-3-3-模拟慢查询" class="headerlink" title="13.3.3 模拟慢查询"></a>13.3.3 模拟慢查询</h3><p>略.</p>
<h3 id="13-3-4-分析慢日志"><a href="#13-3-4-分析慢日志" class="headerlink" title="13.3.4 分析慢日志"></a>13.3.4 分析慢日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysqldumpslow -s c -t 10 /data/mysql/slow.log<br><br>#-s：慢日志<br>#c：次数<br>#-t 10：top 10<br></code></pre></td></tr></table></figure>

<h3 id="13-3-5-第三方工具-自己扩展"><a href="#13-3-5-第三方工具-自己扩展" class="headerlink" title="13.3.5 第三方工具(自己扩展)"></a>13.3.5 第三方工具(自己扩展)</h3><p><a target="_blank" rel="noopener" href="https://www.percona.com/downloads/percona-toolkit/LATEST/">https://www.percona.com/downloads/percona-toolkit/LATEST/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install perl-DBI perl-DBD-MySQL perl-Time-HiRes perl-IO-Socket-SSL perl-Digest-MD5<br><br><span class="hljs-comment">#toolkit工具包中的命令:</span><br>pt-query-diagest /data/mysql/slow.log<br></code></pre></td></tr></table></figure>

<p>Anemometer基于pt-query-digest将MySQL慢查询可视化 </p>
<h2 id="13-4-二进制日志清理"><a href="#13-4-二进制日志清理" class="headerlink" title="13.4 二进制日志清理"></a>13.4 二进制日志清理</h2><h3 id="13-4-1-自动"><a href="#13-4-1-自动" class="headerlink" title="13.4.1 自动"></a>13.4.1 自动</h3><p>expire_logs_days=15</p>
<p>设置的依据: 至少1轮全备周期长度的过期时间.</p>
<h3 id="13-4-2-手工"><a href="#13-4-2-手工" class="headerlink" title="13.4.2 手工"></a>13.4.2 手工</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; help purge<br>PURGE BINARY LOGS TO &#x27;mysql-bin.000032&#x27;;<br>PURGE BINARY LOGS BEFORE &#x27;2008-04-02 22:46:26&#x27;;<br>mysql&gt; reset master ;	（重置日志编号）<br></code></pre></td></tr></table></figure>

<h3 id="13-4-3-日志如何滚动"><a href="#13-4-3-日志如何滚动" class="headerlink" title="13.4.3 日志如何滚动"></a>13.4.3 日志如何滚动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">flush logs;<br>数据库重启<br>max_binlog_size=1073741824 <br></code></pre></td></tr></table></figure>

<h3 id="13-4-4-slow"><a href="#13-4-4-slow" class="headerlink" title="13.4.4 slow"></a>13.4.4 slow</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show variables like &#x27;slow_query_log%&#x27;;<br>mysql&gt; show variables like &#x27;long%&#x27;;<br>mysql&gt; show variables like &#x27;%using_indexes%&#x27;;<br>mysqldumpslow -s c -t 10 /xxxxx<br></code></pre></td></tr></table></figure>

<h3 id="13-4-5-真实优化案例"><a href="#13-4-5-真实优化案例" class="headerlink" title="13.4.5 真实优化案例:"></a>13.4.5 真实优化案例:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs mysql">desc city <br>SELECT SUM(invalid_count) as invalid_count,SUM(confirm_count) as confirm_count,SUM(not_confirm_count) as not_confirm_count,SUM(total_count) as total_count <br>FROM (select count(att.LogID) as invalid_count, 0 as confirm_count,0 as not_confirm_count,0 as total_count,bp.city_id <br>      FROM builder_project_info as bp <br>      JOIN attendentlog as att ON bp.project_id = att.CompanyID <br>      WHERE att.CompanyID in (SELECT project_id from builder_project_info WHERE city_id = 407) and att.LogTime like &quot;2019-06%&quot; and att.state = 2 <br>      GROUP BY bp.city_id <br>      UNION all (<br>select 0 as invalid_count, count(att.LogID) as confirm_count,0 as not_confirm_count,0 as total_count,bp.city_id <br>          FROM builder_project_info as bp <br>          JOIN attendentlog as att ON bp.project_id = att.CompanyID <br>          WHERE att.CompanyID in (SELECT project_id from builder_project_info WHERE city_id = 407) and att.LogTime like &quot;2019-06%&quot; and att.state = 1 <br>          GROUP BY bp.city_id <br>      )<br>UNION all (<br>    select 0 as invalid_count, 0 as confirm_count,count(att.LogID) as not_confirm_count,0 as total_count,bp.city_id <br>    FROM builder_project_info as bp <br>    JOIN attendentlog as att ON bp.project_id = att.CompanyID <br>    WHERE att.CompanyID in (SELECT project_id from builder_project_info WHERE city_id = 407) and att.LogTime like &quot;2019-06%&quot; and att.state = 0 <br>    GROUP BY bp.city_id <br>) <br>UNION all ( <br>    select 0 as invalid_count, 0 as confirm_count,0 as not_confirm_count,count(att.LogID) as total_count,bp.city_id <br>    FROM builder_project_info as bp <br>    JOIN attendentlog as att ON bp.project_id = att.CompanyID <br>    WHERE att.CompanyID in (SELECT project_id from builder_project_info WHERE city_id = 407) and att.LogTime like &quot;2019-06%&quot; <br>    GROUP BY bp.city_id )  <br>     ) as a <br>     GROUP BY a.city_id<br><br>desc city <br>desc country<br>show index from city <br>explain <br>SELECT <br>COUNT(CASE WHEN att.state=0 THEN 1 END) AS a,<br>COUNT(CASE WHEN att.state=1 THEN 1 END) AS b,<br>COUNT(CASE WHEN att.state=2 THEN 1 END) AS c,<br>sum(att.LogID)<br>FROM builder_project_info AS bp<br>JOIN attendentlog AS att ON bp.project_id = att.CompanyID<br>WHERE bp.city_id=407<br>AND att.LogTime between and <br>GROUP BY bp.city_id;<br></code></pre></td></tr></table></figure>

<h1 id="十四、-备份恢复"><a href="#十四、-备份恢复" class="headerlink" title="十四、 备份恢复"></a>十四、 备份恢复</h1><h2 id="14-1-在备份恢复中的职责"><a href="#14-1-在备份恢复中的职责" class="headerlink" title="14.1 在备份恢复中的职责"></a>14.1 在备份恢复中的职责</h2><h2 id="14-1-1-备份策略的设计"><a href="#14-1-1-备份策略的设计" class="headerlink" title="14.1.1 备份策略的设计"></a>14.1.1 备份策略的设计</h2><ol>
<li>备份周期:</li>
</ol>
<p>​    根据数据量.</p>
<ol start="2">
<li>备份工具: </li>
</ol>
<p>​    mysqldump (MDP) , XBK (PBK) percona Xtrabackup , MEB(MySQL Enterprise BACKUP MEB) ,mysqlbinlog</p>
<ol start="3">
<li><p>备份方式: </p>
<p>逻辑:</p>
<p>全备  mysqldump </p>
<p>增量  binlog (flush logs ,cp)</p>
</li>
<li><p>物理备份:（自带以下备份）</p>
<p>全备 : XBK </p>
<p>增量 : XBK</p>
</li>
</ol>
<h3 id="14-1-2-检查备份可用性"><a href="#14-1-2-检查备份可用性" class="headerlink" title="14.1.2 检查备份可用性"></a>14.1.2 检查备份可用性</h3><p>crontab -l —–&gt;</p>
<p>备份脚本  ——&gt;</p>
<p>备份路径  ——&gt;</p>
<p>看备份日志,检查备份文件(大小,内容)</p>
<h3 id="14-1-3-定期的恢复演练"><a href="#14-1-3-定期的恢复演练" class="headerlink" title="14.1.3 定期的恢复演练"></a>14.1.3 定期的恢复演练</h3><h3 id="14-1-4-数据恢复"><a href="#14-1-4-数据恢复" class="headerlink" title="14.1.4 数据恢复"></a>14.1.4 数据恢复</h3><p>只要备份和日志是完整的,恢复到故障之前的时间点(快速)</p>
<h3 id="14-1-5-数据迁移"><a href="#14-1-5-数据迁移" class="headerlink" title="14.1.5 数据迁移  ***"></a>14.1.5 数据迁移  ***</h3><p>操作系统不同的迁移</p>
<p>mysql  -&gt; mysql </p>
<p>其他  -&gt; mysql </p>
<p>mysql  -&gt;  其他 </p>
<h2 id="14-2-备份的介绍"><a href="#14-2-备份的介绍" class="headerlink" title="14.2 备份的介绍"></a>14.2 备份的介绍</h2><ol>
<li>备份的策略</li>
<li>备份的工具</li>
<li>备份类型</li>
</ol>
<p>​    热备 : 对于业务影响最小  InnoDB</p>
<p>​    温备 : 长时间锁表备份   MyISAM</p>
<p>​    冷备 : 业务关闭情况下备份     </p>
<h2 id="14-3-mysqldump"><a href="#14-3-mysqldump" class="headerlink" title="14.3 mysqldump"></a>14.3 mysqldump</h2><h3 id="14-3-1-连接数据库"><a href="#14-3-1-连接数据库" class="headerlink" title="14.3.1 连接数据库"></a>14.3.1 连接数据库</h3><p>-u</p>
<p>-p </p>
<p>-S </p>
<p>-h </p>
<p>P </p>
<h3 id="14-3-2-基础备份参数"><a href="#14-3-2-基础备份参数" class="headerlink" title="14.3.2 基础备份参数"></a>14.3.2 基础备份参数</h3><p>-A </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 backup]<span class="hljs-comment"># mysqldump -uroot -p123 -A &gt;/backup/full.sql</span><br></code></pre></td></tr></table></figure>

<p>-B</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 backup]<span class="hljs-comment"># mysqldump -uroot -p123 -B world oldguo wordpress &gt;/backup/db.sql</span><br></code></pre></td></tr></table></figure>

<p>库 表</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 backup]<span class="hljs-comment"># mysqldump -uroot -p123 world city country &gt; /backup/tab.sql</span><br></code></pre></td></tr></table></figure>

<h3 id="14-3-3-特殊备份参数"><a href="#14-3-3-特殊备份参数" class="headerlink" title="14.3.3 特殊备份参数"></a>14.3.3 特殊备份参数</h3><p>-R 存储过程和函数</p>
<p>-E 事件</p>
<p>–triggers 触发器 </p>
<p>–master-data=2   *****</p>
<ul>
<li><p>记录备份时刻的binlog信息（文件名和position号码）</p>
</li>
<li><p>自动开启锁表的功能</p>
</li>
</ul>
<p>​    不加–single-transaction ,温备份</p>
<p>​    加了–single-transaction,对于InnoDB表不锁表备份(快照备份)</p>
<p>–single-transaction *****</p>
<p>对于InnoDB的表,进行一致性快照备份,不锁表. </p>
<h2 id="14-4-恢复案例"><a href="#14-4-恢复案例" class="headerlink" title="14.4 恢复案例"></a>14.4 恢复案例</h2><h3 id="14-4-1-背景环境"><a href="#14-4-1-背景环境" class="headerlink" title="14.4.1 背景环境"></a>14.4.1 背景环境</h3><p>正在运行的网站系统，mysql-5.7.20 数据库，数据量50G，日业务增量1-5M。</p>
<h3 id="14-4-2-备份策略"><a href="#14-4-2-备份策略" class="headerlink" title="14.4.2 备份策略"></a>14.4.2 备份策略</h3><p>每天23:00点，计划任务调用mysqldump执行全备脚本</p>
<h3 id="14-4-3-故障时间点"><a href="#14-4-3-故障时间点" class="headerlink" title="14.4.3 故障时间点"></a>14.4.3 故障时间点</h3><p>年底故障演练:模拟周三上午10点误删除数据库.</p>
<h3 id="14-4-4-思路"><a href="#14-4-4-思路" class="headerlink" title="14.4.4 思路"></a>14.4.4 思路</h3><ol>
<li><p>停业务，挂维护页,避免数据的二次伤害</p>
</li>
<li><p>找一个临时库，恢复周二23：00全备</p>
</li>
<li><p>截取周二23：00 — 周三10点误删除之间的binlog，恢复到临时库</p>
</li>
<li><p>测试可用性和完整性</p>
</li>
<li><p>备份方法</p>
<ul>
<li>方法一：直接使用临时库顶替原生产库，前端应用割接到新库 </li>
<li>方法二：将误删除的表导出，导入到原生产库</li>
</ul>
</li>
<li><p>开启业务</p>
</li>
</ol>
<p>处理结果：经过20分钟的处理，最终业务恢复正常 </p>
<h3 id="14-4-5-故障模拟演练"><a href="#14-4-5-故障模拟演练" class="headerlink" title="14.4.5 故障模拟演练"></a>14.4.5 故障模拟演练</h3><h4 id="14-4-5-1-准备数据"><a href="#14-4-5-1-准备数据" class="headerlink" title="14.4.5.1 准备数据"></a>14.4.5.1 准备数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create database backup;<br>use backup<br>create table t1 (id int);<br>insert into t1 values(1),(2),(3);<br>commit;<br><br># rm -rf /backup/*<br></code></pre></td></tr></table></figure>

<h4 id="14-4-5-2-周二-23：00全备"><a href="#14-4-5-2-周二-23：00全备" class="headerlink" title="14.4.5.2 周二 23：00全备"></a>14.4.5.2 周二 23：00全备</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqldump -uroot -p123 -A -R --triggers --set-gtid-purged=OFF --master-data=2 --single-transaction|gzip &gt; /backup/full_$(date +%F).sql.gz<br></code></pre></td></tr></table></figure>

<h4 id="14-4-5-3-查看备份是否能正常使用"><a href="#14-4-5-3-查看备份是否能正常使用" class="headerlink" title="14.4.5.3 查看备份是否能正常使用"></a>14.4.5.3 查看备份是否能正常使用</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">gunzip full_2020-09-11.sql.gz<br>vim full_2020-09-11.sql.gz （查看是否有建库，建表，插入数据等）<br></code></pre></td></tr></table></figure>

<h4 id="14-4-5-3-模拟周二-23：00到周三-10点之间数据变化"><a href="#14-4-5-3-模拟周二-23：00到周三-10点之间数据变化" class="headerlink" title="14.4.5.3 模拟周二 23：00到周三 10点之间数据变化"></a>14.4.5.3 模拟周二 23：00到周三 10点之间数据变化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">use backup;<br>insert into t1 values(11),(22),(33);<br>commit;<br>create table t2 (id int);<br>insert into t2 values(11),(22),(33);<br>commit;<br></code></pre></td></tr></table></figure>

<h4 id="14-4-5-4-模拟故障-删除表-只是模拟，不代表生产操作"><a href="#14-4-5-4-模拟故障-删除表-只是模拟，不代表生产操作" class="headerlink" title="14.4.5.4 模拟故障,删除表(只是模拟，不代表生产操作)"></a>14.4.5.4 模拟故障,删除表(只是模拟，不代表生产操作)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">drop database backup;<br></code></pre></td></tr></table></figure>

<h3 id="14-4-6-恢复过程"><a href="#14-4-6-恢复过程" class="headerlink" title="14.4.6 恢复过程"></a>14.4.6 恢复过程</h3><h4 id="14-4-6-1-准备临时数据库（多实例3307）"><a href="#14-4-6-1-准备临时数据库（多实例3307）" class="headerlink" title="14.4.6.1 准备临时数据库（多实例3307）"></a>14.4.6.1 准备临时数据库（多实例3307）</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl start mysqld3307<br></code></pre></td></tr></table></figure>

<h4 id="14-4-6-2-准备备份"><a href="#14-4-6-2-准备备份" class="headerlink" title="14.4.6.2 准备备份"></a>14.4.6.2 准备备份</h4><ol>
<li>准备全备</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /backup<br>gunzip full_2018-10-14.sql.gz <br></code></pre></td></tr></table></figure>

<ol start="2">
<li>截取二进制日志</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="hljs-string">&#x27;mysql-bin.000007&#x27;</span>, MASTER_LOG_POS=957;<br><br>（从日志里找到起点，从show binlog events <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27; &#x27;</span> 找到终点）<br><br>753<br><br>1519<br><br>mysqlbinlog --skip-gtids --start-position=957 --stop-position=1723 /data/binlog/mysql-bin.000007 &gt;/backup/bin.sql<br></code></pre></td></tr></table></figure>

<h4 id="14-4-6-3-恢复备份到临时库"><a href="#14-4-6-3-恢复备份到临时库" class="headerlink" title="14.4.6.3 恢复备份到临时库"></a>14.4.6.3 恢复备份到临时库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql -S /data/3307/mysql.sock<br>set sql_log_bin=0;<br>source /backup/full_2020-09-11.sql<br>source /backup/bin.sql<br></code></pre></td></tr></table></figure>

<h4 id="14-4-6-4-将故障表导出并导入到生产"><a href="#14-4-6-4-将故障表导出并导入到生产" class="headerlink" title="14.4.6.4 将故障表导出并导入到生产"></a>14.4.6.4 将故障表导出并导入到生产</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysqldump -S /data/3307/mysql.sock -B backup &gt;/backup/bak.sql<br>mysql -uroot -p123 <br>set sql_log_bin=0;<br>source /backup/bak.sql;<br></code></pre></td></tr></table></figure>

<h2 id="14-5-练习"><a href="#14-5-练习" class="headerlink" title="14.5. 练习"></a>14.5. 练习</h2><ol>
<li>创建一个数据库 oldboy</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create database oldboy charset utf8mb4;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>在oldboy下创建一张表t1</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">use oldboy;<br>create table t1(id int);<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>插入5行任意数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">insert into t1 values(1),(2),(3),(4),(5);<br>commit;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>全备（检查备份文件）</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqldump -uroot -p123 -A --master-data=2 --single-transaction -R -E --triggers &gt; /backup/full.sql<br></code></pre></td></tr></table></figure>

<ol start="5">
<li>插入两行数据，任意修改3行数据，删除1行数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">insert into t1 values(6),(7),(8);<br>commit;<br>update t1 set id=10 where id&gt;5;<br>commit;<br>delete from t1 where id=5;<br>commit;<br></code></pre></td></tr></table></figure>

<ol start="6">
<li>删除所有数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">delete from t1;<br></code></pre></td></tr></table></figure>

<ol start="7">
<li>再t1中又插入5行新数据，修改3行数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">insert into t1 values(1),(2),(3),(4),(5);<br>commit;<br>update t1 set id=10 where id&gt;2;<br></code></pre></td></tr></table></figure>

<ol start="8">
<li><p>需求，跳过第六步恢复表数据</p>
</li>
<li><p>在全备中找到gtid，并从gtid冒号后的最后的编号+1作为起点。在MySQL中查找事件，找到第7步的数据gtid编号和删除数据的gtid编号（因为要跳过删除数据的gtid的编号），最后做5到7的备份（最后检查备份文件）</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysqlbinlog --skip-gtids --include-gtids=&#x27;9ce458af-ec03-11ea-b6bc-000c2936c152:16-21&#x27; --exclude-gtids=&#x27;9ce458af-ec03-11ea-b6bc-000c2936c152:19&#x27; /data/binlog/mysql-bin.000007 &gt;/backup/bin.sql<br></code></pre></td></tr></table></figure>

<ol start="10">
<li>设置跳过二进制日志记录</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set sql_log_bin=0;<br></code></pre></td></tr></table></figure>

<ol start="11">
<li>导入数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">source /backup/full.sql;<br>source /backup/bin.sql;<br></code></pre></td></tr></table></figure>

<ol start="12">
<li>关闭跳过日志</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set sql_log_bin=1;<br></code></pre></td></tr></table></figure>

<h2 id="14-6-扩展参数"><a href="#14-6-扩展参数" class="headerlink" title="14.6 扩展参数 ***"></a>14.6 扩展参数 ***</h2><p>在构建主从时,使用AUTO/ON</p>
<p>–set-gtid-purged=AUTO/ON/不写</p>
<p>仅是做普通的本机备份恢复时,可以添加</p>
<p>–set-gtid-purged=OFF </p>
<p>（总之在做备份时可以忽略不写，但是会有警报，警报也可以忽略）</p>
<p>–max_allowed_packet=128M 控制的是备份时传输数据包的大小.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqldump -uroot -p123 -A -R --max_allowed_packet=128M --triggers --set-gtid-purged=OFF --master-data=2 --single-transaction|gzip &gt; /backup/full_$(date +%F).sql.gz<br></code></pre></td></tr></table></figure>

<h2 id="14-7-物理备份-XBK"><a href="#14-7-物理备份-XBK" class="headerlink" title="14.7 物理备份-XBK"></a>14.7 物理备份-XBK</h2><h3 id="14-7-1-安装依赖包："><a href="#14-7-1-安装依赖包：" class="headerlink" title="14.7.1 安装依赖包："></a>14.7.1 安装依赖包：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<br><br>yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL libev<br></code></pre></td></tr></table></figure>

<h3 id="14-7-2-下载软件并安装"><a href="#14-7-2-下载软件并安装" class="headerlink" title="14.7.2 下载软件并安装"></a>14.7.2 下载软件并安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.12/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm centos7<br><br>wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/6/x86_64/percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm centos6<br><br>yum -y install percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm<br></code></pre></td></tr></table></figure>

<h3 id="14-7-3-innobackupex-使用"><a href="#14-7-3-innobackupex-使用" class="headerlink" title="14.7.3 innobackupex 使用"></a>14.7.3 innobackupex 使用</h3><h4 id="14-7-3-1-备份过程"><a href="#14-7-3-1-备份过程" class="headerlink" title="14.7.3.1 备份过程"></a>14.7.3.1 备份过程</h4><ol>
<li><p>针对非InnoDB,进行锁表备份,copy所有的非innoDB表文件</p>
</li>
<li><p>针对InnoDB表,立即触发checkpoint,会立即记录一个LSN，copy所有InnoDB表相关的文件(ibdata1,ibd,frm).并且将备份过程中产生,新的数据变化的部分redo一起备份走</p>
</li>
<li><p>在恢复时,xbk会调用InnoDB引擎的CSR过程,将数据和redo的LSN追平,然后进行一致性恢复.</p>
</li>
</ol>
<h4 id="14-7-3-2-恢复过程"><a href="#14-7-3-2-恢复过程" class="headerlink" title="14.7.3.2 恢复过程"></a>14.7.3.2 恢复过程</h4><p>模拟了CSR的全过程,在恢复之前,将数据的LSN号和redo LSN号追平</p>
<p>恢复方法就是直接cp回去即可</p>
<h4 id="14-7-3-2-xbk使用前提"><a href="#14-7-3-2-xbk使用前提" class="headerlink" title="14.7.3.2 xbk使用前提"></a>14.7.3.2 xbk使用前提</h4><ol>
<li><p>数据库启动</p>
</li>
<li><p>能连上数据库</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/my.cnf<br>[client]<br>socket=/tmp/mysql.sock<br></code></pre></td></tr></table></figure>

<ol start="3">
<li><p>默认会读取[mysqld] —&gt; datadir=xxxx</p>
</li>
<li><p>服务器端工具</p>
</li>
</ol>
<h4 id="14-7-3-3-xbk全备"><a href="#14-7-3-3-xbk全备" class="headerlink" title="14.7.3.3 xbk全备"></a>14.7.3.3 xbk全备</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">innobackupex --user=root --password=123 --no-timestamp /backup/full_`date +%F`<br><br>--no-timestamp：不生成时间名<br></code></pre></td></tr></table></figure>

<h4 id="14-7-3-4-备份结果（关键结果）"><a href="#14-7-3-4-备份结果（关键结果）" class="headerlink" title="14.7.3.4 备份结果（关键结果）"></a>14.7.3.4 备份结果（关键结果）</h4><p>xtrabackup_binlog_info ：记录备份后binlong位置点信息，binlog的截取起点    *****</p>
<p>xtrabackup_checkpoints ：备份过程中的LSN记录，方便做增量备份    *****</p>
<p>from : 备份中包含的LSN号的起点,全备:0,增量:上次备份的结束位置</p>
<p>to  : ckpt 时的LSN</p>
<p>last-9 : 备份结束时的LSN.下次增量备份的起始位置.</p>
<h4 id="14-7-3-4-全备恢复演练"><a href="#14-7-3-4-全备恢复演练" class="headerlink" title="14.7.3.4 全备恢复演练"></a>14.7.3.4 全备恢复演练</h4><ol>
<li>破坏</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">pkill mysqld<br>rm -rf /data/mysql/data/*<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>备份处理</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#redo 前滚，undo 回滚，模仿CSR过程</span><br>innobackupex --apply-log /backup/full/<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>数据恢复</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">cp -a /backup/full/* /data/mysql/data/<br>chown -R mysql.mysql /data/mysql/data/*<br>/etc/init.d/mysqld start<br></code></pre></td></tr></table></figure>

<h3 id="14-7-4-增量备份"><a href="#14-7-4-增量备份" class="headerlink" title="14.7.4 增量备份"></a>14.7.4 增量备份</h3><h4 id="14-7-4-1-清空备份路径"><a href="#14-7-4-1-清空备份路径" class="headerlink" title="14.7.4.1 清空备份路径"></a>14.7.4.1 清空备份路径</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">\rm -rf /backup/*<br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-2-模拟数据"><a href="#14-7-4-2-模拟数据" class="headerlink" title="14.7.4.2 模拟数据"></a>14.7.4.2 模拟数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create database full charset utf8mb4;<br>use full;<br>create table t1 (id int);<br>insert into t1 values(1),(2),(3);<br>commit;<br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-3-进行周日的全备"><a href="#14-7-4-3-进行周日的全备" class="headerlink" title="14.7.4.3 进行周日的全备"></a>14.7.4.3 进行周日的全备</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 backup]<span class="hljs-comment"># innobackupex --user=root --password=123 --no-timestamp /backup/full</span><br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-4模拟周一的数据变化"><a href="#14-7-4-4模拟周一的数据变化" class="headerlink" title="14.7.4.4模拟周一的数据变化"></a>14.7.4.4模拟周一的数据变化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create database inc1 charset utf8mb4;<br>use inc1;<br>create table t1 (id int);<br>insert into t1 values(1),(2),(3);<br>commit;<br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-5-进行周一的增量备份"><a href="#14-7-4-5-进行周一的增量备份" class="headerlink" title="14.7.4.5 进行周一的增量备份"></a>14.7.4.5 进行周一的增量备份</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/full /backup/inc1 <br></code></pre></td></tr></table></figure>

<p>说明:</p>
<p>–incremental  开关 </p>
<p>–incremental-basedir=/backup/full 基于哪个备份进行增量</p>
<p>/backup/inc1   增量备份的位置点</p>
<h4 id="14-7-4-6-检查备份的LSN"><a href="#14-7-4-6-检查备份的LSN" class="headerlink" title="14.7.4.6 检查备份的LSN"></a>14.7.4.6 检查备份的LSN</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 backup]<span class="hljs-comment"># cat /backup/full/xtrabackup_checkpoints </span><br>backup_type = full-backuped<br>from_lsn = 0<br>to_lsn = 217478672<br>last_lsn = 217478681<br>compact = 0<br>recover_binlog_info = 0<br>[root@db01 backup]<span class="hljs-comment"># cat /backup/inc1/xtrabackup_checkpoints </span><br>backup_type = incremental<br>from_lsn = 217478672<br>to_lsn = 217484653<br>last_lsn = 217484662<br>compact = 0<br>recover_binlog_info = 0<br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-7-模拟周二数据变化"><a href="#14-7-4-7-模拟周二数据变化" class="headerlink" title="14.7.4.7 模拟周二数据变化"></a>14.7.4.7 模拟周二数据变化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create database inc2 charset utf8mb4;<br>use inc2;<br>create table t1 (id int);<br>insert into t1 values(1),(2),(3);<br>commit;<br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-8-周二的增量"><a href="#14-7-4-8-周二的增量" class="headerlink" title="14.7.4.8 周二的增量"></a>14.7.4.8 周二的增量</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">innobackupex  --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/inc1 /backup/inc2 <br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-9-周三的数据变化"><a href="#14-7-4-9-周三的数据变化" class="headerlink" title="14.7.4.9 周三的数据变化"></a>14.7.4.9 周三的数据变化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create database inc3 charset utf8mb4;<br>use inc3;<br>create table t1 (id int);<br>insert into t1 values(1),(2),(3);<br>commit;<br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-10-模拟上午10点数据库崩溃"><a href="#14-7-4-10-模拟上午10点数据库崩溃" class="headerlink" title="14.7.4.10 模拟上午10点数据库崩溃"></a>14.7.4.10 模拟上午10点数据库崩溃</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">pkill mysqld <br>\rm -rf /data/mysql/data/*<br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-11-恢复思路"><a href="#14-7-4-11-恢复思路" class="headerlink" title="14.7.4.11 恢复思路"></a>14.7.4.11 恢复思路</h4><ol>
<li><p>停业务,挂维护页</p>
</li>
<li><p>查找可用备份并处理备份:full+inc1+inc2 </p>
</li>
<li><p>binlog: inc2 到 故障时间点的binlog</p>
</li>
<li><p>恢复全备+增量+binlog</p>
</li>
<li><p>验证数据</p>
</li>
<li><p>起业务,撤维护页</p>
</li>
</ol>
<h4 id="14-7-4-12-恢复前的准备"><a href="#14-7-4-12-恢复前的准备" class="headerlink" title="14.7.4.12 恢复前的准备"></a>14.7.4.12 恢复前的准备</h4><ol>
<li>整理full</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">innobackupex --apply-log --redo-only /backup/full<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>合并inc1到full,并整理备份</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">innobackupex --apply-log --redo-only --incremental-dir=/backup/inc1 /backup/full <br></code></pre></td></tr></table></figure>

<ol start="3">
<li>合并inc2到full,并整理备份 </li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">innobackupex --apply-log --incremental-dir=/backup/inc2 /backup/full <br></code></pre></td></tr></table></figure>

<ol start="4">
<li>最后一次整理full</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">innobackupex --apply-log /backup/full<br></code></pre></td></tr></table></figure>

<p>–redo-only ：只记录redo，用于第一次基于全备，和最后一次增备之前的所有备份。最后一次增备和最后一次全备不用</p>
<h4 id="14-7-4-13-截取二进制日志"><a href="#14-7-4-13-截取二进制日志" class="headerlink" title="14.7.4.13 截取二进制日志"></a>14.7.4.13 截取二进制日志</h4><p>起点:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">cat /backup/inc2/xtrabackup_binlog_info<br>mysql-bin.000009	1997	40fc0f82-f4a1-11ea-b95f-000c2936c152:1-9,<br>9ce458af-ec03-11ea-b6bc-000c2936c152:1-21<br></code></pre></td></tr></table></figure>

<p>终点:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqlbinlog /data/binlog/mysql-bin.000009 | grep <span class="hljs-string">&#x27;SET&#x27;</span><br>SET @@SESSION.GTID_NEXT= <span class="hljs-string">&#x27;40fc0f82-f4a1-11ea-b95f-000c2936c152:12&#x27;</span>/*!*/;<br></code></pre></td></tr></table></figure>

<p>命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqlbinlog --skip-gtids --include-gtids=<span class="hljs-string">&#x27;40fc0f82-f4a1-11ea-b95f-000c2936c152:10-12&#x27;</span> /data/binlog/mysql-bin.000009 &gt; /backup/binlog.sql<br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-14-恢复备份数据"><a href="#14-7-4-14-恢复备份数据" class="headerlink" title="14.7.4.14 恢复备份数据"></a>14.7.4.14 恢复备份数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">[root@db01 /]# cp -a /backup/full/* /data/mysql/data/<br>[root@db01 /]# chown -R mysql. /data/<br>[root@db01 /]# /etc/init.d/mysqld start<br>mysql&gt; set sql_log_bin=0;<br>mysql&gt; source /backup/binlog.sql<br></code></pre></td></tr></table></figure>

<h4 id="14-7-4-15-验证数据"><a href="#14-7-4-15-验证数据" class="headerlink" title="14.7.4.15 验证数据"></a>14.7.4.15 验证数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; select * from full.t1;<br>mysql&gt; select * from inc1.t1;<br>mysql&gt; select * from inc2.t1;<br>mysql&gt; select * from inc3.t1;<br></code></pre></td></tr></table></figure>

<h3 id="14-7-5-升级迁移-5-6-44-—-gt-5-7-26"><a href="#14-7-5-升级迁移-5-6-44-—-gt-5-7-26" class="headerlink" title="14.7.5 升级迁移(5.6.44 —&gt; 5.7.26)"></a>14.7.5 升级迁移(5.6.44 —&gt; 5.7.26)</h3><h4 id="14-7-5-1-搭建5-6的测试环境"><a href="#14-7-5-1-搭建5-6的测试环境" class="headerlink" title="14.7.5.1 搭建5.6的测试环境"></a>14.7.5.1 搭建5.6的测试环境</h4><ol>
<li>创建必须的目录</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@oldboyedu ~]<span class="hljs-comment"># mkdir /data/mysql/data -p </span><br>[root@oldboyedu ~]<span class="hljs-comment"># mkdir /application/ -p</span><br>[root@oldboyedu ~]<span class="hljs-comment"># mkdir /data/binlog -p</span><br></code></pre></td></tr></table></figure>

<p>上传软件至 /application 下并解压</p>
<p>tar xvf …..</p>
<p>mv mysql….. mysql</p>
<ol start="2">
<li>建用户,改权限</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@oldboyedu ~]<span class="hljs-comment"># useradd mysql</span><br>[root@oldboyedu ~]<span class="hljs-comment"># chown -R mysql. /data /application/</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>修改环境变量</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/profile<br><span class="hljs-built_in">export</span> PATH=/application/mysql/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>数据初始化 </li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@oldboyedu ~]<span class="hljs-comment"># yum remove mariadb-libs</span><br>[root@oldboyedu ~]<span class="hljs-comment"># yum install -y libaio-devel</span><br>[root@oldboyedu ~]<span class="hljs-comment"># \rm -rf /data/mysql/data/*</span><br>[root@oldboyedu ~]<span class="hljs-comment"># /application/mysql/scripts/mysql_install_db --user=mysql --basedir=/application/mysql --datadir=/data/mysql/data</span><br><br>(如果出现 FATAL ERROR: please install the following Perl modules before executing 错误就安装 yum -y install autoconf)<br></code></pre></td></tr></table></figure>

<ol start="5">
<li>启动数据库</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@oldboyedu data]<span class="hljs-comment"># /etc/init.d/mysqld start</span><br>[root@oldboyedu data]<span class="hljs-comment"># mysqladmin -uroot -p password 123</span><br></code></pre></td></tr></table></figure>

<h4 id="14-7-5-2-迁移5-6-数据到-5-7-扩展"><a href="#14-7-5-2-迁移5-6-数据到-5-7-扩展" class="headerlink" title="14.7.5.2 迁移5.6 数据到 5.7 (扩展)"></a>14.7.5.2 迁移5.6 数据到 5.7 (扩展)</h4><ol>
<li>5.6 数据库备份</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@oldboyedu ~]<span class="hljs-comment"># mysqldump -uroot -p123 -A --master-data=2 --single-transaction -R -E --triggers &gt;/tmp/full.sql</span><br>[root@oldboyedu ~]<span class="hljs-comment"># scp /tmp/full.sql 10.0.0.51:/data/3308</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>准备5.7数据库</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 /]<span class="hljs-comment"># systemctl start mysqld3308</span><br>[root@db01 /]<span class="hljs-comment"># mysql -S /data/3308/mysql.sock</span><br>mysql&gt; <span class="hljs-built_in">source</span> /data/3308/full.sql<br>mysql&gt; flush privileges;<br>[root@db01 /]<span class="hljs-comment"># mysql_upgrade -uroot -p123 -S /data/3308/mysql.sock</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li><p>binlog的持续追加</p>
</li>
<li><p>停业务,恢复剩余的binlog</p>
</li>
<li><p>业务割接 </p>
</li>
</ol>
<h3 id="14-7-6-作业1"><a href="#14-7-6-作业1" class="headerlink" title="14.7.6 作业1"></a>14.7.6 作业1</h3><p> Xtrabackup企业级增量恢复实战</p>
<p>背景：</p>
<p>某大型网站，mysql数据库，数据量500G，每日更新量20M-30M</p>
<p>备份策略：</p>
<p>xtrabackup，每周日0:00进行全备，周一到周六00:00进行增量备份。</p>
<p>故障场景：</p>
<p>周三下午2点出现数据库意外删除表操作。</p>
<p>如何恢复？ </p>
<h3 id="14-7-7-作业2"><a href="#14-7-7-作业2" class="headerlink" title="14.7.7 作业2"></a>14.7.7 作业2</h3><p>练习：mysqldump备份恢复例子</p>
<ol>
<li>创建一个数据库 oldboy</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create database oldboy;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>在oldboy下创建一张表t1</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">crate tables t1(id,int);<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>插入5行任意数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">insert t1 values(1),(2),(3),(4),(5);<br>commit;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>全备</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqldump -uroot -p123456 -A -R --trigger --master-data=2 --set-gtid-purged=OFF --single-transaction | gzip &gt; /backup/full_$(date +%F).sql<br></code></pre></td></tr></table></figure>

<p>检查全备，截取gtid号</p>
<p>SET @@GLOBAL.GTID_PURGED=…..</p>
<p>例如：a:1-10</p>
<ol start="5">
<li>插入两行数据，任意修改3行数据，删除1行数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">insert t1 values(6),(7);<br>commit;<br></code></pre></td></tr></table></figure>

<ol start="6">
<li>删除所有数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">delete from t1;<br>select * from t1;<br></code></pre></td></tr></table></figure>

<ol start="7">
<li>再t1中又插入5行新数据，修改3行数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">insert t1 values(8),(9),(10),(11),(12),(13);<br>update t1 set id=111 where id=11;<br>update t1 set id=112 where id=12;<br>update t1 set id=113 where id=13;<br>commit;<br></code></pre></td></tr></table></figure>

<ol start="8">
<li><p>需求，跳过第六步恢复表数据</p>
</li>
<li><p>从show binlog events in “ “里知道全备之后所有操作的gtid编号（包含删除的表的编号）(将删除的编号设定位16)</p>
</li>
<li><p>增量备份</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysqlbinlog --skip-gtids --include-gtids=‘a:11-18’ --exclude-gtids=&#x27;a:16&#x27; /data/binlog/mysql-bin.000006 &gt; /backup/bin_`date +%F`.sql<br></code></pre></td></tr></table></figure>

<ol start="11">
<li>在别的库里还原备份，且导出数据库</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set sql_log_bin=0;<br>source full_$(date +%F).sql;<br>source bin_`date +%F`.sql;<br>set sql_log_bin=0;<br>mysqldump -S /data/3307/mysql.sock -B backup &gt;/backup/bak.sql<br></code></pre></td></tr></table></figure>

<ol start="12">
<li>将导出的表导入到原来的数据库中</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set sql_log_bin=0;<br>source /backup/bak.sql;<br>set sql_log_bin=1;<br></code></pre></td></tr></table></figure>

<h3 id="14-7-8-作业3"><a href="#14-7-8-作业3" class="headerlink" title="14.7.8 作业3"></a>14.7.8 作业3</h3><p>分别写备份脚本和策略 </p>
<h3 id="14-7-9-作业4：备份集中单独恢复表"><a href="#14-7-9-作业4：备份集中单独恢复表" class="headerlink" title="14.7.9 作业4：备份集中单独恢复表"></a>14.7.9 作业4：备份集中单独恢复表</h3><p>思考:在之前的项目案例中,如果误删除的表只有10M,而备份有500G,该如何快速恢复误删除表?</p>
<p>提示：</p>
<p>drop table city;</p>
<p>create table city like city_bak;</p>
<p>alter table city discard tablespace;</p>
<p>cp /backup/full/world/city.ibd /application/mysql/data/world/</p>
<p>chown -R mysql.mysql /application/mysql/data/world/city.ibd </p>
<p>alter table city import tablespace;</p>
<h3 id="14-7-10-作业5：-从mysqldump全备中获取库和表的备份"><a href="#14-7-10-作业5：-从mysqldump全备中获取库和表的备份" class="headerlink" title="14.7.10 作业5： 从mysqldump全备中获取库和表的备份"></a>14.7.10 作业5： 从mysqldump全备中获取库和表的备份</h3><ol>
<li>获得表结构</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># sed -e&#x27;/./&#123;H;$!d;&#125;&#x27; -e &#x27;x;/CREATE TABLE `city`/!d;q&#x27; full.sql&gt;createtable.sql</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>获得INSERT INTO 语句，用于数据的恢复</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># grep -i &#x27;INSERT INTO `city`&#x27; full.sqll &gt;data.sql &amp;</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>获取单库的备份</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># sed -n &#x27;/^-- Current Database: `world`/,/^-- Current Database: `/p&#x27; all.sql &gt;world.sql</span><br></code></pre></td></tr></table></figure>



<h1 id="十五、主从复制"><a href="#十五、主从复制" class="headerlink" title="十五、主从复制"></a>十五、主从复制</h1><p><font color="red"><strong>MySQL Replication(主从复制)</strong></font></p>
<h2 id="15-1-职责介绍"><a href="#15-1-职责介绍" class="headerlink" title="15.1 职责介绍"></a>15.1 职责介绍</h2><ol>
<li>搭建主从复制  *****</li>
<li>主从原理熟悉  *****</li>
<li>主从的故障处理 *****</li>
<li>主从延时  *****</li>
<li>主从的特殊架构的配置使用 </li>
<li>主从架构的演变  </li>
</ol>
<h2 id="15-2-主从复制介绍"><a href="#15-2-主从复制介绍" class="headerlink" title="15.2 主从复制介绍"></a>15.2 主从复制介绍</h2><ol>
<li><p>主从复制基于binlog来实现的</p>
</li>
<li><p>主库发生新的操作,都会记录binlog.</p>
</li>
<li><p>从库取得主库的binlog进行回放</p>
</li>
<li><p>主从复制的过程是异步 </p>
</li>
</ol>
<h2 id="15-3-主从复制的前提-搭建主从复制"><a href="#15-3-主从复制的前提-搭建主从复制" class="headerlink" title="15.3 主从复制的前提 (搭建主从复制)"></a>15.3 主从复制的前提 (搭建主从复制)</h2><ol>
<li><p>2个或以上的数据库实例</p>
</li>
<li><p>主库需要开启二进制日志 </p>
</li>
<li><p>server_id要不同,区分不同的节点</p>
</li>
<li><p>主库需要建立专用的复制用户 (replication slave)</p>
</li>
<li><p>从库应该通过备份主库,恢复的方法进行”补课”</p>
</li>
<li><p>人为告诉从库一些复制信息(ip port user pass,二进制日志起点)</p>
</li>
<li><p>从库应该开启专门的复制线程 </p>
</li>
</ol>
<h2 id="15-4-主从复制搭建过程-生产，3307作为主库，非gtid模式"><a href="#15-4-主从复制搭建过程-生产，3307作为主库，非gtid模式" class="headerlink" title="15.4 主从复制搭建过程(生产，3307作为主库，非gtid模式)"></a>15.4 主从复制搭建过程(生产，3307作为主库，非gtid模式)</h2><h3 id="15-4-1-准备多实例"><a href="#15-4-1-准备多实例" class="headerlink" title="15.4.1 准备多实例"></a>15.4.1 准备多实例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 data]<span class="hljs-comment"># pkill mysqld</span><br>[root@db01 data]<span class="hljs-comment"># systemctl start mysqld3307</span><br>[root@db01 data]<span class="hljs-comment"># \rm -rf /data/3308/data/*</span><br>[root@db01 3308]<span class="hljs-comment"># \rm -rf /data/3308/mysql-bin.*</span><br>[root@db01 3308]<span class="hljs-comment"># mysqld --initialize-insecure --user=mysql --basedir=/application/mysql --datadir=/data/3308/data	（初始化数据库，因为把一些数据删除了）</span><br>[root@db01 data]<span class="hljs-comment"># systemctl start mysqld3308</span><br>[root@db01 data]<span class="hljs-comment"># mysql -S /data/3308/mysql.sock -e &quot;select @@port&quot;	（检查是否启动成功）</span><br>[root@db01 data]<span class="hljs-comment"># mysql -uroot -p123 -S /data/3307/mysql.sock -e &quot;select @port&quot;; （检查是否启动成功）</span><br></code></pre></td></tr></table></figure>

<h3 id="15-4-2-检查配置文件"><a href="#15-4-2-检查配置文件" class="headerlink" title="15.4.2 检查配置文件"></a>15.4.2 检查配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh">主库: 二进制日志是否开启<br>两个节点: server_id<br>[root@db01 data]<span class="hljs-comment"># cat /data/3308/my.cnf </span><br>[mysqld]<br>basedir=/application/mysql<br>datadir=/data/3308/data<br>socket=/data/3308/mysql.sock<br>log_error=/data/3308/mysql.log<br>port=3308<br>server_id=8<br>log_bin=/data/3308/mysql-bin<br><br>[root@db01 data]<span class="hljs-comment"># cat /data/3307/my.cnf </span><br>[mysqld]<br>basedir=/application/mysql<br>datadir=/data/3307/data<br>socket=/data/3307/mysql.sock<br>log_error=/data/3307/mysql.log<br>port=3307<br>server_id=7<br>log_bin=/data/3307/mysql-bin<br></code></pre></td></tr></table></figure>

<h3 id="15-4-3-主库创建复制用户"><a href="#15-4-3-主库创建复制用户" class="headerlink" title="15.4.3 主库创建复制用户"></a>15.4.3 主库创建复制用户</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 ~]<span class="hljs-comment"># mysql -uroot -p123 -S /data/3307/mysql.sock -e &quot;grant replication slave on *.* to repl@&#x27;192.168.27.%&#x27; identified by &#x27;123&#x27;&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="15-4-4-“补课”（全备）"><a href="#15-4-4-“补课”（全备）" class="headerlink" title="15.4.4 “补课”（全备）"></a>15.4.4 “补课”（全备）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#主: </span><br>[root@db01 ~]<span class="hljs-comment"># mysqldump -uroot -p123 -S /data/3307/mysql.sock -A --master-data=2 --single-transaction -R -E --triggers &gt;/tmp/full.sql</span><br><span class="hljs-comment">#从:</span><br>[root@db01 ~]<span class="hljs-comment"># mysql -S /data/3308/mysql.sock </span><br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=0;<br>mysql&gt; <span class="hljs-built_in">source</span> /tmp/full.sql<br></code></pre></td></tr></table></figure>

<h3 id="15-4-5-告诉从库信息（从库输入）"><a href="#15-4-5-告诉从库信息（从库输入）" class="headerlink" title="15.4.5 告诉从库信息（从库输入）"></a>15.4.5 告诉从库信息（从库输入）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; help change master to; （查看帮助，直接在显示的最后把example复制，然后修改）<br>vim /tmp/full.sql	（查看二进制日志的文件以及位置）<br>-- CHANGE MASTER TO MASTER_LOG_FILE=&#x27;mysql-bin.000002&#x27;, MASTER_LOG_POS=448;<br>或从主库输入查看二进制日志的文件以及位置<br>show master log;<br><br>[root@db01 ~]# mysql -S /data/3308/mysql.sock <br>CHANGE MASTER TO <br>MASTER_HOST=&#x27;192.168.27.21&#x27;,<br>MASTER_USER=&#x27;repl&#x27;,<br>MASTER_PASSWORD=&#x27;123&#x27;,<br>MASTER_PORT=3306,<br>MASTER_LOG_FILE=&#x27;mysql-bin.000008&#x27;,<br>MASTER_LOG_POS=22434600,<br>MASTER_CONNECT_RETRY=10;<br></code></pre></td></tr></table></figure>

<h3 id="15-4-6-从库开启复制线程-IO-SQL"><a href="#15-4-6-从库开启复制线程-IO-SQL" class="headerlink" title="15.4.6 从库开启复制线程(IO,SQL)"></a>15.4.6 从库开启复制线程(IO,SQL)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 ~]<span class="hljs-comment"># mysql -S /data/3308/mysql.sock </span><br>mysql&gt; start slave;<br></code></pre></td></tr></table></figure>

<h3 id="15-4-7-检查主从复制状态"><a href="#15-4-7-检查主从复制状态" class="headerlink" title="15.4.7 检查主从复制状态"></a>15.4.7 检查主从复制状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 ~]<span class="hljs-comment"># mysql -S /data/3308/mysql.sock </span><br>mysql&gt; show slave status \G<br>......<br>​       Slave_IO_Running: Yes<br>​      Slave_SQL_Running: Yes<br><span class="hljs-comment">#主库:</span><br>[root@db01 ~]<span class="hljs-comment"># mysql -uroot -p123 -S /data/3307/mysql.sock -e &quot;create database alexsb&quot;</span><br><span class="hljs-comment">#从库:</span><br>[root@db01 world]<span class="hljs-comment"># mysql -S /data/3308/mysql.sock -e &quot;show databases&quot;</span><br></code></pre></td></tr></table></figure>

<h2 id="15-5-主从复制原理"><a href="#15-5-主从复制原理" class="headerlink" title="15.5 主从复制原理 *****"></a>15.5 主从复制原理 *****</h2><h3 id="15-5-1-主从复制中涉及的文件"><a href="#15-5-1-主从复制中涉及的文件" class="headerlink" title="15.5.1 主从复制中涉及的文件"></a>15.5.1 主从复制中涉及的文件</h3><p>主库: </p>
<p>​    binlog </p>
<p>从库: </p>
<p>​    relaylog 中继日志</p>
<p>​    master.info 主库信息文件</p>
<p>​    relaylog.info relaylog应用的信息</p>
<h3 id="15-5-2-主从复制中涉及的线程"><a href="#15-5-2-主从复制中涉及的线程" class="headerlink" title="15.5.2 主从复制中涉及的线程"></a>15.5.2 主从复制中涉及的线程</h3><p>主库:</p>
<p>​    Binlog_Dump Thread : DUMP_T</p>
<p>从库: </p>
<p>​    SLAVE_IO_THREAD   : IO_T</p>
<p>​    SLAVE_SQL_THREAD  : SQL_T</p>
<h3 id="15-5-3-主从复制工作-过程-原理"><a href="#15-5-3-主从复制工作-过程-原理" class="headerlink" title="15.5.3 主从复制工作(过程)原理"></a>15.5.3 主从复制工作(过程)原理</h3><ol>
<li><p>从库执行change master to 命令(主库的连接信息+复制的起点)</p>
</li>
<li><p>从库会将以上信息,记录到master.info文件</p>
</li>
<li><p>从库执行 start slave 命令,立即开启IO_T和SQL_T</p>
</li>
<li><p>从库 IO_T,读取master.info文件中的信息，获取到IP,PORT,User,Pass,binlog的位置信息</p>
</li>
<li><p>从库IO_T请求连接主库,主库专门提供一个DUMP_T,负责和IO_T交互</p>
</li>
<li><p>IO_T根据binlog的位置信息(mysql-bin.000004 , 444),请求主库新的binlog</p>
</li>
<li><p>主库通过DUMP_T将最新的binlog,通过网络TP给从库的IO_T</p>
</li>
<li><p>IO_T接收到新的binlog日志,存储到TCP/IP缓存,立即返回ACK给主库,并更新master.info</p>
</li>
<li><p>IO_T将TCP/IP缓存中数据,转储到磁盘relaylog中.</p>
</li>
<li><p>SQL_T读取relay.info中的信息,获取到上次已经应用过的relaylog的位置信息</p>
</li>
<li><p>SQL_T会按照上次的位置点回放最新的relaylog,再次更新relay.info信息</p>
</li>
<li><p>从库会自动purge应用过relay进行定期清理</p>
</li>
</ol>
<p>补充说明:</p>
<p>一旦主从复制构建成功,主库当中发生了新的变化,都会通过dump_T发送信号给IO_T,增强了主从复制的实时性.</p>
<p>" srcset="/blog/img/loading.gif<img src="">  </p>
<h3 id="15-5-4-主从复制监控"><a href="#15-5-4-主从复制监控" class="headerlink" title="15.5.4 主从复制监控 ****"></a>15.5.4 主从复制监控 ****</h3><p>命令:</p>
<p>show slave status \G</p>
<p><strong>主库有关的信息(master.info):</strong></p>
<p>Master_Host: 10.0.0.51</p>
<p>Master_User: repl</p>
<p>Master_Port: 3307</p>
<p>Connect_Retry: 10</p>
<p><font color="red"><strong>重点</strong></font></p>
<p>Master_Log_File: mysql-bin.000004</p>
<p>Read_Master_Log_Pos: 609 </p>
<p><strong>从库relay应用信息有关的(relay.info):</strong></p>
<p>Relay_Log_File: db01-relay-bin.000002</p>
<p>Relay_Log_Pos: 320</p>
<p>Relay_Master_Log_File: mysql-bin.000004</p>
<p><strong>从库线程运行状态(排错)</strong></p>
<p>Slave_IO_Running: Yes</p>
<p>Slave_SQL_Running: Yes</p>
<p>Last_IO_Errno: 0</p>
<p>Last_IO_Error: </p>
<p>Last_SQL_Errno: 0</p>
<p>Last_SQL_Error:         </p>
<p>​            </p>
<p><strong>过滤复制有关的信息:</strong>    </p>
<p>Replicate_Do_DB: </p>
<p>Replicate_Ignore_DB: </p>
<p>Replicate_Do_Table: </p>
<p>Replicate_Ignore_Table: </p>
<p>Replicate_Wild_Do_Table: </p>
<p>Replicate_Wild_Ignore_Table: </p>
<p>**从库延时主库的时间(秒): **</p>
<p>Seconds_Behind_Master: 0</p>
<p>​                </p>
<p><strong>延时从库 : 推迟多少时间从库在执行复制操作</strong></p>
<p>SQL_Delay: 0</p>
<p>SQL_Remaining_Delay: NULL</p>
<p><strong>GTID复制有关的状态信息</strong></p>
<p>Retrieved_Gtid_Set: </p>
<p>Executed_Gtid_Set: </p>
<p>Auto_Position: 0</p>
<h3 id="15-5-5-主从复制故障"><a href="#15-5-5-主从复制故障" class="headerlink" title="15.5.5 主从复制故障 *****"></a>15.5.5 主从复制故障 *****</h3><h4 id="15-5-5-1-IO-线程故障"><a href="#15-5-5-1-IO-线程故障" class="headerlink" title="15.5.5.1 IO 线程故障"></a>15.5.5.1 IO 线程故障</h4><p>连接主库: connecting</p>
<p>网络,连接信息错误或变更了,防火墙,连接数上限</p>
<p>排查思路:</p>
<ol>
<li>使用用户手工登录</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 data]<span class="hljs-comment"># mysql -urepl -p12321321 -h 10.0.0.51 -P 3307</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be nsecure.<br>ERROR 1045 (28000): Access denied <span class="hljs-keyword">for</span> user <span class="hljs-string">&#x27;repl&#x27;</span>@<span class="hljs-string">&#x27;db01&#x27;</span> (using password: YES)<br><br>[root@db01 data]<span class="hljs-comment"># mysql -urep -p123 -h 10.0.0.51 -P 3307</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be nsecure.<br>ERROR 1045 (28000): Access denied <span class="hljs-keyword">for</span> user <span class="hljs-string">&#x27;rep&#x27;</span>@<span class="hljs-string">&#x27;db01&#x27;</span> (using password: YES)<br><br>[root@db01 data]<span class="hljs-comment"># mysql -urepl -p123 -h 10.0.0.52 -P 3307</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be nsecure.<br>ERROR 2003 (HY000): Can<span class="hljs-string">&#x27;t connect to MySQL server on &#x27;</span>10.0.0.52<span class="hljs-string">&#x27; (113)</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@db01 data]# mysql -urepl -p123 -h 10.0.0.51 -P 3309</span><br><span class="hljs-string">mysql: [Warning] Using a password on the command line interface can be nsecure.</span><br><span class="hljs-string">ERROR 2003 (HY000): Can&#x27;</span>t connect to MySQL server on <span class="hljs-string">&#x27;10.0.0.51&#x27;</span> (111)<br>[root@db01 data]<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure>

<p>**解决: **</p>
<ol>
<li><p>stop slave </p>
</li>
<li><p>reset slave all;</p>
</li>
<li><p>change master to （重新写正确的）</p>
</li>
<li><p>start slave</p>
</li>
<li><p>请求Binlog的错误</p>
</li>
</ol>
<p>错误原因：</p>
<p>binlog 没开</p>
<p>binlog 损坏,不存在</p>
<p><strong>解决方法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#主库执行 <br>reset master;<br>#从库操作 <br>stop slave ;<br>reset slave all; <br>CHANGE MASTER TO <br>MASTER_HOST=&#x27;10.0.0.51&#x27;,<br>MASTER_USER=&#x27;repl&#x27;,<br>MASTER_PASSWORD=&#x27;123&#x27;,<br>MASTER_PORT=3307,<br>MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;,<br>MASTER_LOG_POS=154,<br>MASTER_CONNECT_RETRY=10;<br>start slave;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>存储binlog到relaylog </li>
</ol>
<h4 id="15-5-5-2-SQL线程故障"><a href="#15-5-5-2-SQL线程故障" class="headerlink" title="15.5.5.2 SQL线程故障"></a>15.5.5.2 SQL线程故障</h4><p>relay-log损坏</p>
<p>回放relaylog</p>
<p>研究一条SQL语句为什么执行失败?</p>
<p>insert delete update   —&gt; t1 表 不存在</p>
<p>create table oldboy   —&gt; oldboy 已存在</p>
<p>约束冲突(主键,唯一键,非空..)</p>
<p>合理处理方法: </p>
<p>把握一个原则,一切以主库为准进行解决.</p>
<p>如果出现问题,尽量进行反操作</p>
<p>最直接稳妥办法,重新构建主从</p>
<p>暴力的解决方法</p>
<p>方法一：</p>
<p>stop slave; </p>
<p>set global sql_slave_skip_counter = 1;</p>
<p>start slave;</p>
<p>将同步指针向下移动一个，如果多次不同步，可以重复操作。</p>
<p>start slave;</p>
<p>方法二：</p>
<p>/etc/my.cnf</p>
<p>slave-skip-errors = 1032,1062,1007</p>
<p>常见错误代码:</p>
<p>1007:对象已存在</p>
<p>1032:无法执行DML</p>
<p>1062:主键冲突,或约束冲突</p>
<p>但是，以上操作有时是有风险的，最安全的做法就是重新构建主从。把握一个原则,一切以主库为主.</p>
<p>为了很程度的避免SQL线程故障</p>
<ol>
<li>从库只读</li>
</ol>
<p>show variables like ‘%read_only%’;</p>
<p>read_only</p>
<p>super_read_only</p>
<ol start="2">
<li><p>使用读写分离中间件（互联网公司一般用这个）</p>
<p>atlas </p>
<p>mycat</p>
<p>ProxySQL </p>
<p>MaxScale</p>
</li>
</ol>
<h3 id="15-5-6-主从延时监控及原因"><a href="#15-5-6-主从延时监控及原因" class="headerlink" title="15.5.6 主从延时监控及原因 *****"></a>15.5.6 主从延时监控及原因 *****</h3><h4 id="15-5-6-1-主库方面原因"><a href="#15-5-6-1-主库方面原因" class="headerlink" title="15.5.6.1 主库方面原因"></a>15.5.6.1 主库方面原因</h4><ol>
<li>binlog写入不及时</li>
</ol>
<p>sync_binlog=1    （每次事务提交都立即提交到binlog日志里）</p>
<ol start="2">
<li>默认情况下dump_t 是串行传输binlog *****</li>
</ol>
<p>在并发事务量大时或者大事务,由于dump_t 是串型工作的,导致传送日志较慢(5.5 5.6)</p>
<p>如何解决问题?</p>
<p>必须GTID,使用Group commit方式.可以支持DUMP_T并行,这个还需要配合双一标准来实现</p>
<ol start="3">
<li>主库极其繁忙</li>
</ol>
<p>慢语句</p>
<p>锁等待</p>
<p>从库个数</p>
<p>网络延时</p>
<h4 id="15-5-6-2-从库方面原因"><a href="#15-5-6-2-从库方面原因" class="headerlink" title="15.5.6.2 从库方面原因"></a>15.5.6.2 从库方面原因</h4><ol>
<li>传统复制(Classic)中 *****</li>
</ol>
<p>如果主库并发事务量很大,或者出现大事务</p>
<p>由于从库是单SQL线程,导致,不管传的日志有多少,只能一次执行一个事务.</p>
<p>5.6 版本,有了GTID,可以实现多SQL线程,但是只能基于不同库的事务进行并发回放.(database) </p>
<p>5.7 版本中,有了增强的GTID,增加了seq_no,增加了新型的并发SQL线程模式(logical_clock),MTS技术</p>
<ol start="2">
<li><p>主从硬件差异太大</p>
</li>
<li><p>主从的参数配置</p>
</li>
<li><p>从库和主库的索引不一致</p>
</li>
<li><p>版本有差异</p>
</li>
</ol>
<h4 id="15-5-6-3-主从延时的监控"><a href="#15-5-6-3-主从延时的监控" class="headerlink" title="15.5.6.3 主从延时的监控"></a>15.5.6.3 主从延时的监控</h4><p>show slave status\G</p>
<p>Seconds_Behind_Master: 0</p>
<p>（使用排除法，排除哪一个库出现问题，剩下就是哪一个库又问题）</p>
<p>主库方面原因的监控</p>
<p>主库：</p>
<p>mysql&gt; show master status ;</p>
<p>File: mysql-bin.000001</p>
<p>Position: 1373</p>
<p>从库：</p>
<p>mysql&gt; show slave status\G;</p>
<p>Master_Log_File: mysql-bin.000001</p>
<p>Read_Master_Log_Pos: 1373</p>
<p>从库方面原因监控:    </p>
<p>可以通过查relay-log.info查看mysql-bin是否一致</p>
<p>拿了多少:</p>
<p>mysql&gt; show master status;</p>
<p>Master_Log_File: mysql-bin.000001</p>
<p>Read_Master_Log_Pos: 691688</p>
<p>执行了多少:</p>
<p>mysql&gt; show slave status\G;</p>
<p>Relay_Log_File: db01-relay-bin.000004</p>
<p>Relay_Log_Pos: 690635</p>
<p>Exec_Master_Log_Pos: 691000</p>
<p>Relay_Log_Space: 690635</p>
<h2 id="15-6-延时从库"><a href="#15-6-延时从库" class="headerlink" title="15.6 延时从库  *****"></a>15.6 延时从库  *****</h2><h3 id="15-6-1-介绍及配置"><a href="#15-6-1-介绍及配置" class="headerlink" title="15.6.1 介绍及配置"></a>15.6.1 介绍及配置</h3><p>SQL线程延时:数据已经写入relaylog中了,SQL线程”慢点”运行</p>
<p>一般企业建议3-6小时,具体看公司运维人员对于故障的反应时间</p>
<p>mysql&gt; stop slave;</p>
<p>mysql&gt; CHANGE MASTER TO MASTER_DELAY = 300;</p>
<p>mysql&gt; start slave;</p>
<p>mysql&gt; show slave status \G</p>
<p>SQL_Delay: 300</p>
<p>SQL_Remaining_Delay: NULL</p>
<h3 id="15-6-2-延时从库处理逻辑故障"><a href="#15-6-2-延时从库处理逻辑故障" class="headerlink" title="15.6.2 延时从库处理逻辑故障"></a>15.6.2 延时从库处理逻辑故障</h3><h4 id="15-6-2-1-延时从库的恢复思路"><a href="#15-6-2-1-延时从库的恢复思路" class="headerlink" title="15.6.2.1 延时从库的恢复思路"></a>15.6.2.1 延时从库的恢复思路</h4><ol>
<li><p>监控到数据库逻辑故障</p>
</li>
<li><p>停从库SQL线程,记录已经回放的位置点(截取日志起点)</p>
</li>
</ol>
<p>mysql&gt; stop slave sql_thread ;</p>
<p>mysql&gt; show slave status \G</p>
<p>Relay_Log_File: db01-relay-bin.000002</p>
<p>Relay_Log_Pos: 320</p>
<ol start="3">
<li>截取relaylog日志</li>
</ol>
<p>​    起点: </p>
<p>​    show slave status \G</p>
<p>​    Relay_Log_File ,Relay_Log_Pos    </p>
<p>​    终点: drop之前的位置点</p>
<p>​    show relaylog events in ‘    ‘    </p>
<p>​    进行截取</p>
<ol start="4">
<li>模拟SQL线程回访日志</li>
</ol>
<p>​    从库 source </p>
<ol start="5">
<li>恢复业务</li>
</ol>
<p>​    情况一: 就一个库的话</p>
<p>​    从库替代主库工作</p>
<p>​    情况二: 主库多，而且还在进行业务</p>
<p>​    从库导出故障库,还原到主库中.</p>
<h4 id="15-6-2-2-故障演练"><a href="#15-6-2-2-故障演练" class="headerlink" title="15.6.2.2 故障演练"></a>15.6.2.2 故障演练</h4><p>主库 : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create database delay charset utf8mb4;<br>use delay;<br>create table t1 (id int);<br>insert into t1 values(1),(2),(3);<br>commit;<br>drop database delay;<br></code></pre></td></tr></table></figure>

<p>从库:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs mysql">1.停止 从库SQL 线程,获取relay的位置点（起点）<br>mysql&gt; stop slave sql_thread;<br>mysql&gt; show slave status \G;<br>Relay_Log_File: db01-relay-bin.000002<br>Relay_Log_Pos: 626<br>2.找到relay的截取终点<br>mysql&gt; show relaylog events in &#x27;db01-relay-bin.000002&#x27;;（看左边的数字）<br>| db01-relay-bin.000002 | 1299 | Query | 7 | 1228 | drop database delay      <br>3.截取relay<br>[root@db01 data]# cd /data/3308/data/<br>[root@db01 data]# mysqlbinlog --start-position=626 --stop-position=1299 db01-relay-bin.000002 &gt;/tmp/relay.sql<br>4.恢复relay到从库<br>[root@db01 data]# mysql -uroot -p -S /data/3308/mysql.sock <br>mysql&gt; set sql_log_bin=0;<br>mysql&gt; source /tmp/relay.sql;<br></code></pre></td></tr></table></figure>

<h2 id="15-7-过滤复制"><a href="#15-7-过滤复制" class="headerlink" title="15.7 过滤复制  *****"></a>15.7 过滤复制  *****</h2><h3 id="15-7-1-快速恢复测试环境"><a href="#15-7-1-快速恢复测试环境" class="headerlink" title="15.7.1 快速恢复测试环境"></a>15.7.1 快速恢复测试环境</h3><p>从库 :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql -S /data/3308/mysql.sock<br>drop database delay ;<br>stop slave;<br>reset slave all;<br></code></pre></td></tr></table></figure>

<p>主库: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql -S /data/33078/mysql.sock<br>reset master;<br></code></pre></td></tr></table></figure>

<p>从库: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">[root@db01 ~]# mysql -S /data/3308/mysql.sock <br>CHANGE MASTER TO <br>MASTER_HOST=&#x27;192.168.27.11&#x27;,<br>MASTER_USER=&#x27;repl&#x27;,<br>MASTER_PASSWORD=&#x27;123&#x27;,<br>MASTER_PORT=3307,<br>MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;,<br>MASTER_LOG_POS=154,<br>MASTER_CONNECT_RETRY=10;<br>start slave;<br></code></pre></td></tr></table></figure>

<h3 id="15-7-2-过滤复制应用"><a href="#15-7-2-过滤复制应用" class="headerlink" title="15.7.2 过滤复制应用"></a>15.7.2 过滤复制应用</h3><p>主库: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">show master status ;<br>（参数可以记录到my.cnf里，一般只使用其中一种）<br>binlog_do_db ：白名单<br>binlog_ignore_db ：黑名单<br></code></pre></td></tr></table></figure>

<p>从库: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show slave status \G<br>Replicate_Do_DB: 库级别的白名单<br>Replicate_Ignore_DB: 库级别的黑名单<br>Replicate_Do_Table: 表级别的白名单<br>Replicate_Ignore_Table: 表级别的黑名单<br>Replicate_Wild_Do_Table: 表级别模糊的白名单<br>Replicate_Wild_Ignore_Table: 表级别模糊的黑名单<br></code></pre></td></tr></table></figure>

<p>例子:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/my.cnf</span><br>replicate_do_db=repl<br><span class="hljs-comment"># systemctl restart mysqld3308</span><br></code></pre></td></tr></table></figure>

<h2 id="15-8-GTID复制"><a href="#15-8-GTID复制" class="headerlink" title="15.8 GTID复制  *****"></a>15.8 GTID复制  *****</h2><h3 id="15-8-1-介绍"><a href="#15-8-1-介绍" class="headerlink" title="15.8.1 介绍"></a>15.8.1 介绍</h3><p>GTID(Global Transaction ID)是对于一个已提交事务的唯一编号，并且是一个全局(主从复制)唯一的编号。</p>
<p>它的官方定义如下：</p>
<p>GTID = source_id ：transaction_id</p>
<p>7E11FA47-31CA-19E1-9E56-C43AA21293967:29</p>
<p>什么是sever_uuid，和Server-id 区别？</p>
<p>核心特性: 全局唯一,具备幂等性 </p>
<h3 id="15-8-2-GTID核心参数"><a href="#15-8-2-GTID核心参数" class="headerlink" title="15.8.2 GTID核心参数"></a>15.8.2 GTID核心参数</h3><p>重要参数： </p>
<p>gtid-mode=on</p>
<p>enforce-gtid-consistency=true</p>
<p>log-slave-updates=1</p>
<p>解释：</p>
<p>gtid-mode=on ：启用gtid类型，否则就是普通的复制架构</p>
<p>enforce-gtid-consistency=true：强制GTID的一致性</p>
<p>log-slave-updates=1：slave更新是否记入日志 </p>
<h3 id="15-8-3-GTID复制配置过程："><a href="#15-8-3-GTID复制配置过程：" class="headerlink" title="15.8.3 GTID复制配置过程："></a>15.8.3 GTID复制配置过程：</h3><ol>
<li>清理环境</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">pkill mysqld<br>\rm -rf /data/mysql/data/*<br>\rm -rf /data/binlog/*<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>准备配置文件</li>
</ol>
<p>主库db01：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh">cat &gt; /etc/my.cnf &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">[mysqld]</span><br><span class="hljs-string">basedir=/application/mysql/</span><br><span class="hljs-string">datadir=/data/mysql/data</span><br><span class="hljs-string">socket=/tmp/mysql.sock</span><br><span class="hljs-string">server_id=51</span><br><span class="hljs-string">port=3306</span><br><span class="hljs-string">secure-file-priv=/tmp</span><br><span class="hljs-string">autocommit=0</span><br><span class="hljs-string">log_bin=/data/binlog/mysql-bin</span><br><span class="hljs-string">binlog_format=row</span><br><span class="hljs-string">gtid-mode=on</span><br><span class="hljs-string">enforce-gtid-consistency=true</span><br><span class="hljs-string">log-slave-updates=1</span><br><span class="hljs-string">[mysql]</span><br><span class="hljs-string">prompt=db01 [\\d]&gt;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>slave1(db02)：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh">cat &gt; /etc/my.cnf &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">[mysqld]</span><br><span class="hljs-string">basedir=/application/mysql</span><br><span class="hljs-string">datadir=/data/mysql/data</span><br><span class="hljs-string">socket=/tmp/mysql.sock</span><br><span class="hljs-string">server_id=52</span><br><span class="hljs-string">port=3306</span><br><span class="hljs-string">secure-file-priv=/tmp</span><br><span class="hljs-string">autocommit=0</span><br><span class="hljs-string">log_bin=/data/binlog/mysql-bin</span><br><span class="hljs-string">binlog_format=row</span><br><span class="hljs-string">gtid-mode=on</span><br><span class="hljs-string">enforce-gtid-consistency=true</span><br><span class="hljs-string">log-slave-updates=1</span><br><span class="hljs-string">[mysql]</span><br><span class="hljs-string">prompt=db02 [\\d]&gt;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>slave2(db03)：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh">cat &gt; /etc/my.cnf &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">[mysqld]</span><br><span class="hljs-string">basedir=/application/mysql</span><br><span class="hljs-string">datadir=/data/mysql/data</span><br><span class="hljs-string">socket=/tmp/mysql.sock</span><br><span class="hljs-string">server_id=53</span><br><span class="hljs-string">port=3306</span><br><span class="hljs-string">secure-file-priv=/tmp</span><br><span class="hljs-string">autocommit=0</span><br><span class="hljs-string">log_bin=/data/binlog/mysql-bin</span><br><span class="hljs-string">binlog_format=row</span><br><span class="hljs-string">gtid-mode=on</span><br><span class="hljs-string">enforce-gtid-consistency=true</span><br><span class="hljs-string">log-slave-updates=1</span><br><span class="hljs-string">[mysql]</span><br><span class="hljs-string">prompt=db03 [\\d]&gt;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>初始化数据</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysqld --initialize-insecure --user=mysql --basedir=/application/mysql --datadir=/data/mysql/data <br><br>注意：（这样是初始化成功）<br><br>[root@db01 ~]<span class="hljs-comment">#mysqld --initialize-insecure --user=mysql --basedir=/application/mysql --datadir=/data/mysql/data </span><br>2020-09-18T01:32:18.993792Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation <span class="hljs-keyword">for</span> more details).<br>2020-09-18T01:32:19.159059Z 0 [Warning] InnoDB: New <span class="hljs-built_in">log</span> files created, LSN=45790<br>2020-09-18T01:32:19.198829Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.<br>2020-09-18T01:32:19.294281Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: cac5b9ed-f94e-11ea-bbec-000c2936c152.<br>2020-09-18T01:32:19.309520Z 0 [Warning] Gtid table is not ready to be used. Table <span class="hljs-string">&#x27;mysql.gtid_executed&#x27;</span> cannot be opened.<br>2020-09-18T01:32:19.311034Z 1 [Warning] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>启动数据库</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/etc/init.d/mysqld start<br></code></pre></td></tr></table></figure>

<ol start="5">
<li>主库（51）新建主从复制管理用户</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">grant replication slave on *.* to repl@&#x27;192.168.27.%&#x27; identified by &#x27;123&#x27;;<br></code></pre></td></tr></table></figure>

<ol start="5">
<li>构建主从：</li>
</ol>
<p>主库：51</p>
<p>从库:52,53</p>
<p>主库51:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">show master status\G; #在倒数第二行里会看到 类似这样的<br>......<br>Executed_Gtid_Set: f9fa4509-3566-11eb-b233-000c29fd94d4:-2<br></code></pre></td></tr></table></figure>

<p>从库52\53:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">change master to <br>master_host=&#x27;192.168.27.11&#x27;,<br>master_user=&#x27;repl&#x27;,<br>master_password=&#x27;123&#x27;,<br>MASTER_AUTO_POSITION=1;	<br>start slave;<br></code></pre></td></tr></table></figure>

<p>解释：</p>
<p><font color='red'>MASTER_AUTO_POSITION=1;（自动进行position的应用，会读取relaylog最后一个事务的GTID，工作中要清除从哪个GTID号码开始复制） </font></p>
<h3 id="15-8-4-GTID-复制和普通复制的区别"><a href="#15-8-4-GTID-复制和普通复制的区别" class="headerlink" title="15.8.4 GTID 复制和普通复制的区别"></a>15.8.4 GTID 复制和普通复制的区别</h3><p>非gtid</p>
<p>MASTER_LOG_FILE=’mysql-bin.000001’,</p>
<p>MASTER_LOG_POS=154,</p>
<p>gtid</p>
<p>MASTER_AUTO_POSITION=1;    </p>
<ol>
<li><p>在主从复制环境中，主库发生过的事务，在全局都是由唯一GTID记录的，更方便Failover</p>
</li>
<li><p>额外功能参数（3个）</p>
</li>
<li><p>change master to 的时候不再需要binlog 文件名和position号,MASTER_AUTO_POSITION=1;</p>
</li>
<li><p>在复制过程中，从库不再依赖master.info文件，而是直接读取最后一个relaylog的 GTID号</p>
</li>
<li><p>mysqldump备份时，默认会将备份中包含的事务操作，以以下方式</p>
</li>
</ol>
<p>  #### SET @@GLOBAL.GTID_PURGED=’8c49d7ec-7e78-11e8-9638-000c29ca725d:1-11’;</p>
<p>  告诉从库，我的备份中已经有以上事务，你就不用运行了，直接从下一个GTID开始请求binlog就行。（总之就是不写–set-gtid-purged=off这个参数）</p>
<ol start="6">
<li>使用show slave status\G;时在“Retrieved_Gtid_Set:” “Executed_Gtid_Set: “ 会出现主库的GTID数和事务数</li>
</ol>
<h2 id="15-9-半同步-（用到极少，性能极差）"><a href="#15-9-半同步-（用到极少，性能极差）" class="headerlink" title="15.9 半同步   ***    （用到极少，性能极差）"></a>15.9 半同步   ***    （用到极少，性能极差）</h2><p>解决主从复制数据一致性问题.</p>
<p>ACK ,从库relay落地,IO线程会返回一个ACK,主库的 ACK_reciver .主库事务才能提交.如果一直ACK没收到,超过10秒钟会切换为异步复制.</p>
<h1 id="十六、MHA高可用"><a href="#十六、MHA高可用" class="headerlink" title="十六、MHA高可用"></a>十六、MHA高可用</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34336526/article/details/93610235">https://blog.csdn.net/weixin_34336526/article/details/93610235</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/clsn/p/8150688.html#auto-id-40">https://www.cnblogs.com/clsn/p/8150688.html#auto-id-40</a></p>
<h2 id="16-1-搭建MHA"><a href="#16-1-搭建MHA" class="headerlink" title="16.1 搭建MHA"></a>16.1 搭建MHA</h2><h3 id="16-1-1-规划"><a href="#16-1-1-规划" class="headerlink" title="16.1.1 规划"></a>16.1.1 规划</h3><table>
<thead>
<tr>
<th>机器名称</th>
<th>IP配置</th>
<th>服务角色</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>db01</td>
<td>192.168.27.11</td>
<td>数据库主服务器</td>
<td></td>
</tr>
<tr>
<td>db02</td>
<td>192.168.27.12</td>
<td>数据库从服务器</td>
<td></td>
</tr>
<tr>
<td>db03</td>
<td>192.168.27.13</td>
<td>数据库从服务器，Manager控制器</td>
<td></td>
</tr>
</tbody></table>
<h3 id="16-1-2-搭建环境（1主2从GTID，详细看上面）"><a href="#16-1-2-搭建环境（1主2从GTID，详细看上面）" class="headerlink" title="16.1.2 搭建环境（1主2从GTID，详细看上面）"></a>16.1.2 搭建环境（1主2从GTID，详细看上面）</h3><h3 id="16-1-3-配置关键程序软连接（所有节点）"><a href="#16-1-3-配置关键程序软连接（所有节点）" class="headerlink" title="16.1.3 配置关键程序软连接（所有节点）"></a>16.1.3 配置关键程序软连接（所有节点）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">ln -s /application/mysql/bin/mysqlbinlog  /usr/bin/mysqlbinlog<br>ln -s /application/mysql/bin/mysql /usr/bin/mysql<br></code></pre></td></tr></table></figure>

<h3 id="16-1-4-配置互信"><a href="#16-1-4-配置互信" class="headerlink" title="16.1.4 配置互信"></a>16.1.4 配置互信</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">db01：<br>rm -rf /root/.ssh <br>ssh-keygen<br><span class="hljs-built_in">cd</span> /root/.ssh <br>mv id_rsa.pub authorized_keys<br>scp -r /root/.ssh 192.168.27.12:/root <br>scp -r /root/.ssh 192.168.27.13:/root <br></code></pre></td></tr></table></figure>

<p>各节点验证</p>
<p>注意：</p>
<p>第一次执行：每条命令分别执行，不要一次全部执行，都执行过一次</p>
<p>第二次执行：全部节点都在执行一次，可以一次性全部复制</p>
<p>结果都显示一样的证明验证成功</p>
<p>db01:</p>
<p>ssh 192.168.27.11 date</p>
<p>ssh 192.168.27.12 date</p>
<p>ssh 192.168.27.13 date</p>
<p>db02:</p>
<p>ssh 192.168.27.11 date</p>
<p>ssh 192.168.27.12 date</p>
<p>ssh 192.168.27.13 date</p>
<p>db03:</p>
<p>ssh 192.168.27.11 date</p>
<p>ssh 192.168.27.12 date</p>
<p>ssh 192.168.27.13 date</p>
<h3 id="16-1-5-下载MHA"><a href="#16-1-5-下载MHA" class="headerlink" title="16.1.5 下载MHA"></a>16.1.5 下载MHA</h3><p>mha官网：<a target="_blank" rel="noopener" href="https://code.google.com/archive/p/mysql-master-ha/">https://code.google.com/archive/p/mysql-master-ha/</a> </p>
<p>github下载地址：<a target="_blank" rel="noopener" href="https://github.com/yoshinorim/mha4mysql-manager/wiki/Downloads">https://github.com/yoshinorim/mha4mysql-manager/wiki/Downloads</a> 解压：unzip MHA…..zip</p>
<h3 id="16-1-6安装软件包（所有节点）"><a href="#16-1-6安装软件包（所有节点）" class="headerlink" title="16.1.6安装软件包（所有节点）"></a>16.1.6安装软件包（所有节点）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install perl-DBD-MySQL -y<br>rpm -ivh mha4mysql-node-0.56-0.el6.noarch.rpm<br></code></pre></td></tr></table></figure>

<h3 id="16-1-7-在db01主库中创建mha需要的用户"><a href="#16-1-7-在db01主库中创建mha需要的用户" class="headerlink" title="16.1.7 在db01主库中创建mha需要的用户"></a>16.1.7 在db01主库中创建mha需要的用户</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">grant all privileges on *.* to mha@&#x27;192.168.27.%&#x27; identified by &#x27;mha&#x27;;<br></code></pre></td></tr></table></figure>

<h3 id="16-1-8-Manager软件安装（db03）（这里的源都改成阿里云的源）"><a href="#16-1-8-Manager软件安装（db03）（这里的源都改成阿里云的源）" class="headerlink" title="16.1.8 Manager软件安装（db03）（这里的源都改成阿里云的源）"></a>16.1.8 Manager软件安装（db03）（这里的源都改成阿里云的源）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install -y perl-Config-Tiny epel-release perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes<br>rpm -ivh mha4mysql-manager-0.56-0.el6.noarch.rpm<br></code></pre></td></tr></table></figure>

<p><font color="blue">Manager为什么要装在从节点：需要选择业务量少的节点，尽量使用最后一个节点</font></p>
<h3 id="16-1-9-配置文件准备-db03"><a href="#16-1-9-配置文件准备-db03" class="headerlink" title="16.1.9 配置文件准备(db03)"></a>16.1.9 配置文件准备(db03)</h3><h4 id="16-1-9-1-创建配置文件目录"><a href="#16-1-9-1-创建配置文件目录" class="headerlink" title="16.1.9.1 创建配置文件目录"></a>16.1.9.1 创建配置文件目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mkdir -p /etc/mha<br></code></pre></td></tr></table></figure>

<h4 id="16-1-9-2-创建日志目录"><a href="#16-1-9-2-创建日志目录" class="headerlink" title="16.1.9.2 创建日志目录"></a>16.1.9.2 创建日志目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mkdir -p /var/<span class="hljs-built_in">log</span>/mha/app1<br></code></pre></td></tr></table></figure>

<h4 id="16-1-9-3-编辑mha配置文件"><a href="#16-1-9-3-编辑mha配置文件" class="headerlink" title="16.1.9.3 编辑mha配置文件"></a>16.1.9.3 编辑mha配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh">cat &gt; /etc/mha/app1.cnf &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">[server default]</span><br><span class="hljs-string">manager_log=/var/log/mha/app1/manager    </span><br><span class="hljs-string">manager_workdir=/var/log/mha/app1      </span><br><span class="hljs-string">master_binlog_dir=/data/binlog    </span><br><span class="hljs-string">user=mha                  </span><br><span class="hljs-string">password=mha              </span><br><span class="hljs-string">ping_interval=2</span><br><span class="hljs-string">repl_password=123</span><br><span class="hljs-string">repl_user=repl</span><br><span class="hljs-string">ssh_user=root</span><br><span class="hljs-string">[server1]</span><br><span class="hljs-string">hostname=192.168.27.11</span><br><span class="hljs-string">port=3306</span><br><span class="hljs-string">[server2]</span><br><span class="hljs-string">hostname=192.168.27.12</span><br><span class="hljs-string">port=3306</span><br><span class="hljs-string">[server3]</span><br><span class="hljs-string">hostname=192.168.27.13</span><br><span class="hljs-string">port=3306</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h3 id="16-1-10-状态检查-db03"><a href="#16-1-10-状态检查-db03" class="headerlink" title="16.1.10 状态检查(db03)"></a>16.1.10 状态检查(db03)</h3><p>互信检查：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db03 ~]<span class="hljs-comment"># masterha_check_ssh  --conf=/etc/mha/app1.cnf </span><br>Wed Dec  9 10:52:32 2020 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.<br>Wed Dec  9 10:52:32 2020 - [info] Reading application default configuration from /etc/mha/app1.cnf..<br>Wed Dec  9 10:52:32 2020 - [info] Reading server configuration from /etc/mha/app1.cnf..<br>Wed Dec  9 10:52:32 2020 - [info] Starting SSH connection tests..<br>Wed Dec  9 10:52:33 2020 - [debug] <br>Wed Dec  9 10:52:32 2020 - [debug]  Connecting via SSH from root@192.168.27.11(192.168.27.11:22) to root@192.168.27.12(192.168.27.12:22)..<br>Wed Dec  9 10:52:32 2020 - [debug]   ok.<br>Wed Dec  9 10:52:32 2020 - [debug]  Connecting via SSH from root@192.168.27.11(192.168.27.11:22) to root@192.168.27.13(192.168.27.13:22)..<br>Wed Dec  9 10:52:33 2020 - [debug]   ok.<br>Wed Dec  9 10:52:33 2020 - [debug] <br>Wed Dec  9 10:52:32 2020 - [debug]  Connecting via SSH from root@192.168.27.12(192.168.27.12:22) to root@192.168.27.11(192.168.27.11:22)..<br>Wed Dec  9 10:52:33 2020 - [debug]   ok.<br>Wed Dec  9 10:52:33 2020 - [debug]  Connecting via SSH from root@192.168.27.12(192.168.27.12:22) to root@192.168.27.13(192.168.27.13:22)..<br>Wed Dec  9 10:52:33 2020 - [debug]   ok.<br>Wed Dec  9 10:52:34 2020 - [debug] <br>Wed Dec  9 10:52:33 2020 - [debug]  Connecting via SSH from root@192.168.27.13(192.168.27.13:22) to root@192.168.27.11(192.168.27.11:22)..<br>Wed Dec  9 10:52:33 2020 - [debug]   ok.<br>Wed Dec  9 10:52:33 2020 - [debug]  Connecting via SSH from root@192.168.27.13(192.168.27.13:22) to root@192.168.27.12(192.168.27.12:22)..<br>Wed Dec  9 10:52:34 2020 - [debug]   ok.<br>Wed Dec  9 10:52:34 2020 - [info] All SSH connection tests passed successfully.<br></code></pre></td></tr></table></figure>

<p>主从状态检查</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs sh">（注意：必须把selinux和防火墙关闭，同时保证存在主从复制）<br>[root@db03 ~]<span class="hljs-comment"># masterha_check_repl  --conf=/etc/mha/app1.cnf </span><br>Wed Dec  9 10:56:18 2020 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.<br>Wed Dec  9 10:56:18 2020 - [info] Reading application default configuration from /etc/mha/app1.cnf..<br>Wed Dec  9 10:56:18 2020 - [info] Reading server configuration from /etc/mha/app1.cnf..<br>Wed Dec  9 10:56:18 2020 - [info] MHA::MasterMonitor version 0.56.<br>Wed Dec  9 10:56:19 2020 - [info] GTID failover mode = 1<br>Wed Dec  9 10:56:19 2020 - [info] Dead Servers:<br>Wed Dec  9 10:56:19 2020 - [info] Alive Servers:<br>Wed Dec  9 10:56:19 2020 - [info]   192.168.27.11(192.168.27.11:3306)<br>Wed Dec  9 10:56:19 2020 - [info]   192.168.27.12(192.168.27.12:3306)<br>Wed Dec  9 10:56:19 2020 - [info]   192.168.27.13(192.168.27.13:3306)<br>Wed Dec  9 10:56:19 2020 - [info] Alive Slaves:<br>Wed Dec  9 10:56:19 2020 - [info]   192.168.27.12(192.168.27.12:3306)  Version=5.7.26-log (oldest major version between slaves) log-bin:enabled<br>Wed Dec  9 10:56:19 2020 - [info]     GTID ON<br>Wed Dec  9 10:56:19 2020 - [info]     Replicating from 192.168.27.11(192.168.27.11:3306)<br>Wed Dec  9 10:56:19 2020 - [info]   192.168.27.13(192.168.27.13:3306)  Version=5.7.26-log (oldest major version between slaves) log-bin:enabled<br>Wed Dec  9 10:56:19 2020 - [info]     GTID ON<br>Wed Dec  9 10:56:19 2020 - [info]     Replicating from 192.168.27.11(192.168.27.11:3306)<br>Wed Dec  9 10:56:19 2020 - [info] Current Alive Master: 192.168.27.11(192.168.27.11:3306)<br>Wed Dec  9 10:56:19 2020 - [info] Checking slave configurations..<br>Wed Dec  9 10:56:19 2020 - [info]  read_only=1 is not <span class="hljs-built_in">set</span> on slave 192.168.27.12(192.168.27.12:3306).<br>Wed Dec  9 10:56:19 2020 - [info]  read_only=1 is not <span class="hljs-built_in">set</span> on slave 192.168.27.13(192.168.27.13:3306).<br>Wed Dec  9 10:56:19 2020 - [info] Checking replication filtering settings..<br>Wed Dec  9 10:56:19 2020 - [info]  binlog_do_db= , binlog_ignore_db= <br>Wed Dec  9 10:56:19 2020 - [info]  Replication filtering check ok.<br>Wed Dec  9 10:56:19 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.<br>Wed Dec  9 10:56:19 2020 - [info] Checking SSH publickey authentication settings on the current master..<br>Wed Dec  9 10:56:19 2020 - [info] HealthCheck: SSH to 192.168.27.11 is reachable.<br>Wed Dec  9 10:56:19 2020 - [info] <br>192.168.27.11(192.168.27.11:3306) (current master)<br> +--192.168.27.12(192.168.27.12:3306)<br> +--192.168.27.13(192.168.27.13:3306)<br>Wed Dec  9 10:56:19 2020 - [info] Checking replication health on 192.168.27.12..<br>Wed Dec  9 10:56:19 2020 - [info]  ok.<br>Wed Dec  9 10:56:19 2020 - [info] Checking replication health on 192.168.27.13..<br>Wed Dec  9 10:56:19 2020 - [info]  ok.<br>Wed Dec  9 10:56:19 2020 - [warning] master_ip_failover_script is not defined.<br>Wed Dec  9 10:56:19 2020 - [warning] shutdown_script is not defined.<br>Wed Dec  9 10:56:19 2020 - [info] Got <span class="hljs-built_in">exit</span> code 0 (Not master dead).<br>MySQL Replication Health is OK.<br></code></pre></td></tr></table></figure>

<h3 id="16-1-11-开启MHA-db03-："><a href="#16-1-11-开启MHA-db03-：" class="headerlink" title="16.1.11 开启MHA(db03)："></a>16.1.11 开启MHA(db03)：</h3><p>nohup masterha_manager –conf=/etc/mha/app1.cnf –remove_dead_master_conf –ignore_last_failover &lt; /dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db03 ~]<span class="hljs-comment"># nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span><br>[1] 17222<br>--remove_dead_master_conf：会自动删除故障节点<br>--ignore_last_failover：忽略最后一次切换<br></code></pre></td></tr></table></figure>

<h3 id="16-1-12-查看MHA状态"><a href="#16-1-12-查看MHA状态" class="headerlink" title="16.1.12 查看MHA状态"></a>16.1.12 查看MHA状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db03 ~]<span class="hljs-comment"># masterha_check_status --conf=/etc/mha/app1.cnf</span><br>app1 (pid:17222) is running(0:PING_OK), master:192.168.27.11<br>（下面操作在任意一台主机上都可以）<br>[root@db03 ~]<span class="hljs-comment"># mysql -umha -pmha -h 192.168.27.13 -e &quot;show variables like &#x27;server_id&#x27;&quot;</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| server_id     | 53    |<br>+---------------+-------+<br>[root@db03 ~]<span class="hljs-comment"># mysql -umha -pmha -h 192.168.27.12 -e &quot;show variables like &#x27;server_id&#x27;&quot;</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| server_id     | 52    |<br>+---------------+-------+<br>[root@db03 ~]<span class="hljs-comment"># mysql -umha -pmha -h 192.168.27.11 -e &quot;show variables like &#x27;server_id&#x27;&quot;</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| server_id     | 51    |<br>+---------------+-------+<br></code></pre></td></tr></table></figure>

<h2 id="16-2-MHA-架构软件结构说明"><a href="#16-2-MHA-架构软件结构说明" class="headerlink" title="16.2 MHA 架构软件结构说明"></a>16.2 MHA 架构软件结构说明</h2><h3 id="16-2-1-MAH架构工作原理"><a href="#16-2-1-MAH架构工作原理" class="headerlink" title="16.2.1 MAH架构工作原理"></a>16.2.1 MAH架构工作原理</h3><p>主库宕机处理过程 </p>
<h4 id="16-2-1-1-监控节点-通过配置文件获取所有节点信息"><a href="#16-2-1-1-监控节点-通过配置文件获取所有节点信息" class="headerlink" title="16.2.1.1 监控节点 (通过配置文件获取所有节点信息)"></a>16.2.1.1 监控节点 (通过配置文件获取所有节点信息)</h4><p>系统,网络,SSH连接性  </p>
<p>主从状态,重点是主库 </p>
<h4 id="16-2-1-2-选主"><a href="#16-2-1-2-选主" class="headerlink" title="16.2.1.2 选主"></a>16.2.1.2 选主</h4><ol>
<li>如果判断从库(position或者GTID),数据有差异,最接近于Master的slave,成为备选主</li>
<li>如果判断从库(position或者GTID),数据一致,按照配置文件顺序,选主. </li>
<li>如果设定有权重(candidate_master=1),按照权重强制指定备选主.   <ul>
<li>默认情况下如果一个slave落后master 100M的relay logs的话，即使有权重,也会失效.   </li>
<li>如果check_repl_delay=0的化,即使落后很多日志,也强制选择其为备选主 </li>
</ul>
</li>
</ol>
<h4 id="16-2-1-3-数据补偿"><a href="#16-2-1-3-数据补偿" class="headerlink" title="16.2.1.3 数据补偿"></a>16.2.1.3 数据补偿</h4><ol>
<li>当SSH能连接,从库对比主库GTID 或者position号,立即将二进制日志保存至各个从节点并且应用(save_binary_logs ) </li>
<li>当SSH不能连接, 对比从库之间的relaylog的差异(apply_diff_relay_logs) </li>
</ol>
<h4 id="16-2-1-4-Failover"><a href="#16-2-1-4-Failover" class="headerlink" title="16.2.1.4 Failover"></a>16.2.1.4 Failover</h4><p>将备选主进行身份切换,对外提供服务<br>其余从库和新主库确认新的主从关系 </p>
<h4 id="16-2-1-5-应用透明-VIP"><a href="#16-2-1-5-应用透明-VIP" class="headerlink" title="16.2.1.5 应用透明(VIP)"></a>16.2.1.5 应用透明(VIP)</h4><h4 id="16-2-1-6-故障切换通知-send-reprt"><a href="#16-2-1-6-故障切换通知-send-reprt" class="headerlink" title="16.2.1.6 故障切换通知(send_reprt)"></a>16.2.1.6 故障切换通知(send_reprt)</h4><h4 id="16-2-1-7-二次数据补偿-binlog-server"><a href="#16-2-1-7-二次数据补偿-binlog-server" class="headerlink" title="16.2.1.7 二次数据补偿(binlog_server)"></a>16.2.1.7 二次数据补偿(binlog_server)</h4><h4 id="16-2-1-8-自愈自治-待开发…"><a href="#16-2-1-8-自愈自治-待开发…" class="headerlink" title="16.2.1.8 自愈自治(待开发…)"></a>16.2.1.8 自愈自治(待开发…)</h4><h3 id="16-2-2节点规划"><a href="#16-2-2节点规划" class="headerlink" title="16.2.2节点规划"></a>16.2.2节点规划</h3><p>1主2从，master：db01  slave：db02  db03 </p>
<p>MHA 高可用方案软件构成 </p>
<p>Manager软件：选择一个从节点安装（db03） </p>
<p>Node软件：所有节点都要安装</p>
<p><strong>1主2从,独立数据库实例</strong></p>
<p>" srcset="/blog/img/loading.gif<img src="">  </p>
<h3 id="16-2-2-MHA软件的构成-perl语言"><a href="#16-2-2-MHA软件的构成-perl语言" class="headerlink" title="16.2.2 MHA软件的构成(perl语言)"></a>16.2.2 MHA软件的构成(perl语言)</h3><p><strong>Manager工具包主要包括以下几个工具：</strong></p>
<p>mha4mysql-manager-0.56-0.el6.noarch.rpm</p>
<p><strong>Manager工具命令：</strong></p>
<p>masterha_manger       启动MHA </p>
<p>masterha_check_ssh       检查MHA的SSH配置状况 </p>
<p>masterha_check_repl     检查MySQL复制状况 </p>
<p>masterha_master_monitor   检测master是否宕机 </p>
<p>masterha_check_status    检测当前MHA运行状态 </p>
<p>masterha_master_switch     控制故障转移（自动或者手动）</p>
<p>masterha_conf_host       添加或删除配置的server信息</p>
<p><strong>Node工具包主要包括以下几个工具：</strong></p>
<p>mha4mysql-node-0.56-0.el6.noarch.rpm</p>
<p>这些工具通常由MHA Manager的脚本触发，无需人为操作</p>
<p>save_binary_logs      保存和复制master的二进制日志 </p>
<p>apply_diff_relay_logs    识别差异的中继日志事件并将其差异的事件应用于其他的</p>
<p>purge_relay_logs      清除中继日志（不会阻塞SQL线程） </p>
<h2 id="16-3-MHA-FailOver过程详解"><a href="#16-3-MHA-FailOver过程详解" class="headerlink" title="16.3 MHA FailOver过程详解"></a>16.3 MHA FailOver过程详解</h2><h3 id="16-3-1-什么是Failover"><a href="#16-3-1-什么是Failover" class="headerlink" title="16.3.1 什么是Failover?"></a>16.3.1 什么是Failover?</h3><p>故障转移.</p>
<p>主库宕机一直到业务恢复正常的处理过程(自动)</p>
<h3 id="16-3-2-Failover让你实现怎么做"><a href="#16-3-2-Failover让你实现怎么做" class="headerlink" title="16.3.2 Failover让你实现怎么做?"></a>16.3.2 Failover让你实现怎么做?</h3><ol>
<li>快速监控到主库宕机</li>
<li>选择新主</li>
<li>数据补偿</li>
<li>解除从库身份</li>
<li>剩余从库和新主库构建主从关系</li>
<li>应用透明</li>
<li>故障节点自愈(待开发…)</li>
<li>故障提醒 </li>
</ol>
<h3 id="16-3-3-MHA的Failover如何实现"><a href="#16-3-3-MHA的Failover如何实现" class="headerlink" title="16.3.3 MHA的Failover如何实现?"></a>16.3.3 MHA的Failover如何实现?</h3><p>从启动—&gt;故障—&gt;转移—&gt;业务恢复</p>
<ol>
<li><p>MHA通过masterha_manger脚本启动MHA的功能.</p>
</li>
<li><p>在manager启动之前,会自动检查ssh互信(masterha_check_ssh)和主从状态(masterha_check_repl)</p>
</li>
<li><p>MHA-manager 通过 masterha_master_monitor脚本(每隔ping_interval秒)</p>
</li>
<li><p>masterha_master_monitor探测主库3次无心跳之后,就认为主库宕机了.</p>
</li>
<li><p>进行选主过程</p>
</li>
</ol>
<ul>
<li>算法一: </li>
</ul>
<p>读取配置文件中是否有强制选主的参数?</p>
<p>candidate_master=1</p>
<p>（设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中事件最新的slave）</p>
<p>check_repl_delay=0</p>
<p>（默认情况下如果一个slave落后master 100M的relay logs的话， MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=0,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master）</p>
<ul>
<li>算法二:</li>
</ul>
<p>自动判断所有从库的日志量.将最接近主库数据的从库作为新主.</p>
<ul>
<li>算法三:</li>
</ul>
<p>按照配置文件先后顺序的进行选新主.</p>
<blockquote>
<p><strong>扩展一下:</strong></p>
<p>candidate_master=1 应用场景?</p>
<p>(1) MHA+KeepAlive VIP(早期MHA架构)</p>
<p>(2) 多地多中心</p>
</blockquote>
<ol start="6">
<li>数据补偿 （使用GTID会缩短数据补偿的时间）</li>
</ol>
<p><strong>判断主库SSH的连通性</strong></p>
<p>情况一: SSH能连</p>
<p>调用 save_binary_logs脚本,立即保存缺失部分的binlog到各个从节点,恢复</p>
<p>情况二: SSH无法连接</p>
<p>调用 apply_diff_relay_logs 脚本,计算从库的relaylog的差异,恢复到2号从库</p>
<p>   6.1 提供额外的数据补偿的功能 @@</p>
<ol start="7">
<li><p>解除从库身份</p>
</li>
<li><p>剩余从库和新主库构建主从关系</p>
</li>
<li><p>应用透明 @@</p>
</li>
<li><p>故障节点自愈(待开发…)@@</p>
</li>
<li><p>故障提醒@@ </p>
</li>
</ol>
<h2 id="16-4-MHA-应用透明-vip"><a href="#16-4-MHA-应用透明-vip" class="headerlink" title="16.4 MHA 应用透明(vip)"></a>16.4 MHA 应用透明(vip)</h2><p>db03:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">cp /root/master_ip_failover.txt /usr/<span class="hljs-built_in">local</span>/bin/master_ip_failover<br>vim /usr/<span class="hljs-built_in">local</span>/bin/master_ip_failover<br>my <span class="hljs-variable">$vip</span> = <span class="hljs-string">&#x27;192.168.27.14/24&#x27;</span>;（设定VIP地址，对外提供服务的地址，选一个没有被使用的地址）<br>my <span class="hljs-variable">$key</span> = <span class="hljs-string">&#x27;1&#x27;</span>;<br>my <span class="hljs-variable">$ssh_start_vip</span> = <span class="hljs-string">&quot;/sbin/ifconfig eth0:<span class="hljs-variable">$key</span> <span class="hljs-variable">$vip</span>&quot;</span>;<br>my <span class="hljs-variable">$ssh_stop_vip</span> = <span class="hljs-string">&quot;/sbin/ifconfig eth0:<span class="hljs-variable">$key</span> down&quot;</span>;<br><br>yum install -y dos2unix<br>dos2unix /usr/<span class="hljs-built_in">local</span>/bin/master_ip_failover<br>chmod +x /usr/<span class="hljs-built_in">local</span>/bin/master_ip_failover <br><br>vim /etc/mha/app1.cnf <br>master_ip_failover_script=/usr/<span class="hljs-built_in">local</span>/bin/master_ip_failover<br></code></pre></td></tr></table></figure>

<p> db01:手工添加vip</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db01 ~]<span class="hljs-comment"># ifconfig eth0:1 192.168.27.14/24</span><br></code></pre></td></tr></table></figure>

<p>db03 : 重启MHA</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db03 bin]<span class="hljs-comment"># masterha_stop --conf=/etc/mha/app1.cnf</span><br>[root@db03 bin]<span class="hljs-comment"># nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span><br>[root@db03 bin]<span class="hljs-comment"># masterha_check_status --conf=/etc/mha/app1.cnf</span><br>app1 (pid:14410) is running(0:PING_OK), master:192.168.27.11<br></code></pre></td></tr></table></figure>

<h2 id="16-5-MHA-故障提醒"><a href="#16-5-MHA-故障提醒" class="headerlink" title="16.5 MHA 故障提醒"></a>16.5 MHA 故障提醒</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ll </span><br>email_2019-最新.zip<br><span class="hljs-comment"># unzip email_2019-最新.zip</span><br><span class="hljs-comment"># cp -a email/* /usr/local/bin/</span><br><span class="hljs-comment"># cd /usr/local/bin/</span><br><span class="hljs-comment"># chmod +x *</span><br><br>]<span class="hljs-comment"># vim /etc/mha/app1.cnf </span><br>report_script=/usr/<span class="hljs-built_in">local</span>/bin/send<br></code></pre></td></tr></table></figure>

<p>注意：</p>
<p>（1）这里要先测试testpl文件</p>
<p>（2）测试时修改文件内容，包括发邮件的邮箱和收邮件的邮箱</p>
<p>（3）收邮件的邮箱要在邮箱里设置smtp</p>
<p>（4）从/tmp/sendmail.log能看到日志</p>
<p>重启MHA:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db03 bin]<span class="hljs-comment"># masterha_stop --conf=/etc/mha/app1.cnf</span><br>[root@db03 bin]<span class="hljs-comment"># nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span><br>[root@db03 bin]<span class="hljs-comment"># masterha_check_status --conf=/etc/mha/app1.cnf</span><br></code></pre></td></tr></table></figure>

<h2 id="16-7-额外的数据补偿-binlog-server"><a href="#16-7-额外的数据补偿-binlog-server" class="headerlink" title="16.7 额外的数据补偿(binlog_server)"></a>16.7 额外的数据补偿(binlog_server)</h2><ol>
<li>找一台额外的机器，必须要有5.6以上的版本，支持gtid并开启，我们直接用的第二个slave（db03）</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/mha/app1.cnf <br>[binlog1]<br>no_master=1<br>hostname=192.168.27.13<br>master_binlog_dir=/data/mysql/binlog<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>创建必要目录</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mkdir -p /data/mysql/binlog<br>chown -R mysql.mysql /data/*<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>拉取主库binlog日志</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /data/mysql/binlog <span class="hljs-comment">#必须进入到自己创建好的目录</span><br>mysqlbinlog -R --host=192.168.27.11 --user=mha --password=mha --raw --stop-never mysql-bin.000001 &amp;<br></code></pre></td></tr></table></figure>

<p>注意：</p>
<p>拉取日志的起点,需要按照目前主库正在使用的binlog为起点（在主库使用show master status\G;查看） </p>
<ol start="4">
<li>重启MHA-manager </li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@db03 bin]<span class="hljs-comment"># masterha_stop --conf=/etc/mha/app1.cnf</span><br>[root@db03 bin]<span class="hljs-comment"># nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span><br>[root@db03 binlog]<span class="hljs-comment">#masterha_check_status --conf=/etc/mha/app1.cnf</span><br></code></pre></td></tr></table></figure>





<p>16.8 故障模拟及故障处理</p>
<p>16.8.1 宕掉 db01 数据库</p>
<p>[root@db01 ~]# /etc/init.d/mysqld stop</p>
<p>16.2 恢复故障</p>
<p>（1） 检查各个节点是否启动，并修复故障节点（修复故障节点）</p>
<p>[root@db01 ~]# /etc/init.d/mysqld start</p>
<p>（2） 恢复1主2从(db01)</p>
<p>[root@db03 bin]# grep “CHANGE MASTER TO” /var/log/mha/app1/manager</p>
<p>Thu Jul 18 18:31:54 2019 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=’10.0.0.52’, MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER=’repl’, MASTER_PASSWORD=’xxx’;</p>
<p>[root@db03 bin]# </p>
<p>db01 [(none)]&gt;CHANGE MASTER TO MASTER_HOST=’192.168.27.12’, MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER=’repl’, MASTER_PASSWORD=’123’;</p>
<p>db01 [(none)]&gt;start slave;</p>
<p>（3） 恢复配置文件(db03)产看文件中的节点</p>
<p>注意：如果节点已经被移除，说明切换过程大部分成功了</p>
<p>vim /etc/mha/app1.cnf</p>
<p>（不上缺少的server）</p>
<p>[server1]</p>
<p>hostname=192.168.27.11</p>
<p>port=3306</p>
<p>[server2]</p>
<p>hostname=192.168.27.12</p>
<p>port=3306</p>
<p>[server3]</p>
<p>hostname=192.168.27.13</p>
<p>port=3306</p>
<p>（4）看日志，记录错误</p>
<p>vim /var/log/mha/app1/manager</p>
<p>（5）检查vip</p>
<p>检查vip是否在主库,如果不在,手工调整到主库</p>
<p>（6）恢复binlogserver (db03)</p>
<p>cd /data/mysql/binlog  </p>
<p>rm -rf /data/mysql/binlog/*</p>
<p>mysqlbinlog -R –host=192.168.27.12 –user=mha –password=mha –raw –stop-never mysql-bin.000001 &amp;</p>
<p>修改完成后，将主库binlog拉过来（从000001开始拉，之后的binlog会自动按顺序过来）</p>
<p>（7）检查</p>
<p>masterha_check_ssh –conf=/etc/mha/app1.cnf </p>
<p>masterha_check_repl –conf=/etc/mha/app1.cnf </p>
<p>（8）检查主节点的vip的状态，如果不在，再手工生成</p>
<p>（9） 启动MHA (db03)</p>
<p>[root@db03 bin]# nohup masterha_manager –conf=/etc/mha/app1.cnf –remove_dead_master_conf –ignore_last_failover &lt; /dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</p>
<p>[1] 16543</p>
<p>[root@db03 bin]# masterha_check_status –conf=/etc/mha/app1.cnf</p>
<p>app1 (pid:16543) is running(0:PING_OK), master:192.168.27.12</p>
<p>16.8.3 MHA的故障排查</p>
<ol>
<li>检查脚本</li>
</ol>
<p>​    masterha_check_ssh –conf=/etc/mha/app1.cnf </p>
<p>​    masterha_check_repl –conf=/etc/mha/app1.cnf </p>
<p>​    1主2从复制环境 </p>
<p>(2) 配置文件 </p>
<p>​    节点地址,端口</p>
<p>​    vip 和send脚本指定位置和权限</p>
<p>(3) 软连接 </p>
<p>（4）查看/var/log/mha/app1/manager </p>
<p>脚本问题比较多一些</p>
<p>vip</p>
<p>send </p>
<p>binlog</p>
<p>16.9 MHA配合Atlas实现读写分离</p>
<p>16.9.1 Atlas 介绍</p>
<p>Atlas是由 Qihoo 360, Web平台部基础架构团队开发维护的一个基于MySQL协议的数据中间层项目。</p>
<p>它是在mysql-proxy 0.8.2版本的基础上，对其进行了优化，增加了一些新的功能特性。</p>
<p>360内部使用Atlas运行的mysql业务，每天承载的读写请求数达几十亿条。</p>
<p>下载地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Qihoo360/Atlas/releases">https://github.com/Qihoo360/Atlas/releases</a></p>
<p>注意：</p>
<p>1、Atlas只能安装运行在64位的系统上</p>
<p>2、Centos 5.X安装 Atlas-XX.el5.x86_64.rpm，Centos 6.X安装Atlas-XX.el6.x86_64.rpm。</p>
<p>3、后端mysql版本应大于5.1，建议使用Mysql 5.6以上</p>
<p>16.9.2.安装配置（db03）</p>
<p>yum install -y Atlas*</p>
<p>cd /usr/local/mysql-proxy/conf</p>
<p>mv test.cnf test.cnf.bak</p>
<p>vi test.cnf</p>
<p>[mysql-proxy]</p>
<p>admin-username = user</p>
<p>admin-password = pwd</p>
<p>proxy-backend-addresses = 192.168.27.14:3306    （MHA的vip地址）</p>
<p>proxy-read-only-backend-addresses = 192.168.27.12:3306,192.168.27.13:3306    （读数据的库，一边都是从库）</p>
<p>pwds = repl:3yb5jEku5h4=,mha:O2jBXONX098=    （这里的是生产业务要用的到的用户，必须在atlas声明和在数据库中创建，密码出处解答：<a target="_blank" rel="noopener" href="https://blog.csdn.net/wssg3620625/article/details/21243937%EF%BC%89">https://blog.csdn.net/wssg3620625/article/details/21243937）</a></p>
<p>daemon = true</p>
<p>keepalive = true</p>
<p>event-threads = 8</p>
<p>log-level = message</p>
<p>log-path = /usr/local/mysql-proxy/log</p>
<p>sql-log=ON</p>
<p>proxy-address = 0.0.0.0:33060</p>
<p>admin-address = 0.0.0.0:2345</p>
<p>charset=utf8</p>
<p>启动atlas</p>
<p>/usr/local/mysql-proxy/bin/mysql-proxyd test start</p>
<p>ps -ef |grep proxy</p>
<p>16.9.3. Atlas功能测试</p>
<p>测试读操作：</p>
<p>mysql -umha -pmha -h 192.168.27.13 -P 33060 </p>
<p>db03 [(none)]&gt;select @@server_id;</p>
<p>测试写操作：</p>
<p>mysql&gt; begin;select @@server_id;commit;</p>
<p>16.9.4. 生产用户要求</p>
<p>开发人员申请一个应用用户 app( select update insert) 密码123456,要通过10网段登录</p>
<p>16.9.4.1 在主库中,创建用户</p>
<p>grant select ,update,insert on <em>.</em> to app@’192.168.27.%’ identified by ‘123456’;</p>
<p>16.9.4.2. 在atlas中添加生产用户</p>
<p>/usr/local/mysql-proxy/bin/encrypt 123456   —-&gt;制作加密密码</p>
<p>vim /usr/local/mysql-proxy/conf/test.cnf</p>
<p>pwds = repl:3yb5jEku5h4=,mha:O2jBXONX098=,app:/iZxz+0GRoA=</p>
<p>/usr/local/mysql-proxy/bin/mysql-proxyd test restart</p>
<p>[root@db03 conf]# mysql -uapp -p123456 -h 192.168.27.13 -P 33060</p>
<p>16.9.5. Atlas基本管理</p>
<p>连接管理接口</p>
<p>mysql -uuser -ppwd -h127.0.0.1 -P2345</p>
<p>select * from help;    打印可执行命令</p>
<p>SELECT * FROM backends;    看所有的后端节点</p>
<p>set offline 2;    下线节点</p>
<p>set online 2;    上线节点</p>
<p>REMOVE BACKEND 3;    删除节点</p>
<p>ADD SLAVE 10.0.0.53:3306;    在线添加从节点</p>
<p>ADD PWD oldguo:123456;    添加用户（主库要先添加用户 如：grant select ,update,insert on <em>.</em> to oldguo@’192.168.27.%’ identified by ‘123456’;）</p>
<p>save config;    把修改保存到配置文件里</p>
<p>=============================================================================</p>
<p>十七、MySQL分布式解决方案</p>
<p>17.1 MyCAT基础架构准备</p>
<p>17.1.1 环境准备：</p>
<p>两台虚拟机 db01 db02</p>
<p>每台创建四个mysql实例：3307 3308 3309 3310</p>
<p>17.1.2 删除历史环境：</p>
<p>pkill mysqld</p>
<p>\rm -rf /data/330* </p>
<p>\mv /etc/my.cnf /etc/my.cnf.bak</p>
<p>17.1.3 创建相关目录初始化数据</p>
<p>mkdir /data/33{07..10}/data -p</p>
<p>mysqld –initialize-insecure –user=mysql –datadir=/data/3307/data –basedir=/application/mysql</p>
<p>mysqld –initialize-insecure –user=mysql –datadir=/data/3308/data –basedir=/application/mysql</p>
<p>mysqld –initialize-insecure –user=mysql –datadir=/data/3309/data –basedir=/application/mysql</p>
<p>mysqld –initialize-insecure –user=mysql –datadir=/data/3310/data –basedir=/application/mysql</p>
<p>17.1.4 准备DB01配置文件和启动脚本</p>
<p>cat &gt;/data/3307/my.cnf&lt;&lt;EOF</p>
<p>[mysqld]</p>
<p>basedir=/application/mysql</p>
<p>datadir=/data/3307/data</p>
<p>socket=/data/3307/mysql.sock</p>
<p>port=3307</p>
<p>log-error=/data/3307/mysql.log</p>
<p>log_bin=/data/3307/mysql-bin</p>
<p>binlog_format=row</p>
<p>skip-name-resolve</p>
<p>server-id=7</p>
<p>gtid-mode=on</p>
<p>enforce-gtid-consistency=true</p>
<p>log-slave-updates=1</p>
<p>EOF</p>
<p>cat &gt;/data/3308/my.cnf&lt;&lt;EOF</p>
<p>[mysqld]</p>
<p>basedir=/application/mysql</p>
<p>datadir=/data/3308/data</p>
<p>port=3308</p>
<p>socket=/data/3308/mysql.sock</p>
<p>log-error=/data/3308/mysql.log</p>
<p>log_bin=/data/3308/mysql-bin</p>
<p>binlog_format=row</p>
<p>skip-name-resolve</p>
<p>server-id=8</p>
<p>gtid-mode=on</p>
<p>enforce-gtid-consistency=true</p>
<p>log-slave-updates=1</p>
<p>EOF</p>
<p>cat &gt;/data/3309/my.cnf&lt;&lt;EOF</p>
<p>[mysqld]</p>
<p>basedir=/application/mysql</p>
<p>datadir=/data/3309/data</p>
<p>socket=/data/3309/mysql.sock</p>
<p>port=3309</p>
<p>log-error=/data/3309/mysql.log</p>
<p>log_bin=/data/3309/mysql-bin</p>
<p>binlog_format=row</p>
<p>skip-name-resolve</p>
<p>server-id=9</p>
<p>gtid-mode=on</p>
<p>enforce-gtid-consistency=true</p>
<p>log-slave-updates=1</p>
<p>EOF</p>
<p>cat &gt;/data/3310/my.cnf&lt;&lt;EOF</p>
<p>[mysqld]</p>
<p>basedir=/application/mysql</p>
<p>datadir=/data/3310/data</p>
<p>socket=/data/3310/mysql.sock</p>
<p>port=3310</p>
<p>log-error=/data/3310/mysql.log</p>
<p>log_bin=/data/3310/mysql-bin</p>
<p>binlog_format=row</p>
<p>skip-name-resolve</p>
<p>server-id=10</p>
<p>gtid-mode=on</p>
<p>enforce-gtid-consistency=true</p>
<p>log-slave-updates=1</p>
<p>EOF</p>
<p>cat &gt;/etc/systemd/system/mysqld3307.service&lt;&lt;EOF</p>
<p>[Unit]</p>
<p>Description=MySQL Server</p>
<p>Documentation=man:mysqld(8)</p>
<p>Documentation=<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/en/using-systemd.html">http://dev.mysql.com/doc/refman/en/using-systemd.html</a></p>
<p>After=network.target</p>
<p>After=syslog.target</p>
<p>[Install]</p>
<p>WantedBy=multi-user.target</p>
<p>[Service]</p>
<p>User=mysql</p>
<p>Group=mysql</p>
<p>ExecStart=/application/mysql/bin/mysqld –defaults-file=/data/3307/my.cnf</p>
<p>LimitNOFILE = 5000</p>
<p>EOF</p>
<p>cat &gt;/etc/systemd/system/mysqld3308.service&lt;&lt;EOF</p>
<p>[Unit]</p>
<p>Description=MySQL Server</p>
<p>Documentation=man:mysqld(8)</p>
<p>Documentation=<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/en/using-systemd.html">http://dev.mysql.com/doc/refman/en/using-systemd.html</a></p>
<p>After=network.target</p>
<p>After=syslog.target</p>
<p>[Install]</p>
<p>WantedBy=multi-user.target</p>
<p>[Service]</p>
<p>User=mysql</p>
<p>Group=mysql</p>
<p>ExecStart=/application/mysql/bin/mysqld –defaults-file=/data/3308/my.cnf</p>
<p>LimitNOFILE = 5000</p>
<p>EOF</p>
<p>cat &gt;/etc/systemd/system/mysqld3309.service&lt;&lt;EOF</p>
<p>[Unit]</p>
<p>Description=MySQL Server</p>
<p>Documentation=man:mysqld(8)</p>
<p>Documentation=<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/en/using-systemd.html">http://dev.mysql.com/doc/refman/en/using-systemd.html</a></p>
<p>After=network.target</p>
<p>After=syslog.target</p>
<p>[Install]</p>
<p>WantedBy=multi-user.target</p>
<p>[Service]</p>
<p>User=mysql</p>
<p>Group=mysql</p>
<p>ExecStart=/application/mysql/bin/mysqld –defaults-file=/data/3309/my.cnf</p>
<p>LimitNOFILE = 5000</p>
<p>EOF</p>
<p>cat &gt;/etc/systemd/system/mysqld3310.service&lt;&lt;EOF</p>
<p>[Unit]</p>
<p>Description=MySQL Server</p>
<p>Documentation=man:mysqld(8)</p>
<p>Documentation=<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/en/using-systemd.html">http://dev.mysql.com/doc/refman/en/using-systemd.html</a></p>
<p>After=network.target</p>
<p>After=syslog.target</p>
<p>[Install]</p>
<p>WantedBy=multi-user.target</p>
<p>[Service]</p>
<p>User=mysql</p>
<p>Group=mysql</p>
<p>ExecStart=/application/mysql/bin/mysqld –defaults-file=/data/3310/my.cnf</p>
<p>LimitNOFILE = 5000</p>
<p>EOF</p>
<p>17.1.5 准备DB02配置文件和启动脚本</p>
<p>cat &gt;/data/3307/my.cnf&lt;&lt;EOF</p>
<p>[mysqld]</p>
<p>basedir=/application/mysql</p>
<p>datadir=/data/3307/data</p>
<p>socket=/data/3307/mysql.sock</p>
<p>port=3307</p>
<p>log-error=/data/3307/mysql.log</p>
<p>log_bin=/data/3307/mysql-bin</p>
<p>binlog_format=row</p>
<p>skip-name-resolve</p>
<p>server-id=17</p>
<p>gtid-mode=on</p>
<p>enforce-gtid-consistency=true</p>
<p>log-slave-updates=1</p>
<p>EOF</p>
<p>cat &gt;/data/3308/my.cnf&lt;&lt;EOF</p>
<p>[mysqld]</p>
<p>basedir=/application/mysql</p>
<p>datadir=/data/3308/data</p>
<p>port=3308</p>
<p>socket=/data/3308/mysql.sock</p>
<p>log-error=/data/3308/mysql.log</p>
<p>log_bin=/data/3308/mysql-bin</p>
<p>binlog_format=row</p>
<p>skip-name-resolve</p>
<p>server-id=18</p>
<p>gtid-mode=on</p>
<p>enforce-gtid-consistency=true</p>
<p>log-slave-updates=1</p>
<p>EOF</p>
<p>cat &gt;/data/3309/my.cnf&lt;&lt;EOF</p>
<p>[mysqld]</p>
<p>basedir=/application/mysql</p>
<p>datadir=/data/3309/data</p>
<p>socket=/data/3309/mysql.sock</p>
<p>port=3309</p>
<p>log-error=/data/3309/mysql.log</p>
<p>log_bin=/data/3309/mysql-bin</p>
<p>binlog_format=row</p>
<p>skip-name-resolve</p>
<p>server-id=19</p>
<p>gtid-mode=on</p>
<p>enforce-gtid-consistency=true</p>
<p>log-slave-updates=1</p>
<p>EOF</p>
<p>cat &gt;/data/3310/my.cnf&lt;&lt;EOF</p>
<p>[mysqld]</p>
<p>basedir=/application/mysql</p>
<p>datadir=/data/3310/data</p>
<p>socket=/data/3310/mysql.sock</p>
<p>port=3310</p>
<p>log-error=/data/3310/mysql.log</p>
<p>log_bin=/data/3310/mysql-bin</p>
<p>binlog_format=row</p>
<p>skip-name-resolve</p>
<p>server-id=20</p>
<p>gtid-mode=on</p>
<p>enforce-gtid-consistency=true</p>
<p>log-slave-updates=1</p>
<p>EOF</p>
<p>cat &gt;/etc/systemd/system/mysqld3307.service&lt;&lt;EOF</p>
<p>[Unit]</p>
<p>Description=MySQL Server</p>
<p>Documentation=man:mysqld(8)</p>
<p>Documentation=<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/en/using-systemd.html">http://dev.mysql.com/doc/refman/en/using-systemd.html</a></p>
<p>After=network.target</p>
<p>After=syslog.target</p>
<p>[Install]</p>
<p>WantedBy=multi-user.target</p>
<p>[Service]</p>
<p>User=mysql</p>
<p>Group=mysql</p>
<p>ExecStart=/application/mysql/bin/mysqld –defaults-file=/data/3307/my.cnf</p>
<p>LimitNOFILE = 5000</p>
<p>EOF</p>
<p>cat &gt;/etc/systemd/system/mysqld3308.service&lt;&lt;EOF</p>
<p>[Unit]</p>
<p>Description=MySQL Server</p>
<p>Documentation=man:mysqld(8)</p>
<p>Documentation=<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/en/using-systemd.html">http://dev.mysql.com/doc/refman/en/using-systemd.html</a></p>
<p>After=network.target</p>
<p>After=syslog.target</p>
<p>[Install]</p>
<p>WantedBy=multi-user.target</p>
<p>[Service]</p>
<p>User=mysql</p>
<p>Group=mysql</p>
<p>ExecStart=/application/mysql/bin/mysqld –defaults-file=/data/3308/my.cnf</p>
<p>LimitNOFILE = 5000</p>
<p>EOF</p>
<p>cat &gt;/etc/systemd/system/mysqld3309.service&lt;&lt;EOF</p>
<p>[Unit]</p>
<p>Description=MySQL Server</p>
<p>Documentation=man:mysqld(8)</p>
<p>Documentation=<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/en/using-systemd.html">http://dev.mysql.com/doc/refman/en/using-systemd.html</a></p>
<p>After=network.target</p>
<p>After=syslog.target</p>
<p>[Install]</p>
<p>WantedBy=multi-user.target</p>
<p>[Service]</p>
<p>User=mysql</p>
<p>Group=mysql</p>
<p>ExecStart=/application/mysql/bin/mysqld –defaults-file=/data/3309/my.cnf</p>
<p>LimitNOFILE = 5000</p>
<p>EOF</p>
<p>cat &gt;/etc/systemd/system/mysqld3310.service&lt;&lt;EOF</p>
<p>[Unit]</p>
<p>Description=MySQL Server</p>
<p>Documentation=man:mysqld(8)</p>
<p>Documentation=<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/en/using-systemd.html">http://dev.mysql.com/doc/refman/en/using-systemd.html</a></p>
<p>After=network.target</p>
<p>After=syslog.target</p>
<p>[Install]</p>
<p>WantedBy=multi-user.target</p>
<p>[Service]</p>
<p>User=mysql</p>
<p>Group=mysql</p>
<p>ExecStart=/application/mysql/bin/mysqld –defaults-file=/data/3310/my.cnf</p>
<p>LimitNOFILE = 5000</p>
<p>EOF</p>
<p>17.1.6 修改权限，启动多实例</p>
<p>chown -R mysql.mysql /data/*</p>
<p>systemctl start mysqld3307</p>
<p>systemctl start mysqld3308</p>
<p>systemctl start mysqld3309</p>
<p>systemctl start mysqld3310</p>
<p>mysql -S /data/3307/mysql.sock -e “show variables like ‘server_id’”</p>
<p>mysql -S /data/3308/mysql.sock -e “show variables like ‘server_id’”</p>
<p>mysql -S /data/3309/mysql.sock -e “show variables like ‘server_id’”</p>
<p>mysql -S /data/3310/mysql.sock -e “show variables like ‘server_id’”</p>
<p>17.1.7 节点主从规划</p>
<p>箭头指向谁是主库</p>
<p>  192.168.27.11:3307  &lt;—–&gt; 192.168.27.12:3307</p>
<p>  192.168.27.11:3309  ——&gt; 192.168.27.11:3307</p>
<p>  192.168.27.12:3309  ——&gt; 192.168.27.12:3307</p>
<p>​    </p>
<p>  192.168.27.12:3308 &lt;—–&gt;  192.168.27.11:3308</p>
<p>  192.168.27.12:3310 —–&gt;   192.168.27.12:3308</p>
<p>  192.168.27.11:3310 —–&gt;   192.168.27.11:3308</p>
<p>17.1.8 分片规划</p>
<p>shard1：</p>
<p>  Master：192.168.27.11:3307</p>
<p>  slave1：192.168.27.11:3309</p>
<p>  Standby Master：192.168.27.12:3307</p>
<p>  slave2：192.168.27.12:3309</p>
<p>shard2：</p>
<p>  Master：192.168.27.12:3308</p>
<p>  slave1：192.168.27.12:3310</p>
<p>  Standby Master：192.168.27.11:3308</p>
<p>  slave2：192.168.27.11:3310</p>
<p>​    </p>
<p>17.1.9 开始配置</p>
<p>#第一组四节点结构</p>
<p># 192.168.27.11:3307 &lt;—–&gt; 192.168.27.12:3307</p>
<p>## db02:</p>
<p>mysql -S /data/3307/mysql.sock -e “grant replication slave on <em>.</em> to repl@’192.168.27.%’ identified by ‘123’;”</p>
<p>mysql -S /data/3307/mysql.sock -e “grant all on <em>.</em> to root@’192.168.27.%’ identified by ‘123’ with grant option;”</p>
<p>## db01:</p>
<p>mysql -S /data/3307/mysql.sock -e “CHANGE MASTER TO MASTER_HOST=’192.168.27.12’, MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER=’repl’, MASTER_PASSWORD=’123’;”</p>
<p>mysql -S /data/3307/mysql.sock -e “start slave;”</p>
<p>mysql -S /data/3307/mysql.sock -e “show slave status\G”</p>
<p>## db02:</p>
<p>mysql -S /data/3307/mysql.sock -e “CHANGE MASTER TO MASTER_HOST=’192.168.27.11’, MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER=’repl’, MASTER_PASSWORD=’123’;”</p>
<p>mysql -S /data/3307/mysql.sock -e “start slave;”</p>
<p>mysql -S /data/3307/mysql.sock -e “show slave status\G”</p>
<p>=======================</p>
<p># 192.168.27.11:3309 ——&gt; 192.168.27.11:3307</p>
<p>## db01:</p>
<p>mysql -S /data/3309/mysql.sock -e “CHANGE MASTER TO MASTER_HOST=’192.168.27.11’, MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER=’repl’, MASTER_PASSWORD=’123’;”</p>
<p>mysql -S /data/3309/mysql.sock -e “start slave;”</p>
<p>mysql -S /data/3309/mysql.sock -e “show slave status\G”</p>
<p># 192.168.27.12:3309 ——&gt; 192.168.27.12:3307</p>
<p>## db02:</p>
<p>mysql -S /data/3309/mysql.sock -e “CHANGE MASTER TO MASTER_HOST=’192.168.27.12’, MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER=’repl’, MASTER_PASSWORD=’123’;”</p>
<p>mysql -S /data/3309/mysql.sock -e “start slave;”</p>
<p>mysql -S /data/3309/mysql.sock -e “show slave status\G”</p>
<p>#第二组四节点</p>
<p>#192.168.27.12:3308 &lt;—–&gt; 192.168.27.11:3308</p>
<p>## db01:</p>
<p>mysql -S /data/3308/mysql.sock -e “grant replication slave on <em>.</em> to repl@’192.168.27.%’ identified by ‘123’;”</p>
<p>mysql -S /data/3308/mysql.sock -e “grant all on <em>.</em> to root@’192.168.27.%’ identified by ‘123’ with grant option;”</p>
<p>## db02:</p>
<p>mysql -S /data/3308/mysql.sock -e “CHANGE MASTER TO MASTER_HOST=’192.168.27.11’, MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER=’repl’, MASTER_PASSWORD=’123’;”</p>
<p>mysql -S /data/3308/mysql.sock -e “start slave;”</p>
<p>mysql -S /data/3308/mysql.sock -e “show slave status\G”</p>
<p>## db01:</p>
<p>mysql -S /data/3308/mysql.sock -e “CHANGE MASTER TO MASTER_HOST=’192.168.27.12’, MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER=’repl’, MASTER_PASSWORD=’123’;”</p>
<p>mysql -S /data/3308/mysql.sock -e “start slave;”</p>
<p>mysql -S /data/3308/mysql.sock -e “show slave status\G”</p>
<p># 192.168.27.12:3310 —–&gt; 192.168.27.12:3308</p>
<p>## db02:</p>
<p>mysql -S /data/3310/mysql.sock -e “CHANGE MASTER TO MASTER_HOST=’192.168.27.12’, MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER=’repl’, MASTER_PASSWORD=’123’;”</p>
<p>mysql -S /data/3310/mysql.sock -e “start slave;”</p>
<p>mysql -S /data/3310/mysql.sock -e “show slave status\G”</p>
<p># 192.168.27.11:3310 —–&gt; 192.168.27.11:3308</p>
<p>## db01:</p>
<p>mysql -S /data/3310/mysql.sock -e “CHANGE MASTER TO MASTER_HOST=’192.168.27.11’, MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER=’repl’, MASTER_PASSWORD=’123’;”</p>
<p>mysql -S /data/3310/mysql.sock -e “start slave;”</p>
<p>mysql -S /data/3310/mysql.sock -e “show slave status\G”</p>
<p>17.1.10 检测主从状态</p>
<p>mysql -S /data/3307/mysql.sock -e “show slave status\G”|grep Yes</p>
<p>mysql -S /data/3308/mysql.sock -e “show slave status\G”|grep Yes</p>
<p>mysql -S /data/3309/mysql.sock -e “show slave status\G”|grep Yes</p>
<p>mysql -S /data/3310/mysql.sock -e “show slave status\G”|grep Yes</p>
<p>-—————————————————————————————————————————</p>
<p>注：如果中间出现错误，在每个节点进行执行以下命令,从第1.9步重新开始即可</p>
<p>mysql -S /data/3307/mysql.sock -e “stop slave; reset slave all;”</p>
<p>mysql -S /data/3308/mysql.sock -e “stop slave; reset slave all;”</p>
<p>mysql -S /data/3309/mysql.sock -e “stop slave; reset slave all;”</p>
<p>mysql -S /data/3310/mysql.sock -e “stop slave; reset slave all;”</p>
<p>17.2. MyCAT安装</p>
<p>2.1 预先安装Java运行环境</p>
<p>yum install -y java</p>
<p>2.2下载</p>
<p>Mycat-server-xxxxx.linux.tar.gz</p>
<p><a target="_blank" rel="noopener" href="http://dl.mycat.io/">http://dl.mycat.io/</a></p>
<p>2.3 解压文件</p>
<p>cd /application</p>
<p>下载文件到/application里</p>
<p>[root@db01 application]# tar xf Mycat-server-1.6.7.1-release-20190627191042-linux.tar.gz </p>
<p>2.4 软件目录结构</p>
<p>ls</p>
<p>bin catlet conf lib logs version.txt</p>
<p>2.5 启动和连接</p>
<p>配置环境变量</p>
<p>vim /etc/profile</p>
<p>添加以下内容</p>
<p>export PATH=/application/mycat/bin:$PATH</p>
<p>生效配置</p>
<p>source /etc/profile</p>
<p>启动</p>
<p>mycat start</p>
<p>连接mycat：</p>
<p>mysql -uroot -p123456 -h 127.0.0.1 -P8066</p>
<p>注意：改名之后要在/etc/hosts里那两行的最后添加主机的名字</p>
<p>如：[root@db01 conf]#cat /etc/hosts</p>
<p>127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4 db01</p>
<p>::1     localhost localhost.localdomain localhost6 localhost6.localdomain6 db01</p>
<p>17.3 数据库分布式架构方式</p>
<p>17.3.1 垂直拆分</p>
<p>17.3.2 水平拆分</p>
<p>​    range</p>
<p>​    取模</p>
<p>​    枚举</p>
<p>​    hash</p>
<p>​    时间</p>
<p>​    等等</p>
<p>17.4. Mycat基础应用</p>
<p>17.4.1 主要配置文件介绍</p>
<p>rule.xml    *****,分片策略定义</p>
<p>schema.xml *****,主配置文件</p>
<p>server.xml    *** ,mycat服务有关</p>
<p>log4j2.xml *** ,记录日志有关</p>
<p>*.txt             ,分片策略使用的规则 </p>
<p>17.4.2 用户创建及数据库导入</p>
<p>db01:</p>
<p>mysql -S /data/3307/mysql.sock </p>
<p>grant all on <em>.</em> to root@’192.168.27.%’ identified by ‘123’;</p>
<p>source /root/world.sql</p>
<p>mysql -S /data/3308/mysql.sock </p>
<p>grant all on <em>.</em> to root@’192.168.27.%’ identified by ‘123’;</p>
<p>source /root/world.sql</p>
<p>17.4.3 mycat实现1主1从读写分离</p>
<p>cd /application/mycat/conf</p>
<p>vim schema.xml </p>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd"><p>&lt;mycat:schema xmlns:mycat=”<a target="_blank" rel="noopener" href="http://io.mycat/&quot;&gt;">http://io.mycat/&quot;&gt;</a></p>
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="sh1"> 

</schema> 

<p>​    <dataNode name="sh1" dataHost="oldguo1" database= "world" />     </p>
<p>​    <dataHost name="oldguo1" maxCon="1000" minCon="10" balance="1" writeType="0" dbType="mysql" dbDriver="native" switchType="1">  </p>
<p>​        <heartbeat>select user()</heartbeat> </p>
<p>​    <writeHost host="db1" url="192.168.27.11:3307" user="root" password="123"></p>
<p>​            <readHost host="db2" url="192.168.27.11:3309" user="root" password="123" /> </p>
<p>​    </writeHost> </p>
<p>​    </dataHost> </p>
<p></mycat:schema></p>
<p>17.4.4 配置文件结构介绍</p>
<p>mv schema.xml schema.xml.bak</p>
<p>vim schema.xml </p>
<?xml version="1.0"?>

<!DOCTYPE mycat:schema SYSTEM "schema.dtd"><p>&lt;mycat:schema xmlns:mycat=”<a target="_blank" rel="noopener" href="http://io.mycat/&quot;&gt;">http://io.mycat/&quot;&gt;</a></p>
<p>mycat 逻辑库定义:</p>
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="sh1"> 

</schema> 

<p>==================================================</p>
<p>数据节点定义:</p>
<p>​    <dataNode name="sh1" dataHost="oldguo1" database= "world" />  </p>
<p>==================================================    </p>
<p>后端主机定义:</p>
<p>​    <dataHost name="oldguo1" maxCon="1000" minCon="10" balance="1" writeType="0" dbType="mysql" dbDriver="native" switchType="1">  </p>
<p>​        <heartbeat>select user()</heartbeat> </p>
<p>​    <writeHost host="db1" url="192.168.27.11:3307" user="root" password="123"></p>
<p>​            <readHost host="db2" url="192.168.27.11:3309" user="root" password="123" /> </p>
<p>​    </writeHost> </p>
<p>​    </dataHost> </p>
<p>===================================================    </p>
<p>​            </p>
<p></mycat:schema></p>
<p>注意：dataNode、dataHost的名字是自己起的</p>
<p>17.4.5 Mycat高可用+读写分离</p>
<p>mv schema.xml schema.xml.1</p>
<p>vim schema.xml </p>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd"><p>&lt;mycat:schema xmlns:mycat=”<a target="_blank" rel="noopener" href="http://io.mycat/&quot;&gt;">http://io.mycat/&quot;&gt;</a></p>
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="sh1"> 

</schema> 

<p>​    <dataNode name="sh1" dataHost="oldguo1" database= "world" />     </p>
<p>​    <dataHost name="oldguo1" maxCon="1000" minCon="10" balance="1" writeType="0" dbType="mysql" dbDriver="native" switchType="1">  </p>
<p>​        <heartbeat>select user()</heartbeat> </p>
<p>​    <writeHost host="db1" url="192.168.27.11:3307" user="root" password="123"></p>
<p>​            <readHost host="db2" url="192.168.27.11:3309" user="root" password="123" /> </p>
<p>​    </writeHost> </p>
<p>​         <writeHost host="db3" url="192.168.27.12:3307" user="root" password="123"></p>
<p>​            <readHost host="db4" url="192.168.27.12:3309" user="root" password="123" /> </p>
<p>​    </writeHost> </p>
<p>​    </dataHost> </p>
<p></mycat:schema></p>
<p>说明:  </p>
 <writeHost host="db1" url="192.168.27.11:3307" user="root" password="123">

<p>​      <readHost host="db2" url="192.168.27.11:3309" user="root" password="123" /> </p>
</writeHost> 

<writeHost host="db3" url="192.168.27.12:3307" user="root" password="123">

<p>​      <readHost host="db4" url="192.168.27.12:3309" user="root" password="123" /> </p>
 </writeHost> 

 

<p>第一个 whost: 1192.168.27.11:3307  真正的写节点,负责写操作</p>
<p>第二个 whost: 192.168.27.12:3307  准备（备用）写节点,负责读,当 192.168.27.11:3307宕掉,会切换为真正的写节点</p>
<p>测试:</p>
<p>[root@db01 conf]# mysql -uroot -p123456 -h 192.168.27.11 -P 8066</p>
<p>读:</p>
<p>mysql&gt; select @@server_id;</p>
<p>写:</p>
<p>mysql&gt; begin ;select @@server_id; commit;</p>
<p>17.4.6 配置中的属性介绍:</p>
<p>balance属性</p>
<p>负载均衡类型，目前的取值有3种： </p>
<p>\1. balance=”0”, 不开启读写分离机制，所有读操作都发送到当前可用的writeHost上。 </p>
<p>\2. balance=”1”，全部的readHost与standby writeHost参与select语句的负载均衡，简单的说，</p>
<p> 当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且M1与 M2互为主备)，正常情况下，M2,S1,S2都参与select语句的负载均衡。 </p>
<p>\3. balance=”2”，所有读操作都随机的在writeHost、readhost上分发。</p>
<p>writeType属性</p>
<p>负载均衡类型，目前的取值有2种： </p>
<p>\1. writeType=”0”, 所有写操作发送到配置的第一个writeHost，</p>
<p>第一个挂了切到还生存的第二个writeHost，重新启动后已切换后的为主，切换记录在配置文件中:dnindex.properties . </p>
<p>\2. writeType=“1”，所有写操作都随机的发送到配置的writeHost，但不推荐使用</p>
<p>switchType属性</p>
<p>-1 表示不自动切换 </p>
<p>1 默认值，自动切换 </p>
<p>2 基于MySQL主从同步的状态决定是否切换 ，心跳语句为 show slave status </p>
<p>datahost其他配置</p>
<dataHost name="localhost1" maxCon="1000" minCon="10" balance="1" writeType="0" dbType="mysql" dbDriver="native" switchType="1"> 

 

<p>maxCon=”1000”：最大的并发连接数</p>
<p>minCon=”10” ：mycat在启动之后，会在后端节点上自动开启的连接线程</p>
<p>tempReadHostAvailable=”1”</p>
<p>这个一主一从时（1个writehost，1个readhost时），可以开启这个参数，如果2个writehost，2个readhost时</p>
<p><heartbeat>select user()</heartbeat> 监测心跳</p>
<p>sqlMaxLimit=”100”</p>
<p>类似select * from tables limit 100;</p>
<p>17.5. Mycat高级应用-分布式解决方案</p>
<p>17.5.1 垂直分表</p>
<p>mv schema.xml schema.xml.ha </p>
<p>vim schema.xml</p>
<?xml version="1.0"?>

<!DOCTYPE mycat:schema SYSTEM "schema.dtd">

<p>&lt;mycat:schema xmlns:mycat=”<a target="_blank" rel="noopener" href="http://io.mycat/&quot;&gt;">http://io.mycat/&quot;&gt;</a></p>
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="sh1">

<p>        <table name="user" dataNode="sh1"/></p>
<p>        <table name="order_t" dataNode="sh2"/></p>
</schema>

  <dataNode name="sh1" dataHost="oldguo1" database= "taobao" />

  <dataNode name="sh2" dataHost="oldguo2" database= "taobao" />

  <dataHost name="oldguo1" maxCon="1000" minCon="10" balance="1" writeType="0" dbType="mysql" dbDriver="native" switchType="1">

<p>​    <heartbeat>select user()</heartbeat></p>
  <writeHost host="db1" url="192.168.27.11:3307" user="root" password="123">

<p>​      <readHost host="db2" url="192.168.27.11:3309" user="root" password="123" /></p>
  </writeHost>

  <writeHost host="db3" url="192.168.27.12:3307" user="root" password="123">

<p>​      <readHost host="db4" url="192.168.27.12:3309" user="root" password="123" /></p>
  </writeHost>

  </dataHost>

<p>​    </p>
  <dataHost name="oldguo2" maxCon="1000" minCon="10" balance="1" writeType="0" dbType="mysql" dbDriver="native" switchType="1">

<p>​    <heartbeat>select user()</heartbeat></p>
  <writeHost host="db1" url="192.168.27.11:3308" user="root" password="123">

<p>​      <readHost host="db2" url="192.168.27.11:3310" user="root" password="123" /></p>
  </writeHost>

  <writeHost host="db3" url="192.168.27.12:3308" user="root" password="123">

<p>​      <readHost host="db4" url="192.168.27.12:3310" user="root" password="123" /></p>
  </writeHost>

  </dataHost>    

<p></mycat:schema></p>
<p>创建测试库和表:</p>
<p>[root@db01 conf]# mysql -S /data/3307/mysql.sock -e “create database taobao charset utf8;”</p>
<p>[root@db01 conf]# mysql -S /data/3308/mysql.sock -e “create database taobao charset utf8;”</p>
<p>[root@db01 conf]# mysql -S /data/3307/mysql.sock -e “use taobao;create table user(id int,name varchar(20))”;</p>
<p>[root@db01 conf]# mysql -S /data/3308/mysql.sock -e “use taobao;create table order_t(id int,name varchar(20))”</p>
<p>重启mycat :</p>
<p>mycat restart </p>
<p>测试功能:</p>
<p>[root@db01 conf]# mysql -uroot -p123456 -h 192.168.27.11 -P 8066</p>
<p>mysql&gt; use TESTDB</p>
<p>mysql&gt; insert into user(id ,name ) values(1,’a’),(2,’b’);</p>
<p>mysql&gt; commit;</p>
<p>mysql&gt; insert into order_t(id ,name ) values(1,’a’),(2,’b’);</p>
<p>mysql&gt; commit;</p>
<p>[root@db01 ~]# mysql -S /data/3307/mysql.sock -e “show tables from taobao;”</p>
<p>+——————+</p>
<p>| Tables_in_taobao |</p>
<p>+——————+</p>
<p>| user       |</p>
<p>+——————+</p>
<p>[root@db01 ~]# mysql -S /data/3308/mysql.sock -e “show tables from taobao;”</p>
<p>+——————+</p>
<p>| Tables_in_taobao |</p>
<p>+——————+</p>
<p>| order_t     |</p>
<p>+——————+</p>
<p>[root@db01 ~]# </p>
<p>17.5.2 Mycat分布式-水平拆分(分片)介绍</p>
<p>分片：对一个”bigtable”，比如说t3表</p>
<p>(1)行数非常多，800w</p>
<p>(2)访问非常频繁</p>
<p>分片的目的：</p>
<p>（1）将大数据量进行分布存储</p>
<p>（2）提供均衡的访问路由</p>
<p>分片策略：</p>
<p>范围 range 800w 1-400w 400w01-800w</p>
<p>取模 mod  取余数</p>
<p>枚举 </p>
<p>哈希 hash </p>
<p>时间 流水</p>
<p>优化关联查询</p>
<p>全局表</p>
<p>ER分片</p>
<p>17.5.3 Mycat分布式-范围分片</p>
<p>比如说t3表</p>
<p>(1)行数非常多，2000w（1-1000w:sh1  1000w01-2000w:sh2）</p>
<p>(2)访问非常频繁，用户访问较离散</p>
<p>cp schema.xml schema.xml.11 </p>
<p>vim schema.xml</p>
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="sh1"> 

<p>        <table name="t3" dataNode="sh1,sh2" rule="auto-sharding-long" />    (一张表拆分到两个节点)</p>
</schema> 

  <dataNode name="sh1" dataHost="oldguo1" database= "taobao" /> 

  <dataNode name="sh2" dataHost="oldguo2" database= "taobao" /> 

 

<p>vim rule.xml （只是查看，学习）</p>
<tableRule name="auto-sharding-long">

<p>​        <rule></p>
<p>​            <columns>id</columns></p>
<p>​            <algorithm>rang-long</algorithm></p>
<p>​        </rule>       </p>
<p>&lt;function name=”rang-long”</p>
<p>  class=”io.mycat.route.function.AutoPartitionByLong”&gt;</p>
<p>  <property name="mapFile">autopartition-long.txt</property></p>
</function>

<p>===================================     </p>
<p>mv autopartition-long.txt autopartition-long.txt1</p>
<p>vim autopartition-long.txt （覆盖）</p>
<p>1-10=0  —–&gt; &gt;=1 , &lt;=10</p>
<p>10-20=1 —–&gt; &gt;10 ,&lt;=20</p>
<p>创建测试表：</p>
<p>mysql -S /data/3307/mysql.sock -e “use taobao;create table t3 (id int not null primary key auto_increment,name varchar(20) not null);”</p>
<p>mysql -S /data/3308/mysql.sock -e “use taobao;create table t3 (id int not null primary key auto_increment,name varchar(20) not null);”</p>
<p>测试：</p>
<p>重启mycat</p>
<p>mycat restart</p>
<p>mysql -uroot -p123456 -h 127.0.0.1 -P 8066</p>
<p>use TESTDB;</p>
<p>insert into t3(id,name) values(1,’a’);</p>
<p>insert into t3(id,name) values(2,’b’);</p>
<p>insert into t3(id,name) values(3,’c’);</p>
<p>insert into t3(id,name) values(10,’d’);</p>
<p>insert into t3(id,name) values(11,’aa’);</p>
<p>insert into t3(id,name) values(12,’bb’);</p>
<p>insert into t3(id,name) values(13,’cc’);</p>
<p>insert into t3(id,name) values(14,’dd’);</p>
<p>insert into t3(id,name) values(20,’dd’);</p>
<p>mysql -S /data/3308/mysql.sock -e “select * from taobao.t3;”</p>
<p>mysql -S /data/3307/mysql.sock -e “select * from taobao.t3;”</p>
<p>17.5.4 取模分片（mod-long）：</p>
<p>取余分片方式：分片键（一个列）与节点数量进行取余，得到余数，将数据写入对应节点</p>
<p>vim schema.xml</p>
<p><table name="t4" dataNode="sh1,sh2" rule="mod-long" /></p>
<p>vim rule.xml</p>
<p>（根据分片修改，例子改成2）</p>
<p><property name="count">2</property></p>
<p>准备测试环境</p>
<p>创建测试表：</p>
<p>mysql -S /data/3307/mysql.sock -e “use taobao;create table t4 (id int not null primary key auto_increment,name varchar(20) not null);”</p>
<p>mysql -S /data/3308/mysql.sock -e “use taobao;create table t4 (id int not null primary key auto_increment,name varchar(20) not null);”</p>
<p>重启mycat </p>
<p>mycat restart </p>
<p>测试： </p>
<p>mysql -uroot -p123456 -h192.168.27.11 -P8066</p>
<p>use TESTDB</p>
<p>insert into t4(id,name) values(1,’a’);</p>
<p>insert into t4(id,name) values(2,’b’);</p>
<p>insert into t4(id,name) values(3,’c’);</p>
<p>insert into t4(id,name) values(4,’d’);</p>
<p>分别登录后端节点查询数据</p>
<p>mysql -S /data/3307/mysql.sock -e “select * from taobao.t4;”</p>
<p>mysql -S /data/3308/mysql.sock -e “select * from taobao.t4;”</p>
<p>17.6 枚举分片</p>
<p>t5 表</p>
<p>id name telnum</p>
<p>1  bj  1212</p>
<p>2  sh  22222</p>
<p>3  bj  3333</p>
<p>4  sh  44444</p>
<p>5  bj  5555</p>
<p>sharding-by-intfile</p>
<p>vim schema.xml（可以直接添加，跟以前的表不冲突）</p>
<p><table name="t5" dataNode="sh1,sh2" rule="sharding-by-intfile" /></p>
<p>vim rule.xml（修改）</p>
<tableRule name="sharding-by-intfile"> 

<p><rule> <columns>name</columns> </p>
<p><algorithm>hash-int</algorithm> </p>
</rule> 

</tableRule> 

 

<function name="hash-int" class="org.opencloudb.route.function.PartitionByFileMap"> 

<p><property name="mapFile">partition-hash-int.txt</property> </p>
<p> <property name="type">1</property></p>
<p>​        <property name="defaultNode">0</property></p>
</function> 

 

<p>partition-hash-int.txt 配置： </p>
<p>cp partition-hash-int.txt partition-hash-int.txt1</p>
<p>vim partition-hash-int.txt</p>
<p>bj=0 </p>
<p>sh=1</p>
<p>DEFAULT_NODE=1 </p>
<p>columns 标识将要分片的表字段，algorithm 分片函数， 其中分片函数配置中，mapFile标识配置文件名称</p>
<p>准备测试环境</p>
<p>mysql -S /data/3307/mysql.sock -e “use taobao;create table t5 (id int not null primary key auto_increment,name varchar(20) not null);”</p>
<p>mysql -S /data/3308/mysql.sock -e “use taobao;create table t5 (id int not null primary key auto_increment,name varchar(20) not null);”</p>
<p>重启mycat </p>
<p>mycat restart </p>
<p>mysql -uroot -p123456 -h192.168.27.11 -P8066</p>
<p>use TESTDB</p>
<p>insert into t5(id,name) values(1,’bj’);</p>
<p>insert into t5(id,name) values(2,’sh’);</p>
<p>insert into t5(id,name) values(3,’bj’);</p>
<p>insert into t5(id,name) values(4,’sh’);</p>
<p>insert into t5(id,name) values(5,’tj’);</p>
<p>分别登录后端节点查询数据</p>
<p>mysql -S /data/3307/mysql.sock -e “select * from taobao.t5;”</p>
<p>mysql -S /data/3308/mysql.sock -e “select * from taobao.t5;”</p>
<p>=============================================================================</p>
<p>十八、MySQL优化</p>
<p>18.1 优化哲学 </p>
<p>18.1.1 优化有风险</p>
<p>（1）优化不总是对一个单纯的环境进行！还很可能是一个复杂的已投产的系统。 （2）优化手段本来就有很大的风险，只不过你没能力意识到和预见到！ （3）任何的技术可以解决一个问题，但必然存在带来一个问题的风险！ （4）对于优化来说解决问题而带来的问题控制在可接受的范围内才是有成果。 （5）保持现状或出现更差的情况都是失败！ （6）稳定性和业务可持续性通常比性能更重要！ （7）优化不可避免涉及到变更，变更就有风险！ （8）优化使性能变好，维持和变差是等概率事件！ （9）优化不能只是数据库管理员担当风险，但会所有的人分享优化成果！ （10）所以优化工作是由业务需要驱使的！！！</p>
<p>18.1.2 优化的范围</p>
<p>存储、主机和操作系统:</p>
<p>  主机架构稳定性</p>
<p>  I/O规划及配置</p>
<p>  Swap</p>
<p>  OS内核参数</p>
<p>  网络问题    </p>
<p>应用 :（Index，lock，session）</p>
<p>  应用程序稳定性和性能</p>
<p>  SQL语句性能</p>
<p>  串行访问资源</p>
<p>  性能欠佳会话管理</p>
<p>数据库优化:（内存、数据库设计、参数）</p>
<p>  内存</p>
<p>  数据库结构(物理&amp;逻辑)</p>
<p>  实例配置</p>
<p><img src="file:///C:\Users\kinci\AppData\Local\Temp\ksohtml\wps37C8.tmp.png" srcset="/blog/img/loading.gif" alt="img"> </p>
<p>18.2 优化工具介绍</p>
<p>18.2.1 系统层 </p>
<p>CPU : 计算(主)和调度(次) </p>
<p>MEM : 缓存和缓冲</p>
<p>IO : 输入和输出 </p>
<p>(1) top命令 </p>
<p>%Cpu(s): 0.0 us, 0.0 sy, 100.0 id, 0.0 wa</p>
<p>解析：</p>
<p>id  空闲的CPU时间片占比</p>
<p>us     用户程序工作所占用的时间片占比</p>
<p>sy  内核工作花费的cpu时间片占比</p>
<p>过高的原因:</p>
<p>内核本身bug</p>
<p>并发很高</p>
<p>锁</p>
<p>wa     cpu用来等待的时间片占比</p>
<p>IO</p>
<p>等待大的处理事件</p>
<p>锁</p>
<p>KiB Mem : 4937752 total, 3988956 free,  476100 used,  472696 buff/cache  4193924 avail Mem </p>
<p>KiB Swap: 1048572 total, 1048572 free,    0 used. </p>
<p>(2) iostat </p>
<p>[root@db01 ~]# iostat -dk 1</p>
<p>一般情况下，CPU高，IO也应该高。</p>
<p>如果：CPU 高  ，IO 比较低</p>
<p>wait 高： 有可以能IO出问题了（Raid ，过度条带化）  </p>
<p>SyS 高： 有可能是锁的问题，需要进一步去数据库中判断</p>
<p>(3) vmstat</p>
<p>[root@db01 ~]# vmstat  1</p>
<p>18.2.2 数据库层工具</p>
<p>  show status </p>
<p>  show variables </p>
<p>  show index </p>
<p>  show processlist </p>
<p>  show slave status</p>
<p>  show engine innodb status </p>
<p>  desc /explain </p>
<p>  slowlog</p>
<p>​    </p>
<p>  扩展类深度优化:</p>
<p>  pt系列（pt-query-digest pt-osc pt-index 等）</p>
<p>  mysqlslap </p>
<p>  sysbench </p>
<p>  information_schema （I_S）</p>
<p>  performance_schema (P_S)</p>
<p>  sys </p>
<p>18.3 优化思路 </p>
<p>18.3.0 未优化前的压力测试</p>
<p>db01 [(none)]&gt;create database oldguo charset utf8mb4;</p>
<p>db01 [(none)]&gt;use oldguo;</p>
<p>db01 [oldguo]&gt;set sql_log_bin=0;</p>
<p>db01 [oldguo]&gt;source t100w.sql</p>
<p>db01 [oldguo]&gt;grant all on <em>.</em> to root@’localhost’ identified by ‘123’;</p>
<p>[root@db01 ~]# mysqlslap –defaults-file=/etc/my.cnf \</p>
<p>–concurrency=100 –iterations=1 –create-schema=’oldguo’ \</p>
<p>–query=”select * from oldguo.t100w where k2=’ABxy’” engine=innodb \</p>
<p>–number-of-queries=200 -uroot -p123 -verbose</p>
<p>18.3.1 主机,存储,网络 </p>
<p>主机</p>
<p>真实的硬件（PC Server）: DELL R系列 ，华为，浪潮，HP，曙光,联想</p>
<p>云产品：ECS、数据库RDS、DRDS、PolarDB</p>
<p>IBM 小型机 P6 570 595  P7 720 750 780   P8 </p>
<p>CPU根据数据库类型</p>
<p>OLTP </p>
<p>OLAP </p>
<p>IO密集型：线上系统，OLTP主要是IO密集型的业务，高并发</p>
<p>CPU密集型：数据分析数据处理，OLAP，cpu密集型的，需要CPU高计算能力（i系列，IBM power系列）</p>
<p>CPU密集型： I 系列的，主频很高，核心少 </p>
<p>IO密集型： E系列（至强），主频相对低，核心数量多</p>
<p>内存</p>
<p>建议2-3倍cpu核心数量 （ECC）</p>
<p>磁盘选择</p>
<p>SATA-III  SAS  Fc  SSD（sata） pci-e ssd Flash</p>
<p>主机 RAID卡的BBU(Battery Backup Unit)关闭</p>
<p>存储</p>
<p>根据存储数据种类的不同，选择不同的存储设备</p>
<p>配置合理的RAID级别(raid5、raid10、热备盘)  </p>
<p>r0 :条带化 ,性能高</p>
<p>r1 :镜像，安全</p>
<p>r5 :校验+条带化，安全较高+性能较高（读），写性能较低 （适合于读多写少）</p>
<p>r10：安全+性能都很高，最少四块盘，浪费一半的空间（高IO要求）</p>
<p>网络</p>
<p>1、硬件买好的（单卡单口）</p>
<p>2、网卡绑定（bonding），交换机堆叠</p>
<p>以上问题，提前规避掉。</p>
<p>18.3.2 系统</p>
<p>Swap调整</p>
<p>echo 0 &gt;/proc/sys/vm/swappiness的内容改成0（临时），</p>
<p>vim /etc/sysctl.conf</p>
<p>上添加vm.swappiness=0（永久）</p>
<p>sysctl -p</p>
<p>这个参数决定了Linux是倾向于使用swap，还是倾向于释放文件系统cache。在内存紧张的情况下，数值越低越倾向于释放文件系统cache。 当然，这个参数只能减少使用swap的概率，并不能避免Linux使用swap。 修改MySQL的配置参数innodb_flush_method，开启O_DIRECT模式 这种情况下，InnoDB的buffer pool会直接绕过文件系统cache来访问磁盘，但是redo log依旧会使用文件系统cache。值得注意的是，Redo log是覆写模式的，即使使用了文件系统的cache，也不会占用太多</p>
<p>IO调度策略</p>
<p>centos 7 默认是deadline</p>
<p>cat  /sys/block/sda/queue/scheduler</p>
<p>#临时修改为deadline(centos6)</p>
<p>echo deadline &gt;/sys/block/sda/queue/scheduler </p>
<p>vi /boot/grub/grub.conf</p>
<p>更改到如下内容:</p>
<p>kernel /boot/vmlinuz-2.6.18-8.el5 ro root=LABEL=/ elevator=deadline rhgb quiet</p>
<p>IO ：</p>
<p>  raid</p>
<p>  no lvm</p>
<p>  ext4或xfs</p>
<p>  ssd</p>
<p>  IO调度策略    </p>
<p>提前规划好以上所有问题，减轻MySQL优化的难度。</p>
<p>18.3.3优化参数</p>
<p>18.3.3.1 Max_connections *****</p>
<p>（1）简介</p>
<p>Mysql的最大连接数，如果服务器的并发请求量比较大，可以调高这个值，当然这是要建立在机器能够支撑的情况下，因为如果连接数越来越多，mysql会为每个连接提供缓冲区，就会开销的越多的内存，所以需要适当的调整该值，不能随便去提高设值。</p>
<p>（2）判断依据</p>
<p>show variables like ‘max_connections’;</p>
<p>  +—————–+——-+</p>
<p>  | Variable_name  | Value |</p>
<p>  +—————–+——-+</p>
<p>  | max_connections | 151  |</p>
<p>  +—————–+——-+</p>
<p>show status like ‘Max_used_connections’;</p>
<p>  +———————-+——-+</p>
<p>  | Variable_name    | Value |</p>
<p>  +———————-+——-+</p>
<p>  | Max_used_connections | 101  |</p>
<p>  +———————-+——-+</p>
<p>​    </p>
<p>（3）修改方式举例</p>
<p>vim /etc/my.cnf </p>
<p>Max_connections=1024</p>
<p>补充:</p>
<p>  1.开启数据库时,我们可以临时设置一个比较大的测试值</p>
<p>  2.观察show status like ‘Max_used_connections’;变化</p>
<p>  3.如果max_used_connections跟max_connections相同,</p>
<p>  那么就是max_connections设置过低或者超过服务器的负载上限了</p>
<p>18.3.3.2 back_log *** </p>
<p>（1）简介</p>
<p>mysql能暂存的连接数量，当主要mysql线程在一个很短时间内得到非常多的连接请求时候它就会起作用，如果mysql的连接数据达到max_connections时候，新来的请求将会被存在堆栈中，等待某一连接释放资源，该推栈的数量及back_log,如果等待连接的数量超过back_log，将不被授予连接资源。</p>
<p>back_log值指出在mysql暂时停止回答新请求之前的短时间内有多少个请求可以被存在推栈中，只有如果期望在一个短时间内有很多连接的时候需要增加它</p>
<p>（2）判断依据</p>
<p>show full processlist</p>
<p>发现大量的待连接进程时，就需要加大back_log或者加大max_connections的值</p>
<p>（3）修改方式举例</p>
<p>vim /etc/my.cnf </p>
<p>back_log=1024</p>
<p>18.3.3.3 wait_timeout和interactive_timeout ****</p>
<p>（1）简介</p>
<p>wait_timeout：指的是mysql在关闭一个非交互的连接之前所要等待的秒数</p>
<p>interactive_timeout：指的是mysql在关闭一个交互的连接之前所需要等待的秒数，比如我们在终端上进行mysql管理，使用的即使交互的连接，这时候，如果没有操作的时间超过了interactive_time设置的时间就会自动的断开，默认的是28800，可调优为7200。</p>
<p>wait_timeout:如果设置太小，那么连接关闭的就很快，从而使一些持久的连接不起作用</p>
<p>（2）设置建议</p>
<p>如果设置太大，容易造成连接打开时间过长，在show processlist时候，能看到很多的连接 ，一般希望wait_timeout尽可能低</p>
<p>（3）修改方式举例</p>
<p>wait_timeout=60</p>
<p>interactive_timeout=1200</p>
<p>长连接的应用，为了不去反复的回收和分配资源，降低额外的开销。</p>
<p>一般我们会将wait_timeout设定比较小，interactive_timeout要和应用开发人员沟通长链接的应用是否很多。如果他需要长链接，那么这个值可以不需要调整。</p>
<p>另外还可以使用类外的参数弥补。</p>
<p>18.3.3.4 key_buffer_size *****</p>
<p>key_buffer_size指定索引缓冲区的大小，它决定索引处理的速度，尤其是索引读的速度</p>
<p>(1) myisam 表的索引缓冲区</p>
<p>(2) 临时表的缓冲区</p>
<p>mysql&gt; show status like “created_tmp%”;</p>
<p>+————————-+——-+</p>
<p>| Variable_name      | Value |</p>
<p>+————————-+——-+</p>
<p>| Created_tmp_disk_tables | 0   |</p>
<p>| Created_tmp_files    | 6   |</p>
<p>| Created_tmp_tables   | 1   |</p>
<p>Created_tmp_tables/(Created_tmp_disk_tables + Created_tmp_tables) = 越高越好</p>
<p>Created_tmp_disk_tables/(Created_tmp_disk_tables + Created_tmp_tables) </p>
<p>Created_tmp_disk_tables/(Created_tmp_disk_tables + Created_tmp_tables) </p>
<p>控制在5%-10%以内</p>
<p>mysql&gt; show variables like “key_buffer_size%”;</p>
<p>+—————–+———+ | Variable_name  | Value  | +—————–+———+ | key_buffer_size | 8388608 | +—————–+———+ 1 row in set (0.00 sec)</p>
<p>（3）配置方法 key_buffer_size=64M</p>
<p>18.3.3.5 query_cache_size ***</p>
<p>（1）简介： 查询缓存简称QC，使用查询缓冲，mysql将查询结果存放在缓冲区中，今后对于同样的select语句（区分大小写）,将直接从缓冲区中读取结果。 SQL层： select * from t1 where name=:NAME; select * from t1 where name=:NAME; 1、查询完结果之后，会对SQL语句进行hash运算，得出hash值,我们把他称之为SQL_ID 2、会将存储引擎返回的结果+SQL_ID存储到缓存中。 存储方式： 例子：select * from t1 where id=10;   100次 1、将select * from t1 where id=10; 进行hash运算计算出一串hash值，我们把它称之为“SQL_ID” 2、将存储引擎返回上来的表的内容+SQLID存储到查询缓存中 使用方式： 1、一条SQL执行时，进行hash运算，得出SQLID，去找query cache 2、如果cache中有，则直接返回数据行，如果没有，就走原有的SQL执行流程 一个sql查询如果以select开头，那么mysql服务器将尝试对其使用查询缓存。 注：两个sql语句，只要想差哪怕是一个字符（列如大小写不一样；多一个空格等）,那么这两个sql将使用不同的一个cache。 （2）判断依据 mysql&gt; show status like “%Qcache%”; +————————-+———+ | Variable_name      | Value  | +————————-+———+ | Qcache_free_blocks   | 1    | | Qcache_free_memory   | 1031360 | | Qcache_hits       | 0    | | Qcache_inserts     | 0    | | Qcache_lowmem_prunes  | 0    | | Qcache_not_cached    | 2002  | | Qcache_queries_in_cache | 0    | | Qcache_total_blocks   | 1    | +————————-+———+ 8 rows in set (0.00 sec) ———————状态说明——————– Qcache_free_blocks：缓存中相邻内存块的个数。 如果该值显示较大，则说明Query Cache 中的内存碎片较多了，FLUSH QUERY CACHE会对缓存中的碎片进行整理，从而得到一个空闲块。 注：当一个表被更新之后，和它相关的cache blocks将被free。但是这个block依然可能存在队列中，除非是在队列的尾部。可以用FLUSH QUERY CACHE语句来清空free blocks Qcache_free_memory：Query Cache 中目前剩余的内存大小。通过这个参数我们可以较为准确的观察出当前系统中的Query Cache 内存大小是否足够，是需要增加还是过多了。 Qcache_hits：表示有多少次命中缓存。我们主要可以通过该值来验证我们的查询缓存的效果。数字越大，缓存效果越理想。 Qcache_inserts：表示多少次未命中然后插入，意思是新来的SQL请求在缓存中未找到，不得不执行查询处理，执行查询处理后把结果insert到查询缓存中。这样的情况的次数越多，表示查询缓存应用到的比较少，效果也就不理想。当然系统刚启动后，查询缓存是空的，这很正常。 Qcache_lowmem_prunes： 多少条Query因为内存不足而被清除出QueryCache。通过“Qcache_lowmem_prunes”和“Qcache_free_memory”相互结合，能够更清楚的了解到我们系统中Query Cache 的内存大小是否真的足够，是否非常频繁的出现因为内存不足而有Query 被换出。这个数字最好长时间来看；如果这个数字在不断增长，就表示可能碎片非常严重，或者内存很少。（上面的free_blocks和free_memory可以告诉您属于哪种情况） Qcache_not_cached：不适合进行缓存的查询的数量，通常是由于这些查询不是 SELECT 语句或者用了now()之类的函数。 Qcache_queries_in_cache：当前Query Cache 中cache 的Query 数量； Qcache_total_blocks：当前Query Cache 中的block 数量；。 Qcache_hits / (Qcache_inserts+Qcache_not_cached+Qcache_hits)   90/     10000       0       90 如果出现hits比例过低，其实就可以关闭查询缓存了。使用redis专门缓存数据库 Qcache_free_blocks  来判断碎片 Qcache_free_memory  +  Qcache_lowmem_prunes 来判断内存够不够 Qcache_hits 多少次命中 Qcache_hits / (Qcache_inserts+Qcache_not_cached+Qcache_hits)  （3）配置示例 mysql&gt; show variables like ‘%query_cache%’ ; +——————————+———+ | Variable_name        | Value  | +——————————+———+ | have_query_cache       | YES   | | query_cache_limit      | 1048576 | | query_cache_min_res_unit   | 4096  | | query_cache_size       | 1048576 | | query_cache_type       | OFF   | | query_cache_wlock_invalidate | OFF   | +——————————+———+ 6 rows in set (0.00 sec) mysql&gt; ——————-配置说明——————————- 以上信息可以看出query_cache_type为off表示不缓存任何查询 各字段的解释： query_cache_limit：超过此大小的查询将不缓存 query_cache_min_res_unit：缓存块的最小大小，query_cache_min_res_unit的配置是一柄”双刃剑”，默认是4KB，设置值大对大数据查询有好处，但如果你的查询都是小数据查询，就容易造成内存碎片和浪费。 query_cache_size：查询缓存大小 (注：QC存储的最小单位是1024byte，所以如果你设定了一个不是1024的倍数的值，这个值会被四舍五入到最接近当前值的等于1024的倍数的值。) query_cache_type：缓存类型，决定缓存什么样的查询，注意这个值不能随便设置，必须设置为数字，可选项目以及说明如下： 如果设置为0，那么可以说，你的缓存根本就没有用，相当于禁用了。 如果设置为1，将会缓存所有的结果，除非你的select语句使用SQL_NO_CACHE禁用了查询缓存。 如果设置为2，则只缓存在select语句中通过SQL_CACHE指定需要缓存的查询。 修改/etc/my.cnf,配置完后的部分文件如下： query_cache_size=128M query_cache_type=1</p>
<p>18.3.3.6 max_connect_errors ***</p>
<p>max_connect_errors是一个mysql中与安全有关的计数器值，它负责阻止过多尝试失败的客户端以防止暴力破解密码等情况，当超过指定次数，mysql服务器将禁止host的连接请求，直到mysql服务器重启或通过flush hosts命令清空此host的相关信息 max_connect_errors的值与性能并无太大关系。 修改/etc/my.cnf文件，在[mysqld]下面添加如下内容 max_connect_errors=2000</p>
<p>18.3.3.7 sort_buffer_size ***</p>
<p>（1）简介： 每个需要进行排序的线程分配该大小的一个缓冲区。增加这值加速 ORDER BY GROUP BY distinct union  （2）配置依据 Sort_Buffer_Size并不是越大越好，由于是connection级的参数，过大的设置+高并发可能会耗尽系统内存资源。 列如：500个连接将会消耗500*sort_buffer_size（2M）=1G内存 （3）配置方法 修改/etc/my.cnf文件，在[mysqld]下面添加如下： sort_buffer_size=1M</p>
<p>18.3.3.8 max_allowed_packet *****</p>
<p>（1）简介： mysql根据配置文件会限制，server接受的数据包大小。 （2）配置依据： 有时候大的插入和更新会受max_allowed_packet参数限制，导致写入或者更新失败，更大值是1GB，必须设置1024的倍数 （3）配置方法： max_allowed_packet=32M</p>
<p>18.3.3.9 join_buffer_size ***</p>
<p>select a.name,b.name from a join b on a.id=b.id where xxxx 用于表间关联缓存的大小，和sort_buffer_size一样，该参数对应的分配内存也是每个连接独享。 尽量在SQL与方面进行优化，效果较为明显。 优化的方法：在on条件列加索引，至少应当是有MUL索引</p>
<p>18.3.3.10 thread_cache_size *****</p>
<p>(1)简介 服务器线程缓存，这个值表示可以重新利用保存在缓存中线程的数量,当断开连接时,那么客户端的线程将被放到缓存中以响应下一个客户而不是销毁(前提是缓存数未达上限),如果线程重新被请求，那么请求将从缓存中读取,如果缓存中是空的或者是新的请求，那么这个线程将被重新创建,如果有很多新的线程，增加这个值可以改善系统性能. （2）配置依据 通过比较 Connections 和 Threads_created 状态的变量，可以看到这个变量的作用。 设置规则如下：1GB 内存配置为8，2GB配置为16，3GB配置为32，4GB或更高内存，可配置更大。 服务器处理此客户的线程将会缓存起来以响应下一个客户而不是销毁(前提是缓存数未达上限) 试图连接到MySQL(不管是否连接成功)的连接数 mysql&gt; show status like ‘threads_%’; +——————-+——-+ | Variable_name   | Value | +——————-+——-+ | Threads_cached  | 8   | | Threads_connected | 2   | | Threads_created  | 4783 | | Threads_running  | 1   | +——————-+——-+ 4 rows in set (0.00 sec) Threads_cached :代表当前此时此刻线程缓存中有多少空闲线程。 Threads_connected:代表当前已建立连接的数量，因为一个连接就需要一个线程，所以也可以看成当前被使用的线程数。 Threads_created:代表从最近一次服务启动，已创建线程的数量，如果发现Threads_created值过大的话，表明MySQL服务器一直在创建线程，这也是比较耗cpu SYS资源，可以适当增加配置文件中thread_cache_size值。 Threads_running :代表当前激活的（非睡眠状态）线程数。并不是代表正在使用的线程数，有时候连接已建立，但是连接处于sleep状态。 (3)配置方法： thread_cache_size=32 整理： Threads_created ：一般在架构设计阶段，会设置一个测试值，做压力测试。 结合zabbix监控，看一段时间内此状态的变化。 如果在一段时间内，Threads_created趋于平稳，说明对应参数设定是OK。 如果一直陡峭的增长，或者出现大量峰值，那么继续增加此值的大小，在系统资源够用的情况下（内存）</p>
<p>18.3.3.11 innodb_buffer_pool_size *****</p>
<p>（1）简介 对于InnoDB表来说，innodb_buffer_pool_size的作用就相当于key_buffer_size对于MyISAM表的作用一样。 （2）配置依据： InnoDB使用该参数指定大小的内存来缓冲数据和索引。 对于单独的MySQL数据库服务器，最大可以把该值设置成物理内存的80%,一般我们建议不要超过物理内存的70%。 （3）配置方法 innodb_buffer_pool_size=2048M</p>
<p>18.3.3.12 innodb_flush_log_at_trx_commit ******</p>
<p>（1）简介 主要控制了innodb将log buffer中的数据写入日志文件并flush磁盘的时间点，取值分别为0、1、2三个。 0，表示当事务提交时，不做日志写入操作，而是每秒钟将log buffer中的数据写入日志文件并flush磁盘一次； 1， 每次事务的提交都会引起redo日志文件写入、flush磁盘的操作，确保了事务的ACID； 2，每次事务提交引起写入日志文件的动作,但每秒钟完成一次flush磁盘操作。 （2）配置依据 实际测试发现，该值对插入数据的速度影响非常大，设置为2时插入10000条记录只需要2秒，设置为0时只需要1秒，而设置为1时则需要229秒。因此，MySQL手册也建议尽量将插入操作合并成一个事务，这样可以大幅提高速度。 根据MySQL官方文档，在允许丢失最近部分事务的危险的前提下，可以把该值设为0或2。 （3）配置方法 innodb_flush_log_at_trx_commit=1 双1标准中的一个1</p>
<p>18.3.3.13 innodb_thread_concurrency ***</p>
<p>（1）简介 此参数用来设置innodb线程的并发数量，默认值为0表示不限制。 （2）配置依据 在官方doc上，对于innodb_thread_concurrency的使用，也给出了一些建议，如下： 如果一个工作负载中，并发用户线程的数量小于64，建议设置innodb_thread_concurrency=0； 如果工作负载一直较为严重甚至偶尔达到顶峰，建议先设置innodb_thread_concurrency=128， 并通过不断的降低这个参数，96, 80, 64等等，直到发现能够提供最佳性能的线程数， 例如，假设系统通常有40到50个用户，但定期的数量增加至60，70，甚至200。你会发现， 性能在80个并发用户设置时表现稳定，如果高于这个数，性能反而下降。在这种情况下， 建议设置innodb_thread_concurrency参数为80，以避免影响性能。 如果你不希望InnoDB使用的虚拟CPU数量比用户线程使用的虚拟CPU更多（比如20个虚拟CPU）， 建议通过设置innodb_thread_concurrency 参数为这个值（也可能更低，这取决于性能体现）， 如果你的目标是将MySQL与其他应用隔离，你可以l考虑绑定mysqld进程到专有的虚拟CPU。 但是需 要注意的是，这种绑定，在myslqd进程一直不是很忙的情况下，可能会导致非最优的硬件使用率。在这种情况下， 你可能会设置mysqld进程绑定的虚拟 CPU，允许其他应用程序使用虚拟CPU的一部分或全部。 在某些情况下，最佳的innodb_thread_concurrency参数设置可以比虚拟CPU的数量小。 定期检测和分析系统，负载量、用户数或者工作环境的改变可能都需要对innodb_thread_concurrency参数的设置进行调整。 128  —–&gt; top cpu  设置标准： 1、当前系统cpu使用情况，均不均匀 top 2、当前的连接数，有没有达到顶峰 show status like ‘threads_%’; show processlist; （3）配置方法： innodb_thread_concurrency=8 方法:   1. 看top ,观察每个cpu的各自的负载情况   2. 发现不平均,先设置参数为cpu个数,然后不断增加(一倍)这个数值   3. 一直观察top状态,直到达到比较均匀时,说明已经到位了.</p>
<p>18.3.3.14 innodb_log_buffer_size</p>
<p>此参数确定些日志文件所用的内存大小，以M为单位。缓冲区更大能提高性能，对于较大的事务，可以增大缓存大小。 innodb_log_buffer_size=128M 设定依据： 1、大事务： 存储过程调用 CALL 2、多事务</p>
<p>18.3.3.15 innodb_log_file_size = 100M *****</p>
<p>设置 ib_logfile0 ib_logfile1 此参数确定数据日志文件的大小，以M为单位，更大的设置可以提高性能. innodb_log_file_size = 100M</p>
<p>18.3.3.16 innodb_log_files_in_group = 3 *****</p>
<p>为提高性能，MySQL可以以循环方式将日志文件写到多个文件。推荐设置为3</p>
<p>18.3.3.17 read_buffer_size = 1M **</p>
<p>MySql读入缓冲区大小。对表进行顺序扫描的请求将分配一个读入缓冲区，MySql会为它分配一段内存缓冲区。如果对表的顺序扫描请求非常频繁，并且你认为频繁扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能。和 sort_buffer_size一样，该参数对应的分配内存也是每个连接独享</p>
<p>18.3.3.18 bulk_insert_buffer_size = 8M **</p>
<p>批量插入数据缓存大小，可以有效提高插入效率，默认为8M tokuDB  percona myrocks  RocksDB TiDB MongoDB</p>
<p>18.3.3.19 binary log *****</p>
<p>log-bin=/data/mysql-bin binlog_cache_size = 2M //为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存, 提高记录bin-log的效率。没有什么大事务，dml也不是很频繁的情况下可以设置小一点，如果事务大而且多，dml操作也频繁，则可以适当的调大一点。前者建议是–1M，后者建议是：即 2–4M max_binlog_cache_size = 8M //表示的是binlog 能够使用的最大cache 内存大小 max_binlog_size= 512M //指定binlog日志文件的大小，如果当前的日志大小达到max_binlog_size，还会自动创建新的二进制日志。你不能将该变量设置为大于1GB或小于4096字节。默认值是1GB。在导入大容量的sql文件时，建议关闭sql_log_bin，否则硬盘扛不住，而且建议定期做删除。 expire_logs_days = 7 //定义了mysql清除过期日志的时间。 二进制日志自动删除的天数。默认值为0,表示“没有自动删除”。 log-bin=/data/mysql-bin binlog_format=row sync_binlog=1 双1标准(基于安全的控制)： sync_binlog=1  什么时候刷新binlog到磁盘，每次事务commit innodb_flush_log_at_trx_commit=1 set sql_log_bin=0; show status like ‘com_%’;</p>
<p>18.3.3.20 安全参数 *****</p>
<p>Innodb_flush_method=(O_DIRECT, fsync) 1、fsync  ： （1）在数据页需要持久化时，首先将数据写入OS buffer中，然后由os决定什么时候写入磁盘 （2）在redo buffuer需要持久化时，首先将数据写入OS buffer中，然后由os决定什么时候写入磁盘 但，如果innodb_flush_log_at_trx_commit=1的话，日志还是直接每次commit直接写入磁盘 2、 Innodb_flush_method=O_DIRECT （1）在数据页需要持久化时，直接写入磁盘 （2）在redo buffuer需要持久化时，首先将数据写入OS buffer中，然后由os决定什么时候写入磁盘 但，如果innodb_flush_log_at_trx_commit=1的话，日志还是直接每次commit直接写入磁盘 最安全模式： innodb_flush_log_at_trx_commit=1 innodb_flush_method=O_DIRECT 最高性能模式： innodb_flush_log_at_trx_commit=0 innodb_flush_method=fsync     一般情况下，我们更偏向于安全。 “双一标准” innodb_flush_log_at_trx_commit=1    *************** sync_binlog=1                  *************** innodb_flush_method=O_DIRECT</p>
<p>18.3.4 参数优化结果</p>
<p>[mysqld] basedir=/data/mysql datadir=/data/mysql/data socket=/tmp/mysql.sock log-error=/var/log/mysql.log log_bin=/data/binlog/mysql-bin binlog_format=row skip-name-resolve server-id=52 gtid-mode=on enforce-gtid-consistency=true log-slave-updates=1 relay_log_purge=0 max_connections=1024 back_log=128 wait_timeout=60 interactive_timeout=7200 key_buffer_size=16M query_cache_size=64M query_cache_type=1 query_cache_limit=50M max_connect_errors=20 sort_buffer_size=2M max_allowed_packet=32M join_buffer_size=2M thread_cache_size=200 innodb_buffer_pool_size=1024M innodb_flush_log_at_trx_commit=1 innodb_log_buffer_size=32M innodb_log_file_size=128M innodb_log_files_in_group=3 binlog_cache_size=2M max_binlog_cache_size=8M max_binlog_size=512M expire_logs_days=7 read_buffer_size=2M read_rnd_buffer_size=2M bulk_insert_buffer_size=8M [client] socket=/tmp/mysql.sock </p>
<p>再次压力测试 ： mysqlslap –defaults-file=/etc/my.cnf –concurrency=100 –iterations=1 –create-schema=’oldboy’ –query=”select * from oldboy.t_100w where k2=’FGCD’” engine=innodb –number-of-queries=200000 -uroot -p123 -verbose</p>
<p>18.3.5 锁的监控及处理</p>
<p>18.3.5.1 锁等待模拟</p>
<p>概念： Record Lock Next Lock GAP Lock X IX S IS</p>
<p>tx1:</p>
<p>USE oldboy UPDATE t_100w SET k1=’av’ WHERE id=10; ## tx2: USE oldboy UPDATE t_100w SET k1=’az’ WHERE id=10;</p>
<p>18.3.5.2 监控锁状态（监控所问题步骤）</p>
<p><img src="file:///C:\Users\kinci\AppData\Local\Temp\ksohtml\wps37D8.tmp.png" srcset="/blog/img/loading.gif" alt="img"> </p>
<p>## 1. 看有没有锁等待（监控有没有锁等待）***** SHOW STATUS LIKE ‘innodb_row_lock%’;</p>
<p>Innodb_row_lock_current_waits    ：当前有多少锁等待</p>
<p>Innodb_row_lock_waits    ：一共发生过多少锁等待 ## 2. 查看哪个事务在等待(被阻塞了)*** USE information_schema SELECT * FROM information_schema.INNODB_TRX WHERE trx_state=’LOCK WAIT’;</p>
<p>SELECT</p>
<p> trx_id,trx_state,</p>
<p>trx_mysql_thread_id,</p>
<p>trx_query</p>
<p> FROM information_schema.INNODB_TRX WHERE trx_state=’LOCK WAIT’; trx_id : 事务ID号 trx_state : 当前事务的状态 trx_mysql_thread_id:连接层的,连接线程ID(SHOW PROCESSLIST ===&gt;Id或trx_id ) trx_query : 当前被阻塞的操作(一般是要丢给开发的)</p>
<p>18.3.5.3 查看锁源,谁锁的我! ******</p>
<p>SELECT * FROM sys.innodb_lock_waits;   ## ====&gt;被锁的和锁定它的之间关系</p>
<p>SELECT </p>
<p>locker_table,</p>
<p>locked_type,</p>
<p>waiting_trx_id,</p>
<p>waiting_pid,</p>
<p>waiting_query,</p>
<p>waiting_lock_mode,</p>
<p>blicking_trx_id,</p>
<p>blocking_pid,</p>
<p>sql_kill_blocking_connection</p>
<p>FROM sys.innodb_lock_waits; locked_table : 哪张表出现的等待 </p>
<p>locked_type : 锁的类型(record,gaplock,nextlock)</p>
<p>waiting_trx_id: 等待的事务ID(与上个视图trx_id 对应)</p>
<p>waiting_pid  : 等待的线程ID(与上个视图trx_mysql_thread_id) waiting_query : 等待事务语句</p>
<p>waiting_lock_mode : 锁定类型（X,S） blocking_trx_id : 锁源的事务ID blocking_pid  : 锁源的线程ID</p>
<p>sql_kill_blocking_connection : 处理建议</p>
<p>18.3.5.4 根据锁原的pid，找到锁原的SQL的线程ID *****</p>
<p>SELECT * FROM performance_schema.threads WHERE processlist_id=15; ====&gt; 41</p>
<p>SELECT </p>
<p>thread_id,</p>
<p>name,</p>
<p>processlist_id</p>
<p> FROM performance_schema.threads WHERE processlist_id=15;</p>
<p>18.3.5.5找到锁源的SQL语句 *****</p>
<p>– 当前在执行的语句 SELECT * FROM performance_schema.<code>events_statements_current</code> WHERE thread_id=41;</p>
<p>SELECT </p>
<p>thread_id,</p>
<p>event_name,</p>
<p>SQL_text</p>
<p> FROM performance_schema.<code>events_statements_current</code> WHERE thread_id=41; – 执行语句的历史 SELECT * FROM performance_schema.<code>events_statements_history</code> WHERE thread_id=41; 得出结果,丢给开发 表信息 被阻塞的 锁源SQL</p>
<p>18.3.5.5 优化项目:锁的监控及处理</p>
<p>\1. 背景: 硬件环境: DELL R720,E系列16核,48G MEM,SAS<em>900G</em>6,RAID10 在例行巡检时,发现9-11点时间段的CPU压力非常高(80-90%) 2. 项目的职责   2.1 通过top详细排查,发现mysqld进程占比达到了700-800%   2.2 其中有量的CPU是被用作的SYS和WAIT,us处于正常   2.3 怀疑是MySQL 锁 或者SQL语句出了问题   2.4 经过排查slowlog及锁等待情况,发现有大量锁等待及少量慢语句     (1) pt-query-diagest 查看慢日志    (2) 锁等待有没有?   db03 [(none)]&gt;show status like ‘innodb_row_lock%’;   +——————————-+——-+   | Variable_name         | Value |   +——————————-+——-+   | Innodb_row_lock_current_waits | 0   |   | Innodb_row_lock_time     | 0   |   | Innodb_row_lock_time_avg   | 0   |   | Innodb_row_lock_time_max   | 0   |   | Innodb_row_lock_waits     | 0   |   +——————————-+——-+   情况一:       有100多个current_waits,说明当前很多锁等待情况   情况二:       1000多个lock_waits,说明历史上发生过的锁等待很多   2.5 查看那个事务在等待(被阻塞了)   2.6 查看锁源事务信息(谁锁的我)   2.7 找到锁源的thread_id   2.8 找到锁源的SQL语句 3. 找到语句之后,和应用开发人员进行协商    (1)   开发人员描述,此语句是事务挂起导致   我们提出建议是临时kill 会话,最终解决问题   (2)   开发人员查看后,发现是业务逻辑问题导致的死锁,产生了大量锁等待   临时解决方案,将阻塞事务的会话kill掉.   最终解决方案,修改代码中的业务逻辑 项目结果:   经过排查处理,锁等待的个数减少80%.解决了CPU持续峰值的问题.   锁监控设计到的命令: show status like ‘innodb_rows_lock%’ select * from information_schema.innodb_trx; select * from sys.innodb_lock_waits; select * from performance_schema.threads; select * from performance_schema.events_statements_current; select * from performance_schema.events_statements_history;</p>
<p>18.3.5.6 死锁监控</p>
<p>show engine innodb status\G show variables like ‘%deadlock%’; vim /etc/my.cnf innodb_print_all_deadlocks = 1 </p>
<p>18.3.5.7 主从优化：</p>
<p>## 5.7 从库多线程MTS 基本要求: 5.7以上的版本(忘记小版本) 必须开启GTID binlog必须是row模式  gtid_mode=ON enforce_gtid_consistency=ON log_slave_updates=ON slave-parallel-type=LOGICAL_CLOCK     slave-parallel-workers=16 master_info_repository=TABLE relay_log_info_repository=TABLE relay_log_recovery=ON 5.7 : slave-parallel-type=LOGICAL_CLOCK slave-parallel-workers=8 cpu核心数作为标准 CHANGE MASTER TO  MASTER_HOST=’10.0.0.128’,  MASTER_USER=’repl’,  MASTER_PASSWORD=’123’,  MASTER_PORT=3307,  MASTER_AUTO_POSITION=1; start slave;</p>
<p>=============================================================================</p>
<p>十九、MongoDB 核心技术（运维篇）</p>
<p>19.1：逻辑结构</p>
<p>Mongodb 逻辑结构                MySQL逻辑结构</p>
<p>库（database）                            库</p>
<p>集合（collection）                            表</p>
<p>文档（document）                            数据行</p>
<p>选择之所以叫选择,肯定是痛苦的!</p>
<p>——-&gt;oldguo </p>
<p>19.2 安装部署</p>
<p>19.2.1 系统准备</p>
<p>（1）redhat或cnetos6.2以上系统</p>
<p>（2）系统开发包完整</p>
<p>（3）ip地址和hosts文件解析正常</p>
<p>（4）iptables防火墙&amp;SElinux关闭</p>
<p>（5）关闭大页内存机制</p>
<p>########################################################################</p>
<p>root用户下</p>
<p>在vi /etc/rc.local最后添加如下代码</p>
<p>if test -f /sys/kernel/mm/transparent_hugepage/enabled; then</p>
<p> echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</p>
<p>fi</p>
<p>if test -f /sys/kernel/mm/transparent_hugepage/defrag; then</p>
<p>  echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</p>
<p>fi</p>
<p>​        </p>
<p>echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled        </p>
<p>echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag    </p>
<p>-—————————————————————————————————————————</p>
<p>其他系统关闭参照官方文档：    </p>
<p><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/tutorial/transparent-huge-pages/">https://docs.mongodb.com/manual/tutorial/transparent-huge-pages/</a></p>
<p>-————–</p>
<p>为什么要关闭？</p>
<p>Transparent Huge Pages (THP) is a Linux memory management system </p>
<p>that reduces the overhead of Translation Lookaside Buffer (TLB) </p>
<p>lookups on machines with large amounts of memory by using larger memory pages.</p>
<p>However, database workloads often perform poorly with THP, </p>
<p>because they tend to have sparse rather than contiguous memory access patterns. </p>
<p>You should disable THP on Linux machines to ensure best performance with MongoDB.</p>
<p>############################################################################</p>
<p>修改 vim /etc/security/limits.conf</p>
<p>#*        -    nofile     65535</p>
<p>-————————————————————-</p>
<p>19.2.2 mongodb安装</p>
<p>（1）创建所需用户和组</p>
<p>useradd mongod</p>
<p>passwd mongod</p>
<p>（2）创建mongodb所需目录结构</p>
<p>​    mkdir -p /mongodb/conf</p>
<p>​    mkdir -p /mongodb/log</p>
<p>​    mkdir -p /mongodb/data</p>
<p>（3）上传并解压软件到指定位置</p>
<p>上传到：</p>
<p>cd  /server/tools/</p>
<p>解压：</p>
<p>tar xf mongodb-linux-x86_64-rhel70-3.2.16.tgz</p>
<p>拷贝目录下bin程序到/mongodb/bin</p>
<p>cp -a /server/tools/mongodb-linux-x86_64-rhel70-3.2.16/bin/ /mongodb/</p>
<p>（4）设置目录结构权限</p>
<p>chown -R mongod:mongod /mongodb</p>
<p>（5）设置用户环境变量</p>
<p>su - mongod</p>
<p>vi .bash_profile</p>
<p>export PATH=/mongodb/bin:$PATH</p>
<p>source .bash_profile</p>
<p>（6）启动mongodb</p>
<p>su - mongod </p>
<p>mongod –dbpath=/mongodb/data –logpath=/mongodb/log/mongodb.log –port=27017 –logappend –fork </p>
<p>（7）登录mongodb</p>
<p>[mongod@server2 ~]$ mongo</p>
<p>注：连接之后会有warning，需要修改(使用root用户)</p>
<p>vim /etc/security/limits.conf </p>
<p>#*    -    nofile    65535 </p>
<p>reboot重启生效</p>
<p>（8）使用配置文件（以后的趋势会放弃使用这种格式）</p>
<p>vim /mongodb/conf/mongodb.conf</p>
<p>logpath=/mongodb/log/mongodb.log</p>
<p>dbpath=/mongodb/data </p>
<p>port=27017</p>
<p>logappend=true</p>
<p>fork=true</p>
<p>+++++++++++++++++++</p>
<p>关闭mongodb</p>
<p>mongod -f /mongodb/conf/mongodb.conf –shutdown</p>
<p>使用配置文件启动mongodb</p>
<p>mongod -f /mongodb/conf/mongodb.conf</p>
<p>（YAML模式：）</p>
<p>--</p>
<p>NOTE：</p>
<p>YAML does not support tab characters for indentation: use spaces instead.</p>
<p>–系统日志有关 </p>
<p>systemLog:</p>
<p>  destination: file    </p>
<p>  path: “/mongodb/log/mongodb.log”  –日志位置</p>
<p>  logAppend: true                      –日志以追加模式记录</p>
<p>–数据存储有关  </p>
<p>storage:</p>
<p>  journal:</p>
<p>   enabled: true</p>
<p>  dbPath: “/mongodb/data”      –数据路径的位置</p>
<p>– 进程控制 </p>
<p>processManagement:</p>
<p>  fork: true             –后台守护进程</p>
<p>  pidFilePath: <string>             –pid文件的位置，一般不用配置，可以去掉这行，自动生成到data中</p>
<p>–网络配置有关  </p>
<p>net:            </p>
<p>  bindIp: <ip>            – 监听地址，如果不配置这行是监听在0.0.0.0</p>
<p>  port: <port>                         – 端口号,默认不配置端口号，是27017</p>
<p>– 安全验证有关配置   </p>
<p>security:</p>
<p> authorization: enabled       –是否打开用户名密码验证</p>
<p>——————以下是复制集与分片集群有关———————- </p>
<p>replication:</p>
<p> oplogSizeMB: <NUM></p>
<p> replSetName: “<REPSETNAME>“</p>
<p> secondaryIndexPrefetch: “all”</p>
<p>sharding:</p>
<p>  clusterRole: <string></p>
<p>  archiveMovedChunks: <boolean></p>
<p>—for mongos only</p>
<p>replication:</p>
<p>  localPingThresholdMs: <int></p>
<p>sharding:</p>
<p>  configDB: <string></p>
<p>-–</p>
<p>………</p>
<p>++++++++++++++++++++++</p>
<p>YAML例子</p>
<p>cat &gt; /mongodb/conf/mongo.conf &lt;&lt;EOF</p>
<p>systemLog:</p>
<p>  destination: file</p>
<p>  path: “/mongodb/log/mongodb.log”</p>
<p>  logAppend: true</p>
<p>storage:</p>
<p>  journal:</p>
<p>   enabled: true</p>
<p>  dbPath: “/mongodb/data/“</p>
<p>processManagement:</p>
<p>  fork: true</p>
<p>net:</p>
<p>  port: 27017</p>
<p>  bindIp: 192.168.27.11,127.0.0.1</p>
<p>EOF</p>
<p>mongod -f /mongodb/conf/mongo.conf –shutdown    （关闭）</p>
<p>mongod -f /mongodb/conf/mongo.conf （启动）</p>
<p>（9）mongodb的关闭方式</p>
<p>mongod -f mongodb.conf –shutdown</p>
<p>(10) systemd 管理(root)</p>
<p>[root@db01 ~]# cat &gt; /etc/systemd/system/mongod.service &lt;&lt;EOF</p>
<p>[Unit]</p>
<p>Description=mongodb </p>
<p>After=network.target remote-fs.target nss-lookup.target</p>
<p>[Service]</p>
<p>User=mongod</p>
<p>Type=forking</p>
<p>ExecStart=/mongodb/bin/mongod –config /mongodb/conf/mongo.conf</p>
<p>ExecReload=/bin/kill -s HUP $MAINPID</p>
<p>ExecStop=/mongodb/bin/mongod –config /mongodb/conf/mongo.conf –shutdown</p>
<p>PrivateTmp=true </p>
<p>[Install]</p>
<p>WantedBy=multi-user.target</p>
<p>EOF</p>
<p>[root@db01 ~]# systemctl restart mongod</p>
<p>[root@db01 ~]# systemctl stop mongod</p>
<p>[root@db01 ~]# systemctl start mongod</p>
<p>19.3 mongodb常用基本操作</p>
<p>19.3.0 mongodb 默认存在的库</p>
<p>&gt; show databases;</p>
<p>admin  0.000GB</p>
<p>config 0.000GB</p>
<p>local  0.000GB</p>
<p>19.3.1 命令种类</p>
<p>数据库对象(库(database),表(collection),行(document))</p>
<p>db.命令:</p>
<p>DB级别命令</p>
<p>db    当前在的库</p>
<p>db.[TAB] 类似于linux中的tab功能</p>
<p>db.help() db级别的命令使用帮助</p>
<p>-———————————————————————–</p>
<p>collection级别操作:</p>
<p>db.Collection_name.xxx</p>
<p>-———————————————————————-</p>
<p>document级别操作:</p>
<p>db.t1.insert()</p>
<p>-———————————————————————-</p>
<p>复制集有关(replication set):</p>
<p>rs.</p>
<p>-———————————————————————-</p>
<p>分片集群(sharding cluster)</p>
<p>sh.</p>
<p>-———————————————————————-</p>
<p>19.3.2 帮助</p>
<p>help</p>
<p>KEYWORDS.help()</p>
<p>KEYWORDS.[TAB]</p>
<p>show </p>
<p>use </p>
<p>db.help()</p>
<p>db.a.help()</p>
<p>rs.help()</p>
<p>sh.help()</p>
<p>19.3.3 常用操作</p>
<p>–查看当前db版本</p>
<p>test&gt; db.version()</p>
<p>–显示当前数据库</p>
<p>test&gt; db</p>
<p>test</p>
<p>或</p>
<p>&gt; db.getName()</p>
<p>test</p>
<p>–查询所有数据库</p>
<p>test&gt; show dbs</p>
<p>– 切换数据库</p>
<p>&gt; use local</p>
<p>switched to db local</p>
<p>- 查看所有的collection</p>
<p>show tables;</p>
<p>– 显示当前数据库状态</p>
<p>test&gt; use local</p>
<p>switched to db local</p>
<p>local&gt; db.stats()</p>
<p>– 查看当前数据库的连接机器地址</p>
<p>&gt; db.getMongo()</p>
<p>connection to 127.0.0.1</p>
<p>指定数据库进行连接</p>
<p>默认连接本机test数据库</p>
<p>19.4 mongodb对象操作：</p>
<p>mongo     mysql</p>
<p>库  —–&gt; 库</p>
<p>集合 —–&gt; 表</p>
<p>文档 —–&gt; 数据行</p>
<p>19.4.1库的操作：</p>
<p>– 创建数据库：</p>
<p>当use的时候，系统就会自动创建一个数据库。</p>
<p>如果use之后没有创建任何集合。</p>
<p>系统就会删除这个数据库。</p>
<p>– 删除数据库</p>
<p>如果没有选择任何数据库，会删除默认的test数据库</p>
<p>//删除test数据库</p>
<p>test&gt; show dbs</p>
<p>local 0.000GB</p>
<p>test 0.000GB</p>
<p>test&gt; use test</p>
<p>switched to db test</p>
<p>test&gt; db.dropDatabase()  </p>
<p>{ “dropped” : “test”, “ok” : 1 }</p>
<p>集合的操作：</p>
<p> 创建集合</p>
<p>方法1</p>
<p>admin&gt; use app</p>
<p>switched to db app</p>
<p>app&gt; db.createCollection(‘a’)</p>
<p>{ “ok” : 1 }</p>
<p>app&gt; db.createCollection(‘b’)</p>
<p>{ “ok” : 1 }</p>
<p>&gt; show collections //查看当前数据下的所有集合</p>
<p>a b 或</p>
<p>&gt; db.getCollectionNames()</p>
<p>[ “a”, “b” ]</p>
<p>方法2：当插入一个文档的时候，一个集合就会自动创建。</p>
<p>{id : “101” ,name : “zhangsan” ,age : “18” ,gender : “male”}</p>
<p>use oldboy</p>
<p>db.oldguo.insert({id : “1021” ,name : “zhssn” ,age : “22” ,gender : “female”,address : “sz”})</p>
<p>&gt; db.oldguo.find({id:”101”})</p>
<p>{ “_id” : ObjectId(“5d36b8b6e62adeeaf0de00dc”), “id” : “101”, “name” : “zhangsan”, “age” : “18”, “gender” : “male” }</p>
<p>查询数据:</p>
<p>&gt; db.oldguo.find({id:”101”}).pretty()</p>
<p>{</p>
<p>​    “_id” : ObjectId(“5d36b8b6e62adeeaf0de00dc”),</p>
<p>​    “id” : “101”,</p>
<p>​    “name” : “zhangsan”,</p>
<p>​    “age” : “18”,</p>
<p>​    “gender” : “male”</p>
<p>}</p>
<p>&gt; db.oldguo.find().pretty()</p>
<p>{</p>
<p>​    “_id” : ObjectId(“5d36b8b6e62adeeaf0de00dc”),</p>
<p>​    “id” : “101”,</p>
<p>​    “name” : “zhangsan”,</p>
<p>​    “age” : “18”,</p>
<p>​    “gender” : “male”</p>
<p>}</p>
<p>{</p>
<p>​    “_id” : ObjectId(“5d36b8eae62adeeaf0de00dd”),</p>
<p>​    “id” : “1021”,</p>
<p>​    “name” : “zhssn”,</p>
<p>​    “age” : “22”,</p>
<p>​    “gender” : “female”,</p>
<p>​    “address” : “sz”</p>
<p>}</p>
<p>{</p>
<p>​    “_id” : ObjectId(“5d36b913e62adeeaf0de00de”),</p>
<p>​    “name” : “ls”,</p>
<p>​    “address” : “bj”,</p>
<p>​    “telnum” : “110”</p>
<p>}</p>
<p>&gt; </p>
<p>删除集合</p>
<p>app&gt; use app</p>
<p>switched to db app</p>
<p>app&gt; db.log.drop() //删除集合</p>
<p>– 重命名集合</p>
<p>//把log改名为log1</p>
<p>app&gt; db.log.renameCollection(“log1”)</p>
<p>{ “ok” : 1 }</p>
<p>app&gt; show collections</p>
<p>a b c</p>
<p>log1</p>
<p>app</p>
<p>批量插入数据</p>
<p>for(i=0;i&lt;10000;i++){db.log.insert({“uid”:i,”name”:”mongodb”,”age”:6,”date”:new</p>
<p>Date()})}</p>
<p>Mongodb数据查询语句:</p>
<p>– 查询集合中的记录数</p>
<p>app&gt; db.log.find() //查询所有记录</p>
<p>注：默认每页显示20条记录，当显示不下的的情况下，可以用it迭代命令查询下一页数据。</p>
<p>设置每页显示数据的大小：</p>
<p>&gt; DBQuery.shellBatchSize=50; //每页显示50条记录</p>
<p>app&gt; db.log.findOne() //查看第1条记录</p>
<p>app&gt; db.log.count() //查询总的记录数</p>
<p>– 删除集合中的记录数</p>
<p>app&gt; db.log.remove({}) //删除集合中所有记录</p>
<p>&gt; db.log.distinct(“name”) //查询去掉当前集合中某列的重复数据</p>
<p>– 查看集合存储信息</p>
<p>app&gt; db.log.stats()</p>
<p>app&gt; db.log.dataSize() //集合中数据的原始大小</p>
<p>app&gt; db.log.totalIndexSize() //集合中索引数据的原始大小</p>
<p>app&gt; db.log.totalSize() //集合中索引+数据压缩存储之后的大小  *****</p>
<p>app&gt; db.log.storageSize() //集合中数据压缩存储的大小</p>
<p>19.5 用户管理 *****</p>
<p>注意：</p>
<p>验证库，建立用户时use到的库，在使用用户时，要加上验证库才能登陆。</p>
<p>对于管理员用户,必须在admin下创建.</p>
<p>\1. 建用户时,use到的库,就是此用户的验证库</p>
<p>\2. 登录时,必须明确指定验证库才能登录</p>
<p>\3. 通常,管理员用的验证库是admin,普通用户的验证库一般是所管理的库设置为验证库</p>
<p>\4. 如果直接登录到数据库,不进行use,默认的验证库是test,不是我们生产建议的.</p>
<p>use admin </p>
<p>mongo 10.0.0.51/admin</p>
<p>db.createUser</p>
<p>{</p>
<p>  user: “<name>“,</p>
<p>  pwd: “<cleartext password>“,</p>
<p>  roles: [</p>
<p>​    { role: “<role>“,</p>
<p>   db: “<database>“ } | “<role>“,</p>
<p>  …</p>
<p>  ]</p>
<p>}</p>
<p>基本语法说明：</p>
<p>user:用户名</p>
<p>pwd:密码</p>
<p>roles:</p>
<p>  role:角色名</p>
<p>  db:作用对象    </p>
<p>role：root, readWrite,read  </p>
<p>验证数据库：</p>
<p>mongo -u oldboy -p 123 10.0.0.51/oldboy</p>
<p>-————</p>
<p>用户管理例子：</p>
<p>– 1. 创建超级管理员：管理所有数据库（必须use admin再去创建） *****</p>
<p>$ mongo</p>
<p>use admin</p>
<p>db.createUser(</p>
<p>{</p>
<p>  user: “root”,</p>
<p>  pwd: “root123”,</p>
<p>  roles: [ { role: “root”, db: “admin” } ]</p>
<p>}</p>
<p>)</p>
<p>验证用户</p>
<p>db.auth(‘root’,’root123’)</p>
<p>配置文件中，加入以下配置</p>
<p>security:</p>
<p> authorization: enabled</p>
<p>重启mongodb</p>
<p>mongod -f /mongodb/conf/mongo.conf –shutdown </p>
<p>mongod -f /mongodb/conf/mongo.conf </p>
<p>登录验证</p>
<p>mongo -uroot -proot123 admin</p>
<p>mongo -uroot -proot123 10.0.0.51/admin</p>
<p>或者</p>
<p>mongo</p>
<p>use admin</p>
<p>db.auth(‘root’,’root123’)</p>
<p>查看用户:</p>
<p>use admin</p>
<p>db.system.users.find().pretty()</p>
<p>==================</p>
<p>– 2、创建库管理用户</p>
<p>mongo -uroot -proot123 admin</p>
<p>use app</p>
<p>db.createUser(</p>
<p>{</p>
<p>user: “admin”,</p>
<p>pwd: “admin”,</p>
<p>roles: [ { role: “dbAdmin”, db: “app” } ]</p>
<p>}</p>
<p>)</p>
<p>db.auth(‘admin’,’admin’)</p>
<p>登录测试</p>
<p>mongo -uadmin -padmin 10.0.0.51/app</p>
<p>– 3、创建对app数据库，读、写权限的用户app01 *****</p>
<p>（1）超级管理员用户登陆</p>
<p>mongo -uroot -proot123 admin</p>
<p>（2）选择一个验证库</p>
<p>use app</p>
<p>(3)创建用户</p>
<p>db.createUser(</p>
<p>​    {</p>
<p>​        user: “app01”,</p>
<p>​        pwd: “app01”,</p>
<p>​        roles: [ { role: “readWrite” , db: “app” } ]</p>
<p>​    }</p>
<p>)</p>
<p>mongo -uapp01 -papp01 10.0.0.51/app</p>
<p>– 4、创建app数据库读写权限的用户并对test数据库具有读权限：</p>
<p>mongo -uroot -proot123 10.0.0.51/admin</p>
<p>use app</p>
<p>db.createUser(</p>
<p>{</p>
<p>user: “app03”,</p>
<p>pwd: “app03”,</p>
<p>roles: [ { role: “readWrite”, db: “app” },</p>
<p>{ role: “read”, db: “test” }]})</p>
<p>– 5、查询mongodb中的用户信息</p>
<p>mongo -uroot -proot123 10.0.0.51/admin</p>
<p>db.system.users.find().pretty()</p>
<p>{</p>
<p>​    “_id” : “admin.root”,</p>
<p>​    “user” : “root”,</p>
<p>​    “db” : “admin”,</p>
<p>​    “credentials” : {</p>
<p>​        “SCRAM-SHA-1” : {</p>
<p>​            “iterationCount” : 10000,</p>
<p>​            “salt” : “HsSHIKBQyMnFEzA/PSURYA==”,</p>
<p>​            “storedKey” : “dbOoQserGa/fB+JQyLqr1yXQZBM=”,</p>
<p>​            “serverKey” : “h+b/vARfWp6cmDquUN6bJo4whdc=”</p>
<p>​        }</p>
<p>​    },</p>
<p>​    “roles” : [</p>
<p>​        {</p>
<p>​            “role” : “root”,</p>
<p>​            “db” : “admin”</p>
<p>​        }</p>
<p>​    ]</p>
<p>}</p>
<p>– 6、删除用户（root身份登录，use到验证库）</p>
<p>删除用户</p>
<p># mongo -uroot -proot123 10.0.0.51/admin</p>
<p>use app</p>
<p>db.dropUser(“app01”)</p>
<p>19.6 MongoDB复制集RS（ReplicationSet）******</p>
<p>19.6.1 基本原理</p>
<p>基本构成是1主2从的结构，自带互相监控投票机制（Raft（MongoDB） Paxos（mysql MGR 用的是变种））</p>
<p>如果发生主库宕机，复制集内部会进行投票选举，选择一个新的主库替代原有主库对外提供服务。同时复制集会自动通知</p>
<p>客户端程序，主库已经发生切换了。应用就会连接到新的主库。</p>
<p>MongoDB节点不能多用，一个节点只能出现在一个复制集当中</p>
<p>19.6.2 Replication Set配置过程详解</p>
<p>19.6.2.1 规划</p>
<p>三个以上的mongodb节点（或多实例）</p>
<p>19.6.2.2 环境准备</p>
<p>多个端口：</p>
<p>28017、28018、28019、28020</p>
<p>多套目录：</p>
<p>su - mongod </p>
<p>mkdir -p /mongodb/28017/conf /mongodb/28017/data /mongodb/28017/log</p>
<p>mkdir -p /mongodb/28018/conf /mongodb/28018/data /mongodb/28018/log</p>
<p>mkdir -p /mongodb/28019/conf /mongodb/28019/data /mongodb/28019/log</p>
<p>mkdir -p /mongodb/28020/conf /mongodb/28020/data /mongodb/28020/log</p>
<p>多套配置文件</p>
<p>/mongodb/28017/conf/mongod.conf</p>
<p>/mongodb/28018/conf/mongod.conf</p>
<p>/mongodb/28019/conf/mongod.conf</p>
<p>/mongodb/28020/conf/mongod.conf</p>
<p>配置文件内容:</p>
<p>cat &gt; /mongodb/28017/conf/mongod.conf &lt;&lt;EOF</p>
<p>systemLog:</p>
<p> destination: file</p>
<p> path: /mongodb/28017/log/mongodb.log</p>
<p> logAppend: true</p>
<p>storage:</p>
<p> journal:</p>
<p>  enabled: true</p>
<p> dbPath: /mongodb/28017/data</p>
<p> directoryPerDB: true</p>
<p> #engine: wiredTiger</p>
<p> wiredTiger:</p>
<p>  engineConfig:</p>
<p>   cacheSizeGB: 1</p>
<p>   directoryForIndexes: true</p>
<p>  collectionConfig:</p>
<p>   blockCompressor: zlib</p>
<p>  indexConfig:</p>
<p>   prefixCompression: true</p>
<p>processManagement:</p>
<p> fork: true</p>
<p>net:</p>
<p> bindIp: 10.0.0.51,127.0.0.1</p>
<p> port: 28017</p>
<p>replication:</p>
<p> oplogSizeMB: 2048</p>
<p> replSetName: my_repl</p>
<p>EOF</p>
<p>​    </p>
<p>\cp /mongodb/28017/conf/mongod.conf /mongodb/28018/conf/</p>
<p>\cp /mongodb/28017/conf/mongod.conf /mongodb/28019/conf/</p>
<p>\cp /mongodb/28017/conf/mongod.conf /mongodb/28020/conf/</p>
<p>sed ‘s#28017#28018#g’ /mongodb/28018/conf/mongod.conf -i</p>
<p>sed ‘s#28017#28019#g’ /mongodb/28019/conf/mongod.conf -i</p>
<p>sed ‘s#28017#28020#g’ /mongodb/28020/conf/mongod.conf -i</p>
<p>启动多个实例备用:</p>
<p>mongod -f /mongodb/28017/conf/mongod.conf</p>
<p>mongod -f /mongodb/28018/conf/mongod.conf</p>
<p>mongod -f /mongodb/28019/conf/mongod.conf</p>
<p>mongod -f /mongodb/28020/conf/mongod.conf</p>
<p>netstat -lnp|grep 280</p>
<p>19.6.3 配置普通复制集：</p>
<p>1主2从，从库普通从库</p>
<p>mongo –port 28017 admin</p>
<p>config = {_id: ‘my_repl’, members: [</p>
<p>​             {_id: 0, host: ‘192.168.27.11:28017’},</p>
<p>​             {_id: 1, host: ‘192.168.27.11:28018’},</p>
<p>​             {_id: 2, host: ‘192.168.27.11:28019’}]</p>
<p>​     }  </p>
<p>​         </p>
<p>rs.initiate(config) （复制级初始化密码）</p>
<p>查询复制集状态</p>
<p>rs.status();</p>
<p>19.6.4 1主1从1个arbiter</p>
<p>mongo -port 28017 admin</p>
<p>config = {_id: ‘my_repl’, members: [</p>
<p>​             {_id: 0, host: ‘10.0.0.51:28017’},</p>
<p>​             {_id: 1, host: ‘10.0.0.51:28018’},</p>
<p>​             {_id: 2, host: ‘10.0.0.51:28019’,”arbiterOnly”:true}]</p>
<p>​     }        </p>
<p>rs.initiate(config) </p>
<p>19.6.5 复制集管理操作</p>
<p>19.6.5.1 查看复制集状态</p>
<p>rs.status();  //查看整体复制集状态</p>
<p>rs.isMaster(); // 查看当前是否是主节点</p>
<p>rs.conf();  //查看复制集配置信息</p>
<p>19.6.5.2 添加删除节点</p>
<p>rs.remove(“ip:port”); // 删除一个节点</p>
<p>rs.add(“ip:port”); // 新增从节点</p>
<p>rs.addArb(“ip:port”); // 新增仲裁节点</p>
<p>例子：</p>
<p>添加 arbiter节点</p>
<p>1、连接到主节点</p>
<p>[mongod@db03 ~]$ mongo –port 28018 admin</p>
<p>2、添加仲裁节点</p>
<p>my_repl:PRIMARY&gt; rs.addArb(“10.0.0.53:28020”)</p>
<p>3、查看节点状态</p>
<p>my_repl:PRIMARY&gt; rs.isMaster()</p>
<p>{</p>
<p>  “hosts” : [</p>
<p>​    “10.0.0.53:28017”,</p>
<p>​    “10.0.0.53:28018”,</p>
<p>​    “10.0.0.53:28019”</p>
<p>  ],</p>
<p>  “arbiters” : [</p>
<p>​    “10.0.0.53:28020”</p>
<p>  ],</p>
<p>rs.remove(“ip:port”); // 删除一个节点</p>
<p>例子：</p>
<p>my_repl:PRIMARY&gt; rs.remove(“10.0.0.53:28019”);</p>
<p>{ “ok” : 1 }</p>
<p>my_repl:PRIMARY&gt; rs.isMaster()</p>
<p>rs.add(“ip:port”); // 新增从节点</p>
<p>例子：</p>
<p>my_repl:PRIMARY&gt; rs.add(“10.0.0.53:28019”)</p>
<p>{ “ok” : 1 }</p>
<p>my_repl:PRIMARY&gt; rs.isMaster()</p>
<p>19.6.5.3 特殊从节点</p>
<p>介绍：</p>
<p>arbiter节点：主要负责选主过程中的投票，但是不存储任何数据，也不提供任何服务</p>
<p>hidden节点：隐藏节点，不参与选主，也不对外提供服务。</p>
<p>delay节点：延时节点，数据落后于主库一段时间，因为数据是延时的，也不应该提供服务或参与选主，所以通常会配合hidden（隐藏）</p>
<p>一般情况下会将delay+hidden一起配置使用</p>
<p>配置延时节点（一般延时节点也配置成hidden）</p>
<p>cfg=rs.conf() </p>
<p>cfg.members[3].priority=0</p>
<p>cfg.members[3].hidden=true</p>
<p>cfg.members[3].slaveDelay=120</p>
<p>rs.reconfig(cfg)  </p>
<p>其中members[]的中括号的数字是根据rs.conf的members中数出来的，跟id无关</p>
<p>无需重启</p>
<p>取消以上配置</p>
<p>cfg=rs.conf() </p>
<p>cfg.members[2].priority=1</p>
<p>cfg.members[2].hidden=false</p>
<p>cfg.members[2].slaveDelay=0</p>
<p>rs.reconfig(cfg)  </p>
<p>配置成功后，通过以下命令查询配置后的属性</p>
<p>rs.conf(); </p>
<p>19.6.5.4 副本集其他操作命令</p>
<p>查看副本集的配置信息</p>
<p>admin&gt; rs.conf()</p>
<p>查看副本集各成员的状态</p>
<p>admin&gt; rs.status()</p>
<p>++++++++++++++++++++++++++++++++++++++++++++++++</p>
<p>–副本集角色切换（不要人为随便操作）</p>
<p>admin&gt; rs.stepDown()</p>
<p>注：</p>
<p>admin&gt; rs.freeze(300) //锁定从，使其不会转变成主库</p>
<p>freeze()和stepDown单位都是秒。</p>
<p>+++++++++++++++++++++++++++++++++++++++++++++</p>
<p>设置副本节点可读：在副本节点执行</p>
<p>admin&gt; rs.slaveOk()</p>
<p>eg：</p>
<p>admin&gt; use app</p>
<p>switched to db app</p>
<p>app&gt; db.createCollection(‘a’)</p>
<p>{ “ok” : 0, “errmsg” : “not master”, “code” : 10107 }</p>
<p>查看副本节点（监控主从延时）</p>
<p>admin&gt; rs.printSlaveReplicationInfo()</p>
<p>source: 192.168.1.22:27017</p>
<p>  syncedTo: Thu May 26 2016 10:28:56 GMT+0800 (CST)</p>
<p>  0 secs (0 hrs) behind the primary</p>
<p>OPlog日志（备份恢复章节）</p>
<p>19.7 MongoDB Sharding Cluster 分片集群 *****</p>
<p>19.7.1 规划：</p>
<p>10个实例：38017-38026</p>
<p>（1）configserver:</p>
<p>3台构成的复制集（1主两从，不支持arbiter）38018-38020（复制集名字configsvr）</p>
<p>（2）shard节点：</p>
<p>sh1：38021-23  （1主两从，其中一个节点为arbiter，复制集名字sh1）</p>
<p>sh2：38024-26  （1主两从，其中一个节点为arbiter，复制集名字sh2）</p>
<p>19.7.2 配置过程</p>
<p>19.7.2.1shard复制集配置：</p>
<p>（1）目录创建：</p>
<p>mkdir -p /mongodb/38021/conf /mongodb/38021/log /mongodb/38021/data</p>
<p>mkdir -p /mongodb/38022/conf /mongodb/38022/log /mongodb/38022/data</p>
<p>mkdir -p /mongodb/38023/conf /mongodb/38023/log /mongodb/38023/data</p>
<p>mkdir -p /mongodb/38024/conf /mongodb/38024/log /mongodb/38024/data</p>
<p>mkdir -p /mongodb/38025/conf /mongodb/38025/log /mongodb/38025/data</p>
<p>mkdir -p /mongodb/38026/conf /mongodb/38026/log /mongodb/38026/data</p>
<p>（2）修改配置文件：</p>
<p>sh1:</p>
<p>cat &gt; /mongodb/38021/conf/mongodb.conf&lt;&lt;EOF </p>
<p>systemLog:</p>
<p> destination: file</p>
<p> path: /mongodb/38021/log/mongodb.log  </p>
<p> logAppend: true</p>
<p>storage:</p>
<p> journal:</p>
<p>  enabled: true</p>
<p> dbPath: /mongodb/38021/data</p>
<p> directoryPerDB: true</p>
<p> #engine: wiredTiger</p>
<p> wiredTiger:</p>
<p>  engineConfig:</p>
<p>   cacheSizeGB: 1</p>
<p>   directoryForIndexes: true</p>
<p>  collectionConfig:</p>
<p>   blockCompressor: zlib</p>
<p>  indexConfig:</p>
<p>   prefixCompression: true</p>
<p>net:</p>
<p> bindIp: 192.168.27.11,127.0.0.1</p>
<p> port: 38021</p>
<p>replication:</p>
<p> oplogSizeMB: 2048</p>
<p> replSetName: sh1    （可以自己起名）</p>
<p>sharding:</p>
<p> clusterRole: shardsvr（固定名字）</p>
<p>processManagement: </p>
<p> fork: true</p>
<p>EOF</p>
<p>cp /mongodb/38021/conf/mongodb.conf /mongodb/38022/conf/</p>
<p>cp /mongodb/38021/conf/mongodb.conf /mongodb/38023/conf/</p>
<p>sed ‘s#38021#38022#g’ /mongodb/38022/conf/mongodb.conf -i</p>
<p>sed ‘s#38021#38023#g’ /mongodb/38023/conf/mongodb.conf -i</p>
<p>sh2:</p>
<p>cat &gt; /mongodb/38024/conf/mongodb.conf&lt;&lt;EOF </p>
<p>systemLog:</p>
<p> destination: file</p>
<p> path: /mongodb/38024/log/mongodb.log  </p>
<p> logAppend: true</p>
<p>storage:</p>
<p> journal:</p>
<p>  enabled: true</p>
<p> dbPath: /mongodb/38024/data</p>
<p> directoryPerDB: true</p>
<p> wiredTiger:</p>
<p>  engineConfig:</p>
<p>   cacheSizeGB: 1</p>
<p>   directoryForIndexes: true</p>
<p>  collectionConfig:</p>
<p>   blockCompressor: zlib</p>
<p>  indexConfig:</p>
<p>   prefixCompression: true</p>
<p>net:</p>
<p> bindIp: 192.168.27.11,127.0.0.1</p>
<p> port: 38024</p>
<p>replication:</p>
<p> oplogSizeMB: 2048</p>
<p> replSetName: sh2</p>
<p>sharding:</p>
<p> clusterRole: shardsvr</p>
<p>processManagement: </p>
<p> fork: true</p>
<p>EOF</p>
<p>cp /mongodb/38024/conf/mongodb.conf /mongodb/38025/conf/</p>
<p>cp /mongodb/38024/conf/mongodb.conf /mongodb/38026/conf/</p>
<p>sed ‘s#38024#38025#g’ /mongodb/38025/conf/mongodb.conf -i</p>
<p>sed ‘s#38024#38026#g’ /mongodb/38026/conf/mongodb.conf -i</p>
<p>（3）启动所有节点，并搭建复制集：</p>
<p>mongod -f /mongodb/38021/conf/mongodb.conf </p>
<p>mongod -f /mongodb/38022/conf/mongodb.conf </p>
<p>mongod -f /mongodb/38023/conf/mongodb.conf </p>
<p>mongod -f /mongodb/38024/conf/mongodb.conf </p>
<p>mongod -f /mongodb/38025/conf/mongodb.conf </p>
<p>mongod -f /mongodb/38026/conf/mongodb.conf </p>
<p>mongo –port 38021 admin</p>
<p>config = {_id: ‘sh1’, members: [</p>
<p>​             {_id: 0, host: ‘192.168.27.11:38021’},</p>
<p>​             {_id: 1, host: ‘192.168.27.11:38022’},</p>
<p>​             {_id: 2, host: ‘192.168.27.11:38023’,”arbiterOnly”:true}]</p>
<p>​      }</p>
<p>rs.initiate(config)</p>
<p>mongo –port 38024 admin</p>
<p>config = {_id: ‘sh2’, members: [</p>
<p>​             {_id: 0, host: ‘192.168.27.11:38024’},</p>
<p>​             {_id: 1, host: ‘192.168.27.11:38025’},</p>
<p>​             {_id: 2, host: ‘192.168.27.11:38026’,”arbiterOnly”:true}]</p>
<p>​      }</p>
<p>rs.initiate(config)</p>
<p>19.7.2.2 config节点配置</p>
<p>（1）目录创建：</p>
<p>mkdir -p /mongodb/38018/conf /mongodb/38018/log /mongodb/38018/data</p>
<p>mkdir -p /mongodb/38019/conf /mongodb/38019/log /mongodb/38019/data</p>
<p>mkdir -p /mongodb/38020/conf /mongodb/38020/log /mongodb/38020/data</p>
<p>（2）修改配置文件：</p>
<p>cat &gt; /mongodb/38018/conf/mongodb.conf &lt;&lt;EOF</p>
<p>systemLog:</p>
<p> destination: file</p>
<p> path: /mongodb/38018/log/mongodb.conf</p>
<p> logAppend: true</p>
<p>storage:</p>
<p> journal:</p>
<p>  enabled: true</p>
<p> dbPath: /mongodb/38018/data</p>
<p> directoryPerDB: true</p>
<p> #engine: wiredTiger</p>
<p> wiredTiger:</p>
<p>  engineConfig:</p>
<p>   cacheSizeGB: 1</p>
<p>   directoryForIndexes: true</p>
<p>  collectionConfig:</p>
<p>   blockCompressor: zlib</p>
<p>  indexConfig:</p>
<p>   prefixCompression: true</p>
<p>net:</p>
<p> bindIp: 192.168.27.11,127.0.0.1</p>
<p> port: 38018</p>
<p>replication:</p>
<p> oplogSizeMB: 2048</p>
<p> replSetName: configReplSet</p>
<p>sharding:</p>
<p> clusterRole: configsvr（固定名字）</p>
<p>processManagement: </p>
<p> fork: true</p>
<p>EOF</p>
<p>cp /mongodb/38018/conf/mongodb.conf /mongodb/38019/conf/</p>
<p>cp /mongodb/38018/conf/mongodb.conf /mongodb/38020/conf/</p>
<p>sed ‘s#38018#38019#g’ /mongodb/38019/conf/mongodb.conf -i</p>
<p>sed ‘s#38018#38020#g’ /mongodb/38020/conf/mongodb.conf -i</p>
<p>（3）启动节点，并配置复制集</p>
<p>mongod -f /mongodb/38018/conf/mongodb.conf </p>
<p>mongod -f /mongodb/38019/conf/mongodb.conf </p>
<p>mongod -f /mongodb/38020/conf/mongodb.conf </p>
<p>mongo –port 38018 admin</p>
<p>config = {_id: ‘configReplSet’, members: [</p>
<p>​             {_id: 0, host: ‘192.168.27.11:38018’},</p>
<p>​             {_id: 1, host: ‘192.168.27.11:38019’},</p>
<p>​             {_id: 2, host: ‘192.168.27.11:38020’}]</p>
<p>​      }</p>
<p>rs.initiate(config)  </p>
<p>注：configserver 可以是一个节点，官方建议复制集。configserver不能有arbiter。</p>
<p>新版本中，要求必须是复制集。</p>
<p>注：mongodb 3.4之后，虽然要求config server为replica set，但是不支持arbiter</p>
<p>19.7.2.3mongos节点配置</p>
<p>（1）创建目录：</p>
<p>mkdir -p /mongodb/38017/conf /mongodb/38017/log </p>
<p>（2）配置文件：</p>
<p>cat &gt;/mongodb/38017/conf/mongos.conf&lt;&lt;EOF</p>
<p>systemLog:</p>
<p> destination: file</p>
<p> path: /mongodb/38017/log/mongos.log</p>
<p> logAppend: true</p>
<p>net:</p>
<p> bindIp: 192.168.27.11,127.0.0.1</p>
<p> port: 38017</p>
<p>sharding:</p>
<p> configDB: configReplSet/192.168.27.11:38018,192.168.27.11:38019,192.168.27.11:38020</p>
<p>processManagement: </p>
<p> fork: true</p>
<p>EOF     </p>
<p>（3）启动mongos</p>
<p>mongos -f /mongodb/38017/conf/mongos.conf </p>
<p>19.7.3 分片集群操作：</p>
<p>连接到其中一个mongos（192.168.27.11），做以下配置</p>
<p>（1）连接到mongs的admin数据库</p>
<p># su - mongod</p>
<p>$ mongo 192.168.27.11:38017/admin</p>
<p>（2）添加分片</p>
<p>db.runCommand( { addshard : “sh1/192.168.27.11:38021,192.168.27.11:38022,192.168.27.11:38023”,name:”shard1”} )</p>
<p>db.runCommand( { addshard : “sh2/192.168.27.11:38024,192.168.27.11:38025,192.168.27.11:38026”,name:”shard2”} )</p>
<p>（3）列出分片</p>
<p>mongos&gt; db.runCommand( { listshards : 1 } )</p>
<p>（4）整体状态查看</p>
<p>mongos&gt; sh.status();</p>
<p>19.7.4 使用分片集群</p>
<p>## RANGE分片配置及测试</p>
<p>test库下的vast大表进行手工分片</p>
<p>19.7.4.1 激活数据库分片功能</p>
<p>mongo –port 38017 admin</p>
<p>admin&gt; ( { enablesharding : “数据库名称” } )</p>
<p>eg：</p>
<p>admin&gt; db.runCommand( { enablesharding : “test” } )</p>
<p>19.7.4.2 指定分片建对集合分片</p>
<p>eg：范围片键</p>
<p>–创建索引</p>
<p>use test</p>
<p>&gt; db.vast.ensureIndex( { id: 1 } )</p>
<p>–开启分片</p>
<p>use admin</p>
<p>&gt; db.runCommand( { shardcollection : “test.vast”,key : {id: 1} } )    （id:1是从小到大，id:-1是从大到小）</p>
<p>19.7.4.3 集合分片验证</p>
<p>admin&gt; use test</p>
<p>test&gt; for(i=1;i&lt;1000000;i++){ db.vast.insert({“id”:i,”name”:”shenzheng”,”age”:70,”date”:new Date()}); }</p>
<p>test&gt; db.vast.stats()</p>
<p>19.7.4.4 分片结果测试</p>
<p>shard1:</p>
<p>mongo –port 38021</p>
<p>db.vast.count();</p>
<p>shard2:</p>
<p>mongo –port 38024</p>
<p>db.vast.count();</p>
<p>19.7.5 Hash分片例子</p>
<p>对oldboy库下的vast大表进行hash</p>
<p>创建哈希索引</p>
<p>（1）对于oldboy开启分片功能</p>
<p>mongo –port 38017 admin</p>
<p>use admin</p>
<p>admin&gt; db.runCommand( { enablesharding : “oldboy” } )</p>
<p>（2）对于oldboy库下的vast表建立hash索引</p>
<p>use oldboy</p>
<p>oldboy&gt; db.vast.ensureIndex( { id: “hashed” } )</p>
<p>（3）开启分片 </p>
<p>use admin</p>
<p>admin &gt; sh.shardCollection( “oldboy.vast”, { id: “hashed” } )</p>
<p>（4）录入10w行数据测试</p>
<p>use oldboy</p>
<p>for(i=1;i&lt;100000;i++){ db.vast.insert({“id”:i,”name”:”shenzheng”,”age”:70,”date”:new Date()}); }</p>
<p>（5）hash分片结果测试</p>
<p>mongo –port 38021</p>
<p>use oldboy</p>
<p>db.vast.count();</p>
<p>mongo –port 38024</p>
<p>use oldboy</p>
<p>db.vast.count();</p>
<p>19.8 判断是否Shard集群</p>
<p>admin&gt; db.runCommand({ isdbgrid : 1})</p>
<p>19.9 列出所有分片信息</p>
<p>admin&gt; db.runCommand({ listshards : 1})</p>
<p>19.10 列出开启分片的数据库</p>
<p>admin&gt; use config</p>
<p>config&gt; db.databases.find( { “partitioned”: true } )</p>
<p>或者：</p>
<p>config&gt; db.databases.find() //列出所有数据库分片情况</p>
<p>19.11 查看分片的片键</p>
<p>config&gt; db.collections.find().pretty()</p>
<p>{</p>
<p>​    “_id” : “test.vast”,</p>
<p>​    “lastmodEpoch” : ObjectId(“58a599f19c898bbfb818b63c”),</p>
<p>​    “lastmod” : ISODate(“1970-02-19T17:02:47.296Z”),</p>
<p>​    “dropped” : false,</p>
<p>​    “key” : {</p>
<p>​        “id” : 1</p>
<p>​    },</p>
<p>​    “unique” : false</p>
<p>}</p>
<p>19.12 查看分片的详细信息</p>
<p>admin&gt; db.printShardingStatus()</p>
<p>或</p>
<p>admin&gt; sh.status()  *****</p>
<p>19.13 删除分片节点（谨慎）</p>
<p>（1）确认blance是否在工作</p>
<p>sh.getBalancerState()</p>
<p>（2）删除shard2节点(谨慎)</p>
<p>mongos&gt; db.runCommand( { removeShard: “shard2” } )</p>
<p>注意：删除操作一定会立即触发blancer。</p>
<p>19.14 alancer操作 *****</p>
<p>介绍：</p>
<p>mongos的一个重要功能，自动巡查所有shard节点上的chunk的情况，自动做chunk迁移。</p>
<p>什么时候工作？</p>
<p>1、自动运行，会检测系统不繁忙的时候做迁移</p>
<p>2、在做节点删除的时候，立即开始迁移工作</p>
<p>3、balancer只能在预设定的时间窗口内运行 *****</p>
<p>有需要时可以关闭和开启blancer（备份的时候）</p>
<p>mongos&gt; sh.stopBalancer()</p>
<p>mongos&gt; sh.startBalancer()</p>
<p>19.15 自定义 自动平衡进行的时间段</p>
<p><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/tutorial/manage-sharded-cluster-balancer/#schedule-the-balancing-window">https://docs.mongodb.com/manual/tutorial/manage-sharded-cluster-balancer/#schedule-the-balancing-window</a></p>
<p>// connect to mongos</p>
<p> mongo –port 38017 admin</p>
<p>use config</p>
<p>sh.setBalancerState( true )</p>
<p>db.settings.update({ _id : “balancer” }, { $set : { activeWindow : { start : “3:00”, stop : “5:00” } } }, true )</p>
<p>sh.getBalancerWindow()</p>
<p>sh.status()</p>
<p>关于集合的balancer（了解下）</p>
<p>关闭某个集合的balance</p>
<p>sh.disableBalancing(“students.grades”)</p>
<p>打开某个集合的balancer</p>
<p>sh.enableBalancing(“students.grades”)</p>
<p>确定某个集合的balance是开启或者关闭</p>
<p>db.getSiblingDB(“config”).collections.findOne({_id : “students.grades”}).noBalance;</p>
<p>19.16 备份恢复 *****</p>
<p>19.16.1 备份恢复工具介绍：</p>
<p>（1）**  mongoexport/mongoimport</p>
<p>（2）***** mongodump/mongorestore</p>
<p>19.16.2 备份工具区别在哪里</p>
<p>（1）</p>
<p>mongoexport/mongoimport 导入/导出的是JSON格式或者CSV格式</p>
<p>mongodump/mongorestore  导入/导出的是BSON格式。</p>
<p>（2）JSON可读性强但体积较大，BSON则是二进制文件，体积小但对人类几乎没有可读性。</p>
<p>（3）在一些mongodb版本之间，BSON格式可能会随版本不同而有所不同，所以不同版本之间用mongodump/mongorestore可能不会成功，具体要看版本之间的兼容性。当无法使用BSON进行跨版本的数据迁移的时候，</p>
<p>使用JSON格式即mongoexport/mongoimport是一个可选项。</p>
<p>跨版本的mongodump/mongorestore个人并不推荐，实在要做请先检查文档看两个版本是否兼容（大部分时候是的）    </p>
<p>（4）JSON虽然具有较好的跨版本通用性，但其只保留了数据部分，不保留索引，账户等其他基础信息。使用时应该注意。</p>
<p>19.16.3 应用场景总结:</p>
<p>mongoexport/mongoimport:json csv </p>
<p>（1）异构平台迁移 mysql &lt;—&gt; mongodb</p>
<p>（2）同平台，跨大版本：mongodb 2 —-&gt; mongodb 3</p>
<p>mongodump/mongorestore</p>
<p>日常备份恢复时使用.</p>
<p>19.16.4 导出工具mongoexport</p>
<p>Mongodb中的mongoexport工具可以把一个collection导出成JSON格式或CSV格式的文件。</p>
<p>可以通过参数指定导出的数据项，也可以根据指定的条件导出数据。</p>
<p>（1）版本差异较大</p>
<p>（2）异构平台数据迁移</p>
<p>19.16.5 mongoexport具体用法如下所示</p>
<p>$ mongoexport –help </p>
<p>参数说明：</p>
<p>-h:指明数据库宿主机的IP</p>
<p>-u:指明数据库的用户名</p>
<p>-p:指明数据库的密码</p>
<p>-d:指明数据库的名字</p>
<p>-c:指明collection的名字</p>
<p>-f:指明要导出那些列</p>
<p>-o:指明到要导出的文件名</p>
<p>-q:指明导出数据的过滤条件</p>
<p>–authenticationDatabase admin</p>
<p>（1）单表备份至json格式</p>
<p>mongoexport -uroot -proot123 –port 27017 –authenticationDatabase admin -d oldboy -c log -o /mongodb/log.json</p>
<p>mongoexport -uroot -proot123 -d oldboy -c log –authenticationDatabase admin -o /mongodb/backup/log.json</p>
<p>注：备份文件的名字可以自定义，默认导出了JSON格式的数据。</p>
<p>（2）单表备份至csv格式</p>
<p>如果我们需要导出CSV格式的数据，则需要使用—-type=csv参数：</p>
<p> mongoexport -uroot -proot123 –port 27017 –authenticationDatabase admin -d oldboy -c log –type=csv -f uid,name,age,date -o /mongodb/log.csv</p>
<p>19.16.6 导入工具mongoimport</p>
<p>Mongodb中的mongoimport工具可以把一个特定格式文件中的内容导入到指定的collection中。该工具可以导入JSON格式数据，也可以导入CSV格式数据</p>
<p>19.16.7 mongoimport具体使用如下所示：</p>
<p>$ mongoimport –help</p>
<p>参数说明：</p>
<p>-h:指明数据库宿主机的IP</p>
<p>-u:指明数据库的用户名</p>
<p>-p:指明数据库的密码</p>
<p>-d:指明数据库的名字</p>
<p>-c:指明collection的名字</p>
<p>-f:指明要导入那些列</p>
<p>-j, –numInsertionWorkers=<number> number of insert operations to run concurrently                         (defaults to 1)</p>
<p>（1）恢复json格式表数据到log1</p>
<p>mongoimport -uroot -proot123 –port 27017 –authenticationDatabase admin -d oldboy -c log1 /mongodb/log.json</p>
<p>（2）恢复csv格式的文件到log2</p>
<p>上面演示的是导入JSON格式的文件中的内容，如果要导入CSV格式文件中的内容，则需要通过–type参数指定导入格式，具体如下所示：</p>
<p>错误的恢复</p>
<p>注意：</p>
<p>（1）csv格式的文件头行，有列名字</p>
<p>mongoimport  -uroot -proot123 –port 27017 –authenticationDatabase admin  -d oldboy -c log2 –type=csv –headerline –file /mongodb/log.csv</p>
<p>（2）csv格式的文件头行，没有列名字</p>
<p>mongoimport  -uroot -proot123 –port 27017 –authenticationDatabase admin  -d oldboy -c log3 –type=csv -f id,name,age,date –file /mongodb/log1.csv</p>
<p>–headerline:指明第一行是列名，不需要导入。</p>
<p>19.17 异构平台迁移案例1</p>
<p>mysql  —–&gt; mongodb </p>
<p>world数据库下city表进行导出，导入到mongodb</p>
<p>（1）mysql开启安全路径</p>
<p>vim /etc/my.cnf  —&gt;添加以下配置</p>
<p>secure-file-priv=/tmp</p>
<p>–重启数据库生效</p>
<p>/etc/init.d/mysqld restart</p>
<p>（2）导出mysql的city表数据</p>
<p>source /root/world.sql</p>
<p>select * from world.city into outfile ‘/tmp/city1.csv’ fields terminated by ‘,’;</p>
<p>（3）处理备份文件</p>
<p>desc world.city</p>
<p> ID     | int(11) | NO  | PRI | NULL  | auto_increment |</p>
<p>| Name    | char(35) | NO  |   |     |        |</p>
<p>| CountryCode | char(3) | NO  | MUL |     |        |</p>
<p>| District  | char(20) | NO  |   |     |        |</p>
<p>| Population</p>
<p>vim /tmp/city.csv  —-&gt; 添加第一行列名信息</p>
<p>ID,Name,CountryCode,District,Population</p>
<p>(4)在mongodb中导入备份</p>
<p>mongoimport -uroot -proot123 –port 27017 –authenticationDatabase admin -d world -c city –type=csv -f ID,Name,CountryCode,District,Population –file /tmp/city1.csv</p>
<p>use world</p>
<p>db.city.find({CountryCode:”CHN”});</p>
<p>19.18 异构平台迁移案例2</p>
<p>world共100张表，全部迁移到mongodb</p>
<p>select * from world.city into outfile ‘/tmp/world_city.csv’ fields terminated by ‘,’;</p>
<p>select concat(“select * from “,table_schema,”.”,table_name ,” into outfile ‘/tmp/“,table_schema,”_”,table_name,”.csv’ fields terminated by ‘,’;”)</p>
<p>from information_schema.tables where table_schema =’world’;</p>
<p>导入：</p>
<p>  提示，使用infomation_schema.columns + information_schema.tables</p>
<p>19.19 mysql导出csv：</p>
<p>select * from test_info  </p>
<p>into outfile ‘/tmp/test.csv’  </p>
<p>fields terminated by ‘,’　　　 ——字段间以,号分隔</p>
<p>optionally enclosed by ‘“‘　　 ——字段用”号括起</p>
<p>escaped by ‘“‘  　　　　　 ——字段中使用的转义符为”</p>
<p>lines terminated by ‘\r\n’;　　——行以\r\n结束</p>
<p>mysql导入csv：（可以用以下方式）</p>
<p>load data infile ‘/tmp/test.csv’  </p>
<p>into table test_info  </p>
<p>fields terminated by ‘,’ </p>
<p>optionally enclosed by ‘“‘ </p>
<p>escaped by ‘“‘  </p>
<p>lines terminated by ‘\r\n’; </p>
<p>19.20 mongodump和mongorestore介绍</p>
<p>mongodump能够在Mongodb运行时进行备份，它的工作原理是对运行的Mongodb做查询，然后将所有查到的文档写入磁盘。但是存在的问题时使用mongodump产生的备份不一定是数据库的实时快照，如果我们在备份时对数据库进行了写入操作，则备份出来的文件可能不完全和Mongodb实时数据相等。另外在备份时可能会对其它客户端性能产生不利的影响。</p>
<p>19.21 mongodump用法如下：</p>
<p>$ mongodump –help</p>
<p>参数说明：</p>
<p>-h:指明数据库宿主机的IP</p>
<p>-u:指明数据库的用户名</p>
<p>-p:指明数据库的密码</p>
<p>-d:指明数据库的名字</p>
<p>-c:指明collection的名字</p>
<p>-o:指明到要导出的文件名</p>
<p>-q:指明导出数据的过滤条件</p>
<p>-j, –numParallelCollections= number of collections to dump in parallel (4 by default)</p>
<p>–oplog 备份的同时备份oplog</p>
<p>19.22 mongodump和mongorestore基本使用</p>
<p>（1）全库备份</p>
<p>mkdir /mongodb/backup</p>
<p>mongodump -uroot -proot123 –port 27017 –authenticationDatabase admin -o /mongodb/backup</p>
<p>（2）备份world库</p>
<p>$ mongodump  -uroot -proot123 –port 27017 –authenticationDatabase admin -d world -o /mongodb/backup/</p>
<p>（3）备份oldboy库下的log集合</p>
<p>$ mongodump  -uroot -proot123 –port 27017 –authenticationDatabase admin -d oldboy -c log -o /mongodb/backup/</p>
<p>（4）压缩备份</p>
<p>$ mongodump  -uroot -proot123 –port 27017 –authenticationDatabase admin -d oldguo -o /mongodb/backup/ –gzip</p>
<p> mongodump  -uroot -proot123 –port 27017 –authenticationDatabase admin -o /mongodb/backup/ –gzip</p>
<p>$ mongodump  -uroot -proot123 –port 27017 –authenticationDatabase admin -d app -c vast -o /mongodb/backup/ –gzip</p>
<p>（5）恢复world库</p>
<p>$ mongorestore  -uroot -proot123 –port 27017 –authenticationDatabase admin -d world1 /mongodb/backup/world</p>
<p>（6）恢复oldguo库下的t1集合</p>
<p>[mongod@db03 oldboy]$ mongorestore  -uroot -proot123 –port 27017 –authenticationDatabase admin -d world -c t1 –gzip /mongodb/backup.bak/oldboy/log1.bson.gz </p>
<p>（7）drop表示恢复的时候把之前的集合drop掉(危险)</p>
<p>$ mongorestore -uroot -proot123 –port 27017 –authenticationDatabase admin -d oldboy –drop /mongodb/backup/oldboy</p>
<p>19.23 mongodump和mongorestore高级企业应用（–oplog）</p>
<p>注意：这是replica set或者master/slave模式专用</p>
<p>–oplog</p>
<p> use oplog for taking a point-in-time snapshot</p>
<p>19.23.1 oplog介绍</p>
<p>在replica set中oplog是一个定容集合（capped collection），它的默认大小是磁盘空间的5%（可以通过–oplogSizeMB参数修改）.</p>
<p>位于local库的db.oplog.rs，有兴趣可以看看里面到底有些什么内容。</p>
<p>其中记录的是整个mongod实例一段时间内数据库的所有变更（插入/更新/删除）操作。</p>
<p>当空间用完时新记录自动覆盖最老的记录。</p>
<p>其覆盖范围被称作oplog时间窗口。需要注意的是，因为oplog是一个定容集合，</p>
<p>所以时间窗口能覆盖的范围会因为你单位时间内的更新次数不同而变化。</p>
<p>想要查看当前的oplog时间窗口预计值，可以使用以下命令：</p>
<p> mongod -f /mongodb/28017/conf/mongod.conf </p>
<p> mongod -f /mongodb/28018/conf/mongod.conf </p>
<p> mongod -f /mongodb/28019/conf/mongod.conf </p>
<p> mongod -f /mongodb/28020/conf/mongod.conf </p>
<p> use local </p>
<p> db.oplog.rs.find().pretty()</p>
<p> “ts” : Timestamp(1553597844, 1),</p>
<p>​    “op” : “n”</p>
<p>​    “o” :</p>
<p>  “i”: insert</p>
<p>  “u”: update</p>
<p>  “d”: delete</p>
<p>  “c”: db cmd</p>
<p>​    </p>
<p>-———–</p>
<p>test:PRIMARY&gt; rs.printReplicationInfo()</p>
<p>configured oplog size:  1561.5615234375MB &lt;–集合大小</p>
<p>log length start to end: 423849secs (117.74hrs) &lt;–预计窗口覆盖时间</p>
<p>oplog first event time: Wed Sep 09 2015 17:39:50 GMT+0800 (CST)</p>
<p>oplog last event time:  Mon Sep 14 2015 15:23:59 GMT+0800 (CST)</p>
<p>now:           Mon Sep 14 2015 16:37:30 GMT+0800 (CST)</p>
<p>19.23.2 oplog企业级应用</p>
<p>（1）实现热备，在备份时使用–oplog选项</p>
<p>注：为了演示效果我们在备份过程，模拟数据插入</p>
<p>（2）准备测试数据</p>
<p>use oldboy</p>
<p>for(var i = 1 ;i &lt; 100; i++) {</p>
<p>  db.foo.insert({a:i});</p>
<p>}</p>
<p>my_repl:PRIMARY&gt; db.oplog.rs.find({“op”:”i”}).pretty()</p>
<p>-—————————————————-</p>
<p>oplog 配合mongodump实现热备</p>
<p>mongodump –port 28017 –oplog -o /mongodb/backup</p>
<p>作用介绍：–oplog 会记录备份过程中的数据变化。会以oplog.bson保存下来</p>
<p>恢复</p>
<p>mongorestore –port 28017 –oplogReplay /mongodb/backup</p>
<p>19.23.3 oplog高级应用 ==========binlog应用</p>
<p>背景：每天0点全备，oplog恢复窗口为48小时</p>
<p>某天，上午10点world.city 业务表被误删除。</p>
<p>恢复思路：</p>
<p>​    0、停应用</p>
<p>​    2、找测试库</p>
<p>​    3、恢复昨天晚上全备</p>
<p>​    4、截取全备之后到world.city误删除时间点的oplog，并恢复到测试库</p>
<p>​    5、将误删除表导出，恢复到生产库</p>
<p>恢复步骤：</p>
<p>模拟故障环境：</p>
<p>（1）全备数据库</p>
<p>模拟原始数据</p>
<p>mongo –port 28017</p>
<p>use wo</p>
<p>for(var i = 1 ;i &lt; 20; i++) {</p>
<p>  db.ci.insert({a: i});</p>
<p>}</p>
<p>全备:</p>
<p>rm -rf /mongodb/backup/*</p>
<p>mongodump –port 28017 –oplog -o /mongodb/backup</p>
<p>–oplog功能:在备份同时,将备份过程中产生的日志进行备份</p>
<p>文件必须存放在/mongodb/backup下,自动命令为oplog.bson</p>
<p>再次模拟数据</p>
<p>db.ci1.insert({id:1})</p>
<p>db.ci2.insert({id:2})</p>
<p>（2）上午10点：删除wo库下的ci表</p>
<p>10:00时刻,误删除</p>
<p>db.ci.drop()</p>
<p>show tables;</p>
<p>（3）备份现有的oplog.rs表</p>
<p>mongodump –port 28017 -d local -c oplog.rs -o /mongodb/backup</p>
<p>（4）截取oplog并恢复到drop之前的位置</p>
<p>更合理的方法：登陆到原数据库</p>
<p>[mongod@db03 local]$ mongo –port 28017</p>
<p>my_repl:PRIMARY&gt; use local</p>
<p>db.oplog.rs.find({op:”c”}).pretty();</p>
<p>{</p>
<p>​    “ts” : Timestamp(1553659908, 1),</p>
<p>​    “t” : NumberLong(2),</p>
<p>​    “h” : NumberLong(“-7439981700218302504”),</p>
<p>​    “v” : 2,</p>
<p>​    “op” : “c”,</p>
<p>​    “ns” : “wo.$cmd”,</p>
<p>​    “ui” : UUID(“db70fa45-edde-4945-ade3-747224745725”),</p>
<p>​    “wall” : ISODate(“2019-03-27T04:11:48.890Z”),</p>
<p>​    “o” : {</p>
<p>​        “drop” : “ci”</p>
<p>​    }</p>
<p>}</p>
<p>“ts” : Timestamp(1563958129, 1),</p>
<p>获取到oplog误删除时间点位置:</p>
<p>“ts” : Timestamp(1553659908, 1)</p>
<p>（5）恢复备份+应用oplog</p>
<p>[mongod@db03 backup]$ cd /mongodb/backup/local/</p>
<p>[mongod@db03 local]$ ls</p>
<p>oplog.rs.bson oplog.rs.metadata.json</p>
<p>[mongod@db03 local]$ cp oplog.rs.bson ../oplog.bson </p>
<p>rm -rf /mongodb/backup/local/</p>
<p>mongorestore –port 28018 –oplogReplay –oplogLimit “1563958129:1” –drop  /mongodb/backup/</p>
<p>注意：</p>
<p>–oplogLimit ：跳过某个时间点</p>
<p>19.14 分片集群的备份思路（了解）</p>
<p>19.24.1 你要备份什么？</p>
<p>config server</p>
<p>shard 节点</p>
<p>单独进行备份</p>
<p>19.24.2 备份有什么困难和问题</p>
<p>（1）chunk迁移的问题</p>
<p>​    人为控制在备份的时候，避开迁移的时间窗口</p>
<p>（2）shard节点之间的数据不在同一时间点。</p>
<p>​    选业务量较少的时候        </p>
<p>Ops Manager </p>
<p>如何熟悉数据库业务?</p>
<ol>
<li><p>快速和研发人员打好关系（如：在抽烟的时候聊天，请喝酒或饮料，请吃饭）</p>
</li>
<li><p>找到领导要ER图</p>
</li>
<li><p>DESC ,show create table</p>
</li>
<li><p>select * from city limit 5;</p>
</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/Linux-MySQL/">Linux MySQL</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/10/02/%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">面试准备</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/09/02/ELK/">
                        <span class="hidden-mobile">ELK</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
