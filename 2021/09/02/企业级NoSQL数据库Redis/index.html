

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>企业级NoSQL数据库Redis - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="企业级NoSQL数据库Redis">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-02 14:24" pubdate>
        2021年9月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      60.9k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      953
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">企业级NoSQL数据库Redis</h1>
            
            <div class="markdown-body">
              <h1 id="企业级NoSQL数据库Redis"><a href="#企业级NoSQL数据库Redis" class="headerlink" title="企业级NoSQL数据库Redis"></a>企业级NoSQL数据库Redis</h1><h1 id="一、缓存技术"><a href="#一、缓存技术" class="headerlink" title="一、缓存技术"></a>一、缓存技术</h1><p>缓存cache 是为了调节速度不一致的两个或多个不同的物质的速度，置于中间,可以实现速度较快的一方加速访问速度较慢的一方的作用，比如CPU的一级、二级缓存是保存了CPU最近经常访问的数据，内存是保存CPU经常访问硬盘的数据，而且硬盘也有大小不一的缓存，甚至是物理服务器的raid 卡有也缓存，都是为了起到加速CPU 访问硬盘数据的目的，因为CPU的速度太快了，CPU需要的数据由于硬盘往往不能在短时间内满足CPU的需求，因此CPU缓存、内存、Raid 卡缓存以及硬盘缓存就在一定程度上满足了CPU的数据需求，即CPU 从缓存读取数据,从而可以大幅提高CPU的工作效率。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis1.png" srcset="/blog/img/loading.gif"></p>
<p>参考资料：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://www.sohu.com/a/246498483_468626<br></code></pre></td></tr></table></figure>

<h2 id="1-1-缓存-cache"><a href="#1-1-缓存-cache" class="headerlink" title="1.1 缓存 cache"></a>1.1 缓存 cache</h2><h3 id="1-1-1-buffer与cache"><a href="#1-1-1-buffer与cache" class="headerlink" title="1.1.1 buffer与cache"></a>1.1.1 buffer与cache</h3><p>buffer：缓冲,也叫写缓冲，一般用于写操作，可以将数据先写入内存在写入磁盘，buffer 一般用于写缓冲，用于解决不同介质的速度不一致的缓冲，先将数据临时写入到里自己最近的地方，以提高写入速度，CPU会把数据先写到内存的磁盘缓冲区，然后应用就认为数据已经写入完成，然后由内核在后续的时间再写入磁盘，所以服务器突然断电会丢失内存中的部分数据。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis2.png" srcset="/blog/img/loading.gif"></p>
<p>cache：缓存,也叫读缓存，一般用于读操作，CPU读文件从内存读，如果内存没有,就先从硬盘读到内存再读到CPU，将需要频繁读取的数据放在里自己最近的缓存区域，下次读取的时候即可快速读取。</p>
<p>向 /proc/sys/vm/drop_caches 写入相应的修改值，会清理缓存。建议先执行sync（sync 命令将所有未写的系统缓冲区写到磁盘中，包含已修改的 i-node、已延迟的块 I/O 和读写映射文件）。执行echo 1、2、3 至 /proc/sys/vm/drop_caches, 达到不同的清理目的</p>
<p>如果因为是应用有像内存泄露、溢出的问题时，从swap的使用情况是可以比较快速可以判断的，但通过执行free 反而比较难查看。但核心并不会因为内存泄露等问题并没有快速清空buffer或cache（默认值是0），生产也不应该随便去改变此值。</p>
<p>一般情况下，应用在系统上稳定运行了，free值也会保持在一个稳定值的。当发生内存不足、应用获取不到可用内存、OOM错误等问题时，还是更应该去分析应用方面的原因，否则，清空buffer，强制腾出free的大小，可能只是把问题给暂时屏蔽了。</p>
<p>排除内存不足的情况外，除非是在软件开发阶段，需要临时清掉buffer，以判断应用的内存使用情况；或应用已经不再提供支持，即使应用对内存的时候确实有问题，而且无法避免的情况下，才考虑定时清空buffer。</p>
<p>说明: man 5 proc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># man proc</span><br>......<br>/proc/sys/vm/drop_caches (since Linux 2.6.16)<br>Writing to this file causes the kernel to drop clean caches, dentries, and inodes from memory, causing that memory to become free. This can be useful <span class="hljs-keyword">for</span> memory management testing and performing reproducible filesystem benchmarks.Because writing to this file causes the benefits of caching to be lost, it can degrade overall system performance.<br>To free pagecache, use:<br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches<br>To free dentries and inodes, use:<br><span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/vm/drop_caches<br>To free pagecache, dentries and inodes, use:<br><span class="hljs-built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches<br>Because writing to this file is a nondestructive operation and dirty objects are not freeable, the user should run sync(1) first.<br></code></pre></td></tr></table></figure>

<p>范例: 清理缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># cat /proc/sys/vm/drop_caches</span><br>0<br><span class="hljs-comment"># free -h</span><br>              total        used        free      shared  buff/cache   available<br>Mem:           1.8G        247M        775M         32M        797M        1.3G<br>Swap:          2.0G          0B        2.0G<br><br><span class="hljs-comment"># echo 3 &gt; /proc/sys/vm/drop_caches</span><br><br><span class="hljs-comment"># free -h</span><br>              total        used        free      shared  buff/cache   available<br>Mem:           1.8G        217M        1.5G         32M         79M        1.4G<br>Swap:          2.0G          0B        2.0G<br></code></pre></td></tr></table></figure>

<h3 id="1-1-2-缓存保存位置及分层结构"><a href="#1-1-2-缓存保存位置及分层结构" class="headerlink" title="1.1.2 缓存保存位置及分层结构"></a>1.1.2 缓存保存位置及分层结构</h3><p>互联网应用领域,提到缓存为王</p>
<ul>
<li>用户层: 浏览器DNS缓存,应用程序DNS缓存,操作系统DNS缓存客户端</li>
<li>代理层: CDN,反向代理缓存</li>
<li>Web层: 解释器Opcache,Web服务器缓存</li>
<li>应用层: 页面静态化</li>
<li> 数据层: 分布式缓存,数据库</li>
<li>系统层: 操作系统cache</li>
<li>物理层: 磁盘cache, Raid Cache</li>
</ul>
<h3 id="1-1-3-cache-的特性"><a href="#1-1-3-cache-的特性" class="headerlink" title="1.1.3 cache 的特性"></a>1.1.3 cache 的特性</h3><p>自动过期：给缓存的数据加上有效时间，超出时间后自动过期删除</p>
<p>强制过期：源网站更新图片后CDN是不会更新的，需要强制是图片缓存过期 ，通过CDN管理后台实现</p>
<p>命中率：即缓存的读取命中率</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis3.png" srcset="/blog/img/loading.gif"></p>
<h2 id="1-2-用户层缓存"><a href="#1-2-用户层缓存" class="headerlink" title="1.2 用户层缓存"></a>1.2 用户层缓存</h2><h3 id="1-2-1-DNS缓存"><a href="#1-2-1-DNS缓存" class="headerlink" title="1.2.1 DNS缓存"></a>1.2.1 DNS缓存</h3><p>浏览器的DNS缓存默认为60秒，即60秒之内在访问同一个域名就不在进行DNS解析</p>
<p>范例: 查看chrome浏览器的DNS缓存</p>
<p>注意: 此方式新版的chrome 基于安全原因不再显示缓存信息</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">chrome://net-internals/#dns<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis4.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-2-2-火狐浏览器缓存"><a href="#1-2-2-火狐浏览器缓存" class="headerlink" title="1.2.2 火狐浏览器缓存"></a>1.2.2 火狐浏览器缓存</h3><p>地址栏输入下面指令可以看firefox的缓存信息</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">about:cache<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis5.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis6.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-2-3-前端技术-dns-prefetch"><a href="#1-2-3-前端技术-dns-prefetch" class="headerlink" title="1.2.3 前端技术 dns-prefetch"></a>1.2.3 前端技术 dns-prefetch</h3><p>HTML5的新特性, 可以在html文件中进行DNS的 Prefetch</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis7.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-2-4-浏览器缓存过期机制"><a href="#1-2-4-浏览器缓存过期机制" class="headerlink" title="1.2.4 浏览器缓存过期机制"></a>1.2.4 浏览器缓存过期机制</h3><h4 id="1-2-4-1-最后修改时间-last-modified"><a href="#1-2-4-1-最后修改时间-last-modified" class="headerlink" title="1.2.4.1 最后修改时间 last-modified"></a>1.2.4.1 最后修改时间 last-modified</h4><p>Last-Modified 是 HttpHeader 中的资源的最后修改时间，如果带有 Last-Modified ，下一次发送 Http请求时，将会发生带 If-modified-since 的 HttpHeader 。如果没有过期，将会收到 304 的响应，从缓存中读取。</p>
<p>浏览器请求文件时,会先获取服务器的文件的最后修改时间，再和本地浏览器缓存中的文件时间相比，如果没有发生变化就返回给浏览器304的状态码，表示没有发生变化，然后浏览器就使用的本地的缓存展示资源,如果变化,则重新再一次向服务器请求资源</p>
<p>此方式也需要向服务器发送请求才可以使用缓存</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis8.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis9.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis10.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis11.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis12.png" srcset="/blog/img/loading.gif"></p>
<h4 id="1-2-4-2-Etag标记"><a href="#1-2-4-2-Etag标记" class="headerlink" title="1.2.4.2 Etag标记"></a>1.2.4.2 Etag标记</h4><p>Etag 是 HttpHeader 中代表资源的标签，在服务器端生成。如果带有 Etag ，下一次发送带 Etag 的请求，如果 Etag 没有变化将收到 304 的响应，从缓存中读取。</p>
<p>基于Etag标记是否一致做判断页面是否发生过变化，比如基于 Nginx 的etag on来实现。</p>
<p>Etag 在使用时要注意相同资源多台 Web 服务器的 Etag 的一致性</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis13.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis14.png" srcset="/blog/img/loading.gif" alt="此方式也需要向服务器发送请求才可以使用缓存"></p>
<h4 id="1-2-4-3-过期时间-expires"><a href="#1-2-4-3-过期时间-expires" class="headerlink" title="1.2.4.3 过期时间 expires"></a>1.2.4.3 过期时间 expires</h4><p>以上两种都需要发送请求，即不管资源是否过期都要发送请求进行协商，这样会消耗不必要的时间，因此有了缓存的过期时间</p>
<p>Expire 是 HttpHeader 中代表资源的过期时间，由服务器段设置。如果带有 Expire ，则在 Expire 过期前不会发生 Http 请求，直接从缓存中读取。用户强制 F5 例外</p>
<p>即第一次请求资源时,响应报文带有资源的过期时间，默认为30天，当前此方式使用的比较多，但是无法保证客户的时间都是准确并且一致的，因此会加入一个最大生存周期，使用用户本地的时间计算缓存数据是否超过多少天，下面的过期时间Expires:为2028年，但是缓存的最大生存周期Cache-Control:max-age=315360000，计算为天等于3650天即10年，过期时间如下：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis15.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis16.png" srcset="/blog/img/loading.gif"></p>
<h4 id="1-2-3-4-混合使用和缓存刷新"><a href="#1-2-3-4-混合使用和缓存刷新" class="headerlink" title="1.2.3.4 混合使用和缓存刷新"></a>1.2.3.4 混合使用和缓存刷新</h4><p>通常 Last-Modified,Etag，Expire 是一起混合使用的</p>
<ul>
<li>特别是 Last-Modified 和 Expire 经常一起使用，因为 Expire 可以让浏览器完全不发起 Http 请求，而当浏览器强制 F5 的时候又有 Last-Modified ，这样就很好的达到了浏览器段缓存的效果。</li>
<li>Etag 和 Expire 一起使用时，先判断 Expire ，如果已经过期，再发起 Http 请求，如果 Etag 变化了，则返回 200 响应。如果 Etag 没有变化,则返回 304 响应。</li>
<li>Last-Modified,Etag,Expires 三个同时使用时。先判断 Expire ，然后发送 Http 请求，服务器先判断 last-modified ，再判断 Etag ，必须都没有过期，才能返回 304 响应。</li>
</ul>
<p>缓存刷新</p>
<ul>
<li>第一次访问,获取最新数据,返回 200响应码</li>
<li>鼠标点击二次访问 (Cache)，输入地址后回车，浏览器对所有没有过期的内容直接使用本地缓存。</li>
<li>F5或点刷新按钮，会向服务器发送请求缓存协商信息，last-modified和etag会有影响，但expires本地过期时间不受影响，无变化返回304</li>
<li>按Ctrl+F5强制刷新，所有缓存不再使用，直接连接服务器,获取最新数据,返回200响应码</li>
</ul>
<h3 id="1-2-5-cookie-和-session"><a href="#1-2-5-cookie-和-session" class="headerlink" title="1.2.5 cookie 和 session"></a>1.2.5 cookie 和 session</h3><p>Cookie是访问某些网站以后在本地存储的一些网站相关的信息，下次再访问的时候减少一些步骤,比如加密后的账户名密码等信息</p>
<p>Cookies是服务器在客户端浏览器上存储的小段文本并随每一个请求发送至同一个服务器，是一种实现客户端保持状态的方案。</p>
<p>session称为会话信息，位于web服务器上，主要负责访问者与网站之间的交互，当浏览器请求http地址时，可以基于之前的session实现会话保持、session共享等。</p>
<h2 id="1-3-CDN-缓存"><a href="#1-3-CDN-缓存" class="headerlink" title="1.3 CDN 缓存"></a>1.3 CDN 缓存</h2><h3 id="1-3-1-什么是CDN"><a href="#1-3-1-什么是CDN" class="headerlink" title="1.3.1 什么是CDN"></a>1.3.1 什么是CDN</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis17.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis18.png" srcset="/blog/img/loading.gif"></p>
<p>内容分发网络（Content Delivery Network，CDN）是建立并覆盖在承载网上，由不同区域的服务器组成的分布式网络。将源站资源缓存到全国各地的边缘服务器，利用全球调度系统使用户能够就近获取，有效降低访问延迟，降低源站压力,提升服务可用性。</p>
<p><strong>常见的CDN服务商</strong><br>百度CDN：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://cloud.baidu.com/product/cdn.html<br></code></pre></td></tr></table></figure>

<p>阿里CDN：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.aliyun.com/product/cdn?spm=5176.8269123.416540.50.728y8n<br></code></pre></td></tr></table></figure>

<p>腾讯CDN：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.qcloud.com/product/cdn<br></code></pre></td></tr></table></figure>

<p>腾讯云CDN收费介绍：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://cloud.tencent.com/document/product/228/2949<br></code></pre></td></tr></table></figure>

<h3 id="1-3-2-用户请求CDN流程"><a href="#1-3-2-用户请求CDN流程" class="headerlink" title="1.3.2 用户请求CDN流程"></a>1.3.2 用户请求CDN流程</h3><p>假设您的业务源站域名为 <a target="_blank" rel="noopener" href="http://www.test.com/">www.test.com</a> ，域名接入 CDN 开始使用加速服务后，当您的用户发起HTTP 请求时，实际的处理流程如下图所示：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis19.png" srcset="/blog/img/loading.gif"></p>
<p>详细说明如下：</p>
<ol>
<li>用户向 <a target="_blank" rel="noopener" href="http://www.test.com/">www.test.com</a> 下的某图片资源（如：1.jpg）发起请求，会先向 Local DNS 发起域名解析请求。</li>
<li>当 Local DNS 解析 <a target="_blank" rel="noopener" href="http://www.test.com/">www.test.com</a> 时，会发现已经配置了 CNAME <a target="_blank" rel="noopener" href="http://www.test.com.cdn.dnsv1.com/">www.test.com.cdn.dnsv1.com</a> ，解析请求会发送至 Tencent DNS（GSLB），GSLB 为腾讯云自主研发的调度体系，会为请求分配最佳节点 IP。</li>
<li>Local DNS 获取 Tencent DNS 返回的解析 IP。</li>
<li>用户获取解析 IP。</li>
<li>用户向获取的 IP 发起对资源 1.jpg 的访问请求。</li>
<li>若该 IP 对应的节点缓存有 1.jpg，则会将数据直接返回给用户（10），此时请求结束。若该节点未缓存 1.jpg，则节点会向业务源站发起对 1.jpg 的请求（6、7、8），获取资源后，结合用户自定义配置的缓存策略，将资源缓存至节点（9），并返回给用户（10），此时请求结束。</li>
</ol>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis20.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-3-3-利用-302-实现转发请求重定向至最优服务器集群"><a href="#1-3-3-利用-302-实现转发请求重定向至最优服务器集群" class="headerlink" title="1.3.3 利用 302 实现转发请求重定向至最优服务器集群"></a>1.3.3 利用 302 实现转发请求重定向至最优服务器集群</h3><p>因为中国网络较为复杂，依赖DNS就近解析的调度，仍然会存在部分请求调度失效、调度生效慢等问题。</p>
<p>比如:腾讯云利用在全国部署的302重定向服务器集群，能够为每一个请求实时决策最优的服务器资源，精准解决小运营商的调度问题，提升用户访问质量, 能最快地把用户引导到最优的服务器节点上，避开性能差或者异常的节点。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis21.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-3-4-CDN-分层缓存"><a href="#1-3-4-CDN-分层缓存" class="headerlink" title="1.3.4 CDN 分层缓存"></a>1.3.4 CDN 分层缓存</h3><p>提前对静态内容进行预缓存，避免大量的请求回源，导致主站网络带宽被打满而导致数据无法更新，另外CDN可以将数据根据访问的热度不同而进行不同级别的缓存，例如:访问量最高的资源访问CDN 边缘节点的内存，其次的放在SSD或者SATA，再其次的放在云存储，这样兼顾了速度与成本。</p>
<p>比如: 腾讯云CDN节点，根据用户的数据冷热不同，动态的进行识别，按照cache层次进行数据的存储，在访问频率到40%-90%的数据，首先放在OC节点内存cache中，提供8G-64G的数据空间存储;在访问频率到30%-50%的数据，放在OC节点SSD/SATA硬盘cache中，提供1T-15T的数据空间存猪，其他的比较冷的数据，放在云存储中，采用回源拉取的方式进行处理。这样在成本和效率中计算出最优平衡点，为客户提供服务。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis22.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-3-5-CDN主要优势"><a href="#1-3-5-CDN主要优势" class="headerlink" title="1.3.5 CDN主要优势"></a>1.3.5 CDN主要优势</h3><p>CDN 有效地解决了目前互联网业务中网络层面的以下问题：</p>
<ul>
<li>用户与业务服务器地域间物理距离较远，需要进行多次网络转发，传输延时较高且不稳定。</li>
<li>用户使用运营商与业务服务器所在运营商不同，请求需要运营商之间进行互联转发。</li>
<li>业务服务器网络带宽、处理能力有限，当接收到海量用户请求时，会导致响应速度降低、可用性降低。</li>
<li>利用CDN防止和抵御DDos等攻击，实现安全保护</li>
</ul>
<h2 id="1-4-应用层缓存"><a href="#1-4-应用层缓存" class="headerlink" title="1.4 应用层缓存"></a>1.4 应用层缓存</h2><p>Nginx、PHP等web服务可以设置应用缓存以加速响应用户请求，另外有些解释性语言，比如：PHP/Python/Java不能直接运行，需要先编译成字节码，但字节码需要解释器解释为机器码之后才能执行，因此字节码也是一种缓存，有时候还会出现程序代码上线后字节码没有更新的现象。所以一般上线新版前，需要先将应用缓存清理，再上线新版</p>
<p>另外可以利用动态页面静态化技术,加速访问,比如:将访问数据库的数据的动态页面,提前用程序生成静态页面文件html.电商网站的商品介绍,评论信息非实时数据等皆可利用此技术实现</p>
<h2 id="1-5-数据层缓存"><a href="#1-5-数据层缓存" class="headerlink" title="1.5 数据层缓存"></a>1.5 数据层缓存</h2><p>分布式缓存服务</p>
<ul>
<li>Redis</li>
<li>Memcached</li>
</ul>
<p>数据库</p>
<ul>
<li>MySQL 查询缓存</li>
<li>innodb缓存、MYISAM缓存</li>
</ul>
<h2 id="1-6-硬件缓存"><a href="#1-6-硬件缓存" class="headerlink" title="1.6 硬件缓存"></a>1.6 硬件缓存</h2><h3 id="1-6-1-CPU缓存"><a href="#1-6-1-CPU缓存" class="headerlink" title="1.6.1 CPU缓存"></a>1.6.1 CPU缓存</h3><p>CPU缓存(L1的数据缓存和L1的指令缓存)、二级缓存、三级缓存</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis23.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis24.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-6-2-磁盘相关缓存"><a href="#1-6-2-磁盘相关缓存" class="headerlink" title="1.6.2 磁盘相关缓存"></a>1.6.2 磁盘相关缓存</h3><ul>
<li>磁盘缓存：Disk Cache</li>
<li>磁盘阵列缓存: Raid Cache,可使用电池防止断电丢失数据</li>
</ul>
<h1 id="二、redis-部署与使用"><a href="#二、redis-部署与使用" class="headerlink" title="二、redis 部署与使用"></a>二、redis 部署与使用</h1><h2 id="2-1-redis-基础"><a href="#2-1-redis-基础" class="headerlink" title="2.1 redis 基础"></a>2.1 redis 基础</h2><h3 id="2-1-1-关系型数据库和-NoSQL-数据库"><a href="#2-1-1-关系型数据库和-NoSQL-数据库" class="headerlink" title="2.1.1 关系型数据库和 NoSQL 数据库"></a>2.1.1 关系型数据库和 NoSQL 数据库</h3><p>数据库主要分为两大类：关系型数据库与 NoSQL 数据库。</p>
<p>关系型数据库，是建立在关系模型基础上的数据库，其借助于集合代数等数学概念和方法来处理数据库中的数据。主流的 MySQL、Oracle、PostgreSQL、MS SQL Server 和 DB2 都属于这类传统数据库。</p>
<p>NoSQL 数据库，全称为 Not Only SQL，意思就是适用关系型数据库的时候就使用关系型数据库，不适用的时候也没有必要非使用关系型数据库不可，可以考虑使用更加合适的数据存储。主要分为临时性键值存储（memcached、Redis）、永久性键值存储（ROMA、Redis）、面向文档的数据库（MongoDB、CouchDB）、面向列的数据库（Cassandra、HBase），每种 NoSQL 都有其特有的使用场景及优点。</p>
<p><strong>Oracle，mysql 等传统的关系数据库非常成熟并且已大规模商用，为什么还要用 NoSQL 数据库呢？</strong></p>
<p>主要是由于随着互联网发展，数据量越来越大，对性能要求越来越高，传统数据库存在着先天性的缺陷，即单机（单库）性能瓶颈，并且扩展困难。这样既有单机单库瓶颈，却又扩展困难，自然无法满足日益增长的海量数据存储及其性能要求，所以才会出现了各种不同的 NoSQL 产品，NoSQL 根本性的优势在于在云计算时代，简单、易于大规模分布式扩展，并且读写性能非常高</p>
<p><strong>RDBMS和NOSQL的特点及优缺点：</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis25.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-1-2-redis-简介"><a href="#2-1-2-redis-简介" class="headerlink" title="2.1.2 redis 简介"></a>2.1.2 redis 简介</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis26.png" srcset="/blog/img/loading.gif"></p>
<p>Redis (Remote Dictionary Server)在2009年发布，开发者Salvatore Sanfilippo是意大利开发者，他本想为自己的公司开发一个用于替换MySQL的产品Redis，但是没有想到他把Redis开源后大受欢迎，短短几年，Redis就有了很大的用户群体，目前国内外使用的公司众多,比如:阿里,百度,新浪微博，知乎网，GitHub，Twitter 等</p>
<p>Redis是一个开源的、遵循BSD协议的、基于内存的而且目前比较流行的键值数据库(key-valuedatabase)，是一个非关系型数据库，redis 提供将内存通过网络远程共享的一种服务，提供类似功能的还有memcached，但相比memcached，redis还提供了易扩展、高性能、具备数据持久性等功能。</p>
<p>Redis 在高并发、低延迟环境要求比较高的环境使用量非常广泛，目前redis在DB-Engine月排行榜<code>https://db-engines.com/en/ranking</code> 中一直比较靠前，而且一直是键值型存储类的首位</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis27.png" srcset="/blog/img/loading.gif"></p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://redis.io/">https://redis.io/</a></p>
<h3 id="2-1-3-Redis-特性"><a href="#2-1-3-Redis-特性" class="headerlink" title="2.1.3 Redis 特性"></a>2.1.3 Redis 特性</h3><ul>
<li>速度快: 10W QPS，基于内存，C语言实现</li>
<li>单线程</li>
<li>持久化</li>
<li>支持多种数据结构</li>
<li>支持多种编程语言</li>
<li>功能丰富: 支持Lua脚本,发布订阅,事务,pipeline等功能</li>
<li>简单: 代码短小精悍(单机核心代码只有23000行左右),单线程开发容易,不依赖外部库,使用简单</li>
<li>主从复制</li>
<li>支持高可用和分布式</li>
</ul>
<h3 id="2-1-4-单线程"><a href="#2-1-4-单线程" class="headerlink" title="2.1.4 单线程"></a>2.1.4 单线程</h3><p>Redis 6.0版本前一直是单线程方式处理用户的请求</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis28.png" srcset="/blog/img/loading.gif"></p>
<p>单线程为何如此快?</p>
<ul>
<li>纯内存</li>
<li>非阻塞</li>
<li>避免线程切换和竞态消耗</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis29.png" srcset="/blog/img/loading.gif"></p>
<p>注意事项:</p>
<ul>
<li>一次只运行一条命令</li>
<li>拒绝长(慢)命令:keys, flushall, flushdb, slow lua script, mutil/exec, operate big value(collection)</li>
<li>其实不是单线程: 早期版本是单进程单线程,3版本后实际还有其它的线程, fysnc file descriptor,close file descriptor</li>
</ul>
<h3 id="2-1-5-redis-对比-memcached"><a href="#2-1-5-redis-对比-memcached" class="headerlink" title="2.1.5 redis 对比 memcached"></a>2.1.5 redis 对比 memcached</h3><ul>
<li><p>支持数据的持久化：可以将内存中的数据保持在磁盘中，重启redis服务或者服务器之后可以从备份文件中恢复数据到内存继续使用</p>
</li>
<li><p>支持更多的数据类型：支持string(字符串)、hash(哈希数据)、list(列表)、set(集合)、zset(有序集合)</p>
</li>
<li><p>支持数据的备份：可以实现类似于数据的master-slave模式的数据备份，另外也支持使用快照+AOF</p>
</li>
<li><p>支持更大的value数据：memcache单个key value最大只支持1MB，而redis最大支持512MB(生产不建议超过2M,性能受影响)</p>
</li>
<li><p>在Redis6版本前，Redis 是单线程，而memcached是多线程，所以单机情况下没有 memcached 并发高，性能更好，但redis 支持分布式集群以实现更高的并发，单Redis实例可以实现数万并发</p>
</li>
<li><p>支持集群横向扩展：基于redis cluster的横向扩展，可以实现分布式集群，大幅提升性能和数据安全性</p>
</li>
<li><p>都是基于 C 语言开发</p>
</li>
</ul>
<h3 id="2-1-6-redis-典型应用场景"><a href="#2-1-6-redis-典型应用场景" class="headerlink" title="2.1.6 redis 典型应用场景"></a>2.1.6 redis 典型应用场景</h3><ul>
<li><p>Session 共享：常见于web集群中的Tomcat或者PHP中多web服务器session共享</p>
</li>
<li><p>缓存：数据查询、电商网站商品信息、新闻内容</p>
</li>
<li><p>计数器：访问排行榜、商品浏览数等和次数相关的数值统计场景</p>
</li>
<li><p>微博/微信社交场合：共同好友,粉丝数,关注,点赞评论等</p>
</li>
<li><p>消息队列：ELK的日志缓存、部分业务的订阅发布系统</p>
</li>
<li><p>地理位置: 基于GEO(地理信息定位),实现摇一摇,附近的人,外卖等功能</p>
</li>
</ul>
<p><strong>数据更新操作流程：</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis30.png" srcset="/blog/img/loading.gif"></p>
<p><strong>数据读操作流程：</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis31.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis32.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis33.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis34.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis35.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis36.png" srcset="/blog/img/loading.gif"></p>
<h2 id="2-2-Redis-安装及连接"><a href="#2-2-Redis-安装及连接" class="headerlink" title="2.2 Redis 安装及连接"></a>2.2 Redis 安装及连接</h2><p>官方下载地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://download.redis.io/releases/<br></code></pre></td></tr></table></figure>

<h3 id="2-2-1-yum安装redis"><a href="#2-2-1-yum安装redis" class="headerlink" title="2.2.1 yum安装redis"></a>2.2.1 yum安装redis</h3><p>在centos系统上需要安装epel源</p>
<h4 id="2-2-1-1-查看yum仓库redis版本"><a href="#2-2-1-1-查看yum仓库redis版本" class="headerlink" title="2.2.1.1 查看yum仓库redis版本"></a>2.2.1.1 查看yum仓库redis版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#CentOS 8 由系统源提供</span><br><span class="hljs-comment"># yum info redis</span><br>Name         : redis<br>Version      : 5.0.3<br>Release      : 2.module_el8.2.0+318+3d7e67ea<br>Architecture : x86_64<br>Size         : 925 k<br>Source       : redis-5.0.3-2.module_el8.2.0+318+3d7e67ea.src.rpm<br>Repository   : AppStream<br>Summary      : A persistent key-value database<br>URL          : http://redis.io<br>License      : BSD and MIT<br>Description  : Redis is an advanced key-value store. It is often referred to as a data<br>             : structure server since keys can contain strings, hashes, lists, sets and<br>             : sorted sets.<br>             : <br>             : You can run atomic operations on these types, like appending to a string;<br>             : incrementing the value <span class="hljs-keyword">in</span> a <span class="hljs-built_in">hash</span>; pushing to a list; computing <span class="hljs-built_in">set</span><br>             : intersection, union and difference; or getting the member with highest<br>             : ranking <span class="hljs-keyword">in</span> a sorted <span class="hljs-built_in">set</span>.<br>             : <br>             : In order to achieve its outstanding performance, Redis works with an<br>             : in-memory dataset. Depending on your use <span class="hljs-keyword">case</span>, you can persist it either<br>             : by dumping the dataset to disk every once <span class="hljs-keyword">in</span> a <span class="hljs-keyword">while</span>, or by appending<br>             : each <span class="hljs-built_in">command</span> to a <span class="hljs-built_in">log</span>.<br>             : <br>             : Redis also supports trivial-to-setup master-slave replication, with very<br>             : fast non-blocking first synchronization, auto-reconnection on net split<br>             : and so forth.<br>             : <br>             : Other features include Transactions, Pub/Sub, Lua scripting, Keys with a<br>             : limited time-to-live, and configuration settings to make Redis behave like<br>             : a cache.<br>             : <br>             : You can use Redis from most programming languages also.<br><br>      <br><span class="hljs-comment">#CentOS 7 由epel源提供</span><br><span class="hljs-comment"># yum info redis</span><br>Loaded plugins: fastestmirror<br>Loading mirror speeds from cached hostfile<br>Available Packages<br>Name        : redis<br>Arch        : x86_64<br>Version     : 3.2.12<br>Release     : 2.el7<br>Size        : 544 k<br>Repo        : epel/x86_64<br>Summary     : A persistent key-value database<br>URL         : http://redis.io<br>License     : BSD<br>Description : Redis is an advanced key-value store. It is often referred to as a data<br>            : structure server since keys can contain strings, hashes, lists, sets and<br>            : sorted sets.<br>            : <br>            : You can run atomic operations on these types, like appending to a string;<br>            : incrementing the value <span class="hljs-keyword">in</span> a <span class="hljs-built_in">hash</span>; pushing to a list; computing <span class="hljs-built_in">set</span><br>            : intersection, union and difference; or getting the member with highest<br>            : ranking <span class="hljs-keyword">in</span> a sorted <span class="hljs-built_in">set</span>.<br>            : <br>            : In order to achieve its outstanding performance, Redis works with an<br>            : in-memory dataset. Depending on your use <span class="hljs-keyword">case</span>, you can persist it either<br>            : by dumping the dataset to disk every once <span class="hljs-keyword">in</span> a <span class="hljs-keyword">while</span>, or by appending<br>            : each <span class="hljs-built_in">command</span> to a <span class="hljs-built_in">log</span>.<br>            : <br>            : Redis also supports trivial-to-setup master-slave replication, with very<br>            : fast non-blocking first synchronization, auto-reconnection on net split<br>            : and so forth.<br>            : <br>            : Other features include Transactions, Pub/Sub, Lua scripting, Keys with a<br>            : limited time-to-live, and configuration settings to make Redis behave like<br>            : a cache.<br>            : <br>            : You can use Redis from most programming languages also.<br></code></pre></td></tr></table></figure>

<h4 id="2-2-1-2-yum安装-redis"><a href="#2-2-1-2-yum安装-redis" class="headerlink" title="2.2.1.2 yum安装 redis"></a>2.2.1.2 yum安装 redis</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#以CentOS 8为例</span><br><span class="hljs-comment"># yum -y install redis</span><br><span class="hljs-comment"># systemctl enable --now redis</span><br><span class="hljs-comment"># ss -tnl</span><br>State    Recv-Q    Send-Q    Local Address:Port      Peer<br>Address:Port<br>LISTEN    0       128         0.0.0.0:22         <br>0.0.0.0:*  <br>LISTEN    0       128        127.0.0.1:6379        <br>0.0.0.0:*  <br>LISTEN    0       128          [::]:22          <br>[::]:*  <br><br><span class="hljs-comment"># pstree -p|grep redis</span><br>     |-redis-server(3383)-+-&#123;redis-server&#125;(3384)<br>     |          |-&#123;redis-server&#125;(3385)<br>     |           `-&#123;redis-server&#125;(3386)<br><br><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; ping<br>PONG<br>127.0.0.1:6379&gt; info<br>......<br><span class="hljs-comment"># Server</span><br>redis_version:5.0.3<br>redis_git_sha1:00000000<br>redis_git_dirty:0<br>redis_build_id:8c0bf22bfba82c8f<br>redis_mode:standalone<br>os:Linux 4.18.0-147.el8.x86_64 x86_64<br>......<br></code></pre></td></tr></table></figure>

<h3 id="2-2-2-编译安装-redis"><a href="#2-2-2-编译安装-redis" class="headerlink" title="2.2.2 编译安装 redis"></a>2.2.2 编译安装 redis</h3><p>下载当前最新release版本redis 源码包：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://download.redis.io/releases/<br></code></pre></td></tr></table></figure>



<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis37.png" srcset="/blog/img/loading.gif"></p>
<p>官方的安装方法：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://redis.io/download<br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-1-安装编译需要的依赖包"><a href="#2-2-2-1-安装编译需要的依赖包" class="headerlink" title="2.2.2.1 安装编译需要的依赖包"></a>2.2.2.1 安装编译需要的依赖包</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum -y install gcc jemalloc-devel </span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-2-下载源码"><a href="#2-2-2-2-下载源码" class="headerlink" title="2.2.2.2 下载源码"></a>2.2.2.2 下载源码</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># wget http://download.redis.io/releases/redis-5.0.9.tar.gz</span><br><span class="hljs-comment"># tar xvf redis-5.0.9.tar.gz</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-3-编译安装"><a href="#2-2-2-3-编译安装" class="headerlink" title="2.2.2.3 编译安装"></a>2.2.2.3 编译安装</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd redis-5.0.9/</span><br><span class="hljs-comment"># make PREFIX=/apps/redis install </span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-4-设置环境变量"><a href="#2-2-2-4-设置环境变量" class="headerlink" title="2.2.2.4 设置环境变量"></a>2.2.2.4 设置环境变量</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># echo &#x27;PATH=/apps/redis/bin:$PATH&#x27; &gt; /etc/profile.d/redis.sh</span><br><span class="hljs-comment"># . /etc/profile.d/redis.sh</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-5-查看目录结构"><a href="#2-2-2-5-查看目录结构" class="headerlink" title="2.2.2.5 查看目录结构"></a>2.2.2.5 查看目录结构</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tree /apps/redis/</span><br>/apps/redis/<br>└── bin<br> ├── redis-benchmark<br> ├── redis-check-aof<br> ├── redis-check-rdb<br> ├── redis-cli<br> ├── redis-sentinel -&gt; redis-server<br> └── redis-server<br>1 directory, 6 files<br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-6-准备相关目录和配置文件"><a href="#2-2-2-6-准备相关目录和配置文件" class="headerlink" title="2.2.2.6 准备相关目录和配置文件"></a>2.2.2.6 准备相关目录和配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir /apps/redis/&#123;etc,log,data,run&#125; #创建配置文件、日志、数据等目录</span><br><span class="hljs-comment"># cp redis.conf /apps/redis/etc/</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-7-创建redis账号，修改文件所属"><a href="#2-2-2-7-创建redis账号，修改文件所属" class="headerlink" title="2.2.2.7 创建redis账号，修改文件所属"></a>2.2.2.7 创建redis账号，修改文件所属</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># useradd -r -s /sbin/nologin redis</span><br><span class="hljs-comment"># chown -R redis.redis /apps/redis/</span><br></code></pre></td></tr></table></figure>

<h3 id="2-2-3-前台启动-redis"><a href="#2-2-3-前台启动-redis" class="headerlink" title="2.2.3 前台启动 redis"></a>2.2.3 前台启动 redis</h3><p>redis-server 是 redis 服务器程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-server --help</span><br>Usage: ./redis-server [/path/to/redis.conf] [options]<br>   ./redis-server - (<span class="hljs-built_in">read</span> config from stdin)<br>   ./redis-server -v or --version<br>   ./redis-server -h or --<span class="hljs-built_in">help</span><br>   ./redis-server --test-memory &lt;megabytes&gt;<br><br>Examples:<br>   ./redis-server (run the server with default conf)<br>   ./redis-server /etc/redis/6379.conf<br>   ./redis-server --port 7777<br>   ./redis-server --port 7777 --slaveof 127.0.0.1 8888<br>   ./redis-server /etc/myredis.conf --loglevel verbose<br><br>Sentinel mode:<br>   ./redis-server /etc/sentinel.conf --sentinel<br></code></pre></td></tr></table></figure>

<p><strong>前台启动 redis</strong></p>
<p>在只安装了redis，而没有对Linux做其他设置时，我们会看到日志中有3个”WARNING”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-server /apps/redis/etc/redis.conf</span><br>5111:C 11 Jun 2021 15:17:03.114 <span class="hljs-comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br>5111:C 11 Jun 2021 15:17:03.115 <span class="hljs-comment"># Redis version=5.0.9, bits=64, commit=00000000, modified=0, pid=5111, just started</span><br>5111:C 11 Jun 2021 15:17:03.115 <span class="hljs-comment"># Configuration loaded</span><br>5111:M 11 Jun 2021 15:17:03.115 * Increased maximum number of open files to 10032 (it was originally <span class="hljs-built_in">set</span> to 1024).<br>                _._                                                  <br>           _.-``__ <span class="hljs-string">&#x27;&#x27;</span>-._                                             <br>      _.-``    `.  `_.  <span class="hljs-string">&#x27;&#x27;</span>-._           Redis 5.0.9 (00000000/0) 64 bit<br>  .-`` .-```.  ```\/    _.,_ <span class="hljs-string">&#x27;&#x27;</span>-._                                   <br> (    <span class="hljs-string">&#x27;      ,       .-`  | `,    )     Running in standalone mode</span><br><span class="hljs-string"> |`-._`-...-` __...-.``-._|&#x27;</span>` _.-<span class="hljs-string">&#x27;|     Port: 6379</span><br><span class="hljs-string"> |    `-._   `._    /     _.-&#x27;</span>    |     PID: 5111<br>  `-._    `-._  `-./  _.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                   <br> |`-._`-._    `-.__.-<span class="hljs-string">&#x27;    _.-&#x27;</span>_.-<span class="hljs-string">&#x27;|                                  </span><br><span class="hljs-string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="hljs-string">&#x27;    |           http://redis.io        </span><br><span class="hljs-string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                   <br> |`-._`-._    `-.__.-<span class="hljs-string">&#x27;    _.-&#x27;</span>_.-<span class="hljs-string">&#x27;|                                  </span><br><span class="hljs-string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="hljs-string">&#x27;    |                                  </span><br><span class="hljs-string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                   <br>      `-._    `-.__.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                       <br>          `-._        _.-<span class="hljs-string">&#x27;                                           </span><br><span class="hljs-string">              `-.__.-&#x27;</span>                                               <br><br>5111:M 11 Jun 2021 15:17:03.117 <span class="hljs-comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br>5111:M 11 Jun 2021 15:17:03.117 <span class="hljs-comment"># Server initialized</span><br>5111:M 11 Jun 2021 15:17:03.117 <span class="hljs-comment"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#x27;vm.overcommit_memory = 1&#x27; to /etc/sysctl.conf and then reboot or run the command &#x27;sysctl vm.overcommit_memory=1&#x27; for this to take effect.</span><br>5111:M 11 Jun 2021 15:17:03.117 <span class="hljs-comment"># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &#x27;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#x27; as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span><br>5111:M 11 Jun 2021 15:17:03.117 * Ready to accept connections<br><br><span class="hljs-comment"># ss -ntl</span><br>State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port              <br>LISTEN     0      128                             *:6379                                        *:*                <br>LISTEN     0      128                             *:22                                          *:*                            <br>LISTEN     0      128                          [::]:22                                       [::]:*<br></code></pre></td></tr></table></figure>

<h4 id="2-2-3-1-范例：基于前台启动的-redis-多实例"><a href="#2-2-3-1-范例：基于前台启动的-redis-多实例" class="headerlink" title="2.2.3.1 范例：基于前台启动的 redis 多实例"></a>2.2.3.1 范例：基于前台启动的 redis 多实例</h4><p><strong>终端开启多个窗口，执行以下命令</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#启动redis</span><br><span class="hljs-comment"># redis-server --port 6379</span><br><span class="hljs-comment"># redis-server --port 6380</span><br><br><span class="hljs-comment">#查看端口</span><br><span class="hljs-comment"># ss -tnl</span><br>State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port              <br>LISTEN     0      128                             *:6379                                        *:*                  <br>LISTEN     0      128                             *:6380                                        *:*                  <br>LISTEN     0      128                             *:22                                          *:*                  <br>LISTEN     0      128                          [::]:6379                                     [::]:*                  <br>LISTEN     0      128                          [::]:6380                                     [::]:*                  <br>LISTEN     0      128                          [::]:22                                       [::]:*<br><br><span class="hljs-comment">#查看进程</span><br><span class="hljs-comment"># ps -ef | grep redis | grep -v grep</span><br>root       5243    806  0 21:46 pts/0    00:00:00 redis-server *:6379<br>root       5247   5154  0 21:46 pts/1    00:00:00 redis-server *:6380<br><br><span class="hljs-comment">#使用客户端登录redis</span><br><span class="hljs-comment"># redis-cli -p 6379</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">exit</span><br><span class="hljs-comment"># redis-cli -p 6380</span><br>127.0.0.1:6380&gt; <span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>

<h3 id="2-2-4-redis后台运行"><a href="#2-2-4-redis后台运行" class="headerlink" title="2.2.4 redis后台运行"></a>2.2.4 redis后台运行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#编译安装，且不修改配置文件，redis默认是前台执行</span><br><span class="hljs-comment">#  vim /apps/redis/etc/redis.conf </span><br>......<br><span class="hljs-comment"># By default Redis does not run as a daemon. Use &#x27;yes&#x27; if you need it.</span><br><span class="hljs-comment"># Note that Redis will write a pid file in /var/run/redis.pid when daemonized.</span><br>daemonize yes <span class="hljs-comment">#这里修改为yes</span><br><br>......<br><br><span class="hljs-comment"># redis-server /apps/redis/etc/redis.conf</span><br>5117:C 11 Jun 2021 15:19:29.759 <span class="hljs-comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br>5117:C 11 Jun 2021 15:19:29.759 <span class="hljs-comment"># Redis version=5.0.9, bits=64, commit=00000000, modified=0, pid=5117, just started</span><br>5117:C 11 Jun 2021 15:19:29.759 <span class="hljs-comment"># Configuration loaded</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-4-1-范例-基于后台启动的-redis-多实例"><a href="#2-2-4-1-范例-基于后台启动的-redis-多实例" class="headerlink" title="2.2.4.1 范例: 基于后台启动的 redis 多实例"></a>2.2.4.1 范例: 基于后台启动的 redis 多实例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#将配置文件复制多一份并改名</span><br><span class="hljs-comment"># cp /apps/redis/etc/redis.conf /apps/redis/etc/redis-6379.conf</span><br><span class="hljs-comment"># cp /apps/redis/etc/redis.conf /apps/redis/etc/redis-6380.conf</span><br><br><span class="hljs-comment"># ls /apps/redis/etc</span><br>redis-6379.conf  redis-6380.conf  redis.conf<br><br><span class="hljs-comment">#修改redis-6380.conf的配置文件</span><br><span class="hljs-comment"># vim /apps/redis/etc/redis-6380.conf</span><br>......<br><span class="hljs-comment"># Accept connections on the specified port, default is 6379 (IANA #815344).</span><br><span class="hljs-comment"># If port 0 is specified Redis will not listen on a TCP socket.</span><br>port 6380<br>......<br><br><span class="hljs-comment">#启动redis</span><br><span class="hljs-comment"># redis-server /apps/redis/etc/redis-6379.conf </span><br>5209:C 17 Nov 2022 21:40:00.257 <span class="hljs-comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br>5209:C 17 Nov 2022 21:40:00.257 <span class="hljs-comment"># Redis version=5.0.9, bits=64, commit=00000000, modified=0, pid=5209, just started</span><br>5209:C 17 Nov 2022 21:40:00.257 <span class="hljs-comment"># Configuration loaded             </span><br><span class="hljs-comment"># redis-server /apps/redis/etc/redis-6380.conf </span><br>5225:C 17 Nov 2022 21:40:14.115 <span class="hljs-comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br>5225:C 17 Nov 2022 21:40:14.115 <span class="hljs-comment"># Redis version=5.0.9, bits=64, commit=00000000, modified=0, pid=5225, just started</span><br>5225:C 17 Nov 2022 21:40:14.115 <span class="hljs-comment"># Configuration loaded</span><br><br><span class="hljs-comment">#查看端口</span><br><span class="hljs-comment"># ss -tnl</span><br>State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port              <br>LISTEN     0      128                     127.0.0.1:6379                                        *:*                  <br>LISTEN     0      128                     127.0.0.1:6380                                        *:*                  <br>LISTEN     0      128                             *:22                                          *:*                  <br>LISTEN     0      128                          [::]:22                                       [::]:*<br><br><span class="hljs-comment">#查看进程</span><br><span class="hljs-comment"># ps -ef|grep redis | grep -v grep</span><br>root       5210      1  0 21:39 ?        00:00:00 redis-server 127.0.0.1:6379<br>root       5226      1  0 21:40 ?        00:00:00 redis-server 127.0.0.1:6380<br><br><span class="hljs-comment">#使用客户端登录redis</span><br><span class="hljs-comment"># redis-cli -p 6379</span><br>127.0.0.1:6379&gt; <br><span class="hljs-comment"># redis-cli -p 6380</span><br>127.0.0.1:6380&gt;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-5-解决启动时的三个警告提示"><a href="#2-2-5-解决启动时的三个警告提示" class="headerlink" title="2.2.5 解决启动时的三个警告提示"></a>2.2.5 解决启动时的三个警告提示</h3><h4 id="2-2-5-1-tcp-backlog"><a href="#2-2-5-1-tcp-backlog" class="headerlink" title="2.2.5.1 tcp-backlog"></a>2.2.5.1 tcp-backlog</h4><p><strong>WARNING提示</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is <span class="hljs-built_in">set</span> to the lower value of 128.<br></code></pre></td></tr></table></figure>

<p>backlog参数控制的是三次握手的时候server端收到client ack确认号之后的队列值，即全连接队列</p>
<p>解决方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /etc/sysctl.conf</span><br>net.core.somaxconn = 1024<br><br><span class="hljs-comment"># sysctl -p</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-2-vm-overcommit-memory"><a href="#2-2-5-2-vm-overcommit-memory" class="headerlink" title="2.2.5.2 vm.overcommit_memory"></a>2.2.5.2 vm.overcommit_memory</h4><p><strong>WARNING提示</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">WARNING overcommit_memory is <span class="hljs-built_in">set</span> to 0! Background save may fail under low memorycondition. To fix this issue add <span class="hljs-string">&#x27;vm.overcommit_memory = 1&#x27;</span> to /etc/sysctl.conf and <span class="hljs-keyword">then</span> reboot or run the <span class="hljs-built_in">command</span> <span class="hljs-string">&#x27;sysctl vm.overcommit_memory=1&#x27;</span> <span class="hljs-keyword">for</span> this totake effect.<br></code></pre></td></tr></table></figure>

<p>内核参数说明:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">0、表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程。<br>1、表示内核允许分配所有的物理内存，而不管当前的内存状态如何<br>2、表示内核允许分配超过所有物理内存和交换空间总和的内存<br></code></pre></td></tr></table></figure>

<p>解决方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /etc/sysctl.conf</span><br>vm.overcommit_memory = 1<br><br><span class="hljs-comment">#sysctl -p</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-3-transparent-hugepage"><a href="#2-2-5-3-transparent-hugepage" class="headerlink" title="2.2.5.3 transparent hugepage"></a>2.2.5.3 transparent hugepage</h4><p><strong>WARNING提示</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">WARNING you have Transparent Huge Pages (THP) support enabled <span class="hljs-keyword">in</span> your kernel.This will create latency and memory usage issues with Redis. To fix this issue run the <span class="hljs-built_in">command</span> <span class="hljs-string">&#x27;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#x27;</span> as root, and add it to your /etc/rc.local <span class="hljs-keyword">in</span> order to retain the setting after a reboot. Redis must be restarted after THP is disabled.<br><br>警告：您在内核中启用了透明大页面（THP,不同于一般内存页的4k为2M）支持。 这将在Redis中造成延迟和内存使用问题。 要解决此问题，请以root 用户身份运行命令“<span class="hljs-built_in">echo</span> never&gt;/sys/kernel/mm/transparent_hugepage/enabled”，并将其添加到您的/etc/rc.local中，以便在重启后保留设置。禁用THP后，必须重新启动Redis。<br></code></pre></td></tr></table></figure>

<p>解决方法：</p>
<p><strong>以下命令都要执行</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#临时性修改内核参数</span><br><span class="hljs-comment"># echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="hljs-comment">#永久性修改内核参数</span><br><span class="hljs-comment"># echo &#x27;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#x27; &gt;&gt; /etc/rc.d/rc.local</span><br><span class="hljs-comment"># chmod +x /etc/rc.d/rc.local</span><br><span class="hljs-comment"># /etc/rc.d/rc.local</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-4-再次启动-redis"><a href="#2-2-5-4-再次启动-redis" class="headerlink" title="2.2.5.4 再次启动 redis"></a>2.2.5.4 再次启动 redis</h4><p>将以上配置同步到其他redis 服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#redis-server /apps/redis/etc/redis.conf</span><br>1163:C 12 Jun 2021 10:51:01.455 <span class="hljs-comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br>1163:C 12 Jun 2021 10:51:01.455 <span class="hljs-comment"># Redis version=5.0.9, bits=64, commit=00000000, modified=0, pid=1163, just started</span><br>1163:C 12 Jun 2021 10:51:01.455 <span class="hljs-comment"># Configuration loaded</span><br>1164:M 12 Jun 2021 10:51:01.455 * Increased maximum number of open files to 10032 (it was originally <span class="hljs-built_in">set</span> to 1024).<br>                _._                                                  <br>           _.-``__ <span class="hljs-string">&#x27;&#x27;</span>-._                                             <br>      _.-``    `.  `_.  <span class="hljs-string">&#x27;&#x27;</span>-._           Redis 5.0.9 (00000000/0) 64 bit<br>  .-`` .-```.  ```\/    _.,_ <span class="hljs-string">&#x27;&#x27;</span>-._                                   <br> (    <span class="hljs-string">&#x27;      ,       .-`  | `,    )     Running in standalone mode</span><br><span class="hljs-string"> |`-._`-...-` __...-.``-._|&#x27;</span>` _.-<span class="hljs-string">&#x27;|     Port: 6379</span><br><span class="hljs-string"> |    `-._   `._    /     _.-&#x27;</span>    |     PID: 1164<br>  `-._    `-._  `-./  _.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                   <br> |`-._`-._    `-.__.-<span class="hljs-string">&#x27;    _.-&#x27;</span>_.-<span class="hljs-string">&#x27;|                                  </span><br><span class="hljs-string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="hljs-string">&#x27;    |           http://redis.io        </span><br><span class="hljs-string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                   <br> |`-._`-._    `-.__.-<span class="hljs-string">&#x27;    _.-&#x27;</span>_.-<span class="hljs-string">&#x27;|                                  </span><br><span class="hljs-string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="hljs-string">&#x27;    |                                  </span><br><span class="hljs-string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                   <br>      `-._    `-.__.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                       <br>          `-._        _.-<span class="hljs-string">&#x27;                                           </span><br><span class="hljs-string">              `-.__.-&#x27;</span>                                               <br><br>1164:M 12 Jun 2021 10:51:01.456 <span class="hljs-comment"># Server initialized</span><br>1164:M 12 Jun 2021 10:51:01.531 * DB loaded from disk: 0.075 seconds<br>1164:M 12 Jun 2021 10:51:01.531 * Ready to accept connections<br></code></pre></td></tr></table></figure>

<h3 id="2-2-6-redis使用systemctl启动"><a href="#2-2-6-redis使用systemctl启动" class="headerlink" title="2.2.6 redis使用systemctl启动"></a>2.2.6 redis使用systemctl启动</h3><h4 id="2-2-6-1-添加-redis-service-unit文件"><a href="#2-2-6-1-添加-redis-service-unit文件" class="headerlink" title="2.2.6.1 添加 redis service unit文件"></a>2.2.6.1 添加 redis service unit文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#复制CentOS8安装生成的redis.service文件，进行修改</span><br><span class="hljs-comment"># vim /usr/lib/systemd/system/redis.service</span><br>[Unit]<br>Description=Redis persistent key-value database<br>After=network.target<br><br>[Service]<br>ExecStart=/apps/redis/bin/redis-server /apps/redis/etc/redis.conf --supervised systemd<br>ExecStop=/bin/<span class="hljs-built_in">kill</span> -s QUIT <span class="hljs-variable">$MAINPID</span><br>Type=notify<br>User=redis<br>Group=redis<br>RuntimeDirectory=redis<br>RuntimeDirectoryMode=0755<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<h4 id="2-2-6-2-验证-redis-启动"><a href="#2-2-6-2-验证-redis-启动" class="headerlink" title="2.2.6.2 验证 redis 启动"></a>2.2.6.2 验证 redis 启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># systemctl daemon-reload</span><br><span class="hljs-comment"># systemctl start redis</span><br><span class="hljs-comment"># ss -ntl</span><br>State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port              <br>LISTEN     0      511                     127.0.0.1:6379                                        *:*                  <br>LISTEN     0      128                             *:22                                          *:*                  <br>LISTEN     0      128                          [::]:22                                       [::]:*<br></code></pre></td></tr></table></figure>

<h3 id="2-2-7-使用客户端连接-redis"><a href="#2-2-7-使用客户端连接-redis" class="headerlink" title="2.2.7 使用客户端连接 redis"></a>2.2.7 使用客户端连接 redis</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis38.png" srcset="/blog/img/loading.gif"></p>
<p>使用方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># /apps/redis/bin/redis-cli -h IP/HOSTNAME -p PORT -a PASSWORD</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; ping<br>PONG<br>127.0.0.1:6379&gt; info<br><span class="hljs-comment"># Server</span><br>redis_version:5.0.7<br>redis_git_sha1:00000000<br>redis_git_dirty:0<br>redis_build_id:673d8c0ee1a8872<br>redis_mode:standalone<br>os:Linux 3.10.0-1062.el7.x86_64 x86_64<br>arch_bits:64<br>multiplexing_api:epoll<br>atomicvar_api:atomic-builtin<br>gcc_version:4.8.5<br>process_id:1669<br>run_id:5e0420e92e35ad1d740e9431bc655bfd0044a5d1<br>tcp_port:6379<br>uptime_in_seconds:140<br>uptime_in_days:0<br>hz:10<br>configured_hz:10<br>lru_clock:4807524<br>executable:/apps/redis/bin/redis-server<br>config_file:/apps/redis/etc/redis.conf<br><br><span class="hljs-comment"># Clients</span><br>connected_clients:1<br>client_recent_max_input_buffer:2<br>client_recent_max_output_buffer:0<br>blocked_clients:0<br><br><span class="hljs-comment"># Memory</span><br>used_memory:575792<br>used_memory_human:562.30K<br>used_memory_rss:3506176<br>used_memory_rss_human:3.34M<br>used_memory_peak:575792<br>used_memory_peak_human:562.30K<br>used_memory_peak_perc:100.18%<br>used_memory_overhead:562590<br>used_memory_startup:512896<br>used_memory_dataset:13202<br>used_memory_dataset_perc:20.99%<br>allocator_allocated:1201392<br>allocator_active:1531904<br>allocator_resident:8310784<br>total_system_memory:1019645952<br>total_system_memory_human:972.41M<br>used_memory_lua:37888<br>used_memory_lua_human:37.00K<br>used_memory_scripts:0<br>used_memory_scripts_human:0B<br>number_of_cached_scripts:0<br>maxmemory:0<br>maxmemory_human:0B<br>maxmemory_policy:noeviction<br>allocator_frag_ratio:1.28<br>allocator_frag_bytes:330512<br>allocator_rss_ratio:5.43<br>allocator_rss_bytes:6778880<br>rss_overhead_ratio:0.42<br>rss_overhead_bytes:-4804608<br>mem_fragmentation_ratio:6.57<br>mem_fragmentation_bytes:2972384<br>mem_not_counted_for_evict:0<br>mem_replication_backlog:0<br>mem_clients_slaves:0<br>mem_clients_normal:49694<br>mem_aof_buffer:0<br>mem_allocator:jemalloc-5.1.0<br>active_defrag_running:0<br>lazyfree_pending_objects:0<br><br><span class="hljs-comment"># Persistence</span><br>loading:0<br>rdb_changes_since_last_save:0<br>rdb_bgsave_in_progress:0<br>rdb_last_save_time:1581865688<br>rdb_last_bgsave_status:ok<br>rdb_last_bgsave_time_sec:-1<br>rdb_current_bgsave_time_sec:-1<br>rdb_last_cow_size:0<br>aof_enabled:0<br>aof_rewrite_in_progress:0<br>aof_rewrite_scheduled:0<br>aof_last_rewrite_time_sec:-1<br>aof_current_rewrite_time_sec:-1<br>aof_last_bgrewrite_status:ok<br>aof_last_write_status:ok<br>aof_last_cow_size:0<br><br><span class="hljs-comment"># Stats</span><br>total_connections_received:1<br>total_commands_processed:2<br>instantaneous_ops_per_sec:0<br>total_net_input_bytes:45<br>total_net_output_bytes:11475<br>instantaneous_input_kbps:0.00<br>instantaneous_output_kbps:0.00<br>rejected_connections:0<br>sync_full:0<br>sync_partial_ok:0<br>sync_partial_err:0<br>expired_keys:0<br>expired_stale_perc:0.00<br>expired_time_cap_reached_count:0<br>evicted_keys:0<br>keyspace_hits:0<br>keyspace_misses:0<br>pubsub_channels:0<br>pubsub_patterns:0<br>latest_fork_usec:0<br>migrate_cached_sockets:0<br>slave_expires_tracked_keys:0<br>active_defrag_hits:0<br>active_defrag_misses:0<br>active_defrag_key_hits:0<br>active_defrag_key_misses:0<br><br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:0<br>master_replid:f7228f0b6203183004fae8db00568f9f73422dc4<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br><br><span class="hljs-comment"># CPU</span><br>used_cpu_sys:0.132821<br>used_cpu_user:0.124317<br>used_cpu_sys_children:0.000000<br>used_cpu_user_children:0.000000<br><br><span class="hljs-comment"># Cluster</span><br>cluster_enabled:0<br><br><span class="hljs-comment"># Keyspace</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>

<h3 id="2-2-8-创建命令软连接"><a href="#2-2-8-创建命令软连接" class="headerlink" title="2.2.8 创建命令软连接"></a>2.2.8 创建命令软连接</h3><p><strong>设置环境变量可以省去这一步</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ln -sv /apps/redis/bin/redis-* /usr/bin/</span><br>‘/usr/bin/redis-benchmark’ -&gt; ‘/apps/redis/bin/redis-benchmark’<br>‘/usr/bin/redis-check-aof’ -&gt; ‘/apps/redis/bin/redis-check-aof’<br>‘/usr/bin/redis-check-rdb’ -&gt; ‘/apps/redis/bin/redis-check-rdb’<br>‘/usr/bin/redis-cli’ -&gt; ‘/apps/redis/bin/redis-cli’<br>‘/usr/bin/redis-sentinel’ -&gt; ‘/apps/redis/bin/redis-sentinel’<br>‘/usr/bin/redis-server’ -&gt; ‘/apps/redis/bin/redis-server’<br></code></pre></td></tr></table></figure>

<h3 id="2-2-9-编译安装后的命令"><a href="#2-2-9-编译安装后的命令" class="headerlink" title="2.2.9 编译安装后的命令"></a>2.2.9 编译安装后的命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ll /apps/redis/bin/</span><br>total 32772<br>-rwxr-xr-x 1 root root 4366792 Feb 16 21:12 redis-benchmark <span class="hljs-comment">#redis性能测试工具</span><br>-rwxr-xr-x 1 root root 8125184 Feb 16 21:12 redis-check-aof <span class="hljs-comment">#AOF文件检查工具</span><br>-rwxr-xr-x 1 root root 8125184 Feb 16 21:12 redis-check-rdb <span class="hljs-comment">#RDB文件检查工具</span><br>-rwxr-xr-x 1 root root 4807856 Feb 16 21:12 redis-cli    <span class="hljs-comment">#客户端工具</span><br>lrwxrwxrwx 1 root root    12 Feb 16 21:12 redis-sentinel -&gt; redis-server <span class="hljs-comment">#哨兵，软连接到server</span><br>-rwxr-xr-x 1 root root 8125184 Feb 16 21:12 redis-server <span class="hljs-comment">#redis 服务启动命令</span><br></code></pre></td></tr></table></figure>

<h3 id="2-2-10-实战案例：一键编译安装Redis脚本"><a href="#2-2-10-实战案例：一键编译安装Redis脚本" class="headerlink" title="2.2.10 实战案例：一键编译安装Redis脚本"></a>2.2.10 实战案例：一键编译安装Redis脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># cat install_redis_for_centos.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>. /etc/init.d/<span class="hljs-built_in">functions</span><br>VERSION=redis-4.0.14<br>PASSWORD=123456<br>INSTALL_DIR=/apps/redis<br><br><span class="hljs-function"><span class="hljs-title">install</span></span>() &#123;<br>yum install -y install gcc jemalloc-devel || &#123; action <span class="hljs-string">&quot;安装软件包失败，请检查网络配置&quot;</span> <span class="hljs-literal">false</span>; <span class="hljs-built_in">exit</span>; &#125;<br><br>wget http://download.redis.io/releases/<span class="hljs-variable">$&#123;VERSION&#125;</span>.tar.gz || &#123; action <span class="hljs-string">&quot;Redis 源码下载失败&quot;</span> <span class="hljs-literal">false</span> ; <span class="hljs-built_in">exit</span>; &#125;<br><br>tar xf <span class="hljs-variable">$&#123;VERSION&#125;</span>.tar.gz<br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;VERSION&#125;</span><br>make -j 4 PREFIX=<span class="hljs-variable">$&#123;INSTALL_DIR&#125;</span> install &amp;&amp; action <span class="hljs-string">&quot;Redis 编译安装完成&quot;</span> || &#123; action <span class="hljs-string">&quot;Redis 编译安装失败&quot;</span> <span class="hljs-literal">false</span> ;<span class="hljs-built_in">exit</span> ; &#125;<br><br>ln -s <span class="hljs-variable">$&#123;INSTALL_DIR&#125;</span>/bin/redis-* /usr/bin/<br>mkdir -p <span class="hljs-variable">$&#123;INSTALL_DIR&#125;</span>/&#123;etc,<span class="hljs-built_in">log</span>,data,run&#125;<br>cp redis.conf <span class="hljs-variable">$&#123;INSTALL_DIR&#125;</span>/etc/ &amp;&amp; action <span class="hljs-string">&quot;成功复制redis.conf文件&quot;</span> || &#123; action <span class="hljs-string">&quot;redis.conf文件复制失败&quot;</span> <span class="hljs-literal">false</span>; <span class="hljs-built_in">exit</span>; &#125;<br><br>sed -i -e <span class="hljs-string">&#x27;s/bind 127.0.0.1/bind 0.0.0.0/&#x27;</span> -e <span class="hljs-string">&quot;/# requirepass/a requirepass <span class="hljs-variable">$PASSWORD</span>&quot;</span> -e <span class="hljs-string">&quot;/^dir .*/c dir <span class="hljs-variable">$&#123;INSTALL_DIR&#125;</span>/data/&quot;</span> -e <span class="hljs-string">&quot;/logfile .*/c logfile <span class="hljs-variable">$&#123;INSTALL_DIR&#125;</span>/log/redis-6379.log&quot;</span> -e <span class="hljs-string">&quot;/^pidfile .*/c pidfile <span class="hljs-variable">$&#123;INSTALL_DIR&#125;</span>/run/redis_6379.pid&quot;</span> <span class="hljs-variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf<br><br><span class="hljs-keyword">if</span> id redis &amp;&gt; /dev/null ;<span class="hljs-keyword">then</span><br> action <span class="hljs-string">&quot;Redis 用户已存在&quot;</span> <span class="hljs-literal">false</span> <br><span class="hljs-keyword">else</span><br> useradd -r -s /sbin/nologin redis<br> action <span class="hljs-string">&quot;Redis 用户创建成功&quot;</span><br><span class="hljs-keyword">fi</span><br><br>chown -R redis.redis <span class="hljs-variable">$&#123;INSTALL_DIR&#125;</span><br><br>cat &gt;&gt; /etc/sysctl.conf &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">net.core.somaxconn = 1024</span><br><span class="hljs-string">vm.overcommit_memory = 1</span><br><span class="hljs-string">EOF</span><br>sysctl -p<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#x27;</span> &gt;&gt; /etc/rc.d/rc.local<br>chmod +x /etc/rc.d/rc.local<br>/etc/rc.d/rc.local<br>cat &gt; /usr/lib/systemd/system/redis.service &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description=Redis persistent key-value database</span><br><span class="hljs-string">After=network.target</span><br><span class="hljs-string"></span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">ExecStart=$&#123;INSTALL_DIR&#125;/bin/redis-server $&#123;INSTALL_DIR&#125;/etc/redis.conf --supervised systemd</span><br><span class="hljs-string">ExecStop=/bin/kill -s QUIT \$MAINPID</span><br><span class="hljs-string">#Type=notify</span><br><span class="hljs-string">User=redis</span><br><span class="hljs-string">Group=redis</span><br><span class="hljs-string">RuntimeDirectory=redis</span><br><span class="hljs-string">RuntimeDirectoryMode=0755</span><br><span class="hljs-string"></span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string"></span><br><span class="hljs-string">EOF</span><br><br>systemctl daemon-reload<br>chown -R redis.redis <span class="hljs-variable">$&#123;INSTALL_DIR&#125;</span><br>systemctl <span class="hljs-built_in">enable</span> --now redis.service &amp;&gt; /dev/null &amp;&amp; action <span class="hljs-string">&quot;Redis 服务启动成功,Redis信息如下:&quot;</span> || &#123; action <span class="hljs-string">&quot;Redis 启动失败&quot;</span> <span class="hljs-literal">false</span> ;<span class="hljs-built_in">exit</span>; &#125;<br><br>redis-cli -a <span class="hljs-variable">$PASSWORD</span> INFO Server 2&gt; /dev/null<br><br>&#125;<br><br>install<br></code></pre></td></tr></table></figure>

<h3 id="2-2-11-windows-安装-redis"><a href="#2-2-11-windows-安装-redis" class="headerlink" title="2.2.11 windows 安装 redis"></a>2.2.11 windows 安装 redis</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis39.png" srcset="/blog/img/loading.gif"></p>
<p>官方没有提供 windows 版本</p>
<p>Windows版 Redis下载地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://github.com/MicrosoftArchive/redis/releases<br></code></pre></td></tr></table></figure>

<p>强烈不推荐在生产环境使用Windows 系统运行Redis服务</p>
<h4 id="2-2-11-1-下载并安装-redis"><a href="#2-2-11-1-下载并安装-redis" class="headerlink" title="2.2.11.1 下载并安装 redis"></a>2.2.11.1 下载并安装 redis</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis40.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis41.png" srcset="/blog/img/loading.gif" alt="redis41"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis42.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis43.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis44.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis45.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis46.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis47.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis48.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis49.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-2-11-2-编辑配置文件并执行redis-server-exe"><a href="#2-2-11-2-编辑配置文件并执行redis-server-exe" class="headerlink" title="2.2.11.2 编辑配置文件并执行redis-server.exe"></a>2.2.11.2 编辑配置文件并执行redis-server.exe</h4><p>修改redis.windows.conf配置文件的两行</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis50.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis51.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启动redis</span><br>C:\Program Files\Redis&gt;redis-server redis.windows.conf<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis52.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-2-11-3-验证Redis服务端口"><a href="#2-2-11-3-验证Redis服务端口" class="headerlink" title="2.2.11.3 验证Redis服务端口"></a>2.2.11.3 验证Redis服务端口</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis53.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-2-11-4-执行redis-cli客户端"><a href="#2-2-11-4-执行redis-cli客户端" class="headerlink" title="2.2.11.4 执行redis-cli客户端"></a>2.2.11.4 执行redis-cli客户端</h4><p>使用客户端连接到Windows版redis server，进行创建key与获取key操作</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis54.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-2-12-连接到-Redis"><a href="#2-2-12-连接到-Redis" class="headerlink" title="2.2.12 连接到 Redis"></a>2.2.12 连接到 Redis</h3><p><strong>主要分为客户端连接和程序的连接</strong></p>
<h4 id="2-2-12-1-客户端连接-redis"><a href="#2-2-12-1-客户端连接-redis" class="headerlink" title="2.2.12.1 客户端连接 redis"></a>2.2.12.1 客户端连接 redis</h4><h5 id="2-2-12-1-1-本机无密码连接"><a href="#2-2-12-1-1-本机无密码连接" class="headerlink" title="2.2.12.1.1 本机无密码连接"></a>2.2.12.1.1 本机无密码连接</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli</span><br></code></pre></td></tr></table></figure>

<h5 id="2-2-12-1-2-跨主机无密码连接"><a href="#2-2-12-1-2-跨主机无密码连接" class="headerlink" title="2.2.12.1.2 跨主机无密码连接"></a>2.2.12.1.2 跨主机无密码连接</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -h HOSTNAME/IP -p PORT</span><br></code></pre></td></tr></table></figure>

<h5 id="2-2-12-1-3-跨主机密码连接"><a href="#2-2-12-1-3-跨主机密码连接" class="headerlink" title="2.2.12.1.3 跨主机密码连接"></a>2.2.12.1.3 跨主机密码连接</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -h HOSTNAME/IP -p PORT -a PASSWORD</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-12-2-程序连接-Redis"><a href="#2-2-12-2-程序连接-Redis" class="headerlink" title="2.2.12.2 程序连接 Redis"></a>2.2.12.2 程序连接 Redis</h4><p>redis 支持多种开发语言访问</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis55.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis56.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-2-12-2-1-shell-脚本写入数据到-Redis"><a href="#2-2-12-2-1-shell-脚本写入数据到-Redis" class="headerlink" title="2.2.12.2.1 shell 脚本写入数据到 Redis"></a>2.2.12.2.1 shell 脚本写入数据到 Redis</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim redis_test.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>NUM=100000<br>PASS=<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> `seq <span class="hljs-variable">$NUM</span>`;<span class="hljs-keyword">do</span><br>    redis-cli -h 127.0.0.1 -a <span class="hljs-string">&quot;<span class="hljs-variable">$PASS</span>&quot;</span> --no-auth-warning <span class="hljs-built_in">set</span> key<span class="hljs-variable">$&#123;i&#125;</span> value<span class="hljs-variable">$&#123;i&#125;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;key<span class="hljs-variable">$&#123;i&#125;</span> value<span class="hljs-variable">$&#123;i&#125;</span> 写入完成&quot;</span><br><span class="hljs-keyword">done</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NUM</span>个key写入到Redis完成&quot;</span><br></code></pre></td></tr></table></figure>

<h5 id="2-2-12-2-2-python-连接方式"><a href="#2-2-12-2-2-python-连接方式" class="headerlink" title="2.2.12.2.2 python 连接方式"></a>2.2.12.2.2 python 连接方式</h5><p>python 多种开发库,可以支持连接redis</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis57.png" srcset="/blog/img/loading.gif"></p>
<p>使用redis-py 连接 redis</p>
<p>官方github :</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://github.com/andymccurdy/redis-py<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># yum info python3-redis</span><br>Last metadata expiration check: 1 day, 10:19:31 ago on Thu 15 Oct 2020 11:03:33<br>PM CST.<br>Installed Packages<br>Name     : python3-redis<br>Version   : 3.3.8<br>Release   : 1.el8<br>Architecture : noarch<br>Size     : 523 k<br>Source    : python-redis-3.3.8-1.el8.src.rpm<br>Repository  : @System<br>From repo  : epel<br>Summary   : Python 3 interface to the Redis key-value store<br>URL     : https://github.com/andymccurdy/redis-py<br>License   : MIT<br>Description : This is a Python 3 interface to the Redis key-value store.<br><br><span class="hljs-comment"># yum -y install python3 python3-redis</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注意文件名不要为redis,会和redis模块名称冲突</span><br><span class="hljs-comment"># vim redis_test.py</span><br><span class="hljs-comment">#!/bin/env python3</span><br>import redis<br><span class="hljs-comment">#import time</span><br>pool = redis.ConnectionPool(host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>,port=6379,password=<span class="hljs-string">&quot;&quot;</span>)<br>r = redis.Redis(connection_pool=pool)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(100):<br>     r.set(<span class="hljs-string">&quot;k%d&quot;</span> % i,<span class="hljs-string">&quot;v%d&quot;</span> % i)<br><span class="hljs-comment">#    time.sleep(1)</span><br>     data=r.get(<span class="hljs-string">&quot;k%d&quot;</span> % i)<br>     <span class="hljs-built_in">print</span>(data)<br><br><span class="hljs-comment"># python3 redis_test.py</span><br>......<br>b<span class="hljs-string">&#x27;v94&#x27;</span><br>b<span class="hljs-string">&#x27;v95&#x27;</span><br>b<span class="hljs-string">&#x27;v96&#x27;</span><br>b<span class="hljs-string">&#x27;v97&#x27;</span><br>b<span class="hljs-string">&#x27;v98&#x27;</span><br>b<span class="hljs-string">&#x27;v99&#x27;</span><br><br><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; get k10<br><span class="hljs-string">&quot;v10&quot;</span><br>127.0.0.1:6379&gt;<br></code></pre></td></tr></table></figure>

<p>范例：对比shell脚本和pyehon脚本输入redis的速度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#两种语言的脚本各输入100000个数据的时间对比</span><br><span class="hljs-comment">#shell脚本脚本输入100000个数据的时间</span><br><span class="hljs-comment"># time ./redis_test.sh</span><br>......<br>OK<br>key99998 value99998 写入完成<br>OK<br>key99999 value99999 写入完成<br>OK<br>key100000 value100000 写入完成<br>100000个key写入到Redis完成<br><br>real	2m19.456s<br>user	0m48.389s<br>sys	1m7.368s<br><br><span class="hljs-comment">#python脚本输入100000个数据的时间</span><br><span class="hljs-comment"># time ./redis_test.py</span><br>b<span class="hljs-string">&#x27;v99994&#x27;</span><br>b<span class="hljs-string">&#x27;v99995&#x27;</span><br>b<span class="hljs-string">&#x27;v99996&#x27;</span><br>b<span class="hljs-string">&#x27;v99997&#x27;</span><br>b<span class="hljs-string">&#x27;v99998&#x27;</span><br>b<span class="hljs-string">&#x27;v99999&#x27;</span><br><br>real	0m12.451s<br>user	0m6.504s<br>sys	0m1.783s<br></code></pre></td></tr></table></figure>

<h3 id="2-2-13-图形工具连接"><a href="#2-2-13-图形工具连接" class="headerlink" title="2.2.13 图形工具连接"></a>2.2.13 图形工具连接</h3><p>有一此第三方开发的图形工具也可以连接redis ，比如: RedisDesktopManager</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis58.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis59.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis60.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-2-14-redis-的多实例"><a href="#2-2-14-redis-的多实例" class="headerlink" title="2.2.14 redis 的多实例"></a>2.2.14 redis 的多实例</h3><p>测试环境中经常使用多实例，需要指定不同实例的相应的端口，配置文件，日志文件等相关配置</p>
<h4 id="2-2-14-1-添加配置文件"><a href="#2-2-14-1-添加配置文件" class="headerlink" title="2.2.14.1 添加配置文件"></a>2.2.14.1 添加配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp /apps/redis/etc/redis.conf /apps/redis/etc/redis_6379.conf </span><br><span class="hljs-comment"># cp /apps/redis/etc/redis.conf /apps/redis/etc/redis_6380.conf </span><br><span class="hljs-comment"># cp /apps/redis/etc/redis.conf /apps/redis/etc/redis_6381.conf</span><br><span class="hljs-comment"># tree /apps/redis/</span><br>/apps/redis/<br>├── bin<br>│   ├── redis-benchmark<br>│   ├── redis-check-aof<br>│   ├── redis-check-rdb<br>│   ├── redis-cli<br>│   ├── redis-sentinel -&gt; redis-server<br>│   └── redis-server<br>├── data<br>├── etc<br>│   ├── redis_6379.conf<br>│   ├── redis_6380.conf<br>│   └── redis_6381.conf<br>├── <span class="hljs-built_in">log</span><br>└── run<br></code></pre></td></tr></table></figure>

<h4 id="2-2-14-2-修改第一个实例的匹配文件"><a href="#2-2-14-2-修改第一个实例的匹配文件" class="headerlink" title="2.2.14.2 修改第一个实例的匹配文件"></a>2.2.14.2 修改第一个实例的匹配文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#修改配置文件，其他实例都按以下配置根据需求修改</span><br><span class="hljs-comment"># grep &#x27;^[^#]&#x27; /apps/redis/etc/redis_6379.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br>protected-mode yes<br>port 6379<br>tcp-backlog 511<br>timeout 0<br>tcp-keepalive 300<br>daemonize yes<br>supervised no<br>pidfile /apps/redis/run/redis_6379.pid<br>loglevel notice<br>logfile <span class="hljs-string">&quot;/apps/redis/log/redis_6379.log&quot;</span><br>databases 16<br>always-show-logo yes<br>save 900 1<br>save 300 10<br>save 60 10000<br>stop-writes-on-bgsave-error yes<br>rdbcompression yes<br>rdbchecksum yes<br>dbfilename dump_6379.rdb<br>dir /apps/redis/data/<br>replica-serve-stale-data yes<br>replica-read-only yes<br>repl-diskless-sync no<br>repl-diskless-sync-delay 5<br>repl-disable-tcp-nodelay no<br>replica-priority 100<br>lazyfree-lazy-eviction no<br>lazyfree-lazy-expire no<br>lazyfree-lazy-server-del no<br>replica-lazy-flush no<br>appendonly no<br>appendfilename <span class="hljs-string">&quot;appendonly_6379.aof&quot;</span><br>appendfsync everysec<br>no-appendfsync-on-rewrite no<br>auto-aof-rewrite-percentage 100<br>auto-aof-rewrite-min-size 64mb<br>aof-load-truncated yes<br>aof-use-rdb-preamble yes<br>lua-time-limit 5000<br>slowlog-log-slower-than 10000<br>slowlog-max-len 128<br>latency-monitor-threshold 0<br>notify-keyspace-events <span class="hljs-string">&quot;&quot;</span><br>hash-max-ziplist-entries 512<br>hash-max-ziplist-value 64<br>list-max-ziplist-size -2<br>list-compress-depth 0<br>set-max-intset-entries 512<br>zset-max-ziplist-entries 128<br>zset-max-ziplist-value 64<br>hll-sparse-max-bytes 3000<br>stream-node-max-bytes 4096<br>stream-node-max-entries 100<br>activerehashing yes<br>client-output-buffer-limit normal 0 0 0<br>client-output-buffer-limit replica 256mb 64mb 60<br>client-output-buffer-limit pubsub 32mb 8mb 60<br>hz 10<br>dynamic-hz yes<br>aof-rewrite-incremental-fsync yes<br>rdb-save-incremental-fsync yes<br></code></pre></td></tr></table></figure>

<h4 id="2-2-14-3-添加第二个实例的配置文件"><a href="#2-2-14-3-添加第二个实例的配置文件" class="headerlink" title="2.2.14.3 添加第二个实例的配置文件"></a>2.2.14.3 添加第二个实例的配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># sed &#x27;s/6379/6380/g&#x27; /apps/redis/etc/redis_6379.conf &gt; /apps/redis/etc/redis_6380.conf</span><br><span class="hljs-comment"># grep 6380 /apps/redis/etc/redis_6380.conf</span><br><span class="hljs-comment"># Accept connections on the specified port, default is 6380 (IANA #815344).</span><br>port 6380<br>pidfile /apps/redis/run/redis_6380.pid<br>logfile <span class="hljs-string">&quot;/apps/redis/log/redis_6380.log&quot;</span><br>dbfilename dump_6380.rdb<br>appendfilename <span class="hljs-string">&quot;appendonly_6380.aof&quot;</span><br><span class="hljs-comment"># cluster-config-file nodes-6380.conf</span><br><span class="hljs-comment"># cluster-announce-port 6380</span><br><span class="hljs-comment"># cluster-announce-bus-port 6380</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-14-4-添加第三个实例的配置文件"><a href="#2-2-14-4-添加第三个实例的配置文件" class="headerlink" title="2.2.14.4 添加第三个实例的配置文件"></a>2.2.14.4 添加第三个实例的配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># sed &#x27;s/6379/6381/g&#x27; /apps/redis/etc/redis_6379.conf &gt; /apps/redis/etc/redis_6381.conf</span><br><span class="hljs-comment"># grep 6381 /apps/redis/etc/redis_6381.conf</span><br><span class="hljs-comment"># Accept connections on the specified port, default is 6381 (IANA #815344).</span><br>port 6381<br>pidfile /apps/redis/run/redis_6381.pid<br>logfile <span class="hljs-string">&quot;/apps/redis/log/redis_6381.log&quot;</span><br>dbfilename dump_6381.rdb<br>appendfilename <span class="hljs-string">&quot;appendonly_6381.aof&quot;</span><br><span class="hljs-comment"># cluster-config-file nodes-6381.conf</span><br><span class="hljs-comment"># cluster-announce-port 6381</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-14-5-添加三个实例的service-unit文件"><a href="#2-2-14-5-添加三个实例的service-unit文件" class="headerlink" title="2.2.14.5 添加三个实例的service unit文件"></a>2.2.14.5 添加三个实例的service unit文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /lib/systemd/system/redis6379.service</span><br>[Unit]<br>Description=Redis persistent key-value database<br>After=network.target<br><br>[Service]<br>ExecStart=/apps/redis/bin/redis-server /apps/redis/etc/redis_6379.conf --supervised systemd<br><span class="hljs-comment">#ExecStop=/usr/libexec/redis-shutdown</span><br>ExecStop=/bin/<span class="hljs-built_in">kill</span> -s QUIT <span class="hljs-variable">$MAINPID</span><br>Type=notify<br>User=redis<br>Group=redis<br>RuntimeDirectory=redis<br>RuntimeDirectoryMode=0755<br><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment"># vim /lib/systemd/system/redis6380.service</span><br>[Unit]<br>Description=Redis persistent key-value database<br>After=network.target<br><br>[Service]<br>ExecStart=/apps/redis/bin/redis-server /apps/redis/etc/redis_6380.conf --supervised systemd<br><span class="hljs-comment">#ExecStop=/usr/libexec/redis-shutdown</span><br>ExecStop=/bin/<span class="hljs-built_in">kill</span> -s QUIT <span class="hljs-variable">$MAINPID</span><br>Type=notify<br>User=redis<br>Group=redis<br>RuntimeDirectory=redis<br>RuntimeDirectoryMode=0755<br><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment"># vim /lib/systemd/system/redis6381.service</span><br>[Unit]<br>Description=Redis persistent key-value database<br>After=network.target<br><br>[Service]<br>ExecStart=/apps/redis/bin/redis-server /apps/redis/etc/redis_6381.conf --supervised systemd<br><span class="hljs-comment">#ExecStop=/usr/libexec/redis-shutdown</span><br>ExecStop=/bin/<span class="hljs-built_in">kill</span> -s QUIT <span class="hljs-variable">$MAINPID</span><br>Type=notify<br>User=redis<br>Group=redis<br>RuntimeDirectory=redis<br>RuntimeDirectoryMode=0755<br><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment"># chown -R redis.redis /apps/redis/</span><br><span class="hljs-comment"># systemctl daemon-reload</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-14-6-启动redis"><a href="#2-2-14-6-启动redis" class="headerlink" title="2.2.14.6 启动redis"></a>2.2.14.6 启动redis</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># systemctl enable --now redis6379 redis6380 redis6381</span><br><br><span class="hljs-comment">#查看端口</span><br><span class="hljs-comment"># ss -ntl</span><br>State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port              <br>LISTEN     0      511                             *:6379                                        *:*                  <br>LISTEN     0      511                             *:6380                                        *:*                  <br>LISTEN     0      511                             *:6381                                        *:*                  <br>LISTEN     0      128                             *:22                                          *:*                  <br>LISTEN     0      128                          [::]:22                                       [::]:*<br><br><span class="hljs-comment"># tree /apps/redis/</span><br>/apps/redis/<br>├── bin<br>│   ├── redis-benchmark<br>│   ├── redis-check-aof<br>│   ├── redis-check-rdb<br>│   ├── redis-cli<br>│   ├── redis-sentinel -&gt; redis-server<br>│   └── redis-server<br>├── data<br>│   ├── dump_6379.rdb<br>│   ├── dump_6380.rdb<br>│   └── dump_6381.rdb<br>├── etc<br>│   ├── redis_6379.conf<br>│   ├── redis_6380.conf<br>│   └── redis_6381.conf<br>├── <span class="hljs-built_in">log</span><br>│   ├── redis_6379.log<br>│   ├── redis_6380.log<br>│   └── redis_6381.log<br>└── run<br>    ├── redis_6379.pid<br>    ├── redis_6380.pid<br>    └── redis_6381.pid<br><br>5 directories, 18 files<br></code></pre></td></tr></table></figure>

<h2 id="2-3-redis-配置和优化"><a href="#2-3-redis-配置和优化" class="headerlink" title="2.3 redis 配置和优化"></a>2.3 redis 配置和优化</h2><h3 id="2-3-1-redis-主要配置项"><a href="#2-3-1-redis-主要配置项" class="headerlink" title="2.3.1 redis 主要配置项"></a>2.3.1 redis 主要配置项</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis61.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">bind</span> 0.0.0.0 <span class="hljs-comment">#监听地址，可以用空格隔开后多个监听IP</span><br><br>protected-mode yes <span class="hljs-comment">#redis3.2之后加入的新特性，在没有设置bind IP和密码的时候,redis只允许访问127.0.0.1:6379，可以远程连接，但当访问将提示警告信息并拒绝远程访问</span><br><br>port 6379 <span class="hljs-comment">#监听端口,默认6379/tcp</span><br><br>tcp-backlog 511 <span class="hljs-comment">#三次握手的时候server端收到client ack确认号之后的队列值，即全连接队列长度</span><br><br>timeout 0 <span class="hljs-comment">#客户端和Redis服务端的连接超时时间，默认是0，表示永不超时</span><br><br>tcp-keepalive 300 <span class="hljs-comment">#tcp 会话保持时间300s</span><br><br>daemonize no <span class="hljs-comment">#默认no，即直接运行redis-server程序时,不作为守护进程运行，而是以前台方式运行，如果想在后台运行需改成yes。当redis作为守护进程运行的时候，它会写一个 pid 到/var/run/redis.pid 文件</span><br><br>supervised no <span class="hljs-comment">#和OS相关参数，可设置通过upstart和systemd管理Redis守护进程，centos7后都使用systemd</span><br><br>pidfile /var/run/redis_6379.pid <span class="hljs-comment">#pid文件路径,可以根据需求修改。如：/apps/redis/run/redis_6379.pid</span><br><br>loglevel notice <span class="hljs-comment">#日志级别</span><br><br>logfile <span class="hljs-string">&quot;/path/redis.log&quot;</span> <span class="hljs-comment">#日志路径,示例:logfile &quot;/apps/redis/log/redis_6379.log&quot;</span><br><br>databases 16 <span class="hljs-comment">#设置数据库数量，默认：0-15，共16个库</span><br><br>always-show-logo yes <span class="hljs-comment">#在启动redis时是否显示或在日志中记录记录redis的logo</span><br><br>save 900 1 <span class="hljs-comment">#在900秒内有1个key内容发生更改,就执行快照机制</span><br><br>save 300 10 <span class="hljs-comment">#在300秒内有10个key内容发生更改,就执行快照机制</span><br><br>save 60 10000  <span class="hljs-comment">#60秒内如果有10000个key以上的变化，就自动快照备份</span><br><br>stop-writes-on-bgsave-error yes <span class="hljs-comment">#默认为yes时,可能会因空间满等原因快照无法保存出错时，会禁止redis写入操作，生产建议为no #此项只针对配置文件中的自动save有效</span><br><br>rdbcompression yes <span class="hljs-comment">#持久化到RDB文件时，是否压缩，&quot;yes&quot;为压缩，&quot;no&quot;则反之</span><br><br>rdbchecksum yes <span class="hljs-comment">#是否对备份文件开启RC64校验，默认是开启</span><br><br>dbfilename dump.rdb <span class="hljs-comment">#快照文件名</span><br><br>dir ./ <span class="hljs-comment">#快照文件保存路径，示例：dir &quot;/apps/redis/data&quot;</span><br><br><span class="hljs-comment">#主从复制相关</span><br><span class="hljs-comment"># replicaof &lt;masterip&gt; &lt;masterport&gt; #指定复制的master主机地址和端口，5.0版之前的指令为slaveof</span><br><span class="hljs-comment"># masterauth &lt;master-password&gt; #指定复制的master主机的密码</span><br><br>replica-serve-stale-data yes <span class="hljs-comment">#当从库同主库失去连接或者复制正在进行，从机库有两种运行方式：</span><br>                             <span class="hljs-comment">#1、设置为yes(默认设置)，从库会继续响应客户端的读请求，此为建议值</span><br>                             <span class="hljs-comment">#2、设置为no，除去特定命令外的任何请求都会返回一个错误&quot;SYNC with master in progress&quot;。</span><br><br>replica-read-only yes <span class="hljs-comment">#是否设置从库只读，建议值为yes,否则主库同步从库时可能会覆盖数据，造成数据丢失</span><br><br>repl-diskless-sync no <span class="hljs-comment">#是否使用socket方式复制数据(无盘同步)，新slave第一次连接master时需要做数据的全量同步，redis server就要从内存dump出新的RDB文件，然后从master传到slave，有两种方式把RDB文件传输给客户端：</span><br>                      <span class="hljs-comment">#1、基于硬盘（disk-backed）：为no时，master创建一个新进程dump生成RDB磁盘文件，RDB完成之后由父进程（即主进程）将RDB文件发送给slaves，此为默认值</span><br>                      <span class="hljs-comment">#2、基于socket（diskless）：master创建一个新进程直接dump RDB至slave的网络socket，不经过主进程和硬盘</span><br>                      <span class="hljs-comment">#推荐使用基于硬盘（为no），是因为RDB文件创建后，可以同时传输给更多的slave，但是基于socket(为yes)， 新slave连接到master之后得逐个同步数据。只有当磁盘I/O较慢且网络较快时，可用diskless(yes),否则一般建议使用磁盘(no)</span><br><br>repl-diskless-sync-delay 5 <span class="hljs-comment">#diskless时复制的服务器等待的延迟时间，设置0为关闭，在延迟时间内到达的客户端，会一起通过diskless方式同步数据，但是一旦复制开始，master节点不会再接收新slave的复制请求，直到下一次同步开始才再接收新请求。即无法为延迟时间后到达的新副本提供服务，新副本将排队等待下一次RDB传输，因此服务器会等待一段时间才能让更多副本到达。推荐值：30-60</span><br><br>repl-ping-replica-period 10 <span class="hljs-comment">#slave根据master指定的时间进行周期性的PING master,用于监测master状态,默认10s</span><br><br>repl-timeout 60 <span class="hljs-comment">#复制连接的超时时间，需要大于repl-ping-slave-period，否则会经常报超时</span><br><br>repl-disable-tcp-nodelay no <span class="hljs-comment">#是否在slave套接字发送SYNC之后禁用 TCP_NODELAY，如果选择&quot;yes&quot;，Redis将合并多个报文为一个大的报文，从而使用更少数量的包向slaves发送数据，但是将使数据传输到slave上有延迟，Linux内核的默认配置会达到40毫秒，如果 &quot;no&quot; ，数据传输到slave的延迟将会减少，但要使用更多的带宽</span><br><br>repl-backlog-size 512mb <span class="hljs-comment">#复制缓冲区内存大小，当slave断开连接一段时间后，该缓冲区会累积复制副本数据，因此当slave 重新连接时，通常不需要完全重新同步，只需传递在副本中的断开连接后没有同步的部分数据即可。只有在至少有一个slave连接之后才分配此内存空间,建议建立主从时此值要调大一些或在低峰期配置,否则会导致同步到slave失败</span><br><span class="hljs-comment">#复制缓存区大小取决于复制时间内redis新增数据的大小。如：复制时间要5分钟，5分钟内新增数据有10G，那么复制缓冲区的大小至少要设置为10G</span><br><br>repl-backlog-ttl 3600 <span class="hljs-comment">#多长时间内master没有slave连接，就清空backlog缓冲区</span><br><br>replica-priority 100 <span class="hljs-comment">#当master不可用，哨兵Sentinel会根据slave的优先级选举一个master，此值最低的slave会优先当选master，而配置成0，永远不会被选举，一般多个slave都设为一样的值，让其自动选择</span><br><br><span class="hljs-comment">#min-replicas-to-write 3 #至少有3个可连接的slave，mater才接受写操作</span><br><br><span class="hljs-comment">#min-replicas-max-lag 10 #和上面至少3个slave的ping延迟不能超过10秒，否则master也将停止写操作</span><br><br>requirepass foobared <span class="hljs-comment">#设置redis连接密码，之后需要AUTH pass,如果有特殊符号，用&quot; &quot;引起来,生产建议设置</span><br><br>rename-command <span class="hljs-comment">#重命名一些高危命令，示例：rename-command FLUSHALL &quot;&quot; 禁用命令</span><br>               <span class="hljs-comment">#示例: rename-command del magedu</span><br><br>maxclients 10000 <span class="hljs-comment">#Redis最大连接客户端</span><br><br>maxmemory &lt;bytes&gt; <span class="hljs-comment">#redis使用的最大内存，单位为bytes字节，0为不限制，建议设为物理内存一半，8G内存的计算方式8(G)*1024(MB)1024(KB)*1024(Kbyte)，需要注意的是缓冲区是不计算在maxmemory内,生产中如果不设置此项,可能会导致OOM</span><br><br>appendonly no <span class="hljs-comment">#是否开启AOF日志记录，默认redis使用的是rdb方式持久化，这种方式在许多应用中已经足够用了，但是redis如果中途宕机，会导致可能有几分钟的数据丢失(取决于dump数据的间隔时间)，根据save来策略进行持久化，Append Only File是另一种持久化方式，可以提供更好的持久化特性，Redis会把每次写入的数据在接收后都写入 appendonly.aof 文件，每次启动时Redis都会先把这个文件的数据读入内存里，先忽略RDB文件。默认不启用此功能</span><br><br>appendfilename <span class="hljs-string">&quot;appendonly.aof&quot;</span> <span class="hljs-comment">#文本文件AOF的文件名，存放在dir指令指定的目录中</span><br><br>appendfsync everysec <span class="hljs-comment">#aof持久化策略的配置</span><br>                     <span class="hljs-comment">#no表示由操作系统保证数据同步到磁盘,Linux的默认fsync(写入磁盘)策略是30秒，最多会丢失30s的数据</span><br>                     <span class="hljs-comment">#always表示每次写入都执行fsync，以保证数据同步到磁盘,安全性高,性能较差</span><br>                     <span class="hljs-comment">#everysec表示每秒执行一次fsync，可能会导致丢失这1s数据,此为默认值,也生产建议值</span><br><br><span class="hljs-comment">#同时在执行bgrewriteaof操作和主进程写aof文件的操作，两者都会操作磁盘，而bgrewriteaof往往会涉及大量磁盘操作，这样就会造成主进程在写aof文件的时候出现阻塞的情形,以下参数实现控制</span><br>no-appendfsync-on-rewrite no <span class="hljs-comment">#在aof rewrite期间,是否对aof新记录的append暂缓使用文件同步策略,主要考虑磁盘IO开支和请求阻塞时间。</span><br>                             <span class="hljs-comment">#默认为no,表示&quot;不暂缓&quot;,新的aof记录仍然会被立即同步到磁盘，是最安全的方式，不会丢失数据，但是要忍受阻塞的问题</span><br>                             <span class="hljs-comment">#为yes,相当于将appendfsync设置为no，这说明并没有执行磁盘操作，只是写入了缓冲区，因此这样并不会造成阻塞（因为没有竞争磁盘），但是如果这个时候redis挂掉，就会丢失数据。丢失多少数据呢？Linux的默认fsync(写入磁盘)策略是30秒，最多会丢失30s的数据,但由于yes性能较好而且会避免出现阻塞因此比较推荐</span><br><br><span class="hljs-comment">#rewrite 即对aof文件进行整理,将空闲空间回收,从而可以减少恢复数据时间</span><br><br>auto-aof-rewrite-percentage 100 <span class="hljs-comment">#当Aof log增长超过指定百分比例时，重写AOF文件，设置为0表示不自动重写Aof日志，重写是为了使aof体积保持最小，但是还可以确保保存最完整的数据</span><br><br>auto-aof-rewrite-min-size 64mb <span class="hljs-comment">#触发aof rewrite的最小文件大小</span><br><br>aof-load-truncated yes <span class="hljs-comment">#是否加载由于某些原因导致的末尾异常的AOF文件(主进程被kill/断电等)，建议yes</span><br><br>aof-use-rdb-preamble no <span class="hljs-comment">#redis4.0新增RDB-AOF混合持久化格式，在开启了这个功能之后，AOF重写产生的文件将同时包含RDB格式的内容和AOF格式的内容，其中RDB格式的内容用于记录已有的数据，而AOF格式的内容则用于记录最近发生了变化的数据，这样Redis就可以同时兼有RDB持久化和AOF持久化的优点（既能够快速地生成重写文件，也能够在出现问题时，快速地载入数据）,默认为no,即不启用此功能</span><br><br>lua-time-limit 5000 <span class="hljs-comment">#lua脚本的最大执行时间，单位为毫秒</span><br><br>cluster-enabled yes <span class="hljs-comment">#是否开启集群模式，默认不开启,即单机模式</span><br><br>cluster-config-file nodes-6379.conf <span class="hljs-comment">#由node节点自动生成的集群配置文件名称</span><br><br>cluster-node-timeout 15000 <span class="hljs-comment">#集群中node节点连接超时时间，单位ms,超过此时间，会踢出集群</span><br><br>cluster-replica-validity-factor 10 <span class="hljs-comment">#单位为次,在执行故障转移的时候可能有些节点和master断开一段时间导致数据比较旧，这些节点就不适用于选举为master，超过这个时间的就不会被进行故障转移,不能当选master，计算公式：(node-timeout * replica-validity-factor) + repl-ping-replica-period</span><br><br>cluster-migration-barrier 1 <span class="hljs-comment">#集群迁移屏障，一个主节点至少拥有1个正常工作的从节点，即如果主节点的slave节点故障后会将多余的从节点分配到当前主节点成为其新的从节点。</span><br><br>cluster-require-full-coverage yes <span class="hljs-comment">#集群请求槽位全部覆盖，如果一个主库宕机且没有备库就会出现集群槽位不全，那么yes时redis集群槽位验证不全,就不再对外提供服务(对key赋值时,会出现CLUSTERDOWN The cluster is down的提示,cluster_state:fail,但ping 仍PONG)，而no则可以继续使用,但是会出现查询数据查不到的情况(因为有数据丢失)。生产建议为no</span><br><br>cluster-replica-no-failover no <span class="hljs-comment">#如果为yes,此选项阻止在主服务器发生故障时尝试对其主服务器进行故障转移。 但是，主服务器仍然可以执行手动强制故障转移，一般为no</span><br><br><span class="hljs-comment">#Slow log 是 Redis 用来记录超过指定执行时间的日志系统，执行时间不包括与客户端交谈，发送回复等I/O操作，而是实际执行命令所需的时间（在该阶段线程被阻塞并且不能同时为其它请求提供服务）,由于slow log 保存在内存里面，读写速度非常快，因此可放心地使用，不必担心因为开启 slow log 而影响Redis 的速度</span><br><br>slowlog-log-slower-than 10000 <span class="hljs-comment">#以微秒为单位的慢日志记录，为负数会禁用慢日志，为0会记录每个命令操作。默认值为10ms,一般一条命令执行都在微秒级,生产建议设为1ms-10ms之间</span><br><br>slowlog-max-len 128 <span class="hljs-comment">#最多记录多少条慢日志的保存队列长度，达到此长度后，记录新命令会将最旧的命令从命令队列中删除，以此滚动删除,即,先进先出,队列固定长度,默认128,值偏小,生产建议设为1000以上</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-2-CONFIG-动态修改配置"><a href="#2-3-2-CONFIG-动态修改配置" class="headerlink" title="2.3.2 CONFIG 动态修改配置"></a>2.3.2 CONFIG 动态修改配置</h3><p>config 命令用于查看当前redis配置、以及不重启redis服务实现动态更改redis配置等</p>
<p><strong>注意：不是所有配置都可以动态修改,且此方式无法持久保存</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">CONFIG SET parameter value<br>时间复杂度：O(1)<br>CONFIG SET 命令可以动态地调整 Redis 服务器的配置(configuration)而无须重启。<br><br>你可以使用它修改配置参数，或者改变 Redis 的持久化(Persistence)方式。<br>CONFIG SET 可以修改的配置参数可以使用命令 CONFIG GET * 来列出，所有被 CONFIG SET 修改的配置参数都会立即生效。<br><br>CONFIG GET parameter<br>时间复杂度： O(N)，其中 N 为命令返回的配置选项数量。<br>CONFIG GET 命令用于取得运行中的 Redis 服务器的配置参数(configuration parameters)，在Redis 2.4 版本中， 有部分参数没有办法用 CONFIG GET 访问，但是在最新的 Redis 2.6 版本中，所有配置参数都已经可以用 CONFIG GET 访问了。<br><br>CONFIG GET 接受单个参数 parameter 作为搜索关键字，查找所有匹配的配置参数，其中参数和值以“键-值对”(key-value pairs)的方式排列。<br>比如执行 CONFIG GET s* 命令，服务器就会返回所有以 s 开头的配置参数及参数的值：<br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-1-设置连接密码"><a href="#2-3-2-1-设置连接密码" class="headerlink" title="2.3.2.1 设置连接密码"></a>2.3.2.1 设置连接密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#设置连接密码</span><br>127.0.0.1:6379&gt; CONFIG SET requirepass 123456<br>OK<br><br><span class="hljs-comment">#查看连接密码</span><br>127.0.0.1:6379&gt; CONFIG GET requirepass <br>1) <span class="hljs-string">&quot;requirepass&quot;</span><br>2) <span class="hljs-string">&quot;123456&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis62.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-3-2-2-获取当前配置"><a href="#2-3-2-2-获取当前配置" class="headerlink" title="2.3.2.2 获取当前配置"></a>2.3.2.2 获取当前配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#奇数行为键，偶数行为值</span><br>127.0.0.1:6379&gt; CONFIG GET *<br> 1) <span class="hljs-string">&quot;dbfilename&quot;</span><br> 2) <span class="hljs-string">&quot;dump.rdb&quot;</span><br> 3) <span class="hljs-string">&quot;requirepass&quot;</span><br> 4) <span class="hljs-string">&quot;&quot;</span><br> 5) <span class="hljs-string">&quot;masterauth&quot;</span><br> 6) <span class="hljs-string">&quot;&quot;</span><br> 7) <span class="hljs-string">&quot;cluster-announce-ip&quot;</span><br> 8) <span class="hljs-string">&quot;&quot;</span><br> 9) <span class="hljs-string">&quot;unixsocket&quot;</span><br>10) <span class="hljs-string">&quot;&quot;</span><br>11) <span class="hljs-string">&quot;logfile&quot;</span><br>12) <span class="hljs-string">&quot;/var/log/redis/redis.log&quot;</span><br>13) <span class="hljs-string">&quot;pidfile&quot;</span><br>14) <span class="hljs-string">&quot;/var/run/redis_6379.pid&quot;</span><br>15) <span class="hljs-string">&quot;slave-announce-ip&quot;</span><br>16) <span class="hljs-string">&quot;&quot;</span><br>17) <span class="hljs-string">&quot;replica-announce-ip&quot;</span><br>18) <span class="hljs-string">&quot;&quot;</span><br>19) <span class="hljs-string">&quot;maxmemory&quot;</span><br>20) <span class="hljs-string">&quot;0&quot;</span><br>......<br><br><span class="hljs-comment">#查看bind</span><br>127.0.0.1:6379&gt; CONFIG GET <span class="hljs-built_in">bind</span><br>1) <span class="hljs-string">&quot;bind&quot;</span><br>2) <span class="hljs-string">&quot;0.0.0.0&quot;</span><br><br><span class="hljs-comment">#有些设置无法修改</span><br>127.0.0.1:6379&gt; CONFIG SET <span class="hljs-built_in">bind</span> 127.0.0.1<br>(error) ERR Unsupported CONFIG parameter: <span class="hljs-built_in">bind</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-3-更改最大内存"><a href="#2-3-2-3-更改最大内存" class="headerlink" title="2.3.2.3 更改最大内存"></a>2.3.2.3 更改最大内存</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; CONFIG SET maxmemory 8589934592<br>OK<br>127.0.0.1:6379&gt; CONFIG GET maxmemory<br>1) <span class="hljs-string">&quot;maxmemory&quot;</span><br>2) <span class="hljs-string">&quot;8589934592&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-3-慢查询"><a href="#2-3-3-慢查询" class="headerlink" title="2.3.3 慢查询"></a>2.3.3 慢查询</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis63.png" srcset="/blog/img/loading.gif"></p>
<p>范例: SLOW LOG</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#vim /etc/redis.conf</span><br>slowlog-log-slower-than 10000  <span class="hljs-comment">#指定为超过1us即为慢的指令                          </span><br>slowlog-max-len 1024 <span class="hljs-comment">#指定保存1024条慢记录</span><br>                                <br>127.0.0.1:6379&gt; SLOWLOG LEN  <span class="hljs-comment">#查看慢日志的记录条数</span><br>(<span class="hljs-built_in">integer</span>) 14<br>127.0.0.1:6379&gt; SLOWLOG GET [n] <span class="hljs-comment">#查看慢日志的n条记录</span><br>1) 1) (<span class="hljs-built_in">integer</span>) 14<br>2) (<span class="hljs-built_in">integer</span>) 1544690617<br>3) (<span class="hljs-built_in">integer</span>) 4<br>4) 1) <span class="hljs-string">&quot;slowlog&quot;</span><br>127.0.0.1:6379&gt; SLOWLOG GET 3<br>1) 1) (<span class="hljs-built_in">integer</span>) 7<br>   2) (<span class="hljs-built_in">integer</span>) 1602901545<br>   3) (<span class="hljs-built_in">integer</span>) 26<br>   4) 1) <span class="hljs-string">&quot;SLOWLOG&quot;</span><br>      2) <span class="hljs-string">&quot;get&quot;</span><br>   5) <span class="hljs-string">&quot;127.0.0.1:38258&quot;</span><br> 6) <span class="hljs-string">&quot;&quot;</span><br>2) 1) (<span class="hljs-built_in">integer</span>) 6<br>   2) (<span class="hljs-built_in">integer</span>) 1602901540<br>   3) (<span class="hljs-built_in">integer</span>) 22<br>   4) 1) <span class="hljs-string">&quot;SLOWLOG&quot;</span><br>      2) <span class="hljs-string">&quot;get&quot;</span><br>      3) <span class="hljs-string">&quot;2&quot;</span><br>   5) <span class="hljs-string">&quot;127.0.0.1:38258&quot;</span><br>   6) <span class="hljs-string">&quot;&quot;</span><br>3) 1) (<span class="hljs-built_in">integer</span>) 5<br>   2) (<span class="hljs-built_in">integer</span>) 1602901497<br>   3) (<span class="hljs-built_in">integer</span>) 22<br>   4) 1) <span class="hljs-string">&quot;SLOWLOG&quot;</span><br>      2) <span class="hljs-string">&quot;GET&quot;</span><br>      5) <span class="hljs-string">&quot;127.0.0.1:38258&quot;</span><br>      6) <span class="hljs-string">&quot;&quot;</span><br>127.0.0.1:6379&gt; SLOWLOG RESET <span class="hljs-comment">#清空慢日志</span><br>OK<br></code></pre></td></tr></table></figure>

<h3 id="2-3-4-redis-持久化"><a href="#2-3-4-redis-持久化" class="headerlink" title="2.3.4 redis 持久化"></a>2.3.4 redis 持久化</h3><p>Redis 虽然是一个内存级别的缓存程序，也就是redis 是使用内存进行数据的缓存的，但是其可以将内存的数据按照一定的策略保存到硬盘上，从而实现数据持久保存的目的</p>
<p>目前redis支持两种不同方式的数据持久化保存机制，分别是RDB和AOF</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis64.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-3-4-1-RDB-模式"><a href="#2-3-4-1-RDB-模式" class="headerlink" title="2.3.4.1 RDB 模式"></a>2.3.4.1 RDB 模式</h4><h5 id="2-3-4-1-1-RDB-模式工作原理"><a href="#2-3-4-1-1-RDB-模式工作原理" class="headerlink" title="2.3.4.1.1 RDB 模式工作原理"></a>2.3.4.1.1 RDB 模式工作原理</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis65.png" srcset="/blog/img/loading.gif"></p>
<p>RDB(Redis DataBase)：基于时间的快照，其默认只保留当前最新的一次快照，特点是执行速度比较快，缺点是可能会丢失从上次快照到当前时间点之间未做快照的数据</p>
<p><strong>RDB bgsave 实现快照的具体过程:</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis66.png" srcset="/blog/img/loading.gif"></p>
<p>Redis从master主进程先fork出一个子进程，使用写时复制机制，子进程将内存的数据保存为一个临时文件，比如:tmp-<pid>.rdb，当数据保存完成之后再将上一次保存的RDB文件替换掉，然后关闭子进程，这样可以保证每一次做RDB快照保存的数据都是完整的</p>
<p>因为直接替换RDB文件的时候，可能会出现突然断电等问题，而导致RDB文件还没有保存完整就因为突然关机停止保存，而导致数据丢失的情况，后续可以手动将每次生成的RDB文件进行备份，这样可以最大化保存历史数据</p>
<p><strong>下图为redis的一个子进程作将内存的数据保存为一个临时文件。redis-server(2045)和temp-2045.rdb</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis67.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-3-4-2-3-RDB-相关配置"><a href="#2-3-4-2-3-RDB-相关配置" class="headerlink" title="2.3.4.2.3 RDB 相关配置"></a>2.3.4.2.3 RDB 相关配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">save 900 1<br>save 300 10<br>save 60 10000<br>dbfilename dump.rdb<br>dir ./     <span class="hljs-comment">#编泽编译安装,默认RDB文件存放在启动redis的工作目录,建议明确指定存入目录</span><br>stop-writes-on-bgsave-error yes<br>rdbcompression yes<br>rdbchecksum yes<br></code></pre></td></tr></table></figure>

<h5 id="2-3-4-2-4-实现RDB方式"><a href="#2-3-4-2-4-实现RDB方式" class="headerlink" title="2.3.4.2.4 实现RDB方式"></a>2.3.4.2.4 实现RDB方式</h5><ul>
<li>save: 同步，会阻赛其它命令，不推荐使用</li>
<li>bgsave: 异步后台执行，不影响其它命令的执行<strong>（生产中一般会用bgsave。生产中可以做一个计划任务，每段时间bgsave备份（可以判断rdb_bgsave_in_progress是否为0，如果为0即备份完成，如果不为0则备份未完成）</strong></li>
<li>自动: 制定规则，自动执行</li>
</ul>
<h5 id="2-3-4-2-4-RDB-模式的优缺点"><a href="#2-3-4-2-4-RDB-模式的优缺点" class="headerlink" title="2.3.4.2.4 RDB 模式的优缺点"></a>2.3.4.2.4 RDB 模式的优缺点</h5><h6 id="2-3-4-2-4-1-RDB-模式优点"><a href="#2-3-4-2-4-1-RDB-模式优点" class="headerlink" title="2.3.4.2.4.1 RDB 模式优点"></a>2.3.4.2.4.1 RDB 模式优点</h6><ul>
<li><p>RDB快照保存了某个时间点的数据，可以通过脚本执行redis指令bgsave(非阻塞，后台执行)或者save(会阻塞写操作,不推荐)命令自定义时间点备份，可以保留多个备份，当出现问题可以恢复到不同时间点的版本，很适合备份，并且此文件格式也支持有不少第三方工具可以进行后续的数据分析</p>
<p>比如: 可以在最近的24小时内，每小时备份一次RDB文件，并且在每个月的每一天，也备份一个ROB文件。这样的话，即使遇上问题，也可以随时将数据集还原到不同的版本。</p>
</li>
<li><p>RDB可以最大化Redis的性能，父进程在保存 RDB 文件时唯一要做的就是fork出一个子进程，然后这个子进程就会处理接下来的所有保存工作，父进程无须执行任何磁盘I/O操作。</p>
</li>
<li><p>RDB在大量数据，比如几个G的数据，恢复的速度比AOF的快</p>
</li>
</ul>
<h6 id="2-3-2-4-4-2-RDB-模式缺点"><a href="#2-3-2-4-4-2-RDB-模式缺点" class="headerlink" title="2.3.2.4.4.2 RDB 模式缺点"></a>2.3.2.4.4.2 RDB 模式缺点</h6><ul>
<li><p>不能实时保存数据，可能会丢失自上一次执行RDB备份到当前的内存数据</p>
<p>如果你需要尽量避免在服务器故障时丢失数据，那么RDB不适合你。虽然Redis允许你设置不同的保存点（save point）来控制保存RDB文件的频率，但是，因为ROB文件需要保存整个数据集的状态，所以它并不是一个轻松的操作。因此你可能会至少5分钟才保存一次RDB文件。在这种情况下，一旦发生故障停机，你就可能会丢失好几分钟的数据。</p>
</li>
<li><p>当数据量非常大的时候，从父进程fork子进程进行保存至RDB文件时需要一点时间，可能是毫秒或者秒，取决于磁盘IO性能</p>
<p>在数据集比较庞大时，fork()可能会非常耗时，造成服务器在一定时间内停止处理客户端，如果数据集非常巨大，并且CPU时间非常紧张的话，那么这种停止时间甚至可能会长达整整一秒或更久。虽然 AOF重写也需要进行fork()，但无论AOF重写的执行间隔有多长，数据的持久性都不会有任何损失。</p>
</li>
</ul>
<h5 id="2-3-4-2-5-范例-手动备份RDB文件的脚本"><a href="#2-3-4-2-5-范例-手动备份RDB文件的脚本" class="headerlink" title="2.3.4.2.5 范例: 手动备份RDB文件的脚本"></a>2.3.4.2.5 范例: 手动备份RDB文件的脚本</h5><p><strong>如果执行脚本时出现：<code>redis-cli: command not found</code>错误，就给redis的命令创建软连接或者脚本补全redis命令的路径</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看redis配置</span><br><span class="hljs-comment"># vim /apps/redis/etc/redis.conf</span><br>save <span class="hljs-string">&quot;&quot;</span><br>dbfilename dump_6379.rdb<br>dir <span class="hljs-string">&quot;/data/redis&quot;</span><br>appendonly no<br><br><span class="hljs-comment"># vim redis_backup_rdb.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>. /etc/init.d/<span class="hljs-built_in">functions</span><br>BACKUP=/backup/redis-rdb<br>DIR=/data/redis<br>FILE=dump_6379.rdb<br>PASS=123456<br><br><span class="hljs-function"><span class="hljs-title">color</span></span> () &#123;<br>  RES_COL=60<br>  MOVE_TO_COL=<span class="hljs-string">&quot;echo -en \\033[<span class="hljs-variable">$&#123;RES_COL&#125;</span>G&quot;</span><br>  SETCOLOR_SUCCESS=<span class="hljs-string">&quot;echo -en \\033[1;32m&quot;</span><br>  SETCOLOR_FAILURE=<span class="hljs-string">&quot;echo -en \\033[1;31m&quot;</span><br>  SETCOLOR_WARNING=<span class="hljs-string">&quot;echo -en \\033[1;33m&quot;</span><br>  SETCOLOR_NORMAL=<span class="hljs-string">&quot;echo -en \E[0m&quot;</span><br>  <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> &amp;&amp; <span class="hljs-variable">$MOVE_TO_COL</span><br>  <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;[&quot;</span><br>  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$2</span> = <span class="hljs-string">&quot;success&quot;</span> -o <span class="hljs-variable">$2</span> = <span class="hljs-string">&quot;0&quot;</span> ] ;<span class="hljs-keyword">then</span><br>    <span class="hljs-variable">$&#123;SETCOLOR_SUCCESS&#125;</span><br>    <span class="hljs-built_in">echo</span> -n $<span class="hljs-string">&quot; OK &quot;</span>  <br>  <span class="hljs-keyword">elif</span> [ <span class="hljs-variable">$2</span> = <span class="hljs-string">&quot;failure&quot;</span> -o <span class="hljs-variable">$2</span> = <span class="hljs-string">&quot;1&quot;</span> ] ;<span class="hljs-keyword">then</span><br>    <span class="hljs-variable">$&#123;SETCOLOR_FAILURE&#125;</span><br>    <span class="hljs-built_in">echo</span> -n $<span class="hljs-string">&quot;FAILED&quot;</span><br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-variable">$&#123;SETCOLOR_WARNING&#125;</span><br>    <span class="hljs-built_in">echo</span> -n $<span class="hljs-string">&quot;WARNING&quot;</span><br>  <span class="hljs-keyword">fi</span><br>  <span class="hljs-variable">$&#123;SETCOLOR_NORMAL&#125;</span><br>  <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;]&quot;</span><br>  <span class="hljs-built_in">echo</span><br>&#125;<br><br><span class="hljs-comment">#使redis执行bgsave</span><br>redis-cli -h 127.0.0.1 -a <span class="hljs-variable">$PASS</span> --no-auth-warning bgsave<br><span class="hljs-comment">#获取bgsave的状态</span><br>result=`redis-cli -a 123456 --no-auth-warning info Persistence | grep rdb_bgsave_in_progress | sed -rn <span class="hljs-string">&#x27;s/.*:([0-9]+).*/\1/p&#x27;</span>`<br>until [ <span class="hljs-variable">$result</span> -eq 0 ] ;<span class="hljs-keyword">do</span><br>  sleep 1<br>  result=`redis-cli -a 123456 --no-auth-warning info Persistence | grep rdb_bgsave_in_progress | sed -rn <span class="hljs-string">&#x27;s/.*:([0-9]+).*/\1/p&#x27;</span>`<br><span class="hljs-keyword">done</span><br>DATE=`date +%F_%H-%M-%S`<br><br><span class="hljs-comment">#判断备份的文件是否存在，如果不存在备份文件夹就创建并修改文件夹属性</span><br>[ -e <span class="hljs-variable">$BACKUP</span> ] || &#123; mkdir -p <span class="hljs-variable">$BACKUP</span> ; chown -R redis.redis <span class="hljs-variable">$BACKUP</span>; &#125;<br>mv <span class="hljs-variable">$DIR</span>/<span class="hljs-variable">$FILE</span> <span class="hljs-variable">$BACKUP</span>/dump_6379-<span class="hljs-variable">$&#123;DATE&#125;</span>.rdb<br><br>action <span class="hljs-string">&quot;Backup redis RDB&quot;</span><br><br><span class="hljs-comment">#执行</span><br><span class="hljs-comment"># bash redis_backup_rdb.sh</span><br>Background saving started<br>Backup redis RDB                                                   [ OK ]<br><br><span class="hljs-comment"># ll /backup/redis-rdb/ -h</span><br>total 143M<br>-rw-r--r-- 1 redis redis 143M Oct 21 11:08 dump_6379-2021-10-21_11-08-47.rdb<br></code></pre></td></tr></table></figure>

<h5 id="2-3-4-2-6-范例-观察save-和-bgsave的执行过程"><a href="#2-3-4-2-6-范例-观察save-和-bgsave的执行过程" class="headerlink" title="2.3.4.2.6 范例: 观察save 和 bgsave的执行过程"></a>2.3.4.2.6 范例: 观察save 和 bgsave的执行过程</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#阻塞</span><br><span class="hljs-comment">#生成临时文件</span><br><br><span class="hljs-comment">#save</span><br><span class="hljs-comment">#同时执行以下两个命令</span><br><span class="hljs-comment"># redis-cli -a 123456 save</span><br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning get key1 #会有停顿</span><br><br><span class="hljs-comment">#bgsave</span><br><span class="hljs-comment"># redis-cli -a 123456 bgsave</span><br><span class="hljs-comment"># pstree -p | grep redis-server</span><br>           |-redis-server(5736)-+-redis-server(5792)   <span class="hljs-comment">#对应下面的rdb文件</span><br>           |                    |-&#123;redis-server&#125;(5737)<br>           |                    |-&#123;redis-server&#125;(5738)<br>           |                    `-&#123;redis-server&#125;(5739)<br><br><span class="hljs-comment"># ll /data/redis/ -h</span><br>total 245M<br>-rw-r--r-- 1 redis redis 117M Jun 12 17:36 dump_6379.rdb<br>-rw-r--r-- 1 redis redis  68M Jun 12 17:37 temp-5792.rdb<br></code></pre></td></tr></table></figure>

<h5 id="2-3-4-2-7-范例-自动保存"><a href="#2-3-4-2-7-范例-自动保存" class="headerlink" title="2.3.4.2.7 范例: 自动保存"></a>2.3.4.2.7 范例: 自动保存</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /apps/redis/etc/redis.conf</span><br>save 60 3<br><br><span class="hljs-comment">#测试60s内修改3个key,验证是否生成RDB文件</span><br></code></pre></td></tr></table></figure>

<h5 id="2-3-4-2-8-范例：dump-rdb文件配破坏后回复"><a href="#2-3-4-2-8-范例：dump-rdb文件配破坏后回复" class="headerlink" title="2.3.4.2.8 范例：dump.rdb文件配破坏后回复"></a>2.3.4.2.8 范例：dump.rdb文件配破坏后回复</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#首先要有备份</span><br><br><span class="hljs-comment">#文件被破坏，之前录入的数据都没有</span><br><span class="hljs-comment"># ll /apps/redis/data</span><br>total 0<br><br>127.0.0.1:6379&gt;info<br>......<br><span class="hljs-comment"># Cluster</span><br>cluster_enabled:0<br><br><span class="hljs-comment"># Keyspace</span><br><br><span class="hljs-comment">#恢复</span><br><span class="hljs-comment"># systemctl stop redis</span><br><span class="hljs-comment"># cp /root/dump_6379.rdb /apps/redis/data #注意RDB文件的名称</span><br><span class="hljs-comment"># chown redis.redis /apps/redis/data</span><br><span class="hljs-comment"># ll</span><br>total 14728<br>-rw-r--r-- 1 root root 15077890 Jun 12 20:20 dump_6379.rdb<br><br><span class="hljs-comment"># systemctl start redis</span><br><span class="hljs-comment"># redis-cli -a 123456 info</span><br>......<br><span class="hljs-comment"># Cluster</span><br>cluster_enabled:0<br><br><span class="hljs-comment"># Keyspace</span><br>db0:keys=900001,expires=0,avg_ttl=0<br></code></pre></td></tr></table></figure>

<h4 id="2-3-4-2-AOF-模式"><a href="#2-3-4-2-AOF-模式" class="headerlink" title="2.3.4.2 AOF 模式"></a>2.3.4.2 AOF 模式</h4><h5 id="2-3-4-2-1-AOF-模式工作原理"><a href="#2-3-4-2-1-AOF-模式工作原理" class="headerlink" title="2.3.4.2.1 AOF 模式工作原理"></a>2.3.4.2.1 AOF 模式工作原理</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis68.png" srcset="/blog/img/loading.gif"></p>
<p>AOF：AppendOnylFile，按照操作顺序依次将操作追加到指定的日志文件末尾</p>
<p>AOF 和 RDB 一样使用了写时复制机制，AOF默认为每秒钟 fsync一次，即将执行的命令保存到AOF文件当中，这样即使redis服务器发生故障的话最多只丢失1秒钟之内的数据，也可以设置不同的fsync策略always，即设置每次执行命令的时候执行fsync，fsync会在后台执行线程，所以主线程可以继续处理用户的正常请求而不受到写入AOF文件的I/O影响</p>
<p>同时启用RDB和AOF，进行恢复时，<strong>默认AOF文件优先级高于RDB文件,即会使用AOF文件进行恢复</strong></p>
<p>注意: AOF 模式默认是关闭的，第一次开启AOF后,并重启服务生效后，会因为AOF的优先级高于RDB，而AOF默认没有文件存在,从而导致所有数据丢失</p>
<h5 id="2-3-4-2-2-AOF-rewrite-重写"><a href="#2-3-4-2-2-AOF-rewrite-重写" class="headerlink" title="2.3.4.2.2 AOF rewrite 重写"></a>2.3.4.2.2 AOF rewrite 重写</h5><p>将一些重复的,可以合并的，过期的数据重新写入一个新的AOF文件，从而节约AOF备份占用的硬盘空间,也能加速恢复过程可以手动执行bgrewriteaof 触发AOF,或定义自动rewrite策略</p>
<h5 id="2-3-4-2-3-AOF-rewrite-过程"><a href="#2-3-4-2-3-AOF-rewrite-过程" class="headerlink" title="2.3.4.2.3 AOF rewrite 过程"></a>2.3.4.2.3 AOF rewrite 过程</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis69.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-3-4-2-4-范例-启用AOF功能的正确方式"><a href="#2-3-4-2-4-范例-启用AOF功能的正确方式" class="headerlink" title="2.3.4.2.4 范例: 启用AOF功能的正确方式"></a>2.3.4.2.4 范例: 启用AOF功能的正确方式</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ll /apps/redis/data/</span><br>total 314392<br>-rw-r--r-- 1 redis redis 187779391 Oct 17 14:23 dump.rdb<br><br><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; CONFIG GET appendonly<br>1) <span class="hljs-string">&quot;appendonly&quot;</span><br>2) <span class="hljs-string">&quot;no&quot;</span><br>127.0.0.1:6379&gt; CONFIG SET appendonly yes<br>OK<br><br><span class="hljs-comment"># ll /apps/redis/data/</span><br>total 314392<br>-rw-r--r-- 1 redis redis 187779391 Oct 17 14:23 dump.rdb<br>-rw-r--r-- 1 redis redis  85196805 Oct 17 14:45 temp-rewriteaof-2146.aof<br><br><span class="hljs-comment"># ll /apps/redis/data/</span><br>total 366760<br>-rw-r--r-- 1 redis redis 187779391 Oct 17 14:45 appendonly.aof<br>-rw-r--r-- 1 redis redis 187779391 Oct 17 14:23 dump.rdb<br><br><span class="hljs-comment"># vim /apps/redis/etc/redis.conf</span><br>appendonly yes <span class="hljs-comment">#改为yes</span><br></code></pre></td></tr></table></figure>

<p><strong>config set appendonly yes 可以同时看到下面显示</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis70.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-3-4-2-5-AOF-相关配置"><a href="#2-3-4-2-5-AOF-相关配置" class="headerlink" title="2.3.4.2.5 AOF 相关配置"></a>2.3.4.2.5 AOF 相关配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /apps/redis/etc/redis.conf</span><br>appendonly yes<br>appendfilename <span class="hljs-string">&quot;appendonly-<span class="hljs-variable">$&#123;port&#125;</span>.aof&quot;</span><br>appendfsync everysec<br>dir /path<br>no-appendfsync-on-rewrite yes<br>auto-aof-rewrite-percentage 100<br>auto-aof-rewrite-min-size 64mb<br>aof-load-truncated yes<br></code></pre></td></tr></table></figure>

<h5 id="2-3-4-2-6-范例-动态修改配置自动生成appendonly-aof文件"><a href="#2-3-4-2-6-范例-动态修改配置自动生成appendonly-aof文件" class="headerlink" title="2.3.4.2.6 范例: 动态修改配置自动生成appendonly.aof文件"></a>2.3.4.2.6 范例: 动态修改配置自动生成appendonly.aof文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; CONFIG <span class="hljs-built_in">set</span> appendonly yes<br></code></pre></td></tr></table></figure>

<h5 id="2-3-4-2-7-手动执行AOF重写-BGREWRITEAOF-命令"><a href="#2-3-4-2-7-手动执行AOF重写-BGREWRITEAOF-命令" class="headerlink" title="2.3.4.2.7 手动执行AOF重写 BGREWRITEAOF 命令"></a>2.3.4.2.7 手动执行AOF重写 BGREWRITEAOF 命令</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">BGREWRITEAOF<br>时间复杂度： O(N)， N 为要追加到 AOF 文件中的数据数量。<br>执行一个AOF文件重写操作。重写会创建一个当前 AOF 文件的体积优化版本。<br>即使 BGREWRITEAOF 执行失败，也不会有任何数据丢失，因为旧的 AOF 文件在 BGREWRITEAOF 成功之前不会被修改。<br><br>重写操作只会在没有其他持久化工作在后台执行时被触发，也就是说：<br>如果 Redis 的子进程正在执行快照的保存工作，那么 AOF 重写的操作会被预定(scheduled)，等到保存工作完成之后再执行 AOF 重写。在这种情况下， BGREWRITEAOF 的返回值仍然是 OK ，但还会加上一条额外的信息，说明 BGREWRITEAOF 要等到保存操作完成之后才能执行。在 Redis 2.6 或以上的版本，可以使用 INFO [section] 命令查看 BGREWRITEAOF 是否被预定。<br><br>如果已经有别的AOF文件重写在执行，那么BGREWRITEAOF返回一个错误，并且这个新的BGREWRITEAOF请求也不会被预定到下次执行。<br><br>从 Redis 2.4 开始，AOF重写由Redis自行触发，BGREWRITEAOF仅仅用于手动触发重写操作。<br></code></pre></td></tr></table></figure>

<h5 id="2-3-4-2-8-范例-手动bgrewriteaof"><a href="#2-3-4-2-8-范例-手动bgrewriteaof" class="headerlink" title="2.3.4.2.8 范例: 手动bgrewriteaof"></a>2.3.4.2.8 范例: 手动bgrewriteaof</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; BGREWRITEAOF<br>Background append only file rewriting started<br><br><span class="hljs-comment">#同时可以观察到下面显示</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis71.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-3-4-2-5-AOF-模式优缺点"><a href="#2-3-4-2-5-AOF-模式优缺点" class="headerlink" title="2.3.4.2.5 AOF 模式优缺点"></a>2.3.4.2.5 AOF 模式优缺点</h5><h6 id="2-3-4-2-5-1-AOF-模式优点"><a href="#2-3-4-2-5-1-AOF-模式优点" class="headerlink" title="2.3.4.2.5.1 AOF 模式优点"></a>2.3.4.2.5.1 AOF 模式优点</h6><ul>
<li><p>数据安全性相对较高，根据所使用的fsync策略(fsync是同步内存中redis所有已经修改的文件到存储设备)，默认是appendfsync everysec，即每秒执行一次 fsync,在这种配置下，Redis 仍然可以保持良好的性能，并且就算发生故障停机，也最多只会丢失一秒钟的数据( fsync会在后台线程执行，所以主线程可以继续努力地处理命令请求)</p>
</li>
<li><p>由于该机制对日志文件的写入操作采用的是append模式，因此在写入过程中不需要seek, 即使出现宕机现象，也不会破坏日志文件中已经存在的内容。然而如果本次操作只是写入了一半数据就出现了系统崩溃问题，不用担心，在Redis下一次启动之前，可以通过 <code>redis-check-aof</code> 工具来解决数据一致性的问题</p>
</li>
<li><p>Redis可以在 AOF文件体积变得过大时，自动地在后台对AOF进行重写，重写后的新AOF文件包含了恢复当前数据集所需的最小命令集合。整个重写操作是绝对安全的，因为Redis在创建新 AOF文件的过程中，append模式不断的将修改数据追加到现有的 AOF文件里面，即使重写过程中发生停机，现有的 AOF文件也不会丢失。而一旦新AOF文件创建完毕，Redis就会从旧AOF文件切换到新AOF文件，并开始对新AOF文件进行追加操作。</p>
</li>
<li><p>AOF包含一个格式清晰、易于理解的日志文件用于记录所有的修改操作。事实上，也可以通过该文件完成数据的重建</p>
<p>AOF文件有序地保存了对数据库执行的所有写入操作，这些写入操作以Redis协议的格式保存，因此 AOF文件的内容非常容易被人读懂，对文件进行分析(parse)也很轻松。</p>
<p>导出（export)AOF文件也非常简单：举个例子，如果你不小心执行了FLUSHALL.命令，但只要AOF文件未被重写，那么只要停止服务器，移除 AOF文件末尾的FLUSHAL命令，并重启Redis ,就可以将数据集恢复到FLUSHALL执行之前的状态。</p>
</li>
</ul>
<h5 id="2-3-4-2-5-2-AOF-模式缺点"><a href="#2-3-4-2-5-2-AOF-模式缺点" class="headerlink" title="2.3.4.2.5.2 AOF 模式缺点"></a>2.3.4.2.5.2 AOF 模式缺点</h5><ul>
<li>即使有些操作是重复的也会全部记录，AOF 的文件大小要大于 RDB 格式的文件</li>
<li>AOF 在恢复大数据集时的速度比 RDB 的恢复速度要慢</li>
<li>根据fsync策略不同，AOF速度可能会慢于RDB</li>
<li>bug 出现的可能性更多</li>
</ul>
<h4 id="2-3-4-3-RDB和AOF-的选择"><a href="#2-3-4-3-RDB和AOF-的选择" class="headerlink" title="2.3.4.3 RDB和AOF 的选择"></a>2.3.4.3 RDB和AOF 的选择</h4><p>如果主要充当缓存功能,或者可以承受数分钟数据的丢失, 通常生产环境一般只需启用RDB即可，此也是默认值</p>
<p>如果数据需要持久保存，一点不能丢失，可以选择同时开启RDB和AOF，一般不建议只开启AOF</p>
<h2 id="2-4-Redis-常用命令"><a href="#2-4-Redis-常用命令" class="headerlink" title="2.4 Redis 常用命令"></a>2.4 Redis 常用命令</h2><p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://redis.io/commands<br></code></pre></td></tr></table></figure>

<p>参考链接: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://redisdoc.com/<br></code></pre></td></tr></table></figure>

<h3 id="2-4-1-INFO"><a href="#2-4-1-INFO" class="headerlink" title="2.4.1 INFO"></a>2.4.1 INFO</h3><p>显示当前节点redis运行状态信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; INFO<br><span class="hljs-comment"># Server</span><br>redis_version:5.0.3<br>redis_git_sha1:00000000<br>redis_git_dirty:0<br>redis_build_id:8c0bf22bfba82c8f<br>redis_mode:standalone<br>os:Linux 4.18.0-147.el8.x86_64 x86_64<br>arch_bits:64<br>multiplexing_api:epoll<br>atomicvar_api:atomic-builtin<br>gcc_version:8.2.1<br>process_id:725<br>run_id:8af0d3fba2b7c5520e0981b125cc49c3ce4d2a2f<br>tcp_port:6379<br>uptime_in_seconds:18552<br>......<br></code></pre></td></tr></table></figure>

<h3 id="2-4-3-SELECT"><a href="#2-4-3-SELECT" class="headerlink" title="2.4.3 SELECT"></a>2.4.3 SELECT</h3><p>切换数据库，相当于在MySQL的 USE DBNAME 指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#r edis-cli</span><br>127.0.0.1:6379&gt; info cluster<br><span class="hljs-comment"># Cluster</span><br>cluster_enabled:0<br>127.0.0.1:6379[15]&gt; SELECT 0<br>OK<br>127.0.0.1:6379&gt; SELECT 1<br>OK<br>127.0.0.1:6379[1]&gt; SELECT 15<br>OK<br>127.0.0.1:6379[15]&gt; SELECT 16<br>(error) ERR DB index is out of range<br>127.0.0.1:6379[15]&gt;<br></code></pre></td></tr></table></figure>

<p>注意: 在 redis cluster 模式下不支持多个数据库，会出现下面错误（只能用db0数据库）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; info cluster<br><span class="hljs-comment"># Cluster</span><br>cluster_enabled:1<br>127.0.0.1:6379&gt; select 0<br>OK<br>127.0.0.1:6379&gt; select 1<br>(error) ERR SELECT is not allowed <span class="hljs-keyword">in</span> cluster mode<br></code></pre></td></tr></table></figure>

<h3 id="2-4-4-KEYS"><a href="#2-4-4-KEYS" class="headerlink" title="2.4.4 KEYS"></a>2.4.4 KEYS</h3><p><strong>查看当前库下的所有key，此命令慎用！</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis72.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis140.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379[15]&gt; SELECT 0<br>OK<br>127.0.0.1:6379&gt; KEYS *<br>1) <span class="hljs-string">&quot;9527&quot;</span><br>2) <span class="hljs-string">&quot;9526&quot;</span><br>3) <span class="hljs-string">&quot;paihangbang&quot;</span><br>4) <span class="hljs-string">&quot;list1&quot;</span><br>127.0.0.1:6379&gt; SELECT 1<br>OK<br>127.0.0.1:6379[1]&gt; KEYS *<br>(empty list or <span class="hljs-built_in">set</span>)<br>127.0.0.1:6379[1]&gt;<br><br>127.0.0.1:6379&gt;MSET one 1 two 2 three 3 four 4  <span class="hljs-comment"># 一次设置 4 个 key</span><br>OK<br><br>127.0.0.1:6379&gt; KEYS *o*<br>1) <span class="hljs-string">&quot;four&quot;</span><br>2) <span class="hljs-string">&quot;two&quot;</span><br>3) <span class="hljs-string">&quot;one&quot;</span><br><br>127.0.0.1:6379&gt; KEYS t??<br>1) <span class="hljs-string">&quot;two&quot;</span><br><br>127.0.0.1:6379&gt; keys ?8?<br> 1) <span class="hljs-string">&quot;k80&quot;</span><br> 2) <span class="hljs-string">&quot;k82&quot;</span><br> 3) <span class="hljs-string">&quot;k86&quot;</span><br> 4) <span class="hljs-string">&quot;k83&quot;</span><br> 5) <span class="hljs-string">&quot;k85&quot;</span><br> 6) <span class="hljs-string">&quot;k89&quot;</span><br> 7) <span class="hljs-string">&quot;k88&quot;</span><br> 8) <span class="hljs-string">&quot;k81&quot;</span><br> 9) <span class="hljs-string">&quot;k84&quot;</span><br>10) <span class="hljs-string">&quot;k87&quot;</span><br>127.0.0.1:6379&gt; keys ?8<br>1) <span class="hljs-string">&quot;k8&quot;</span><br><br>127.0.0.1:6379&gt; KEYS t[w]*<br>1) <span class="hljs-string">&quot;two&quot;</span><br><br>127.0.0.1:6379&gt; KEYS *  <span class="hljs-comment"># 匹配数据库内所有 key</span><br>1) <span class="hljs-string">&quot;four&quot;</span><br>2) <span class="hljs-string">&quot;three&quot;</span><br>3) <span class="hljs-string">&quot;two&quot;</span><br>4) <span class="hljs-string">&quot;one&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-1-范例：禁用keys-（建议生产中这样做）"><a href="#2-4-4-1-范例：禁用keys-（建议生产中这样做）" class="headerlink" title="2.4.4.1 范例：禁用keys （建议生产中这样做）"></a>2.4.4.1 范例：禁用keys （建议生产中这样做）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /etc/redis.conf</span><br>.....<br>rename-command keys* <span class="hljs-string">&quot;no input keys&quot;</span><br>......<br></code></pre></td></tr></table></figure>

<h3 id="2-4-5-BGSAVE"><a href="#2-4-5-BGSAVE" class="headerlink" title="2.4.5 BGSAVE"></a>2.4.5 BGSAVE</h3><p>手动在后台执行RDB持久化操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#交互式执行</span><br>127.0.0.1:6379[1]&gt; BGSAVE<br>Background saving started<br><br><span class="hljs-comment">#非交互式执行</span><br><span class="hljs-comment"># ll /var/lib/redis/</span><br>total 4<br>-rw-r--r-- 1 redis redis 326 Feb 18 22:45 dump.rdb<br><br><span class="hljs-comment"># redis-cli -h 127.0.0.1 -a &#x27;123456&#x27; BGSAVE</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>Background saving started<br><br><span class="hljs-comment"># ll /var/lib/redis/</span><br>total 4<br>-rw-r--r-- 1 redis redis 92 Feb 18 22:54 dump.rdb<br></code></pre></td></tr></table></figure>

<h3 id="2-4-6-DBSIZE"><a href="#2-4-6-DBSIZE" class="headerlink" title="2.4.6 DBSIZE"></a>2.4.6 DBSIZE</h3><p>返回当前库下的所有key 数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; DBSIZE<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; SELECT 1<br>OK<br>127.0.0.1:6379[1]&gt; DBSIZE<br>(<span class="hljs-built_in">integer</span>) 0<br></code></pre></td></tr></table></figure>

<h3 id="2-4-7-FLUSHDB"><a href="#2-4-7-FLUSHDB" class="headerlink" title="2.4.7 FLUSHDB"></a>2.4.7 FLUSHDB</h3><p>强制清空当前库中的所有key，此命令慎用！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379[1]&gt; SELECT 0<br>OK<br>127.0.0.1:6379&gt; DBSIZE<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; FLUSHDB<br>OK<br>127.0.0.1:6379&gt; DBSIZE<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt;<br></code></pre></td></tr></table></figure>

<p>范例：禁用flushdb （建议生产中这样做）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]<span class="hljs-comment"># vim /etc/redis.conf</span><br>.....<br>rename-command flushdb <span class="hljs-string">&quot;not-input-flushdb&quot;</span><br>......<br></code></pre></td></tr></table></figure>

<h3 id="2-4-8-FLUSHALL"><a href="#2-4-8-FLUSHALL" class="headerlink" title="2.4.8 FLUSHALL"></a>2.4.8 FLUSHALL</h3><p>强制清空当前redis服务器所有数据库中的所有key，即删除所有数据，此命令慎用！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; FLUSHALL<br>OK<br><br><span class="hljs-comment">#生产建议修改配置 /etc/redis.conf</span><br>rename-command FLUSHALL <span class="hljs-string">&quot;not-input-flushall&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-4-9-SHUTDOWN"><a href="#2-4-9-SHUTDOWN" class="headerlink" title="2.4.9 SHUTDOWN"></a>2.4.9 SHUTDOWN</h3><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cos">可用版本： &gt;= <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><br><br>时间复杂度： O(N)，其中 N 为关机时需要保存的数据库键数量。<br>SHUTDOWN 命令执行以下操作：<br><br>停止所有客户端<br><br>如果有至少一个保存点在等待，执行 SAVE 命令<br><br>如果 AOF 选项被打开，更新 AOF 文件<br><br>关闭 redis 服务器(server)<br><br>如果持久化被打开的话， SHUTDOWN 命令会保证服务器正常关闭而不丢失任何数据。<br><br>另一方面，假如只是单纯地执行 SAVE 命令，然后再执行 <span class="hljs-keyword">QUIT</span> 命令，则没有这一保证 —— 因为在执行SAVE 之后、执行 <span class="hljs-keyword">QUIT</span> 之前的这段时间中间，其他客户端可能正在和服务器进行通讯，这时如果执行<span class="hljs-keyword">QUIT</span> 就会造成数据丢失。<br></code></pre></td></tr></table></figure>

<h2 id="2-5-redis-数据类型"><a href="#2-5-redis-数据类型" class="headerlink" title="2.5 redis 数据类型"></a>2.5 redis 数据类型</h2><p>参考资料：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://www.redis.cn/topics/data-types.html<br></code></pre></td></tr></table></figure>

<p>相关命令参考: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://redisdoc.com/<br></code></pre></td></tr></table></figure>



<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis73.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis74.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-5-1-字符串-string"><a href="#2-5-1-字符串-string" class="headerlink" title="2.5.1 字符串 string"></a>2.5.1 字符串 string</h3><p>字符串是所有编程语言中最常见的和最常用的数据类型，而且也是redis最基本的数据类型之一，而且redis 中所有的 key 的类型都是字符串。常用于保存 Session 信息场景，此数据类型比较常用</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis75.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-5-1-1-添加一个key"><a href="#2-5-1-1-添加一个key" class="headerlink" title="2.5.1.1 添加一个key"></a>2.5.1.1 添加一个key</h4><p>set 指令可以创建一个key 并赋值, 使用格式</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-meta">SET</span> <span class="hljs-meta">key</span> value [EX seconds] [PX milliseconds] [NX|XX]<br>时间复杂度： O(1)<br>将字符串值 value 关联到 <span class="hljs-meta">key</span> 。<br><br>如果 <span class="hljs-meta">key</span> 已经持有其他值， <span class="hljs-meta">SET</span> 就覆写旧值， 无视类型。<br>当 <span class="hljs-meta">SET</span> 命令对一个带有生存时间（TTL）的键进行设置之后， 该键原有的 TTL 将被清除。<br><br>从 Redis 2.6.12 版本开始， <span class="hljs-meta">SET</span> 命令的行为可以通过一系列参数来修改：<br>EX seconds ： 将键的过期时间设置为 seconds 秒。 执行 <span class="hljs-meta">SET</span> <span class="hljs-meta">key</span> value EX seconds 的效果等同于执行 SETEX <span class="hljs-meta">key</span> seconds value 。<br>PX milliseconds ： 将键的过期时间设置为 milliseconds 毫秒。 执行 <span class="hljs-meta">SET</span> <span class="hljs-meta">key</span> value PX milliseconds 的效果等同于执行 PSETEX <span class="hljs-meta">key</span> milliseconds value 。<br>NX ： 只在键不存在时， 才对键进行设置操作。 执行 <span class="hljs-meta">SET</span> <span class="hljs-meta">key</span> value NX 的效果等同于执行 SETNX <span class="hljs-meta">key</span> value 。<br>XX ： 只在键已经存在时， 才对键进行设置操作。<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#不论key是否存在.都设置</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> key1 value1<br>OK<br>127.0.0.1:6379&gt; get key1<br><span class="hljs-string">&quot;value1&quot;</span><br>127.0.0.1:6379&gt; TYPE key1  <span class="hljs-comment">#判断类型</span><br>string<br>127.0.0.1:6379&gt; SET title ceo ex 3 <span class="hljs-comment">#设置自动过期时间3s</span><br>OK<br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> NAME rlin<br>OK<br>127.0.0.1:6379&gt; get NAME<br><span class="hljs-string">&quot;rlin&quot;</span><br><br><span class="hljs-comment">#大小写敏感</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> name rlin<br>OK<br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> NAME Rlin<br>OK<br>127.0.0.1:6379&gt; get name<br><span class="hljs-string">&quot;rlin&quot;</span><br>127.0.0.1:6379&gt; get NAME<br><span class="hljs-string">&quot;Rlin&quot;</span><br><br><span class="hljs-comment">#NX：key不存在,才设置,相当于add</span><br>127.0.0.1:6379&gt; get title<br><span class="hljs-string">&quot;ceo&quot;</span><br>127.0.0.1:6379&gt; setnx title coo  <span class="hljs-comment">#或“set key value nx”</span><br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; get title<br><span class="hljs-string">&quot;ceo&quot;</span><br>127.0.0.1:6379&gt; setnx campon Asia<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; get campon<br><span class="hljs-string">&quot;Asia&quot;</span><br><br><span class="hljs-comment">#XX：key存在,才设置,相当于update</span><br>127.0.0.1:6379&gt; get title<br><span class="hljs-string">&quot;ceo&quot;</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> title coo xx<br>OK<br>127.0.0.1:6379&gt; get title<br><span class="hljs-string">&quot;coo&quot;</span><br>127.0.0.1:6379&gt; get age<br>(nil)<br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> age 20 xx<br>(nil)<br>127.0.0.1:6379&gt; get age<br>(nil)<br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-2-获取一个key的内容"><a href="#2-5-1-2-获取一个key的内容" class="headerlink" title="2.5.1.2 获取一个key的内容"></a>2.5.1.2 获取一个key的内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：GET key</span><br><span class="hljs-comment">#获取一个key的内容</span><br>10.0.0.50:6379&gt; get k1<br><span class="hljs-string">&quot;v1&quot;</span><br>10.0.0.50:6379&gt; get k2<br><span class="hljs-string">&quot;v2&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-3-删除一个和多个key"><a href="#2-5-1-3-删除一个和多个key" class="headerlink" title="2.5.1.3 删除一个和多个key"></a>2.5.1.3 删除一个和多个key</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：DEL key [key ...]</span><br>127.0.0.1:6379&gt; DEL key1<br>(<span class="hljs-built_in">integer</span>) 1<br><br>127.0.0.1:6379&gt; DEL key1 key2<br>(<span class="hljs-built_in">integer</span>) 2<br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-4-批量设置多个key"><a href="#2-5-1-4-批量设置多个key" class="headerlink" title="2.5.1.4 批量设置多个key"></a>2.5.1.4 批量设置多个key</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式:MSET key value [key value ...]</span><br>127.0.0.1:6379&gt; MSET key1 value1 key2 value2<br>OK<br>10.0.0.50:6379&gt; MSET gouqunzhu gouduizhang gouguanli1 laowang gouguanli2 xiaowei gouguanli3 jiangzong<br>OK<br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-5-批量获取多个value"><a href="#2-5-1-5-批量获取多个value" class="headerlink" title="2.5.1.5 批量获取多个value"></a>2.5.1.5 批量获取多个value</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式:MGET key [key ...]</span><br>127.0.0.1:6379&gt; MGET key1 key2<br>1) <span class="hljs-string">&quot;value1&quot;</span><br>2) <span class="hljs-string">&quot;value2&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-6-追加数据"><a href="#2-5-1-6-追加数据" class="headerlink" title="2.5.1.6 追加数据"></a>2.5.1.6 追加数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：APPEND key value</span><br>127.0.0.1:6379&gt; APPEND key1 <span class="hljs-string">&quot; append new value&quot;</span><br>(<span class="hljs-built_in">integer</span>) 12        <span class="hljs-comment">#添加数据后,key1总共9个字节</span><br>127.0.0.1:6379&gt; get key1<br><span class="hljs-string">&quot;value1 append new value&quot;</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> key2 Hello<br>OK<br>127.0.0.1:6379&gt; APPEND key2 <span class="hljs-string">&quot; World&quot;</span><br>(<span class="hljs-built_in">integer</span>) 11<br>127.0.0.1:6379&gt; get key2<br><span class="hljs-string">&quot;Hello World&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-7-设置新值并返回旧值（可以知道之前旧value的值）"><a href="#2-5-1-7-设置新值并返回旧值（可以知道之前旧value的值）" class="headerlink" title="2.5.1.7 设置新值并返回旧值（可以知道之前旧value的值）"></a>2.5.1.7 设置新值并返回旧值（可以知道之前旧value的值）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：GETSET key value</span><br><span class="hljs-comment">#set key newvalue并返回旧的value</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> key3 386<br>OK<br>127.0.0.1:6379&gt; getset key3 457<br><span class="hljs-string">&quot;386&quot;</span><br>127.0.0.1:6379&gt; get key3<br><span class="hljs-string">&quot;457&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-8-返回字符串-key-对应值的字节数"><a href="#2-5-1-8-返回字符串-key-对应值的字节数" class="headerlink" title="2.5.1.8 返回字符串 key 对应值的字节数"></a>2.5.1.8 返回字符串 key 对应值的字节数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> name rlin<br>OK<br>127.0.0.1:6379&gt; STRLEN name<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; APPEND name <span class="hljs-string">&quot; haruka&quot;</span><br>(<span class="hljs-built_in">integer</span>) 11<br>127.0.0.1:6379&gt; get name<br><span class="hljs-string">&quot;rlin haruka&quot;</span><br>127.0.0.1:6379&gt; STRLEN name <span class="hljs-comment">#返回字节数</span><br>(<span class="hljs-built_in">integer</span>) 11 <br><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> address 127.0.0.1<br>OK<br>127.0.0.1:6379&gt; STRLEN address<br>(<span class="hljs-built_in">integer</span>) 9<br>127.0.0.1:6379&gt; APPEND address <span class="hljs-string">&quot; 10.0.0.101&quot;</span><br>(<span class="hljs-built_in">integer</span>) 20<br>127.0.0.1:6379&gt; get address<br><span class="hljs-string">&quot;127.0.0.1 10.0.0.101&quot;</span><br>127.0.0.1:6379&gt; STRLEN address<br>(<span class="hljs-built_in">integer</span>) 20<br><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> name 总队长<br>OK<br>127.0.0.1:6379&gt; get name<br><span class="hljs-string">&quot;\xe6\x80\xbb\xe9\x98\x9f\xe9\x95\xbf&quot;</span><br>127.0.0.1:6379&gt; strlen name<br>(<span class="hljs-built_in">integer</span>) 9<br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-9-判断-key-是否存在"><a href="#2-5-1-9-判断-key-是否存在" class="headerlink" title="2.5.1.9 判断 key 是否存在"></a>2.5.1.9 判断 key 是否存在</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; SET name rlin ex 10<br>OK<br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> age 10<br>OK<br>127.0.0.1:6379&gt; EXISTS NAME <span class="hljs-comment">#key的大小写敏感</span><br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; EXISTS name age <span class="hljs-comment">#返回值为1,表示存在2个key,0表示不存在</span><br>(<span class="hljs-built_in">integer</span>) 2<br>127.0.0.1:6379&gt; EXISTS name  <span class="hljs-comment">#过几秒再执行命令</span><br>(<span class="hljs-built_in">integer</span>) 0<br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-10-查看-key-的过期时间"><a href="#2-5-1-10-查看-key-的过期时间" class="headerlink" title="2.5.1.10 查看 key 的过期时间"></a>2.5.1.10 查看 key 的过期时间</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">ttl key <span class="hljs-comment">#查看key的剩余生存时间,如果key过期后,会自动删除</span><br>-1 <span class="hljs-comment">#返回值表示永不过期，默认创建的key是永不过期，重新对key赋值，也会从有剩余生命周期变成永不过期</span><br>-2 <span class="hljs-comment">#返回值表示没有此key</span><br>(<span class="hljs-built_in">integer</span>) num <span class="hljs-comment">#key的剩余有效期</span><br><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> name rlin ex 100<br>OK<br>127.0.0.1:6379&gt; ttl name<br>(<span class="hljs-built_in">integer</span>) 98<br>127.0.0.1:6379&gt; ttl name<br>(<span class="hljs-built_in">integer</span>) 94<br>127.0.0.1:6379&gt; ttl name<br>(<span class="hljs-built_in">integer</span>) 93<br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> name zongduizhang <span class="hljs-comment">#重新设置，没有加EX和时间，默认永不过期</span><br>OK<br>127.0.0.1:6379&gt; ttl name<br>(<span class="hljs-built_in">integer</span>) -1<br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> name rlin ex 200<br>OK<br>127.0.0.1:6379&gt; ttl name<br>(<span class="hljs-built_in">integer</span>) 197<br>127.0.0.1:6379&gt; get name<br><span class="hljs-string">&quot;rlin&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-11-重新设置key的过期时间"><a href="#2-5-1-11-重新设置key的过期时间" class="headerlink" title="2.5.1.11 重新设置key的过期时间"></a>2.5.1.11 重新设置key的过期时间</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：EXPIRE key seconds</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> name rlin ex 300<br>OK<br>127.0.0.1:6379&gt; ttl name<br>(<span class="hljs-built_in">integer</span>) 297<br>127.0.0.1:6379&gt; EXPIRE name 100<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ttl name<br>(<span class="hljs-built_in">integer</span>) 97<br>127.0.0.1:6379&gt; expire name 1000<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ttl name<br>(<span class="hljs-built_in">integer</span>) 998<br>127.0.0.1:6379&gt; expire name 86400<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ttl name<br>(<span class="hljs-built_in">integer</span>) 86398<br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-12-取消key的过期时间"><a href="#2-5-1-12-取消key的过期时间" class="headerlink" title="2.5.1.12 取消key的过期时间"></a>2.5.1.12 取消key的过期时间</h4><p>即永不过期</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：PERSIST key</span><br>127.0.0.1:6379&gt; TTL name<br>(<span class="hljs-built_in">integer</span>) 999<br>127.0.0.1:6379&gt; PERSIST name<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; TTL name<br>(<span class="hljs-built_in">integer</span>) -1<br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-13-数值递增"><a href="#2-5-1-13-数值递增" class="headerlink" title="2.5.1.13 数值递增"></a>2.5.1.13 数值递增</h4><p>利用INCR命令簇（INCR, DECR, INCRBY,DECRBY)来把字符串当作原子计数器使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：INCR key</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> num 10 <span class="hljs-comment">#设置初始值</span><br>OK<br>127.0.0.1:6379&gt; INCR num<br>(<span class="hljs-built_in">integer</span>) 11<br>127.0.0.1:6379&gt; get num<br><span class="hljs-string">&quot;11&quot;</span><br><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> num -9<br>OK<br>127.0.0.1:6379&gt; INCR num<br>(<span class="hljs-built_in">integer</span>) -8<br>127.0.0.1:6379&gt; get num<br><span class="hljs-string">&quot;-8&quot;</span><br><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> name rlin<br>OK<br>127.0.0.1:6379&gt; INCR name<br>(error) ERR value is not an <span class="hljs-built_in">integer</span> or out of range<br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-14-数值递减"><a href="#2-5-1-14-数值递减" class="headerlink" title="2.5.1.14 数值递减"></a>2.5.1.14 数值递减</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：DECR key</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> num 10<br>OK<br>127.0.0.1:6379&gt; DECR num<br>(<span class="hljs-built_in">integer</span>) 9<br>127.0.0.1:6379&gt; get num<br><span class="hljs-string">&quot;9&quot;</span><br><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> num -100<br>OK<br>127.0.0.1:6379&gt; decr num<br>(<span class="hljs-built_in">integer</span>) -101<br>127.0.0.1:6379&gt; get num<br><span class="hljs-string">&quot;-101&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-15-数值增加"><a href="#2-5-1-15-数值增加" class="headerlink" title="2.5.1.15 数值增加"></a>2.5.1.15 数值增加</h4><p>将key对应的数字加decrement(可以是负数)。如果key不存在，操作之前，key就会被置为0。如果key的value类型错误或者是个不能表示成数字的字符串，就返回错误。这个操作最多支持64位有符号的正型数字。</p>
<p><strong>类似于：N+（A） A为自然数</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：INCRBY key increment</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> num 777<br>OK<br>127.0.0.1:6379&gt; INCRBY num 666<br>(<span class="hljs-built_in">integer</span>) 1443<br>127.0.0.1:6379&gt; get num<br><span class="hljs-string">&quot;1443&quot;</span><br>127.0.0.1:6379&gt; INCRBY num -1500<br>(<span class="hljs-built_in">integer</span>) -57<br>127.0.0.1:6379&gt; get num<br><span class="hljs-string">&quot;-57&quot;</span><br><br><span class="hljs-comment">#如果key不存在，操作之前，key就会被置为0</span><br>127.0.0.1:6379&gt; get zero<br>(nil)<br>127.0.0.1:6379&gt; INCRBY zero 10<br>(<span class="hljs-built_in">integer</span>) 10<br>127.0.0.1:6379&gt; get zero<br><span class="hljs-string">&quot;10&quot;</span><br><br><span class="hljs-comment">#如果key不存在，操作之前，key就会被置为0</span><br>127.0.0.1:6379&gt; get none<br>(nil)<br>127.0.0.1:6379&gt; INCRBY none -999<br>(<span class="hljs-built_in">integer</span>) -999<br>127.0.0.1:6379&gt; get none<br><span class="hljs-string">&quot;-999&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-16-数据减少"><a href="#2-5-1-16-数据减少" class="headerlink" title="2.5.1.16 数据减少"></a>2.5.1.16 数据减少</h4><p>decrby 可以减小数值(也可以增加)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式DECRBY key decrement</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> num 200<br>OK<br>127.0.0.1:6379&gt; DECRBY num 233<br>(<span class="hljs-built_in">integer</span>) -33<br>127.0.0.1:6379&gt; get num<br><span class="hljs-string">&quot;-33&quot;</span><br>127.0.0.1:6379&gt; DECRBY num -40<br>(<span class="hljs-built_in">integer</span>) 7<br>127.0.0.1:6379&gt; get num<br><span class="hljs-string">&quot;7&quot;</span><br><br><span class="hljs-comment">#如果key不存在，操作之前，key就会被置为0</span><br>127.0.0.1:6379&gt; get zero<br>(nil)<br>127.0.0.1:6379&gt; DECRBY zero 10<br>(<span class="hljs-built_in">integer</span>) -10<br>127.0.0.1:6379&gt; get zero<br><span class="hljs-string">&quot;-10&quot;</span><br><br><span class="hljs-comment">#如果key不存在，操作之前，key就会被置为0</span><br>127.0.0.1:6379&gt; get none<br>(nil)<br>127.0.0.1:6379&gt; DECRBY none -666<br>(<span class="hljs-built_in">integer</span>) 666<br>127.0.0.1:6379&gt; get none<br><span class="hljs-string">&quot;666&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-5-2-列表-list"><a href="#2-5-2-列表-list" class="headerlink" title="2.5.2 列表 list"></a>2.5.2 列表 list</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis76.png" srcset="/blog/img/loading.gif"></p>
<p>列表是一个双向可读写的管道，其头部是左侧，尾部是右侧，一个列表最多可以包含2^32-1（4294967295）个元素，下标 0 表示列表的第一个元素，以 1 表示列表的第二个元素，以此类推。也可以使用负数下标，以 -1 表示列表的最后一个元素， -2 表示列表的倒数第二个元素，元素值可以重复，常用于存入日志等场景，此数据类型比较常用</p>
<p>列表特点</p>
<ul>
<li>有序</li>
<li>可重复</li>
<li>左右都可以操作</li>
</ul>
<h4 id="2-5-2-1-生成列表并插入数据"><a href="#2-5-2-1-生成列表并插入数据" class="headerlink" title="2.5.2.1 生成列表并插入数据"></a>2.5.2.1 生成列表并插入数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis77.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis78.png" srcset="/blog/img/loading.gif"></p>
<p>LPUSH和RPUSH都可以插入列表</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">LPUSH</span> <span class="hljs-selector-tag">key</span> <span class="hljs-selector-tag">value</span> <span class="hljs-selector-attr">[value …]</span><br>时间复杂度： <span class="hljs-selector-tag">O</span>(<span class="hljs-number">1</span>)<br>将一个或多个值 <span class="hljs-selector-tag">value</span> 插入到列表 <span class="hljs-selector-tag">key</span> 的表头<br><br>如果有多个 <span class="hljs-selector-tag">value</span> 值，那么各个 <span class="hljs-selector-tag">value</span> 值按从左到右的顺序依次插入到表头： 比如说，对空列表 <span class="hljs-selector-tag">mylist</span> 执行命令 <span class="hljs-selector-tag">LPUSH</span> <span class="hljs-selector-tag">mylist</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">b</span> <span class="hljs-selector-tag">c</span> ，列表的值将是 <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">b</span> <span class="hljs-selector-tag">a</span> ，这等同于原子性地执行 <span class="hljs-selector-tag">LPUSH</span> <span class="hljs-selector-tag">mylist</span> <span class="hljs-selector-tag">a</span> 、 <span class="hljs-selector-tag">LPUSH</span> <span class="hljs-selector-tag">mylist</span> <span class="hljs-selector-tag">b</span> 和 <span class="hljs-selector-tag">LPUSH</span> <span class="hljs-selector-tag">mylist</span> <span class="hljs-selector-tag">c</span> 三个命令。<br><br>如果 <span class="hljs-selector-tag">key</span> 不存在，一个空列表会被创建并执行 <span class="hljs-selector-tag">LPUSH</span> 操作。<br><br>当 <span class="hljs-selector-tag">key</span> 存在但不是列表类型时，返回一个错误。<br><br><span class="hljs-selector-tag">RPUSH</span> <span class="hljs-selector-tag">key</span> <span class="hljs-selector-tag">value</span> <span class="hljs-selector-attr">[value …]</span><br>时间复杂度： <span class="hljs-selector-tag">O</span>(<span class="hljs-number">1</span>)<br>将一个或多个值 <span class="hljs-selector-tag">value</span> 插入到列表 <span class="hljs-selector-tag">key</span> 的表尾(最右边)。<br><br>如果有多个 <span class="hljs-selector-tag">value</span> 值，那么各个 <span class="hljs-selector-tag">value</span> 值按从左到右的顺序依次插入到表尾：比如对一个空列表 <span class="hljs-selector-tag">mylist</span> 执行 <span class="hljs-selector-tag">RPUSH</span> <span class="hljs-selector-tag">mylist</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">b</span> <span class="hljs-selector-tag">c</span> ，得出的结果列表为 <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">b</span> <span class="hljs-selector-tag">c</span> ，等同于执行命令 <span class="hljs-selector-tag">RPUSH</span> <span class="hljs-selector-tag">mylist</span> <span class="hljs-selector-tag">a</span> 、 <span class="hljs-selector-tag">RPUSH</span> <span class="hljs-selector-tag">mylist</span> <span class="hljs-selector-tag">b</span> 、 <span class="hljs-selector-tag">RPUSH</span> <span class="hljs-selector-tag">mylist</span> <span class="hljs-selector-tag">c</span> 。<br><br>如果 <span class="hljs-selector-tag">key</span> 不存在，一个空列表会被创建并执行 <span class="hljs-selector-tag">RPUSH</span> 操作。<br><br>当 <span class="hljs-selector-tag">key</span> 存在但不是列表类型时，返回一个错误。<br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-2-往列表的左边添加数据"><a href="#2-5-2-2-往列表的左边添加数据" class="headerlink" title="2.5.2.2 往列表的左边添加数据"></a>2.5.2.2 往列表的左边添加数据</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">LPUSH key value [value …]<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; LPUSH name math englinsh chinese physical <span class="hljs-comment">#根据顺序逐个写入name，最后的physical会在列表的最左侧。</span><br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; <span class="hljs-built_in">type</span> name<br>list<br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-3-往列表的右边添加数据"><a href="#2-5-2-3-往列表的右边添加数据" class="headerlink" title="2.5.2.3 往列表的右边添加数据"></a>2.5.2.3 往列表的右边添加数据</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">RPUSH key value [value …]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; RPUSH plan planA planB planC<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; <span class="hljs-built_in">type</span> plan<br>list<br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-3-往列表的左边追加数据"><a href="#2-5-2-3-往列表的左边追加数据" class="headerlink" title="2.5.2.3 往列表的左边追加数据"></a>2.5.2.3 往列表的左边追加数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; LPUSH name ken <span class="hljs-comment">#存在的数据往左移动</span><br>(<span class="hljs-built_in">integer</span>) 5<br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-4-往列表的有边追加数据"><a href="#2-5-2-4-往列表的有边追加数据" class="headerlink" title="2.5.2.4 往列表的有边追加数据"></a>2.5.2.4 往列表的有边追加数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; RPUSH plan planD <span class="hljs-comment">#存在的数据往右移动</span><br>(<span class="hljs-built_in">integer</span>) 4<br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-5-获取列表长度-元素个数"><a href="#2-5-2-5-获取列表长度-元素个数" class="headerlink" title="2.5.2.5 获取列表长度(元素个数)"></a>2.5.2.5 获取列表长度(元素个数)</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">LLEN key<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; llen plan<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; llen name<br>(<span class="hljs-built_in">integer</span>) 5<br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-6-获取列表指定位置数据"><a href="#2-5-2-6-获取列表指定位置数据" class="headerlink" title="2.5.2.6 获取列表指定位置数据"></a>2.5.2.6 获取列表指定位置数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis79.png" srcset="/blog/img/loading.gif"></p>
<hr>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis80.png" srcset="/blog/img/loading.gif"></p>
<hr>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis81.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-5-2-7-获取列表单个编号的值"><a href="#2-5-2-7-获取列表单个编号的值" class="headerlink" title="2.5.2.7 获取列表单个编号的值"></a>2.5.2.7 获取列表单个编号的值</h4><p>语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">LINDEX key index<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; LPUSH plan planA planB planC planD<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; LINDEX plan 0 <span class="hljs-comment">#获取0编号的值</span><br><span class="hljs-string">&quot;planD&quot;</span><br>127.0.0.1:6379&gt; LINDEX plan 1<br><span class="hljs-string">&quot;planC&quot;</span><br>127.0.0.1:6379&gt; LINDEX plan 2<br><span class="hljs-string">&quot;planB&quot;</span><br>127.0.0.1:6379&gt; LINDEX plan 3 <span class="hljs-comment">#获取3编号的元素</span><br><span class="hljs-string">&quot;planA&quot;</span><br>127.0.0.1:6379&gt; LINDEX plan 4<br>(nil)<br>127.0.0.1:6379&gt; LINDEX plan -1 <span class="hljs-comment">#获取倒数第一个的值</span><br><span class="hljs-string">&quot;planA&quot;</span><br>127.0.0.1:6379&gt; LINDEX plan -2 <span class="hljs-comment">#获取倒数第二个的值</span><br><span class="hljs-string">&quot;planB&quot;</span><br>127.0.0.1:6379&gt; LINDEX plan -4<br><span class="hljs-string">&quot;planD&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-8-获取列表多个编号的值"><a href="#2-5-2-8-获取列表多个编号的值" class="headerlink" title="2.5.2.8 获取列表多个编号的值"></a>2.5.2.8 获取列表多个编号的值</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">LRANGE key start stop<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#元素从0开始编号</span><br><span class="hljs-comment">#0 -1 表示所有元素</span><br>127.0.0.1:6379&gt; LPUSH plan planA planB planC planD planE<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; LLEN plan<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; LRANGE plan 1 2<br>1) <span class="hljs-string">&quot;planD&quot;</span><br>2) <span class="hljs-string">&quot;planC&quot;</span><br>127.0.0.1:6379&gt; LRANGE plan 0 2<br>1) <span class="hljs-string">&quot;planE&quot;</span><br>2) <span class="hljs-string">&quot;planD&quot;</span><br>3) <span class="hljs-string">&quot;planC&quot;</span><br>127.0.0.1:6379&gt; LRANGE plan 0 4 <span class="hljs-comment">#所有元素</span><br>1) <span class="hljs-string">&quot;planE&quot;</span><br>2) <span class="hljs-string">&quot;planD&quot;</span><br>3) <span class="hljs-string">&quot;planC&quot;</span><br>4) <span class="hljs-string">&quot;planB&quot;</span><br>5) <span class="hljs-string">&quot;planA&quot;</span><br>127.0.0.1:6379&gt; LRANGE plan 0 -1 <span class="hljs-comment">#所有元素</span><br>1) <span class="hljs-string">&quot;planE&quot;</span><br>2) <span class="hljs-string">&quot;planD&quot;</span><br>3) <span class="hljs-string">&quot;planC&quot;</span><br>4) <span class="hljs-string">&quot;planB&quot;</span><br>5) <span class="hljs-string">&quot;planA&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-9-修改列表指定索引值"><a href="#2-5-2-9-修改列表指定索引值" class="headerlink" title="2.5.2.9 修改列表指定索引值"></a>2.5.2.9 修改列表指定索引值</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis82.png" srcset="/blog/img/loading.gif"></p>
<p>语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh、">LSET key index value<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; RPUSH list1 a b c d e f<br>(<span class="hljs-built_in">integer</span>) 6<br>127.0.0.1:6379&gt; llen list1<br>(<span class="hljs-built_in">integer</span>) 6<br>127.0.0.1:6379&gt; LRANGE list1 0 -1<br>1) <span class="hljs-string">&quot;a&quot;</span><br>2) <span class="hljs-string">&quot;b&quot;</span><br>3) <span class="hljs-string">&quot;c&quot;</span><br>4) <span class="hljs-string">&quot;d&quot;</span><br>5) <span class="hljs-string">&quot;e&quot;</span><br>6) <span class="hljs-string">&quot;f&quot;</span><br>127.0.0.1:6379&gt; lset list1 3 33<br>OK<br>127.0.0.1:6379&gt; LRANGE list1 0 -1<br>1) <span class="hljs-string">&quot;a&quot;</span><br>2) <span class="hljs-string">&quot;b&quot;</span><br>3) <span class="hljs-string">&quot;c&quot;</span><br>4) <span class="hljs-string">&quot;33&quot;</span><br>5) <span class="hljs-string">&quot;e&quot;</span><br>6) <span class="hljs-string">&quot;f&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-10-移除列表第一个数据"><a href="#2-5-2-10-移除列表第一个数据" class="headerlink" title="2.5.2.10 移除列表第一个数据"></a>2.5.2.10 移除列表第一个数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis83.png" srcset="/blog/img/loading.gif"></p>
<p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">LPOP key <span class="hljs-comment">#删除列表第一个元素</span><br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; lpush list a b c d e f<br>(<span class="hljs-built_in">integer</span>) 6<br>127.0.0.1:6379&gt; LRANGE list 0 -1<br>1) <span class="hljs-string">&quot;f&quot;</span><br>2) <span class="hljs-string">&quot;e&quot;</span><br>3) <span class="hljs-string">&quot;d&quot;</span><br>4) <span class="hljs-string">&quot;c&quot;</span><br>5) <span class="hljs-string">&quot;b&quot;</span><br>6) <span class="hljs-string">&quot;a&quot;</span><br>127.0.0.1:6379&gt; LPOP list <br><span class="hljs-string">&quot;f&quot;</span><br>127.0.0.1:6379&gt; LRANGE list 0 -1<br>1) <span class="hljs-string">&quot;e&quot;</span><br>2) <span class="hljs-string">&quot;d&quot;</span><br>3) <span class="hljs-string">&quot;c&quot;</span><br>4) <span class="hljs-string">&quot;b&quot;</span><br>5) <span class="hljs-string">&quot;a&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-11-移除列表最后一个数据"><a href="#2-5-2-11-移除列表最后一个数据" class="headerlink" title="2.5.2.11 移除列表最后一个数据"></a>2.5.2.11 移除列表最后一个数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis84.png" srcset="/blog/img/loading.gif"></p>
<p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">RPOP key <span class="hljs-comment">#删除列表最后第一个元素</span><br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; LPUSH list 1 2 3 4 5 6<br>(<span class="hljs-built_in">integer</span>) 6<br>127.0.0.1:6379&gt; LRANGE list 0 -1<br>1) <span class="hljs-string">&quot;6&quot;</span><br>2) <span class="hljs-string">&quot;5&quot;</span><br>3) <span class="hljs-string">&quot;4&quot;</span><br>4) <span class="hljs-string">&quot;3&quot;</span><br>5) <span class="hljs-string">&quot;2&quot;</span><br>6) <span class="hljs-string">&quot;1&quot;</span><br>127.0.0.1:6379&gt; RPOP list<br><span class="hljs-string">&quot;1&quot;</span><br>127.0.0.1:6379&gt; LRANGE list 0 -1<br>1) <span class="hljs-string">&quot;6&quot;</span><br>2) <span class="hljs-string">&quot;5&quot;</span><br>3) <span class="hljs-string">&quot;4&quot;</span><br>4) <span class="hljs-string">&quot;3&quot;</span><br>5) <span class="hljs-string">&quot;2&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-12-保留列表某个区间的元素"><a href="#2-5-2-12-保留列表某个区间的元素" class="headerlink" title="2.5.2.12 保留列表某个区间的元素"></a>2.5.2.12 保留列表某个区间的元素</h4><p>LTRIM 对一个列表进行修剪(trim)，让列表只保留指定区间内的元素，不在指定区间之内的元素都将被删除</p>
<p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">LTRIM key start stop <span class="hljs-comment">#只保留列表某个区间的元素</span><br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; LPUSH plan planA planB planC planD planE<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; LLEN plab<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; LLEN plan<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; LRANGE plan 0 -1<br>1) <span class="hljs-string">&quot;planE&quot;</span><br>2) <span class="hljs-string">&quot;planD&quot;</span><br>3) <span class="hljs-string">&quot;planC&quot;</span><br>4) <span class="hljs-string">&quot;planB&quot;</span><br>5) <span class="hljs-string">&quot;planA&quot;</span><br>127.0.0.1:6379&gt; LTRIM plan 2 4 <span class="hljs-comment">#只保留2到4号的值</span><br>OK<br>127.0.0.1:6379&gt; LRANGE plan 0 -1<br>1) <span class="hljs-string">&quot;planC&quot;</span><br>2) <span class="hljs-string">&quot;planB&quot;</span><br>3) <span class="hljs-string">&quot;planA&quot;</span><br><br>127.0.0.1:6379&gt; LPUSH plan planA planB planC planD planE<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; LRANGE plan 0 -1<br>1) <span class="hljs-string">&quot;planE&quot;</span><br>2) <span class="hljs-string">&quot;planD&quot;</span><br>3) <span class="hljs-string">&quot;planC&quot;</span><br>4) <span class="hljs-string">&quot;planB&quot;</span><br>5) <span class="hljs-string">&quot;planA&quot;</span><br>127.0.0.1:6379&gt; LTRIM plan -2 -1 <span class="hljs-comment">#只保留-1到-2号的值</span><br>OK<br>127.0.0.1:6379&gt; LRANGE plan 0 -1<br>1) <span class="hljs-string">&quot;planB&quot;</span><br>2) <span class="hljs-string">&quot;planA&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-13-删除列表"><a href="#2-5-2-13-删除列表" class="headerlink" title="2.5.2.13 删除列表"></a>2.5.2.13 删除列表</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">DEL key [key......]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; LPUSH plan planA planB planC planD planE<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; DEL plan<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; EXISTS plan<br>(<span class="hljs-built_in">integer</span>) 0<br></code></pre></td></tr></table></figure>

<h3 id="2-5-3-集合-set"><a href="#2-5-3-集合-set" class="headerlink" title="2.5.3 集合 set"></a>2.5.3 集合 set</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis85.png" srcset="/blog/img/loading.gif"></p>
<p>Set 是 String 类型的无序集合，集合中的成员是唯一的，这就意味着集合中不能出现重复的数据，可以在两个不同的集合中对数据进行对比并取值，常用于取值判断，统计，交集等场景</p>
<p>集合特点</p>
<ul>
<li>无序</li>
<li>无重复</li>
<li>集合间操作</li>
</ul>
<h4 id="2-5-3-1-生成集合key"><a href="#2-5-3-1-生成集合key" class="headerlink" title="2.5.3.1 生成集合key"></a>2.5.3.1 生成集合key</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">SADD key member [member ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; SADD key a b c<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; sadd num 1 2 3<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; <span class="hljs-built_in">type</span> key<br><span class="hljs-built_in">set</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">type</span> num<br><span class="hljs-built_in">set</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-3-2-追加数值"><a href="#2-5-3-2-追加数值" class="headerlink" title="2.5.3.2 追加数值"></a>2.5.3.2 追加数值</h4><p>追加时，只能追加不存在的数据，不能追加已经存在的数值</p>
<p><strong>语法同上</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; SADD key d e f<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; sadd num 3 <span class="hljs-comment">#已存在的value,无法再次添加</span><br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; <span class="hljs-built_in">type</span> key<br><span class="hljs-built_in">set</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">type</span> num<br><span class="hljs-built_in">set</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-3-3-查看集合的所有数据"><a href="#2-5-3-3-查看集合的所有数据" class="headerlink" title="2.5.3.3 查看集合的所有数据"></a>2.5.3.3 查看集合的所有数据</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">SMEMBERS key<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; sadd plan plan1 plan2 plan3 plan4 plan5<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; smembers plan<br>1) <span class="hljs-string">&quot;plan2&quot;</span><br>2) <span class="hljs-string">&quot;plan4&quot;</span><br>3) <span class="hljs-string">&quot;plan1&quot;</span><br>4) <span class="hljs-string">&quot;plan3&quot;</span><br>5) <span class="hljs-string">&quot;plan5&quot;</span><br><br>127.0.0.1:6379&gt; sadd <span class="hljs-built_in">source</span> java python c c++ c<span class="hljs-comment">#</span><br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; smembers <span class="hljs-built_in">source</span><br>1) <span class="hljs-string">&quot;c++&quot;</span><br>2) <span class="hljs-string">&quot;c&quot;</span><br>3) <span class="hljs-string">&quot;python&quot;</span><br>4) <span class="hljs-string">&quot;java&quot;</span><br>5) <span class="hljs-string">&quot;c#&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-3-4-删除集合中的元素"><a href="#2-5-3-4-删除集合中的元素" class="headerlink" title="2.5.3.4 删除集合中的元素"></a>2.5.3.4 删除集合中的元素</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">SREM key member [member ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; sadd plan plan1 plan2 plan3 plan4 plan5 <span class="hljs-comment">#创建集合</span><br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; SMEMBERS plan <span class="hljs-comment">#查看集合</span><br>1) <span class="hljs-string">&quot;plan2&quot;</span><br>2) <span class="hljs-string">&quot;plan4&quot;</span><br>3) <span class="hljs-string">&quot;plan1&quot;</span><br>4) <span class="hljs-string">&quot;plan3&quot;</span><br>5) <span class="hljs-string">&quot;plan5&quot;</span><br>127.0.0.1:6379&gt; sadd plan plan6 <span class="hljs-comment">#追加集合中的元素</span><br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; SMEMBERS plan <span class="hljs-comment">#查看集合</span><br>1) <span class="hljs-string">&quot;plan4&quot;</span><br>2) <span class="hljs-string">&quot;plan1&quot;</span><br>3) <span class="hljs-string">&quot;plan3&quot;</span><br>4) <span class="hljs-string">&quot;plan2&quot;</span><br>5) <span class="hljs-string">&quot;plan6&quot;</span><br>6) <span class="hljs-string">&quot;plan5&quot;</span><br>127.0.0.1:6379&gt; SREM plan plan4 <span class="hljs-comment">#删除集合中的元素</span><br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; SMEMBERS plan <span class="hljs-comment">#查看集合</span><br>1) <span class="hljs-string">&quot;plan3&quot;</span><br>2) <span class="hljs-string">&quot;plan2&quot;</span><br>3) <span class="hljs-string">&quot;plan1&quot;</span><br>4) <span class="hljs-string">&quot;plan6&quot;</span><br>5) <span class="hljs-string">&quot;plan5&quot;</span><br></code></pre></td></tr></table></figure>

<p><strong>集合间操作:</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis86.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-5-3-5-获取集合的交集"><a href="#2-5-3-5-获取集合的交集" class="headerlink" title="2.5.3.5 获取集合的交集"></a>2.5.3.5 获取集合的交集</h4><p>交集：已属于A且属于B的元素称为A与B的交（集）</p>
<p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">SINTER key [key ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; sadd plan p1 p2 p3 p4<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; sadd pick p3 p4 p5 p6<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; SINTER plan pick<br>1) <span class="hljs-string">&quot;p3&quot;</span><br>2) <span class="hljs-string">&quot;p4&quot;</span><br><br>127.0.0.1:6379&gt; sadd class math english chinese<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; sadd cookie math physical chemiscial<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; SINTER class cookie<br>1) <span class="hljs-string">&quot;math&quot;</span><br><br>127.0.0.1:6379&gt; sadd num1 1 2 3 4 5 6 7 8 9<br>(<span class="hljs-built_in">integer</span>) 9<br>127.0.0.1:6379&gt; sadd num2 9 8 7 6 5 4 3 2 1 <br>(<span class="hljs-built_in">integer</span>) 9<br>127.0.0.1:6379&gt; sinter num1 num2<br>1) <span class="hljs-string">&quot;1&quot;</span><br>2) <span class="hljs-string">&quot;2&quot;</span><br>3) <span class="hljs-string">&quot;3&quot;</span><br>4) <span class="hljs-string">&quot;4&quot;</span><br>5) <span class="hljs-string">&quot;5&quot;</span><br>6) <span class="hljs-string">&quot;6&quot;</span><br>7) <span class="hljs-string">&quot;7&quot;</span><br>8) <span class="hljs-string">&quot;8&quot;</span><br>9) <span class="hljs-string">&quot;9&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-3-6-获取集合的并集"><a href="#2-5-3-6-获取集合的并集" class="headerlink" title="2.5.3.6 获取集合的并集"></a>2.5.3.6 获取集合的并集</h4><p>并集：已属于A或属于B的元素为称为A与B的并（集）（类似：我全都要）</p>
<p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">SUNION key [key ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; sadd class1 v1 v2 v3 v4 <br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; sadd class3 v4 v3 v8 v7<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; SUNION class1 class3<br>1) <span class="hljs-string">&quot;v8&quot;</span><br>2) <span class="hljs-string">&quot;v3&quot;</span><br>3) <span class="hljs-string">&quot;v7&quot;</span><br>4) <span class="hljs-string">&quot;v2&quot;</span><br>5) <span class="hljs-string">&quot;v1&quot;</span><br>6) <span class="hljs-string">&quot;v4&quot;</span><br><br>127.0.0.1:6379&gt; sadd plan1 plan1 plan2 plan3 plan4 plan 5<br>(<span class="hljs-built_in">integer</span>) 6<br>127.0.0.1:6379&gt; sadd plan2 planA planB planC planD planE<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; SUNION plan1 plan2<br> 1) <span class="hljs-string">&quot;plan3&quot;</span><br> 2) <span class="hljs-string">&quot;plan&quot;</span><br> 3) <span class="hljs-string">&quot;plan4&quot;</span><br> 4) <span class="hljs-string">&quot;plan2&quot;</span><br> 5) <span class="hljs-string">&quot;5&quot;</span><br> 6) <span class="hljs-string">&quot;planD&quot;</span><br> 7) <span class="hljs-string">&quot;planA&quot;</span><br> 8) <span class="hljs-string">&quot;planC&quot;</span><br> 9) <span class="hljs-string">&quot;planE&quot;</span><br>10) <span class="hljs-string">&quot;planB&quot;</span><br>11) <span class="hljs-string">&quot;plan1&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-7-获取集合的差集"><a href="#2-5-2-7-获取集合的差集" class="headerlink" title="2.5.2.7 获取集合的差集"></a>2.5.2.7 获取集合的差集</h4><p>差集：已属于A而不属于B的元素称为A与B的差（集）</p>
<p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">SDIFF key [key ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; sadd plan1 p1 p2 p3 p4 p5<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; sadd plan2 p2 p4 p5 p7 p10<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; SDIFF plan1 plan2<br>1) <span class="hljs-string">&quot;p1&quot;</span><br>2) <span class="hljs-string">&quot;p3&quot;</span><br><br>127.0.0.1:6379&gt; sadd class1 math chinese english<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; sadd class2 math political <span class="hljs-built_in">history</span><br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; SDIFF class1 class2<br>1) <span class="hljs-string">&quot;chinese&quot;</span><br>2) <span class="hljs-string">&quot;english&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-5-4-有序集合-sorted-set"><a href="#2-5-4-有序集合-sorted-set" class="headerlink" title="2.5.4 有序集合 sorted set"></a>2.5.4 有序集合 sorted set</h3><p>Redis 有序集合和集合一样也是string类型元素的集合,且不允许重复的成员，不同的是每个元素都会关联一个double(双精度浮点型)类型的分数，redis正是通过该分数来为集合中的成员进行从小到大的排序，有序集合的成员是唯一的,但分数(score)却可以重复，集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是O(1)， 集合中最大的成员数为 2^32 - 1 (4294967295, 每个集合可存储40多亿个成员)，经常用于排行榜的场景</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis88.png" srcset="/blog/img/loading.gif"></p>
<p>有序集合特点</p>
<ul>
<li>有序</li>
<li>无重复元素</li>
<li>每个元素是由score和value组成</li>
<li>score 可以重复</li>
<li>value 不可以重复</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis89.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis90.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-5-4-1-生成有序集合"><a href="#2-5-4-1-生成有序集合" class="headerlink" title="2.5.4.1 生成有序集合"></a>2.5.4.1 生成有序集合</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">ZADD key [NX|NX] [CH] [INCR] score member [score member ...] <br><span class="hljs-comment">#value 值为自然数</span><br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#单个赋值</span><br>127.0.0.1:6379&gt; ZADD plan 1 planA <span class="hljs-comment">#分数为1</span><br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD plan 2 plan1<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD plan 3 planB<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD plan 4 plan2<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD plan 5 a<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD plan 6 txt<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD plan 3 233 <span class="hljs-comment">#分数可重复，元素值不可以重复</span><br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; TYPE plan<br>zset<br><br>127.0.0.1:6379&gt; ZADD list 100 math <br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD list 90 joker<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD list 233 haruka<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD list 7978 666<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD list 123 qwe<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD list 666 牛逼<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZADD list -95 qwe<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; ZADD list -1 gaga<br>(<span class="hljs-built_in">integer</span>) 1<br><br><span class="hljs-comment">#一次生成多个数据：</span><br>127.0.0.1:6379&gt; ZADD class 1 math 2 chinese 3 english 4 <span class="hljs-built_in">history</span> 5 political<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; TYPE class<br>zset<br></code></pre></td></tr></table></figure>

<h4 id="2-5-4-2-有序集合实现正序排序"><a href="#2-5-4-2-有序集合实现正序排序" class="headerlink" title="2.5.4.2 有序集合实现正序排序"></a>2.5.4.2 有序集合实现正序排序</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ZRANGE key start stop [WITHSCORES]<br></code></pre></td></tr></table></figure>

<p>范例：有序集合实现排行榜</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; ZADD paihangbang 90 nzzha 199 zhanlang 60 zhulouji 30 gangtiexia -100 shuimenqiao<br>(<span class="hljs-built_in">integer</span>) 5<br><br>127.0.0.1:6379&gt; ADD scoure 150 math 122 english 133 chinese 80 <span class="hljs-built_in">history</span> 98 politlcal<br>(<span class="hljs-built_in">integer</span>) 5<br><br>127.0.0.1:6379&gt; ZRANGE paihangbang 0 -1 <span class="hljs-comment">#正序排序后显示集合内所有的key,score从小到大显示</span><br>1) <span class="hljs-string">&quot;shuimenqiao&quot;</span><br>2) <span class="hljs-string">&quot;gangtiexia&quot;</span><br>3) <span class="hljs-string">&quot;zhulouji&quot;</span><br>4) <span class="hljs-string">&quot;nzzha&quot;</span><br>5) <span class="hljs-string">&quot;zhanlang&quot;</span><br><br>127.0.0.1:6379&gt; ZRANGE scoure 0 -1<br>1) <span class="hljs-string">&quot;history&quot;</span><br>2) <span class="hljs-string">&quot;politlcal&quot;</span><br>3) <span class="hljs-string">&quot;english&quot;</span><br>4) <span class="hljs-string">&quot;chinese&quot;</span><br>5) <span class="hljs-string">&quot;math&quot;</span><br><br>127.0.0.1:6379&gt; ZRANGE paihangbang 0 -1 withscores<br> 1) <span class="hljs-string">&quot;shuimenqiao&quot;</span><br> 2) <span class="hljs-string">&quot;-100&quot;</span><br> 3) <span class="hljs-string">&quot;gangtiexia&quot;</span><br> 4) <span class="hljs-string">&quot;30&quot;</span><br> 5) <span class="hljs-string">&quot;zhulouji&quot;</span><br> 6) <span class="hljs-string">&quot;60&quot;</span><br> 7) <span class="hljs-string">&quot;nzzha&quot;</span><br> 8) <span class="hljs-string">&quot;90&quot;</span><br> 9) <span class="hljs-string">&quot;zhanlang&quot;</span><br>10) <span class="hljs-string">&quot;199&quot;</span><br><br>127.0.0.1:6379&gt; ZRANGE scoure 0 -1 withscores<br> 1) <span class="hljs-string">&quot;history&quot;</span><br> 2) <span class="hljs-string">&quot;80&quot;</span><br> 3) <span class="hljs-string">&quot;politlcal&quot;</span><br> 4) <span class="hljs-string">&quot;98&quot;</span><br> 5) <span class="hljs-string">&quot;english&quot;</span><br> 6) <span class="hljs-string">&quot;122&quot;</span><br> 7) <span class="hljs-string">&quot;chinese&quot;</span><br> 8) <span class="hljs-string">&quot;133&quot;</span><br> 9) <span class="hljs-string">&quot;math&quot;</span><br>10) <span class="hljs-string">&quot;150&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-4-3-有序集合实现反向排序"><a href="#2-5-4-3-有序集合实现反向排序" class="headerlink" title="2.5.4.3 有序集合实现反向排序"></a>2.5.4.3 有序集合实现反向排序</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ZREVRANGE key start stop [WITHSCORES]<br></code></pre></td></tr></table></figure>

<p>范例：有序集合实现排行榜</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; ZADD paihangbang 90 nzzha 199 zhanlang 60 zhulouji 30 gangtiexia -100 shuimenqiao<br>(<span class="hljs-built_in">integer</span>) 5<br><br>127.0.0.1:6379&gt; ADD scoure 150 math 122 english 133 chinese 80 <span class="hljs-built_in">history</span> 98 politlcal<br>(<span class="hljs-built_in">integer</span>) 5<br><br>127.0.0.1:6379&gt; ZREVRANGE paihangbang 0 -1 <span class="hljs-comment">#倒序排序后显示集合内所有的key,score从大到小显示</span><br>1) <span class="hljs-string">&quot;zhanlang&quot;</span><br>2) <span class="hljs-string">&quot;nzzha&quot;</span><br>3) <span class="hljs-string">&quot;zhulouji&quot;</span><br>4) <span class="hljs-string">&quot;gangtiexia&quot;</span><br>5) <span class="hljs-string">&quot;shuimenqiao&quot;</span><br><br>127.0.0.1:6379&gt; ZREVRANGE scoure 0 -1<br>1) <span class="hljs-string">&quot;math&quot;</span><br>2) <span class="hljs-string">&quot;chinese&quot;</span><br>3) <span class="hljs-string">&quot;english&quot;</span><br>4) <span class="hljs-string">&quot;politlcal&quot;</span><br>5) <span class="hljs-string">&quot;history&quot;</span><br><br><span class="hljs-comment">#正序显示指定集合内所有key和得分情况</span><br>127.0.0.1:6379&gt; ZREVRANGE paihangbang 0 -1 WITHSCORES<br> 1) <span class="hljs-string">&quot;zhanlang&quot;</span><br> 2) <span class="hljs-string">&quot;199&quot;</span><br> 3) <span class="hljs-string">&quot;nzzha&quot;</span><br> 4) <span class="hljs-string">&quot;90&quot;</span><br> 5) <span class="hljs-string">&quot;zhulouji&quot;</span><br> 6) <span class="hljs-string">&quot;60&quot;</span><br> 7) <span class="hljs-string">&quot;gangtiexia&quot;</span><br> 8) <span class="hljs-string">&quot;30&quot;</span><br> 9) <span class="hljs-string">&quot;shuimenqiao&quot;</span><br>10) <span class="hljs-string">&quot;-100&quot;</span><br><br>127.0.0.1:6379&gt; ZREVRANGE scoure 0 -1 withscores<br> 1) <span class="hljs-string">&quot;math&quot;</span><br> 2) <span class="hljs-string">&quot;150&quot;</span><br> 3) <span class="hljs-string">&quot;chinese&quot;</span><br> 4) <span class="hljs-string">&quot;133&quot;</span><br> 5) <span class="hljs-string">&quot;english&quot;</span><br> 6) <span class="hljs-string">&quot;122&quot;</span><br> 7) <span class="hljs-string">&quot;politlcal&quot;</span><br> 8) <span class="hljs-string">&quot;98&quot;</span><br> 9) <span class="hljs-string">&quot;history&quot;</span><br>10) <span class="hljs-string">&quot;80&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-4-3-获取集合的个数"><a href="#2-5-4-3-获取集合的个数" class="headerlink" title="2.5.4.3 获取集合的个数"></a>2.5.4.3 获取集合的个数</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ZCARD key<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; ZADD plan 100 planA 90 planB 70 planC -100 planD<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; ZADD scoure 100 math 90 chinese 50 english 85 <span class="hljs-built_in">history</span><br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; ZADD temperature 30 guangzhou 23 hunan 19 hubei 11 beijing -20 heilongjiang<br>(<span class="hljs-built_in">integer</span>) 5<br>127.0.0.1:6379&gt; ZCARD plan<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; ZCARD scoure<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; ZCARD temperature<br>(<span class="hljs-built_in">integer</span>) 5<br></code></pre></td></tr></table></figure>

<h4 id="2-5-4-4-基于索引返回数值"><a href="#2-5-4-4-基于索引返回数值" class="headerlink" title="2.5.4.4 基于索引返回数值"></a>2.5.4.4 基于索引返回数值</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; zadd plan 1 v1 2 v2 3 v3 4 v4 5 v5 6 v6<br>(<span class="hljs-built_in">integer</span>) 6<br>127.0.0.1:6379&gt; ZRANGE plan 0 4 <span class="hljs-comment">#正着排，取0到4的值</span><br>1) <span class="hljs-string">&quot;v1&quot;</span><br>2) <span class="hljs-string">&quot;v2&quot;</span><br>3) <span class="hljs-string">&quot;v3&quot;</span><br>4) <span class="hljs-string">&quot;v4&quot;</span><br>5) <span class="hljs-string">&quot;v5&quot;</span><br>127.0.0.1:6379&gt; ZREVRANGE plan 3 5 <span class="hljs-comment">#反着排，取3到5的值</span><br>1) <span class="hljs-string">&quot;v3&quot;</span><br>2) <span class="hljs-string">&quot;v2&quot;</span><br>3) <span class="hljs-string">&quot;v1&quot;</span><br>127.0.0.1:6379&gt; ZRANGE plan 0 10 <span class="hljs-comment">#超出范围不报错</span><br>1) <span class="hljs-string">&quot;v1&quot;</span><br>2) <span class="hljs-string">&quot;v2&quot;</span><br>3) <span class="hljs-string">&quot;v3&quot;</span><br>4) <span class="hljs-string">&quot;v4&quot;</span><br>5) <span class="hljs-string">&quot;v5&quot;</span><br>6) <span class="hljs-string">&quot;v6&quot;</span><br>127.0.0.1:6379&gt; ZRANGE plan 2 2 <span class="hljs-comment">#正着排，取2号的值</span><br>1) <span class="hljs-string">&quot;v3&quot;</span><br>127.0.0.1:6379&gt; ZREVRANGE plan 4 4 <span class="hljs-comment">#反着排，取4号的值</span><br>1) <span class="hljs-string">&quot;v2&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-4-5-返回某个数值的索引-排名"><a href="#2-5-4-5-返回某个数值的索引-排名" class="headerlink" title="2.5.4.5 返回某个数值的索引(排名)"></a>2.5.4.5 返回某个数值的索引(排名)</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ZRANK key member<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; zadd plan 1 v1 2 v2 3 v3 4 v4 5 v5 6 v6<br>(<span class="hljs-built_in">integer</span>) 6<br><span class="hljs-comment">#格式：</span><br>127.0.0.1:6379&gt; ZRANK plan v4<br>(<span class="hljs-built_in">integer</span>) 3 <span class="hljs-comment">#第4个</span><br>127.0.0.1:6379&gt; ZRANK plan v2<br>(<span class="hljs-built_in">integer</span>) 1 <span class="hljs-comment">#第2个</span><br>127.0.0.1:6379&gt; ZRANK plan v0 <span class="hljs-comment">#取不存在的值</span><br>(nil)<br></code></pre></td></tr></table></figure>

<h4 id="2-5-4-6-获取分数"><a href="#2-5-4-6-获取分数" class="headerlink" title="2.5.4.6 获取分数"></a>2.5.4.6 获取分数</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ZSCORE key member<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; ZADD score 132 math 124 chinese 130 english 90 politics 93 <span class="hljs-built_in">history</span> 88 geography<br>(<span class="hljs-built_in">integer</span>) 6<br>127.0.0.1:6379&gt; TYPE score<br>zset<br>127.0.0.1:6379&gt; ZREVRANGE score 0 -1<br>1) <span class="hljs-string">&quot;math&quot;</span><br>2) <span class="hljs-string">&quot;english&quot;</span><br>3) <span class="hljs-string">&quot;chinese&quot;</span><br>4) <span class="hljs-string">&quot;history&quot;</span><br>5) <span class="hljs-string">&quot;politics&quot;</span><br>6) <span class="hljs-string">&quot;geography&quot;</span><br>127.0.0.1:6379&gt; ZSCORE score math<br><span class="hljs-string">&quot;132&quot;</span><br>127.0.0.1:6379&gt; ZSCORE score politics<br><span class="hljs-string">&quot;90&quot;</span><br>127.0.0.1:6379&gt; ZSCORE score chinese<br><span class="hljs-string">&quot;124&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-4-7-删除元素"><a href="#2-5-4-7-删除元素" class="headerlink" title="2.5.4.7 删除元素"></a>2.5.4.7 删除元素</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ZREM key member [member ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; ZADD score 132 math 124 chinese 130 english 90 politics 93 <span class="hljs-built_in">history</span> 88 geography<br>(<span class="hljs-built_in">integer</span>) 6<br>127.0.0.1:6379&gt; ZRANGE score 0 -1<br>1) <span class="hljs-string">&quot;geography&quot;</span><br>2) <span class="hljs-string">&quot;politics&quot;</span><br>3) <span class="hljs-string">&quot;history&quot;</span><br>4) <span class="hljs-string">&quot;chinese&quot;</span><br>5) <span class="hljs-string">&quot;english&quot;</span><br>6) <span class="hljs-string">&quot;math&quot;</span><br>127.0.0.1:6379&gt; ZREM score chinese <span class="hljs-comment">#删除一个元素</span><br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZRANGE score 0 -1<br>1) <span class="hljs-string">&quot;geography&quot;</span><br>2) <span class="hljs-string">&quot;politics&quot;</span><br>3) <span class="hljs-string">&quot;history&quot;</span><br>4) <span class="hljs-string">&quot;english&quot;</span><br>5) <span class="hljs-string">&quot;math&quot;</span><br>127.0.0.1:6379&gt; ZREM score english <span class="hljs-built_in">history</span> <span class="hljs-comment">#删除多个元素</span><br>(<span class="hljs-built_in">integer</span>) 2<br>127.0.0.1:6379&gt; ZRANGE score 0 -1<br>1) <span class="hljs-string">&quot;geography&quot;</span><br>2) <span class="hljs-string">&quot;politics&quot;</span><br>3) <span class="hljs-string">&quot;math&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-5-5-哈希-hash"><a href="#2-5-5-哈希-hash" class="headerlink" title="2.5.5 哈希 hash"></a>2.5.5 哈希 hash</h3><p>hash 是一个string类型的字段(field)和值(value)的映射表，Redis 中每个 hash 可以存储 2^32 -1 键值对，类似于字典，存放了多个k/v 对，hash特别适合用于存储对象场景</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis91.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis92.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis93.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-5-5-1-生成-hash-key"><a href="#2-5-5-1-生成-hash-key" class="headerlink" title="2.5.5.1 生成 hash key"></a>2.5.5.1 生成 hash key</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">HSET <span class="hljs-built_in">hash</span> field value<br>时间复杂度： O(1)<br>将哈希表 <span class="hljs-built_in">hash</span> 中域 field 的值设置为 value 。<br><br>如果给定的哈希表并不存在， 那么一个新的哈希表将被创建并执行 HSET 操作。<br>如果域 field 已经存在于哈希表中， 那么它的旧值将被新值 value 覆盖<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; HSET classmate name zongduizhang age 12 gender man <br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; TYPE classmate<br><span class="hljs-built_in">hash</span><br><br>127.0.0.1:6379&gt; HSET No9521 name zhouxingxing age 30 gender man<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; TYPE No9521<br><span class="hljs-built_in">hash</span><br><br>127.0.0.1:6379&gt; HSET report math 130 chinese 138 english 125<br>(<span class="hljs-built_in">integer</span>) 3<br><br><span class="hljs-comment">#给已存在的哈希表增加字段</span><br>127.0.0.1:6379&gt; HSET classmate height 175 weight 120<br>(<span class="hljs-built_in">integer</span>) 2<br><br>127.0.0.1:6379&gt; HSET No9521 height 172 weight 123<br>(<span class="hljs-built_in">integer</span>) 2<br><br>127.0.0.1:6379&gt; HSET report <span class="hljs-built_in">history</span> 95<br>(<span class="hljs-built_in">integer</span>) 1<br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-2-查看所有-hash-key-的值"><a href="#2-5-5-2-查看所有-hash-key-的值" class="headerlink" title="2.5.5.2 查看所有 hash key 的值"></a>2.5.5.2 查看所有 hash key 的值</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">HGETALL key<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; HGETALL report<br>1) <span class="hljs-string">&quot;math&quot;</span><br>2) <span class="hljs-string">&quot;130&quot;</span><br>3) <span class="hljs-string">&quot;chinese&quot;</span><br>4) <span class="hljs-string">&quot;138&quot;</span><br>5) <span class="hljs-string">&quot;english&quot;</span><br>6) <span class="hljs-string">&quot;125&quot;</span><br>127.0.0.1:6379&gt; HGETALL classmate<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;zongduizhang&quot;</span><br>3) <span class="hljs-string">&quot;age&quot;</span><br>4) <span class="hljs-string">&quot;12&quot;</span><br>5) <span class="hljs-string">&quot;gender&quot;</span><br>6) <span class="hljs-string">&quot;man&quot;</span><br>127.0.0.1:6379&gt; HGETALL No9521<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;zhouxingxing&quot;</span><br>3) <span class="hljs-string">&quot;age&quot;</span><br>4) <span class="hljs-string">&quot;30&quot;</span><br>5) <span class="hljs-string">&quot;gender&quot;</span><br>6) <span class="hljs-string">&quot;man&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-2-获取hash-key的单个对应字段的值"><a href="#2-5-5-2-获取hash-key的单个对应字段的值" class="headerlink" title="2.5.5.2 获取hash key的单个对应字段的值"></a>2.5.5.2 获取hash key的单个对应字段的值</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">HGET KEY FIELD<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; HGET No9521 age<br><span class="hljs-string">&quot;30&quot;</span><br>127.0.0.1:6379&gt; HGET No9521 name<br><span class="hljs-string">&quot;zhouxingxing&quot;</span><br>127.0.0.1:6379&gt; HGET report math<br><span class="hljs-string">&quot;130&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-3-获取-hash-key-的多个对应字段的值"><a href="#2-5-5-3-获取-hash-key-的多个对应字段的值" class="headerlink" title="2.5.5.3 获取 hash key 的多个对应字段的值"></a>2.5.5.3 获取 hash key 的多个对应字段的值</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">HMGET key filed [filed ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; HGETALL report<br>1) <span class="hljs-string">&quot;math&quot;</span><br>2) <span class="hljs-string">&quot;130&quot;</span><br>3) <span class="hljs-string">&quot;chinese&quot;</span><br>4) <span class="hljs-string">&quot;138&quot;</span><br>5) <span class="hljs-string">&quot;english&quot;</span><br>6) <span class="hljs-string">&quot;125&quot;</span><br>7) <span class="hljs-string">&quot;history&quot;</span><br>8) <span class="hljs-string">&quot;95&quot;</span><br>127.0.0.1:6379&gt; HMGET report math <span class="hljs-comment">#该命令也可以获取单个值</span><br>1) <span class="hljs-string">&quot;130&quot;</span><br>127.0.0.1:6379&gt; HMGET report math chinese<br>1) <span class="hljs-string">&quot;130&quot;</span><br>2) <span class="hljs-string">&quot;138&quot;</span><br>127.0.0.1:6379&gt; HMGET report math chinese english<br>1) <span class="hljs-string">&quot;130&quot;</span><br>2) <span class="hljs-string">&quot;138&quot;</span><br>3) <span class="hljs-string">&quot;125&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-3-删除一个hash-key-的对应字段"><a href="#2-5-5-3-删除一个hash-key-的对应字段" class="headerlink" title="2.5.5.3 删除一个hash key 的对应字段"></a>2.5.5.3 删除一个hash key 的对应字段</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">HDEL key filed [filed ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; HGETALL report<br>1) <span class="hljs-string">&quot;math&quot;</span><br>2) <span class="hljs-string">&quot;130&quot;</span><br>3) <span class="hljs-string">&quot;chinese&quot;</span><br>4) <span class="hljs-string">&quot;138&quot;</span><br>5) <span class="hljs-string">&quot;english&quot;</span><br>6) <span class="hljs-string">&quot;125&quot;</span><br>7) <span class="hljs-string">&quot;history&quot;</span><br>8) <span class="hljs-string">&quot;95&quot;</span><br>127.0.0.1:6379&gt; HDEL report math <span class="hljs-comment">#删除一个值</span><br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; HDEL report chinese english <span class="hljs-comment">#删除多个值</span><br>(<span class="hljs-built_in">integer</span>) 2<br>127.0.0.1:6379&gt; HGETALL report<br>1) <span class="hljs-string">&quot;history&quot;</span><br>2) <span class="hljs-string">&quot;95&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-4-批量设置hash-key的多个field和value"><a href="#2-5-5-4-批量设置hash-key的多个field和value" class="headerlink" title="2.5.5.4 批量设置hash key的多个field和value"></a>2.5.5.4 批量设置hash key的多个field和value</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">HMSET key filed value [file value ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; HMSET No9527 name zhongduizhang age 26 cithou<br>OK<br>127.0.0.1:6379&gt; HGETALL No9527<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;zhongduizhang&quot;</span><br>3) <span class="hljs-string">&quot;age&quot;</span><br>4) <span class="hljs-string">&quot;26&quot;</span><br>5) <span class="hljs-string">&quot;city&quot;</span><br>6) <span class="hljs-string">&quot;guangzhou&quot;</span><br><br>127.0.0.1:6379&gt; HMSET No0093 name amuluo age 30 city side7<br>OK<br>127.0.0.1:6379&gt; HGETALL No0093<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;amuluo&quot;</span><br>3) <span class="hljs-string">&quot;age&quot;</span><br>4) <span class="hljs-string">&quot;30&quot;</span><br>5) <span class="hljs-string">&quot;city&quot;</span><br>6) <span class="hljs-string">&quot;side7&quot;</span><br><br>127.0.0.1:6379&gt; HMSET mountain name huangshan age 500 city zhongguo<br>OK<br>127.0.0.1:6379&gt; HGETALL mountain<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;huangshan&quot;</span><br>3) <span class="hljs-string">&quot;age&quot;</span><br>4) <span class="hljs-string">&quot;500&quot;</span><br>5) <span class="hljs-string">&quot;city&quot;</span><br>6) <span class="hljs-string">&quot;zhongguo&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-5-获取hash中指定字段的值"><a href="#2-5-5-5-获取hash中指定字段的值" class="headerlink" title="2.5.5.5 获取hash中指定字段的值"></a>2.5.5.5 获取hash中指定字段的值</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">HMGET key filed [filed ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; HMSET No9527 name zhongduizhang age 26 cithou<br>OK<br>127.0.0.1:6379&gt; HMGET No9527 city <span class="hljs-comment">#获取单个元素的值</span><br>1) <span class="hljs-string">&quot;guangzhou&quot;</span><br>127.0.0.1:6379&gt; HMGET No9527 name age <span class="hljs-comment">#获取多个元素的值</span><br>1) <span class="hljs-string">&quot;zhongduizhang&quot;</span><br>2) <span class="hljs-string">&quot;26&quot;</span><br><br>127.0.0.1:6379&gt; HMSET No0093 name amuluo age 30 city side7<br>OK<br>127.0.0.1:6379&gt; HMGET No0093 city<br>1) <span class="hljs-string">&quot;side7&quot;</span><br><br>127.0.0.1:6379&gt; HMSET mountain name huangshan age 500 city zhongguo<br>OK<br>127.0.0.1:6379&gt; HMGET mountain name<br>1) <span class="hljs-string">&quot;huangshan&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-6-获取hash中的所有字段名field"><a href="#2-5-5-6-获取hash中的所有字段名field" class="headerlink" title="2.5.5.6 获取hash中的所有字段名field"></a>2.5.5.6 获取hash中的所有字段名field</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">HKEYS key<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; HMSET No9527 name zhongduizhang age 26 cithou<br>OK<br>HKEYS No9527<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;age&quot;</span><br>3) <span class="hljs-string">&quot;city&quot;</span><br><br>127.0.0.1:6379&gt; HMSET No0093 name amuluo age 30 city side7<br>OK<br>127.0.0.1:6379&gt; HKEYS No0093<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;age&quot;</span><br>3) <span class="hljs-string">&quot;city&quot;</span><br><br>127.0.0.1:6379&gt; HMSET mountain name huangshan age 500 city zhongguo<br>OK<br>127.0.0.1:6379&gt; HKEYS mountain<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;age&quot;</span><br>3) <span class="hljs-string">&quot;city&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-7-获取hash-key对应所有field的value"><a href="#2-5-5-7-获取hash-key对应所有field的value" class="headerlink" title="2.5.5.7 获取hash key对应所有field的value"></a>2.5.5.7 获取hash key对应所有field的value</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">HVALS key<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; HMSET No9527 name zhongduizhang age 26 cithou<br>OK<br>127.0.0.1:6379&gt; HVALS No9527<br>1) <span class="hljs-string">&quot;zhongduizhang&quot;</span><br>2) <span class="hljs-string">&quot;26&quot;</span><br>3) <span class="hljs-string">&quot;guangzhou&quot;</span><br><br>127.0.0.1:6379&gt; HMSET No0093 name amuluo age 30 city side7<br>OK<br>127.0.0.1:6379&gt; HVALS No0093<br>1) <span class="hljs-string">&quot;amuluo&quot;</span><br>2) <span class="hljs-string">&quot;30&quot;</span><br>3) <span class="hljs-string">&quot;side7&quot;</span><br><br>127.0.0.1:6379&gt; HMSET mountain name huangshan age 500 city zhongguo<br>OK<br>127.0.0.1:6379&gt; HVALS mountain<br>1) <span class="hljs-string">&quot;huangshan&quot;</span><br>2) <span class="hljs-string">&quot;500&quot;</span><br>3) <span class="hljs-string">&quot;zhongguo&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-7-获取指定hash-key-的所有field及value"><a href="#2-5-5-7-获取指定hash-key-的所有field及value" class="headerlink" title="2.5.5.7 获取指定hash key 的所有field及value"></a>2.5.5.7 获取指定hash key 的所有field及value</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">HGETALL key<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; HGETALL No9527<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;zhongduizhang&quot;</span><br>3) <span class="hljs-string">&quot;age&quot;</span><br>4) <span class="hljs-string">&quot;26&quot;</span><br>5) <span class="hljs-string">&quot;city&quot;</span><br>6) <span class="hljs-string">&quot;guangzhou&quot;</span><br><br>127.0.0.1:6379&gt; HGETALL No0093<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;amuluo&quot;</span><br>3) <span class="hljs-string">&quot;age&quot;</span><br>4) <span class="hljs-string">&quot;30&quot;</span><br>5) <span class="hljs-string">&quot;city&quot;</span><br>6) <span class="hljs-string">&quot;side7&quot;</span><br><br>127.0.0.1:6379&gt; HGETALL mountain<br>1) <span class="hljs-string">&quot;name&quot;</span><br>2) <span class="hljs-string">&quot;huangshan&quot;</span><br>3) <span class="hljs-string">&quot;age&quot;</span><br>4) <span class="hljs-string">&quot;500&quot;</span><br>5) <span class="hljs-string">&quot;city&quot;</span><br>6) <span class="hljs-string">&quot;zhongguo&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-8-删除-hash"><a href="#2-5-5-8-删除-hash" class="headerlink" title="2.5.5.8 删除 hash"></a>2.5.5.8 删除 hash</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><br></code></pre></td></tr></table></figure>

<p>翻译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; HMSET No9527 name zhongduizhang age 26 cithou<br>OK<br>127.0.0.1:6379&gt; DEL No9527<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; HMGET No9527 city <span class="hljs-comment">#被删除后key不存在了</span><br>1) (nil)<br>127.0.0.1:6379&gt; EXISTS No9527<br>(<span class="hljs-built_in">integer</span>) 0<br><br>127.0.0.1:6379&gt; HMSET No0093 name amuluo age 30 city site3<br>OK<br>127.0.0.1:6379&gt; DEL No0093 <br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; EXISTS No0093<br>(<span class="hljs-built_in">integer</span>) 0<br><br>127.0.0.1:6379&gt; HMSET hash1 plan1 v1 plan2 v2 plan3 v3 plan4 v4 plan5 v5<br>127.0.0.1:6379&gt; DEL hash1<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; EXISTS hash1<br>(<span class="hljs-built_in">integer</span>) 0<br></code></pre></td></tr></table></figure>

<h2 id="2-6-消息队列"><a href="#2-6-消息队列" class="headerlink" title="2.6 消息队列"></a>2.6 消息队列</h2><p>消息队列: 把要传输的数据放在队列中</p>
<p>功能: 可以实现多个系统之间的解耦,异步,削峰/限流等</p>
<p>常用的消息队列应用: kafka，rabbitMQ，redis</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis94.png" srcset="/blog/img/loading.gif"></p>
<p>消息队列主要分为两种,这两种模式Redis都支持</p>
<ul>
<li>生产者/消费者模式</li>
<li>发布者/订阅者模式</li>
</ul>
<h3 id="2-6-1-生产者消费者模式"><a href="#2-6-1-生产者消费者模式" class="headerlink" title="2.6.1 生产者消费者模式"></a>2.6.1 生产者消费者模式</h3><p>在生产者/消费者(Producer/Consumer)模式下，上层应用接收到的外部请求后开始处理其当前步骤的操作，在执行完成后将已经完成的操作发送至指定的频道(channel,逻辑队列)当中，并由其下层的应用监听该频道并继续下一步的操作，如果其处理完成后没有下一步的操作就直接返回数据给外部请求，如果还有下一步的操作就再将任务发布到另外一个频道，由另外一个消费者继续监听和处理。此模式应用广泛</p>
<h4 id="2-6-1-1-模式介绍"><a href="#2-6-1-1-模式介绍" class="headerlink" title="2.6.1.1 模式介绍"></a>2.6.1.1 模式介绍</h4><p>生产者消费者模式下，多个消费者同时监听一个队列，但是一个消息只能被最先抢到消息的消费者消费，即消息任务是一次性读取和处理，此模式在分布式业务架构中很常用，比较常用的消息队列软件还有RabbitMQ、Kafka、RocketMQ、ActiveMQ等。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis95.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-6-1-2-队列介绍"><a href="#2-6-1-2-队列介绍" class="headerlink" title="2.6.1.2 队列介绍"></a>2.6.1.2 队列介绍</h4><p>队列当中的消息由不同的生产者写入，也会有不同的消费者取出进行消费处理，但是一个消息一定是只能被取出一次也就是被消费一次。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis96.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis97.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis98.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-6-1-3-生产者发布消息"><a href="#2-6-1-3-生产者发布消息" class="headerlink" title="2.6.1.3 生产者发布消息"></a>2.6.1.3 生产者发布消息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; AUTH 123456<br>OK<br>127.0.0.1:6379&gt; LPUSH channel1 msg1 <span class="hljs-comment">#从管道的左侧写入</span><br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; LPUSH channel1 msg2<br>(<span class="hljs-built_in">integer</span>) 2<br>127.0.0.1:6379&gt; LPUSH channel1 msg3<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; LPUSH channel1 msg4<br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; LPUSH channel1 msg5<br>(<span class="hljs-built_in">integer</span>) 5<br></code></pre></td></tr></table></figure>

<h4 id="2-6-1-4-查看队列所有消息"><a href="#2-6-1-4-查看队列所有消息" class="headerlink" title="2.6.1.4 查看队列所有消息"></a>2.6.1.4 查看队列所有消息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; LRANGE channel1 0 -1<br>1) <span class="hljs-string">&quot;msg5&quot;</span><br>2) <span class="hljs-string">&quot;msg4&quot;</span><br>3) <span class="hljs-string">&quot;msg3&quot;</span><br>4) <span class="hljs-string">&quot;msg2&quot;</span><br>5) <span class="hljs-string">&quot;msg1&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-1-5-消费者消费消息"><a href="#2-6-1-5-消费者消费消息" class="headerlink" title="2.6.1.5 消费者消费消息"></a>2.6.1.5 消费者消费消息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; RPOP channel1 <span class="hljs-comment">#从管道的右侧消费，用于消息的先进先出</span><br><span class="hljs-string">&quot;msg1&quot;</span><br>127.0.0.1:6379&gt; RPOP channel1<br><span class="hljs-string">&quot;msg2&quot;</span><br>127.0.0.1:6379&gt; RPOP channel1<br><span class="hljs-string">&quot;msg3&quot;</span><br>127.0.0.1:6379&gt; RPOP channel1<br><span class="hljs-string">&quot;msg4&quot;</span><br>127.0.0.1:6379&gt; RPOP channel1<br><span class="hljs-string">&quot;msg5&quot;</span><br>127.0.0.1:6379&gt; RPOP channel1<br>(nil)<br></code></pre></td></tr></table></figure>

<h4 id="2-6-1-6-再次验证队列消息"><a href="#2-6-1-6-再次验证队列消息" class="headerlink" title="2.6.1.6 再次验证队列消息"></a>2.6.1.6 再次验证队列消息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; LRANGE channel1 0 -1<br>(empty list or <span class="hljs-built_in">set</span>)                           <span class="hljs-comment">#队列中的消息已经被已全部消费完毕</span><br></code></pre></td></tr></table></figure>

<h3 id="2-6-2-发布者订阅模式"><a href="#2-6-2-发布者订阅模式" class="headerlink" title="2.6.2 发布者订阅模式"></a>2.6.2 发布者订阅模式</h3><h4 id="2-6-2-1-模式简介"><a href="#2-6-2-1-模式简介" class="headerlink" title="2.6.2.1 模式简介"></a>2.6.2.1 模式简介</h4><p>在发布者订阅者模式下，发布者将消息发布到指定的channel里面，凡是监听该channel的消费者都会收到同样的一份消息，这种模式<strong>类似于是收音机的广播模式</strong>，即凡是收听某个频道的听众都会收到主持人发布的相同的消息内容。此模式常用语群聊天、群通知、群公告等场景</p>
<ul>
<li>Publisher：发布者</li>
<li>Subscriber：订阅者</li>
<li>Channel：频道</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis99.png" srcset="/blog/img/loading.gif" alt="redis98"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis100.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-6-2-2-订阅者监听频道"><a href="#2-6-2-2-订阅者监听频道" class="headerlink" title="2.6.2.2 订阅者监听频道"></a>2.6.2.2 订阅者监听频道</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SH">SUBSCRIBE channel [channel ...]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; SUBSCRIBE channel1 <span class="hljs-comment">#订阅者事先订阅指定的频道，之后发布的消息才能收到</span><br>Reading messages... (press Ctrl-C to quit)<br>1) <span class="hljs-string">&quot;subscribe&quot;</span><br>2) <span class="hljs-string">&quot;channel1&quot;</span><br>3) (<span class="hljs-built_in">integer</span>) 1<br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-3-发布者发布消息"><a href="#2-6-2-3-发布者发布消息" class="headerlink" title="2.6.2.3 发布者发布消息"></a>2.6.2.3 发布者发布消息</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">PUBLISH channel message<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; PUBLISH channel1 test1 <span class="hljs-comment">#发布者发布消息</span><br>(<span class="hljs-built_in">integer</span>) 2  <span class="hljs-comment">#订阅者个数</span><br>127.0.0.1:6379&gt; PUBLISH channel1 test2<br>(<span class="hljs-built_in">integer</span>) 2<br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-4-各个订阅者都能收到消息"><a href="#2-6-2-4-各个订阅者都能收到消息" class="headerlink" title="2.6.2.4 各个订阅者都能收到消息"></a>2.6.2.4 各个订阅者都能收到消息</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis101.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-6-2-5-订阅多个频道"><a href="#2-6-2-5-订阅多个频道" class="headerlink" title="2.6.2.5 订阅多个频道"></a>2.6.2.5 订阅多个频道</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#订阅指定的多个频道</span><br>127.0.0.1:6379&gt; SUBSCRIBE channel1 channel2<br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-6-订阅所有频道"><a href="#2-6-2-6-订阅所有频道" class="headerlink" title="2.6.2.6 订阅所有频道"></a>2.6.2.6 订阅所有频道</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; PSUBSCRIBE *  <span class="hljs-comment">#支持通配符*</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-7-订阅匹配的频道"><a href="#2-6-2-7-订阅匹配的频道" class="headerlink" title="2.6.2.7 订阅匹配的频道"></a>2.6.2.7 订阅匹配的频道</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; PSUBSCRIBE chann* <span class="hljs-comment">#匹配订阅多个频道</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-8-取消订阅"><a href="#2-6-2-8-取消订阅" class="headerlink" title="2.6.2.8 取消订阅"></a>2.6.2.8 取消订阅</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; unsubscribe channel1<br>1) <span class="hljs-string">&quot;unsubscribe&quot;</span><br>2) <span class="hljs-string">&quot;channel1&quot;</span><br>3) (<span class="hljs-built_in">integer</span>) 0<br></code></pre></td></tr></table></figure>

<h2 id="2-7-redis使用的注意事项"><a href="#2-7-redis使用的注意事项" class="headerlink" title="2.7 redis使用的注意事项"></a>2.7 redis使用的注意事项</h2><ol>
<li><strong>redis不能以root身份启动（特别是redis是放在公网的）</strong></li>
<li><strong>redis要设置安全密码</strong>*</li>
</ol>
<h1 id="三、redis集群与高可用"><a href="#三、redis集群与高可用" class="headerlink" title="三、redis集群与高可用"></a>三、redis集群与高可用</h1><p>虽然Redis可以实现单机的数据持久化，但无论是RDB也好或者AOF也好，都解决不了单点宕机问题，即一旦单台redis服务器本身出现系统故障、硬件故障等问题后，就会直接造成数据的丢失。</p>
<p>此外，单机的性能也是有极限的,因此需要使用另外的技术来解决单点故障和性能扩展的问题。</p>
<h2 id="3-1-redis-主从复制"><a href="#3-1-redis-主从复制" class="headerlink" title="3.1 redis 主从复制"></a>3.1 redis 主从复制</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis102.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-1-1-redis-主从复制架构"><a href="#3-1-1-redis-主从复制架构" class="headerlink" title="3.1.1 redis 主从复制架构"></a>3.1.1 redis 主从复制架构</h3><p>主从模式（master/slave），可以实现Redis数据的跨主机备份。</p>
<p>程序端连接到高可用负载的VIP，然后连接到负载服务器设置的Redis后端real server，此模式不需要在程序里面配 置Redis服务器的真实IP地址，当后期Redis服务器IP地址发生变更只需要更改redis 相应的后端real server即可， 可避免更改程序中的IP地址设置。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis103.png" srcset="/blog/img/loading.gif"></p>
<p>主从复制特点</p>
<ul>
<li>一个master可以有多个slave</li>
<li>一个slave只能有一个master</li>
<li>数据流向是单向的，master到slave</li>
</ul>
<h3 id="3-1-2-使用命令行方式实现主从复制"><a href="#3-1-2-使用命令行方式实现主从复制" class="headerlink" title="3.1.2 使用命令行方式实现主从复制"></a>3.1.2 使用命令行方式实现主从复制</h3><p><strong>Redis Slave 也要开启持久化并设置和master同样的连接密码</strong>，因为后期slave会有提升为master的可能,Slave 端切换master同步后会丢失之前的所有数据,而通过持久化可以恢复数据</p>
<p>一旦某个Slave成为一个master的slave，Redis Slave服务会清空当前redis服务器上的所有数据并将master的数据导入到自己的内存，但是如果只是断开同步关系后,则不会删除当前已经同步过的数据。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis104.png" srcset="/blog/img/loading.gif"></p>
<p>当配置Redis复制功能时，强烈建议打开主服务器的持久化功能。否则的话，由于延迟等问题，部署的服务应该要避免自动启动。</p>
<p>参考案例: 导致主从服务器数据全部丢失</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.假设节点A为主服务器，并且关闭了持久化。并且节点B和节点c从节点A复制数据<br>2.节点A崩溃，然后自动拉起服务重启了节点A.由于节点A的持久化被关闭了，所以重启之后没有任何数据<br>3.节点B和节点c将从节点A复制数据，但是A的数据是空的，于是就把自身保存的数据副本删除。<br></code></pre></td></tr></table></figure>

<p>在关闭主服务器上的持久化，并同时开启自动拉起进程的情况下，即便使用Sentinel来实现Redis的高可用性，也是非常危险的。因为主服务器可能拉起得非常快，以至于Sentinel在配置的心跳时间间隔内没有检测到主服务器已被重启，然后还是会执行上面的数据丢失的流程。无论何时，数据安全都是极其重要的，<strong>所以应该禁止主服务器关闭持久化的同时自动启动</strong>。</p>
<p>默认redis状态为master，需要转换为slave角色并指向master服务器的IP+PORT+Password<br><code>REPLICAOF MASTER_IP PORT</code> 指令可以启用主从同步复制功能，早期版本使用 <code>SLAVEOF</code> 指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; REPLICAOF MASTER_IP PORT<br>127.0.0.1:6379&gt; CONFIG SET masterauth &lt;masterpass&gt;<br></code></pre></td></tr></table></figure>

<p><strong>关于SLAVEOF</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis105.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-1-2-1-环境规划"><a href="#3-1-2-1-环境规划" class="headerlink" title="3.1.2.1 环境规划"></a>3.1.2.1 环境规划</h4><table>
<thead>
<tr>
<th>服务器地址</th>
<th>hostname</th>
<th>角色</th>
<th>redis版本</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.7</td>
<td>redis-master</td>
<td>master</td>
<td>redis 5.0.9</td>
</tr>
<tr>
<td>10.0.0.17</td>
<td>redis-slave1</td>
<td>slave</td>
<td>redis 5.0.9</td>
</tr>
<tr>
<td>10.0.0.27</td>
<td>redis-slave2</td>
<td>slave</td>
<td>redis 5.0.9</td>
</tr>
</tbody></table>
<h4 id="3-1-2-2-修改hostname"><a href="#3-1-2-2-修改hostname" class="headerlink" title="3.1.2.2 修改hostname"></a>3.1.2.2 修改hostname</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#10.0.0.7</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-master</span><br><br><span class="hljs-comment">#10.0.0.17</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-slave1</span><br><br><span class="hljs-comment">#10.0.0.27</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-slave2</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-3-安装redis"><a href="#3-1-2-3-安装redis" class="headerlink" title="3.1.2.3 安装redis"></a>3.1.2.3 安装redis</h4><p>master和slave安装redis，过程略</p>
<h4 id="3-1-2-4-查看个节点当前状态"><a href="#3-1-2-4-查看个节点当前状态" class="headerlink" title="3.1.2.4 查看个节点当前状态"></a>3.1.2.4 查看个节点当前状态</h4><h5 id="3-1-2-4-1-master当前状态"><a href="#3-1-2-4-1-master当前状态" class="headerlink" title="3.1.2.4.1 master当前状态"></a>3.1.2.4.1 master当前状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; AUTH 123456<br>OK<br>127.0.0.1:6379&gt; INFO replication<br><span class="hljs-comment"># Replication</span><br>role:master <span class="hljs-comment">#查看当前角色默认为master</span><br>connected_slaves:0<br>master_replid:a3504cab4d33e9723a7bc988ff8e022f6d9325bf<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br><br><span class="hljs-comment">#添加数据</span><br>127.0.0.1:6379&gt; SET key1 v1-master<br>OK<br>127.0.0.1:6379&gt; KEYS *<br>1) <span class="hljs-string">&quot;key1&quot;</span><br>127.0.0.1:6379&gt; GET key1<br><span class="hljs-string">&quot;v1-master&quot;</span><br>127.0.0.1:6379&gt;<br></code></pre></td></tr></table></figure>

<h5 id="3-1-2-4-2-slave1当前节点状态"><a href="#3-1-2-4-2-slave1当前节点状态" class="headerlink" title="3.1.2.4.2 slave1当前节点状态"></a>3.1.2.4.2 slave1当前节点状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; info<br>NOAUTH Authentication required.<br>127.0.0.1:6379&gt; AUTH 123456<br>OK<br>127.0.0.1:6379&gt; INFO replication  <br><span class="hljs-comment"># Replication</span><br>role:master <span class="hljs-comment">#查看当前角色默认为master</span><br>connected_slaves:0<br>master_replid:a3504cab4d33e9723a7bc988ff8e022f6d9325bf<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br><br>127.0.0.1:6379&gt; SET key1 v1-slave1<br>OK<br>127.0.0.1:6379&gt; KEYS *<br>1) <span class="hljs-string">&quot;key1&quot;</span><br>127.0.0.1:6379&gt; GET key1<br><span class="hljs-string">&quot;v1-slave1&quot;</span><br>127.0.0.1:6379&gt;<br></code></pre></td></tr></table></figure>

<h5 id="3-1-2-4-3-slave2当亲节点状态"><a href="#3-1-2-4-3-slave2当亲节点状态" class="headerlink" title="3.1.2.4.3 slave2当亲节点状态"></a>3.1.2.4.3 slave2当亲节点状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@redis-slave2 redis-5.0.9]<span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; AUTH 123456<br>OK<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:master <span class="hljs-comment">#查看当前角色默认为master</span><br>connected_slaves:0<br>master_replid:a3986a83369872065854c5c98c1c7ce973848f9c<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br><br>127.0.0.1:6379&gt; SET key1 v1-slave2<br>OK<br>127.0.0.1:6379&gt; keys *<br>1) <span class="hljs-string">&quot;key1&quot;</span><br>127.0.0.1:6379&gt; GET key1<br><span class="hljs-string">&quot;v1-slave2&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-5-slave节点设置master的IP和端口"><a href="#3-1-2-5-slave节点设置master的IP和端口" class="headerlink" title="3.1.2.5 slave节点设置master的IP和端口"></a>3.1.2.5 slave节点设置master的IP和端口</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#在slave上设置master的IP和端口，4.0版之前的指令为slaveof</span><br><span class="hljs-comment">#在5.0版本仍可使用SLAVEOF MasterIP Port</span><br>127.0.0.1:6379&gt; REPLICAOF 10.0.0.7 6379<br>OK<br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-6-slave节点设置master密码"><a href="#3-1-2-6-slave节点设置master密码" class="headerlink" title="3.1.2.6 slave节点设置master密码"></a>3.1.2.6 slave节点设置master密码</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#在slave上设置master的密码，才可以同步</span><br>127.0.0.1:6379&gt; CONFIG SET masterauth 123456<br>OK<br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-7-slave节点查看当前replication信息"><a href="#3-1-2-7-slave节点查看当前replication信息" class="headerlink" title="3.1.2.7 slave节点查看当前replication信息"></a>3.1.2.7 slave节点查看当前<code>replication</code>信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave <span class="hljs-comment">#角色变为slave</span><br>master_host:10.0.0.7 <span class="hljs-comment">#IP指向master</span><br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:7<br>master_sync_in_progress:0<br>slave_repl_offset:126<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:adffab2fc315d6980b694d33461e1fe89c3717ff<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:126<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:126<br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-8-查看同步的信息"><a href="#3-1-2-8-查看同步的信息" class="headerlink" title="3.1.2.8 查看同步的信息"></a>3.1.2.8 查看同步的信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; keys *<br>1) <span class="hljs-string">&quot;key1&quot;</span><br>127.0.0.1:6379&gt; get key1<br><span class="hljs-string">&quot;v1-master&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-9-查看master的replication信息"><a href="#3-1-2-9-查看master的replication信息" class="headerlink" title="3.1.2.9 查看master的replication信息"></a>3.1.2.9 查看master的<code>replication</code>信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在master上可以看到所有slave信息</span><br>127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:2<br>slave0:ip=10.0.0.17,port=6379,state=online,offset=308,lag=1<br>slave1:ip=10.0.0.27,port=6379,state=online,offset=308,lag=1<br>master_replid:adffab2fc315d6980b694d33461e1fe89c3717ff<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:308<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:308<br></code></pre></td></tr></table></figure>

<h3 id="3-1-3-删除主从同步"><a href="#3-1-3-删除主从同步" class="headerlink" title="3.1.3 删除主从同步"></a>3.1.3 删除主从同步</h3><p>REPLIATOF NO ONE 指令可以取消主从复制, 但不会清除slave上已有的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#取消复制,在slave上执行REPLIATOF NO ONE,会断开和master的连接不再主从复制</span><br>127.0.0.1:6379&gt; REPLICAOF no one<br></code></pre></td></tr></table></figure>

<h3 id="3-1-4-同步日志"><a href="#3-1-4-同步日志" class="headerlink" title="3.1.4 同步日志"></a>3.1.4 同步日志</h3><h4 id="3-1-4-1-在-master-上观察日志"><a href="#3-1-4-1-在-master-上观察日志" class="headerlink" title="3.1.4.1 在 master 上观察日志"></a>3.1.4.1 在 master 上观察日志</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#  tail -f /apps/redis/log/redis.log</span><br>5648:M 20 Nov 2022 15:46:46.291 * Replica 10.0.0.17:6379 asks <span class="hljs-keyword">for</span> synchronization<br>5648:M 20 Nov 2022 15:46:46.291 * Full resync requested by replica 10.0.0.17:6379<br>5648:M 20 Nov 2022 15:46:46.291 * Starting BGSAVE <span class="hljs-keyword">for</span> SYNC with target: disk<br>5648:M 20 Nov 2022 15:46:46.292 * Background saving started by pid 5682<br>5682:C 20 Nov 2022 15:46:46.292 * DB saved on disk<br>5682:C 20 Nov 2022 15:46:46.293 * RDB: 0 MB of memory used by copy-on-write<br>5648:M 20 Nov 2022 15:46:46.370 * Background saving terminated with success<br>5648:M 20 Nov 2022 15:46:46.370 * Synchronization with replica 10.0.0.17:6379 succeeded<br>5648:M 20 Nov 2022 15:47:06.533 * Replica 10.0.0.27:6379 asks <span class="hljs-keyword">for</span> synchronization<br>5648:M 20 Nov 2022 15:47:06.533 * Full resync requested by replica 10.0.0.27:6379<br>5648:M 20 Nov 2022 15:47:06.533 * Starting BGSAVE <span class="hljs-keyword">for</span> SYNC with target: disk<br>5648:M 20 Nov 2022 15:47:06.533 * Background saving started by pid 5683<br>5683:C 20 Nov 2022 15:47:06.550 * DB saved on disk<br>5683:C 20 Nov 2022 15:47:06.550 * RDB: 0 MB of memory used by copy-on-write<br>5648:M 20 Nov 2022 15:47:06.582 * Background saving terminated with success<br>5648:M 20 Nov 2022 15:47:06.582 * Synchronization with replica 10.0.0.27:6379 succeeded<br></code></pre></td></tr></table></figure>

<h5 id="3-1-2-2-2-在-slave-节点观察日志"><a href="#3-1-2-2-2-在-slave-节点观察日志" class="headerlink" title="3.1.2.2.2 在 slave 节点观察日志"></a>3.1.2.2.2 在 slave 节点观察日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># tail -f /var/log/redis/redis.log</span><br>766:S 20 Nov 2022 15:46:44.955 * Partial resynchronization not possible (no cached master)<br>766:S 20 Nov 2022 15:46:44.955 <span class="hljs-comment"># Unexpected reply to PSYNC from master: -NOAUTH Authentication required.</span><br>766:S 20 Nov 2022 15:46:44.955 * Retrying with SYNC...<br>766:S 20 Nov 2022 15:46:44.955 <span class="hljs-comment"># MASTER aborted replication with an error: NOAUTH Authentication required.</span><br>766:S 20 Nov 2022 15:46:45.961 * Connecting to MASTER 10.0.0.7:6379<br>766:S 20 Nov 2022 15:46:45.961 * MASTER &lt;-&gt; REPLICA sync started<br>766:S 20 Nov 2022 15:46:45.961 * Non blocking connect <span class="hljs-keyword">for</span> SYNC fired the event.<br>766:S 20 Nov 2022 15:46:45.961 * Master replied to PING, replication can <span class="hljs-built_in">continue</span>...<br>766:S 20 Nov 2022 15:46:45.962 * Partial resynchronization not possible (no cached master)<br>766:S 20 Nov 2022 15:46:45.962 * Full resync from master: adffab2fc315d6980b694d33461e1fe89c3717ff:0<br>766:S 20 Nov 2022 15:46:46.041 * MASTER &lt;-&gt; REPLICA sync: receiving 196 bytes from master<br>766:S 20 Nov 2022 15:46:46.041 * MASTER &lt;-&gt; REPLICA sync: Flushing old data<br>766:S 20 Nov 2022 15:46:46.041 * MASTER &lt;-&gt; REPLICA sync: Loading DB <span class="hljs-keyword">in</span> memory<br>766:S 20 Nov 2022 15:46:46.041 * MASTER &lt;-&gt; REPLICA sync: Finished with success<br></code></pre></td></tr></table></figure>

<h3 id="3-1-5-使用配置文件方式实现主从复制"><a href="#3-1-5-使用配置文件方式实现主从复制" class="headerlink" title="3.1.5 使用配置文件方式实现主从复制"></a>3.1.5 使用配置文件方式实现主从复制</h3><h4 id="3-1-5-1-环境规划"><a href="#3-1-5-1-环境规划" class="headerlink" title="3.1.5.1 环境规划"></a>3.1.5.1 环境规划</h4><table>
<thead>
<tr>
<th>服务器地址</th>
<th>hostname</th>
<th>角色</th>
<th>redis版本</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.7</td>
<td>redis-master</td>
<td>master</td>
<td>redis 5.0.9</td>
</tr>
<tr>
<td>10.0.0.17</td>
<td>redis-slave1</td>
<td>slave</td>
<td>redis 5.0.9</td>
</tr>
<tr>
<td>10.0.0.27</td>
<td>redis-slave2</td>
<td>slave</td>
<td>redis 5.0.9</td>
</tr>
</tbody></table>
<h4 id="3-1-5-2-设置hostname"><a href="#3-1-5-2-设置hostname" class="headerlink" title="3.1.5.2 设置hostname"></a>3.1.5.2 设置hostname</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#10.0.0.7</span><br>hostnamectl set-hostname redis-master<br><br><span class="hljs-comment">#10.0.0.17</span><br>hostnameclt set-hostname redis-slave1<br><br><span class="hljs-comment">#10.0.0.27</span><br>hostnameclt set-hostname redis-slave2<br></code></pre></td></tr></table></figure>

<h4 id="3-1-5-3-安装redis"><a href="#3-1-5-3-安装redis" class="headerlink" title="3.1.5.3 安装redis"></a>3.1.5.3 安装redis</h4><p>所有节点安装redis，过程略</p>
<h4 id="3-1-5-4-修改slave节点配置文件"><a href="#3-1-5-4-修改slave节点配置文件" class="headerlink" title="3.1.5.4 修改slave节点配置文件"></a>3.1.5.4 修改slave节点配置文件</h4><p><strong>所有从节点都要修改</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /apps/redis/etc/redis.conf</span><br>.......<br><span class="hljs-comment"># replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br>replicaof 10.0.0.7 6379 <span class="hljs-comment">#指定master的IP和端口号</span><br><br><span class="hljs-comment"># If the master is password protected (using the &quot;requirepass&quot; configuration</span><br><span class="hljs-comment"># directive below) it is possible to tell the replica to authenticate before</span><br><span class="hljs-comment"># starting the replication synchronization process, otherwise the master will</span><br><span class="hljs-comment"># refuse the replica request.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># masterauth &lt;master-password&gt;</span><br>masterauth 123456 <span class="hljs-comment">#如果密码需要设置</span><br><br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart redis</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-4-master查看状态"><a href="#3-1-2-4-master查看状态" class="headerlink" title="3.1.2.4 master查看状态"></a>3.1.2.4 master查看状态</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#在master上查看状态</span><br>127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:2<br>slave0:ip=10.0.0.27,port=6379,state=online,offset=882,lag=1<br>slave1:ip=10.0.0.17,port=6379,state=online,offset=882,lag=1<br>master_replid:adffab2fc315d6980b694d33461e1fe89c3717ff<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:882<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:882<br></code></pre></td></tr></table></figure>

<h4 id="3-1-6-5-slave查看状态"><a href="#3-1-6-5-slave查看状态" class="headerlink" title="3.1.6.5 slave查看状态"></a>3.1.6.5 slave查看状态</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.7<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:9<br>master_sync_in_progress:0<br>slave_repl_offset:406<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:adffab2fc315d6980b694d33461e1fe89c3717ff<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:406<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:393<br>repl_backlog_histlen:14<br>127.0.0.1:6379&gt; get key1   <span class="hljs-comment">#同步成功后,slave上的key信息丢失,从master复制过来新的值</span><br><span class="hljs-string">&quot;v1-master&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-6-6-停止master的redis服务并查看slave的状态"><a href="#3-1-6-6-停止master的redis服务并查看slave的状态" class="headerlink" title="3.1.6.6 停止master的redis服务并查看slave的状态"></a>3.1.6.6 停止master的redis服务并查看slave的状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.7<br>master_port:6379<br>master_link_status:down <span class="hljs-comment">#显示down，表示无法连接master</span><br>master_last_io_seconds_ago:-1<br>master_sync_in_progress:0<br>slave_repl_offset:1148<br>master_link_down_since_seconds:3<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:adffab2fc315d6980b694d33461e1fe89c3717ff<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1148<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:393<br>repl_backlog_histlen:756<br></code></pre></td></tr></table></figure>

<h4 id="3-1-6-7-slave-观察日志"><a href="#3-1-6-7-slave-观察日志" class="headerlink" title="3.1.6.7 slave 观察日志"></a>3.1.6.7 slave 观察日志</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># tail -f /apps/redislog/redis.log</span><br>24592:S 20 Feb 2020 12:03:58.792 * Connecting to MASTER 10.0.0.8:6379<br>24592:S 20 Feb 2020 12:03:58.792 * MASTER &lt;-&gt; REPLICA sync started<br>24592:S 20 Feb 2020 12:03:58.797 * Non blocking connect <span class="hljs-keyword">for</span> SYNC fired the event.<br>24592:S 20 Feb 2020 12:03:58.797 * Master replied to PING, replication can <span class="hljs-built_in">continue</span>...<br>24592:S 20 Feb 2020 12:03:58.798 * Partial resynchronization not possible (no cached master)<br>24592:S 20 Feb 2020 12:03:58.801 * Full resync from master: b69908f23236fb20b810d198f7f4539f795e0ee5:2440<br>24592:S 20 Feb 2020 12:03:58.863 * MASTER &lt;-&gt; REPLICA sync: receiving 213 bytes from master<br>24592:S 20 Feb 2020 12:03:58.863 * MASTER &lt;-&gt; REPLICA sync: Flushing old data<br>24592:S 20 Feb 2020 12:03:58.863 * MASTER &lt;-&gt; REPLICA sync: Loading DB <span class="hljs-keyword">in</span> memory<br>24592:S 20 Feb 2020 12:03:58.863 * MASTER &lt;-&gt; REPLICA sync: Finished with success<br></code></pre></td></tr></table></figure>

<h4 id="3-1-6-6-Master日志"><a href="#3-1-6-6-Master日志" class="headerlink" title="3.1.6.6 Master日志"></a>3.1.6.6 Master日志</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># tail /apps/redislog/redis.log</span><br>11846:M 20 Feb 2020 12:11:35.171 * DB loaded from disk: 0.000 seconds<br>11846:M 20 Feb 2020 12:11:35.171 * Ready to accept connections<br>11846:M 20 Feb 2020 12:11:36.086 * Replica 10.0.0.17:6379 asks <span class="hljs-keyword">for</span> synchronization<br>11846:M 20 Feb 2020 12:11:36.086 * Partial resynchronization not accepted: Replication ID mismatch (Replica asked <span class="hljs-keyword">for</span><br><span class="hljs-string">&#x27;b69908f23236fb20b810d198f7f4539f795e0ee5&#x27;</span>, my replication IDs are <span class="hljs-string">&#x27;4bff970970c073c1f3d8e8ad20b1c1f126a5f31c&#x27;</span> and  <span class="hljs-string">&#x27;0000000000000000000000000000000000000000&#x27;</span>)<br>11846:M 20 Feb 2020 12:11:36.086 * Starting BGSAVE <span class="hljs-keyword">for</span> SYNC with target: disk<br>11846:M 20 Feb 2020 12:11:36.095 * Background saving started by pid 11850<br>11850:C 20 Feb 2020 12:11:36.121 * DB saved on disk<br>11850:C 20 Feb 2020 12:11:36.121 * RDB: 4 MB of memory used by copy-on-write<br>11846:M 20 Feb 2020 12:11:36.180 * Background saving terminated with success<br>11846:M 20 Feb 2020 12:11:36.180 * Synchronization with replica 10.0.0.17:6379 succeeded<br></code></pre></td></tr></table></figure>

<h3 id="3-1-7-slave-状态只读无法写入数据"><a href="#3-1-7-slave-状态只读无法写入数据" class="headerlink" title="3.1.7 slave 状态只读无法写入数据"></a>3.1.7 slave 状态只读无法写入数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> key1 v1-slave<br>(error) READONLY You can<span class="hljs-string">&#x27;t write against a read only replica.</span><br></code></pre></td></tr></table></figure>

<h3 id="3-1-8-主从复制故障恢复"><a href="#3-1-8-主从复制故障恢复" class="headerlink" title="3.1.8 主从复制故障恢复"></a>3.1.8 主从复制故障恢复</h3><h4 id="3-1-8-1-主从复制故障恢复过程介绍"><a href="#3-1-8-1-主从复制故障恢复过程介绍" class="headerlink" title="3.1.8.1 主从复制故障恢复过程介绍"></a>3.1.8.1 主从复制故障恢复过程介绍</h4><h5 id="3-1-8-1-1-slave-节点故障和恢复"><a href="#3-1-8-1-1-slave-节点故障和恢复" class="headerlink" title="3.1.8.1.1 slave 节点故障和恢复"></a>3.1.8.1.1 slave 节点故障和恢复</h5><p>Client指向另一个从节点即可,并及时修复故障从节点</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis106.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-1-8-1-2-master-节点故障和恢复"><a href="#3-1-8-1-2-master-节点故障和恢复" class="headerlink" title="3.1.8.1.2 master 节点故障和恢复"></a>3.1.8.1.2 master 节点故障和恢复</h5><p>需要提升slave为新的master</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis107.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis108.png" srcset="/blog/img/loading.gif"></p>
<p>master故障后，只能手动提升一个slave为新master，不支持自动切换。Master的切换会导致master_replid发生变化，slave之前的master_replid就和当前master不一致从而会引发所有slave的全量同步。</p>
<h4 id="3-1-8-2-手动实现主从复制故障恢复"><a href="#3-1-8-2-手动实现主从复制故障恢复" class="headerlink" title="3.1.8.2 手动实现主从复制故障恢复"></a>3.1.8.2 手动实现主从复制故障恢复</h4><p>假设当前主节点10.0.0.7故障,提升10.0.0.17为新的master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看当前10.0.0.17节点的状态为slave,master指向10.0.0.7</span><br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.7<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:4<br>master_sync_in_progress:0<br>slave_repl_offset:322<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:209cd6c0ef8d092fd0d5c8766890a16404da3039<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:322<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:322<br></code></pre></td></tr></table></figure>

<p>10.0.0.17停止slave同步并提升为新的master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#提升为master角色</span><br>127.0.0.1:6379&gt; REPLICAOF NO ONE <span class="hljs-comment">#旧版使用SLAVEOF no one</span><br>OK<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:0<br>master_replid:1e17676d9b82822b1efea8cdc80ea1656c518b36<br>master_replid2:209cd6c0ef8d092fd0d5c8766890a16404da3039<br>master_repl_offset:462<br>second_repl_offset:463<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:462<br></code></pre></td></tr></table></figure>

<p>测试能否写入数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> keytest1 vtest1<br>OK<br></code></pre></td></tr></table></figure>

<p>修改所有slave指向新的master节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#修改10.0.0.27节点指向新的master节点10.0.0.17</span><br>127.0.0.1:6379&gt; SLAVEOF 10.0.0.17 6379 <span class="hljs-comment">#或者修改配置文件使10.0.0.27指向10.0.0.17</span><br>OK<br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> key100 v100<br>(error) READONLY You can<span class="hljs-string">&#x27;t write against a read only replica.</span><br></code></pre></td></tr></table></figure>

<p>查看日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># tail -f /apps/redis/log/redis.log</span><br>1762:S 20 Feb 2020 13:28:21.943 <span class="hljs-comment"># Connection with master lost.</span><br>1762:S 20 Feb 2020 13:28:21.943 * Caching the disconnected master state.<br>1762:S 20 Feb 2020 13:28:21.943 * REPLICAOF 10.0.0.17:6379 enabled (user request from <span class="hljs-string">&#x27;id=5 addr=127.0.0.1:59668 fd=9 name= age=149 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=41 qbuf-free=32727 obl=0 oll=0 omem=0 events=r cmd=slaveof&#x27;</span>)<br>1762:S 20 Feb 2020 13:28:21.966 * Connecting to MASTER 10.0.0.17:6379<br>1762:S 20 Feb 2020 13:28:21.966 * MASTER &lt;-&gt; REPLICA sync started<br>1762:S 20 Feb 2020 13:28:21.967 * Non blocking connect <span class="hljs-keyword">for</span> SYNC fired the event.<br>1762:S 20 Feb 2020 13:28:21.968 * Master replied to PING, replication can <span class="hljs-built_in">continue</span>...<br>1762:S 20 Feb 2020 13:28:21.968 * Trying a partial resynchronization (request 8e8279e461fdf0f1a3464ef768675149ad4b54a3:3991).<br>1762:S 20 Feb 2020 13:28:21.969 * Successful partial resynchronization with master.<br>1762:S 20 Feb 2020 13:28:21.969 * MASTER &lt;-&gt; REPLICA sync: Master accepted a Partial Resynchronization.<br></code></pre></td></tr></table></figure>

<p>在新master可看到slave</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在新master节点10.0.0.17上查看状态</span><br>127.0.0.1:6379&gt; INFO replication<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.27,port=6379,state=online,offset=608,lag=1<br>master_replid:1e17676d9b82822b1efea8cdc80ea1656c518b36<br>master_replid2:209cd6c0ef8d092fd0d5c8766890a16404da3039<br>master_repl_offset:608<br>second_repl_offset:463<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:608<br></code></pre></td></tr></table></figure>

<h3 id="3-1-9-实现-redis-的级联复制"><a href="#3-1-9-实现-redis-的级联复制" class="headerlink" title="3.1.9 实现 redis 的级联复制"></a>3.1.9 实现 redis 的级联复制</h3><p>即实现基于Slave节点的Slave</p>
<p><strong>使用命令的方式实现级联复制，使用配置文件的方式同样也可以实现</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis109.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-1-9-1-环境规划"><a href="#3-1-9-1-环境规划" class="headerlink" title="3.1.9.1 环境规划"></a>3.1.9.1 环境规划</h4><table>
<thead>
<tr>
<th>服务器地址</th>
<th>hostname</th>
<th>角色</th>
<th>redis版本</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.7</td>
<td>redis-master</td>
<td>master</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.17</td>
<td>redis-slave1</td>
<td>slave</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.27</td>
<td>redis-slave2</td>
<td>slave</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.37</td>
<td>redis-slave3</td>
<td>slave</td>
<td>redis5.0.9</td>
</tr>
</tbody></table>
<h4 id="3-1-9-2-修改hostname"><a href="#3-1-9-2-修改hostname" class="headerlink" title="3.1.9.2 修改hostname"></a>3.1.9.2 修改hostname</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#10.0.0.7</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-master</span><br><br><span class="hljs-comment">#10.0.0.17</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-slave1</span><br><br><span class="hljs-comment">#10.0.0.27</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-slave2</span><br><br><span class="hljs-comment">#10.0.0.37</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-slave3</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-9-2-slave1指向master"><a href="#3-1-9-2-slave1指向master" class="headerlink" title="3.1.9.2 slave1指向master"></a>3.1.9.2 slave1指向master</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; REPLICAOF 10.0.0.7 6379<br>OK<br>127.0.0.1:6379&gt; CONFIG SET masterauth 123456<br>OK<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.7<br>master_port:6379<br>master_link_status:down<br>master_last_io_seconds_ago:-1<br>master_sync_in_progress:0<br>slave_repl_offset:1<br>master_link_down_since_seconds:1668942005<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:72599e3ef4b50a69c8b8cc02fb902c32a2993ead<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:210<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:210<br></code></pre></td></tr></table></figure>

<h4 id="3-1-9-2-查看master节点数据是否同步slave1"><a href="#3-1-9-2-查看master节点数据是否同步slave1" class="headerlink" title="3.1.9.2 查看master节点数据是否同步slave1"></a>3.1.9.2 查看master节点数据是否同步slave1</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#master节点</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> key2 v2<br>OK<br>127.0.0.1:6379&gt; keys *<br>1) <span class="hljs-string">&quot;key1&quot;</span><br>2) <span class="hljs-string">&quot;key2&quot;</span><br><br><span class="hljs-comment">#slave1节点</span><br>127.0.0.1:6379&gt; keys *<br>1) <span class="hljs-string">&quot;key1&quot;</span><br>2) <span class="hljs-string">&quot;key2&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-9-3-slave2指向salve1"><a href="#3-1-9-3-slave2指向salve1" class="headerlink" title="3.1.9.3 slave2指向salve1"></a>3.1.9.3 slave2指向salve1</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; REPLICAOF 10.0.0.17 6379 <br>OK<br>127.0.0.1:6379&gt; CONFIG SET masterauth 123456<br>OK<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.17<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:3<br>master_sync_in_progress:0<br>slave_repl_offset:320<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:05e78dd19ac923ddd3a03f63738f1b5b85f3eb00<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:320<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:320<br></code></pre></td></tr></table></figure>

<h4 id="3-1-9-4-slave2查看是否同步数据"><a href="#3-1-9-4-slave2查看是否同步数据" class="headerlink" title="3.1.9.4 slave2查看是否同步数据"></a>3.1.9.4 slave2查看是否同步数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; keys *<br>1) <span class="hljs-string">&quot;key2&quot;</span><br>2) <span class="hljs-string">&quot;key1&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-9-5-slave3指向slave2"><a href="#3-1-9-5-slave3指向slave2" class="headerlink" title="3.1.9.5 slave3指向slave2"></a>3.1.9.5 slave3指向slave2</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; REPLICAOF 10.0.0.17 6379<br>OK<br>127.0.0.1:6379&gt; CONFIG SET masterauth 123456<br>OK<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.17<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:3<br>master_sync_in_progress:0<br>slave_repl_offset:502<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:05e78dd19ac923ddd3a03f63738f1b5b85f3eb00<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:502<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:489<br>repl_backlog_histlen:14<br></code></pre></td></tr></table></figure>

<h4 id="3-1-9-6-slave3查看数据是否同步"><a href="#3-1-9-6-slave3查看数据是否同步" class="headerlink" title="3.1.9.6 slave3查看数据是否同步"></a>3.1.9.6 slave3查看数据是否同步</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; keys *<br>1) <span class="hljs-string">&quot;key1&quot;</span><br>2) <span class="hljs-string">&quot;key2&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-9-7-查看slave2主从状态"><a href="#3-1-9-7-查看slave2主从状态" class="headerlink" title="3.1.9.7 查看slave2主从状态"></a>3.1.9.7 查看slave2主从状态</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.7<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:9 <span class="hljs-comment">#最近一次与master通信已经过去多少秒</span><br>master_sync_in_progress:0 <span class="hljs-comment">#是否正在与master通信。</span><br>slave_repl_offset:600 <span class="hljs-comment">#当前同步的偏移量</span><br>slave_priority:100 <span class="hljs-comment">#slave优先级，master故障后值越小越优先同步。</span><br>slave_read_only:1<br>connected_slaves:2<br>slave0:ip=10.0.0.27,port=6379,state=online,offset=600,lag=0 <span class="hljs-comment">#slave1的从节点slave2</span><br>slave1:ip=10.0.0.37,port=6379,state=online,offset=600,lag=0 <span class="hljs-comment">#slave1的从节点slave3</span><br>master_replid:05e78dd19ac923ddd3a03f63738f1b5b85f3eb00<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:600<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:29<br>repl_backlog_histlen:57<br></code></pre></td></tr></table></figure>

<h3 id="3-1-10-主从复制优化"><a href="#3-1-10-主从复制优化" class="headerlink" title="3.1.10 主从复制优化"></a>3.1.10 主从复制优化</h3><h4 id="3-1-10-1-主从复制过程"><a href="#3-1-10-1-主从复制过程" class="headerlink" title="3.1.10.1 主从复制过程"></a>3.1.10.1 主从复制过程</h4><p>Redis主从复制分为全量同步和增量同步</p>
<h5 id="3-1-10-1-1-全量复制过程"><a href="#3-1-10-1-1-全量复制过程" class="headerlink" title="3.1.10.1.1 全量复制过程"></a>3.1.10.1.1 全量复制过程</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis110.png" srcset="/blog/img/loading.gif"></p>
<p>首次同步是全量同步，主从同步可以让从服务器从主服务器同步数据，而且从服务器还可再有其它的从服务器，即另外一台redis服务器可以从一台从服务器进行数据同步，redis 的主从同步是非阻塞的，master收到从服务器的psync(2.8版本之前是SYNC)命令,会fork一个子进程在后台执行bgsave命令，并将新写入的数据写入到一个缓冲区中，bgsave执行完成之后,将生成的RDB文件发送给slave，然后master再将缓冲区的内容以redis协议格式再全部发送给slave，slave 先删除旧数据,slave将收到后的RDB文件载入自己的内存，再加载所有收到缓冲区的内容 从而这样一次完整的数据同步</p>
<p>Redis全量复制一般发生在Slave首次初始化阶段，这时Slave需要将Master上的所有数据都复制一份。</p>
<h5 id="3-1-10-1-2-增量复制过程"><a href="#3-1-10-1-2-增量复制过程" class="headerlink" title="3.1.10.1.2 增量复制过程"></a>3.1.10.1.2 增量复制过程</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis111.png" srcset="/blog/img/loading.gif"></p>
<p>全量同步之后再次需要同步时,从服务器只要发送当前的offset位置(等同于MySQL的binlog的位置)给主服务器，然后主服务器根据相应的位置将之后的数据(包括写在缓冲区的积压数据)发送给从服务器,再次其保存到其内存即可。</p>
<h5 id="3-1-10-1-3-主从同步完整过程"><a href="#3-1-10-1-3-主从同步完整过程" class="headerlink" title="3.1.10.1.3 主从同步完整过程"></a>3.1.10.1.3 主从同步完整过程</h5><p>具体主从同步过程如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-number">1</span>）从服务器连接主服务器，发送PSYNC命令<br><span class="hljs-number">2</span>）主服务器接收到PSYNC命令后，开始执行<span class="hljs-keyword">BGSAVE命令生成RDB快照文件并使用缓冲区记录此后执行的所有写命令</span><br><span class="hljs-keyword"></span><span class="hljs-number">3</span>）主服务器<span class="hljs-keyword">BGSAVE执行完后，向所有从服务器发送RDB快照文件，并在发送期间继续记录被执行的写命令</span><br><span class="hljs-keyword"></span><span class="hljs-number">4</span>）从服务器收到快照文件后丢弃所有旧数据，载入收到的快照至内存<br><span class="hljs-number">5</span>）主服务器快照发送完毕后，开始向从服务器发送缓冲区中的写命令<br><span class="hljs-number">6</span>）从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令<br><span class="hljs-number">7</span>）后期同步会先发送自己slave_repl_offset位置，只同步新增加的数据，不再全量同步<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis112.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis113.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis114.png" srcset="/blog/img/loading.gif"></p>
<p>复制缓冲区(环形队列)配置参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#复制缓冲区大小,建议要设置足够大</span><br>repl-backlog-size 1mb<br><br><span class="hljs-comment">#Redis同时也提供了当没有slave需要同步的时候，多久可以释放环形队列：</span><br>repl-backlog-ttl  3600<br></code></pre></td></tr></table></figure>

<h5 id="3-1-10-1-4-避免全量复制"><a href="#3-1-10-1-4-避免全量复制" class="headerlink" title="3.1.10.1.4 避免全量复制"></a>3.1.10.1.4 避免全量复制</h5><ul>
<li><p>第一次全量复制不可避免，后续的全量复制可以利用小主节点(内存小)，业务低峰时进行全量</p>
</li>
<li><p>节点运行ID不匹配：主节点重启会导致RUNID变化，可能会触发全量复制，可以利用故障转移，例如哨兵或集群，而从节点重启动，不会导致全量复制</p>
</li>
<li><p>复制积压缓冲区不足：当主节点生成的新数据大于缓冲区大小，从节点恢复和主节点连接后，会导致全量复制.解决方法将<code>repl-backlog-size</code>调大</p>
</li>
</ul>
<h5 id="3-1-10-1-5-避免复制风暴"><a href="#3-1-10-1-5-避免复制风暴" class="headerlink" title="3.1.10.1.5 避免复制风暴"></a>3.1.10.1.5 避免复制风暴</h5><ul>
<li>单主节点复制风暴当主节点重启，多从节点复制解决方法:更换复制拓扑</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis115.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li>单机器复制风暴机器宕机后，大量全量复制解决方法:主节点分散多机器</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis116.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-1-10-2-主从同步优化配置"><a href="#3-1-10-2-主从同步优化配置" class="headerlink" title="3.1.10.2 主从同步优化配置"></a>3.1.10.2 主从同步优化配置</h4><p>Redis在2.8版本之前没有提供增量部分复制的功能，当网络闪断或者slave Redis重启之后会导致主从之间的全量同步，即从2.8版本开始增加了部分复制的功能。</p>
<p><strong>性能相关配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">repl-diskless-sync no <span class="hljs-comment"># 是否使用无盘同步RDB文件，默认为no，no为不使用无盘，需要将RDB文件保存到磁盘后再发送给slave，yes为支持无盘，支持无盘就是RDB文件不需要保存至本地磁盘，而且直接通过socket文件发送给slave</span><br><br>repl-diskless-sync-delay 5 <span class="hljs-comment">#diskless时复制的服务器等待的延迟时间</span><br><br>repl-ping-slave-period 10 <span class="hljs-comment">#slave端向server端发送ping的时间间隔，默认为10秒</span><br><br>repl-timeout 60 <span class="hljs-comment">#设置主从ping连接超时时间,超过此值无法连接,master_link_status显示为down,并记录错误日志</span><br><br>repl-disable-tcp-nodelay no <span class="hljs-comment">#是否启用TCP_NODELAY，如设置成yes，则redis会合并小的TCP包从而节省带宽， 但会增加同步延迟（40ms），造成master与slave数据不一致，假如设置成no，则redismaster会立即发送同步数据，没有延迟，yes关注性能，no关注redis服务中的数据一致性</span><br><br>repl-backlog-size 1mb <span class="hljs-comment">#master的写入数据缓冲区，用于记录自上一次同步后到下一次同步过程中间的写入命令，计算公式：repl-backlog-size = 允许从节点最大中断时长 * 主实例offset每秒写入量，比如master每秒最大写入64mb，最大允许60秒，那么就要设置为64mb*60秒=3840MB(3.8G),建议此值是设置的足够大</span><br><br>repl-backlog-ttl 3600 <span class="hljs-comment">#如果一段时间后没有slave连接到master，则backlog size的内存将会被释放。如果值为0则 表示永远不释放这部份内存。</span><br><br>slave-priority 100 <span class="hljs-comment">#slave端的优先级设置，值是一个整数，数字越小表示优先级越高。当master故障时将会按照优先级来选择slave端进行恢复，如果值设置为0，则表示该slave永远不会被选择。</span><br><br>min-replicas-to-write 1 <span class="hljs-comment">#设置一个master的可用slave不能少于多少个，否则master无法执行写</span><br><br>min-slaves-max-lag 20 <span class="hljs-comment">#设置至少有上面数量的slave延迟时间都大于多少秒时，master不接收写操作(拒绝写入)</span><br></code></pre></td></tr></table></figure>

<h3 id="3-1-11-常见主从复制故障汇总"><a href="#3-1-11-常见主从复制故障汇总" class="headerlink" title="3.1.11 常见主从复制故障汇总"></a>3.1.11 常见主从复制故障汇总</h3><h4 id="3-1-11-1-master密码不对"><a href="#3-1-11-1-master密码不对" class="headerlink" title="3.1.11.1 master密码不对"></a>3.1.11.1 master密码不对</h4><p>即配置的master密码不对，导致验证不通过而无法建立主从同步关系。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># tail -f /var/log/redis/redis.log</span><br>24930:S 20 Feb 2020 13:53:57.029 * Connecting to MASTER 10.0.0.8:6379<br>24930:S 20 Feb 2020 13:53:57.030 * MASTER &lt;-&gt; REPLICA sync started<br>24930:S 20 Feb 2020 13:53:57.030 * Non blocking connect <span class="hljs-keyword">for</span> SYNC fired the event.<br>24930:S 20 Feb 2020 13:53:57.030 * Master replied to PING, replication can <span class="hljs-built_in">continue</span>...<br>24930:S 20 Feb 2020 13:53:57.031 <span class="hljs-comment"># Unable to AUTH to MASTER: -ERR invalid password</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-11-2-Redis版本不一致"><a href="#3-1-11-2-Redis版本不一致" class="headerlink" title="3.1.11.2 Redis版本不一致"></a>3.1.11.2 Redis版本不一致</h4><p>不同的redis 大版本之间存在兼容性问题，比如：3和4，4和5之间，因此各master和slave之间必须保持版本一致</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis117.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-1-11-3-无法远程连接"><a href="#3-1-11-3-无法远程连接" class="headerlink" title="3.1.11.3 无法远程连接"></a>3.1.11.3 无法远程连接</h4><p>在开启了安全模式情况下，没有设置bind地址或者密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /etc/redis.conf</span><br><span class="hljs-comment">#bind 127.0.0.1  #将此行注释</span><br><span class="hljs-comment"># systemctl restart redis</span><br><br><span class="hljs-comment"># ss -ntl</span><br>State    Recv-Q    Send-Q    Local Address:Port     Peer Address:Port  <br>LISTEN    0        128              0.0.0.0:22           0.0.0.0:*   <br>LISTEN    0        100            127.0.0.1:25           0.0.0.0:*   <br>LISTEN    0        128              0.0.0.0:6379         0.0.0.0:*   <br>LISTEN    0        128                 [::]:22              [::]:*   <br>LISTEN    0        100                [::1]:25              [::]:*   <br>LISTEN    0        128                 [::]:6379            [::]:*  <br><br><span class="hljs-comment"># redis-cli -h 10.0.0.7</span><br>10.0.0.7:6379&gt; KEYS *<br>(error) DENIED Redis is running <span class="hljs-keyword">in</span> protected mode because protected mode is enabled, no <span class="hljs-built_in">bind</span> address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions: 1) Just <span class="hljs-built_in">disable</span> protected mode sending the <span class="hljs-built_in">command</span> <span class="hljs-string">&#x27;CONFIG SET protected-mode no&#x27;</span> from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet <span class="hljs-keyword">if</span> you <span class="hljs-keyword">do</span> so. Use CONFIG REWRITE to make<br>this change permanent. 2) Alternatively you can just <span class="hljs-built_in">disable</span> the protected mode by editing the Redis configuration file, and setting the protected mode option to <span class="hljs-string">&#x27;no&#x27;</span>, and <span class="hljs-keyword">then</span> restarting the server. 3) If you started the server manually just <span class="hljs-keyword">for</span> testing, restart it with the <span class="hljs-string">&#x27;--protected-mode no&#x27;</span> option. 4) Setup a <span class="hljs-built_in">bind</span> address or an authentication password. NOTE: You only need to <span class="hljs-keyword">do</span> one of theabove things <span class="hljs-keyword">in</span> order <span class="hljs-keyword">for</span> the server to start accepting connections from the outside.<br>10.0.0.37:6379&gt; <span class="hljs-built_in">exit</span><br><br><span class="hljs-comment">#可以本机登录</span><br><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; KEYS *<br>(empty list or <span class="hljs-built_in">set</span>)<br></code></pre></td></tr></table></figure>

<h4 id="3-1-11-4-配置不一致"><a href="#3-1-11-4-配置不一致" class="headerlink" title="3.1.11.4 配置不一致"></a>3.1.11.4 配置不一致</h4><p>主从节点的maxmemory不一致，主节点内存大于从节点内存，主从复制可能丢失数据</p>
<p><code>rename-command</code> 命令不一致，如在主节点定义了lfushall，flushdb，从节点没定义,结果执行flushdb，不同步</p>
<p><strong>注意：主从配置文件一定要一致</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#master有一个rename-command flushdb &quot;rlin&quot;,而slave没有这个配置,则同步时从节点可以看到以下同步错误</span><br>3181:S 21 Oct 2020 17:34:50.581 <span class="hljs-comment"># == CRITICAL == This replica is sending an error to its master: &#x27;unknown command `rlin`, with args beginning with: &#x27;after processing the command &#x27;&lt;unknown&gt;&#x27;</span><br></code></pre></td></tr></table></figure>



<h2 id="3-2-redis-哨兵-Sentinel"><a href="#3-2-redis-哨兵-Sentinel" class="headerlink" title="3.2 redis 哨兵(Sentinel)"></a>3.2 redis 哨兵(Sentinel)</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis118.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-2-1-redis-集群介绍"><a href="#3-2-1-redis-集群介绍" class="headerlink" title="3.2.1 redis 集群介绍"></a>3.2.1 redis 集群介绍</h3><p>主从架构无法实现master和slave角色的自动切换，即当master出现redis服务异常、主机断电、磁盘损坏等问题导致master无法使用，而redis主从复制无法实现自动的故障转移(将slave自动提升为新master)，需要手动修改环境配置,才能切换到slave redis服务器，另外也无法横向扩展Redis服务的并行写入性能，当单台Redis服务器性能无法满足业务写入需求的时候,也需要解决以上的两个核心问题，即：</p>
<p>1.master和slave角色的无缝切换，让业务无感知从而不影响业务使用 </p>
<p>2.可横向动态扩展Redis服务器，从而实现多台服务器并行写入以实现更高并发的目的。</p>
<p>Redis 集群实现方式：</p>
<ul>
<li>客户端分片: 由应用决定将不同的KEY发送到不同的Redis服务器</li>
<li>代理分片: 由代理决定将不同的KEY发送到不同的Redis服务器,代理程序如:codis,twemproxy等</li>
<li>Redis Cluster</li>
</ul>
<h3 id="3-2-2-哨兵-Sentinel-工作原理"><a href="#3-2-2-哨兵-Sentinel-工作原理" class="headerlink" title="3.2.2 哨兵 (Sentinel) 工作原理"></a>3.2.2 哨兵 (Sentinel) 工作原理</h3><h4 id="3-2-2-1-sentinel-架构和故障转移"><a href="#3-2-2-1-sentinel-架构和故障转移" class="headerlink" title="3.2.2.1 sentinel 架构和故障转移"></a>3.2.2.1 sentinel 架构和故障转移</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis119.png" srcset="/blog/img/loading.gif"></p>
<hr>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis120.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis121.png" srcset="/blog/img/loading.gif"></p>
<p>Sentinel 进程是用于监控redis集群中Master主服务器工作的状态，在Master主服务器发生故障的时候，可以实现Master和Slave服务器的切换，保证系统的高可用，此功能在redis2.6+的版本已引用，Redis的哨兵模式到了2.8版本之后就稳定了下来。一般在生产环境也建议使用Redis的2.8版本的以后版本</p>
<p>哨兵(Sentinel) 是一个分布式系统，可以在一个架构中运行多个哨兵(sentinel) 进程，这些进程使用流言协议(gossip protocols)来接收关于Master主服务器是否下线的信息，并使用投票协议(AgreementProtocols)来决定是否执行自动故障迁移,以及选择哪个Slave作为新的Master</p>
<p>每个哨兵(Sentinel)进程会向其它哨兵(Sentinel)、Master、Slave定时发送消息，以确认对方是否”活”着，如果发现对方在指定配置时间(此项可配置)内未得到回应，则暂时认为对方已离线，也就是所谓的”主观认为宕机” (主观:是每个成员都具有的独自的而且可能相同也可能不同的意识)，英文名称：Subjective Down，简称SDOWN</p>
<p>有主观宕机，对应的有客观宕机。当“哨兵群”中的多数Sentinel进程在对Master主服务器做出SDOWN的判断，并且通过 SENTINEL is-master-down-by-addr 命令互相交流之后，得出的Master Server下线判断，这种方式就是“客观宕机”(客观:是不依赖于某种意识而已经实际存在的一切事物)，英文名称是：Objectively  Down， 简称 ODOWN</p>
<p>通过一定的vote算法，从剩下的slave从服务器节点中，选一台提升为Master服务器节点，然后自动修改相关配置，并开启故障转移（failover）</p>
<p>Sentinel 机制可以解决master和slave角色的自动切换问题，但单个 Master 的性能瓶颈问题无法解决,类似于MySQL中的MHA功能</p>
<p>Redis Sentinel中的Sentinel节点个数应该为大于等于3且最好为奇数</p>
<p>客户端初始化时连接的是Sentinel节点集合，不再是具体的Redis节点，但Sentinel只是配置中心不是代理。</p>
<p>Redis Sentinel 节点与普通redis 没有区别,要实现读写分离依赖于客户端程序</p>
<p>redis 3.0 之前版本中，生产环境一般使用哨兵模式，但3.0后推出redis cluster功能后，可以支持更大规模的生产环境</p>
<h4 id="3-2-2-2-sentinel中的三个定时任务"><a href="#3-2-2-2-sentinel中的三个定时任务" class="headerlink" title="3.2.2.2 sentinel中的三个定时任务"></a>3.2.2.2 sentinel中的三个定时任务</h4><ul>
<li><p>每10秒每个sentinel对master和slave执行info</p>
<p>发现slave节点</p>
<p>确认主从关系</p>
</li>
<li><p>每2秒每个sentinel通过master节点的channel交换信息(pub/sub)</p>
<p>通过sentinel__:hello频道交互</p>
<p>交互对节点的“看法”和自身信息</p>
</li>
<li><p>每1秒每个sentinel对其他sentinel和redis执行ping</p>
</li>
</ul>
<h3 id="3-2-3-实现哨兵的前提"><a href="#3-2-3-实现哨兵的前提" class="headerlink" title="3.2.3 实现哨兵的前提"></a>3.2.3 实现哨兵的前提</h3><p>哨兵的前提是已经实现了一个redis的主从复制的运行环境，从而实现一个一主两从基于哨兵的高可用redis架构</p>
<p>注意: master 的配置文件中masterauth和slave都必须相同</p>
<h3 id="3-2-4-实现哨兵"><a href="#3-2-4-实现哨兵" class="headerlink" title="3.2.4 实现哨兵"></a>3.2.4 实现哨兵</h3><h4 id="3-2-4-1-环境规划"><a href="#3-2-4-1-环境规划" class="headerlink" title="3.2.4.1 环境规划"></a>3.2.4.1 环境规划</h4><table>
<thead>
<tr>
<th>服务器IP地址</th>
<th>hostname</th>
<th>角色</th>
<th>安装软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.7</td>
<td>redis-master-sentinel1</td>
<td>master</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.17</td>
<td>redis-slave1-sentinel2</td>
<td>slave1</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.27</td>
<td>redis-slave2-sentinel3</td>
<td>slave2</td>
<td>redis5.0.9</td>
</tr>
</tbody></table>
<h4 id="3-2-4-2-修改hostname"><a href="#3-2-4-2-修改hostname" class="headerlink" title="3.2.4.2 修改hostname"></a>3.2.4.2 修改hostname</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#10.0.0.7</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-master-sentinel1</span><br><br><span class="hljs-comment">#10.0.0.17</span><br><span class="hljs-comment"># hostnameclt set-hostname redis-slave1-sentinel2</span><br><br><span class="hljs-comment">#10.0.0.27</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-slave2-sentinel3</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-4-3-安装部署redis"><a href="#3-2-4-3-安装部署redis" class="headerlink" title="3.2.4.3 安装部署redis"></a>3.2.4.3 安装部署redis</h4><p>过程略</p>
<h4 id="3-2-4-4-修改配置文件"><a href="#3-2-4-4-修改配置文件" class="headerlink" title="3.2.4.4 修改配置文件"></a>3.2.4.4 修改配置文件</h4><h5 id="3-2-4-4-1-master修改配置文件"><a href="#3-2-4-4-1-master修改配置文件" class="headerlink" title="3.2.4.4.1 master修改配置文件"></a>3.2.4.4.1 master修改配置文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#命令式修改</span><br><span class="hljs-comment">#sed -Ei.backup -e &#x27;s/^(bind ).*/\10.0.0.0/&#x27; -e &#x27;s/^# (masterauth ).*/\1123456/&#x27; -e &#x27;s/^# (requirepass ).*/\1123456/&#x27; -e &#x27;s/^(pidfile ).*(\/redis_6379.pid)$/\1\/apps\/redis\/run\2/&#x27; -e &#x27;s/^(logfile ).*/\1&quot;\/apps\/redis\/log\/redis-6379.log&quot;/&#x27; -e &#x27;s/^(dir ).*/\1\/apps\/redis\/data\//&#x27; /apps/redis/etc/redis.conf</span><br><br><span class="hljs-comment">#vim修改</span><br><span class="hljs-comment"># vim /apps/redis/etc/redis.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br>pidfile /apps/redis/run/redis_6379.conf<br>logfile /apps/redis/<span class="hljs-built_in">log</span>/redis-6379.log<br>dir /apps/redis/data/<br>requirepass 123456<br>masterauth 123456<br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-4-2-slave1修改配置文件"><a href="#3-2-4-4-2-slave1修改配置文件" class="headerlink" title="3.2.4.4.2 slave1修改配置文件"></a>3.2.4.4.2 slave1修改配置文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#命令式修改</span><br><span class="hljs-comment"># sed -Ei.backup -e &#x27;s/^(bind ).*/\10.0.0.0/&#x27; -e &#x27;s/^# (masterauth ).*/\1123456/&#x27; -e &#x27;s/^# (requirepass ).*/\1123456/&#x27; -e &#x27;s/^(pidfile ).*(\/redis_6379.pid)$/\1\/apps\/redis\/run\2/&#x27; -e &#x27;s/^(logfile ).*/\1&quot;\/apps\/redis\/log\/redis-6379.log&quot;/&#x27; -e &#x27;s/^(dir ).*/\1\/apps\/redis\/data\//&#x27; -e &#x27;s/^# (replicaof ).*/\110.0.0.7 6379/&#x27; /apps/redis/etc/redis.conf</span><br><br><span class="hljs-comment">#vim修改</span><br><span class="hljs-comment"># vim /apps/redis/etc/redis.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br>pidfile /apps/redis/run/redis_6379.conf<br>logfile /apps/redis/<span class="hljs-built_in">log</span>/redis-6379.log<br>dir /apps/redis/data/<br>replicaof 10.0.0.7 6379<br>masterauth 123456<br>requirepass 123456<br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-4-3-slave2修改配置文件"><a href="#3-2-4-4-3-slave2修改配置文件" class="headerlink" title="3.2.4.4.3 slave2修改配置文件"></a>3.2.4.4.3 slave2修改配置文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#命令式修改</span><br><span class="hljs-comment"># sed -Ei.backup -e &#x27;s/^(bind ).*/\10.0.0.0/&#x27; -e &#x27;s/^# (masterauth ).*/\1123456/&#x27; -e &#x27;s/^# (requirepass ).*/\1123456/&#x27; -e &#x27;s/^(pidfile ).*(\/redis_6379.pid)$/\1\/apps\/redis\/run\2/&#x27; -e &#x27;s/^(logfile ).*/\1&quot;\/apps\/redis\/log\/redis-6379.log&quot;/&#x27; -e &#x27;s/^(dir ).*/\1\/apps\/redis\/data\//&#x27; -e &#x27;s/^# (replicaof ).*/\110.0.0.7 6379/&#x27; /apps/redis/etc/redis.conf</span><br><br><span class="hljs-comment">#vim修改</span><br><span class="hljs-comment"># vim /apps/redis/etc/redis.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br>pidfile /apps/redis/run/redis_6379.conf<br>logfile /apps/redis/<span class="hljs-built_in">log</span>/redis-6379.log<br>dir /apps/redis/data/<br>replicaof 10.0.0.7 6379<br>masterauth 123456<br>requirepass 123456<br></code></pre></td></tr></table></figure>

<h4 id="3-2-4-5-启动redis"><a href="#3-2-4-5-启动redis" class="headerlink" title="3.2.4.5 启动redis"></a>3.2.4.5 启动redis</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl enable --now redis</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-4-6-查看redis主从状态"><a href="#3-2-4-6-查看redis主从状态" class="headerlink" title="3.2.4.6 查看redis主从状态"></a>3.2.4.6 查看redis主从状态</h4><h5 id="3-2-4-6-1-查看master节点主从状态"><a href="#3-2-4-6-1-查看master节点主从状态" class="headerlink" title="3.2.4.6.1 查看master节点主从状态"></a>3.2.4.6.1 查看master节点主从状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:2<br>slave0:ip=10.0.0.17,port=6379,state=online,offset=1092,lag=1<br>slave1:ip=10.0.0.27,port=6379,state=online,offset=1092,lag=1<br>master_replid:22ed6e622f7b837825cf8d81c0ca8d0783850cd9<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1092<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1092<br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-6-2-查看slave1主从状态"><a href="#3-2-4-6-2-查看slave1主从状态" class="headerlink" title="3.2.4.6.2 查看slave1主从状态"></a>3.2.4.6.2 查看slave1主从状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.7<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:8<br>master_sync_in_progress:0<br>slave_repl_offset:1106<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:22ed6e622f7b837825cf8d81c0ca8d0783850cd9<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1106<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:841<br>repl_backlog_histlen:266<br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-6-3-查看slave2主从状态"><a href="#3-2-4-6-3-查看slave2主从状态" class="headerlink" title="3.2.4.6.3 查看slave2主从状态"></a>3.2.4.6.3 查看slave2主从状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.7<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:0<br>master_sync_in_progress:0<br>slave_repl_offset:1148<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:22ed6e622f7b837825cf8d81c0ca8d0783850cd9<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1148<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1148<br></code></pre></td></tr></table></figure>

<h4 id="3-2-4-7-编辑哨兵的配置文件"><a href="#3-2-4-7-编辑哨兵的配置文件" class="headerlink" title="3.2.4.7 编辑哨兵的配置文件"></a>3.2.4.7 编辑哨兵的配置文件</h4><p>Sentinel实际上是一个特殊的redis服务器,有些redis指令支持,但很多指令并不支持.默认监听在26379/tcp端口.</p>
<p>哨兵可以不和Redis服务器部署在一起，但一般部署在一起，所有redis节点使用相同的以下示例的配置文件</p>
<p>如果是编译安装，在源码目录有sentinel.conf，复制到安装目录即可，如：/apps/redis/etc/sentinel.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp redis-5.0.9/sentinel.conf /apps/redis/etc/</span><br><span class="hljs-comment"># vim /apps/redis/etc/sentinel.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br>port 26379<br>daemonize yes<br>pidfile /apps/redis/run/redis-sentinel.pid<br>logfile <span class="hljs-string">&quot;/apps/redis/log/sentinel_26379.log&quot;</span><br>dir /apps/redis/data<br>sentinel monitor mymaster 10.0.0.7 6379 2<br>sentinel auth-pass mymaster 123456<br>sentinel down-after-milliseconds mymaster 3000<br>sentinel parallel-syncs mymaster 1<br>sentinel failover-timeout mymaster 180000<br>sentinel deny-scripts-reconfig yes<br></code></pre></td></tr></table></figure>

<h4 id="3-2-4-8-发送sentinel文件到slave节点"><a href="#3-2-4-8-发送sentinel文件到slave节点" class="headerlink" title="3.2.4.8 发送sentinel文件到slave节点"></a>3.2.4.8 发送sentinel文件到slave节点</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># scp /apps/redis/etc/sentinel.conf 10.0.0.17:/apps/redis/etc/</span><br><span class="hljs-comment"># scp /apps/redis/etc/sentinel.conf 10.0.0.27:/apps/redis/etc/</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-4-9-启动sentinel"><a href="#3-2-4-9-启动sentinel" class="headerlink" title="3.2.4.9 启动sentinel"></a>3.2.4.9 启动sentinel</h4><p><strong>所有节点都执行以下命令</strong></p>
<h5 id="3-2-4-9-1-yum安装启动"><a href="#3-2-4-9-1-yum安装启动" class="headerlink" title="3.2.4.9.1 yum安装启动"></a>3.2.4.9.1 yum安装启动</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl enable --now redis-sentinel.service</span><br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-9-2-编译安装启动"><a href="#3-2-4-9-2-编译安装启动" class="headerlink" title="3.2.4.9.2 编译安装启动"></a>3.2.4.9.2 编译安装启动</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#redis为编译安装时执行以下命令</span><br><span class="hljs-comment"># /apps/redis/bin/redis-sentinel /apps/redis/etc/sentinel.conf</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-4-10-验证哨兵端口"><a href="#3-2-4-10-验证哨兵端口" class="headerlink" title="3.2.4.10 验证哨兵端口"></a>3.2.4.10 验证哨兵端口</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ss -tnl</span><br>State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port              <br>LISTEN     0      511                             *:26379                                       *:*                  <br>LISTEN     0      511                             *:6379                                        *:*                  <br>LISTEN     0      128                             *:22                                          *:*                  <br>LISTEN     0      100                     127.0.0.1:25                                          *:*                  <br>LISTEN     0      128                          [::]:22                                       [::]:*                  <br>LISTEN     0      100                         [::1]:25                                       [::]:*<br></code></pre></td></tr></table></figure>

<h4 id="3-2-4-11-查看哨兵日志"><a href="#3-2-4-11-查看哨兵日志" class="headerlink" title="3.2.4.11 查看哨兵日志"></a>3.2.4.11 查看哨兵日志</h4><h5 id="3-2-4-11-1-查看master哨兵日志"><a href="#3-2-4-11-1-查看master哨兵日志" class="headerlink" title="3.2.4.11.1 查看master哨兵日志"></a>3.2.4.11.1 查看master哨兵日志</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tail -f /apps/redis/log/sentinel_26379.log</span><br>1561:X 21 Nov 2022 14:50:05.019 <span class="hljs-comment"># Redis version=5.0.9, bits=64, commit=00000000, modified=0, pid=1561, just started</span><br>1561:X 21 Nov 2022 14:50:05.019 <span class="hljs-comment"># Configuration loaded</span><br>1562:X 21 Nov 2022 14:50:05.020 * Increased maximum number of open files to 10032 (it was originally <span class="hljs-built_in">set</span> to 1024).<br>1562:X 21 Nov 2022 14:50:05.021 * Running mode=sentinel, port=26379.<br>1562:X 21 Nov 2022 14:50:05.143 <span class="hljs-comment"># Sentinel ID is e75d78c4d31e3ce36007f5d121353c23705d7ab3</span><br>1562:X 21 Nov 2022 14:50:05.143 <span class="hljs-comment"># +monitor master mymaster 10.0.0.7 6379 quorum 2</span><br>1562:X 21 Nov 2022 14:50:05.144 * +slave slave 10.0.0.17:6379 10.0.0.17 6379 @ mymaster 10.0.0.7 6379<br>1562:X 21 Nov 2022 14:50:05.145 * +slave slave 10.0.0.27:6379 10.0.0.27 6379 @ mymaster 10.0.0.7 6379<br>1562:X 21 Nov 2022 14:50:16.930 * +sentinel sentinel f79e97f9f290eddec7cc811aefe62f7b88c7e96c 10.0.0.17 26379 @ mymaster 10.0.0.7 6379<br>1562:X 21 Nov 2022 14:50:21.135 * +sentinel sentinel a4acbcafe8b95b75e0ad2ab5a5f74b7dfb491385 10.0.0.27 26379 @ mymaster 10.0.0.7 6379<br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-11-2-查看salve1哨兵日志"><a href="#3-2-4-11-2-查看salve1哨兵日志" class="headerlink" title="3.2.4.11.2 查看salve1哨兵日志"></a>3.2.4.11.2 查看salve1哨兵日志</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tail -f /apps/redis/log/sentinel_26379.log</span><br>1358:X 21 Nov 2022 14:50:15.182 <span class="hljs-comment"># Redis version=5.0.9, bits=64, commit=00000000, modified=0, pid=1358, just started</span><br>1358:X 21 Nov 2022 14:50:15.182 <span class="hljs-comment"># Configuration loaded</span><br>1359:X 21 Nov 2022 14:50:15.183 * Increased maximum number of open files to 10032 (it was originally <span class="hljs-built_in">set</span> to 1024).<br>1359:X 21 Nov 2022 14:50:15.183 * Running mode=sentinel, port=26379.<br>1359:X 21 Nov 2022 14:50:15.185 <span class="hljs-comment"># Sentinel ID is f79e97f9f290eddec7cc811aefe62f7b88c7e96c</span><br>1359:X 21 Nov 2022 14:50:15.185 <span class="hljs-comment"># +monitor master mymaster 10.0.0.7 6379 quorum 2</span><br>1359:X 21 Nov 2022 14:50:15.186 * +slave slave 10.0.0.17:6379 10.0.0.17 6379 @ mymaster 10.0.0.7 6379<br>1359:X 21 Nov 2022 14:50:15.186 * +slave slave 10.0.0.27:6379 10.0.0.27 6379 @ mymaster 10.0.0.7 6379<br>1359:X 21 Nov 2022 14:50:15.514 * +sentinel sentinel e75d78c4d31e3ce36007f5d121353c23705d7ab3 10.0.0.7 26379 @ mymaster 10.0.0.7 6379<br>1359:X 21 Nov 2022 14:50:21.403 * +sentinel sentinel a4acbcafe8b95b75e0ad2ab5a5f74b7dfb491385 10.0.0.27 26379 @ mymaster 10.0.0.7 6379<br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-11-3-查看slave2哨兵日志"><a href="#3-2-4-11-3-查看slave2哨兵日志" class="headerlink" title="3.2.4.11.3 查看slave2哨兵日志"></a>3.2.4.11.3 查看slave2哨兵日志</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tail -f /apps/redis/log/sentinel_26379.log </span><br>1284:X 21 Nov 2022 14:50:18.744 <span class="hljs-comment"># Redis version=5.0.9, bits=64, commit=00000000, modified=0, pid=1284, just started</span><br>1284:X 21 Nov 2022 14:50:18.744 <span class="hljs-comment"># Configuration loaded</span><br>1285:X 21 Nov 2022 14:50:18.756 * Increased maximum number of open files to 10032 (it was originally <span class="hljs-built_in">set</span> to 1024).<br>1285:X 21 Nov 2022 14:50:18.760 * Running mode=sentinel, port=26379.<br>1285:X 21 Nov 2022 14:50:18.761 <span class="hljs-comment"># Sentinel ID is a4acbcafe8b95b75e0ad2ab5a5f74b7dfb491385</span><br>1285:X 21 Nov 2022 14:50:18.761 <span class="hljs-comment"># +monitor master mymaster 10.0.0.7 6379 quorum 2</span><br>1285:X 21 Nov 2022 14:50:18.763 * +slave slave 10.0.0.17:6379 10.0.0.17 6379 @ mymaster 10.0.0.7 6379<br>1285:X 21 Nov 2022 14:50:18.763 * +slave slave 10.0.0.27:6379 10.0.0.27 6379 @ mymaster 10.0.0.7 6379<br>1285:X 21 Nov 2022 14:50:18.993 * +sentinel sentinel e75d78c4d31e3ce36007f5d121353c23705d7ab3 10.0.0.7 26379 @ mymaster 10.0.0.7 6379<br>1285:X 21 Nov 2022 14:50:20.708 * +sentinel sentinel f79e97f9f290eddec7cc811aefe62f7b88c7e96c 10.0.0.17 26379 @ mymaster 10.0.0.7 6379<br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-11-4-总结"><a href="#3-2-4-11-4-总结" class="headerlink" title="3.2.4.11.4 总结"></a>3.2.4.11.4 总结</h5><ul>
<li>每个sentinel的id是不同的</li>
<li>可以制动master和slave个是哪台服务器</li>
</ul>
<h4 id="3-2-4-12-当前sentinel状态"><a href="#3-2-4-12-当前sentinel状态" class="headerlink" title="3.2.4.12 当前sentinel状态"></a>3.2.4.12 当前sentinel状态</h4><p>在sentinel状态中尤其是最后一行，涉及到masterIP是多少，有几个slave，有几个sentinels，必须是符合全部服务器数量</p>
<p><strong>所有节点的sentinel信息都一样</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -p 26379</span><br>127.0.0.1:26379&gt; INFO sentinel<br><span class="hljs-comment"># Sentinel</span><br>sentinel_masters:1<br>sentinel_tilt:0<br>sentinel_running_scripts:0<br>sentinel_scripts_queue_length:0<br>sentinel_simulate_failure_flags:0<br>master0:name=mymaster,status=ok,address=10.0.0.7:6379,slaves=2,sentinels=3 <span class="hljs-comment">#两个slave,三个sentinel服务器,如果sentinels值不符合,检查myid可能冲突</span><br></code></pre></td></tr></table></figure>

<p><strong>到此redis sentinel已经部署完毕</strong></p>
<h3 id="3-2-5-redis-sentinel配置文件解释"><a href="#3-2-5-redis-sentinel配置文件解释" class="headerlink" title="3.2.5 redis sentinel配置文件解释"></a>3.2.5 redis sentinel配置文件解释</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">bind</span> 0.0.0.0<br>port 26379<br>daemonize yes<br>pidfile /apps/redis/run/redis-sentinel.pid <span class="hljs-comment">#pid文件</span><br>logfile <span class="hljs-string">&quot;/apps/redis/log/sentinel_26379.log&quot;</span> <span class="hljs-comment">#日志文件</span><br>dir /apps/redis/data  <span class="hljs-comment">#工作目录</span><br><br>sentinel monitor mymaster 10.0.0.7 6379 2 <span class="hljs-comment">#指定当前mymaster集群中master服务器的地址和端口</span><br><span class="hljs-comment">#2为法定人数限制(quorum)，即有几个sentinel认为master down了就进行故障转移，一般此值是所有sentinel节点(一般总数是&gt;=3的 奇数,如:3,5,7等)的一半以上的整数值，比如，哨兵总数是3，即3/2=1.5，取整为2,是master的ODOWN客观下线的依据</span><br><br>sentinel myid e75d78c4d31e3ce36007f5d121353c23705d7ab3 <span class="hljs-comment">#sentinel启动后会自动生成，且会注释“sentinel monitor mymaster”这一行</span><br><br>sentinel auth-pass mymaster 123456 <span class="hljs-comment">#mymaster集群中master的密码，注意此行要在上面行的下面</span><br><br>sentinel down-after-milliseconds mymaster 30000 <span class="hljs-comment">#(SDOWN)判断mymaster集群中所有节点的主观下线的时间，单位：毫秒，建议3000，根据业务调整</span><br><br>sentinel parallel-syncs mymaster 1 <span class="hljs-comment">#发生故障转移后，同时向新master同步数据的slave数量，数字越小总同步时间越长，但可以减轻新master的负载压力</span><br><br>sentinel failover-timeout mymaster 180000 <span class="hljs-comment">#所有slaves指向新的master所需的超时时间，单位：毫秒</span><br><br>sentinel deny-scripts-reconfig yes <span class="hljs-comment">#禁止修改脚本</span><br></code></pre></td></tr></table></figure>

<h3 id="3-2-6-测试测试故障转移"><a href="#3-2-6-测试测试故障转移" class="headerlink" title="3.2.6 测试测试故障转移"></a>3.2.6 测试测试故障转移</h3><h4 id="3-2-6-1-关闭master节点的redis同时查看日志"><a href="#3-2-6-1-关闭master节点的redis同时查看日志" class="headerlink" title="3.2.6.1 关闭master节点的redis同时查看日志"></a>3.2.6.1 关闭master节点的redis同时查看日志</h4><p>在关闭了主master节点之后，在master机器上查看sentinels日志，可以知道由哪个slave当上了主节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#关闭sentinel</span><br><span class="hljs-comment"># killall redis-server</span><br><span class="hljs-comment"># systemctl stop redis</span><br><span class="hljs-comment">#查看日志</span><br><span class="hljs-comment"># tail -f /apps/redis/logs/entinel_26379.log</span><br>1562:X 21 Nov 2022 15:03:36.460 <span class="hljs-comment"># +sdown master mymaster 10.0.0.7 6379</span><br>1562:X 21 Nov 2022 15:03:36.518 <span class="hljs-comment"># +new-epoch 1</span><br>1562:X 21 Nov 2022 15:03:36.518 <span class="hljs-comment"># +vote-for-leader f79e97f9f290eddec7cc811aefe62f7b88c7e96c 1</span><br>1562:X 21 Nov 2022 15:03:36.561 <span class="hljs-comment"># +odown master mymaster 10.0.0.7 6379 #quorum 3/2</span><br>1562:X 21 Nov 2022 15:03:36.561 <span class="hljs-comment"># Next failover delay: I will not start a failover before Mon Nov 21 15:09:36 2022</span><br>1562:X 21 Nov 2022 15:03:37.635 <span class="hljs-comment"># +config-update-from sentinel f79e97f9f290eddec7cc811aefe62f7b88c7e96c 10.0.0.17 26379 @ mymaster 10.0.0.7 6379</span><br>1562:X 21 Nov 2022 15:03:37.635 <span class="hljs-comment"># +switch-master mymaster 10.0.0.7 6379 10.0.0.17 6379</span><br>1562:X 21 Nov 2022 15:03:37.636 * +slave slave 10.0.0.27:6379 10.0.0.27 6379 @ mymaster 10.0.0.17 6379<br>1562:X 21 Nov 2022 15:03:37.636 * +slave slave 10.0.0.7:6379 10.0.0.7 6379 @ mymaster 10.0.0.17 6379<br>1562:X 21 Nov 2022 15:03:40.706 <span class="hljs-comment"># +sdown slave 10.0.0.7:6379 10.0.0.7 6379 @ mymaster 10.0.0.17 6379</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-6-2-查看各节点sentinel信息"><a href="#3-2-6-2-查看各节点sentinel信息" class="headerlink" title="3.2.6.2 查看各节点sentinel信息"></a>3.2.6.2 查看各节点sentinel信息</h4><h5 id="3-2-6-2-1-原master节点"><a href="#3-2-6-2-1-原master节点" class="headerlink" title="3.2.6.2.1 原master节点"></a>3.2.6.2.1 原master节点</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 -p 26379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface<br>may not be safe.<br>127.0.0.1:26379&gt; INFO sentinel<br><span class="hljs-comment"># Sentinel</span><br>sentinel_masters:1<br>sentinel_tilt:0<br>sentinel_running_scripts:0<br>sentinel_scripts_queue_length:0<br>sentinel_simulate_failure_flags:0<br>master0:name=mymaster,status=ok,address=10.0.0.17:6379,slaves=2,sentinels=3<br></code></pre></td></tr></table></figure>

<h5 id="3-2-6-2-2-新master（slave1）节点"><a href="#3-2-6-2-2-新master（slave1）节点" class="headerlink" title="3.2.6.2.2 新master（slave1）节点"></a>3.2.6.2.2 新master（slave1）节点</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -p 26379</span><br>127.0.0.1:26379&gt; info sentinel<br><span class="hljs-comment"># Sentinel</span><br>sentinel_masters:1<br>sentinel_tilt:0<br>sentinel_running_scripts:0<br>sentinel_scripts_queue_length:0<br>sentinel_simulate_failure_flags:0<br>master0:name=mymaster,status=ok,address=10.0.0.17:6379,slaves=2,sentinels=3<br></code></pre></td></tr></table></figure>

<h5 id="3-2-6-2-3-原slave2节点"><a href="#3-2-6-2-3-原slave2节点" class="headerlink" title="3.2.6.2.3 原slave2节点"></a>3.2.6.2.3 原slave2节点</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:26379&gt; info sentinel<br><span class="hljs-comment"># Sentinel</span><br>sentinel_masters:1<br>sentinel_tilt:0<br>sentinel_running_scripts:0<br>sentinel_scripts_queue_length:0<br>sentinel_simulate_failure_flags:0<br>master0:name=mymaster,status=ok,address=10.0.0.17:6379,slaves=2,sentinels=3<br></code></pre></td></tr></table></figure>

<h4 id="3-2-6-3-查看redis信息"><a href="#3-2-6-3-查看redis信息" class="headerlink" title="3.2.6.3 查看redis信息"></a>3.2.6.3 查看redis信息</h4><h5 id="3-2-6-3-1-原master节点"><a href="#3-2-6-3-1-原master节点" class="headerlink" title="3.2.6.3.1 原master节点"></a>3.2.6.3.1 原master节点</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.17 <span class="hljs-comment">#指向新master节点</span><br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:1<br>master_sync_in_progress:0<br>slave_repl_offset:312461<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:dd34826c10031a2f6d33042374ffa9661ee7ef0c<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:312461<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:283985<br>repl_backlog_histlen:28477<br></code></pre></td></tr></table></figure>

<h5 id="3-2-6-3-2-新master（slave1）节点"><a href="#3-2-6-3-2-新master（slave1）节点" class="headerlink" title="3.2.6.3.2 新master（slave1）节点"></a>3.2.6.3.2 新master（slave1）节点</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:2<br>slave0:ip=10.0.0.27,port=6379,state=online,offset=318871,lag=1<br>slave1:ip=10.0.0.7,port=6379,state=online,offset=319136,lag=0<br>master_replid:dd34826c10031a2f6d33042374ffa9661ee7ef0c<br>master_replid2:22ed6e622f7b837825cf8d81c0ca8d0783850cd9<br>master_repl_offset:319136<br>second_repl_offset:172402<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:841<br>repl_backlog_histlen:318296<br></code></pre></td></tr></table></figure>

<h5 id="3-2-6-3-3-原slave2节点"><a href="#3-2-6-3-3-原slave2节点" class="headerlink" title="3.2.6.3.3 原slave2节点"></a>3.2.6.3.3 原slave2节点</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.17 <span class="hljs-comment">#指向新master节点</span><br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:0<br>master_sync_in_progress:0<br>slave_repl_offset:328228<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:dd34826c10031a2f6d33042374ffa9661ee7ef0c<br>master_replid2:22ed6e622f7b837825cf8d81c0ca8d0783850cd9<br>master_repl_offset:328228<br>second_repl_offset:172402<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:328228<br></code></pre></td></tr></table></figure>

<h4 id="3-2-6-4-故障转移后的redis配置文件会被自动修改"><a href="#3-2-6-4-故障转移后的redis配置文件会被自动修改" class="headerlink" title="3.2.6.4 故障转移后的redis配置文件会被自动修改"></a>3.2.6.4 故障转移后的redis配置文件会被自动修改</h4><h5 id="3-2-6-4-1-redis-conf配置文件修改情况"><a href="#3-2-6-4-1-redis-conf配置文件修改情况" class="headerlink" title="3.2.6.4.1 redis.conf配置文件修改情况"></a>3.2.6.4.1 <code>redis.conf</code>配置文件修改情况</h5><p>故障转移后redis.conf中的replicaof行的master IP会被修改（所有节点都一样）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># grep ^replicaof /apps/redis/etc/redis.conf</span><br>replicaof 10.0.0.17 6379<br></code></pre></td></tr></table></figure>

<h5 id="3-2-6-4-2-sentinel-conf配置文件修改情况"><a href="#3-2-6-4-2-sentinel-conf配置文件修改情况" class="headerlink" title="3.2.6.4.2 sentinel.conf配置文件修改情况"></a>3.2.6.4.2 <code>sentinel.conf</code>配置文件修改情况</h5><p>哨兵配置文件的sentinel monitor IP 同样也会被修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># grep &quot;^[a-Z]&quot; /apps/redis/etc/sentinel.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br>port 26379<br>daemonize yes<br>pidfile <span class="hljs-string">&quot;/apps/redis/run/redis-sentinel.pid&quot;</span><br>logfile <span class="hljs-string">&quot;/apps/redis/log/sentinel_26379.log&quot;</span><br>dir <span class="hljs-string">&quot;/apps/redis/data&quot;</span><br>sentinel myid e75d78c4d31e3ce36007f5d121353c23705d7ab3<br>sentinel deny-scripts-reconfig yes<br>sentinel monitor mymaster 10.0.0.17 6379 2  <span class="hljs-comment">#自动修改此行</span><br>sentinel down-after-milliseconds mymaster 3000<br>sentinel auth-pass mymaster 123456<br>sentinel config-epoch mymaster 1<br>protected-mode no<br>sentinel leader-epoch mymaster 1<br>sentinel known-replica mymaster 10.0.0.7 6379<br>sentinel known-replica mymaster 10.0.0.27 6379<br>sentinel known-sentinel mymaster 10.0.0.27 26379 a4acbcafe8b95b75e0ad2ab5a5f74b7dfb491385<br>sentinel known-sentinel mymaster 10.0.0.17 26379 f79e97f9f290eddec7cc811aefe62f7b88c7e96c<br>sentinel current-epoch 1<br><br>port 26379<br>daemonize no<br>pidfile <span class="hljs-string">&quot;/var/run/redis-sentinel.pid&quot;</span><br>logfile <span class="hljs-string">&quot;/var/log/redis/sentinel.log&quot;</span><br>dir <span class="hljs-string">&quot;/tmp&quot;</span><br>sentinel myid 50547f34ed71fd48c197924969937e738a39975b<br>sentinel deny-scripts-reconfig yes<br>sentinel monitor mymaster 10.0.0.18 6379 2 <br>sentinel down-after-milliseconds mymaster 3000<br>sentinel auth-pass mymaster 123456<br>sentinel config-epoch mymaster 1<br>protected-mode no<br>supervised systemd<br>sentinel leader-epoch mymaster 1<br>sentinel known-replica mymaster 10.0.0.8 6379<br>sentinel known-replica mymaster 10.0.0.28 6379<br>sentinel known-sentinel mymaster 10.0.0.28 26379<br>50547f34ed71fd48c197924969937e738a39975d<br>sentinel current-epoch 1<br></code></pre></td></tr></table></figure>

<h3 id="3-2-7-sentinel-运维"><a href="#3-2-7-sentinel-运维" class="headerlink" title="3.2.7 sentinel 运维"></a>3.2.7 sentinel 运维</h3><h4 id="3-2-7-1-手动让主节点下线"><a href="#3-2-7-1-手动让主节点下线" class="headerlink" title="3.2.7.1 手动让主节点下线"></a>3.2.7.1 手动让主节点下线</h4><p>语法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sentinel failover &lt;masterName&gt;<br></code></pre></td></tr></table></figure>

<p>范例</p>
<p><strong>master执行以下命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -p 26379 sentinel failover mymaster</span><br></code></pre></td></tr></table></figure>

<p><strong>slave节点查看sentinel信息</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">127.0.0.1:26379&gt; info sentinel<br><span class="hljs-comment"># Sentinel</span><br>sentinel_masters:1<br>sentinel_tilt:0<br>sentinel_running_scripts:0<br>sentinel_scripts_queue_length:0<br>sentinel_simulate_failure_flags:0<br>master0:name=mymaster,status=ok,address=10.0.0.27:6379,slaves=2,sentinels=3<br></code></pre></td></tr></table></figure>

<h4 id="3-2-7-2-手动故障转移，将主节点转移到优先级高的从节点上"><a href="#3-2-7-2-手动故障转移，将主节点转移到优先级高的从节点上" class="headerlink" title="3.2.7.2 手动故障转移，将主节点转移到优先级高的从节点上"></a>3.2.7.2 手动故障转移，将主节点转移到优先级高的从节点上</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /apps/redis/etc/redis.conf</span><br>replica-priority 10 <span class="hljs-comment">#指定优先级,值越小sentinel会优先将之选为新的master,默为值为100</span><br><br><span class="hljs-comment"># redis-cli -p 26379</span><br>127.0.0.1:26379&gt; sentinel failover mymaster<br>OK<br></code></pre></td></tr></table></figure>

<h3 id="3-2-8-应用程序如何连接-redis"><a href="#3-2-8-应用程序如何连接-redis" class="headerlink" title="3.2.8 应用程序如何连接 redis"></a>3.2.8 应用程序如何连接 redis</h3><p>Redis 官方客户端：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://redis.io/clients<br></code></pre></td></tr></table></figure>

<h4 id="3-2-8-1-客户端连接-sentinel-工作原理"><a href="#3-2-8-1-客户端连接-sentinel-工作原理" class="headerlink" title="3.2.8.1 客户端连接 sentinel 工作原理"></a>3.2.8.1 客户端连接 sentinel 工作原理</h4><h5 id="3-2-8-1-1-选举出一个sentinel"><a href="#3-2-8-1-1-选举出一个sentinel" class="headerlink" title="3.2.8.1.1 选举出一个sentinel"></a>3.2.8.1.1 选举出一个sentinel</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis123.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-2-8-1-2-由这个sentinel-通过masterName-获取master节点信息"><a href="#3-2-8-1-2-由这个sentinel-通过masterName-获取master节点信息" class="headerlink" title="3.2.8.1.2 由这个sentinel 通过masterName 获取master节点信息"></a>3.2.8.1.2 由这个sentinel 通过masterName 获取master节点信息</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis124.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-2-8-1-3-sentinel-发送role指令确认mater的信息"><a href="#3-2-8-1-3-sentinel-发送role指令确认mater的信息" class="headerlink" title="3.2.8.1.3 sentinel 发送role指令确认mater的信息"></a>3.2.8.1.3 sentinel 发送role指令确认mater的信息</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis125.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-2-8-1-4-客户端订阅sentinel的相关频道，获取新的master信息变化-并自动连接新的master"><a href="#3-2-8-1-4-客户端订阅sentinel的相关频道，获取新的master信息变化-并自动连接新的master" class="headerlink" title="3.2.8.1.4 客户端订阅sentinel的相关频道，获取新的master信息变化,并自动连接新的master"></a>3.2.8.1.4 客户端订阅sentinel的相关频道，获取新的master信息变化,并自动连接新的master</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis126.png" srcset="/blog/img/loading.gif"></p>
<p><strong>简单来说：新来的班主任通过该版的任何一个学生找到该班的班长，不管班长以后会不会换人</strong></p>
<h4 id="3-2-8-2-java-连接Sentinel哨兵"><a href="#3-2-8-2-java-连接Sentinel哨兵" class="headerlink" title="3.2.8.2 java 连接Sentinel哨兵"></a>3.2.8.2 java 连接Sentinel哨兵</h4><p>java 客户端连接Redis：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://github.com/xetorthio/jedis/blob/master/pom.xml<br></code></pre></td></tr></table></figure>

<p>配置文件内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml">#jedis/pom.xml 配置连接redis<br><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">redis-hosts</span>&gt;</span>localhost:6379,localhost:6380,localhost:6381,localhost:6382,localhost:6383<br>,localhost:6384,localhost:6385<span class="hljs-tag">&lt;/<span class="hljs-name">redis-hosts</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">sentinel-hosts</span>&gt;</span>localhost:26379,localhost:26380,localhost:26381<span class="hljs-tag">&lt;/<span class="hljs-name">sentinel-hosts</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">cluster-hosts</span>&gt;</span>localhost:7379,localhost:7380,localhost:7381,localhost:7382,localhost:7383<br>,localhost:7384,localhost:7385<span class="hljs-tag">&lt;/<span class="hljs-name">cluster-hosts</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">github.global.server</span>&gt;</span>github<span class="hljs-tag">&lt;/<span class="hljs-name">github.global.server</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>java客户端连接单机的redis是通过Jedis来实现的，java代码用的时候只要创建Jedis对象就可以建多个Jedis连接池来连接redis，应用程序再直接调用连接池即可连接Redis。而Redis为了保障高可用，服务一般都是Sentinel部署方式，当Redis服务中的主服务挂掉之后，会仲裁出另外一台Slaves服务充当Master。这个时候,我们的应用即使使用了Jedis 连接池，如果Master服务挂了，应用将还是无法连接新的Master服务，为了解决这个问题, Jedis也提供了相应的Sentinel实现,能够在Redis Sentinel主从切换时候,通知应用,把应用连接到新的Master服务。</p>
<p>Redis Sentinel的使用也是十分简单的，只是在JedisPool中添加了Sentinel和MasterName参数，JRedis Sentinel底层基于Redis订阅实现Redis主从服务的切换通知，当Reids发生主从切换时，Sentinel会发送通知主动通知Jedis进行连接的切换，JedisSentinelPool在每次从连接池中获取链接对象的时候,都要对连接对象进行检测,如果此链接和Sentinel的Master服务连接参数不一致,则会关闭此连接,重新获取新的Jedis连接对象。</p>
<h4 id="3-2-8-3-python-连接Sentinel哨兵"><a href="#3-2-8-3-python-连接Sentinel哨兵" class="headerlink" title="3.2.8.3 python 连接Sentinel哨兵"></a>3.2.8.3 python 连接Sentinel哨兵</h4><h5 id="3-2-8-3-1-安装Python3和Python3-redis"><a href="#3-2-8-3-1-安装Python3和Python3-redis" class="headerlink" title="3.2.8.3.1 安装Python3和Python3-redis"></a>3.2.8.3.1 安装Python3和Python3-redis</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum -y install python3 python3-redis</span><br></code></pre></td></tr></table></figure>

<h5 id="3-2-8-3-2-添加Python脚本"><a href="#3-2-8-3-2-添加Python脚本" class="headerlink" title="3.2.8.3.2 添加Python脚本"></a>3.2.8.3.2 添加Python脚本</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim sentinel_test.py</span><br><span class="hljs-comment">#!/usr/bin/python3</span><br>import redis<br>from redis.sentinel import Sentinel<br><span class="hljs-comment">#连接哨兵服务器(主机名也可以用域名)</span><br>sentinel = Sentinel([(<span class="hljs-string">&#x27;10.0.0.7&#x27;</span>, 26379),<br>                   (<span class="hljs-string">&#x27;10.0.0.17&#x27;</span>, 26379),<br>                   (<span class="hljs-string">&#x27;10.0.0.27&#x27;</span>, 26379)],<br>                     socket_timeout=0.5)<br><br>redis_auth_pass = <span class="hljs-string">&#x27;123456&#x27;</span><br><br><span class="hljs-comment">#mymaster 是配置哨兵模式的redis集群名称，此为默认值,实际名称按照个人部署案例来填写</span><br><span class="hljs-comment">#获取主服务器地址</span><br>master = sentinel.discover_master(<span class="hljs-string">&#x27;mymaster&#x27;</span>)<br><span class="hljs-built_in">print</span>(master)<br><br><span class="hljs-comment">#获取从服务器地址</span><br>slave = sentinel.discover_slaves(<span class="hljs-string">&#x27;mymaster&#x27;</span>)<br><span class="hljs-built_in">print</span>(slave)<br><br><span class="hljs-comment">#获取主服务器进行写入</span><br>master = sentinel.master_for(<span class="hljs-string">&#x27;mymaster&#x27;</span>, socket_timeout=0.5,<br>password=redis_auth_pass, db=0)<br>w_ret = master.set(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;rlin&#x27;</span>)<br><span class="hljs-comment">#输出：True</span><br><br><span class="hljs-comment">#获取从服务器进行读取（默认是round-roubin）</span><br>slave = sentinel.slave_for(<span class="hljs-string">&#x27;mymaster&#x27;</span>, socket_timeout=0.5,<br>password=redis_auth_pass, db=0)<br>r_ret = slave.get(<span class="hljs-string">&#x27;name&#x27;</span>)<br><span class="hljs-built_in">print</span>(r_ret)<br><span class="hljs-comment">#输出：rlin</span><br></code></pre></td></tr></table></figure>

<h5 id="3-2-8-3-3-执行脚本"><a href="#3-2-8-3-3-执行脚本" class="headerlink" title="3.2.8.3.3 执行脚本"></a>3.2.8.3.3 执行脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># chmod +x sentinel_test.py</span><br><br><span class="hljs-comment"># ./sentinel_test.py</span><br>(<span class="hljs-string">&#x27;10.0.0.7&#x27;</span>, 6379)<br>[(<span class="hljs-string">&#x27;10.0.0.27&#x27;</span>, 6379), (<span class="hljs-string">&#x27;10.0.0.17&#x27;</span>, 6379)]<br>b<span class="hljs-string">&#x27;rlin&#x27;</span><br></code></pre></td></tr></table></figure>

<h2 id="3-3-Redis-Cluster"><a href="#3-3-Redis-Cluster" class="headerlink" title="3.3 Redis Cluster"></a>3.3 Redis Cluster</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis127.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-3-1-Redis-Cluster-工作原理"><a href="#3-3-1-Redis-Cluster-工作原理" class="headerlink" title="3.3.1 Redis Cluster 工作原理"></a>3.3.1 Redis Cluster 工作原理</h3><p>在哨兵sentinel机制中，可以解决redis高可用问题，即当master故障后可以自动将slave提升为master，从而可以保证redis服务的正常使用，但是无法解决redis单机写入的瓶颈问题，即单机redis写入性能受限于单机的内存大小、并发数量、网卡速率等因素。</p>
<p><strong>早期Redis 分布式集群部署方案：</strong></p>
<ol>
<li>客户端分区：由客户端程序决定key写分配和写入的redis node，但是需要客户端自己处理写入分配、高可用管理和故障转移等</li>
<li>代理方案：基于三方软件实现redis proxy，客户端先连接之代理层，由代理层实现key的写入分配，对客户端来说是有比较简单，但是对于集群管节点增减相对比较麻烦，而且代理本身也是单点和性能瓶颈</li>
</ol>
<p>redis 3.0版本之后推出了无中心架构的redis cluster机制，在无中心的redis集群当中，其每个节点保存当前节点数据和整个集群状态,每个节点都和其他所有节点连接</p>
<p><strong>Redis Cluster特点如下：</strong></p>
<ol>
<li>所有Redis节点使用(PING机制)互联</li>
<li>集群中某个节点的是否失效，是由整个集群中超过半数的节点监测都失效，才能算真正的失效</li>
<li>客户端不需要proxy即可直接连接redis，应用程序中需要配置有全部的redis服务器IP</li>
<li>redis cluster把所有的redis node 平均映射到 0-16383个槽位(slot)上，读写需要到指定的redis node上进行操作，因此有多少个redis node相当于redis 并发扩展了多少倍，每个redis node 承担16384/N个槽位</li>
<li>Redis cluster预先分配16384个(slot)槽位，当需要在redis集群中写入一个key -value的时候，会使用CRC16(key) mod 16384之后的值，决定将key写入值哪一个槽位从而决定写入哪一个Redis节点上，从而有效解决单机瓶颈。</li>
</ol>
<h3 id="3-3-2-Redis-cluster-架构"><a href="#3-3-2-Redis-cluster-架构" class="headerlink" title="3.3.2 Redis cluster 架构"></a>3.3.2 Redis cluster 架构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis128.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-3-2-1-Redis-cluster-基本架构"><a href="#3-3-2-1-Redis-cluster-基本架构" class="headerlink" title="3.3.2.1 Redis cluster 基本架构"></a>3.3.2.1 Redis cluster 基本架构</h4><p>假如三个主节点分别是：A, B, C 三个节点，采用哈希槽 (hash slot)的方式来分配16384个slot 的话<br>它们三个节点分别承担的slot 区间可以是：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">节点<span class="hljs-keyword">A</span>覆盖 <span class="hljs-number">0</span>－<span class="hljs-number">5460</span><br>节点B覆盖 <span class="hljs-number">5461－10922</span><br>节点C覆盖 <span class="hljs-number">10923－16383</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis129.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-3-2-2-Redis-cluster-主从架构"><a href="#3-3-2-2-Redis-cluster-主从架构" class="headerlink" title="3.3.2.2 Redis cluster 主从架构"></a>3.3.2.2 Redis cluster 主从架构</h4><p>Redis cluster的架构虽然解决了并发的问题，但是又引入了一个新的问题，每个Redis master的高可用如何解决？</p>
<p>那就是对每个master节点都实现主从复制，从而实现 redis 高可用性</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis130.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-3-2-3-Redis-Cluster-部署架构说明"><a href="#3-3-2-3-Redis-Cluster-部署架构说明" class="headerlink" title="3.3.2.3 Redis Cluster 部署架构说明"></a>3.3.2.3 Redis Cluster 部署架构说明</h4><p>环境A：3台服务器，每台服务器启动6379和6380两个redis 服务实例，适用于测试环境</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis131.png" srcset="/blog/img/loading.gif"></p>
<p>环境B：6台服务器，分别是三组master/slave，适用于生产环境</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis132.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#集群节点</span><br>10.0.0.7<br>10.0.0.17<br>10.0.0.27<br>10.0.0.37<br>10.0.0.47<br>10.0.0.57<br><span class="hljs-comment">#预留服务器扩展使用</span><br>10.0.0.67<br>10.0.0.77<br></code></pre></td></tr></table></figure>

<p>说明：Redis 5.X 和之前版本相比有很多变化，以下分别介绍两个版本5.X和4.X的配置</p>
<h4 id="3-3-2-4-部署方式介绍"><a href="#3-3-2-4-部署方式介绍" class="headerlink" title="3.3.2.4 部署方式介绍"></a>3.3.2.4 部署方式介绍</h4><p>redis cluster 有多种部署方法</p>
<ul>
<li><p>原生命令安装</p>
<p>理解Redis Cluster架构</p>
<p>生产环境不使用</p>
</li>
<li><p>官方工具安装</p>
<p>高效、准确</p>
<p>生产环境可以使用</p>
</li>
<li><p>自主研发</p>
<p>可以实现可视化的自动化部署</p>
</li>
</ul>
<h3 id="3-3-3-原生命令手动部署redis-cluster-生产不用"><a href="#3-3-3-原生命令手动部署redis-cluster-生产不用" class="headerlink" title="3.3.3 原生命令手动部署redis cluster(生产不用)"></a>3.3.3 原生命令手动部署redis cluster(生产不用)</h3><h4 id="3-3-3-1-原生命令手动部署过程"><a href="#3-3-3-1-原生命令手动部署过程" class="headerlink" title="3.3.3.1 原生命令手动部署过程"></a>3.3.3.1 原生命令手动部署过程</h4><ul>
<li>在所有节点安装redis，并配置开启cluster功能</li>
<li>各个节点执行meet，实现所有节点的相互通信</li>
<li>为各个master节点指派槽位范围</li>
<li>指定各个节点的主从关系</li>
</ul>
<h4 id="3-3-3-2-环境规划"><a href="#3-3-3-2-环境规划" class="headerlink" title="3.3.3.2 环境规划"></a>3.3.3.2 环境规划</h4><table>
<thead>
<tr>
<th align="center">ip</th>
<th>hostname</th>
<th align="center">port</th>
<th>redis版本</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.0.0.7</td>
<td>redis-master1</td>
<td align="center">6379</td>
<td>redis3.2.12</td>
</tr>
<tr>
<td align="center">10.0.0.17</td>
<td>redis-master2</td>
<td align="center">6379</td>
<td>redis3.2.12</td>
</tr>
<tr>
<td align="center">10.0.0.27</td>
<td>redis-master3</td>
<td align="center">6379</td>
<td>redis3.2.12</td>
</tr>
<tr>
<td align="center">10.0.0.37</td>
<td>redis-slave1</td>
<td align="center">6379</td>
<td>redis3.2.12</td>
</tr>
<tr>
<td align="center">10.0.0.47</td>
<td>redis-slave2</td>
<td align="center">6379</td>
<td>redis3.2.12</td>
</tr>
<tr>
<td align="center">10.0.0.57</td>
<td>redis-slave3</td>
<td align="center">6379</td>
<td>redis3.2.12</td>
</tr>
</tbody></table>
<h5 id="3-3-3-3-修改hostname"><a href="#3-3-3-3-修改hostname" class="headerlink" title="3.3.3.3 修改hostname"></a>3.3.3.3 修改hostname</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#10.0.0.7</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-master1</span><br><br><span class="hljs-comment">#10.0.0.17</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-master2</span><br><br><span class="hljs-comment">#10.0.0.27</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-master3</span><br><br><span class="hljs-comment">#10.0.0.37</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-slave1</span><br><br><span class="hljs-comment">#10.0.0.47</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-slave2</span><br><br><span class="hljs-comment">#10.0.0.57</span><br><span class="hljs-comment"># hostnamectl set-hostname redis-slave</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-4-所有节点安装redis"><a href="#3-3-3-4-所有节点安装redis" class="headerlink" title="3.3.3.4 所有节点安装redis"></a>3.3.3.4 所有节点安装redis</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y redis</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-5-修改配置文件"><a href="#3-3-3-5-修改配置文件" class="headerlink" title="3.3.3.5 修改配置文件"></a>3.3.3.5 修改配置文件</h4><p><strong>任意节点修改配置文件后复制到所有节点上</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/redis.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br>masterauth 123456<br>requirepass 123456<br>cluster-enabled yes<br>cluster-config-file nodes-6379.conf<br>cluster-require-full-coverage no<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-6-所有节点启动redis"><a href="#3-3-3-6-所有节点启动redis" class="headerlink" title="3.3.3.6 所有节点启动redis"></a>3.3.3.6 所有节点启动redis</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl enable --now redis</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-7-查看启动端口"><a href="#3-3-3-7-查看启动端口" class="headerlink" title="3.3.3.7 查看启动端口"></a>3.3.3.7 查看启动端口</h4><p><strong>6379：redis端口</strong></p>
<p><strong>16379：redis集群端口</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ss -tnl</span><br>State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port              <br>LISTEN     0      128                             *:16379                                       *:*                  <br>LISTEN     0      128                             *:6379                                        *:*                  <br>LISTEN     0      128                             *:22                                          *:*                  <br>LISTEN     0      128                          [::]:22                                       [::]:*<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-8-查看redis各节点状态"><a href="#3-3-3-8-查看redis各节点状态" class="headerlink" title="3.3.3.8 查看redis各节点状态"></a>3.3.3.8 查看redis各节点状态</h4><p>可以看到redis为<strong>cluster</strong>状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ps aux | grep redis</span><br>redis      1674  0.1  0.5 143060  5816 ?        Ssl  17:14   0:00 /usr/bin/redis-server 0.0.0.0:6379 [cluster]<br>root       1682  0.0  0.0 112812   972 pts/0    R+   17:15   0:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-9-执行meet操作实现互通互信"><a href="#3-3-3-9-执行meet操作实现互通互信" class="headerlink" title="3.3.3.9 执行meet操作实现互通互信"></a>3.3.3.9 执行meet操作实现互通互信</h4><p><strong>在任一节点上和其它所有节点进行meet通信</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 cluster meet 10.0.0.17 6379</span><br>OK<br><span class="hljs-comment"># redis-cli -a 123456 cluster meet 10.0.0.7 6379</span><br>OK<br><span class="hljs-comment"># redis-cli -a 123456 cluster meet 10.0.0.27 6379</span><br>OK<br><span class="hljs-comment"># redis-cli -a 123456 cluster meet 10.0.0.37 6379</span><br>OK<br><span class="hljs-comment"># redis-cli -a 123456 cluster meet 10.0.0.47 6379</span><br>OK<br><span class="hljs-comment"># redis-cli -a 123456 cluster meet 10.0.0.57 6379</span><br>OK<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-10-查看每个节点的集群状态"><a href="#3-3-3-10-查看每个节点的集群状态" class="headerlink" title="3.3.3.10 查看每个节点的集群状态"></a>3.3.3.10 查看每个节点的集群状态</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 cluster nodes</span><br>442c4a1bd026e5398ff265f98968ee1e8afd5fbc 10.0.0.17:6379 master - 0 1669022367471 1 connected<br>d7920709bba57bdebc796966108e217fafebe98f 10.0.0.57:6379 master - 0 1669022369484 0 connected<br>7c0232c487ad28e67127b4f883ef2ccf3b9d4e65 10.0.0.37:6379 master - 0 1669022366467 3 connected<br>c5bde47058d7c674af73847c91b144b4a2dd46d2 10.0.0.27:6379 master - 0 1669022368478 5 connected<br>84b657306b5fabd08baeb7a4e81479e06e420947 10.0.0.47:6379 master - 0 1669022365462 4 connected<br>8a8ce275ad34a3c6d287fb388cc8aded77be512d 10.0.0.7:6379 myself,master - 0 0 2 connected<br><br><span class="hljs-comment">#由于没有槽位无法创建key</span><br><span class="hljs-comment"># redis-cli -a 123456 set name rlin</span><br>(error) CLUSTERDOWN Hash slot not served<br><br><span class="hljs-comment"># redis-cli -h 10.0.0.7 -a 123456 cluster info</span><br>cluster_state:fail<br>cluster_slots_assigned:0<br>cluster_slots_ok:0<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:6<br>cluster_size:0<br>cluster_current_epoch:5<br>cluster_my_epoch:2<br>cluster_stats_messages_sent:685<br>cluster_stats_messages_received:685<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-11-为各个master节点指派槽位范围"><a href="#3-3-3-11-为各个master节点指派槽位范围" class="headerlink" title="3.3.3.11 为各个master节点指派槽位范围"></a>3.3.3.11 为各个master节点指派槽位范围</h4><p><strong>在master节点上执行</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#创建添加槽位的脚本</span><br><span class="hljs-comment"># vim addslot.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>host=<span class="hljs-variable">$1</span><br>port=<span class="hljs-variable">$2</span><br>start=<span class="hljs-variable">$3</span><br>end=<span class="hljs-variable">$4</span><br>pass=123456<br><br><span class="hljs-keyword">for</span> slot <span class="hljs-keyword">in</span> `seq <span class="hljs-variable">$&#123;start&#125;</span> <span class="hljs-variable">$&#123;end&#125;</span>`;<span class="hljs-keyword">do</span><br>	<span class="hljs-built_in">echo</span> slot:<span class="hljs-variable">$slot</span><br>	redis-cli -h <span class="hljs-variable">$&#123;host&#125;</span> -p <span class="hljs-variable">$port</span> -a <span class="hljs-variable">$&#123;pass&#125;</span> --no-auth-warning cluster addslots <span class="hljs-variable">$&#123;slot&#125;</span> <span class="hljs-comment">#注意3.XZ版本不用添加“--no-auth-warning”</span><br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment">#为三个master分配槽位,共16364/3=5,461.333333333333,平均每个master分配5,461个槽位</span><br><span class="hljs-comment"># bash addslot.sh 10.0.0.7 6379 0 5461</span><br><span class="hljs-comment"># bash addslot.sh 10.0.0.17 6379 5462 10922</span><br><span class="hljs-comment"># bash addslot.sh 10.0.0.27 6379 10923 16383</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-12-查看分槽后的信息"><a href="#3-3-3-12-查看分槽后的信息" class="headerlink" title="3.3.3.12 查看分槽后的信息"></a>3.3.3.12 查看分槽后的信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#当第一个master分配完槽位后,可以看到下面信息</span><br><span class="hljs-comment"># redis-cli -a 123456 cluster info</span><br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:6<br>cluster_size:3 <span class="hljs-comment">#三个成员</span><br>cluster_current_epoch:5<br>cluster_my_epoch:2<br>cluster_stats_messages_sent:2017<br>cluster_stats_messages_received:2017<br><br><span class="hljs-comment">#当第一个master分配完槽位后,可以看到下面信息</span><br><span class="hljs-comment"># redis-cli -a 123456 cluster nodes</span><br>442c4a1bd026e5398ff265f98968ee1e8afd5fbc 10.0.0.17:6379 master - 0 1669023225216 1 connected 5462-10922<br>d7920709bba57bdebc796966108e217fafebe98f 10.0.0.57:6379 master - 0 1669023224211 0 connected<br>7c0232c487ad28e67127b4f883ef2ccf3b9d4e65 10.0.0.37:6379 master - 0 1669023223206 3 connected<br>c5bde47058d7c674af73847c91b144b4a2dd46d2 10.0.0.27:6379 master - 0 1669023226220 5 connected 10923-16383<br>84b657306b5fabd08baeb7a4e81479e06e420947 10.0.0.47:6379 master - 0 1669023222201 4 connected<br>8a8ce275ad34a3c6d287fb388cc8aded77be512d 10.0.0.7:6379 myself,master - 0 0 2 connected 0-5461<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-13-测试key的创建"><a href="#3-3-3-13-测试key的创建" class="headerlink" title="3.3.3.13 测试key的创建"></a>3.3.3.13 测试key的创建</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 set name rlin</span><br>(error) MOVED 5798 10.0.0.17:6379 <span class="hljs-comment">#会提示需要在哪个节点上创建key</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.17 -a 123456 set name rlin</span><br>OK<br><span class="hljs-comment"># redis-cli -a 123456 get name</span><br>(error) MOVED 5798 10.0.0.17:6379 <span class="hljs-comment">#会提示在哪个节点上读取key</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.17 -a 123456 get name</span><br><span class="hljs-string">&quot;rlin&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-14-从节点规划"><a href="#3-3-3-14-从节点规划" class="headerlink" title="3.3.3.14 从节点规划"></a>3.3.3.14 从节点规划</h4><table>
<thead>
<tr>
<th align="center">master IP</th>
<th align="center">slave IP</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.0.0.7:6379</td>
<td align="center">10.0.0.37:6379</td>
</tr>
<tr>
<td align="center">10.0.0.17:6379</td>
<td align="center">10.0.0.47:6379</td>
</tr>
<tr>
<td align="center">10.0.0.27:6379</td>
<td align="center">10.0.0.57:6379</td>
</tr>
</tbody></table>
<h4 id="3-3-3-15-各master节点创建从节点"><a href="#3-3-3-15-各master节点创建从节点" class="headerlink" title="3.3.3.15 各master节点创建从节点"></a>3.3.3.15 各master节点创建从节点</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#通过上面cluster nodes 查看master的ID信息,执行下面操作,将对应的slave 指定相应的master节点,实现三对主从节点</span><br><span class="hljs-comment">#再次提示，要通过查看cluster nodes 信息来获取主节点的ID信息</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.37 -a 123456 cluster replicate 8a8ce275ad34a3c6d287fb388cc8aded77be512d</span><br>OK<br><span class="hljs-comment"># redis-cli -h 10.0.0.47 -a 123456 cluster replicate 442c4a1bd026e5398ff265f98968ee1e8afd5fbc</span><br>OK<br><span class="hljs-comment"># redis-cli -h 10.0.0.57 -a 123456 cluster replicate c5bde47058d7c674af73847c91b144b4a2dd46d2</span><br>OK<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-16-查看各节点集群信息"><a href="#3-3-3-16-查看各节点集群信息" class="headerlink" title="3.3.3.16 查看各节点集群信息"></a>3.3.3.16 查看各节点集群信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -h 10.0.0.7 -a 123456 cluster nodes</span><br>442c4a1bd026e5398ff265f98968ee1e8afd5fbc 10.0.0.17:6379 master - 0 1669023800884 1 connected 5462-10922<br>d7920709bba57bdebc796966108e217fafebe98f 10.0.0.57:6379 slave c5bde47058d7c674af73847c91b144b4a2dd46d2 0 1669023798874 5 connected<br>7c0232c487ad28e67127b4f883ef2ccf3b9d4e65 10.0.0.37:6379 slave 8a8ce275ad34a3c6d287fb388cc8aded77be512d 0 1669023798372 3 connected<br>c5bde47058d7c674af73847c91b144b4a2dd46d2 10.0.0.27:6379 master - 0 1669023797869 5 connected 10923-16383<br>84b657306b5fabd08baeb7a4e81479e06e420947 10.0.0.47:6379 slave 442c4a1bd026e5398ff265f98968ee1e8afd5fbc 0 1669023799880 4 connected<br>8a8ce275ad34a3c6d287fb388cc8aded77be512d 10.0.0.7:6379 myself,master - 0 0 2 connected 0-5461<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-17-查看主节点信息"><a href="#3-3-3-17-查看主节点信息" class="headerlink" title="3.3.3.17 查看主节点信息"></a>3.3.3.17 查看主节点信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -h 10.0.0.7 -a 123456 info replication</span><br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.37,port=6379,state=online,offset=267,lag=1<br>master_repl_offset:267<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:2<br>repl_backlog_histlen:266<br><br><span class="hljs-comment"># redis-cli -h 10.0.0.17 -a 123456 info replication</span><br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.47,port=6379,state=online,offset=267,lag=0<br>master_repl_offset:267<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:2<br>repl_backlog_histlen:266<br><br><span class="hljs-comment"># redis-cli -h 10.0.0.27 -a 123456 info replication</span><br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.57,port=6379,state=online,offset=239,lag=0<br>master_repl_offset:239<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:2<br>repl_backlog_histlen:238<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-18-查看主从节关系及槽位信息"><a href="#3-3-3-18-查看主从节关系及槽位信息" class="headerlink" title="3.3.3.18 查看主从节关系及槽位信息"></a>3.3.3.18 查看主从节关系及槽位信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -h 10.0.0.27 -a 123456 cluster slots</span><br>1) 1) (<span class="hljs-built_in">integer</span>) 0<br>   2) (<span class="hljs-built_in">integer</span>) 5461<br>   3) 1) <span class="hljs-string">&quot;10.0.0.7&quot;</span><br>      2) (<span class="hljs-built_in">integer</span>) 6379<br>      3) <span class="hljs-string">&quot;8a8ce275ad34a3c6d287fb388cc8aded77be512d&quot;</span><br>   4) 1) <span class="hljs-string">&quot;10.0.0.37&quot;</span><br>      2) (<span class="hljs-built_in">integer</span>) 6379<br>      3) <span class="hljs-string">&quot;7c0232c487ad28e67127b4f883ef2ccf3b9d4e65&quot;</span><br>2) 1) (<span class="hljs-built_in">integer</span>) 5462<br>   2) (<span class="hljs-built_in">integer</span>) 10922<br>   3) 1) <span class="hljs-string">&quot;10.0.0.17&quot;</span><br>      2) (<span class="hljs-built_in">integer</span>) 6379<br>      3) <span class="hljs-string">&quot;442c4a1bd026e5398ff265f98968ee1e8afd5fbc&quot;</span><br>   4) 1) <span class="hljs-string">&quot;10.0.0.47&quot;</span><br>      2) (<span class="hljs-built_in">integer</span>) 6379<br>      3) <span class="hljs-string">&quot;84b657306b5fabd08baeb7a4e81479e06e420947&quot;</span><br>3) 1) (<span class="hljs-built_in">integer</span>) 10923<br>   2) (<span class="hljs-built_in">integer</span>) 16383<br>   3) 1) <span class="hljs-string">&quot;10.0.0.27&quot;</span><br>      2) (<span class="hljs-built_in">integer</span>) 6379<br>      3) <span class="hljs-string">&quot;c5bde47058d7c674af73847c91b144b4a2dd46d2&quot;</span><br>   4) 1) <span class="hljs-string">&quot;10.0.0.57&quot;</span><br>      2) (<span class="hljs-built_in">integer</span>) 6379<br>      3) <span class="hljs-string">&quot;d7920709bba57bdebc796966108e217fafebe98f&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-19-验证-redis-cluster-访问"><a href="#3-3-3-19-验证-redis-cluster-访问" class="headerlink" title="3.3.3.19 验证 redis cluster 访问"></a>3.3.3.19 验证 redis cluster 访问</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#-c 表示以集群方式连接</span><br><span class="hljs-comment"># redis-cli -c -h 10.0.0.7 -a 123456 set name zongduizhang</span><br>OK<br><span class="hljs-comment"># redis-cli -c -h 10.0.0.7 -a 123456 get name</span><br><span class="hljs-string">&quot;zongduizhang&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-3-4-Redis-5-的-redis-cluster相关命令解释"><a href="#3-3-4-Redis-5-的-redis-cluster相关命令解释" class="headerlink" title="3.3.4 Redis 5 的 redis cluster相关命令解释"></a>3.3.4 Redis 5 的 redis cluster相关命令解释</h3><p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://redis.io/topics/cluster-tutorial<br></code></pre></td></tr></table></figure>

<h4 id="3-3-4-1-redis-cluster-相关命令"><a href="#3-3-4-1-redis-cluster-相关命令" class="headerlink" title="3.3.4.1 redis cluster 相关命令"></a>3.3.4.1 redis cluster 相关命令</h4><p>范例: 查看 –cluster 选项帮助</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli --cluster help</span><br>Cluster Manager Commands:<br>create     host1:port1 ... hostN:portN<br>        --cluster-replicas &lt;arg&gt;<br>check     host:port<br>        --cluster-search-multiple-owners<br>info      host:port<br>fix      host:port<br>        --cluster-search-multiple-owners<br>reshard    host:port<br>        --cluster-from &lt;arg&gt;<br>        --cluster-to &lt;arg&gt;<br>        --cluster-slots &lt;arg&gt;<br>        --cluster-yes<br>        --cluster-timeout &lt;arg&gt;<br>        --cluster-pipeline &lt;arg&gt;<br>        --cluster-replace<br>rebalance   host:port<br>        --cluster-weight &lt;node1=w1...nodeN=wN&gt;<br>        --cluster-use-empty-masters<br>        --cluster-timeout &lt;arg&gt;<br>        --cluster-simulate<br>        --cluster-pipeline &lt;arg&gt;<br>        --cluster-threshold &lt;arg&gt;<br>        --cluster-replace<br>add-node    new_host:new_port existing_host:existing_port<br>        --cluster-slave<br>        --cluster-master-id &lt;arg&gt;<br>del-node    host:port node_id<br>call      host:port <span class="hljs-built_in">command</span> arg arg .. arg<br>set-timeout  host:port milliseconds<br>import     host:port<br>        --cluster-from &lt;arg&gt;<br>        --cluster-copy<br>        --cluster-replace<br><span class="hljs-built_in">help</span><br><br>For check, fix, reshard, del-node, set-timeout you can specify the host and portof any working node <span class="hljs-keyword">in</span> the cluster.<br></code></pre></td></tr></table></figure>

<h4 id="3-3-4-2-redis查看cluster指令的帮助"><a href="#3-3-4-2-redis查看cluster指令的帮助" class="headerlink" title="3.3.4.2 redis查看cluster指令的帮助"></a>3.3.4.2 redis查看cluster指令的帮助</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli CLUSTER HELP</span><br>1) CLUSTER &lt;subcommand&gt; arg arg ... arg. Subcommands are:<br>2) ADDSLOTS &lt;slot&gt; [slot ...] -- Assign slots to current node.<br>3) BUMPEPOCH -- Advance the cluster config epoch.<br>4) COUNT-failure-reports &lt;node-id&gt; -- Return number of failure reports <span class="hljs-keyword">for</span> &lt;node-id&gt;.<br>5) COUNTKEYSINSLOT &lt;slot&gt; - Return the number of keys <span class="hljs-keyword">in</span> &lt;slot&gt;.<br>6) DELSLOTS &lt;slot&gt; [slot ...] -- Delete slots information from current node.<br>7) FAILOVER [force|takeover] -- Promote current replica node to being a master.<br>8) FORGET &lt;node-id&gt; -- Remove a node from the cluster.<br>9) GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; -- Return key names stored by current node <span class="hljs-keyword">in</span> a slot.<br>10) FLUSHSLOTS -- Delete current node own slots information.<br>11) INFO - Return onformation about the cluster.<br>12) KEYSLOT &lt;key&gt; -- Return the <span class="hljs-built_in">hash</span> slot <span class="hljs-keyword">for</span> &lt;key&gt;.<br>13) MEET &lt;ip&gt; &lt;port&gt; [bus-port] -- Connect nodes into a working cluster.<br>14) MYID -- Return the node id.<br>15) NODES -- Return cluster configuration seen by node. Output format:<br>16)   &lt;id&gt; &lt;ip:port&gt; &lt;flags&gt; &lt;master&gt; &lt;pings&gt; &lt;pongs&gt; &lt;epoch&gt; &lt;link&gt; &lt;slot&gt; ... &lt;slot&gt;<br>17) REPLICATE &lt;node-id&gt; -- Configure current node as replica to &lt;node-id&gt;.<br>18) RESET [hard|soft] -- Reset current node (default: soft).<br>19) SET-config-epoch &lt;epoch&gt; - Set config epoch of current node.<br>20) SETSLOT &lt;slot&gt; (importing|migrating|stable|node &lt;node-id&gt;) -- Set slot state.<br>21) REPLICAS &lt;node-id&gt; -- Return &lt;node-id&gt; replicas.<br>22) SLOTS -- Return information about slots range mappings. Each range is made of:<br>23)   start, end, master and replicas IP addresses, ports and ids<br></code></pre></td></tr></table></figure>

<h3 id="3-3-5-实战案例：基于Redis-5-的-redis-cluster-部署"><a href="#3-3-5-实战案例：基于Redis-5-的-redis-cluster-部署" class="headerlink" title="3.3.5 实战案例：基于Redis 5 的 redis cluster 部署"></a>3.3.5 实战案例：基于Redis 5 的 redis cluster 部署</h3><h4 id="3-3-5-1-环境规划"><a href="#3-3-5-1-环境规划" class="headerlink" title="3.3.5.1 环境规划"></a>3.3.5.1 环境规划</h4><table>
<thead>
<tr>
<th>服务器IP</th>
<th>hostname</th>
<th>redis版本</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.7</td>
<td>redis-master1</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.17</td>
<td>redis-master2</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.27</td>
<td>redis-master3</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.37</td>
<td>redis-slave1</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.47</td>
<td>redis-slave2</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.57</td>
<td>redis-slave3</td>
<td>redis5.0.9</td>
</tr>
</tbody></table>
<h4 id="3-3-5-2-服务器要求"><a href="#3-3-5-2-服务器要求" class="headerlink" title="3.3.5.2 服务器要求"></a>3.3.5.2 服务器要求</h4><ol>
<li>每个redis 节点采用相同的硬件配置、相同的密码、相同的redis版本</li>
<li>所有redis服务器必须没有任何数据</li>
</ol>
<h4 id="3-3-5-3-安装redis"><a href="#3-3-5-3-安装redis" class="headerlink" title="3.3.5.3 安装redis"></a>3.3.5.3 安装redis</h4><p>过程略</p>
<h4 id="3-3-5-4-修改redis配置文件"><a href="#3-3-5-4-修改redis配置文件" class="headerlink" title="3.3.5.4 修改redis配置文件"></a>3.3.5.4 修改redis配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /etc/redis.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br>pidfile /apps/redis/run/redis_6379.pid<br>logfile <span class="hljs-string">&quot;/apps/redis/log/redis-6379.log&quot;</span><br>dir /apps/redis/data/<br>requirepass 123456<br>masterauth 123456  <span class="hljs-comment">#建议配置，否则后期的master和slave主从复制无法成功，还需再配置requirepass 123456</span><br>cluster-enabled yes <span class="hljs-comment">#取消此行注释,必须开启集群，开启后redis 进程会有cluster显示</span><br>cluster-config-file nodes-6379.conf <span class="hljs-comment">#取消此行注释,此为集群状态文件,记录主从关系及slot范围信息,由redis cluster 集群自动创建和维护</span><br>cluster-require-full-coverage no  <span class="hljs-comment">#默认值为yes,设为no可以防止一个节点不可用导致整个cluster不可能</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-5-启动redis"><a href="#3-3-5-5-启动redis" class="headerlink" title="3.3.5.5 启动redis"></a>3.3.5.5 启动redis</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl daemon-reload</span><br><span class="hljs-comment"># systemctl enable --now redis</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-6-查看redis端口"><a href="#3-3-5-6-查看redis端口" class="headerlink" title="3.3.5.6 查看redis端口"></a>3.3.5.6 查看redis端口</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#开启了16379的cluster的端口,实际的端口=redis port + 10000</span><br><span class="hljs-comment"># ss -ntl</span><br>State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port              <br>LISTEN     0      511                             *:6379                                        *:*                  <br>LISTEN     0      128                             *:22                                          *:*                  <br>LISTEN     0      511                             *:16379                                       *:*                  <br>LISTEN     0      128                          [::]:22                                       [::]:*<br><br><span class="hljs-comment">#注意进程有[cluster]状态</span><br>[root@centos8 ~]<span class="hljs-comment">#ps -ef|grep redis</span><br>redis  1939   1  0 10:54 ?   00:00:00 /usr/bin/redis-server 0.0.0.0:6379<br>[cluster]<br>root   1955  1335  0 10:57 pts/0   00:00:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-7-查看cluster状态"><a href="#3-3-5-7-查看cluster状态" class="headerlink" title="3.3.5.7 查看cluster状态"></a>3.3.5.7 查看cluster状态</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ps -ef|grep redis</span><br>redis      5746      1  0 20:53 ?        00:00:00 /apps/redis/bin/redis-server 0.0.0.0:6379 [cluster]<br>root       5754   1379  0 20:55 pts/0    00:00:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-8-创建集群"><a href="#3-3-5-8-创建集群" class="headerlink" title="3.3.5.8 创建集群"></a>3.3.5.8 创建集群</h4><p><code>--cluster create</code> 表示创建集群</p>
<p><code>--cluster-replicas 1</code> 表示每个master对应一个slave节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning --cluster create 10.0.0.7:6379 10.0.0.17:6379 10.0.0.27:6379 10.0.0.37:6379 10.0.0.47:6379 10.0.0.57:6379 --cluster-replicas 1</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>&gt;&gt;&gt; Performing <span class="hljs-built_in">hash</span> slots allocation on 6 nodes...<br>Master[0] -&gt; Slots 0 - 5460<br>Master[1] -&gt; Slots 5461 - 10922<br>Master[2] -&gt; Slots 10923 - 16383<br>Adding replica 10.0.0.47:6379 to 10.0.0.7:6379<br>Adding replica 10.0.0.57:6379 to 10.0.0.17:6379<br>Adding replica 10.0.0.37:6379 to 10.0.0.27:6379<br>M: 1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379  <span class="hljs-comment">#带M的为master</span><br>   slots:[0-5460] (5461 slots) master  <span class="hljs-comment">#当前master的槽位起始和结束位</span><br>M: ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379<br>   slots:[5461-10922] (5462 slots) master<br>M: cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379<br>   slots:[10923-16383] (5461 slots) master<br>S: 35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379 <span class="hljs-comment">#带S的slave</span><br>   replicates cc3ab037bf9ff76438b6f16e43fab783ec915375<br>S: 50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379<br>   replicates 1969ea14c7dda04279a6457ff9aac71c181c9b86<br>S: d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379<br>   replicates ccef8619ee263fad8652562288dc3df9456ed97a<br>Can I <span class="hljs-built_in">set</span> the above configuration? (<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;yes&#x27;</span> to accept): yes    <span class="hljs-comment">#输入yes自动创建集群</span><br>&gt;&gt;&gt; Nodes configuration updated<br>&gt;&gt;&gt; Assign a different config epoch to each node<br>&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster<br>Waiting <span class="hljs-keyword">for</span> the cluster to join<br>...<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)<br>M: 1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379<br>   slots:[0-5460] (5461 slots) master <span class="hljs-comment">#已经分配的槽位</span><br>   1 additional replica(s) <span class="hljs-comment">#分配了一个slave</span><br>S: 35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379 <span class="hljs-comment">#对应的master的10.0.0.27的ID</span><br>   slots: (0 slots) slave <span class="hljs-comment">#slave没有分配槽位</span><br>   replicates cc3ab037bf9ff76438b6f16e43fab783ec915375<br>S: 50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379 <span class="hljs-comment">#对应的master的10.0.0.7的ID</span><br>   slots: (0 slots) slave<br>   replicates 1969ea14c7dda04279a6457ff9aac71c181c9b86<br>S: d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379 <span class="hljs-comment">#对应的master的10.0.0.17的</span><br>   slots: (0 slots) slave<br>   replicates ccef8619ee263fad8652562288dc3df9456ed97a<br>M: cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>M: ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379<br>   slots:[5461-10922] (5462 slots) master<br>   1 additional replica(s)<br>[OK] All nodes agree about slots configuration. <span class="hljs-comment">#所有节点槽位分配完成</span><br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots... <span class="hljs-comment">#检查打开的槽位</span><br>&gt;&gt;&gt; Check slots coverage... <span class="hljs-comment">#检查插槽覆盖范围</span><br>[OK] All 16384 slots covered. <span class="hljs-comment">#所有槽位(16384个)分配完成</span><br><br><span class="hljs-comment">#观察以上结果，可以看到3组master/slave</span><br>master:10.0.0.7---slave:10.0.0.47<br>master:10.0.0.17---slave:10.0.0.57<br>master:10.0.0.27---slave:10.0.0.37<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-9-查看各节点主从状态"><a href="#3-3-5-9-查看各节点主从状态" class="headerlink" title="3.3.5.9 查看各节点主从状态"></a>3.3.5.9 查看各节点主从状态</h4><h5 id="3-3-5-9-1-master1状态"><a href="#3-3-5-9-1-master1状态" class="headerlink" title="3.3.5.9.1 master1状态"></a>3.3.5.9.1 master1状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.7 --no-auth-warning -c INFO replication</span><br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.47,port=6379,state=online,offset=896,lag=1<br>master_replid:f2fc8bd6177aa5b7091adf16a6251caf297af68b<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:896<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:896<br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-9-2-master2状态"><a href="#3-3-5-9-2-master2状态" class="headerlink" title="3.3.5.9.2 master2状态"></a>3.3.5.9.2 master2状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.17 --no-auth-warning -c INFO replication</span><br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.57,port=6379,state=online,offset=924,lag=0<br>master_replid:ebfea92d922f5a62b68abdd8b214895046523656<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:924<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:924<br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-9-3-master3状态"><a href="#3-3-5-9-3-master3状态" class="headerlink" title="3.3.5.9.3 master3状态"></a>3.3.5.9.3 master3状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.27 --no-auth-warning -c INFO replication</span><br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.37,port=6379,state=online,offset=966,lag=1<br>master_replid:e598d05f73afab0c598f45762d54201f094b03ec<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:966<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:966<br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-9-4-slave1状态"><a href="#3-3-5-9-4-slave1状态" class="headerlink" title="3.3.5.9.4 slave1状态"></a>3.3.5.9.4 slave1状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.37 --no-auth-warning -c INFO replication</span><br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.27<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:4<br>master_sync_in_progress:0<br>slave_repl_offset:1008<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:e598d05f73afab0c598f45762d54201f094b03ec<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1008<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1008<br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-9-5-slave2状态"><a href="#3-3-5-9-5-slave2状态" class="headerlink" title="3.3.5.9.5 slave2状态"></a>3.3.5.9.5 slave2状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.47 --no-auth-warning -c INFO replication</span><br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.7<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:9<br>master_sync_in_progress:0<br>slave_repl_offset:1036<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:f2fc8bd6177aa5b7091adf16a6251caf297af68b<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1036<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1036<br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-9-6-slave3状态"><a href="#3-3-5-9-6-slave3状态" class="headerlink" title="3.3.5.9.6 slave3状态"></a>3.3.5.9.6 slave3状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.57 --no-auth-warning -c INFO replication</span><br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.17<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:10<br>master_sync_in_progress:0<br>slave_repl_offset:1064<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:ebfea92d922f5a62b68abdd8b214895046523656<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1064<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1064<br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-9-7-查看所有master节点对应的slave节点"><a href="#3-3-5-9-7-查看所有master节点对应的slave节点" class="headerlink" title="3.3.5.9.7 查看所有master节点对应的slave节点"></a>3.3.5.9.7 查看所有master节点对应的slave节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning  cluster nodes</span><br>35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379@16379 slave cc3ab037bf9ff76438b6f16e43fab783ec915375 0 1669036697000 4 connected<br>50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379@16379 slave 1969ea14c7dda04279a6457ff9aac71c181c9b86 0 1669036694000 5 connected<br>d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379@16379 slave ccef8619ee263fad8652562288dc3df9456ed97a 0 1669036696817 6 connected<br>cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379@16379 master - 0 1669036697823 3 connected 10923-16383<br>1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379@16379 myself,master - 0 1669036695000 1 connected 0-5460<br>ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379@16379 master - 0 1669036696000 2 connected 5461-10922<br><br><span class="hljs-comment">#以下命令查看指定master节点的slave节点信息,其中“1969ea14c7dda04279a6457ff9aac71c181c9b86”为master节点的ID</span><br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning cluster slaves 1969ea14c7dda04279a6457ff9aac71c181c9b86</span><br>1) <span class="hljs-string">&quot;50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379@16379 slave 1969ea14c7dda04279a6457ff9aac71c181c9b86 0 1669036940307 5 connected&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-10-验证集群状态"><a href="#3-3-5-10-验证集群状态" class="headerlink" title="3.3.5.10 验证集群状态"></a>3.3.5.10 验证集群状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning CLUSTER INFO</span><br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:6 <span class="hljs-comment">#节点数</span><br>cluster_size:3 <span class="hljs-comment">#三个集群</span><br>cluster_current_epoch:6<br>cluster_my_epoch:1<br>cluster_stats_messages_ping_sent:1085<br>cluster_stats_messages_pong_sent:1186<br>cluster_stats_messages_sent:2271<br>cluster_stats_messages_ping_received:1181<br>cluster_stats_messages_pong_received:1085<br>cluster_stats_messages_meet_received:5<br>cluster_stats_messages_received:2271<br><br><span class="hljs-comment">#查看任意节点的集群状态</span><br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning --cluster info 10.0.0.37:6379</span><br>10.0.0.7:6379 (1969ea14...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>10.0.0.27:6379 (cc3ab037...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>10.0.0.17:6379 (ccef8619...) -&gt; 0 keys | 5462 slots | 1 slaves.<br>[OK] 0 keys <span class="hljs-keyword">in</span> 3 masters.<br>0.00 keys per slot on average.<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-11-查看集群node对应关系"><a href="#3-3-5-11-查看集群node对应关系" class="headerlink" title="3.3.5.11 查看集群node对应关系"></a>3.3.5.11 查看集群node对应关系</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning CLUSTER NODES</span><br>35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379@16379 slave cc3ab037bf9ff76438b6f16e43fab783ec915375 0 1669037090286 4 connected<br>50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379@16379 slave 1969ea14c7dda04279a6457ff9aac71c181c9b86 0 1669037092297 5 connected<br>d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379@16379 slave ccef8619ee263fad8652562288dc3df9456ed97a 0 1669037091293 6 connected<br>cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379@16379 master - 0 1669037089000 3 connected 10923-16383<br>1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379@16379 myself,master - 0 1669037091000 1 connected 0-5460<br>ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379@16379 master - 0 1669037089282 2 connected 5461-10922<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-12-检查集群节点"><a href="#3-3-5-12-检查集群节点" class="headerlink" title="3.3.5.12 检查集群节点"></a>3.3.5.12 检查集群节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning --cluster check 10.0.0.37:6379</span><br>10.0.0.7:6379 (1969ea14...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>10.0.0.27:6379 (cc3ab037...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>10.0.0.17:6379 (ccef8619...) -&gt; 0 keys | 5462 slots | 1 slaves.<br>[OK] 0 keys <span class="hljs-keyword">in</span> 3 masters.<br>0.00 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.37:6379)<br>S: 35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379<br>   slots: (0 slots) slave<br>   replicates cc3ab037bf9ff76438b6f16e43fab783ec915375<br>S: 50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379<br>   slots: (0 slots) slave<br>   replicates 1969ea14c7dda04279a6457ff9aac71c181c9b86<br>M: 1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>M: cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>M: ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379<br>   slots:[5461-10922] (5462 slots) master<br>   1 additional replica(s)<br>S: d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379<br>   slots: (0 slots) slave<br>   replicates ccef8619ee263fad8652562288dc3df9456ed97a<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-12-验证集群写入key"><a href="#3-3-5-12-验证集群写入key" class="headerlink" title="3.3.5.12 验证集群写入key"></a>3.3.5.12 验证集群写入key</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis133.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-3-5-12-1-redis-cluster-写入key"><a href="#3-3-5-12-1-redis-cluster-写入key" class="headerlink" title="3.3.5.12.1 redis cluster 写入key"></a>3.3.5.12.1 redis cluster 写入key</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#经过算法计算，当前key的槽位需要写入指定的node</span><br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning -h 10.0.0.7 set key1 k1</span><br>(error) MOVED 9189 10.0.0.17:6379 <span class="hljs-comment">#槽位不在当前node所以无法写入</span><br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning -h 10.0.0.17 set key1 k1</span><br>OK<br><span class="hljs-comment">#指定node可写入</span><br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning -h 10.0.0.17 get key1</span><br><span class="hljs-string">&quot;k1&quot;</span><br><span class="hljs-comment">#对应的slave节点可以使用“KEYS *”查看key</span><br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning -h 10.0.0.7 keys &quot;*&quot;</span><br>(empty list or <span class="hljs-built_in">set</span>)<br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning -h 10.0.0.7 get key1</span><br>(error) MOVED 9189 10.0.0.17:6379<br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning -h 10.0.0.17 keys &quot;*&quot;</span><br>1) <span class="hljs-string">&quot;key1&quot;</span><br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning -h 10.0.0.57 keys &quot;*&quot;</span><br>1) <span class="hljs-string">&quot;key1&quot;</span><br><br><span class="hljs-comment">#但不能回去value值，只能到对应的master里获取value值</span><br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning -h 10.0.0.57 get key1</span><br>(error) MOVED 9189 10.0.0.17:6379<br><span class="hljs-comment"># redis-cli -a 123456 --no-auth-warning -h 10.0.0.17 get key1</span><br><span class="hljs-string">&quot;k1&quot;</span><br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-12-2-redis-cluster-计算key所属的slot"><a href="#3-3-5-12-2-redis-cluster-计算key所属的slot" class="headerlink" title="3.3.5.12.2 redis cluster 计算key所属的slot"></a>3.3.5.12.2 redis cluster 计算key所属的slot</h5><p><strong>通过计算得到key对应的slot（槽位），通过各集群所分配到的slot（槽位）来存储key和value</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -h 10.0.0.7 -a 123456 --no-auth-warning cluster keyslot hello</span><br>(<span class="hljs-built_in">integer</span>) 866<br><span class="hljs-comment"># redis-cli -h 10.0.0.7 -a 123456 --no-auth-warning set hello world</span><br>OK<br><span class="hljs-comment"># redis-cli -h 10.0.0.7 -a 123456 --no-auth-warning cluster keyslot name</span><br>(<span class="hljs-built_in">integer</span>) 5798<br><span class="hljs-comment"># redis-cli -h 10.0.0.7 -a 123456 --no-auth-warning set name rlin</span><br>(error) MOVED 5798 10.0.0.17:6379<br><span class="hljs-comment"># redis-cli -h 10.0.0.17 -a 123456 --no-auth-warning set name rlin</span><br>OK      <br><span class="hljs-comment"># redis-cli -h 10.0.0.17 -a 123456 --no-auth-warning get name</span><br><span class="hljs-string">&quot;rlin&quot;</span><br></code></pre></td></tr></table></figure>

<p><strong>还可以通过使用<code>-c</code>以集群模式连接redis或直接取值赋值，这样可以避免繁杂的运算，可以快速的对集群进行读写。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -c -h 10.0.0.7 -a 123456 --no-auth-warning</span><br>10.0.0.7:6379&gt; cluster keyslot linux<br>(<span class="hljs-built_in">integer</span>) 12299<br>10.0.0.7:6379&gt; <span class="hljs-built_in">set</span> linux unix<br>-&gt; Redirected to slot [12299] located at 10.0.0.27:6379<br>OK<br>10.0.0.27:6379&gt; get linux<br><span class="hljs-string">&quot;unix&quot;</span><br><span class="hljs-comment">#或</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.7 -a 123456 --no-auth-warning -c set plan1 p1</span><br>OK<br><br><span class="hljs-comment">#验证，注意命令所输入的IP</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.27 -a 123456 --no-auth-warning get plan1 #没有使用“-c”时，需要根据key来改变节点</span><br>(error) MOVED 10602 10.0.0.17:6379<br><span class="hljs-comment"># redis-cli -h 10.0.0.17 -a 123456 --no-auth-warning get plan1</span><br><span class="hljs-string">&quot;p1&quot;</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.27 -a 123456 --no-auth-warning -c get plan1</span><br><span class="hljs-string">&quot;p1&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-13-python脚本实现RedisCluster集群写入"><a href="#3-3-5-13-python脚本实现RedisCluster集群写入" class="headerlink" title="3.3.5.13 python脚本实现RedisCluster集群写入"></a>3.3.5.13 python脚本实现RedisCluster集群写入</h4><h5 id="3-3-5-13-1-安装python3和python对应的cluser写入工具"><a href="#3-3-5-13-1-安装python3和python对应的cluser写入工具" class="headerlink" title="3.3.5.13.1 安装python3和python对应的cluser写入工具"></a>3.3.5.13.1 安装python3和python对应的cluser写入工具</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum -y install python3</span><br><span class="hljs-comment"># pip3 install redis-py-cluster</span><br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-13-2-编写Python脚本"><a href="#3-3-5-13-2-编写Python脚本" class="headerlink" title="3.3.5.13.2 编写Python脚本"></a>3.3.5.13.2 编写Python脚本</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs SH"><span class="hljs-comment"># vim redis_cluster_test.py</span><br><span class="hljs-comment">#!/usr/bin/env python3</span><br>from rediscluster import RedisCluster<br>startup_nodes = [<br>    &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.7&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:6379&#125;,<br>    &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.17&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:6379&#125;,<br>    &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.27&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:6379&#125;,<br>    &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.37&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:6379&#125;,<br>    &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.47&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:6379&#125;,<br>    &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.57&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:6379&#125;<br>]<br>redis_conn= RedisCluster(startup_nodes=startup_nodes,password=<span class="hljs-string">&#x27;123456&#x27;</span>, decode_responses=True)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(0, 10000):<br>    redis_conn.set(<span class="hljs-string">&#x27;key&#x27;</span>+str(i),<span class="hljs-string">&#x27;value&#x27;</span>+str(i))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;key&#x27;</span>+str(i)+<span class="hljs-string">&#x27;:&#x27;</span>,redis_conn.get(<span class="hljs-string">&#x27;key&#x27;</span>+str(i)))<br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-13-3-执行脚本"><a href="#3-3-5-13-3-执行脚本" class="headerlink" title="3.3.5.13.3 执行脚本"></a>3.3.5.13.3 执行脚本</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># chmod +x redis_cluster_test.py</span><br><span class="hljs-comment"># ./redis_cluster_test.py</span><br>......<br>key9998: value9998<br>key9999: value9999<br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-13-4-redis查看结果"><a href="#3-3-5-13-4-redis查看结果" class="headerlink" title="3.3.5.13.4 redis查看结果"></a>3.3.5.13.4 redis查看结果</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#redis-cli -a 123456 -h 10.0.0.7</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.8:6379&gt; DBSIZE<br>(<span class="hljs-built_in">integer</span>) 3331<br>10.0.0.8:6379&gt; GET key1<br>(error) MOVED 9189 10.0.0.17:6379<br>10.0.0.8:6379&gt; GET key2<br><span class="hljs-string">&quot;value2&quot;</span><br>10.0.0.8:6379&gt; GET key3<br><span class="hljs-string">&quot;value3&quot;</span><br>10.0.0.8:6379&gt; KEYS *<br>......<br>3329) <span class="hljs-string">&quot;key7832&quot;</span><br>3330) <span class="hljs-string">&quot;key2325&quot;</span><br>3331) <span class="hljs-string">&quot;key2880&quot;</span><br><br><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.17 DBSIZE</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>(<span class="hljs-built_in">integer</span>) 3342<br><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.27 -c keys &quot;*&quot;</span><br>......<br>3328) <span class="hljs-string">&quot;key79&quot;</span><br>3329) <span class="hljs-string">&quot;key6124&quot;</span><br>3330) <span class="hljs-string">&quot;key3086&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-14-模拟master故障，对应的slave节点自动提升为新master"><a href="#3-3-5-14-模拟master故障，对应的slave节点自动提升为新master" class="headerlink" title="3.3.5.14 模拟master故障，对应的slave节点自动提升为新master"></a>3.3.5.14 模拟master故障，对应的slave节点自动提升为新master</h4><p><strong>模拟node2节点出故障,需要相应的数秒故障转移时间，在对应的slave节点的日志上会出现“Failover election won: I’m the new master.”</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-cli -a 123456</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>127.0.0.1:6379&gt; shutdown<br>not connected&gt; <span class="hljs-built_in">exit</span><br><br><span class="hljs-comment"># ss -tnl</span><br>State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port              <br>LISTEN     0      128                             *:22                                          *:*                  <br>LISTEN     0      128                          [::]:22                                       [::]:*<br><br><span class="hljs-comment"># redis-cli -a 123456 --cluster info 10.0.0.7:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>Could not connect to Redis at 10.0.0.17:6379: Connection refused<br>10.0.0.7:6379 (1969ea14...) -&gt; 3332 keys | 5461 slots | 1 slaves.<br>10.0.0.57:6379 (d1fd7d43...) -&gt; 3342 keys | 5462 slots | 0 slaves. <span class="hljs-comment">#10.0.0.57为新的master</span><br>10.0.0.27:6379 (cc3ab037...) -&gt; 3330 keys | 5461 slots | 1 slaves.<br>[OK] 10004 keys <span class="hljs-keyword">in</span> 3 masters.<br>0.61 keys per slot on average.<br><br><span class="hljs-comment"># redis-cli -a 123456 --cluster check 10.0.0.7:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>Could not connect to Redis at 10.0.0.17:6379: Connection refused<br>10.0.0.7:6379 (1969ea14...) -&gt; 3332 keys | 5461 slots | 1 slaves.<br>10.0.0.57:6379 (d1fd7d43...) -&gt; 3342 keys | 5462 slots | 0 slaves.<br>10.0.0.27:6379 (cc3ab037...) -&gt; 3330 keys | 5461 slots | 1 slaves.<br>[OK] 10004 keys <span class="hljs-keyword">in</span> 3 masters.<br>0.61 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)<br>M: 1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>S: 35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379<br>   slots: (0 slots) slave<br>   replicates cc3ab037bf9ff76438b6f16e43fab783ec915375<br>S: 50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379<br>   slots: (0 slots) slave<br>   replicates 1969ea14c7dda04279a6457ff9aac71c181c9b86<br>M: d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379<br>   slots:[5461-10922] (5462 slots) master<br>M: cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.57</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.57:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:0<br>master_replid:15d2d9fdb1ee6202423c94cc6fb6d3b48478da5c<br>master_replid2:ebfea92d922f5a62b68abdd8b214895046523656<br>master_repl_offset:149935<br>second_repl_offset:149936<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:149935<br><br><span class="hljs-comment">#恢复故障节点master2</span><br><span class="hljs-comment"># systemctl restart redis</span><br><br><span class="hljs-comment">#查看日志可知，master2成为slave3的slave节点</span><br><span class="hljs-comment"># tail -f /apps/redis/log/redis-6379.log</span><br>5615:M 22 Nov 2022 11:38:33.698 <span class="hljs-comment"># Configuration change detected. Reconfiguring myself as a replica of d1fd7d43a18ea97e32d7633ac0f780c282fa0570</span><br>5615:S 22 Nov 2022 11:38:33.698 * Before turning into a replica, using my master parameters to synthesize a cached master: I may be able to synchronize with the new master with just a partial transfer.<br>5615:S 22 Nov 2022 11:38:33.698 <span class="hljs-comment"># Cluster state changed: ok</span><br>5615:S 22 Nov 2022 11:38:34.818 * Connecting to MASTER 10.0.0.57:6379<br>5615:S 22 Nov 2022 11:38:34.819 * MASTER &lt;-&gt; REPLICA sync started<br>5615:S 22 Nov 2022 11:38:34.819 * Non blocking connect <span class="hljs-keyword">for</span> SYNC fired the event.<br>5615:S 22 Nov 2022 11:38:34.819 * Master replied to PING, replication can <span class="hljs-built_in">continue</span>...<br>5615:S 22 Nov 2022 11:38:34.820 * Trying a partial resynchronization (request 4cd7bf373ef02285e46bd2b1e83fa1a31397f5f8:1).<br>5615:S 22 Nov 2022 11:38:34.820 * Full resync from master: 15d2d9fdb1ee6202423c94cc6fb6d3b48478da5c:149935<br>5615:S 22 Nov 2022 11:38:34.820 * Discarding previously cached master state.<br>5615:S 22 Nov 2022 11:38:34.912 * MASTER &lt;-&gt; REPLICA sync: receiving 62919 bytes from master<br>5615:S 22 Nov 2022 11:38:34.913 * MASTER &lt;-&gt; REPLICA sync: Flushing old data<br>5615:S 22 Nov 2022 11:38:34.914 * MASTER &lt;-&gt; REPLICA sync: Loading DB <span class="hljs-keyword">in</span> memory<br>5615:S 22 Nov 2022 11:38:34.916 * MASTER &lt;-&gt; REPLICA sync: Finished with success<br><br><span class="hljs-comment">#通过redis客户端也可以看到master2节点成为了slave3的slave点</span><br><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.17 -c cluster nodes</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379@16379 master - 0 1669088411000 1 connected 0-5460<br>35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379@16379 slave cc3ab037bf9ff76438b6f16e43fab783ec915375 0 1669088411880 4 connected<br>50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379@16379 slave 1969ea14c7dda04279a6457ff9aac71c181c9b86 0 1669088410000 5 connected<br>d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379@16379 myself,master - 0 1669088409000 7 connected 5461-10922<br>cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379@16379 master - 0 1669088410000 3 connected 10923-16383<br>ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379@16379 slave d1fd7d43a18ea97e32d7633ac0f780c282fa0570 0 1669088409866 7 connected<br><br><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.17</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.17:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.57<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:1<br>master_sync_in_progress:0<br>slave_repl_offset:150425<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:15d2d9fdb1ee6202423c94cc6fb6d3b48478da5c<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:150425<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:149936<br>repl_backlog_histlen:490<br></code></pre></td></tr></table></figure>

<h3 id="3-3-6-实战案例：基于-Redis-4-的-redis-cluster-部署（用3台主机模拟6个redis）"><a href="#3-3-6-实战案例：基于-Redis-4-的-redis-cluster-部署（用3台主机模拟6个redis）" class="headerlink" title="3.3.6 实战案例：基于 Redis 4 的 redis cluster 部署（用3台主机模拟6个redis）"></a>3.3.6 实战案例：基于 Redis 4 的 redis cluster 部署（用3台主机模拟6个redis）</h3><h4 id="3-3-5-1-准备redis-Cluster-基本配置"><a href="#3-3-5-1-准备redis-Cluster-基本配置" class="headerlink" title="3.3.5.1 准备redis Cluster 基本配置"></a>3.3.5.1 准备redis Cluster 基本配置</h4><ol>
<li>每个redis 节点采用相同的硬件配置、相同的密码、相同的redis版本</li>
<li>所有redis服务器必须没有任何数据</li>
<li>准备三台CentOS 7 主机，已编译安装好redis，各启动两个redis实例，分别使用6379和6380端口，从而模拟实现6台redis实例</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">10.0.0.7:6379|6380<br>10.0.0.17:6379|6380<br>10.0.0.27:6379|6380<br></code></pre></td></tr></table></figure>

<p>范例: 3个物理节点环境的基于脚本安装后批量修改配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#sed -i -e &#x27;/^# masterauth/a masterauth 123456&#x27; -e &#x27;/# cluster-enabled yes/a cluster-enabled yes&#x27; -e &#x27;/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf&#x27;  -e &#x27;/cluster-require-full-coverage yes/c cluster-require-full-coverage no&#x27; /apps/redis/etc/redis.conf</span><br><br>[root@centos7 ~]<span class="hljs-comment">#grep &#x27;^[^#]&#x27; /apps/redis/etc/redis.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br>protected-mode yes<br>port 6379<br>tcp-backlog 511<br>timeout 0<br>tcp-keepalive 300<br>daemonize no<br>supervised no<br>pidfile /apps/redis/run/redis_6379.pid<br>loglevel notice<br>logfile /apps/redis/<span class="hljs-built_in">log</span>/redis-6379.log<br>databases 16<br>always-show-logo yes<br>save 900 1<br>save 300 10<br>save 60 10000<br>stop-writes-on-bgsave-error yes<br>rdbcompression yes<br>rdbchecksum yes<br>dbfilename dump.rdb<br>dir /apps/redis/data/<br>masterauth 123456<br>slave-serve-stale-data yes<br>slave-read-only yes<br>repl-diskless-sync no<br>repl-diskless-sync-delay 5<br>repl-disable-tcp-nodelay no<br>slave-priority 100<br>requirepass 123456<br>lazyfree-lazy-eviction no<br>lazyfree-lazy-expire no<br>lazyfree-lazy-server-del no<br>slave-lazy-flush no<br>appendonly no<br>appendfilename <span class="hljs-string">&quot;appendonly.aof&quot;</span><br>appendfsync everysec<br>no-appendfsync-on-rewrite no<br>auto-aof-rewrite-percentage 100<br>auto-aof-rewrite-min-size 64mb<br>aof-load-truncated yes<br>aof-use-rdb-preamble no<br>lua-time-limit 5000<br>cluster-enabled yes<br>cluster-config-file nodes-6379.conf<br>cluster-require-full-coverage no<br>slowlog-log-slower-than 10000<br>slowlog-max-len 128<br>latency-monitor-threshold 0<br>notify-keyspace-events <span class="hljs-string">&quot;&quot;</span><br>hash-max-ziplist-entries 512<br>hash-max-ziplist-value 64<br>list-max-ziplist-size -2<br>list-compress-depth 0<br>set-max-intset-entries 512<br>zset-max-ziplist-entries 128<br>zset-max-ziplist-value 64<br>hll-sparse-max-bytes 3000<br>activerehashing yes<br>client-output-buffer-limit normal 0 0 0<br>client-output-buffer-limit slave 256mb 64mb 60<br>client-output-buffer-limit pubsub 32mb 8mb 60<br>hz 10<br>aof-rewrite-incremental-fsync yes<br></code></pre></td></tr></table></figure>

<p><strong>准备3个实例：在三个主机上重复下面的操作</strong><br>范例: 3个节点，基于手动编译安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在三台主机上都编译安装redis</span><br>[root@redis-node1 ~]<span class="hljs-comment">#yum -y install gcc jemalloc-devel</span><br>[root@redis-node1 ~]<span class="hljs-comment">#cd /usr/local/src</span><br>[root@redis-node1 src]<span class="hljs-comment">#wget http://download.redis.io/releases/redis-</span><br>4.0.14.tar.gz<br>[root@redis-node1 src]<span class="hljs-comment">#tar xf redis-4.0.14.tar.gz</span><br>[root@redis-node1 src]<span class="hljs-comment">#cd redis-4.0.14</span><br>[root@redis-node1 redis-4.0.14]<span class="hljs-comment">#make PREFIX=/apps/redis install</span><br><br><span class="hljs-comment">#准备相关文件和目录</span><br>[root@redis-node1 redis-4.0.14]<span class="hljs-comment">#ln -s /apps/redis/bin/redis-* /usr/bin/</span><br>[root@redis-node1 redis-4.0.14]<span class="hljs-comment">#mkdir -p /apps/redis/&#123;etc,log,data,run&#125;</span><br>[root@redis-node1 redis-4.0.14]<span class="hljs-comment">#cp redis.conf /apps/redis/etc/</span><br><br><span class="hljs-comment">#准备用户</span><br>[root@redis-node1 ~]<span class="hljs-comment">#useradd -r -s /sbin/nologin redis</span><br><br><span class="hljs-comment">#配置权限和相关优化配置</span><br>[root@redis-node1 ~]<span class="hljs-comment">#chown -R redis.redis /apps/redis</span><br>[root@redis-node1 ~]<span class="hljs-comment">#cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF</span><br>net.core.somaxconn = 1024<br>vm.overcommit_memory = 1<br>EOF<br>[root@redis-node1 ~]<span class="hljs-comment">#sysctl -p</span><br>[root@redis-node1 ~]<span class="hljs-comment">#echo &#x27;echo never &gt;</span><br>/sys/kernel/mm/transparent_hugepage/enabled<span class="hljs-string">&#x27; &gt;&gt; /etc/rc.d/rc.local</span><br><span class="hljs-string">[root@redis-node1 ~]#chmod +x /etc/rc.d/rc.local</span><br><span class="hljs-string">[root@redis-node1 ~]#/etc/rc.d/rc.local</span><br><span class="hljs-string"></span><br><span class="hljs-string">#准备service文件</span><br><span class="hljs-string">[root@redis-node1 ~]#cat &gt; /usr/lib/systemd/system/redis.service &lt;&lt;EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description=Redis persistent key-value database</span><br><span class="hljs-string">After=network.target</span><br><span class="hljs-string"></span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">ExecStart=/apps/redis/bin/redis-server /apps/redis/etc/redis.conf --supervised</span><br><span class="hljs-string">systemd</span><br><span class="hljs-string">ExecStop=/bin/kill -s QUIT \$MAINPID</span><br><span class="hljs-string">Type=notify</span><br><span class="hljs-string">User=redis</span><br><span class="hljs-string">Group=redis</span><br><span class="hljs-string">RuntimeDirectory=redis</span><br><span class="hljs-string">RuntimeDirectoryMode=0755</span><br><span class="hljs-string"></span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string"></span><br><span class="hljs-string">EOF</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@redis-node1 ~]#systemctl daemon-reload</span><br><span class="hljs-string">[root@redis-node1 ~]#systemctl enable --now redis</span><br><span class="hljs-string"></span><br><span class="hljs-string">#准备6379的实例配置文件</span><br><span class="hljs-string">[root@redis-node1 ~]#systemctl stop redis</span><br><span class="hljs-string">[root@redis-node1 ~]#cd /apps/redis/etc/</span><br><span class="hljs-string">[root@redis-node1 etc]#sed -i -e &#x27;</span>s/<span class="hljs-built_in">bind</span> 127.0.0.1/<span class="hljs-built_in">bind</span> 0.0.0.0/<span class="hljs-string">&#x27; -e &#x27;</span>/^<span class="hljs-comment"># masterauth/a masterauth 123456&#x27; -e &#x27;/# requirepass/a requirepass 123456&#x27; -e &#x27;/#cluster-enabled yes/a cluster-enabled yes&#x27; -e &#x27;/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf&#x27; -e &#x27;s/^dir .*/dir \/apps\/redis\/data/&#x27; -e &#x27;/appendonly no/c appendonly yes&#x27; -e &#x27;/logfile &quot;&quot;/c logfile &quot;/apps/redis/log/redis-6379.log&quot;&#x27; -e &#x27;/^pidfile .*/c pidfile/apps/redis/run/redis_6379.pid&#x27; /apps/redis/etc/redis.conf</span><br><br><span class="hljs-comment">#准备6380端口的实例的配置文件</span><br>[root@redis-node1 etc]<span class="hljs-comment">#cp -p redis.conf redis6380.conf</span><br>[root@redis-node1 etc]<span class="hljs-comment">#sed -i -e &#x27;s/6379/6380/&#x27; -e &#x27;s/dbfilename dump\.rdb/dbfilename dump6380.rdb/&#x27; -e &#x27;s/appendfilename &quot;appendonly\.aof&quot;/appendfilename &quot;appendonly6380.aof&quot;/&#x27; /apps/redis/etc/redis6380.conf</span><br><br>准备服务文件<br>[root@redis-node1 ~]<span class="hljs-comment">#cp /lib/systemd/system/redis.service /lib/systemd/system/redis6380.service</span><br>[root@redis-node1 ~]<span class="hljs-comment">#sed -i &#x27;s/redis.conf/redis6380.conf/&#x27; /lib/systemd/system/redis6380.service</span><br><br><span class="hljs-comment">#启动服务，查看到端口都打开</span><br>[root@redis-node1 ~]<span class="hljs-comment">#systemctl daemon-reload</span><br>[root@redis-node1 ~]<span class="hljs-comment">#systemctl enable --now redis redis6380</span><br>[root@redis-node1 ~]<span class="hljs-comment">#ss -ntl</span><br>State    Recv-Q Send-Q  Local Address:Port   Peer Address:Port      <br>LISTEN    0    100      127.0.0.1:25         *:*       <br> <br>LISTEN    0    128         *:16379        *:*       <br> <br>LISTEN    0    128         *:16380        *:*    <br><br>LISTEN    0    128         *:6379        *:*       <br> <br>LISTEN    0    128         *:6380        *:*       <br> <br>LISTEN    0    128         *:22         *:*       <br> <br>LISTEN    0    100       [::1]:25        [::]:*       <br> <br>LISTEN    0    128        [::]:22        [::]:*      <br><br>root@redis-node1 ~]<span class="hljs-comment">#ps -ef|grep redis</span><br>redis 71539  1  0 22:13 ?  00:00:00 /apps/redis/bin/redis-server 0.0.0.0:6379<br>[cluster]<br>redis 71543  1  0 22:13 ?  00:00:00 /apps/redis/bin/redis-server 0.0.0.0:6380<br>[cluster]<br>root  71553  31781  0 22:15 pts/0 00:00:00 grep --color=auto redis<br><br>[root@redis-node1 ~]<span class="hljs-comment">#tree /apps/redis/</span><br>/apps/redis<br>├── bin<br>│  ├── redis-benchmark<br>│  ├── redis-check-aof<br>│  ├── redis-check-rdb<br>│  ├── redis-cli<br>│  ├── redis-sentinel -&gt; redis-server<br>│  └── redis-server<br>├── data<br>│  ├── appendonly6380.aof<br>│  ├── appendonly.aof<br>│  ├── nodes-6379.conf<br>│  └── nodes-6380.conf<br>├── etc<br>│  ├── redis6380.conf<br>│  └── redis.conf<br>├── <span class="hljs-built_in">log</span><br>│  ├── redis-6379.log<br>│  └── redis-6380.log<br>└── run<br> ├── redis_6379.pid<br> └── redis_6380.pid<br><br>5 directories, 16 files<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-2-准备redis-trib-rb工具"><a href="#3-3-5-2-准备redis-trib-rb工具" class="headerlink" title="3.3.5.2 准备redis-trib.rb工具"></a>3.3.5.2 准备redis-trib.rb工具</h4><p>Redis 3和 4版本需要使用到集群管理工具redis-trib.rb，这个工具是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具，redis-trib.rb是redis作者用ruby开发完成的，centos 7 系统yum安装的ruby存在版本较低问题，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#find / -name redis-trib.rb</span><br>/usr/<span class="hljs-built_in">local</span>/src/redis-4.0.14/src/redis-trib.rb<br>[root@redis-node1 ~]<span class="hljs-comment">#cp /usr/local/src/redis-4.0.14/src/redis-trib.rb /usr/bin/</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb #缺少ruby环境无法运行rb脚本</span><br>/usr/bin/env: ruby: No such file or directory<br><br><span class="hljs-comment">#CentOS 7带的ruby版本过低,无法运行上面ruby脚本,需要安装2.3以上版本,安装rubygems依赖ruby自</span><br>动安装<br>[root@redis-node1 ~]<span class="hljs-comment">#yum install rubygems -y </span><br>[root@redis-node1 ~]<span class="hljs-comment">#gem install redis #gem相当于python里pip和linux的yum</span><br>Fetching: redis-4.1.3.gem (100%)<br>ERROR: Error installing redis:<br>redis requires Ruby version &gt;= 2.3.0.<br></code></pre></td></tr></table></figure>

<p>解决ruby版本较低问题：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#yum -y install gcc openssl-devel zlib-devel</span><br>[root@redis-node1 ~]<span class="hljs-comment">#wget https://cache.ruby-lang.org/pub/ruby/2.5/ruby-2.5.5.tar.gz</span><br>[root@redis-node1 ~]<span class="hljs-comment">#tar xf ruby-2.5.5.tar.gz</span><br>[root@redis-node1 ~]<span class="hljs-comment">#cd ruby-2.5.5</span><br>[root@redis-node1 ruby-2.5.5]<span class="hljs-comment">#./configure</span><br>[root@redis-node1 ruby-2.5.5]<span class="hljs-comment">#make -j 2 &amp;&amp; make install</span><br>[root@redis-node1 ruby-2.5.5]<span class="hljs-comment">#which ruby</span><br>/usr/<span class="hljs-built_in">local</span>/bin/ruby<br>[root@redis-node1 ruby-2.5.5]<span class="hljs-comment"># ruby -v</span><br>ruby 2.5.5p157 (2019-03-15 revision 67260) [x86_64-linux]<br>[root@redis-node1 ruby-2.5.5]<span class="hljs-comment">#exit  #注意需要重新登录</span><br></code></pre></td></tr></table></figure>

<p>redis-trib.rb 仍无法运行错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb -h</span><br>Traceback (most recent call last):<br>2: from /usr/bin/redis-trib.rb:25:<span class="hljs-keyword">in</span> `&lt;main&gt;<span class="hljs-string">&#x27;</span><br><span class="hljs-string">1: from /usr/local/lib/ruby/2.5.0/rubygems/core_ext/kernel_require.rb:59:in</span><br><span class="hljs-string">`require&#x27;</span><br>/usr/<span class="hljs-built_in">local</span>/lib/ruby/2.5.0/rubygems/core_ext/kernel_require.rb:59:<span class="hljs-keyword">in</span> `require<span class="hljs-string">&#x27;: cannot load such file -- redis (LoadError)</span><br></code></pre></td></tr></table></figure>

<p><strong>解决上述错误：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#gem install redis -v 4.1.3 #注意需要重新登录再执行,否则无法识别到新ruby版本</span><br>Fetching: redis-4.1.3.gem (100%)<br>Successfully installed redis-4.1.3<br>Parsing documentation <span class="hljs-keyword">for</span> redis-4.1.3<br>Installing ri documentation <span class="hljs-keyword">for</span> redis-4.1.3<br>Done installing documentation <span class="hljs-keyword">for</span> redis after 1 seconds<br>1 gem installed<br><br><span class="hljs-comment">#gem uninstall redis 可以卸载已安装好redis模块</span><br></code></pre></td></tr></table></figure>

<p>如果无法在线安装，可以下载redis模块安装包离线安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#https://rubygems.org/gems/redis #先下载redis模块安装包</span><br>[root@redis-node1 ~]<span class="hljs-comment">#gem install -l redis-4.1.3.gem #安装redis模块</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-3-redis-trib-rb-命令用法"><a href="#3-3-5-3-redis-trib-rb-命令用法" class="headerlink" title="3.3.5.3 redis-trib.rb 命令用法"></a>3.3.5.3 redis-trib.rb 命令用法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb</span><br>Usage: redis-trib &lt;<span class="hljs-built_in">command</span>&gt; &lt;options&gt; &lt;arguments ...&gt;<br>create host1:port1 ... hostN:portN <span class="hljs-comment">#创建集群</span><br>--replicas &lt;arg&gt; <span class="hljs-comment">#指定每个master的副本数量,即对应slave数量,一般为1</span><br>check host:port <span class="hljs-comment">#检查集群信息</span><br>info host:port <span class="hljs-comment">#查看集群主机信息</span><br>fix host:port <span class="hljs-comment">#修复集群</span><br>--timeout &lt;arg&gt;<br>reshard host:port <span class="hljs-comment">#在线热迁移集群指定主机的slots数据</span><br>--from &lt;arg&gt;<br>--to &lt;arg&gt;<br>--slots &lt;arg&gt;<br>      --yes<br>--timeout &lt;arg&gt;<br>--pipeline &lt;arg&gt;<br>rebalance host:port <span class="hljs-comment">#平衡集群中各主机的slot数量</span><br>--weight &lt;arg&gt;<br>--auto-weights<br>--use-empty-masters<br>--timeout &lt;arg&gt;<br>--simulate<br>--pipeline &lt;arg&gt;<br>--threshold &lt;arg&gt;<br>add-node new_host:new_port existing_host:existing_port <span class="hljs-comment">#添加主机到集群</span><br>--slave<br>--master-id &lt;arg&gt;<br>del-node host:port node_id <span class="hljs-comment">#删除主机</span><br>set-timeout host:port milliseconds <span class="hljs-comment">#设置节点的超时时间</span><br>call host:port <span class="hljs-built_in">command</span> arg arg .. arg <span class="hljs-comment">#在集群上的所有节点上执行命令</span><br>import host:port <span class="hljs-comment">#导入外部redis服务器的数据到当前集群</span><br>--from &lt;arg&gt;<br>--copy<br>--replace<br><span class="hljs-built_in">help</span> (show this <span class="hljs-built_in">help</span>)<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-4-修改密码-redis-登录密码"><a href="#3-3-5-4-修改密码-redis-登录密码" class="headerlink" title="3.3.5.4 修改密码 redis 登录密码"></a>3.3.5.4 修改密码 redis 登录密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#修改redis-trib.rb连接redis的密码</span><br>[root@redis ~]<span class="hljs-comment">#vim /usr/local/lib/ruby/gems/2.5.0/gems/redis-4.1.3/lib/redis/client.rb</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis134.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-3-5-5-创建redis-cluster集群"><a href="#3-3-5-5-创建redis-cluster集群" class="headerlink" title="3.3.5.5 创建redis cluster集群"></a>3.3.5.5 创建redis cluster集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#确保三台主机6个实例都启动状态</span><br>[root@redis-node1 ~]<span class="hljs-comment">#systemctl is-active redis redis6380</span><br>active<br>active<br>[root@redis-node2 ~]<span class="hljs-comment">#systemctl is-active redis redis6380</span><br>active<br>active<br>[root@redis-node3 ~]<span class="hljs-comment">#systemctl is-active redis redis6380</span><br>active<br>active<br><br><span class="hljs-comment">#在第一个主机上执行下面操作</span><br><span class="hljs-comment">#--replicas 1 表示每个 master 分配一个 slave 节点,前三个节点自动划分为master,后面都为slave节点</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb create --replicas 1 10.0.0.7:6379 10.0.0.17:6379 10.0.0.27:6379 10.0.0.7:6380 10.0.0.17:6380 10.0.0.27:6380</span><br>&gt;&gt;&gt; Creating cluster<br>&gt;&gt;&gt; Performing <span class="hljs-built_in">hash</span> slots allocation on 6 nodes...<br>Using 3 masters:<br>10.0.0.7:6379<br>10.0.0.17:6379<br>10.0.0.27:6379<br>Adding replica 10.0.0.17:6380 to 10.0.0.7:6379<br>Adding replica 10.0.0.27:6380 to 10.0.0.17:6379<br>Adding replica 10.0.0.7:6380 to 10.0.0.27:6379<br>M: 739cb4c9895592131de418b8bc65990f81b75f3a 10.0.0.7:6379<br> slots:0-5460 (5461 slots) master<br>S: 0e0beba04cc98da02ebdb5225a11b84aa8062e10 10.0.0.7:6380<br> replicates a01fd3d81922d6752f7c960f1a75b6e8f28d911b<br>M: dddabb4e19235ec02ae96ab2ce67e295ce0274d7 10.0.0.17:6379<br> slots:5461-10922 (5462 slots) master<br>S: 34708909088ba562decbc1525a9606e088bdddf1 10.0.0.17:6380<br> replicates 739cb4c9895592131de418b8bc65990f81b75f3a<br>M: a01fd3d81922d6752f7c960f1a75b6e8f28d911b 10.0.0.27:6379<br> slots:10923-16383 (5461 slots) master<br>S: aefc6203958859024b8383b2fdb87b9e09411ccd 10.0.0.27:6380<br> replicates dddabb4e19235ec02ae96ab2ce67e295ce0274d7<br>Can I <span class="hljs-built_in">set</span> the above configuration? (<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;yes&#x27;</span> to accept): yes  <span class="hljs-comment">#输入yes</span><br>&gt;&gt;&gt; Nodes configuration updated<br>&gt;&gt;&gt; Assign a different config epoch to each node<br>&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster<br>Waiting <span class="hljs-keyword">for</span> the cluster to join....<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)<br>M: 739cb4c9895592131de418b8bc65990f81b75f3a 10.0.0.7:6379<br> slots:0-5460 (5461 slots) master<br> 1 additional replica(s)<br>S: 0e0beba04cc98da02ebdb5225a11b84aa8062e10 10.0.0.7:6380<br> slots: (0 slots) slave<br> replicates a01fd3d81922d6752f7c960f1a75b6e8f28d911b<br>S: 34708909088ba562decbc1525a9606e088bdddf1 10.0.0.17:6380<br> slots: (0 slots) slave<br> replicates 739cb4c9895592131de418b8bc65990f81b75f3a<br>S: aefc6203958859024b8383b2fdb87b9e09411ccd 10.0.0.27:6380<br> slots: (0 slots) slave<br> replicates dddabb4e19235ec02ae96ab2ce67e295ce0274d7<br>M: a01fd3d81922d6752f7c960f1a75b6e8f28d911b 10.0.0.27:6379<br> slots:10923-16383 (5461 slots) master<br> 1 additional replica(s)<br>M: dddabb4e19235ec02ae96ab2ce67e295ce0274d7 10.0.0.17:6379<br> slots:5461-10922 (5462 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br></code></pre></td></tr></table></figure>

<p>如果有之前的操作导致Redis集群创建报错，则执行清空数据和集群命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; FLUSHALL<br>OK<br>127.0.0.1:6379&gt; cluster reset<br>OK<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-6-查看-redis-cluster-集群状态"><a href="#3-3-5-6-查看-redis-cluster-集群状态" class="headerlink" title="3.3.5.6 查看 redis cluster 集群状态"></a>3.3.5.6 查看 redis cluster 集群状态</h4><p>自动生成配置文件记录master/slave对应关系</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#cat /apps/redis/data/nodes-6379.conf</span><br>0e0beba04cc98da02ebdb5225a11b84aa8062e10 10.0.0.7:6380@16380 slave<br>a01fd3d81922d6752f7c960f1a75b6e8f28d911b 0 1582383256000 5 connected<br>34708909088ba562decbc1525a9606e088bdddf1 10.0.0.17:6380@16380 slave<br>739cb4c9895592131de418b8bc65990f81b75f3a 0 1582383256216 4 connected<br>aefc6203958859024b8383b2fdb87b9e09411ccd 10.0.0.27:6380@16380 slave<br>dddabb4e19235ec02ae96ab2ce67e295ce0274d7 0 1582383257000 6 connected<br>739cb4c9895592131de418b8bc65990f81b75f3a 10.0.0.7:6379@16379 myself,master - 0<br>1582383256000 1 connected 0-5460<br>a01fd3d81922d6752f7c960f1a75b6e8f28d911b 10.0.0.27:6379@16379 master - 0<br>1582383258230 5 connected 10923-16383<br>dddabb4e19235ec02ae96ab2ce67e295ce0274d7 10.0.0.17:6379@16379 master - 0<br>1582383257223 3 connected 5461-10922<br>vars currentEpoch 6 lastVoteEpoch 0<br>[root@redis-node1 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>查看状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb info 10.0.0.7:6379</span><br>10.0.0.7:6379 (739cb4c9...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>10.0.0.27:6379 (a01fd3d8...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>10.0.0.17:6379 (dddabb4e...) -&gt; 0 keys | 5462 slots | 1 slaves.<br>[OK] 0 keys <span class="hljs-keyword">in</span> 3 masters.<br>0.00 keys per slot on average.<br><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb check 10.0.0.7:6379</span><br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)<br>M: 739cb4c9895592131de418b8bc65990f81b75f3a 10.0.0.7:6379<br> slots:0-5460 (5461 slots) master<br> 1 additional replica(s)<br>S: 0e0beba04cc98da02ebdb5225a11b84aa8062e10 10.0.0.7:6380<br> slots: (0 slots) slave<br> replicates a01fd3d81922d6752f7c960f1a75b6e8f28d911b<br>S: 34708909088ba562decbc1525a9606e088bdddf1 10.0.0.17:6380<br> slots: (0 slots) slave<br> replicates 739cb4c9895592131de418b8bc65990f81b75f3a<br>S: aefc6203958859024b8383b2fdb87b9e09411ccd 10.0.0.27:6380<br> slots: (0 slots) slave<br> replicates dddabb4e19235ec02ae96ab2ce67e295ce0274d7<br>M: a01fd3d81922d6752f7c960f1a75b6e8f28d911b 10.0.0.27:6379<br> slots:10923-16383 (5461 slots) master<br> 1 additional replica(s)<br>M: dddabb4e19235ec02ae96ab2ce67e295ce0274d7 10.0.0.17:6379<br> slots:5461-10922 (5462 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not<br>be safe.<br>127.0.0.1:6379&gt; CLUSTER INFO<br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:6<br>cluster_size:3<br>cluster_current_epoch:6<br>cluster_my_epoch:1<br>cluster_stats_messages_ping_sent:252<br>cluster_stats_messages_pong_sent:277<br>cluster_stats_messages_sent:529<br>cluster_stats_messages_ping_received:272<br>cluster_stats_messages_pong_received:252<br>cluster_stats_messages_meet_received:5<br>cluster_stats_messages_received:529<br>127.0.0.1:6379&gt;<br><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 -p 6379 CLUSTER NODES</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not<br>be safe.<br>29a83275db60f1c8f9f6d39b66cbc6c3d5cf20f1 10.0.0.7:6379@16379 myself,master - 0<br>1601985995000 1 connected 0-5460<br>3e607de412a8a240e8214c2d7a663cf1523412eb 10.0.0.17:6380@16380 slave<br>29a83275db60f1c8f9f6d39b66cbc6c3d5cf20f1 0 1601985997092 4 connected<br>17d0b29d2f50ea9c89d4e6e0cf3ee3ee4f7c4179 10.0.0.7:6380@16380 slave<br>90b206131d89b0812c626677343df9a11ff1d211 0 1601985995075 5 connected<br>90b206131d89b0812c626677343df9a11ff1d211 10.0.0.27:6379@16379 master - 0<br>1601985996084 5 connected 10923-16383<br>fb34c3a704aefb1e1ef2317b20598d6e1e51c010 10.0.0.17:6379@16379 master - 0<br>1601985995000 3 connected 5461-10922<br>c9ea6113a1992695fb86f5368fe6320349b0f8a6 10.0.0.27:6380@16380 slave<br>fb34c3a704aefb1e1ef2317b20598d6e1e51c010 0 1601985996000 6 connected<br><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 -p 6379 INFO replication</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.17,port=6380,state=online,offset=196,lag=0<br>master_replid:4ee36f9374c796ca4c65a0f0cb2c39304bb2e9c9<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:196<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:196<br><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 -p 6380 INFO replication</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:10.0.0.27<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:2<br>master_sync_in_progress:0<br>slave_repl_offset:224<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:dba41cb31c14de7569e597a3d8debc1f0f114c1e<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:224<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:224<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-7-python脚本实现RedisCluster集群写入"><a href="#3-3-3-7-python脚本实现RedisCluster集群写入" class="headerlink" title="3.3.3.7 python脚本实现RedisCluster集群写入"></a>3.3.3.7 python脚本实现RedisCluster集群写入</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@redis-node1 ~]<span class="hljs-comment">#yum -y install python3</span><br>[root@redis-node1 ~]<span class="hljs-comment">#pip3 install redis-py-cluster</span><br>[root@redis-node1 ~]<span class="hljs-comment">#vim redis_cluster_test.py</span><br>[root@redis-node1 ~]<span class="hljs-comment">#cat ./redis_cluster_test.py</span><br><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> rediscluster <span class="hljs-keyword">import</span> RedisCluster<br>startup_nodes = [<br> &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.7&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:<span class="hljs-number">6379</span>&#125;,<br> &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.7&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:<span class="hljs-number">6380</span>&#125;,<br> &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.17&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:<span class="hljs-number">6379</span>&#125;,<br> &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.17&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:<span class="hljs-number">6380</span>&#125;,<br> &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.27&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:<span class="hljs-number">6379</span>&#125;,<br> &#123;<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.27&quot;</span>, <span class="hljs-string">&quot;port&quot;</span>:<span class="hljs-number">6380</span>&#125;<br>]<br>redis_conn= RedisCluster(startup_nodes=startup_nodes,password=<span class="hljs-string">&#x27;123456&#x27;</span>,decode_responses=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10000</span>):<br> redis_conn.<span class="hljs-built_in">set</span>(<span class="hljs-string">&#x27;key&#x27;</span>+<span class="hljs-built_in">str</span>(i),<span class="hljs-string">&#x27;value&#x27;</span>+<span class="hljs-built_in">str</span>(i))<br> <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;key&#x27;</span>+<span class="hljs-built_in">str</span>(i)+<span class="hljs-string">&#x27;:&#x27;</span>,redis_conn.get(<span class="hljs-string">&#x27;key&#x27;</span>+<span class="hljs-built_in">str</span>(i)))<br>    <br>[root@redis-node1 ~]<span class="hljs-comment">#chmod +x redis_cluster_test.py</span><br>[root@redis-node1 ~]<span class="hljs-comment">#./redis_cluster_test.py</span><br>......<br>key9998: value9998<br>key9999: value9999<br></code></pre></td></tr></table></figure>

<p><strong>验证脚本写入的状态</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 -h 10.0.0.7 DBSIZE</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>(<span class="hljs-built_in">integer</span>) 3331<br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 -h 10.0.0.17 DBSIZE</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>(<span class="hljs-built_in">integer</span>) 3340<br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 -h 10.0.0.27 DBSIZE</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>(<span class="hljs-built_in">integer</span>) 3329<br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 GET key1</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>(error) MOVED 9189 10.0.0.17:6379<br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 GET key2</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br><span class="hljs-string">&quot;value2&quot;</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 -h 10.0.0.17 GET key1</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br><span class="hljs-string">&quot;value1&quot;</span><br><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb info 10.0.0.7:6379</span><br>10.0.0.7:6379 (739cb4c9...) -&gt; 3331 keys | 5461 slots | 1 slaves.<br>10.0.0.27:6379 (a01fd3d8...) -&gt; 3329 keys | 5461 slots | 1 slaves.<br>10.0.0.17:6379 (dddabb4e...) -&gt; 3340 keys | 5462 slots | 1 slaves.<br>[OK] 10000 keys <span class="hljs-keyword">in</span> 3 masters.<br>0.61 keys per slot on average.<br>[root@redis-node1 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-8-模拟-master-故障，对应的slave节点自动提升为新master"><a href="#3-3-3-8-模拟-master-故障，对应的slave节点自动提升为新master" class="headerlink" title="3.3.3.8 模拟 master 故障，对应的slave节点自动提升为新master"></a>3.3.3.8 模拟 master 故障，对应的slave节点自动提升为新master</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#systemctl stop redis</span><br><br><span class="hljs-comment">#不会立即提升,需要稍等一会儿再观察下面结果</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb check 10.0.0.27:6379</span><br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.27:6379)<br>M: a01fd3d81922d6752f7c960f1a75b6e8f28d911b 10.0.0.27:6379<br> slots:10923-16383 (5461 slots) master<br> 1 additional replica(s)<br>S: aefc6203958859024b8383b2fdb87b9e09411ccd 10.0.0.27:6380<br> slots: (0 slots) slave<br> replicates dddabb4e19235ec02ae96ab2ce67e295ce0274d7<br>S: 0e0beba04cc98da02ebdb5225a11b84aa8062e10 10.0.0.7:6380<br> slots: (0 slots) slave<br> replicates a01fd3d81922d6752f7c960f1a75b6e8f28d911b<br>M: 34708909088ba562decbc1525a9606e088bdddf1 10.0.0.17:6380<br> slots:0-5460 (5461 slots) master<br> 0 additional replica(s)<br>M: dddabb4e19235ec02ae96ab2ce67e295ce0274d7 10.0.0.17:6379<br> slots:5461-10922 (5462 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br>[root@redis-node1 ~]<span class="hljs-comment">#tail /var/log/messages</span><br>Feb 22 23:23:13 centos7 redis-server: 71887:M 22 Feb 23:23:13.656 * Saving the<br>final RDB snapshot before exiting.<br>Feb 22 23:23:13 centos7 systemd: Stopped Redis persistent key-value database.<br>Feb 22 23:23:13 centos7 redis-server: 71887:M 22 Feb 23:23:13.660 * DB saved on<br>disk<br>Feb 22 23:23:13 centos7 redis-server: 71887:M 22 Feb 23:23:13.660 * Removing the<br>pid file.<br>Feb 22 23:23:13 centos7 redis-server: 71887:M 22 Feb 23:23:13.660 <span class="hljs-comment"># Redis is now</span><br>ready to <span class="hljs-built_in">exit</span>, <span class="hljs-built_in">bye</span> <span class="hljs-built_in">bye</span>...<br>Feb 22 23:23:13 centos7 systemd: Unit redis.service entered failed state.<br>Feb 22 23:23:13 centos7 systemd: redis.service failed.<br>Feb 22 23:23:30 centos7 redis-server: 72046:S 22 Feb 23:23:30.077 * FAIL message<br>received from dddabb4e19235ec02ae96ab2ce67e295ce0274d7 about<br>739cb4c9895592131de418b8bc65990f81b75f3a<br>Feb 22 23:23:30 centos7 redis-server: 72046:S 22 Feb 23:23:30.077 <span class="hljs-comment"># Cluster</span><br>state changed: fail<br>Feb 22 23:23:30 centos7 redis-server: 72046:S 22 Feb 23:23:30.701 <span class="hljs-comment"># Cluster</span><br>state changed: ok<br><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb info 10.0.0.27:6379</span><br>10.0.0.27:6379 (a01fd3d8...) -&gt; 3329 keys | 5461 slots | 1 slaves.<br>10.0.0.17:6380 (34708909...) -&gt; 3331 keys | 5461 slots | 0 slaves.<br>10.0.0.17:6379 (dddabb4e...) -&gt; 3340 keys | 5462 slots | 1 slaves.<br>[OK] 10000 keys <span class="hljs-keyword">in</span> 3 masters.<br>0.61 keys per slot on average.<br></code></pre></td></tr></table></figure>

<p><strong>将故障的master恢复后，该节点自动加入集群成为新的slave</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#systemctl start redis</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb check 10.0.0.27:6379</span><br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.27:6379)<br>M: a01fd3d81922d6752f7c960f1a75b6e8f28d911b 10.0.0.27:6379<br> slots:10923-16383 (5461 slots) master<br> 1 additional replica(s)<br>S: aefc6203958859024b8383b2fdb87b9e09411ccd 10.0.0.27:6380<br> slots: (0 slots) slave<br> replicates dddabb4e19235ec02ae96ab2ce67e295ce0274d7<br>S: 739cb4c9895592131de418b8bc65990f81b75f3a 10.0.0.7:6379<br> slots: (0 slots) slave<br> replicates 34708909088ba562decbc1525a9606e088bdddf1<br>S: 0e0beba04cc98da02ebdb5225a11b84aa8062e10 10.0.0.7:6380<br> slots: (0 slots) slave<br> replicates a01fd3d81922d6752f7c960f1a75b6e8f28d911b<br>M: 34708909088ba562decbc1525a9606e088bdddf1 10.0.0.17:6380<br> slots:0-5460 (5461 slots) master<br> 1 additional replica(s)<br>M: dddabb4e19235ec02ae96ab2ce67e295ce0274d7 10.0.0.17:6379<br> slots:5461-10922 (5462 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br></code></pre></td></tr></table></figure>

<h3 id="3-3-7实战案例：基于-Redis-4-的-redis-cluster-部署（六台主机实现）"><a href="#3-3-7实战案例：基于-Redis-4-的-redis-cluster-部署（六台主机实现）" class="headerlink" title="3.3.7实战案例：基于 Redis 4 的 redis cluster 部署（六台主机实现）"></a>3.3.7实战案例：基于 Redis 4 的 redis cluster 部署（六台主机实现）</h3><table>
<thead>
<tr>
<th align="center">ip:port</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.0.0.7:6379</td>
<td align="center">master</td>
</tr>
<tr>
<td align="center">10.0.0.17:6379</td>
<td align="center">master</td>
</tr>
<tr>
<td align="center">10.0.0.27:6379</td>
<td align="center">master</td>
</tr>
<tr>
<td align="center">10.0.0.37:6379</td>
<td align="center">slave</td>
</tr>
<tr>
<td align="center">10.0.0.47:6379</td>
<td align="center">slave</td>
</tr>
<tr>
<td align="center">10.0.0.57:6379</td>
<td align="center">slave</td>
</tr>
<tr>
<td align="center">10.0.0.67：6378</td>
<td align="center">扩容master</td>
</tr>
<tr>
<td align="center">10.0.0.77：6379</td>
<td align="center">扩容slave</td>
</tr>
</tbody></table>
<h4 id="3-3-6-1-环境搭建"><a href="#3-3-6-1-环境搭建" class="headerlink" title="3.3.6.1 环境搭建"></a>3.3.6.1 环境搭建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#六个节点全部执行</span><br>[root@centos7 ~]<span class="hljs-comment"># bash install_redis_for_centos.sh</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-6-2-修改配置文件"><a href="#3-3-6-2-修改配置文件" class="headerlink" title="3.3.6.2 修改配置文件"></a>3.3.6.2 修改配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#六个节点全部执行</span><br>[root@centos7 ~]<span class="hljs-comment"># sed -i -e &#x27;/^# masterauth/a masterauth 123456&#x27; -e &#x27;/# cluster-enabled yes/a cluster-enabled yes&#x27; -e &#x27;/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf&#x27; -e &#x27;/cluster-require-full-coverage yes/c cluster-require-full-coverage no&#x27; /apps/redis/etc/redis.conf</span><br><br>[root@centos7 ~]<span class="hljs-comment"># systemctl restart redis</span><br>[root@centos7 ~]<span class="hljs-comment"># ss -tnl</span><br>[root@centos7 ~]<span class="hljs-comment"># ps -ef | grep redis</span><br>redis      4544      1  0 22:28 ?        00:00:00 /apps/redis/bin/redis-server 0.0.0.0:6379 [cluster]<br>root       4555   1249  0 22:28 pts/0    00:00:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>

<h4 id="3-3-6-3-准备ruby脚本"><a href="#3-3-6-3-准备ruby脚本" class="headerlink" title="3.3.6.3 准备ruby脚本"></a>3.3.6.3 准备ruby脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在任意一个节点上执行</span><br>[root@redis-node1 ~]<span class="hljs-comment">#find / -name redis-trib.rb</span><br>/root/redis-4.0.14/src/redis-trib.rb<br>[root@redis-node1 ~]<span class="hljs-comment">#cp /root/redis-4.0.14/src/redis-trib.rb /usr/bin/</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb #缺少ruby环境无法运行rb脚本</span><br>/usr/bin/env: ruby: No such file or directory<br><br><span class="hljs-comment">#CentOS 7带的ruby版本过低,无法运行上面ruby脚本,需要安装2.3以上版本,安装rubygems依赖ruby自动安装</span><br>[root@redis-node1 ~]<span class="hljs-comment">#yum -y install gcc openssl-devel zlib-devel</span><br>[root@redis-node1 ~]<span class="hljs-comment">#wget https://cache.ruby-lang.org/pub/ruby/2.5/ruby-2.5.5.tar.gz</span><br>[root@redis-node1 ~]<span class="hljs-comment">#tar xf ruby-2.5.5.tar.gz</span><br>[root@redis-node1 ~]<span class="hljs-comment">#cd ruby-2.5.5</span><br>[root@redis-node1 ruby-2.5.5]<span class="hljs-comment">#./configure</span><br>[root@redis-node1 ruby-2.5.5]<span class="hljs-comment">#make -j 2 &amp;&amp; make install</span><br>[root@redis-node1 ruby-2.5.5]<span class="hljs-comment">#which ruby</span><br>/usr/<span class="hljs-built_in">local</span>/bin/ruby<br>[root@redis-node1 ruby-2.5.5]<span class="hljs-comment"># ruby -v</span><br>ruby 2.5.5p157 (2019-03-15 revision 67260) [x86_64-linux]<br>[root@redis-node1 ruby-2.5.5]<span class="hljs-comment">#exit  #注意需要重新登录</span><br><br>[root@redis-node1 ~]<span class="hljs-comment"># yum install rubygems -y </span><br>[root@redis-node1 ~]<span class="hljs-comment"># gem install redis</span><br>Fetching: redis-4.3.1.gem (100%)<br>Successfully installed redis-4.3.1<br>Parsing documentation <span class="hljs-keyword">for</span> redis-4.3.1<br>Installing ri documentation <span class="hljs-keyword">for</span> redis-4.3.1<br>Done installing documentation <span class="hljs-keyword">for</span> redis after 0 seconds<br>1 gem installed<br><br><span class="hljs-comment">#修改配置文件</span><br>[root@redis-node1 ~]<span class="hljs-comment"># find / -name client.rb</span><br>/root/ruby-2.5.5/gems/xmlrpc-0.3.0/lib/xmlrpc/client.rb<br>/usr/<span class="hljs-built_in">local</span>/lib/ruby/gems/2.5.0/gems/xmlrpc-0.3.0/lib/xmlrpc/client.rb<br>/usr/<span class="hljs-built_in">local</span>/lib/ruby/gems/2.5.0/gems/redis-4.3.1/lib/redis/client.rb    <span class="hljs-comment">#这个才是要使用的ruby脚本</span><br>[root@redis-node1 ~]<span class="hljs-comment"># vim /usr/local/lib/ruby/gems/2.5.0/gems/redis-4.3.1/lib/redis/client.rb</span><br>......<br>password: 123456,<br></code></pre></td></tr></table></figure>

<h4 id="3-3-6-4-创建redis-cluster集群"><a href="#3-3-6-4-创建redis-cluster集群" class="headerlink" title="3.3.6.4 创建redis cluster集群"></a>3.3.6.4 创建redis cluster集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment"># redis-trib.rb create --replicas 1 10.0.0.7:6379 10.0.0.17:6379 10.0.0.27:6379 10.0.0.37:6379 10.0.0.47:6379 10.0.0.57:6379</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-6-5-查看集群"><a href="#3-3-6-5-查看集群" class="headerlink" title="3.3.6.5 查看集群"></a>3.3.6.5 查看集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># redis-trib.rb info 10.0.0.7:6379</span><br>10.0.0.7:6379 (3534d31f...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>10.0.0.17:6379 (408483a9...) -&gt; 0 keys | 5462 slots | 1 slaves.<br>10.0.0.27:6379 (6a65e24c...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>[OK] 0 keys <span class="hljs-keyword">in</span> 3 masters.<br>0.00 keys per slot on average.<br><br>[root@centos7 ~]<span class="hljs-comment"># redis-cli -a 123456 cluster nodes</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>989a26e3744b5731030744393d579a364c0b2dac 10.0.0.37:6379@16379 slave 6a65e24cc2127cb4dd6b4f8d19c7388835ab5a5e 0 1623891418603 4 connected<br>3534d31f0953014011642be9be0f91ea93bc69aa 10.0.0.7:6379@16379 myself,master - 0 1623891416000 1 connected 0-5460<br>408483a9641c063ad67b7840dd80a7357fc2615a 10.0.0.17:6379@16379 master - 0 1623891418000 2 connected 5461-10922<br>6a65e24cc2127cb4dd6b4f8d19c7388835ab5a5e 10.0.0.27:6379@16379 master - 0 1623891418000 3 connected 10923-16383<br>59f3129bb6ae27e2250da6c58886ff552096b972 10.0.0.47:6379@16379 slave 3534d31f0953014011642be9be0f91ea93bc69aa 0 1623891417596 5 connected<br>9621feef2ca069f678a7f7e601f69804782efc0f 10.0.0.57:6379@16379 slave 408483a9641c063ad67b7840dd80a7357fc2615a 0 1623891419609 6 connected<br></code></pre></td></tr></table></figure>

<h3 id="3-3-8-redis-cluster集群节点维护简介"><a href="#3-3-8-redis-cluster集群节点维护简介" class="headerlink" title="3.3.8 redis cluster集群节点维护简介"></a>3.3.8 redis cluster集群节点维护简介</h3><p>redis 集群运行之后，难免由于硬件故障、网络规划、业务增长等原因对已有集群进行相应的调整， 比如: 增加Redis node节点、减少节点、节点迁移、更换服务器等。增加节点和删除节点会涉及到已有的槽位重新分配及数据迁移。</p>
<h3 id="3-3-9-基于Redis5的cluster集群节点维护"><a href="#3-3-9-基于Redis5的cluster集群节点维护" class="headerlink" title="3.3.9 基于Redis5的cluster集群节点维护"></a>3.3.9 基于Redis5的cluster集群节点维护</h3><p><strong>实战案例：</strong><br>因公司业务发展迅猛，现有的三主三从的redis cluster架构可能无法满足现有业务的并发写入需求，因此公司紧急采购两台服务器10.0.0.67，10.0.0.77，需要将其动态添加到集群当中，但不能影响业务使用和数据丢失。</p>
<p><strong>注意: 生产环境一般建议master节点为奇数个，比如:3，5，7以防止脑裂现象</strong></p>
<p><strong>增加Redis node节点，需要与之前的Redis node版本相同、配置一致，然后分别再启动两台Redis node，应为一主一从。</strong></p>
<h4 id="3-3-9-1-环境规划"><a href="#3-3-9-1-环境规划" class="headerlink" title="3.3.9.1 环境规划"></a>3.3.9.1 环境规划</h4><table>
<thead>
<tr>
<th>服务器IP</th>
<th>hostname</th>
<th>redis版本</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.67</td>
<td>redis-master4</td>
<td>redis5.0.9</td>
</tr>
<tr>
<td>10.0.0.77</td>
<td>redis-slave4</td>
<td>redis5.0.9</td>
</tr>
</tbody></table>
<h4 id="3-3-9-2-修改hostname"><a href="#3-3-9-2-修改hostname" class="headerlink" title="3.3.9.2 修改hostname"></a>3.3.9.2 修改hostname</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#10.0.0.67</span><br><span class="hljs-comment"># hostanemctl set-hostname redis-master4</span><br><br><span class="hljs-comment">#10.0.0.77</span><br><span class="hljs-comment"># hostnamectl set-hostname redis=slave4</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-9-3-编译安装redis5"><a href="#3-3-9-3-编译安装redis5" class="headerlink" title="3.3.9.3 编译安装redis5"></a>3.3.9.3 编译安装redis5</h4><p>过程略</p>
<h4 id="3-3-9-4-修改配置文件"><a href="#3-3-9-4-修改配置文件" class="headerlink" title="3.3.9.4 修改配置文件"></a>3.3.9.4 修改配置文件</h4><p>过程略</p>
<h4 id="3-3-9-5-启动redis"><a href="#3-3-9-5-启动redis" class="headerlink" title="3.3.9.5 启动redis"></a>3.3.9.5 启动redis</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl enable --now redis</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-9-6-添加新的master节点到集群"><a href="#3-3-9-6-添加新的master节点到集群" class="headerlink" title="3.3.9.6 添加新的master节点到集群"></a>3.3.9.6 添加新的master节点到集群</h4><p>命令格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli -a 123456 --cluster add-node 新master节点IP:6379 redis集群任意节点IP:6379<br></code></pre></td></tr></table></figure>

<p>操作：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 --cluster add-node 10.0.0.67:6379 10.0.0.57:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>&gt;&gt;&gt; Adding node 10.0.0.67:6379 to cluster 10.0.0.57:6379<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.57:6379)<br>M: d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379<br>   slots:[5461-10922] (5462 slots) master<br>   1 additional replica(s)<br>M: 1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>S: 35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379<br>   slots: (0 slots) slave<br>   replicates cc3ab037bf9ff76438b6f16e43fab783ec915375<br>S: 50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379<br>   slots: (0 slots) slave<br>   replicates 1969ea14c7dda04279a6457ff9aac71c181c9b86<br>M: cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>S: ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379<br>   slots: (0 slots) slave<br>   replicates d1fd7d43a18ea97e32d7633ac0f780c282fa0570<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>&gt;&gt;&gt; Send CLUSTER MEET to node 10.0.0.67:6379 to make it join the cluster.<br>[OK] New node added correctly.<br></code></pre></td></tr></table></figure>

<h4 id="3-3-9-7-查看master4节点信息"><a href="#3-3-9-7-查看master4节点信息" class="headerlink" title="3.3.9.7 查看master4节点信息"></a>3.3.9.7 查看master4节点信息</h4><p>观察到该节点已经加入成功，但此节点上没有slot位,也无从节点，而且新加入的节点是master</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 --cluster check 10.0.0.7:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.7:6379 (1969ea14...) -&gt; 3332 keys | 5461 slots | 1 slaves.<br>10.0.0.67:6379 (aeb17968...) -&gt; 0 keys | 0 slots | 0 slaves.<br>10.0.0.57:6379 (d1fd7d43...) -&gt; 3342 keys | 5462 slots | 1 slaves.<br>10.0.0.27:6379 (cc3ab037...) -&gt; 3330 keys | 5461 slots | 1 slaves.<br>[OK] 10004 keys <span class="hljs-keyword">in</span> 4 masters.<br>0.61 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)<br>M: 1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>S: 35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379<br>   slots: (0 slots) slave<br>   replicates cc3ab037bf9ff76438b6f16e43fab783ec915375<br>S: 50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379<br>   slots: (0 slots) slave<br>   replicates 1969ea14c7dda04279a6457ff9aac71c181c9b86<br>M: aeb17968edb87366188969c59a14f43ab95aa207 10.0.0.67:6379<br>   slots: (0 slots) master<br>M: d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379<br>   slots:[5461-10922] (5462 slots) master<br>   1 additional replica(s)<br>M: cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>S: ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379<br>   slots: (0 slots) slave<br>   replicates d1fd7d43a18ea97e32d7633ac0f780c282fa0570<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br><span class="hljs-comment"># cat /apps/redis/data/nodes-6379.conf</span><br>35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379@16379 slave cc3ab037bf9ff76438b6f16e43fab783ec915375 0 1669093278390 4 connected<br>50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379@16379 slave 1969ea14c7dda04279a6457ff9aac71c181c9b86 0 1669093280401 5 connected<br>aeb17968edb87366188969c59a14f43ab95aa207 10.0.0.67:6379@16379 master - 0 1669093281611 0 connected<br>d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379@16379 master - 0 1669093278000 7 connected 5461-10922<br>cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379@16379 master - 0 1669093279397 3 connected 10923-16383<br>1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379@16379 myself,master - 0 1669093280000 1 connected 0-5460<br>ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379@16379 slave d1fd7d43a18ea97e32d7633ac0f780c282fa0570 0 1669093281406 7 connected<br>vars currentEpoch 7 lastVoteEpoch 7<br></code></pre></td></tr></table></figure>

<h4 id="3-3-9-8-在新的master节点上重新分配槽位"><a href="#3-3-9-8-在新的master节点上重新分配槽位" class="headerlink" title="3.3.9.8 在新的master节点上重新分配槽位"></a>3.3.9.8 在新的master节点上重新分配槽位</h4><p>新的node节点加到集群之后，默认是master节点，但是没有slots，需要重新分配</p>
<p>添加主机之后需要对添加至集群种的新主机重新分片，否则其没有分片也就无法写入数据。</p>
<p><strong>注意: 重新分配槽位需要清空数据,所以需要先备份数据（让开发导出redis数据，清空redis数据）,扩展后再恢复数据（扩容完成后再导入回去）</strong></p>
<p>命令格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli -a 123456 --cluster reshard redis集群任意节点IP:6379<br></code></pre></td></tr></table></figure>

<p>操作：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 --cluster reshard 10.0.0.47:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.47:6379)<br>S: 50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379<br>   slots: (0 slots) slave<br>   replicates 1969ea14c7dda04279a6457ff9aac71c181c9b86<br>M: aeb17968edb87366188969c59a14f43ab95aa207 10.0.0.67:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br>S: 35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379<br>   slots: (0 slots) slave<br>   replicates cc3ab037bf9ff76438b6f16e43fab783ec915375<br>M: cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>S: ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379<br>   slots: (0 slots) slave<br>   replicates d1fd7d43a18ea97e32d7633ac0f780c282fa0570<br>M: 1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>M: d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>How many slots <span class="hljs-keyword">do</span> you want to move (from 1 to 16384)? 4096 <span class="hljs-comment">#新分配多少个槽位=16384/master个数</span><br>What is the receiving node ID? aeb17968edb87366188969c59a14f43ab95aa207 <span class="hljs-comment">#新的master的ID</span><br>Please enter all the <span class="hljs-built_in">source</span> node IDs.<br>Type <span class="hljs-string">&#x27;all&#x27;</span> to use all the nodes as <span class="hljs-built_in">source</span> nodes <span class="hljs-keyword">for</span> the <span class="hljs-built_in">hash</span> slots.<br>Type <span class="hljs-string">&#x27;done&#x27;</span> once you entered all the <span class="hljs-built_in">source</span> nodes IDs.<br>Source node <span class="hljs-comment">#1: all #将哪些源主机的槽位分配给新的节点，all是自动在所有的redis node选择划分，如果是从redis cluster删除某个主机可以使用此方式将指定主机上的槽位全部移动到别的redis主机</span><br>......<br>Do you want to proceed with the proposed reshard plan (yes/no)?  yes <span class="hljs-comment">#确认分配</span><br>......<br>Moving slot 1358 from 10.0.0.7:6379 to 10.0.0.67:6379: ..<br>Moving slot 1359 from 10.0.0.7:6379 to 10.0.0.67:6379: .<br>Moving slot 1360 from 10.0.0.7:6379 to 10.0.0.67:6379: .<br>Moving slot 1361 from 10.0.0.7:6379 to 10.0.0.67:6379: <br>Moving slot 1362 from 10.0.0.7:6379 to 10.0.0.67:6379: <br>Moving slot 1363 from 10.0.0.7:6379 to 10.0.0.67:6379: <br>Moving slot 1364 from 10.0.0.7:6379 to 10.0.0.67:6379:<br></code></pre></td></tr></table></figure>

<h4 id="3-3-9-9-查看槽位分配"><a href="#3-3-9-9-查看槽位分配" class="headerlink" title="3.3.9.9 查看槽位分配"></a>3.3.9.9 查看槽位分配</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 --cluster check 10.0.0.7:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.7:6379 (1969ea14...) -&gt; 2511 keys | 4096 slots | 1 slaves.<br>10.0.0.67:6379 (aeb17968...) -&gt; 2476 keys | 4096 slots | 0 slaves.<br>10.0.0.57:6379 (d1fd7d43...) -&gt; 2516 keys | 4096 slots | 1 slaves.<br>10.0.0.27:6379 (cc3ab037...) -&gt; 2501 keys | 4096 slots | 1 slaves.<br>[OK] 10004 keys <span class="hljs-keyword">in</span> 4 masters.<br>0.61 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)<br>M: 1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>S: 35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379<br>   slots: (0 slots) slave<br>   replicates cc3ab037bf9ff76438b6f16e43fab783ec915375<br>S: 50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379<br>   slots: (0 slots) slave<br>   replicates 1969ea14c7dda04279a6457ff9aac71c181c9b86<br>M: aeb17968edb87366188969c59a14f43ab95aa207 10.0.0.67:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master <span class="hljs-comment">#可看到4096个</span><br>M: d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>M: cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>S: ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379<br>   slots: (0 slots) slave<br>   replicates d1fd7d43a18ea97e32d7633ac0f780c282fa0570<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br></code></pre></td></tr></table></figure>

<h4 id="3-3-9-10-为新的master添加新的slave节点——方法一"><a href="#3-3-9-10-为新的master添加新的slave节点——方法一" class="headerlink" title="3.3.9.10 为新的master添加新的slave节点——方法一"></a>3.3.9.10 为新的master添加新的slave节点——方法一</h4><p>需要再向当前的Redis集群中添加一个Redis单机服务器10.0.0.77，用于解决当前10.0.0.67单机的潜在宕机问题，即实现响应的高可用功能。</p>
<p>命令格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli -a 123456 --cluster add-node &lt;slave节点ip&gt;:6379 &lt;任意集群节点&gt;:6379 --cluster-slave --cluster-master-id masterid<br><span class="hljs-comment">#如：</span><br><span class="hljs-comment"># redis-cli -a 123456 --cluster add-node 10.0.0.77:6379 10.0.0.67:6379 --cluster-slave --cluster-master-id aeb17968edb87366188969c59a14f43ab95aa207</span><br></code></pre></td></tr></table></figure>

<p>操作</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 --cluster add-node 10.0.0.77:6379 10.0.0.67:6379  --cluster-slave --cluster-master-id aeb17968edb87366188969c59a14f43ab95aa207</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>&gt;&gt;&gt; Adding node 10.0.0.77:6379 to cluster 10.0.0.67:6379<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.67:6379)<br>M: aeb17968edb87366188969c59a14f43ab95aa207 10.0.0.67:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br>S: ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379<br>   slots: (0 slots) slave<br>   replicates d1fd7d43a18ea97e32d7633ac0f780c282fa0570<br>S: 50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379<br>   slots: (0 slots) slave<br>   replicates 1969ea14c7dda04279a6457ff9aac71c181c9b86<br>M: d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>M: 1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>M: cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>S: 35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379<br>   slots: (0 slots) slave<br>   replicates cc3ab037bf9ff76438b6f16e43fab783ec915375<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>&gt;&gt;&gt; Send CLUSTER MEET to node 10.0.0.77:6379 to make it join the cluster.<br>Waiting <span class="hljs-keyword">for</span> the cluster to join<br><br>&gt;&gt;&gt; Configure node as replica of 10.0.0.67:6379.<br>[OK] New node added correctly.<br></code></pre></td></tr></table></figure>

<h4 id="3-3-9-11-为新的master添加新的slave节点——方法二"><a href="#3-3-9-11-为新的master添加新的slave节点——方法二" class="headerlink" title="3.3.9.11 为新的master添加新的slave节点——方法二"></a>3.3.9.11 为新的master添加新的slave节点——方法二</h4><p>添加新的slave节点（此时新节点的状态为master），通过命令将新的节点制定为某个master的slave节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 --cluster add-node 10.0.0.77:6379 10.0.0.7:6379</span><br><span class="hljs-comment"># redis-cli -a 123456 --cluster add-node 10.0.0.77:6379 10.0.0.7:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>&gt;&gt;&gt; Adding node 10.0.0.77:6379 to cluster 10.0.0.7:6379<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)<br>M: 7547a68b099501ef83df068d1f8b25d72f066127 10.0.0.7:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>M: e27a62a24d85470eaa22b433e50de907f113e529 10.0.0.67:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br>M: 7c0741e11faeeb3650ff10351bf92733644c6fd2 10.0.0.17:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>S: 67f33202107ed05087622be5fb59ce14f09dc03d 10.0.0.57:6379<br>   slots: (0 slots) slave<br>   replicates 7c0741e11faeeb3650ff10351bf92733644c6fd2<br>M: 1856409b7e276d5634b51b6a3d5424a063c9a69a 10.0.0.27:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>S: 95d755227633d1e44cb47daa4fb75bb19f06d3f4 10.0.0.47:6379<br>   slots: (0 slots) slave<br>   replicates 7547a68b099501ef83df068d1f8b25d72f066127<br>S: 2b6b3c1b8aad214dd01f033822e1b9e87aa82f68 10.0.0.37:6379<br>   slots: (0 slots) slave<br>   replicates 1856409b7e276d5634b51b6a3d5424a063c9a69a<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>&gt;&gt;&gt; Send CLUSTER MEET to node 10.0.0.77:6379 to make it join the cluster.<br>[OK] New node added correctly.<br><br><span class="hljs-comment"># redis-cli -h 10.0.0.77 -p 6379 -a 123456</span><br>10.0.0.78:6380&gt; CLUSTER NODES <span class="hljs-comment">#查看当前集群节点，找到目标master 的ID</span><br>10.0.0.78:6380&gt; CLUSTER REPLICATE e27a62a24d85470eaa22b433e50de907f113e529 <span class="hljs-comment">#将其设置slave，命令格式为cluster replicate MASTERID</span><br>OK<br>10.0.0.78:6380&gt; CLUSTER NODES <span class="hljs-comment">#再次查看集群节点状态，验证节点是否已经更改为指定master 的</span><br>slave<br><span class="hljs-comment">#或</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.77 -p 6379 -a 123456 CLUSTER NODES</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.77 -p 6379 -a 123456 CLUSTER REPLICATE e27a62a24d85470eaa22b433e50de907f113e529</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-9-12-验证slave节点是否成功添加"><a href="#3-3-9-12-验证slave节点是否成功添加" class="headerlink" title="3.3.9.12 验证slave节点是否成功添加"></a>3.3.9.12 验证slave节点是否成功添加</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -a 123456 --cluster check 10.0.0.7:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.7:6379 (1969ea14...) -&gt; 2511 keys | 4096 slots | 1 slaves.<br>10.0.0.67:6379 (aeb17968...) -&gt; 2476 keys | 4096 slots | 1 slaves.<br>10.0.0.57:6379 (d1fd7d43...) -&gt; 2516 keys | 4096 slots | 1 slaves.<br>10.0.0.27:6379 (cc3ab037...) -&gt; 2501 keys | 4096 slots | 1 slaves.<br>[OK] 10004 keys <span class="hljs-keyword">in</span> 4 masters.<br>0.61 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)<br>M: 1969ea14c7dda04279a6457ff9aac71c181c9b86 10.0.0.7:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>S: 35700376d5c98b075249a633d4d9408ce6ec59ee 10.0.0.37:6379<br>   slots: (0 slots) slave<br>   replicates cc3ab037bf9ff76438b6f16e43fab783ec915375<br>S: 50b34ce50df322af8948ea9ea8abac5aea46102a 10.0.0.47:6379<br>   slots: (0 slots) slave<br>   replicates 1969ea14c7dda04279a6457ff9aac71c181c9b86<br>M: aeb17968edb87366188969c59a14f43ab95aa207 10.0.0.67:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br>   1 additional replica(s)<br>M: d1fd7d43a18ea97e32d7633ac0f780c282fa0570 10.0.0.57:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>M: cc3ab037bf9ff76438b6f16e43fab783ec915375 10.0.0.27:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>S: 049ce14960e02a0dc5bb8997d221cd88045f7a57 10.0.0.77:6379<br>   slots: (0 slots) slave<br>   replicates aeb17968edb87366188969c59a14f43ab95aa207<br>S: ccef8619ee263fad8652562288dc3df9456ed97a 10.0.0.17:6379<br>   slots: (0 slots) slave<br>   replicates d1fd7d43a18ea97e32d7633ac0f780c282fa0570<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br><span class="hljs-comment"># redis-cli -a 123456 -h 10.0.0.7 --no-auth-warning cluster info</span><br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:8 <span class="hljs-comment">#8个节点</span><br>cluster_size:4 <span class="hljs-comment">#4组主从</span><br>cluster_current_epoch:8<br>cluster_my_epoch:1<br>cluster_stats_messages_ping_sent:19531<br>cluster_stats_messages_pong_sent:19243<br>cluster_stats_messages_fail_sent:14<br>cluster_stats_messages_auth-ack_sent:1<br>cluster_stats_messages_update_sent:10<br>cluster_stats_messages_sent:38799<br>cluster_stats_messages_ping_received:19236<br>cluster_stats_messages_pong_received:17860<br>cluster_stats_messages_meet_received:7<br>cluster_stats_messages_fail_received:3<br>cluster_stats_messages_auth-req_received:1<br>cluster_stats_messages_update_received:4<br>cluster_stats_messages_received:37111<br></code></pre></td></tr></table></figure>

<h3 id="3-3-10-基于Redis4的cluster集群节点维护"><a href="#3-3-10-基于Redis4的cluster集群节点维护" class="headerlink" title="3.3.10 基于Redis4的cluster集群节点维护"></a>3.3.10 基于Redis4的cluster集群节点维护</h3><h5 id="3-3-8-1-1-新节点安装redis"><a href="#3-3-8-1-1-新节点安装redis" class="headerlink" title="3.3.8.1.1 新节点安装redis"></a>3.3.8.1.1 新节点安装redis</h5><p>过程略</p>
<h5 id="3-3-8-1-2-修改配置文件"><a href="#3-3-8-1-2-修改配置文件" class="headerlink" title="3.3.8.1.2 修改配置文件"></a>3.3.8.1.2 修改配置文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#配置node7节点</span><br>[root@redis-node7 ~]<span class="hljs-comment">#dnf -y install redis</span><br>[root@redis-node7 ~]<span class="hljs-comment">#sed -i.bak -e &#x27;s/bind 127.0.0.1/bind 0.0.0.0/&#x27; -e &#x27;/masterauth/a masterauth 123456&#x27; -e &#x27;/# requirepass/a requirepass 123456&#x27; -e &#x27;/# cluster-enabled yes/a cluster-enabled yes&#x27; -e &#x27;/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf&#x27; -e &#x27;/cluster-require-full-coverage yes/c cluster-require-full-coverage no&#x27; /etc/redis.conf</span><br>[root@redis-node7 ~]<span class="hljs-comment">#systemctl enable --now redis</span><br><br><span class="hljs-comment">#配置node8节点</span><br>[root@redis-node8 ~]<span class="hljs-comment">#dnf -y install redis</span><br>[root@redis-node8 ~]<span class="hljs-comment">#sed -i.bak -e &#x27;s/bind 127.0.0.1/bind 0.0.0.0/&#x27; -e &#x27;/masterauth/a masterauth 123456&#x27; -e &#x27;/# requirepass/a requirepass 123456&#x27; -e &#x27;/# cluster-enabled yes/a cluster-enabled yes&#x27; -e &#x27;/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf&#x27; -e &#x27;/cluster-require-full-coverage yes/c cluster-require-full-coverage no&#x27; /etc/redis.conf</span><br><br>[root@redis-node8 ~]<span class="hljs-comment">#systemctl enable --now redis</span><br></code></pre></td></tr></table></figure>

<h5 id="3-3-7-1-2-添加新的master节点到集群"><a href="#3-3-7-1-2-添加新的master节点到集群" class="headerlink" title="3.3.7.1.2 添加新的master节点到集群"></a>3.3.7.1.2 添加新的master节点到集群</h5><p>使用以下命令添加新节点，要添加的新redis节点IP和端口添加到的已有的集群中任意节点的IP:端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">add-node new_host:new_port existing_host:existing_port [--slave --master-id &lt;arg&gt;]<br><br><span class="hljs-comment">#说明：</span><br>new_host:new_port <span class="hljs-comment">#为新添加的主机的IP和端口</span><br>existing_host:existing_port <span class="hljs-comment">#为已有的集群中任意节点的IP和端口</span><br></code></pre></td></tr></table></figure>

<p><strong>Redis 3/4 添加方式：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#把新的Redis 节点10.0.0.37添加到当前Redis集群当中。</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb add-node 10.0.0.37:6379 10.0.0.7:6379</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb info 10.0.0.7:6379</span><br>10.0.0.7:6379 (29a83275...) -&gt; 3331 keys | 5461 slots | 1 slaves.<br>10.0.0.37:6379 (12ca273a...) -&gt; 0 keys | 0 slots | 0 slaves.<br>10.0.0.27:6379 (90b20613...) -&gt; 3329 keys | 5461 slots | 1 slaves.<br>10.0.0.17:6379 (fb34c3a7...) -&gt; 3340 keys | 5462 slots | 1 slaves.<br>[OK] 10000 keys <span class="hljs-keyword">in</span> 4 masters.<br>0.61 keys per slot on average.<br></code></pre></td></tr></table></figure>

<h5 id="3-3-7-1-3-在新的master上重新分配槽位"><a href="#3-3-7-1-3-在新的master上重新分配槽位" class="headerlink" title="3.3.7.1.3 在新的master上重新分配槽位"></a>3.3.7.1.3 在新的master上重新分配槽位</h5><p>新的node节点加到集群之后，默认是master节点，但是没有slots，需要重新分配</p>
<p>添加主机之后需要对添加至集群种的新主机重新分片，否则其没有分片也就无法写入数据。</p>
<p><strong>注意: 重新分配槽位需要清空数据,所以需要先备份数据（让开发导出redis数据，清空redis数据）,扩展后再恢复数据（扩容完成后再导入回去）</strong></p>
<p>Redis 3/4:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment"># redis-trib.rb check 10.0.0.67:6379 #当前状态&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.67:6379)</span><br>M: 7961583d836ea892b3c818913436cc6a195481da 10.0.0.67:6379<br>   slots: (0 slots) master<br>   0 additional replica(s)<br>S: 59f3129bb6ae27e2250da6c58886ff552096b972 10.0.0.47:6379<br>   slots: (0 slots) slave<br>   replicates 3534d31f0953014011642be9be0f91ea93bc69aa<br>S: 9621feef2ca069f678a7f7e601f69804782efc0f 10.0.0.57:6379<br>   slots: (0 slots) slave<br>   replicates 408483a9641c063ad67b7840dd80a7357fc2615a<br>M: 408483a9641c063ad67b7840dd80a7357fc2615a 10.0.0.17:6379<br>   slots:5461-10922 (5462 slots) master<br>   1 additional replica(s)<br>M: 6a65e24cc2127cb4dd6b4f8d19c7388835ab5a5e 10.0.0.27:6379<br>   slots:10923-16383 (5461 slots) master<br>   1 additional replica(s)<br>S: 989a26e3744b5731030744393d579a364c0b2dac 10.0.0.37:6379<br>   slots: (0 slots) slave<br>   replicates 6a65e24cc2127cb4dd6b4f8d19c7388835ab5a5e<br>M: 3534d31f0953014011642be9be0f91ea93bc69aa 10.0.0.7:6379<br>   slots:0-5460 (5461 slots) master<br>   1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>[root@redis-node1 ~]<span class="hljs-comment"># redis-trib.rb reshard &lt;任意节点&gt;:6379 #重新分片</span><br>[root@redis-node1 ~]<span class="hljs-comment"># redis-trib.rb fix 10.0.0.67:6379 #如果迁移失败使用此命令修复集群</span><br></code></pre></td></tr></table></figure>

<h5 id="3-3-7-1-4-使用redis4-0-14发生迁槽失败应对"><a href="#3-3-7-1-4-使用redis4-0-14发生迁槽失败应对" class="headerlink" title="3.3.7.1.4 使用redis4.0.14发生迁槽失败应对"></a>3.3.7.1.4 使用redis4.0.14发生迁槽失败应对</h5><h5 id="3-3-7-1-6-为新的master添加新的slave节点"><a href="#3-3-7-1-6-为新的master添加新的slave节点" class="headerlink" title="3.3.7.1.6 为新的master添加新的slave节点"></a>3.3.7.1.6 为新的master添加新的slave节点</h5><p>需要再向当前的Redis集群中添加一个Redis单机服务器10.0.0.78，用于解决当前10.0.0.68单机的潜在宕机问题，即实现响应的高可用功能，有两种方式：<br><strong>方法1：在新加节点到集群时，直接将之设置为slave</strong><br><strong>Redis 3/4 添加方式：</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">redis-trib.rb  add-node --slave --master-id 750cab050bc81f2655ed53900fd43d2e64423333 10.0.0.77:6379 &lt;任意集群节点&gt;:6379<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看当前状态</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster check 10.0.0.8:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.8:6379 (cb028b83...) -&gt; 5019 keys | 4096 slots | 1 slaves.<br>10.0.0.68:6379 (d6e2eca6...) -&gt; 4948 keys | 4096 slots | 0 slaves.<br>10.0.0.48:6379 (d04e524d...) -&gt; 5033 keys | 4096 slots | 1 slaves.<br>10.0.0.28:6379 (d34da866...) -&gt; 5000 keys | 4096 slots | 1 slaves.<br>[OK] 20000 keys <span class="hljs-keyword">in</span> 4 masters.<br>1.22 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)<br>M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379<br> slots:[1365-5460] (4096 slots) master<br> 1 additional replica(s)<br>M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379<br> slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br>S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379<br> slots: (0 slots) slave<br> replicates d34da8666a6f587283a1c2fca5d13691407f9462<br>S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379<br> slots: (0 slots) slave<br> replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7<br>M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379<br> slots:[6827-10922] (4096 slots) master<br> 1 additional replica(s)<br>S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379<br> slots: (0 slots) slave<br> replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057<br>M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379<br> slots:[12288-16383] (4096 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br><span class="hljs-comment">#直接加为slave节点</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster add-node 10.0.0.78:6379 10.0.0.8:6379 --cluster-slave --cluster-master-id d6e2eca6b338b717923f64866bd31d42e52edc98</span><br><br><span class="hljs-comment">#验证是否成功</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster check 10.0.0.8:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.8:6379 (cb028b83...) -&gt; 5019 keys | 4096 slots | 1 slaves.<br>10.0.0.68:6379 (d6e2eca6...) -&gt; 4948 keys | 4096 slots | 1 slaves.<br>10.0.0.48:6379 (d04e524d...) -&gt; 5033 keys | 4096 slots | 1 slaves.<br>10.0.0.28:6379 (d34da866...) -&gt; 5000 keys | 4096 slots | 1 slaves.<br>[OK] 20000 keys <span class="hljs-keyword">in</span> 4 masters.<br>1.22 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)<br>M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379<br> slots:[1365-5460] (4096 slots) master<br> 1 additional replica(s)<br>M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379<br> slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br> 1 additional replica(s)<br>S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379<br> slots: (0 slots) slave<br> replicates d6e2eca6b338b717923f64866bd31d42e52edc98<br>S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379<br> slots: (0 slots) slave<br>  replicates d34da8666a6f587283a1c2fca5d13691407f9462<br>S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379<br> slots: (0 slots) slave<br> replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7<br>M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379<br> slots:[6827-10922] (4096 slots) master<br> 1 additional replica(s)<br>S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379<br> slots: (0 slots) slave<br> replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057<br>M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379<br> slots:[12288-16383] (4096 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -a 123456 -h 10.0.0.8 --no-auth-warning cluster info</span><br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:8  <span class="hljs-comment">#8个节点</span><br>cluster_size:4      <span class="hljs-comment">#4组主从</span><br>cluster_current_epoch:11<br>cluster_my_epoch:10<br>cluster_stats_messages_ping_sent:1810<br>cluster_stats_messages_pong_sent:1423<br>cluster_stats_messages_auth-req_sent:5<br>cluster_stats_messages_update_sent:14<br>cluster_stats_messages_sent:3252<br>cluster_stats_messages_ping_received:1417<br>cluster_stats_messages_pong_received:1368<br>cluster_stats_messages_meet_received:2<br>cluster_stats_messages_fail_received:2<br>cluster_stats_messages_auth-ack_received:2<br>cluster_stats_messages_update_received:4<br>cluster_stats_messages_received:2795<br></code></pre></td></tr></table></figure>

<p><strong>方法2：先将新节点加入集群，再修改为slave</strong><br><strong>为新的master添加slave节点</strong><br>Redis 3/4 版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment">#redis-trib.rb add-node 10.0.0.78:6379 10.0.0.8:6379</span><br></code></pre></td></tr></table></figure>

<p>Redis 5 版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#把10.0.0.78:6379添加到集群中：</span><br>[root@redis-node1 ~]<br></code></pre></td></tr></table></figure>

<p><strong>更改新节点更改状态为slave：</strong></p>
<p>需要手动将其指定为某个master的slave，否则其默认角色为master。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@redis-node1 ~]<span class="hljs-comment"># #登录到新添加节点</span><br><br></code></pre></td></tr></table></figure>

<h4 id="3-3-7-2-集群维护之动态缩容"><a href="#3-3-7-2-集群维护之动态缩容" class="headerlink" title="3.3.7.2 集群维护之动态缩容"></a>3.3.7.2 集群维护之动态缩容</h4><p><strong>实战案例：</strong><br>由于10.0.0.8服务器使用年限已经超过三年，已经超过厂商质保期而且硬盘出现异常报警，经运维部架构师提交方案并同开发同事开会商议，决定将现有Redis集群的8台主服务器中的master 10.0.0.7和对应的slave 10.0.0.37 临时下线，三台服务器的并发写入性能足够支出未来1-2年的业务需求</p>
<p><strong>删除节点过程：</strong><br>添加节点的时候是先添加node节点到集群，然后分配槽位，删除节点的操作与添加节点的操作正好相反，是先将被删除的Redis node上的槽位迁移到集群中的其他Redis node节点上，然后再将其删除，如果一个Redis node节点上的槽位没有被完全迁移，删除该node的时候会提示有数据且无法删除。</p>
<h5 id="3-3-7-2-1-迁移master-的槽位之其他master"><a href="#3-3-7-2-1-迁移master-的槽位之其他master" class="headerlink" title="3.3.7.2.1 迁移master 的槽位之其他master"></a>3.3.7.2.1 迁移master 的槽位之其他master</h5><p><strong>注意: 被迁移Redis master源服务器必须保证没有数据，否则迁移报错并会被强制中断。</strong><br>Redis 3/4 版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment"># redis-trib.rb reshard 10.0.0.8:6379</span><br>[root@redis-node1 ~]<span class="hljs-comment"># redis-trib.rb fix 10.0.0.8:6379 #如果迁移失败使用此命令修复集群</span><br></code></pre></td></tr></table></figure>

<p>Redis 5版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看当前状态</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster check 10.0.0.8:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface<br>may not be safe.<br>10.0.0.8:6379 (cb028b83...) -&gt; 5019 keys | 4096 slots | 1 slaves.<br>10.0.0.68:6379 (d6e2eca6...) -&gt; 4948 keys | 4096 slots | 1 slaves.<br>10.0.0.48:6379 (d04e524d...) -&gt; 5033 keys | 4096 slots | 1 slaves.<br>10.0.0.28:6379 (d34da866...) -&gt; 5000 keys | 4096 slots | 1 slaves.<br>[OK] 20000 keys <span class="hljs-keyword">in</span> 4 masters.<br>1.22 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)<br>M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379<br> slots:[1365-5460] (4096 slots) master<br> 1 additional replica(s)<br>M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379<br> slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br> 1 additional replica(s)<br>S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379<br> slots: (0 slots) slave<br> replicates d6e2eca6b338b717923f64866bd31d42e52edc98<br>S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379<br> slots: (0 slots) slave<br> replicates d34da8666a6f587283a1c2fca5d13691407f9462<br>S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379<br> slots: (0 slots) slave<br> replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7<br>M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379<br> slots:[6827-10922] (4096 slots) master<br> 1 additional replica(s)<br>S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379<br> slots: (0 slots) slave<br> replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057<br>M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379<br> slots:[12288-16383] (4096 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br><span class="hljs-comment">#连接到任意集群节点，#最后1365个slot从10.0.0.8移动到第一个master节点10.0.0.28上</span><br>[root@redis-node1 ~]<span class="hljs-comment"># redis-cli -a 123456 --cluster reshard 10.0.0.18:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.18:6379)<br>S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379<br> slots: (0 slots) slave<br> replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057<br>S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379<br> slots: (0 slots) slave<br> replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7<br>S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379<br> slots: (0 slots) slave<br> replicates d6e2eca6b338b717923f64866bd31d42e52edc98<br>M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379<br> slots:[1365-5460] (4096 slots) master<br> 1 additional replica(s)<br>M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379<br> slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br> 1 additional replica(s)<br>S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379<br> slots: (0 slots) slave<br> replicates d34da8666a6f587283a1c2fca5d13691407f9462<br>M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379<br> slots:[6827-10922] (4096 slots) master<br> 1 additional replica(s)<br>M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379<br> slots:[12288-16383] (4096 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>How many slots <span class="hljs-keyword">do</span> you want to move (from 1 to 16384)? 1356 <span class="hljs-comment">#共4096/3分别给其它三个master节点</span><br>What is the receiving node ID? d34da8666a6f587283a1c2fca5d13691407f9462 <span class="hljs-comment">#master 10.0.0.28</span><br>Please enter all the <span class="hljs-built_in">source</span> node IDs.<br>  Type <span class="hljs-string">&#x27;all&#x27;</span> to use all the nodes as <span class="hljs-built_in">source</span> nodes <span class="hljs-keyword">for</span> the <span class="hljs-built_in">hash</span> slots.<br>  Type <span class="hljs-string">&#x27;done&#x27;</span> once you entered all the <span class="hljs-built_in">source</span> nodes IDs.<br>Source node <span class="hljs-comment">#1: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 #输入要删除10.0.0.8节点ID</span><br>Source node <span class="hljs-comment">#2: done</span><br><br>Ready to move 1356 slots.<br>Source nodes:<br> M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>Destination node:<br> M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>Resharding plan:<br> Moving slot 1365 from cb028b83f9dc463d732f6e76ca6bbcd469d948a7<br>......<br>Moving slot 2719 from cb028b83f9dc463d732f6e76ca6bbcd469d948a7<br> Moving slot 2720 from cb028b83f9dc463d732f6e76ca6bbcd469d948a7<br>Do you want to proceed with the proposed reshard plan (yes/no)? yes <span class="hljs-comment">#确定</span><br>......<br>Moving slot 2718 from 10.0.0.8:6379 to 10.0.0.28:6379: ..<br>Moving slot 2719 from 10.0.0.8:6379 to 10.0.0.28:6379: .<br>Moving slot 2720 from 10.0.0.8:6379 to 10.0.0.28:6379: ..<br><br><span class="hljs-comment">#非交互式方式</span><br><span class="hljs-comment">#再将1365个slot从10.0.0.8移动到第二个master节点10.0.0.48上</span><br>[root@redis-node1 ~]<span class="hljs-comment"># redis-cli -a 123456 --cluster reshard 10.0.0.18:6379 -- cluster-slots 1365 --cluster-from cb028b83f9dc463d732f6e76ca6bbcd469d948a7 -- cluster-to d04e524daec4d8e22bdada7f21a9487c2d3e1057 --cluster-yes</span><br><br><span class="hljs-comment">#最后的slot从10.0.0.8移动到第三个master节点10.0.0.68上</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster reshard 10.0.0.18:6379 -- cluster-slots 1375 --cluster-from cb028b83f9dc463d732f6e76ca6bbcd469d948a7 -- cluster-to d6e2eca6b338b717923f64866bd31d42e52edc98 --cluster-yes</span><br><br><span class="hljs-comment">#确认10.0.0.8的所有slot都移走了，上面的slave也自动删除，成为其它master的slave</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster check 10.0.0.8:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.8:6379 (cb028b83...) -&gt; 0 keys | 0 slots | 0 slaves.<br>10.0.0.68:6379 (d6e2eca6...) -&gt; 6631 keys | 5471 slots | 2 slaves.<br>10.0.0.48:6379 (d04e524d...) -&gt; 6694 keys | 5461 slots | 1 slaves.<br>10.0.0.28:6379 (d34da866...) -&gt; 6675 keys | 5452 slots | 1 slaves.<br>[OK] 20000 keys <span class="hljs-keyword">in</span> 4 masters.<br>1.22 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)<br>M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379<br> slots: (0 slots) master<br>M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379<br> slots:[0-1364],[4086-6826],[10923-12287] (5471 slots) master<br> 2 additional replica(s)<br>S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379<br> slots: (0 slots) slave<br> replicates d6e2eca6b338b717923f64866bd31d42e52edc98<br>S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379<br> slots: (0 slots) slave<br> replicates d34da8666a6f587283a1c2fca5d13691407f9462<br>S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379<br> slots: (0 slots) slave<br>  replicates d6e2eca6b338b717923f64866bd31d42e52edc98<br>M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379<br> slots:[2721-4085],[6827-10922] (5461 slots) master<br> 1 additional replica(s)<br>S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379<br> slots: (0 slots) slave<br> replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057<br>M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379<br> slots:[1365-2720],[12288-16383] (5452 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br><span class="hljs-comment">#原有的10.0.0.38自动成为10.0.0.68的slave</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 -h 10.0.0.68 INFO replication</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:2<br>slave0:ip=10.0.0.78,port=6379,state=online,offset=129390,lag=0<br>slave1:ip=10.0.0.38,port=6379,state=online,offset=129390,lag=0<br>master_replid:43e3e107a0acb1fd5a97240fc4b2bd8fc85b113f<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:129404<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:129404<br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -a 123456 -h 10.0.0.8 --no-auth-warning cluster info</span><br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:8  <span class="hljs-comment">#集群中8个节点</span><br>cluster_size:3    <span class="hljs-comment">#少了一个主从的slot</span><br>cluster_current_epoch:16<br>cluster_my_epoch:13<br>cluster_stats_messages_ping_sent:3165<br>cluster_stats_messages_pong_sent:2489<br>cluster_stats_messages_fail_sent:6<br>cluster_stats_messages_auth-req_sent:5<br>cluster_stats_messages_auth-ack_sent:1<br>cluster_stats_messages_update_sent:27<br>cluster_stats_messages_sent:5693<br>cluster_stats_messages_ping_received:2483<br>cluster_stats_messages_pong_received:2400<br>cluster_stats_messages_meet_received:2<br>cluster_stats_messages_fail_received:2<br>cluster_stats_messages_auth-req_received:1<br>cluster_stats_messages_auth-ack_received:2<br>cluster_stats_messages_update_received:4<br>cluster_stats_messages_received:4894<br></code></pre></td></tr></table></figure>

<h5 id="3-3-7-2-2-从集群删除服务器"><a href="#3-3-7-2-2-从集群删除服务器" class="headerlink" title="3.3.7.2.2 从集群删除服务器"></a>3.3.7.2.2 从集群删除服务器</h5><p>虽然槽位已经迁移完成，但是服务器IP信息还在集群当中，因此还需要将IP信息从集群删除<br>注意: 删除服务器前,必须清除主机上面的槽位,否则会删除主机失败<br>Redis 3/4：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">#redis-trib.rb del-node &lt;要删除的服务器ip&gt;:6379 &lt;要删除服务器nodeid&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@s~]<span class="hljs-comment">#redis-trib.rb del-node 10.0.0.8:6379 dfffc371085859f2858730e1f350e9167e287073</span><br>&gt;&gt;&gt; Removing node dfffc371085859f2858730e1f350e9167e287073 from cluster<br>192.168.7.102:6379<br>&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...<br>&gt;&gt;&gt; SHUTDOWN the node.<br><br><span class="hljs-comment">#删除节点后,redis进程自动关闭</span><br><span class="hljs-comment">#删除节点信息</span><br>[root@redis-node1 ~]<span class="hljs-comment">#rm -f /apps/redis/data/nodes-6379.conf</span><br><br>[root@centos7 redis]<span class="hljs-comment"># redis-trib.rb del-node 10.0.0.37:6379 627458585c4b9a528ba87dcf34428eb4abcc0d5f</span><br>&gt;&gt;&gt; Removing node 627458585c4b9a528ba87dcf34428eb4abcc0d5f from cluster 10.0.0.37:6379<br>&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...<br>&gt;&gt;&gt; SHUTDOWN the node.<br><br><span class="hljs-comment">#删除节点后,redis进程自动关闭</span><br><span class="hljs-comment">#删除节点信息</span><br>[root@redis-node1 ~]<span class="hljs-comment">#rm -f /apps/redis/data/nodes-6379.conf</span><br></code></pre></td></tr></table></figure>

<p>Redis 5：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis-node1 ~]<span class="hljs-comment"># redis-cli -a 123456 --cluster del-node 10.0.0.8:6379 cb028b83f9dc463d732f6e76ca6bbcd469d948a7</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>&gt;&gt;&gt; Removing node cb028b83f9dc463d732f6e76ca6bbcd469d948a7 from cluster<br>10.0.0.8:6379<br>&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...<br>&gt;&gt;&gt; SHUTDOWN the node.<br><br><span class="hljs-comment">#删除节点后,redis进程自动关闭</span><br><span class="hljs-comment">#删除节点信息</span><br>[root@redis-node1 ~]<span class="hljs-comment">#rm -f /var/lib/redis/nodes-6379.conf</span><br></code></pre></td></tr></table></figure>

<h5 id="3-3-7-2-3-删除多余的slave节点验证结果"><a href="#3-3-7-2-3-删除多余的slave节点验证结果" class="headerlink" title="3.3.7.2.3 删除多余的slave节点验证结果"></a>3.3.7.2.3 删除多余的slave节点验证结果</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#验证删除成功</span><br>[root@redis-node1 ~]<span class="hljs-comment">#ss -ntl</span><br>State    Recv-Q    Send-Q  Local Address:Port   Peer Address:Port <br>  <br>LISTEN    0       128       0.0.0.0:22       0.0.0.0:*   <br> <br>LISTEN    0       128        [::]:22        [::]:* <br><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster check 10.0.0.18:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface<br>may not be safe.<br>10.0.0.68:6379 (d6e2eca6...) -&gt; 6631 keys | 5471 slots | 2 slaves.<br>10.0.0.48:6379 (d04e524d...) -&gt; 6694 keys | 5461 slots | 1 slaves.<br>10.0.0.28:6379 (d34da866...) -&gt; 6675 keys | 5452 slots | 1 slaves.<br>[OK] 20000 keys <span class="hljs-keyword">in</span> 3 masters.<br>1.22 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.18:6379)<br>S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379<br> slots: (0 slots) slave<br> replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057<br>S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379<br> slots: (0 slots) slave<br> replicates d6e2eca6b338b717923f64866bd31d42e52edc98<br>S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379<br>slots: (0 slots) slave<br> replicates d6e2eca6b338b717923f64866bd31d42e52edc98<br>M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379<br> slots:[0-1364],[4086-6826],[10923-12287] (5471 slots) master<br> 2 additional replica(s)<br>S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379<br> slots: (0 slots) slave<br> replicates d34da8666a6f587283a1c2fca5d13691407f9462<br>M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379<br> slots:[2721-4085],[6827-10922] (5461 slots) master<br> 1 additional replica(s)<br>M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379<br> slots:[1365-2720],[12288-16383] (5452 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br><span class="hljs-comment">#删除多余的slave从节点</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster del-node 10.0.0.18:6379 f9adcfb8f5a037b257af35fa548a26ffbadc852d</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>&gt;&gt;&gt; Removing node f9adcfb8f5a037b257af35fa548a26ffbadc852d from cluster<br>10.0.0.18:6379<br>&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...<br>&gt;&gt;&gt; SHUTDOWN the node.<br><br><span class="hljs-comment">#删除集群文件</span><br>[root@redis-node4 ~]<span class="hljs-comment">#rm -f /var/lib/redis/nodes-6379.conf</span><br><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster check 10.0.0.18:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.68:6379 (d6e2eca6...) -&gt; 6631 keys | 5471 slots | 1 slaves.<br>10.0.0.48:6379 (d04e524d...) -&gt; 6694 keys | 5461 slots | 1 slaves.<br>10.0.0.28:6379 (d34da866...) -&gt; 6675 keys | 5452 slots | 1 slaves.<br>[OK] 20000 keys <span class="hljs-keyword">in</span> 3 masters.<br>1.22 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.18:6379)<br>S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379<br> slots: (0 slots) slave<br> replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057<br>S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379<br> slots: (0 slots) slave<br> replicates d6e2eca6b338b717923f64866bd31d42e52edc98<br>M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379<br> slots:[0-1364],[4086-6826],[10923-12287] (5471 slots) master<br> 1 additional replica(s)<br>S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379<br> slots: (0 slots) slave<br> replicates d34da8666a6f587283a1c2fca5d13691407f9462<br>M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379<br> slots:[2721-4085],[6827-10922] (5461 slots) master<br> 1 additional replica(s)<br>M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379<br>slots:[1365-2720],[12288-16383] (5452 slots) master<br> 1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster info 10.0.0.18:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>10.0.0.68:6379 (d6e2eca6...) -&gt; 6631 keys | 5471 slots | 1 slaves.<br>10.0.0.48:6379 (d04e524d...) -&gt; 6694 keys | 5461 slots | 1 slaves.<br>10.0.0.28:6379 (d34da866...) -&gt; 6675 keys | 5452 slots | 1 slaves.<br>[OK] 20000 keys <span class="hljs-keyword">in</span> 3 masters.<br>1.22 keys per slot on average.<br><br><span class="hljs-comment">#查看集群信息</span><br>[root@redis-node1 ~]<span class="hljs-comment">#redis-cli -a 123456 -h 10.0.0.18 CLUSTER INFO</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:6  <span class="hljs-comment">#只有6个节点</span><br>cluster_size:3<br>cluster_current_epoch:11<br>cluster_my_epoch:10<br>cluster_stats_messages_ping_sent:12147<br>cluster_stats_messages_pong_sent:12274<br>cluster_stats_messages_update_sent:14<br>cluster_stats_messages_sent:24435<br>cluster_stats_messages_ping_received:12271<br>cluster_stats_messages_pong_received:12147<br>cluster_stats_messages_meet_received:3<br>cluster_stats_messages_update_received:28<br>cluster_stats_messages_received:24449<br></code></pre></td></tr></table></figure>

<h3 id="3-3-11-Redis-Cluster之数据导入导出（让开发做数据导出导入的工作）"><a href="#3-3-11-Redis-Cluster之数据导入导出（让开发做数据导出导入的工作）" class="headerlink" title="3.3.11 Redis Cluster之数据导入导出（让开发做数据导出导入的工作）"></a>3.3.11 Redis Cluster之数据导入导出（让开发做数据导出导入的工作）</h3><p>官方提供了离线迁移数据到集群的工具,有些公司开发了离线迁移工具</p>
<ul>
<li>官方工具: redis-cli –cluster import（redis5.x版本）</li>
<li>第三方在线迁移工具: 模拟slave 节点实现, 比如: 唯品会 redis-migrate-tool , 豌豆荚 redis-port redis-dump</li>
</ul>
<h3 id="3-3-12-Redis5单机数据导入到Redis5集群"><a href="#3-3-12-Redis5单机数据导入到Redis5集群" class="headerlink" title="3.3.12 Redis5单机数据导入到Redis5集群"></a>3.3.12 Redis5单机数据导入到Redis5集群</h3><p><strong>实战案例：</strong><br>公司将redis cluster部署完成之后，需要将之前的数据导入之Redis cluster集群，但是由于Redis cluster使用的分片保存key的机制，因此使用传统的AOF文件或RDB快照无法满足需求，因此需要使用集群数据导入命令完成。</p>
<p>其他参考方法：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://10691.cn/591.html<br></code></pre></td></tr></table></figure>



<p><strong>注意1: 导入数据需要redis cluster不能与被导入的数据有重复的key名称，否则导入不成功或中断。</strong></p>
<h4 id="3-3-11-1-redis-cli-–cluster-import-数据导入（从单主机redis导入到redis集群）"><a href="#3-3-11-1-redis-cli-–cluster-import-数据导入（从单主机redis导入到redis集群）" class="headerlink" title="3.3.11.1 redis-cli –cluster import 数据导入（从单主机redis导入到redis集群）"></a>3.3.11.1 redis-cli –cluster import 数据导入（从单主机redis导入到redis集群）</h4><h5 id="3-3-11-1-1-基础环境准备"><a href="#3-3-11-1-1-基础环境准备" class="headerlink" title="3.3.11.1.1 基础环境准备"></a>3.3.11.1.1 基础环境准备</h5><p>导入数据之前需要关闭各redis 服务器的密码，包括集群中的各node和源Redis server，避免认证带来的环境不一致从而无法导入，可以加参数–cluster-replace 强制替换Redis cluster已有的key。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在所有节点包括master和slave节点上关闭各Redis密码认证</span><br>[root@redis ~]<span class="hljs-comment"># redis-cli -h 10.0.0.18 -p 6379 -a 123456 --no-auth-warning CONFIG SET requirepass &quot;&quot;</span><br>OK<br></code></pre></td></tr></table></figure>

<h5 id="3-3-11-1-2-执行数据导入"><a href="#3-3-11-1-2-执行数据导入" class="headerlink" title="3.3.11.1.2 执行数据导入"></a>3.3.11.1.2 执行数据导入</h5><p>将源Redis server的数据直接导入之 redis cluster,此方式慎用!</p>
<p>Redis 3/4：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis ~]<span class="hljs-comment"># redis-trib.rb import --from &lt;外部Redis node-IP:PORT&gt; --replace &lt;集群服务器IP:PORT&gt;</span><br></code></pre></td></tr></table></figure>

<p>Redis 5：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis ~]<span class="hljs-comment">#redis-cli --cluster import &lt;集群服务器IP:PORT&gt; --cluster-from &lt;外部Redis node-IP:PORT&gt; --cluster-copy --cluster-replace</span><br><br><span class="hljs-comment">#只使用cluster-copy，则要导入集群中的key不能存在</span><br><span class="hljs-comment">#如果集群中已有同样的key，如果需要替换，可以cluster-copy和cluster-replace联用，这样集群中的key就会被替换为外部数据</span><br></code></pre></td></tr></table></figure>

<p>范例：将非集群节点的数据导入redis cluster</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在非集群节点10.0.0.78生成数据</span><br>[root@centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.78<br>[root@centos8 ~]<span class="hljs-comment">#cat redis_test.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#Author: wangxiaochun</span><br><span class="hljs-comment">#QQ: 29308620</span><br><span class="hljs-comment">#Date: 2020-02-03</span><br><span class="hljs-comment">#FileName： redis.sh</span><br><span class="hljs-comment">#URL: http://www.wangxiaochun.com</span><br><span class="hljs-comment">#Description： The test script</span><br><span class="hljs-comment">#Copyright (C): 2020 All rights reserved</span><br><span class="hljs-comment">#********************************************************************</span><br>NUM=10<br>PASS=123456<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> `seq <span class="hljs-variable">$NUM</span>`;<span class="hljs-keyword">do</span><br> redis-cli -h 127.0.0.1 -a <span class="hljs-string">&quot;<span class="hljs-variable">$PASS</span>&quot;</span>  --no-auth-warning  <span class="hljs-built_in">set</span> testkey<span class="hljs-variable">$&#123;i&#125;</span><br>testvalue<span class="hljs-variable">$&#123;i&#125;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;testkey<span class="hljs-variable">$&#123;i&#125;</span> testvalue<span class="hljs-variable">$&#123;i&#125;</span> 写入完成&quot;</span><br><span class="hljs-keyword">done</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NUM</span>个key写入到Redis完成&quot;</span> <br><br>[root@centos8 ~]<span class="hljs-comment">#bash redis_test.sh</span><br>OK<br>testkey1 testvalue1 写入完成<br>OK<br>testkey2 testvalue2 写入完成<br>OK<br>testkey3 testvalue3 写入完成<br>OK<br>testkey4 testvalue4 写入完成<br>OK<br>testkey5 testvalue5 写入完成<br>OK<br>testkey6 testvalue6 写入完成<br>OK<br>testkey7 testvalue7 写入完成<br>OK<br>testkey8 testvalue8 写入完成<br>OK<br>testkey9 testvalue9 写入完成<br>OK<br>testkey10 testvalue10 写入完成<br>10个key写入到Redis完成<br><br><span class="hljs-comment">#取消需要导入的主机的密码</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.78 -p 6379 -a 123456 --no-auth-warning CONFIG SET requirepass &quot;&quot;</span><br><br><span class="hljs-comment">#取消所有集群服务器的密码</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.8 -p 6379 -a 123456 --no-auth-warning CONFIG SET requirepass &quot;&quot;</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.18 -p 6379 -a 123456 --no-auth-warning CONFIG SET requirepass &quot;&quot;</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.28 -p 6379 -a 123456 --no-auth-warning CONFIG SET requirepass &quot;&quot;</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.38 -p 6379 -a 123456 --no-auth-warning CONFIG SET requirepass &quot;&quot;</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.48 -p 6379 -a 123456 --no-auth-warning CONFIG SET requirepass &quot;&quot;</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.58 -p 6379 -a 123456 --no-auth-warning CONFIG SET requirepass &quot;&quot;</span><br><br><span class="hljs-comment">#导入数据至集群</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli --cluster import 10.0.0.8:6379 --cluster-from 10.0.0.78:6379 --cluster-copy --cluster-replace</span><br>&gt;&gt;&gt; Importing data from 10.0.0.78:6379 to cluster 10.0.0.8:6379<br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)<br>M: a177c5cbc2407ebb6230ea7e2a7de914bf8c2dab 10.0.0.8:6379<br> slots:[0-5461] (5462 slots) master<br> 1 additional replica(s)<br>M: 4f146b1ac51549469036a272c60ea97f065ef832 10.0.0.28:6379<br> slots:[10923-16383] (5461 slots) master<br> 1 additional replica(s)<br>S: 779a24884dbe1ceb848a685c669ec5326e6c8944 10.0.0.48:6379<br> slots: (0 slots) slave<br> replicates 97c5dcc3f33c2fc75c7fdded25d05d2930a312c0<br>M: 97c5dcc3f33c2fc75c7fdded25d05d2930a312c0 10.0.0.18:6379<br> slots:[5462-10922] (5461 slots) master<br> 1 additional replica(s)<br>S: 07231a50043d010426c83f3b0788e6b92e62050f 10.0.0.58:6379<br> slots: (0 slots) slave<br>  replicates 4f146b1ac51549469036a272c60ea97f065ef832<br>S: cb20d58870fe05de8462787cf9947239f4bc5629 10.0.0.38:6379<br> slots: (0 slots) slave<br> replicates a177c5cbc2407ebb6230ea7e2a7de914bf8c2dab<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>*** Importing 10 keys from DB 0<br>Migrating testkey4 to 10.0.0.18:6379: OK<br>Migrating testkey8 to 10.0.0.18:6379: OK<br>Migrating testkey6 to 10.0.0.28:6379: OK<br>Migrating testkey1 to 10.0.0.8:6379: OK<br>Migrating testkey5 to 10.0.0.8:6379: OK<br>Migrating testkey10 to 10.0.0.28:6379: OK<br>Migrating testkey7 to 10.0.0.18:6379: OK<br>Migrating testkey9 to 10.0.0.8:6379: OK<br>Migrating testkey2 to 10.0.0.28:6379: OK<br>Migrating testkey3 to 10.0.0.18:6379: OK<br><br><span class="hljs-comment">#验证数据</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.8 keys &#x27;*&#x27;</span><br>1) <span class="hljs-string">&quot;testkey5&quot;</span><br>2) <span class="hljs-string">&quot;testkey1&quot;</span><br>3) <span class="hljs-string">&quot;testkey9&quot;</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.18 keys &#x27;*&#x27;</span><br>1) <span class="hljs-string">&quot;testkey8&quot;</span><br>2) <span class="hljs-string">&quot;testkey4&quot;</span><br>3) <span class="hljs-string">&quot;testkey3&quot;</span><br>4) <span class="hljs-string">&quot;testkey7&quot;</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.28 keys &#x27;*&#x27;</span><br>1) <span class="hljs-string">&quot;testkey6&quot;</span><br>2) <span class="hljs-string">&quot;testkey10&quot;</span><br>3) <span class="hljs-string">&quot;testkey2&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis135.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-3-8-2-redis-migrate-tool-数据导入（从单主机redis导入到redis集群）"><a href="#3-3-8-2-redis-migrate-tool-数据导入（从单主机redis导入到redis集群）" class="headerlink" title="3.3.8.2 redis-migrate-tool 数据导入（从单主机redis导入到redis集群）"></a>3.3.8.2 redis-migrate-tool 数据导入（从单主机redis导入到redis集群）</h4><p>补充教程：<a target="_blank" rel="noopener" href="https://blog.csdn.net/singgel/article/details/94596464">https://blog.csdn.net/singgel/article/details/94596464</a></p>
<h4 id="3-3-8-3-redis-dump-数据导出和导入（从redis集群导入到另外的集群）"><a href="#3-3-8-3-redis-dump-数据导出和导入（从redis集群导入到另外的集群）" class="headerlink" title="3.3.8.3 redis-dump 数据导出和导入（从redis集群导入到另外的集群）"></a>3.3.8.3 redis-dump 数据导出和导入（从redis集群导入到另外的集群）</h4><p>缺点：导出导入过程耗时</p>
<h3 id="3-3-13-集群偏斜"><a href="#3-3-13-集群偏斜" class="headerlink" title="3.3.13 集群偏斜"></a>3.3.13 集群偏斜</h3><p>redis cluster 多个节点运行一段时间后，可能会出现倾斜现象，某个节点数据偏多，内存消耗更大，或者接受用户请求访问更多</p>
<p>发生倾斜的原因可能如下:</p>
<ul>
<li>节点和槽分配不均</li>
<li>不同槽对应键值数量差异较大</li>
<li>包含bigkey，建议少用</li>
<li>内存相关配置不一致</li>
<li>热点数据不均衡 : 一致性不高时，可以使用本缓存和MQ</li>
</ul>
<p>获取指定槽位中对应键key值的个数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#redis-cli cluster countkeysinslot &#123;slot的值&#125;</span><br></code></pre></td></tr></table></figure>

<p>范例: 获取指定slot对应的key个数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#redis-cli -a 123456 cluster countkeysinslot 1</span><br>(<span class="hljs-built_in">integer</span>) 0<br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -a 123456 cluster countkeysinslot 2</span><br>(<span class="hljs-built_in">integer</span>) 0<br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -a 123456 cluster countkeysinslot 3</span><br>(<span class="hljs-built_in">integer</span>) 1<br></code></pre></td></tr></table></figure>

<p>执行自动的槽位重新平衡分布，但会影响客户端的访问，此方法慎用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#redis-cli --cluster rebalance &lt;集群节点IP:PORT&gt;</span><br></code></pre></td></tr></table></figure>

<p>范例: 执行自动的槽位重新平衡分布</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#redis-cli -a 123456 --cluster rebalance 10.0.0.8:6379</span><br>&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br>*** No rebalancing needed! All nodes are within the 2.00% threshold.<br></code></pre></td></tr></table></figure>

<p>获取bigkey ，建议在slave节点执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#redis-cli --bigkeys</span><br></code></pre></td></tr></table></figure>

<p>范例: 查找 bigkey</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#redis-cli -a 123456 --bigkeys</span><br><br><span class="hljs-comment"># Scanning the entire keyspace to find biggest keys as well as</span><br><span class="hljs-comment"># average sizes per key type. You can use -i 0.1 to sleep 0.1 sec</span><br><span class="hljs-comment"># per 100 SCAN commands (not usually needed).</span><br><br>[00.00%] Biggest string found so far <span class="hljs-string">&#x27;key8811&#x27;</span> with 9 bytes<br>[26.42%] Biggest string found so far <span class="hljs-string">&#x27;testkey1&#x27;</span> with 10 bytes<br><br>-------- summary -------<br><br>Sampled 3335 keys <span class="hljs-keyword">in</span> the keyspace!<br>Total key length <span class="hljs-keyword">in</span> bytes is 22979 (avg len 6.89)<br><br>Biggest string found <span class="hljs-string">&#x27;testkey1&#x27;</span> has 10 bytes<br><br>3335 strings with 29649 bytes (100.00% of keys, avg size 8.89)<br>0 lists with 0 items (00.00% of keys, avg size 0.00)<br>0 sets with 0 members (00.00% of keys, avg size 0.00)<br>0 hashs with 0 fields (00.00% of keys, avg size 0.00)<br>0 zsets with 0 members (00.00% of keys, avg size 0.00)<br>0 streams with 0 entries (00.00% of keys, avg size 0.00)<br></code></pre></td></tr></table></figure>

<h3 id="3-3-14-redis-cluster-的局限性"><a href="#3-3-14-redis-cluster-的局限性" class="headerlink" title="3.3.14 redis cluster 的局限性"></a>3.3.14 redis cluster 的局限性</h3><ul>
<li>大多数时客户端性能会”降低”</li>
<li>命令无法跨节点使用:mget、keys、scan、flush、sinter等</li>
<li>客户端维护更复杂:SDK和应用本身消耗(例如更多的连接池)</li>
<li>不支持多个数据库︰集群模式下只有一个db 0</li>
<li>复制只支持一层∶不支持树形复制结构,不支持级联复制</li>
<li>Key事务和Lua支持有限∶操作的key必须在一个节点,Lua和事务无法跨节点使用</li>
</ul>
<p>范例: 跨slot的局限性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#redis-cli -a 123456 mget key1 key2 key3</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>(error) CROSSSLOT Keys <span class="hljs-keyword">in</span> request don<span class="hljs-string">&#x27;t hash to the same slot</span><br></code></pre></td></tr></table></figure>

<h2 id="3-4-redis-扩展集群方案"><a href="#3-4-redis-扩展集群方案" class="headerlink" title="3.4 redis 扩展集群方案"></a>3.4 redis 扩展集群方案</h2><p>在Redis 官方自带的Redis cluster集群功能出来之前，有一些开源的集群解决方案可被参考使用</p>
<h3 id="3-4-1-codis"><a href="#3-4-1-codis" class="headerlink" title="3.4.1 codis"></a>3.4.1 codis</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis136.png" srcset="/blog/img/loading.gif"></p>
<p>Codis 是一个豌豆荚开发基于go实现的分布式 Redis 解决方案, 对于上层的应用来说, 连接到 Codis<br>Proxy 和连接原生的 Redis Server 没有显著区别 (不支持的命令列表), 上层应用可以像使用单机的<br>Redis 一样使用, Codis 底层会处理请求的转发, 不停机的数据迁移等工作, 所有后边的一切事情, 对于前<br>面的客户端来说是透明的, 可以简单的认为后边连接的是一个内存无限大的 Redis 服务</p>
<p>codis-proxy相当于redis，即连接codis-proxy和连接redis是没有任何区别的，codis-proxy无状态，不负责记录是否在哪保存，数据在zookeeper记录，即codis proxy向zookeeper查询key的记录位置，<br>proxy 将请求转发到一个组进行处理，一个组里面有一个master和一个或者多个slave组成，默认有<br>1024个槽位，而redis cluster 默认有16384个槽位，其把不同的槽位的内容放在不同的group</p>
<p>Github 地址：<a target="_blank" rel="noopener" href="https://github.com/CodisLabs/codis/">https://github.com/CodisLabs/codis/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis137.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-4-2-twemproxy"><a href="#3-4-2-twemproxy" class="headerlink" title="3.4.2 twemproxy"></a>3.4.2 twemproxy</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis138.png" srcset="/blog/img/loading.gif"></p>
<p>Twemproxy是一种代理分片机制，由Twitter开源。Twemproxy作为代理，可接受来自多个程序的访问，按照proxy配置的算法，转发给后台的各个Redis服务器，再原路返回。解决了单个Redis实例承载能力的问题。Twemproxy本身也是单点，需要用Keepalived做高可用方案。通过Twemproxy可以使用多台服务器来水平扩张redis服务，可以有效的避免单点故障问题。虽然使用Twemproxy需要更多的硬件资源和在redis性能有一定的损失（twitter测试约20%），也不支持数据迁移。但是能够提高整个系统的HA,另外twemproxy实现了memcached协议</p>
<p>Github 地址：<a target="_blank" rel="noopener" href="https://github.com/twitter/twemproxy">https://github.com/twitter/twemproxy</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Redis/redis139.png" srcset="/blog/img/loading.gif"></p>
<h1 id="四、redis补充"><a href="#四、redis补充" class="headerlink" title="四、redis补充"></a>四、redis补充</h1><h2 id="4-1-亿级redis数据导出与导入"><a href="#4-1-亿级redis数据导出与导入" class="headerlink" title="4.1 亿级redis数据导出与导入"></a>4.1 亿级redis数据导出与导入</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://blog.csdn.net/dishytian/article/details/95321066<br></code></pre></td></tr></table></figure>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/linux-NoSQL-redis/">linux NoSQL redis</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7Web%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8TOMCAT/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">企业级Web应用服务器TOMCAT</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7Linux%E8%99%9A%E6%8B%9F%E5%8C%96KVM/">
                        <span class="hidden-mobile">企业级Linux虚拟化KVM</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
