

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>消息队列与微服务 - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="消息队列与微服务">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-02 14:32" pubdate>
        2021年9月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      15.9k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      233
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">消息队列与微服务</h1>
            
            <div class="markdown-body">
              <h1 id="消息队列与微服务"><a href="#消息队列与微服务" class="headerlink" title="消息队列与微服务"></a>消息队列与微服务</h1><h1 id="一、MQ-Message-queuing"><a href="#一、MQ-Message-queuing" class="headerlink" title="一、MQ(Message queuing)"></a>一、MQ(Message queuing)</h1><h2 id="1-1-MQ-由来"><a href="#1-1-MQ-由来" class="headerlink" title="1.1 MQ 由来"></a>1.1 MQ 由来</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">Message Queue 的需求由来已久，在 19 世纪 80 年代金融交易中，美国高盛等公司采用 Teknekron 公司的产品，当时的 Message queuing 软件叫做(the information bus（TIB）,后来 TIB 被电信和通讯等公司采用，然后路透社收购了 Teknekron 公司，再然后 IBM 公司开发了 MQSeries，并且微软也开发了 Microsoft Message Queue（MSMQ），但是这些商业 MQ 供应商的问题是厂商锁定及使用价格高昂，于是 2001 年，Java Message queuing 试图解决锁定和交互性的问题，但对应用来说反而更加麻烦了，于是2004年，摩根大通和iMatrix开始着手Advanced Message Queuing Protocol （AMQP）开放标准的开发，2006 年，AMQP 规范发布，2007年，Rabbit 技术公司基于 AMQP 标准开发的 RabbitMQ 1.0 发布。<br><br>路透社：<br>（Reuters，LSE：RTR，NASDAQ: RTRSY）是世界上最早创办的通讯社之一，也是目前英国最大的通讯社和西方四大通讯社之一，路透社是世界前三大的多媒体新闻通讯社，提供各类新闻和金融数据，在 128 个国家运行。摩根大通集团，业界称西摩或小摩，总部位于美国纽约，总资产 2.5 万亿美元，总存款 1.5 万亿美元，占美国存款总额的 25%，分行 6000 多家，是美国最大金融服务机构之一。<br><br>iMatrix 是一个企业级的 JAVA 快速开发平台。<br></code></pre></td></tr></table></figure>

<h2 id="1-2-MQ-定义"><a href="#1-2-MQ-定义" class="headerlink" title="1.2 MQ 定义"></a>1.2 MQ 定义</h2><p>消息队列的目的是为了实现各个 APP 之间的通讯，APP 基于 MQ 实现消息的发送和接收实现应用程序之间的通讯，这样多个应用程序可以运行在不同的主机上，通过 MQ 就可以实现夸网络通信，因此 MQ 实现了业务的解耦和异步机制。</p>
<h2 id="1-3-MQ-使用场合"><a href="#1-3-MQ-使用场合" class="headerlink" title="1.3 MQ 使用场合"></a>1.3 MQ 使用场合</h2><p>消息队列作为高并发系统的核心组件之一，能够帮助业务系统结构提升开发效率和系统稳定性，消息队列主要具有以下特点:</p>
<ol>
<li>削峰填谷（主要解决瞬时写压力大于应用服务能力导致消息丢失、系统奔溃等问题）</li>
<li>系统解耦（解决不同重要程度、不同能力级别系统之间依赖导致一死全死）</li>
<li>提升性能（当存在一对多调用时，可以发一条消息给消息系统，让消息系统通知相关系统）</li>
<li>蓄流压测（线上有些链路不好压测，可以通过堆积一定量消息再放开来压测）</li>
</ol>
<h2 id="1-4-MQ-分类"><a href="#1-4-MQ-分类" class="headerlink" title="1.4 MQ 分类"></a>1.4 MQ 分类</h2><p>目前主流的消息队列软件有 RabbitMQ、kafka、ActiveMQ、RocketMQ 等，还有小众的消息队列软件如 ZeroMQ、Apache Qpid 等。</p>
<p>197728723</p>
<h1 id="二、RabbitMQ"><a href="#二、RabbitMQ" class="headerlink" title="二、RabbitMQ"></a>二、RabbitMQ</h1><p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/">https://www.rabbitmq.com/</a></p>
<p>阿里云消息队列：<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/ons?spm=5176.234368.h2v3icoap.427.2620db25lcHi1Q&amp;aly_as=Tz_Lue_o">https://www.aliyun.com/product/ons?spm=5176.234368.h2v3icoap.427.2620db25lcHi1Q&amp;aly_as=Tz_Lue_o</a></p>
<h2 id="2-1-RabbitMQ简介"><a href="#2-1-RabbitMQ简介" class="headerlink" title="2.1 RabbitMQ简介"></a>2.1 RabbitMQ简介</h2><p>RabbitMQ 采用 Erlang 语言开发，Erlang 语言由 Ericson 设计，Erlang 在分布式编程和故障恢复方面表现出色，电信领域被广泛使用。</p>
<p><a target="_blank" rel="noopener" href="https://www.erlang.org/">https://www.erlang.org/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq11.png" srcset="/blog/img/loading.gif"></p>
<p><strong>Broker</strong>: 接收和分发消息的应用，RabbitMQ Server 就是 Message Broker。</p>
<p><strong>Virtual host</strong>: 出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 namespace 概念，当多个不同的用户使用同一个RabbitMQ server 提供的服务时，可以划分出多个 vhost，每个用户在自己的 vhost创建 exchange／queue 等。</p>
<p><strong>Connection</strong>: publisher／consumer 和 broker 之间的 TCP 连接。</p>
<p><strong>Channel</strong>: 如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection 的开销将是巨大的，效率也较低。Channel 是在 connection内部建立的逻辑连接，如果应用程序支持多线程，通常每个 thread 创建单独的channel 进行通讯，AMQP method 包含了channel id 帮助客户端和 message broker识别 channel，所以 channel 之间是完全隔离的。Channel 作为轻量级的 Connection极大减少了操作系统建立 TCP connection 的开销。</p>
<p><strong>Exchange</strong>: message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing<br>key，分发消息到 queue 中去。常用的类型有：direct (point-to-point), topic (publish-subscribe) and fanout (multicast)。</p>
<p><strong>Queue</strong>: 消息最终被送到这里等待 consumer 取走。</p>
<p><strong>Binding</strong>: exchange 和 queue 之间的虚拟连接，binding 中可以包含 routing key。Binding 信息被保存到 exchange 中的查询表中，用于 message 的分发依据。</p>
<p><strong>rabbitmq 优势</strong></p>
<ol>
<li>基于 erlang 语言开发，具有高并发优点、支持分布式</li>
<li>具有消息确认机制、消息持久化机制，消息可靠性和集群可靠性高</li>
<li>简单易用、运行稳定、跨平台、多语言</li>
<li>开源</li>
</ol>
<p><strong>Queue 的特性</strong></p>
<ol>
<li>消息基于先进先出的原则进行顺序消费</li>
<li>消息可以持久化到磁盘节点服务器</li>
<li>消息可以缓存到内存节点服务器提高性能</li>
</ol>
<h2 id="2-2-RabbitMQ-中的生产者消费者示例"><a href="#2-2-RabbitMQ-中的生产者消费者示例" class="headerlink" title="2.2 RabbitMQ 中的生产者消费者示例"></a>2.2 RabbitMQ 中的生产者消费者示例</h2><p>生产者发送消息到 broker server（RabbitMQ），在 Broker 内部，用户创建Exchange／Queue，通过 Binding 规则将两者联系在一起，Exchange 分发消息，根据类型／binding 的不同分发策略有区别，消息最后来到 Queue 中，等待消费者取走。</p>
<p>JMS 是在 2001 年发布的 Java 消息服务（Java Message Service）应用程序接口，是一个 Java 平台中关于面向消息中间件（MOM，message oriented middleware）的 API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。</p>
<h3 id="2-3-RabbitMQ-单机部署"><a href="#2-3-RabbitMQ-单机部署" class="headerlink" title="2.3 RabbitMQ 单机部署"></a>2.3 RabbitMQ 单机部署</h3><p>官网下载地址：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a></p>
<p>github 下载地址：<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-server/releases">https://github.com/rabbitmq/rabbitmq-server/releases</a></p>
<h3 id="2-3-1-Ubuntu-1804-安装单机版-RabbitMQ"><a href="#2-3-1-Ubuntu-1804-安装单机版-RabbitMQ" class="headerlink" title="2.3.1 Ubuntu 1804 安装单机版 RabbitMQ"></a>2.3.1 Ubuntu 1804 安装单机版 RabbitMQ</h3><p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/install-debian.html#apt">https://www.rabbitmq.com/install-debian.html#apt</a></p>
<h4 id="2-3-1-1-主机名解析"><a href="#2-3-1-1-主机名解析" class="headerlink" title="2.3.1.1 主机名解析"></a>2.3.1.1 主机名解析</h4><p>在当前 MQ 服务器配置本地主机名解析</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">172.18.0.51 mq-server1 mq-server1.magedu.net<br><br>ping mq-server1<br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-2-服务器安装-RabbitMQ"><a href="#2-3-1-2-服务器安装-RabbitMQ" class="headerlink" title="2.3.1.2 服务器安装 RabbitMQ"></a>2.3.1.2 服务器安装 RabbitMQ</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh">安装基础命令及添加 key<br><span class="hljs-comment"># sudo apt-get install curl gnupg</span><br><span class="hljs-comment"># curl -fsSL https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc | sudo apt-key add -</span><br>OK<br><br>安装 apt HTTPS 传输<br><span class="hljs-comment"># sudo apt-get install apt-transport-https</span><br><br>各节点添加 apt 源：<br>sudo tee /etc/apt/sources.list.d/bintray.rabbitmq.list &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">## Installs the latest Erlang 22.x release.</span><br><span class="hljs-string">## Change component to &quot;erlang-21.x&quot; to install the latest 21.x version.</span><br><span class="hljs-string">## &quot;bionic&quot; as distribution name should work for any later Ubuntu or Debian release.</span><br><span class="hljs-string">## See the release to distribution mapping table in RabbitMQ doc guides to learn more.</span><br><span class="hljs-string">deb https://dl.bintray.com/rabbitmq-erlang/debian bionic erlang</span><br><span class="hljs-string">deb https://dl.bintray.com/rabbitmq/debian bionic main</span><br><span class="hljs-string">EOF</span><br><br>更新软件包列表并安装：<br><span class="hljs-comment"># sudo apt-get update</span><br><span class="hljs-comment"># apt-cache madison rabbitmq-server #查看可以安装的版本</span><br><span class="hljs-comment"># apt install rabbitmq-server=3.8.3-1 #安装较新版本的 RabbitMQ</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-3-启动-RabbitMQ-服务"><a href="#2-3-1-3-启动-RabbitMQ-服务" class="headerlink" title="2.3.1.3 启动 RabbitMQ 服务"></a>2.3.1.3 启动 RabbitMQ 服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl start rabbitmq-server</span><br><span class="hljs-comment"># systemctl enable rabbitmq-server</span><br><span class="hljs-comment"># ps -ef | grep rabbitmq</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq1.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-3-1-4-RabbitMQ-插件管理"><a href="#2-3-1-4-RabbitMQ-插件管理" class="headerlink" title="2.3.1.4 RabbitMQ 插件管理"></a>2.3.1.4 RabbitMQ 插件管理</h4><p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/management.html">https://www.rabbitmq.com/management.html</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">开启 web 界面管理插件：<br><span class="hljs-comment"># rabbitmq-plugins enable rabbitmq_management</span><br><br><span class="hljs-comment"># lsof -i:5672</span><br><br>5672：消费者访问的 端口<br>15672：web 管理端口<br>25672：集群状态通信端口<br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-5-登陆-web-管理界面"><a href="#2-3-1-5-登陆-web-管理界面" class="headerlink" title="2.3.1.5 登陆 web 管理界面"></a>2.3.1.5 登陆 web 管理界面</h4><p>rabbitmq 从 3.3.0 开始禁止使用 guest/guest 权限通过除 localhost 外的访问，直接访问报错。</p>
<p>解决方法：在生产系统中解决此问题的推荐方法是创建一个新用户或一组具有访问必要虚拟主机权限的用户。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#3.8版本的解决方法</span><br><span class="hljs-comment">#创建用户</span><br>rabbitmqctl add_user rlin 123456<br><br><span class="hljs-comment">#查看用户是否创建成功</span><br>rabbitmqctl list_users<br><br><span class="hljs-comment">#将用户设置为超级管理员</span><br>rabbitmqctl set_user_Tags rlin administrator<br><br><span class="hljs-comment">#3.7版本以下的解决方法</span><br><span class="hljs-comment"># vim /usr/lib/rabbitmq/lib/rabbitmq_server-3.8.3/ebin/rabbit.app</span><br>39 &#123;loopback_users, []&#125;, <span class="hljs-comment">#删除被禁止登陆的 guest 账户</span><br><br><span class="hljs-comment"># systemctl restart rabbitmq-server.service #重启 rabbitmq 服务</span><br></code></pre></td></tr></table></figure>

<h2 id="2-4-RabbitMQ-集群部署"><a href="#2-4-RabbitMQ-集群部署" class="headerlink" title="2.4 RabbitMQ 集群部署"></a>2.4 RabbitMQ 集群部署</h2><p>Rabbitmq 集群分为二种方式：</p>
<ol>
<li>普通模式：创建好 RabbitMQ 集群之后的默认模式。</li>
<li>镜像模式：把需要的队列做成镜像队列。</li>
</ol>
<p><strong>普通集群模式</strong>：queue 创建之后，如果没有其它 policy，消息实体只存在于其中一个节点，A、B 两个 Rabbitmq 节点仅有相同的元数据，即队列结构，但队列的数据仅保存有一份，即创建该队列的 rabbitmq 节点（A 节点），当消息进入 A 节点的 Queue 中后，consumer 从 B 节点拉取时，RabbitMQ 会临时在 A、B 间进行消息传输，把 A 中的消息实体取出并经过 B 发送给 consumer，所以 consumer 可以连接每一个节点，从中取消息，该模式存在一个问题就是当 A 节点故障后，B节点无法取到 A 节点中还未消费的消息实体。</p>
<p><strong>镜像集群模式</strong>：</p>
<p>把需要的队列做成镜像队列，存在于多个节点，属于 RabbitMQ 的 HA 方案（镜<br>像模式是在普通模式的基础上，增加一些镜像策略）</p>
<p>该模式解决了普通模式中的数据丢失问题，其实质和普通模式不同之处在于，消息实体会主动在镜像节点间同步，而不是在 consumer 取数据时临时拉取，该模式带来的副作用也很明显，除了降低系统性能外，如果镜像队列数量过多，加之大量的消息进入，集群内部的网络带宽将会被这种同步通讯大大消耗掉，所以在对可靠性要求较高的场合中适用，一个队列想做成镜像队列，需要先设置 policy，然后客户端创建队列的时候，rabbitmq 集群根据“队列名称”自动设置是普通集群模式或镜像队列。</p>
<p>集群中有两种节点类型：</p>
<ul>
<li>内存节点：只将数据保存到内存</li>
<li>磁盘节点：保存数据到内存和磁盘。</li>
</ul>
<p>内存节点虽然不写入磁盘，但是它执行比磁盘节点要好，集群中，只需要一个磁盘节点来保存数据就足够了如果集群中只有内存节点，那么不能全部停止它们，否则所有数据消息在服务器全部停机之后都会丢失。</p>
<p>推荐设计架构：</p>
<p>在一个 rabbitmq 集群里，有 3 台或以上机器，其中 1 台使用磁盘模式，其它节点使用内存模式，内存节点无访问速度更快，由于磁盘 IO 相对较慢，因此可作为数据备份使用。</p>
<h3 id="2-4-1-Ubuntu-1804-安装集群版-RabbitMQ"><a href="#2-4-1-Ubuntu-1804-安装集群版-RabbitMQ" class="headerlink" title="2.4.1 Ubuntu 1804 安装集群版 RabbitMQ"></a>2.4.1 Ubuntu 1804 安装集群版 RabbitMQ</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">集群环境，三台服务器，具体 IP 如下：<br>172.31.2.105 hostname：mq-server1.rlin.net<br>172.31.2.106 hostname：mq-server2.rlin.net<br>172.31.2.107 hostname：mq-server3.rlin.net<br></code></pre></td></tr></table></figure>

<h4 id="2-4-1-1-主机名解析配置"><a href="#2-4-1-1-主机名解析配置" class="headerlink" title="2.4.1.1 主机名解析配置"></a>2.4.1.1 主机名解析配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">各 MQ 服务器配置本地主机名解析：<br>172.31.2.105 mq-server1 mq-server1.rlin.net<br>172.31.2.106 mq-server2 mq-server2.rlin.net<br>172.31.2.107 mq-server3 mq-server3.rlin.net<br></code></pre></td></tr></table></figure>

<h4 id="2-4-1-2-各服务器安装-RabbitMQ"><a href="#2-4-1-2-各服务器安装-RabbitMQ" class="headerlink" title="2.4.1.2 各服务器安装 RabbitMQ"></a>2.4.1.2 各服务器安装 RabbitMQ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">各 RabbitMQ 服务器安装基础命令及添加 key<br><span class="hljs-comment"># sudo apt update</span><br><span class="hljs-comment"># sudo apt-get install -y curl gnupg</span><br><span class="hljs-comment"># curl -fsSL https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc | sudo apt-key add -</span><br>OK<br><br>各 RabbitMQ 安装 apt HTTPS 传输<br><span class="hljs-comment"># sudo apt-get install -y apt-transport-https</span><br><br>各 RabbitMQ 服务器添加 apt 源：<br>sudo tee /etc/apt/sources.list.d/bintray.rabbitmq.list &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">## Installs the latest Erlang 22.x release.</span><br><span class="hljs-string">## Change component to &quot;erlang-21.x&quot; to install the latest 21.x version.</span><br><span class="hljs-string">## &quot;bionic&quot; as distribution name should work for any later Ubuntu or Debian release.</span><br><span class="hljs-string">## See the release to distribution mapping table in RabbitMQ doc guides to learn more.</span><br><span class="hljs-string">deb https://dl.bintray.com/rabbitmq-erlang/debian bionic erlang</span><br><span class="hljs-string">deb https://dl.bintray.com/rabbitmq/debian bionic main</span><br><span class="hljs-string">EOF</span><br><br>各 RabbitMQ 更新软件包列表并执行安装：<br><span class="hljs-comment"># sudo apt-get update</span><br><span class="hljs-comment"># apt-cache madison rabbitmq-server #查看可以安装的版本</span><br><span class="hljs-comment"># apt install -y rabbitmq-server #安装最新版本的rabbitmq</span><br><span class="hljs-comment"># apt install -y rabbitmq-server=3.7.22-1 #安装较新版本的 RabbitMQ</span><br><br><span class="hljs-comment">#或者在官网里照快速安装的脚本“Quick Start Script”，将其复制到linux里执行即可</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-1-3-启动-RabbitMQ-服务"><a href="#2-4-1-3-启动-RabbitMQ-服务" class="headerlink" title="2.4.1.3 启动 RabbitMQ 服务"></a>2.4.1.3 启动 RabbitMQ 服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">Server1：<br>root@mq-server1:~<span class="hljs-comment"># systemctl enable rabbitmq-server</span><br>root@mq-server1:~<span class="hljs-comment"># systemctl start rabbitmq-server</span><br><br>Server2：<br>root@mq-server2:~<span class="hljs-comment"># systemctl start rabbitmq-server</span><br>root@mq-server2:~<span class="hljs-comment"># systemctl enable rabbitmq-server</span><br><br>Server3：<br>root@mq-server3:~<span class="hljs-comment"># systemctl start rabbitmq-server</span><br>root@mq-server3:~<span class="hljs-comment"># systemctl enable rabbitmq-server</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-1-4-创建-RabbitMQ-集群"><a href="#2-4-1-4-创建-RabbitMQ-集群" class="headerlink" title="2.4.1.4 创建 RabbitMQ 集群"></a>2.4.1.4 创建 RabbitMQ 集群</h4><p>Rabbitmq 的集群是依赖于 erlang 的集群来工作的，所以必须先构建起 erlang 的集群环境,而 Erlang 的集群中各节点是通过一个 magic cookie 来实现的，这个cookie 存放在 /var/lib/rabbitmq/.erlang.cookie 中，文件是 400 的权限,所以必须保证各节点 cookie 保持一致，否则节点之间就无法通信。</p>
<h5 id="2-4-1-4-1-各服务器关闭-RabbitMQ"><a href="#2-4-1-4-1-各服务器关闭-RabbitMQ" class="headerlink" title="2.4.1.4.1 各服务器关闭 RabbitMQ"></a>2.4.1.4.1 各服务器关闭 RabbitMQ</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@mq-server1:~<span class="hljs-comment"># systemctl stop rabbitmq-server</span><br>root@mq-server2:~<span class="hljs-comment"># systemctl stop rabbitmq-server</span><br>root@mq-server3:~<span class="hljs-comment"># systemctl stop rabbitmq-server</span><br><br>在 mq-server1 同步.erlang.cookie 至其他两台服务器：<br><span class="hljs-comment"># scp /var/lib/rabbitmq/.erlang.cookie 172.31.2.106:/var/lib/rabbitmq/.erlang.cookie</span><br><br><span class="hljs-comment"># scp /var/lib/rabbitmq/.erlang.cookie 172.31.2.107:/var/lib/rabbitmq/.erlang.cookie</span><br></code></pre></td></tr></table></figure>

<h5 id="2-4-1-4-2-各服务器启动-RabbitMQ"><a href="#2-4-1-4-2-各服务器启动-RabbitMQ" class="headerlink" title="2.4.1.4.2 各服务器启动 RabbitMQ"></a>2.4.1.4.2 各服务器启动 RabbitMQ</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@mq-server1:~<span class="hljs-comment"># systemctl restart rabbitmq-server</span><br>root@mq-server2:~<span class="hljs-comment"># systemctl restart rabbitmq-server</span><br>root@mq-server3:~<span class="hljs-comment"># systemctl restart rabbitmq-server</span><br></code></pre></td></tr></table></figure>

<h5 id="2-4-1-4-3-查看当前集群状态"><a href="#2-4-1-4-3-查看当前集群状态" class="headerlink" title="2.4.1.4.3 查看当前集群状态"></a>2.4.1.4.3 查看当前集群状态</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs sh">3.7.X 及早期版本单节点状态：<br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl cluster_status</span><br>Cluster status of node rabbit@mq-server1 ...<br>[&#123;nodes,[&#123;disc,[<span class="hljs-string">&#x27;rabbit@mq-server1&#x27;</span>]&#125;]&#125;,<br>&#123;running_nodes,[<span class="hljs-string">&#x27;rabbit@mq-server1&#x27;</span>]&#125;,<br>&#123;cluster_name,&lt;&lt;<span class="hljs-string">&quot;rabbit@mq-server1&quot;</span>&gt;&gt;&#125;,<br>&#123;partitions,[]&#125;,<br>&#123;alarms,[&#123;<span class="hljs-string">&#x27;rabbit@mq-server1&#x27;</span>,[]&#125;]&#125;]<br><br>root@mq-server2:~<span class="hljs-comment"># rabbitmqctl cluster_status</span><br>Cluster status of node rabbit@mq-server2 ...<br>[&#123;nodes,[&#123;disc,[<span class="hljs-string">&#x27;rabbit@mq-server2&#x27;</span>]&#125;]&#125;,<br>&#123;running_nodes,[<span class="hljs-string">&#x27;rabbit@mq-server2&#x27;</span>]&#125;,<br>&#123;cluster_name,&lt;&lt;<span class="hljs-string">&quot;rabbit@mq-server2&quot;</span>&gt;&gt;&#125;,<br>&#123;partitions,[]&#125;,<br>&#123;alarms,[&#123;<span class="hljs-string">&#x27;rabbit@mq-server2&#x27;</span>,[]&#125;]&#125;]<br><br>root@mq-server3:~<span class="hljs-comment"># rabbitmqctl cluster_status</span><br>Cluster status of node rabbit@mq-server3 ...<br>[&#123;nodes,[&#123;disc,[<span class="hljs-string">&#x27;rabbit@mq-server3&#x27;</span>]&#125;]&#125;,<br>&#123;running_nodes,[<span class="hljs-string">&#x27;rabbit@mq-server3&#x27;</span>]&#125;,<br>&#123;cluster_name,&lt;&lt;<span class="hljs-string">&quot;rabbit@mq-server3&quot;</span>&gt;&gt;&#125;,<br>&#123;partitions,[]&#125;,<br>&#123;alarms,[&#123;<span class="hljs-string">&#x27;rabbit@mq-server3&#x27;</span>,[]&#125;]&#125;]<br><br>3.8.X 版本单节点状态<br><span class="hljs-comment"># rabbitmqctl cluster_status</span><br>Cluster status of node rabbit@mq-server1 ...<br>Basics<br><br>Cluster name: rabbit@mq-server1<br><br>Disk Nodes<br><br>rabbit@mq-server1<br><br>Running Nodes<br><br>rabbit@mq-server1<br><br>Versions<br><br>rabbit@mq-server1: RabbitMQ 3.9.5 on Erlang 24.0.5<br><br>Maintenance status<br><br>Node: rabbit@mq-server1, status: not under maintenance<br><br>Alarms<br><br>(none)<br><br>Network Partitions<br><br>(none)<br><br>Listeners<br><br>Node: rabbit@mq-server1, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication<br>Node: rabbit@mq-server1, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0<br><br>Feature flags<br><br>Flag: implicit_default_bindings, state: enabled<br>Flag: maintenance_mode_status, state: enabled<br>Flag: quorum_queue, state: enabled<br>Flag: stream_queue, state: enabled<br>Flag: user_limits, state: enabled<br>Flag: virtual_host_metadata, state: enabled<br></code></pre></td></tr></table></figure>

<h5 id="2-4-1-4-4-创建-RabbitMQ-集群"><a href="#2-4-1-4-4-创建-RabbitMQ-集群" class="headerlink" title="2.4.1.4.4 创建 RabbitMQ 集群"></a>2.4.1.4.4 创建 RabbitMQ 集群</h5><p>在 mq-server1 作为内存节点添加到 mq-server3，并作为内存节点，在 mq-server1执行以下命令:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@mq-server1:~<span class="hljs-comment"># rabbitmqctl stop_app #停止 app 服务</span><br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl reset #清空元数据</span><br>Resetting node rabbit@mq-server1 ...<br><br><span class="hljs-comment">#将 rabbitmq-server1 添加到集群当中，并成为内存节点，不加--ram 默认是磁盘节点</span><br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl join_cluster rabbit@mq-server3 --ram</span><br>Clustering node rabbit@mq-server1 with rabbit@mq-server3<br><br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl start_app #启动 app 服务</span><br>Starting node rabbit@mq-server1 ...<br>completed with 3 plugins.<br></code></pre></td></tr></table></figure>

<p>在 mq-server2 作为内存节点添加到 mq-server3，并作为内存节点，在 mq-server2执行以下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@mq-server2:~<span class="hljs-comment"># rabbitmqctl stop_app</span><br>Stopping rabbit application on node rabbit@mq-server2 ...<br><br>root@mq-server2:~<span class="hljs-comment"># rabbitmqctl reset</span><br>Resetting node rabbit@mq-server2 ...<br><br>root@mq-server2:~<span class="hljs-comment"># rabbitmqctl join_cluster rabbit@mq-server3 --ram</span><br>Clustering node rabbit@mq-server2 with rabbit@mq-server3<br><br>root@mq-server2:~<span class="hljs-comment"># rabbitmqctl start_app</span><br>Starting node rabbit@mq-server2 ...<br>completed with 0 plugins.<br></code></pre></td></tr></table></figure>

<h5 id="2-4-1-4-5-将集群设置为镜像模式"><a href="#2-4-1-4-5-将集群设置为镜像模式" class="headerlink" title="2.4.1.4.5 将集群设置为镜像模式"></a>2.4.1.4.5 将集群设置为镜像模式</h5><p>只要在其中一台节点执行以下命令即可：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@mq-server1:~<span class="hljs-comment"># rabbitmqctl set_policy ha-all &quot;#&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;</span><br>Setting policy <span class="hljs-string">&quot;ha-all&quot;</span> <span class="hljs-keyword">for</span> pattern <span class="hljs-string">&quot;#&quot;</span> to <span class="hljs-string">&quot;&#123;&quot;</span>ha-mode<span class="hljs-string">&quot;:&quot;</span>all<span class="hljs-string">&quot;&#125;&quot;</span> with priority <span class="hljs-string">&quot;0&quot;</span> <span class="hljs-keyword">for</span> vhost <span class="hljs-string">&quot;/&quot;</span> ...<br></code></pre></td></tr></table></figure>

<h5 id="2-4-1-4-6-验证当前集群状态"><a href="#2-4-1-4-6-验证当前集群状态" class="headerlink" title="2.4.1.4.6 验证当前集群状态"></a>2.4.1.4.6 验证当前集群状态</h5><p>3.7.X 及早期版本集群状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@mq-server1:~<span class="hljs-comment"># rabbitmqctl cluster_status</span><br>Cluster status of node rabbit@mq-server1 ...<br>[&#123;nodes,[&#123;disc,[<span class="hljs-string">&#x27;rabbit@mq-server3&#x27;</span>]&#125;, <span class="hljs-comment">#集群中至少有一个节点是磁盘节点用于数据持久化</span><br>&#123;ram,[<span class="hljs-string">&#x27;rabbit@mq-server2&#x27;</span>,<span class="hljs-string">&#x27;rabbit@mq-server1&#x27;</span>]&#125;]&#125;, <span class="hljs-comment">#集群中的内存节点</span><br>&#123;running_nodes,[<span class="hljs-string">&#x27;rabbit@mq-server2&#x27;</span>,<span class="hljs-string">&#x27;rabbit@mq-server3&#x27;</span>,<span class="hljs-string">&#x27;rabbit@mq-server1&#x27;</span>]&#125;,<br>&#123;cluster_name,&lt;&lt;<span class="hljs-string">&quot;rabbit@mq-server3&quot;</span>&gt;&gt;&#125;, <span class="hljs-comment">#当前正在运行的节点</span><br>&#123;partitions,[]&#125;,<br>&#123;alarms,[&#123;<span class="hljs-string">&#x27;rabbit@mq-server2&#x27;</span>,[]&#125;,<br>&#123;<span class="hljs-string">&#x27;rabbit@mq-server3&#x27;</span>,[]&#125;,<br>&#123;<span class="hljs-string">&#x27;rabbit@mq-server1&#x27;</span>,[]&#125;]&#125;]<br>root@mq-server1:~<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>3.8.X 版本集群状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># rabbitmqctl cluster_status</span><br>Cluster status of node rabbit@mq-server3 ...<br>Basics<br><br>Cluster name: rabbit@mq-server1<br><br>Disk Nodes<br>rabbit@mq-server3<br><br>RAM Nodes<br>rabbit@mq-server1<br>rabbit@mq-server2<br><br>Running Nodes<br>rabbit@mq-server1<br>rabbit@mq-server2<br>rabbit@mq-server3<br><br>Versions<br>rabbit@mq-server1: RabbitMQ 3.8.3 on Erlang 22.3<br>rabbit@mq-server2: RabbitMQ 3.8.3 on Erlang 22.3<br>rabbit@mq-server3: RabbitMQ 3.8.3 on Erlang 22.3<br></code></pre></td></tr></table></figure>

<h5 id="2-4-1-4-7-安装插件"><a href="#2-4-1-4-7-安装插件" class="headerlink" title="2.4.1.4.7 安装插件"></a>2.4.1.4.7 安装插件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#在mq-server1安装插件</span><br><span class="hljs-comment">#rabbitmq-plugins enable rabbitmq_management</span><br><br><span class="hljs-comment">#创建账号</span><br><span class="hljs-comment">#账号信息会同步到所有节点</span><br>rabbitmqctl add_user rlin 123456<br><br><span class="hljs-comment">#将创建的账号设置为超级管理员</span><br>rabbitmqctl set_user_tags rlin administrator<br><br><span class="hljs-comment">#查看账号</span><br>rabbitmqctl list_users<br>Listing users ...<br>user	tags<br>rlin	[administrator]<br>guest	[administrator]<br><br><span class="hljs-comment">#给账号添加权限</span><br>rabbitmqctl set_permissions rlin <span class="hljs-string">&quot;.*&quot;</span> <span class="hljs-string">&quot;.*&quot;</span> <span class="hljs-string">&quot;.*&quot;</span><br><br><span class="hljs-comment">#查看端口</span><br>root@mq-server1:~<span class="hljs-comment"># ss -tnl</span><br>State          Recv-Q          Send-Q                      Local Address:Port                      Peer Address:Port                       <br>LISTEN         0               1024                              0.0.0.0:15672                          0.0.0.0:*                          <br>LISTEN         0               128                                     *:5672                                 *:*             <br><br>root@mq-server1:~<span class="hljs-comment"># lsof -i:15672</span><br>COMMAND   PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>beam.smp 5608 rabbitmq   97u  IPv4  45214      0t0  TCP mq-server1:15672-&gt;172.31.2.1:57133 (ESTABLISHED)<br>beam.smp 5608 rabbitmq   98u  IPv4  42787      0t0  TCP *:15672 (LISTEN)<br>beam.smp 5608 rabbitmq   99u  IPv4  45215      0t0  TCP mq-server1:15672-&gt;172.31.2.1:50111 (ESTABLISHED)<br>beam.smp 5608 rabbitmq  100u  IPv4  45217      0t0  TCP mq-server1:15672-&gt;172.31.2.1:59853 (ESTABLISHED)<br>beam.smp 5608 rabbitmq  101u  IPv4  45219      0t0  TCP mq-server1:15672-&gt;172.31.2.1:64380 (ESTABLISHED)<br>beam.smp 5608 rabbitmq  102u  IPv4  45221      0t0  TCP mq-server1:15672-&gt;172.31.2.1:50013 (ESTABLISHED)<br>beam.smp 5608 rabbitmq  105u  IPv4  45223      0t0  TCP mq-server1:15672-&gt;172.31.2.1:54066 (ESTABLISHED)<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq2.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-4-1-4-8-登录mq-server1-web-界面"><a href="#2-4-1-4-8-登录mq-server1-web-界面" class="headerlink" title="2.4.1.4.8 登录mq-server1 web 界面"></a>2.4.1.4.8 登录mq-server1 web 界面</h5><p>ip:15672</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq3.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq4.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq5.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-4-2-web-界面验证集群状态"><a href="#2-4-2-web-界面验证集群状态" class="headerlink" title="2.4.2 web 界面验证集群状态"></a>2.4.2 web 界面验证集群状态</h3><h4 id="2-4-2-1-web-界面验证当前集群状态"><a href="#2-4-2-1-web-界面验证当前集群状态" class="headerlink" title="2.4.2.1 web 界面验证当前集群状态"></a>2.4.2.1 web 界面验证当前集群状态</h4><p>不启用 web 插件的 rabbitmq 服务器，会在 web 节点提示节点统计信息不可用(Node statistics not available)</p>
<h4 id="2-4-2-2-各服务器启动-web-插件"><a href="#2-4-2-2-各服务器启动-web-插件" class="headerlink" title="2.4.2.2 各服务器启动 web 插件"></a>2.4.2.2 各服务器启动 web 插件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@mq-server2:~<span class="hljs-comment"># rabbitmq-plugins enable rabbitmq_management</span><br>Enabling plugins on node rabbit@mq-server2:<br>rabbitmq_management<br>The following plugins have been configured:<br>rabbitmq_management<br>rabbitmq_management_agent<br>rabbitmq_web_dispatch<br>Applying plugin configuration to rabbit@mq-server2...<br>The following plugins have been enabled:<br>rabbitmq_management<br>rabbitmq_management_agent<br>rabbitmq_web_dispatch<br><br>started 3 plugins.<br><br>root@mq-server3:~<span class="hljs-comment"># rabbitmq-plugins enable rabbitmq_management</span><br>Enabling plugins on node rabbit@mq-server3:<br>rabbitmq_management<br>The following plugins have been configured:<br>rabbitmq_management<br>rabbitmq_management_agent<br>rabbitmq_web_dispatch<br>Applying plugin configuration to rabbit@mq-server3...<br>The following plugins have been enabled:<br>rabbitmq_management<br>rabbitmq_management_agent<br>rabbitmq_web_dispatch<br><br>started 3 plugins.<br></code></pre></td></tr></table></figure>

<h4 id="2-4-2-3-开启-web-插件后的集群状态"><a href="#2-4-2-3-开启-web-插件后的集群状态" class="headerlink" title="2.4.2.3 开启 web 插件后的集群状态"></a>2.4.2.3 开启 web 插件后的集群状态</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq6.png" srcset="/blog/img/loading.gif"></p>
<h2 id="2-5-RabbitMQ-常用命令"><a href="#2-5-RabbitMQ-常用命令" class="headerlink" title="2.5 RabbitMQ 常用命令"></a>2.5 RabbitMQ 常用命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#创建 vhost</span><br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl add_vhost magedu</span><br>Adding vhost <span class="hljs-string">&quot;magedu&quot;</span> ...<br><br><span class="hljs-comment">#删除指定 vhost</span><br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl delete_vhost magedu</span><br>Deleting vhost <span class="hljs-string">&quot;magedu&quot;</span> ...<br><br><span class="hljs-comment">#列出所有 vhost</span><br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl list_vhosts</span><br>Listing vhosts ...<br>name<br>magedu<br>/<br><br><span class="hljs-comment">#列出所有队列</span><br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl list_queues</span><br>Timeout: 60.0 seconds ...<br>Listing queues <span class="hljs-keyword">for</span> vhost / ...<br><br><span class="hljs-comment">#添加账户 jack 密码为 123456</span><br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl add_user jack 123456</span><br>Adding user <span class="hljs-string">&quot;jack&quot;</span> ...<br><br><span class="hljs-comment">#更改用户密码</span><br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl change_password jack 654321</span><br>Changing password <span class="hljs-keyword">for</span> user <span class="hljs-string">&quot;jack&quot;</span> ...<br><br><span class="hljs-comment">#设置 jack 用户对 magedu 的 vhost 有读写权限，三个点为配置正则、读和写</span><br>root@mq-server1:~<span class="hljs-comment"># rabbitmqctl set_permissions -p magedu jack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br>Setting permissions <span class="hljs-keyword">for</span> user <span class="hljs-string">&quot;jack&quot;</span> <span class="hljs-keyword">in</span> vhost <span class="hljs-string">&quot;magedu&quot;</span> ...<br></code></pre></td></tr></table></figure>

<h2 id="2-6-RabbitMQ-API"><a href="#2-6-RabbitMQ-API" class="headerlink" title="2.6 RabbitMQ API"></a>2.6 RabbitMQ API</h2><p><a target="_blank" rel="noopener" href="https://rawcdn.githack.com/rabbitmq/rabbitmq-management/rabbitmq_v3_6_9/priv/www/api/index.html">https://rawcdn.githack.com/rabbitmq/rabbitmq-management/rabbitmq_v3_6_9/priv/www/api/index.html</a></p>
<p><a target="_blank" rel="noopener" href="https://rawcdn.githack.com/rabbitmq/rabbitmq-management/rabbitmq_v3_6_9/priv/www/api/index.html">https://rawcdn.githack.com/rabbitmq/rabbitmq-management/rabbitmq_v3_6_9/priv/www/api/index.html</a></p>
<h2 id="2-7-RabbitMQ-Cluster-Monitor"><a href="#2-7-RabbitMQ-Cluster-Monitor" class="headerlink" title="2.7 RabbitMQ Cluster Monitor"></a>2.7 RabbitMQ Cluster Monitor</h2><h3 id="2-7-1-集群状态监控"><a href="#2-7-1-集群状态监控" class="headerlink" title="2.7.1 集群状态监控"></a>2.7.1 集群状态监控</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python">vim rabbitmq_monitor.py<br><span class="hljs-comment">#!/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br><span class="hljs-comment">#Author: ZhangJie</span><br><span class="hljs-keyword">import</span> subprocess<br><br>running_list = []<br>error_list = []<br>false = <span class="hljs-string">&quot;false&quot;</span><br>true = <span class="hljs-string">&quot;true&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_status</span>():</span><br>    obj = subprocess.Popen((<span class="hljs-string">&quot;curl -s -u guest:guest http://localhost:15672/api/nodes &amp;&gt; /dev/null&quot;</span>), shell=<span class="hljs-literal">True</span>, stdout=subprocess.PIPE)<br><br>    data = obj.stdout.read()<br>    data1 = <span class="hljs-built_in">eval</span>(data)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data1:<br>        <span class="hljs-keyword">if</span> i.get(<span class="hljs-string">&quot;running&quot;</span>) == <span class="hljs-string">&quot;true&quot;</span>:<br>            running_list.append(i.get(<span class="hljs-string">&quot;name&quot;</span>))<br>        <span class="hljs-keyword">else</span>:<br>            error_list.append(i.get(<span class="hljs-string">&quot;name&quot;</span>))<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">count_server</span>():</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(running_list) &lt; <span class="hljs-number">3</span>: <span class="hljs-comment"># 可以判断错误列表大于 0 或者运行列表小于 3，3未总计的节点数量</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-number">101</span>) <span class="hljs-comment"># 100 就是集群内有节点运行不正常了</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-number">50</span>) <span class="hljs-comment"># 50 为所有节点全部运行正常</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    get_status()<br>    count_server()<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br>    <br><span class="hljs-comment">#正常集群状态</span><br>python3 rabbitmq_monitor.py<br><span class="hljs-number">50</span><br><span class="hljs-comment">#停止任何一个rabbitmq</span><br>systemctl stop rabbitmq-server<br>python3 rabbitmq_monitor.py<br><span class="hljs-number">101</span><br></code></pre></td></tr></table></figure>

<h3 id="2-7-2-内存使用监控"><a href="#2-7-2-内存使用监控" class="headerlink" title="2.7.2 内存使用监控"></a>2.7.2 内存使用监控</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># cat rabbitmq_memory.py</span><br><span class="hljs-comment">#!/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br><span class="hljs-comment">#Author: ZhangJie</span><br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> sys<br><br>running_list = []<br>error_list = []<br>false = <span class="hljs-string">&quot;false&quot;</span><br>true = <span class="hljs-string">&quot;true&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_status</span>():</span><br>    obj = subprocess.Popen((<span class="hljs-string">&quot;curl -s -u guest:guest http://localhost:15672/api/nodes &amp;&gt; /dev/null&quot;</span>), shell=<span class="hljs-literal">True</span>, stdout=subprocess.PIPE)<br>    data = obj.stdout.read()<br>    data1 = <span class="hljs-built_in">eval</span>(data)<br>    <span class="hljs-comment">#print(data1)</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data1:<br>        <span class="hljs-keyword">if</span> i.get(<span class="hljs-string">&quot;name&quot;</span>) == sys.argv[<span class="hljs-number">1</span>]:<br>            <span class="hljs-built_in">print</span>(i.get(<span class="hljs-string">&quot;mem_used&quot;</span>))<br>                       <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    get_status()<br>                       <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br>                       <br>root@mq-server3:~<span class="hljs-comment"># python3 rabbitmq_memory.py rabbit@mq-server1</span><br><span class="hljs-number">85774336</span><br>root@mq-server3:~<span class="hljs-comment"># python3 rabbitmq_memory.py rabbit@mq-server2</span><br><span class="hljs-number">91099136</span><br>root@mq-server3:~<span class="hljs-comment"># python3 rabbitmq_memory.py rabbit@mq-server3</span><br><span class="hljs-number">96428032</span><br></code></pre></td></tr></table></figure>

<h2 id="2-8-RabbitMQ二进制安装"><a href="#2-8-RabbitMQ二进制安装" class="headerlink" title="2.8 RabbitMQ二进制安装"></a>2.8 RabbitMQ二进制安装</h2><p>需要在官网查看哪个版本的Erlang支持哪个版本的Rabbitmq</p>
<h3 id="设置hosts和hostname，跟apt安装的一样"><a href="#设置hosts和hostname，跟apt安装的一样" class="headerlink" title="设置hosts和hostname，跟apt安装的一样"></a>设置hosts和hostname，跟apt安装的一样</h3><h3 id="2-8-1-部署RabbitMQ"><a href="#2-8-1-部署RabbitMQ" class="headerlink" title="2.8.1 部署RabbitMQ"></a>2.8.1 部署RabbitMQ</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#下载rabbitmq</span><br>mkdir /apps/<br><span class="hljs-built_in">cd</span> /apps<br>tar xf rabbitmq_server-generic-unix-3.8.7.tar,xz<br>chown -R rabbitmq.rabbitmq /apps/rabbitmq_server-generic-unix-3.8.7<br>ln -sv /apps/rabbitmq_server-generic-unix-3.8.7 /apps/rabbitmq<br><span class="hljs-comment">#创建用户和组先参考apt安装的rabbitmq的用户和组的信息</span><br>groupadd -r rabbitmq<br>useradd -r -s /bin/nologin -g rabbitmq<br><span class="hljs-comment">#service文件参考用apt安装的rabbitmq-server.service</span><br></code></pre></td></tr></table></figure>

<h3 id="2-8-2-部署Erlang"><a href="#2-8-2-部署Erlang" class="headerlink" title="2.8.2 部署Erlang"></a>2.8.2 部署Erlang</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#解决依赖</span><br>apt install ncurses-dev socat wxWidgets* <span class="hljs-comment">#这里安装的wxWidgets是所有都安装</span><br><span class="hljs-comment">#注意：wxWidgets的安装看博客：https://blog.csdn.net/qq_23918781/article/details/81077285</span><br><span class="hljs-comment">#下载erlang并编译</span><br><span class="hljs-built_in">cd</span> /apps<br>tar xf opt_src_23.0.tar.gz<br><span class="hljs-built_in">cd</span> opt_src_23.0<br>./configre --prefix=/apps/erlang_23.0<br>make &amp;&amp; make install<br><span class="hljs-comment">#解决环境</span><br>vim /etc/profile<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:/apps/erlang_23.0/bin<br><span class="hljs-built_in">source</span> /etc/profile<br>ln -sv /apps/erlang_23.0/bin/erl /usr/bin<br></code></pre></td></tr></table></figure>

<h3 id="2-8-3-启动Rabbitmq"><a href="#2-8-3-启动Rabbitmq" class="headerlink" title="2.8.3 启动Rabbitmq"></a>2.8.3 启动Rabbitmq</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /apps/rabbitmq_Server-3.8.7<br>./sbin/rabbitmq-server<br>systemclt start rabbitmq-server<br></code></pre></td></tr></table></figure>



<h1 id="三、ZooKeeper"><a href="#三、ZooKeeper" class="headerlink" title="三、ZooKeeper"></a>三、ZooKeeper</h1><p><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/">https://zookeeper.apache.org/</a></p>
<p>ZooKeeper 最早起源于雅虎研究院的一个研究小组。在当时，研究人员发现，在雅虎内部很多大型系统基本都需要依赖一个类似的系统来进行分布式协调，但是这些系统往往都存在分布式单点问题，所以， 雅虎的开发人员就试图开发一个通用的无单点问题的分布式协调框架，以便让开发人员将精力集中在处理业务逻辑上。</p>
<p>关于“ZooKeeper”这个项目的名字，其实也有一段趣闻，在立项初期，考虑到之前内部很多项目都是使用动物的名字来命名的（例如著名的 Pig 项目)，雅虎的工程师 希 望给这个项目也取一个动物的名字。时任研究院的首席科学家RaghuRamakrishnan(拉古·拉玛克里希南)开玩笑地说：“在这样下去，我们这儿就变成动物园了！”此话一出，大家纷纷表示就叫动物园管理员吧一一一因为各个以动物命名的分布式组件放在一起， 雅虎的整个分布式系统看上去就像一个大型的动物园了，而 的动物园了，而Zookeeper 正好要用来进行分布式环境的协调，于是Zookeeper的名字也就由此诞生了。</p>
<h2 id="3-1-ZooKeeper-使用场景"><a href="#3-1-ZooKeeper-使用场景" class="headerlink" title="3.1 ZooKeeper 使用场景"></a>3.1 ZooKeeper 使用场景</h2><p>ZooKeeper 是一个分布式服务框架，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：命名服务、状态同步、配置中心、集群管理等。</p>
<h3 id="3-1-1-命名服务"><a href="#3-1-1-命名服务" class="headerlink" title="3.1.1 命名服务"></a>3.1.1 命名服务</h3><p>命名服务是分布式系统中比较常见的一类场景。命名服务是分布式系统最基本的公共服务之一。在分布式系统中，被命名的实体通常可以是集群中的机器、提供的服务地址或远程对象等——这些我们都可以统称它们为名字（Name），其中较为常见的就是一些分布式服务框架（如 RPC、RMI）中的服务地址列表，通过使用命名服务，客户端应用能够根据指定名字来获取资源的实体、服务地址和提供者的信息等。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq12.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-1-2-状态同步"><a href="#3-1-2-状态同步" class="headerlink" title="3.1.2 状态同步"></a>3.1.2 状态同步</h3><p>每个节点除了存储数据内容和 node 节点状态信息之外，还存储了已经注册的APP 的状态信息，当有些节点或 APP 不可用，就将当前状态同步给其他服务。</p>
<h3 id="3-1-3-配置中心"><a href="#3-1-3-配置中心" class="headerlink" title="3.1.3 配置中心"></a>3.1.3 配置中心</h3><p>现在我们大多数应用都是采用的是分布式开发的应用，搭建到不同的服务器上，我们的配置文件，同一个应用程序的配置文件一样，还有就是多个程序存在相同的配置，当我们配置文件中有个配置属性需要改变，我们需要改变每个程序的配置属性，这样会很麻烦的去修改配置，那么可用使用 ZooKeeper 来实现配置中心，ZooKeeper 采用的是推拉相结合的方式： 客户端向服务端注册自己需要关注的节点，一旦该节点的数据发生变更，那么服务端就会向相应的客户端发送Watcher 事件通知，客户端接收到这个消息通知后，需要主动到服务端获取最新的数据。</p>
<h3 id="3-1-4-集群管理"><a href="#3-1-4-集群管理" class="headerlink" title="3.1.4 集群管理"></a>3.1.4 集群管理</h3><p>所谓集群管理，包括集群监控与集群控制两大块，前者侧重对集群运行时状态的收集，后者则是对集群进行操作与控制，在日常开发和运维过程中，我们经常会有类似于如下的需求：</p>
<ol>
<li>希望知道当前集群中究竟有多少机器在工作。</li>
<li>对集群中每台机器的运行时状态进行数据收集。</li>
<li>对集群中机器进行上下线操作。</li>
</ol>
<p>ZooKeeper 具有以下两大特性：</p>
<ol>
<li>客户端如果对 ZooKeeper 的一个数据节点注册 Watcher 监听，那么当该数据节点的内容或是其子节点列表发生变更时，ZooKeeper 服务器就会向订阅的客户端发送变更通知。</li>
<li>对在 ZooKeeper 上创建的临时节点，一旦客户端与服务器之间的会话失效，那么该临时节点也就被自动清除。</li>
</ol>
<p>Watcher （事件监听器），是 Zookeeper 中的一个很重要的特性。Zookeeper 允许用户在指定节点上注册一些 许用户在指定节点上注册一些 Watcher，并且在一些特定事件触发的时候，并且在一些特定事件触发的时候，ZooKeeper 服务端会将事件通知到感兴趣的客户端上去，该机制是 Zookeeper<br>实现分布式协调服务的重要特性。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq13.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">0 生产者启动<br>1 生产者注册至 zookeeper<br>2 消费者启动并订阅频道<br>3 zookeeper 通知消费者事件<br>4 消费者调用生产者<br>5 监控中心负责统计和监控服务状态<br></code></pre></td></tr></table></figure>

<h2 id="3-2-ZooKeeper-单机安装"><a href="#3-2-ZooKeeper-单机安装" class="headerlink" title="3.2 ZooKeeper 单机安装"></a>3.2 ZooKeeper 单机安装</h2><p>单机版的 ZooKeeper 安装</p>
<h3 id="3-2-1-配置-java-环境"><a href="#3-2-1-配置-java-环境" class="headerlink" title="3.2.1 配置 java 环境"></a>3.2.1 配置 java 环境</h3><p>官方依赖介绍：<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_requiredSoftware">https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_requiredSoftware</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install openjdk-8-jdk</span><br><span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;1.8.0_222&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_222-8u222-b10-1ubuntu1~18.04.1-b10)<br>OpenJDK 64-Bit Server VM (build 25.222-b10, mixed mode)<br></code></pre></td></tr></table></figure>

<h3 id="3-2-2-部署-ZooKeeper"><a href="#3-2-2-部署-ZooKeeper" class="headerlink" title="3.2.2 部署 ZooKeeper"></a>3.2.2 部署 ZooKeeper</h3><p>官网下载地址：<a target="_blank" rel="noopener" href="https://archive.apache.org/dist/zookeeper/">https://archive.apache.org/dist/zookeeper/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># pwd</span><br>/apps<br><span class="hljs-comment"># wget https://archive.apache.org/dist/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz</span><br><span class="hljs-comment"># tar xvf zookeeper-3.4.14.tar.gz</span><br><span class="hljs-comment"># ln -sv /apps/zookeeper-3.4.14 /apps/zookeeper</span><br><span class="hljs-string">&#x27;/apps/zookeeper&#x27;</span> -&gt; <span class="hljs-string">&#x27;/apps/zookeeper-3.4.14&#x27;</span><br><br><span class="hljs-comment"># cd /apps/zookeeper/conf/</span><br><span class="hljs-comment"># cp zoo_sample.cfg zoo.cfg</span><br><span class="hljs-comment"># mkdir /apps/zookeeper/data/</span><br><br><span class="hljs-comment"># grep ^[a-Z] zoo.cfg #当前配置</span><br>tickTime=2000<br>initLimit=10<br>syncLimit=5<br>dataDir=/apps/zookeeper/data<br>clientPort=2181<br></code></pre></td></tr></table></figure>

<h3 id="3-2-3-启动-ZooKeeper"><a href="#3-2-3-启动-ZooKeeper" class="headerlink" title="3.2.3 启动 ZooKeeper"></a>3.2.3 启动 ZooKeeper</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/zookeeper/bin/zkServer.sh #用于启动、重启、停止 ZooKeeper</span><br><span class="hljs-comment"># /apps/zookeeper/bin/zkServer.sh --help</span><br><span class="hljs-comment"># /apps/zookeeper/bin/zkServer.sh start</span><br>ZooKeeper JMX enabled by default<br>Using config: /usr/<span class="hljs-built_in">local</span>/zookeeper/bin/../conf/zoo.cfg<br>Starting zookeeper ... STARTED<br></code></pre></td></tr></table></figure>

<h3 id="3-2-4-验证-Zookeeper-进程"><a href="#3-2-4-验证-Zookeeper-进程" class="headerlink" title="3.2.4 验证 Zookeeper 进程"></a>3.2.4 验证 Zookeeper 进程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># pe -ef | grep zookeeper</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq14.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-2-5-验证-Zookeeper-状态"><a href="#3-2-5-验证-Zookeeper-状态" class="headerlink" title="3.2.5 验证 Zookeeper 状态"></a>3.2.5 验证 Zookeeper 状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/local/zookeeper/bin/zkServer.sh status</span><br>ZooKeeper JMX enabled by default<br>Using config: /usr/<span class="hljs-built_in">local</span>/zookeeper/bin/../conf/zoo.cfg<br>Mode: standalone<br></code></pre></td></tr></table></figure>

<h3 id="3-3-ZooKeeper-集群介绍"><a href="#3-3-ZooKeeper-集群介绍" class="headerlink" title="3.3 ZooKeeper 集群介绍"></a>3.3 ZooKeeper 集群介绍</h3><p>ZooKeeper 集群用于解决单点和单机性能及数据高可用等问题。</p>
<p>读写数据：<a target="_blank" rel="noopener" href="http://www.sohu.com/a/253808097_465221">http://www.sohu.com/a/253808097_465221</a></p>
<h3 id="3-3-1-集群结构"><a href="#3-3-1-集群结构" class="headerlink" title="3.3.1 集群结构"></a>3.3.1 集群结构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq15.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq16.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq17.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-3-2-集群角色"><a href="#3-3-2-集群角色" class="headerlink" title="3.3.2 集群角色"></a>3.3.2 集群角色</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq18.png" srcset="/blog/img/loading.gif"></p>
<h2 id="3-4-Zookeeper-集群部署"><a href="#3-4-Zookeeper-集群部署" class="headerlink" title="3.4 Zookeeper 集群部署"></a>3.4 Zookeeper 集群部署</h2><p>Zookeeper 的集群部署过程:</p>
<p>zookeeper 集群特性：整个集群中只要有超过集群数量一半的 zookeeper 工作只正常的，那么整个集群对外就是可用的，假如有 2 台服务器做了一个 zookeeper集群，只要有任何一台故障或宕机，那么这个 zookeeper 集群就不可用了，因为剩下的一台没有超过集群一半的数量，但是假如有三台 zookeeper组成一个集群，那么损坏一台就还剩两台，大于 3 台的一半，所以损坏一台还是可以正常运行的，但是再损坏一台就只剩一台集群就不可用了。那么要是 4 台组成一个zookeeper 集群，损坏一台集群肯定是正常的，那么损坏两台就还剩两台，那么2 台不大于集群数量的一半，所以 3 台的 zookeeper 集群和 4 台的 zookeeper 集群损坏两台的结果都是集群不可用，以此类推 5 台和 6 台以及 7 台和 8 台都是同理，所以这也就是为什么集群一般都是奇数的原因。</p>
<h3 id="3-4-1-配置-ZooKeeper-集群"><a href="#3-4-1-配置-ZooKeeper-集群" class="headerlink" title="3.4.1 配置 ZooKeeper 集群"></a>3.4.1 配置 ZooKeeper 集群</h3><p>各 zookeeper 服务器都配置 java 环境并部署 zookeeper 集群</p>
<p>服务器环境：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">Zk-node1:172.31.4.101<br>Zk-node2:172.31.4.102<br>Zk-node3:172.31.4.103<br></code></pre></td></tr></table></figure>

<h4 id="3-4-1-1-zk-节点1部署过程"><a href="#3-4-1-1-zk-节点1部署过程" class="headerlink" title="3.4.1.1 zk 节点1部署过程"></a>3.4.1.1 zk 节点1部署过程</h4><p>官方文档：<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html">https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install -y openjdk-8-jdk</span><br><span class="hljs-comment"># java –version #验证 JDK 版本</span><br>openjdk version <span class="hljs-string">&quot;1.8.0_222&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_222-8u222-b10-1ubuntu1~18.04.1-b10)<br>OpenJDK 64-Bit Server VM (build 25.222-b10, mixed mode)<br><br><span class="hljs-comment"># mkdir /apps</span><br><span class="hljs-comment"># cd /apps</span><br><span class="hljs-comment"># wget https://archive.apache.org/dist/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz</span><br><span class="hljs-comment"># tar xf zookeeper-3.4.14.tar.gz</span><br><span class="hljs-comment"># ln -sv /apps/zookeeper-3.4.14 /apps/zookeeper #解决并对 zookeeper做软连接</span><br><span class="hljs-string">&#x27;/apps/zookeeper&#x27;</span> -&gt; <span class="hljs-string">&#x27;/apps/zookeeper-3.4.14&#x27;</span><br><span class="hljs-comment"># cd /apps/zookeeper/conf/</span><br><span class="hljs-comment"># cp zoo_sample.cfg zoo.cfg #基于模板配置文件生成配置文件</span><br><br><span class="hljs-comment"># mkdir /apps/zookeeper/data #创建数据目录</span><br><br><span class="hljs-comment"># grep -v &quot;^#&quot; /apps/zookeeper/conf/zoo.cfg #配置文件内容</span><br>tickTime=2000 <span class="hljs-comment">#服务器与服务器之间的单次心跳检测时间间隔，单位为毫秒</span><br>initLimit=10 <span class="hljs-comment">#集群中 leader 服务器与 follower 服务器初始连接心跳次数，即多少个 2000 毫秒</span><br>syncLimit=5 <span class="hljs-comment"># leader 与 follower 之间连接完成之后，后期检测发送和应答的心跳次数，如果该 follower 在设置的时间内(5*2000)不能与 leader 进行通信，那么此 follower 将被视为不可用。</span><br>dataDir=/apps/zookeeper/data <span class="hljs-comment">#自定义的 zookeeper 保存数据的目录</span><br>clientPort=2181 <span class="hljs-comment">#客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求</span><br>maxClientCnxns=128 <span class="hljs-comment">#单个客户端IP可以和zookeeper保持的连接数</span><br>autopurge.snapRetainCount=6 <span class="hljs-comment">#3.4.0 中的新增功能：启用后，ZooKeeper 自动清除功能会将 autopurge.snapRetainCount 最新快照和相应的事务日志分别保留在 dataDir 和 dataLogDir 中，并删除其余部分，默认值为 3。最小值为 3。</span><br>autopurge.purgeInterval=12 <span class="hljs-comment"># 3.4.0 及之后版本，ZK 提供了自动清理日志和快照文件的功能，这个参数指定了清理频率，单位是小时，需要配置一个 1 或更大的整数，默认是 0，表示不开启自动清理功能</span><br><br>server.1=172.31.4.101:2888:3888 <span class="hljs-comment"># server.服务器编号=服务器 IP:LF 数据同步端口:LF 选举端口</span><br>server.2=172.31.4.102:2888:3888<br>server.3=172.31.4.103:2888:3888<br><br><span class="hljs-comment"># echo &quot;1&quot; &gt; /apps/zookeeper/data/myid #自己的集群 id</span><br><br><span class="hljs-comment"># scp zoo.cfg 172.31.4.102:/apps/zookeeper/conf/zoo.cfg #将配置文件分发至其他服务器</span><br><span class="hljs-comment"># scp zoo.cfg 172.31.4.103:/apps/zookeeper/conf/zoo.cfg</span><br><br><span class="hljs-comment"># chown -R /apps/zookeeper-3.4.14</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-1-2-zk-节点-2-部署过程"><a href="#3-4-1-2-zk-节点-2-部署过程" class="headerlink" title="3.4.1.2 zk 节点 2 部署过程"></a>3.4.1.2 zk 节点 2 部署过程</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install-y openjdk-8-jdk</span><br><span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;1.8.0_222&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_222-8u222-b10-1ubuntu1~18.04.1-b10)<br>OpenJDK 64-Bit Server VM (build 25.222-b10, mixed mode)<br><br><span class="hljs-comment"># mkdir /apps</span><br><span class="hljs-comment"># cd /apps</span><br><span class="hljs-comment"># wget https://archive.apache.org/dist/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz</span><br><span class="hljs-comment"># tar xf zookeeper-3.4.14.tar.gz</span><br><span class="hljs-comment"># ln -sv /apps/zookeeper-3.4.14 /apps/zookeeper</span><br><span class="hljs-string">&#x27;/apps/zookeeper&#x27;</span> -&gt; <span class="hljs-string">&#x27;/apps/zookeeper-3.4.14&#x27;</span><br><span class="hljs-comment"># cd /apps/zookeeper/conf/</span><br><span class="hljs-comment"># cp zoo_sample.cfg zoo.cfg</span><br><span class="hljs-comment"># mkdir /apps/zookeeper/data</span><br><br><span class="hljs-comment"># grep -v &quot;^#&quot; /apps/zookeeper/conf/zoo.cfg</span><br>tickTime=2000<br>initLimit=10<br>syncLimit=5<br>dataDir=/apps/zookeeper/data<br>clientPort=2181<br>maxClientCnxns=4096<br>autopurge.snapRetainCount=128<br>autopurge.purgeInterval=1<br><br>server.1=172.31.4.101:2888:3888<br>server.2=172.31.4.102:2888:3888<br>server.3=172.31.4.103:2888:3888<br><br><span class="hljs-comment"># echo &quot;2&quot; &gt; /apps/zookeeper/data/myid</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-1-4-zk-节点-3-部署"><a href="#3-4-1-4-zk-节点-3-部署" class="headerlink" title="3.4.1.4 zk 节点 3 部署"></a>3.4.1.4 zk 节点 3 部署</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install -y openjdk-8-jdk</span><br><span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;1.8.0_222&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_222-8u222-b10-1ubuntu1~18.04.1-b10)<br>OpenJDK 64-Bit Server VM (build 25.222-b10, mixed mode)<br><br><span class="hljs-comment"># mkdir /apps</span><br><span class="hljs-comment"># cd /apps</span><br><span class="hljs-comment"># wget https://archive.apache.org/dist/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz</span><br><span class="hljs-comment"># tar xf zookeeper-3.4.14.tar.gz</span><br><span class="hljs-comment"># ln -sv /apps/zookeeper-3.4.14 /apps/zookeeper</span><br><span class="hljs-string">&#x27;/apps/zookeeper&#x27;</span> -&gt; <span class="hljs-string">&#x27;/apps/zookeeper-3.4.14&#x27;</span><br><span class="hljs-comment"># cd /apps/zookeeper/conf/</span><br><span class="hljs-comment"># cp zoo_sample.cfg zoo.cfg</span><br><br><span class="hljs-comment"># mkdir /apps/zookeeper/data #数据目录</span><br><br><span class="hljs-comment"># grep -v &quot;^#&quot; /apps/zookeeper/conf/zoo.cfg #配置文件</span><br>tickTime=2000<br>initLimit=10<br>syncLimit=5<br>dataDir=/apps/zookeeper/data<br>clientPort=2181<br>maxClientCnxns=4096<br>autopurge.snapRetainCount=128<br>autopurge.purgeInterval=1<br><br>server.1=172.31.4.101:2888:3888<br>server.2=172.31.4.102:2888:3888<br>server.3=172.31.4.103:2888:3888<br><br><span class="hljs-comment"># echo &quot;3&quot; &gt; /apps/zookeeper/data/myid #当前节点 id</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-2-各服务器启动-zookeeper"><a href="#3-4-2-各服务器启动-zookeeper" class="headerlink" title="3.4.2 各服务器启动 zookeeper"></a>3.4.2 各服务器启动 zookeeper</h3><p>各 zookeeper 服务器尽快启动 zookeeper 服务。</p>
<h4 id="3-4-2-1-zk-节点1启动zookeeper"><a href="#3-4-2-1-zk-节点1启动zookeeper" class="headerlink" title="3.4.2.1 zk 节点1启动zookeeper"></a>3.4.2.1 zk 节点1启动zookeeper</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/zookeeper/bin/zkServer.sh start</span><br>ZooKeeper JMX enabled by default<br>Using config: /apps/zookeeper/bin/../conf/zoo.cfg<br>Starting zookeeper ... STARTED<br></code></pre></td></tr></table></figure>

<h4 id="3-4-2-2-zk-节点2启动zookeeper"><a href="#3-4-2-2-zk-节点2启动zookeeper" class="headerlink" title="3.4.2.2 zk 节点2启动zookeeper"></a>3.4.2.2 zk 节点2启动zookeeper</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/zookeeper/bin/zkServer.sh start</span><br>ZooKeeper JMX enabled by default<br>Using config: /apps/zookeeper/bin/../conf/zoo.cfg<br>Starting zookeeper ... STARTED<br></code></pre></td></tr></table></figure>

<h4 id="3-4-2-3-zk-节点3启动zookeeper"><a href="#3-4-2-3-zk-节点3启动zookeeper" class="headerlink" title="3.4.2.3 zk 节点3启动zookeeper"></a>3.4.2.3 zk 节点3启动zookeeper</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/zookeeper/bin/zkServer.sh start</span><br>ZooKeeper JMX enabled by default<br>Using config: /usr/<span class="hljs-built_in">local</span>/zookeeper/bin/../conf/zoo.cfg<br>Starting zookeeper ... STARTED<br></code></pre></td></tr></table></figure>

<h3 id="3-4-3-验证-zookeeper-集群状态"><a href="#3-4-3-验证-zookeeper-集群状态" class="headerlink" title="3.4.3 验证 zookeeper 集群状态"></a>3.4.3 验证 zookeeper 集群状态</h3><p>验证各 zookeeper 节点服务运行状态</p>
<h4 id="3-4-3-1-zk节点1验证zookeeper"><a href="#3-4-3-1-zk节点1验证zookeeper" class="headerlink" title="3.4.3.1 zk节点1验证zookeeper"></a>3.4.3.1 zk节点1验证zookeeper</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/zookeeper/bin/zkServer.sh status</span><br>ZooKeeper JMX enabled by default<br>Using config: /apps/zookeeper/bin/../conf/zoo.cfg<br>Mode: follower<br></code></pre></td></tr></table></figure>

<h4 id="3-4-3-2-zk-节点-2-验证-zookeeper"><a href="#3-4-3-2-zk-节点-2-验证-zookeeper" class="headerlink" title="3.4.3.2 zk 节点 2 验证 zookeeper"></a>3.4.3.2 zk 节点 2 验证 zookeeper</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/zookeeper/bin/zkServer.sh status</span><br>ZooKeeper JMX enabled by default<br>Using config: /apps/zookeeper/bin/../conf/zoo.cfg<br>Mode: follower<br></code></pre></td></tr></table></figure>

<h4 id="3-4-3-3-zk-节点-3-验证-zookeeper"><a href="#3-4-3-3-zk-节点-3-验证-zookeeper" class="headerlink" title="3.4.3.3 zk 节点 3 验证 zookeeper"></a>3.4.3.3 zk 节点 3 验证 zookeeper</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/zookeeper/bin/zkServer.sh status</span><br>ZooKeeper JMX enabled by default<br>Using config: /apps/zookeeper/bin/../conf/zoo.cfg<br>Mode: leader<br></code></pre></td></tr></table></figure>

<h3 id="3-4-4-zookeeper-集群选举过程"><a href="#3-4-4-zookeeper-集群选举过程" class="headerlink" title="3.4.4 zookeeper 集群选举过程"></a>3.4.4 zookeeper 集群选举过程</h3><h4 id="3-4-4-1-节点角色状态"><a href="#3-4-4-1-节点角色状态" class="headerlink" title="3.4.4.1 节点角色状态"></a>3.4.4.1 节点角色状态</h4><p>LOOKING：寻找 Leader 状态，处于该状态需要进入选举流程 </p>
<p>LEADING：领导者状态，处于该状态的节点说明是角色已经是 Leader </p>
<p>FOLLOWING：跟随者状态，表示 Leader 已经选举出来，当前节点角色是 follower </p>
<p>OBSERVER：观察者状态，表明当前节点角色是 observer</p>
<h4 id="3-4-4-2-选举-ID"><a href="#3-4-4-2-选举-ID" class="headerlink" title="3.4.4.2 选举 ID"></a>3.4.4.2 选举 ID</h4><p>ZXID（zookeeper transaction id）：每个改变 Zookeeper 状态的操作都会形成一个 对应的 zxid。 </p>
<p>myid：服务器的唯一标识(SID)，通过配置 myid 文件指定，集群中唯一。</p>
<h4 id="3-4-4-3-leader-选举过程"><a href="#3-4-4-3-leader-选举过程" class="headerlink" title="3.4.4.3 leader 选举过程"></a>3.4.4.3 leader 选举过程</h4><p>当集群中的 zookeeper 节点启动以后，会根据配置文件中指定的 zookeeper 节点 地址进行 leader 选择操作，过程如下：</p>
<ol>
<li><p>每个 zookeeper 都会发出投票，由于是第一次选举 leader，因此每个节点都会把自己当做 leader 角色进行选举，每个 zookeeper 的投票中都会包含自己 的 myid 和 zxid，此时 zookeeper 1 的投票为 myid 为 1，初始 zxid 有一个初始值，后期会随着数据更新而自动变化，zookeeper2 的投票为 myid 为 2，初始 zxid 为初始生成的值。 </p>
</li>
<li><p>每个节点接受并检查对方的投票信息，比如投票时间、是否状态为 LOOKING 状态的投票。 </p>
</li>
<li><p>对比投票，优先检查 xvid，如果 xvid 不一样则 xvid 大的为 leader，如果 xvid 相同则继续对比 myid，myid 大的一方为 leader</p>
</li>
</ol>
<p>成为 Leader 的必要条件： Leader 要具有最高的 zxid；当集群的规模是 n 时， 集群中大多数的机器（至少 n/2+1）得到响应并 follow 选出的 Leader。 </p>
<p>心跳机制：Leader 与 Follower 利用 PING 来感知对方的是否存活，当 Leader 无 法响应 PING 时，将重新发起 Leader 选举。</p>
<h4 id="3-4-4-4-投票日志"><a href="#3-4-4-4-投票日志" class="headerlink" title="3.4.4.4 投票日志"></a>3.4.4.4 投票日志</h4><p>Zookeeper1 的投票日志:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># tail -f /apps/zookeeper/conf/zookeeper.out</span><br>2021-08-30 11:44:29,647 [myid:1] - <span class="hljs-builtin-name">INFO</span>  [QuorumPeer[<span class="hljs-attribute">myid</span>=1]/0:0:0:0:0:0:0:0:2181<span class="hljs-keyword">:Environment</span>@100] -<span class="hljs-built_in"> Server </span>environment:user.<span class="hljs-attribute">name</span>=root<br>2021-08-30 11:44:29,647 [myid:1] - <span class="hljs-builtin-name">INFO</span>  [QuorumPeer[<span class="hljs-attribute">myid</span>=1]/0:0:0:0:0:0:0:0:2181<span class="hljs-keyword">:Environment</span>@100] -<span class="hljs-built_in"> Server </span>environment:user.<span class="hljs-attribute">home</span>=/root<br>2021-08-30 11:44:29,647 [myid:1] - <span class="hljs-builtin-name">INFO</span>  [QuorumPeer[<span class="hljs-attribute">myid</span>=1]/0:0:0:0:0:0:0:0:2181<span class="hljs-keyword">:Environment</span>@100] -<span class="hljs-built_in"> Server </span>environment:user.<span class="hljs-attribute">dir</span>=/apps/zookeeper-3.4.14<br>2021-08-30 11:44:29,648 [myid:1] - <span class="hljs-builtin-name">INFO</span>  [QuorumPeer[<span class="hljs-attribute">myid</span>=1]/0:0:0:0:0:0:0:0:2181:ZooKeeperServer@174] - Created<span class="hljs-built_in"> server </span>with tickTime 2000 minSessionTimeout 4000 maxSessionTimeout 40000 datadir /apps/zookeeper/data/version-2 snapdir /apps/zookeeper/data/version-2<br>2021-08-30 11:44:29,648 [myid:1] - <span class="hljs-builtin-name">INFO</span>  [QuorumPeer[<span class="hljs-attribute">myid</span>=1]/0:0:0:0:0:0:0:0:2181:Follower@65] - FOLLOWING - LEADER ELECTION TOOK - 276867<br></code></pre></td></tr></table></figure>

<p>Zookeeper2 的投票日志：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># tail -f /apps/zookeeper/conf/zookeeper.out</span><br>2021-08-30 11:44:29,667 [myid:2] - <span class="hljs-builtin-name">INFO</span>  [QuorumPeer[<span class="hljs-attribute">myid</span>=2]/0:0:0:0:0:0:0:0:2181<span class="hljs-keyword">:Environment</span>@100] -<span class="hljs-built_in"> Server </span>environment:user.<span class="hljs-attribute">dir</span>=/apps/zookeeper-3.4.14/conf<br>2021-08-30 11:44:29,668 [myid:2] - <span class="hljs-builtin-name">INFO</span>  [QuorumPeer[<span class="hljs-attribute">myid</span>=2]/0:0:0:0:0:0:0:0:2181:ZooKeeperServer@174] - Created<span class="hljs-built_in"> server </span>with tickTime 2000 minSessionTimeout 4000 maxSessionTimeout 40000 datadir /apps/zookeeper/data/version-2 snapdir /apps/zookeeper/data/version-2<br>2021-08-30 11:44:29,669 [myid:2] - <span class="hljs-builtin-name">INFO</span>  [QuorumPeer[<span class="hljs-attribute">myid</span>=2]/0:0:0:0:0:0:0:0:2181:Follower@65] - FOLLOWING - LEADER ELECTION TOOK - 229<br></code></pre></td></tr></table></figure>

<p>Zookeeper3 的投票日志：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle"># tail -f <span class="hljs-regexp">/apps/</span>zookeeper<span class="hljs-regexp">/conf/</span>zookeeper.out<br><span class="hljs-number">2021</span>-<span class="hljs-number">08</span>-<span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">44</span>:<span class="hljs-number">29</span>,<span class="hljs-number">668</span> [myid:<span class="hljs-number">3</span>] - INFO  [QuorumPeer[myid=<span class="hljs-number">3</span>]<span class="hljs-regexp">/0:0:0:0:0:0:0:0:2181:ZooKeeperServer@174] - Created server with tickTime 2000 minSessionTimeout 4000 maxSessionTimeout 40000 datadir /</span>apps<span class="hljs-regexp">/zookeeper/</span>data<span class="hljs-regexp">/version-2 snapdir /</span>apps<span class="hljs-regexp">/zookeeper/</span>data/version-<span class="hljs-number">2</span><br><span class="hljs-number">2021</span>-<span class="hljs-number">08</span>-<span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">44</span>:<span class="hljs-number">29</span>,<span class="hljs-number">669</span> [myid:<span class="hljs-number">3</span>] - INFO  [QuorumPeer[myid=<span class="hljs-number">3</span>]/<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">2181</span>:Leader@<span class="hljs-number">380</span>] - LEADING - LEADER ELECTION TOOK - <span class="hljs-number">216</span><br></code></pre></td></tr></table></figure>

<h2 id="3-5-zookeeper-数据增删改查"><a href="#3-5-zookeeper-数据增删改查" class="headerlink" title="3.5 zookeeper 数据增删改查"></a>3.5 zookeeper 数据增删改查</h2><h3 id="3-5-1-查看当前-zk-运行状态"><a href="#3-5-1-查看当前-zk-运行状态" class="headerlink" title="3.5.1 查看当前 zk 运行状态"></a>3.5.1 查看当前 zk 运行状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/zookeeper/bin/zkServer.sh status</span><br>ZooKeeper JMX enabled by default<br>Using config: /apps/zookeeper/bin/../conf/zoo.cfg<br>Mode: follower<br></code></pre></td></tr></table></figure>

<h3 id="3-5-2-命令行写入数据"><a href="#3-5-2-命令行写入数据" class="headerlink" title="3.5.2 命令行写入数据"></a>3.5.2 命令行写入数据</h3><p>可连接至 zookeeper 集群中的任意一台 zookeeper 节点进行一下操作。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/zookeeper/bin/zkCli.sh -server 172.31.4.101:2181</span><br>[zk: 172.31.4.101:2181(CONNECTED) 1] <span class="hljs-built_in">help</span> <span class="hljs-comment">#支持的命令</span><br>ZooKeeper -server host:port cmd args<br>	<span class="hljs-built_in">stat</span> path [watch]<br>	<span class="hljs-built_in">set</span> path data [version]<br>	ls path [watch]<br>	delquota [-n|-b] path<br>	ls2 path [watch]<br>	setAcl path acl<br>	setquota -n|-b val path<br>	<span class="hljs-built_in">history</span> <br>	redo cmdno<br>	printwatches on|off<br>	delete path [version]<br>	sync path<br>	listquota path<br>	rmr path<br>	get path [watch]<br>	create [-s] [-e] path data acl<br>	addauth scheme auth<br>	quit <br>	getAcl path<br>	close <br>	connect host:port<br><br>[zk: 172.31.4.101:2181(CONNECTED) 2] create /<span class="hljs-built_in">test</span> <span class="hljs-string">&quot;hello&quot;</span> <span class="hljs-comment">#写入数据</span><br>Created /<span class="hljs-built_in">test</span><br>[zk: 172.31.4.101:2181(CONNECTED) 3] get /<span class="hljs-built_in">test</span> <span class="hljs-comment">#验证数据，可以到其他节点验证数据是否一致</span><br>hello<br>cZxid = 0x100000004<br>ctime = Mon Aug 30 11:51:07 CST 2021<br>mZxid = 0x100000004<br>mtime = Mon Aug 30 11:51:07 CST 2021<br>pZxid = 0x100000004<br>cversion = 0<br>dataVersion = 0<br>aclVersion = 0<br>ephemeralOwner = 0x0<br>dataLength = 5<br>numChildren = 0<br><br>[zk: 172.31.4.101:2181(CONNECTED) 5] create /rlin1 <span class="hljs-string">&quot;11&quot;</span><br>Created /rlin1<br>[zk: 172.31.4.101:2181(CONNECTED) 6] get /rlin1 <br>11<br>cZxid = 0x100000005 <span class="hljs-comment">#leader 生成按照数据写入顺序生成的 zxid</span><br>ctime = Mon Aug 30 11:52:31 CST 2021<br>mZxid = 0x100000005 <span class="hljs-comment">#节点最新一次更新发生时的 zxid</span><br>mtime = Mon Aug 30 11:52:31 CST 2021<br>pZxid = 0x100000005<br>cversion = 0<br>dataVersion = 0<br>aclVersion = 0<br>ephemeralOwner = 0x0<br>dataLength = 2<br>numChildren = 0<br><br>[zk: 172.31.4.101:2181(CONNECTED) 7] create /rlin2 <span class="hljs-string">&quot;22&quot;</span><br>Created /rlin2<br>[zk: 172.31.4.101:2181(CONNECTED) 8] get /rlin2<br>22<br>cZxid = 0x100000006<br>ctime = Mon Aug 30 11:53:25 CST 2021<br>mZxid = 0x100000006<br>mtime = Mon Aug 30 11:53:25 CST 2021<br>pZxid = 0x100000006<br>cversion = 0<br>dataVersion = 0<br>aclVersion = 0<br>ephemeralOwner = 0x0<br>dataLength = 2<br>numChildren = 0<br><br>[zk: 172.31.4.101:2181(CONNECTED) 9] create /rlin2/linux <span class="hljs-string">&quot;m100&quot;</span><br>Created /rlin2/linux<br>[zk: 172.31.4.101:2181(CONNECTED) 10] get /rlin2/linux<br>m100<br>cZxid = 0x100000007<br>ctime = Mon Aug 30 11:56:09 CST 2021<br>mZxid = 0x100000007<br>mtime = Mon Aug 30 11:56:09 CST 2021<br>pZxid = 0x100000007<br>cversion = 0<br>dataVersion = 0<br>aclVersion = 0<br>ephemeralOwner = 0x0<br>dataLength = 4<br>numChildren = 0<br></code></pre></td></tr></table></figure>

<h2 id="3-6-zookeeper-客户端-ZooInspector"><a href="#3-6-zookeeper-客户端-ZooInspector" class="headerlink" title="3.6 zookeeper 客户端 ZooInspector"></a>3.6 zookeeper 客户端 ZooInspector</h2><p><a target="_blank" rel="noopener" href="https://github.com/zzhang5/zooinspector">https://github.com/zzhang5/zooinspector</a></p>
<h3 id="3-6-1-客户端编译"><a href="#3-6-1-客户端编译" class="headerlink" title="3.6.1 客户端编译"></a>3.6.1 客户端编译</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># git clone https://github.com/zzhang5/zooinspector.git</span><br><span class="hljs-comment"># cd zooinspector/</span><br><span class="hljs-comment"># mvn clean package</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq19.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-6-2-客户端使用"><a href="#3-6-2-客户端使用" class="headerlink" title="3.6.2 客户端使用"></a>3.6.2 客户端使用</h3><h4 id="3-6-2-1-Linux-客户端使用"><a href="#3-6-2-1-Linux-客户端使用" class="headerlink" title="3.6.2.1 Linux 客户端使用"></a>3.6.2.1 Linux 客户端使用</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># chmod +x target/zooinspector-pkg/bin/zooinspector.sh</span><br><span class="hljs-comment"># target/zooinspector-pkg/bin/zooinspector.sh</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq20.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq21.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq22.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-6-2-2-windows-客户端使用"><a href="#3-6-2-2-windows-客户端使用" class="headerlink" title="3.6.2.2 windows 客户端使用"></a>3.6.2.2 windows 客户端使用</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq23.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq24.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq25.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq26.png" srcset="/blog/img/loading.gif"></p>
<h1 id="四、kafka"><a href="#四、kafka" class="headerlink" title="四、kafka"></a>四、kafka</h1><p><a target="_blank" rel="noopener" href="http://kafka.apache.org/">http://kafka.apache.org/</a></p>
<p>阿里云消息队列：<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/ons?spm=5176.234368.h2v3icoap.427.2620db25lcHi1Q&amp;aly_as=Tz_Lue_o">https://www.aliyun.com/product/ons?spm=5176.234368.h2v3icoap.427.2620db25lcHi1Q&amp;aly_as=Tz_Lue_o</a></p>
<p>Kafka 被称为下一代分布式消息系统，由 scala 和 Java 编写，是非营利性组织 ASF(Apache Software Foundation，简称为 ASF)基金会中的一个开源项目，比如 HTTP Server、Hadoop、ActiveMQ、Tomcat 等开源软件都属于 Apache 基金会的开 源软件，类似的消息系统还有 RbbitMQ、ActiveMQ、ZeroMQ。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq27.png" srcset="/blog/img/loading.gif"></p>
<p>Kafka®用于构建实时数据管道和流应用程序。 它具有水平可伸缩性，容错性， 快速性，可在数千家公司中投入生产。</p>
<h2 id="4-1-常用消息队列对比"><a href="#4-1-常用消息队列对比" class="headerlink" title="4.1 常用消息队列对比"></a>4.1 常用消息队列对比</h2><p>kafka 最主要的优势是其具备分布式功能、并可以结合 zookeeper 可以实现动态扩容，Kafka 是一种高吞吐量的分布式发布订阅消息系统。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq28.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-2-kafka-优势"><a href="#4-2-kafka-优势" class="headerlink" title="4.2 kafka 优势"></a>4.2 kafka 优势</h2><p>kafka 通过 O(1)的磁盘数据结构提供消息的持久化，这种结构对于即使数以 TB 的消息存储也能够保持长时间的稳定性能。</p>
<p>高吞吐量：即使是非常普通的硬件 Kafka 也可以支持每秒数百万的消息。</p>
<p>支持通过 Kafka 服务器分区消息。</p>
<p>支持 Hadoop 并行数据加载。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq29.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-3-kafka-角色"><a href="#4-3-kafka-角色" class="headerlink" title="4.3 kafka 角色"></a>4.3 kafka 角色</h2><p>Broker：Kafka 集群包含一个或多个服务器，这种服务器被称为 broker。</p>
<p>Topic ：每条发布到 Kafka 集群的消息都有一个类别，这个类别被称为 topic，（物理上不同 topic 的消息分开存储在不同的文件夹，逻辑上一个 topic 的消息虽然保存于一个或多个 broker 上但用户只需指定消息的 topic 即可生产或消费数据而不必关心数据存于何处），topic 在逻辑上对 record(记录、日志)进行分组保存，消费者需要订阅相应的 topic 才能消费 topic 中的消息。</p>
<p>Partition ：是物理上的概念，每个 topic 包含一个或多个 partition，创建 topic 时可指定 parition 数量，<strong>每个 partition 对应于一个文件夹，该文件夹下存储该 partition 的数据和索引文件，为了实现实现数据的高可用，比如将分区 0 的数据分散到不同的 kafka 节点，每一个分区都有一个 broker 作为 leader 和一个 broker 作为 Follower。</strong></p>
<p>分区的优势(分区因子为 3)：</p>
<p>一：实现存储空间的横向扩容，即将多个 kafka 服务器的空间结合利用 </p>
<p>二：提升性能，多服务器读写 </p>
<p>三：实现高可用，分区 leader 分布在不同的 kafka 服务器，比如分区 0 的 leader 为服务器 A，则服务器 B 和服务器 C 为 A 的 follower，而分区 1 的 leader 为服务器 B，则服务器 A 和 C 为服务器 B 的 follower，而分区 2 的 leader 为 C， 则服务器 A 和 B 为 C 的 follower。</p>
<p>Producer：负责发布消息到 Kafka broker。</p>
<p>Consumer：消费消息，每个 consumer 属于一个特定的 consuer group（可为每个 consumer 指定 group name，若不指定 group name 则属于默认的 group），使用 consumer high level API 时，同一 topic 的一条消息只能被同一个 consumer group 内的一个 consumer 消费，但多个 consumer group 可同时消费这一消息。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq30.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-4-kafka-部署"><a href="#4-4-kafka-部署" class="headerlink" title="4.4 kafka 部署"></a>4.4 kafka 部署</h2><p><a target="_blank" rel="noopener" href="http://kafka.apache.org/quickstart">http://kafka.apache.org/quickstart</a></p>
<p>部署三台服务器的高可用 kafka 环境。</p>
<p>部署环境：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Server1</span>:<span class="hljs-number">172.31.4.101</span><br><span class="hljs-attribute">Server2</span>:<span class="hljs-number">172.31.4.102</span><br><span class="hljs-attribute">Server3</span>:<span class="hljs-number">172.31.4.103</span><br></code></pre></td></tr></table></figure>

<h3 id="4-4-1-版本选择"><a href="#4-4-1-版本选择" class="headerlink" title="4.4.1 版本选择"></a>4.4.1 版本选择</h3><p>版本格式 kafka_scala 版本_kafka 版本：<a target="_blank" rel="noopener" href="http://kafka.apache.org/downloads">http://kafka.apache.org/downloads</a></p>
<p>scala 版本 2.12：<a target="_blank" rel="noopener" href="http://distfiles.macports.org/">http://distfiles.macports.org/</a></p>
<p>scale 与 java：<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Scala/2462287?fr=aladdin">https://baike.baidu.com/item/Scala/2462287?fr=aladdin</a> </p>
<p>kafka_2.12-2.3.1 版本更新内容：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">Kafka Connect REST API 进行了一些改进。<br>Kafka Connect 现在支持增量式合作再平衡。<br>Kafka Streams 现在支持内存中的会话存储和窗口存储。<br>AdminClient 现在允许用户确定他们有权对主题执行哪些操作。<br>有一个新的代理开始时间指标。<br>JMXTool 现在可以连接到安全的 RMI 端口。<br>已添加增量式 AlterConfigs API。 旧的 AlterConfigs API 已被弃用。<br>现在，我们跟踪低于其最小 ISR 计数的分区。<br>现在，即使在代理上启用了自动主题创建，消费者也可以选择退出。<br>Kafka 组件现在可以使用外部配置存储（KIP-421）。<br>遇到错误时，我们已实现了改进的副本获取程序行为。<br></code></pre></td></tr></table></figure>

<h3 id="4-4-2-各节点部署-kafka"><a href="#4-4-2-各节点部署-kafka" class="headerlink" title="4.4.2 各节点部署 kafka"></a>4.4.2 各节点部署 kafka</h3><h4 id="4-4-2-1-kafka-节点-1"><a href="#4-4-2-1-kafka-节点-1" class="headerlink" title="4.4.2.1 kafka 节点 1"></a>4.4.2.1 kafka 节点 1</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># pwd</span><br>/apps<br><span class="hljs-comment"># wget https://archive.apache.org/dist/kafka/2.3.1/kafka_2.12-2.3.1.tgz</span><br><span class="hljs-comment"># tar xf kafka_2.12-2.3.1.tgz</span><br><span class="hljs-comment"># ln -sv /apps/kafka_2.12-2.3.1 /apps/kafka</span><br><span class="hljs-string">&#x27;kafka&#x27;</span> -&gt; <span class="hljs-string">&#x27;kafka_2.12-2.3.1&#x27;</span><br><span class="hljs-comment"># mkdir /apps/kafka/data #创建数据目录</span><br><span class="hljs-comment"># cd /apps/kafka/config/</span><br><span class="hljs-comment"># vim server.properties</span><br>21 broker.id=101 <span class="hljs-comment">#每个 broker 在集群中的唯一标识，正整数。</span><br>31 listeners=PLAINTEXT://172.31.4.101:9092 <span class="hljs-comment">#监听地址</span><br>60 log.dirs=/apps/kafka/data <span class="hljs-comment">#kakfa 用于保存数据的目录，所有的消息都会存储在该目录当中</span><br>65 num.partitions=1 <span class="hljs-comment">#设置创新新的 topic 默认分区数量</span><br>103 log.retention.hours=168 <span class="hljs-comment">#设置 kafka 中消息保留时间，默认为168小时即7天</span><br><span class="hljs-comment">#zookeeper.connect 指定连接的 zk 的地址,zk 中存储了 broker 的元数据信息,格式如下：</span><br>123 zookeeper.connect=172.31.4.101:2181,172.31.4.102:2181,172.31.4.103:2181<br>126 zookeeper.connection.timeout.ms=6000 <span class="hljs-comment">#设置连接 zookeeper 的超时时间，默认 6 秒钟</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-2-kafka-节点-2"><a href="#4-4-2-2-kafka-节点-2" class="headerlink" title="4.4.2.2 kafka 节点 2"></a>4.4.2.2 kafka 节点 2</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># pwd</span><br>/apps<br><span class="hljs-comment"># wget https://archive.apache.org/dist/kafka/2.3.1/kafka_2.12-2.3.1.tgz</span><br><span class="hljs-comment"># tar xf kafka_2.12-2.3.1.tgz</span><br><span class="hljs-comment"># ln -sv /apps/kafka_2.12-2.3.1 /apps/kafka</span><br><span class="hljs-string">&#x27;kafka&#x27;</span> -&gt; <span class="hljs-string">&#x27;kafka_2.12-2.3.1&#x27;</span><br><span class="hljs-comment"># mkdir /apps/kafka/data #创建数据目录</span><br><span class="hljs-comment"># cd /apps/kafka/config/</span><br><span class="hljs-comment"># vim server.properties</span><br>21 broker.id=102<br>31 listeners=PLAINTEXT://172.31.4.102:9092<br>60 log.dirs=/apps/kafka/data <span class="hljs-comment">#需要磁盘空间大IO快的单独分区或存储</span><br>65 num.partitions=1<br>103 log.retention.hours=168<br>123 zookeeper.connect=172.31.4.101:2181,172.31.4.102:2181,172.31.4.103:2181<br>126 zookeeper.connection.timeout.ms=6000 <br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-3-kafka-节点-3"><a href="#4-4-2-3-kafka-节点-3" class="headerlink" title="4.4.2.3 kafka 节点 3"></a>4.4.2.3 kafka 节点 3</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># pwd</span><br>/apps<br><span class="hljs-comment"># wget https://archive.apache.org/dist/kafka/2.3.1/kafka_2.12-2.3.1.tgz</span><br><span class="hljs-comment"># tar xf kafka_2.12-2.3.1.tgz</span><br><span class="hljs-comment"># ln -sv /apps/kafka_2.12-2.3.1 /apps/kafka</span><br><span class="hljs-string">&#x27;kafka&#x27;</span> -&gt; <span class="hljs-string">&#x27;kafka_2.12-2.3.1&#x27;</span><br><span class="hljs-comment"># mkdir /apps/kafka/data #创建数据目录</span><br><span class="hljs-comment"># cd /apps/kafka/config/</span><br><span class="hljs-comment"># vim server.properties</span><br>21 broker.id=103<br>31 listeners=PLAINTEXT://172.31.4.103:9092<br>60 log.dirs=/apps/kafka/data<br>65 num.partitions=1<br>103 log.retention.hours=168<br>123 zookeeper.connect=172.31.4.101:2181,172.31.4.102:2181,172.31.4.103:2181<br>126 zookeeper.connection.timeout.ms=6000<br></code></pre></td></tr></table></figure>

<h3 id="4-4-3-各节点启动-kafka"><a href="#4-4-3-各节点启动-kafka" class="headerlink" title="4.4.3 各节点启动 kafka"></a>4.4.3 各节点启动 kafka</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/kafka/bin/kafka-server-start.sh</span><br><span class="hljs-comment"># /apps/kafka/config/server.properties &amp; #此方式 zookeeper 会在 shell 断开后关闭</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-3-1-节点-1-启动-kafka"><a href="#4-4-3-1-节点-1-启动-kafka" class="headerlink" title="4.4.3.1 节点 1 启动 kafka"></a>4.4.3.1 节点 1 启动 kafka</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/kafka/bin/kafka-server-start.sh -daemon  /apps/kafka/config/server.properties #以守护进程启动</span><br><span class="hljs-comment"># tail -f /apps/kafka/logs/server.log</span><br>......<br>[2021-08-30 13:33:05,467] INFO Kafka version: 2.3.1 (org.apache.kafka.common.utils.AppInfoParser)<br>[2021-08-30 13:33:05,467] INFO Kafka commitId: 18a913733fb71c01 (org.apache.kafka.common.utils.AppInfoParser)<br>[2021-08-30 13:33:05,467] INFO Kafka startTimeMs: 1630301585463 (org.apache.kafka.common.utils.AppInfoParser)<br>[2021-08-30 13:33:05,469] INFO [KafkaServer id=101] started (kafka.server.KafkaServer)<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq7.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-3-3-2-节点-2-启动-kafka"><a href="#4-3-3-2-节点-2-启动-kafka" class="headerlink" title="4.3.3.2 节点 2 启动 kafka"></a>4.3.3.2 节点 2 启动 kafka</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/kafka/bin/kafka-server-start.sh -daemon /apps/kafka/config/server.properties</span><br><span class="hljs-comment"># tail -f /apps/kafka/logs/server.log</span><br>......<br>[2021-08-30 13:33:05,629] INFO Kafka version: 2.3.1 (org.apache.kafka.common.utils.AppInfoParser)<br>[2021-08-30 13:33:05,642] INFO Kafka commitId: 18a913733fb71c01 (org.apache.kafka.common.utils.AppInfoParser)<br>[2021-08-30 13:33:05,642] INFO Kafka startTimeMs: 1630301585599 (org.apache.kafka.common.utils.AppInfoParser)<br>[2021-08-30 13:33:05,645] INFO [KafkaServer id=102] started (kafka.server.KafkaServer)<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq8.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-4-3-3-节点-3-启动-kafka"><a href="#4-4-3-3-节点-3-启动-kafka" class="headerlink" title="4.4.3.3 节点 3 启动 kafka"></a>4.4.3.3 节点 3 启动 kafka</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/kafka/bin/kafka-server-start.sh -daemon /apps/kafka/config/server.properties</span><br><span class="hljs-comment"># tail -f /apps/kafka/logs/server.log</span><br>......<br>[2021-08-30 13:33:05,563] INFO Kafka version: 2.3.1 (org.apache.kafka.common.utils.AppInfoParser)<br>[2021-08-30 13:33:05,564] INFO Kafka commitId: 18a913733fb71c01 (org.apache.kafka.common.utils.AppInfoParser)<br>[2021-08-30 13:33:05,564] INFO Kafka startTimeMs: 1630301585551 (org.apache.kafka.common.utils.AppInfoParser)<br>[2021-08-30 13:33:05,571] INFO [KafkaServer id=103] started (kafka.server.KafkaServer)<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq9.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-4-3-4-验证-zookeeper-中-kafka-元数据"><a href="#4-4-3-4-验证-zookeeper-中-kafka-元数据" class="headerlink" title="4.4.3.4 验证 zookeeper 中 kafka 元数据"></a>4.4.3.4 验证 zookeeper 中 kafka 元数据</h4><p>1、Broker 依赖于 Zookeeper，每个 Broker 的 id 和 Topic、Partition 这些元数据信 息都会写入 Zookeeper 的 ZNode 节点中； </p>
<p>2、Consumer 依赖于 Zookeeper，Consumer 在消费消息时，每消费完一条消 息，会将产生的 offset 保存到 Zookeeper 中，下次消费在当前 offset 往后继续消 费； </p>
<p>ps：kafka0.9 之前 Consumer 的 offset 存储在 Zookeeper 中，kafka0,9 以后 offset 存储在本地。 </p>
<p>3、Partition 依赖于 Zookeeper，Partition 完成 Replication 备份后，选举出一个 Leader，这个是依托于 Zookeeper 的选举机制实现的；</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq31.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-5-测试-kafka-读写数据"><a href="#4-5-测试-kafka-读写数据" class="headerlink" title="4.5 测试 kafka 读写数据"></a>4.5 测试 kafka 读写数据</h2><p><a target="_blank" rel="noopener" href="http://kafka.apache.org/quickstart">http://kafka.apache.org/quickstart</a></p>
<h3 id="4-5-1-创建-topic"><a href="#4-5-1-创建-topic" class="headerlink" title="4.5.1 创建 topic"></a>4.5.1 创建 topic</h3><p>创建名为 logstashtest，partitions(分区)为 3，replication(每个分区的副本数/每个分区的分区因子)为 3 的 topic(主题)</p>
<p> 在任意 kafaka 服务器操作：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/kafka/bin/kafka-topics.sh --create --zookeeper 172.31.4.101:2181,172.31.4.102:2181,172.31.4.103:2181 --partitions 3 --replication-factor 3 --topic rlin1-topic</span><br>Created topic rlin1-topic.<br></code></pre></td></tr></table></figure>

<h3 id="4-5-2-验证-topic"><a href="#4-5-2-验证-topic" class="headerlink" title="4.5.2 验证 topic"></a>4.5.2 验证 topic</h3><p>状态说明：logstashtest 有三个分区分别为0、1、2，分区0的leader是3（broker.id）， 分区 0 有三个副本，并且状态都为 lsr（ln-sync，表示可以参加选举成为 leader）。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/kafka/bin/kafka-topics.sh --describe --zookeeper 172.31.4.101:2181,172.31.4.102:2181,172.31.4.103:2181 --topic rlin1-topic</span><br>Topic:rlin1-topic	PartitionCount:3	ReplicationFactor:3	Configs:<br>	Topic: rlin1-topic	Partition: 0	Leader: 103	Replicas: 103,101,102	Isr: 103,101,102<br>	Topic: rlin1-topic	Partition: 1	Leader: 101	Replicas: 101,102,103	Isr: 101,102,103<br>	Topic: rlin1-topic	Partition: 2	Leader: 102	Replicas: 102,103,101	Isr: 102,103,101<br></code></pre></td></tr></table></figure>

<h3 id="4-5-3-获取所有-topic"><a href="#4-5-3-获取所有-topic" class="headerlink" title="4.5.3 获取所有 topic"></a>4.5.3 获取所有 topic</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/kafka/bin/kafka-topics.sh --list --zookeeper  172.31.4.101:2181,172.31.4.102:2181,172.31.4.103:2181</span><br>rlin1-topic<br></code></pre></td></tr></table></figure>

<h3 id="4-5-4-测试发送消息"><a href="#4-5-4-测试发送消息" class="headerlink" title="4.5.4 测试发送消息"></a>4.5.4 测试发送消息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/kafka/bin/kafka-console-producer.sh --broker-list  172.31.4.101:9092,172.31.4.102:9092,172.31.4.103:9092 --topic rlin-topic2</span><br>&gt;msg1<br>&gt;msg2<br>&gt;msg3<br></code></pre></td></tr></table></figure>

<h3 id="4-5-5-测试获取消息"><a href="#4-5-5-测试获取消息" class="headerlink" title="4.5.5 测试获取消息"></a>4.5.5 测试获取消息</h3><p>可以到任意一台 kafka 服务器测试消息获取，只要有相应的消息获取客户端即可。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/kafka/bin/kafka-console-consumer.sh --topic rlin-topic2 --bootstrap-server 172.31.4.102:9092 --from-beginning</span><br>msg1<br>msg3<br>msg2<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq32.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-5-6-删除-topic"><a href="#4-5-6-删除-topic" class="headerlink" title="4.5.6 删除 topic"></a>4.5.6 删除 topic</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/kafka/bin/kafka-topics.sh --delete --zookeeper 172.31.4.101:2181,172.31.4.102:2181,172.31.4.103:2181 --topic rlin-topic2</span><br>Topic magedu is marked <span class="hljs-keyword">for</span> deletion.<br></code></pre></td></tr></table></figure>



<h1 id="五、ActiveMQ"><a href="#五、ActiveMQ" class="headerlink" title="五、ActiveMQ"></a>五、ActiveMQ</h1><h2 id="5-1-ActiveMQ-介绍"><a href="#5-1-ActiveMQ-介绍" class="headerlink" title="5.1 ActiveMQ 介绍"></a>5.1 ActiveMQ 介绍</h2><p><a target="_blank" rel="noopener" href="http://activemq.apache.org/">http://activemq.apache.org/</a></p>
<p>ActiveMQ 是一种开源的基于 JMS（Java Message Servie）规范的一种消息中 间件的实现，ActiveMQ 采用 Java 开发，设计目标是提供标准的、面向消息的、 能够跨越多语言和多系统的应用集成消息通信中间件。</p>
<p>ActiveMQ 提供了多语言客户端支持，除了一般的 Java 客户端以外，还可以使用 C/C++、PHP、Python、JavaScript（Ajax）等语言开发客户端。</p>
<p>目前分为经典和下一代两个版本。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq33.png" srcset="/blog/img/loading.gif"></p>
<p>下载地址：</p>
<p><a target="_blank" rel="noopener" href="http://activemq.apache.org/components/classic/download/">http://activemq.apache.org/components/classic/download/</a></p>
<p><a target="_blank" rel="noopener" href="http://activemq.apache.org/download-archives">http://activemq.apache.org/download-archives</a></p>
<h2 id="5-2-ActiveMQ-单机安装"><a href="#5-2-ActiveMQ-单机安装" class="headerlink" title="5.2 ActiveMQ 单机安装"></a>5.2 ActiveMQ 单机安装</h2><p>官方更新记录：<a target="_blank" rel="noopener" href="http://activemq.apache.org/components/classic/">http://activemq.apache.org/components/classic/</a></p>
<p>官方安装文档：<a target="_blank" rel="noopener" href="http://activemq.apache.org/getting-started">http://activemq.apache.org/getting-started</a></p>
<h3 id="5-2-1-配置-java-环境"><a href="#5-2-1-配置-java-环境" class="headerlink" title="5.2.1 配置 java 环境"></a>5.2.1 配置 java 环境</h3><p>ActiveMQ 依赖于 java 环境，因此要先配置 java</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install -y openjdk-8-jdk</span><br><span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;1.8.0_222&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_222-8u222-b10-1ubuntu1~18.04.1-b10)<br>OpenJDK 64-Bit Server VM (build 25.222-b10, mixed mode)<br></code></pre></td></tr></table></figure>

<h3 id="5-2-2-部署并启动-ActiveMQ"><a href="#5-2-2-部署并启动-ActiveMQ" class="headerlink" title="5.2.2 部署并启动 ActiveMQ"></a>5.2.2 部署并启动 ActiveMQ</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># wget https://archive.apache.org/dist/activemq/5.15.10/apache-activemq-5.15.10-bin.tar.gz</span><br><span class="hljs-comment"># tar xvf apache-activemq-5.15.10-bin.tar.gz</span><br><span class="hljs-comment"># ln -sv /usr/local/src/apache-activemq-5.15.10 /usr/local/activemq</span><br><span class="hljs-comment"># cd /usr/local/activemq</span><br><span class="hljs-comment"># /usr/local/activemq/bin/linux-x86-64/activemq start</span><br>Starting ActiveMQ Broker...<br></code></pre></td></tr></table></figure>

<h3 id="5-2-3-验证-ActiveMQ-日志"><a href="#5-2-3-验证-ActiveMQ-日志" class="headerlink" title="5.2.3 验证 ActiveMQ 日志"></a>5.2.3 验证 ActiveMQ 日志</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq34.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-4-验证-activemq-端口和进程"><a href="#5-2-4-验证-activemq-端口和进程" class="headerlink" title="5.2.4 验证 activemq 端口和进程"></a>5.2.4 验证 activemq 端口和进程</h3><h4 id="5-2-4-1-验证端口"><a href="#5-2-4-1-验证端口" class="headerlink" title="5.2.4.1 验证端口"></a>5.2.4.1 验证端口</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq35.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-2-4-2-验证进程"><a href="#5-2-4-2-验证进程" class="headerlink" title="5.2.4.2 验证进程"></a>5.2.4.2 验证进程</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq36.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-5-登录-ActiveMQ-Web-界面"><a href="#5-2-5-登录-ActiveMQ-Web-界面" class="headerlink" title="5.2.5 登录 ActiveMQ Web 界面"></a>5.2.5 登录 ActiveMQ Web 界面</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">默认账户名和密码: admin</span><br>Web 管理端口：8161<br>客户端访问端口：61616<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq37.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq38.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq39.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-3-ActiveMQ-集群部署"><a href="#5-3-ActiveMQ-集群部署" class="headerlink" title="5.3 ActiveMQ 集群部署"></a>5.3 ActiveMQ 集群部署</h2><p>略</p>
<h1 id="六、RocketMQ"><a href="#六、RocketMQ" class="headerlink" title="六、RocketMQ"></a>六、RocketMQ</h1><p><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/">https://rocketmq.apache.org/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq">https://github.com/apache/rocketmq</a></p>
<p>阿里开源基于 Java 开发的消息队列：<a target="_blank" rel="noopener" href="http://jm.taobao.org/tags/Apache-RocketMQ/">http://jm.taobao.org/tags/Apache-RocketMQ/</a> （已经贡献给Apache基金会）</p>
<h1 id="七、微服务与-dubbo"><a href="#七、微服务与-dubbo" class="headerlink" title="七、微服务与 dubbo"></a>七、微服务与 dubbo</h1><p>阿里云微服务：<a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/act/edasdubbo.html?utm_content=se_1005011324">https://promotion.aliyun.com/ntms/act/edasdubbo.html?utm_content=se_1005011324</a></p>
<p>dubbo 官网：<a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/">http://dubbo.apache.org/zh-cn/</a></p>
<p>dubbo 架构：<a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/preface/architecture.html">http://dubbo.apache.org/zh-cn/docs/user/preface/architecture.html</a></p>
<p>阿里云 dubbo 简介：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/99299.html?spm=5176.261987.1367952.1.6f112f4doomrxR">https://help.aliyun.com/document_detail/99299.html?spm=5176.261987.1367952.1.6f112f4doomrxR</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq40.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-1-生产者示例"><a href="#7-1-生产者示例" class="headerlink" title="7.1 生产者示例"></a>7.1 生产者示例</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt update</span><br><span class="hljs-comment"># apt install openjdk-8-jdk -y</span><br><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># tar xf dubbo-demo-provider-2.1.5-assembly.tar.gz</span><br><span class="hljs-comment"># cd dubbo-demo-provider-2.1.5</span><br><span class="hljs-comment"># vim conf/dubbo.properties</span><br>dubbo.registry.address=zookeeper://172.31.4.101:2181 | <br>zookeeper://172.31.4.102:2181 | zookeeper://172.31.4.103:2181 <span class="hljs-comment">#zk 集群配置</span><br>dubbo.registry.address=zookeeper://172.31.4.101:2181 <span class="hljs-comment">#单 zk 节点配置</span><br><br><span class="hljs-comment"># ./bin/start.sh #启动 provider</span><br>Starting the demo-provider ....<br><br><span class="hljs-comment"># tail -f logs/stdout.log #验证日志</span><br>OpenJDK 64-Bit Server VM warning: ignoring option PermSize=128m; support was <br>removed <span class="hljs-keyword">in</span> 8.0<br>log4j:WARN No appenders could be found <span class="hljs-keyword">for</span> logger <br>(com.alibaba.dubbo.common.logger.LoggerFactory).<br>log4j:WARN Please initialize the log4j system properly.<br>log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html<span class="hljs-comment">#noconfig for more </span><br>info.<br>[2019-11-22 16:45:09] Dubbo service server started!<br><span class="hljs-comment"># tail -f logs/dubbo-demo-provider.log #服务日志</span><br></code></pre></td></tr></table></figure>

<h3 id="7-1-2-zookeeper-验证-provider-注册"><a href="#7-1-2-zookeeper-验证-provider-注册" class="headerlink" title="7.1.2 zookeeper 验证 provider 注册"></a>7.1.2 zookeeper 验证 provider 注册</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq41.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-2-消费者示例"><a href="#7-2-消费者示例" class="headerlink" title="7.2 消费者示例"></a>7.2 消费者示例</h2><h3 id="7-2-1-部署-consumer"><a href="#7-2-1-部署-consumer" class="headerlink" title="7.2.1 部署 consumer"></a>7.2.1 部署 consumer</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tar xvf dubbo-demo-consumer-2.1.5-assembly.tar.gz</span><br><span class="hljs-comment"># cd dubbo-demo-consumer-2.1.5/</span><br><span class="hljs-comment"># vim conf/dubbo.properties</span><br>dubbo.registry.address=zookeeper://172.31.4.101:2181 | <br>zookeeper://172.31.4.102:2181 | zookeeper://172.31.4.103:2181<br><br><span class="hljs-comment"># ./bin/start.sh </span><br>Starting the demo-consumer ....OK!<br>PID: 25137<br>STDOUT: logs/stdout.log<br></code></pre></td></tr></table></figure>

<h3 id="7-2-2-zookeeper-验证-consumer-注册"><a href="#7-2-2-zookeeper-验证-consumer-注册" class="headerlink" title="7.2.2 zookeeper 验证 consumer 注册"></a>7.2.2 zookeeper 验证 consumer 注册</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq42.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-2-3-验证-consumer-日志"><a href="#7-2-3-验证-consumer-日志" class="headerlink" title="7.2.3 验证 consumer 日志"></a>7.2.3 验证 consumer 日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tail -f logs/stdout.log </span><br>[17:07:19] Hello world3, response form provider: 172.18.0.101:20880<br>[17:07:21] Hello world4, response form provider: 172.18.0.101:20880<br>[17:07:23] Hello world5, response form provider: 172.18.0.101:20880<br>[17:07:25] Hello world6, response form provider: 172.18.0.101:20880<br>[17:07:27] Hello world7, response form provider: 172.18.0.101:20880<br>[17:07:29] Hello world8, response form provider: 172.18.0.101:20880<br>[17:07:31] Hello world9, response form provider: 172.18.0.101:20880<br>[17:07:33] Hello world10, response form provider: 172.18.0.101:20880<br>[17:07:35] Hello world11, response form provider: 172.18.0.101:20880<br></code></pre></td></tr></table></figure>

<h3 id="7-2-4-验证-provider-日志"><a href="#7-2-4-验证-provider-日志" class="headerlink" title="7.2.4 验证 provider 日志"></a>7.2.4 验证 provider 日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@zk-node1:/usr/<span class="hljs-built_in">local</span>/src/dubbo-demo-provider-2.1.5<span class="hljs-comment"># tail -f logs/stdout.log </span><br>[17:10:02] Hello world84, request from consumer: /172.18.0.102:35044<br>[17:10:04] Hello world85, request from consumer: /172.18.0.102:35044<br>[17:10:06] Hello world86, request from consumer: /172.18.0.102:35044<br>[17:10:08] Hello world87, request from consumer: /172.18.0.102:35044<br>[17:10:10] Hello world88, request from consumer: /172.18.0.102:35044<br>[17:10:12] Hello world89, request from consumer: /172.18.0.102:35044<br>[17:10:14] Hello world90, request from consumer: /172.18.0.102:35044<br></code></pre></td></tr></table></figure>

<h3 id="7-2-5-总结"><a href="#7-2-5-总结" class="headerlink" title="7.2.5 总结"></a>7.2.5 总结</h3><p><strong>多个消费者会与多个生产者轮询调度</strong></p>
<h2 id="7-3-dubbo-admin"><a href="#7-3-dubbo-admin" class="headerlink" title="7.3 dubbo admin"></a>7.3 dubbo admin</h2><p>基于 zookeeper 发现并管理 provider 和 consumer。</p>
<h3 id="7-3-1-部署-dubbo-admin"><a href="#7-3-1-部署-dubbo-admin" class="headerlink" title="7.3.1 部署 dubbo admin"></a>7.3.1 部署 dubbo admin</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir /apps #运行 APP 目录</span><br><span class="hljs-comment"># cd /apps/</span><br><span class="hljs-comment"># tar xf apache-tomcat-8.5.45.tar.gz #上传并解压 tomcat</span><br><span class="hljs-comment"># cd /apps/apache-tomcat-8.5.45/webapps</span><br><span class="hljs-comment"># unzip dubboadmin.war -d dubboadmin #上传 dubbo-admin 程序压缩文件</span><br><br><span class="hljs-comment"># vim ./dubboadmin/WEB-INF/dubbo.properties #编辑配置文件，修改 zookeeper连接地址</span><br>dubbo.registry.address=zookeeper://172.18.0.101:2181 |<br>zookeeper://172.18.0.102:2181 | zookeeper://172.18.0.103:2181<br>dubbo.admin.root.password=root<br>dubbo.admin.guest.password=guest<br><span class="hljs-comment"># /apps/apache-tomcat-8.5.45/bin/catalina.sh start #启动 tomcat</span><br></code></pre></td></tr></table></figure>

<h3 id="7-3-2-验证-tomcat-日志"><a href="#7-3-2-验证-tomcat-日志" class="headerlink" title="7.3.2 验证 tomcat 日志"></a>7.3.2 验证 tomcat 日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tail -n5 /apps/apache-tomcat-8.5.45/logs/catalina.out</span><br>22-Nov-2019 17:25:11.755 INFO [localhost-startStop-1]<br>org.apache.catalina.startup.HostConfig.deployDirectory Deploying web application<br>directory [/apps/apache-tomcat-8.5.45<br>/webapps/manager]22-Nov-2019 17:25:11.769 INFO [localhost-startStop-1]<br>org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web<br>application directory [/apps/apache-tomcat-8.<br>5.45/webapps/manager] has finished <span class="hljs-keyword">in</span> [14] ms22-Nov-2019 17:25:11.781 INFO<br>[main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [<span class="hljs-string">&quot;http-nio-8080&quot;</span>]<br>22-Nov-2019 17:25:11.805 INFO [main] org.apache.coyote.AbstractProtocol.start<br>Starting ProtocolHandler [<span class="hljs-string">&quot;ajp-nio-8009&quot;</span>]<br>22-Nov-2019 17:25:11.817 INFO [main] org.apache.catalina.startup.Catalina.start<br>Server startup <span class="hljs-keyword">in</span> 14391 ms<br></code></pre></td></tr></table></figure>

<h3 id="7-3-3-验证-dubbo-admin-界面"><a href="#7-3-3-验证-dubbo-admin-界面" class="headerlink" title="7.3.3 验证 dubbo admin 界面"></a>7.3.3 验证 dubbo admin 界面</h3><p><a target="_blank" rel="noopener" href="http://172.18.0.103:8080/dubboadmin">http://172.18.0.103:8080/dubboadmin</a></p>
<p>登录界面：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq43.png" srcset="/blog/img/loading.gif"></p>
<p>应用界面：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq44.png" srcset="/blog/img/loading.gif"></p>
<p>注册中心：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq45.png" srcset="/blog/img/loading.gif"></p>
<p>系统环境：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq46.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-4-微服务编译"><a href="#7-4-微服务编译" class="headerlink" title="7.4 微服务编译"></a>7.4 微服务编译</h2><p><a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/dev/build.html">http://dubbo.apache.org/zh-cn/docs/dev/build.html</a></p>
<h3 id="7-4-1-代码克隆与编译"><a href="#7-4-1-代码克隆与编译" class="headerlink" title="7.4.1 代码克隆与编译"></a>7.4.1 代码克隆与编译</h3><p>以 github 上 java 开源项目 dubbo-admin 为例</p>
<p>Github 地址：<a target="_blank" rel="noopener" href="https://github.com/apache/dubbo-admin/blob/develop/README_ZH.md">https://github.com/apache/dubbo-admin/blob/develop/README_ZH.md</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/<br><span class="hljs-comment"># git clone https://github.com/apache/dubbo-admin.git</span><br>Cloning into <span class="hljs-string">&#x27;dubbo-admin&#x27;</span>...<br>remote: Enumerating objects: 3, <span class="hljs-keyword">done</span>.<br>remote: Counting objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>remote: Compressing objects: 100% (3/3), <span class="hljs-keyword">done</span>.<br>remote: Total 7664 (delta 0), reused 0 (delta 0), pack-reused 7661<br>Receiving objects: 100% (7664/7664), 12.85 MiB | 722.00 KiB/s, <span class="hljs-keyword">done</span>.<br>Resolving deltas: 100% (4164/4164), <span class="hljs-keyword">done</span>.<br></code></pre></td></tr></table></figure>

<h3 id="7-4-2-maven-部署准备"><a href="#7-4-2-maven-部署准备" class="headerlink" title="7.4.2 maven 部署准备"></a>7.4.2 maven 部署准备</h3><p>Maven 翻译为”专家”、”内行”，是 Apache 基金会旗下的一个纯 Java 开发的开 源项目，Maven 是一个项目管理工具，可以对 Java 项目进行构建、解决打包依 赖等。</p>
<p>POM( Project Object Model，项目对象模型 ) 是 Maven 工程的基本工作单元， 是一个 XML 文件，包含了项目的基本信息，用于描述项目如何构建，声明项目依赖等，在执行任务或目标时，Maven 会在当前目录中查找 pom 文件，通过读 取 pom 文件获取所需的配置信息，然后执行目标。</p>
<p>Pom 文件中可以指定以下配置：</p>
<ol>
<li>项目依赖 </li>
<li>插件 </li>
<li>执行目标 </li>
<li>项目构建 profile </li>
<li>项目版本 </li>
<li>项目开发者列表 </li>
<li>相关邮件列表信息</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://maven.apache.org/install.html">http://maven.apache.org/install.html</a></p>
<p>清华镜像源：<a target="_blank" rel="noopener" href="http://mirrors.tuna.tsinghua.edu.cn/apache/maven">http://mirrors.tuna.tsinghua.edu.cn/apache/maven</a></p>
<p>官方各版本下载地址，推荐使用次新版本：<a target="_blank" rel="noopener" href="https://archive.apache.org/dist/maven/maven-3/">https://archive.apache.org/dist/maven/maven-3/</a></p>
<p>java 环境： </p>
<p>Maven 是一个基于 Java 的工具所以服务器要安装 jdk 环境，版本要求如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">Maven 3.3 要求 JDK 1.7 或以上<br>Maven 3.2 要求 JDK 1.6 或以上<br>Maven 3.0/3.1 要求 JDK 1.5 或以上<br></code></pre></td></tr></table></figure>

<p>jdk部署：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># 下载ocrale的jdk</span><br><span class="hljs-comment"># tar xf jdk-8u241-linux-x64.tar.gz</span><br><span class="hljs-comment"># ln -sv /usr/local/src/jdk1.8.0_241 /usr/local/jdk</span><br><span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-comment">#添加一下内容</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/dt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><span class="hljs-built_in">export</span> PATH=/usr/<span class="hljs-built_in">local</span>/src/apache-maven-3.6.3/bin/:<span class="hljs-variable">$PATH</span><br><span class="hljs-comment"># source /etc/profile</span><br></code></pre></td></tr></table></figure>

<p>Maven 部署：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment"># wget https://archive.apache.org/dist/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz</span><br><br><span class="hljs-comment"># tar xf apache-maven-3.6.3-bin.tar.gz</span><br><span class="hljs-built_in">export</span> PATH=/usr/<span class="hljs-built_in">local</span>/src/apache-maven-3.6.3/bin/:<span class="hljs-variable">$PATH</span><br><br><span class="hljs-comment"># mvn -v #验证 mvn 是否可用</span><br>Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)<br>Maven home: /usr/<span class="hljs-built_in">local</span>/src/apache-maven-3.6.3<br>Java version: 1.8.0_241, vendor: Oracle Corporation, runtime: /usr/<span class="hljs-built_in">local</span>/src/jdk1.8.0_241/jre<br>Default locale: en_HK, platform encoding: UTF-8<br>OS name: <span class="hljs-string">&quot;linux&quot;</span>, version: <span class="hljs-string">&quot;4.15.0-55-generic&quot;</span>, arch: <span class="hljs-string">&quot;amd64&quot;</span>, family: <span class="hljs-string">&quot;unix&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="7-6-3-执行-java-代码编译"><a href="#7-6-3-执行-java-代码编译" class="headerlink" title="7.6.3 执行 java 代码编译"></a>7.6.3 执行 java 代码编译</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh">Maven 的打包命令<br>1.进入到包含有“pom.xml”的路径，执行：<br>mvn clean install package<br><br>2.有的时候受到测试的干扰，导致无法正在进行编译，这时候可以选择跳过测试：<br>mvn clean install package -Dmaven.test.skip=<span class="hljs-literal">true</span><br> <span class="hljs-string">&quot; -Dmaven.test.skip=true&quot;</span>：跳过测试，并且不编译测试下的源代码；<br> <span class="hljs-string">&quot;-DskipTests&quot;</span>：不执行测试，但是会进行测试代码的编译；<br>3.如果需要编译的代码异常庞大，需要考虑对编译环境做一些处理，提成编译效率：<br>启动多线程编译：mvn -T 4 clean install package -Dmaven.test.skip=<span class="hljs-literal">true</span><br>分配编译的 CPU 个数：mvn -T 2C clean install package -Dmaven.test.skip=<span class="hljs-literal">true</span><br>启用多线程编译：mvn clean install package -Dmaven.test.skip=<span class="hljs-literal">true</span> -Dmaven.compile.fork=<span class="hljs-literal">true</span><br>4.所有的 Maven 都是建立在 JVM 上的，所以进行编译的时候还需要考虑 JVM 参数优化：<br>如果是 windows 找到“maven/bin/mvn.cmd”，如果linux找到“maven/bin/mvn”，配置参数是：“MAVEN_OPTS”<br>打开属性配置文件：vim /etc/profile<br>追加一个配置项：<span class="hljs-built_in">export</span> MAVEN_OPTS=<span class="hljs-string">&quot;-Xmx6g -Xms6g&quot;</span><br>使配置立即生效：<span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure>

<h4 id="7-4-3-1-执行源码编译"><a href="#7-4-3-1-执行源码编译" class="headerlink" title="7.4.3.1 执行源码编译"></a>7.4.3.1 执行源码编译</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/src/dubbo-admin #进入到源码目录</span><br><span class="hljs-comment"># vim dubbo-admin-server/src/main/resources/application.properties #修改zookeeper 地址为实际 IP</span><br><span class="hljs-comment"># centers in dubbo2.7</span><br>admin.registry.address=zookeeper://172.31.0.106:2181<br>admin.config-center=zookeeper://172.31.0.106:2181<br>admin.metadata-report.address=zookeeper://172.31.0.106:2181<br><br><span class="hljs-comment"># export MAVEN_OPTS=-Xmx1024m -XX:MaxPermSize=512m</span><br><span class="hljs-comment"># mvn clean package #官方执行 java 编译</span><br><span class="hljs-comment"># mvn clean install package -Dmaven.test.skip=true #执行 java 源码编译并跳过测试单元</span><br></code></pre></td></tr></table></figure>

<p>报错：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">[ERROR] Killed<br>[ERROR] npm ERR! code ELIFECYCLE<br>[ERROR] npm ERR! errno 137<br>[ERROR] npm ERR! dubbo-admin-ui@1.0.0 build: `node build/build.js`<br>[ERROR] npm ERR! Exit status 137<br>[ERROR] npm ERR! <br>[ERROR] npm ERR! Failed at the dubbo-admin-ui@1.0.0 build script.<br></code></pre></td></tr></table></figure>

<p>解决办法： </p>
<p>1.服务器增加内存(推荐 4G 或以上)，避免被内核 OOM </p>
<p>2.服务器修改 node.js 源为淘宝源，加速资源下载</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@web2:/opt/dubbo-admin<span class="hljs-comment"># npm config get registry</span><br>https://registry.npmjs.org/<br>root@web2:/opt/dubbo-admin<span class="hljs-comment"># npm config set registry </span><br>https://registry.npm.taobao.org<br>root@web2:/opt/dubbo-admin<span class="hljs-comment"># npm config get registry</span><br></code></pre></td></tr></table></figure>

<h4 id="7-4-3-2-编译过程中"><a href="#7-4-3-2-编译过程中" class="headerlink" title="7.4.3.2 编译过程中"></a>7.4.3.2 编译过程中</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq47.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-4-3-3-编译完成"><a href="#7-4-3-3-编译完成" class="headerlink" title="7.4.3.3 编译完成"></a>7.4.3.3 编译完成</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq48.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-4-3-4-验证-java-包"><a href="#7-4-3-4-验证-java-包" class="headerlink" title="7.4.3.4 验证 java 包"></a>7.4.3.4 验证 java 包</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ll -h ./dubbo-admin-distribution/target/dubbo-admin-0.1.jar </span><br>-rw-r--r-- 1 root root 61M Dec 25 11:39 dubbo-admin-distribution/target/dubbo-admin-0.1.jar<br></code></pre></td></tr></table></figure>

<h4 id="7-4-3-5-启动服务测试"><a href="#7-4-3-5-启动服务测试" class="headerlink" title="7.4.3.5 启动服务测试"></a>7.4.3.5 启动服务测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># java -jar dubbo-admin-distribution/target/dubbo-admin-0.1.jar</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq49.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-4-3-6-web-界面验证"><a href="#7-4-3-6-web-界面验证" class="headerlink" title="7.4.3.6 web 界面验证"></a>7.4.3.6 web 界面验证</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq50.png" srcset="/blog/img/loading.gif"></p>
<p>登录名和密码为 root</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq51.png" srcset="/blog/img/loading.gif"></p>
<h1 id="八、Nexus"><a href="#八、Nexus" class="headerlink" title="八、Nexus"></a>八、Nexus</h1><p>Nexus 是一个强大的 Maven 仓库管理器，它极大地简化了自己内部仓库的维护和外部仓库的访问。</p>
<p>maven 官方仓库：<a target="_blank" rel="noopener" href="http://repo.maven.apache.org/">http://repo.maven.apache.org/</a></p>
<p>官方下载页面：<a target="_blank" rel="noopener" href="https://help.sonatype.com/repomanager3/download/download-archives---repository-manager-3">https://help.sonatype.com/repomanager3/download/download-archives---repository-manager-3</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq52.png" srcset="/blog/img/loading.gif"></p>
<h2 id="8-1-部署-nexus"><a href="#8-1-部署-nexus" class="headerlink" title="8.1 部署 nexus"></a>8.1 部署 nexus</h2><p>内存推荐 4G 或以上，太小会导致无法启动，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@nexus-server:/usr/<span class="hljs-built_in">local</span>/nexus<span class="hljs-comment"># ./bin/nexus run</span><br>WARNING: ************************************************************<br>WARNING: Detected execution as <span class="hljs-string">&quot;root&quot;</span> user. This is NOT recommended!<br>WARNING: ************************************************************<br>Java HotSpot(TM) 64-Bit Server VM warning: INFO: <br>os::commit_memory(0x0000000717000000, 1890582528, 0) failed; error=<span class="hljs-string">&#x27;Cannot </span><br><span class="hljs-string">allocate memory&#x27;</span> (errno=12)<br></code></pre></td></tr></table></figure>

<h3 id="8-1-1-启动-nexus"><a href="#8-1-1-启动-nexus" class="headerlink" title="8.1.1 启动 nexus"></a>8.1.1 启动 nexus</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#先配置jdk，直接下载直接用</span><br>root@nexus-server:/apps<span class="hljs-comment"># tar xf nexus-3.20.1-01-unix.tar.gz</span><br>root@nexus-server:/apps<span class="hljs-comment"># ln -sv /apps/nexus-3.20.1-01  /apps/nexus</span><br><span class="hljs-string">&#x27;/apps/nexus&#x27;</span> -&gt; <span class="hljs-string">&#x27;/apps/nexus-3.20.1-01&#x27;</span><br>root@nexus-server:/apps<span class="hljs-comment"># cd /apps/nexus</span><br><br><span class="hljs-comment"># ./bin/nexus --help</span><br><span class="hljs-comment"># ./bin/nexus run</span><br><span class="hljs-comment"># ./bin/nexus start</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq53.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-1-2-登录-web-界面"><a href="#8-1-2-登录-web-界面" class="headerlink" title="8.1.2 登录 web 界面"></a>8.1.2 登录 web 界面</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq54.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-1-3-设置向导"><a href="#8-1-3-设置向导" class="headerlink" title="8.1.3 设置向导"></a>8.1.3 设置向导</h3><p>设置向导：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq55.png" srcset="/blog/img/loading.gif"></p>
<p>设置密码：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq56.png" srcset="/blog/img/loading.gif"></p>
<p>匿名下载：</p>
<p>启用匿名访问将默认允许未经授权的下载，浏览和搜索存储库内容，可以通过 编辑分配给匿名用户的角色来更改未经身份验证的用户的权限。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq57.png" srcset="/blog/img/loading.gif"></p>
<p>完成：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq58.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-1-4-验证默认仓库"><a href="#8-1-4-验证默认仓库" class="headerlink" title="8.1.4 验证默认仓库"></a>8.1.4 验证默认仓库</h3><p><strong>Hosted</strong>：本地仓库，通常我们会部署自己的构件到这一类型的仓库，比如公司 的第三方库</p>
<p><strong>Proxy</strong>：代理仓库，它们被用来代理远程的公共仓库，如 maven 中央仓库(官方 仓库)。</p>
<p><strong>Group</strong>：仓库组，用来合并多个 hosted/proxy 仓库，当你的项目希望在多个 repository 使用资源时就不需要多次引用了，只需要引用一个 group 即可。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq59.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-1-5-service文件"><a href="#8-1-5-service文件" class="headerlink" title="8.1.5 service文件"></a>8.1.5 service文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /lib/systemd/system/nexus.service<br>[Unit]<br>Description=nexus service<br>After=network.target<br><br>[Service]<br>Type=forking<br>LimitNOFILE=65536<br>ExecStart=/opt/nexus/bin/nexus start<br>ExecStop=/opt/nexus/bin/nexus stop<br>User=nexus <span class="hljs-comment">#或root</span><br>Restart=on-abort<br><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment"># systemctl daemon-reload</span><br><span class="hljs-comment"># systemctl restart nexus.service</span><br><span class="hljs-comment"># systemctl enable nexus.service</span><br></code></pre></td></tr></table></figure>

<h2 id="8-2-使用-nexus-构建私有-yum-仓库示例"><a href="#8-2-使用-nexus-构建私有-yum-仓库示例" class="headerlink" title="8.2 使用 nexus 构建私有 yum 仓库示例"></a>8.2 使用 nexus 构建私有 yum 仓库示例</h2><h3 id="8-2-1-nesux-仓库配置"><a href="#8-2-1-nesux-仓库配置" class="headerlink" title="8.2.1 nesux 仓库配置"></a>8.2.1 nesux 仓库配置</h3><p>通过 nexus 作为公司内网 yum 仓库,通过阿里云镜像安装包</p>
<p>阿里云镜像地址：<a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/zabbix/zabbix/4.4/rhel/7/x86_64/">https://mirrors.aliyun.com/zabbix/zabbix/4.4/rhel/7/x86_64/</a></p>
<p>setting–Create repository—yum(proxy)</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq60.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq61.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq10.png" srcset="/blog/img/loading.gif" alt="apt仓库设置"></p>
<p>注意：distribution写ubuntu的版本，remote storage写外网远程仓库的ubuntu地址，Blob store写对应的仓库</p>
<h3 id="8-2-2-centos-7-x-配置-yum-仓库"><a href="#8-2-2-centos-7-x-配置-yum-仓库" class="headerlink" title="8.2.2 centos 7.x 配置 yum 仓库"></a>8.2.2 centos 7.x 配置 yum 仓库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@localhost ~]<span class="hljs-comment"># cat /etc/redhat-release </span><br>CentOS Linux release 7.7.1908 (Core)<br>[root@localhost ~]<span class="hljs-comment"># cat /etc/yum.repos.d/zabbix.repo </span><br>[zabbix-nexus]<br>name=zabbix<br>baseurl=http://172.31.0.105:8081/repository/zabbix-proxy/<br>enabled=1<br>gpgcheck=0<br></code></pre></td></tr></table></figure>

<h3 id="8-2-3-centos7-x-安装-zabbix-测试"><a href="#8-2-3-centos7-x-安装-zabbix-测试" class="headerlink" title="8.2.3 centos7.x 安装 zabbix 测试"></a>8.2.3 centos7.x 安装 zabbix 测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install zabbix-agent zabbix-get --nogpgcheck</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq62.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq63.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-2-4-验证nexus数据"><a href="#8-2-4-验证nexus数据" class="headerlink" title="8.2.4 验证nexus数据"></a>8.2.4 验证nexus数据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq64.png" srcset="/blog/img/loading.gif"></p>
<h2 id="8-3-修改-nexus-数据目录"><a href="#8-3-修改-nexus-数据目录" class="headerlink" title="8.3 修改 nexus 数据目录"></a>8.3 修改 nexus 数据目录</h2><p>将 nexus 的数据目录修改为/data，公司一般为存储大，读写快的硬盘</p>
<h3 id="8-3-1-nexus-配置"><a href="#8-3-1-nexus-配置" class="headerlink" title="8.3.1 nexus 配置"></a>8.3.1 nexus 配置</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq65.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq66.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq67.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-3-2-nexus-服务器产生数据"><a href="#8-3-2-nexus-服务器产生数据" class="headerlink" title="8.3.2 nexus 服务器产生数据"></a>8.3.2 nexus 服务器产生数据</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@localhost ~]<span class="hljs-comment"># yum install zabbix-server</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq68.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-3-3-验证-nexus-数据目录"><a href="#8-3-3-验证-nexus-数据目录" class="headerlink" title="8.3.3 验证 nexus 数据目录"></a>8.3.3 验证 nexus 数据目录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ll /data/magedu/</span><br>total 24<br>drwxr-xr-x 3 root root 4096 Mar 24 11:49 ./<br>drwxr-xr-x 7 root root 4096 Mar 24 11:44 ../<br>-rw-r--r-- 1 root root 4096 Mar 24 11:44 CB3FB1E6-ED6CD3AC-A316E2DB-CAE133B5-<br>38FF13DA-deletions.index<br>-rw-r--r-- 1 root root 90 Mar 24 11:49 CB3FB1E6-ED6CD3AC-A316E2DB-CAE133B5-38FF13DA-metrics.properties<br>drwxr-xr-x 7 root root 4096 Mar 24 11:49 content/<br>-rw-r--r-- 1 root root 72 Mar 24 11:44 metadata.properties<br><br><span class="hljs-comment"># file /data/magedu/content/vol-01/chap-42/f22747ca-d621-4431-acc8-c6600dfb80d6.bytes </span><br>/data/magedu/content/vol-01/chap-42/f22747ca-d621-4431-acc8-c6600dfb80d6.bytes: RPM v3.0 bin i386/x86_64<br></code></pre></td></tr></table></figure>

<h2 id="8-4-nexus-数据备份"><a href="#8-4-nexus-数据备份" class="headerlink" title="8.4 nexus 数据备份"></a>8.4 nexus 数据备份</h2><p>Nexus 中普通数据信息和元数据是分开存储的，普通数据是保存在 blob 中，而元 数据保存在数据库中，所以在备份的时候必须同时进行备份普通数据和元数据， 才能在后期恢复数据的时候保证数据的最终完整性。</p>
<p>blob 数据： 普通数据信息在 Nexus 中是保存在 blob 中的，所以此部分数据必须进行备份， blob 的典型配置中，此目录对应着 Nexus 的数据目录的 blobs 子目录。</p>
<p>元数据： 元数据在 Nexus 中是在数据库中进行保存的，为了保证数据的完整性，Nexus 需要同时将数据库中的数据进行导出和备份</p>
<p>一般需要备份的有两个：</p>
<ol>
<li>Admin - Compact bolb store</li>
<li>Admin - Export databases for backup</li>
</ol>
<h3 id="8-4-1-nexus-备份配置"><a href="#8-4-1-nexus-备份配置" class="headerlink" title="8.4.1 nexus 备份配置"></a>8.4.1 nexus 备份配置</h3><h4 id="8-4-1-1-添加存储用于保存备份数据"><a href="#8-4-1-1-添加存储用于保存备份数据" class="headerlink" title="8.4.1.1 添加存储用于保存备份数据"></a>8.4.1.1 添加存储用于保存备份数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq69.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq70.png" srcset="/blog/img/loading.gif"></p>
<h4 id="8-4-1-2-nexus-blob-备份计划任务"><a href="#8-4-1-2-nexus-blob-备份计划任务" class="headerlink" title="8.4.1.2 nexus blob 备份计划任务"></a>8.4.1.2 nexus blob 备份计划任务</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq71.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq72.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq73.png" srcset="/blog/img/loading.gif"></p>
<p>配置数据目录和备份时间：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq74.png" srcset="/blog/img/loading.gif"></p>
<h4 id="8-4-1-3-nexus-元数据备份计划任务"><a href="#8-4-1-3-nexus-元数据备份计划任务" class="headerlink" title="8.4.1.3 nexus 元数据备份计划任务"></a>8.4.1.3 nexus 元数据备份计划任务</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq75.png" srcset="/blog/img/loading.gif"></p>
<p>任务配置：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq76.png" srcset="/blog/img/loading.gif"></p>
<p>验证计划任务：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq77.png" srcset="/blog/img/loading.gif"></p>
<h4 id="8-4-1-5-测试备份"><a href="#8-4-1-5-测试备份" class="headerlink" title="8.4.1.5 测试备份"></a>8.4.1.5 测试备份</h4><h5 id="8-4-1-5-1-立即备份普通数据"><a href="#8-4-1-5-1-立即备份普通数据" class="headerlink" title="8.4.1.5.1 立即备份普通数据"></a>8.4.1.5.1 立即备份普通数据</h5><p>进入到普通数据备份任务计划：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq78.png" srcset="/blog/img/loading.gif"></p>
<p>立即备份；</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq79.png" srcset="/blog/img/loading.gif"></p>
<p>备份结果：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq80.png" srcset="/blog/img/loading.gif"></p>
<h5 id="8-4-1-5-2-立即备份元数据"><a href="#8-4-1-5-2-立即备份元数据" class="headerlink" title="8.4.1.5.2 立即备份元数据"></a>8.4.1.5.2 立即备份元数据</h5><p>进入到元数据备份任务计划：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq81.png" srcset="/blog/img/loading.gif"></p>
<p>执行备份：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq82.png" srcset="/blog/img/loading.gif"></p>
<p>备份结果：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq83.png" srcset="/blog/img/loading.gif"></p>
<h4 id="8-4-1-6-验证备份数据"><a href="#8-4-1-6-验证备份数据" class="headerlink" title="8.4.1.6 验证备份数据"></a>8.4.1.6 验证备份数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/rabbitmq/rabbitmq84.png" srcset="/blog/img/loading.gif"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/linux-rabbitmq-zookeeper-kafka/">linux rabbitmq zookeeper kafka</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/09/02/ELK/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ELK</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/">
                        <span class="hidden-mobile">网络文件共享服务</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
