

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>企业级Web应用服务器TOMCAT - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="企业级Web应用服务器TOMCAT">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-02 14:25" pubdate>
        2021年9月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      71.8k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      1120
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">企业级Web应用服务器TOMCAT</h1>
            
            <div class="markdown-body">
              <h1 id="企业级WEB应用服务器TOMCAT"><a href="#企业级WEB应用服务器TOMCAT" class="headerlink" title="企业级WEB应用服务器TOMCAT"></a>企业级WEB应用服务器TOMCAT</h1><h1 id="一、-WEB技术"><a href="#一、-WEB技术" class="headerlink" title="一、 WEB技术"></a>一、 WEB技术</h1><h2 id="1-1-HTTP协议和B-S-结构"><a href="#1-1-HTTP协议和B-S-结构" class="headerlink" title="1.1 HTTP协议和B/S 结构"></a>1.1 HTTP协议和B/S 结构</h2><p>操作系统有进程子系统，使用多进程就可以充分利用硬件资源。进程中可以多个线程，每一个线程可以被CPU调度执行，这样就可以让程序并行的执行。这样一台主机就可以作为一个服务器为多个客户端提供计算服务。</p>
<p>客户端和服务端往往处在不同的物理主机上，它们分属不同的进程，这些进程间需要通信。跨主机的进程间通信需要使用网络编程。最常见的网络编程接口是Socket。</p>
<p>Socket称为套接字，本意是插座。也就是说网络通讯需要两端，如果一端被动的接收另一端请求并提供计算和数据的称为服务器端，另一端往往只是发起计算或数据请求，称为客户端。</p>
<p>这种编程模式称为Client/Server编程模式，简称C/S编程。开发的程序也称为C/S程序。C/S编程往往使用传输层协议（TCP/UDP），较为底层，比如：QQ，迅雷, 云音乐, 云盘, foxmail，xshell等</p>
<p>1990年HTTP协议和浏览器诞生。在应用层使用文本跨网络在不同进程间传输数据，最后在浏览器中将服务器端返回的HTML渲染出来。由此，诞生了网页开发。</p>
<p>网页是存储在WEB服务器端的文本文件，浏览器发起HTTP请求后，到达WEB服务程序后，服务程序根据URL读取对应的HTML文件，并封装成HTTP响应报文返回给浏览器端。</p>
<p>起初网页开发主要指的是HTML、CSS等文件制作，目的就是显示文字或图片，通过超级链接跳转到另一个HTML并显示其内容。</p>
<p>后来，网景公司意识到让网页动起来很重要，傍着SUN的Java的名气发布了JavaScript语言，可以在浏览器中使用JS引擎执行的脚本语言，可以让网页元素动态变化，网页动起来了。</p>
<p>为了让网页动起来，微软使用ActiveX技术、SUN的Applet都可以在浏览器中执行代码，但都有安全性问题。能不能直接把内容直接在WEB服务器端组织成HTML，然后把HTML返回给浏览器渲染呢？</p>
<p>最早出现了CGI（Common Gateway Interface）通用网关接口，通过浏览器中输入URL直接映射到一个服务器端的脚本程序执行，这个脚本可以查询数据库并返回结果给浏览器端。这种将用户请求使用程序动态生成的技术，称为动态网页技术。先后出现了ASP、PHP、JSP等技术，这些技术的使用不同语言编写的程序都运行在服务器端，所以称为<strong>WEB后端编程</strong>。有一部分程序员还是要编写HTML、CSS、JavaScript，这些代码运行在浏览器端，称为<strong>WEB前端编程</strong>。合起来称为Browser/Server编程，即<strong>B/S编程</strong>。</p>
<h2 id="1-2-浏览器发展历史"><a href="#1-2-浏览器发展历史" class="headerlink" title="1.2 浏览器发展历史"></a>1.2 浏览器发展历史</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat1.png" srcset="/blog/img/loading.gif"></p>
<p>1980年代，Tim Berners-Lee为CERN（欧洲核子研究中心，当时欧洲最大的互联网节点）设计基于超文本思想的ENQUIRE项目，以促进科研人员之间的信息共享和更新。1989年3月他编写了《信息化管理：建议》一文，并构建基于Internet的Hypertext系统，并在CERN开发了World Wide Web项目，打造了世界上第一个网站，于1991年8月6日正式上线。</p>
<p>Tim Berners-Lee于1990年12月29日发明了第一个浏览器 WorldWideWeb ，还发明了HTTP协议。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat2.png" srcset="/blog/img/loading.gif"></p>
<p>1994年为了完成麻省理工学院（MIT）与欧洲粒子物理研究所（CERN）之间的协同工作，Tim创建了W3C（ World Wide Web Consortium 万维网联盟），负责万维网持续发展，并提出W3C的标准应该基于无专利权、无版税</p>
<p>Marc Andreessen于1993年发明了马赛克Mosaic浏览器。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat3.png" srcset="/blog/img/loading.gif"></p>
<p>看到了这个技术的前景，不久后他成立自己的公司——网景Netscape。1994发布了NetscapeNavigator浏览器，席卷全球。苹果公司采用了Netscape浏览器。</p>
<p>Spyclass公司从NCSA获得Masaic的商标和技术，微软在1994年以200万美元从Spyclass公司购买了Mosaic授权，使用了部分Mosaic源码，1995年微软发布Windows 95捆绑IE，开启第一次浏览器大战，最终后来居上。</p>
<p>1999年网景被美国在线AOL收购，收购后不久，Netscape公开了浏览器代码，并创建了Mozilla组织。</p>
<p>Mozilla组织使用Gecko引擎重写浏览器。</p>
<p>Mozilla组织使用Gecko引擎发布了几款浏览器，最终于2004年更名为Firefox浏览器。第二次浏览器大战开始了</p>
<p>2003年5月，网景被解散。</p>
<p>2007年12月AOL宣布停止支持Netscape浏览器。</p>
<p>2003年Apple的Safari发布第一个测试版。</p>
<p>2008年Google的Chrome浏览器带着 V8 JS引擎横空出世。</p>
<p>2008年IE占据浏览器市场份额的75%，Firefox占近20%，2019 年Chrome占据市场份额近70%。</p>
<p>2018年12月，微软宣布打算基于Chromium开源项目开发新版本的Edge浏览器。1月16日微软正式宣布了适用于Windows和macOS的基于Chromium开源项目Microsoft Edge浏览器的全面上市。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat4.png" srcset="/blog/img/loading.gif"></p>
<p>浏览器市场份额：<a target="_blank" rel="noopener" href="https://gs.statcounter.com/">https://gs.statcounter.com/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat5.png" srcset="/blog/img/loading.gif"></p>
<p>浏览器内两大核心：渲染引擎（解析html）和 JS引擎（解析javascript）</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">为什么谷歌的市值比微软高？为什么当年网景推 Netscape 浏览器的时候，微软很紧张？不惜亲自下场手撕，因为浏览器是另一个软件治理的入口，本质上是操作系统之上的操作系统。如果软件都运行在浏览器上，那么本地操作系统就沦为和硬件一般无二的管道了。可惜的是，这是历史趋势，无人能逆，所以谷歌现在可以反推自己的操作系统，这是降维打击<br></code></pre></td></tr></table></figure>

<h2 id="1-3-网页技术"><a href="#1-3-网页技术" class="headerlink" title="1.3 网页技术"></a>1.3 网页技术</h2><h3 id="1-3-1-静态网页技术"><a href="#1-3-1-静态网页技术" class="headerlink" title="1.3.1 静态网页技术"></a>1.3.1 静态网页技术</h3><p>早期的HTML设计之初，只能在HTML里面显示文字、图片，使用CSS来控制颜色、字体大小等。再后来引入了JavaScript就可以是网页可以人机交互、可以让元素动起来。但这都不是内容的动态变化。</p>
<h3 id="1-3-2-动态网页技术"><a href="#1-3-2-动态网页技术" class="headerlink" title="1.3.2 动态网页技术"></a>1.3.2 动态网页技术</h3><p>网页的内容是后端根据用户从浏览器端提交的请求不同，通过后台的程序进行执行，将运行的结果生成内容临时拼凑生成HTML，返回到浏览器端，通过浏览器端渲染呈现。常见的有 JSP、PHP、ASP和DotNet、Nodejs等。也可以将动态资源静态化，以加快速度。</p>
<h2 id="1-4-前端三大核心技术"><a href="#1-4-前端三大核心技术" class="headerlink" title="1.4 前端三大核心技术"></a>1.4 前端三大核心技术</h2><h3 id="1-4-1-HTML"><a href="#1-4-1-HTML" class="headerlink" title="1.4.1 HTML"></a>1.4.1 HTML</h3><p>HTML（HyperText Markup Language）超文本标记语言，它不同于一般的编程语言。超文本即超出纯文本的范畴，例如：描述文本颜色、大小、字体等信息，或使用图片、音频、视频等非文本内容。</p>
<p>HTML由一个个的标签（标记）组成，这些标签各司其职，有的提供网页信息，有的负责文字，有的负责图片，有的负责网页布局，所以一个HTML文件，是由格式标签和数据组成。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>马哥教育欢迎您<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>超文本需要显示，就得有软件能够呈现超文本定义的排版格式，例如显示：图片、表格，显示字体的大小、颜色，这个软件就是浏览器。</p>
<p>超文本的诞生是为了解决纯文本不能格式显示的问题，是为了好看，但是只有通过网络才能分享超文本的内容，所以制定了HTTP协议。</p>
<h3 id="1-4-2-CSS（Cascading-Style-Sheets）层叠样式表"><a href="#1-4-2-CSS（Cascading-Style-Sheets）层叠样式表" class="headerlink" title="1.4.2 CSS（Cascading Style Sheets）层叠样式表"></a>1.4.2 CSS（Cascading Style Sheets）层叠样式表</h3><p>HTML本身为了格式化显示文本，但是当网页呈现大家面前的时候，需求HTML提供更多样式能力。这使得HTML变得越来越臃肿。这促使了CSS的诞生。</p>
<p>1994年，W3C成立，CSS设计小组所有成员加入W3C，并努力研发CSS的标准，微软最终加入。</p>
<p>1996年12月发布CSS 1.0。</p>
<p>1998年5月发布CSS 2.0。</p>
<p>CSS 3采用了模块化思想，每个模块都在CSS 2基础上分别增强功能。所以，这些模块是陆续发布的。</p>
<p>不同厂家的浏览器使用的引擎，对CSS的支持不一样，导致网页布局、样式在不同浏览器不一样。因此，想要保证不同用户使用不同浏览器看到的网页效果一直非常困难。</p>
<h3 id="1-4-3-JavaScript"><a href="#1-4-3-JavaScript" class="headerlink" title="1.4.3 JavaScript"></a>1.4.3 JavaScript</h3><p>Javascript 简称JS，是一种动态的弱类型脚本解释性语言，和HTML、CSS并称三大WEB核心技术，得到了几乎主流浏览器支持。</p>
<p>1994年，网景Netscape公司成立并发布了Netscape Navigator浏览器，占据了很大的市场份额，网景意识到WEB需要动态，需要一种技术来实现。</p>
<p>1995年9月网景浏览器2发布测试版本发布了LiveScript，随即在12月的测试版就更名为JavaScript。同时期，微软推出IE并支持JScript、VBScript，与之抗衡。</p>
<p>1997年，网景、微软、SUN、Borland公司和其他组织在ECMA（European Computer Manufacturers Association 欧洲计算机制造商协会）确定了ECMAScript的本程序设计语言的标准。JavaScript和JScript都成为ECMAScript标准的实现。</p>
<p>2008年后随着chrome浏览器的V8引擎发布。</p>
<p>V8 JS引擎不是解释执行，而是本地编译，在V8引擎做了很多优化，JS程序在其上运行堪比本地二进制程序。V8引擎使用C++开发，可以嵌入到任何C++程序中。基于V8引擎，2009年基于服务器javascript的运行环境Node.js诞生，创建了第一版npm (Node.js包管理器和开源库生态系统), 提供了大量的库供程序员使用。从此，便可以在服务器端真正大规模使用JavaScript编程了。也就是说 JavaScript 也可以真正称为服务器端编程语言了，成为目前唯一的前，后端通用的语言。</p>
<p><strong>同步</strong></p>
<p>交互式网页，用户提交了请求，就是想看到查询的结果。服务器响应到来后是一个全新的页面内容，哪怕URL不变，整个网页都需要重新渲染。例如，用户填写注册信息，只是2次密码不一致，提交后，整个注册页面重新刷新，所有填写项目重新填写(当然有办法让用户减少重填)。这种交互非常不友好。从代价的角度看，就是为了注册的一点点信息，结果返回了整个网页内容，不但浪费了网络带宽，还需要浏览器重新渲染网页，太浪费资源了，影响了用户体验和感受。上面这些请求的过程，就是同步过程，用户发起请求，页面整个刷新，直到服务器端响应的数据到来并重新渲染。</p>
<p><strong>异步</strong><br>1996年微软实现了iframe标签，可以在一个网页使用iframe标签局部异步加载内容。</p>
<p>1999年微软推出异步数据传输的ActiveX插件技术，太笨重了，但是也火了很多年。有一个组件XMLHttpRequest被大多数浏览器支持。</p>
<p>传统的网页如果需要更新内容，必需重载整个网页面。Ajax的出现，改变这一切，同时极大的促进了Javascript的发展。Ajax 即”Asynchronous Javascript And XML”（异步 JavaScript 和 XML），是指一种创建交互式、快速动态网页应用的网页开发技术，最早起源于1998年微软的Outlook Web Access开发团队。Ajax 通过在后台与服务器进行少量数据交换， 可以使网页实现异步更新。这意味着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。Javascript 通过调用浏览器内置的WEB API中的XMLHttpRequest 对象实现Ajax 技术。早期Ajax结合数据格式XML，目前更多的使用JSON。利用AJAX可实现前后端开发的彻底分离，改变了传统的开发模式。</p>
<p>AJAX是一种技术的组合，技术的重新发现，而不是发明，但是它深远的影响了整个WEB开发。</p>
<p>参考资料： <a target="_blank" rel="noopener" href="https://www.w3school.com.cn/ajax/index.asp">https://www.w3school.com.cn/ajax/index.asp</a></p>
<h1 id="二、-java-基础"><a href="#二、-java-基础" class="headerlink" title="二、 java 基础"></a>二、 java 基础</h1><h2 id="2-1-开发语言"><a href="#2-1-开发语言" class="headerlink" title="2.1 开发语言"></a>2.1 开发语言</h2><p>语言：人与人交流的沟通表达方式</p>
<p>计算机语言：人与计算机之间交互沟通的语言</p>
<h3 id="2-1-1-语言分类"><a href="#2-1-1-语言分类" class="headerlink" title="2.1.1 语言分类"></a>2.1.1 语言分类</h3><p><strong>按照与自然语言的差异分类</strong></p>
<ul>
<li>低级语言<ul>
<li>机器语言、汇编语言都是面向机器的语言，都是低级语言。不同机器是不能通用的，不同机</li>
<li>器需要不同的机器指令或者汇编程序</li>
</ul>
</li>
<li>高级语言<ul>
<li>接近自然语言和数学语言的计算机语言</li>
</ul>
</li>
</ul>
<h3 id="2-1-2-常见语言"><a href="#2-1-2-常见语言" class="headerlink" title="2.1.2 常见语言"></a>2.1.2 常见语言</h3><ul>
<li>C语言<ul>
<li>面向过程编程，只有函数</li>
<li>操作系统编程、单片机编程等领域</li>
</ul>
</li>
<li>C++语言<ul>
<li>底层高性能开发</li>
<li>面向对象，学习难度极大，目前标准发展有点乱</li>
</ul>
</li>
<li>Java<ul>
<li>Java目前是最流行的编程语言。</li>
<li>WEB开发领域第一，延伸领域极多，库丰富</li>
<li>大数据领域生态完整</li>
</ul>
</li>
<li>Python<ul>
<li>入门门槛低，深入并不容易，非专业程序员容易接受，他们有丰富的专业知识，但计算机专业知识不够</li>
<li>Python简洁的语法，不需要让他们关注背后的细节，可以让他们较容易的掌握并开始编程</li>
<li>运维开发</li>
</ul>
</li>
<li>Javascript<ul>
<li>网景公司发明的动态脚本语言，前端开发第一语言</li>
<li>JavaScript才是目前前后端通吃的全栈语言</li>
<li>前端执行的JS代码，需要从服务器端发送到浏览器端，在浏览器端使用JS引擎执行</li>
</ul>
</li>
<li>Go<ul>
<li>C语言之父Ken Thompson亲自参与设计</li>
<li>静态编译型语言，但结合了动态解释性语言的特点，例如GC</li>
<li>充分利用多核，适合高并发场景</li>
</ul>
</li>
</ul>
<h2 id="2-2-WEB架构"><a href="#2-2-WEB架构" class="headerlink" title="2.2 WEB架构"></a>2.2 WEB架构</h2><h3 id="2-2-1-web资源和访问"><a href="#2-2-1-web资源和访问" class="headerlink" title="2.2.1 web资源和访问"></a>2.2.1 web资源和访问</h3><h4 id="2-2-1-1-WEB资源分类"><a href="#2-2-1-1-WEB资源分类" class="headerlink" title="2.2.1.1 WEB资源分类"></a>2.2.1.1 WEB资源分类</h4><ul>
<li>静态资源<ul>
<li>图片：一旦创建好，图片文件不再改变。图片数目多，占用磁盘空间多，一般使用单独的图片服务器</li>
<li>HTML、CSS、JavaScript：这些文本是文本的，前端工程师可以修改，但修改次数较少，一段时间都不变</li>
</ul>
</li>
<li>动态资源<ul>
<li>内容有后台程序动态生成，比如：查询数据库，将查询结果生成为静态 HTML文件</li>
<li>再将之通过 http 协议响应给客户端</li>
</ul>
</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat6.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-2-1-2-访问web的方式"><a href="#2-2-1-2-访问web的方式" class="headerlink" title="2.2.1.2 访问web的方式"></a>2.2.1.2 访问web的方式</h4><p><strong>PC端或移动端浏览器访问</strong><br>从静态服务器请求HTML、CSS、JS等文件发送到浏览器端，浏览器端接收后渲染在浏览器上从图片服务器请求图片资源显示从业务服务器访问动态内容，动态内容是请求后有后台服务访问数据库后得到的，最终返回到浏览器端</p>
<p><strong>手机 App 访问</strong></p>
<p>内置了HTML和JS文件，不需要从静态WEB服务器下载 JS 或 HTML。为的就是减少文件的发送，现代前端开发使用的JS文件太多或太大了有必要就从图片服务器请求图片，从业务服务器请求动态数据</p>
<p>客户需求多样，更多的内容还是需要由业务服务器提供，业务服务器往往都是由一组服务器组成。</p>
<h3 id="2-2-2-后台应用架构"><a href="#2-2-2-后台应用架构" class="headerlink" title="2.2.2 后台应用架构"></a>2.2.2 后台应用架构</h3><h4 id="2-2-2-1-单体架构"><a href="#2-2-2-1-单体架构" class="headerlink" title="2.2.2.1 单体架构"></a>2.2.2.1 单体架构</h4><ul>
<li><p>传统架构（单机系统），一个项目一个工程：比如商品、订单、支付、库存、登录、注册等等，统一部署，一个进程</p>
</li>
<li><p>Java实现：JSP、Servlet，打包成一个jar、war部署</p>
</li>
<li><p>如果某个功能模块出问题，有可能全站不可访问，修改Bug后、某模块功能升级后，需要重新整体打包，功能模块相互之间耦合度高,相互影响,不适合当今互联网业务功能的快速迭代。项目庞大，管理难度大</p>
</li>
<li><p>web应用服务器：开源的tomcat、jetty、glassfish。商用的有weblogic、websphere、Jboss</p>
<h4 id="2-2-2-2-微服务"><a href="#2-2-2-2-微服务" class="headerlink" title="2.2.2.2 微服务"></a>2.2.2.2 微服务</h4></li>
<li><p>属于SOA（Service Oriented Architecture）的子集</p>
</li>
<li><p>微服务化的核心就是将传统的一站式应用，根据业务拆分成一个一个的服务，彻底去掉耦合，每一个微服务提供单个业务功能，一个服务只做一件事。每个服务都围绕着具体业务进行构建，并且能够被独立地部署到生产环境、类生产环境等</p>
</li>
<li><p>从技术角度讲就是一种小而独立的处理过程，类似与进程的概念，能够自行单独启动或销毁</p>
</li>
<li><p>微服务架构（分布式系统），各个模块/服务，各自独立出来，”让专业的人干专业的事”，独立部署。分布式系统中，不同的服务可以使用各自独立的数据库。</p>
</li>
<li><p>服务之间采用轻量级的通信机制（通常是基于HTTP的RESTful API）。</p>
</li>
<li><p>微服务设计的思想改变了原有的企业研发团队组织架构。传统的研发组织架构是水平架构，前端、后端、DBA、测试分别有自己对应的团队，属于水平团队组织架构。而微服务的设计思想对团队的划分有着一定的影响，使得团队组织架构的划分更倾向于垂直架构，比如用户业务是一个团队来负责，支付业务是一个团队来负责。但实际上在企业中并不会把团队组织架构拆分得这么绝对，垂直架构只是一种理想的架构</p>
</li>
<li><p>微服务的实现框架有多种，不同的应用架构，部署方式也有不同</p>
<h4 id="2-2-2-3-单体架构和微服务比较"><a href="#2-2-2-3-单体架构和微服务比较" class="headerlink" title="2.2.2.3 单体架构和微服务比较"></a>2.2.2.3 单体架构和微服务比较</h4></li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat7.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat8.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-2-2-4-微服务的优缺点"><a href="#2-2-2-4-微服务的优缺点" class="headerlink" title="2.2.2.4 微服务的优缺点"></a>2.2.2.4 微服务的优缺点</h4><ul>
<li>微服务优点：</li>
<li>每个服务足够内聚，足够小，代码容易理解。这样能聚焦一个只当的业务功能或业务需求。开发简单、开发效率提高，一个服务可能就是专业的只干一件事，微服务能够被小团队单独开发，这个小团队可以是2到5人的开发人员组成</li>
<li>微服务是松耦合的，是有功能意义的服务，无论是在开发阶段或部署阶段都是独立的。</li>
<li>微服务能使用不同的语言开发</li>
<li>易于和第三方集成，微服务运行容易且灵活的方式集成自动部署，通过持续集成工具，如:Jenkins、Hudson、Bamboo</li>
<li>微服务易于被一个开发人员理解、修改和维护，这样小团队能够更关注自己的工作成果，无需通过合作才能体现价值</li>
<li>微服务允许你利用融合最新技术。微服务只是业务逻辑的代码，不会和HTML/CSS或其他界面组件混合，即前后端分离</li>
<li>每个微服务都有自己的存储能力，可以有自己的数据库，也可以有统一数据库</li>
</ul>
<p><strong>微服务缺点：</strong></p>
<ul>
<li>微服务把原有的一个项目拆分成多个独立工程，增加了开发、测试、运维、监控等的复杂度</li>
<li>微服务架构需要保证不同服务之间的数据一致性，引入了分布式事务和异步补偿机制，为设计和开发带来一定挑战</li>
<li>开发人员和运维需要处理分布式系统的复杂性，需要更强的技术能力</li>
<li>微服务适用于复杂的大系统，对于小型应用使用微服务，进行盲目的拆分只会增加其维护和开发成本</li>
</ul>
<h4 id="2-2-2-5-常见的微服务框架"><a href="#2-2-2-5-常见的微服务框架" class="headerlink" title="2.2.2.5 常见的微服务框架"></a>2.2.2.5 常见的微服务框架</h4><ul>
<li>Dubbo<ul>
<li>阿里开源贡献给了ASF，目前已经是Apache的顶级项目</li>
<li>一款高性能的Java RPC服务框架，微服务生态体系中的一个重要组件</li>
<li>将单体程序分解成多个功能服务模块，模块间使用Dubbo框架提供的高性能RPC通信</li>
<li>内部协调使用Zookeeper，实现服务注册、服务发现和服务治理</li>
</ul>
</li>
<li>Spring cloud<ul>
<li>一个完整的微服务解决方案，相当于Dubbo的超集</li>
<li>微服务框架，将单体应用拆分为粒度更小的单一功能服务</li>
<li>基于HTTP协议的REST(Representational State Transfer 表述性状态转移）风格实现模块间通信</li>
</ul>
</li>
</ul>
<h2 id="2-3-Java"><a href="#2-3-Java" class="headerlink" title="2.3 Java"></a>2.3 Java</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat9.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-3-1-Java历史"><a href="#2-3-1-Java历史" class="headerlink" title="2.3.1 Java历史"></a>2.3.1 Java历史</h3><p>Java原指的是印度尼西亚的爪哇岛，人口众多，盛产咖啡、橡胶等。</p>
<p>Java语言最早是在1991年开始设计的，最初叫Oak项目，它初衷是跑在不同机顶盒设备中的。</p>
<p>1993年网景公司成立。Oak项目组很快他们发现了浏览器和动态网页技术这个巨大的市场，转向WEB方向。并首先发布了可以让网页动起来的Applet技术（浏览器中嵌入运行Java字节码的技术）。</p>
<p>在1995年，一杯爪哇岛咖啡成就了Java这个名字。</p>
<p>Sun公司第一个Java公开版本1.0发布于1996年。口号是”一次编写，到处运行”(Write once，Runanywhere)，跨平台运行。</p>
<p>1999年，SUN公司发布了第二代Java平台(Java2)。</p>
<p>2009年4月20日，Oracle甲骨文公司宣布将以每股9.50美元，总计74亿美金收购SUN（计算机系统）公司。2010年1月成功收购。</p>
<p>2010年，Java创始人之一的 James Gosling 离开了Oracle，去了Google。</p>
<blockquote>
<p>2010年8月13日，Oracle在加利福尼亚地方法院起诉Google侵犯版权和专利权。Oracle声称Google侵犯了Java 37个API和部分专利。地方法院的陪审团认为未侵犯专利，且API无版权。</p>
<p>2016年5月26日，地方法院二审陪审团认定未侵犯版权，对37个JAVA API的重新实现受到合理使用的保护。</p>
<p>2017年Oracle上诉美国联邦巡回上诉法院，2018年3月27日判决Oracle胜诉，Google应赔偿近90亿美金。</p>
<p>2019年1月Google想让美国最高法院撤销联邦法院裁决。谷歌表示裁决是”对软件业的毁灭性一击”。现任特朗普政府支持Oracle公司，但微软、Mozilla、 红帽支持Google。目前案件已经受理，但由于疫情推迟。有更多的企业和组织加入进来，包括IBM、计算机和通信协会、互联网协会、超过150名学者和教授。</p>
<p>此案如果Oracle胜诉，将在美国形成判例，将深远广泛影响软件业。例如: POSIX接口， 是商用系统UNIX的兼容接口规范。</p>
</blockquote>
<h3 id="2-3-2-java组成"><a href="#2-3-2-java组成" class="headerlink" title="2.3.2 java组成"></a>2.3.2 java组成</h3><p>Java包含下面部分：</p>
<ul>
<li>语言、语法规范。关键字,如: if、for、class等</li>
<li>源代码 source code</li>
<li>依赖库，标准库(基础)、第三方库(针对某些应用)。底层代码太难使用且开发效率低，封装成现成的库</li>
<li>JVM虚拟机。将源代码编译为中间码即字节码后,再运行在JVM之上</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat10.png" srcset="/blog/img/loading.gif"></p>
<p>由于各种操作系统ABI不一样，采用编译方式，需要为不同操作系统编译成相应格式的二进制程序才能运行。</p>
<p>1995年，Java发布Applet技术，Java程序在后台编译成字节码，发送到浏览器端，在浏览器中运行一个Applet程序，这段程序是运行在另外一个JVM进程中的。</p>
<p>但是这种在客户端运行Java代码的技术，会有很大的安全问题。1997年CGI技术发展起来，动态网页技术开始向后端开发转移，在后端将动态内容组织好，拼成HTML发回到浏览器端。</p>
<h3 id="2-3-3-Java动态网页技术"><a href="#2-3-3-Java动态网页技术" class="headerlink" title="2.3.3 Java动态网页技术"></a>2.3.3 Java动态网页技术</h3><h4 id="2-3-3-1-servlet"><a href="#2-3-3-1-servlet" class="headerlink" title="2.3.3.1 servlet"></a>2.3.3.1 servlet</h4><p>本质就是一段Java程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.http.*;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloWorld</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>&#123;<br> <span class="hljs-keyword">private</span> String message;<br> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ServletException</span><br><span class="hljs-function"></span>&#123;<br>   message = <span class="hljs-string">&quot;Hello World&quot;</span>;<br>&#125;<br> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doGet</span><span class="hljs-params">(HttpServletRequest request,</span></span><br><span class="hljs-params"><span class="hljs-function">          HttpServletResponse response)</span></span><br><span class="hljs-function">      <span class="hljs-keyword">throws</span> ServletException, IOException</span><br><span class="hljs-function">     </span>&#123;<br>   response.setContentType(<span class="hljs-string">&quot;text/html&quot;</span>); <span class="hljs-comment">//响应报文内容类型</span><br>   PrintWriter out = response.getWriter();  <span class="hljs-comment">//构建响应报文内容</span><br>   out.println(<span class="hljs-string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="hljs-string">&quot;&lt;/h1&gt;&quot;</span>);<br>   out.println(<span class="hljs-string">&quot;&lt;p&gt;&lt;a href=http://www.magedu.com&gt;马哥教育&lt;/a&gt;欢迎你&lt;/p&gt;&quot;</span>);<br>&#125;<br> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span></span><br><span class="hljs-function"> </span>&#123;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在Servlet中最大的问题是，HTML输出和Java代码混在一起，如果网页布局要调整，Java源代码就需要随之进行调整,对于开发人员来说就是个噩梦。</p>
<h4 id="2-3-3-2-jsp（Java-Server-Pages）"><a href="#2-3-3-2-jsp（Java-Server-Pages）" class="headerlink" title="2.3.3.2 jsp（Java Server Pages）"></a>2.3.3.2 jsp（Java Server Pages）</h4><p>JSP本质是提供一个HTML模板，也就是在网页中预留以后填充的空，后续将Java程序运行生成的数据对HTML进行填空就可以了。如果网页布局需要调整，JAVA源代码不需要很大的调整。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;<br>  pageEncoding=&quot;UTF-8&quot;%&gt;<br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>jsp例子<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>本行后面的内容是服务器端动态生成字符串，最后拼接在一起<br>&lt;%<br>out.println(&quot;你的 IP 地址 &quot; + request.getRemoteAddr());<br>%&gt;<br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>JSP是基于Servlet实现，JSP将表现和逻辑分离，这样页面开发人员更好的注重页面表现力更好服务客户。</p>
<p>不过最终 JSP 还需要先转换为 Servlet的源代码.java文件（Tomcat中使用Jasper转换），只不过这个转换过程无需人工完成,是通过工具自动实现的,然后再编译成.class文件，最后才可以在JVM中运行。<br>比如: 浏览器第一次请求test.jsp时, Tomcat服务器会自动将test.jsp转化成test.jsp.java这么一个类,并将该文件编译成class文件。编译完毕后再运行class文件来响应浏览器的请求。如果以后访问test.jsp就不再重新编译jsp文件了，直接调用class文件来响应浏览器。后续如果Tomcat检测到JSP页面改动了的话，会重新编译</p>
<p>JSP类似于PHP和ASP,前端代码和后端JAVA代码混写在一起,需要前端和后端工程师在一起协作才能完成,无法做到真正的前后端分离开发</p>
<p>在web早期的开发中，通常采用的分为两层，视图层和模型层。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat11.png" srcset="/blog/img/loading.gif"></p>
<p>优点：架构简单，比较适合小型项目开发</p>
<p>缺点：JSP职责不单一，职责过重，不便于维护</p>
<h4 id="2-3-3-3-MVC"><a href="#2-3-3-3-MVC" class="headerlink" title="2.3.3.3 MVC"></a>2.3.3.3 MVC</h4><p>如果过度使用jsp,jsp中既写有大量的java代码，也有html，甚至还有javascript等，造成难以维护，难以实现前后端分工协作，后来java 的web开发借鉴了MVC（Model View Controller ）开发模式，</p>
<p>MVC是模型(Model)、视图(View)、控制器(Controller)的简写，是一种软件设计规范。是将业务逻辑、数据、显示分离的方法来组织代码。MVC主要作用是降低了视图与业务逻辑间的双向偶合。</p>
<p>MVC不是一种设计模式，MVC是一种架构模式。当然不同的MVC存在差异。</p>
<ul>
<li>Model（模型）：数据模型，提供要展示的数据，因此包含数据和行为，可以认为是领域模型或JavaBean组件（包含数据和行为），不过现在一般都分离开来：Value Object（数据Dao） 和 服务层（行为Service）。也就是模型提供了模型数据查询和模型数据的状态更新等功能，包括数据和业务。</li>
<li>View（视图）：负责进行模型的展示，一般就是我们见到的用户界面，客户想看到的东西。可通过JSP实现</li>
<li>Controller（控制器）：接收用户请求，委托给模型进行处理（状态改变），处理完毕后把返回的模型数据返回给视图，由视图负责展示。也就是说控制器做了个调度员的工作。最终表现为Servlet</li>
</ul>
<p>最典型的MVC就是JSP + servlet + javabean的模式。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat12.png" srcset="/blog/img/loading.gif"></p>
<p><strong>职责分析：</strong><br><strong>Controller：控制器</strong></p>
<ul>
<li>取得表单数据</li>
<li>调用业务逻辑</li>
<li>转向指定的页面</li>
</ul>
<p><strong>Model：模型</strong></p>
<ul>
<li>业务逻辑</li>
<li>保存数据的状态</li>
</ul>
<p><strong>View：视图</strong></p>
<ul>
<li>显示页面</li>
</ul>
<p><strong>处理流程</strong></p>
<ol>
<li>用户发请求</li>
<li>Servlet接收请求数据，并调用对应的业务逻辑方法</li>
<li>业务处理完毕，返回更新后的数据给servlet</li>
<li>servlet转向到JSP，由JSP来渲染页面</li>
<li>响应给前端更新后的页面</li>
</ol>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat13.png" srcset="/blog/img/loading.gif"></p>
<p>MVC模式也有以下不足：</p>
<ul>
<li>每次请求必须经过”控制器-&gt;模型-&gt;视图”这个流程，用户才能看到最终的展现界面，这个过程似乎有些复杂</li>
<li>实际上视图是依赖于模型的，换句话说，如果没有模型，视图也无法呈现出最终的效果</li>
<li>渲染视图过程是在服务端来完成的，最终呈现给浏览器的是带有模型的视图页面，性能无法得到很好的优化</li>
</ul>
<h4 id="2-3-3-4-REST"><a href="#2-3-3-4-REST" class="headerlink" title="2.3.3.4 REST"></a>2.3.3.4 REST</h4><p>为了使数据展现过程更加直接，并且提供更好的用户体验，对MVC模式进行改进。首先从浏览器发送AJAX（ Asynchronous JavaScript and XML 异步的 JavaScript 和 XML））请求，然后服务端接受该请求并返回JSON数据返回给浏览器，最后在浏览器中进行界面渲染。改进后的MVC模式如下图所示：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat14.png" srcset="/blog/img/loading.gif"></p>
<p>也就是说，我们输入的是AJAX请求，输出的是JSON数据，REST技术实现这样的功能。</p>
<p>REST全称是Representational State Transfer（表述性状态转移），全称是 Resource Representational State Transfer：通俗来讲就是：资源在网络中以某种表现形式进行状态转移。分解开来：Resource：资源，即数据；Representational：某种表现形式，比如用JSON，XML，JPEG等；State Transfer：状态变化。通过HTTP动词实现</p>
<p>它是Roy Fielding博士在2000年写的一篇关于软件架构风格的论文，后来国内外许多知名互联网公司纷纷开始采用这种轻量级的Web服务，大家习惯将其称为RESTful Web Services，或简称REST服务。</p>
<p>如果将浏览器这一端视为前端，而服务器那一端视为后端的话，可以将以上改进后的MVC模式简化为以下前后端分离模式，如下图所示：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat15.png" srcset="/blog/img/loading.gif"></p>
<p>可见，采用REST风格的架构可以使得前端关注界面展现，后端关注业务逻辑，分工明确，职责清晰。</p>
<p>在设计web接口的时候，REST主要是用于定义接口名，接口名一般是用名次写，不用动词，那怎么表达“获取”或者“删除”或者“更新”这样的操作呢——用请求类型来区分。</p>
<p>比如，我们有一个friends接口，对于“朋友”我们有增删改查四种操作，怎么定义REST接口？</p>
<p>增加一个朋友，uri: generalcode.cn/v1/friends 接口类型：POST</p>
<p>删除一个朋友，uri: generalcode.cn/va/friends 接口类型：DELETE</p>
<p>修改一个朋友，uri: generalcode.cn/va/friends 接口类型：PUT</p>
<p>查找朋友，uri: generalcode.cn/va/friends 接口类型：GET</p>
<p>上面我们定义的四个接口就是符合REST协议的，请注意，这几个接口都没有动词，只有名词friends，都是通过Http请求的接口类型来判断是什么业务操作。</p>
<p>REST就是一种设计API的模式。最常用的数据格式是JSON。由于JSON能直接被JavaScript读取，所以，以JSON格式编写的REST风格的API具有简单、易读、易用的特点。</p>
<p>编写API有什么好处呢？由于API就是把Web App的功能全部封装了，所以，通过API操作数据，可以极大地把前端和后端的代码隔离，使得后端代码易于测试，前端代码编写更简单。离。前端拿到数据只负责展示和渲染，不对数据做任何处理。后端处理数据并以JSON格式传输出去，定义这样一套统一的接口，在web，ios，android三端都可以用相同的接口，通过客户端访问API，就可以完成通过浏览器页面提供的功能，而后端代码基本无需改动。</p>
<h3 id="2-3-4-JDK"><a href="#2-3-4-JDK" class="headerlink" title="2.3.4 JDK"></a>2.3.4 JDK</h3><h4 id="2-3-4-1-JDK和JRE"><a href="#2-3-4-1-JDK和JRE" class="headerlink" title="2.3.4.1 JDK和JRE"></a>2.3.4.1 JDK和JRE</h4><h5 id="2-3-4-1-1-JDK-和-JRE-关系"><a href="#2-3-4-1-1-JDK-和-JRE-关系" class="headerlink" title="2.3.4.1.1 JDK 和 JRE 关系"></a>2.3.4.1.1 JDK 和 JRE 关系</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat16.png" srcset="/blog/img/loading.gif"></p>
<p><strong>Java SE API:</strong> Java 基础类库开发接口</p>
<p><strong>JRE：</strong>Java Runtime Environment缩写，指Java运行时环境， 包含 JVM + Java核心类库</p>
<p><strong>JDK：</strong>Java Development Kit，即 Java 语言的软件开发工具包,JDK协议基于 JRL(JavaResearch License)协议</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat17.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat18.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-3-4-1-2-JVM-的各种版本"><a href="#2-3-4-1-2-JVM-的各种版本" class="headerlink" title="2.3.4.1.2 JVM 的各种版本"></a>2.3.4.1.2 JVM 的各种版本</h5><p>参考链接:</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/List_of_Java_virtual_machines">https://en.wikipedia.org/wiki/List_of_Java_virtual_machines</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Comparison_of_Java_virtual_machines">https://en.wikipedia.org/wiki/Comparison_of_Java_virtual_machines</a></p>
<p>各个公司和组织基于标准规范,开发了不同的JVM版本</p>
<ul>
<li>SUN HotSpot</li>
<li>IBM J9VM</li>
<li>BEA JRockit</li>
</ul>
<p><strong>JVM 市场份额</strong></p>
<p>2018年12月，由 Snyk 和 The Java Magazine 联合推出发布的 2018 JVM 生态调查报告</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat19.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-3-4-2-Oracle-JDK版本"><a href="#2-3-4-2-Oracle-JDK版本" class="headerlink" title="2.3.4.2 Oracle JDK版本"></a>2.3.4.2 Oracle JDK版本</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat20.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat21.png" srcset="/blog/img/loading.gif"></p>
<p>JDK也就是常说的J2SE，在1999年，正式发布了Java第二代平台，发布了三个版本：</p>
<ul>
<li>J2SE：标准版，适用于桌面平台</li>
<li>J2EE：企业版，java在企业级开发所有规范的总和，共有13个大的规范,Servlet、Jsp都包含在 JavaEE规范中</li>
<li>J2ME：微型版，适用于移动、无线、机顶盒等设备环境</li>
</ul>
<p>2005年，Java的版本又更名为JavaSE、JavaEE、JavaME</p>
<p><strong>JDK7、JDK8、JDK11是LTS（Long Term Support）</strong></p>
<p><strong>JDK 历史版本</strong></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_version_history">https://en.wikipedia.org/wiki/Java_version_history</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat22.png" srcset="/blog/img/loading.gif"></p>
<p><strong>JDK 版本名称</strong></p>
<table>
<thead>
<tr>
<th>版本</th>
<th>项目名称</th>
<th>发行日期</th>
</tr>
</thead>
<tbody><tr>
<td>JDK</td>
<td>1.0 Oak(橡树)</td>
<td>1996-01-23</td>
</tr>
<tr>
<td>JDK 1.1</td>
<td></td>
<td>1997-02-19</td>
</tr>
<tr>
<td>JDK</td>
<td>1.1.4 Sparkler（宝石）</td>
<td>1997-09-12</td>
</tr>
<tr>
<td>JDK 1.1.5 Pumpkin</td>
<td>（南瓜）</td>
<td>1997-12-13</td>
</tr>
<tr>
<td>JDK 1.1.6 Abigail</td>
<td>（阿比盖尔–女子名）</td>
<td>1998-04-24</td>
</tr>
<tr>
<td>JDK 1.1.7 Brutus</td>
<td>（布鲁图–古罗马政治家和将军）</td>
<td>1998-09-28</td>
</tr>
<tr>
<td>JDK 1.1.8 Chelsea</td>
<td>（切尔西–城市名）</td>
<td>1999-04-08</td>
</tr>
<tr>
<td>J2SE 1.2 Playground</td>
<td>（运动场）</td>
<td>1998-12-04</td>
</tr>
<tr>
<td>J2SE 1.2.1 none</td>
<td>（无）</td>
<td>1999-03-30</td>
</tr>
<tr>
<td>J2SE 1.2.2 Cricket</td>
<td>（蟋蟀）</td>
<td>1999-07-08</td>
</tr>
<tr>
<td>J2SE 1.3 Kestrel</td>
<td>（美洲红隼）</td>
<td>2000-05-08</td>
</tr>
<tr>
<td>J2SE 1.3.1 Ladybird</td>
<td>（瓢虫）</td>
<td>2001-05-17</td>
</tr>
<tr>
<td>J2SE 1.4.0 Merlin</td>
<td>（灰背隼）</td>
<td>2002-02-13</td>
</tr>
<tr>
<td>J2SE 1.4.1 grasshopper</td>
<td>（蚱蜢）</td>
<td>2002-09-16</td>
</tr>
<tr>
<td>J2SE 1.4.2 Mantis</td>
<td>（螳螂）</td>
<td>2003-06-26</td>
</tr>
<tr>
<td>Java SE 5.0 (1.5.0) Tiger</td>
<td>（老虎）</td>
<td>2004-09-30</td>
</tr>
<tr>
<td>Java SE 6.0 (1.6.0) Mustang</td>
<td>（野马）</td>
<td>2006-12-11</td>
</tr>
<tr>
<td>Java SE 7.0 (1.7.0) Dolphin</td>
<td>（海豚）</td>
<td>2011-07-28</td>
</tr>
<tr>
<td>Java SE 8.0 (1.8.0) Spider</td>
<td>（蜘蛛）</td>
<td>2014-03-18</td>
</tr>
<tr>
<td>Java SE 9</td>
<td></td>
<td>2017-09-21</td>
</tr>
<tr>
<td>Java SE 10</td>
<td></td>
<td>2018-03-14</td>
</tr>
<tr>
<td>Java SE 11</td>
<td></td>
<td>2018-09-25</td>
</tr>
<tr>
<td>Java SE 12</td>
<td></td>
<td>2019-03-19</td>
</tr>
<tr>
<td>Java SE 13</td>
<td></td>
<td>2019-09-17</td>
</tr>
<tr>
<td>Java SE 14</td>
<td></td>
<td>2020-03-17</td>
</tr>
</tbody></table>
<p><strong>时间-事件轴</strong></p>
<blockquote>
<p>1995年5月23日，Java语言诞生<br>1996年1月，第一个JDK-JDK1.0诞生<br>1996年4月，10个最主要的操作系统供应商申明将在其产品中嵌入JAVA技术<br>1996年9月，约8.3万个网页应用了JAVA技术来制作<br>1997年2月18日，JDK1.1发布</p>
<p>1997年4月2日，JavaOne会议召开，参与者逾一万人，创当时全球同类会议规模之纪录<br>1997年9月，JavaDeveloperConnection社区成员超过十万<br>1998年2月，JDK1.1被下载超过2,000,000次<br>1998年12月8日，JAVA2企业平台J2EE发布<br>1999年6月，SUN公司发布Java的三个版本：标准版、企业版和微型版（J2SE、J2EE、J2ME）<br>2000年5月8日，JDK1.3发布<br>2000年5月29日，JDK1.4发布<br>2001年6月5日，NOKIA宣布，到2003年将出售1亿部支持Java的手机<br>2001年9月24日，J2EE1.3发布<br>2002年2月13日，J2SE1.4发布，自此Java的计算能力有了大幅提升。<br>2004年9月30日18:00PM，J2SE1.5发布，是Java语言的发展史上的又一里程碑事件。为了表示这个版本的重要性，J2SE1.5更名为J2SE5.0<br>2005年6月，JavaOne大会召开，SUN公司公开Java SE 6。此时，Java的各种版本已经更名以取消其中的数字”2”：J2EE更名为Java EE, J2SE更名为Java SE，J2ME更名为Java ME。<br>2006年11月13日，SUN公司宣布Java全线采纳GNU General Public License Version 2，从而公开了Java的源代码。</p>
</blockquote>
<p><strong>收费</strong></p>
<p>从2019年1月份开始，Oracle JDK 开始对 Java SE 8 之后的版本开始进行商用收费，确切的说是8u201/202 之后的版本。如果你用 Java 开发的功能如果是用作商业用途的，如果还不想花钱购买的话，能免费使用的最新版本是 8u201/202。当然如果是个人客户端或者个人开发者可以免费试用Oracle JDK 所有的版本。</p>
<p><strong>发版方式</strong></p>
<p>在 JDK 9 发布之前，Oracle 的发版策略是以特性驱动的，只有重大的特性改变才会发布大版本，比如JDK 7 到 JDK 8，中间会发多个更新版本。而从 JDK 9 开始变为以时间驱动的方式。发布周期为6个月一个大版本，比如 JDK 9 到 JDK 10，3个月一次补丁版，3年一个 LTS(长期支持版本)。</p>
<h4 id="2-3-4-3-OpenJDK"><a href="#2-3-4-3-OpenJDK" class="headerlink" title="2.3.4.3 OpenJDK"></a>2.3.4.3 OpenJDK</h4><h5 id="2-3-4-3-1-OpenJDK-介绍"><a href="#2-3-4-3-1-OpenJDK-介绍" class="headerlink" title="2.3.4.3.1 OpenJDK 介绍"></a>2.3.4.3.1 OpenJDK 介绍</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat23.png" srcset="/blog/img/loading.gif"></p>
<p>OpenJDK是Sun公司采用GPL v2协议发布的JDK开源版本，于2009年正式发布。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat24.png" srcset="/blog/img/loading.gif"></p>
<p>官方网站：<a target="_blank" rel="noopener" href="https://openjdk.java.net/projects/jdk6/">https://openjdk.java.net/projects/jdk6/</a></p>
<p>OpenJDK 7是基于JDK7的beta版开发，但为了也将Java SE 6开源，从OpenJDK7的b20构建反向分开发，从中剥离了不符合Java SE 6规范的代码，发布OpenJDK 6。所以OpenJDK6和JDK6没什么关系,只是API兼容而已</p>
<p>OpenJDK使用GPL v2可以用于商业用途。目前由红帽维护。OpenJDK也有在其基础上的众多发行版，比如阿里的Dragonwell。</p>
<p>相对来说,Oracle jDK具有更好的响应能力和JVM性能，更加稳定。</p>
<h5 id="2-3-4-3-2-安装-openjdk"><a href="#2-3-4-3-2-安装-openjdk" class="headerlink" title="2.3.4.3.2 安装 openjdk"></a>2.3.4.3.2 安装 openjdk</h5><ul>
<li>在Centos中，可以使用 yum 仓库安装 openjdk</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum list &quot;*jdk*&quot;</span><br>Loaded plugins: fastestmirror<br>Repodata is over 2 weeks old. Install yum-cron? Or run: yum makecache fast<br>Loading mirror speeds from cached hostfile<br>Available Packages<br>copy-jdk-configs.noarch                                              3.3-10.el7_5                                    base   <br>java-1.6.0-openjdk.x86_64                                            1:1.6.0.41-1.13.13.1.el7_3                      base   <br>java-1.6.0-openjdk-demo.x86_64                                       1:1.6.0.41-1.13.13.1.el7_3                      base   <br>java-1.6.0-openjdk-devel.x86_64                                      1:1.6.0.41-1.13.13.1.el7_3                      base   <br>java-1.6.0-openjdk-javadoc.x86_64                                    1:1.6.0.41-1.13.13.1.el7_3                      base   <br>java-1.6.0-openjdk-src.x86_64                                        1:1.6.0.41-1.13.13.1.el7_3                      base   <br>java-1.7.0-openjdk.x86_64                                            1:1.7.0.261-2.6.22.2.el7_8                      base   <br>java-1.7.0-openjdk-accessibility.x86_64                              1:1.7.0.261-2.6.22.2.el7_8                      base   <br>java-1.7.0-openjdk-demo.x86_64                                       1:1.7.0.261-2.6.22.2.el7_8                      base   <br>java-1.7.0-openjdk-devel.x86_64                                      1:1.7.0.261-2.6.22.2.el7_8                      base   <br>java-1.7.0-openjdk-headless.x86_64                                   1:1.7.0.261-2.6.22.2.el7_8                      base   <br>java-1.7.0-openjdk-javadoc.noarch                                    1:1.7.0.261-2.6.22.2.el7_8                      base   <br>java-1.7.0-openjdk-src.x86_64                                        1:1.7.0.261-2.6.22.2.el7_8                      base   <br>java-1.8.0-openjdk.i686                                              1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk.x86_64                                            1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-accessibility.i686                                1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-accessibility.x86_64                              1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-demo.i686                                         1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-demo.x86_64                                       1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-devel.i686                                        1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-devel.x86_64                                      1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-headless.i686                                     1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-headless.x86_64                                   1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-javadoc.noarch                                    1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-javadoc-zip.noarch                                1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-src.i686                                          1:1.8.0.292.b10-1.el7_9                         updates<br>java-1.8.0-openjdk-src.x86_64                                        1:1.8.0.292.b10-1.el7_9                         updates<br>java-11-openjdk.i686                                                 1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk.x86_64                                               1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-demo.i686                                            1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-demo.x86_64                                          1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-devel.i686                                           1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-devel.x86_64                                         1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-headless.i686                                        1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-headless.x86_64                                      1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-javadoc.i686                                         1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-javadoc.x86_64                                       1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-javadoc-zip.i686                                     1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-javadoc-zip.x86_64                                   1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-jmods.i686                                           1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-jmods.x86_64                                         1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-src.i686                                             1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-src.x86_64                                           1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-static-libs.i686                                     1:11.0.11.0.9-1.el7_9                           updates<br>java-11-openjdk-static-libs.x86_64                                   1:11.0.11.0.9-1.el7_9                           updates<br>java-latest-openjdk.x86_64                                           1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-debug.x86_64                                     1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-demo.x86_64                                      1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-demo-debug.x86_64                                1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-demo-fastdebug.x86_64                            1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-devel.x86_64                                     1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-devel-debug.x86_64                               1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-devel-fastdebug.x86_64                           1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-fastdebug.x86_64                                 1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-headless.x86_64                                  1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-headless-debug.x86_64                            1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-headless-fastdebug.x86_64                        1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-javadoc.x86_64                                   1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-javadoc-zip.x86_64                               1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-jmods.x86_64                                     1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-jmods-debug.x86_64                               1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-jmods-fastdebug.x86_64                           1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-src.x86_64                                       1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-src-debug.x86_64                                 1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-src-fastdebug.x86_64                             1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-static-libs.x86_64                               1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-static-libs-debug.x86_64                         1:16.0.1.0.9-1.rolling.el7                      epel   <br>java-latest-openjdk-static-libs-fastdebug.x86_64                     1:16.0.1.0.9-1.rolling.el7                      epel   <br>ldapjdk.noarch                                                       4.19-5.el7                                      base   <br>ldapjdk-javadoc.noarch                                               4.19-5.el7                                      base<br><br>Last metadata expiration check: 0:00:47 ago on Sun 08 Aug 2021 04:56:56 PM CST.<br>Available Packages<br>copy-jdk-configs.noarch                                         3.7-4.el8                                         AppStream <br>java-1.8.0-openjdk.x86_64                                       1:1.8.0.302.b08-0.el8_4                           AppStream <br>java-1.8.0-openjdk-accessibility.x86_64                         1:1.8.0.302.b08-0.el8_4                           AppStream <br>java-1.8.0-openjdk-accessibility-fastdebug.x86_64               1:1.8.0.302.b08-0.el8_4                           PowerTools<br>java-1.8.0-openjdk-accessibility-slowdebug.x86_64               1:1.8.0.302.b08-0.el8_4                           PowerTools<br>java-1.8.0-openjdk-demo.x86_64                                  1:1.8.0.302.b08-0.el8_4                           AppStream <br>java-1.8.0-openjdk-demo-fastdebug.x86_64                        1:1.8.0.302.b08-0.el8_4                           PowerTools<br>java-1.8.0-openjdk-demo-slowdebug.x86_64                        1:1.8.0.302.b08-0.el8_4                           PowerTools<br>java-1.8.0-openjdk-devel.x86_64                                 1:1.8.0.302.b08-0.el8_4                           AppStream <br>java-1.8.0-openjdk-devel-fastdebug.x86_64                       1:1.8.0.302.b08-0.el8_4                           PowerTools<br>java-1.8.0-openjdk-devel-slowdebug.x86_64                       1:1.8.0.302.b08-0.el8_4                           PowerTools<br>java-1.8.0-openjdk-fastdebug.x86_64                             1:1.8.0.302.b08-0.el8_4                           PowerTools<br>java-1.8.0-openjdk-headless.x86_64                              1:1.8.0.302.b08-0.el8_4                           AppStream <br>java-1.8.0-openjdk-headless-fastdebug.x86_64                    1:1.8.0.302.b08-0.el8_4                           PowerTools<br>java-1.8.0-openjdk-headless-slowdebug.x86_64                    1:1.8.0.302.b08-0.el8_4                           AppStream <br>java-1.8.0-openjdk-javadoc.noarch                               1:1.8.0.302.b08-0.el8_4                           AppStream <br>java-1.8.0-openjdk-javadoc-zip.noarch                           1:1.8.0.302.b08-0.el8_4                           AppStream <br>java-1.8.0-openjdk-slowdebug.x86_64                             1:1.8.0.302.b08-0.el8_4                           AppStream <br>java-1.8.0-openjdk-src.x86_64                                   1:1.8.0.302.b08-0.el8_4                           AppStream <br>java-1.8.0-openjdk-src-fastdebug.x86_64                         1:1.8.0.302.b08-0.el8_4                           PowerTools<br>java-1.8.0-openjdk-src-slowdebug.x86_64                         1:1.8.0.302.b08-0.el8_4                           PowerTools<br>java-11-openjdk.x86_64                                          1:11.0.12.0.7-0.el8_4                             AppStream <br>java-11-openjdk-demo.x86_64                                     1:11.0.12.0.7-0.el8_4                             AppStream <br>java-11-openjdk-demo-fastdebug.x86_64                           1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-demo-slowdebug.x86_64                           1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-devel.x86_64                                    1:11.0.12.0.7-0.el8_4                             AppStream <br>java-11-openjdk-devel-fastdebug.x86_64                          1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-devel-slowdebug.x86_64                          1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-fastdebug.x86_64                                1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-headless.x86_64                                 1:11.0.12.0.7-0.el8_4                             AppStream <br>java-11-openjdk-headless-fastdebug.x86_64                       1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-headless-slowdebug.x86_64                       1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-javadoc.x86_64                                  1:11.0.12.0.7-0.el8_4                             AppStream <br>java-11-openjdk-javadoc-zip.x86_64                              1:11.0.12.0.7-0.el8_4                             AppStream <br>java-11-openjdk-jmods.x86_64                                    1:11.0.12.0.7-0.el8_4                             AppStream <br>java-11-openjdk-jmods-fastdebug.x86_64                          1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-jmods-slowdebug.x86_64                          1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-slowdebug.x86_64                                1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-src.x86_64                                      1:11.0.12.0.7-0.el8_4                             AppStream <br>java-11-openjdk-src-fastdebug.x86_64                            1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-src-slowdebug.x86_64                            1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-static-libs.x86_64                              1:11.0.12.0.7-0.el8_4                             AppStream <br>java-11-openjdk-static-libs-fastdebug.x86_64                    1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-11-openjdk-static-libs-slowdebug.x86_64                    1:11.0.12.0.7-0.el8_4                             PowerTools<br>java-latest-openjdk.x86_64                                      1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-demo.x86_64                                 1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-demo-fastdebug.x86_64                       1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-demo-slowdebug.x86_64                       1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-devel.x86_64                                1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-devel-fastdebug.x86_64                      1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-devel-slowdebug.x86_64                      1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-fastdebug.x86_64                            1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-headless.x86_64                             1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-headless-fastdebug.x86_64                   1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-headless-slowdebug.x86_64                   1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-javadoc.x86_64                              1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-javadoc-zip.x86_64                          1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-jmods.x86_64                                1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-jmods-fastdebug.x86_64                      1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-jmods-slowdebug.x86_64                      1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-slowdebug.x86_64                            1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-src.x86_64                                  1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-src-fastdebug.x86_64                        1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-src-slowdebug.x86_64                        1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-static-libs.x86_64                          1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-static-libs-fastdebug.x86_64                1:16.0.1.0.9-3.rolling.el8                        epel      <br>java-latest-openjdk-static-libs-slowdebug.x86_64                1:16.0.1.0.9-3.rolling.el8                        epel      <br>openjdk-asmtools.noarch                                         7.0.b10-0.2.20210610.gitf40a2c0.el8               epel      <br>openjdk-asmtools-javadoc.noarch                                 7.0.b10-0.2.20210610.gitf40a2c0.el8               epel<br><br>[root@centos8 ~]<span class="hljs-comment"># yum -y install java-1.8.0-openjdk.x86_64 java-1.8.0-openjdk-devel</span><br><br>[root@centos8 ~]<span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;1.8.0_232&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_232-b09)<br>OpenJDK 64-Bit Server VM (build 25.232-b09, mixed mode)<br><br>[root@centos8 ~]<span class="hljs-comment"># which java</span><br>/usr/bin/java<br><br>[root@centos8 ~]<span class="hljs-comment"># ll /usr/bin/java</span><br>lrwxrwxrwx 1 root root 22 Feb  8 20:03 /usr/bin/java -&gt; /etc/alternatives/java<br><br>[root@centos8 ~]<span class="hljs-comment"># ll /etc/alternatives/java</span><br>lrwxrwxrwx 1 root root 73 Feb  8 20:03 /etc/alternatives/java -&gt;<br>/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.232.b09-0.el8_0.x86_64/jre/bin/java<br><br>[root@centos8 ~]<span class="hljs-comment"># rpm -qf /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.232.b09-0.el8_0.x86_64/jre/bin/java</span><br>java-1.8.0-openjdk-headless-1.8.0.232.b09-0.el8_0.x86_64<br></code></pre></td></tr></table></figure>

<p>范例: 安装 java-11-openjdk</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">OpenJDK 64-Bit Server VM 18.9 (build 11.0.7+10-LTS, mixed mode, sharing)<br>[root@centos8 ~]<span class="hljs-comment"># yum -y install java-11-openjdk.x86_64</span><br>[root@centos8 ~]<span class="hljs-comment"># java --version</span><br>openjdk 11.0.7 2020-04-14 LTS<br>OpenJDK Runtime Environment 18.9 (build 11.0.7+10-LTS)<br></code></pre></td></tr></table></figure>

<p>范例: 编译运行java程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install java-1.8.0-openjdk-devel</span><br>[root@centos8 ~]<span class="hljs-comment"># cat Hello.java</span><br>class Hello&#123; <br> public static void main(String[] args)<br> &#123; <br>   System.out.println(<span class="hljs-string">&quot;hello, world&quot;</span>); <br> &#125; <br>&#125; <br><br><span class="hljs-comment">#编译成字节码</span><br>[root@centos8 ~]<span class="hljs-comment"># javac Hello.java</span><br>[root@centos8 ~]<span class="hljs-comment"># ll Hello.*</span><br>-rw-r--r-- 1 root root 416 Oct 24 13:00 Hello.class<br>-rw-r--r-- 1 root root 130 Aug 22 23:38 Hello.java<br><br>[root@centos8 ~]<span class="hljs-comment"># file Hello.class</span><br>Hello.class: compiled Java class data, version 52.0 (Java 1.8)<br><br><span class="hljs-comment">#运行java程序</span><br>[root@centos8 ~]<span class="hljs-comment"># java Hello</span><br>hello, world<br></code></pre></td></tr></table></figure>

<ul>
<li>ubuntu 安装 openjdk</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment"># apt update</span><br>[root@ubuntu1804 ~]<span class="hljs-comment"># apt -y install openjdk-8-jdk</span><br>[root@ubuntu1804 ~]<span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;1.8.0_242&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_242-8u242-b08-0ubuntu3~18.04-b08)<br>OpenJDK 64-Bit Server VM (build 25.242-b08, mixed mode)<br><br>root@ubuntu2004:~<span class="hljs-comment"># apt -y install openjdk-11-jdk</span><br>root@ubuntu2004:~<span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;11.0.9.1&quot;</span> 2020-11-04<br>OpenJDK Runtime Environment (build 11.0.9.1+1-Ubuntu-0ubuntu1.20.04)<br>OpenJDK 64-Bit Server VM (build 11.0.9.1+1-Ubuntu-0ubuntu1.20.04, mixed mode,<br>sharing)<br></code></pre></td></tr></table></figure>

<h4 id="2-3-4-4-安装oracle官方-JDK"><a href="#2-3-4-4-安装oracle官方-JDK" class="headerlink" title="2.3.4.4 安装oracle官方 JDK"></a>2.3.4.4 安装oracle官方 JDK</h4><p>官方下载链接:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">#注意需要注册登录后,才能下载JDK<br>https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat25.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat26.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat27.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-3-4-4-1-Oracle-JDK-的-rpm安装"><a href="#2-3-4-4-1-Oracle-JDK-的-rpm安装" class="headerlink" title="2.3.4.4.1 Oracle JDK 的 rpm安装"></a>2.3.4.4.1 Oracle JDK 的 rpm安装</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#需要登录下载：https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</span><br><br>[root@centos8 ~]<span class="hljs-comment"># ls -lh jdk-8u241-linux-x64.rpm</span><br>-rw-r--r-- 1 root root 171M Feb  8 18:29 jdk-8u241-linux-x64.rpm<br><br><span class="hljs-comment">#安装jdk，无相关依赖包</span><br>[root@centos8 ~]<span class="hljs-comment"># yum -y install jdk-8u241-linux-x64.rpm</span><br>[root@centos8 ~]<span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_241&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_241-b07)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.241-b07, mixed mode)<br><br><span class="hljs-comment">#初始化环境变量</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/profile.d/jdk.sh</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/profile.d/jdk.sh</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/java/default<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-comment">#以下两项非必须项</span><br><span class="hljs-built_in">export</span> JRE_HOME=<span class="hljs-variable">$JAVA_HOME</span>/jre <br><span class="hljs-built_in">export</span> CLASSPATH=<span class="hljs-variable">$JAVA_HOME</span>/lib/:<span class="hljs-variable">$JRE_HOME</span>/lib/<br><br>[root@centos8 ~]<span class="hljs-comment">#. /etc/profile.d/jdk.sh</span><br><span class="hljs-comment">#为什么环境是指向/usr/java/default?</span><br>[root@centos8 ~]<span class="hljs-comment"># ll /usr/java/default</span><br>lrwxrwxrwx 1 root root 16 Aug  8 22:27 /usr/java/default -&gt; /usr/java/latest<br>[root@centos8 ~]<span class="hljs-comment"># ll /usr/java/latest</span><br>lrwxrwxrwx 1 root root 28 Aug  8 22:27 /usr/java/latest -&gt; /usr/java/jdk1.8.0_241-amd64 <span class="hljs-comment">#此文件夹是有java二进制文件的文件夹</span><br>[root@centos8t ~]<span class="hljs-comment"># ll /usr/java/jdk1.8.0_241-amd64/bin/ | grep java</span><br>-rwxr-xr-x 1 root root   8534 Dec 11  2019 java<br>......<br><br><span class="hljs-comment">#查看jdk信息</span><br>[root@centos8 ~]<span class="hljs-comment"># which java</span><br>/usr/bin/java<br>[root@centos8 ~]<span class="hljs-comment"># ll /usr/bin/java</span><br>lrwxrwxrwx 1 root root 22 Feb  8 18:35 /usr/bin/java -&gt; /etc/alternatives/java<br>[root@centos8 ~]<span class="hljs-comment"># ll /etc/alternatives/java</span><br>lrwxrwxrwx 1 root root 41 Feb  8 18:35 /etc/alternatives/java -&gt;<br>/usr/java/jdk1.8.0_241-amd64/jre/bin/java<br><br>[root@centos8 ~]<span class="hljs-comment"># rpm -q --scripts jdk-8u241-linux-x64.rpm</span><br><br><span class="hljs-comment">#查看到安装目录为/user/java下</span><br>[root@centos8 ~]<span class="hljs-comment"># rpm -ql jdk-8u241-linux-x64.rpm |less</span><br>warning: jdk-8u241-linux-x64.rpm: Header V3 RSA/SHA256 Signature, key ID<br>ec551f03: NOKEY<br>/usr<br>/usr/java<br>/usr/java/jdk1.8.0_241-amd64<br>/usr/java/jdk1.8.0_241-amd64/.java<br>/usr/java/jdk1.8.0_241-amd64/.java/.systemPrefs<br>/usr/java/jdk1.8.0_241-amd64/.java/.systemPrefs/.system.lock<br>/usr/java/jdk1.8.0_241-amd64/.java/.systemPrefs/.systemRootModFile<br>/usr/java/jdk1.8.0_241-amd64/.java/init.d<br>......<br><br>[root@centos8 ~]<span class="hljs-comment"># ll /usr/java/</span><br>total 0<br>lrwxrwxrwx 1 root root  16 Feb  8 18:35 default -&gt; /usr/java/latest<br>drwxr-xr-x 8 root root 258 Feb  8 18:35 jdk1.8.0_241-amd64<br>lrwxrwxrwx 1 root root  28 Feb  8 18:35 latest -&gt; /usr/java/jdk1.8.0_241-amd64<br></code></pre></td></tr></table></figure>

<h5 id="2-3-4-4-2-Oracle-JDK的二进制文件安装"><a href="#2-3-4-4-2-Oracle-JDK的二进制文件安装" class="headerlink" title="2.3.4.4.2 Oracle JDK的二进制文件安装"></a>2.3.4.4.2 Oracle JDK的二进制文件安装</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载安装包：https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</span><br>[root@centos8 ~]<span class="hljs-comment"># tar xvf jdk-8u241-linux-x64.tar.gz -C /usr/local/</span><br>[root@centos8 ~]<span class="hljs-comment"># cd /usr/local/</span><br>[root@centos8 ~]<span class="hljs-comment"># ln -s jdk1.8.0_241/ jdk</span><br><br><span class="hljs-comment">#初始化环境变量</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/profile.d/jdk.sh</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/profile.d/jdk.sh</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin<br><span class="hljs-comment">#以下两项非必须项</span><br><span class="hljs-comment">#export JRE_HOME=$JAVA_HOME/jre</span><br><span class="hljs-comment">#export CLASSPATH=$JAVA_HOME/lib/:$JRE_HOME/lib/</span><br><br>[root@centos8 ~]<span class="hljs-comment"># . /etc/profile.d/jdk.sh</span><br><br><span class="hljs-comment">#注意:JAVA_HOME变量必须设置,否则tomcat启动时会出下面错误</span><br>[root@centos8 ~]<span class="hljs-comment"># catalina.sh</span><br>Neither the JAVA_HOME nor the JRE_HOME environment variable is defined<br>At least one of these environment variable is needed to run this program<br>[root@centos8 ~]<span class="hljs-comment"># startup.sh</span><br>Neither the JAVA_HOME nor the JRE_HOME environment variable is defined<br>At least one of these environment variable is needed to run this program<br><br><span class="hljs-comment">#验证安装</span><br>[root@centos8 ~]<span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_241&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_241-b07)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.241-b07, mixed mode)<br>[root@centos8 ~]<span class="hljs-comment"># which java</span><br>/usr/<span class="hljs-built_in">local</span>/jdk/bin/java<br></code></pre></td></tr></table></figure>

<h1 id="三、-Tomcat-基础功能"><a href="#三、-Tomcat-基础功能" class="headerlink" title="三、 Tomcat 基础功能"></a>三、 Tomcat 基础功能</h1><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat28.png" srcset="/blog/img/loading.gif"></p>
<h2 id="3-1-tomcat历史和介绍"><a href="#3-1-tomcat历史和介绍" class="headerlink" title="3.1 tomcat历史和介绍"></a>3.1 tomcat历史和介绍</h2><h3 id="3-1-1-WEB应用服务器"><a href="#3-1-1-WEB应用服务器" class="headerlink" title="3.1.1 WEB应用服务器"></a>3.1.1 WEB应用服务器</h3><ul>
<li>商用：IBM WebSphere、Oracle WebLogic（原属于BEA公司）、Oracle Oc4j、JBoss等</li>
<li>开源：Tomcat、Jetty、Resin、Glassfish</li>
</ul>
<h3 id="3-1-2-Tomcat-介绍"><a href="#3-1-2-Tomcat-介绍" class="headerlink" title="3.1.2 Tomcat 介绍"></a>3.1.2 Tomcat 介绍</h3><p>Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，Tomcat 具有处理HTML页面的功能，它还是一个Servlet和JSP容器</p>
<p>起始于SUN 公司的一个Servlet的参考实现项目 Java Web Server，开发者是 James DuncanDavidson，在1999年，将项目贡献给了apache软件基金会（ASF），和ASF现有的项目 JServ 合并，并开源成为顶级项目</p>
<p>Tomcat 仅仅实现了Java EE规范中与Servlet、JSP相关的类库，是JavaEE不完整实现。</p>
<p>著名图书出版商O’Reilly约稿该项目成员Davidson希望使用一个公猫作为封面，但是公猫已经被使用，书出版后封面是一只雪豹。</p>
<p>《Tomcat权威指南》封面如下</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat29.png" srcset="/blog/img/loading.gif"></p>
<p>1999年发布初始版本是Tomcat 3.0，实现了Servlet 2.2 和 JSP 1.1规范。</p>
<p>Tomcat 4.x发布时，内建了Catalina（Servlet容器）和 Jasper（JSP engine）等</p>
<p>当前 Tomcat 的正式版本已经更新到 9.0.x 版本，但当前企业中主流版本为 8.x 和 7.x</p>
<p>官网： <a target="_blank" rel="noopener" href="http://tomcat.apache.org/">http://tomcat.apache.org/</a></p>
<p>官网文档: <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.5-doc/index.html">https://tomcat.apache.org/tomcat-8.5-doc/index.html</a></p>
<p>帮助文档:</p>
<p><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/tomcat/">https://cwiki.apache.org/confluence/display/tomcat/</a></p>
<p><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/tomcat/FAQ">https://cwiki.apache.org/confluence/display/tomcat/FAQ</a></p>
<h3 id="3-1-3-Tomcat-各版本区别"><a href="#3-1-3-Tomcat-各版本区别" class="headerlink" title="3.1.3 Tomcat 各版本区别"></a>3.1.3 Tomcat 各版本区别</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://tomcat.apache.org/whichversion.html">https://tomcat.apache.org/whichversion.html</a></p>
<table>
<thead>
<tr>
<th>Servlet Spec</th>
<th>JSP Spec</th>
<th>EL Spec</th>
<th>WebSocket Spec</th>
<th>Authentication (JASIC) Spec</th>
<th>Apache   Tomcat   Version</th>
<th>Latest      Released    Version</th>
<th>Supported Java  Versions</th>
</tr>
</thead>
<tbody><tr>
<td>5.0</td>
<td>3.0</td>
<td>4.0</td>
<td>2.0</td>
<td>2.0</td>
<td>10.0.x</td>
<td>10.0.0-M1</td>
<td>8 and later</td>
</tr>
<tr>
<td>4.0</td>
<td>2.3</td>
<td>3.0</td>
<td>1.1</td>
<td>1.1</td>
<td>9.0x</td>
<td>9.0.31</td>
<td>8 and later</td>
</tr>
<tr>
<td>3.1</td>
<td>2.3</td>
<td>3.0</td>
<td>1.1</td>
<td>1.1</td>
<td>8.5x</td>
<td>8.5.51</td>
<td>7 and later</td>
</tr>
<tr>
<td>3.1</td>
<td>2.3</td>
<td>3.0</td>
<td>1.1</td>
<td>N/A</td>
<td>8.0x (superseded)</td>
<td>8.0.53 (superseded)</td>
<td>7 and later</td>
</tr>
<tr>
<td>3.0</td>
<td>2.2</td>
<td>2.2</td>
<td>1.1</td>
<td>N/A</td>
<td>7.0.x</td>
<td>7.0.100</td>
<td>6 and later (7 and later forWebSocket)</td>
</tr>
<tr>
<td>2.5</td>
<td>2.1</td>
<td>2.1</td>
<td>N/A</td>
<td>N/A</td>
<td>6.0.x (archived)</td>
<td>6.0.53 (archived)</td>
<td>5 and later</td>
</tr>
<tr>
<td>2.4</td>
<td>2.0</td>
<td>N/A</td>
<td>N/A</td>
<td>N/A</td>
<td>5.5.x (archived)</td>
<td>5.5.36 (archived)</td>
<td>1.4 and later</td>
</tr>
<tr>
<td>2.3</td>
<td>1.2</td>
<td>N/A</td>
<td>N/A</td>
<td>N/A</td>
<td>4.1.x (archived)</td>
<td>4.1.40 (archived)</td>
<td>1.3 and later</td>
</tr>
<tr>
<td>2.2</td>
<td>1.1</td>
<td>N/A</td>
<td>N/A</td>
<td>N/A</td>
<td>3.3.x (archived)</td>
<td>3.3.2 (archived)</td>
<td>1.1 and later</td>
</tr>
</tbody></table>
<h2 id="3-2-安装tomcat"><a href="#3-2-安装tomcat" class="headerlink" title="3.2 安装tomcat"></a>3.2 安装tomcat</h2><h3 id="3-2-1-基于包安装"><a href="#3-2-1-基于包安装" class="headerlink" title="3.2.1 基于包安装"></a>3.2.1 基于包安装</h3><p>CentOS 8 包仓库中目前还没有提供tomcat相关包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum list tomcat</span><br>Last metadata expiration check: 1:25:35 ago on Wed 15 Jul 2020 09:01:28 AM CST.<br>Error: No matching Packages to list<br></code></pre></td></tr></table></figure>

<p>CentOS 7 yum仓库源中自带的Tomcat 7.0版本安装，此方式安装tomcat版本较低，不推荐</p>
<p><strong>范例：在CentOS 7 上安装 tomcat</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum list tomcat*</span><br>Loaded plugins: fastestmirror<br>Loading mirror speeds from cached hostfile<br>Available Packages<br>tomcat.noarch                                                    7.0.76-16.el7_9                                     updates<br>tomcat-admin-webapps.noarch                                      7.0.76-16.el7_9                                     updates<br>tomcat-docs-webapp.noarch                                        7.0.76-16.el7_9                                     updates<br>tomcat-el-2.2-api.noarch                                         7.0.76-16.el7_9                                     updates<br>tomcat-javadoc.noarch                                            7.0.76-16.el7_9                                     updates<br>tomcat-jsp-2.2-api.noarch                                        7.0.76-16.el7_9                                     updates<br>tomcat-jsvc.noarch                                               7.0.76-16.el7_9                                     updates<br>tomcat-lib.noarch                                                7.0.76-16.el7_9                                     updates<br>tomcat-native.x86_64                                             1.2.23-1.el7                                        epel   <br>tomcat-servlet-3.0-api.noarch                                    7.0.76-16.el7_9                                     updates<br>tomcat-webapps.noarch                                            7.0.76-16.el7_9                                     updates<br>tomcatjss.noarch                                                 7.2.5-1.el7                                         base<br><br>[root@centos7 ~]<span class="hljs-comment"># yum -y install tomcat tomcat-webapps tomcat-admin-webapps tomcat-docs-webapp</span><br>[root@centos7 ~]<span class="hljs-comment"># systemctl enable --now tomcat</span><br>Created symlink from /etc/systemd/system/multi-user.target.wants/tomcat.service<br>to /usr/lib/systemd/system/tomcat.service.<br><br>[root@centos7 ~]<span class="hljs-comment"># ss -ntl</span><br>State      Recv-Q Send-Q                 Local Address:Port                                Peer Address:Port              <br>LISTEN     0      128                                *:22                                             *:*                  <br>LISTEN     0      100                               :::8080                                          :::*                  <br>LISTEN     0      128                               :::22                                            :::*                  <br>LISTEN     0      1                   ::ffff:127.0.0.1:8005                                          :::*                  <br>LISTEN     0      100                               :::8009                                          :::*<br>  <br>[root@centos7 ~]<span class="hljs-comment"># getent passwd tomcat</span><br>tomcat:x:53:53:Apache Tomcat:/usr/share/tomcat:/sbin/nologin<br>[root@centos7 ~]<span class="hljs-comment"># ps aux|grep tomcat</span><br>tomcat      933  7.5  8.9 2295060 89812 ?       Ssl  23:18   0:03 /usr/lib/jvm/jre/bin/java -Djavax.sql.DataSource.Factory=org.apache.commons.dbcp.BasicDataSourceFactory -classpath /usr/share/tomcat/bin/bootstrap.jar:/usr/share/tomcat/bin/tomcat-juli.jar:/usr/share/java/commons-daemon.jar -Dcatalina.base=/usr/share/tomcat -Dcatalina.home=/usr/share/tomcat -Djava.endorsed.dirs= -Djava.io.tmpdir=/var/cache/tomcat/temp -Djava.util.logging.config.file=/usr/share/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager org.apache.catalina.startup.Bootstrap start<br>root        996  0.0  0.0 112660   968 pts/0    R+   23:19   0:00 grep --color=auto tomcat<br></code></pre></td></tr></table></figure>

<p>打开浏览器访问：<a target="_blank" rel="noopener" href="http://tomcat:8080/">http://tomcat:8080/</a> 或本机ip:8080</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat30.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-2-2-二进制安装"><a href="#3-2-2-二进制安装" class="headerlink" title="3.2.2 二进制安装"></a>3.2.2 二进制安装</h3><p>CentOS7 的yum源的tomcat版本老旧,而CentOS8 yum源里无tomcat</p>
<p>目前比较主流的Tomcat是8.5.X版本,推荐从Apache官网下载二进制tomcat包进行安装,此为生产常用方式</p>
<h4 id="3-2-2-1-下载并安装"><a href="#3-2-2-1-下载并安装" class="headerlink" title="3.2.2.1 下载并安装"></a>3.2.2.1 下载并安装</h4><p><strong>注意: 安装tomcat 前必须先部署JDK</strong></p>
<p>官方和镜像站点下载:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">https://tomcat.apache.org/download-80.cgi<br>https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat31.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#官网或镜像网站下载：</span><br>[root@centos8 ~]<span class="hljs-comment"># wget https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.50/bin/apache-tomcat-8.5.50.tar.gz</span><br>[root@centos8 ~]<span class="hljs-comment"># tar xf apache-tomcat-8.5.50.tar.gz -C /usr/local/</span><br>[root@centos8 ~]<span class="hljs-comment"># cd /usr/local/</span><br>[root@centos8 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># ln -s apache-tomcat-8.5.50/ tomcat</span><br><br><span class="hljs-comment">#指定PATH变量</span><br>[root@centos8 ~]<span class="hljs-comment"># echo &#x27;PATH=/usr/local/tomcat/bin:$PATH&#x27; &gt; /etc/profile.d/tomcat.sh</span><br>[root@centos8 ~]<span class="hljs-comment"># . /etc/profile.d/tomcat.sh</span><br>[root@centos8 ~]<span class="hljs-comment"># echo $PATH</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/bin:/usr/<span class="hljs-built_in">local</span>/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/usr/sbin:/usr/bin:/usr/<span class="hljs-built_in">local</span>/jdk/bin:/root/bin<br><br><span class="hljs-comment">#查看当前变量设置和命令用法</span><br>[root@centos8 ~]<span class="hljs-comment"># catalina.sh</span><br>Using CATALINA_BASE:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_HOME:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_TMPDIR: /usr/<span class="hljs-built_in">local</span>/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /usr/<span class="hljs-built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="hljs-built_in">local</span>/tomcat/bin/tomcat-juli.jar<br>Usage: catalina.sh ( commands ... )<br>commands:<br>  debug             Start Catalina <span class="hljs-keyword">in</span> a debugger<br>  debug -security   Debug Catalina with a security manager<br>  jpda start        Start Catalina under JPDA debugger<br>  run               Start Catalina <span class="hljs-keyword">in</span> the current window<br>  run -security     Start <span class="hljs-keyword">in</span> the current window with security manager<br>  start             Start Catalina <span class="hljs-keyword">in</span> a separate window<br>  start -security   Start <span class="hljs-keyword">in</span> a separate window with security manager<br>  stop              Stop Catalina, waiting up to 5 seconds <span class="hljs-keyword">for</span> the process to end<br>  stop n            Stop Catalina, waiting up to n seconds <span class="hljs-keyword">for</span> the process to end<br>  stop -force       Stop Catalina, <span class="hljs-built_in">wait</span> up to 5 seconds and <span class="hljs-keyword">then</span> use <span class="hljs-built_in">kill</span> -KILL <span class="hljs-keyword">if</span> still running<br>  stop n -force     Stop Catalina, <span class="hljs-built_in">wait</span> up to n seconds and <span class="hljs-keyword">then</span> use <span class="hljs-built_in">kill</span> -KILL <span class="hljs-keyword">if</span> still running<br>  configtest        Run a basic syntax check on server.xml - check <span class="hljs-built_in">exit</span> code <span class="hljs-keyword">for</span> result<br>  version           What version of tomcat are you running?<br>Note: Waiting <span class="hljs-keyword">for</span> the process to end and use of the -force option require that <span class="hljs-variable">$CATALINA_PID</span> is defined<br><br><span class="hljs-comment">#查看环境变量和版本信息</span><br>[root@centos8 ~]<span class="hljs-comment"># catalina.sh version</span><br>Using CATALINA_BASE:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_HOME:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_TMPDIR: /usr/<span class="hljs-built_in">local</span>/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /usr/<span class="hljs-built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="hljs-built_in">local</span>/tomcat/bin/tomcat-juli.jar<br>Server version: Apache Tomcat/8.5.50<br>Server built:   Dec 7 2019 19:19:46 UTC<br>Server number:  8.5.50.0<br>OS Name:        Linux<br>OS Version:     4.18.0-240.el8.x86_64<br>Architecture:   amd64<br>JVM Version:    1.8.0_241-b07<br>JVM Vendor:     Oracle Corporation<br><br><span class="hljs-comment">#启动tomcat</span><br>[root@centos8 ~]<span class="hljs-comment"># startup.sh</span><br>Using CATALINA_BASE:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_HOME:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_TMPDIR: /usr/<span class="hljs-built_in">local</span>/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /usr/<span class="hljs-built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="hljs-built_in">local</span>/tomcat/bin/tomcat-juli.jar<br>Tomcat started.<br><br><span class="hljs-comment">#查看端口，8080端口</span><br>[root@centos8 ~]<span class="hljs-comment"># ss -ntl</span><br>State          Recv-Q          Send-Q                        Local Address:Port                   Peer Address:Port         <br>LISTEN         0               128                                 0.0.0.0:22                          0.0.0.0:*            <br>LISTEN         0               5                                 127.0.0.1:631                         0.0.0.0:*            <br>LISTEN         0               128                                 0.0.0.0:111                         0.0.0.0:*            <br>LISTEN         0               128                                    [::]:22                             [::]:*            <br>LISTEN         0               5                                     [::1]:631                            [::]:*            <br>LISTEN         0               1                        [::ffff:127.0.0.1]:8005                              *:*            <br>LISTEN         0               100                                       *:8009                              *:*            <br>LISTEN         0               128                                    [::]:111                            [::]:*            <br>LISTEN         0               100                                       *:8080                              *:*<br><br><span class="hljs-comment">#查看进程是以root启动的</span><br>[root@centos8 ~]<span class="hljs-comment"># ps aux|grep tomcat</span><br>root       31738  3.4  8.0 2205052 77476 pts/0   Sl   09:27   0:01 /usr/<span class="hljs-built_in">local</span>/jdk/bin/java -Djava.util.logging.config.file=/usr/<span class="hljs-built_in">local</span>/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/<span class="hljs-built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="hljs-built_in">local</span>/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/<span class="hljs-built_in">local</span>/tomcat -Dcatalina.home=/usr/<span class="hljs-built_in">local</span>/tomcat -Djava.io.tmpdir=/usr/<span class="hljs-built_in">local</span>/tomcat/temp org.apache.catalina.startup.Bootstrap start<br>root       31795  0.0  0.1  12112  1080 pts/0    S+   09:28   0:00 grep --color=auto tomcat<br><br><span class="hljs-comment">#关闭tomcat</span><br>[root@centos8 ~]<span class="hljs-comment"># shutdown.sh</span><br>Using CATALINA_BASE:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_HOME:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_TMPDIR: /usr/<span class="hljs-built_in">local</span>/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /usr/<span class="hljs-built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="hljs-built_in">local</span>/tomcat/bin/tomcat-juli.jar<br><span class="hljs-comment">#或者以下也可以,指定10s后停止,默认5s</span><br>[root@centos8 ~]<span class="hljs-comment"># catalina.sh stop 10</span><br><br>[root@centos8 ~]<span class="hljs-comment"># ps aux|grep tomcat</span><br>root       31836  0.0  0.1  12112  1076 pts/0    R+   09:31   0:00 grep --color=auto tomcat<br>[root@centos8 ~]<span class="hljs-comment"># ss -tnl</span><br>State           Recv-Q          Send-Q                    Local Address:Port                     Peer Address:Port          <br>LISTEN          0               128                             0.0.0.0:22                            0.0.0.0:*             <br>LISTEN          0               5                             127.0.0.1:631                           0.0.0.0:*             <br>LISTEN          0               128                             0.0.0.0:111                           0.0.0.0:*             <br>LISTEN          0               128                                [::]:22                               [::]:*             <br>LISTEN          0               5                                 [::1]:631                              [::]:*             <br>LISTEN          0               128                                [::]:111                              [::]:*<br><br><span class="hljs-comment">#再次用不同方式启动tomcat</span><br>[root@centos8 ~]<span class="hljs-comment"># catalina.sh start</span><br>Using CATALINA_BASE:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_HOME:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_TMPDIR: /usr/<span class="hljs-built_in">local</span>/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /usr/<span class="hljs-built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="hljs-built_in">local</span>/tomcat/bin/tomcat-juli.jar<br>Tomcat started.<br>[root@centos8 ~]<span class="hljs-comment"># ss -ntl</span><br>State          Recv-Q          Send-Q                        Local Address:Port                   Peer Address:Port         <br>LISTEN         0               128                                 0.0.0.0:22                          0.0.0.0:*            <br>LISTEN         0               5                                 127.0.0.1:631                         0.0.0.0:*            <br>LISTEN         0               128                                 0.0.0.0:111                         0.0.0.0:*            <br>LISTEN         0               128                                    [::]:22                             [::]:*            <br>LISTEN         0               5                                     [::1]:631                            [::]:*            <br>LISTEN         0               1                        [::ffff:127.0.0.1]:8005                              *:*            <br>LISTEN         0               100                                       *:8009                              *:*            <br>LISTEN         0               128                                    [::]:111                            [::]:*            <br>LISTEN         0               100                                       *:8080                              *:*   <br><br><span class="hljs-comment">#再次用不同方式关闭tomcat</span><br>[root@centos8 ~]<span class="hljs-comment"># catalina.sh stop</span><br>Using CATALINA_BASE:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_HOME:   /usr/<span class="hljs-built_in">local</span>/tomcat<br>Using CATALINA_TMPDIR: /usr/<span class="hljs-built_in">local</span>/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk<br>Using CLASSPATH:       /usr/<span class="hljs-built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="hljs-built_in">local</span>/tomcat/bin/tomcat-juli.jar<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat32.png" srcset="/blog/img/loading.gif"></p>
<p><strong>扩展知识：tomcat 和 catalina 关系</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">Tomcat的servlet容器在4.X版本中被Craig McClanahan(Apache Struts项目的创始人,也是Tomcat的Catalina的架构师)重新设计为Catalina.即Catalina就是servlet容器。<br><br>Tomcat的核心分为3个部分:<br>（1）Web容器:处理静态页面；<br>（2）JSP容器:把jsp页面翻译成一般的 servlet<br>（3）catalina: 是一个servlet容器,用于处理servlet<br><br>Catalina是美国西海岸靠近洛杉矶22英里的一个小岛，因为其风景秀丽而著名，曾被评为全美最漂亮的小岛。Servlet运行模块的最早开发者Craig McClanahan因为喜欢Catalina岛,故以Catalina命名他所开这个模块，另外在开发的早期阶段，Tomcat是被搭建在一个叫Avalon的服务器框架上，而Avalon则是Catalina岛上的一个小镇的名字，于是想一个与小镇名字相关联的单词也是自然而然。设计者估计是想把tomcat设计成最美的轻量级容器吧。下图为该小岛。<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat33.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-2-2-2-配置-tomcat自启动的-service-文件"><a href="#3-2-2-2-配置-tomcat自启动的-service-文件" class="headerlink" title="3.2.2.2 配置 tomcat自启动的 service 文件"></a>3.2.2.2 配置 tomcat自启动的 service 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建tomcat专用帐户</span><br>[root@centos8 ~]<span class="hljs-comment"># useradd -r -s /sbin/nologin tomcat</span><br><br><span class="hljs-comment">#准备service文件中相关环境文件</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /usr/local/tomcat/conf/tomcat.conf</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /usr/local/tomcat/conf/tomcat.conf</span><br><span class="hljs-comment">#两个变量至少设置一项才能启动 tomcat</span><br>JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-comment">#JRE_HOME=/usr/local/jdk/jre</span><br><br>[root@centos8 ~]<span class="hljs-comment"># chown -R tomcat.tomcat /usr/local/tomcat/</span><br><br><span class="hljs-comment">#创建tomcat.service文件</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /lib/systemd/system/tomcat.service</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /lib/systemd/system/tomcat.service</span><br>[Unit]<br>Description=Tomcat<br><span class="hljs-comment">#After=syslog.target network.target remote-fs.target nss-lookup.target</span><br>After=syslog.target network.target<br><br>[Service]<br>Type=forking<br>EnvironmentFile=/usr/<span class="hljs-built_in">local</span>/tomcat/conf/tomcat.conf<br>ExecStart=/usr/<span class="hljs-built_in">local</span>/tomcat/bin/startup.sh<br>ExecStop=/usr/<span class="hljs-built_in">local</span>/tomcat/bin/shutdown.sh<br>PrivateTmp=<span class="hljs-literal">true</span><br>User=tomcat<br>Group=tomcat<br><br>[Install]<br>WantedBy=multi-user.target<br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl daemon-reload</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable --now tomcat #启动tomcat可能需要一点时间</span><br>Created symlink /etc/systemd/system/multi-user.target.wants/tomcat.service →<br>/usr/lib/systemd/system/tomcat.service.<br>[root@centos8 ~]<span class="hljs-comment"># systemctl status tomcat</span><br>● tomcat.service - Tomcat<br> Loaded: loaded (/usr/lib/systemd/system/tomcat.service; enabled; vendor<br>preset: disabled)<br> Active: active (running) since Sat 2020-02-08 23:37:02 CST; 5s ago<br>Process: 14312 ExecStart=/usr/<span class="hljs-built_in">local</span>/tomcat/bin/startup.sh (code=exited,<br>status=0/SUCCESS)<br>Main PID: 14320 (java)<br> Tasks: 43 (<span class="hljs-built_in">limit</span>: 4895)<br> Memory: 64.2M<br> CGroup: /system.slice/tomcat.service<br>     └─14320 /usr/<span class="hljs-built_in">local</span>/jdk/jre/bin/java -<br>Djava.util.logging.config.file=/usr/<span class="hljs-built_in">local</span>/tomcat/conf/logging&gt;<br><br>Feb 08 23:37:02 centos8.localdomain systemd[1]: Starting Tomcat...<br>Feb 08 23:37:02 centos8.localdomain systemd[1]: Started Tomcat.<br></code></pre></td></tr></table></figure>

<h3 id="3-2-3-实战案例：-一键安装tomcat脚本"><a href="#3-2-3-实战案例：-一键安装tomcat脚本" class="headerlink" title="3.2.3 实战案例： 一键安装tomcat脚本"></a>3.2.3 实战案例： 一键安装tomcat脚本</h3><p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># vim install_tomcat_for_centos.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#********************************************************************</span><br>. /etc/init.d/<span class="hljs-built_in">functions</span><br>DIR=`<span class="hljs-built_in">pwd</span>`<br>JDK_FILE=<span class="hljs-string">&quot;jdk-8u241-linux-x64.tar.gz&quot;</span><br>TOMCAT_FILE=<span class="hljs-string">&quot;apache-tomcat-8.5.50.tar.gz&quot;</span><br>JDK_DIR=<span class="hljs-string">&quot;/usr/local/&quot;</span><br>TOMCAT_DIR=<span class="hljs-string">&quot;/usr/local/&quot;</span><br><span class="hljs-function"><span class="hljs-title">install_jdk</span></span>()&#123;<br><span class="hljs-keyword">if</span> ! [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$DIR</span>/<span class="hljs-variable">$JDK_FILE</span>&quot;</span> ];<span class="hljs-keyword">then</span><br>	action <span class="hljs-string">&quot;<span class="hljs-variable">$JDK_FILE</span> 文件不存在&quot;</span> <span class="hljs-literal">false</span><br>	<span class="hljs-built_in">exit</span>;<br><span class="hljs-keyword">elif</span> [ -d <span class="hljs-variable">$JDK_DIR</span>/jdk ];<span class="hljs-keyword">then</span><br>	action <span class="hljs-string">&quot;JDK 已经安装&quot;</span> <span class="hljs-literal">false</span><br>	<span class="hljs-built_in">exit</span>;<br><span class="hljs-keyword">else</span><br>	[ -d <span class="hljs-string">&quot;<span class="hljs-variable">$JDK_DIR</span>&quot;</span> ] || mkdir -pv <span class="hljs-variable">$JDK_DIR</span><br><span class="hljs-keyword">fi</span><br><br>tar xf <span class="hljs-variable">$DIR</span>/<span class="hljs-variable">$JDK_FILE</span> -C <span class="hljs-variable">$JDK_DIR</span><br><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$JDK_DIR</span> &amp;&amp; ln -s jdk1.8.* jdk<br><br>cat &gt; /etc/profile.d/jdk.sh &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">export JAVA_HOME=$JDK_DIR/jdk</span><br><span class="hljs-string">export JRE_HOME=\$JAVA_HOME/jre</span><br><span class="hljs-string">export CLASSPATH=\$JAVA_HOME/lib/:\$JRE_HOME/lib/</span><br><span class="hljs-string">export PATH=\$PATH:\$JAVA_HOME/bin</span><br><span class="hljs-string">EOF</span><br>. /etc/profile.d/jdk.sh<br>java -version &amp;&amp; action <span class="hljs-string">&quot;JDK 安装完成&quot;</span> || &#123; action <span class="hljs-string">&quot;JDK 安装失败&quot;</span> <span class="hljs-literal">false</span> ; <span class="hljs-built_in">exit</span>; &#125;<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">install_tomcat</span></span>()&#123;<br><span class="hljs-keyword">if</span> ! [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$DIR</span>/<span class="hljs-variable">$TOMCAT_FILE</span>&quot;</span> ];<span class="hljs-keyword">then</span><br>	 action <span class="hljs-string">&quot;<span class="hljs-variable">$TOMCAT_FILE</span> 文件不存在&quot;</span> <span class="hljs-literal">false</span><br><span class="hljs-built_in">exit</span>;<br><span class="hljs-keyword">elif</span> [ -d <span class="hljs-variable">$TOMCAT_DIR</span>/tomcat ];<span class="hljs-keyword">then</span><br>	 action <span class="hljs-string">&quot;TOMCAT 已经安装&quot;</span> <span class="hljs-literal">false</span><br><span class="hljs-built_in">exit</span><br><span class="hljs-keyword">else</span><br>	[ -d <span class="hljs-string">&quot;<span class="hljs-variable">$TOMCAT_DIR</span>&quot;</span> ] || mkdir -pv <span class="hljs-variable">$TOMCAT_DIR</span><br><span class="hljs-keyword">fi</span><br><br>tar xf <span class="hljs-variable">$DIR</span>/<span class="hljs-variable">$TOMCAT_FILE</span> -C <span class="hljs-variable">$TOMCAT_DIR</span><br><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$TOMCAT_DIR</span> &amp;&amp; ln -s apache-tomcat-*/ tomcat<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;PATH=<span class="hljs-variable">$TOMCAT_DIR</span>/tomcat/bin:&quot;</span><span class="hljs-string">&#x27;$PATH&#x27;</span> &gt; /etc/profile.d/tomcat.sh<br><br>id tomcat &amp;&gt; /dev/null || useradd -r -s /sbin/nologin tomcat<br><br>cat &gt; <span class="hljs-variable">$TOMCAT_DIR</span>/tomcat/conf/tomcat.conf &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">JAVA_HOME=$JDK_DIR/jdk</span><br><span class="hljs-string">EOF</span><br><br>chown -R tomcat.tomcat <span class="hljs-variable">$TOMCAT_DIR</span>/tomcat/<br><br>cat &gt; /lib/systemd/system/tomcat.service &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description=Tomcat</span><br><span class="hljs-string">#After=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class="hljs-string">After=syslog.target network.target</span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">Type=forking</span><br><span class="hljs-string">EnvironmentFile=$TOMCAT_DIR/tomcat/conf/tomcat.conf</span><br><span class="hljs-string">ExecStart=$TOMCAT_DIR/tomcat/bin/startup.sh</span><br><span class="hljs-string">ExecStop=$TOMCAT_DIR/tomcat/bin/shutdown.sh</span><br><span class="hljs-string">RestartSec=3</span><br><span class="hljs-string">PrivateTmp=true</span><br><span class="hljs-string">User=tomcat</span><br><span class="hljs-string">Group=tomcat</span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br><br>systemctl daemon-reload<br><br>systemctl <span class="hljs-built_in">enable</span> --now tomcat.service<br><br>systemctl is-active tomcat.service &amp;&gt; /dev/null &amp;&amp; action <span class="hljs-string">&quot;TOMCAT 安装完成&quot;</span> || &#123; action <span class="hljs-string">&quot;TOMCAT 安装失败&quot;</span> <span class="hljs-literal">false</span> ; <span class="hljs-built_in">exit</span>; &#125;<br><br>&#125;<br><br>install_jdk<br><br>install_tomcat<br><br></code></pre></td></tr></table></figure>

<h2 id="3-3-tomcat的文件结构和组成"><a href="#3-3-tomcat的文件结构和组成" class="headerlink" title="3.3 tomcat的文件结构和组成"></a>3.3 tomcat的文件结构和组成</h2><h3 id="3-3-1-目录结构"><a href="#3-3-1-目录结构" class="headerlink" title="3.3.1 目录结构"></a>3.3.1 目录结构</h3><table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>bin</td>
<td>服务启动、停止等相关程序和文件</td>
</tr>
<tr>
<td>conf</td>
<td>配置文件</td>
</tr>
<tr>
<td>lib</td>
<td>库目录</td>
</tr>
<tr>
<td>logs</td>
<td>日志目录</td>
</tr>
<tr>
<td>webapps</td>
<td>应用程序，应用部署目录</td>
</tr>
<tr>
<td>work</td>
<td>jsp编译后的结果文件，建议提前预热访问</td>
</tr>
</tbody></table>
<p>范例：查看tomcat相关目录和文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat<br>[root@centos8 tomcat]<span class="hljs-comment">#ls</span><br>bin           conf             lib      logs    README.md      RUNNING.txt  webapps<br>BUILDING.txt  CONTRIBUTING.md  LICENSE  NOTICE  RELEASE-NOTES  temp         work<br>[root@centos8 tomcat]<span class="hljs-comment"># ls bin</span><br>bootstrap.jar       ciphers.sh                    daemon.sh         shutdown.bat     tomcat-native.tar.gz<br>catalina.bat        commons-daemon.jar            digest.bat        shutdown.sh      tool-wrapper.bat<br>catalina.sh         commons-daemon-native.tar.gz  digest.sh         startup.bat      tool-wrapper.sh<br>catalina-tasks.xml  configtest.bat                setclasspath.bat  startup.sh       version.bat<br>ciphers.bat         configtest.sh                 setclasspath.sh   tomcat-juli.jar  version.sh<br>[root@centos8 tomcat]<span class="hljs-comment"># ls conf</span><br>Catalina         catalina.properties  jaspic-providers.xml  logging.properties  tomcat.conf       tomcat-users.xsd<br>catalina.policy  context.xml          jaspic-providers.xsd  server.xml          tomcat-users.xml  web.xml<br>[root@centos8 tomcat]<span class="hljs-comment"># ls lib</span><br>annotations-api.jar       ecj-4.6.3.jar   servlet-api.jar     tomcat-i18n-fr.jar     tomcat-jni.jar<br>catalina-ant.jar          el-api.jar      tomcat-api.jar      tomcat-i18n-ja.jar     tomcat-util.jar<br>catalina-ha.jar           jasper-el.jar   tomcat-coyote.jar   tomcat-i18n-ko.jar     tomcat-util-scan.jar<br>catalina.jar              jasper.jar      tomcat-dbcp.jar     tomcat-i18n-ru.jar     tomcat-websocket.jar<br>catalina-storeconfig.jar  jaspic-api.jar  tomcat-i18n-de.jar  tomcat-i18n-zh-CN.jar  websocket-api.jar<br>catalina-tribes.jar       jsp-api.jar     tomcat-i18n-es.jar  tomcat-jdbc.jar<br>[root@centos8 tomcat]<span class="hljs-comment"># ls logs</span><br>catalina.2021-08-09.log  host-manager.2021-08-09.log  localhost_access_log.2021-08-09.txt<br>catalina.out             localhost.2021-08-09.log     manager.2021-08-09.log<br>[root@centos8 tomcat]<span class="hljs-comment"># ls webapps/</span><br>docs examples host-manager manager ROOT<br>[root@centos8 tomcat]<span class="hljs-comment"># ls work/</span><br>Catalina<br>[root@centos8 tomcat]<span class="hljs-comment"># ls work/Catalina/</span><br>localhost<br>[root@centos8 tomcat]<span class="hljs-comment"># ls work/Catalina/localhost/</span><br>docs examples host-manager manager ROOT<br>[root@centos8 tomcat]<span class="hljs-comment"># ll -i work/Catalina/localhost/</span><br>total 0<br>  2523315 drwxr-x--- 2 tomcat tomcat  6 Aug  9 09:28 docs<br> 68755267 drwxr-x--- 2 tomcat tomcat  6 Aug  9 09:28 examples<br>136779955 drwxr-x--- 2 tomcat tomcat  6 Aug  9 09:28 host-manager<br>203962755 drwxr-x--- 2 tomcat tomcat  6 Aug  9 09:28 manager<br>203962754 drwxr-x--- 3 tomcat tomcat 17 Aug  9 09:29 ROOT<br>[root@centos8 tomcat]<span class="hljs-comment"># ll -i webapps/</span><br>total 4<br>204445885 drwxr-x--- 15 tomcat tomcat 4096 Aug  9 09:22 docs<br>203962563 drwxr-x---  6 tomcat tomcat   83 Aug  9 09:22 examples<br>  2334398 drwxr-x---  5 tomcat tomcat   87 Aug  9 09:22 host-manager<br> 68755072 drwxr-x---  5 tomcat tomcat  103 Aug  9 09:22 manager<br> 68737264 drwxr-x---  3 tomcat tomcat  283 Aug  9 09:22 ROOT<br><br>[root@centos8 tomcat]<span class="hljs-comment"># tree work/Catalina/localhost/</span><br>work/Catalina/localhost/<br>├── docs<br>├── examples<br>├── host-manager<br>├── manager<br>└── ROOT<br><br>5 directories, 0 files<br><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://10.0.0.8:8080/</span><br><span class="hljs-comment">#当访问过后，work目录中生成新文件</span><br>[root@centos8 tomcat]<span class="hljs-comment"># tree work/Catalina/localhost/</span><br>work/Catalina/localhost/<br>├── docs<br>├── examples<br>├── host-manager<br>├── manager<br>└── ROOT<br> └── org<br>   └── apache<br>     └── jsp<br>       ├── index_jsp.class <span class="hljs-comment">#字节码文件</span><br>       └── index_jsp.java  <span class="hljs-comment">#servlet文件</span><br>       <br>8 directories, 2 files<br><br><span class="hljs-comment">#tomcat会自动的将jsp文件生成java源文件，再编译成class文件</span><br>[root@centos8 tomcat]<span class="hljs-comment"># less work/Catalina/localhost/ROOT/org/apache/jsp/index_jsp.java</span><br>/*<br>* Generated by the Jasper component of Apache Tomcat<br>* Version: Apache Tomcat/8.5.50<br>* Generated at: 2020-02-09 03:20:20 UTC<br>* Note: The last modified time of this file was <span class="hljs-built_in">set</span> to<br>*    the last modified time of the <span class="hljs-built_in">source</span> file after<br>*    generation to assist with modification tracking.<br>*/<br>package org.apache.jsp;<br><br>import javax.servlet.*;<br>import javax.servlet.http.*;<br>import javax.servlet.jsp.*;<br><br>public final class index_jsp extends org.apache.jasper.runtime.HttpJspBase<br> implements org.apache.jasper.runtime.JspSourceDependent,<br>        org.apache.jasper.runtime.JspSourceImports &#123;<br><br>private static final javax.servlet.jsp.JspFactory _jspxFactory =<br>    javax.servlet.jsp.JspFactory.getDefaultFactory();<br><br>private static java.util.Map&lt;java.lang.String,java.lang.Long&gt;<br>_jspx_dependants;<br></code></pre></td></tr></table></figure>

<h3 id="3-3-2-配置文件"><a href="#3-3-2-配置文件" class="headerlink" title="3.3.2 配置文件"></a>3.3.2 配置文件</h3><h4 id="3-3-2-1-配置文件说明"><a href="#3-3-2-1-配置文件说明" class="headerlink" title="3.3.2.1 配置文件说明"></a>3.3.2.1 配置文件说明</h4><p>官方帮助文档：<a target="_blank" rel="noopener" href="http://tomcat.apache.org/tomcat-8.5-doc/index.html">http://tomcat.apache.org/tomcat-8.5-doc/index.html</a></p>
<p>在tomcat安装目录下的 conf 子目录中，有以下的 tomcat 的配置文件</p>
<table>
<thead>
<tr>
<th>文件名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>server.xml</td>
<td>主配置文件</td>
</tr>
<tr>
<td>web.xml</td>
<td>每个webapp只有“部署”后才能被访问，它的部署方式通常由web.xml进行定义，其存放位置为WEB-INF/目录中；此文件为所有的webapps提供默认部署相关的配置,每个web应用也可以使用专用配置文件,来覆盖全局文件</td>
</tr>
<tr>
<td>context.xml</td>
<td>用于定义所有web应用均需加载的Context配置，此文件为所有的webapps提供默认配置，每个web应用也可以使用自已专用的配置，它通常由专用的配置文件context.xml来定义，其存放位置为WEB-INF/目录中,覆盖全局的文件</td>
</tr>
<tr>
<td>tomcat-users.xml</td>
<td>用户认证的账号和密码文件</td>
</tr>
<tr>
<td>catalina.policy</td>
<td>当使用security选项启动tomcat时，用于为tomcat设置安全策略</td>
</tr>
<tr>
<td>catalina.properties</td>
<td>Tomcat 环境变量的配置，用于设定类加载器路径，以及一些与JVM调优相关参数</td>
</tr>
<tr>
<td>logging.properties</td>
<td>Tomcat 日志系统相关的配置，可以修改日志级别和日志路径等</td>
</tr>
</tbody></table>
<p><strong>注意：配置文件大小写敏感</strong></p>
<p>范例：查看配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 conf]<span class="hljs-comment">#pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/conf<br>[root@centos8 conf]<span class="hljs-comment">#ls</span><br>Catalina       context.xml      logging.properties tomcat-users.xml<br>catalina.policy   jaspic-providers.xml server.xml     tomcat-users.xsd<br>catalina.properties jaspic-providers.xsd tomcat.conf     web.xml<br>[root@centos8 conf]<span class="hljs-comment"># wc -l server.xml web.xml context.xml tomcat-users.xml catalina.policy catalina.properties logging.properties</span><br>   167 server.xml<br>  4726 web.xml<br>    30 context.xml<br>    44 tomcat-users.xml<br>   271 catalina.policy<br>   214 catalina.properties<br>    75 logging.properties<br>  5527 total<br>[root@centos8 conf]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>范例: 主要配置文件内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># grep -v &#x27;\-\-&#x27; /usr/local/tomcat/conf/server.xml</span><br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>  Licensed to the Apache Software Foundation (ASF) under one or more<br>  contributor license agreements.  See the NOTICE file distributed with<br>  this work <span class="hljs-keyword">for</span> additional information regarding copyright ownership.<br>  The ASF licenses this file to You under the Apache License, Version 2.0<br>  (the <span class="hljs-string">&quot;License&quot;</span>); you may not use this file except <span class="hljs-keyword">in</span> compliance with<br>  the License.  You may obtain a copy of the License at<br><br>      http://www.apache.org/licenses/LICENSE-2.0<br><br>  Unless required by applicable law or agreed to <span class="hljs-keyword">in</span> writing, software<br>  distributed under the License is distributed on an <span class="hljs-string">&quot;AS IS&quot;</span> BASIS,<br>  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br>  See the License <span class="hljs-keyword">for</span> the specific language governing permissions and<br>  limitations under the License.<br>     define subcomponents such as <span class="hljs-string">&quot;Valves&quot;</span> at this level.<br>     Documentation at /docs/config/server.html<br>&lt;Server port=<span class="hljs-string">&quot;8005&quot;</span> shutdown=<span class="hljs-string">&quot;SHUTDOWN&quot;</span>&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.startup.VersionLoggerListener&quot;</span> /&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.security.SecurityListener&quot;</span> /&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> SSLEngine=<span class="hljs-string">&quot;on&quot;</span> /&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot;</span> /&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot;</span> /&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot;</span> /&gt;<br><br>       Documentation at /docs/jndi-resources-howto.html<br>  &lt;GlobalNamingResources&gt;<br>         UserDatabaseRealm to authenticate users<br>    &lt;Resource name=<span class="hljs-string">&quot;UserDatabase&quot;</span> auth=<span class="hljs-string">&quot;Container&quot;</span><br>              <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;org.apache.catalina.UserDatabase&quot;</span><br>              description=<span class="hljs-string">&quot;User database that can be updated and saved&quot;</span><br>              factory=<span class="hljs-string">&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span><br>              pathname=<span class="hljs-string">&quot;conf/tomcat-users.xml&quot;</span> /&gt;<br>  &lt;/GlobalNamingResources&gt;<br><br>       a single <span class="hljs-string">&quot;Container&quot;</span> Note:  A <span class="hljs-string">&quot;Service&quot;</span> is not itself a <span class="hljs-string">&quot;Container&quot;</span>,<br>       so you may not define subcomponents such as <span class="hljs-string">&quot;Valves&quot;</span> at this level.<br>       Documentation at /docs/config/service.html<br>  &lt;Service name=<span class="hljs-string">&quot;Catalina&quot;</span>&gt;<br><br>    &lt;Executor name=<span class="hljs-string">&quot;tomcatThreadPool&quot;</span> namePrefix=<span class="hljs-string">&quot;catalina-exec-&quot;</span><br>        maxThreads=<span class="hljs-string">&quot;150&quot;</span> minSpareThreads=<span class="hljs-string">&quot;4&quot;</span>/&gt;<br><br><br>         and responses are returned. Documentation at :<br>         Java HTTP Connector: /docs/config/http.html<br>         Java AJP  Connector: /docs/config/ajp.html<br>         APR (HTTP/AJP) Connector: /docs/apr.html<br>         Define a non-SSL/TLS HTTP/1.1 Connector on port 8080<br>    &lt;Connector port=<span class="hljs-string">&quot;8080&quot;</span> protocol=<span class="hljs-string">&quot;HTTP/1.1&quot;</span><br>               connectionTimeout=<span class="hljs-string">&quot;20000&quot;</span><br>               redirectPort=<span class="hljs-string">&quot;8443&quot;</span> /&gt;<br>    &lt;Connector executor=<span class="hljs-string">&quot;tomcatThreadPool&quot;</span><br>               port=<span class="hljs-string">&quot;8080&quot;</span> protocol=<span class="hljs-string">&quot;HTTP/1.1&quot;</span><br>               connectionTimeout=<span class="hljs-string">&quot;20000&quot;</span><br>               redirectPort=<span class="hljs-string">&quot;8443&quot;</span> /&gt;<br>         This connector uses the NIO implementation. The default<br>         SSLImplementation will depend on the presence of the APR/native<br>         library and the useOpenSSL attribute of the<br>         AprLifecycleListener.<br>         Either JSSE or OpenSSL style configuration may be used regardless of<br>         the SSLImplementation selected. JSSE style configuration is used below.<br>    &lt;Connector port=<span class="hljs-string">&quot;8443&quot;</span> protocol=<span class="hljs-string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span><br>               maxThreads=<span class="hljs-string">&quot;150&quot;</span> SSLEnabled=<span class="hljs-string">&quot;true&quot;</span>&gt;<br>        &lt;SSLHostConfig&gt;<br>            &lt;Certificate certificateKeystoreFile=<span class="hljs-string">&quot;conf/localhost-rsa.jks&quot;</span><br>                         <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;RSA&quot;</span> /&gt;<br>        &lt;/SSLHostConfig&gt;<br>    &lt;/Connector&gt;<br>         This connector uses the APR/native implementation <span class="hljs-built_in">which</span> always uses<br>         OpenSSL <span class="hljs-keyword">for</span> TLS.<br>         Either JSSE or OpenSSL style configuration may be used. OpenSSL style<br>         configuration is used below.<br>    &lt;Connector port=<span class="hljs-string">&quot;8443&quot;</span> protocol=<span class="hljs-string">&quot;org.apache.coyote.http11.Http11AprProtocol&quot;</span><br>               maxThreads=<span class="hljs-string">&quot;150&quot;</span> SSLEnabled=<span class="hljs-string">&quot;true&quot;</span> &gt;<br>        &lt;UpgradeProtocol className=<span class="hljs-string">&quot;org.apache.coyote.http2.Http2Protocol&quot;</span> /&gt;<br>        &lt;SSLHostConfig&gt;<br>            &lt;Certificate certificateKeyFile=<span class="hljs-string">&quot;conf/localhost-rsa-key.pem&quot;</span><br>                         certificateFile=<span class="hljs-string">&quot;conf/localhost-rsa-cert.pem&quot;</span><br>                         certificateChainFile=<span class="hljs-string">&quot;conf/localhost-rsa-chain.pem&quot;</span><br>                         <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;RSA&quot;</span> /&gt;<br>        &lt;/SSLHostConfig&gt;<br>    &lt;/Connector&gt;<br><br>    &lt;Connector port=<span class="hljs-string">&quot;8009&quot;</span> protocol=<span class="hljs-string">&quot;AJP/1.3&quot;</span> redirectPort=<span class="hljs-string">&quot;8443&quot;</span> /&gt;<br><br><br>         every request.  The Engine implementation <span class="hljs-keyword">for</span> Tomcat stand alone<br>         analyzes the HTTP headers included with the request, and passes them<br>         on to the appropriate Host (virtual host).<br><br>    &lt;Engine name=<span class="hljs-string">&quot;Catalina&quot;</span> defaultHost=<span class="hljs-string">&quot;localhost&quot;</span> jvmRoute=<span class="hljs-string">&quot;jvm1&quot;</span>&gt;<br>    &lt;Engine name=<span class="hljs-string">&quot;Catalina&quot;</span> defaultHost=<span class="hljs-string">&quot;localhost&quot;</span>&gt;<br><br>          /docs/cluster-howto.html  (simple how to)<br>      &lt;Cluster className=<span class="hljs-string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span>/&gt;<br><br>      &lt;Realm className=<span class="hljs-string">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;<br>             resources under the key <span class="hljs-string">&quot;UserDatabase&quot;</span>.  Any edits<br>             that are performed against this UserDatabase are immediately<br>        &lt;Realm className=<span class="hljs-string">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span><br>               resourceName=<span class="hljs-string">&quot;UserDatabase&quot;</span>/&gt;<br>      &lt;/Realm&gt;<br><br>      &lt;Host name=<span class="hljs-string">&quot;localhost&quot;</span>  appBase=<span class="hljs-string">&quot;webapps&quot;</span><br>            unpackWARs=<span class="hljs-string">&quot;true&quot;</span> autoDeploy=<span class="hljs-string">&quot;true&quot;</span>&gt;<br><br>        &lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.authenticator.SingleSignOn&quot;</span> /&gt;<br><br>             Documentation at: /docs/config/valve.html<br>        &lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="hljs-string">&quot;logs&quot;</span><br>               prefix=<span class="hljs-string">&quot;localhost_access_log&quot;</span> suffix=<span class="hljs-string">&quot;.txt&quot;</span><br>               pattern=<span class="hljs-string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;<br><br>      &lt;/Host&gt;<br>    &lt;/Engine&gt;<br>  &lt;/Service&gt;<br>&lt;/Server&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># grep -v &#x27;\-\-&#x27; /usr/local/tomcat/conf/context.xml</span><br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>  Licensed to the Apache Software Foundation (ASF) under one or more<br>  contributor license agreements.  See the NOTICE file distributed with<br>  this work <span class="hljs-keyword">for</span> additional information regarding copyright ownership.<br>  The ASF licenses this file to You under the Apache License, Version 2.0<br>  (the <span class="hljs-string">&quot;License&quot;</span>); you may not use this file except <span class="hljs-keyword">in</span> compliance with<br>  the License.  You may obtain a copy of the License at<br><br>      http://www.apache.org/licenses/LICENSE-2.0<br><br>  Unless required by applicable law or agreed to <span class="hljs-keyword">in</span> writing, software<br>  distributed under the License is distributed on an <span class="hljs-string">&quot;AS IS&quot;</span> BASIS,<br>  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br>  See the License <span class="hljs-keyword">for</span> the specific language governing permissions and<br>  limitations under the License.<br>&lt;Context&gt;<br><br>    &lt;WatchedResource&gt;WEB-INF/web.xml&lt;/WatchedResource&gt;<br>    &lt;WatchedResource&gt;<span class="hljs-variable">$&#123;catalina.base&#125;</span>/conf/web.xml&lt;/WatchedResource&gt;<br><br>    &lt;Manager pathname=<span class="hljs-string">&quot;&quot;</span> /&gt;<br>&lt;/Context&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># grep -v &#x27;\-\-&#x27; /usr/local/tomcat/conf/tomcat-users.xml</span><br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>  Licensed to the Apache Software Foundation (ASF) under one or more<br>  contributor license agreements.  See the NOTICE file distributed with<br>  this work <span class="hljs-keyword">for</span> additional information regarding copyright ownership.<br>  The ASF licenses this file to You under the Apache License, Version 2.0<br>  (the <span class="hljs-string">&quot;License&quot;</span>); you may not use this file except <span class="hljs-keyword">in</span> compliance with<br>  the License.  You may obtain a copy of the License at<br><br>      http://www.apache.org/licenses/LICENSE-2.0<br><br>  Unless required by applicable law or agreed to <span class="hljs-keyword">in</span> writing, software<br>  distributed under the License is distributed on an <span class="hljs-string">&quot;AS IS&quot;</span> BASIS,<br>  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br>  See the License <span class="hljs-keyword">for</span> the specific language governing permissions and<br>  limitations under the License.<br>&lt;tomcat-users xmlns=<span class="hljs-string">&quot;http://tomcat.apache.org/xml&quot;</span><br>              xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>              xsi:schemaLocation=<span class="hljs-string">&quot;http://tomcat.apache.org/xml tomcat-users.xsd&quot;</span><br>              version=<span class="hljs-string">&quot;1.0&quot;</span>&gt;<br>  NOTE:  By default, no user is included <span class="hljs-keyword">in</span> the <span class="hljs-string">&quot;manager-gui&quot;</span> role required<br>  to operate the <span class="hljs-string">&quot;/manager/html&quot;</span> web application.  If you wish to use this app,<br>  you must define such a user - the username and password are arbitrary. It is<br>  strongly recommended that you <span class="hljs-keyword">do</span> NOT use one of the users <span class="hljs-keyword">in</span> the commented out<br>  section below since they are intended <span class="hljs-keyword">for</span> use with the examples web<br>  application.<br>  NOTE:  The sample user and role entries below are intended <span class="hljs-keyword">for</span> use with the<br>  examples web application. They are wrapped <span class="hljs-keyword">in</span> a comment and thus are ignored<br>  when reading this file. If you wish to configure these users <span class="hljs-keyword">for</span> use with the<br>  examples web application, <span class="hljs-keyword">do</span> not forget to remove the &lt;!.. ..&gt; that surrounds<br>  them. You will also need to <span class="hljs-built_in">set</span> the passwords to something appropriate.<br>  &lt;role rolename=<span class="hljs-string">&quot;tomcat&quot;</span>/&gt;<br>  &lt;role rolename=<span class="hljs-string">&quot;role1&quot;</span>/&gt;<br>  &lt;user username=<span class="hljs-string">&quot;tomcat&quot;</span> password=<span class="hljs-string">&quot;&lt;must-be-changed&gt;&quot;</span> roles=<span class="hljs-string">&quot;tomcat&quot;</span>/&gt;<br>  &lt;user username=<span class="hljs-string">&quot;both&quot;</span> password=<span class="hljs-string">&quot;&lt;must-be-changed&gt;&quot;</span> roles=<span class="hljs-string">&quot;tomcat,role1&quot;</span>/&gt;<br>  &lt;user username=<span class="hljs-string">&quot;role1&quot;</span> password=<span class="hljs-string">&quot;&lt;must-be-changed&gt;&quot;</span> roles=<span class="hljs-string">&quot;role1&quot;</span>/&gt;<br>&lt;/tomcat-users&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># cat /usr/local/tomcat/conf/tomcat.conf</span><br>JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br></code></pre></td></tr></table></figure>

<h4 id="3-3-2-2-日志文件"><a href="#3-3-2-2-日志文件" class="headerlink" title="3.3.2.2 日志文件"></a>3.3.2.2 日志文件</h4><p>参考文档: <a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/TOMCAT/Logging">https://cwiki.apache.org/confluence/display/TOMCAT/Logging</a></p>
<p>日志格式: <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging">https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">%a - Remote IP address<br>%A - Local IP address<br>%b - Bytes sent, excluding HTTP headers, or <span class="hljs-string">&#x27;-&#x27;</span> <span class="hljs-keyword">if</span> zero<br>%B - Bytes sent, excluding HTTP headers<br>%h - Remote host name (or IP address <span class="hljs-keyword">if</span> enableLookups <span class="hljs-keyword">for</span> the connector is <span class="hljs-literal">false</span>)<br>%H - Request protocol<br>%l - Remote logical username from identd (always returns <span class="hljs-string">&#x27;-&#x27;</span>)<br>%m - Request method (GET, POST, etc.)<br>%p - Local port on <span class="hljs-built_in">which</span> this request was received. See also %&#123;xxx&#125;p below.<br>%q - Query string (prepended with a <span class="hljs-string">&#x27;?&#x27;</span> <span class="hljs-keyword">if</span> it exists)<br>%r - First line of the request (method and request URI)<br>%s - HTTP status code of the response<br>%S - User session ID<br>%t - Date and time, <span class="hljs-keyword">in</span> Common Log Format<br>%u - Remote user that was authenticated (<span class="hljs-keyword">if</span> any), <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;-&#x27;</span><br>%U - Requested URL path<br>%v - Local server name<br>%D - Time taken to process the request <span class="hljs-keyword">in</span> millis. Note: In httpd %D is<br>microseconds. Behaviour will be aligned to httpd <span class="hljs-keyword">in</span> Tomcat 10 onwards.<br>%T - Time taken to process the request, <span class="hljs-keyword">in</span> seconds. Note: This value has<br>millisecond resolution whereas <span class="hljs-keyword">in</span> httpd it has second resolution. Behaviour will<br>be align to httpd <span class="hljs-keyword">in</span> Tomcat 10 onwards.<br>%F - Time taken to commit the response, <span class="hljs-keyword">in</span> millis<br>%I - Current request thread name (can compare later with stacktraces)<br>%X - Connection status when response is completed:<br>X = Connection aborted before the response completed.<br>+ = Connection may be kept alive after the response is sent.<br>- = Connection will be closed after the response is sent.<br>There is also support to write information incoming or outgoing headers,<br>cookies, session or request attributes and special timestamp formats. It is<br>modeled after the Apache HTTP Server <span class="hljs-built_in">log</span> configuration syntax. Each of them can<br>be used multiple <span class="hljs-built_in">times</span> with different xxx keys:<br><br>%&#123;xxx&#125;i write value of incoming header with name xxx<br>%&#123;xxx&#125;o write value of outgoing header with name xxx<br>%&#123;xxx&#125;c write value of cookie with name xxx<br>%&#123;xxx&#125;r write value of ServletRequest attribute with name xxx<br>%&#123;xxx&#125;s write value of HttpSession attribute with name xxx<br>%&#123;xxx&#125;p write <span class="hljs-built_in">local</span> (server) port (xxx==<span class="hljs-built_in">local</span>) or remote (client) port<br>(xxx=remote)<br><br>%&#123;xxx&#125;t write timestamp at the end of the request formatted using the enhanced<br>SimpleDateFormat pattern xxx<br></code></pre></td></tr></table></figure>

<p>范例: tomcat中的日志文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@tomcat ~]<span class="hljs-comment"># cat /usr/local/tomcat/conf/logging.properties</span><br><span class="hljs-comment"># Licensed to the Apache Software Foundation (ASF) under one or more</span><br><span class="hljs-comment"># contributor license agreements. See the NOTICE file distributed with</span><br><span class="hljs-comment"># this work for additional information regarding copyright ownership.</span><br><span class="hljs-comment"># The ASF licenses this file to You under the Apache License, Version 2.0</span><br><span class="hljs-comment"># (the &quot;License&quot;); you may not use this file except in compliance with</span><br><span class="hljs-comment"># the License. You may obtain a copy of the License at</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#   http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment"># See the License for the specific language governing permissions and</span><br><span class="hljs-comment"># limitations under the License.</span><br><br>handlers = 1catalina.org.apache.juli.AsyncFileHandler,<br>2localhost.org.apache.juli.AsyncFileHandler,<br>3manager.org.apache.juli.AsyncFileHandler, 4host-<br>manager.org.apache.juli.AsyncFileHandler, java.util.logging.ConsoleHandler<br><br>.handlers = 1catalina.org.apache.juli.AsyncFileHandler,<br>java.util.logging.ConsoleHandler<br><br><span class="hljs-comment">############################################################</span><br><span class="hljs-comment"># Handler specific properties.</span><br><span class="hljs-comment"># Describes specific configuration info for Handlers.</span><br><span class="hljs-comment">############################################################</span><br><br>1catalina.org.apache.juli.AsyncFileHandler.level = FINE<br>1catalina.org.apache.juli.AsyncFileHandler.directory = <span class="hljs-variable">$&#123;catalina.base&#125;</span>/logs<br>1catalina.org.apache.juli.AsyncFileHandler.prefix = catalina.<br>1catalina.org.apache.juli.AsyncFileHandler.encoding = UTF-8<br><br>2localhost.org.apache.juli.AsyncFileHandler.level = FINE<br>2localhost.org.apache.juli.AsyncFileHandler.directory = <span class="hljs-variable">$&#123;catalina.base&#125;</span>/logs<br>2localhost.org.apache.juli.AsyncFileHandler.prefix = localhost.<br>2localhost.org.apache.juli.AsyncFileHandler.encoding = UTF-8<br><br>3manager.org.apache.juli.AsyncFileHandler.level = FINE<br>3manager.org.apache.juli.AsyncFileHandler.directory = <span class="hljs-variable">$&#123;catalina.base&#125;</span>/logs<br>3manager.org.apache.juli.AsyncFileHandler.prefix = manager.<br>3manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8<br><br>4host-manager.org.apache.juli.AsyncFileHandler.level = FINE<br>4host-manager.org.apache.juli.AsyncFileHandler.directory = <span class="hljs-variable">$&#123;catalina.base&#125;</span>/logs<br>4host-manager.org.apache.juli.AsyncFileHandler.prefix = host-manager.<br>4host-manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8<br><br>java.util.logging.ConsoleHandler.level = FINE<br>java.util.logging.ConsoleHandler.formatter = org.apache.juli.OneLineFormatter<br>java.util.logging.ConsoleHandler.encoding = UTF-8<br><br><span class="hljs-comment">############################################################</span><br><span class="hljs-comment"># Facility specific properties.</span><br><span class="hljs-comment"># Provides extra control for each logger.</span><br><span class="hljs-comment">############################################################</span><br><br>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].level = INFO<br>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].handlers =<br>2localhost.org.apache.juli.AsyncFileHandler<br><br>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].level =INFO<br>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].<br>[/manager].handlers = 3manager.org.apache.juli.AsyncFileHandler<br><br>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-<br>manager].level = INFO<br>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-<br>manager].handlers = 4host-manager.org.apache.juli.AsyncFileHandler<br><br><span class="hljs-comment"># For example, set the org.apache.catalina.util.LifecycleBase logger to log</span><br><span class="hljs-comment"># each component that extends LifecycleBase changing state:</span><br><span class="hljs-comment">#org.apache.catalina.util.LifecycleBase.level = FINE</span><br><br><span class="hljs-comment"># To see debug messages in TldLocationsCache, uncomment the following line:</span><br><span class="hljs-comment">#org.apache.jasper.compiler.TldLocationsCache.level = FINE</span><br><br><span class="hljs-comment"># To see debug messages for HTTP/2 handling, uncomment the following line:</span><br><span class="hljs-comment">#org.apache.coyote.http2.level = FINE</span><br><br><span class="hljs-comment"># To see debug messages for WebSocket handling, uncomment the following line:</span><br><span class="hljs-comment">#org.apache.tomcat.websocket.level = FINE</span><br><br>[root@centos8 ~]<span class="hljs-comment"># ls /usr/local/tomcat/logs/ -1</span><br>catalina.2020-07-14.log  <span class="hljs-comment">#tomcat服务日志</span><br>catalina.out        <span class="hljs-comment">#tomcat服务日志</span><br>host-manager.2020-07-14.log  <span class="hljs-comment">#host manager管理日志</span><br>localhost.2020-07-14.log    <span class="hljs-comment">#默认主机日志</span><br>localhost_access_log.2020-07-14.txt  <span class="hljs-comment">##默认主机访问日志</span><br>manager.2020-07-14.log     <span class="hljs-comment">#manager 管理日志</span><br></code></pre></td></tr></table></figure>

<p>范例: tomcat的访问日志格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看访问日志格式</span><br>[root@centos8 ~]<span class="hljs-comment"># tail /usr/local/tomcat/conf/server.xml</span><br>      Documentation at: /docs/config/valve.html<br>      Note: The pattern used is equivalent to using pattern=<span class="hljs-string">&quot;common&quot;</span> --&gt;<br>   &lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span><br>directory=<span class="hljs-string">&quot;logs&quot;</span><br>       prefix=<span class="hljs-string">&quot;localhost_access_log&quot;</span> suffix=<span class="hljs-string">&quot;.txt&quot;</span><br>       pattern=<span class="hljs-string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;  <span class="hljs-comment">#说明: &amp;quot;在html中表示双引号&quot;符号</span><br>  <br>  &lt;/Host&gt;<br> &lt;/Engine&gt;<br>&lt;/Service&gt;<br>&lt;/Server&gt;<br><br><span class="hljs-comment">#查看访问日志</span><br>[root@centos8 ~]<span class="hljs-comment"># tail /usr/local/tomcat/logs/localhost_access_log.2020-07-14.txt</span><br>10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 11215<br>10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="hljs-string">&quot;GET /tomcat.css HTTP/1.1&quot;</span> 200 5581<br>10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="hljs-string">&quot;GET /tomcat.png HTTP/1.1&quot;</span> 200 5103<br>10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="hljs-string">&quot;GET /bg-nav.png HTTP/1.1&quot;</span> 200 1401<br>10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="hljs-string">&quot;GET /bg-upper.png HTTP/1.1&quot;</span> 200 3103<br>10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="hljs-string">&quot;GET /asf-logo-wide.svg HTTP/1.1&quot;</span> 200<br>27235<br>10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="hljs-string">&quot;GET /bg-middle.png HTTP/1.1&quot;</span> 200 1918<br>10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="hljs-string">&quot;GET /bg-button.png HTTP/1.1&quot;</span> 200 713<br>10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="hljs-string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> 200 21630<br></code></pre></td></tr></table></figure>

<h3 id="3-3-3-组件"><a href="#3-3-3-组件" class="headerlink" title="3.3.3 组件"></a>3.3.3 组件</h3><h4 id="3-3-3-1-组件分层和分类"><a href="#3-3-3-1-组件分层和分类" class="headerlink" title="3.3.3.1 组件分层和分类"></a>3.3.3.1 组件分层和分类</h4><p><strong>顶级组件</strong></p>
<p>Server，代表整个Tomcat容器，一台主机可以启动多tomcat实例，需要确保端口不要产生冲突</p>
<p><strong>服务类组件</strong></p>
<p>Service，实现组织Engine和Connector，建立两者之间关联关系, service 里面只能包含一个Engine</p>
<p><strong>连接器组件</strong></p>
<p>Connector，有HTTP（默认端口8080/tcp）、HTTPS（默认端口8443/tcp）、AJP（默认端口8009/tcp）协议的连接器，AJP（Apache Jserv protocol）是一种基于TCP的二进制通讯协议。</p>
<p><strong>容器类</strong></p>
<p>Engine、Host（虚拟主机）、Context(上下文件,解决路径映射)都是容器类组件，可以嵌入其它组件，内部配置如何运行应用程序。</p>
<p><strong>内嵌类</strong></p>
<p>可以内嵌到其他组件内，valve、logger、realm、loader、manager等。以logger举例，在不同容器组件内分别定义。</p>
<p><strong>集群类组件</strong></p>
<p>listener、cluster</p>
<h4 id="3-3-3-2-Tomcat内部组成"><a href="#3-3-3-2-Tomcat内部组成" class="headerlink" title="3.3.3.2 Tomcat内部组成"></a>3.3.3.2 Tomcat内部组成</h4><p>由上述组件就构成了Tomcat，如下图</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat34.png" srcset="/blog/img/loading.gif"></p>
<table>
<thead>
<tr>
<th>名称 说明</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>Server</td>
<td>服务器，Tomcat运行的进程实例，一个Server中可以有多个service，但通常就一个</td>
</tr>
<tr>
<td>Service</td>
<td>服务，用来组织Engine和Connector的对应关系，一个service中只有一个Engine</td>
</tr>
<tr>
<td>Connector</td>
<td>连接器，负责客户端的HTTP、HTTPS、AJP等协议连接。一个Connector只属于某一个Engine</td>
</tr>
<tr>
<td>Engine</td>
<td>即引擎，用来响应并处理用户请求。一个Engine上可以绑定多个Connector</td>
</tr>
<tr>
<td>Host</td>
<td>即虚拟主机,可以实现多虚拟主机,例如使用不同的主机头区分</td>
</tr>
<tr>
<td>Context</td>
<td>应用的上下文，配置特定url路径映射和目录的映射关系：url =&gt; directory</td>
</tr>
</tbody></table>
<p>每一个组件都由一个Java“类”实现，这些组件大体可分为以下几个类型：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs erlang">顶级组件：Server<br>服务类组件：Service<br>连接器组件：http, https, ajp（apache jserv protocol）<br>容器类：Engine, Host, Context<br>被嵌套类：valve, logger, realm, loader, manager, ...<br>集群类组件：listener, cluster, ...<br></code></pre></td></tr></table></figure>

<p>范例: 查看类</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># grep className /usr/local/tomcat/conf/server.xml</span><br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.startup.VersionLoggerListener&quot;</span> /&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.security.SecurityListener&quot;</span> /&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> SSLEngine=<span class="hljs-string">&quot;on&quot;</span> /&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot;</span> /&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot;</span> /&gt;<br>  &lt;Listener className=<span class="hljs-string">&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot;</span> /&gt;<br>        &lt;UpgradeProtocol className=<span class="hljs-string">&quot;org.apache.coyote.http2.Http2Protocol&quot;</span> /&gt;<br>      &lt;Cluster className=<span class="hljs-string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span>/&gt;<br>      &lt;Realm className=<span class="hljs-string">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;<br>        &lt;Realm className=<span class="hljs-string">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span><br>        &lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.authenticator.SingleSignOn&quot;</span> /&gt;<br>        &lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="hljs-string">&quot;logs&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-3-核心组件"><a href="#3-3-3-3-核心组件" class="headerlink" title="3.3.3.3 核心组件"></a>3.3.3.3 核心组件</h4><ul>
<li>Tomcat启动一个Server进程。可以启动多个Server，即tomcat的多实例, 但一般只启动一个</li>
<li>创建一个Service提供服务。可以创建多个Service，但一般也只创建一个<ul>
<li>每个Service中，是Engine和其连接器Connector的关联配置</li>
</ul>
</li>
<li>可以为这个Service提供多个连接器Connector，这些Connector使用了不同的协议，绑定了不同的端口。其作用就是处理来自客户端的不同的连接请求或响应</li>
<li>Service 内部还定义了Engine，引擎才是真正的处理请求的入口，其内部定义多个虚拟主机Host<ul>
<li>Engine对请求头做了分析，将请求发送给相应的虚拟主机</li>
<li>如果没有匹配，数据就发往Engine上的defaultHost缺省虚拟主机</li>
<li>Engine上的缺省虚拟主机可以修改</li>
</ul>
</li>
<li>Host 定义虚拟主机，虚拟主机有name名称，通过名称匹配</li>
<li>Context 定义应用程序单独的路径映射和配置</li>
</ul>
<p>范例：多个组件关系 conf/server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Server</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8005&quot;</span> <span class="hljs-attr">shutdown</span>=<span class="hljs-string">&quot;SHUTDOWN&quot;</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">Service</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Connector</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8080&quot;</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;HTTP/1.1&quot;</span><span class="hljs-attr">connectionTimeout</span>=<span class="hljs-string">&quot;20000&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">redirectPort</span>=<span class="hljs-string">&quot;8443&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Connector</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8009&quot;</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;AJP/1.3&quot;</span> <span class="hljs-attr">redirectPort</span>=<span class="hljs-string">&quot;8443&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Engine</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span> <span class="hljs-attr">defaultHost</span>=<span class="hljs-string">&quot;localhost&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;localhost&quot;</span>  <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;webapps&quot;</span> <span class="hljs-attr">unpackWARs</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Context</span> &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Context</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">Engine</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">Service</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Server</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-4-tomcat处理请求过程"><a href="#3-3-3-4-tomcat处理请求过程" class="headerlink" title="3.3.3.4 tomcat处理请求过程"></a>3.3.3.4 tomcat处理请求过程</h4><p>假设来自客户的请求为：<a target="_blank" rel="noopener" href="http://localhost:8080/test/index.jsp">http://localhost:8080/test/index.jsp</a></p>
<ul>
<li>浏览器端的请求被发送到服务端端口8080，Tomcat进程监听在此端口上。通过侦听的HTTP/1.1 Connector获得此请求。</li>
<li>Connector把该请求交给它所在的Service的Engine来处理，并等待Engine的响应</li>
<li>Engine获得请求localhost:8080/test/index.jsp，遍历它所有虚拟主机Host</li>
<li>Engine匹配到名为localhost的Host。如果匹配不到,就把请求交给该Engine中的defaultHost处理</li>
<li>localhost Host获得请求/test/index.jsp，匹配它所拥有的所有Context</li>
<li>Host匹配到路径为/test的Context</li>
<li>path=/test的Context获得请求index.jsp，在它的mapping table中寻找对应的servlet</li>
<li>Context匹配到URL PATTERN为 *.jsp 的servlet，对应于JspServlet类构造HttpServletRequest对象和HttpServletResponse对象，作为参数调用JspServlet的doGet或doPost方法。</li>
<li>Context把执行完了之后的HttpServletResponse对象返回给Host</li>
<li>Host把HttpServletResponse对象返回给Engine</li>
<li>Engine把HttpServletResponse对象返回给Connector</li>
<li>Connector把HttpServletResponse对象返回给浏览器端</li>
</ul>
<h2 id="3-4-应用部署"><a href="#3-4-应用部署" class="headerlink" title="3.4 应用部署"></a>3.4 应用部署</h2><h3 id="3-4-1-tomcat的根目录结构"><a href="#3-4-1-tomcat的根目录结构" class="headerlink" title="3.4.1 tomcat的根目录结构"></a>3.4.1 tomcat的根目录结构</h3><p>Tomcat中默认网站根目录是$CATALINA_BASE/webapps/</p>
<p>在Tomcat中部署主站应用程序和其他应用程序，和之前WEB服务程序不同。</p>
<p><strong>nginx</strong><br>假设在nginx中部署2个网站应用eshop、forum，假设网站根目录是/data/nginx/html，那么部署可以是这样的。eshop解压缩所有文件放到 /data/nginx/html/ 目录下,forum 的文件放在 /data/nginx/html/forum/ 下。</p>
<p>最终网站链接有以下对应关系</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">http://localhost/ 对应于eshop的应用，即 /data/nginx/html/<br>http://localhost/forum/ 对应于forum的应用，即/data/nginx/html/forum/<br></code></pre></td></tr></table></figure>

<p><strong>Tomcat</strong></p>
<p>Tomcat中默认网站根目录是**$CATALINA_BASE**/webapps/</p>
<p>在Tomcat的webapps目录中，有个非常特殊的目录ROOT，它就是网站默认根目录。</p>
<p>将eshop解压后的文件放到这个**$CATALINA_BASE**/webapps/ROOT中。</p>
<p>bbs解压后文件都放在**$CATALINA_BASE**/webapps/forum目录下。</p>
<p><strong>$CATALINA_BASE</strong>/webapps下面的每个目录都对应一个Web应用,即WebApp</p>
<p>最终网站链接有以下对应关系</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://localhost/ 对应于eshop的应用WebApp，即<span class="hljs-variable">$CATALINA_BASE</span>/webapps/ROOT/目录,<br>http://localhost/forum/ 对应于forum的应用WebApp，即<span class="hljs-variable">$CATALINA_BASE</span>/webapps/forum/<br></code></pre></td></tr></table></figure>

<p>如果同时存在**$CATALINA_BASE** /webapps/ROOT/forum ，仍以$CATALINA_BASE/webapps/forum/优先生效</p>
<p>每一个虚拟主机都可以使用<strong>appBase</strong>指令配置自己的站点目录，使用appBase目录下的ROOT目录作为主站目录。</p>
<p>范例: 主页目和编码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># vim /usr/local/tomcat/webapps/ROOT/index.html</span><br>&lt;h1&gt;总队长&lt;/h1&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># curl 10.0.0.8:8080/index.html -I</span><br>HTTP/1.1 200<br>Accept-Ranges: bytes<br>ETag: W/<span class="hljs-string">&quot;22-1594212097000&quot;</span><br>Last-Modified: Wed, 08 Jul 2020 12:41:37 GMT<br>Content-Type: text/html  <span class="hljs-comment">#tomcat无指定编码,浏览器自动识别为GBK,可能会导致乱码</span><br>Content-Length: 22<br>Date: Wed, 08 Jul 2020 13:06:03 GMT<br><br><span class="hljs-comment">#httpd服务器默认指定编码为UTF-8,因为服务器本身不会出现乱码</span><br><span class="hljs-comment">#nginx服务器默认在响应头部没有批定编码,也会出现乱码</span><br>[root@centos8 ~]<span class="hljs-comment"># yum install -y httpd</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl start httpd</span><br>[root@centos8 ~]<span class="hljs-comment"># curl 10.0.0.18/index.html -I</span><br>HTTP/1.1 200 OK<br>Date: Wed, 08 Jul 2020 13:07:57 GMT<br>Server: Apache/2.4.37 (centos)<br>Last-Modified: Wed, 08 Jul 2020 12:59:55 GMT<br>ETag: <span class="hljs-string">&quot;16-5a9edaf39d274&quot;</span><br>Accept-Ranges: bytes<br>Content-Length: 22<br>Content-Type: text/html; charset=UTF-8<br><br>[root@centos8 ~]<span class="hljs-comment"># yum install -y nginx</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl start nginx</span><br>[root@centos8 ~]<span class="hljs-comment"># curl 10.0.0.18/index.html -I</span><br>HTTP/1.1 200 OK<br>Server: nginx/1.14.1<br>Date: Mon, 09 Aug 2021 03:35:08 GMT<br>Content-Type: text/html<br>Content-Length: 4057<br>Last-Modified: Mon, 07 Oct 2019 21:16:24 GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;5d9bab28-fd9&quot;</span><br>Accept-Ranges: bytes<br><br><span class="hljs-comment">#浏览器的设置默认不是UTF-8,可能会导致乱码</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat35.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat36.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html">#修改网页指定编码<br>[root@centos8 ~]# vim /usr/local/tomcat/webapps/ROOT/index.html<br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">Content-Type</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;text/html;charset=utf-8&quot;</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>总队长<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat37.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-4-2-JSP-WebApp目录结构"><a href="#3-4-2-JSP-WebApp目录结构" class="headerlink" title="3.4.2 JSP WebApp目录结构"></a>3.4.2 JSP WebApp目录结构</h3><p><strong>$CATALINA_BASE</strong>/webapps下面的每个目录对应的WebApp,可能有以下子目录,但下面子目录是非必须的</p>
<ul>
<li>主页配置：默认按以下顺序查找主页文件 index.html，index.htm、index.jsp</li>
<li>WEB-INF/：当前目录WebApp的私有资源路径，通常存储当前应用使用的web.xml和context.xml配置文件</li>
<li>META-INF/：类似于WEB-INF，也是私有资源的配置信息，和WEB-INF/目录一样浏览器无法访问</li>
<li>classes/：类文件，当前webapp需要的类</li>
<li>lib/：当前应用依赖的jar包</li>
</ul>
<h3 id="3-4-3-主页设置"><a href="#3-4-3-主页设置" class="headerlink" title="3.4.3 主页设置"></a>3.4.3 主页设置</h3><h4 id="3-4-3-1-全局配置实现修改默认主页文件"><a href="#3-4-3-1-全局配置实现修改默认主页文件" class="headerlink" title="3.4.3.1 全局配置实现修改默认主页文件"></a>3.4.3.1 全局配置实现修改默认主页文件</h4><p>默认情况下 tomcat 会在$CATALINA_BASE/webapps/ROOT/目录下按以下次序查找文件,找到第一个则进行显示</p>
<ul>
<li>index.html</li>
<li>index.htm</li>
<li>index.jsp</li>
</ul>
<p>可以通过修改 $CATALINA_BASE/conf/web.xml 中的下面 <welcome-file-list>标签 内容修改默认页文件</p>
<p>范例: 修改默认主页文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment">#pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat<br>[root@centos8 tomcat]<span class="hljs-comment"># echo &#x27;&lt;h1&gt;www.lin.org&lt;/h1&gt;&#x27; &gt; webapps/ROOT/index.html</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://127.0.0.1:8080/</span><br>&lt;h1&gt;www.lin.org&lt;/h1&gt;<br><br>[root@centos8 tomcat]<span class="hljs-comment"># tail conf/web.xml</span><br>  &lt;!-- here, so be sure to include any of the default values that you wish  --&gt;<br>  &lt;!-- to use within your application.                                       --&gt;<br><br>    &lt;welcome-file-list&gt;<br>        &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;<br>        &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;<br>        &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;<br>    &lt;/welcome-file-list&gt;<br><br>&lt;/web-app&gt;<br>[root@centos8 tomcat]<span class="hljs-comment"># vim conf/web.xml</span><br>[root@centos8 tomcat]<span class="hljs-comment"># tail conf/web.xml</span><br>&lt;!-- here, so be sure to include any of the default values that you wish  --&gt;<br>&lt;!-- to use within your application.                    --&gt;<br> <br> &lt;welcome-file-list&gt;<br>   &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;<br>   &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;<br>   &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;<br> &lt;/welcome-file-list&gt;<br>&lt;/web-app&gt;<br><br>[root@centos8 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://127.0.0.1:8080/</span><br><br><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>    &lt;head&gt;<br>        &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;<br>        &lt;title&gt;Apache Tomcat/8.5.50&lt;/title&gt;<br>        &lt;link href=<span class="hljs-string">&quot;favicon.ico&quot;</span> rel=<span class="hljs-string">&quot;icon&quot;</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;image/x-icon&quot;</span> /&gt;<br>        &lt;link href=<span class="hljs-string">&quot;favicon.ico&quot;</span> rel=<span class="hljs-string">&quot;shortcut icon&quot;</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;image/x-icon&quot;</span> /&gt;<br>        &lt;link href=<span class="hljs-string">&quot;tomcat.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;text/css&quot;</span> /&gt;<br>    &lt;/head&gt;<br>    ......<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-3-2-WebApp的专用配置文件"><a href="#3-4-3-2-WebApp的专用配置文件" class="headerlink" title="3.4.3.2 WebApp的专用配置文件"></a>3.4.3.2 WebApp的专用配置文件</h4><p>将上面主配置文件conf/web.xml中的 <welcome-file-list>标签 内容，复制到/usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml中，如下所示:</p>
<p>范例: 针对主站点根目录设置专用配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@centos8 tomcat]# vim webapps/ROOT/WEB-INF/web.xml<br>[root@centos8 tomcat]#cat webapps/ROOT/WEB-INF/web.xml<br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee</span></span><br><span class="hljs-string"><span class="hljs-tag">                             http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.1&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">metadata-complete</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Welcome to Tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span><br>        Welcome to Tomcat<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span>  #修改三个文件的顺序<br>        <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.htm<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br>#配置修改后，无需重启tomcat服务，即可观察首页变化<br>[root@centos8 tomcat]# curl http://127.0.0.1:8080/<br></code></pre></td></tr></table></figure>

<p>范例: 针对特定APP目录设置专用配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment"># mkdir webapps/rlin/</span><br>[root@centos8 tomcat]<span class="hljs-comment"># cp -a webapps/ROOT/WEB-INF/ webapps/rlin/</span><br>[root@centos8 tomcat]<span class="hljs-comment"># echo /usr/local/tomcat/webapps/rlin/test.html &gt; webapps/rlin/test.html</span><br><br>[root@centos8 tomcat]<span class="hljs-comment"># tree webapps/rlin/</span><br>webapps/rlin/<br>├── index.htm<br>├── index.html<br>├── test.html<br>└── WEB-INF<br> └── web.xml<br><br>1 directory, 4 files<br><br>[root@centos8 tomcat]<span class="hljs-comment"># vim webapps/rlin/WEB-INF/web.xml</span><br>......<br>&lt;description&gt;<br>  Welcome to Tomcat<br>&lt;/description&gt;<br> &lt;welcome-file-list&gt;<br> &lt;welcome-file&gt;test.html&lt;/welcome-file&gt;  <span class="hljs-comment">#修改默认页面文件的顺序</span><br> &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;<br> &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;<br> &lt;/welcome-file-list&gt;<br>&lt;/web-app&gt;<br><br><span class="hljs-comment">#注意修改属性</span><br>[root@centos8 tomcat]<span class="hljs-comment"># chown -R tomcat.tomcat webapps/rlin/</span><br><span class="hljs-comment">#记得修改hosts配置再访问</span><br>[root@centos7 ~]<span class="hljs-comment"># curl http://www.rlin.org:8080/rlin/ </span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/rlin/test.html<br></code></pre></td></tr></table></figure>

<p><strong>配置规则：</strong></p>
<ul>
<li>webApp的专有配置优先于系统的全局配置</li>
<li>修改系统的全局配置文件，需要重新启动服务生效</li>
<li>修改 webApp的专有配置，无需重启即可生效</li>
</ul>
<h3 id="3-4-4-应用部署实现"><a href="#3-4-4-应用部署实现" class="headerlink" title="3.4.4 应用部署实现"></a>3.4.4 应用部署实现</h3><h4 id="3-4-4-1-WebApp应用的归档格式"><a href="#3-4-4-1-WebApp应用的归档格式" class="headerlink" title="3.4.4.1 WebApp应用的归档格式"></a>3.4.4.1 WebApp应用的归档格式</h4><ul>
<li>.war：WebApp打包,类zip格式文件,通常包括一个应用的所有资源,比如jsp,html,配置文件等</li>
<li>.jar：EJB类文件的打包压缩类zip格式文件，,包括很多的class文件, 网景公司发明</li>
<li>.rar：资源适配器类打包文件，目前已不常用</li>
<li>.ear：企业级WebApp打包，目前已不常用 </li>
</ul>
<p>传统应用开发测试后，通常打包为war格式，这种文件部署到Tomcat的webapps目录下，并默认会自<br>动解包展开和部署上线。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#conf/server.xml中文件配置</span><br>&lt;Host name=<span class="hljs-string">&quot;localhost&quot;</span>  appBase=<span class="hljs-string">&quot;webapps&quot;</span> unpackWARs=<span class="hljs-string">&quot;true&quot;</span> autoDeploy=<span class="hljs-string">&quot;true&quot;</span>&gt;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-2-部署方式"><a href="#3-4-4-2-部署方式" class="headerlink" title="3.4.4.2 部署方式"></a>3.4.4.2 部署方式</h4><ul>
<li><p>部署Deploy：将webapp的源文件放置到目标目录，通过web.xml和context.xml文件中配置的路径就可以访问该webapp，通过类加载器加载其特有的类和依赖的类到JVM上，即：最终用户可以通过浏览器访问该应用</p>
<ul>
<li><p>自动部署：Tomcat一旦发现多了一个web应用APP.war包，默认会自动把它解压缩，加载并<br>启动起来</p>
</li>
<li><p>手动部署</p>
<ul>
<li><p>冷部署：将webapp放到指定目录，才去启动Tomcat服务</p>
</li>
<li><p>热部署：Tomcat服务不停止，需要依赖manager、ant脚本、tcd（tomcat client<br>deployer）等工具</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>反部署undeploy：停止webapp运行，并从JVM上清除已经加载的类，从Tomcat应用目录中移除部署的文件</p>
</li>
<li><p>启动start：是webapp能够访问</p>
</li>
<li><p>停止stop：webapp不能访问，不能提供服务，但是JVM并不清除它</p>
</li>
</ul>
<h4 id="3-4-4-3-部署WebApp的目录结构"><a href="#3-4-4-3-部署WebApp的目录结构" class="headerlink" title="3.4.4.3 部署WebApp的目录结构"></a>3.4.4.3 部署WebApp的目录结构</h4><p>常见开发项目目录组成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#目录结构一般由开发用工具自动生成，以下模拟生成相关目录</span><br>mkdir projects/myapp/&#123;WEB-INF,META-INF,classes,lib&#125; -pv<br>mkdir: 已创建目录 <span class="hljs-string">&quot;projects&quot;</span><br>mkdir: 已创建目录 <span class="hljs-string">&quot;projects/myapp&quot;</span><br>mkdir: 已创建目录 <span class="hljs-string">&quot;projects/myapp/WEB-INF&quot;</span><br>mkdir: 已创建目录 <span class="hljs-string">&quot;projects/myapp/META-INF&quot;</span><br>mkdir: 已创建目录 <span class="hljs-string">&quot;projects/myapp/classes&quot;</span><br>mkdir: 已创建目录 <span class="hljs-string">&quot;projects/myapp/lib&quot;</span><br><br><span class="hljs-comment">#常见应用首页，内容就用前面的test.jsp内部</span><br>vi projects/myapp/index.jsp<br><br><span class="hljs-comment">#手动复制项目目录到webapps目录下去</span><br>cp -r projects/myapp/ /usr/<span class="hljs-built_in">local</span>/tomcat/webapps/<br><br><span class="hljs-comment">#注意权限和属性</span><br>chown -R tomcat.tomcat /usr/<span class="hljs-built_in">local</span>/tomcat/webapps/myapp<br><br><span class="hljs-comment">#访问http://YourIP:8080/myapp/</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-4-实战案例：手动的应用部署"><a href="#3-4-4-4-实战案例：手动的应用部署" class="headerlink" title="3.4.4.4 实战案例：手动的应用部署"></a>3.4.4.4 实战案例：手动的应用部署</h4><h5 id="3-4-4-4-1-部署主页目录下的应用WebApp"><a href="#3-4-4-4-1-部署主页目录下的应用WebApp" class="headerlink" title="3.4.4.4.1 部署主页目录下的应用WebApp"></a>3.4.4.4.1 部署主页目录下的应用WebApp</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment">#pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat<br>[root@centos8 tomcat]<span class="hljs-comment"># vim webapps/ROOT/test.jsp</span><br>[root@centos8 tomcat]<span class="hljs-comment"># cat webapps/ROOT/test.jsp</span><br>&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span><br>    pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>    &lt;head&gt;<br>        &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br>        &lt;title&gt;jsp例子&lt;/title&gt;<br>    &lt;/head&gt;<br>    &lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>&lt;%<br>        out.println(<span class="hljs-string">&quot;hello jsp&quot;</span>);<br>%&gt;<br>        &lt;br&gt;<br>        &lt;%=request.getRequestURL()%&gt;<br>    &lt;/body&gt;<br>&lt;/html&gt;<br><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://127.0.0.1:8080/test.jsp</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>    &lt;head&gt;<br>        &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br>        &lt;title&gt;jsp例子&lt;/title&gt;<br>    &lt;/head&gt;<br>    &lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>hello jsp<br><br>        &lt;br&gt;<br>        http://127.0.0.1:8080/test.jsp<br>    &lt;/body&gt;<br>&lt;/html&gt;<br><br>[root@centos8 tomcat]<span class="hljs-comment"># tree work/Catalina/localhost/ROOT/</span><br>work/Catalina/localhost/ROOT/<br>└── org<br> └── apache<br>   └── jsp<br>     ├── test_jsp.class<br>     └── test_jsp.java<br><br>3 directories, 2 files<br>[root@centos8 tomcat]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-4-4-2-部署一个子目录的应用WebApp"><a href="#3-4-4-4-2-部署一个子目录的应用WebApp" class="headerlink" title="3.4.4.4.2 部署一个子目录的应用WebApp"></a>3.4.4.4.2 部署一个子目录的应用WebApp</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat<br>[root@centos8 tomcat]<span class="hljs-comment"># mkdir webapps/app1/</span><br><br><span class="hljs-comment">#利用之前实验的文件生成新应用</span><br>[root@centos8 tomcat]<span class="hljs-comment"># cp -p webapps/ROOT/test.jsp webapps/app1/</span><br>[root@centos8 tomcat]<span class="hljs-comment"># chown -R tomcat.tomcat webapps/app1/</span><br>[root@centos8 tomcat]<span class="hljs-comment"># tree webapps/app1/</span><br>webapps/testapp1/<br>└── test.jsp<br><br>0 directories, 1 file<br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://127.0.0.1:8080/app1/test.jsp</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>    &lt;head&gt;<br>        &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br>        &lt;title&gt;jsp例子&lt;/title&gt;<br>    &lt;/head&gt;<br>    &lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>hello jsp<br><br>        &lt;br&gt;<br>        http://127.0.0.1:8080/app1/test.jsp<br>    &lt;/body&gt;<br>&lt;/html&gt;<br>[root@centos8 tomcat]<span class="hljs-comment"># tree work/Catalina/localhost/app1/</span><br>work/Catalina/localhost/app1/<br>└── org<br> └── apache<br>   └── jsp<br>     ├── test_jsp.class<br>     └── test_jsp.java<br>     <br>3 directories, 2 files<br>[root@centos8 tomcat]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#删除应用，在删除webapps里的文件夹后，系统会自动删除work/Catalina/licalhost/里相应的文件夹</span><br>[root@centos8 tomcat]<span class="hljs-comment"># rm -rf webapps/app1/</span><br>[root@centos8 tomcat]<span class="hljs-comment"># ls webapps/</span><br>docs examples host-manager manager ROOT<br>[root@centos8 tomcat]<span class="hljs-comment"># ls work/Catalina/localhost/</span><br>docs examples host-manager manager ROOT<br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-5-实战案例：自动的应用部署war包"><a href="#3-4-4-5-实战案例：自动的应用部署war包" class="headerlink" title="3.4.4.5 实战案例：自动的应用部署war包"></a>3.4.4.5 实战案例：自动的应用部署war包</h4><h5 id="3-4-4-5-1-制作应用的war包文件"><a href="#3-4-4-5-1-制作应用的war包文件" class="headerlink" title="3.4.4.5.1 制作应用的war包文件"></a>3.4.4.5.1 制作应用的war包文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># mkdir /data/app2/</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /data/app2/test.html</span><br>&lt;h1&gt;This is <span class="hljs-built_in">test</span> html &lt;/h1&gt;<br>[root@centos8 ~]<span class="hljs-comment">#cat /data/app2/test.jsp</span><br>&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>&lt;%<br>out.println(<span class="hljs-string">&quot;test jsp&quot;</span>);<br>%&gt;<br>&lt;br&gt;<br>&lt;%=request.getRequestURL()%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@centos8 ~]<span class="hljs-comment"># ls /data/app2/</span><br>test.html test.jsp<br>[root@centos8 ~]<span class="hljs-comment"># cd /data/app2/</span><br><br><span class="hljs-comment">#生成war包文件app2.war,此文件的名称决定了tomcat子目录的名称</span><br>[root@centos8 app2]<span class="hljs-comment"># jar cvf /data/app2.war *</span><br>added manifest<br>adding: test.html(<span class="hljs-keyword">in</span> = 28) (out= 27)(deflated 3%)<br>adding: test.jsp(<span class="hljs-keyword">in</span> = 329) (out= 275)(deflated 16%)<br>[root@centos8 app2]<span class="hljs-comment"># cd /data/app2/</span><br>[root@centos8 app2]<span class="hljs-comment"># ls</span><br>test.html test.jsp<br>[root@centos8 app2]<span class="hljs-comment"># cd /data/</span><br>[root@centos8 data]<span class="hljs-comment"># ls</span><br>app2 app2.war<br>[root@centos8 data]<span class="hljs-comment"># file app2.war</span><br>app2.war: Java archive data (JAR)<br>[root@centos8 data]<span class="hljs-comment"># chown tomcat.tomcat /data/app2.war</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-4-5-2-自动应用部署上面的war包"><a href="#3-4-4-5-2-自动应用部署上面的war包" class="headerlink" title="3.4.4.5.2 自动应用部署上面的war包"></a>3.4.4.5.2 自动应用部署上面的war包</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat<br>[root@centos8 tomcat]<span class="hljs-comment"># ls webapps/</span><br>docs examples host-manager manager ROOT<br>[root@centos8 tomcat]<span class="hljs-comment"># ls work/Catalina/localhost/</span><br>docs examples host-manager manager ROOT<br>[root@centos8 tomcat]<span class="hljs-comment"># cp -p /data/app2.war webapps/</span><br><br><span class="hljs-comment">#再次查看，tomcat将app2.war自动解压缩</span><br>[root@centos8 tomcat]<span class="hljs-comment"># ll webapps/</span><br>total 8<br>drwxr-x--- 15 tomcat tomcat 4096 Feb  9 11:02 docs<br>drwxr-x---  6 tomcat tomcat   83 Feb  9 11:02 examples<br>drwxr-x---  5 tomcat tomcat   87 Feb  9 11:02 host-manager<br>drwxr-x---  5 tomcat tomcat  103 Feb  9 11:02 manager<br>drwxr-x---  3 tomcat tomcat  300 Feb  9 19:59 ROOT<br>drwxr-x---  3 tomcat tomcat   55 Feb  9 20:14 app2<br>-rw-r--r--  1 tomcat tomcat  862 Feb  9 20:05 app2.war<br>[root@centos8 tomcat]<span class="hljs-comment"># ll webapps/app2</span><br>total 8<br>drwxr-x--- 2 tomcat tomcat  44 Feb  9 20:14 META-INF<br>-rw-r----- 1 tomcat tomcat  28 Feb  9 20:03 test.html<br>-rw-r----- 1 tomcat tomcat 329 Aug 30 02:30 test.jsp<br><br><span class="hljs-comment">#work目录会自动生成对应的app2的子目录，但目录内无内容</span><br>[root@centos8 tomcat]<span class="hljs-comment"># tree work/Catalina/localhost/app2/</span><br>work/Catalina/localhost/app2/<br><br>0 directories, 0 files<br><br><span class="hljs-comment">#访问jsp文件后，tomcat会自动将jsp转换和编译生成work目录下对应的java和class文件</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://127.0.0.1:8080/app2/test.jsp</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>hello jsp<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br><br>[root@centos8 tomcat]<span class="hljs-comment"># tree work/Catalina/localhost/app2/</span><br>work/Catalina/localhost/app2/<br>└── org<br> └── apache<br>   └── jsp<br>     ├── test_jsp.class<br>     └── test_jsp.java<br>     <br>3 directories, 2 files<br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://127.0.0.1:8080/app2/test.html</span><br>&lt;h1&gt;This is <span class="hljs-built_in">test</span> html &lt;/h1&gt;<br>[root@centos8 tomcat]<span class="hljs-comment"># tree work/Catalina/localhost/app2/</span><br>work/Catalina/localhost/estapp2/<br>└── org<br> └── apache<br>   └── jsp<br>     ├── test_jsp.class<br>     └── test_jsp.java<br><br>3 directories, 2 files<br><br><span class="hljs-comment">#自动删除（反部署）</span><br><span class="hljs-comment">#[root@centos8 tomcat]# rm -f webapps/app2.war </span><br>[root@centos8 tomcat]<span class="hljs-comment"># ls webapps/</span><br>docs examples host-manager manager ROOT app2<br><span class="hljs-comment">#过几秒再查看，发现app2目录也随之删除</span><br>[root@centos8 tomcat]<span class="hljs-comment"># ls webapps/</span><br>docs examples host-manager manager ROOT<br>[root@centos8 tomcat]<span class="hljs-comment"># ls webapps/</span><br>docs examples host-manager manager ROOT<br>[root@centos8 tomcat]<span class="hljs-comment"># ls work/Catalina/localhost/</span><br>docs examples host-manager manager ROOT<br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-6-实站案例-部署基于JAVA的博客系统-JPress"><a href="#3-4-4-6-实站案例-部署基于JAVA的博客系统-JPress" class="headerlink" title="3.4.4.6 实站案例: 部署基于JAVA的博客系统 JPress"></a>3.4.4.6 实站案例: 部署基于JAVA的博客系统 JPress</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先下载Jpress，链接: https://pan.baidu.com/s/1DHKY5xBbcNPltJ3VZiBz8g 提取码: im4m</span><br>[root@centos8 ~]<span class="hljs-comment"># cd /usr/local/tomcat/webapps/</span><br>[root@centos8 webapps]<span class="hljs-comment">#ls</span><br>docs examples host-manager jpress-v3.2.1.war manager ROOT<br><br><span class="hljs-comment">#自动解压缩生成jpress-v3.2.1目录</span><br>[root@centos8 webapps]<span class="hljs-comment">#ls</span><br>docs examples host-manager jpress-v3.2.1 jpress-v3.2.1.war manager ROOT<br><br><span class="hljs-comment">#生成软链接</span><br>[root@centos8 webapps]<span class="hljs-comment"># ln -s jpress-v3.2.1 jpress</span><br>[root@centos8 webapps]<span class="hljs-comment"># ls</span><br>docs examples host-manager jpress jpress-v3.2.1 jpress-v3.2.1.war manager<br>ROOT<br>[root@centos8 webapps]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#准备数据库和用户授权</span><br>[root@centos8 ~]<span class="hljs-comment"># yum -y install mysql-server</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable --now mysqld</span><br>[root@centos8 ~]<span class="hljs-comment"># mysql</span><br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection id is 8<br>Server version: 8.0.21 Source distribution<br><br>Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; create user jpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>mysql&gt; create database jpress;<br>mysql&gt; grant all on jpress.* to jpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>访问ip:8080/jpress</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat38.png" srcset="/blog/img/loading.gif" alt="点击下一步"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat39.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat40.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat41.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat42.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat43.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat44.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat45.png" srcset="/blog/img/loading.gif"></p>
<p>上传的图片存放路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 webapps]<span class="hljs-comment"># tree jpress/attachment/</span><br>jpress/attachment/<br>└── 20210110<br> └── 2169440a4e75459d8a420f4b245565d4.jpg<br><br>1 directory, 1 file<br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-7-基于WEB的管理Server-status和Manager-APP实现应用部署"><a href="#3-4-4-7-基于WEB的管理Server-status和Manager-APP实现应用部署" class="headerlink" title="3.4.4.7 基于WEB的管理Server status和Manager APP实现应用部署"></a>3.4.4.7 基于WEB的管理Server status和Manager APP实现应用部署</h4><p>tomcat 提供了基于WEB的管理页面,默认由 tomcat-admin-webapps.noarch包提供相关文件</p>
<h5 id="3-4-4-7-1-实现WEB的管理Server-status和Manager-APP"><a href="#3-4-4-7-1-实现WEB的管理Server-status和Manager-APP" class="headerlink" title="3.4.4.7.1 实现WEB的管理Server status和Manager APP"></a>3.4.4.7.1 实现WEB的管理Server status和Manager APP</h5><p>打开浏览器可以访问tomcat管理的默认管理页面，点击下图两个按钮都会出现下面提示403的错误提示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat46.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat47.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat48.png" srcset="/blog/img/loading.gif"></p>
<p><strong>默认的管理页面被禁用，启用方法如下</strong></p>
<ul>
<li><strong>修改conf/conf/tomcat-users.xml</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment">#ls conf/</span><br>Catalina       context.xml      logging.properties tomcat-users.xml<br>catalina.policy   jaspic-providers.xml server.xml     tomcat-users.xsd<br>catalina.properties jaspic-providers.xsd tomcat.conf     web.xml<br><br><span class="hljs-comment">#查看配置信息</span><br>[root@centos8 tomcat]<span class="hljs-comment"># cat conf/server.xml</span><br>&lt;GlobalNamingResources&gt;<br> &lt;!-- Editable user database that can also be used by<br>    UserDatabaseRealm to authenticate users<br>  --&gt;<br> &lt;Resource name=<span class="hljs-string">&quot;UserDatabase&quot;</span> auth=<span class="hljs-string">&quot;Container&quot;</span><br>       <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;org.apache.catalina.UserDatabase&quot;</span><br>       description=<span class="hljs-string">&quot;User database that can be updated and saved&quot;</span><br>       factory=<span class="hljs-string">&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span><br>       pathname=<span class="hljs-string">&quot;conf/tomcat-users.xml&quot;</span> /&gt;  <span class="hljs-comment">#由此文件指定授权用户信息</span><br>&lt;/GlobalNamingResources&gt;<br></code></pre></td></tr></table></figure>

<p>用户认证，配置文件是conf/tomcat-users.xml。打开tomcat-users.xml，我们需要一个角色manager-gui。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment"># vim conf/tomcat-users.xml</span><br>&lt;tomcat-users xmlns=<span class="hljs-string">&quot;http://tomcat.apache.org/xml&quot;</span><br>      xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>      xsi:schemaLocation=<span class="hljs-string">&quot;http://tomcat.apache.org/xml tomcat-users.xsd&quot;</span><br>       version=<span class="hljs-string">&quot;1.0&quot;</span>&gt;<br><span class="hljs-comment">#加下面两行，指定用户和密码</span><br>&lt;role rolename=<span class="hljs-string">&quot;manager-gui&quot;</span>/&gt;<br>&lt;user username=<span class="hljs-string">&quot;admin&quot;</span> password=<span class="hljs-string">&quot;123456&quot;</span> roles=<span class="hljs-string">&quot;manager-gui&quot;</span>/&gt;<br>......<br>&lt;/tomcat-users&gt;<br><br><span class="hljs-comment">#修改全局配置文件需要重启服务生效</span><br>[root@centos8 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br></code></pre></td></tr></table></figure>

<ul>
<li><strong>修改webapps/manager/META-INF/context.xml</strong></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">antiResourceLocking</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">privileged</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">allow</span>=<span class="hljs-string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot;</span> /&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">Manager</span> <span class="hljs-attr">sessionAttributeValueClassNameFilter</span>=<span class="hljs-string">&quot;java\.lang\.</span></span><br><span class="hljs-string"><span class="hljs-tag">(?:Boolean|Integer|Long|Number|String)|org\.apache\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>查看正则表达式就知道是本地访问了，由于当前访问地址是192.168.x.x，可以修改正则表达式为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">allow=<span class="hljs-string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|192\.168\.\d+\.\d+&quot;</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@centos8 tomcat]#vim webapps/manager/META-INF/context.xml<br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">antiResourceLocking</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">privileged</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">allow</span>=<span class="hljs-string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10\.0\.0\.\d+&quot;</span> /&gt;</span> #在最后添加有关本机的ip地址段在正则表达式<br><span class="hljs-tag">&lt;<span class="hljs-name">Manager</span> <span class="hljs-attr">sessionAttributeValueClassNameFilter</span>=<span class="hljs-string">&quot;java\.lang\.(?:Boolean|Integer|Long|Number|String)|org\.apache\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br><br>#修改WebApp的配置无需重启服务即可生效<br></code></pre></td></tr></table></figure>

<ul>
<li>再次通过浏览器访问两个按钮Server Status和Manager App，可以看到以下管理界面，输入前面<br>的用户和密码进行登录</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat49.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat50.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat51.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-4-4-7-2-基于WEB应用程序管理器实现APP的部署"><a href="#3-4-4-7-2-基于WEB应用程序管理器实现APP的部署" class="headerlink" title="3.4.4.7.2 基于WEB应用程序管理器实现APP的部署"></a>3.4.4.7.2 基于WEB应用程序管理器实现APP的部署</h5><p>Web 应用程序管理界面可以实现以下功能</p>
<p>Applications 应用程序管理，可以启动、停止、重加载、反部署、清理过期session</p>
<p>Deploy 可以热部署，也可以部署war文件。<br><strong>方式1: 指定目录部署软件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># mkdir -p /data/myapp/</span><br>[root@centos8 ~]<span class="hljs-comment"># echo /data/myapp/index.html &gt; /data/myapp/index.html</span><br><br><span class="hljs-comment">#按下面信息添写,实现下面链接的访问</span><br>http://10.0.0.201:8080/test1/<br></code></pre></td></tr></table></figure>

<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Context</span> <span class="hljs-built_in">Path</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">required</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span> 指定通过浏览器访问的虚拟目录<br><span class="hljs-variable">WAR</span> <span class="hljs-variable">or</span> <span class="hljs-built_in">Directory</span> <span class="hljs-built_in">URL</span>：指定真正存放文件的实际磁盘目录路径<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat52.png" srcset="/blog/img/loading.gif" alt="先在这里部署"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat53.png" srcset="/blog/img/loading.gif" alt="后访问"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#自动将/data/myapp目录下的数据复制到webapps/test1下面</span><br>[root@centos8 ~]<span class="hljs-comment"># tree /usr/local/tomcat/webapps/test1/</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/test1/<br>└── index.html<br><br>0 directories, 1 file<br><br>[root@centos8 ~]<span class="hljs-comment"># cat /usr/local/tomcat/webapps/test1/index.html</span><br>/data/myapp/index.html<br></code></pre></td></tr></table></figure>

<p><strong>方式2: 部署war包文件</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat54.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat55.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-4-5-常见配置详解"><a href="#3-4-5-常见配置详解" class="headerlink" title="3.4.5 常见配置详解"></a>3.4.5 常见配置详解</h3><h4 id="3-4-5-1-端口8005-tcp-安全配置管理"><a href="#3-4-5-1-端口8005-tcp-安全配置管理" class="headerlink" title="3.4.5.1 端口8005/tcp 安全配置管理"></a>3.4.5.1 端口8005/tcp 安全配置管理</h4><p>在conf/server.xml 有以下内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Server</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8005&quot;</span> <span class="hljs-attr">shutdown</span>=<span class="hljs-string">&quot;SHUTDOWN&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Service</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Connector</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8080&quot;</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;HTTP/1.1&quot;</span> </span><br><span class="hljs-tag">                   <span class="hljs-attr">connectionTimeout</span>=<span class="hljs-string">&quot;20000&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">redirectPort</span>=<span class="hljs-string">&quot;8443&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Connector</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8009&quot;</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;AJP/1.3&quot;</span> <span class="hljs-attr">redirectPort</span>=<span class="hljs-string">&quot;8443&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Engine</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span> <span class="hljs-attr">defaultHost</span>=<span class="hljs-string">&quot;localhost&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;localhost&quot;</span>  <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;webapps&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">unpackWARs</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">Engine</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Service</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Server</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xaml">&lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt;<br></code></pre></td></tr></table></figure>

<p>8005是Tomcat的管理端口，默认监听在127.0.0.1上。无需验证就可发送SHUTDOWN (大小写敏感)这个字符串，tomcat接收到后就会关闭此Server。</p>
<p><strong>此管理功能建议禁用，可将SHUTDOWN改为一串猜不出的字符串实现或者port修改成 0, 会使用随机端口,如:36913</strong></p>
<p><strong>port设为-1等无效端口,将关闭此功能</strong></p>
<p><strong>此行不能被注释,否则无法启动tomcat服务</strong></p>
<p>范例:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Server</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8005&quot;</span> <span class="hljs-attr">shutdown</span>=<span class="hljs-string">&quot;44ba3c71d57f494992641b258b965f28&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>范例：修改8005/tcp端口管理命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install telnet</span><br>[root@centos8 ~]<span class="hljs-comment"># ss -ntl</span><br>State          Recv-Q         Send-Q                        Local Address:Port                    Peer Address:Port         <br>LISTEN         0              128                                 0.0.0.0:22                           0.0.0.0:*            <br>LISTEN         0              5                                 127.0.0.1:631                          0.0.0.0:*            <br>LISTEN         0              128                                 0.0.0.0:111                          0.0.0.0:*            <br>LISTEN         0              128                                 0.0.0.0:80                           0.0.0.0:*            <br>LISTEN         0              128                                    [::]:22                              [::]:*            <br>LISTEN         0              5                                     [::1]:631                             [::]:*            <br>LISTEN         0              70                                        *:33060                              *:*            <br>LISTEN         0              1                        [::ffff:127.0.0.1]:8005                               *:*            <br>LISTEN         0              100                                       *:8009                               *:*            <br>LISTEN         0              128                                       *:3306                               *:*            <br>LISTEN         0              128                                    [::]:111                             [::]:*            <br>LISTEN         0              100                                       *:8080                               *:*            <br>LISTEN         0              128                                    [::]:80                              [::]:*<br><br>[root@centos8 ~]<span class="hljs-comment"># telnet 127.0.0.1 8005</span><br>Trying 127.0.0.1...<br>Connected to 127.0.0.1.<br>Escape character is <span class="hljs-string">&#x27;^]&#x27;</span>.<br>SHUTDOWN <span class="hljs-comment">#执行命令关闭tomcat</span><br>Connection closed by foreign host.<br><br>[root@centos8 ~]<span class="hljs-comment">#ss -ntl</span><br>State           Recv-Q          Send-Q                   Local Address:Port                      Peer Address:Port          <br>LISTEN          0               128                            0.0.0.0:22                             0.0.0.0:*             <br>LISTEN          0               5                            127.0.0.1:631                            0.0.0.0:*             <br>LISTEN          0               128                            0.0.0.0:111                            0.0.0.0:*             <br>LISTEN          0               128                            0.0.0.0:80                             0.0.0.0:*             <br>LISTEN          0               128                               [::]:22                                [::]:*             <br>LISTEN          0               5                                [::1]:631                               [::]:*             <br>LISTEN          0               70                                   *:33060                                *:*             <br>LISTEN          0               128                                  *:3306                                 *:*             <br>LISTEN          0               128                               [::]:111                               [::]:*             <br>LISTEN          0               128                               [::]:80                                [::]:*<br>      <br>[root@centos8 tomcat]<span class="hljs-comment"># vim conf/server.xml</span><br>&lt;Server port=<span class="hljs-string">&quot;8005&quot;</span> shutdown=<span class="hljs-string">&quot;rlin&quot;</span>&gt;<br>[root@centos8 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@centos8 tomcat]<span class="hljs-comment"># telnet 127.0.0.1 8005</span><br>Trying 127.0.0.1...<br>Connected to 127.0.0.1.<br>Escape character is <span class="hljs-string">&#x27;^]&#x27;</span>.<br>SHUTDOWN<br>Connection closed by foreign host.<br>[root@centos8 tomcat]<span class="hljs-comment">#ss -ntl</span><br>State           Recv-Q          Send-Q                   Local Address:Port                      Peer Address:Port          <br>LISTEN          0               128                            0.0.0.0:22                             0.0.0.0:*             <br>LISTEN          0               5                            127.0.0.1:631                            0.0.0.0:*             <br>LISTEN          0               128                            0.0.0.0:111                            0.0.0.0:*             <br>LISTEN          0               128                            0.0.0.0:80                             0.0.0.0:*             <br>LISTEN          0               128                               [::]:22                                [::]:*             <br>LISTEN          0               5                                [::1]:631                               [::]:*             <br>LISTEN          0               70                                   *:33060                                *:*             <br>LISTEN          0               100                                  *:8009                                 *:*             <br>LISTEN          0               128                                  *:3306                                 *:*             <br>LISTEN          0               128                               [::]:111                               [::]:*             <br>LISTEN          0               100                                  *:8080                                 *:*             <br>LISTEN          0               128                               [::]:80                                [::]:*<br><br>root@centos8 tomcat]<span class="hljs-comment"># telnet 127.0.0.1 8005</span><br>Trying 127.0.0.1...<br>Connected to 127.0.0.1.<br>Escape character is <span class="hljs-string">&#x27;^]&#x27;</span>.<br>magedu<br>Connection closed by foreign host.<br>[root@centos8 tomcat]<span class="hljs-comment"># ss -ntl</span><br>State          Recv-Q         Send-Q                        Local Address:Port                    Peer Address:Port         <br>LISTEN         0              128                                 0.0.0.0:22                           0.0.0.0:*            <br>LISTEN         0              5                                 127.0.0.1:631                          0.0.0.0:*            <br>LISTEN         0              128                                 0.0.0.0:111                          0.0.0.0:*            <br>LISTEN         0              128                                 0.0.0.0:80                           0.0.0.0:*            <br>LISTEN         0              128                                    [::]:22                              [::]:*            <br>LISTEN         0              5                                     [::1]:631                             [::]:*            <br>LISTEN         0              70                                        *:33060                              *:*            <br>LISTEN         0              1                        [::ffff:127.0.0.1]:8005                               *:*            <br>LISTEN         0              100                                       *:8009                               *:*            <br>LISTEN         0              128                                       *:3306                               *:*            <br>LISTEN         0              128                                    [::]:111                             [::]:*            <br>LISTEN         0              100                                       *:8080                               *:*            <br>LISTEN         0              128                                    [::]:80                              [::]:*<br></code></pre></td></tr></table></figure>

<h4 id="3-4-5-2-显示指定的http服务器版本信息"><a href="#3-4-5-2-显示指定的http服务器版本信息" class="headerlink" title="3.4.5.2 显示指定的http服务器版本信息"></a>3.4.5.2 显示指定的http服务器版本信息</h4><p>默认不显示tomcat的http的Server头信息, 可以指定tomcat的http的Server头信息为相应的值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#conf/server.xml</span><br>&lt;Connector port=<span class="hljs-string">&quot;8080&quot;</span> protocol=<span class="hljs-string">&quot;HTTP/1.1&quot;</span>  connectionTimeout=<span class="hljs-string">&quot;20000&quot;</span><br>redirectPort=<span class="hljs-string">&quot;8443&quot;</span> Server=<span class="hljs-string">&quot;SOME STRING&quot;</span>/&gt;<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># curl -I 127.0.0.1:8080</span><br>HTTP/1.1 200<br>Content-Type: text/html;charset=UTF-8<br>Transfer-Encoding: chunked<br>Date: Fri, 17 Jul 2020 08:32:52 GMT<br><br><span class="hljs-comment">#修改配置,指定想显示的tomcat版本</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /usr/local/tomcat/conf/server.xml</span><br>......<br>&lt;Connector port=<span class="hljs-string">&quot;8080&quot;</span> protocol=<span class="hljs-string">&quot;HTTP/1.1&quot;</span><br>       connectionTimeout=<span class="hljs-string">&quot;20000&quot;</span><br>       redirectPort=<span class="hljs-string">&quot;8443&quot;</span> Server=<span class="hljs-string">&quot;rlin-Server&quot;</span>/&gt; <span class="hljs-comment">#约71行</span><br>......<br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@centos8 ~]<span class="hljs-comment"># curl 127.0.0.1:8080 -I</span><br>HTTP/1.1 200<br>Content-Type: text/html;charset=UTF-8<br>Transfer-Encoding: chunked<br>Date: Fri, 17 Jul 2020 08:34:17 GMT<br>Server: rlin-Server<br></code></pre></td></tr></table></figure>

<h4 id="3-4-5-3-其它配置"><a href="#3-4-5-3-其它配置" class="headerlink" title="3.4.5.3 其它配置"></a>3.4.5.3 其它配置</h4><p>conf/server.xml中可以配置service，connector, Engine,Host等</p>
<ul>
<li>service配置</li>
</ul>
<p>一般情况下，一个Server实例配置一个Service，name属性相当于该Service的ID。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Service</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>连接器配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Connector</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8080&quot;</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;HTTP/1.1&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">connectionTimeout</span>=<span class="hljs-string">&quot;20000&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">redirectPort</span>=<span class="hljs-string">&quot;8443&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>

<p>redirectPort，如果访问HTTPS协议，自动转向这个连接器。但大多数时候，Tomcat并不会开启<br>HTTPS，因为Tomcat往往部署在内部，HTTPS性能较差</p>
<ul>
<li>引擎配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Engine</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span> <span class="hljs-attr">defaultHost</span>=<span class="hljs-string">&quot;localhost&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>defaultHost 配置</li>
</ul>
<p>defaultHost指向内部定义某虚拟主机。缺省虚拟主机可以改动，默认localhost。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;localhost&quot;</span>  <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;webapps&quot;</span> <span class="hljs-attr">unpackWARs</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-5-4-多虚拟主机配置"><a href="#3-4-5-4-多虚拟主机配置" class="headerlink" title="3.4.5.4 多虚拟主机配置"></a>3.4.5.4 多虚拟主机配置</h4><h5 id="3-4-5-4-1-多虚拟主机配置说明"><a href="#3-4-5-4-1-多虚拟主机配置说明" class="headerlink" title="3.4.5.4.1 多虚拟主机配置说明"></a>3.4.5.4.1 多虚拟主机配置说明</h5><ul>
<li>name 必须是主机名，用主机名来匹配</li>
<li>appBase 当前主机的网页根目录，是相对于 $CATALINA_HOME ，也可以使用绝对路径</li>
<li>unpackWARs 是否自动解压war格式</li>
<li>autoDeploy 热部署，自动加载并运行应用</li>
</ul>
<p><strong>虚拟主机配置过程</strong></p>
<ul>
<li>再添加和配置一个新的虚拟主机，并将myapp部署到/data/webapps目录下</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@centos8 ~]# vim conf/server.xml <br>#在上一个<span class="hljs-tag">&lt;<span class="hljs-name">HOST</span>&gt;</span>....<span class="hljs-tag">&lt;/<span class="hljs-name">HOST</span>&gt;</span>文件后面增加下面内容<br><span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;web1.rlin.org&quot;</span> <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps/&quot;</span> <span class="hljs-attr">unpackWARs</span>=<span class="hljs-string">&quot;True&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;false&quot;</span>&gt;</span><br><br>#虚拟主机专有访问日志<br><span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="hljs-attr">directory</span>=<span class="hljs-string">&quot;logs&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">prefix</span>=<span class="hljs-string">&quot;web1_access_log&quot;</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">&quot;.txt&quot;</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;%h %l %u %t <span class="hljs-symbol">&amp;quot;</span>%r<span class="hljs-symbol">&amp;quot;</span> %s</span></span><br><span class="hljs-string"><span class="hljs-tag">%b&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br><br>#以下行是自带的不需要修改<br><span class="hljs-tag">&lt;/<span class="hljs-name">Engine</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Service</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Server</span>&gt;</span><br><br>#或者如果不加日志也可以用下面简化写法<br><span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;web1.rlin.org&quot;</span> <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps/&quot;</span> <span class="hljs-attr">unpackWARs</span>=<span class="hljs-string">&quot;True&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br><br>[root@centos8 ~]# systemctl restart tomcat<br></code></pre></td></tr></table></figure>

<ul>
<li>准备虚拟主机的数据目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">常见虚拟主机根目录<br>[root@centos8 ~]<span class="hljs-comment"># mkdir /data/webapps/ROOT -pv</span><br>[root@centos8 ~]<span class="hljs-comment"># chown -R tomcat.tomcat /data/webapps</span><br>[root@centos8 ~]<span class="hljs-comment"># echo web1.rlin.org &gt; /data/webapps/ROOT/index.html</span><br></code></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<p>刚才在虚拟主机中主机名定义web1.rlin.org，所以需要主机在本机手动配置一个域名解析。</p>
<p>如果是windows，修改在C:\Windows\System32\drivers\etc下的hosts文件，需要管理员权限。</p>
<p>使用<a target="_blank" rel="noopener" href="http://web1.rlin.org:8080/%E8%AE%BF%E9%97%AE%E6%9F%A5%E7%9C%8B">http://web1.rlin.org:8080/访问查看</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#linux主机测试</span><br>[root@centos7 ~]<span class="hljs-comment"># curl web1.rlin.org:8080</span><br>web1.rlin.org<br></code></pre></td></tr></table></figure>

<h5 id="3-4-5-4-2-实战案例：tomcat实现多虚拟主机"><a href="#3-4-5-4-2-实战案例：tomcat实现多虚拟主机" class="headerlink" title="3.4.5.4.2 实战案例：tomcat实现多虚拟主机"></a>3.4.5.4.2 实战案例：tomcat实现多虚拟主机</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat<br>[root@centos8 tomcat]<span class="hljs-comment"># vim conf/server.xml</span><br>[root@centos8 tomcat]<span class="hljs-comment"># tail conf/server.xml</span><br>       pattern=<span class="hljs-string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;<br>  &lt;/Host&gt;<br><span class="hljs-comment">#添加了以下四行</span><br>  &lt;Host name=<span class="hljs-string">&quot;node1.rlin.org&quot;</span> appBase=<span class="hljs-string">&quot;/data/webapps1&quot;</span> npackWARs=<span class="hljs-string">&quot;True&quot;</span><br>              autoDeploy=<span class="hljs-string">&quot;false&quot;</span>&gt;<br>  &lt;/Host&gt;<br>  &lt;Host name=<span class="hljs-string">&quot;node2.rlin.org&quot;</span> appBase=<span class="hljs-string">&quot;/data/webapps2&quot;</span> npackWARs=<span class="hljs-string">&quot;True&quot;</span><br>              autoDeploy=<span class="hljs-string">&quot;false&quot;</span>&gt;<br>  &lt;/Host&gt;<br> &lt;/Engine&gt;<br>&lt;/Service&gt;<br>&lt;/Server&gt;<br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br><br><span class="hljs-comment">#对每个虚拟主机，准备数据</span><br>[root@centos8 ~]<span class="hljs-comment"># mkdir /data/webapps&#123;1,2&#125;/ROOT -pv</span><br>mkdir: created directory <span class="hljs-string">&#x27;/data/webapps1/ROOT&#x27;</span><br>mkdir: created directory <span class="hljs-string">&#x27;/data/webapps2/ROOT&#x27;</span><br><br>[root@centos8 ~]<span class="hljs-comment"># cat /data/webapps1/ROOT/index.jsp</span><br>&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>&lt;br&gt;<br>&lt;%=request.getRequestURL()%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@centos8 ~]<span class="hljs-comment">#cat /data/webapps2/ROOT/index.jsp</span><br>&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>&lt;br&gt;<br>&lt;%=request.getRequestURL()%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@centos8 ~]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#设置权限</span><br>[root@centos8 ~]<span class="hljs-comment"># chown -R tomcat.tomcat /data/webapps&#123;1,2&#125;/</span><br><br><span class="hljs-comment">#准备虚拟主机的名称解析</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4<br>centos8.localdomain<br>::1     localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.0.0.8 node1.rlin.org node2.rlin.org<br><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org:8080/</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>http://node1.magedu.org:8080/<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@centos8 ~]<span class="hljs-comment"># curl http://node2.rlin.org:8080/</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>http://node2.magedu.org:8080/<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-5-5-基于web方式的Host-Manager虚拟主机管理"><a href="#3-4-5-5-基于web方式的Host-Manager虚拟主机管理" class="headerlink" title="3.4.5.5 基于web方式的Host Manager虚拟主机管理"></a>3.4.5.5 基于web方式的Host Manager虚拟主机管理</h4><p>可以通过tomcat的管理页面点下面Host Manager按钮进入管理虚拟主机的页面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat56.png" srcset="/blog/img/loading.gif"></p>
<p>默认Host Manager 管理页被禁用，会出现下面提示，解决方法类似于3.4.4.6</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat57.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-4-5-5-1-允许本机访问"><a href="#3-4-5-5-1-允许本机访问" class="headerlink" title="3.4.5.5.1 允许本机访问"></a>3.4.5.5.1 允许本机访问</h5><p>配置如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@centos8 tomcat]# vim conf/tomcat-users.xml<br><span class="hljs-tag">&lt;<span class="hljs-name">tomcat-users</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://tomcat.apache.org/xml&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://tomcat.apache.org/xml tomcat-users.xsd&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">role</span> <span class="hljs-attr">rolename</span>=<span class="hljs-string">&quot;manager-gui&quot;</span>/&gt;</span> #3.4.4.6添加的内容<br>  <span class="hljs-tag">&lt;<span class="hljs-name">role</span> <span class="hljs-attr">rolename</span>=<span class="hljs-string">&quot;admin-gui&quot;</span> /&gt;</span>  #添加新的role<br>  <span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">username</span>=<span class="hljs-string">&quot;admin&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;123456&quot;</span> <span class="hljs-attr">roles</span>=<span class="hljs-string">&quot;manager-gui,admin-gui&quot;</span>/&gt;</span> #再加新role<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">tomcat-users</span>&gt;</span><br>[root@centos8 tomcat]#systemctl restart tomcat<br></code></pre></td></tr></table></figure>

<p>重启Tomcat后，点击”Host Manager”按钮</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat58.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat59.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-4-5-5-2-允许远程主机访问"><a href="#3-4-5-5-2-允许远程主机访问" class="headerlink" title="3.4.5.5.2 允许远程主机访问"></a>3.4.5.5.2 允许远程主机访问</h5><p>但通过远程访问地址仍无法访问Host Manager管理页面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat60.png" srcset="/blog/img/loading.gif"></p>
<p>默认无法通过网络远程访问Host Manager管理页面，默认会出现以下界面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat61.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment"># vim webapps/host-manager/META-INF/context.xml</span><br>&lt;Context antiResourceLocking=<span class="hljs-string">&quot;false&quot;</span> privileged=<span class="hljs-string">&quot;true&quot;</span> &gt;<br>&lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span><br>    allow=<span class="hljs-string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10\.0\.0\.\d+&quot;</span> /&gt;<br>&lt;Manager sessionAttributeValueClassNameFilter=<span class="hljs-string">&quot;java\.lang\.</span><br><span class="hljs-string">(?:Boolean|Integer|Long|Number|String)|org\.apach</span><br><span class="hljs-string">e\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.</span><br><span class="hljs-string">(?:Linked)?HashMap&quot;</span>/&gt;<br>&lt;/Context&gt; <br></code></pre></td></tr></table></figure>

<p>无需重启服务，直接访问，输入前面的用户和密码，即可登录成功</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat62.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat63.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-4-5-5-3-创建新的虚拟主机"><a href="#3-4-5-5-3-创建新的虚拟主机" class="headerlink" title="3.4.5.5.3 创建新的虚拟主机"></a>3.4.5.5.3 创建新的虚拟主机</h5><p>可以管理虚拟主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建虚拟主机前,必须先创建相关目录,否则创建虚拟机不成功</span><br>[root@centos8 ~]<span class="hljs-comment"># mkdir -p /data/node1/ROOT/</span><br>[root@centos8 ~]<span class="hljs-comment"># echo node1.rlin.org &gt; /data/node1/ROOT/index.html</span><br>[root@centos8 ~]<span class="hljs-comment"># chown -R tomcat.tomcat /data/node1/</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat64.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat65.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat66.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-4-5-5-Context-配置"><a href="#3-4-5-5-Context-配置" class="headerlink" title="3.4.5.5 Context 配置"></a>3.4.5.5 Context 配置</h4><h5 id="3-4-5-5-1-Centext-配置方式"><a href="#3-4-5-5-1-Centext-配置方式" class="headerlink" title="3.4.5.5.1 Centext 配置方式"></a>3.4.5.5.1 Centext 配置方式</h5><p>Context作用：</p>
<ul>
<li>路径映射：将url映射至指定路径，而非使用appBase下的物理目录，实现虚拟目录功能</li>
<li>应用独立配置，例如单独配置应用日志、单独配置应用访问控制</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml">#路径映射<br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/test&quot;</span> <span class="hljs-attr">docBase</span>=<span class="hljs-string">&quot;/data/test&quot;</span> <span class="hljs-attr">reloadable</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><br>#还可以添加日志等独立的配置<br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/test&quot;</span> <span class="hljs-attr">docBase</span>=<span class="hljs-string">&quot;/data/test&quot;</span> <span class="hljs-attr">reloadable</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="hljs-attr">directory</span>=<span class="hljs-string">&quot;logs&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">prefix</span>=<span class="hljs-string">&quot;localhost_test_log&quot;</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">&quot;.txt&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;%h %l %u %t <span class="hljs-symbol">&amp;quot;</span>%r<span class="hljs-symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>path：指的是访问的URL路径，如果path与appBase下面的子目录同名，context的docBase路径优先更高</li>
<li>docBase：可以是磁盘文件的绝对路径，也可以是相对路径（相对于Host的appBase）</li>
<li>reloadable：true表示如果WEB-INF/classes或META-INF/lib目录下.class文件有改动，就会将WEB应用重新加载。生产环境中，建议使用false来禁用。</li>
</ul>
<p>Centext实现过程</p>
<ul>
<li>将~/projects/myapp/下面的项目文件复制到/data/下，可以修改一下index.jsp 区别一下</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#例1</span><br><span class="hljs-comment"># cp -r ~/projects/myapp /data/myapp-v1</span><br><span class="hljs-comment"># vim /data/myappv1/index.jsp</span><br><span class="hljs-comment"># cd /data</span><br><span class="hljs-comment"># ln -sv myapp-v1 test</span><br><br><span class="hljs-comment">#例2</span><br>mkdir /data/linux<br><span class="hljs-built_in">echo</span> /data/linux/index.html &gt; /data/linux/index.html<br></code></pre></td></tr></table></figure>

<p><strong>注意</strong>：这里特别使用了软链接，原因方便后期版升级或回滚，如是是版本升级，需要将软链接指向myappv2，重新启动。如果新版上线后，出现问题，重新修改软链接到上一个版本的目录，并重启，就可以实现回滚</p>
<ul>
<li>修改conf/server.xml设置context</li>
</ul>
<p>Tomcat的配置文件server.xml中修改如下，重启Tomcat生效</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml">#例1<br>vim conf/server.xml<br><span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;node1.rlin.com&quot;</span>  <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps/&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">unpackWARs</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/test&quot;</span> <span class="hljs-attr">docBase</span>=<span class="hljs-string">&quot;/data/test&quot;</span> <span class="hljs-attr">reloadable</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br>chown tomcat.tomcat -R /data/myapp-v1/<br>systemctl restart tomcat<br><br>#例2<br>vim conf/server.xml<br><span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;node1.rlin.com&quot;</span>  <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps/&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">unpackWARs</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/linux&quot;</span> <span class="hljs-attr">docBase</span>=<span class="hljs-string">&quot;/data/linux&quot;</span> <span class="hljs-attr">reloadable</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br>chown tomcat.tomcat -R /data/linux/<br>systemctl restart tomcat<br></code></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<p>例1使用<a target="_blank" rel="noopener" href="http://node1.rlin.com:8080/test/">http://node1.rlin.com:8080/test/</a></p>
<p>例2使用<a target="_blank" rel="noopener" href="http://node1.rlin.com:8080/linux/">http://node1.rlin.com:8080/linux/</a></p>
<h5 id="3-4-5-5-2-Valve组件"><a href="#3-4-5-5-2-Valve组件" class="headerlink" title="3.4.5.5.2 Valve组件"></a>3.4.5.5.2 Valve组件</h5><p>valve(阀门)组件可以定义日志</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="hljs-attr">directory</span>=<span class="hljs-string">&quot;logs&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">prefix</span>=<span class="hljs-string">&quot;localhost_access_log&quot;</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">&quot;.txt&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;%h %l %u %t <span class="hljs-symbol">&amp;quot;</span>%r<span class="hljs-symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>valve存在多种类型：</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">定义访问日志：org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.catalina</span><span class="hljs-selector-class">.valves</span><span class="hljs-selector-class">.AccessLogValve</span><br>定义访问控制：org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.catalina</span><span class="hljs-selector-class">.valves</span>.RemoteAddrValve<br></code></pre></td></tr></table></figure>

<p>示例:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span> <span class="hljs-attr">deny</span>=<span class="hljs-string">&quot;10\.0\.0\.\d+&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-5-5-3-实战案例"><a href="#3-4-5-5-3-实战案例" class="headerlink" title="3.4.5.5.3 实战案例"></a>3.4.5.5.3 实战案例</h5><p><strong>范例：虚拟主机上利用context实现虚拟目录</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在前面范例的基础上实现，继续创建node1.magedu.org虚拟主机下的物理子目录</span><br>[root@centos8 ~]<span class="hljs-comment"># mkdir /data/webapps1/app1/</span><br>[root@centos8 ~]<span class="hljs-comment"># echo /data/webapps1/app1/index.html &gt; /data/webapps1/app1/index.html</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org:8080/app1/</span><br>/data/webapps1/app1/index.html<br><br><span class="hljs-comment">#利用context实现node1.rlin.org虚拟主机下的虚拟子目录</span><br>[root@centos8 tomcat]<span class="hljs-comment"># vim conf/server.xml</span><br>[root@centos8 tomcat]<span class="hljs-comment"># tail conf/server.xml</span><br>  &lt;/Host&gt;<br>  &lt;Host name=<span class="hljs-string">&quot;node1.rlin.org&quot;</span> appBase=<span class="hljs-string">&quot;/data/webapps1&quot;</span>&gt;<br>   <span class="hljs-comment">#加下面六行</span><br>  &lt;Context path=<span class="hljs-string">&quot;/app1&quot;</span> docBase=<span class="hljs-string">&quot;/data/app1&quot;</span> reloadable=<span class="hljs-string">&quot;true&quot;</span> /&gt;<br>  &lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="hljs-string">&quot;logs&quot;</span> prefix=<span class="hljs-string">&quot;node1.rlin.org_app1&quot;</span> suffix=<span class="hljs-string">&quot;.log&quot;</span> pattern=<span class="hljs-string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;<br>   &lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span><br>deny=<span class="hljs-string">&quot;10\.0\.0\.7&quot;</span>/&gt;<br>   &lt;/Context&gt;<br>   &lt;/Host&gt;<br>  &lt;Host  name=<span class="hljs-string">&quot;node2.rlin.org&quot;</span>  appBase=<span class="hljs-string">&quot;/data/webapps2&quot;</span>&gt;<br>  &lt;/Host&gt;<br> &lt;/Engine&gt;<br>&lt;/Service&gt;<br>&lt;/Server&gt;<br>[root@centos8 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br><br><span class="hljs-comment">#因数据没有准备好，出现下面错误</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://node1.rlin.org:8080/app1/</span><br>curl: (7) Failed to connect to node1.rlin.org port 8080: Connection refused<br><br><span class="hljs-comment">#准备数据目录</span><br>[root@centos8 tomcat]<span class="hljs-comment"># mkdir /data/app1-v1</span><br>[root@centos8 tomcat]<span class="hljs-comment"># echo /data/app1-v1/index.html &gt; /data/app1-v1/index.html</span><br>[root@centos8 tomcat]<span class="hljs-comment"># ln -s /data/app1-v1/ /data/app1</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://node1.rlin.org:8080/app1/</span><br>curl: (7) Failed to connect to node1.rlin.org port 8080: Connection refused<br><br><span class="hljs-comment">#数据目录准备好，还需要重新启动服务，才能访问</span><br>[root@centos8 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://node1.rlin.org:8080/app1/</span><br>/data/app1-v1/index.html<br>[root@centos7 ~]<span class="hljs-comment"># curl -I http://node1.rlin.org:8080/app1/</span><br>HTTP/1.1 403<br>Content-Type: text/html;charset=utf-8<br>Content-Language: en<br>Transfer-Encoding: chunked<br>Date: Tue, 14 Jul 2020 06:48:54 GMT<br><br><span class="hljs-comment">#可以看到此目录单独的访问日志</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /usr/local/tomcat/logs/node1.rlin.org_app1.2020-07-14.log</span><br>10.0.0.8 - - [14/Jul/2020:14:36:01 +0800] <span class="hljs-string">&quot;GET /app1/ HTTP/1.1&quot;</span> 200 330<br>10.0.0.7 - - [14/Jul/2020:14:48:07 +0800] <span class="hljs-string">&quot;GET /app1/ HTTP/1.1&quot;</span> 403 618<br></code></pre></td></tr></table></figure>

<p><strong>范例: 基于前面环境,实现软件升级和回滚功能</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#升级版本</span><br>[root@centos8 tomcat]<span class="hljs-comment"># mkdir /data/app1-v2</span><br>[root@centos8 tomcat]<span class="hljs-comment"># echo /data/app1-v2/index.html &gt; /data/app1-v2/index.html</span><br>[root@centos8 tomcat]<span class="hljs-comment"># rm -f /data/app1</span><br><br><span class="hljs-comment">#删除软链接，仍然可以访问旧版本</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://node1.rlin.org:8080/app1/</span><br>/data/app1-v1/index.html<br><br><span class="hljs-comment">#重新服务后，出现错误</span><br>[root@centos8 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://node1.rlin.org:8080/app1/</span><br>curl: (7) Failed to connect to node1.rlin.org port 8080: Connection refused<br><br><span class="hljs-comment">#新建软链接，指向新版，仍需重启服务才生效</span><br>[root@centos8 tomcat]<span class="hljs-comment"># ln -s /data/app1-v2/ /data/app1</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://node1.rlin.org:8080/app1/</span><br>curl: (7) Failed to connect to node1.rlin.org port 8080: Connection refused<br>[root@centos8 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://node1.rlin.org:8080/app1/</span><br>/data/app1-v2/index.html<br><br><span class="hljs-comment">#软件降级或回滚</span><br>[root@centos8 tomcat]<span class="hljs-comment"># rm -f /data/app1</span><br>[root@centos8 tomcat]<span class="hljs-comment"># ln -s /data/app1-v1/ /data/app1</span><br>[root@centos8 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@centos8 tomcat]<span class="hljs-comment"># curl http://node1.rlin.org:8080/app1/</span><br>/data/app1-v1/index.html<br></code></pre></td></tr></table></figure>



<h1 id="四、结合反向代理实现tomcat部署"><a href="#四、结合反向代理实现tomcat部署" class="headerlink" title="四、结合反向代理实现tomcat部署"></a>四、结合反向代理实现tomcat部署</h1><h2 id="4-1-常见部署方式介绍"><a href="#4-1-常见部署方式介绍" class="headerlink" title="4.1 常见部署方式介绍"></a>4.1 常见部署方式介绍</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat67.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li><p>standalone模式，Tomcat单独运行，直接接受用户的请求，不推荐。</p>
</li>
<li><p>反向代理，单机运行，提供了一个Nginx作为反向代理，可以做到静态由nginx提供响应，动态jsp代理给Tomcat</p>
</li>
<li><p>LNMT：Linux + Nginx + MySQL + Tomcat</p>
</li>
<li><p>LAMT：Linux + Apache（Httpd）+ MySQL + Tomcat</p>
</li>
<li><p>前置一台Nginx，给多台Tomcat实例做反向代理和负载均衡调度，Tomcat上部署的纯动态页面更适合</p>
<ul>
<li> LNMT：Linux + Nginx + MySQL + Tomcat</li>
</ul>
</li>
<li><p>多级代理</p>
<ul>
<li> LNNMT：Linux + Nginx + Nginx + MySQL + Tomcat</li>
</ul>
</li>
</ul>
<h2 id="4-2-利用-nginx-反向代理实现全部转发置指定同一个虚拟主机"><a href="#4-2-利用-nginx-反向代理实现全部转发置指定同一个虚拟主机" class="headerlink" title="4.2 利用 nginx 反向代理实现全部转发置指定同一个虚拟主机"></a>4.2 利用 nginx 反向代理实现全部转发置指定同一个虚拟主机</h2><h3 id="4-2-1-配置说明"><a href="#4-2-1-配置说明" class="headerlink" title="4.2.1 配置说明"></a>4.2.1 配置说明</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat68.png" srcset="/blog/img/loading.gif"></p>
<p>利用nginx反向代理功能，实现 4.1 图（2）的代理功能，将用户请求全部转发至指定的同一个tomcat主机</p>
<p>利用nginx指令proxy_pass 可以向后端服务器转发请求报文,并且在转发时会保留客户端的请求报文中的host首部</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#从yum源安装nginx</span><br><span class="hljs-comment">#yum install nginx -y</span><br><span class="hljs-comment">#vim /etc/nginx/nginx.conf</span><br><span class="hljs-comment">#全部反向代理测试</span><br>location / &#123;<br>  <span class="hljs-comment"># proxy_pass http://127.0.0.1:8080; # 不管什么请求，都会访问后面的localhost虚拟主机</span><br> <br>    proxy_pass http://node1.rlin.com:8080; <span class="hljs-comment"># 此项将用户访问全部请求转发到node1的虚拟主机上</span><br>  <br>  <span class="hljs-comment">#proxy_pass http://node2.rlin.com:8080; #此项将用户访问全部请求转发到node2的虚拟主机上</span><br> <br>  <span class="hljs-comment">#以上两项都需要修改nginx服务器的/etc/hosts,实现node1.rlin.com和node2.rlin.com到IP的解析  </span><br>&#125;<br><br><span class="hljs-comment">#nginx -t</span><br><span class="hljs-comment">#systemctl restart nginx</span><br><br><span class="hljs-comment">#说明: proxy_pass http://FQDN/ 中的FQDN 决定转发至后端哪个虚拟主机,而与用户请求的URL无关</span><br><span class="hljs-comment">#如果转到后端的哪个服务器由用户请求决定,可以向后端服务转发请求的主机头实现,示例:proxy_set_header Host $http_host;</span><br></code></pre></td></tr></table></figure>

<h3 id="4-2-2-实战案例"><a href="#4-2-2-实战案例" class="headerlink" title="4.2.2 实战案例"></a>4.2.2 实战案例</h3><p>环境说明:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">一台主机,实现nginx和tomcat<br>tomcat上有两个虚拟主机node1和node2<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先按3.4.5.4介绍方式在同一下主机上建立两个tomcat虚拟主机，node1.rlin.org和node2.rlin.org</span><br><span class="hljs-comment">#修改/etc/hosts文件，实现名称解析</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/hosts</span><br>127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4<br>centos8.localdomain<br>::1     localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.0.0.201 node1.rlin.org node2.rlin.org<br><br><span class="hljs-comment">#安装nginx</span><br>[root@centos8 ~]<span class="hljs-comment"># yum -y install nginx</span><br><br><span class="hljs-comment">#修改nginx.conf配置文件</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/nginx/nginx.conf</span><br>......<br><br><span class="hljs-comment">#修改location / 此行，添加以下内容</span><br>location / &#123;<br>     <span class="hljs-comment">#proxy_pass http://127.0.0.1:8080;</span><br>     proxy_pass http://node1.rlin.org:8080;              <br>     &#125;<br>......<br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable --now nginx</span><br><br><span class="hljs-comment">#先别访问node1,node2和IP都可以看到一样的node1的虚拟主机页面</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org/</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>&lt;br&gt;<br>http://node1.rlin.org:8080/<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node2.magedu.org/</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>&lt;br&gt;<br>http://node1.rlin.org:8080/<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># curl http://127.0.0.1/</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>&lt;br&gt;<br>http://node1.rlin.org:8080/<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># curl http://10.0.0.201/</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>&lt;br&gt;<br>http://node1.rlin.org:8080/<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br><span class="hljs-comment">#再次修改nginx.conf配置文件</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/nginx/nginx.conf</span><br>......<br><span class="hljs-comment">#修改location / 行，添加以下内容</span><br>location / &#123;<br>     <span class="hljs-comment">#proxy_pass http://127.0.0.1:8080;</span><br>     proxy_pass http://node2.magedu.org:8080;              <br>     &#125;<br>......<br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart nginx</span><br><span class="hljs-comment">#先别访问node1,node2和IP都可以看到一样的node2的虚拟主机页面</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org/</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node2.rlin.org/</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://127.0.0.1/</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://10.0.0.201/</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br> &lt;title&gt;jsp例子&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>后面的内容是服务器端动态生成字符串，最后拼接在一起<br>&lt;br&gt;<br>http://node2.rlin.org:8080/<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br></code></pre></td></tr></table></figure>

<h2 id="4-3-利用nginx实现动静分离代理"><a href="#4-3-利用nginx实现动静分离代理" class="headerlink" title="4.3 利用nginx实现动静分离代理"></a>4.3 利用nginx实现动静分离代理</h2><h3 id="4-3-1-配置说明"><a href="#4-3-1-配置说明" class="headerlink" title="4.3.1 配置说明"></a>4.3.1 配置说明</h3><p>可以利用nginx实现动静分离</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nginx">[root@<span class="hljs-attribute">centos8</span> ~]<span class="hljs-comment"># vim nginx.conf</span><br>root /usr/share/nginx/html;<br><span class="hljs-comment">#下面行可不加</span><br><span class="hljs-comment">#location / &#123;</span><br><span class="hljs-comment">#  root /data/webapps/ROOT;</span><br><span class="hljs-comment">#  index index.html;</span><br><span class="hljs-comment">#&#125;</span><br><br><span class="hljs-comment"># ~* 不区分大小写</span><br><span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.jsp$</span> &#123;<br>  <span class="hljs-attribute">proxy_pass</span> http://node1.rlin.com:8080; <span class="hljs-comment">#注意: 8080后不要加/,需要nginx修改 /etc/hosts</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上设置，可以将jsp的请求反向代理到tomcat，而其它文件仍由nginx处理，从而实现所谓动静分离。但由于jsp文件中实际上是由静态资源和动态组成，所以无法彻底实现动静分离。实际上Tomcat不太适合做动静分离，用它来管理程序的图片不好做动静分离部署</p>
<h3 id="4-3-2-实战案例"><a href="#4-3-2-实战案例" class="headerlink" title="4.3.2 实战案例"></a>4.3.2 实战案例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#准备三个不同的资源文件</span><br>[root@centos8 ~]<span class="hljs-comment"># echo /usr/local/tomcat/webapps/ROOT/test.html &gt; /usr/local/tomcat/webapps/ROOT/test.html</span><br>[root@centos8 ~]<span class="hljs-comment"># echo /usr/local/tomcat/webapps/ROOT/test.jsp &gt; /usr/local/tomcat/webapps/ROOT/test.jsp</span><br>[root@centos8 ~]<span class="hljs-comment"># echo /usr/share/nginx/html/test.html &gt; /usr/share/nginx/html/test.html</span><br><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/nginx/nginx.conf</span><br>......<br>root     /usr/share/nginx/html;<br><span class="hljs-comment">#location / &#123;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#&#125;</span><br>location ~* \.jsp$ &#123;<br> proxy_pass http://127.0.0.1:8080;                     <br>     &#125;<br>......<br><br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart nginx</span><br><br><span class="hljs-comment">#访问test.html，观察结果都一样访问的是nginx自身的资源</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org/test.html</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node2.rlin.org/test.html</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://127.0.0.1/test.html</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://10.0.0.201/test.html</span><br>/usr/share/nginx/html/test.html<br><br><span class="hljs-comment">#访问test.jsp，观察结果都一样访问的是tomcat的默认主机资源</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org/test.jsp</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node2.rlin.org/test.jsp</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://127.0.0.1/test.jsp</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://10.0.0.201/test.jsp</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.jsp<br></code></pre></td></tr></table></figure>

<h2 id="4-4-利用httpd实现基于http协议的反向代理至后端Tomcat服务器"><a href="#4-4-利用httpd实现基于http协议的反向代理至后端Tomcat服务器" class="headerlink" title="4.4 利用httpd实现基于http协议的反向代理至后端Tomcat服务器"></a>4.4 利用httpd实现基于http协议的反向代理至后端Tomcat服务器</h2><h3 id="4-4-1-配置说明"><a href="#4-4-1-配置说明" class="headerlink" title="4.4.1 配置说明"></a>4.4.1 配置说明</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat69.png" srcset="/blog/img/loading.gif"></p>
<p>httpd也提供了反向代理功能，所以可以实现对tomcat的反向代理功能</p>
<p>范例：查看代理相关模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># httpd -M|grep proxy</span><br>AH00558: httpd: Could not reliably determine the server<span class="hljs-string">&#x27;s fully qualified domain</span><br><span class="hljs-string">name, using centos8.localdomain. Set the &#x27;</span>ServerName<span class="hljs-string">&#x27; directive globally to</span><br><span class="hljs-string">suppress this message</span><br><span class="hljs-string">proxy_module (shared)</span><br><span class="hljs-string">proxy_ajp_module (shared)    #ajp</span><br><span class="hljs-string">proxy_balancer_module (shared)</span><br><span class="hljs-string">proxy_connect_module (shared)</span><br><span class="hljs-string">proxy_express_module (shared)</span><br><span class="hljs-string">proxy_fcgi_module (shared)</span><br><span class="hljs-string">proxy_fdpass_module (shared)</span><br><span class="hljs-string">proxy_ftp_module (shared)</span><br><span class="hljs-string">proxy_http_module (shared)   #http</span><br><span class="hljs-string">proxy_hcheck_module (shared)</span><br><span class="hljs-string">proxy_scgi_module (shared)</span><br><span class="hljs-string">proxy_uwsgi_module (shared)</span><br><span class="hljs-string">proxy_wstunnel_module (shared)</span><br><span class="hljs-string">proxy_http2_module (shared)</span><br></code></pre></td></tr></table></figure>

<p><strong>proxy_http_module</strong>模块代理配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/httpd/conf.d/http-tomcat.conf<br>&lt;VirtualHost *:80&gt;<br> ServerName    node1.rlinu.org<br> ProxyRequests   Off<br> ProxyPass  / http://127.0.0.1:8080/<br> ProxyPassReverse / http://127.0.0.1:8080/<br> ProxyPreserveHost On<br> ProxyVia     On<br>&lt;/VirtualHost&gt;<br></code></pre></td></tr></table></figure>

<ul>
<li>ProxyRequests：Off 关闭正向代理功能,即启动反向代理</li>
<li>ProxyPass：反向代理指令,指向后端服务器</li>
<li>ProxyPassReverse：当反向代理时,返回给客户端的报文需将之重写个别后端主机的response头,<br>如:Location,Content-Location,URI</li>
<li>ProxyPreserveHost：On时让反向代理保留原请求的Host首部转发给后端服务器，off 时则删除<br>host首部后再转发至后面端服务器, 这将导致只能转发到后端的默认虚拟主机</li>
<li>ProxyVia：On开启。反向代理的响应报文中提供一个response的via首部，默认值off</li>
</ul>
<p><strong>说明: 关于ProxyPreserveHost</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#分别访问下面不同链接</span><br>http://httpd服务IP/<br>http://node1.magedu.org/<br>http://node1.magedu.org/index.jsp<br><br><span class="hljs-comment">#以上3个URL看到了不同的页面，说明ProxyPreserveHost On起了作用</span><br><span class="hljs-comment">#设置ProxyPreserveHost Off再看效果，说明什么？</span><br></code></pre></td></tr></table></figure>

<h3 id="4-4-2-实战案例"><a href="#4-4-2-实战案例" class="headerlink" title="4.4.2 实战案例"></a>4.4.2 实战案例</h3><p>范例：基于httpd实现反向代理后端的tomcat</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat70.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#对不同的虚拟主机生成页面文件</span><br>[root@centos8 ~]<span class="hljs-comment"># echo /usr/local/tomcat/webapps/ROOT/test.html &gt; /usr/local/tomcat/webapps/ROOT/test.html</span><br>[root@centos8 ~]<span class="hljs-comment"># echo /data/node1/ROOT/test.html &gt; /data/node1/ROOT/test.html</span><br>[root@centos8 ~]<span class="hljs-comment"># echo /data/node2/ROOT/test.html &gt; /data/node2/ROOT/test.html</span><br><br><span class="hljs-comment">#修改httpd配置</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/httpd/conf.d/tomcat.conf</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/httpd/conf.d/tomcat.conf</span><br>&lt;VirtualHost *:80&gt;<br> ServerName    node1.rlin.org<br> ProxyRequests   Off<br> ProxyVia     On<br> ProxyPreserveHost On<br> ProxyPass / http://127.0.0.1:8080/<br> ProxyPassReverse  / http://127.0.0.1:8080/<br>&lt;/VirtualHost&gt;<br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart httpd</span><br><br><span class="hljs-comment">#用下面不同URL访问，可以看不同结果</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org/test.html</span><br>/data/node1/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment"># curl http://node2.rlin.org/test.html</span><br>/data/node2/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment"># curl http://127.0.0.1/test.html</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment"># curl http://10.0.0.201/test.html</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.html<br><br><span class="hljs-comment">#修改配置</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/httpd/conf.d/tomcat.conf</span><br><span class="hljs-comment">#只修改下面一行</span><br>ProxyPreserveHost Off <br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart httpd</span><br><br><span class="hljs-comment">#再次用用下面不同URL访问，可以看相同结果</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org/test.html</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment"># curl http://node2.rlin.org/test.html</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment"># curl http://10.0.0.201/test.html</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment"># curl http://127.0.0.1/test.html</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.html<br></code></pre></td></tr></table></figure>

<h2 id="4-5-利用-httpd-实现基于AJP协议的反向代理至后端"><a href="#4-5-利用-httpd-实现基于AJP协议的反向代理至后端" class="headerlink" title="4.5 利用 httpd 实现基于AJP协议的反向代理至后端"></a>4.5 利用 httpd 实现基于AJP协议的反向代理至后端</h2><p>Tomcat服务器</p>
<h3 id="4-5-1-AJP-协议说明"><a href="#4-5-1-AJP-协议说明" class="headerlink" title="4.5.1 AJP 协议说明"></a>4.5.1 AJP 协议说明</h3><p>AJP（Apache JServ Protocol）是定向包协议，是一个二进制的TCP传输协议，相比HTTP这种纯文本的协议来说，效率和性能更高，也做了很多优化。但是浏览器并不能直接支持AJP13协议，只支持HTTP协议。所以实际情况是，通过Apache的proxy_ajp模块进行反向代理，暴露成http协议给客户端访问</p>
<h3 id="4-5-2-启用和禁用-AJP"><a href="#4-5-2-启用和禁用-AJP" class="headerlink" title="4.5.2 启用和禁用 AJP"></a>4.5.2 启用和禁用 AJP</h3><p>注意: Tomcat/8.5.51之后版本基于安全需求默认禁用AJP协议</p>
<p>范例: Tomcat/8.5.51之后版启用支持AJP协议</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment"># vim conf/server.xml</span><br><span class="hljs-comment">#取消前面的注释,并修改下面行,修改address和secretRequired</span><br>&lt;Connector protocol=<span class="hljs-string">&quot;AJP/1.3&quot;</span>  address=<span class="hljs-string">&quot;0.0.0.0&quot;</span> port=<span class="hljs-string">&quot;8009&quot;</span><br> redirectPort=<span class="hljs-string">&quot;8443&quot;</span> secretRequired=<span class="hljs-string">&quot;&quot;</span> /&gt;<br> <br>[root@centos8 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@centos8 tomcat]<span class="hljs-comment"># ss -ntl</span><br>State     Recv-Q    Send-Q          Local Address:Port    <br>   Peer Address:Port  <br>LISTEN     0       128               0.0.0.0:22     <br>      0.0.0.0:*   <br>LISTEN     0       100              127.0.0.1:25     <br>      0.0.0.0:*   <br>LISTEN     0       128                [::]:22     <br>       [::]:*   <br>LISTEN     0       100                [::1]:25     <br>       [::]:*   <br>LISTEN     0       1          [::ffff:127.0.0.1]:8005    <br>        *:*   <br>LISTEN     0       100         [::ffff:127.0.0.1]:8009    <br>        *:*   <br>LISTEN     0       100                  *:8080    <br>        *:*   <br>LISTEN     0       128                  *:80     <br>        *:* <br></code></pre></td></tr></table></figure>

<p><strong>注意: secretRequired=”” 必须加上,否则出现以下错误提示</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 tomcat]<span class="hljs-comment"># cat logs/catalina.log</span><br>Caused by: java.lang.IllegalArgumentException: The AJP Connector is configured<br>with secretRequired=<span class="hljs-string">&quot;true&quot;</span> but the secret attribute is either null or <span class="hljs-string">&quot;&quot;</span>. This<br>combination is not valid.<br></code></pre></td></tr></table></figure>

<p>除httpd外，其它支持AJP代理的服务器非常少，比如Nginx就不支持AJP，所以目前一般都禁用AJP协议端口</p>
<p><strong>范例：禁用AJP协议</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#Tomcat/8.5.50版本之前默认支持AJP协议</span><br>[root@centos8 ~]<span class="hljs-comment"># ss -ntl</span><br>State    Recv-Q    Send-Q           Local Address:Port    <br>   Peer Address:Port  <br>LISTEN    0       128                0.0.0.0:22     <br>      0.0.0.0:*    <br>LISTEN    0       100                  *:8080    <br>        *:*    <br>LISTEN    0       128                  *:80     <br>        *:*    <br>LISTEN    0       128                 [::]:22     <br>       [::]:*    <br>LISTEN    0       1           [::ffff:127.0.0.1]:8005    <br>        *:*    <br>LISTEN    0       100                  *:8009    <br>        *:*<br>        <br><span class="hljs-comment">#配置tomcat配置文件，删除下面一行</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /usr/local/tomcat/conf/server.xml</span><br>&lt;Connector port=<span class="hljs-string">&quot;8009&quot;</span> protocol=<span class="hljs-string">&quot;AJP/1.3&quot;</span> redirectPort=<span class="hljs-string">&quot;8443&quot;</span> /&gt;  <br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@centos8 ~]<span class="hljs-comment"># ss -ntl</span><br>State    Recv-Q    Send-Q           Local Address:Port    <br>   Peer Address:Port  <br>LISTEN    0       128                0.0.0.0:22     <br>      0.0.0.0:*    <br>LISTEN    0       100                  *:8080    <br>        *:*    <br>LISTEN    0       128                  *:80     <br>        *:*    <br>LISTEN    0       128                 [::]:22     <br>       [::]:*    <br>LISTEN    0       1           [::ffff:127.0.0.1]:8005    <br>        *:* <br></code></pre></td></tr></table></figure>

<h3 id="4-5-3-httpd-实现-AJP-反向代理"><a href="#4-5-3-httpd-实现-AJP-反向代理" class="headerlink" title="4.5.3 httpd 实现 AJP 反向代理"></a>4.5.3 httpd 实现 AJP 反向代理</h3><h4 id="4-5-3-1-配置说明"><a href="#4-5-3-1-配置说明" class="headerlink" title="4.5.3.1 配置说明"></a>4.5.3.1 配置说明</h4><p>相对来讲，AJP协议基于二进制比使用HTTP协议的连接器效率高些。</p>
<p><strong>proxy_ajp_module</strong>模块代理配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">VirtualHost</span> *<span class="hljs-attr">:80</span>&gt;</span><br> ServerName    node1.rlin.org<br> ProxyRequests   Off<br> ProxyVia     On<br> ProxyPreserveHost On<br> ProxyPass    / ajp://127.0.0.1:8009/<br><span class="hljs-tag">&lt;/<span class="hljs-name">VirtualHost</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>查看Server Status可以看到确实使用的是ajp连接了。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat71.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-5-3-2-实战案例"><a href="#4-5-3-2-实战案例" class="headerlink" title="4.5.3.2 实战案例"></a>4.5.3.2 实战案例</h3><p><strong>范例：启用httpd的AJP反向代理功能</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat72.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># vim /etc/httpd/conf.d/tomcat.conf</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/httpd/conf.d/tomcat.conf</span><br>&lt;VirtualHost *:80&gt;<br> ServerName    node1.rlin.org<br> ProxyRequests   Off<br> ProxyVia     On  <span class="hljs-comment">#此项对AJP无效</span><br> ProxyPreserveHost On  <span class="hljs-comment">#此项对AJP无效</span><br> ProxyPass    / ajp://127.0.0.1:8009/<br>&lt;/VirtualHost&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart httpd</span><br><br><span class="hljs-comment">#再次使用下面不同URL访问，可以看以下结果</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org/test.html</span><br>/data/node1/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment"># curl http://node2.rlin.org/test.html</span><br>/data/node2/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment"># curl http://10.0.0.201/test.html</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment"># curl http://127.0.0.1/test.html</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.html<br><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/httpd/conf.d/tomcat.conf</span><br><span class="hljs-comment">#只修改下面一行,关闭向后端转发请求的host首部</span><br>ProxyPreserveHost Off <br><br><span class="hljs-comment">#再次使用下面不同URL访问，可以看到和上面一样的结果，说明AJP协议和Http不同，会自动转发所有首部信息</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org/test.html</span><br>/data/node1/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment"># curl http://node2.rlin.org/test.html</span><br>/data/node2/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment">#curl http://10.0.0.201/test.html</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.html<br>[root@centos8 ~]<span class="hljs-comment">#curl http://127.0.0.1/test.html</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat/webapps/ROOT/test.html<br></code></pre></td></tr></table></figure>

<p>可以通过status页面看到下面AJP的信息</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat73.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat74.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#用iptables禁用AJP的访问</span><br>[root@centos8 ~]<span class="hljs-comment"># iptables -A INPUT -p tcp --dport 8009 -j REJECT</span><br>[root@centos8 ~]<span class="hljs-comment"># curl http://node1.rlin.org/test.html</span><br>&lt;!DOCTYPE HTML PUBLIC <span class="hljs-string">&quot;-//IETF//DTD HTML 2.0//EN&quot;</span>&gt;<br>&lt;html&gt;&lt;head&gt;<br>&lt;title&gt;503 Service Unavailable&lt;/title&gt;<br>&lt;/head&gt;&lt;body&gt;<br>&lt;h1&gt;Service Unavailable&lt;/h1&gt;<br>&lt;p&gt;The server is temporarily unable to service your<br>request due to maintenance downtime or capacity<br>problems. Please try again later.&lt;/p&gt;<br>&lt;/body&gt;&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<h2 id="4-6-实现tomcat负载均衡"><a href="#4-6-实现tomcat负载均衡" class="headerlink" title="4.6 实现tomcat负载均衡"></a>4.6 实现tomcat负载均衡</h2><p>动态服务器的问题，往往就是并发能力太弱，往往需要多台动态服务器一起提供服务。如何把并发的压力分摊，这就需要调度，采用一定的调度策略，将请求分发给不同的服务器，这就是Load Balance负载均衡。</p>
<p>当单机Tomcat，演化出多机多级部署的时候，一个问题便凸显出来，这就是Session。而这个问题的由来，都是由于HTTP协议在设计之初没有想到未来的发展。</p>
<h3 id="4-6-1-HTTP的无状态，有连接和短连接"><a href="#4-6-1-HTTP的无状态，有连接和短连接" class="headerlink" title="4.6.1 HTTP的无状态，有连接和短连接"></a>4.6.1 HTTP的无状态，有连接和短连接</h3><ul>
<li><p>无状态：指的是服务器端无法知道2次请求之间的联系，即使是前后2次请求来自同一个浏览器，也没有任何数据能够判断出是同一个浏览器的请求。后来可以通过cookie、session机制来判断。</p>
</li>
<li><p>浏览器端第一次HTTP请求服务器端时，在服务器端使用session这种技术，就可以在服务器端产生一个随机值即SessionID发给浏览器端，浏览器端收到后会保持这个SessionID在Cookie当中，这个Cookie值一般不能持久存储，浏览器关闭就消失。浏览器在每一次提交HTTP请求的时候会把这个SessionID传给服务器端，服务器端就可以通过比对知道是谁了</p>
</li>
<li><p>Session通常会保存在服务器端内存中，如果没有持久化，则易丢失</p>
</li>
<li><p>Session会定时过期。过期后浏览器如果再访问，服务端发现没有此ID，将给浏览器端重新发新的SessionID</p>
</li>
<li><p>更换浏览器也将重新获得新的SessionID</p>
</li>
<li><p>有连接：是因为它基于TCP协议，是面向连接的，需要3次握手、4次断开。</p>
</li>
<li><p>短连接：Http 1.1之前，都是一个请求一个连接，而Tcp的连接创建销毁成本高，对服务器有很大的影响。所以，自Http 1.1开始，支持keep-alive，默认也开启，一个连接打开后，会保持一段时间（可设置），浏览器再访问该服务器就使用这个Tcp连接，减轻了服务器压力，提高了效率。</p>
</li>
</ul>
<p>服务器端如果故障，即使Session被持久化了，但是服务没有恢复前都不能使用这些SessionID。</p>
<p>如果使用HAProxy或者Nginx等做负载均衡器，调度到了不同的Tomcat上，那么也会出现找不到SessionID的情况。</p>
<h3 id="4-6-2-会话保持方式"><a href="#4-6-2-会话保持方式" class="headerlink" title="4.6.2 会话保持方式"></a>4.6.2 会话保持方式</h3><h4 id="4-6-2-1-session-sticky会话黏性"><a href="#4-6-2-1-session-sticky会话黏性" class="headerlink" title="4.6.2.1 session sticky会话黏性"></a>4.6.2.1 session sticky会话黏性</h4><p>Session绑定</p>
<ul>
<li>nginx：source ip, cookie</li>
<li>HAProxy：source ip, cookie</li>
</ul>
<p>优点：简单易配置</p>
<p>缺点：如果目标服务器故障后，如果没有做sessoin持久化，就会丢失session,此方式生产很少使用</p>
<h4 id="4-6-2-2-session-复制集群"><a href="#4-6-2-2-session-复制集群" class="headerlink" title="4.6.2.2 session 复制集群"></a>4.6.2.2 session 复制集群</h4><p>Tomcat自己的提供的多播集群，通过多播将任何一台的session同步到其它节点。</p>
<p>缺点</p>
<ul>
<li>Tomcat的同步节点不宜过多，互相即时通信同步session需要太多带宽</li>
<li>每一台都拥有全部session，内存损耗太多</li>
</ul>
<h4 id="4-6-2-3-session-server"><a href="#4-6-2-3-session-server" class="headerlink" title="4.6.2.3 session server"></a>4.6.2.3 session server</h4><p>session 共享服务器，使用memcached、redis做共享的Session服务器，此为推荐方式</p>
<h3 id="4-6-3-负载均衡规划和准备"><a href="#4-6-3-负载均衡规划和准备" class="headerlink" title="4.6.3 负载均衡规划和准备"></a>4.6.3 负载均衡规划和准备</h3><h4 id="4-6-3-1-负载均衡主机和网络地址规划"><a href="#4-6-3-1-负载均衡主机和网络地址规划" class="headerlink" title="4.6.3.1 负载均衡主机和网络地址规划"></a>4.6.3.1 负载均衡主机和网络地址规划</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat75.png" srcset="/blog/img/loading.gif"></p>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>服务</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.201</td>
<td>proxy.rlin.org</td>
<td>调度器</td>
<td>Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.202</td>
<td>t1.rlin.org</td>
<td>tomcat1</td>
<td>JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.203</td>
<td>t2.rlin.org</td>
<td>tomcat2</td>
<td>JDK8、Tomcat8</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#只需在10.0.0.201的nginx主机上实现域名解析</span><br>[root@proxy ~]<span class="hljs-comment"># vim /etc/hosts</span><br><span class="hljs-comment">#添加以下三行</span><br>10.0.0.201 proxy.rlin.org proxy<br>10.0.0.202 t1.rlin.org t1<br>10.0.0.203 t2.rlin.org t2<br><br><span class="hljs-comment">#t1和t2配置jdk环境环境</span><br>[root@t1 ~]<span class="hljs-comment"># tar xf jdk-8u241-linux-x64.tar.gz -C /usr/local/</span><br>[root@t1 ~]<span class="hljs-comment"># cd /usr/local/</span><br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># ln -s jdk1.8.0_241/ jdk</span><br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># vim /etc/profile.d/jdk.sh</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin<br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># . /etc/profile.d/jdk.sh</span><br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># java -version</span><br><span class="hljs-comment">#t1和t2配置tomcat环境</span><br>[root@t1 ~]<span class="hljs-comment"># wget https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.50/bin/apache-tomcat-8.5.50.tar.gz</span><br>[root@t1 ~]<span class="hljs-comment"># tar xf apache-tomcat-8.5.50.tar.gz -C /usr/local/</span><br>[root@t1 ~]<span class="hljs-comment"># cd /usr/local/</span><br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># echo &#x27;PATH=/usr/local/tomcat/bin:$PATH&#x27; &gt; /etc/profile.d/tomcat.sh</span><br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># . /etc/profile.d/tomcat.sh</span><br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># useradd -r -s /sbin/nologin tomcat</span><br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># vim /usr/local/tomcat/conf/tomcat.conf</span><br>JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># chown -R tomcat.tomcat /usr/local/tomcat/</span><br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># vim /lib/systemd/system/tomcat.service</span><br>[Unit]<br>Description=Tomcat<br><span class="hljs-comment">#After=syslog.target network.target remote-fs.target nss-lookup.target</span><br>After=syslog.target network.target<br><br>[Service]<br>Type=forking<br>EnvironmentFile=/usr/<span class="hljs-built_in">local</span>/tomcat/conf/tomcat.conf<br>ExecStart=/usr/<span class="hljs-built_in">local</span>/tomcat/bin/startup.sh<br>ExecStop=/usr/<span class="hljs-built_in">local</span>/tomcat/bin/shutdown.sh<br>PrivateTmp=<span class="hljs-literal">true</span><br>User=tomcat<br>Group=tomcat<br><br>[Install]<br>WantedBy=multi-user.target<br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># systemctl daemon-reload</span><br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># systemctl enable --now tomcat</span><br>[root@t1 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># ss -tnl</span><br>State          Recv-Q          Send-Q                        Local Address:Port                   Peer Address:Port         <br>LISTEN         0               128                                 0.0.0.0:111                         0.0.0.0:*            <br>LISTEN         0               128                                 0.0.0.0:22                          0.0.0.0:*            <br>LISTEN         0               5                                 127.0.0.1:631                         0.0.0.0:*            <br>LISTEN         0               100                                       *:8009                              *:*            <br>LISTEN         0               128                                    [::]:111                            [::]:*            <br>LISTEN         0               100                                       *:8080                              *:*            <br>LISTEN         0               128                                    [::]:22                             [::]:*            <br>LISTEN         0               5                                     [::1]:631                            [::]:*            <br>LISTEN         0               1                        [::ffff:127.0.0.1]:8005                              *:*<br></code></pre></td></tr></table></figure>

<h4 id="4-6-3-2-负载均衡tomcat主机准备"><a href="#4-6-3-2-负载均衡tomcat主机准备" class="headerlink" title="4.6.3.2 负载均衡tomcat主机准备"></a>4.6.3.2 负载均衡tomcat主机准备</h4><p>修改tomcat的虚拟机主机为自定义的主机名,并设为默认的虚拟主机</p>
<p>t1虚拟主机配置conf/server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@t1 ~]# cd /usr/local/tomcat<br>[root@t1 tomcat]# vim conf/server.xml<br>128 <span class="hljs-tag">&lt;<span class="hljs-name">Engine</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span> <span class="hljs-attr">defaultHost</span>=<span class="hljs-string">&quot;t1.rlin.org&quot;</span>&gt;</span><br>    #直接在后面添加<br>    <span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;t1.rlin.org&quot;</span> <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps/&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">Engine</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>t2虚拟主机配置conf/server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@t2 ~]# cd /usr/local/tomcat<br>[root@t2 tomcat]# vim conf/server.xml<br>128 <span class="hljs-tag">&lt;<span class="hljs-name">Engine</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span> <span class="hljs-attr">defaultHost</span>=<span class="hljs-string">&quot;t2.rlin.org&quot;</span>&gt;</span><br>     #直接在后面添加<br>    <span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;t2.rlin.org&quot;</span> <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps/&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Engine</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="4-6-3-3-负载均衡规划测试用jsp文件"><a href="#4-6-3-3-负载均衡规划测试用jsp文件" class="headerlink" title="4.6.3.3 负载均衡规划测试用jsp文件"></a>4.6.3.3 负载均衡规划测试用jsp文件</h4><p>在t1和 t2节点创建相同的文件/data/webapps/ROOT/index.jsp</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#项目路径配置</span><br>[root@t1 ~]<span class="hljs-comment"># mkdir -pv /data/webapps/ROOT</span><br><br><span class="hljs-comment">#编写测试jsp文件，内容在下面</span><br>[root@t1 ~]<span class="hljs-comment"># vim /data/webapps/ROOT/index.jsp</span><br>&lt;%@ page import=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br> &lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="hljs-string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;<br>&lt;%=new Date()%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br><span class="hljs-comment">#设置权限</span><br>[root@t1 ~]<span class="hljs-comment"># chown -R tomcat.tomcat /data/webapps/</span><br></code></pre></td></tr></table></figure>

<h3 id="4-6-4-Nginx-实现后端-tomcat-的负载均衡调度"><a href="#4-6-4-Nginx-实现后端-tomcat-的负载均衡调度" class="headerlink" title="4.6.4 Nginx 实现后端 tomcat 的负载均衡调度"></a>4.6.4 Nginx 实现后端 tomcat 的负载均衡调度</h3><h4 id="4-6-4-1-Nginx-实现后端-tomcat-的负载均衡"><a href="#4-6-4-1-Nginx-实现后端-tomcat-的负载均衡" class="headerlink" title="4.6.4.1 Nginx 实现后端 tomcat 的负载均衡"></a>4.6.4.1 Nginx 实现后端 tomcat 的负载均衡</h4><p>nginx 配置如下</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx">[root@<span class="hljs-attribute">proxy</span> ~]<span class="hljs-comment"># yum install -y nginx</span><br><br>[root@proxy ~]<span class="hljs-comment"># vim /etc/nginx/nginx.conf </span><br><span class="hljs-comment">#在http块中加以下内容</span><br><span class="hljs-comment">#注意名称不要用下划线</span><br>upstream tomcat-server &#123;<br>    <span class="hljs-comment">#ip_hash; # 先禁用看看轮询，之后开启开黏性</span><br>    <span class="hljs-comment">#hash $cookie_JSESSIONID # 先禁用看看轮询，之后开启开黏性</span><br>    <span class="hljs-attribute">server</span> t1.rlin.org:<span class="hljs-number">8080</span>;<br>    <span class="hljs-attribute">server</span> t2.rlin.org:<span class="hljs-number">8080</span>;<br>&#125;<br> <br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(jsp|do)$</span> &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://tomcat-server;<br>    &#125;<br>&#125;<br>[root@<span class="hljs-attribute">proxy</span> ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>测试<a target="_blank" rel="noopener" href="http://proxy.rlin.org/index.jsp%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E8%BD%AE%E8%AF%A2%E8%B0%83%E5%BA%A6%E6%95%88%E6%9E%9C,%E6%AF%8F%E6%AC%A1%E5%88%B7%E6%96%B0%E5%90%8E%E7%AB%AF%E4%B8%BB%E6%9C%BA%E5%92%8CSessionID%E9%83%BD%E4%BC%9A%E5%8F%98%E5%8C%96">http://proxy.rlin.org/index.jsp，可以看到轮询调度效果,每次刷新后端主机和SessionID都会变化</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat76.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat77.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># curl http://proxy.rlin.org/index.jsp</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;div&gt;On tomcat-server&lt;/div&gt;<br>&lt;div&gt;10.0.0.202:8080&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;C5F6CC595197372A0D9C4ECD06D37E2A&lt;/span&gt;&lt;/div&gt;<br>Wed Aug 11 20:04:35 CST 2021<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@proxy ~]<span class="hljs-comment"># curl http://proxy.rlin.org/index.jsp</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;div&gt;On tomcat-server&lt;/div&gt;<br>&lt;div&gt;10.0.0.203:8080&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;4025CC7E89BEC74119FAAC795C1A6660&lt;/span&gt;&lt;/div&gt;<br>Wed Aug 11 20:05:04 CST 2021<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>使用抓包wireshark工具可以看到下面信息</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat78.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat79.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat80.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat81.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat82.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-6-4-2-实现-session-黏性"><a href="#4-6-4-2-实现-session-黏性" class="headerlink" title="4.6.4.2 实现 session 黏性"></a>4.6.4.2 实现 session 黏性</h4><p>在upstream中使用ip_hash指令，使用客户端IP地址Hash。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># vim /etc/nginx/nginx.conf</span><br><span class="hljs-comment">#只添加ip_hash;这一行</span><br>upstream tomcat-server &#123;<br>   ip_hash; <span class="hljs-comment">#启动源地址hash </span><br>    <span class="hljs-comment">#hash $cookie_JSESSIONID  #启动基于cookie的hash</span><br>   server t1.magedu.org:8080;<br>   server t2.magedu.org:8080;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>配置完reload nginx服务。curl 测试一下看看效果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#用curl访问每次都调度到10.0.0.203主机上，但因为curl每次请求不会自动携带之前获取的cookie,所有SessionID每次都在变化</span><br>[root@proxy ~]<span class="hljs-comment"># curl http://proxy.rlin.org/index.jsp</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;div&gt;On tomcat-server&lt;/div&gt;<br>&lt;div&gt;10.0.0.203:8080&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;6EBCDB8CBF0B931E01AE0EB458152A1B&lt;/span&gt;&lt;/div&gt;<br>Wed Aug 11 20:06:36 CST 2021<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@proxy ~]<span class="hljs-comment"># curl http://proxy.rlin.org/index.jsp</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;div&gt;On tomcat-server&lt;/div&gt;<br>&lt;div&gt;10.0.0.203:8080&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;2FA4DD5E39F95E3B077613E2DBFA5C34&lt;/span&gt;&lt;/div&gt;<br>Wed Aug 11 20:07:02 CST 2021<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>通过图形浏览器看到主机不变，sessionID不变</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat83.png" srcset="/blog/img/loading.gif"></p>
<p>关闭Session对应的Tomcat服务，再重启启动它，看看Session的变化。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># vim /etc/nginx/nginx.conf</span><br><span class="hljs-comment">#只添加ip_hash;这一行</span><br>upstream tomcat-server &#123;<br>   <span class="hljs-comment">#ip_hash; #启动源地址hash </span><br>   <span class="hljs-built_in">hash</span> <span class="hljs-variable">$cookie_JSESSIONID</span>  <span class="hljs-comment">#启动基于cookie的hash</span><br>   server t1.magedu.org:8080;<br>   server t2.magedu.org:8080;<br>&#125;<br>[root@proxy ~]<span class="hljs-comment"># systemc	restart nginx</span><br><br>[root@t2 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br></code></pre></td></tr></table></figure>

<p>通过浏览器看到主机不变，但sessionID和上一次变化，但后续刷新不再变化</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat84.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-6-5-Httpd-实现后端tomcat的负载均衡调度"><a href="#4-6-5-Httpd-实现后端tomcat的负载均衡调度" class="headerlink" title="4.6.5 Httpd 实现后端tomcat的负载均衡调度"></a>4.6.5 Httpd 实现后端tomcat的负载均衡调度</h3><p>和nginx一样, httpd 也支持负载均衡调度功能</p>
<h4 id="4-6-5-1-httpd-的负载均衡配置说明"><a href="#4-6-5-1-httpd-的负载均衡配置说明" class="headerlink" title="4.6.5.1 httpd 的负载均衡配置说明"></a>4.6.5.1 httpd 的负载均衡配置说明</h4><p>使用 httpd -M 可以看到 proxy_balancer_module，用它来实现负载均衡。</p>
<p>官方帮助: <a target="_blank" rel="noopener" href="http://httpd.apache.org/docs/2.4/mod/mod_proxy_balancer.html">http://httpd.apache.org/docs/2.4/mod/mod_proxy_balancer.html</a></p>
<table>
<thead>
<tr>
<th>方式</th>
<th>依赖模块</th>
</tr>
</thead>
<tbody><tr>
<td>http负载均衡</td>
<td>mod_proxy、mod_proxy_http、mod_proxy_balancer</td>
</tr>
<tr>
<td>ajp负载均衡</td>
<td>mod_proxy、mod_proxy_ajp、mod_proxy_balancer</td>
</tr>
</tbody></table>
<p><strong>负载均衡配置说明</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#配置代理到balancer</span><br>ProxyPass [path] !|url [key=value [key=value ...]]<br><br><span class="hljs-comment">#Balancer成员</span><br>BalancerMember [balancerurl] url [key=value [key=value ...]]<br><br><span class="hljs-comment">#设置Balancer或参数</span><br>ProxySet url key=value [key=value ...]<br></code></pre></td></tr></table></figure>

<p>ProxyPass 和 BalancerMember 指令参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>缺省值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>min</td>
<td>0</td>
<td>连接池最小容量</td>
</tr>
<tr>
<td>max</td>
<td>1 - n</td>
<td>连接池最大容量</td>
</tr>
<tr>
<td>retry</td>
<td>60</td>
<td>apache请求发送到后端服务器错误后等待的时间秒数。0表示立即重试</td>
</tr>
</tbody></table>
<p>Balancer 参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>缺省值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>loadfactor</td>
<td></td>
<td>定义负载均衡后端服务器权重，取值范围: 1 - 100</td>
</tr>
<tr>
<td>lbmethod</td>
<td>byrequests</td>
<td>负载均衡调度方法。byrequests 基于权重的统计请求个数进行调度。bytrafficz 执行基于权重的流量计数调度                 bybusyness 通过考量每个后端服务器当前负载进行调度</td>
</tr>
<tr>
<td>maxattempts</td>
<td>1</td>
<td>放弃接受请求前,实现故障转移的次数，默认为1，其最大值不应该大于总的节点数</td>
</tr>
<tr>
<td>nofailover</td>
<td>Off</td>
<td>On 表示不允许故障转移, 如果后端服务器没有Session副本可以设置为On                                                                                               Off 表示故障可以转移</td>
</tr>
<tr>
<td>stickysession</td>
<td></td>
<td>调度器的sticky session名字，根据web后台编程语言不同，可以设置为JSESSIONID或PHPSESSIONID</td>
</tr>
</tbody></table>
<p>ProxySet指令也可以使用上面的参数。</p>
<h4 id="4-6-5-2-启用-httpd-的负载均衡"><a href="#4-6-5-2-启用-httpd-的负载均衡" class="headerlink" title="4.6.5.2 启用 httpd 的负载均衡"></a>4.6.5.2 启用 httpd 的负载均衡</h4><p>在 tomcat 的配置中Engine使用jvmRoute属性,通过此项可得知SessionID是在哪个tomcat生成</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml">#t1的conf/server.xml配置如下：<br><span class="hljs-tag">&lt;<span class="hljs-name">Engine</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span> <span class="hljs-attr">defaultHost</span>=<span class="hljs-string">&quot;t1.rlin.org&quot;</span> <span class="hljs-attr">jvmRoute</span>=<span class="hljs-string">&quot;Tomcat1&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;t1.rlin.org&quot;</span> <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>     <br>   <br><span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br> <br>#t2的conf/server.xml配置如下：<br><span class="hljs-tag">&lt;<span class="hljs-name">Engine</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span> <span class="hljs-attr">defaultHost</span>=<span class="hljs-string">&quot;t2.rlin.org&quot;</span> <span class="hljs-attr">jvmRoute</span>=<span class="hljs-string">&quot;Tomcat2&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;t2.rlin.org&quot;</span> <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>     <br>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>这样设置后 SessionID 就变成了以下形式：</p>
<p>SessionID = 9C949FA4AFCBE9337F5F0669548BD4DF.Tomcat1</p>
<p>httpd配置如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># vim /etc/httpd/conf.d/tomcat.conf</span><br>[root@proxy ~]<span class="hljs-comment"># cat /etc/httpd/conf.d/tomcat.conf</span><br>&lt;Proxy balancer://tomcat-server&gt;<br> BalancerMember http://t1.rlin.org:8080 loadfactor=1<br> BalancerMember http://t2.rlin.org:8080 loadfactor=2<br>&lt;/Proxy&gt;<br><br>&lt;VirtualHost *:80&gt;<br> ServerName    proxy.rlin.org<br> ProxyRequests   Off<br> ProxyVia     On<br> ProxyPreserveHost On  <span class="hljs-comment">#off时不向后端转发原请求host首部，而转发采用BalancerMember指向名称为首部</span><br> ProxyPass    / balancer://tomcat-server/<br> ProxyPassReverse / balancer://tomcat-server/<br>&lt;/VirtualHost&gt;<br><br><span class="hljs-comment">#开启httpd负载均衡的状态页</span><br>&lt;Location /balancer-manager&gt;<br>SetHandler balancer-manager<br>ProxyPass !<br>Require all granted<br>&lt;/Location&gt;<br></code></pre></td></tr></table></figure>

<p>loadfactor设置为1:2，便于观察。观察调度的结果是轮询的。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat85.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat86.png" srcset="/blog/img/loading.gif"></p>
<p><strong>查看状态页</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat87.png" srcset="/blog/img/loading.gif"></p>
<p>使用抓包wireshark工具可以看到下面信息</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat88.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat89.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat90.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat91.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-6-5-3-实现-session-黏性"><a href="#4-6-5-3-实现-session-黏性" class="headerlink" title="4.6.5.3 实现 session 黏性"></a>4.6.5.3 实现 session 黏性</h4><p>官方文档：<a target="_blank" rel="noopener" href="http://httpd.apache.org/docs/2.4/mod/mod_proxy_balancer.html">http://httpd.apache.org/docs/2.4/mod/mod_proxy_balancer.html</a></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-tag">%&#123;BALANCER_WORKER_ROUTE&#125;<span class="hljs-selector-tag">e</span></span>  The route of the worker chosen.<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># vim /etc/httpd/conf.d/tomcat.conf</span><br><span class="hljs-comment">#添加此行,在cookie 添加 ROUTEID的定义</span><br>Header add Set-Cookie <span class="hljs-string">&quot;ROUTEID=.%&#123;BALANCER_WORKER_ROUTE&#125;e; path=/&quot;</span><br>env=BALANCER_ROUTE_CHANGED <br><br>&lt;Proxy balancer://tomcat-server&gt;<br> BalancerMember http://t1.magedu.org:8080 loadfactor=1 route=T1 <span class="hljs-comment">#修改行,指定后端后服务器对应的ROUTEID</span><br> BalancerMember http://t2.magedu.org:8080 loadfactor=1 route=T2 <span class="hljs-comment">#修改行</span><br> ProxySet stickysession=ROUTEID   <span class="hljs-comment">#添加此行,指定用cookie中的ROUTEID值做为调度条件</span><br>&lt;/Proxy&gt;<br><br>&lt;VirtualHost *:80&gt;<br> ServerName    proxy.magedu.org<br> ProxyRequests   Off<br> ProxyVia     On<br> ProxyPreserveHost On<br> ProxyPass    / balancer://tomcat-server/<br> ProxyPassReverse / balancer://tomcat-server/<br>&lt;/VirtualHost&gt;<br><br><span class="hljs-comment">#开启httpd负载均衡的状态页</span><br>&lt;Location /balancer-manager&gt;<br>SetHandler balancer-manager<br>ProxyPass !<br>Require all granted<br>&lt;/Location&gt;<br></code></pre></td></tr></table></figure>

<p>用浏览器访问发现Session不变了，一直找的同一个Tomcat服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#观察结果</span><br>[root@proxy ~]<span class="hljs-comment"># curl http://proxy.rlin.org/index.jsp #轮询</span><br>[root@proxy ~]<span class="hljs-comment"># curl -b &quot;ROUTEID=.T1&quot; http://proxy.rlin.org/index.jsp #固定调度到t1</span><br>[root@proxy ~]<span class="hljs-comment"># curl -b &quot;ROUTEID=.T2&quot; http://proxy.rlin.org/index.jsp</span><br><br>[root@centos7 ~]<span class="hljs-comment"># curl http://proxy.magedu.org/index.jsp -I</span><br>HTTP/1.1 200<br>Date: Wed, 15 Jul 2020 00:55:05 GMT<br>Server: Apache/2.4.37 (centos)<br>Content-Type: text/html;charset=ISO-8859-1<br>Transfer-Encoding: chunked<br>Set-Cookie: JSESSIONID=214D58236E1BD3095814B86A65C46C8A.Tomcat1; Path=/;<br>HttpOnly<br>Via: 1.1 proxy.rlin.org<br>Set-Cookie: ROUTEID=.T1; path=/<br><br>[root@centos7 ~]<span class="hljs-comment">#curl -b &quot;JSESSIONID=214D58236E1BD3095814B86A65C46C8A.Tomcat1; ROUTEID=.T1&quot; http://proxy.rlin.org/index.jsp</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat92.png" srcset="/blog/img/loading.gif"></p>
<p>关闭tomcat2的tomcat服务，再查看，转向另一台tomcat服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t2 ~]<span class="hljs-comment"># systemctl stop tomcat</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat93.png" srcset="/blog/img/loading.gif"></p>
<p>重新启动 tomcat2 的tomcat服务，再查看保持不变</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t2 ~]<span class="hljs-comment"># systemctl start tomcat</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat94.png" srcset="/blog/img/loading.gif"></p>
<p>查看状态页</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat95.png" srcset="/blog/img/loading.gif"></p>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@client ~]<span class="hljs-comment"># curl -I www.rlin.org</span><br>HTTP/1.1 200<br>Date: Sun, 10 Jan 2021 09:58:49 GMT<br>Server: Apache/2.4.37 (centos)<br>Content-Type: text/html;charset=ISO-8859-1<br>Transfer-Encoding: chunked<br>Set-Cookie: JSESSIONID=9E1A624ABD2A0ABBD256EFB14B12D555.Tomcat2; Path=/;<br>HttpOnly<br>Via: 1.1 proxy.rlin.org<br>Set-Cookie: ROUTEID=.T2; path=/<br><br>[root@client ~]<span class="hljs-comment">#curl -b &quot;ROUTEID=.T1&quot; www.rlin.org</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>   &lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>   &lt;/head&gt;<br>   &lt;body&gt;<br>   &lt;h1&gt;t1.magedu.org&lt;/h1&gt;<br>   &lt;div&gt;On www.rlin.org&lt;/div&gt;<br>   &lt;div&gt;10.0.0.202:8080&lt;/div&gt;<br>   &lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;A13BFA537739734CFDC12D59EA56710A.Tomcat1&lt;/span&gt;&lt;/div&gt;<br>   Sun Jan 10 18:01:33 CST 2021<br>   &lt;/body&gt;<br>   &lt;/html&gt;<br></code></pre></td></tr></table></figure>

<h4 id="4-6-5-4-实现-AJP-协议的负载均衡"><a href="#4-6-5-4-实现-AJP-协议的负载均衡" class="headerlink" title="4.6.5.4 实现 AJP 协议的负载均衡"></a>4.6.5.4 实现 AJP 协议的负载均衡</h4><p>在上面基础上修改httpd的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在t1和t2的tomcat-8.5.51以上版本的需启用AJP</span><br>[root@centos8 tomcat]<span class="hljs-comment"># vim conf/server.xml</span><br><span class="hljs-comment">#取消前面的注释,并修改下面行</span><br>&lt;Connector protocol=<span class="hljs-string">&quot;AJP/1.3&quot;</span>  address=<span class="hljs-string">&quot;0.0.0.0&quot;</span> port=<span class="hljs-string">&quot;8009&quot;</span><br> redirectPort=<span class="hljs-string">&quot;8443&quot;</span> secretRequired=<span class="hljs-string">&quot;&quot;</span> /&gt;<br> <br>[root@proxy ~]<span class="hljs-comment"># cat /etc/httpd/conf.d/tomcat.conf</span><br><span class="hljs-comment">#Header add Set-Cookie &quot;ROUTEID=.%&#123;BALANCER_WORKER_ROUTE&#125;e; path=/&quot; env=BALANCER_ROUTE_CHANGED #注释此行</span><br><br>&lt;Proxy balancer://tomcat-server&gt;<br> BalancerMember ajp://t1.rlin.org:8009 loadfactor=1 route=T1  <span class="hljs-comment">#修改此行</span><br> BalancerMember ajp://t2.rlin.org:8009 loadfactor=1 route=T2  <span class="hljs-comment">#修改此行</span><br>  <span class="hljs-comment">#ProxySet stickysession=ROUTEID  #先注释此行</span><br>&lt;/Proxy&gt;<br><br>&lt;VirtualHost *:80&gt;<br> ServerName    proxy.rlin.org<br> ProxyRequests   Off<br> ProxyVia     On<br> ProxyPreserveHost On<br> ProxyPass    / balancer://tomcat-server/<br> ProxyPassReverse / balancer://tomcat-server/<br>&lt;/VirtualHost&gt;<br><br>&lt;Location /balancer-manager&gt;<br> SetHandler balancer-manager<br> ProxyPass !<br> Require all granted<br>&lt;/Location&gt;<br><br><span class="hljs-comment">#ProxySet stickysession=ROUTEID先禁用,可以看到不断轮询的切换效果</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat96.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat97.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat98.png" srcset="/blog/img/loading.gif"></p>
<p>抓包可以可看AJP13协议</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat99.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat100.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat101.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat102.png" srcset="/blog/img/loading.gif"></p>
<p>开启ProxySet后，发现Session不变了，一直找的同一个Tomcat服务器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># vim /etc/httpd/conf.d/tomcat.conf</span><br>&lt;Proxy balancer://tomcat-server&gt;<br> BalancerMember ajp://t1.rlin.org:8009 loadfactor=1 route=T1 <br> BalancerMember ajp://t2.rlin.org:8009 loadfactor=2 route=T2 <br> ProxySet stickysession=ROUTEID   <span class="hljs-comment">#取消此行注释,只修改此行</span><br>&lt;/Proxy&gt;<br><br>[root@proxy ~]<span class="hljs-comment"># systemctl restart httpd</span><br></code></pre></td></tr></table></figure>

<p>多次刷新页面，不再变化</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat103.png" srcset="/blog/img/loading.gif"></p>
<p><strong>虽然，上面的做法实现客户端在一段时间内找同一台Tomcat，从而避免切换后导致的Session丢失。但是如果Tomcat节点挂掉，那么Session依旧丢失。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># systemctl stop tomcat</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat104.png" srcset="/blog/img/loading.gif"></p>
<p>再恢复t1,观察到仍不会变化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~] <span class="hljs-comment">#systemctl start tomcat</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat105.png" srcset="/blog/img/loading.gif"></p>
<p><strong>结论:</strong><br><strong>假设有A、B两个节点，都将Session持久化。如果Tomcat A节点下线期间用户切换到了Tomcat B上，就获得了Tomcat B的Session，原有Sesssion将丢失，就算将持久化Session的Tomcat A节点再次上线了，也没用了。因此需要实现Session的高可用性来解决上述问题。</strong></p>
<h1 id="五、Tomcat-Session-Replication-Cluster"><a href="#五、Tomcat-Session-Replication-Cluster" class="headerlink" title="五、Tomcat Session Replication Cluster"></a>五、Tomcat Session Replication Cluster</h1><p>Tomcat 官方实现了 Session 的复制集群,将每个Tomcat的Session进行相互的复制同步,从而保证所有Tomcat都有相同的Session信息.</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat106.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-1-配置说明"><a href="#5-1-配置说明" class="headerlink" title="5.1 配置说明"></a>5.1 配置说明</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html">https://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash">&lt;Cluster className=<span class="hljs-string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span><br>channelSendOptions=<span class="hljs-string">&quot;8&quot;</span>&gt;<br><br>&lt;Manager className=<span class="hljs-string">&quot;org.apache.catalina.ha.session.DeltaManager&quot;</span><br>expireSessionsOnShutdown=<span class="hljs-string">&quot;false&quot;</span><br> notifyListenersOnReplication=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br> <br> &lt;Channel className=<span class="hljs-string">&quot;org.apache.catalina.tribes.group.GroupChannel&quot;</span>&gt;<br>&lt;Membership className=<span class="hljs-string">&quot;org.apache.catalina.tribes.membership.McastService&quot;</span><br>address=<span class="hljs-string">&quot;228.0.0.4&quot;</span>     <span class="hljs-comment">#指定的多播地址</span><br>port=<span class="hljs-string">&quot;45564&quot;</span>  <span class="hljs-comment">#45564/UDP</span><br>frequency=<span class="hljs-string">&quot;500&quot;</span>       <span class="hljs-comment">#间隔500ms发送</span><br>dropTime=<span class="hljs-string">&quot;3000&quot;</span>/&gt;      <span class="hljs-comment">#故障阈值3s</span><br>&lt;Receiver className=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span><br> address=<span class="hljs-string">&quot;auto&quot;</span>  <span class="hljs-comment">#监听地址,此项建议修改为当前主机的IP</span><br> port=<span class="hljs-string">&quot;4000&quot;</span> <span class="hljs-comment">#监听端口</span><br> autoBind=<span class="hljs-string">&quot;100&quot;</span> <span class="hljs-comment">#如果端口冲突,自动绑定其它端口,范围是4000-4100</span><br> selectorTimeout=<span class="hljs-string">&quot;5000&quot;</span>     <span class="hljs-comment">#自动绑定超时时长5s</span><br> maxThreads=<span class="hljs-string">&quot;6&quot;</span>/&gt;<br> <br> &lt;Sender<br>className=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.ReplicationTransmitter&quot;</span>&gt;<br>&lt;Transport<br>className=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.nio.PooledParallelSender&quot;</span>/&gt;<br>&lt;/Sender&gt;<br>&lt;Interceptor<br>className=<span class="hljs-string">&quot;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&quot;</span>/&gt;<br>&lt;Interceptor<br>className=<span class="hljs-string">&quot;org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor&quot;</span>/&gt;<br>&lt;/Channel&gt;<br><br>&lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.ha.tcp.ReplicationValve&quot;</span> filter=<span class="hljs-string">&quot;&quot;</span>/&gt;<br>&lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.ha.session.JvmRouteBinderValve&quot;</span>/&gt;<br>&lt;Deployer className=<span class="hljs-string">&quot;org.apache.catalina.ha.deploy.FarmWarDeployer&quot;</span><br>tempDir=<span class="hljs-string">&quot;/tmp/war-temp/&quot;</span><br>deployDir=<span class="hljs-string">&quot;/tmp/war-deploy/&quot;</span><br>watchDir=<span class="hljs-string">&quot;/tmp/war-listen/&quot;</span><br>watchEnabled=<span class="hljs-string">&quot;false&quot;</span>/&gt;<br><br>&lt;ClusterListener<br>className=<span class="hljs-string">&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;</span>/&gt;<br>&lt;/Cluster&gt;<br><br><span class="hljs-comment">#注意:tomcat7的官方文档此处有错误</span><br>http://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html<br>......<br>&lt;ClusterListener<br>className=<span class="hljs-string">&quot;org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener&quot;</span>&gt;<br>    &lt;ClusterListener<br>className=<span class="hljs-string">&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;</span>&gt;<br>   &lt;/Cluster&gt;<br></code></pre></td></tr></table></figure>

<p>配置说明</p>
<ul>
<li>Cluster 集群配置</li>
<li>Manager 会话管理器配置</li>
<li>Channel 信道配置<ul>
<li>Membership 成员判定。使用什么多播地址、端口多少、间隔时长ms、超时时长ms。同一个多播地址和端口认为同属一个组。使用时修改这个多播地址，以防冲突</li>
<li>Receiver 接收器，多线程接收多个其他节点的心跳、会话信息。默认会从4000到4100依次尝试可用端口<ul>
<li>address=”auto”，auto可能绑定到127.0.0.1上，所以一定要改为当前主机可用的IP</li>
</ul>
</li>
<li>Sender 多线程发送器，内部使用了tcp连接池。</li>
</ul>
</li>
<li>Interceptor 拦截器</li>
<li>Valve<ul>
<li>ReplicationValve 检测哪些请求需要检测Session，Session数据是否有了变化，需要启动复制过程</li>
</ul>
</li>
<li>ClusterListener<ul>
<li>ClusterSessionListener 集群session侦听器</li>
</ul>
</li>
</ul>
<p>使用 <Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/></p>
<p>添加到 <Engine> 所有虚拟主机都可以启用Session复制</p>
<p>添加到 <Host> ，该虚拟主机可以启用Session复制</p>
<p>最后，在应用程序内部启用了才可以使用</p>
<h2 id="5-2-实战案例-实现-Tomcat-Session-集群"><a href="#5-2-实战案例-实现-Tomcat-Session-集群" class="headerlink" title="5.2 实战案例: 实现 Tomcat Session 集群"></a>5.2 实战案例: 实现 Tomcat Session 集群</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat107.png" srcset="/blog/img/loading.gif"></p>
<p>环境准备：</p>
<ul>
<li><p>时间同步，确保NTP或Chrony服务正常运行</p>
</li>
<li><p>防火墙规则</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>服务</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.201</td>
<td>proxy.rlin.org</td>
<td>调度器</td>
<td>Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.202</td>
<td>t1.rlin.org</td>
<td>tomcat1</td>
<td>JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.203</td>
<td>t2.rlin.org</td>
<td>tomcat2</td>
<td>JDK8、Tomcat8</td>
</tr>
</tbody></table>
<h3 id="5-2-1-在-proxy-主机设置-httpd-或nginx-实现后端tomcat主机轮询"><a href="#5-2-1-在-proxy-主机设置-httpd-或nginx-实现后端tomcat主机轮询" class="headerlink" title="5.2.1 在 proxy 主机设置 httpd (或nginx)实现后端tomcat主机轮询"></a>5.2.1 在 proxy 主机设置 httpd (或nginx)实现后端tomcat主机轮询</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#http</span><br>[root@proxy ~]<span class="hljs-comment"># cat /etc/httpd/conf.d/tomcat.conf</span><br>&lt;Proxy balancer://tomcat-server&gt;<br> BalancerMember http://t1.magedu.org:8080 loadfactor=1<br> BalancerMember http://t2.magedu.org:8080 loadfactor=1<br>&lt;/Proxy&gt;<br><br>&lt;VirtualHost *:80&gt;<br> ServerName    proxy.magedu.org<br> ProxyRequests   Off<br> ProxyVia     On<br> ProxyPreserveHost On <br> ProxyPass    / balancer://tomcat-server/<br> ProxyPassReverse / balancer://tomcat-server/<br>&lt;/VirtualHost&gt;<br><br>[root@proxy ~]<span class="hljs-comment">#systemctl restart httpd</span><br><br><span class="hljs-comment">#nignx</span><br>[root@proxy ~]<span class="hljs-comment"># vim /etc/nginx/nginx.conf</span><br><span class="hljs-comment">#在http块中加以下内容</span><br><span class="hljs-comment">#注意名称不要用下划线</span><br>upstream tomcat-server &#123;<br>    <span class="hljs-comment">#ip_hash; # 先禁用看看轮询，之后开启开黏性</span><br>    <span class="hljs-comment">#hash $cookie_JSESSIONID # 先禁用看看轮询，之后开启开黏性</span><br>    server t1.rlin.org:8080;<br>    server t2.rlin.org:8080;<br>&#125;<br> <br>server &#123;<br>    location ~* \.(jsp|<span class="hljs-keyword">do</span>)$ &#123;<br>        proxy_pass http://tomcat-server;<br>    &#125;<br>&#125;<br><br>[root@proxy ~]<span class="hljs-comment"># systemctl restart nginx</span><br></code></pre></td></tr></table></figure>

<h3 id="5-2-1-在所有后端tomcat主机上修改conf-server-xml"><a href="#5-2-1-在所有后端tomcat主机上修改conf-server-xml" class="headerlink" title="5.2.1 在所有后端tomcat主机上修改conf/server.xml"></a>5.2.1 在所有后端tomcat主机上修改conf/server.xml</h3><p>本次把多播复制的配置放到t1.rlin.org和t2.rlin.org虚拟主机里面， 即Host块中。</p>
<p>特别注意修改Receiver的address属性为一个本机可对外的IP地址。</p>
<h4 id="5-2-1-1-修改-t1-主机的-conf-server-xml"><a href="#5-2-1-1-修改-t1-主机的-conf-server-xml" class="headerlink" title="5.2.1.1 修改 t1 主机的 conf/server.xml"></a>5.2.1.1 修改 t1 主机的 conf/server.xml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#将5.1 内容复制到conf/server.xml的Host块内或Engine块(针对所有主机)</span><br>[root@t1 ~]<span class="hljs-comment"># vim /usr/local/tomcat/conf/server.xml</span><br>[root@t1 ~]<span class="hljs-comment"># cat /usr/local/tomcat/conf/server.xml</span><br>.....以上省略.....<br> &lt;Host name=<span class="hljs-string">&quot;t1.rlin.org&quot;</span>  appBase=<span class="hljs-string">&quot;/data/webapps&quot;</span> unpackWARs=<span class="hljs-string">&quot;true&quot;</span><br>autoDeploy=<span class="hljs-string">&quot;true&quot;</span>&gt;<br><span class="hljs-comment">###################在&lt;Host&gt; &lt;/host&gt;块中间加下面一段内容</span><br><span class="hljs-comment">##############################</span><br>&lt;Cluster className=<span class="hljs-string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span><br>                 channelSendOptions=<span class="hljs-string">&quot;8&quot;</span>&gt;<br><br>          &lt;Manager className=<span class="hljs-string">&quot;org.apache.catalina.ha.session.DeltaManager&quot;</span><br>                   expireSessionsOnShutdown=<span class="hljs-string">&quot;false&quot;</span><br>                   notifyListenersOnReplication=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br><br>          &lt;Channel className=<span class="hljs-string">&quot;org.apache.catalina.tribes.group.GroupChannel&quot;</span>&gt;<br>            &lt;Membership className=<span class="hljs-string">&quot;org.apache.catalina.tribes.membership.McastService&quot;</span><br>                        address=<span class="hljs-string">&quot;230.100.100.100&quot;</span>  <span class="hljs-comment">#指定不冲突的多播地址</span><br>                        port=<span class="hljs-string">&quot;45564&quot;</span><br>                        frequency=<span class="hljs-string">&quot;500&quot;</span><br>                        dropTime=<span class="hljs-string">&quot;3000&quot;</span>/&gt;<br>            &lt;Receiver className=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span><br>                      address=<span class="hljs-string">&quot;10.0.0.202&quot;</span>      <span class="hljs-comment">#指定网卡的IP</span><br>                      port=<span class="hljs-string">&quot;4000&quot;</span><br>                      autoBind=<span class="hljs-string">&quot;100&quot;</span><br>                      selectorTimeout=<span class="hljs-string">&quot;5000&quot;</span><br>                      maxThreads=<span class="hljs-string">&quot;6&quot;</span>/&gt;<br><br>            &lt;Sender className=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.ReplicationTransmitter&quot;</span>&gt;<br>              &lt;Transport className=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.nio.PooledParallelSender&quot;</span>/&gt;<br>            &lt;/Sender&gt;<br>            &lt;Interceptor className=<span class="hljs-string">&quot;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&quot;</span>/&gt;<br>            &lt;Interceptor className=<span class="hljs-string">&quot;org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor&quot;</span>/&gt;<br>          &lt;/Channel&gt;<br><br>          &lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.ha.tcp.ReplicationValve&quot;</span><br>                 filter=<span class="hljs-string">&quot;&quot;</span>/&gt;<br>          &lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.ha.session.JvmRouteBinderValve&quot;</span>/&gt;<br><br>          &lt;Deployer className=<span class="hljs-string">&quot;org.apache.catalina.ha.deploy.FarmWarDeployer&quot;</span><br>                    tempDir=<span class="hljs-string">&quot;/tmp/war-temp/&quot;</span><br>                    deployDir=<span class="hljs-string">&quot;/tmp/war-deploy/&quot;</span><br>                    watchDir=<span class="hljs-string">&quot;/tmp/war-listen/&quot;</span><br>                    watchEnabled=<span class="hljs-string">&quot;false&quot;</span>/&gt;<br><br>          &lt;ClusterListener className=<span class="hljs-string">&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;</span>/&gt;<br>        &lt;/Cluster&gt;<br><span class="hljs-comment">#######################################以上内容是新加的</span><br><span class="hljs-comment">#################################</span><br>  &lt;/Host&gt;<br> &lt;/Engine&gt;<br>&lt;/Service&gt;<br>&lt;/Server&gt;<br>[root@t1 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br> <br>[root@t1 ~]<span class="hljs-comment"># ss -ntl</span><br>State      Recv-Q  Send-Q Local Address:Port Peer   <br>Address:Port     <br>LISTEN      0     128        0.0.0.0:22    <br> 0.0.0.0:*       <br>LISTEN      0     100       127.0.0.1:25    <br> 0.0.0.0:*       <br>LISTEN      0     128      [::]:22     [::]:*<br>      <br>LISTEN      0     100             [::1]:25     [::]:*<br>      <br>LISTEN      0     50      [::ffff:10.0.0.101]:4000      *:*<br>      <br>LISTEN      0     1        ::ffff:127.0.0.1]:8005      *:*<br>      <br>LISTEN      0     100       *:8009      *:*<br><br>LISTEN      0     100               *:8080      *:*<br></code></pre></td></tr></table></figure>

<p><strong>简化说明</strong><br>t1的conf/server.xml中，如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;t1.magedu.com&quot;</span> <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br> #其他略去<br>  <span class="hljs-tag">&lt;<span class="hljs-name">Receiver</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.0.0.201&quot;</span>  #只改此行</span><br><span class="hljs-tag"> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;4000&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">autoBind</span>=<span class="hljs-string">&quot;100&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">selectorTimeout</span>=<span class="hljs-string">&quot;5000&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">maxThreads</span>=<span class="hljs-string">&quot;6&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="5-2-1-2-修改-t2-主机的-conf-server-xml"><a href="#5-2-1-2-修改-t2-主机的-conf-server-xml" class="headerlink" title="5.2.1.2 修改 t2 主机的 conf/server.xml"></a>5.2.1.2 修改 t2 主机的 conf/server.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@t2 ~]#vim /usr/local/tomcat/conf/server.xml<br>[root@t2 ~]#cat /usr/local/tomcat/conf/server.xml<br>.....以上省略.....<br> <span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;localhost&quot;</span>  <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;webapps&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">unpackWARs</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- SingleSignOn valve, share authentication between web applications</span><br><span class="hljs-comment">      Documentation at: /docs/config/valve.html --&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    &lt;Valve className=&quot;org.apache.catalina.authenticator.SingleSignOn&quot; /&gt;</span><br><span class="hljs-comment">    --&gt;</span><br>    <br>     <span class="hljs-comment">&lt;!-- Access log processes all example.</span><br><span class="hljs-comment">      Documentation at: /docs/config/valve.html</span><br><span class="hljs-comment">      <span class="hljs-doctag">Note:</span> The pattern used is equivalent to using pattern=&quot;common&quot; --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">directory</span>=<span class="hljs-string">&quot;logs&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">prefix</span>=<span class="hljs-string">&quot;localhost_access_log&quot;</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">&quot;.txt&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;%h %l %u %t <span class="hljs-symbol">&amp;quot;</span>%r<span class="hljs-symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span><br>       <br>       <span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;t2.magedu.org&quot;</span> <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br>     <br>     ###################在<span class="hljs-tag">&lt;<span class="hljs-name">Host</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span>块中间加下面一段内容##############################<br>  <span class="hljs-tag">&lt;<span class="hljs-name">Cluster</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">channelSendOptions</span>=<span class="hljs-string">&quot;8&quot;</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">Manager</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.ha.session.DeltaManager&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">expireSessionsOnShutdown</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">notifyListenersOnReplication</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">Channel</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.tribes.group.GroupChannel&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Membership</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.tribes.membership.McastService&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">address</span>=<span class="hljs-string">&quot;230.100.100.100&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">port</span>=<span class="hljs-string">&quot;45564&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">frequency</span>=<span class="hljs-string">&quot;500&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">dropTime</span>=<span class="hljs-string">&quot;3000&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Receiver</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.0.0.102&quot;</span>       #此行指定当前主机的<span class="hljs-attr">IP</span>,其它和<span class="hljs-attr">T1</span>节点配置相同</span><br><span class="hljs-tag"> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;4000&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">autoBind</span>=<span class="hljs-string">&quot;100&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">selectorTimeout</span>=<span class="hljs-string">&quot;5000&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">maxThreads</span>=<span class="hljs-string">&quot;6&quot;</span>/&gt;</span><br>     <br><span class="hljs-tag">&lt;<span class="hljs-name">Sender</span></span><br><span class="hljs-tag"><span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.ReplicationTransmitter&quot;</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">Transport</span></span><br><span class="hljs-tag"><span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.nio.PooledParallelSender&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Sender</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Interceptor</span></span><br><span class="hljs-tag"><span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Interceptor</span></span><br><span class="hljs-tag"><span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.tribes.group.interceptors.MessageDispatchIntercep</span></span><br><span class="hljs-string"><span class="hljs-tag">tor&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Channel</span>&gt;</span><br>      <br><span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.ha.tcp.ReplicationValve&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">filter</span>=<span class="hljs-string">&quot;&quot;</span>/&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.ha.session.JvmRouteBinderValve&quot;</span>/&gt;</span><br>      <br><span class="hljs-tag">&lt;<span class="hljs-name">Deployer</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.ha.deploy.FarmWarDeployer&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">tempDir</span>=<span class="hljs-string">&quot;/tmp/war-temp/&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">deployDir</span>=<span class="hljs-string">&quot;/tmp/war-deploy/&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">watchDir</span>=<span class="hljs-string">&quot;/tmp/war-listen/&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">watchEnabled</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>      <br>ClusterListener<br>className=&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;/&gt;<br><span class="hljs-tag">&lt;/<span class="hljs-name">Cluster</span>&gt;</span><br>#######################################以上内容是新加的<br>#################################<br>       <span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">Engine</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">Service</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Server</span>&gt;</span><br>[root@t2 ~]#systemctl restart tomcat<br>[root@t2 ~]#ss -ntl<br>State      Recv-Q  Send-Q    Local Address:Port  Peer Address:Port <br>LISTEN      0    128        0.0.0.0:22      0.0.0.0:*  <br>LISTEN      0    100       127.0.0.1:25      0.0.0.0:*  <br>LISTEN      0    128          [::]:22       [::]:*  <br>LISTEN      0    100         [::1]:25       [::]:*  <br>LISTEN      0    50   [::ffff:10.0.0.102]:4000        *:*  <br>LISTEN      0    1    [::ffff:127.0.0.1]:8005        *:*  <br>LISTEN      0    100           *:8009        *:*  <br>LISTEN      0    100           *:8080        *:*  <br></code></pre></td></tr></table></figure>

<p><strong>简化说明</strong><br>t2主机的server.xml中，如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;t2.magedu.com&quot;</span> <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;/data/webapps&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br> 其他略去<br>  <span class="hljs-tag">&lt;<span class="hljs-name">Receiver</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;10.0.0.102&quot;</span>  #只改此行</span><br><span class="hljs-tag"> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;4000&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">autoBind</span>=<span class="hljs-string">&quot;100&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">selectorTimeout</span>=<span class="hljs-string">&quot;5000&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">maxThreads</span>=<span class="hljs-string">&quot;6&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<p>尝试使用刚才配置过得负载均衡(移除Session黏性)，测试发现Session还是变来变去。</p>
<h3 id="5-2-3-修改应用的web-xml文件开启该应用程序的分布式"><a href="#5-2-3-修改应用的web-xml文件开启该应用程序的分布式" class="headerlink" title="5.2.3 修改应用的web.xml文件开启该应用程序的分布式"></a>5.2.3 修改应用的web.xml文件开启该应用程序的分布式</h3><p>参考官方说明: <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html">https://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat108.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">Make sure your web.<span class="hljs-keyword">xml</span> <span class="hljs-title">has</span> the <span class="hljs-tag">&lt;distributable/&gt;</span> element<br></code></pre></td></tr></table></figure>

<p>为所有tomcat主机应用web.xml的 <web-app> 标签增加子标签 <distributable/> 来开启该应用程序的分布式。</p>
<h4 id="5-2-3-1-修改t1主机的应用的web-xml文件"><a href="#5-2-3-1-修改t1主机的应用的web-xml文件" class="headerlink" title="5.2.3.1 修改t1主机的应用的web.xml文件"></a>5.2.3.1 修改t1主机的应用的web.xml文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># ll /usr/local/tomcat/webapps/ROOT/WEB-INF/</span><br>total 4<br>-rw-r----- 1 tomcat tomcat 1227 Jul  1 05:53 web.xml<br>[root@t1 ~]<span class="hljs-comment"># cp -a /usr/local/tomcat/webapps/ROOT/WEB-INF/ /data/webapps/ROOT/</span><br>[root@t1 ~]<span class="hljs-comment"># tree /data/webapps/ROOT/</span><br>/data/webapps/ROOT/<br>├── index.jsp<br>└── WEB-INF<br> └── web.xml<br><br>1 directory, 2 files<br><br><span class="hljs-comment">#在倒数第二行加一行</span><br>[root@t1 ~]<span class="hljs-comment"># vim /data/webapps/ROOT/WEB-INF/web.xml</span><br><span class="hljs-comment">#添加前</span><br>[root@t1 ~]<span class="hljs-comment"># tail -n3 /data/webapps/ROOT/WEB-INF/web.xml</span><br>  &lt;/description&gt;<br><br>&lt;/web-app&gt;<br><span class="hljs-comment">#添加后</span><br>[root@t1 ~]<span class="hljs-comment"># tail -n3 /data/webapps/ROOT/WEB-INF/web.xml</span><br>&lt;/description&gt;<br>&lt;distributable/&gt;  <span class="hljs-comment">#添加此行</span><br>&lt;/web-app&gt;<br><br><span class="hljs-comment">#注意权限</span><br>[root@t1 ~]<span class="hljs-comment"># ll /data/webapps/ROOT/WEB-INF/</span><br>total 4<br>-rw-r----- 1 tomcat tomcat 1243 Jan 17 09:37 web.xml<br><br>[root@t1 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br><br><span class="hljs-comment">#同时观察日志</span><br>[root@t1 ~]<span class="hljs-comment"># tail -f /usr/local/tomcat/logs/catalina.out</span><br>15-Jul-2020 11:29:10.998 INFO [Membership-MemberAdded.]<br>org.apache.catalina.ha.tcp.SimpleTcpCluster.memberAdded Replication member<br>added:[org.apache.catalina.tribes.membership.MemberImpl[tcp://&#123;10, 0, 0,<br>102&#125;:4000,&#123;10, 0, 0, 102&#125;,4000, alive=1022, securePort=-1, UDP Port=-1, id=&#123;89<br>-26 -30 -99 16 80 65 95 -65 14 -33 124 -55 -123 -30 82 &#125;, payload=&#123;&#125;, <span class="hljs-built_in">command</span>=<br>&#123;&#125;, domain=&#123;&#125;]]<br></code></pre></td></tr></table></figure>

<h4 id="5-2-3-2-修改t2主机的应用的web-xml文件"><a href="#5-2-3-2-修改t2主机的应用的web-xml文件" class="headerlink" title="5.2.3.2 修改t2主机的应用的web.xml文件"></a>5.2.3.2 修改t2主机的应用的web.xml文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#与5.2.3.1上的t1相同的操作</span><br>[root@t2 ~]<span class="hljs-comment"># cp -a /usr/local/tomcat/webapps/ROOT/WEB-INF/ /data/webapps/ROOT/</span><br>[root@t2 ~]<span class="hljs-comment"># vim /data/webapps/ROOT/WEB-INF/web.xml</span><br>[root@t2 ~]<span class="hljs-comment"># tail -n3 /data/webapps/ROOT/WEB-INF/web.xml</span><br>&lt;/description&gt;<br>&lt;distributable/&gt;  <span class="hljs-comment">#添加此行</span><br>&lt;/web-app&gt;<br><br><span class="hljs-comment">#注意权限</span><br>[root@t2 ~]<span class="hljs-comment"># ll /data/webapps/ROOT/WEB-INF/</span><br>total 4<br>-rw-r----- 1 tomcat tomcat 1243 Jan 17 09:38 web.xml<br><br>[root@t2 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br><br><span class="hljs-comment">#同时观察日志</span><br>[root@t2 ~]<span class="hljs-comment"># tail -f /usr/local/tomcat/logs/catalina.out</span><br>15-Jul-2020 11:29:12.088 INFO [t2.magedu.org-startStop-1]<br>org.apache.catalina.ha.session.DeltaManager.getAllClusterSessions Manager [],<br>requesting session state from<br>[org.apache.catalina.tribes.membership.MemberImpl[tcp://&#123;10, 0, 0, 101&#125;:4000,<br>&#123;10, 0, 0, 101&#125;,4000, alive=208408, securePort=-1, UDP Port=-1, id=&#123;118 -108<br>-116 119 58 22 73 113 -123 -96 -94 111 -65 -90 -87 -107 &#125;, payload=&#123;&#125;, <span class="hljs-built_in">command</span>=<br>&#123;&#125;, domain=&#123;&#125;]]. This operation will timeout <span class="hljs-keyword">if</span> no session state has been<br>received within [60] seconds.<br></code></pre></td></tr></table></figure>

<h3 id="5-2-4-测试访问"><a href="#5-2-4-测试访问" class="headerlink" title="5.2.4 测试访问"></a>5.2.4 测试访问</h3><p>重启全部Tomcat，通过负载均衡调度到不同节点，返回的SessionID不变了。</p>
<p>用浏览器访问,并刷新多次,发现SessionID 不变,但后端主机在轮询</p>
<p><strong>但此方式当后端tomcat主机较多时,会重复占用大量的内存,并不适合后端服务器众多的场景</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat109.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat110.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#修改t1和t2的配置项,删除jvmRoute配置项</span><br>[root@t1 tomcat]<span class="hljs-comment"># vim conf/server.xml</span><br>&lt;Engine name=<span class="hljs-string">&quot;Catalina&quot;</span> defaultHost=<span class="hljs-string">&quot;t1.rlin.org&quot;</span> &gt;<br>[root@t1 tomcat]<span class="hljs-comment">#systemctl restart tomcat</span><br><br><span class="hljs-comment">#多次执行下面操作,可以看到SessionID不变</span><br>[root@centos7 ~]<span class="hljs-comment"># curl -b &#x27;JSESSIONID=1A3E7EED14F3E44FAF7469F8693E1CB6&#x27; proxy.rlin.org/index.jsp</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;div&gt;On tomcat-server&lt;/div&gt;<br>&lt;div&gt;10.0.0.202:8080&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;C58631F7C0C9BEE2CBE6681B4AD30D4E&lt;/span&gt;&lt;/div&gt;<br>Thu Aug 12 09:05:59 CST 2021<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@centos7 ~]<span class="hljs-comment">#curl -b &#x27;JSESSIONID=1A3E7EED14F3E44FAF7469F8693E1CB6&#x27; proxy.magedu.org/index.jsp</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;div&gt;On tomcat-server&lt;/div&gt;<br>&lt;div&gt;10.0.0.203:8080&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;C58631F7C0C9BEE2CBE6681B4AD30D4E&lt;/span&gt;&lt;/div&gt;<br>Thu Aug 12 09:06:07 CST 2021<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@centos7 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat111.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-5-故障模拟"><a href="#5-2-5-故障模拟" class="headerlink" title="5.2.5 故障模拟"></a>5.2.5 故障模拟</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#模拟t2节点故障</span><br>[root@t2 ~]<span class="hljs-comment"># systemctl stop tomcat</span><br><br><span class="hljs-comment">#多次访问SessionID不变</span><br>[root@centos7 ~]<span class="hljs-comment"># curl -b &#x27;JSESSIONID=1A3E7EED14F3E44FAF7469F8693E1CB6&#x27; proxy.magedu.org/index.jsp</span><br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;div&gt;On tomcat-server&lt;/div&gt;<br>&lt;div&gt;10.0.0.202:8080&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;C58631F7C0C9BEE2CBE6681B4AD30D4E&lt;/span&gt;&lt;/div&gt;<br>Thu Aug 12 09:06:32 CST 2021<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<h3 id="5-2-6-恢复实验环境"><a href="#5-2-6-恢复实验环境" class="headerlink" title="5.2.6 恢复实验环境"></a>5.2.6 恢复实验环境</h3><p>本小节结束,为学习后面的内容,删除此节相关配置,为后续内容准备</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#恢复t1环境</span><br>[root@t1 ~]<span class="hljs-comment"># vim /usr/local/tomcat/conf/server.xml</span><br>[root@t1 ~]<span class="hljs-comment"># tail /usr/local/tomcat/conf/server.xml</span><br>   &lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span><br>directory=<span class="hljs-string">&quot;logs&quot;</span><br>       prefix=<span class="hljs-string">&quot;localhost_access_log&quot;</span> suffix=<span class="hljs-string">&quot;.txt&quot;</span><br>       pattern=<span class="hljs-string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;<br>       <br>       &lt;/Host&gt;<br>  &lt;Host name=<span class="hljs-string">&quot;t1.rlin.org&quot;</span>  appBase=<span class="hljs-string">&quot;/data/webapps&quot;</span> unpackWARs=<span class="hljs-string">&quot;true&quot;</span><br>autoDeploy=<span class="hljs-string">&quot;true&quot;</span>&gt;<br>  &lt;/Host&gt;<br> &lt;/Engine&gt;<br>&lt;/Service&gt;<br>&lt;/Server&gt;<br>[root@t1 ~]<span class="hljs-comment"># rm -f  /data/webapps/ROOT/WEB-INF/web.xml</span><br>[root@t1 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br><br><span class="hljs-comment">#恢复t2环境</span><br>[root@t2 ~]<span class="hljs-comment"># vim /usr/local/tomcat/conf/server.xml</span><br>[root@t2 ~]<span class="hljs-comment"># tail /usr/local/tomcat/conf/server.xml</span><br>       prefix=<span class="hljs-string">&quot;localhost_access_log&quot;</span> suffix=<span class="hljs-string">&quot;.txt&quot;</span><br>       pattern=<span class="hljs-string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;<br>       <br>       &lt;/Host&gt;<br>    &lt;Host name=<span class="hljs-string">&quot;t2.rlin.org&quot;</span> appBase=<span class="hljs-string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="hljs-string">&quot;true&quot;</span> &gt;<br>      &lt;/Host&gt;<br> &lt;/Engine&gt;<br>&lt;/Service&gt;<br>&lt;/Server&gt;<br>[root@t2 ~]<span class="hljs-comment"># rm -f  /data/webapps/ROOT/WEB-INF/web.xml</span><br>[root@t2 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br></code></pre></td></tr></table></figure>



<h1 id="六、Memcached"><a href="#六、Memcached" class="headerlink" title="六、Memcached"></a>六、Memcached</h1><h3 id="6-1-NoSQL介绍"><a href="#6-1-NoSQL介绍" class="headerlink" title="6.1 NoSQL介绍"></a>6.1 NoSQL介绍</h3><p>NoSQL是对 Not Only SQL、非传统关系型数据库的统称。</p>
<p>NoSQL一词诞生于1998年，2009年这个词汇被再次提出指非关系型、分布式、不提供ACID的数据库设计模式。</p>
<p>随着互联网时代的到来，数据爆发式增长，数据库技术发展日新月异，要适应新的业务需求。</p>
<p>而随着移动互联网、物联网的到来，大数据的技术中NoSQL也同样重要。</p>
<p>数据库排名：<a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking">https://db-engines.com/en/ranking</a><br>NoSQL 分类</p>
<ul>
<li>Key-value Store k/v数据库<ul>
<li>性能好 O(1) , 如: redis、memcached</li>
</ul>
</li>
<li>Document Store 文档数据库<ul>
<li>mongodb、CouchDB</li>
</ul>
</li>
<li>Column Store 列存数据库，Column-Oriented DB<ul>
<li>HBase、Cassandra，大数据领域应用广泛</li>
</ul>
</li>
<li>Graph DB 图数据库<ul>
<li>Neo4j</li>
</ul>
</li>
<li>Time Series 时序数据库<ul>
<li>InfluxDB、Prometheus </li>
</ul>
</li>
</ul>
<h2 id="6-2-Memcached"><a href="#6-2-Memcached" class="headerlink" title="6.2 Memcached"></a>6.2 Memcached</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat112.png" srcset="/blog/img/loading.gif"></p>
<p>Memcached 只支持能序列化的数据类型，不支持持久化，基于Key-Value的内存缓存系统</p>
<p>memcached 虽然没有像redis所具备的数据持久化功能，比如RDB和AOF都没有，但是可以通过做集群同步的方式，让各memcached服务器的数据进行同步，从而实现数据的一致性，即保证各memcached的数据是一样的，即使有任何一台 memcached 发生故障，只要集群中有一台memcached 可用就不会出现数据丢失，当其他memcached 重新加入到集群的时候,可以自动从有数据的memcached 当中自动获取数据并提供服务。</p>
<p>Memcached 借助了操作系统的 libevent 工具做高效的读写。libevent是个程序库，它将Linux的epoll、BSD类操作系统的kqueue等事件处理功能封装成统一的接口。即使对服务器的连接数增加，也能发挥高性能。memcached使用这个libevent库，因此能在Linux、BSD、Solaris等操作系统上发挥其高性能</p>
<p>Memcached 支持最大的内存存储对象为1M，超过1M的数据可以使用客户端压缩或拆分报包放到多个key中，比较大的数据在进行读取的时候需要消耗的时间比较长，memcached 最适合保存用户的session实现session共享</p>
<p>Memcached存储数据时, Memcached会去申请1MB的内存, 把该块内存称为一个slab, 也称为一个page</p>
<p>Memcached 支持多种开发语言，包括：JAVA,C,Python,PHP,C#,Ruby,Perl等</p>
<p>Memcached 官网：<a target="_blank" rel="noopener" href="http://memcached.org/">http://memcached.org/</a></p>
<h2 id="6-3-Memcached-和-Redis-比较"><a href="#6-3-Memcached-和-Redis-比较" class="headerlink" title="6.3 Memcached 和 Redis 比较"></a>6.3 Memcached 和 Redis 比较</h2><table>
<thead>
<tr>
<th>比较类别</th>
<th>Redis</th>
<th>memcached</th>
</tr>
</thead>
<tbody><tr>
<td>支持的数据结构</td>
<td>哈希、列表、集合、有序集合</td>
<td>纯kev-value</td>
</tr>
<tr>
<td>持久化支持</td>
<td>有</td>
<td>无</td>
</tr>
<tr>
<td>高可用支持</td>
<td>redis支持集群功能，可以实现主动复制，读写分离。官方也提供了sentinel集群管理工具，能够实现主从服务监控，故障自动转移，这一切，对于客户端都是透明的，无需程序改动，也无需人工介入</td>
<td>需要二次开发</td>
</tr>
<tr>
<td>存储value容量</td>
<td>最大512M</td>
<td>最大1M</td>
</tr>
<tr>
<td>内存分配</td>
<td>临时申请空间，可能导致碎片</td>
<td>预分配内存池的方式管理内存，能够省去内存分配时间</td>
</tr>
<tr>
<td>虚拟内存使用</td>
<td>有自己的VM机制，理论上能够存储比物理内存更多的数据，当数据超量时，会引发swap，把冷数据刷到磁盘上</td>
<td>所有的数据存储在物理内存里</td>
</tr>
<tr>
<td>网络模型</td>
<td>非阻塞IO复用模型,提供一些非KV存储之外的排序，聚合功能，在执行这些功能时，复杂的CPU计算，会阻塞整个IO调度</td>
<td>非阻塞IO复用模型</td>
</tr>
<tr>
<td>水平扩展的支持</td>
<td>redis cluster 可以横向扩展</td>
<td>暂无</td>
</tr>
<tr>
<td>多线程</td>
<td>Redis6.0之前是只支持单线程</td>
<td>Memcached支持多线程,CPU利用方面Memcache优于Redis</td>
</tr>
<tr>
<td>过期策略</td>
<td>有专门线程，清除缓存数据</td>
<td>懒淘汰机制：每次往缓存放入数据的时候，都会存一个时间，在读取的时候要和设置的时间做TTL比较来判断是否过期</td>
</tr>
<tr>
<td>单机QPS</td>
<td>约10W</td>
<td>约60W</td>
</tr>
<tr>
<td>源代码可读性</td>
<td>代码清爽简洁</td>
<td>可能是考虑了太多的扩展性，多系统的兼容性，代码不清爽</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>复杂数据结构、有持久化、高可用需求、value存储内容较大</td>
<td>纯KV，数据量非常大，并发量非常大的业务</td>
</tr>
</tbody></table>
<h2 id="6-4-Memcached-工作机制"><a href="#6-4-Memcached-工作机制" class="headerlink" title="6.4 Memcached 工作机制"></a>6.4 Memcached 工作机制</h2><h3 id="6-4-1-内存分配机制"><a href="#6-4-1-内存分配机制" class="headerlink" title="6.4.1 内存分配机制"></a>6.4.1 内存分配机制</h3><p>应用程序运行需要使用内存存储数据，但对于一个缓存系统来说，申请内存、释放内存将十分频繁，非常容易导致大量内存碎片，最后导致无连续可用内存可用。</p>
<p>Memcached采用了Slab Allocator机制来分配、管理内存。</p>
<ul>
<li>Page：分配给Slab的内存空间，默认为1MB，分配后就得到一个Slab。Slab分配之后内存按照固<br>定字节大小等分成chunk。</li>
<li>Chunk：用于缓存记录k/v值的内存空间。Memcached会根据数据大小选择存到哪一个chunk中，假设chunk有128bytes、64bytes等多种，数据只100bytes存储在128bytes中，存在少许浪费。<ul>
<li>Chunk最大就是Page的大小，即一个Page中就一个Chunk </li>
</ul>
</li>
<li>Slab Class：Slab按照Chunk的大小分组，就组成不同的Slab Class, 第一个Chunk大小为 96B的Slab为Class1,Chunk 120B为Class 2,如果有100bytes要存，那么Memcached会选择下图中SlabClass 2 存储，因为它是120bytes的Chunk。Slab之间的差异可以使用Growth Factor 控制，默认1.25。 </li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat113.png" srcset="/blog/img/loading.gif"></p>
<p>范例：查看Slab Class</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#-f, --slab-growth-factor=&lt;num&gt; chunk size growth factor (default: 1.25)</span><br>[root@centos8 ~]<span class="hljs-comment"># memcached -u memcached -f 2 -vv</span><br>slab class  1: chunk size     96 perslab  10922<br>slab class  2: chunk size    192 perslab   5461<br>slab class  3: chunk size    384 perslab   2730<br>slab class  4: chunk size    768 perslab   1365<br>slab class  5: chunk size    1536 perslab   682<br>slab class  6: chunk size    3072 perslab   341<br>slab class  7: chunk size    6144 perslab   170<br>slab class  8: chunk size   12288 perslab    85<br>slab class  9: chunk size   24576 perslab    42<br>slab class  10: chunk size   49152 perslab    21<br>slab class  11: chunk size   98304 perslab    10<br>slab class  12: chunk size   196608 perslab    5<br>slab class  13: chunk size   524288 perslab    2<br>&lt;27 server listening (auto-negotiate)<br>&lt;28 server listening (auto-negotiate)<br></code></pre></td></tr></table></figure>

<h3 id="6-4-2-懒过期-Lazy-Expiration"><a href="#6-4-2-懒过期-Lazy-Expiration" class="headerlink" title="6.4.2 懒过期 Lazy Expiration"></a>6.4.2 懒过期 Lazy Expiration</h3><p>memcached不会监视数据是否过期，而是在取数据时才看是否过期，如果过期,把数据有效期限标识为0，并不清除该数据。以后可以覆盖该位置存储其它数据。</p>
<h3 id="6-4-3-LRU"><a href="#6-4-3-LRU" class="headerlink" title="6.4.3 LRU"></a>6.4.3 LRU</h3><p>当内存不足时，memcached会使用LRU（Least Recently Used）机制来查找可用空间，分配给新记录使用。</p>
<h3 id="6-4-4-集群"><a href="#6-4-4-集群" class="headerlink" title="6.4.4 集群"></a>6.4.4 集群</h3><p>Memcached集群，称为基于客户端的分布式集群，即由客户端实现集群功能，即Memcached本身不支持集群</p>
<p>Memcached集群内部并不互相通信，一切都需要客户端连接到Memcached服务器后自行组织这些节点，并决定数据存储的节点。</p>
<h2 id="6-5-安装和启动"><a href="#6-5-安装和启动" class="headerlink" title="6.5 安装和启动"></a>6.5 安装和启动</h2><p>官方安装说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://github.com/memcached/memcached/wiki/Install<br></code></pre></td></tr></table></figure>

<h3 id="6-5-1-yum安装"><a href="#6-5-1-yum安装" class="headerlink" title="6.5.1 yum安装"></a>6.5.1 yum安装</h3><p>范例: CentOS 8 安装 memcached</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum info memcached</span><br>Last metadata expiration check: 0:57:53 ago on Thu 12 Aug 2021 08:47:58 AM CST.<br>Available Packages<br>Name         : memcached<br>Version      : 1.5.22<br>Release      : 2.el8<br>Architecture : x86_64<br>Size         : 162 k<br>Source       : memcached-1.5.22-2.el8.src.rpm<br>Repository   : AppStream<br>Summary      : High Performance, Distributed Memory Object Cache<br>URL          : https://www.memcached.org/<br>License      : BSD<br>Description  : memcached is a high-performance, distributed memory object caching<br>             : system, generic <span class="hljs-keyword">in</span> nature, but intended <span class="hljs-keyword">for</span> use <span class="hljs-keyword">in</span> speeding up dynamic<br>             : web applications by alleviating database load.<br>      <br>[root@centos8 ~]<span class="hljs-comment"># yum -y install memcached</span><br>[root@centos8 ~]<span class="hljs-comment"># rpm -ql memcached</span><br>/etc/sysconfig/memcached<br>/usr/bin/memcached<br>/usr/bin/memcached-tool<br>/usr/lib/.build-id<br>/usr/lib/.build-id/25<br>/usr/lib/.build-id/25/9ffe16926831a542c5c1a8fbdfdf063429439e<br>/usr/lib/systemd/system/memcached.service<br>/usr/share/doc/memcached<br>/usr/share/doc/memcached/AUTHORS<br>/usr/share/doc/memcached/CONTRIBUTORS<br>/usr/share/doc/memcached/COPYING<br>/usr/share/doc/memcached/ChangeLog<br>/usr/share/doc/memcached/NEWS<br>/usr/share/doc/memcached/README.md<br>/usr/share/doc/memcached/new_lru.txt<br>/usr/share/doc/memcached/protocol-binary-range.txt<br>/usr/share/doc/memcached/protocol-binary.txt<br>/usr/share/doc/memcached/protocol.txt<br>/usr/share/doc/memcached/readme.txt<br>/usr/share/doc/memcached/storage.txt<br>/usr/share/doc/memcached/threads.txt<br>/usr/share/doc/memcached/tls.txt<br>/usr/share/man/man1/memcached-tool.1.gz<br>/usr/share/man/man1/memcached.1.gz<br><br>[root@t1 ~]<span class="hljs-comment"># cat /etc/sysconfig/memcached</span><br>PORT=<span class="hljs-string">&quot;11211&quot;</span>   <span class="hljs-comment">#监听端口</span><br>USER=<span class="hljs-string">&quot;memcached&quot;</span> <span class="hljs-comment">#启动用户</span><br>MAXCONN=<span class="hljs-string">&quot;1024&quot;</span>  <span class="hljs-comment">#最大连接数</span><br>CACHESIZE=<span class="hljs-string">&quot;64&quot;</span>  <span class="hljs-comment">#最大使用内存</span><br>OPTIONS=<span class="hljs-string">&quot;-l 127.0.0.1,::1&quot;</span> <span class="hljs-comment">#其他选项</span><br><br>[root@centos8 ~]<span class="hljs-comment"># grep -Ev &quot;^#|^$&quot; /usr/lib/systemd/system/memcached.service</span><br>[Unit]<br>Description=memcached daemon<br>Before=httpd.service<br>After=network.target<br>[Service]<br>EnvironmentFile=/etc/sysconfig/memcached<br>ExecStart=/usr/bin/memcached -p <span class="hljs-variable">$&#123;PORT&#125;</span> -u <span class="hljs-variable">$&#123;USER&#125;</span> -m <span class="hljs-variable">$&#123;CACHESIZE&#125;</span> -c <span class="hljs-variable">$&#123;MAXCONN&#125;</span> <span class="hljs-variable">$OPTIONS</span><br>PrivateTmp=<span class="hljs-literal">true</span><br>ProtectSystem=full<br>NoNewPrivileges=<span class="hljs-literal">true</span><br>PrivateDevices=<span class="hljs-literal">true</span><br>CapabilityBoundingSet=CAP_SETGID CAP_SETUID CAP_SYS_RESOURCE<br>RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX<br>[Install]<br>WantedBy=multi-user.target<br><br>[root@centos8 ~]<span class="hljs-comment"># getent passwd memcached</span><br>memcached:x:992:989:Memcached daemon:/run/memcached:/sbin/nologin<br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable --now memcached</span><br>[root@centos8 ~]<span class="hljs-comment"># pstree -p |grep memcached</span><br>     |-memcached(25582)-+-&#123;memcached&#125;(25584)<br>     |         |-&#123;memcached&#125;(25585)<br>     |         |-&#123;memcached&#125;(25586)<br>     |         |-&#123;memcached&#125;(25587)<br>     |         |-&#123;memcached&#125;(25588)<br>     |         |-&#123;memcached&#125;(25589)<br>     |         |-&#123;memcached&#125;(25590)<br>     |         |-&#123;memcached&#125;(25591)<br>     |          `-&#123;memcached&#125;(25592)<br>     <br>[root@centos8 ~]<span class="hljs-comment"># ss -ntlup|grep memcached</span><br>tcp  LISTEN  0    128         127.0.0.1:11211     0.0.0.0:*  <br>users:((<span class="hljs-string">&quot;memcached&quot;</span>,pid=25453,fd=27))     <br>tcp  LISTEN  0    128          [::1]:11211      [::]:*  <br>users:((<span class="hljs-string">&quot;memcached&quot;</span>,pid=25453,fd=28)) <br><br><span class="hljs-comment">#修改端口绑定的IP为当前主机的所有IP</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/sysconfig/memcached</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/sysconfig/memcached</span><br>PORT=<span class="hljs-string">&quot;11211&quot;</span><br>USER=<span class="hljs-string">&quot;memcached&quot;</span><br>MAXCONN=<span class="hljs-string">&quot;1024&quot;</span><br>CACHESIZE=<span class="hljs-string">&quot;64&quot;</span><br><span class="hljs-comment">#OPTIONS=&quot;-l 127.0.0.1,::1&quot; #注释此行</span><br>OPTIONS=<span class="hljs-string">&quot;&quot;</span><br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart memcached.service</span><br>[root@centos8 ~]<span class="hljs-comment"># ss -ntul</span><br>Netid   State  Recv-Q Send-Q Local Address:Port  Peer Address:Port   <br>udp    UNCONN  0    0      127.0.0.1:323      0.0.0.0:*    <br>udp    UNCONN  0    0       [::1]:323       [::]:*    <br>tcp    LISTEN  0    128      0.0.0.0:22      0.0.0.0:*    <br>tcp    LISTEN  0    100     127.0.0.1:25      0.0.0.0:*    <br>tcp    LISTEN  0    128      0.0.0.0:11211     0.0.0.0:*    <br>tcp    LISTEN  0    128       [::]:22       [::]:*    <br>tcp    LISTEN  0    100      [::1]:25       [::]:*    <br>tcp    LISTEN  0    128       [::]:11211      [::]:*<br></code></pre></td></tr></table></figure>

<p>范例: CentOS 7 安装 memcached</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum info memcached</span><br>Loaded plugins: fastestmirror<br>Loading mirror speeds from cached hostfile<br>Available Packages<br>Name        : memcached<br>Arch        : x86_64<br>Version     : 1.4.15<br>Release     : 10.el7_3.1<br>Size        : 85 k<br>Repo        : base/7/x86_64<br>Summary     : High Performance, Distributed Memory Object Cache<br>URL         : http://www.memcached.org/<br>License     : BSD<br>Description : memcached is a high-performance, distributed memory object caching<br>            : system, generic <span class="hljs-keyword">in</span> nature, but intended <span class="hljs-keyword">for</span> use <span class="hljs-keyword">in</span> speeding up dynamic<br>            : web applications by alleviating database load.<br>     <br>[root@centos7 ~]<span class="hljs-comment"># yum install memcached</span><br>[root@centos7 ~]<span class="hljs-comment"># rpm -ql memcached</span><br>/etc/sysconfig/memcached<br>/usr/bin/memcached<br>/usr/bin/memcached-tool<br>/usr/lib/systemd/system/memcached.service<br>/usr/share/doc/memcached-1.4.15<br>/usr/share/doc/memcached-1.4.15/AUTHORS<br>/usr/share/doc/memcached-1.4.15/CONTRIBUTORS<br>/usr/share/doc/memcached-1.4.15/COPYING<br>/usr/share/doc/memcached-1.4.15/ChangeLog<br>/usr/share/doc/memcached-1.4.15/NEWS<br>/usr/share/doc/memcached-1.4.15/README.md<br>/usr/share/doc/memcached-1.4.15/protocol.txt<br>/usr/share/doc/memcached-1.4.15/readme.txt<br>/usr/share/doc/memcached-1.4.15/threads.txt<br>/usr/share/man/man1/memcached-tool.1.gz<br>/usr/share/man/man1/memcached.1.gz<br><br>[root@centos7 ~]<span class="hljs-comment"># getent passwd memcached</span><br>memcached:x:997:995:Memcached daemon:/run/memcached:/sbin/nologin<br><br>[root@centos7 ~]<span class="hljs-comment"># cat /usr/lib/systemd/system/memcached.service</span><br>[Service]<br>Type=simple<br>EnvironmentFile=-/etc/sysconfig/memcached<br>ExecStart=/usr/bin/memcached -u <span class="hljs-variable">$USER</span> -p <span class="hljs-variable">$PORT</span> -m <span class="hljs-variable">$CACHESIZE</span> -c <span class="hljs-variable">$MAXCONN</span><br><span class="hljs-variable">$OPTIONS</span><br><br>[root@centos7 ~]<span class="hljs-comment"># cat /etc/sysconfig/memcached</span><br>PORT=<span class="hljs-string">&quot;11211&quot;</span><br>USER=<span class="hljs-string">&quot;memcached&quot;</span><br>MAXCONN=<span class="hljs-string">&quot;1024&quot;</span><br>CACHESIZE=<span class="hljs-string">&quot;64&quot;</span><br>OPTIONS=<span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment">#前台显示看看效果</span><br>[root@centos7 ~]<span class="hljs-comment"># memcached -u memcached -p 11211 -f 1.25 -vv</span><br>slab class   1: chunk size        96 perslab   10922<br>slab class   2: chunk size       120 perslab    8738<br>slab class   3: chunk size       152 perslab    6898<br>slab class   4: chunk size       192 perslab    5461<br>slab class   5: chunk size       240 perslab    4369<br>slab class   6: chunk size       304 perslab    3449<br>slab class   7: chunk size       384 perslab    2730<br>slab class   8: chunk size       480 perslab    2184<br>slab class   9: chunk size       600 perslab    1747<br>slab class  10: chunk size       752 perslab    1394<br>slab class  11: chunk size       944 perslab    1110<br>slab class  12: chunk size      1184 perslab     885<br>slab class  13: chunk size      1480 perslab     708<br>slab class  14: chunk size      1856 perslab     564<br>slab class  15: chunk size      2320 perslab     451<br>slab class  16: chunk size      2904 perslab     361<br>slab class  17: chunk size      3632 perslab     288<br>slab class  18: chunk size      4544 perslab     230<br>slab class  19: chunk size      5680 perslab     184<br>slab class  20: chunk size      7104 perslab     147<br>slab class  21: chunk size      8880 perslab     118<br>slab class  22: chunk size     11104 perslab      94<br>slab class  23: chunk size     13880 perslab      75<br>slab class  24: chunk size     17352 perslab      60<br>slab class  25: chunk size     21696 perslab      48<br>slab class  26: chunk size     27120 perslab      38<br>slab class  27: chunk size     33904 perslab      30<br>slab class  28: chunk size     42384 perslab      24<br>slab class  29: chunk size     52984 perslab      19<br>slab class  30: chunk size     66232 perslab      15<br>slab class  31: chunk size     82792 perslab      12<br>slab class  32: chunk size    103496 perslab      10<br>slab class  33: chunk size    129376 perslab       8<br>slab class  34: chunk size    161720 perslab       6<br>slab class  35: chunk size    202152 perslab       5<br>slab class  36: chunk size    252696 perslab       4<br>slab class  37: chunk size    315872 perslab       3<br>slab class  38: chunk size    394840 perslab       2<br>slab class  39: chunk size    493552 perslab       2<br>slab class  40: chunk size    616944 perslab       1<br>slab class  41: chunk size    771184 perslab       1<br>slab class  42: chunk size   1048576 perslab       1<br>&lt;26 server listening (auto-negotiate)<br>&lt;27 server listening (auto-negotiate)<br>&lt;28 send buffer was 212992, now 268435456<br>&lt;29 send buffer was 212992, now 268435456<br>&lt;28 server listening (udp)<br>&lt;29 server listening (udp)<br>&lt;28 server listening (udp)<br>&lt;29 server listening (udp)<br>&lt;28 server listening (udp)<br>&lt;29 server listening (udp)<br>&lt;28 server listening (udp)<br>&lt;29 server listening (udp)<br>......<br>[root@centos7 ~]<span class="hljs-comment"># systemctl start memcached</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ss -ntlpu|grep memcached</span><br>udp  UNCONN   0    0     *:11211         *:*     users:<br>((<span class="hljs-string">&quot;memcached&quot;</span>,pid=2591,fd=28))<br>udp  UNCONN   0    0   [::]:11211       [::]:*     users:<br>((<span class="hljs-string">&quot;memcached&quot;</span>,pid=2591,fd=29))<br>tcp  LISTEN   0    128    *:11211         *:*     users:<br>((<span class="hljs-string">&quot;memcached&quot;</span>,pid=2591,fd=26))<br>tcp  LISTEN   0    128  [::]:11211       [::]:*     users:<br>((<span class="hljs-string">&quot;memcached&quot;</span>,pid=2591,fd=27)) tcp  LISTEN   0  100  [::1]:25    <br>   [::]:* <br></code></pre></td></tr></table></figure>

<h3 id="6-5-2-编译安装"><a href="#6-5-2-编译安装" class="headerlink" title="6.5.2 编译安装"></a>6.5.2 编译安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum -y install gcc libevent-devel</span><br><span class="hljs-comment">#估计不科学上网不能下载，只能直接先下载在放到linux里</span><br>[root@centos7 ~]<span class="hljs-comment"># wget http://www.memcached.org/files/memcached-1.6.6.tar.gz</span><br>[root@centos7 ~]<span class="hljs-comment"># tar xvf memcached-1.6.6.tar.gz</span><br>[root@centos7 ~]<span class="hljs-comment"># cd memcached-1.6.6/</span><br>[root@centos7 memcached-1.6.6]<span class="hljs-comment"># ./configure --prefix=/apps/memcached</span><br>[root@centos7 memcached-1.6.6]<span class="hljs-comment"># make &amp;&amp; make install</span><br><br>[root@centos7 ~]<span class="hljs-comment"># tree /apps/memcached/</span><br>/apps/memcached/<br>├── bin<br>│  └── memcached<br>├── include<br>│  └── memcached<br>│    └── protocol_binary.h<br>└── share<br> └── man<br>   └── man1<br>     └── memcached.1<br>     <br>6 directories, 3 files<br>[root@centos7 ~]<span class="hljs-comment"># echo &#x27;PATH=/apps/memcached/bin:$PATH&#x27; &gt; /etc/profile.d/memcached.sh</span><br>[root@centos7 ~]<span class="hljs-comment"># . /etc/profile.d/memcached.sh</span><br><br><span class="hljs-comment">#准备用户</span><br>[root@centos7 ~]<span class="hljs-comment"># useradd -r -s /sbin/nologin memcached</span><br><br>[root@centos7 ~]<span class="hljs-comment"># cat /etc/sysconfig/memcached</span><br>PORT=<span class="hljs-string">&quot;11211&quot;</span><br>USER=<span class="hljs-string">&quot;memcached&quot;</span><br>MAXCONN=<span class="hljs-string">&quot;1024&quot;</span><br>CACHESIZE=<span class="hljs-string">&quot;64&quot;</span><br>OPTIONS=<span class="hljs-string">&quot;-l 127.0.0.1,::1&quot;</span><br><br><span class="hljs-comment">#默认前台执行</span><br>[root@centos7 ~]<span class="hljs-comment"># memcached -u memcached -m 2048 -c 65536 -f 2 -vv</span><br><br><span class="hljs-comment">#以后台方式执行</span><br>[root@centos7 ~]<span class="hljs-comment"># memcached -u memcached -m 2048 -c 65536 -d</span><br><br><span class="hljs-comment">#准备service文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cat /lib/systemd/system/memcached.service</span><br>[Unit]<br>Description=memcached daemon<br>Before=httpd.service<br>After=network.target<br><br>[Service]<br>EnvironmentFile=/etc/sysconfig/memcached<br>ExecStart=/apps/memcached/bin/memcached -p <span class="hljs-variable">$&#123;PORT&#125;</span> -u <span class="hljs-variable">$&#123;USER&#125;</span> -m <span class="hljs-variable">$&#123;CACHESIZE&#125;</span> -c <span class="hljs-variable">$&#123;MAXCONN&#125;</span> <span class="hljs-variable">$OPTIONS</span><br><br>[Install]<br>WantedBy=multi-user.target<br><br>[root@centos7 ~]<span class="hljs-comment"># systemctl daemon-reload</span><br>[root@centos7 ~]<span class="hljs-comment"># systemctl enable --now memcached.service</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ss -ntl</span><br>State   Recv-Q Send-Q Local Address:Port  Peer Address:Port<br>LISTEN   0    128     127.0.0.1:11211   *:*         <br>LISTEN   0    128         *:22    *:*         <br>LISTEN   0    100     127.0.0.1:25    *:*         <br>LISTEN   0    128       [::1]:11211   [::]:*         <br>LISTEN   0    128       [::]:22    [::]:*         <br>LISTEN   0    100       [::1]:25    [::]:* <br>[root@centos7 ~]<span class="hljs-comment"># memcached --version</span><br>memcached 1.6.6<br></code></pre></td></tr></table></figure>

<h3 id="6-5-3-memcached-启动程序说明"><a href="#6-5-3-memcached-启动程序说明" class="headerlink" title="6.5.3 memcached 启动程序说明"></a>6.5.3 memcached 启动程序说明</h3><p>修改memcached 运行参数，可以使用下面的选项修改/etc/sysconfig/memcached文件</p>
<p>memcached 常见选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">-u username memcached运行的用户身份，必须普通用户<br>-p 绑定的端口，默认11211<br>-m num 最大内存，单位MB，默认64MB<br>-c num 最大连接数，缺省1024<br>-d 守护进程方式运行<br>-f 增长因子Growth Factor，默认1.25<br>-v 详细信息，-vv能看到详细信息<br>-M 使用内存直到耗尽，不许LRU<br>-U 设置UDP监听端口，0表示禁用UDP<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># memcached -u memcached -p 11211 -f 2 -vv</span><br>slab class   1: chunk size        96 perslab   10922<br>slab class   2: chunk size       192 perslab    5461<br>slab class   3: chunk size       384 perslab    2730<br>slab class   4: chunk size       768 perslab    1365<br>slab class   5: chunk size      1536 perslab     682<br>slab class   6: chunk size      3072 perslab     341<br>slab class   7: chunk size      6144 perslab     170<br>slab class   8: chunk size     12288 perslab      85<br>slab class   9: chunk size     24576 perslab      42<br>slab class  10: chunk size     49152 perslab      21<br>slab class  11: chunk size     98304 perslab      10<br>slab class  12: chunk size    196608 perslab       5<br>slab class  13: chunk size    524288 perslab       2<br>failed to listen on TCP port 11211: Address already <span class="hljs-keyword">in</span> use<br><br>[root@centos8 ~]<span class="hljs-comment"># memcached -u memcached -p 11211 -f 1.25 -vv</span><br>slab class   1: chunk size        96 perslab   10922<br>slab class   2: chunk size       120 perslab    8738<br>slab class   3: chunk size       152 perslab    6898<br>slab class   4: chunk size       192 perslab    5461<br>slab class   5: chunk size       240 perslab    4369<br>slab class   6: chunk size       304 perslab    3449<br>slab class   7: chunk size       384 perslab    2730<br>slab class   8: chunk size       480 perslab    2184<br>slab class   9: chunk size       600 perslab    1747<br>slab class  10: chunk size       752 perslab    1394<br>slab class  11: chunk size       944 perslab    1110<br>slab class  12: chunk size      1184 perslab     885<br>slab class  13: chunk size      1480 perslab     708<br>slab class  14: chunk size      1856 perslab     564<br>slab class  15: chunk size      2320 perslab     451<br>slab class  16: chunk size      2904 perslab     361<br>slab class  17: chunk size      3632 perslab     288<br>slab class  18: chunk size      4544 perslab     230<br>slab class  19: chunk size      5680 perslab     184<br>slab class  20: chunk size      7104 perslab     147<br>slab class  21: chunk size      8880 perslab     118<br>slab class  22: chunk size     11104 perslab      94<br>slab class  23: chunk size     13880 perslab      75<br>slab class  24: chunk size     17352 perslab      60<br>slab class  25: chunk size     21696 perslab      48<br>slab class  26: chunk size     27120 perslab      38<br>slab class  27: chunk size     33904 perslab      30<br>slab class  28: chunk size     42384 perslab      24<br>slab class  29: chunk size     52984 perslab      19<br>slab class  30: chunk size     66232 perslab      15<br>slab class  31: chunk size     82792 perslab      12<br>slab class  32: chunk size    103496 perslab      10<br>slab class  33: chunk size    129376 perslab       8<br>slab class  34: chunk size    161720 perslab       6<br>slab class  35: chunk size    202152 perslab       5<br>slab class  36: chunk size    252696 perslab       4<br>slab class  37: chunk size    315872 perslab       3<br>slab class  38: chunk size    394840 perslab       2<br>slab class  39: chunk size    524288 perslab       2<br>failed to listen on TCP port 11211: Address already <span class="hljs-keyword">in</span> use<br></code></pre></td></tr></table></figure>

<h2 id="6-6-使用-memcached"><a href="#6-6-使用-memcached" class="headerlink" title="6.6 使用 memcached"></a>6.6 使用 memcached</h2><h3 id="6-6-1-memcached-开发库和工具"><a href="#6-6-1-memcached-开发库和工具" class="headerlink" title="6.6.1 memcached 开发库和工具"></a>6.6.1 memcached 开发库和工具</h3><p>与memcached通信的不同语言的连接器。libmemcached提供了C库和命令行工具。</p>
<p>范例: 查看memcached相关包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum list &quot;*memcached*&quot;</span><br>Last metadata expiration check: 11:17:49 ago on Thu 12 Aug 2021 08:47:58 AM CST.<br>Installed Packages<br>memcached.x86_64                                                1.5.22-2.el8                                      @AppStream<br>Available Packages<br>libmemcached.i686                                               1.0.18-15.el8                                     PowerTools<br>libmemcached.x86_64                                             1.0.18-15.el8                                     AppStream <br>libmemcached-devel.i686                                         1.0.18-15.el8                                     PowerTools<br>libmemcached-devel.x86_64                                       1.0.18-15.el8                                     PowerTools<br>libmemcached-libs.i686                                          1.0.18-15.el8                                     AppStream <br>libmemcached-libs.x86_64                                        1.0.18-15.el8                                     AppStream <br>perl-Cache-Memcached.noarch                                     1.30-21.el8                                       epel      <br>python2-memcached.noarch                                        1.58-8.el8                                        epel      <br>python3-memcached.noarch                                        1.58-8.el8                                        epel<br><br>[root@centos7 ~]<span class="hljs-comment"># yum list &quot;*memcached*&quot;</span><br>Loaded plugins: fastestmirror<br>Loading mirror speeds from cached hostfile<br>Installed Packages<br>memcached.x86_64                                                            1.4.15-10.el7_3.1                          @base<br>Available Packages<br>libmemcached.i686                                                           1.0.16-5.el7                               base <br>libmemcached.x86_64                                                         1.0.16-5.el7                               base <br>libmemcached-devel.i686                                                     1.0.16-5.el7                               base <br>libmemcached-devel.x86_64                                                   1.0.16-5.el7                               base <br>memcached-devel.i686                                                        1.4.15-10.el7_3.1                          base <br>memcached-devel.x86_64                                                      1.4.15-10.el7_3.1                          base <br>opensips-memcached.x86_64                                                   1.10.5-4.el7                               epel <br>perl-Cache-Memcached.noarch                                                 1.30-8.el7                                 epel <br>php-ZendFramework-Cache-Backend-Libmemcached.noarch                         1.12.20-1.el7                              epel <br>php-ZendFramework-Cache-Backend-Memcached.noarch                            1.12.20-1.el7                              epel <br>php-pecl-memcached.x86_64                                                   2.2.0-1.el7                                epel <br>python-memcached.noarch                                                     1.48-4.el7                                 base <br>uwsgi-router-memcached.x86_64                                               2.0.18-8.el7                               epel<br></code></pre></td></tr></table></figure>

<p><strong>协议</strong></p>
<p>查看/usr/share/doc/memcached-1.4.15/protocol.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum info libmemcached</span><br>Last metadata expiration check: 11:22:17 ago on Thu 12 Aug 2021 08:47:58 AM CST.<br>Available Packages<br>Name         : libmemcached<br>Version      : 1.0.18<br>Release      : 15.el8<br>Architecture : i686<br>Size         : 144 k<br>Source       : libmemcached-1.0.18-15.el8.src.rpm<br>Repository   : PowerTools<br>Summary      : Client library and <span class="hljs-built_in">command</span> line tools <span class="hljs-keyword">for</span> memcached server<br>URL          : http://libmemcached.org/<br>License      : BSD<br>Description  : libmemcached is a C/C++ client library and tools <span class="hljs-keyword">for</span> the memcached server<br>             : (http://memcached.org/). It has been designed to be light on memory<br>             : usage, and provide full access to server side methods.<br>             : <br>             : It also implements several <span class="hljs-built_in">command</span> line tools:<br>             : <br>             : memaslap    Load testing and benchmarking a server<br>             : memcapable  Checking a Memcached server capibilities and compatibility<br>             : memcat      Copy the value of a key to standard output<br>             : memcp       Copy data to a server<br>             : memdump     Dumping your server<br>             : memerror    Translate an error code to a string<br>             : memexist    Check <span class="hljs-keyword">for</span> the existance of a key<br>             : memflush    Flush the contents of your servers<br>             : memparse    Parse an option string<br>             : memping     Test to see <span class="hljs-keyword">if</span> a server is available.<br>             : memrm       Remove a key(s) from the server<br>             : memslap     Generate testing loads on a memcached cluster<br>             : memstat     Dump the stats of your servers to standard output<br>             : memtouch    Touches a key<br><br>Name         : libmemcached<br>Version      : 1.0.18<br>Release      : 15.el8<br>Architecture : x86_64<br>Size         : 140 k<br>Source       : libmemcached-1.0.18-15.el8.src.rpm<br>Repository   : AppStream<br>Summary      : Client library and <span class="hljs-built_in">command</span> line tools <span class="hljs-keyword">for</span> memcached server<br>URL          : http://libmemcached.org/<br>License      : BSD<br>Description  : libmemcached is a C/C++ client library and tools <span class="hljs-keyword">for</span> the memcached server<br>             : (http://memcached.org/). It has been designed to be light on memory<br>             : usage, and provide full access to server side methods.<br>             : <br>             : It also implements several <span class="hljs-built_in">command</span> line tools:<br>             : <br>             : memaslap    Load testing and benchmarking a server<br>             : memcapable  Checking a Memcached server capibilities and compatibility<br>             : memcat      Copy the value of a key to standard output<br>             : memcp       Copy data to a server<br>             : memdump     Dumping your server<br>             : memerror    Translate an error code to a string<br>             : memexist    Check <span class="hljs-keyword">for</span> the existance of a key<br>             : memflush    Flush the contents of your servers<br>             : memparse    Parse an option string<br>             : memping     Test to see <span class="hljs-keyword">if</span> a server is available.<br>             : memrm       Remove a key(s) from the server<br>             : memslap     Generate testing loads on a memcached cluster<br>             : memstat     Dump the stats of your servers to standard output<br>             : memtouch    Touches a key<br>      <br>[root@centos8 ~]<span class="hljs-comment"># yum repoquery -l libmemcached</span><br>Last metadata expiration check: 11:22:41 ago on Thu 12 Aug 2021 08:47:58 AM CST.<br>/usr/bin/memaslap<br>/usr/bin/memcapable<br>/usr/bin/memcat<br>/usr/bin/memcp<br>/usr/bin/memdump<br>/usr/bin/memerror<br>/usr/bin/memexist<br>/usr/bin/memflush<br>/usr/bin/memparse<br>/usr/bin/memping<br>/usr/bin/memrm<br>/usr/bin/memslap<br>/usr/bin/memstat<br>/usr/bin/memtouch<br>/usr/lib/.build-id<br>/usr/lib/.build-id/0c<br>/usr/lib/.build-id/0c/714eeee02c485612dd22beffc2d452d919d6c4<br>/usr/lib/.build-id/14<br>/usr/lib/.build-id/14/2d58fd5298468317ceb93b6a1af48ff60cdfbc<br>/usr/lib/.build-id/42<br>/usr/lib/.build-id/42/6cfa70cf43326336e09fb3f550d2f324742bef<br>/usr/lib/.build-id/4a<br>/usr/lib/.build-id/4a/2085f6f39de39a201cdb5ef8fbbff673fff13e<br>/usr/lib/.build-id/4b<br>/usr/lib/.build-id/4b/9775c2dffa3be740b8bec87dc84cf3db42dd6d<br>/usr/lib/.build-id/51<br>/usr/lib/.build-id/51/7d8209b3b484df54531ca7fd94c0c73501b0c4<br>/usr/lib/.build-id/61<br>/usr/lib/.build-id/61/8bae950f705d75befe7a396dea75c3dc5174c0<br>/usr/lib/.build-id/7a<br>/usr/lib/.build-id/7a/53821258233757c74b8cbf0b14b32a5190e22f<br>/usr/lib/.build-id/92<br>/usr/lib/.build-id/92/8fa02a4b367a3140127db8db360fde35d0eb97<br>/usr/lib/.build-id/96<br>/usr/lib/.build-id/96/7f41c94f76c7dd2fe3f4b5da94961eb749adf5<br>/usr/lib/.build-id/a4<br>/usr/lib/.build-id/a4/02b7c4b58a6df40d975f0f84368b28f219000f<br>/usr/lib/.build-id/b9<br>/usr/lib/.build-id/b9/de8360da0b95e17553687590a586ef00c2dcc4<br>/usr/lib/.build-id/c4<br>/usr/lib/.build-id/c4/b05b02f7122478587e6e5e5c6f94111cae2f87<br>/usr/lib/.build-id/de<br>/usr/lib/.build-id/de/d9f1aa41b71085c415e2158d64fad5d3d750a7<br>/usr/share/man/man1/memaslap.1.gz<br>/usr/share/man/man1/memcapable.1.gz<br>/usr/share/man/man1/memcat.1.gz<br>/usr/share/man/man1/memcp.1.gz<br>/usr/share/man/man1/memdump.1.gz<br>/usr/share/man/man1/memerror.1.gz<br>/usr/share/man/man1/memexist.1.gz<br>/usr/share/man/man1/memflush.1.gz<br>/usr/share/man/man1/memparse.1.gz<br>/usr/share/man/man1/memping.1.gz<br>/usr/share/man/man1/memrm.1.gz<br>/usr/share/man/man1/memslap.1.gz<br>/usr/share/man/man1/memstat.1.gz<br>/usr/share/man/man1/memtouch.1.gz<br>/usr/bin/memaslap<br>/usr/bin/memcapable<br>/usr/bin/memcat<br>/usr/bin/memcp<br>/usr/bin/memdump<br>/usr/bin/memerror<br>/usr/bin/memexist<br>/usr/bin/memflush<br>/usr/bin/memparse<br>/usr/bin/memping<br>/usr/bin/memrm<br>/usr/bin/memslap<br>/usr/bin/memstat<br>/usr/bin/memtouch<br>/usr/lib/.build-id<br>/usr/lib/.build-id/1b<br>/usr/lib/.build-id/1b/be22224bfebeca90608feb39b80727ae54628e<br>/usr/lib/.build-id/38<br>/usr/lib/.build-id/38/5751e779437bb3a4081e7cfb4ef77088a07d97<br>/usr/lib/.build-id/42<br>/usr/lib/.build-id/42/b350284fa158955530a88eb8f96c1f870b4fe2<br>/usr/lib/.build-id/56<br>/usr/lib/.build-id/56/42b8e27074c76b9801e7719479084a600db691<br>/usr/lib/.build-id/59<br>/usr/lib/.build-id/59/9c9b9482f1c789b5b4446f1b97f5d7e52f30ab<br>/usr/lib/.build-id/72<br>/usr/lib/.build-id/72/493b49e4933a11db401650eb5de14a38e22c5b<br>/usr/lib/.build-id/78<br>/usr/lib/.build-id/78/c5db64ca4e70a9fd1ef5da96ad28db07946bfa<br>/usr/lib/.build-id/98<br>/usr/lib/.build-id/98/6fde24b289939e1bb1621f74c46e68329b140a<br>/usr/lib/.build-id/a9<br>/usr/lib/.build-id/a9/028d7389fc0be4422efaf38782416365d67969<br>/usr/lib/.build-id/dc<br>/usr/lib/.build-id/dc/d8bd345f28d55f95c5a510ac88e440c97778d3<br>/usr/lib/.build-id/de<br>/usr/lib/.build-id/de/0354325ffca355fc6682f3ac4207f111d42ec1<br>/usr/lib/.build-id/e0<br>/usr/lib/.build-id/e0/e81e353fdc4b4cfe6e44c20d65e1eb4740249c<br>/usr/lib/.build-id/e1<br>/usr/lib/.build-id/e1/91e088f007b253329756088bedb68948191166<br>/usr/lib/.build-id/e8<br>/usr/lib/.build-id/e8/b2f6d6a35c022c66e400c6f6db3d507be54dcd<br>/usr/share/man/man1/memaslap.1.gz<br>/usr/share/man/man1/memcapable.1.gz<br>/usr/share/man/man1/memcat.1.gz<br>/usr/share/man/man1/memcp.1.gz<br>/usr/share/man/man1/memdump.1.gz<br>/usr/share/man/man1/memerror.1.gz<br>/usr/share/man/man1/memexist.1.gz<br>/usr/share/man/man1/memflush.1.gz<br>/usr/share/man/man1/memparse.1.gz<br>/usr/share/man/man1/memping.1.gz<br>/usr/share/man/man1/memrm.1.gz<br>/usr/share/man/man1/memslap.1.gz<br>/usr/share/man/man1/memstat.1.gz<br>/usr/share/man/man1/memtouch.1.gz<br><br><span class="hljs-comment">#测试memcached是否可访问</span><br>[root@centos8 ~]<span class="hljs-comment"># yum install -y libmemcached</span><br>[root@centos8 ~]<span class="hljs-comment"># rpm -ql libmemcached</span><br>/usr/bin/memaslap<br>/usr/bin/memcapable<br>/usr/bin/memcat<br>/usr/bin/memcp<br>/usr/bin/memdump<br>/usr/bin/memerror<br>/usr/bin/memexist<br>/usr/bin/memflush<br>/usr/bin/memparse<br>/usr/bin/memping<br>/usr/bin/memrm<br>/usr/bin/memslap<br>/usr/bin/memstat<br>/usr/bin/memtouch<br>/usr/lib/.build-id<br>/usr/lib/.build-id/1b<br>/usr/lib/.build-id/1b/be22224bfebeca90608feb39b80727ae54628e<br>/usr/lib/.build-id/38<br>/usr/lib/.build-id/38/5751e779437bb3a4081e7cfb4ef77088a07d97<br>/usr/lib/.build-id/42<br>/usr/lib/.build-id/42/b350284fa158955530a88eb8f96c1f870b4fe2<br>/usr/lib/.build-id/56<br>/usr/lib/.build-id/56/42b8e27074c76b9801e7719479084a600db691<br>/usr/lib/.build-id/59<br>/usr/lib/.build-id/59/9c9b9482f1c789b5b4446f1b97f5d7e52f30ab<br>/usr/lib/.build-id/72<br>/usr/lib/.build-id/72/493b49e4933a11db401650eb5de14a38e22c5b<br>/usr/lib/.build-id/78<br>/usr/lib/.build-id/78/c5db64ca4e70a9fd1ef5da96ad28db07946bfa<br>/usr/lib/.build-id/98<br>/usr/lib/.build-id/98/6fde24b289939e1bb1621f74c46e68329b140a<br>/usr/lib/.build-id/a9<br>/usr/lib/.build-id/a9/028d7389fc0be4422efaf38782416365d67969<br>/usr/lib/.build-id/dc<br>/usr/lib/.build-id/dc/d8bd345f28d55f95c5a510ac88e440c97778d3<br>/usr/lib/.build-id/de<br>/usr/lib/.build-id/de/0354325ffca355fc6682f3ac4207f111d42ec1<br>/usr/lib/.build-id/e0<br>/usr/lib/.build-id/e0/e81e353fdc4b4cfe6e44c20d65e1eb4740249c<br>/usr/lib/.build-id/e1<br>/usr/lib/.build-id/e1/91e088f007b253329756088bedb68948191166<br>/usr/lib/.build-id/e8<br>/usr/lib/.build-id/e8/b2f6d6a35c022c66e400c6f6db3d507be54dcd<br>/usr/share/man/man1/memaslap.1.gz<br>/usr/share/man/man1/memcapable.1.gz<br>/usr/share/man/man1/memcat.1.gz<br>/usr/share/man/man1/memcp.1.gz<br>/usr/share/man/man1/memdump.1.gz<br>/usr/share/man/man1/memerror.1.gz<br>/usr/share/man/man1/memexist.1.gz<br>/usr/share/man/man1/memflush.1.gz<br>/usr/share/man/man1/memparse.1.gz<br>/usr/share/man/man1/memping.1.gz<br>/usr/share/man/man1/memrm.1.gz<br>/usr/share/man/man1/memslap.1.gz<br>/usr/share/man/man1/memstat.1.gz<br>/usr/share/man/man1/memtouch.1.gz<br>[root@centos8 ~]<span class="hljs-comment"># memping --servers=10.0.0.202</span><br>[root@centos8 ~]<span class="hljs-comment"># echo $?</span><br>0 <span class="hljs-comment">#证明该服务器开启了mamched</span><br>[root@centos8 ~]<span class="hljs-comment"># memping --servers=10.0.0.201</span><br>Failed to ping 10.0.0.201:11211 CONNECTION FAILURE <span class="hljs-comment">#证明该服务器没有开启了mamched</span><br><br><span class="hljs-comment">#查看memcached状态</span><br>[root@centos8 ~]<span class="hljs-comment"># memstat --servers=10.0.0.202</span><br>Server: 10.0.0.202 (11211)<br>	 pid: 37040<br>	 uptime: 1998<br>	 time: 1628735022<br>	 version: 1.5.22<br>	 libevent: 2.1.8-stable<br>	 pointer_size: 64<br>	 rusage_user: 0.045916<br>	 rusage_system: 0.126236<br>	 max_connections: 1024<br>	 curr_connections: 2<br>	 total_connections: 4<br>	 rejected_connections: 0<br>	 connection_structures: 3<br>	 reserved_fds: 20<br>	 cmd_get: 0<br>	 cmd_set: 0<br>	 cmd_flush: 0<br>	 cmd_touch: 0<br>	 cmd_meta: 0<br>	 get_hits: 0<br>	 get_misses: 0<br>	 get_expired: 0<br>	 get_flushed: 0<br>	 delete_misses: 0<br>	 delete_hits: 0<br>	 incr_misses: 0<br>	 incr_hits: 0<br>	 decr_misses: 0<br>	 decr_hits: 0<br>	 cas_misses: 0<br>	 cas_hits: 0<br>	 cas_badval: 0<br>	 touch_hits: 0<br>	 touch_misses: 0<br>	 auth_cmds: 0<br>	 auth_errors: 0<br>	 bytes_read: 32<br>	 bytes_written: 32<br>	 limit_maxbytes: 67108864<br>	 accepting_conns: 1<br>	 listen_disabled_num: 0<br>	 time_in_listen_disabled_us: 0<br>	 threads: 4<br>	 conn_yields: 0<br>	 hash_power_level: 16<br>	 hash_bytes: 524288<br>	 hash_is_expanding: 0<br>	 slab_reassign_rescues: 0<br>	 slab_reassign_chunk_rescues: 0<br>	 slab_reassign_evictions_nomem: 0<br>	 slab_reassign_inline_reclaim: 0<br>	 slab_reassign_busy_items: 0<br>	 slab_reassign_busy_deletes: 0<br>	 slab_reassign_running: 0<br>	 slabs_moved: 0<br>	 lru_crawler_running: 0<br>	 lru_crawler_starts: 2040<br>	 lru_maintainer_juggles: 2045<br>	 malloc_fails: 0<br>	 log_worker_dropped: 0<br>	 log_worker_written: 0<br>	 log_watcher_skipped: 0<br>	 log_watcher_sent: 0<br>	 bytes: 0<br>	 curr_items: 0<br>	 total_items: 0<br>	 slab_global_page_pool: 0<br>	 expired_unfetched: 0<br>	 evicted_unfetched: 0<br>	 evicted_active: 0<br>	 evictions: 0<br>	 reclaimed: 0<br>	 crawler_reclaimed: 0<br>	 crawler_items_checked: 0<br>	 lrutail_reflocked: 0<br>	 moves_to_cold: 0<br>	 moves_to_warm: 0<br>	 moves_within_lru: 0<br>	 direct_reclaims: 0<br>	 lru_bumps_dropped: 0<br>[root@centos8 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h3 id="6-6-2-memcached-操作命令"><a href="#6-6-2-memcached-操作命令" class="headerlink" title="6.6.2 memcached 操作命令"></a>6.6.2 memcached 操作命令</h3><p>帮助文档:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># cat /usr/share/doc/memcached/protocol.txt</span><br><span class="hljs-comment">#内容太多，这里省略。</span><br></code></pre></td></tr></table></figure>

<p>五种基本 memcached 命令执行最简单的操作。这些命令和操作包括：</p>
<ul>
<li>set</li>
<li>add</li>
<li>replace</li>
<li>get</li>
<li>delete</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#前三个命令是用于操作存储在 memcached 中的键值对的标准修改命令,都使用如下所示的语法：</span><br><span class="hljs-built_in">command</span> &lt;key&gt; &lt;flags&gt; &lt;expiration time&gt; &lt;bytes&gt;<br>&lt;value&gt;<br><br><span class="hljs-comment">#参数说明如下：</span><br><span class="hljs-built_in">command</span> <span class="hljs-built_in">set</span>/add/replace<br>key     key 用于查找缓存值<br>flags   可以包括键值对的整型参数，客户机使用它存储关于键值对的额外信息<br>expiration time   在缓存中保存键值对的时间长度（以秒为单位，0 表示永远）<br>bytes   在缓存中存储的字节点<br>value   存储的值（始终位于第二行）<br><br><span class="hljs-comment">#增加key，过期时间为秒，bytes为存储数据的字节数</span><br>add key flags exptime bytes<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># systemctl start memcached</span><br>[root@centos8 ~]<span class="hljs-comment"># telnet localhost 11211</span><br>Trying ::1...<br>Connected to localhost.<br>Escape character is <span class="hljs-string">&#x27;^]&#x27;</span>.<br>stats<br>STAT pid 27208<br>STAT uptime 242<br>STAT time 1603035824<br>STAT version 1.5.9<br>STAT libevent 2.1.8-stable<br>STAT pointer_size 64<br>STAT rusage_user 0.004214<br>STAT rusage_system 0.040611<br>STAT max_connections 1024<br>STAT curr_connections 2<br>STAT total_connections 4<br>STAT rejected_connections 0<br>STAT connection_structures 3<br>STAT reserved_fds 20<br>STAT cmd_get 8<br>STAT cmd_set 4<br>STAT cmd_flush 1<br>STAT cmd_touch 0<br>STAT get_hits 5<br>STAT get_misses 3<br>STAT get_expired 0<br>STAT get_flushed 0<br>STAT delete_misses 0<br>STAT delete_hits 1<br>STAT incr_misses 0<br>STAT incr_hits 0<br>STAT decr_misses 0<br>STAT decr_hits 0<br>STAT cas_misses 0<br>STAT cas_hits 0<br>STAT cas_badval 0<br>STAT touch_hits 0<br>STAT touch_misses 0<br>STAT auth_cmds 0<br>STAT auth_errors 0<br>STAT bytes_read 224<br>STAT bytes_written 3963<br>STAT limit_maxbytes 67108864<br>STAT accepting_conns 1<br>STAT listen_disabled_num 0<br>STAT time_in_listen_disabled_us 0<br>STAT threads 4<br>STAT conn_yields 0<br>STAT hash_power_level 16<br>STAT hash_bytes 524288<br>STAT hash_is_expanding 0<br>STAT slab_reassign_rescues 0<br>STAT slab_reassign_chunk_rescues 0<br>STAT slab_reassign_evictions_nomem 0<br>STAT slab_reassign_inline_reclaim 0<br>STAT slab_reassign_busy_items 0<br>STAT slab_reassign_busy_deletes 0<br>STAT slab_reassign_running 0<br>STAT slabs_moved 0<br>STAT lru_crawler_running 0<br>STAT lru_crawler_starts 765<br>STAT lru_maintainer_juggles 523<br>STAT malloc_fails 0<br>STAT log_worker_dropped 0<br>STAT log_worker_written 0<br>STAT log_watcher_skipped 0<br>STAT log_watcher_sent 0<br>STAT bytes 0<br>STAT curr_items 0<br>STAT total_items 4<br>STAT slab_global_page_pool 0<br>STAT expired_unfetched 0<br>STAT evicted_unfetched 0<br>STAT evicted_active 0<br>STAT evictions 0<br>STAT reclaimed 3<br>STAT crawler_reclaimed 0<br>STAT crawler_items_checked 1<br>STAT lrutail_reflocked 4<br>STAT moves_to_cold 5<br>STAT moves_to_warm 1<br>STAT moves_within_lru 0<br>STAT direct_reclaims 0<br>STAT lru_bumps_dropped 0<br>END<br>stats items <span class="hljs-comment">#显示各个 slab 中 item 的数目和存储时长(最后一次访问距离现在的秒数)。</span><br>STAT items:1:number 2<br>STAT items:1:number_hot 0<br>STAT items:1:number_warm 0<br>STAT items:1:number_cold 2<br>STAT items:1:age_hot 0<br>STAT items:1:age_warm 0<br>STAT items:1:age 17<br>STAT items:1:evicted 0<br>STAT items:1:evicted_nonzero 0<br>STAT items:1:evicted_time 0<br>STAT items:1:outofmemory 0<br>STAT items:1:tailrepairs 0<br>STAT items:1:reclaimed 0<br>STAT items:1:expired_unfetched 0<br>STAT items:1:evicted_unfetched 0<br>STAT items:1:evicted_active 0<br>STAT items:1:crawler_reclaimed 0<br>STAT items:1:crawler_items_checked 0<br>STAT items:1:lrutail_reflocked 0<br>STAT items:1:moves_to_cold 2<br>STAT items:1:moves_to_warm 0<br>STAT items:1:moves_within_lru 0<br>STAT items:1:direct_reclaims 0<br>STAT items:1:hits_to_hot 0<br>STAT items:1:hits_to_warm 0<br>STAT items:1:hits_to_cold 1<br>STAT items:1:hits_to_temp 0<br>END<br>stats slabs <span class="hljs-comment">#用于显示各个slab的信息，包括chunk的大小、数目、使用情况等</span><br>STAT 1:chunk_size 96<br>STAT 1:chunks_per_page 10922<br>STAT 1:total_pages 1<br>STAT 1:total_chunks 10922<br>STAT 1:used_chunks 1<br>STAT 1:free_chunks 10921<br>STAT 1:free_chunks_end 0<br>STAT 1:mem_requested 67<br>STAT 1:get_hits 1<br>STAT 1:cmd_set 3<br>STAT 1:delete_hits 0<br>STAT 1:incr_hits 0<br>STAT 1:decr_hits 0<br>STAT 1:cas_hits 0<br>STAT 1:cas_badval 0<br>STAT 1:touch_hits 0<br>STAT active_slabs 1<br>STAT total_malloced 1048576<br>END<br><br><span class="hljs-comment">#加</span><br>add mykey 1 60 4 <br><span class="hljs-built_in">test</span><br>STORED<br><span class="hljs-comment">#查</span><br>get mykey<br>VALUE mykey 1 4<br><span class="hljs-built_in">test</span><br>END<br><br><span class="hljs-comment">#改</span><br><span class="hljs-built_in">set</span> mykey 1 60 5<br>test1<br>STORED<br>get mykey<br>VALUE mykey 1 5<br>test1<br>END<br><br><span class="hljs-comment">#删除</span><br>delete mykey<br>DELETED<br>get mykey<br>END<br><br><span class="hljs-comment">#清空</span><br>flush_all<br>OK<br>get mykey<br>END<br>quit<br></code></pre></td></tr></table></figure>

<h3 id="6-6-3-python-语言连接-memcached"><a href="#6-6-3-python-语言连接-memcached" class="headerlink" title="6.6.3 python 语言连接 memcached"></a>6.6.3 python 语言连接 memcached</h3><h4 id="6-6-3-1-范例-python3-测试代码"><a href="#6-6-3-1-范例-python3-测试代码" class="headerlink" title="6.6.3.1 范例: python3 测试代码"></a>6.6.3.1 范例: python3 测试代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install python3 python3-memcached</span><br>[root@centos8 ~]<span class="hljs-comment"># vim m3.py</span><br><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-comment">#coding:utf-8</span><br>import memcache<br>m = memcache.Client([<span class="hljs-string">&#x27;127.0.0.1:11211&#x27;</span>], debug=True)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(10):<br> m.set(<span class="hljs-string">&quot;key%d&quot;</span> % i,<span class="hljs-string">&quot;v%d&quot;</span> % i)<br> ret = m.get(<span class="hljs-string">&#x27;key%d&#x27;</span> % i)<br> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%s&quot;</span> % ret)<br> <br>[root@centos8 ~]<span class="hljs-comment"># chmod +x m3.py</span><br>[root@centos8 ~]<span class="hljs-comment"># ./m3.py</span><br>v0<br>v1<br>v2<br>v3<br>v4<br>v5<br>v6<br>v7<br>v8<br>v9<br></code></pre></td></tr></table></figure>

<h4 id="6-6-3-2-范例-python2-测试代码"><a href="#6-6-3-2-范例-python2-测试代码" class="headerlink" title="6.6.3.2 范例: python2 测试代码"></a>6.6.3.2 范例: python2 测试代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum -y install python-memcached</span><br><br>[root@centos7 ~]<span class="hljs-comment"># vim m2.py</span><br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br>import memcache<br>m = memcache.Client([<span class="hljs-string">&#x27;127.0.0.1:11211&#x27;</span>], debug=True)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(10):<br>m.set(<span class="hljs-string">&quot;key%d&quot;</span> % i,<span class="hljs-string">&quot;v%d&quot;</span> % i)<br>ret = m.get(<span class="hljs-string">&#x27;key%d&#x27;</span> % i)<br><span class="hljs-built_in">print</span> ret<br><br>[root@centos7 ~]<span class="hljs-comment"># python m2.py</span><br>v0<br>v1<br>v2<br>v3<br>v4<br>v5<br>v6<br>v7<br>v8<br>v9<br><br>[root@centos7 ~]<span class="hljs-comment"># telnet 127.0.0.1 11211</span><br>Trying 127.0.0.1...<br>Connected to 127.0.0.1.<br>Escape character is <span class="hljs-string">&#x27;^]&#x27;</span>.<br>get key1<br>VALUE key1 0 2<br>v1<br>END<br>get key9<br>VALUE key9 0 2<br>v9<br>END<br>get key10<br>END<br>quit<br>Connection closed by foreign host.<br>[root@centos7 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h2 id="6-7-memcached-集群部署架构"><a href="#6-7-memcached-集群部署架构" class="headerlink" title="6.7 memcached 集群部署架构"></a>6.7 memcached 集群部署架构</h2><h3 id="6-7-1-基于-magent-的部署架构"><a href="#6-7-1-基于-magent-的部署架构" class="headerlink" title="6.7.1 基于 magent 的部署架构"></a>6.7.1 基于 magent 的部署架构</h3><p>Magent是google开发的项目,应用端通过负载均衡服务器连接到magent，然后再由magent代理用户应用请求到memcached处理，底层的memcached为双主结构会自动同步数据，本部署方式存在magent单点问题,因此需要两个magent做高可用。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat114.png" srcset="/blog/img/loading.gif"></p>
<p>项目站点：<a target="_blank" rel="noopener" href="https://code.google.com/archive/p/memagent/">https://code.google.com/archive/p/memagent/</a></p>
<p>此项目过于陈旧,且不稳定,当前已经废弃</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat115.png" srcset="/blog/img/loading.gif"></p>
<h3 id="6-7-2-Repcached-实现原理"><a href="#6-7-2-Repcached-实现原理" class="headerlink" title="6.7.2 Repcached 实现原理"></a>6.7.2 Repcached 实现原理</h3><p>项目站点：<a target="_blank" rel="noopener" href="http://repcached.sourceforge.net/">http://repcached.sourceforge.net/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat116.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat117.png" srcset="/blog/img/loading.gif"></p>
<p>在 master上可以通过 -X 选项指定 replication port(默认为11212/tcp)，在 slave上通过 -x 指定复制的master并连接，事实上，如果同时指定了 -x/-X， repcached先会尝试连接对端的master，但如果连接失败，它就会用 -X参数来自己 listen（成为master）；如果 master坏掉， slave侦测到连接断了，它会自动 listen而成为 master；而如果 slave坏掉，master也会侦测到连接断开，它就会重新 listen等待新的 slave加入。</p>
<p>从这方案的技术实现来看，其实它是一个单 master单 slave的方案，但它的 master/slave都是可读写的，而且可以相互同步，所以从功能上看，也可以认为它是双机 master-master方案</p>
<h3 id="6-7-3-简化后的部署架构"><a href="#6-7-3-简化后的部署架构" class="headerlink" title="6.7.3 简化后的部署架构"></a>6.7.3 简化后的部署架构</h3><p>magent已经有很长时间没有更新，因此可以不再使用magent，直接通过负载均衡连接到memcached，仍然有两台memcached做高可用，repcached版本的memcached之间会自动同步数据，以保持数据一致性，即使其中的一台memcached故障也不影响业务正常运行，故障的memcached修复上线后再自动从另外一台同步数据即可保持数据一致性。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat118.png" srcset="/blog/img/loading.gif"></p>
<h3 id="6-7-4-部署repcached"><a href="#6-7-4-部署repcached" class="headerlink" title="6.7.4 部署repcached"></a>6.7.4 部署repcached</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum -y install gcc libevent libevent-devel</span><br>[root@centos7 ~]<span class="hljs-comment"># wget https://deac-riga.dl.sourceforge.net/project/repcached/repcached/2.2.1-1.2.8/memcached-1.2.8-repcached-2.2.1.tar.gz #估计没有科学上网是下载不了</span><br>[root@centos7 ~]<span class="hljs-comment"># tar xf memcached-1.2.8-repcached-2.2.1.tar.gz</span><br>[root@centos7 ~]<span class="hljs-comment"># cd memcached-1.2.8-repcached-2.2.1</span><br>[root@centos7 memcached-1.2.8-repcached-2.2.1]<span class="hljs-comment"># ./configure --prefix=/apps/repcached --enable-replication</span><br>[root@centos7 memcached-1.2.8-repcached-2.2.1]<span class="hljs-comment"># make #报错如下</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat119.png" srcset="/blog/img/loading.gif"></p>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 memcached-1.2.8-repcached-2.2.1]<span class="hljs-comment"># vim memcached.c</span><br>56 <span class="hljs-comment">#ifndef IOV_MAX</span><br>57 <span class="hljs-comment">#if defined(__FreeBSD__) || defined(__APPLE__)</span><br>58 <span class="hljs-comment"># define IOV_MAX 1024</span><br>59 <span class="hljs-comment">#endif</span><br>60 <span class="hljs-comment">#endif</span><br><br><span class="hljs-comment">#改为如下内容，即删除原有的原第57，59行</span><br>56 <span class="hljs-comment">#ifndef IOV_MAX</span><br>57 <span class="hljs-comment"># define IOV_MAX 1024</span><br>58 <span class="hljs-comment">#endif</span><br></code></pre></td></tr></table></figure>

<p>再次编译安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 memcached-1.2.8-repcached-2.2.1]<span class="hljs-comment"># make &amp;&amp; make install</span><br>[root@centos7 ~]<span class="hljs-comment"># tree /apps/repcached/</span><br>/apps/repcached/<br>├── bin<br>│  ├── memcached<br>│  └── memcached-debug<br>└── share<br> └── man<br>   └── man1<br>     └── memcached.1<br><br>4 directories, 3 files<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat120.png" srcset="/blog/img/loading.gif"></p>
<h3 id="6-7-5-验证是否可执行"><a href="#6-7-5-验证是否可执行" class="headerlink" title="6.7.5 验证是否可执行"></a>6.7.5 验证是否可执行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># echo &#x27;PATH=/apps/repcached/bin:$PATH&#x27; &gt; /etc/profile.d/repcached.sh</span><br>[root@centos7 ~]<span class="hljs-comment"># . /etc/profile.d/repcached.sh</span><br>[root@centos7 ~]<span class="hljs-comment"># memcached -h</span><br>memcached 1.2.8<br>repcached 2.2.1<br>-p &lt;num&gt;      TCP port number to listen on (default: 11211)<br>-U &lt;num&gt;      UDP port number to listen on (default: 11211, 0 is off)<br>-s &lt;file&gt;     unix socket path to listen on (disables network support)<br>-a &lt;mask&gt;     access mask <span class="hljs-keyword">for</span> unix socket, <span class="hljs-keyword">in</span> octal (default 0700)<br>-l &lt;ip_addr&gt;  interface to listen on, default is INDRR_ANY<br>-d            run as a daemon<br>-r            maximize core file <span class="hljs-built_in">limit</span><br>-u &lt;username&gt; assume identity of &lt;username&gt; (only when run as root)<br>-m &lt;num&gt;      max memory to use <span class="hljs-keyword">for</span> items <span class="hljs-keyword">in</span> megabytes, default is 64 MB<br>-M            <span class="hljs-built_in">return</span> error on memory exhausted (rather than removing items)<br>-c &lt;num&gt;      max simultaneous connections, default is 1024<br>-k            lock down all paged memory.  Note that there is a<br>              <span class="hljs-built_in">limit</span> on how much memory you may lock.  Trying to<br>              allocate more than that would fail, so be sure you<br>              <span class="hljs-built_in">set</span> the <span class="hljs-built_in">limit</span> correctly <span class="hljs-keyword">for</span> the user you started<br>              the daemon with (not <span class="hljs-keyword">for</span> -u &lt;username&gt; user;<br>              under sh this is <span class="hljs-keyword">done</span> with <span class="hljs-string">&#x27;ulimit -S -l NUM_KB&#x27;</span>).<br>-v            verbose (<span class="hljs-built_in">print</span> errors/warnings <span class="hljs-keyword">while</span> <span class="hljs-keyword">in</span> event loop)<br>-vv           very verbose (also <span class="hljs-built_in">print</span> client commands/reponses)<br>-h            <span class="hljs-built_in">print</span> this <span class="hljs-built_in">help</span> and <span class="hljs-built_in">exit</span><br>-i            <span class="hljs-built_in">print</span> memcached and libevent license<br>-P &lt;file&gt;     save PID <span class="hljs-keyword">in</span> &lt;file&gt;, only used with -d option<br>-f &lt;factor&gt;   chunk size growth factor, default 1.25<br>-n &lt;bytes&gt;    minimum space allocated <span class="hljs-keyword">for</span> key+value+flags, default 48<br>-R            Maximum number of requests per event<br>              limits the number of requests process <span class="hljs-keyword">for</span> a given con nection<br>              to prevent starvation.  default 20<br>-b            Set the backlog queue <span class="hljs-built_in">limit</span> (default 1024)<br>-x &lt;ip_addr&gt;  hostname or IP address of peer repcached<br>-X &lt;num:num&gt;  TCP port number <span class="hljs-keyword">for</span> replication. &lt;listen:connect&gt; (default: 11212)<br></code></pre></td></tr></table></figure>

<h3 id="6-7-6-启动-memcached"><a href="#6-7-6-启动-memcached" class="headerlink" title="6.7.6 启动 memcached"></a>6.7.6 启动 memcached</h3><h4 id="6-7-6-1-server1-相关操作"><a href="#6-7-6-1-server1-相关操作" class="headerlink" title="6.7.6.1 server1 相关操作"></a>6.7.6.1 server1 相关操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建用户</span><br>[root@centos7 ~]<span class="hljs-comment"># useradd -r -s /sbin/nologin memcached</span><br><br><span class="hljs-comment">#后台启动</span><br><span class="hljs-comment">#-x 10.0.0.17为对端memcached的地址</span><br>[root@centos7 ~]<span class="hljs-comment"># memcached -d -m 2048 -p 11211 -u memcached -c 2048 -x 10.0.0.17</span><br>[root@centos7 ~]<span class="hljs-comment"># ss -ntl</span><br>State      Recv-Q Send-Q                 Local Address:Port                                Peer Address:Port              <br>LISTEN     0      128                                *:11211                                          *:*                  <br>LISTEN     0      128                                *:11212                                          *:*                  <br>LISTEN     0      128                                *:22                                             *:*                  <br>LISTEN     0      128                               :::11211                                         :::*                  <br>LISTEN     0      128                               :::22                                            :::*<br></code></pre></td></tr></table></figure>

<h4 id="6-7-6-2-server2-相关操作"><a href="#6-7-6-2-server2-相关操作" class="headerlink" title="6.7.6.2 server2 相关操作"></a>6.7.6.2 server2 相关操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># useradd -r -s /sbin/nologin memcached</span><br>[root@centos7 ~]<span class="hljs-comment"># memcached -d -m 2048 -p 11211 -u memcached -c 2048 -x 10.0.0.7</span><br>[root@centos7 ~]<span class="hljs-comment"># ss -ntlu</span><br>Netid  State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port              <br>udp    UNCONN     0      0                               *:11211                                       *:*                  <br>udp    UNCONN     0      0                              :::11211                                      :::*                  <br>tcp    LISTEN     0      128                             *:11211                                       *:*                  <br>tcp    LISTEN     0      128                             *:22                                          *:*                  <br>tcp    LISTEN     0      128                            :::11211                                      :::*                  <br>tcp    LISTEN     0      128                            :::22                                         :::*<br></code></pre></td></tr></table></figure>

<h3 id="6-7-7-连接到-memcached-验证数据"><a href="#6-7-7-连接到-memcached-验证数据" class="headerlink" title="6.7.7 连接到 memcached 验证数据"></a>6.7.7 连接到 memcached 验证数据</h3><h4 id="6-7-7-1-shell-命令测试"><a href="#6-7-7-1-shell-命令测试" class="headerlink" title="6.7.7.1 shell 命令测试"></a>6.7.7.1 shell 命令测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在第一台memcached上创建数据</span><br>[root@centos7 ~]<span class="hljs-comment"># telnet 10.0.0.7 11211</span><br>Trying 10.0.0.7...<br>Connected to 10.0.0.7.<br>Escape character is <span class="hljs-string">&#x27;^]&#x27;</span>.<br>add name 0 0 4  <span class="hljs-comment">#key 名为name，且永不超时</span><br>wang<br>STORED<br>get name<br>VALUE name 0 4<br>wang<br>END<br>quit<br>Connection closed by foreign host.<br>[root@centos7 ~]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#到另外一台memcached服务器验证是否有同步过来的数据</span><br>[root@centos7 ~]<span class="hljs-comment"># telnet 10.0.0.17 11211</span><br>Trying 10.0.0.17...<br>Connected to 10.0.0.17.<br>Escape character is <span class="hljs-string">&#x27;^]&#x27;</span>.<br>get name<br>VALUE name 0 4<br>wang<br>END<br><span class="hljs-built_in">set</span> age 0 0 2  <span class="hljs-comment">#新建 key</span><br>20<br>quit<br>Connection closed by foreign host.<br><br><span class="hljs-comment">#在第一台memcached上验证实现双向复制</span><br>[root@centos7 ~]<span class="hljs-comment"># telnet 10.0.0.7 11211</span><br>Trying 10.0.0.7...<br>Connected to 10.0.0.7.<br>Escape character is <span class="hljs-string">&#x27;^]&#x27;</span>.<br>get age<br>VALUE age 0 2<br>20<br>END<br></code></pre></td></tr></table></figure>

<h4 id="6-7-7-2-python-脚本连接-memcached"><a href="#6-7-7-2-python-脚本连接-memcached" class="headerlink" title="6.7.7.2 python 脚本连接 memcached"></a>6.7.7.2 python 脚本连接 memcached</h4><p>示例：测试连接memcached的Python脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum -y install python-memcached</span><br>[root@centos7 ~]<span class="hljs-comment"># vim ./m2.py</span><br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br><br>import memcache<br><br>m = memcache.Client([<span class="hljs-string">&#x27;10.0.0.7:11211&#x27;</span>], debug=True)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(100):<br>m.set(<span class="hljs-string">&quot;key%d&quot;</span> % i,<span class="hljs-string">&quot;v%d&quot;</span> % i)<br>ret = m.get(<span class="hljs-string">&#x27;key%d&#x27;</span> % i)<br><span class="hljs-built_in">print</span> ret<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@centos7 ~]<span class="hljs-comment"># yum -y install python-memcached</span><br>[root@centos7 ~]<span class="hljs-comment"># vim ./m2.py</span><br><br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br><br><span class="hljs-keyword">import</span> memcache<br>m = memcache.Client([<span class="hljs-string">&#x27;10.0.0.7:11211&#x27;</span>], debug=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>m.<span class="hljs-built_in">set</span>(<span class="hljs-string">&quot;key%d&quot;</span> % i,<span class="hljs-string">&quot;v%d&quot;</span> % i)<br>ret = m.get(<span class="hljs-string">&#x27;key%d&#x27;</span> % i)<br><span class="hljs-built_in">print</span> ret<br><br>[root@centos7 ~]<span class="hljs-comment"># chmod +x m2.py</span><br>[root@centos7 ~]<span class="hljs-comment"># ./m2.py</span><br>v0<br>v1<br>v2<br>v3<br>v4<br>v5<br>v6<br>v7<br>v8<br>v9<br><br>[root@centos7 ~]<span class="hljs-comment"># telnet 10.0.0.7 11211</span><br>Trying <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span>...<br>Connected to <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span>.<br>Escape character <span class="hljs-keyword">is</span> <span class="hljs-string">&#x27;^]&#x27;</span>.<br>get key1<br>VALUE key1 <span class="hljs-number">0</span> <span class="hljs-number">2</span><br>v1<br>END<br>get key6<br>VALUE key6 <span class="hljs-number">0</span> <span class="hljs-number">2</span><br>v6<br>END<br>get key10<br>END<br>quit<br>Connection closed by foreign host.<br><br><span class="hljs-comment">#在第二台memcached上验证同步的数据</span><br>[root@centos7 ~]<span class="hljs-comment"># telnet 10.0.0.17 11211</span><br>Trying <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.17</span>...<br>Connected to <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.17</span>.<br>Escape character <span class="hljs-keyword">is</span> <span class="hljs-string">&#x27;^]&#x27;</span>.<br>get key1<br>VALUE key1 <span class="hljs-number">0</span> <span class="hljs-number">2</span><br>v1<br>END<br>get key6<br>VALUE key6 <span class="hljs-number">0</span> <span class="hljs-number">2</span><br>v6<br>END<br>get key10<br>END<br>quit<br>Connection closed by foreign host.<br></code></pre></td></tr></table></figure>



<h1 id="七、session-共享服务器"><a href="#七、session-共享服务器" class="headerlink" title="七、session 共享服务器"></a>七、session 共享服务器</h1><h2 id="7-1-msm"><a href="#7-1-msm" class="headerlink" title="7.1 msm"></a>7.1 msm</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat121.png" srcset="/blog/img/loading.gif"></p>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>服务</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.201</td>
<td>proxy.rlin.org</td>
<td>调度器</td>
<td>Nginx、Httpd</td>
</tr>
<tr>
<td>10.0.0.202</td>
<td>t1.rlin.org</td>
<td>tomcat1</td>
<td>jdk8、tomcat、memcached</td>
</tr>
<tr>
<td>10.0.0.203</td>
<td>t2.rlin.org</td>
<td>tomcat2</td>
<td>jdk8、tomcat、memcached</td>
</tr>
<tr>
<td>10.0.0.204</td>
<td>serssion.server</td>
<td>共享服务</td>
<td></td>
</tr>
</tbody></table>
<p>msm（memcached session manager）提供将Tomcat的session保持到memcached或redis的程序，可以实现高可用。</p>
<p>项目早期托管在google code,目前在Github</p>
<p>github网站链接: <a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager">https://github.com/magro/memcached-session-manager</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat122.png" srcset="/blog/img/loading.gif"></p>
<p>支持Tomcat的 6.x、7.x、8.x、9.x</p>
<ul>
<li>Tomcat的Session管理类，Tomcat版本不同<ul>
<li>memcached-session-manager-2.3.2.jar</li>
<li>memcached-session-manager-tc8-2.3.2.jar</li>
</ul>
</li>
<li>Session数据的序列化、反序列化类<ul>
<li>官方推荐kyro</li>
<li>在webapp中WEB-INF/lib/下 </li>
</ul>
</li>
<li>驱动类<ul>
<li>memcached(spymemcached.jar)</li>
<li>Redis(jedis.jar)</li>
</ul>
</li>
</ul>
<p>参考链接: <a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a></p>
<p>将spymemcached.jar、memcached-session-manage、kyro相关的jar文件都放到Tomcat的lib目录中去，这个目录是 $CATALINA_HOME/lib/ ，对应本次安装就是/usr/local/tomcat/lib。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">kryo-3.0.3.jar<br>asm-5.2.jar<br>objenesis-2.6.jar<br>reflectasm-1.11.9.jar<br>minlog-1.3.1.jar<br>kryo-serializers-0.45.jar<br>msm-kryo-serializer-2.3.2.jar<br>memcached-session-manager-tc8-2.3.2.jar<br>spymemcached-2.12.3.jar<br>memcached-session-manager-2.3.2.jar<br></code></pre></td></tr></table></figure>

<h2 id="7-3-sticky-模式"><a href="#7-3-sticky-模式" class="headerlink" title="7.3 sticky 模式"></a>7.3 sticky 模式</h2><h3 id="7-3-1-sticky-模式工作原理"><a href="#7-3-1-sticky-模式工作原理" class="headerlink" title="7.3.1 sticky 模式工作原理"></a>7.3.1 sticky 模式工作原理</h3><p>sticky 模式即前端tomcat和后端memcached有关联(粘性)关系</p>
<p>参考文档:<a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">Tomcat-1 (t1) will primarily store it<span class="hljs-string">&#x27;s sessions in memcached-2 (m2) which is running on another machine (m2 is a regular node for t1). Only if m2 is not available, t1 will store it&#x27;</span>s sessions <span class="hljs-keyword">in</span> memcached-1 (m1, m1 is the failoverNode <span class="hljs-keyword">for</span> t1). With this configuration, sessions won<span class="hljs-string">&#x27;t be lost when machine 1 (serving t1 and m1) crashes. The following really nice ASCII art showsthis setup. </span><br><span class="hljs-string">Tomcat-1（t1）主要将其会话存储在另一台计算机上运行的memcached-2（m2）中（m2是t1的常规节点）。 仅当m2不可用时，t1才会将其会话存储在memcached-1中（m1，m1是t1的failoverNode）。 使用此配置，当计算机1（服务于t1和m1）崩溃时，会话不会丢失。 以下非常好的ASCII艺术显示了此设置。</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;t1&gt;  &lt;t2&gt;</span><br><span class="hljs-string"> . \ / .</span><br><span class="hljs-string"> .  X  .</span><br><span class="hljs-string"> . / \ .</span><br><span class="hljs-string">&lt;m1&gt;  &lt;m2&gt;</span><br></code></pre></td></tr></table></figure>

<p>t1和m1部署可以在一台主机上，t2和m2部署也可以在同一台。</p>
<p>当新用户发请求到Tomcat1时, Tomcat1生成session返回给用户的同时,也会同时发给memcached2备份。即Tomcat1 session为<strong>主session</strong>，memcached2 session为<strong>备用session</strong>，使用memcached相当于备份了一份Session</p>
<p>如果Tomcat1发现memcached2 失败,无法备份Session到memcached2,则将Sessoin备份存放在memcached1中</p>
<h3 id="7-3-2-配置过程"><a href="#7-3-2-配置过程" class="headerlink" title="7.3.2 配置过程"></a>7.3.2 配置过程</h3><h4 id="7-3-2-1-下载相关jar包"><a href="#7-3-2-1-下载相关jar包" class="headerlink" title="7.3.2.1 下载相关jar包"></a>7.3.2.1 下载相关jar包</h4><p>下载相关jar包,参考下面官方说明的下载链接</p>
<p><a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a></p>
<p><strong>tomcat和memcached相关包</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat122.png" srcset="/blog/img/loading.gif"></p>
<p><strong>序列化相关下载</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat123.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-3-2-2-修改tomcat配置"><a href="#7-3-2-2-修改tomcat配置" class="headerlink" title="7.3.2.2 修改tomcat配置"></a>7.3.2.2 修改tomcat配置</h4><p>修改 $CATALINA_HOME/conf/context.xml</p>
<p>特别注意，t1配置中为failoverNodes=”n1”， t2配置为failoverNodes=”n2”</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml">#以下是sticky的配置<br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span>&gt;</span><br>...<br> <span class="hljs-tag">&lt;<span class="hljs-name">Manager</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">memcachedNodes</span>=<span class="hljs-string">&quot;n1:10.0.0.202:11211,n2:10.0.0.203:11211&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">failoverNodes</span>=<span class="hljs-string">&quot;n1&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">requestUriIgnorePattern</span>=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">transcoderFactoryClass</span>=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span><br><span class="hljs-tag">  /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>配置说明</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">memcachedNodes=&quot;n1:host1.yourdomain.com:11211,n2:host2.yourdomain.com:11211&quot;<br><br>memcached的节点: n1、n2只是别名，可以重新命名。failoverNodes 为故障转移节点，n1是备用节点，n2是主存储节点。另一台Tomcat将n1改为n2，其主节点是n1，备用节点是n2。<br></code></pre></td></tr></table></figure>

<p>如果配置成功，可以在logs/catalina.out中看到下面的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">12-APR-2020 16:24:08.975 INFO [t1.magedu.com-startStop-1]<br>de.javakaffee.web.msm.MemcachedSessionService.startInternal --------<br>- finished initialization:<br>- sticky: <span class="hljs-literal">true</span><br>- operation timeout: 1000<br>- node ids: [n2]<br>- failover node ids: [n1]<br>- storage key prefix: null<br>- locking mode: null (expiration: 5s)<br></code></pre></td></tr></table></figure>

<p>配置成功后，网页访问以下，页面中看到了Session。然后运行下面的Python程序，就可以看到是否存储到了memcached中了。</p>
<h4 id="7-3-2-3-准备测试msm的python脚本"><a href="#7-3-2-3-准备测试msm的python脚本" class="headerlink" title="7.3.2.3 准备测试msm的python脚本"></a>7.3.2.3 准备测试msm的python脚本</h4><p>范例：安装python环境准备python程序查看memcached中的SessionID</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@centos8 ~]<span class="hljs-comment"># yum -y install python3 python3-memcached</span><br><span class="hljs-comment">#或者执行下面两步</span><br>[root@centos8 ~]<span class="hljs-comment"># yum install python3 -y</span><br>[root@centos8 ~]<span class="hljs-comment"># pip3 install python-memcached</span><br><br><span class="hljs-comment">#脚本内容</span><br>[root@centos8 ~]<span class="hljs-comment"># cat showmemcached.py</span><br><span class="hljs-keyword">import</span> memcache<br><br>mc = memcache.Client([<span class="hljs-string">&#x27;10.0.0.202:11211&#x27;</span>], debug=<span class="hljs-literal">True</span>)<br><br>stats = mc.get_stats()[<span class="hljs-number">0</span>]<br><span class="hljs-built_in">print</span>(stats)<br><span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> stats[<span class="hljs-number">1</span>].items():<br>  <span class="hljs-built_in">print</span>(k, v)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">30</span>)<br><span class="hljs-comment"># 查看全部key</span><br><span class="hljs-built_in">print</span>(mc.get_stats(<span class="hljs-string">&#x27;items&#x27;</span>)) <span class="hljs-comment"># stats items 返回 items:5:number 1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">30</span>)<br><span class="hljs-built_in">print</span>(mc.get_stats(<span class="hljs-string">&#x27;cachedump 5 0&#x27;</span>)) <span class="hljs-comment"># stats cachedump 5 0 # 5和上面的items返回的值有关；0表示全部</span><br></code></pre></td></tr></table></figure>

<p>t1、t2、n1、n2依次启动成功，分别使用<a target="_blank" rel="noopener" href="http://t1.rlin.org:8080/">http://t1.rlin.org:8080/</a> 和<a target="_blank" rel="noopener" href="http://t2.rlin.org:8080/%E8%A7%82%E5%AF%9F%E3%80%82">http://t2.rlin.org:8080/观察。</a></p>
<p>开启负载均衡调度器，通过<a target="_blank" rel="noopener" href="http://proxy.rlin.com来访问看看效果/">http://proxy.rlin.com来访问看看效果</a></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">On tomcats<br>10.0.0.203:8080<br>SessionID = 2A19B1EB6D9649C9FED3E7277FDFD470-n2.Tomcat1<br>Wed Jun 26 16:32:11 CST 2019<br><br>On tomcats<br>10.0.0.202:8080<br>SessionID = 2A19B1EB6D9649C9FED3E7277FDFD470-n1.Tomcat2<br>Wed Jun 26 16:32:36 CST 2019<br></code></pre></td></tr></table></figure>

<p>可以看到浏览器端被调度到不同Tomcat上，但是都获得了同样的SessionID。</p>
<p>停止t2、n2看看效果，恢复看看效果。</p>
<p>范例：访问tomcat，查看memcached中SessionID信息</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat124.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># python3 showmemcached.py</span><br>.....<br>[(<span class="hljs-string">&#x27;10.0.0.48:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;8D0B801640CA0B1EB9AD4A4C221EA81A-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97b;</span><br><span class="hljs-string">1581598952 s]&#x27;</span>&#125;)]<br><span class="hljs-comment">#以上结果表示SessionID来自于memcached的n2节点，但是最终是由tomcat1返回的SessionID</span><br></code></pre></td></tr></table></figure>

<h3 id="7-3-3-实战案例-1-tomcat和memcached集成在一台主机"><a href="#7-3-3-实战案例-1-tomcat和memcached集成在一台主机" class="headerlink" title="7.3.3 实战案例 1 : tomcat和memcached集成在一台主机"></a>7.3.3 实战案例 1 : tomcat和memcached集成在一台主机</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat125.png" srcset="/blog/img/loading.gif"></p>
<p>环境准备：</p>
<ul>
<li>时间同步，确保NTP或Chrony服务正常运行。</li>
<li>防火墙规则</li>
<li>禁用SELinux</li>
<li>三台主机</li>
</ul>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>服务</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.201</td>
<td>proxy.rlin.org</td>
<td>调度器</td>
<td>CentOS8、Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.202</td>
<td>t1.rlin.org</td>
<td>tomcat1</td>
<td>CentOS8、JDK8、Tomcat8、memcached</td>
</tr>
<tr>
<td>10.0.0.203</td>
<td>t2.rlin.org</td>
<td>tomcat1</td>
<td>CentOS8、JDK8、Tomcat8、memcached</td>
</tr>
</tbody></table>
<h4 id="7-3-3-1-配置nginx充当proxy"><a href="#7-3-3-1-配置nginx充当proxy" class="headerlink" title="7.3.3.1 配置nginx充当proxy"></a>7.3.3.1 配置nginx充当proxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># cat /etc/nginx/nginx.conf</span><br>http &#123;<br>......<br>upstream tomcat-server &#123;<br>    <span class="hljs-comment">#ip_hash;</span><br>   server t1.rlin.org:8080;<br>   server t2.rlin.org:8080;<br>&#125;<br> server &#123;<br>......<br>   location / &#123;<br>   &#125;<br>   location ~* \.(jsp|<span class="hljs-keyword">do</span>)$ &#123;<br>    proxy_pass http://tomcat-server;<br>   &#125;<br><br>[root@proxy ~]<span class="hljs-comment"># cat /etc/hosts</span><br>10.0.0.201 proxy.rlin.org proxy<br>10.0.0.202 t1.rlin.org t1<br>10.0.0.203 t2.rlin.org t2<br></code></pre></td></tr></table></figure>

<h4 id="7-3-3-2-配置memcached"><a href="#7-3-3-2-配置memcached" class="headerlink" title="7.3.3.2 配置memcached"></a>7.3.3.2 配置memcached</h4><h5 id="7-3-3-2-1-在-tomcat1-上配置-memcached"><a href="#7-3-3-2-1-在-tomcat1-上配置-memcached" class="headerlink" title="7.3.3.2.1 在 tomcat1 上配置 memcached"></a>7.3.3.2.1 在 tomcat1 上配置 memcached</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># yum -y install memcached</span><br>[root@t1 ~]<span class="hljs-comment"># vim /etc/sysconfig/memcached</span><br>[root@t1 ~]<span class="hljs-comment"># cat /etc/sysconfig/memcached</span><br>PORT=<span class="hljs-string">&quot;11211&quot;</span><br>USER=<span class="hljs-string">&quot;memcached&quot;</span><br>MAXCONN=<span class="hljs-string">&quot;1024&quot;</span><br>CACHESIZE=<span class="hljs-string">&quot;64&quot;</span><br><span class="hljs-comment">#注释下面行</span><br><span class="hljs-comment">#OPTIONS=&quot;-l 127.0.0.1,::1&quot;</span><br><br>[root@t1 ~]<span class="hljs-comment"># systemctl enable --now memcached.service</span><br></code></pre></td></tr></table></figure>

<h5 id="7-3-3-2-2-在-tomcat2-上配置-memcached"><a href="#7-3-3-2-2-在-tomcat2-上配置-memcached" class="headerlink" title="7.3.3.2.2 在 tomcat2 上配置 memcached"></a>7.3.3.2.2 在 tomcat2 上配置 memcached</h5><p>配置和t1相同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t2 ~]<span class="hljs-comment"># yum -y install memcached</span><br>[root@t2 ~]<span class="hljs-comment"># vim /etc/sysconfig/memcached</span><br>[root@t2 ~]<span class="hljs-comment"># cat /etc/sysconfig/memcached</span><br>PORT=<span class="hljs-string">&quot;11211&quot;</span><br>USER=<span class="hljs-string">&quot;memcached&quot;</span><br>MAXCONN=<span class="hljs-string">&quot;1024&quot;</span><br>CACHESIZE=<span class="hljs-string">&quot;64&quot;</span><br><span class="hljs-comment">#注释下面行</span><br><span class="hljs-comment">#OPTIONS=&quot;-l 127.0.0.1,::1&quot;</span><br><br>[root@t2 ~]<span class="hljs-comment"># systemctl enable --now memcached.service</span><br></code></pre></td></tr></table></figure>

<h4 id="7-3-3-3-配置-tomcat"><a href="#7-3-3-3-配置-tomcat" class="headerlink" title="7.3.3.3 配置 tomcat"></a>7.3.3.3 配置 tomcat</h4><h5 id="7-3-3-3-1-配置-tomcat1"><a href="#7-3-3-3-1-配置-tomcat1" class="headerlink" title="7.3.3.3.1 配置 tomcat1"></a>7.3.3.3.1 配置 tomcat1</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先安装tomcat，然后修改配置</span><br>[root@t1 tomcat]<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat<br>[root@t1 tomcat]<span class="hljs-comment"># vim conf/server.xml</span><br>&lt;Engine name=<span class="hljs-string">&quot;Catalina&quot;</span> defaultHost=<span class="hljs-string">&quot;t1.rlin.org&quot;</span> jvmRoute=<span class="hljs-string">&quot;Tomcat1&quot;</span>&gt; <br>......<br>   &lt;Host name=<span class="hljs-string">&quot;t1.rlin.org&quot;</span> appBase=<span class="hljs-string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="hljs-string">&quot;true&quot;</span> &gt;<br>  &lt;/Host&gt; <br> &lt;/Engine&gt;<br>&lt;/Service&gt;<br>&lt;/Server&gt;<br><br>[root@t1 tomcat]<span class="hljs-comment"># vim conf/context.xml</span><br>&lt;Context&gt;<br>......<br> &lt;Manager pathname=<span class="hljs-string">&quot;&quot;</span> /&gt;<br>  --&gt;<br><span class="hljs-comment">###倒数第一行前,即&lt;/Context&gt;行的前面,加下面内容</span><br>&lt;Manager className=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br>memcachedNodes=<span class="hljs-string">&quot;n1:10.0.0.202:11211,n2:10.0.0.203:11211&quot;</span><br>failoverNodes=<span class="hljs-string">&quot;n1&quot;</span><br>requestUriIgnorePattern=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br>transcoderFactoryClass=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span><br>/&gt;<br>&lt;/Context&gt;  <span class="hljs-comment">#最后一行</span><br><br><span class="hljs-comment">#将相关包传到lib/目录下</span><br>asm-5.2.jar<br>kryo-3.0.3.jar<br>kryo-serializers-0.45.jar<br>memcached-session-manager-2.3.2.jar<br>memcached-session-manager-tc8-2.3.2.jar<br>minlog-1.3.1.jar<br>msm-kryo-serializer-2.3.2.jar<br>objenesis-2.6.jar<br>reflectasm-1.11.9.jar<br>spymemcached-2.12.3.jar<br><br>[root@t1 tomcat]<span class="hljs-comment"># ls lib/ -t |tail</span><br>kryo-3.0.3.jar<br>asm-5.2.jar<br>objenesis-2.6.jar<br>reflectasm-1.11.9.jar<br>minlog-1.3.1.jar<br>kryo-serializers-0.45.jar<br>msm-kryo-serializer-2.3.2.jar<br>memcached-session-manager-tc8-2.3.2.jar<br>spymemcached-2.12.3.jar<br>memcached-session-manager-2.3.2.jar<br><br>[root@t1 tomcat]<span class="hljs-comment"># mkdir -p /data/webapps/ROOT</span><br>[root@t1 tomcat]<span class="hljs-comment"># cat /data/webapps/ROOT/index.jsp</span><br>&lt;%@ page import=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br> &lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt; tomcat website &lt;/h1&gt;<br>&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="hljs-string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;<br>&lt;%=new Date()%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@t1 tomcat]<span class="hljs-comment"># chown -R tomcat.tomcat /data/webapps</span><br>[root@t1 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br></code></pre></td></tr></table></figure>

<h5 id="7-3-3-3-2-配置-tomcat2"><a href="#7-3-3-3-2-配置-tomcat2" class="headerlink" title="7.3.3.3.2 配置 tomcat2"></a>7.3.3.3.2 配置 tomcat2</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#t2参考上面t1做配置</span><br>[root@t2 tomcat]<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat<br>[root@t2 tomcat]<span class="hljs-comment"># vim conf/server.xml</span><br>&lt;Engine name=<span class="hljs-string">&quot;Catalina&quot;</span> defaultHost=<span class="hljs-string">&quot;t2.rlin.org&quot;</span> jvmRoute=<span class="hljs-string">&quot;Tomcat2&quot;</span>&gt; <br>......<br>  &lt;Host name=<span class="hljs-string">&quot;t2.rlin.org&quot;</span> appBase=<span class="hljs-string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="hljs-string">&quot;true&quot;</span> &gt;<br>  &lt;/Host&gt; <br>  &lt;/Engine&gt;<br>&lt;/Service&gt;<br>&lt;/Server&gt;<br><br>[root@t2 tomcat]<span class="hljs-comment"># vim conf/context.xml</span><br>&lt;Context&gt;<br>......<br> &lt;Manager pathname=<span class="hljs-string">&quot;&quot;</span> /&gt;<br>  --&gt;<br><span class="hljs-comment">####################加下面内容################</span><br>&lt;Manager className=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br>memcachedNodes=<span class="hljs-string">&quot;n1:10.0.0.202:11211,n2:10.0.0.203:11211&quot;</span><br>failoverNodes=<span class="hljs-string">&quot;n2&quot;</span>  <span class="hljs-comment">#只修改此行,和t1不同,其它都一样</span><br>requestUriIgnorePattern=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br>transcoderFactoryClass=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span><br>/&gt;<br><span class="hljs-comment">####################加上面内容################</span><br>&lt;/Context&gt;<br><br><span class="hljs-comment">#将相关包传到lib/目录下</span><br>asm-5.2.jar<br>kryo-3.0.3.jar<br>kryo-serializers-0.45.jar<br>memcached-session-manager-2.3.2.jar<br>memcached-session-manager-tc8-2.3.2.jar<br>minlog-1.3.1.jar<br>msm-kryo-serializer-2.3.2.jar<br>objenesis-2.6.jar<br>reflectasm-1.11.9.jar<br>spymemcached-2.12.3.jar<br><br>[root@t2 tomcat]<span class="hljs-comment">#ls lib/ -t |tail</span><br>kryo-3.0.3.jar<br>asm-5.2.jar<br>objenesis-2.6.jar<br>reflectasm-1.11.9.jar<br>minlog-1.3.1.jar<br>kryo-serializers-0.45.jar<br>msm-kryo-serializer-2.3.2.jar<br>memcached-session-manager-tc8-2.3.2.jar<br>spymemcached-2.12.3.jar<br>memcached-session-manager-2.3.2.jar<br><br>[root@t2 tomcat]<span class="hljs-comment"># mkdir -p /data/webapps/ROOT</span><br>[root@t2 tomcat]<span class="hljs-comment"># cat /data/webapps/ROOT/index.jsp</span><br>&lt;%@ page import=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br> &lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt; tomcat website &lt;/h1&gt;<br>&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="hljs-string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;<br>&lt;%=new Date()%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@t2 tomcat]<span class="hljs-comment"># chown -R tomcat.tomcat /data/webapps</span><br>[root@t2 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br></code></pre></td></tr></table></figure>

<h5 id="7-3-3-3-3-查看tomcat日志"><a href="#7-3-3-3-3-查看tomcat日志" class="headerlink" title="7.3.3.3.3 查看tomcat日志"></a>7.3.3.3.3 查看tomcat日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 tomcat]<span class="hljs-comment"># tail -n 20 logs/catalina.out</span><br>13-Aug-2021 21:05:38.328 INFO [t1.rlin.org-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.startInternal  starts initialization... (configured nodes definition n1:10.0.0.8:11211,n2:10.0.0.9:11211, failover nodes n1)<br>2021-08-13 21:05:38.328 INFO net.spy.memcached.MemcachedConnection:  Setting retryQueueSize to -1<br>2021-08-13 21:05:38.329 INFO net.spy.memcached.MemcachedConnection:  Added &#123;QA sa=/10.0.0.8:11211, <span class="hljs-comment">#Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0&#125; to connect queue</span><br>2021-08-13 21:05:38.343 INFO net.spy.memcached.MemcachedConnection:  Added &#123;QA sa=/10.0.0.9:11211, <span class="hljs-comment">#Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0&#125; to connect queue</span><br>13-Aug-2021 21:05:38.355 INFO [t1.rlin.org-startStop-1] de.javakaffee.web.msm.RequestTrackingHostValve.&lt;init&gt; Setting ignorePattern to .*\.(ico|png|gif|jpg|css|js)$<br>13-Aug-2021 21:05:38.356 INFO [t1.rlin.org-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.setLockingMode Setting lockingMode to null<br>13-Aug-2021 21:05:38.356 INFO [t1.rlin.org-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.createTranscoderFactory Creating transcoder factory de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory<br>13-Aug-2021 21:05:38.356 INFO [t1.rlin.org-startStop-1] de.javakaffee.web.msm.serializer.kryo.KryoTranscoder.&lt;init&gt; Starting with initialBufferSize 102400, maxBufferSize 2048000 and defaultSerializerFactory de.javakaffee.web.msm.serializer.kryo.DefaultFieldSerializerFactory<br>13-Aug-2021 21:05:38.356 INFO [t1.rlin.org-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.startInternal --------<br>-  finished initialization: <span class="hljs-comment">#出现这几行就证明成功开启了stick</span><br>- sticky: <span class="hljs-literal">true</span><br>- operation timeout: 1000<br>- node ids: [n2]<br>- failover node ids: [n1]<br>- storage key prefix: null<br>- locking mode: null (expiration: 5s)<br>--------<br>13-Aug-2021 21:05:38.359 INFO [t1.rlin.org-startStop-1] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/data/webapps/ROOT] has finished <span class="hljs-keyword">in</span> [161] ms<br>13-Aug-2021 21:05:38.376 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [<span class="hljs-string">&quot;http-nio-8080&quot;</span>]<br>13-Aug-2021 21:05:38.509 INFO [main] org.apache.catalina.startup.Catalina.start Server startup <span class="hljs-keyword">in</span> 1962 ms<br>[root@t1 tomcat]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h4 id="7-3-3-4-python测试脚本"><a href="#7-3-3-4-python测试脚本" class="headerlink" title="7.3.3.4 python测试脚本"></a>7.3.3.4 python测试脚本</h4><p>在t1 上安装部署python3环境,访问memcached</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># yum -y install python3 python3-memcached</span><br><span class="hljs-comment">#或者下面方式也可以安装</span><br>[root@t1 ~]<span class="hljs-comment"># yum -y install python3</span><br>[root@t1 ~]<span class="hljs-comment"># pip3 install python-memcached</span><br><br><span class="hljs-comment">#准备python测试脚本</span><br>[root@t1 ~]<span class="hljs-comment"># cat showmemcached.py</span><br><span class="hljs-comment">#!/usr/bin/python3</span><br>import memcache <span class="hljs-comment"># pip install python-memcached</span><br>mc = memcache.Client([<span class="hljs-string">&#x27;10.0.0.202:11211&#x27;</span>,<span class="hljs-string">&#x27;10.0.0.203:11211&#x27;</span>], debug=True)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * 30)<br><span class="hljs-comment">#查看全部 key</span><br><span class="hljs-comment">#for x in mc.get_stats(&#x27;items&#x27;): # stats items 返回 items:5:number 1</span><br><span class="hljs-comment">#  print(x)</span><br><span class="hljs-comment">#print(&#x27;-&#x27; * 30)</span><br><br><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> mc.get_stats(<span class="hljs-string">&#x27;cachedump 5 0&#x27;</span>):  <span class="hljs-comment"># stats cachedump 5 0 # 5和上面的items返回的值有关；0表示全部</span><br> <span class="hljs-built_in">print</span>(x)<br> <br>[root@t1 ~]<span class="hljs-comment"># chmod +x showmemcached.py</span><br><br><span class="hljs-comment">#运行python脚本</span><br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="7-3-3-5-浏览器访问"><a href="#7-3-3-5-浏览器访问" class="headerlink" title="7.3.3.5 浏览器访问"></a>7.3.3.5 浏览器访问</h4><p>第一次刷新页面,可以看到下面显示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat126.png" srcset="/blog/img/loading.gif"></p>
<p>第一次运行脚本查看结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment">#./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;3B4E6FB0934692150DD9944845830FCC-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97b; 1603970381 s]&#x27;</span>&#125;)<br><br><span class="hljs-comment">#只有10.0.0.203上有信息,说明SessionID是由Tomcat1生成,并备份到n2,即t2上面的memcached</span><br></code></pre></td></tr></table></figure>

<p>第二次刷新页面后,运行脚本可以查看到下面显示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat127.png" srcset="/blog/img/loading.gif"></p>
<p>第二次执行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment">#./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;3B4E6FB0934692150DD9944845830FCC-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97b; 1603970442 s]&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;&#125;)<br></code></pre></td></tr></table></figure>

<p>第三次刷新页面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat128.png" srcset="/blog/img/loading.gif"></p>
<p>第三次执行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;1F25576134187FC6AA22D3C3033BCDCC-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867127 s]&#x27;</span>, <span class="hljs-string">&#x27;601A4DC423A52482387467745B17A435-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867076 s]&#x27;</span>, <span class="hljs-string">&#x27;C10DAF92EC7A40FD980DE43B19BB188B-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867075 s]&#x27;</span>, <span class="hljs-string">&#x27;3663B038625BD11CC4FACC5EE7173F03-n1.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867072 s]&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;1F25576134187FC6AA22D3C3033BCDCC-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867127 s]&#x27;</span>, <span class="hljs-string">&#x27;F597658A6DD05BA715409BE8364F158A-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867123 s]&#x27;</span>, <span class="hljs-string">&#x27;5521051E99D8AC28E432DBE9499697DA-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867077 s]&#x27;</span>, <span class="hljs-string">&#x27;5525205EE8F48596C3EB1D2E2C3882BF-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867076 s]&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>

<p>第四次刷新页面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat129.png" srcset="/blog/img/loading.gif"></p>
<p>第四次执行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment">#./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;1F25576134187FC6AA22D3C3033BCDCC-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867127 s]&#x27;</span>, <span class="hljs-string">&#x27;601A4DC423A52482387467745B17A435-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867076 s]&#x27;</span>, <span class="hljs-string">&#x27;C10DAF92EC7A40FD980DE43B19BB188B-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867075 s]&#x27;</span>, <span class="hljs-string">&#x27;3663B038625BD11CC4FACC5EE7173F03-n1.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867072 s]&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;1F25576134187FC6AA22D3C3033BCDCC-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867127 s]&#x27;</span>, <span class="hljs-string">&#x27;F597658A6DD05BA715409BE8364F158A-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867123 s]&#x27;</span>, <span class="hljs-string">&#x27;5521051E99D8AC28E432DBE9499697DA-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867077 s]&#x27;</span>, <span class="hljs-string">&#x27;5525205EE8F48596C3EB1D2E2C3882BF-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628867076 s]&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>

<p>之后多次刷新页面,执行脚本后,session信息不在变化</p>
<h4 id="7-3-3-6-故障访问"><a href="#7-3-3-6-故障访问" class="headerlink" title="7.3.3.6 故障访问"></a>7.3.3.6 故障访问</h4><h5 id="7-3-3-6-1-模拟tomcat故障"><a href="#7-3-3-6-1-模拟tomcat故障" class="headerlink" title="7.3.3.6.1 模拟tomcat故障"></a>7.3.3.6.1 模拟tomcat故障</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">[root@t2 ~]# systemctl stop tomcat<br></code></pre></td></tr></table></figure>

<p>刷新几次页面,看到下面SessionID显示不变</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat130.png" srcset="/blog/img/loading.gif"></p>
<p>运行脚本看到下面结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;items:5:number&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;items:5:number_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:number_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:number_cold&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;items:5:age_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:age_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:age&#x27;</span>: <span class="hljs-string">&#x27;1531&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:evicted_nonzero&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted_time&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:outofmemory&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:tailrepairs&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:reclaimed&#x27;</span>:<br><span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:expired_unfetched&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted_unfetched&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:evicted_active&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:crawler_reclaimed&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:crawler_items_checked&#x27;</span>: <span class="hljs-string">&#x27;9&#x27;</span>, <span class="hljs-string">&#x27;items:5:lrutail_reflocked&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:moves_to_cold&#x27;</span>: <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;items:5:moves_to_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:moves_within_lru&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:direct_reclaims&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:hits_to_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_cold&#x27;</span>:<br><span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_temp&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;&#125;)<br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;4E92417BEFB38ED09E50433EF6F96DDF-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b;1594562924 s]&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;&#125;)<br></code></pre></td></tr></table></figure>

<h5 id="7-3-3-6-2-模拟memcached故障"><a href="#7-3-3-6-2-模拟memcached故障" class="headerlink" title="7.3.3.6.2 模拟memcached故障"></a>7.3.3.6.2 模拟memcached故障</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">[root@t2 ~]# systemctl start tomcat<br>[root@t2 ~]# systemctl stop memcached.service<br></code></pre></td></tr></table></figure>

<p>刷新几次页面可以看到下面显示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat131.png" srcset="/blog/img/loading.gif"></p>
<p>再次运行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>MemCached: MemCache: inet:10.0.0.102:11211: connect: [Errno 111] Connection<br>refused. Marking dead.<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;items:5:number&#x27;</span>: <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;items:5:number_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:number_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:number_cold&#x27;</span>: <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;items:5:age_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:age_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:age&#x27;</span>: <span class="hljs-string">&#x27;60&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:evicted_nonzero&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted_time&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:outofmemory&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:tailrepairs&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:reclaimed&#x27;</span>:<br><span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;items:5:expired_unfetched&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted_unfetched&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:evicted_active&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:crawler_reclaimed&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:crawler_items_checked&#x27;</span>: <span class="hljs-string">&#x27;11&#x27;</span>, <span class="hljs-string">&#x27;items:5:lrutail_reflocked&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:moves_to_cold&#x27;</span>: <span class="hljs-string">&#x27;13&#x27;</span>, <span class="hljs-string">&#x27;items:5:moves_to_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:moves_within_lru&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:direct_reclaims&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:hits_to_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_cold&#x27;</span>:<br><span class="hljs-string">&#x27;5&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_temp&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>&#125;)<br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;63B8F0CE41AF8943351AB9B71DE174C3-n1.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b;1594564819 s]&#x27;</span>, <span class="hljs-string">&#x27;63B8F0CE41AF8943351AB9B71DE174C3-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1594564785 s]&#x27;</span>&#125;)<br><br><span class="hljs-comment">#看到只有10.0.0.202有信息,并且生成两个sessionID,说明当memcached2挂掉后,tomcat1将只能将Session信息写入至memcached1做为备份</span><br></code></pre></td></tr></table></figure>

<p>恢复memcached</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t2 ~]<span class="hljs-comment"># systemctl start memcached.service</span><br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;items:5:number&#x27;</span>: <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;items:5:number_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:number_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:number_cold&#x27;</span>: <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;items:5:age_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:age_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:age&#x27;</span>: <span class="hljs-string">&#x27;23&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:evicted_nonzero&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted_time&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:outofmemory&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:tailrepairs&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:reclaimed&#x27;</span>:<br><span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;items:5:expired_unfetched&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted_unfetched&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:evicted_active&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:crawler_reclaimed&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:crawler_items_checked&#x27;</span>: <span class="hljs-string">&#x27;13&#x27;</span>, <span class="hljs-string">&#x27;items:5:lrutail_reflocked&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:moves_to_cold&#x27;</span>: <span class="hljs-string">&#x27;20&#x27;</span>, <span class="hljs-string">&#x27;items:5:moves_to_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:moves_within_lru&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:direct_reclaims&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:hits_to_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_cold&#x27;</span>:<br><span class="hljs-string">&#x27;5&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_temp&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;items:5:number&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;items:5:number_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:number_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:number_cold&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;items:5:age_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:age_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:age&#x27;</span>: <span class="hljs-string">&#x27;20&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:evicted_nonzero&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted_time&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:outofmemory&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:tailrepairs&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:reclaimed&#x27;</span>:<br><span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:expired_unfetched&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:evicted_unfetched&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:evicted_active&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:crawler_reclaimed&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:crawler_items_checked&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:lrutail_reflocked&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:moves_to_cold&#x27;</span>: <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;items:5:moves_to_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:moves_within_lru&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:direct_reclaims&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;items:5:hits_to_hot&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_warm&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_cold&#x27;</span>:<br><span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;items:5:hits_to_temp&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>&#125;)<br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;63B8F0CE41AF8943351AB9B71DE174C3-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b;1594564785 s]&#x27;</span>, <span class="hljs-string">&#x27;63B8F0CE41AF8943351AB9B71DE174C3-n1.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b;1594564819 s]&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;63B8F0CE41AF8943351AB9B71DE174C3-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b;1594564796 s]&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>

<h3 id="7-3-4-实战案例-2-tomcat和memcached-分别处于不同主机"><a href="#7-3-4-实战案例-2-tomcat和memcached-分别处于不同主机" class="headerlink" title="7.3.4 实战案例 2 : tomcat和memcached 分别处于不同主机"></a>7.3.4 实战案例 2 : tomcat和memcached 分别处于不同主机</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat132.png" srcset="/blog/img/loading.gif"></p>
<p>环境准备：</p>
<ul>
<li><p>时间同步，确保NTP或Chrony服务正常运行。</p>
</li>
<li><p>防火墙规则</p>
</li>
<li><p>禁用SELinux</p>
</li>
<li><p>五台主机</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>服务</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.201</td>
<td>proxy.rlin.org</td>
<td>调度器</td>
<td>CentOS8、Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.202</td>
<td>t1.rlin.org</td>
<td>tomcat1</td>
<td>CentOS8、JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.203</td>
<td>t2.rlin.org</td>
<td>tomcat2</td>
<td>CentOS8、JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.204</td>
<td>m1.rlin.org</td>
<td>memcached1</td>
<td>CentOS8、memcached</td>
</tr>
<tr>
<td>10.0.0.205</td>
<td>m2.rlin.org</td>
<td>memcached2</td>
<td>CentOS8、memcached</td>
</tr>
</tbody></table>
<h4 id="7-3-4-1-准备proxy主机的配置，利用nginx作为反向代理"><a href="#7-3-4-1-准备proxy主机的配置，利用nginx作为反向代理" class="headerlink" title="7.3.4.1 准备proxy主机的配置，利用nginx作为反向代理"></a>7.3.4.1 准备proxy主机的配置，利用nginx作为反向代理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># cat /etc/nginx/nginx.conf</span><br>http &#123;<br>......<br>upstream tomcat-server &#123;<br>   server t1.rlin.org:8080;<br>   server t2.rlin.org:8080;<br>&#125;<br> server &#123;<br>......<br>   location / &#123;<br>   &#125;<br>   location ~* \.(jsp|<span class="hljs-keyword">do</span>)$ &#123;<br>    proxy_pass http://tomcat-server;<br>   &#125;<br>   <br>[root@proxy ~]<span class="hljs-comment"># systemctl enable --now nginx</span><br><br>[root@proxy ~]<span class="hljs-comment"># cat /etc/hosts</span><br>10.0.0.201 proxy.rlin.org proxy<br>10.0.0.202 t1.rlin.org t1<br>10.0.0.203 t2.rlin.org t2<br><br><span class="hljs-comment">#准备一台测试机(可选)</span><br>[root@centos7 ~]<span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4<br>centos7.wangxiaochun.com<br>::1     localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.0.0.201 proxy.rlin.org<br>[root@centos7 ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.7<br></code></pre></td></tr></table></figure>

<h4 id="7-3-4-2-在m1和m2上分别配置memcached"><a href="#7-3-4-2-在m1和m2上分别配置memcached" class="headerlink" title="7.3.4.2 在m1和m2上分别配置memcached"></a>7.3.4.2 在m1和m2上分别配置memcached</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在m1和m2上做相同的配置</span><br>[root@m1 ~]<span class="hljs-comment"># yum -y install memcached</span><br>[root@m1 ~]<span class="hljs-comment"># vim /etc/sysconfig/memcached</span><br>[root@m1 ~]<span class="hljs-comment"># cat /etc/sysconfig/memcached</span><br>PORT=<span class="hljs-string">&quot;11211&quot;</span><br>USER=<span class="hljs-string">&quot;memcached&quot;</span><br>MAXCONN=<span class="hljs-string">&quot;1024&quot;</span><br>CACHESIZE=<span class="hljs-string">&quot;64&quot;</span><br><span class="hljs-comment">#OPTIONS=&quot;-l 127.0.0.1,::1&quot;</span><br>OPTIONS=<span class="hljs-string">&quot;&quot;</span><br>[root@m1 ~]<span class="hljs-comment"># systemctl start memcached.service</span><br><br><span class="hljs-comment">#m2的配置和m1相同</span><br></code></pre></td></tr></table></figure>

<h4 id="7-3-4-3-在t1和t2上准备tomcat"><a href="#7-3-4-3-在t1和t2上准备tomcat" class="headerlink" title="7.3.4.3 在t1和t2上准备tomcat"></a>7.3.4.3 在t1和t2上准备tomcat</h4><p>t1 的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 tomcat]<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat<br>[root@t1 tomcat]<span class="hljs-comment"># vim conf/server.xml</span><br>&lt;Engine name=<span class="hljs-string">&quot;Catalina&quot;</span> defaultHost=<span class="hljs-string">&quot;t1.rlin.org&quot;</span> jvmRoute=<span class="hljs-string">&quot;Tomcat1&quot;</span>&gt; <br>......<br>   &lt;Host name=<span class="hljs-string">&quot;t1.rlin.org&quot;</span> appBase=<span class="hljs-string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="hljs-string">&quot;true&quot;</span> &gt;<br>  &lt;/Host&gt; <br> &lt;/Engine&gt;<br>&lt;/Service&gt;<br>&lt;/Server&gt;<br><br>[root@t1 tomcat]<span class="hljs-comment"># vim conf/context.xml</span><br>.....<br>&lt;Context&gt;<br>......<br> &lt;Manager pathname=<span class="hljs-string">&quot;&quot;</span> /&gt;<br>  --&gt;<br><span class="hljs-comment">#在最后一行前加下面内容</span><br>&lt;Manager className=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br>memcachedNodes=<span class="hljs-string">&quot;n1:10.0.0.204:11211,n2:10.0.0.205:11211&quot;</span><br>failoverNodes=<span class="hljs-string">&quot;n1&quot;</span><br>requestUriIgnorePattern=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br>transcoderFactoryClass=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFact</span><br><span class="hljs-string">ory&quot;</span><br>/&gt;<br>&lt;/Context&gt; <span class="hljs-comment">#此行是最后一行</span><br><br><span class="hljs-comment">#将相关包传到lib/目录下</span><br>asm-5.2.jar<br>kryo-3.0.3.jar<br>kryo-serializers-0.45.jar<br>memcached-session-manager-2.3.2.jar<br>memcached-session-manager-tc8-2.3.2.jar<br>minlog-1.3.1.jar<br>msm-kryo-serializer-2.3.2.jar<br>objenesis-2.6.jar<br>reflectasm-1.11.9.jar<br>spymemcached-2.12.3.jar<br><br>[root@t1 tomcat]<span class="hljs-comment">#ls lib/ -t |tail</span><br>kryo-3.0.3.jar<br>asm-5.2.jar<br>objenesis-2.6.jar<br>reflectasm-1.11.9.jar<br>minlog-1.3.1.jar<br>kryo-serializers-0.45.jar<br>msm-kryo-serializer-2.3.2.jar<br>memcached-session-manager-tc8-2.3.2.jar<br>spymemcached-2.12.3.jar<br>memcached-session-manager-2.3.2.jar<br><br>[root@t1 tomcat]<span class="hljs-comment"># mkdir -p /data/webapps/ROOT</span><br>[root@t1 tomcat]<span class="hljs-comment"># cat /data/webapps/ROOT/index.jsp</span><br>&lt;%@ page import=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br> &lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="hljs-string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;<br>&lt;%=new Date()%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@t1 tomcat]<span class="hljs-comment"># chown -R tomcat.tomcat /data/webapps/</span><br>[root@t1 ~]<span class="hljs-comment"># systemctl restart tomcat #重启之前最好留意一下日志，查看重启之后是否能够开启stick</span><br></code></pre></td></tr></table></figure>

<p><strong>t2参考上面t1做类似的配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t2 tomcat]<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/tomcat<br>[root@t2 tomcat]<span class="hljs-comment"># vim conf/server.xml</span><br>&lt;Engine name=<span class="hljs-string">&quot;Catalina&quot;</span> defaultHost=<span class="hljs-string">&quot;t2.rlin.org&quot;</span> jvmRoute=<span class="hljs-string">&quot;Tomcat2&quot;</span>&gt; <br>......<br>   &lt;Host name=<span class="hljs-string">&quot;t2.rlin.org&quot;</span> appBase=<span class="hljs-string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="hljs-string">&quot;true&quot;</span> &gt;<br>  &lt;/Host&gt; <br> &lt;/Engine&gt;<br>&lt;/Service&gt;<br>&lt;/Server&gt;<br><br>[root@t2 tomcat]<span class="hljs-comment"># vim conf/context.xml</span><br>.....<br>&lt;Context&gt;<br>......<br> &lt;Manager pathname=<span class="hljs-string">&quot;&quot;</span> /&gt;<br>  --&gt;<br><span class="hljs-comment">#在最后一行前加下面内容</span><br>&lt;Manager className=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br>memcachedNodes=<span class="hljs-string">&quot;n1:10.0.0.204:11211,n2:10.0.0.205:11211&quot;</span><br>failoverNodes=<span class="hljs-string">&quot;n2&quot;</span> <span class="hljs-comment">#只修改此行,和t1不同,其它都一样</span><br>requestUriIgnorePattern=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br>transcoderFactoryClass=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFact</span><br><span class="hljs-string">ory&quot;</span><br>/&gt;<br>&lt;/Context&gt; <span class="hljs-comment">#此行是最后一行</span><br><br><span class="hljs-comment">#将相关包传到lib/目录下</span><br>asm-5.2.jar<br>kryo-3.0.3.jar<br>kryo-serializers-0.45.jar<br>memcached-session-manager-2.3.2.jar<br>memcached-session-manager-tc8-2.3.2.jar<br>minlog-1.3.1.jar<br>msm-kryo-serializer-2.3.2.jar<br>objenesis-2.6.jar<br>reflectasm-1.11.9.jar<br>spymemcached-2.12.3.jar<br><br>[root@t2 tomcat]<span class="hljs-comment"># mkdir -p /data/webapps/ROOT</span><br>[root@t2 tomcat]<span class="hljs-comment"># cat /data/webapps/ROOT/index.jsp</span><br>&lt;%@ page import=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br> &lt;title&gt;tomcat <span class="hljs-built_in">test</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="hljs-string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;<br>&lt;div&gt;SessionID = &lt;span style=<span class="hljs-string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;<br>&lt;%=new Date()%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br>[root@t2 tomcat]<span class="hljs-comment"># chown -R tomcat.tomcat /data/webapps/</span><br>[root@t2 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br></code></pre></td></tr></table></figure>

<p>查看日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># tail /usr/local/tomcat/logs/catalina.out</span><br>.......<br>14-Aug-2021 09:37:41.422 INFO [t2.rlin.org-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.startInternal --------<br>-  finished initialization:<br>- sticky: <span class="hljs-literal">true</span><br>- operation timeout: 1000<br>- node ids: [n1]<br>- failover node ids: [n2]<br>- storage key prefix: null<br>- locking mode: null (expiration: 5s)<br>--------<br>......<br></code></pre></td></tr></table></figure>

<h4 id="7-3-4-4-测试的python脚本"><a href="#7-3-4-4-测试的python脚本" class="headerlink" title="7.3.4.4 测试的python脚本"></a>7.3.4.4 测试的python脚本</h4><p>在proxy上安装部署python3环境,访问memcached</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># yum -y install python3 python3-memcached</span><br><br><span class="hljs-comment">#准备python测试脚本</span><br>[root@proxy ~]<span class="hljs-comment"># cat showmemcached.py</span><br><span class="hljs-comment">#!/usr/bin/python3</span><br>import memcache <span class="hljs-comment"># pip install python-memcached</span><br>mc = memcache.Client([<span class="hljs-string">&#x27;10.0.0.103:11211&#x27;</span>,<span class="hljs-string">&#x27;10.0.0.104:11211&#x27;</span>], debug=True)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * 30)<br><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> mc.get_stats(<span class="hljs-string">&#x27;cachedump 5 0&#x27;</span>):  <span class="hljs-comment"># stats cachedump 5 0 # 5和上面的items返回的值有关；0表示全部</span><br> <span class="hljs-built_in">print</span>(x)<br> <br>[root@proxy ~]<span class="hljs-comment"># chmod +x showmemcached.py</span><br><br><span class="hljs-comment">#运行python脚本</span><br>[root@proxy ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.204:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;D72B23D0232C26AD5EF45318145C5427-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628906931 s]&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.205:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;20EFF20054C6AC806EB40DC74027222B-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628906926 s]&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="7-3-4-5-浏览器访问测试"><a href="#7-3-4-5-浏览器访问测试" class="headerlink" title="7.3.4.5 浏览器访问测试"></a>7.3.4.5 浏览器访问测试</h4><p>第一次刷新浏览器可以看到以下显示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat133.png" srcset="/blog/img/loading.gif"></p>
<p>运行脚本,可以看到只有m2上有SessionID信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.204:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;D72B23D0232C26AD5EF45318145C5427-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628906931 s]&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.205:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;B11C717B87EC4E1044F28D24FEDC9D0F-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628907144 s]&#x27;</span>, <span class="hljs-string">&#x27;20EFF20054C6AC806EB40DC74027222B-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628906926 s]&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>

<p>第二次刷新页面,可以看到主机轮询,SessionID不变,但SessionID来自别一个tomcat</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat134.png" srcset="/blog/img/loading.gif"></p>
<p>多次刷新页面,可以看到主机轮询,SessionID不变,发现以下规律</p>
<p>当tomcat为t1,发现SessionID为n1.Tomcat2</p>
<p>当tomcat为t2,发现SessionID为n2.Tomcat1</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat135.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat136.png" srcset="/blog/img/loading.gif"></p>
<p>运行脚本,可以看到m1和m2上都有了SessionID信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.204:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;B11C717B87EC4E1044F28D24FEDC9D0F-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628907249 s]&#x27;</span>, <span class="hljs-string">&#x27;D72B23D0232C26AD5EF45318145C5427-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628906931 s]&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.205:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;B11C717B87EC4E1044F28D24FEDC9D0F-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628907143 s]&#x27;</span>, <span class="hljs-string">&#x27;20EFF20054C6AC806EB40DC74027222B-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628906926 s]&#x27;</span>&#125;)<br>[root@proxy ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h4 id="7-3-4-6-模拟故障"><a href="#7-3-4-6-模拟故障" class="headerlink" title="7.3.4.6 模拟故障"></a>7.3.4.6 模拟故障</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">[root@t2 ~]# systemctl stop tomcat<br></code></pre></td></tr></table></figure>

<p>多次刷新页面,SessionID不变</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">[root@m2 ~]# systemctl stop memcached.service<br></code></pre></td></tr></table></figure>

<p>多次刷新页面,SessionID不变</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat137.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat138.png" srcset="/blog/img/loading.gif"></p>
<p>运行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@proxy ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>MemCached: MemCache: inet:10.0.0.205:11211: connect: [Errno 111] Connection refused.  Marking dead.<br>(<span class="hljs-string">&#x27;10.0.0.204:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;B11C717B87EC4E1044F28D24FEDC9D0F-n1.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628907794 s]&#x27;</span>, <span class="hljs-string">&#x27;B11C717B87EC4E1044F28D24FEDC9D0F-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628907249 s]&#x27;</span>, <span class="hljs-string">&#x27;D72B23D0232C26AD5EF45318145C5427-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628906931 s]&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>

<h2 id="7-4-non-sticky-模式"><a href="#7-4-non-sticky-模式" class="headerlink" title="7.4 non-sticky 模式"></a>7.4 non-sticky 模式</h2><h3 id="7-4-1-non-sticky-模式工作原理"><a href="#7-4-1-non-sticky-模式工作原理" class="headerlink" title="7.4.1 non-sticky 模式工作原理"></a>7.4.1 non-sticky 模式工作原理</h3><p>non-sticky 模式即前端tomcat和后端memcached无关联(无粘性)关系</p>
<p>从msm 1.4.0之后版本开始支持non-sticky模式。</p>
<p>Tomcat session为中转Session，对每一个SessionID随机选中后端的memcached节点n1(或者n2)为主session，而另一个memcached节点n2(或者是n1)为备session。产生的新的Session会发送给主、备memcached，并清除本地Session。</p>
<p>后端两个memcached服务器对一个session来说是一个是主,一个是备,但对所有session信息来说每个memcached即是主同时也是备</p>
<p>如果n1下线，n2则转正。n1再次上线，n2依然是主Session存储节点。</p>
<h3 id="7-4-2-memcached配置"><a href="#7-4-2-memcached配置" class="headerlink" title="7.4.2 memcached配置"></a>7.4.2 memcached配置</h3><p>放到 $CATALINA_HOME/conf/context.xml 中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context</span>&gt;</span><br>...<br> <span class="hljs-tag">&lt;<span class="hljs-name">Manager</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">memcachedNodes</span>=<span class="hljs-string">&quot;n1:10.0.0.101:11211,n2:10.0.0.102:11211&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">sticky</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">sessionBackupAsync</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">lockingMode</span>=<span class="hljs-string">&quot;uriPattern:/path1|/path2&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">requestUriIgnorePattern</span>=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span><br><span class="hljs-tag"></span><br><span class="hljs-tag">  <span class="hljs-attr">transcoderFactoryClass</span>=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span><br><span class="hljs-tag">  /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="7-4-3-redis-配置"><a href="#7-4-3-redis-配置" class="headerlink" title="7.4.3 redis 配置"></a>7.4.3 redis 配置</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat139.png" srcset="/blog/img/loading.gif"></p>
<p>支持将session存放在Redis中,但当前对Redis的支持不允许连接到多个Redis节点,可以通过Redis的集群服务实现防止redis的单点失败</p>
<p>参考文档 :</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ran-jit/tomcat-cluster-redis-session-manager/wiki">https://github.com/ran-jit/tomcat-cluster-redis-session-manager/wiki</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#example-for-non-sticky-sessions--kryo--redis">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#example-for-non-sticky-sessions--kryo--redis</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat140.png" srcset="/blog/img/loading.gif"></p>
<p><strong>下载 jedis.jar</strong>，放到 $CATALINA_HOME/lib/ ，对应本次安装就是/usr/local/tomcat/lib。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># yum install redis</span><br><span class="hljs-comment"># vim /etc/redis.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br><br><span class="hljs-comment"># systemctl start redis</span><br></code></pre></td></tr></table></figure>

<p>放到 $CATALINA_HOME/conf/context.xml 中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context</span>&gt;</span><br>...<br> <span class="hljs-tag">&lt;<span class="hljs-name">Manager</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">memcachedNodes</span>=<span class="hljs-string">&quot;redis://:password@redis.example.com:portnumber&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">sticky</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">sessionBackupAsync</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">lockingMode</span>=<span class="hljs-string">&quot;uriPattern:/path1|/path2&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">requestUriIgnorePattern</span>=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span><br><span class="hljs-tag"> </span><br><span class="hljs-tag">  <span class="hljs-attr">transcoderFactoryClass</span>=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span><br><span class="hljs-tag">  /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>浏览器访问，使用redis相关工具可以观察到redis中的信息</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat141.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-4-4-实战案例-memcached-实现non-sticky模式"><a href="#7-4-4-实战案例-memcached-实现non-sticky模式" class="headerlink" title="7.4.4 实战案例: memcached 实现non-sticky模式"></a>7.4.4 实战案例: memcached 实现non-sticky模式</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat142.png" srcset="/blog/img/loading.gif"></p>
<p>环境准备：</p>
<ul>
<li>时间同步，确保NTP或Chrony服务正常运行。</li>
<li>防火墙规则</li>
<li>禁用SELinux</li>
<li>三台主机</li>
</ul>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>服务</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.201</td>
<td>proxy.rlin.org</td>
<td>调度器</td>
<td>Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.202</td>
<td>t1.rlin.org</td>
<td>tomcat1</td>
<td>JDK8、Tomcat8,memcached</td>
</tr>
<tr>
<td>10.0.0.203</td>
<td>t2.rlin.org</td>
<td>tomcat2</td>
<td>JDK8、Tomcat8,memcached</td>
</tr>
</tbody></table>
<h4 id="7-4-4-1-修改tomcat配置"><a href="#7-4-4-1-修改tomcat配置" class="headerlink" title="7.4.4.1 修改tomcat配置"></a>7.4.4.1 修改tomcat配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在前面实验基础上修改,memcached配置不变,只需要修改tomcat配置</span><br>[root@t1 tomcat]<span class="hljs-comment"># vim conf/context.xml</span><br>&lt;Context&gt;<br>...<br>&lt;Manager className=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br>memcachedNodes=<span class="hljs-string">&quot;n1:10.0.0.202:11211,n2:10.0.0.203:11211&quot;</span><br>sticky=<span class="hljs-string">&quot;false&quot;</span>        <span class="hljs-comment">#下面三行和sticky模式不同</span><br>sessionBackupAsync=<span class="hljs-string">&quot;false&quot;</span><br>lockingMode=<span class="hljs-string">&quot;uriPattern:/path1|/path2&quot;</span><br>requestUriIgnorePattern=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br>transcoderFactoryClass=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFact</span><br><span class="hljs-string">ory&quot;</span><br>/&gt;<br>&lt;/Context&gt;<br><br>[root@t1 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br><br><span class="hljs-comment">#查看日志</span><br>[root@t1 ~]<span class="hljs-comment"># tail -f /usr/local/tomcat/logs/catalina.out</span><br>......<br>14-Aug-2021 10:22:17.142 INFO [t1.rlin.org-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.startInternal --------<br>-  finished initialization:<br>- sticky: <span class="hljs-literal">false</span><br>- operation timeout: 1000<br>- node ids: [n1, n2]<br>- failover node ids: []<br>- storage key prefix: null<br>- locking mode: uriPattern:/path1|/path2 (expiration: 5s)<br>--------<br>......<br><br><span class="hljs-comment">#t2和t1相同操作</span><br>[root@t2 tomcat]<span class="hljs-comment"># vim conf/context.xml</span><br>&lt;Context&gt;<br>...<br>&lt;Manager className=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br>memcachedNodes=<span class="hljs-string">&quot;n1:10.0.0.202:11211,n2:10.0.0.203:11211&quot;</span><br>sticky=<span class="hljs-string">&quot;false&quot;</span>        <span class="hljs-comment">#下面三行和sticky模式不同</span><br>sessionBackupAsync=<span class="hljs-string">&quot;false&quot;</span><br>lockingMode=<span class="hljs-string">&quot;uriPattern:/path1|/path2&quot;</span><br>requestUriIgnorePattern=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br>transcoderFactoryClass=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFact</span><br><span class="hljs-string">ory&quot;</span><br>/&gt;<br>&lt;/Context&gt;<br>[root@t2 tomcat]<span class="hljs-comment"># systemctl restart tomcat</span><br><br><span class="hljs-comment">#运行脚本查看key</span><br>[root@t1 ~]<span class="hljs-comment"># cat ./showmemcached.py</span><br><span class="hljs-comment">#!/usr/bin/python3</span><br>import memcache <span class="hljs-comment"># pip install python-memcached</span><br>mc = memcache.Client([<span class="hljs-string">&#x27;10.0.0.202:11211&#x27;</span>,<span class="hljs-string">&#x27;10.0.0.203:11211&#x27;</span>], debug=True)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * 30)<br><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> mc.get_stats(<span class="hljs-string">&#x27;cachedump 5 0&#x27;</span>):  <span class="hljs-comment"># stats cachedump 5 0 # 5和上面的items返回的值有关；0表示全部</span><br> <span class="hljs-built_in">print</span>(x)<br> <br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;&#125;)<br>[root@t1 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h4 id="7-4-4-2-通过浏览器访问"><a href="#7-4-4-2-通过浏览器访问" class="headerlink" title="7.4.4.2 通过浏览器访问"></a>7.4.4.2 通过浏览器访问</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat143.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#再次运行脚本后可以看到,t2为memcached的主节点,t1为备份节点</span><br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;19A823B03441C1AB9367289C729F1988-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628913105 s]&#x27;</span>&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;bak:19A823B03441C1AB9367289C729F1988-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628913109 s]&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="7-4-4-3-模拟故障"><a href="#7-4-4-3-模拟故障" class="headerlink" title="7.4.4.3 模拟故障"></a>7.4.4.3 模拟故障</h4><p><strong>模拟t1的memcached 故障</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># systemctl stop memcached.service</span><br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>MemCached: MemCache: inet:10.0.0.202:11211: connect: [Errno 111] Connection refused.  Marking dead.<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;5E5E2174D9548761778FFB6E64EAE67F-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911682 s]&#x27;</span>, <span class="hljs-string">&#x27;bak:3F6C29AA05DF3A0C0E00A6B89C3F1905-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911630 s]&#x27;</span>, <span class="hljs-string">&#x27;bak:B668EE1FF62B090AA0F5B3E782EF5891-n1.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911625 s]&#x27;</span>, <span class="hljs-string">&#x27;B707CD7820FA09966DE65169D04EEDBD-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911610 s]&#x27;</span>&#125;)<br><br>[root@t1 ~]<span class="hljs-comment"># systemctl start memcached.service</span><br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;5E5E2174D9548761778FFB6E64EAE67F-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911682 s]&#x27;</span>, <span class="hljs-string">&#x27;bak:3F6C29AA05DF3A0C0E00A6B89C3F1905-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911630 s]&#x27;</span>, <span class="hljs-string">&#x27;bak:B668EE1FF62B090AA0F5B3E782EF5891-n1.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911625 s]&#x27;</span>, <span class="hljs-string">&#x27;B707CD7820FA09966DE65169D04EEDBD-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911610 s]&#x27;</span>&#125;)<br><br><span class="hljs-comment">#刷新几次页面后,再运行脚本</span><br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;<span class="hljs-string">&#x27;7A7467CF465DA79266D4DB7227B07A04-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628912735 s]&#x27;</span>, <span class="hljs-string">&#x27;AEB8B2E529BE29F6C8A62E92CAABA2DB-n2.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628912719 s]&#x27;</span>, <span class="hljs-string">&#x27;F4928B7998EA8502F2103259A6AA259F-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628912719 s]&#x27;</span>, <span class="hljs-string">&#x27;FD71021F4A2BF25D3DD6F45022542C56-n2.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628912718 s]&#x27;</span>, <span class="hljs-string">&#x27;5E5E2174D9548761778FFB6E64EAE67F-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911682 s]&#x27;</span>, <span class="hljs-string">&#x27;bak:3F6C29AA05DF3A0C0E00A6B89C3F1905-n1.Tomcat2&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911630 s]&#x27;</span>, <span class="hljs-string">&#x27;bak:B668EE1FF62B090AA0F5B3E782EF5891-n1.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911625 s]&#x27;</span>, <span class="hljs-string">&#x27;B707CD7820FA09966DE65169D04EEDBD-n2.Tomcat1&#x27;</span>: <span class="hljs-string">&#x27;[97 b; 1628911610 s]&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>

<p><strong>模拟t2的memcached 故障</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t2 ~]<span class="hljs-comment"># systemctl stop memcached.service</span><br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>MemCached: MemCache: inet:10.0.0.203:11211: connect: [Errno 111] Connection refused.  Marking dead.<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;&#125;)<br></code></pre></td></tr></table></figure>

<p>再刷新页面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat144.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#运行脚本看到在t1上生成相同的SessionID,并成为memcached新主</span><br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>MemCached: MemCache: inet:10.0.0.203:11211: connect: [Errno 111] Connection refused.  Marking dead.<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;&#125;)<br><br>[root@t2 ~]<span class="hljs-comment"># systemctl start memcached.service</span><br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;&#125;)<br><br><span class="hljs-comment">#再刷新页,运行脚本看到t2成为备用节点</span><br>[root@t1 ~]<span class="hljs-comment"># ./showmemcached.py</span><br>------------------------------<br>(<span class="hljs-string">&#x27;10.0.0.202:11211 (1)&#x27;</span>, &#123;&#125;)<br>(<span class="hljs-string">&#x27;10.0.0.203:11211 (1)&#x27;</span>, &#123;&#125;)<br></code></pre></td></tr></table></figure>

<p>模拟t1的tomcat故障,刷新页面,可以看到SessionID不变</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># systemctl stop tomcat</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat145.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-4-5-实战案例-redis-实现-non-sticky-模式的msm"><a href="#7-4-5-实战案例-redis-实现-non-sticky-模式的msm" class="headerlink" title="7.4.5 实战案例: redis 实现 non-sticky 模式的msm"></a>7.4.5 实战案例: redis 实现 non-sticky 模式的msm</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat146.png" srcset="/blog/img/loading.gif"></p>
<p>环境准备：</p>
<ul>
<li>时间同步，确保NTP或Chrony服务正常运行。</li>
<li>防火墙规则</li>
<li>禁用SELinux</li>
<li>四台主机</li>
</ul>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>服务</th>
<th>软件包</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.201</td>
<td>proxy.rlin.org</td>
<td>调度器</td>
<td>Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.202</td>
<td>t1.rlin.org</td>
<td>tomcat1</td>
<td>JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.203</td>
<td>t2.rlin.org</td>
<td>tomcat2</td>
<td>JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.204</td>
<td>redis.rlin.org</td>
<td>redis</td>
<td>Redis</td>
</tr>
</tbody></table>
<h4 id="7-4-5-1-上传redis库到tomcat服务器"><a href="#7-4-5-1-上传redis库到tomcat服务器" class="headerlink" title="7.4.5.1 上传redis库到tomcat服务器"></a>7.4.5.1 上传redis库到tomcat服务器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># ll /usr/local/tomcat/lib/jedis-3.0.0.jar</span><br>-rw-r--r-- 1 root root 586620 Jun 26  2019 /usr/<span class="hljs-built_in">local</span>/tomcat/lib/jedis-3.0.0.jar<br>[root@t2 ~]<span class="hljs-comment"># ll /usr/local/tomcat/lib/jedis-3.0.0.jar</span><br>-rw-r--r-- 1 root root 586620 Jun 26  2019 /usr/<span class="hljs-built_in">local</span>/tomcat/lib/jedis-3.0.0.jar<br></code></pre></td></tr></table></figure>

<h4 id="7-4-5-2-安装并配置-Redis-服务"><a href="#7-4-5-2-安装并配置-Redis-服务" class="headerlink" title="7.4.5.2 安装并配置 Redis 服务"></a>7.4.5.2 安装并配置 Redis 服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis ~]<span class="hljs-comment"># yum -y install redis</span><br>[root@redis ~]<span class="hljs-comment"># sed -i.bak &#x27;s/^bind.*/bind 0.0.0.0/&#x27; /etc/redis.conf</span><br>[root@redis ~]<span class="hljs-comment"># systemctl enable --now redis</span><br>[root@redis ~]<span class="hljs-comment"># ss -ntl</span><br>State           Recv-Q          Send-Q                    Local Address:Port                     Peer Address:Port          <br>LISTEN          0               128                             0.0.0.0:6379                          0.0.0.0:*             <br>LISTEN          0               128                             0.0.0.0:111                           0.0.0.0:*             <br>LISTEN          0               32                        192.168.122.1:53                            0.0.0.0:*             <br>LISTEN          0               128                             0.0.0.0:22                            0.0.0.0:*             <br>LISTEN          0               5                             127.0.0.1:631                           0.0.0.0:*             <br>LISTEN          0               128                                [::]:111                              [::]:*             <br>LISTEN          0               128                                [::]:22                               [::]:*             <br>LISTEN          0               5                                 [::1]:631                              [::]:*<br></code></pre></td></tr></table></figure>

<h4 id="7-4-5-3-修改tomcat-配置指定redis服务器地址"><a href="#7-4-5-3-修改tomcat-配置指定redis服务器地址" class="headerlink" title="7.4.5.3 修改tomcat 配置指定redis服务器地址"></a>7.4.5.3 修改tomcat 配置指定redis服务器地址</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># vim /usr/local/tomcat/conf/context.xml</span><br>&lt;Context&gt;<br>...<br>&lt;Manager className=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br>memcachedNodes=<span class="hljs-string">&quot;redis://10.0.0.204:6379&quot;</span>   <span class="hljs-comment">#和non-sticky的memcached相比,只修改此行</span><br>sticky=<span class="hljs-string">&quot;false&quot;</span><br>sessionBackupAsync=<span class="hljs-string">&quot;false&quot;</span><br>lockingMode=<span class="hljs-string">&quot;uriPattern:/path1|/path2&quot;</span><br>requestUriIgnorePattern=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br>transcoderFactoryClass=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFact</span><br><span class="hljs-string">ory&quot;</span><br>/&gt;<br>&lt;/Context&gt;<br>[root@t1 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br><br><span class="hljs-comment">#查看日志</span><br>[root@t1 ~]<span class="hljs-comment"># tail -f /usr/local/tomcat/logs/catalina.out</span><br>......<br>14-Aug-2021 11:21:16.486 INFO [t1.rlin.org-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.startInternal --------<br>-  finished initialization:<br>- sticky: <span class="hljs-literal">false</span><br>- operation timeout: 1000<br>- node ids: []<br>- failover node ids: []<br>- storage key prefix: null<br>- locking mode: uriPattern:/path1|/path2 (expiration: 5s)<br>--------<br>.......<br><br><span class="hljs-comment">#t2和t1配置相同</span><br>[root@t2 ~]<span class="hljs-comment"># vim /usr/local/tomcat/conf/context.xml</span><br>......<br>&lt;Manager className=<span class="hljs-string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br>memcachedNodes=<span class="hljs-string">&quot;redis://10.0.0.204:6379&quot;</span>   <span class="hljs-comment">#和non-sticky的memcached相比,只修改此行</span><br>sticky=<span class="hljs-string">&quot;false&quot;</span><br>sessionBackupAsync=<span class="hljs-string">&quot;false&quot;</span><br>lockingMode=<span class="hljs-string">&quot;uriPattern:/path1|/path2&quot;</span><br>requestUriIgnorePattern=<span class="hljs-string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br>transcoderFactoryClass=<span class="hljs-string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFact</span><br><span class="hljs-string">ory&quot;</span><br>/&gt;<br>&lt;/Context&gt;<br>[root@t2 ~]<span class="hljs-comment"># systemctl restart tomcat</span><br></code></pre></td></tr></table></figure>

<h4 id="7-4-5-4-测试访问"><a href="#7-4-5-4-测试访问" class="headerlink" title="7.4.5.4 测试访问"></a>7.4.5.4 测试访问</h4><p>浏览器刷新访问多次,主机轮询,但SessionID不变</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat147.png" srcset="/blog/img/loading.gif"></p>
<p>使用redis工具连接redis 查看SessionID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@redis ~]<span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; KEYS *<br>1) <span class="hljs-string">&quot;validity:2FA388265E9E3F65ACFDB7E1920F0D6A.Tomcat2&quot;</span><br>2) <span class="hljs-string">&quot;2FA388265E9E3F65ACFDB7E1920F0D6A.Tomcat2&quot;</span><br>127.0.0.1:6379&gt; GET 2FA388265E9E3F65ACFDB7E1920F0D6A.Tomcat2<br><span class="hljs-string">&quot;\x00\x02\x00\\\x00\x00\x01&#123;B\xaf\xda!\x00\x00\x01&#123;B\xaf\xda!\x00\x00\a\b11\x00\x00\x01&#123;B\xaf\xda#\x00\x00\x01&#123;B\xaf\xdak\x00(2FA388265E9E3F65ACFDB7E1920F0D6A.Tomcat2\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00&quot;</span><br>127.0.0.1:6379&gt;<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat148.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat149.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat150.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-4-5-5-模拟故障"><a href="#7-4-5-5-模拟故障" class="headerlink" title="7.4.5.5 模拟故障"></a>7.4.5.5 模拟故障</h4><h5 id="7-4-5-5-1-模拟tomcat故障-查看是否SessionID变化"><a href="#7-4-5-5-1-模拟tomcat故障-查看是否SessionID变化" class="headerlink" title="7.4.5.5.1 模拟tomcat故障,查看是否SessionID变化"></a>7.4.5.5.1 模拟tomcat故障,查看是否SessionID变化</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t2 ~]<span class="hljs-comment"># systemctl stop tomcat</span><br></code></pre></td></tr></table></figure>

<p>刷新页面,可以看到SessinID不变</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat151.png" srcset="/blog/img/loading.gif"></p>
<h5 id="7-4-5-5-2-模拟Redis-故障"><a href="#7-4-5-5-2-模拟Redis-故障" class="headerlink" title="7.4.5.5.2 模拟Redis 故障"></a>7.4.5.5.2 模拟Redis 故障</h5><p>模拟Redis 故障,再刷新页面,可以看到SessionID不断变化,说明redis存在单点故障</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># systemctl start tomcat</span><br>[root@redis ~]<span class="hljs-comment"># systemctl stop redis</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat152.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat153.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-5-Session-问题方案总结"><a href="#7-5-Session-问题方案总结" class="headerlink" title="7.5 Session 问题方案总结"></a>7.5 Session 问题方案总结</h2><p>通过多组实验，使用不同技术实现了session持久机制</p>
<ol>
<li>session绑定，基于IP或session cookie的。其部署简单，尤其基于session黏性的方式，粒度小，对负载均衡影响小。但一旦后端服务器有故障，其上的session丢失。</li>
<li>session复制集群，基于tomcat实现多个服务器内共享同步所有session。此方法可以保证任意一台后端服务器故障，其余各服务器上还都存有全部session，对业务无影响。但是它基于多播实现心跳，TCP单播实现复制，当设备节点过多，这种复制机制不是很好的解决方案。且并发连接多的时候，单机上的所有session占据的内存空间非常巨大，甚至耗尽内存。</li>
<li>session服务器，将所有的session存储到一个共享的内存空间中，使用多个冗余节点保存session，这样做到session存储服务器的高可用，且占据业务服务器内存较小。是一种比较好的解决session持久的解决方案。</li>
</ol>
<p>以上的方法都有其适用性。生产环境中，应根据实际需要合理选择。</p>
<p>不过以上这些方法都是在内存中实现了session的保持，可以使用数据库或者文件系统，把session数据存储起来，持久化。这样服务器重启后，也可以重新恢复session数据。不过session数据是有时效性的，是否需要这样做，视情况而定。</p>
<h1 id="八、Tomcat-性能优化"><a href="#八、Tomcat-性能优化" class="headerlink" title="八、Tomcat 性能优化"></a>八、Tomcat 性能优化</h1><p>在目前流行的互联网架构中，Tomcat在目前的网络编程中是举足轻重的，由于Tomcat的运行依赖于JVM，从虚拟机的角度把Tomcat的调整分为外部环境调优 JVM 和 Tomcat 自身调优两部分</p>
<h2 id="8-1-JVM组成"><a href="#8-1-JVM组成" class="headerlink" title="8.1 JVM组成"></a>8.1 JVM组成</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_241&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_241-b07)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.241-b07, mixed mode)<br></code></pre></td></tr></table></figure>

<h3 id="8-1-1-JVM组成"><a href="#8-1-1-JVM组成" class="headerlink" title="8.1.1 JVM组成"></a>8.1.1 JVM组成</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat154.png" srcset="/blog/img/loading.gif"></p>
<p><strong>JVM 组成部分</strong></p>
<ul>
<li>类加载子系统: 使用Java语言编写.java Source Code文件，通过javac编译成.class Byte Code文件。class loader类加载器将所需所有类加载到内存，必要时将类实例化成实例</li>
<li>运行时数据区: 最消耗内存的空间,需要优化</li>
<li>执行引擎: 包括JIT (JustInTimeCompiler)即时编译器, GC垃圾回收器</li>
<li>本地方法接口: 将本地方法栈通过JNI(Java Native Interface)调用Native Method Libraries, 比如:C,C++库等,扩展Java功能,融合不同的编程语言为Java所用</li>
</ul>
<p><strong>JVM运行时数据区域由下面部分构成：</strong></p>
<ul>
<li>Method Area 方法区(线程共享)：所有线程共享的内存空间，存放已加载的类信息(构造方法,接口定义),常量(final),静态变量(static), 运行时常量池等。但实例变量存放在堆内存中. 从JDK8开始此空间由永久代改名为元空间</li>
<li>heap 堆(线程共享)：虚拟机启动时创建,存放创建的所有对象信息。如果对象无法申请到可用内存将抛出OOM异常.堆是靠GC垃圾回收器管理的,通过-Xmx -Xms 指定最大堆和最小堆空间大小</li>
<li>Java stack Java栈(线程私有)：每个线程会分配一个栈，存放java中8大基本数据类型,对象引用,实例的本地变量,方法参数和返回值等,基于FILO()（First In Last Out）,每个方法为一个栈帧</li>
<li>Program Counter Register PC寄存器(线程私有)：就是一个指针,指向方法区中的方法字节码,每一个线程用于记录当前线程正在执行的字节码指令地址。由执行引擎读取下一条指令.因为线程需要切换，当一个线程被切换回来需要执行的时候，知道执行到哪里了</li>
<li>Native Method stack 本地方法栈(线程私有)：为本地方法执行构建的内存空间，存放本地方法执行时的局部变量、操作数等。</li>
</ul>
<p>所谓本地方法，使用native 关健字修饰的方法,比如:Thread.sleep方法. 简单的说是非Java实现的方法，例如操作系统的C编写的库提供的本地方法，Java调用这些本地方法接口执行。但是要注意，本地方法应该避免直接编程使用，因为Java可能跨平台使用，如果用了Windows API，换到了Linux平台部署就有了问题</p>
<h3 id="8-1-2-虚拟机"><a href="#8-1-2-虚拟机" class="headerlink" title="8.1.2 虚拟机"></a>8.1.2 虚拟机</h3><p>目前Oracle官方使用的是HotSpot， 它最早由一家名为”Longview Technologies”公司设计，使用了很多优秀的设计理念和出色的性能，1997年该公司被SUN公司收购。后来随着JDK一起发布了HotSpot VM。目前HotSpot是最主要的VM。</p>
<p>安卓程序需要运行在JVM上，而安卓平台使用了Google自研的Java虚拟机——Dalvid，适合于内存、处理器能力有限系统。</p>
<h2 id="8-2-GC-Garbage-Collection-垃圾收集器"><a href="#8-2-GC-Garbage-Collection-垃圾收集器" class="headerlink" title="8.2 GC (Garbage Collection) 垃圾收集器"></a>8.2 GC (Garbage Collection) 垃圾收集器</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat155.png" srcset="/blog/img/loading.gif"></p>
<p>在堆内存中如果创建的对象不再使用,仍占用着内存,此时即为垃圾.需要即使进行垃圾回收,从而释放内存空间给其它对象使用</p>
<p>其实不同的开发语言都有垃圾回收问题,C,C++需要程序员人为回收,造成开发难度大,容易出错等问题,但执行效率高,而JAVA和Python中不需要程序员进行人为的回收垃圾,而由JVM或相关程序自动回收垃圾,减轻程序员的开发难度,但可能会造成执行效率低下</p>
<p>堆内存里面经常创建、销毁对象，内存也是被使用、被释放。如果不妥善处理，一个使用频繁的进程，可能会出现虽然有足够的内存容量，但是无法分配出可用内存空间，因为没有连续成片的内存了，内存全是碎片化的空间。</p>
<p>所以需要有合适的垃圾回收机制,确保正常释放不再使用的内存空间,还需要保证内存空间尽可能的保持一定的连续</p>
<p>对于垃圾回收,需要解决三个问题</p>
<ul>
<li>哪些是垃圾要回收</li>
<li>怎么回收垃圾</li>
<li>什么时候回收垃圾</li>
</ul>
<h3 id="8-2-1-Garbage-垃圾确定方法"><a href="#8-2-1-Garbage-垃圾确定方法" class="headerlink" title="8.2.1 Garbage 垃圾确定方法"></a>8.2.1 Garbage 垃圾确定方法</h3><ul>
<li>引用计数: 每一个堆内对象上都与一个私有引用计数器，记录着被引用的次数，引用计数清零，该对象所占用堆内存就可以被回收。循环引用的对象都无法将引用计数归零，就无法清除。Python中即使用此种方式</li>
<li>根搜索(可达)算法 Root Searching</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat156.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-2-2-垃圾回收基本算法"><a href="#8-2-2-垃圾回收基本算法" class="headerlink" title="8.2.2 垃圾回收基本算法"></a>8.2.2 垃圾回收基本算法</h3><h4 id="8-2-2-1-标记-清除-Mark-Sweep"><a href="#8-2-2-1-标记-清除-Mark-Sweep" class="headerlink" title="8.2.2.1 标记-清除 Mark-Sweep"></a>8.2.2.1 标记-清除 Mark-Sweep</h4><p>分垃圾标记阶段和内存释放阶段。标记阶段，找到所有可访问对象打个标记。清理阶段，遍历整个堆，对未标记对象(即不再使用的对象)清理。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat157.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat158.png" srcset="/blog/img/loading.gif"></p>
<p>标记-清除最大的问题会造成内存碎片,但是效率很高,不浪费空间</p>
<h4 id="8-2-2-2-标记-压缩-压实-Mark-Compact"><a href="#8-2-2-2-标记-压缩-压实-Mark-Compact" class="headerlink" title="8.2.2.2 标记-压缩 (压实)Mark-Compact"></a>8.2.2.2 标记-压缩 (压实)Mark-Compact</h4><p>分垃圾标记阶段和内存整理阶段。标记阶段，找到所有可访问对象打个标记。内存清理阶段时，整理时将对象向内存一端移动，整理后存活对象连续的集中在内存一端</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat159.png" srcset="/blog/img/loading.gif"></p>
<p>标记-压缩算法好处是整理后内存空间连续分配，有大段的连续内存可分配，没有内存碎片。</p>
<p>缺点是内存整理过程有消耗,效率相对低下</p>
<h4 id="8-2-2-3-复制-Copying"><a href="#8-2-2-3-复制-Copying" class="headerlink" title="8.2.2.3 复制 Copying"></a>8.2.2.3 复制 Copying</h4><p>先将可用内存分为大小相同两块区域A和B，每次只用其中一块，比如A。当A用完后，则将A中存活的对象复制到B。复制到B的时候连续的使用内存，最后将A一次性清除干净。</p>
<p>缺点是比较浪费内存，只能使用原来一半内存，因为内存对半划分了，复制过程毕竟也是有代价。</p>
<p>好处是没有碎片，复制过程中保证对象使用连续空间</p>
<h4 id="8-2-2-4-多种算法总结"><a href="#8-2-2-4-多种算法总结" class="headerlink" title="8.2.2.4 多种算法总结"></a>8.2.2.4 多种算法总结</h4><p>没有最好的算法,在不同场景选择最合适的算法</p>
<ul>
<li>效率: 复制算法&gt;标记清除算法&gt; 标记压缩算法</li>
<li>内存整齐度: 复制算法=标记压缩算法&gt; 标记清除算法</li>
<li>内存利用率: 标记压缩算法=标记清除算法&gt;复制算法</li>
</ul>
<p><strong>STW</strong></p>
<p>对于大多数垃圾回收算法而言，GC线程工作时，停止所有工作的线程，称为Stop The World。GC 完成时，恢复其他工作线程运行。这也是JVM运行中最头疼的问题。</p>
<h3 id="8-2-3-分代堆内存GC策略"><a href="#8-2-3-分代堆内存GC策略" class="headerlink" title="8.2.3 分代堆内存GC策略"></a>8.2.3 分代堆内存GC策略</h3><p>上述垃圾回收算法都有优缺点，能不能对不同数据进行区分管理，不同分区对数据实施不同回收策略，分而治之。</p>
<h4 id="8-2-3-1-堆内存分代"><a href="#8-2-3-1-堆内存分代" class="headerlink" title="8.2.3.1 堆内存分代"></a>8.2.3.1 堆内存分代</h4><p><strong>将heap内存空间分为三个不同类别: 年轻代、老年代、持久代</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat160.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat161.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat162.png" srcset="/blog/img/loading.gif"></p>
<p><strong>Heap堆内存分为</strong></p>
<ul>
<li>年轻代Young：Young Generation<ul>
<li>伊甸园区eden: 只有一个,刚刚创建的对象</li>
<li>幸存(存活)区Servivor Space：有2个幸存区，一个是from区，一个是to区。大小相等、地位相同、可互换。<ul>
<li>from 指的是本次复制数据的源区</li>
<li>to 指的是本次复制数据的目标区</li>
</ul>
</li>
</ul>
</li>
<li>老年代Tenured：Old Generation, 长时间存活的对象</li>
</ul>
<p><strong>默认空间大小比例:</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat163.png" srcset="/blog/img/loading.gif"></p>
<p><strong>永久代</strong>：JDK1.7之前使用, 即Method Area方法区,保存JVM自身的类和方法,存储JAVA运行时的环境信息,JDK1.8后 改名为 MetaSpace,此空间不存在垃圾回收,关闭JVM会释放此区域内存,此空间物理上不属于heap内存,但逻辑上存在于heap内存</p>
<ul>
<li>永久代必须指定大小限制,字符串常量JDK1.7存放在永久代,1.8后存放在heap中</li>
<li>MetaSpace 可以设置,也可不设置,无上限</li>
</ul>
<p><strong>规律: 一般情况99%的对象都是临时对象</strong></p>
<p>范例: 在tomcat 状态页可以看到以下的内存分代</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat164.png" srcset="/blog/img/loading.gif"></p>
<p><strong>范例: 查看JVM内存分配情况</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># cat Heap.java #该文件在实验文件里</span><br>public class Heap &#123;<br> public static void main(String[] args)&#123;<br>   //返回JVM试图使用的最大内存,字节单位<br>   long max = Runtime.getRuntime().maxMemory();<br>   //返回JVM初始化总内存<br>   long total = Runtime.getRuntime().totalMemory();<br>   System.out.println(<span class="hljs-string">&quot;max=&quot;</span>+max+<span class="hljs-string">&quot;字节\t&quot;</span>+(max/(double)1024/1024)+<span class="hljs-string">&quot;MB&quot;</span>);<br>   System.out.println(<span class="hljs-string">&quot;total=&quot;</span>+total+<span class="hljs-string">&quot;字节\t&quot;</span>+ (total/(double)1024/1024)+<span class="hljs-string">&quot;MB&quot;</span>);<br> &#125;<br>&#125;<br>[root@t1 ~]<span class="hljs-comment"># vim /etc/profile.d/jdk.sh</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>//jdk<br><span class="hljs-built_in">export</span> JRE_HOME=<span class="hljs-variable">$JAVA_HOME</span>/jre<br><span class="hljs-built_in">export</span> CLASSPATH=<span class="hljs-variable">$JAVA_HOME</span>/lib/:<span class="hljs-variable">$JRE_HOME</span>/lib/:.<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin<br>[root@t1 ~]<span class="hljs-comment"># . /etc/profile.d/jdk.sh</span><br>[root@t1 ~]<span class="hljs-comment"># javac Heap.java</span><br>[root@t1 ~]<span class="hljs-comment"># java Heap</span><br>max=239271936字节	228.1875MB<br>total=16252928字节	15.5MB<br><br>[root@centos8 ~]<span class="hljs-comment"># java -classpath . Heap</span><br>max=239271936字节	228.1875MB<br>total=16252928字节	15.5MB<br><br>[root@centos8 ~]<span class="hljs-comment"># java -XX:+PrintGCDetails Heap</span><br>max=239271936字节	228.1875MB<br>total=16252928字节	15.5MB<br>Heap<br> def new generation   total 4928K, used 530K [0x00000000f1400000, 0x00000000f1950000, 0x00000000f62a0000)<br>  eden space 4416K,  12% used [0x00000000f1400000, 0x00000000f1484ae0, 0x00000000f1850000)<br>  from space 512K,   0% used [0x00000000f1850000, 0x00000000f1850000, 0x00000000f18d0000)<br>  to   space 512K,   0% used [0x00000000f18d0000, 0x00000000f18d0000, 0x00000000f1950000)<br> tenured generation   total 10944K, used 0K [0x00000000f62a0000, 0x00000000f6d50000, 0x0000000100000000)<br>   the space 10944K,   0% used [0x00000000f62a0000, 0x00000000f62a0000, 0x00000000f62a0200, 0x00000000f6d50000)<br> Metaspace       used 2522K, capacity 4486K, committed 4864K, reserved 1056768K<br>  class space    used 269K, capacity 386K, committed 512K, reserved 1048576K<br><br>[root@centos8 ~]<span class="hljs-comment"># echo &quot;scale=2;(4928+10944)/1024&quot; |bc</span><br>15.50<br><span class="hljs-comment">#说明年轻代+老年代占用了所有heap空间, Metaspace实际不占heap空间,逻辑上存在于Heap</span><br><span class="hljs-comment">#默认JVM试图分配最大内存的总内存的1/4,初始化默认总内存为总内存的1/64</span><br></code></pre></td></tr></table></figure>

<h4 id="8-2-3-2-年轻代回收-Minor-GC"><a href="#8-2-3-2-年轻代回收-Minor-GC" class="headerlink" title="8.2.3.2 年轻代回收 Minor GC"></a>8.2.3.2 年轻代回收 Minor GC</h4><ol>
<li><p>起始时，所有新建对象(特大对象直接进入老年代)都出生在eden，当eden满了，启动GC。这个称为Young GC 或者 Minor GC。</p>
</li>
<li><p>先标记eden存活对象，然后将存活对象复制到s0（假设本次是s0，也可以是s1，它们可以调换），eden剩余所有空间都清空。GC完成。</p>
</li>
<li><p>继续新建对象，当eden满了，启动GC。</p>
</li>
<li><p>先标记eden和s0中存活对象，然后将存活对象复制到s1。将eden和s0清空,此次GC完成</p>
</li>
<li><p>继续新建对象，当eden满了，启动GC。</p>
</li>
<li><p>先标记eden和s1中存活对象，然后将存活对象复制到s0。将eden和s1清空,此次GC完成</p>
</li>
</ol>
<p>以后就重复上面的步骤。通常场景下,大多数对象都不会存活很久，而且创建活动非常多，新生代就需要频繁垃圾回收。</p>
<p>但是，如果一个对象一直存活，它最后就在from、to来回复制，如果from区中对象复制次数达到阈值(默认15次,CMS为6次,可通过java的选项 -XX:MaxTenuringThreshold=N 指定)，就直接复制到老年代。</p>
<h4 id="8-2-3-3-老年代回收-Major-GC"><a href="#8-2-3-3-老年代回收-Major-GC" class="headerlink" title="8.2.3.3 老年代回收 Major GC"></a>8.2.3.3 老年代回收 Major GC</h4><p>进入老年代的数据较少，所以老年代区被占满的速度较慢，所以垃圾回收也不频繁。</p>
<p>如果老年代也满了,会触发老年代GC,称为Old GC或者 Major GC。</p>
<p>由于老年代对象一般来说存活次数较长，所以较常采用标记-压缩算法。</p>
<p>当老年代满时,会触发 Full GC,即对所有”代”的内存进行垃圾回收</p>
<p>Minor GC比较频繁，Major GC较少。但一般Major GC时，由于老年代对象也可以引用新生代对象，所以先进行一次Minor GC，然后在Major GC会提高效率。可以认为回收老年代的时候完成了一次Full GC。</p>
<p>所以可以认为 MajorGC = FullGC</p>
<h4 id="8-2-3-4-GC-触发条件"><a href="#8-2-3-4-GC-触发条件" class="headerlink" title="8.2.3.4 GC 触发条件"></a>8.2.3.4 GC 触发条件</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat165.png" srcset="/blog/img/loading.gif"></p>
<p><strong>Minor GC 触发条件</strong>：当eden区满了触发</p>
<p><strong>Full GC 触发条件：</strong></p>
<ul>
<li>老年代满了</li>
<li>System.gc()手动调用。不推荐</li>
</ul>
<p><strong>年轻代:</strong></p>
<ul>
<li>存活时长低</li>
<li>适合复制算法</li>
</ul>
<p><strong>老年代:</strong></p>
<ul>
<li>区域大,存活时长高</li>
<li>适合标记清除和标记压缩算法</li>
</ul>
<h3 id="8-2-4-java-内存调整相关参数"><a href="#8-2-4-java-内存调整相关参数" class="headerlink" title="8.2.4 java 内存调整相关参数"></a>8.2.4 java 内存调整相关参数</h3><h4 id="8-2-4-1-JVM-内存常用相关参数"><a href="#8-2-4-1-JVM-内存常用相关参数" class="headerlink" title="8.2.4.1 JVM 内存常用相关参数"></a>8.2.4.1 JVM 内存常用相关参数</h4><p>Java 命令行参考文档: <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat166.png" srcset="/blog/img/loading.gif"></p>
<p>帮助：man java<br><strong>选项分类</strong></p>
<ul>
<li><strong>-选项名称</strong> 此为标准选项,所有HotSpot都支持</li>
<li><strong>-X选项名称</strong> 此为稳定的非标准选项</li>
<li><strong>-XX:选项名称</strong> 非标准的不稳定选项，下一个版本可能会取消</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>-Xms</td>
<td>设置应用程序初始使用的堆内存大小（年轻代+老年代）</td>
<td>-Xms2g</td>
</tr>
<tr>
<td>-Xmx</td>
<td>设置应用程序能获得的最大堆内存早期JVM不建议超过32G，内存管理效率下降</td>
<td>-Xms4g</td>
</tr>
<tr>
<td>-XX:NewSize</td>
<td>设置初始新生代大小</td>
<td>-XX:NewSize=128m</td>
</tr>
<tr>
<td>-XX:MaxNewSize</td>
<td>设置最大新生代内存空间</td>
<td>-XX:MaxNewSize=256m</td>
</tr>
<tr>
<td>-Xmnsize</td>
<td>同时设置-XX:NewSize 和 -XX:MaxNewSize，代替两者</td>
<td>-Xmn1g</td>
</tr>
<tr>
<td>-XX:NewRatio</td>
<td>以比例方式设置新生代和老年代</td>
<td>-XX:NewRatio=2new/old=1/2</td>
</tr>
<tr>
<td>-XX:SurvivorRatio</td>
<td>以比例方式设置eden和survivor(S0或S1)</td>
<td>-XX:SurvivorRatio=6 eden/survivor=6/1 new/survivor=8/1</td>
</tr>
<tr>
<td>-Xss</td>
<td>设置每个线程私有的栈空间大小,依据具体线程大小和数量</td>
<td>-Xss256k</td>
</tr>
</tbody></table>
<p>范例: 查看java的选项帮助</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看java命令标准选项</span><br>[root@centos ~]<span class="hljs-comment"># java</span><br>Usage: java [-options] class [args...]<br>           (to execute a class)<br>   or  java [-options] -jar jarfile [args...]<br>           (to execute a jar file)<br><span class="hljs-built_in">where</span> options include:<br>    -d32	  use a 32-bit data model <span class="hljs-keyword">if</span> available<br>    -d64	  use a 64-bit data model <span class="hljs-keyword">if</span> available<br>    -server	  to select the <span class="hljs-string">&quot;server&quot;</span> VM<br>                  The default VM is server.<br><br>    -cp &lt;class search path of directories and zip/jar files&gt;<br>    -classpath &lt;class search path of directories and zip/jar files&gt;<br>                  A : separated list of directories, JAR archives,<br>                  and ZIP archives to search <span class="hljs-keyword">for</span> class files.<br>    -D&lt;name&gt;=&lt;value&gt;<br>                  <span class="hljs-built_in">set</span> a system property<br>    -verbose:[class|gc|jni]<br>                  <span class="hljs-built_in">enable</span> verbose output<br>    -version      <span class="hljs-built_in">print</span> product version and <span class="hljs-built_in">exit</span><br>    -version:&lt;value&gt;<br>                  Warning: this feature is deprecated and will be removed<br>                  <span class="hljs-keyword">in</span> a future release.<br>                  require the specified version to run<br>    -showversion  <span class="hljs-built_in">print</span> product version and <span class="hljs-built_in">continue</span><br>    -jre-restrict-search | -no-jre-restrict-search<br>                  Warning: this feature is deprecated and will be removed<br>                  <span class="hljs-keyword">in</span> a future release.<br>                  include/exclude user private JREs <span class="hljs-keyword">in</span> the version search<br>    -? -<span class="hljs-built_in">help</span>      <span class="hljs-built_in">print</span> this <span class="hljs-built_in">help</span> message<br>    -X            <span class="hljs-built_in">print</span> <span class="hljs-built_in">help</span> on non-standard options<br>    -ea[:&lt;packagename&gt;...|:&lt;classname&gt;]<br>    -enableassertions[:&lt;packagename&gt;...|:&lt;classname&gt;]<br>                  <span class="hljs-built_in">enable</span> assertions with specified granularity<br>    -da[:&lt;packagename&gt;...|:&lt;classname&gt;]<br>    -disableassertions[:&lt;packagename&gt;...|:&lt;classname&gt;]<br>                  <span class="hljs-built_in">disable</span> assertions with specified granularity<br>    -esa | -enablesystemassertions<br>                  <span class="hljs-built_in">enable</span> system assertions<br>    -dsa | -disablesystemassertions<br>                  <span class="hljs-built_in">disable</span> system assertions<br>    -agentlib:&lt;libname&gt;[=&lt;options&gt;]<br>                  load native agent library &lt;libname&gt;, e.g. -agentlib:hprof<br>                  see also, -agentlib:jdwp=<span class="hljs-built_in">help</span> and -agentlib:hprof=<span class="hljs-built_in">help</span><br>    -agentpath:&lt;pathname&gt;[=&lt;options&gt;]<br>                  load native agent library by full pathname<br>    -javaagent:&lt;jarpath&gt;[=&lt;options&gt;]<br>                  load Java programming language agent, see java.lang.instrument<br>    -splash:&lt;imagepath&gt;<br>                  show splash screen with specified image<br>See http://www.oracle.com/technetwork/java/javase/documentation/index.html <span class="hljs-keyword">for</span> more details.<br>[root@t1 ~]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#查看java的非标准选项</span><br>[root@centos8 ~]<span class="hljs-comment"># java -X</span><br>    -Xmixed           mixed mode execution (default)<br>    -Xint             interpreted mode execution only<br>    -Xbootclasspath:&lt;directories and zip/jar files separated by :&gt;<br>                      <span class="hljs-built_in">set</span> search path <span class="hljs-keyword">for</span> bootstrap classes and resources<br>    -Xbootclasspath/a:&lt;directories and zip/jar files separated by :&gt;<br>                      append to end of bootstrap class path<br>    -Xbootclasspath/p:&lt;directories and zip/jar files separated by :&gt;<br>                      prepend <span class="hljs-keyword">in</span> front of bootstrap class path<br>    -Xdiag            show additional diagnostic messages<br>    -Xnoclassgc       <span class="hljs-built_in">disable</span> class garbage collection<br>    -Xincgc           <span class="hljs-built_in">enable</span> incremental garbage collection<br>    -Xloggc:&lt;file&gt;    <span class="hljs-built_in">log</span> GC status to a file with time stamps<br>    -Xbatch           <span class="hljs-built_in">disable</span> background compilation<br>    -Xms&lt;size&gt;        <span class="hljs-built_in">set</span> initial Java heap size<br>    -Xmx&lt;size&gt;        <span class="hljs-built_in">set</span> maximum Java heap size<br>    -Xss&lt;size&gt;        <span class="hljs-built_in">set</span> java thread stack size<br>    -Xprof            output cpu profiling data<br>    -Xfuture          <span class="hljs-built_in">enable</span> strictest checks, anticipating future default<br>    -Xrs              reduce use of OS signals by Java/VM (see documentation)<br>    -Xcheck:jni       perform additional checks <span class="hljs-keyword">for</span> JNI <span class="hljs-built_in">functions</span><br>    -Xshare:off       <span class="hljs-keyword">do</span> not attempt to use shared class data<br>    -Xshare:auto      use shared class data <span class="hljs-keyword">if</span> possible (default)<br>    -Xshare:on        require using shared class data, otherwise fail.<br>    -XshowSettings    show all settings and <span class="hljs-built_in">continue</span><br>    -XshowSettings:all<br>                      show all settings and <span class="hljs-built_in">continue</span><br>    -XshowSettings:vm show all vm related settings and <span class="hljs-built_in">continue</span><br>    -XshowSettings:properties<br>                      show all property settings and <span class="hljs-built_in">continue</span><br>    -XshowSettings:locale<br>                      show all locale related settings and <span class="hljs-built_in">continue</span><br><br>The -X options are non-standard and subject to change without notice.<br><br><span class="hljs-comment">#查看所有不稳定选项的当前生效值</span><br>[root@centos8 ~]<span class="hljs-comment"># java -XX:+PrintFlagsFinal</span><br>[Global flags]<br>     intx ActiveProcessorCount                      = -1                                  &#123;product&#125;<br>    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   &#123;product&#125;<br>    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  &#123;product&#125;<br>    uintx AdaptiveSizePausePolicy                   = 0                                   &#123;product&#125;<br>    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  &#123;product&#125;<br>    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  &#123;product&#125;<br>    uintx AdaptiveSizePolicyOutputInterval          = 0                                   &#123;product&#125;<br>    uintx AdaptiveSizePolicyWeight                  = 10                                  &#123;product&#125;<br>    uintx AdaptiveSizeThroughPutPolicy              = 0                                   &#123;product&#125;<br>    uintx AdaptiveTimeWeight                        = 25                                  &#123;product&#125;<br>......<br><br><span class="hljs-comment">#查看所有不稳定选项的默认值</span><br>[root@centos8 ~]<span class="hljs-comment"># java -XX:+PrintFlagsInitial</span><br>[Global flags]<br>     intx ActiveProcessorCount                      = -1                                  &#123;product&#125;<br>    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   &#123;product&#125;<br>    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  &#123;product&#125;<br>    uintx AdaptiveSizePausePolicy                   = 0                                   &#123;product&#125;<br>    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  &#123;product&#125;<br>    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  &#123;product&#125;<br><br>.......<br><br><span class="hljs-comment">#查看当前命令行的使用的选项设置</span><br>[root@centos8 ~]<span class="hljs-comment"># java -XX:+PrintCommandLineFlags</span><br>-XX:InitialHeapSize=15598528 -XX:MaxHeapSize=249576448 -<br>XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops<br>-XX:+UseParallelGC<br><br><span class="hljs-comment">#上面的-XX:+UseParallelGC 说明当前使用Parallel Scavenge + Parallel Old</span><br></code></pre></td></tr></table></figure>

<p>范例: 查看和指定JVM内存分配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#默认JVM试图分配最大内存的总内存的1/4,初始化默认总内存为总内存的1/64</span><br>[root@centos8 ~]<span class="hljs-comment"># cat Heap.java</span><br>public class Heap &#123;<br> public static void main(String[] args)&#123;<br>   //返回JVM试图使用的最大内存,字节单位<br>   long max = Runtime.getRuntime().maxMemory();<br>   //返回JVM初始化总内存<br>   long total = Runtime.getRuntime().totalMemory();<br>   System.out.println(<span class="hljs-string">&quot;max=&quot;</span>+max+<span class="hljs-string">&quot;字节\t&quot;</span>+(max/(double)1024/1024)+<span class="hljs-string">&quot;MB&quot;</span>);<br>   System.out.println(<span class="hljs-string">&quot;total=&quot;</span>+total+<span class="hljs-string">&quot;字节\t&quot;</span>+<br>(total/(double)1024/1024)+<span class="hljs-string">&quot;MB&quot;</span>);<br> &#125;<br>&#125;<br>[root@centos8 ~]<span class="hljs-comment"># javac Heap.java</span><br>[root@centos8 ~]<span class="hljs-comment"># echo $CLASSPATH</span><br>/usr/<span class="hljs-built_in">local</span>/jdk/lib/:/usr/<span class="hljs-built_in">local</span>/jdk/jre/lib/<br><br>[root@centos8 ~]<span class="hljs-comment"># cp Heap.class /usr/local/jdk/lib</span><br><span class="hljs-comment">#查看当前内存默认值</span><br>[root@centos8 ~]<span class="hljs-comment"># java -XX:+PrintGCDetails Heap</span><br>max=239271936字节	228.1875MB<br>total=16252928字节	15.5MB<br>Heap<br> def new generation   total 4928K, used 530K [0x00000000f1400000, 0x00000000f1950000, 0x00000000f62a0000)<br>  eden space 4416K,  12% used [0x00000000f1400000, 0x00000000f1484ae0, 0x00000000f1850000)<br>  from space 512K,   0% used [0x00000000f1850000, 0x00000000f1850000, 0x00000000f18d0000)<br>  to   space 512K,   0% used [0x00000000f18d0000, 0x00000000f18d0000, 0x00000000f1950000)<br> tenured generation   total 10944K, used 0K [0x00000000f62a0000, 0x00000000f6d50000, 0x0000000100000000)<br>   the space 10944K,   0% used [0x00000000f62a0000, 0x00000000f62a0000, 0x00000000f62a0200, 0x00000000f6d50000)<br> Metaspace       used 2522K, capacity 4486K, committed 4864K, reserved 1056768K<br>  class space    used 269K, capacity 386K, committed 512K, reserved 1048576K<br><br><span class="hljs-comment">#指定内存空间</span><br>[root@centos8 ~]<span class="hljs-comment"># java -Xms1024m -Xmx1024m -XX:+PrintGCDetails Heap</span><br>max=1037959168字节	989.875MB<br>total=1037959168字节	989.875MB<br>Heap<br> def new generation   total 314560K, used 11185K [0x00000000c0000000, 0x00000000d5550000, 0x00000000d5550000)<br>  eden space 279616K,   4% used [0x00000000c0000000, 0x00000000c0aec408, 0x00000000d1110000)<br>  from space 34944K,   0% used [0x00000000d1110000, 0x00000000d1110000, 0x00000000d3330000)<br>  to   space 34944K,   0% used [0x00000000d3330000, 0x00000000d3330000, 0x00000000d5550000)<br> tenured generation   total 699072K, used 0K [0x00000000d5550000, 0x0000000100000000, 0x0000000100000000)<br>   the space 699072K,   0% used [0x00000000d5550000, 0x00000000d5550000, 0x00000000d5550200, 0x0000000100000000)<br> Metaspace       used 2522K, capacity 4486K, committed 4864K, reserved 1056768K<br>  class space    used 269K, capacity 386K, committed 512K, reserved 1048576K<br><br><span class="hljs-comment">#以下计算结果和max一样,说明Metaspace逻辑存在,但物理上并不属于heap空间</span><br>[root@centos8 ~]<span class="hljs-comment"># echo &#x27;(314560+699072)*1024&#x27;|bc</span><br>1037959168 <br></code></pre></td></tr></table></figure>

<p>范例: 查看OOM</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># cat HeapOom2.java #该文件需要在实验环境文件里</span><br>import java. util. Random;<br>public class HeapOom2 &#123;<br>	public static void main(String[] args) &#123;<br>		String str = <span class="hljs-string">&quot;I am lao wang&quot;</span>;<br>		<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>			str += str + new Random().nextInt(88888888);<br>		&#125;<br>	&#125;<br>&#125;<br>[root@centos8 ~]<span class="hljs-comment"># javac HeapOom2.java</span><br><br>[root@centos8 ~]<span class="hljs-comment"># java -Xms100m -Xmx100m -XX:+PrintGCDetails HeapOom2</span><br>[GC (Allocation Failure) [DefNew: 27321K-&gt;2946K(30720K), 0.0113108 secs] 27321K-&gt;5634K(99008K), 0.0113649 secs] [Times: user=0.00 sys=0.01, real=0.01 secs] <br>[GC (Allocation Failure) [DefNew: 24991K-&gt;0K(30720K), 0.0052229 secs] 27679K-&gt;8322K(99008K), 0.0052588 secs] [Times: user=0.00 sys=0.01, real=0.01 secs] <br>[GC (Allocation Failure) [DefNew: 16577K-&gt;0K(30720K), 0.0043613 secs] 24900K-&gt;19074K(99008K), 0.0044313 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] <br>[GC (Allocation Failure) [DefNew: 21503K-&gt;0K(30720K), 0.0673620 secs] 40578K-&gt;40578K(99008K), 0.0673951 secs] [Times: user=0.00 sys=0.03, real=0.07 secs] <br>[GC (Allocation Failure) [DefNew: 21982K-&gt;0K(30720K), 0.0744600 secs] 62560K-&gt;62082K(99008K), 0.0745070 secs] [Times: user=0.00 sys=0.04, real=0.08 secs] <br>[GC (Allocation Failure) [DefNew: 21504K-&gt;21504K(30720K), 0.0000175 secs][Tenured: 62082K-&gt;35202K(68288K), 0.0058587 secs] 83586K-&gt;35202K(99008K), [Metaspace: 2476K-&gt;2476K(1056768K)], 0.0059294 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] <br>[Full GC (Allocation Failure) [Tenured: 35202K-&gt;32500K(68288K), 0.0066670 secs] 35202K-&gt;32500K(99008K), [Metaspace: 2476K-&gt;2476K(1056768K)], 0.0066989 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] <br>Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Java heap space<br>	at java.util.Arrays.copyOf(Arrays.java:3332)<br>	at java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:124)<br>	at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:674)<br>	at java.lang.StringBuilder.append(StringBuilder.java:208)<br>	at HeapOom2.main(HeapOom2.java:6)<br>Heap<br> def new generation   total 30720K, used 1044K [0x00000000f9c00000, 0x00000000fbd50000, 0x00000000fbd50000)<br>  eden space 27328K,   3% used [0x00000000f9c00000, 0x00000000f9d05368, 0x00000000fb6b0000)<br>  from space 3392K,   0% used [0x00000000fba00000, 0x00000000fba00000, 0x00000000fbd50000)<br>  to   space 3392K,   0% used [0x00000000fb6b0000, 0x00000000fb6b0000, 0x00000000fba00000)<br> tenured generation   total 68288K, used 32500K [0x00000000fbd50000, 0x0000000100000000, 0x0000000100000000)<br>   the space 68288K,  47% used [0x00000000fbd50000, 0x00000000fdd0d300, 0x00000000fdd0d400, 0x0000000100000000)<br> Metaspace       used 2510K, capacity 4486K, committed 4864K, reserved 1056768K<br>  class space    used 268K, capacity 386K, committed 512K, reserved 1048576K<br></code></pre></td></tr></table></figure>

<h4 id="8-2-4-2-JDK-工具监控使用情况"><a href="#8-2-4-2-JDK-工具监控使用情况" class="headerlink" title="8.2.4.2 JDK 工具监控使用情况"></a>8.2.4.2 JDK 工具监控使用情况</h4><h5 id="8-2-4-2-1-案例1-jvisualvm工具"><a href="#8-2-4-2-1-案例1-jvisualvm工具" class="headerlink" title="8.2.4.2.1 案例1: jvisualvm工具"></a>8.2.4.2.1 案例1: jvisualvm工具</h5><p>范例: 指定参数运行Java程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#java -cp . -Xms512m -Xmx1g HelloWorld</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#测试用java程序</span><br>javac HelloWorld.java<br>java -classpath . -Xms512m -Xmx1g HelloWorld<br><br>[root@tomcat ~]<span class="hljs-comment"># cat HelloWorld.java</span><br>public class HelloWorld extends Thread &#123;<br>    public static void main(String[] args) &#123;<br>        try &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>				Thread.sleep(2000);<br>				System.out.println(<span class="hljs-string">&quot;hello magedu&quot;</span>);<br>			&#125;            <br>        &#125; catch (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#编译为字节码.class文件</span><br>[root@tomcat ~]<span class="hljs-comment"># javac HelloWorld.java</span><br>[root@tomcat ~]<span class="hljs-comment"># ll HelloWorld.class</span><br>-rw-r--r-- 1 root root 590 Jul 13 16:31 HelloWorld.class<br>[root@tomcat ~]<span class="hljs-comment"># file HelloWorld.class</span><br>HelloWorld.class: compiled Java class data, version 52.0 (Java 1.8)<br><br><span class="hljs-comment">#相对路径运行class文件</span><br>[root@tomcat ~]<span class="hljs-comment"># java -cp . -Xms512m -Xmx1g HelloWorld</span><br>hello magedu<br>hello magedu<br>hello magedu<br><br><span class="hljs-comment">#或者用下面方法指定CLASS文件的搜索路径</span><br>[root@tomcat ~]<span class="hljs-comment"># echo $CLASSPATH</span><br>/usr/<span class="hljs-built_in">local</span>/jdk/lib/:/usr/<span class="hljs-built_in">local</span>/jdk/jre/lib/<br>[root@tomcat ~]<span class="hljs-comment"># mv HelloWorld.class /usr/local/jdk/lib/</span><br><br><span class="hljs-comment">#分别执行多次观察</span><br>[root@tomcat ~]<span class="hljs-comment"># java HelloWorld</span><br>[root@tomcat ~]<span class="hljs-comment"># java -Xms256m -Xmx512m HelloWorld</span><br>[root@tomcat ~]<span class="hljs-comment"># java -Xms128m -Xmx512m -XX:NewSize=64m -XX:MaxNewSize=200m</span><br>HelloWorld<br>hello magedu<br><br>[root@tomcat ~]<span class="hljs-comment"># jps</span><br>21299 Main<br>21418 Jps<br>21407 HelloWorld<br><br><span class="hljs-comment">#将Linux的图形工具显示到windows桌面</span><br><span class="hljs-comment">#方法1</span><br><span class="hljs-comment">#注意:先在windows上开启Xwindows Server，如Xmanager</span><br>[root@tomcat ~]<span class="hljs-comment"># export DISPLAY=10.0.0.1:0.0</span><br><br><span class="hljs-comment">#方法2:使用 MobaXterm 连接</span><br>[root@tomcat ~]<span class="hljs-comment"># yum -y install xorg-x11-xauth xorg-x11-fonts-* xorg-x11-font-utils xorg-x11-fonts-Type1</span><br>[root@tomcat ~]<span class="hljs-comment"># exit</span><br><br><span class="hljs-comment">#运行图形工具</span><br>[roottomcat ~]<span class="hljs-comment"># which jvisualvm</span><br>/usr/<span class="hljs-built_in">local</span>/jdk/bin/jvisualvm<br><br>[root@tomcat ~]<span class="hljs-comment"># jvisualvm</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat167.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat168.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat169.png" srcset="/blog/img/loading.gif"></p>
<h5 id="8-2-4-2-2-案例2-使用-jvisualvm的-Visual-GC-插件"><a href="#8-2-4-2-2-案例2-使用-jvisualvm的-Visual-GC-插件" class="headerlink" title="8.2.4.2.2 案例2: 使用 jvisualvm的 Visual GC 插件"></a>8.2.4.2.2 案例2: 使用 jvisualvm的 Visual GC 插件</h5><p>范例: 使用 jvisualvm的 Visual GC 插件 观察 java程序的OOM</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># cat HeapOom.java</span><br>import java.util.ArrayList;<br>import java.util.List;<br><br>public class HeapOom &#123;<br>    public static void main(String[] args) &#123;<br>        List&lt;byte[]&gt; list =new ArrayList&lt;byte[]&gt;();<br>        int i = 0;<br>        boolean flag = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">while</span>(flag)&#123;<br>            try&#123;<br>                i++;<br>                list.add(new byte[1024* 1024]);//每次增加一个1M大小的数组对象<br>                Thread.sleep(1000);<br>            &#125;catch(Throwable e)&#123;<br>                e.printStackTrace();<br>                flag = <span class="hljs-literal">false</span>;<br>                System.out.println(<span class="hljs-string">&quot;count=&quot;</span>+i);//记录运行的次数<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>安装VirtualGC插件</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat170.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat171.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat172.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat173.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat174.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat175.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat176.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat177.png" srcset="/blog/img/loading.gif"></p>
<p>运行上面的OOM程序,重新运行jvisualm, 可以看到多了一下VisualGC页标,下面的图示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># java -Xms100m -Xmx200m HeapOom</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat178.png" srcset="/blog/img/loading.gif"></p>
<p>当OOM时退出JAVA程序时,会显示下面图示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># java HeapOom</span><br>java.lang.OutOfMemoryError: Java heap space<br>at HeapOom.main(HeapOom.java:12)<br>count=229<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat179.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat180.png" srcset="/blog/img/loading.gif"></p>
<h5 id="8-2-4-2-3-Jprofiler定位OOM的问题原因"><a href="#8-2-4-2-3-Jprofiler定位OOM的问题原因" class="headerlink" title="8.2.4.2.3 Jprofiler定位OOM的问题原因"></a>8.2.4.2.3 Jprofiler定位OOM的问题原因</h5><p>JProfiler官网：<a target="_blank" rel="noopener" href="http://www.ej-technologies.com/products/jprofiler/overview.html">http://www.ej-technologies.com/products/jprofiler/overview.html</a></p>
<p>JProfiler是一款功能强大的Java开发分析工具，它可以快速的帮助用户分析出存在的错误，软件还可对需要的显示类进行标记，包括了内存的分配情况和信息的视图等</p>
<p>范例: 安装jprofiler工具定位OOM原因和源码问题的位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装OpenJDK</span><br>[root@centos8 ~]<span class="hljs-comment"># yum -y install java-1.8.0-openjdk-devel</span><br><br>[root@centos8 ~]<span class="hljs-comment"># cat HeapOom.java</span><br>import java.util.ArrayList;<br>import java.util.List;<br><br>public class HeapOom &#123;<br>    public static void main(String[] args) &#123;<br>        List&lt;byte[]&gt; list =new ArrayList&lt;byte[]&gt;();<br>        int i = 0;<br>        boolean flag = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">while</span>(flag)&#123;<br>            try&#123;<br>                i++;<br>                list.add(new byte[1024* 1024]);//每次增加一个1M大小的数组对象<br>                Thread.sleep(1000);<br>            &#125;catch(Throwable e)&#123;<br>                e.printStackTrace();<br>                flag = <span class="hljs-literal">false</span>;<br>                System.out.println(<span class="hljs-string">&quot;count=&quot;</span>+i);//记录运行的次数<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br>[root@centos8 ~]<span class="hljs-comment"># javac HeapOom.java</span><br>[root@centos8 ~]<span class="hljs-comment"># java -cp . -Xms5m -Xmx10m -XX:+HeapDumpOnOutOfMemoryError HeapOom</span><br>java.lang.OutOfMemoryError: Java heap space<br>Dumping heap to java_pid40277.hprof ...<br>Heap dump file created [9182494 bytes <span class="hljs-keyword">in</span> 0.009 secs]<br>java.lang.OutOfMemoryError: Java heap space<br>	at HeapOom.main(HeapOom.java:12)<br>count=9<br><br>[root@centos8 ~]<span class="hljs-comment"># cat HeapOom2.java</span><br>import java. util. Random;<br>public class HeapOom2 &#123;<br>	public static void main(String[] args) &#123;<br>		String str = <span class="hljs-string">&quot;I am lao wang&quot;</span>;<br>		<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>			str += str + new Random().nextInt(88888888);<br>		&#125;<br>	&#125;<br>&#125;<br><br>[root@centos8 ~]<span class="hljs-comment"># javac HeapOom2.java</span><br>[root@centos8 ~]<span class="hljs-comment"># java -cp . -Xms5m -Xmx10m -XX:+HeapDumpOnOutOfMemoryError HeapOom2</span><br>java.lang.OutOfMemoryError: Java heap space<br>Dumping heap to java_pid40323.hprof ...<br>Heap dump file created [4889742 bytes <span class="hljs-keyword">in</span> 0.013 secs]<br>Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Java heap space<br>	at java.util.Arrays.copyOf(Arrays.java:3332)<br>	at java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:124)<br>	at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:674)<br>	at java.lang.StringBuilder.append(StringBuilder.java:208)<br>	at HeapOom2.main(HeapOom2.java:6)<br></code></pre></td></tr></table></figure>

<p><strong>下载并安装Jprofiler</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat181.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat182.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat183.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat184.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat185.png" srcset="/blog/img/loading.gif"></p>
<p>下载并安装JProfiler(傻瓜式安装略)后,双击打开前面生成的两个文件java_pid96271.hprof和java_pid96339,可以看到下面显示,从中分析OOM原因</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat186.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat187.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat188.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat189.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat190.png" srcset="/blog/img/loading.gif"></p>
<h4 id="8-2-4-3-Tomcat的JVM参数设置"><a href="#8-2-4-3-Tomcat的JVM参数设置" class="headerlink" title="8.2.4.3 Tomcat的JVM参数设置"></a>8.2.4.3 Tomcat的JVM参数设置</h4><p>默认不指定，-Xmx大约使用了1/4的内存，当前本机内存指定约为1G。</p>
<p>在bin/catalina.sh中增加一行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">......<br><span class="hljs-comment"># OS specific support. $var _must_ be set to either true or false.</span><br><span class="hljs-comment">#添加下面一行</span><br>JAVA_OPTS=<span class="hljs-string">&quot;-server -Xms128m -Xmx512m -XX:NewSize=48m -XX:MaxNewSize=200m&quot;</span><br><br>cygwin=<span class="hljs-literal">false</span><br>darwin=<span class="hljs-literal">false</span><br>........<br>systemctl restart tomcat<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">-server：VM运行在server模式，为在服务器端最大化程序运行速度而优化<br>-client：VM运行在Client模式，为客户端环境减少启动时间而优化<br></code></pre></td></tr></table></figure>

<p>重启 Tomcat 观察</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@tomcat ~]<span class="hljs-comment"># ps aux|grep tomcat</span><br>tomcat     40459  9.8 13.8 2491788 133040 ?      Sl   16:51   0:03 /usr/<span class="hljs-built_in">local</span>//jdk/bin/java -Djava.util.logging.config.file=/usr/<span class="hljs-built_in">local</span>/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -server -Xms128m -Xmx512m -XX:NewSize=48m -XX:MaxNewSize=200m -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/<span class="hljs-built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="hljs-built_in">local</span>/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/<span class="hljs-built_in">local</span>/tomcat -Dcatalina.home=/usr/<span class="hljs-built_in">local</span>/tomcat -Djava.io.tmpdir=/usr/<span class="hljs-built_in">local</span>/tomcat/temp org.apache.catalina.startup.Bootstrap start<br>root       40525  0.0  0.0  12112   944 pts/1    R+   16:52   0:00 grep --color=auto tomcato.tmpdir=/usr/<span class="hljs-built_in">local</span>/tomcat/temp org.apache.catalina.startup.Bootstrap<br>start<br></code></pre></td></tr></table></figure>

<p>浏览器访问server status页面，可以看到以下页面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat191.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-2-5-垃圾收集方式"><a href="#8-2-5-垃圾收集方式" class="headerlink" title="8.2.5 垃圾收集方式"></a>8.2.5 垃圾收集方式</h3><p>按<strong>工作模式</strong>不同：指的是GC线程和工作线程是否一起运行</p>
<ul>
<li>独占垃圾回收器：只有GC在工作，STW 一直进行到回收完毕，工作线程才能继续执行</li>
<li>并发垃圾回收器：让GC线程垃圾回收某些阶段可以和工作线程一起进行,如:标记阶段并行,回收阶<br>段仍然串行</li>
</ul>
<p>按<strong>回收线程</strong>数：指的是GC线程是否串行或并行执行</p>
<ul>
<li>串行垃圾回收器：一个GC线程完成回收工作</li>
<li>并行垃圾回收器：多个GC线程同时一起完成回收工作，充分利用CPU资源</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat192.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-2-6-调整策略"><a href="#8-2-6-调整策略" class="headerlink" title="8.2.6 调整策略"></a>8.2.6 调整策略</h3><p>对JVM调整策略应用极广</p>
<ul>
<li>在WEB领域中Tomcat等</li>
<li>在大数据领域Hadoop生态各组件</li>
<li>在消息中间件领域的Kafka等</li>
<li>在搜索引擎领域的ElasticSearch、Solr等</li>
</ul>
<p><strong>注意: 在不同领域和场景对JVM需要不同的调整策略</strong></p>
<ul>
<li>减少 STW 时长，串行变并行</li>
<li>减少 GC 次数，要分配合适的内存大小</li>
</ul>
<p><strong>一般情况下，我们大概可以使用以下原则：</strong></p>
<ul>
<li>客户端或较小程序，内存使用量不大，可以使用串行回收</li>
<li>对于服务端大型计算，可以使用并行回收</li>
<li>大型WEB应用，用户端不愿意等待，尽量少的STW，可以使用并发回收</li>
</ul>
<h3 id="8-2-7-垃圾回收器"><a href="#8-2-7-垃圾回收器" class="headerlink" title="8.2.7 垃圾回收器"></a>8.2.7 垃圾回收器</h3><h4 id="8-2-7-1-常用垃圾回收器"><a href="#8-2-7-1-常用垃圾回收器" class="headerlink" title="8.2.7.1 常用垃圾回收器"></a>8.2.7.1 常用垃圾回收器</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat193.png" srcset="/blog/img/loading.gif"></p>
<h5 id="8-2-7-1-1-按分代设置不同垃圾回收器"><a href="#8-2-7-1-1-按分代设置不同垃圾回收器" class="headerlink" title="8.2.7.1.1 按分代设置不同垃圾回收器"></a>8.2.7.1.1 按分代设置不同垃圾回收器</h5><p><strong>新生代</strong></p>
<ul>
<li>新生代串行收集器<strong>Serial</strong>：单线程、独占式串行，采用复制算法,简单高效但会造成STW</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat194.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li>新生代并行回收收集器<strong>PS(Parallel Scavenge)<strong>：多线程并行、独占式，会产生STW, 使用</strong>复制算<br>法</strong>关注调整<strong>吞吐量</strong>,此收集器关注点是达到一个可控制的吞吐量吞吐量 = 运行用户代码时间/（运行用户代码时间+垃圾收集时间），比如虚拟机总共运行100分钟，其中垃圾回收花掉1分钟，那吞吐量就是99%。高吞吐量可以高效率利用CPU时间，尽快完成运算任务，主要适合在后台运算而不需要太多交互的任务。除此之外，Parallel Scavenge 收集器具有自适应调节策略，它可以将内存管理的调优任务交给虚拟机去完成。自适应调节策略也是Parallel Scavenge与 ParNew 收集器的一个重要区别。<strong>和ParNew不同,PS不可以和老年代的CMS组合</strong></li>
<li>新生代并行收集器ParNew：就是Serial 收集器的多线程版,将单线程的串行收集器变成了多线程并行、独占式,使用<strong>复制算法</strong>,相当于PS的改进版经常和CMS配合使用,关注点是尽可能地缩短垃圾收集时用户线程的停顿时间，适合需要与用户交互的程序，良好的响应速度能提升用户体验</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat195.png" srcset="/blog/img/loading.gif"></p>
<p>老年代：</p>
<ul>
<li>老年代串行收集器<strong>Serial Old</strong>：Serial Old是Serial收集器的老年代版本,单线程、独占式串行，回收算法使用标记压缩</li>
<li>老年代并行回收收集器<strong>Parallel Old</strong>：多线程、独占式并行，回收算法使用标记压缩，关注调整<strong>吞吐量</strong></li>
</ul>
<p>Parallel Old收集器是Parallel Scavenge 收集器的老年代版本，这个收集器是JDK1.6之后才开始提供，从HotSpot虚拟机的垃圾收集器的图中也可以看出，Parallel Scavenge 收集器无法与CMS收集器配合工作,因为一个是为了吞吐量，一个是为了客户体验（也就是暂停时间的缩短）</p>
<ul>
<li><strong>CMS (Concurrent Mark Sweep并发标记清除算法) 收集器</strong><ul>
<li><p>在某些阶段尽量使用和工作线程一起运行，减少STW时长(200ms以内), 提升<strong>响应</strong>速度,是互联网服务端BS系统上较佳的回收算法</p>
</li>
<li><p>分为4个阶段：初始标记、并发标记、重新标记、并发清除，在初始标记、重新标记时需要STW。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat196.png" srcset="/blog/img/loading.gif"></p>
</li>
<li><p>初始标记：此过程需要STW（Stop The Word），只标记一下GC Roots能直接关联到的对象，速度很快。</p>
</li>
<li><p>并发标记：就是GC Roots进行扫描可达链的过程，为了找出哪些对象需要收集。这个过程远远慢于初始标记，但它是和用户线程一起运行的，不会出现STW，所有用户并不会感受到。</p>
</li>
<li><p>重新标记：为了修正在并发标记期间，用户线程产生的垃圾，这个过程会比初始标记时间稍微长一点，但是也很快，和初始标记一样会产生STW。</p>
</li>
<li><p>并发清理：在重新标记之后，对现有的垃圾进行清理，和并发标记一样也是和用户线程一起运行的，耗时较长（和初始标记比的话），不会出现STW。</p>
</li>
<li><p>由于整个过程中，耗时最长的并发标记和并发清理都是与用户线程一起执行的，所以总体上来说，CMS收集器的内存回收过程是与用户线程一起并发执行的。</p>
</li>
</ul>
</li>
</ul>
<h5 id="8-2-7-1-2-以下收集器不再按明确的分代单独设置"><a href="#8-2-7-1-2-以下收集器不再按明确的分代单独设置" class="headerlink" title="8.2.7.1.2 以下收集器不再按明确的分代单独设置"></a>8.2.7.1.2 以下收集器不再按明确的分代单独设置</h5><ul>
<li><strong>G1(Garbage First)收集器</strong><ul>
<li>是最新垃圾回收器，从JDK1.6实验性提供，JDK1.7发布，其设计目标是在多处理器、大内存服务器端提供优于CMS收集器的吞吐量和停顿控制的回收器。JDK9将G1设为默认的收集器,建议 JDK9版本以后使用。</li>
<li>基于标记压缩算法,不会产生大量的空间碎片，有利于程序的长期执行。</li>
<li>分为4个阶段：初始标记、并发标记、最终标记、筛选回收。并发标记并发执行，其它阶段STW只有GC线程并行执行。</li>
<li>G1收集器是面向服务端的收集器，它的思想就是首先回收尽可能多的垃圾（这也是Garbage-First名字的由来）</li>
<li>G1能充分的利用多CPU，多核环境下的硬件优势，使用多个CPU来缩短STW停顿的时间(10ms以内)。</li>
<li>可预测的停顿：这是G1相对于CMS的另一大优势，G1和CMS一样都是关注于降低停顿时间，但是G1能够让使用者明确的指定在一个M毫秒的时间片段内，消耗在垃圾收集的时间不得超过N毫秒。</li>
<li>通过此选项指定: +UseG1GC</li>
</ul>
</li>
<li>ZGC收集器: 减少SWT时长(1ms以内), 可以PK C++的效率,目前实验阶段</li>
<li>Shenandoah收集器: 和ZGC竞争关系,目前实验阶段</li>
<li>Epsilon收集器: 调试 JDK 使用,内部使用,不用于生产环境</li>
</ul>
<p><strong>JVM 1.8 默认的垃圾回收器：PS + ParallelOld,所以大多数都是针对此进行调优</strong></p>
<h4 id="8-2-7-2-垃圾收集器设置"><a href="#8-2-7-2-垃圾收集器设置" class="headerlink" title="8.2.7.2 垃圾收集器设置"></a>8.2.7.2 垃圾收集器设置</h4><p>优化调整Java 相关参数的目标: 尽量减少FullGC和STW</p>
<p>通过以下选项可以单独指定新生代、老年代的垃圾收集器</p>
<ul>
<li><p>-server 指定为Server模式,也是默认值,一般使用此工作模式</p>
</li>
<li><p>-XX:+UseSerialGC</p>
</li>
<li><p>运行在Client模式下，新生代是Serial, 老年代使用SerialOld </p>
</li>
<li><p>-XX:+UseParNewGC</p>
</li>
<li><p>新生代使用ParNew，老年代使用SerialOld</p>
</li>
<li><p>-XX:+UseParallelGC</p>
</li>
<li><p>运行于server模式下，新生代使用Serial Scavenge, 老年代使用SerialOld</p>
</li>
<li><p>-XX:+UseParallelOldGC</p>
</li>
<li><p>新生代使用Paralell Scavenge, 老年代使用Paralell Old</p>
</li>
<li><p>-XX:ParallelGCThreads=N，在关注吞吐量的场景使用此选项增加并行线程数</p>
</li>
<li><p>-XX:+UseConcMarkSweepGC</p>
<ul>
<li>新生代使用ParNew, 老年代优先使用CMS，备选方式为Serial Old</li>
<li>响应时间要短，停顿短使用这个垃圾收集器</li>
<li>-XX:CMSInitiatingOccupancyFraction=N，N为0-100整数表示达到老年代的大小的百分比多少触发回收<ul>
<li>默认68</li>
</ul>
</li>
<li>-XX:+UseCMSCompactAtFullCollection 开启此值,在CMS收集后，进行内存碎片整理</li>
<li>-XX:CMSFullGCsBeforeCompaction=N 设定多少次CMS后，进行一次内存碎片整理</li>
<li>-XX:+CMSParallelRemarkEnabled 降低标记停顿</li>
</ul>
</li>
</ul>
<p>范例: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">-XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=80 -<br>XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=5<br></code></pre></td></tr></table></figure>

<p>范例: 查看默认模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># java |&amp; grep &#x27;-server&#x27;</span><br>    -server	  to select the <span class="hljs-string">&quot;server&quot;</span> VM<br>                  The default VM is server.<br>[root@centos8 ~]<span class="hljs-comment"># tail -n 2 /usr/local/jdk/jre/lib/amd64/jvm.cfg</span><br>-server KNOWN<br>-client IGNORE<br></code></pre></td></tr></table></figure>

<p>范例: 指定垃圾回收设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#将参数加入到bin/catalina.sh中，重启观察Tomcat status。老年代已经使用CMS</span><br>[root@tomcat ~]<span class="hljs-comment"># vim /usr/local/tomcat/bin/catalina.sh</span><br>......<br><span class="hljs-comment"># OS specific support. $var _must_ be set to either true or false.</span><br><br>JAVA_OPTS=<span class="hljs-string">&quot;-server -Xmx512m -Xms128m -XX:NewSize=48m -XX:MaxNewSize=200m -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=5&quot;</span>  <br><br>cygwin=<span class="hljs-literal">false</span><br>darwin=<span class="hljs-literal">false</span><br>os400=<span class="hljs-literal">false</span><br>.......<br>[root@tomcat ~]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@tomcat ~]<span class="hljs-comment"># ps aux |grep tomcat</span><br>tomcat     40638 62.2 15.2 2547752 147012 ?      Sl   16:55   0:02 /usr/<span class="hljs-built_in">local</span>//jdk/bin/java -Djava.util.logging.config.file=/usr/<span class="hljs-built_in">local</span>/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -server -Xmx512m -Xms128m -XX:NewSize=48m -XX:MaxNewSize=200m -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=5 -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/<span class="hljs-built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="hljs-built_in">local</span>/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/<span class="hljs-built_in">local</span>/tomcat -Dcatalina.home=/usr/<span class="hljs-built_in">local</span>/tomcat -Djava.io.tmpdir=/usr/<span class="hljs-built_in">local</span>/tomcat/temp org.apache.catalina.startup.Bootstrap start<br>root       40686  0.0  0.1  12112  1016 pts/1    R+   16:55   0:00 grep --color=auto tomcat<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat197.png" srcset="/blog/img/loading.gif"></p>
<p>开启垃圾回收输出统计信息,适用于调试环境的相关选项</p>
<ul>
<li>-XX:+PrintGC 输出GC信息</li>
<li>-XX:+PrintGCDetails 输出GC详细信息</li>
<li>-XX:+PrintGCTimeStamps 与前两个组合使用，在信息上加上一个时间戳</li>
<li>-XX:+PrintHeapAtGC 生成GC前后椎栈的详细信息，日志会更大</li>
</ul>
<p>注意: 以上适用调试环境，生产环境请移除这些参数，否则有非常多的日志输出</p>
<h3 id="8-2-8-JAVA参数总结"><a href="#8-2-8-JAVA参数总结" class="headerlink" title="8.2.8 JAVA参数总结"></a>8.2.8 JAVA参数总结</h3><table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>-Xms</td>
<td>初始堆大小</td>
<td>物理内存的1/64(&lt;1GB)</td>
<td>默认(MinHeapFreeRatio参数可以调整)空余堆内存小于40%时，JVM就会增大堆直到-Xmx的最大限制.</td>
</tr>
<tr>
<td>-Xmx</td>
<td>最大堆大小</td>
<td>物理内存的1/4(&lt;1GB)</td>
<td>默认(MaxHeapFreeRatio参数可以调整)空余堆内存大于70%时，JVM会减少堆直到-Xms的最小限制</td>
</tr>
<tr>
<td>-Xm</td>
<td>年轻代大小(1.4or lator)</td>
<td></td>
<td>注意：此处的大小是（eden+ 2 survivor space).与jmap -heap中显示的New gen是不同的。 整个堆大小=年轻代大小 + 年老代大小 + 持久代大小. 增大年轻代后,将会减小年老代大小.此值对系统性能影响较大,Sun官方推荐配置为整个堆的3/8</td>
</tr>
<tr>
<td>-XX:NewSize</td>
<td>设置年轻代大小(for 1.3/1.4)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:MaxNewSize</td>
<td>年轻代最大值(for 1.3/1.4)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:PermSize</td>
<td>设置持久代(perm gen)初始值</td>
<td>物理内存的1/64</td>
<td></td>
</tr>
<tr>
<td>-XX:MaxPermSize</td>
<td>-XX:MaxPermSize</td>
<td>物理内存的1/4</td>
<td></td>
</tr>
<tr>
<td>-Xss</td>
<td>每个线程的堆栈大小</td>
<td></td>
<td>JDK5.0以后每个线程堆栈大小为1M,以前每个线程堆栈大小为256K.更具应用的线程所需内存大小进行 调整.在相同物理内存下,减小这个值能生成更多的线程.但是操作系统对一个进程内的线程数还是有限制的,不能无限生成,经验值在3000~5000左右 一般小的应用， 如果栈不是很深， 应该是128k够用的 大的应用建议使用256k。这个选项对性能影响比较大，需要严格的测试。</td>
</tr>
<tr>
<td>-XX:ThreadStackSize</td>
<td>Thread StackSize</td>
<td></td>
<td>(0 means use defaultstack size) [Sparc: 512;Solaris x86: 320 (was 256prior in 5.0 and earlier);Sparc 64 bit: 1024; Linuxamd64: 1024 (was 0 in 5.0and earlier); all others 0.]</td>
</tr>
<tr>
<td>-XX:NewRatio</td>
<td>年轻代(包括Eden和两个Survivor区)与年老代的比值(除去持久代)</td>
<td></td>
<td>-XX:NewRatio=4表示年轻代与年老代所占比值为1:4,年轻代占整个堆栈的1/5Xms=Xmx并且设置了Xmn的情况下，该参数不需要进行设置。</td>
</tr>
<tr>
<td>-XX:SurvivorRatio</td>
<td>Eden区与Survivor区的大小比值</td>
<td></td>
<td>设置为8,则两个Survivor区与一个Eden区的比值为2:8,一个Survivor区占整个年轻代的1/10</td>
</tr>
<tr>
<td>-XX:LargePageSizeInBytes</td>
<td>内存页的大小不可设置过大， 会影响Perm的大小</td>
<td></td>
<td>=128m</td>
</tr>
<tr>
<td>-XX:+UseFastAccessorMethods</td>
<td>原始类型的快速优化</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+DisableExplicitGC</td>
<td>关闭System.gc()</td>
<td></td>
<td>这个参数需要严格的测试</td>
</tr>
<tr>
<td>-XX:MaxTenuringThreshold</td>
<td>垃圾最大年龄</td>
<td></td>
<td>如果设置为0的话,则年轻代对象不经过Survivor区,直接进入年老代. 对于年老代比较多的应用,可以提高效率.如果将此值设置为一个较大值,则年轻代对象会在Survivor区进行多次复制,这样可以增加对象再年轻代的存活 时间,增加在年轻代即被回收的概率 该参数只有在串行GC时才有效</td>
</tr>
<tr>
<td>-XX:+AggressiveOpts</td>
<td>加快编译</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+UseBiasedLocking</td>
<td>锁机制的性能改善</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-Xnoclassgc</td>
<td>禁用垃圾回收</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:SoftRefLRUPolicyMSPerMB</td>
<td>每兆堆空闲空间中SoftReference的存活时时间</td>
<td></td>
<td>可达的对象在上次被引用后将保留一段时间。 缺省值是堆中每个空闲兆字节的生命周期的一秒钟</td>
</tr>
<tr>
<td>-XX:PretenureSizeThreshold</td>
<td>对象超过多大是直接在旧生代分配</td>
<td>0</td>
<td>单位字节 新生代采用Parallel Scavenge GC时无效 另一种直接在旧生代分配的情况是大的数组对象,且数组中无外部引用对象.</td>
</tr>
<tr>
<td>-XX:TLABWasteTargetPercent</td>
<td>TLAB占eden区的百分比</td>
<td>1%</td>
<td></td>
</tr>
<tr>
<td>-XX:+CollectGen0First</td>
<td>FullGC时是否先YGC</td>
<td>false</td>
<td></td>
</tr>
</tbody></table>
<p><strong>并行收集器相关参数</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseParallelGC</td>
<td>Full GC采用parallelMSC</td>
<td></td>
<td>选择垃圾收集器为并行收集器.此配置仅对年轻代有效.即上述配置下,年轻代使用并发收集,而年老代仍旧使用串行收集</td>
</tr>
<tr>
<td>-XX:+UseParNewGC</td>
<td>设置年轻代为并行收集</td>
<td></td>
<td>可与CMS收集同时使用 JDK5.0以上,JVM会根据系统配置自行设置,所以无需再设置此值</td>
</tr>
<tr>
<td>-XX:ParallelGCThreads</td>
<td>并行收集器的线程数</td>
<td></td>
<td>此值最好配置与处理器数目相等 同样适用于CMS</td>
</tr>
<tr>
<td>-XX:+UseParallelOldGC</td>
<td>年老代垃圾收集方式为并行收集(ParallelCompacting</td>
<td></td>
<td>这个是JAVA 6出现的参数选项</td>
</tr>
<tr>
<td>-XX:MaxGCPauseMillis</td>
<td>每次年轻代垃圾回收的最长时间(最大暂停时间)</td>
<td></td>
<td>如果无法满足此时间,JVM会自动调整年轻代大小,以满足此值.</td>
</tr>
<tr>
<td>-XX:+UseAdaptiveSizePolicy</td>
<td>自动选择年轻代区大小和相应的Survivor区比例</td>
<td></td>
<td>设置此选项后,并行收集器会自动选择年轻代区大小和相应的Survivor区比例,以达到目标系统规定的最低相应时间或者收集频率等,此值建议使用并行收集器时,一直打开.</td>
</tr>
<tr>
<td>-XX:GCTimeRatio</td>
<td>设置垃圾回收时间占程序运行时间的百分比</td>
<td></td>
<td>公式为1/(1+n)</td>
</tr>
<tr>
<td>-XX:+ScavengeBeforeFullGC</td>
<td>Full GC前调用YGC</td>
<td>true</td>
<td></td>
</tr>
</tbody></table>
<p><strong>CMS相关参数</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseConcMarkSweepGC</td>
<td>使用CMS内存收集</td>
<td></td>
<td>测试中配置这个以后,-XX:NewRatio=4的配置可能失效,所以,此时年轻代大小最好用-Xmn设置</td>
</tr>
<tr>
<td>-XX:+AggressiveHeap</td>
<td></td>
<td></td>
<td>试图是使用大量的物理内存 长时间大内存使用的优化，能检查计算资源（内存， 处理器数量） 至少需要256MB内存 大量的CPU／内存， （在1.4.1在4CPU的机器上已经显示有提升）</td>
</tr>
<tr>
<td>-XX:CMSFullGCsBeforeCompaction</td>
<td>多少次后进行内存压缩</td>
<td></td>
<td>由于并发收集器不对内存空间进行压缩,整理,所以运行一段时间以后会产生”碎片”,使得运行效率降低.此值设置运行多少次GC以后对内存空间进行压缩,整理.</td>
</tr>
<tr>
<td>-XX:+CMSParallelRemarkEnabled</td>
<td>降低标记停顿</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX+UseCMSCompactAtFullCollection</td>
<td>在FULLGC的时候，对年老代的压缩</td>
<td></td>
<td>CMS是不会移动内存的， 因此， 这个非常容易产生碎片，导致内存不够用， 因此， 内存的压缩这个时候就会被启用。增加这个参数是个好习惯。 可能会影响性能,但是可以消除碎片</td>
</tr>
<tr>
<td>-XX:+UseCMSInitiatingOccupancyOnly</td>
<td>使用手动定义初始化定义开始CMS收集</td>
<td></td>
<td>禁止hostspot自行触发CMSGC</td>
</tr>
<tr>
<td>-XX:CMSInitiatingOccupancyFraction=70</td>
<td>使用cms作为垃圾回收使用70％后开始CMS收集</td>
<td>92</td>
<td></td>
</tr>
<tr>
<td>-XX:+UseConcMarkSweepGC</td>
<td>使用CMS内存收集</td>
<td></td>
<td>测试中配置这个以后,-XX:NewRatio=4的配置可能失效,所以,此时年轻代大小最好用-Xmn设置</td>
</tr>
<tr>
<td>-XX:CMSInitiatingPermOccupancyFraction</td>
<td>设置PermGen使用到达多少比率时触发</td>
<td>92</td>
<td></td>
</tr>
<tr>
<td>-XX:+CMSIncrementalMode</td>
<td>设置为增量模式</td>
<td></td>
<td>用于单CPU情况</td>
</tr>
<tr>
<td>-XX:+CMSClassUnloadingEnabled</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>辅助信息</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+PrintGC</td>
<td></td>
<td></td>
<td>输出形式:[GC 118250K-&gt;113543K(130112K),0.0094143 secs] [Full GC121376K-&gt;10414K(130112K),0.0650971 secs]</td>
</tr>
<tr>
<td>-XX:+PrintGCDetails</td>
<td></td>
<td></td>
<td>输出形式:[GC [DefNew:8614K-&gt;781K(9088K),0.0123035 secs] 118250K-&gt;113543K(130112K),0.0124633 secs] [GC[DefNew: 8614K&gt;8614K(9088K), 0.0000665secs] 121376K-&gt;10414K(130112K),0.0436268 secs]</td>
</tr>
<tr>
<td>-XX:+PrintGCTimeStamps</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintGC:PrintGCTimeStamps</td>
<td></td>
<td></td>
<td>可与-XX:+PrintGC -XX:+PrintGCDetails混合使用输出形式:11.851: [GC98328K-&gt;93620K(130112K),0.0082960 secs]</td>
</tr>
<tr>
<td>-XX:+PrintGCApplicationStoppedTime</td>
<td>打印垃圾回收期间程序暂停的时间.可与上面混合使用</td>
<td></td>
<td>输出形式:Total time forwhich application threadswere stopped: 0.0468229seconds</td>
</tr>
<tr>
<td>-XX:+PrintGCApplicationConcurrentTime</td>
<td>打印每次垃圾回收前,程序未中断的执行时间.可与上面混合使用</td>
<td></td>
<td>输出形式:Application time:0.5291524 seconds</td>
</tr>
<tr>
<td>-XX:+PrintHeapAtGC</td>
<td>打印GC前后的详细堆栈信息</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-Xloggc:filename</td>
<td>把相关日志信息记录到文件以便分析. 与上面几个配合使用</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintGC</td>
<td></td>
<td></td>
<td>输出形式:[GC 118250K-&gt;113543K(130112K),0.0094143 secs] [Full GC121376K-&gt;10414K(130112K),0.0650971 secs]</td>
</tr>
<tr>
<td>-XX:+PrintClassHistogram</td>
<td>garbage collects before printing the histogram.</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintTLAB</td>
<td>查看TLAB空间的使用情况</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintTenuringDistribution</td>
<td>查看每次minor GC后新的存活周期的阈值</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="8-3-JVM相关工具"><a href="#8-3-JVM相关工具" class="headerlink" title="8.3 JVM相关工具"></a>8.3 JVM相关工具</h2><h3 id="8-3-1-JVM-工具概述"><a href="#8-3-1-JVM-工具概述" class="headerlink" title="8.3.1 JVM 工具概述"></a>8.3.1 JVM 工具概述</h3><p>$JAVA_HOME/bin下</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>jps</td>
<td>查看所有jvm进程</td>
</tr>
<tr>
<td>jinfo</td>
<td>查看进程的运行环境参数，主要是jvm命令行参数</td>
</tr>
<tr>
<td>jstat</td>
<td>对jvm应用程序的资源和性能进行实时监控</td>
</tr>
<tr>
<td>jstack</td>
<td>查看所有线程的运行状态</td>
</tr>
<tr>
<td>jmap</td>
<td>查看jvm占用物理内存的状态</td>
</tr>
<tr>
<td>jhat</td>
<td>+UseParNew</td>
</tr>
<tr>
<td>jconsole</td>
<td>图形工具</td>
</tr>
<tr>
<td>jvisualvm</td>
<td>图形工具</td>
</tr>
</tbody></table>
<h3 id="8-3-2-jps"><a href="#8-3-2-jps" class="headerlink" title="8.3.2 jps"></a>8.3.2 jps</h3><p>JVM 进程状态工具</p>
<p>格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">jps：Java virutal machine Process Status tool，<br>jps [-q] [-mlvV] [&lt;hostid&gt;]<br>-q：静默模式；<br>-v：显示传递给jvm的命令行参数；<br>-m：输出传入main方法的参数；<br>-l：输出main类或jar完全限定名称；<br>-v：显示通过flag文件传递给jvm的参数；<br>[&lt;hostid&gt;]：主机id，默认为localhost；<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#显示java进程</span><br>[root@tomcat ~]<span class="hljs-comment"># jps</span><br>22357 Jps<br>21560 Main<br>21407 HelloWorld<br><br><span class="hljs-comment">#详细列出当前Java进程信息</span><br>[root@tomcat ~]<span class="hljs-comment"># jps -l -v</span><br>39159 org.netbeans.Main -Djdk.home=/usr/<span class="hljs-built_in">local</span>/jdk -Dnetbeans.default_userdir_root=/root/.visualvm -Dnetbeans.dirs=/usr/<span class="hljs-built_in">local</span>/jdk/lib/visualvm/visualvm:/usr/<span class="hljs-built_in">local</span>/jdk/lib/visualvm/profiler: -Dnetbeans.home=/usr/<span class="hljs-built_in">local</span>/jdk/lib/visualvm/platform -Xms24m -Xmx256m -Dsun.jvmstat.perdata.syncWaitMs=10000 -Dsun.java2d.noddraw=<span class="hljs-literal">true</span> -Dsun.java2d.d3d=<span class="hljs-literal">false</span> -Dnetbeans.keyring.no.master=<span class="hljs-literal">true</span> -Dplugin.manager.install.global=<span class="hljs-literal">false</span> --add-exports=java.desktop/sun.awt=ALL-UNNAMED --add-exports=jdk.jvmstat/sun.jvmstat.monitor.event=ALL-UNNAMED --add-exports=jdk.jvmstat/sun.jvmstat.monitor=ALL-UNNAMED --add-exports=java.desktop/sun.swing=ALL-UNNAMED --add-exports=jdk.attach/sun.tools.attach=ALL-UNNAMED --add-modules=java.activation -XX:+IgnoreUnrecognizedVMOptions -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/root/.visualvm/8u131/var/<span class="hljs-built_in">log</span>/heapdump.hprof<br>40700 sun.tools.jps.Jps -Denv.class.path=/usr/<span class="hljs-built_in">local</span>//jdk/lib/:/usr/<span class="hljs-built_in">local</span>//jdk/jre/lib/:. -Dapplication.home=/usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241 -Xms8m<br></code></pre></td></tr></table></figure>

<h3 id="8-3-3-jinfo"><a href="#8-3-3-jinfo" class="headerlink" title="8.3.3 jinfo"></a>8.3.3 jinfo</h3><p>输出给定的java进程的所有配置信息</p>
<p>格式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">jinfo [option] &lt;pid&gt;<br>-flags：打印 VM flags<br>-sysprops：to <span class="hljs-built_in">print</span> Java system properties<br>-flag &lt;name&gt;：to <span class="hljs-built_in">print</span> the value of the named VM flag<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先获得一个java进程ID，然后jinfo</span><br>[root@tomcat ~]<span class="hljs-comment"># jps</span><br>40840 Jps<br>40830 HelloWorld<br><br>[root@tomcat ~]<span class="hljs-comment"># jinfo 21407</span><br>Attaching to process ID 40830, please <span class="hljs-built_in">wait</span>...<br>Debugger attached successfully.<br>Server compiler detected.<br>JVM version is 25.241-b07<br>Java System Properties:<br><br>java.runtime.name = Java(TM) SE Runtime Environment<br>java.vm.version = 25.241-b07<br>sun.boot.library.path = /usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/lib/amd64<br>java.vendor.url = http://java.oracle.com/<br>java.vm.vendor = Oracle Corporation<br>path.separator = :<br>file.encoding.pkg = sun.io<br>java.vm.name = Java HotSpot(TM) 64-Bit Server VM<br>sun.os.patch.level = unknown<br>sun.java.launcher = SUN_STANDARD<br>user.country = US<br>user.dir = /root<br>java.vm.specification.name = Java Virtual Machine Specification<br>java.runtime.version = 1.8.0_241-b07<br>java.awt.graphicsenv = sun.awt.X11GraphicsEnvironment<br>os.arch = amd64<br>java.endorsed.dirs = /usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/lib/endorsed<br>java.io.tmpdir = /tmp<br>line.separator = <br><br>java.vm.specification.vendor = Oracle Corporation<br>os.name = Linux<br>sun.jnu.encoding = UTF-8<br>java.library.path = /usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib<br>java.specification.name = Java Platform API Specification<br>java.class.version = 52.0<br>sun.management.compiler = HotSpot 64-Bit Tiered Compilers<br>os.version = 4.18.0-240.el8.x86_64<br>user.home = /root<br>user.timezone = <br>java.awt.printerjob = sun.print.PSPrinterJob<br>file.encoding = UTF-8<br>java.specification.version = 1.8<br>user.name = root<br>java.class.path = /usr/<span class="hljs-built_in">local</span>//jdk/lib/:/usr/<span class="hljs-built_in">local</span>//jdk/jre/lib/:.<br>java.vm.specification.version = 1.8<br>sun.arch.data.model = 64<br>sun.java.command = HelloWorld<br>java.home = /usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre<br>user.language = en<br>java.specification.vendor = Oracle Corporation<br>awt.toolkit = sun.awt.X11.XToolkit<br>java.vm.info = mixed mode<br>java.version = 1.8.0_241<br>java.ext.dirs = /usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/lib/ext:/usr/java/packages/lib/ext<br>sun.boot.class.path = /usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/lib/resources.jar:/usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/lib/rt.jar:/usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/lib/sunrsasign.jar:/usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/lib/jsse.jar:/usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/lib/jce.jar:/usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/lib/charsets.jar:/usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/lib/jfr.jar:/usr/<span class="hljs-built_in">local</span>/jdk1.8.0_241/jre/classes<br>java.vendor = Oracle Corporation<br>file.separator = /<br>java.vendor.url.bug = http://bugreport.sun.com/bugreport/<br>sun.io.unicode.encoding = UnicodeLittle<br>sun.cpu.endian = little<br>sun.cpu.isalist = <br><br>VM Flags:<br>Non-default VM flags: -XX:CICompilerCount=2 -XX:InitialHeapSize=16777216 -XX:MaxHeapSize=247463936 -XX:MaxNewSize=82444288 -XX:MinHeapDeltaBytes=196608 -XX:NewSize=5570560 -XX:OldSize=11206656 -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseFastUnorderedTimeStamps <br>Command line:  <br><br>[root@tomcat ~]<span class="hljs-comment"># jinfo -flags 21407</span><br>Attaching to process ID 21407, please <span class="hljs-built_in">wait</span>...<br>Debugger attached successfully.<br>Server compiler detected.<br>JVM version is 25.241-b07<br>Non-default VM flags: -XX:CICompilerCount=2 -XX:InitialHeapSize=268435456 -<br>XX:MaxHeapSize=536870912 -XX:MaxNewSize=178913280 -XX:MinHeapDeltaBytes=196608 -<br>XX:NewSize=89456640 -XX:OldSize=178978816 -XX:+UseCompressedClassPointers -<br>XX:+UseCompressedOops -XX:+UseFastUnorderedTimeStamps<br>Command line:  -Xms256m -Xmx512m<br></code></pre></td></tr></table></figure>

<h3 id="8-3-4-jstat"><a href="#8-3-4-jstat" class="headerlink" title="8.3.4 jstat"></a>8.3.4 jstat</h3><p>输出指定的java进程的统计信息</p>
<p>格式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash">jstat -<span class="hljs-built_in">help</span>|-options<br>jstat -&lt;option&gt; [-t] [-h&lt;lines&gt;] &lt;vmid&gt; [&lt;interval&gt; [&lt;count&gt;]]<br>[&lt;interval&gt; [&lt;count&gt;]]<br>interval：时间间隔，单位是毫秒；<br>count：显示的次数；<br><br><span class="hljs-comment">#返回可用统计项列表</span><br><span class="hljs-comment"># jstat -options</span><br>  -class：class loader<br>  -compiler：JIT<br>  -gc：gc<br>  -gccapacity：统计堆中各代的容量<br>  -gccause：<br>  -gcmetacapacity<br>  -gcnew：新生代<br>  -gcnewcapacity<br>  -gcold：老年代<br>  -gcoldcapacity<br>  -gcutil<br>  -printcompilation<br>  <br>S0C: Current survivor space 0 capacity (kB).<br>S1C: Current survivor space 1 capacity (kB).<br>S0U: Survivor space 0 utilization (kB).<br>S1U: Survivor space 1 utilization (kB).<br>EC: Current eden space capacity (kB).<br>EU: Eden space utilization (kB).<br>OC: Current old space capacity (kB).<br>OU: Old space utilization (kB).<br>MC: Metaspace capacity (kB).<br>MU: Metacspace utilization (kB).<br>CCSC: Compressed class space capacity (kB).<br>CCSU: Compressed class space used (kB).<br>YGC: Number of young generation garbage collection events.<br>YGCT: Young generation garbage collection time.<br>FGC: Number of full GC events.<br>FGCT: Full garbage collection time.<br>GCT: Total garbage collection time.<br><br>TT: Tenuring threshold.<br>MTT: Maximum tenuring threshold.<br>DSS: Desired survivor size (kB).<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@tomcat ~]<span class="hljs-comment"># jstat -gc 40830</span><br> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   <br>512.0  512.0   0.0    0.0    4416.0   442.1    10944.0      0.0     4480.0 780.9  384.0   76.6       0    0.000   0      0.000    0.000<br><br>S0C:S0区容量<br>YGC：新生代的垃圾回收次数<br>YGCT：新生代垃圾回收消耗的时长；<br>FGC：Full GC的次数<br>FGCT：Full GC消耗的时长<br>GCT：GC消耗的总时长<br><br><span class="hljs-comment">#3次，一秒一次</span><br>[root@tomcat ~]<span class="hljs-comment"># jstat -gcnew 40830 1000 3</span><br> S0C    S1C    S0U    S1U   TT MTT  DSS      EC       EU     YGC     YGCT  <br> 512.0  512.0    0.0    0.0 15  15    0.0   4416.0    442.1      0    0.000<br> 512.0  512.0    0.0    0.0 15  15    0.0   4416.0    442.1      0    0.000<br> 512.0  512.0    0.0    0.0 15  15    0.0   4416.0    442.1      0    0.000<br></code></pre></td></tr></table></figure>

<h3 id="8-3-5-jstack"><a href="#8-3-5-jstack" class="headerlink" title="8.3.5 jstack"></a>8.3.5 jstack</h3><p>程序员常用堆栈情况查看工具</p>
<p>jstack：查看指定的java进程的线程栈的相关信息</p>
<p>格式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">jstack [-l] &lt;pid&gt;<br>jstack -F [-m] [-l] &lt;pid&gt;<br>-l：long listings，会显示额外的锁信息，因此，发生死锁时常用此选项<br>-m：混合模式，既输出java堆栈信息，也输出C/C++堆栈信息<br>-F：当使用<span class="hljs-string">&quot;jstack -l PID&quot;</span>无响应，可以使用-F强制输出信息<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先获得一个java进程PID，然后jinfo</span><br>[root@tomcat ~]<span class="hljs-comment"># jstack -l 40830</span><br>2021-08-14 16:59:04<br>Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.241-b07 mixed mode):<br><br><span class="hljs-string">&quot;Attach Listener&quot;</span> <span class="hljs-comment">#8 daemon prio=9 os_prio=0 tid=0x00007fd0a4001000 nid=0xa001 waiting on condition [0x0000000000000000]</span><br>   java.lang.Thread.State: RUNNABLE<br><br>   Locked ownable synchronizers:<br>	- None<br><br><span class="hljs-string">&quot;Service Thread&quot;</span> <span class="hljs-comment">#7 daemon prio=9 os_prio=0 tid=0x00007fd0c80b8800 nid=0x9f86 runnable [0x0000000000000000]</span><br>   java.lang.Thread.State: RUNNABLE<br><br>   Locked ownable synchronizers:<br>	- None<br><br><span class="hljs-string">&quot;C1 CompilerThread1&quot;</span> <span class="hljs-comment">#6 daemon prio=9 os_prio=0 tid=0x00007fd0c80b5800 nid=0x9f85 waiting on condition [0x0000000000000000]</span><br>   java.lang.Thread.State: RUNNABLE<br><br>   Locked ownable synchronizers:<br>	- None<br><br><span class="hljs-string">&quot;C2 CompilerThread0&quot;</span> <span class="hljs-comment">#5 daemon prio=9 os_prio=0 tid=0x00007fd0c80b3800 nid=0x9f84 waiting on condition [0x0000000000000000]</span><br>   java.lang.Thread.State: RUNNABLE<br><br>   Locked ownable synchronizers:<br>	- None<br><br><span class="hljs-string">&quot;Signal Dispatcher&quot;</span> <span class="hljs-comment">#4 daemon prio=9 os_prio=0 tid=0x00007fd0c80b2000 nid=0x9f83 runnable [0x0000000000000000]</span><br>   java.lang.Thread.State: RUNNABLE<br><br>   Locked ownable synchronizers:<br>	- None<br><br><span class="hljs-string">&quot;Finalizer&quot;</span> <span class="hljs-comment">#3 daemon prio=8 os_prio=0 tid=0x00007fd0c807d000 nid=0x9f82 in Object.wait() [0x00007fd0cc71b000]</span><br>   java.lang.Thread.State: WAITING (on object monitor)<br>	at java.lang.Object.wait(Native Method)<br>	- waiting on &lt;0x00000000f1408ee0&gt; (a java.lang.ref.ReferenceQueue<span class="hljs-variable">$Lock</span>)<br>	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)<br>	- locked &lt;0x00000000f1408ee0&gt; (a java.lang.ref.ReferenceQueue<span class="hljs-variable">$Lock</span>)<br>	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)<br>	at java.lang.ref.Finalizer<span class="hljs-variable">$FinalizerThread</span>.run(Finalizer.java:216)<br><br>   Locked ownable synchronizers:<br>	- None<br><br><span class="hljs-string">&quot;Reference Handler&quot;</span> <span class="hljs-comment">#2 daemon prio=10 os_prio=0 tid=0x00007fd0c8078800 nid=0x9f81 in Object.wait() [0x00007fd0cc81c000]</span><br>   java.lang.Thread.State: WAITING (on object monitor)<br>	at java.lang.Object.wait(Native Method)<br>	- waiting on &lt;0x00000000f1406c00&gt; (a java.lang.ref.Reference<span class="hljs-variable">$Lock</span>)<br>	at java.lang.Object.wait(Object.java:502)<br>	at java.lang.ref.Reference.tryHandlePending(Reference.java:191)<br>	- locked &lt;0x00000000f1406c00&gt; (a java.lang.ref.Reference<span class="hljs-variable">$Lock</span>)<br>	at java.lang.ref.Reference<span class="hljs-variable">$ReferenceHandler</span>.run(Reference.java:153)<br><br>   Locked ownable synchronizers:<br>	- None<br><br><span class="hljs-string">&quot;main&quot;</span> <span class="hljs-comment">#1 prio=5 os_prio=0 tid=0x00007fd0c800a800 nid=0x9f7f waiting on condition [0x00007fd0d0cd7000]</span><br>   java.lang.Thread.State: TIMED_WAITING (sleeping)<br>	at java.lang.Thread.sleep(Native Method)<br>	at HelloWorld.main(HelloWorld.java:5)<br><br>   Locked ownable synchronizers:<br>	- None<br><br><span class="hljs-string">&quot;VM Thread&quot;</span> os_prio=0 tid=0x00007fd0c806f000 nid=0x9f80 runnable <br><br><span class="hljs-string">&quot;VM Periodic Task Thread&quot;</span> os_prio=0 tid=0x00007fd0c80bb800 nid=0x9f87 waiting on condition <br><br>JNI global references: 5<br></code></pre></td></tr></table></figure>

<h3 id="8-3-6-jmap"><a href="#8-3-6-jmap" class="headerlink" title="8.3.6 jmap"></a>8.3.6 jmap</h3><p>Memory Map, 用于查看堆内存的使用状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看进程堆内存情况</span><br>[root@tomcat ~]<span class="hljs-comment"># jmap -heap 40830</span><br>Attaching to process ID 40830, please <span class="hljs-built_in">wait</span>...<br>Debugger attached successfully.<br>Server compiler detected.<br>JVM version is 25.241-b07<br><br>using thread-local object allocation.<br>Mark Sweep Compact GC<br><br>Heap Configuration:<br>   MinHeapFreeRatio         = 40<br>   MaxHeapFreeRatio         = 70<br>   MaxHeapSize              = 247463936 (236.0MB)<br>   NewSize                  = 5570560 (5.3125MB)<br>   MaxNewSize               = 82444288 (78.625MB)<br>   OldSize                  = 11206656 (10.6875MB)<br>   NewRatio                 = 2<br>   SurvivorRatio            = 8<br>   MetaspaceSize            = 21807104 (20.796875MB)<br>   CompressedClassSpaceSize = 1073741824 (1024.0MB)<br>   MaxMetaspaceSize         = 17592186044415 MB<br>   G1HeapRegionSize         = 0 (0.0MB)<br><br>Heap Usage:<br>New Generation (Eden + 1 Survivor Space):<br>   capacity = 5046272 (4.8125MB)<br>   used     = 724568 (0.6910018920898438MB)<br>   free     = 4321704 (4.121498107910156MB)<br>   14.358480874594155% used<br>Eden Space:<br>   capacity = 4521984 (4.3125MB)<br>   used     = 724568 (0.6910018920898438MB)<br>   free     = 3797416 (3.6214981079101562MB)<br>   16.023232280344203% used<br>From Space:<br>   capacity = 524288 (0.5MB)<br>   used     = 0 (0.0MB)<br>   free     = 524288 (0.5MB)<br>   0.0% used<br>To Space:<br>   capacity = 524288 (0.5MB)<br>   used     = 0 (0.0MB)<br>   free     = 524288 (0.5MB)<br>   0.0% used<br>tenured generation:<br>   capacity = 11206656 (10.6875MB)<br>   used     = 0 (0.0MB)<br>   free     = 11206656 (10.6875MB)<br>   0.0% used<br><br>710 interned Strings occupying 47368 bytes.<br></code></pre></td></tr></table></figure>

<h3 id="8-3-7-jhat"><a href="#8-3-7-jhat" class="headerlink" title="8.3.7 jhat"></a>8.3.7 jhat</h3><p>Java Heap Analysis Tool 堆分析工具</p>
<p>格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">jmap [option] &lt;pid&gt;<br><span class="hljs-comment">#查看堆空间的详细信息：</span><br>jmap -heap &lt;pid&gt;<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@t1 ~]<span class="hljs-comment"># jmap -heap 96334</span><br>Attaching to process ID 96334, please <span class="hljs-built_in">wait</span>...<br>Debugger attached successfully.<br>Server compiler detected.<br>JVM version is 25.251-b08<br><br>using thread-local object allocation.<br>Mark Sweep Compact GC<br><br>Heap Configuration:<br> MinHeapFreeRatio     = 40<br> MaxHeapFreeRatio     = 70<br> MaxHeapSize        = 251658240 (240.0MB)<br> NewSize          = 5570560 (5.3125MB)<br> MaxNewSize        = 83886080 (80.0MB)<br> OldSize          = 11206656 (10.6875MB)<br> <br><span class="hljs-comment">#查看堆内存中的对象的数目：</span><br>jmap -histo[:live] &lt;pid&gt;<br>live：只统计活动对象；<br><br><span class="hljs-comment">#保存堆内存数据至文件中，而后使用jvisualvm或jhat进行查看：</span><br>jmap -dump:&lt;dump-options&gt; &lt;pid&gt;<br>dump-options:<br>live  dump only live objects; <span class="hljs-keyword">if</span> not specified, all objects <span class="hljs-keyword">in</span> the heap are<br>dumped.<br>format=b   binary format<br>file=&lt;file&gt; dump heap to &lt;file&gt;<br></code></pre></td></tr></table></figure>

<h3 id="8-3-8-jconsole"><a href="#8-3-8-jconsole" class="headerlink" title="8.3.8 jconsole"></a>8.3.8 jconsole</h3><p>图形化工具,可以用来查看Java进程信息</p>
<p>JMX（Java Management Extensions，即Java管理扩展）是一个为应用程序、设备、系统等植入管理功能的框架。JMX可以跨越一系列异构操作系统平台、系统体系结构和网络传输协议，灵活的开发无缝集成的系统、网络和服务管理应用。</p>
<p>JMX最常见的场景是监控Java程序的基本信息和运行情况，任何Java程序都可以开启JMX，然后使用JConsole或Visual VM进行预览。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#为Java程序开启JMX很简单，只要在运行Java程序的命令后面指定如下命令即可</span><br>-Djava.rmi.server.hostname=127.0.0.1<br>-Dcom.sun.management.jmxremote.port=1000<br>-Dcom.sun.management.jmxremote.ssl=<span class="hljs-literal">false</span><br>-Dcom.sun.management.jmxremote.authenticate=<span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<p>在 tomcat 开启远程 JMX 如下配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /usr/<span class="hljs-built_in">local</span>/tomcat/bin/catalina.sh<br>CATALINA_OPTS=<span class="hljs-string">&quot;<span class="hljs-variable">$CATALINA__OPTS</span></span><br><span class="hljs-string">-Dcom.sun.management.jmxremote     #启用远程监控JMX</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.port=XXXXX    #默认启动的JMX端口号，要和</span><br><span class="hljs-string">zabbix添加主机时候的端口一致即可</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.authenticate=false   #不使用用户名密码</span><br><span class="hljs-string">-Dcom.sun.management.jmxremote.ss1=false    #不使用ssl认证</span><br><span class="hljs-string">-Djava.rmi.server.hostname=&lt;JAVA主机IP&gt;&quot;</span>   <span class="hljs-comment">#tomcat主机自己的IP地址,不要写zabbix服务器的地址</span><br></code></pre></td></tr></table></figure>

<p>下图是使用Jconsle通过JMX查看Java程序的运行信息</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat198.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat199.png" srcset="/blog/img/loading.gif"></p>
<p>范例: 开启远程JMX功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@tomcat ~]<span class="hljs-comment"># vim /usr/local/tomcat/bin/catalina.sh</span><br>.......<br><span class="hljs-comment"># -----------------------------------------------------------------------------</span><br>CATALINA_OPTS=<span class="hljs-string">&quot;<span class="hljs-variable">$CATALINA__OPTS</span> -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=12345 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=10.0.0.202&quot;</span><br><span class="hljs-comment"># OS specific support. $var _must_ be set to either true or false.</span><br>.......<br><br>[root@tomcat ~]<span class="hljs-comment"># systemctl restart tomcat</span><br>[root@tomcat ~]<span class="hljs-comment"># ss -ntl</span><br>State          Recv-Q         Send-Q                        Local Address:Port                    Peer Address:Port         <br>LISTEN         0              128                                 0.0.0.0:22                           0.0.0.0:*            <br>LISTEN         0              5                                 127.0.0.1:631                          0.0.0.0:*            <br>LISTEN         0              128                                 0.0.0.0:11211                        0.0.0.0:*            <br>LISTEN         0              128                                 0.0.0.0:111                          0.0.0.0:*            <br>LISTEN         0              50                                        *:43601                              *:*            <br>LISTEN         0              128                                    [::]:22                              [::]:*            <br>LISTEN         0              5                                     [::1]:631                             [::]:*            <br>LISTEN         0              50                                        *:12345                              *:*            <br>LISTEN         0              50                                        *:45019                              *:*            <br>LISTEN         0              1                        [::ffff:127.0.0.1]:8005                               *:*            <br>LISTEN         0              100                                       *:8009                               *:*            <br>LISTEN         0              128                                    [::]:11211                           [::]:*            <br>LISTEN         0              128                                    [::]:111                             [::]:*            <br>LISTEN         0              100                                       *:8080                               *:*<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat200.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat201.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat202.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/tomcat/tomcat203.png" srcset="/blog/img/loading.gif"></p>
<h2 id="8-4-Tomcat-性能优化常用配置"><a href="#8-4-Tomcat-性能优化常用配置" class="headerlink" title="8.4 Tomcat 性能优化常用配置"></a>8.4 Tomcat 性能优化常用配置</h2><h3 id="8-4-1-内存空间优化"><a href="#8-4-1-内存空间优化" class="headerlink" title="8.4.1 内存空间优化"></a>8.4.1 内存空间优化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">JAVA_OPTS=<span class="hljs-string">&quot;-server -Xms4g -Xmx4g -XX:NewSize= -XX:MaxNewSize= &quot;</span><br><br>-server：服务器模式<br>-Xms：堆内存初始化大小<br>-Xmx：堆内存空间上限<br>-XX:NewSize=：新生代空间初始化大小<br>-XX:MaxNewSize=：新生代空间最大值<br></code></pre></td></tr></table></figure>

<p><strong>生产案例：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># vim /usr/local/tomcat/bin/catalina.sh</span><br>JAVA_OPTS=<span class="hljs-string">&quot;-server -Xms4g -Xmx4g -Xss512k -Xmn1g -XX:CMSInitiatingOccupancyFraction=65 -XX:+AggressiveOpts -XX:+UseBiasedLocking -XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10 -XX:NewRatio=2 -XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5 -XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods&quot;</span><br><br><span class="hljs-comment">#一台tomcat服务器并发连接数不高,生产建议分配物理内存通常4G到8G较多,如果需要更多连接,一般会利用虚拟化技术实现多台tomcat</span><br></code></pre></td></tr></table></figure>

<h3 id="8-4-2-线程池调整"><a href="#8-4-2-线程池调整" class="headerlink" title="8.4.2 线程池调整"></a>8.4.2 线程池调整</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># vim /usr/local/tomcat/conf/server.xml</span><br>......<br>&lt;Connector port=<span class="hljs-string">&quot;8080&quot;</span> protocol=<span class="hljs-string">&quot;HTTP/1.1&quot;</span>  connectionTimeout=<span class="hljs-string">&quot;20000&quot;</span><br>redirectPort=<span class="hljs-string">&quot;8443&quot;</span> /&gt;<br>......<br></code></pre></td></tr></table></figure>

<p>常用属性：</p>
<ul>
<li>connectionTimeout ：连接超时时长,单位ms</li>
<li>maxThreads：最大线程数，默认200</li>
<li>minSpareThreads：最小空闲线程数</li>
<li>maxSpareThreads：最大空闲线程数</li>
<li>acceptCount：当启动线程满了之后，等待队列的最大长度，默认100</li>
<li>URIEncoding：URI 地址编码格式，建议使用 UTF-8</li>
<li>enableLookups：是否启用客户端主机名的DNS反向解析，缺省禁用，建议禁用，就使用客户端IP就行</li>
<li>compression：是否启用传输压缩机制，建议 “on”，CPU和流量的平衡<ul>
<li>compressionMinSize：启用压缩传输的数据流最小值，单位是字节</li>
<li>compressableMimeType：定义启用压缩功能的MIME类型text/html, text/xml, text/css, text/javascript</li>
</ul>
</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/linux-tomcat/">linux tomcat</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1Zabbix/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">企业级监控服务Zabbix</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis/">
                        <span class="hidden-mobile">企业级NoSQL数据库Redis</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
