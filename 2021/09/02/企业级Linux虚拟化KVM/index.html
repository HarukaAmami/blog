

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>企业级Linux虚拟化KVM - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="企业级Linux虚拟化KVM">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-02 14:23" pubdate>
        2021年9月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      47.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      720
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">企业级Linux虚拟化KVM</h1>
            
            <div class="markdown-body">
              <h1 id="企业级Linux虚拟化KVM"><a href="#企业级Linux虚拟化KVM" class="headerlink" title="企业级Linux虚拟化KVM"></a>企业级Linux虚拟化KVM</h1><h1 id="一、虚拟化基础"><a href="#一、虚拟化基础" class="headerlink" title="一、虚拟化基础"></a>一、虚拟化基础</h1><h2 id="1-1-传统的物理机部署方案"><a href="#1-1-传统的物理机部署方案" class="headerlink" title="1.1 传统的物理机部署方案"></a>1.1 传统的物理机部署方案</h2><p>IDC选择,如:联通,电信,世纪互联,鹏博士等</p>
<ul>
<li>服务器选型及采购</li>
<li>服务器系统选择、系统安装、上架</li>
<li>应用规划及部署</li>
<li>域名选择及注册</li>
<li>DNS配置映射</li>
<li>测试外网访问</li>
</ul>
<p><strong>传统数据中心面临的问题：</strong></p>
<ul>
<li>服务器和网络设备资源利用率过低，并且无法共享,导致资源浪费据统计大部分数据中心中的服务器和网络设备的利用率仅在24%～30%之间，有的CPU利用率、硬盘利用率都在10%以下</li>
<li>资源分配后进行调整困难资源分配不合理也是传统网络架构存在的问题，因为资源不能动态调配，分配出去的资源是固定的，不能随意添加或删除。</li>
<li>难以实现自动化，初始化成本高,服务器迁移和升级很繁琐，无法实现自动化</li>
<li>成本高昂，集群环境需要大量的服务器主机,硬件投入和后期维护管理成本巨大</li>
</ul>
<h2 id="1-2-虚拟化和虚拟机"><a href="#1-2-虚拟化和虚拟机" class="headerlink" title="1.2 虚拟化和虚拟机"></a>1.2 虚拟化和虚拟机</h2><h3 id="1-2-1-虚拟化"><a href="#1-2-1-虚拟化" class="headerlink" title="1.2.1 虚拟化"></a>1.2.1 虚拟化</h3><p>参考资料: <a target="_blank" rel="noopener" href="https://www.vmware.com/cn/solutions/virtualization.html">https://www.vmware.com/cn/solutions/virtualization.html</a></p>
<h4 id="1-2-1-1-什么是虚拟化"><a href="#1-2-1-1-什么是虚拟化" class="headerlink" title="1.2.1.1 什么是虚拟化"></a>1.2.1.1 什么是虚拟化</h4><p>在计算机技术中，虚拟化（Virtualization）是一种资源管理技术，是将计算机的各种实体资源（CPU、内存、磁盘空间、网络适配器等），予以抽象、转换后呈现出来并可供分割、组合为一个或多个计算机配置环境，并重新分割、重新组合，以达到最大化合理利用物理资源的目的。</p>
<h5 id="2-1-2-1-2-虚拟化优势"><a href="#2-1-2-1-2-虚拟化优势" class="headerlink" title="2.1.2.1.2 虚拟化优势"></a>2.1.2.1.2 虚拟化优势</h5><p>虚拟化可以提高 IT 敏捷性、灵活性和可扩展性，同时大幅节约成本。更高的工作负载移动性、更高的性能和资源可用性、自动化运维 - 这些都是虚拟化的优势，虚拟化技术可以使 IT 部门更轻松地进行管理以及降低拥有成本和运维成本。其优势包括：</p>
<ul>
<li>资源超分,如物理内存128G,可以给虚拟机分配200G内存</li>
<li>降低资金成本和运维成本</li>
<li>最大限度减少或消除停机</li>
<li>提高 IT 部门的工作效率、效益、敏捷性和响应能力</li>
<li>加快应用和资源的调配速度</li>
<li>提高业务连续性和灾难恢复能力</li>
<li>简化数据中心管理</li>
<li>真正的 Software-Defined Data Center 的可用性</li>
<li>减少端口的冲突<h4 id="1-2-1-3-虚拟化的发展史"><a href="#1-2-1-3-虚拟化的发展史" class="headerlink" title="1.2.1.3 虚拟化的发展史"></a>1.2.1.3 虚拟化的发展史</h4><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm1.png" srcset="/blog/img/loading.gif"></li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1959</span>年，计算机科学家Christopher Strachey发表了一篇名为《大型高速计算机中的时间共享》（TimeSharing in Large Fast Computers）的学术报告，他在文中首次提出了虚拟化的基本概念，被认为是虚拟化技术的最早论述<br><br><span class="hljs-attribute">1964</span>年，IBM推出了专为 System/<span class="hljs-number">360</span> Mainframe 量身订造的操作系统 CP-<span class="hljs-number">40</span>，首次实现了虚拟内存和虚拟机。<br><br><span class="hljs-attribute">1967</span>年，第一个管理程序(hypervisor)诞生，<span class="hljs-number">5</span>年之后，IBM 发布用于创建灵活大型主机的虚拟机(VM)技术，该技术可根据动态的需求快速而有效地使用各种资源。从此，虚拟化这一词汇正式被引入了IT的现实世界。<br><br><span class="hljs-attribute">20</span>世纪<span class="hljs-number">70</span>年代的 System <span class="hljs-number">370</span> 系列中通过虚拟机监控器（Virtual Machine Monitor，VMM）的程序在物理硬件之上生成多个可以独立运行操作系统软件的虚拟机实例<br><br><span class="hljs-attribute">20</span>世纪 <span class="hljs-number">90</span> 年代 Windows 的广泛使用以及 Linux 作为服务器系统的出现奠定了 x<span class="hljs-number">86</span> 服务器的行业标准地位。<br><br><span class="hljs-attribute">1998</span>年VMware公司在美国成立，<span class="hljs-number">1999</span>年VMware发布了它的第一款产品VMware Workstation、 <span class="hljs-number">2001</span>年发布VMware GSX Server和VMware ESXI Server宣布进入服务器虚拟化市场， <span class="hljs-number">2003</span>年VMware推出了VMware Virtual Center， <span class="hljs-number">2004</span>年推出了<span class="hljs-number">64</span>位支持版本，同年被EMC收购，<span class="hljs-number">2013</span>年收入<span class="hljs-number">52</span>.<span class="hljs-number">1</span>亿美元。<br><br><span class="hljs-attribute">2015</span>年<span class="hljs-number">10</span>月<span class="hljs-number">12</span>日，戴尔与数据存储公司EMC的并购宣布完成，最终戴尔以<span class="hljs-number">670</span>亿美元收购了EMC<br><br><span class="hljs-attribute">2003</span>年，Xen实现半虚拟化<br><br><span class="hljs-attribute">2005</span>年，HVM硬件辅助的虚拟化，Intel VT-x，AMD-V<br><br><span class="hljs-attribute">2005</span>年，openVZ出现，在linux平台上的容器化技术实现<br><br><span class="hljs-attribute">2006</span>年，QEMU<br><br><span class="hljs-attribute">2007</span>年，KVM（Kernel-based Virtual Machine）基于内核Linux <span class="hljs-number">2</span>.<span class="hljs-number">6</span>.<span class="hljs-number">20</span><br><br><span class="hljs-attribute">2007</span>年<span class="hljs-number">8</span>月<span class="hljs-number">21</span>日，思杰宣布<span class="hljs-number">5</span>亿美元收购XenSource公司，并推出服务器虚拟化XenServer、桌面虚拟化XenDesktop和应用虚拟化XenApp，<span class="hljs-number">2013</span>年收入<span class="hljs-number">29</span>亿美元。<br><br><span class="hljs-attribute">2008</span>年，LXC发布<br><br><span class="hljs-attribute">2008</span>年<span class="hljs-number">3</span>月<span class="hljs-number">13</span>日微软在北京发布Windows Server <span class="hljs-number">2008</span>，内置虚拟化技术hyper-v。<br><br><span class="hljs-attribute">2008</span>年<span class="hljs-number">9</span>月，红帽以<span class="hljs-number">1</span>.<span class="hljs-number">07</span>亿美元的价格收购KVM的以色列母公司Qumranet，并推出企业级虚拟化解决方案RHEV，目前最新版本<span class="hljs-number">3</span>.<span class="hljs-number">3</span>，<span class="hljs-number">2013</span>年收入超过<span class="hljs-number">13</span>亿美元<br><br><span class="hljs-attribute">2013</span>年，docker发布<br><br><span class="hljs-attribute">2017</span>年<span class="hljs-number">11</span>月全球最大公有云厂商AWS宣布了全新的C<span class="hljs-number">5</span>实例，该实例完全基于新的虚拟机监控程序（Hypervisor）：KVM。在之前的<span class="hljs-number">11</span>年里，AWS的所有虚拟化实例都是基于XEN技术实现的。也就是说AWS也开始转向了KVM之路而不再坚持使用从其诞生之日起一直使用的XEN技术,事实上国内的阿里云早在<span class="hljs-number">2015</span>年就开始从XEN切换到KVM<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm2.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-2-2-虚拟机"><a href="#1-2-2-虚拟机" class="headerlink" title="1.2.2 虚拟机"></a>1.2.2 虚拟机</h3><h4 id="1-2-2-1-虚拟机"><a href="#1-2-2-1-虚拟机" class="headerlink" title="1.2.2.1 虚拟机"></a>1.2.2.1 虚拟机</h4><p>虚拟计算机称为“虚拟机”(VM,Virtual Machine)，它是一种严密隔离且内含操作系统和应用的软件容器。每个虚拟机都是完全独立的。通过将多台虚拟机放置在一台物理计算机上，可仅在一台物理服务器或“主机”上运行多个操作系统和应用，名为“hypervisor”的精简软件层可将虚拟机与主机分离开来，并根据需要为每个虚拟机动态分配计算资源。</p>
<h5 id="2-1-2-2-2-虚拟机的主要特性"><a href="#2-1-2-2-2-虚拟机的主要特性" class="headerlink" title="2.1.2.2.2 虚拟机的主要特性"></a>2.1.2.2.2 虚拟机的主要特性</h5><p>虚拟机具有以下特征，这些特征可提供多项优势</p>
<p><strong>分区</strong></p>
<p>可在一台物理机上运行多个操作系统</p>
<p>可在虚拟机之间分配系统资源。</p>
<p><strong>隔离</strong></p>
<p>可在硬件级别进行故障和安全隔离。</p>
<p>可利用高级资源控制功能保持性能</p>
<p><strong>封装</strong></p>
<p>可将虚拟机的完整状态保存到文件中。</p>
<p>移动和复制虚拟机就像移动和复制文件一样轻松</p>
<p><strong>独立于硬件</strong></p>
<p>可将任意虚拟机调配或迁移到任意物理服务器上</p>
<p>安装系统不会受硬件兼容性的影响</p>
<h2 id="1-3-虚拟化类型"><a href="#1-3-虚拟化类型" class="headerlink" title="1.3 虚拟化类型"></a>1.3 虚拟化类型</h2><h3 id="1-3-1-服务器虚拟化"><a href="#1-3-1-服务器虚拟化" class="headerlink" title="1.3.1 服务器虚拟化"></a>1.3.1 服务器虚拟化</h3><p>服务器虚拟化支持将多个操作系统作为高效的虚拟机在单个物理服务器上运行。主要优势包括：</p>
<ul>
<li>提升 IT 效率</li>
<li>降低运维成本</li>
<li>更快地部署工作负载</li>
<li>提高应用性能</li>
<li>提高服务器可用性</li>
<li>消除服务器数量剧增情况和复杂性</li>
</ul>
<h3 id="1-3-2-网络虚拟化"><a href="#1-3-2-网络虚拟化" class="headerlink" title="1.3.2 网络虚拟化"></a>1.3.2 网络虚拟化</h3><p>通过软件定义网络(Software Defined Network，SDN)，即网络的创建不再依赖于物理设备，如公有云厂商允许用户自己创建新的网络，在 kubernetes、openstack中都会使用到网络虚拟化。</p>
<h3 id="1-3-3-桌面虚拟化"><a href="#1-3-3-桌面虚拟化" class="headerlink" title="1.3.3 桌面虚拟化"></a>1.3.3 桌面虚拟化</h3><p>将桌面部署为代管服务,使 IT 组织能够更快地响应不断变化的工作场所需求和新出现的机会。还可以将虚拟化桌面和应用快速、轻松地交付给分支机构、外包和离岸员工以及使用 iPad 和 Android 平板电脑的移动员工。</p>
<p>Citrix 思杰公司在云计算虚拟化、虚拟桌面和远程接入技术领域的处于优势地位</p>
<h3 id="1-3-4-应用虚拟化"><a href="#1-3-4-应用虚拟化" class="headerlink" title="1.3.4 应用虚拟化"></a>1.3.4 应用虚拟化</h3><p>将软件虚拟化，比如 office 365,钉钉,企业微信</p>
<h3 id="1-3-5-存储虚拟化"><a href="#1-3-5-存储虚拟化" class="headerlink" title="1.3.5 存储虚拟化"></a>1.3.5 存储虚拟化</h3><p>SAN(基于磁盘)/NAS(NFS/Samba)/GlusterFS/ceph等</p>
<h3 id="1-3-6-库虚拟化"><a href="#1-3-6-库虚拟化" class="headerlink" title="1.3.6 库虚拟化"></a>1.3.6 库虚拟化</h3><p>在linux上运行windows 程序使用 wine，在mac系统运行windows程序使用CrossOver等</p>
<h3 id="1-3-7-容器虚技术"><a href="#1-3-7-容器虚技术" class="headerlink" title="1.3.7 容器虚技术"></a>1.3.7 容器虚技术</h3><p>被称为下一代虚拟化技术，典型代表: Docker、Podman、Linux Container(LXC)、Pouch</p>
<h2 id="1-4-Hypervisor类型"><a href="#1-4-Hypervisor类型" class="headerlink" title="1.4 Hypervisor类型"></a>1.4 Hypervisor类型</h2><h3 id="1-4-1-Hypervisor-介绍"><a href="#1-4-1-Hypervisor-介绍" class="headerlink" title="1.4.1 Hypervisor 介绍"></a>1.4.1 Hypervisor 介绍</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm3.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li>Hypervisor是一种运行在基础物理服务器和操作系统之间的中间软件层，其可以允许多个操作系统和应用共享底层的内存、CPU、磁盘等物理硬件，也可叫做VMM（ virtual machinemonitor），即虚拟机监视器。</li>
<li>Hypervisor是所有虚拟化技术的核心，非中断地支持多工作负载迁移的能力是Hypervisor的基本功能，当服务器启动并执行Hypervisor时，它会给每一台虚拟机分配适量的内存、CPU、网络和磁盘，并加载所有虚拟机的客户操作系统。</li>
<li>多数的虚拟化而采用虚拟机管理程序Hypervisor</li>
<li>允许多种操作系统在相同的物理系统中运行</li>
<li>控制硬件并向来宾操作系统提供访问底层硬件的途径</li>
<li>向来宾操作系统提供虚拟化的硬件</li>
</ul>
<p><strong>X86 CPU 的保护环</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm4.png" srcset="/blog/img/loading.gif"></p>
<p><strong>注意</strong>：CPU为了保证程序代码执行的安全性、多用户的独立性、保护OS的正常运行，提出了CPU执行状态的概念。这样能够限制不同程序之间的访问能力，避免一个程序获取另一个程序的内存数据造成数据混乱，同时也避免了程序错误的操作物理硬件。一般CPU都会划分为 用户态 和内核态 ，x86的CPU架构更是细分为了Ring3~0四种状态。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm5.png" srcset="/blog/img/loading.gif"></p>
<p><strong>Ring3 用户态(User Mode)：</strong>运行在用户态的程序代码需要受到CPU的检查，用户态程序代码只能访问内存页表项中规定能被用户态程序代码访问的页面虚拟地址(受限的内存访问)，而且还只能访问任务描述符TSS中的I/O Permission Bitmap中规定能被用户态程序代码访问的端口。甚至不能直接访问外围硬件设备、不能抢占CPU。所有的应用程序都运行在用户态上。当运行在用户态的Application需要调用只能被核心态代码直接访问的硬件设备时，CPU会通过特别的接口去调用核心态的代码，以此来实现Application对硬件设备的调用。如果用户态的Application直接调用硬件设备时，就会被Host OS捕捉到并触发异常，弹出警告窗口。</p>
<p>**Ring0 核心态(Kernel Mode)**：是Host OS Kernel运行的模式，运行在核心态的代码可以无限制的对系统内存、设备驱动程序、网卡接口、显卡接口等外围硬件设备进行访问。只有Host OS能够无限制的访问磁盘、键盘等外围硬件设备的数据，但是首先需要在Host OS上安装驱动程序</p>
<h3 id="1-4-2-Hypervisor-分类"><a href="#1-4-2-Hypervisor-分类" class="headerlink" title="1.4.2 Hypervisor 分类"></a>1.4.2 Hypervisor 分类</h3><p>1974年Gerald J.Popek和Robert P.Goldberg的文章“Formal Requirements forVirtualizable Third Generation Architectures” 将Hypervisor分为两类:</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm6.png" srcset="/blog/img/loading.gif"></p>
<h4 id="1-4-2-1-类型-I-裸金属型"><a href="#1-4-2-1-类型-I-裸金属型" class="headerlink" title="1.4.2.1 类型 I : 裸金属型"></a>1.4.2.1 类型 I : 裸金属型</h4><p>直接运行到物理机的Hypervisor上，这种架构搭建的虚拟化环境称为裸机虚拟化环境(Bare-Metal<br>Hardware</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">KVM<br>XEN<br>vmware esxi<br>rhev hypervisor<br>Hyper-v Server<br><br><span class="hljs-comment">#Redhat将KVM划分到类型I即裸机型：</span><br>https://www.redhat.com/zh/topics/virtualization/what-is-KVM<br></code></pre></td></tr></table></figure>

<h4 id="1-4-2-2-类型-II-宿主型"><a href="#1-4-2-2-类型-II-宿主型" class="headerlink" title="1.4.2.2 类型 II : 宿主型"></a>1.4.2.2 类型 II : 宿主型</h4><p>即需要运行在具有虚拟化功能的操作系统上的Hypervisor，构建的是主机虚拟化环境(Hosted<br>Virtualization)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">vmware workstation<br>Microsoft Hyper-V<br>VirtualBox<br>paralles desktop <span class="hljs-comment">#Mac系统最强虚拟机技术</span><br></code></pre></td></tr></table></figure>

<h2 id="1-5-虚拟化技术分类"><a href="#1-5-虚拟化技术分类" class="headerlink" title="1.5 虚拟化技术分类"></a>1.5 虚拟化技术分类</h2><h3 id="1-5-1-模拟器-软件仿真"><a href="#1-5-1-模拟器-软件仿真" class="headerlink" title="1.5.1 模拟器/软件仿真"></a>1.5.1 模拟器/软件仿真</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm7.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li>通过软件模拟完整的硬件环境来虚拟化来宾平台。</li>
<li>可以模拟X86、ARM 、PowerPC等多种CPU</li>
<li>效率比较低</li>
<li>产品或方案:QEMU、Bochs、PearPC</li>
</ul>
<h3 id="1-5-2-全虚拟机化-full-virtualization-本地虚拟化-nativevirtualization"><a href="#1-5-2-全虚拟机化-full-virtualization-本地虚拟化-nativevirtualization" class="headerlink" title="1.5.2 全虚拟机化 full virtualization / 本地虚拟化 nativevirtualization"></a>1.5.2 全虚拟机化 full virtualization / 本地虚拟化 nativevirtualization</h3><p><strong>不需要对GuestOS操作系统软件的源代码做任何的修改，就可以运行在这样的VMM中</strong></p>
<p>在全虚拟化的虚拟平台中，GuestOS并不知道自己是一台虚拟机，它会认为自己就是运行在计算机物理硬件设备上的HostOS。全虚拟化的GuestOS具有完全的物理机特性。因为全虚拟化的VMM会将一个OS所能够操作的CPU、内存、外设等物理设备逻辑抽象成为虚拟CPU、虚拟内存、虚拟外设等虚拟设备后，再交由GuestOS来操作使用。这样的GuestOS会将底层硬件平台视为自己所有的，但是实际上，这些都是VMM为GuestOS制造了这种假象。</p>
<p>全虚拟化/本地虚拟化不做CPU和内存模拟，只对CPU和内存做相应的分配等操作</p>
<p>全虚拟化又分为：软件辅助的全虚拟化 &amp; 硬件辅助的全虚拟化</p>
<h4 id="1-5-2-1-软件辅助的全虚拟化"><a href="#1-5-2-1-软件辅助的全虚拟化" class="headerlink" title="1.5.2.1 软件辅助的全虚拟化"></a>1.5.2.1 软件辅助的全虚拟化</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm8.png" srcset="/blog/img/loading.gif"></p>
<p>在Intel等CPU厂商还没有发布x86 CPU虚拟化技术之前，完全虚拟化都是通过软件辅助的方式来实现的。</p>
<p>代表技术: Vmware Workstation,QEMU,Virtual PC</p>
<p>当使用GuestOS的时候，不可避免的会调用GuestOS中的虚拟设备驱动程序 和核心调度程序来操作硬件设备。与HostOS的不同在于，HostOS运行在CPU的核心态中，这就表示HostOS可以直接对硬件设备进行操作。但GuestOS作为一个运行在CPU用户态中应用程序，不能够直接的操作硬件设备。为了解决这个问题，VMM引用了两个机制——<strong>特权解除和陷入模拟。</strong></p>
<p>软件辅助的全虚拟化主要是应用了两种机制：</p>
<ul>
<li>特权解除：VMM、GuestOS、GuestApplications都是运行在Ring 1-3用户态中的应用程序代码.当GuestOS需要调用运行在核心态的指令时，VMM就会动态的将核心态指令捕获并调用若干运行在非核心态的指令来模拟出期望得到的效果(GuestOS和VMM是运行在用户态上的应用程序)，从而将核心态的特权解除。解除了核心态的特权后，就能够在GuestOS中执行大部分的核心态指令了。但是，这仍然不能完美的解决问题。因为在一个OS的指令集中还存在着一种敏感指令(可能是内核态，也可能是用户态)。此时就需要陷入模拟的实现。</li>
<li>陷入模拟：无论是HostOS还是GuestOS，只要是一个OS都必然会存在有敏感指令(reboot、shutdown等)。试想如果我们希望将GuestOS重启，并在GuestOS中执行了 reboot 指令，但是却将HostOS给重启了，这将会非常糟糕。VMM的陷入模拟机制就是为了解决这个问题。 在GuestOS中执行了敏感指令 reboot 时，VMM首先会将敏感指令 reboot 捕获、检测并判定其为敏感指令。此时VMM就会陷入模拟，将敏感指令 reboot 模拟成一个只针对GuestOS进行操作的、非敏感的、并且运行在非核心态上的 “reboot” 指令，最后CPU执行虚拟机的重启操作</li>
</ul>
<p>简而言之，软件辅助虚拟化能够成功的将所有在GuestOS中执行的系统内核特权指令进行捕获、翻译，使之成为只能对GuestOS生效的虚拟特权指令。之所以需要这么做的前提是因为CPU并不能准确的去判断一个特权指令到底是由GuestOS发出的还是由HostOS发出的，这样也就无法针对一个正确的OS去将这一个特权指令执行。</p>
<p>由于全虚拟化VMM会频繁的捕获这些核心态的和敏感的指令，将这些指令进行转换之后，再交给CPU执行。所以经过了转换，导致其效率低，但全虚拟化VMM应用程序的好处在于其不需要对GuestOS的核心源码做修改，所以全虚拟化的VMM可以安装绝大部分的OS(暂时来说只有已Linux、open soralis、BSD等几种OS开源了内核代码)。</p>
<p>直到后来CPU厂商们发布了能够判断特权指令归属的标准x86 CPU之后，迎来了硬件辅助全虚拟化。</p>
<h4 id="1-5-2-2-硬件辅助的全虚拟化-HVM-Hardware-Virtual-Machine"><a href="#1-5-2-2-硬件辅助的全虚拟化-HVM-Hardware-Virtual-Machine" class="headerlink" title="1.5.2.2 硬件辅助的全虚拟化 HVM(Hardware Virtual Machine)"></a>1.5.2.2 硬件辅助的全虚拟化 HVM(Hardware Virtual Machine)</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm9.png" srcset="/blog/img/loading.gif"></p>
<p>2005年Intel提出并开发了由CPU直接支持的虚拟化技术。这种虚拟化技术引入新的CPU运行模式和新的指令集，使得VMM和GuestOS运行于不同的模式下(VMM=Root Mode;GuestOS=Non-Root Mode)，GuestOS运行于受控模式，原来的一些敏感指令在受控模式下会全部陷入VMM，由VMM来实现模拟，这样就解决了部分非内核态敏感指令的陷入——模拟难题，而且模式切换时上下文的保存恢复由硬件来完成，这样就大大提高了陷入——模拟时上下文切换的效率 。该技术的引入使x86 CPU可以很容易地实现完全虚拟化。故皆被几乎所有之前分歧的各大流派所采用，包括KVM-x86，VMWare ESX Server 3，Xen 3.0 。</p>
<p>虚拟化CPU形成了新的CPU执行状态 Non-Root Mode 和 Root Mode .GuestOS运行在Non-Root Mode的Ring 0核心态中，这意味着GuestOS能够直接执行特权指令,而不再需要特权解除和陷入模拟机制。并且在硬件层上面紧接的就是虚拟化层的VMM，而不需要HostOS。这是因为在硬件辅助全虚拟化的VMM会以一种更具协作性的方式来实现虚拟化 —— 将虚拟化模块加载到HostOS的内核中，例如：KVM，KVM通过在HostOS内核中加载KVM Kernel Module来将HostOS转换成为一个VMM。所以此时VMM可以看作是HostOS，反之亦然。</p>
<p>硬件辅助全虚拟化主要使用了支持虚拟化功能的CPU进行支撑，CPU可以明确的分辨出来自GuestOS的特权指令，并针对GuestOS进行特权操作，而不会影响到HostOS。</p>
<p>硬件辅助全虚拟化需要物理硬件的支持，比如需要CPU必须支持并且打开虚拟化功能，例如Intel 的Intel VT-X/EPT，AMD的AMD-V/RVI，以在CPU 层面支持虚拟化功能和内存虚拟化技术</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">全虚拟化软件(硬件辅助全虚拟化)：<br>vmware esxi<br>Xen3.0<br>KVM<br>Microsoft Hyper-V<br>vmware workstation <span class="hljs-comment">#https://www.vmware.com/cn/products/workstation-pro.html</span><br>VirtualBox<br>paralles desktop<br></code></pre></td></tr></table></figure>

<p><strong>KVM 是硬件辅助的虚拟化技术</strong>，主要负责比较繁琐的 CPU 和内存虚拟化，而 Qemu 则负责 I/O 虚拟化，两者合作各自发挥自身的优势</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm10.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-5-3-半虚拟化-para-virtualization"><a href="#1-5-3-半虚拟化-para-virtualization" class="headerlink" title="1.5.3 半虚拟化 para virtualization"></a>1.5.3 半虚拟化 para virtualization</h3><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm11.png" srcset="/blog/img/loading.gif" style="zoom:150%;" />

<p>半虚拟化是需要GuestOS协助的虚拟化。因为在半虚拟化VMM中运行的GuestOS，都需要将其内核源码进行都进过了特别的修改。</p>
<p>通过修改客户操作系统代码，将原来在物理机上执行的一些特权指令(主要是修改GuestOS指令集中的敏感指令和核心态指令)，修改成可以和VMM直接交互的方式，实现操作系统的定制化。这样，就不会有捕获异常、翻译和模拟的过程，性能损耗比较少。</p>
<p>半虚拟化VMM在处理敏感指令和内核态指令的流程上相对更简单一些。让HostOS在捕抓到GuestOS内核态指令或敏感指令时，HostOS也能够准确的判断出该指令是否属于GuestOS(GuestOS知道自己是虚拟机)。这样就可以高效的避免了上述问题。典型的半虚拟化软件有——Xen、KVM-PowerPC(简易指令集)</p>
<p>半虚拟化除了修改内核外还有另外一种实现方法——在每一个GuestOS中安装半虚拟化软件，如:VMTools、RHEVTools。</p>
<p>注意：若使用KVM运行Windows时，一定要安装半虚拟化驱动Tools，否则无法工作。现在主流的半虚拟化驱动是由IBM和redhat联合开发一个通用半虚拟机驱动virtio 。</p>
<p>半虚拟化要求guest OS 的内核是知道自己运行在虚拟化环境当中的，因此guest OS的系统架构必须和宿主机的系统架构相同，并且要求对guest OS的内核做相应的修改，因此半虚拟化只支持开源内核的系统，不支持闭源的系统，比较常见的半虚拟化就是早期版本的XEN，但是Xen 从其3.0 版本开始，可以支持利用硬件辅助虚拟化技术(<a target="_blank" rel="noopener" href="http://www-archive.xenproject.org/files/xen_3.0_datasheet.pdf)%EF%BC%8C%E5%AE%9E%E7%8E%B0%E4%BA%86%E5%AE%8C%E5%85%A8%E8%99%9A%E6%8B%9F%E5%8C%96%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%E5%85%B6%E5%B9%B3%E5%8F%B0%E4%B8%8A%E4%B8%8D%E5%8A%A0%E4%BF%AE%E6%94%B9%E7%9A%84%E7%9B%B4%E6%8E%A5%E8%BF%90%E8%A1%8C%E5%A6%82Linux/Windows">http://www-archive.xenproject.org/files/xen_3.0_datasheet.pdf)，实现了完全虚拟化，可以在其平台上不加修改的直接运行如Linux/Windows</a> 等系列的操作系统，使得系统具备了更好的兼容性。</p>
<p><strong>xen 的半虚拟化相关技术:</strong></p>
<img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm12.png" srcset="/blog/img/loading.gif" style="zoom:80%;" />

<ul>
<li>Domain 0：Domain 0 是一个修改过的 Linux kernel，是唯一运行在 Xen Hypervisor 之上的虚拟机，它拥有访问物理<br>I/O 资源的权限，同时和系统上运行的其他虚拟机进行交互。Domain 0 需要在其它 Domain 启动之前启动。</li>
<li>Domain U：运行在 Xen Hypervisor 上的所有半虚拟化（paravirtualized）虚拟机被称为“Domain U PV Guests”，其上运行着被修改过内核的操作系统，如 Linux、Solaris、FreeBSD 等其它 UNIX 操作系统。所有的全虚拟化虚拟机被称为“Domain U HVM Guests”，其上运行着不用修改内核的操作系统，如 Windows 等。</li>
</ul>
<h3 id="1-5-4-各虚拟化技术性能对比"><a href="#1-5-4-各虚拟化技术性能对比" class="headerlink" title="1.5.4 各虚拟化技术性能对比"></a>1.5.4 各虚拟化技术性能对比</h3><table>
<thead>
<tr>
<th>虚拟机名称</th>
<th>开发厂商简介</th>
<th>虚拟类型</th>
<th>执行效率</th>
<th>GuestOS是否可以跨平台</th>
<th>许可证类型</th>
</tr>
</thead>
<tbody><tr>
<td>Xen</td>
<td><a target="_blank" rel="noopener" href="https://www.citrix.com/products/citrix-hypervisor/">https://www.citrix.com/products/citrix-hypervisor/</a></td>
<td>虚拟化、完全虚拟化</td>
<td>非常高</td>
<td>可以</td>
<td>GPL</td>
</tr>
<tr>
<td>Vmware</td>
<td><a target="_blank" rel="noopener" href="https://www.vmware.com/">https://www.vmware.com/</a></td>
<td>完全虚拟化</td>
<td>较高</td>
<td>可以</td>
<td>私有</td>
</tr>
<tr>
<td>Vmware</td>
<td><a target="_blank" rel="noopener" href="http://www.linux-kvm.org/page/Main_Page">http://www.linux-kvm.org/page/Main_Page</a></td>
<td>完全虚拟化</td>
<td>较高</td>
<td>可以</td>
<td>GPL</td>
</tr>
<tr>
<td>QEMU</td>
<td><a target="_blank" rel="noopener" href="http://www.qemu.com/">http://www.qemu.com/</a></td>
<td>模拟</td>
<td>较低</td>
<td>可以</td>
<td>LGPL/GPL</td>
</tr>
</tbody></table>
<h2 id="1-6-虚拟化技术厂商"><a href="#1-6-虚拟化技术厂商" class="headerlink" title="1.6 虚拟化技术厂商"></a>1.6 虚拟化技术厂商</h2><h3 id="1-6-1-软件技术厂商"><a href="#1-6-1-软件技术厂商" class="headerlink" title="1.6.1 软件技术厂商"></a>1.6.1 软件技术厂商</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm13.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-6-2-硬件技术厂商"><a href="#1-6-2-硬件技术厂商" class="headerlink" title="1.6.2 硬件技术厂商"></a>1.6.2 硬件技术厂商</h3><p>英特尔® 虚拟化技术（英特尔® VT）<br><a target="_blank" rel="noopener" href="https://www.intel.cn/content/www/cn/zh/virtualization/virtualization-technology/intel-virtualization-technology.html">https://www.intel.cn/content/www/cn/zh/virtualization/virtualization-technology/intel-virtualization-technology.html</a></p>
<p>Intel从2005年开始支持在CPU中加入硬件虚拟化的支持，intel virtualazation tochnology，简称intel VT，IntelVT虚拟化技术包括分别针对CPU的增强虚拟化技术Intel VT-x、I/O虚拟化的Intel VT-d、网络虚拟化的Intel VT-c 技术</p>
<h4 id="1-6-2-1-Intel-VT-x"><a href="#1-6-2-1-Intel-VT-x" class="headerlink" title="1.6.2.1 Intel VT-x"></a>1.6.2.1 Intel VT-x</h4><p>Intel VT-x 可以让一个CPU工作起来像多个CPU在并行运行，从而使得在一台物理服务器内可以同时运行多个操作系统，能够降低（甚至消除）多个虚拟机操作系统之间的资源争夺和限制，从硬件上极大地改善虚拟机的安全性和性能，有助于提高基于软件的虚拟化解决方案的灵活性与稳定性，此外，IntelVT-x具备的虚拟机迁移特性还可为IT投资提供有力保护，并进一步提高故障切换、负载均衡、灾难恢复和维护的灵活性。</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs coq">Intel VT Flex Priority（灵活优先级）：当处理器执行任务时，往往会收到其它设备或应用发出的请求或“中断”命令。为了最大程度减少对性能的影响，处理器内的一个寄存器专用来监控任务优先级，只有优先级高于当前运行任务的请求或“中断”才被及时处理<br><br>Intel VT Flex Migration（灵活迁移）：虚拟化能够在无需停机的情况下，将运行中的虚拟机在物理服务器之间进行迁移，借助此项技术，管理程序能够在迁移池内的所有服务器中建立一套一致的指令，实现工作负载的无缝迁移<br><br>Intel VT Extended Page <span class="hljs-keyword">Tables</span>（EPT，扩展页表）：为了降低实现内存虚拟化的难度和提升内存虚拟化的性能，Extended Page <span class="hljs-keyword">Tables</span>直接在硬件上支持虚拟机内存的逻辑地址-&gt;虚拟机内存的物理地址-&gt;物理服务器内存的物理地址的两次转换。<br></code></pre></td></tr></table></figure>

<h4 id="1-6-2-2-Intel-VT-d"><a href="#1-6-2-2-Intel-VT-d" class="headerlink" title="1.6.2.2 Intel VT-d"></a>1.6.2.2 Intel VT-d</h4><p>Intel VT-d技术支持直接I/O访问，虚拟机创建好之后，数据即可直接在虚拟机与为其分配的I/O设备之间进行传输，这样就加快了I/O的流动，减少VMM活动及服务器处理器的负载。</p>
<h4 id="1-6-2-3-Intel-VT-c"><a href="#1-6-2-3-Intel-VT-c" class="headerlink" title="1.6.2.3 Intel VT-c"></a>1.6.2.3 Intel VT-c</h4><p>Intel VT-c技术：支持网络连接的Intel虚拟化技术，包括: 虚拟机设备队列（VMDq）、虚拟机直接互连（VMDc）。</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">虚拟机设备队列（<span class="hljs-variable">VMDq</span>），最大限度提高<span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span>吞吐率，<span class="hljs-variable">IntelVT</span><span class="hljs-operator">-</span><span class="hljs-variable">c</span>可将网络<span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span>吞吐量提高一倍以上，使虚拟化应用达到接近物理服务器的吞吐率<br>虚拟机直接互连（<span class="hljs-variable">VMDc</span>）：大幅提升虚拟化性能。<span class="hljs-variable">VMDc</span>支持虚拟机直接访问网络<span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span>硬件，从而显著提升虚拟机性能，这些通信链路直接绕过了<span class="hljs-variable">VMM</span>交换机，进一步提升了<span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span>性能并减少服务器处理器的负载。<br></code></pre></td></tr></table></figure>

<h2 id="1-7-云计算"><a href="#1-7-云计算" class="headerlink" title="1.7 云计算"></a>1.7 云计算</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm14.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-7-1-什么是云计算"><a href="#1-7-1-什么是云计算" class="headerlink" title="1.7.1 什么是云计算"></a>1.7.1 什么是云计算</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm15.png" srcset="/blog/img/loading.gif"></p>
<p>以前电脑被发明的时候，还没有网络，每个电脑，就是一个单机。用户在单机上，安装操作系统和应用软件，完成自己的工作.后来，有了网络，单机与单机之间，可以交换信息，协同工作.再后来，单机性能越来越强，就有了服务器。人们发现，可以把一些服务器集中起来，放在机房里，然后让用户通过网络，去访问和使用机房里的计算机资源.再再后来，小型网络变成了大型网络，就有了互联网（Internet）。小型机房变成了大型机房，就有了IDC（Internet Data Center，互联网数据中心）当越来越多的计算机资源和应用服务被集中起来，就变成了——“云计算（Cloud Computing）”。无数的大型机房，就成了“云端”</p>
<p>云计算(Cloud Computing)是概念最早是由Google 前首席执行官 埃里克•施密特（EricSchmidt）在2006 年8 月 9日的搜索引擎大会上首次提出的一种构想，而“云计算”就是这种构想的代名词，云计算以虚拟化为基础，以网络为中心，为用户提供安全、快速、便捷的数据存储和网络计算服务，包括所需要的硬件、平台、软件及服务等资源，而提供资源的网络就被称为“云”。</p>
<p><strong>美国国家标准与技术研究院（NIST）定义：云计算是一种按使用量付费的模式，这种模式提供可用的、便捷的、按需的网络访问， 进入可配置的计算资源共享池（资源包括网络，服务器，存储，应用软件，服务），这些资源能够被快速提供，只需投入很少的管理工作，或与服务供应商进行很少的交互</strong></p>
<p>云计算是指服务的交付和使用模式，指通过网络以按需、易扩展的方式获得所需的资源（可以是IT和软件、互联网相关的，也可以使任意其他的服务）。提供资源的网络被称为“云”。“云”中的资源在使用者看来是可以无限扩展的，并且可以随时获取，按需使用，随时扩展，按使用付费。意味着计算能力也可以作为一种商品进行流通，就像煤气、水电一样，取用方便，费用低廉。最大的不同在于，它是通过网络进行传输的. 云是网络、互联网的一种比喻说法。过去在画图时往往用云来表示电信网，后来也用来表示互联网和底层基础设施的抽象</p>
<h3 id="1-7-2-云计算分类"><a href="#1-7-2-云计算分类" class="headerlink" title="1.7.2 云计算分类"></a>1.7.2 云计算分类</h3><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm16.png" srcset="/blog/img/loading.gif" style="zoom:60%;" />

<ul>
<li>公有云：Public Cloud，通常指第三方提供商为用户提供的能够通过互联网来使用的云主机，所有入驻的用户都称为租户。公有云本质上是一种共享资源服务，最大的特点是成本低，扩展性非常好，对于对安全要求不高的中小型企业或是个人站长来说是非常好的选择。缺点是对于云端的资源缺乏控制、保密数据的安全性、网络性能和匹配性问题</li>
<li>私有云：Private Cloud，是为使用者单独使用而构建的，是企业的专有资源，对数据保密、数据安全、服务质量都能有效控制。特点是安全性与私有化，是订制化解决方案的根本，可保证企业的数据安全与稳定</li>
<li>混合云： Hybird Cloud，是一种混合了私有云和公有云的新型解决方案，集公有云的方便便捷与私有云的安全稳定为一体，是近年来云计算的主要模式和发展方向。企业出于安全考虑，会将敏感数据或是运行关键性的工作负载放在私有云上面，同时又希望能使用公有云的免费资源，达到安全又省钱的目的。</li>
</ul>
<p>公有云和私有云的对比</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm17.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">公有云：比如阿里云<span class="hljs-string">/aws</span>、azure、金山云、腾讯云等都属于公有云，每个人都可以付费使用，不需要自己关心底层硬件，但是数据安全需要考虚<br><br>私有云：在自己公司内部或IDC自建Openstack、VMware等环境<br><br>混合云：既要使用公有云，又要使用私有云，即自己的私有云的部分业务和公有云有交接，这部分称为混合云<br></code></pre></td></tr></table></figure>

<p>下图为截止到2018年底，全球主要云计算厂商的营收对比：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm18.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-7-3-云计算分层"><a href="#1-7-3-云计算分层" class="headerlink" title="1.7.3 云计算分层"></a>1.7.3 云计算分层</h3><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm19.png" srcset="/blog/img/loading.gif" style="zoom:80%;" />

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm20.png" srcset="/blog/img/loading.gif"></p>
<p>传统IDC：直接在物理机运行服务，不能快速对业务横向扩容。</p>
<p>把计算机资源放在云端，如何提供给用户，又分为三种层次：</p>
<ul>
<li><p>第一层次，是最底层的硬件资源，主要包括CPU（计算资源），硬盘（存储资源），还有网卡（网络资源）等，即为IAASIaaS：Infrastructure as a service,基础设施即服务 自建基础服务(openstack)、阿里云ECS。</p>
</li>
<li><p>第二层次，更高级些，用户不直接使用CPU、硬盘、网卡，而是希望把操作系统，数据库软件等安装好，用户再来使用，即为PAAS</p>
<p>PaaS：Platform-as-a-service 平台即服务， 如: 公有云的RDS云数据库（Relational DatabaseService）、docker、Redis、SLB(Server Load Balancer)等服务。</p>
</li>
<li><p>第三层次，更进一步，用户期望不但要装好操作系统等服务，还要把具体的应用软件装好，例如: 邮件、OA系统等，用户可以直接使用服务，即为SAAS</p>
</li>
</ul>
<p>SaaS：Software-as-a-service 软件即服务，如: 企业邮箱、OA系统、云盘、云音乐等</p>
<h3 id="1-7-4-云计算和虚拟化"><a href="#1-7-4-云计算和虚拟化" class="headerlink" title="1.7.4 云计算和虚拟化"></a>1.7.4 云计算和虚拟化</h3><p>面对这么多样化多层次的云计算服务，需要对资源进行调用和管理.如果人工对物理资源进行管理效率太低，需要各种软件和平台，负责对资源进行调用和管理，即所谓自动化运维管理要对物理资源进行灵活和动态的弹性管理，就需要实现“虚拟化”</p>
<p>通俗的说，虚拟化就是把物理资源转变为逻辑上可以管理的资源，以打破物理结构间的壁垒，计算元件运行在虚拟的基础上而不是真实的基础上，可以扩大硬件的容量，简化软件的重新配置过程。</p>
<p>虚拟化是云计算的基础。常见的虚拟化就是在一台物理服务器上，运行多台“虚拟服务器”,也叫虚拟机<br>（VM，Virtual Machine）,从表面来看，这些虚拟机都是独立的服务器，但实际上，它们共享物理服务器的CPU、内存、硬件、网卡等资源</p>
<p>云计算是一种服务模式，虚拟化是一种技术</p>
<p>虚拟化是云计算的重要支撑技术。云计算是基于互联网的相关服务的增加、使用和交付模式，通常涉及通过互联网来提供动态易扩展且经常是虚拟化的资源。通过虚拟化，可以将应用程序和数据在不同层次以不同的方式展现给客户，为云计算的使用者和开发者提供便利。云计算的虚拟化过程为组织带来了灵活性，从而改善IT运维和减少成本支出.</p>
<p>虚拟化和云计算并不是相互捆绑的，而是可以优势互补为用户提供更优质的服务。在云计算的部署方案中，虚拟化技术可以使其IT资源应用更加灵活。而在虚拟化的应用过程中，云计算也提供了按需所取的资源和服务。在一些特定场景中，云计算和虚拟化无法剥离，只有相互搭配才能更好地解决客户需求</p>
<p><strong>虚拟化和云的区别</strong></p>
<p>参考链接: <a target="_blank" rel="noopener" href="https://www.redhat.com/zh/topics/cloud-computing/cloud-vs-virtualization">https://www.redhat.com/zh/topics/cloud-computing/cloud-vs-virtualization</a></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">由于两者的核心理念都是从硬件中分离资源，以创建可用的环境，所以很容易被混为一谈。虚拟化有助于创建云，但它并非实现云计算的决定性技术。你可以这样理解：<br>虚拟化是一种将功能与硬件分离的技术云计算远非只是依赖于这种分离的解决方案<br><br>美国国家标准与技术协会这样描述云计算的 <span class="hljs-number">5</span> 种功能：一个网络、池化资源、一个用户界面、置备功能、自动化资源控制<span class="hljs-regexp">/分配。虽然虚拟化可以创建网络和池化资源，但还需要其他管理和操作系统软件来创建用户界面、部署虚拟机、控制/</span>分配资源<br></code></pre></td></tr></table></figure>

<p><strong>虚拟化和云计算的对比：</strong></p>
<table>
<thead>
<tr>
<th>项目</th>
<th>虚拟化</th>
<th>云</th>
</tr>
</thead>
<tbody><tr>
<td>定义</td>
<td>技术</td>
<td>方法</td>
</tr>
<tr>
<td>目的</td>
<td>从 1 个物理硬件系统创建多个模拟环境</td>
<td>汇聚并自动化分配虚拟资源以供按需使用</td>
</tr>
<tr>
<td>用途</td>
<td>针对具体用途为特定用户提供打包资源</td>
<td>针对多种用途为用户群组提供不同资源</td>
</tr>
<tr>
<td>配置</td>
<td>基于镜像</td>
<td>基于模板</td>
</tr>
<tr>
<td>成本</td>
<td>资本性支出（CAPEX）高、运营支出(OPEX)低</td>
<td>私有云：CAPEX 高、OPEX低 公共云：CAPEX 低、</td>
</tr>
<tr>
<td>可扩展性</td>
<td>纵向扩展</td>
<td>横向扩展</td>
</tr>
<tr>
<td>使用场景</td>
<td>少量服务器的环境</td>
<td>众多服务器的大环境</td>
</tr>
</tbody></table>
<h1 id="二、-虚拟化技术之KVM架构和部署"><a href="#二、-虚拟化技术之KVM架构和部署" class="headerlink" title="二、 虚拟化技术之KVM架构和部署"></a>二、 虚拟化技术之KVM架构和部署</h1><h2 id="2-1-KVM-概述"><a href="#2-1-KVM-概述" class="headerlink" title="2.1 KVM 概述"></a>2.1 KVM 概述</h2><h3 id="2-1-1-KVM-介绍"><a href="#2-1-1-KVM-介绍" class="headerlink" title="2.1.1 KVM 介绍"></a>2.1.1 KVM 介绍</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm21.png" srcset="/blog/img/loading.gif"></p>
<p>KVM（ Kernel-based Virtual Machine）是一个完整的虚拟化解决方案，适用于包含虚拟化扩展（IntelVT或AMD-V）的x86硬件上的Linux。目前也支持ARM等其它硬件平台. 它由可加载的内核模块kvm.ko组成，它提供核心虚拟化基础架构和处理器特定模块，kvm-intel.ko或kvm-amd.ko，KVM的用户空间组件包含在QEMU1.3后续版本中,KVM目前已成为学术界的主流 VMM (virtual machine monitor，虚拟机监视器，也称为 hypervisor)之一</p>
<p>KVM是开源软件，可运行多个运行未修改的Linux或Windows映像的虚拟机</p>
<p>依赖于HVM；Intel VT-x, AMD AMD-V</p>
<p>官网： <a target="_blank" rel="noopener" href="https://www.linux-kvm.org/">https://www.linux-kvm.org</a></p>
<p>2006年10月，以色列 Qumranet 公司发布 KVM,早期开发者 Avi Kivity</p>
<p>2007年2月，KVM内核组件收录至Linux 2.6.20及后续版本中</p>
<p>2008年9月，Redhat 1.7亿美元收购</p>
<p>2009年9月, RHEL5.4 中在集成XEN的同时,也将KVM添加进来</p>
<p>2011年11月，RHEL6使用KVM代替XEN</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm22.png" srcset="/blog/img/loading.gif"></p>
<p><strong>帽 kvm 介绍</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.redhat.com/zh/topics/virtualization/what-is-KVM<br></code></pre></td></tr></table></figure>

<p><strong>RedHat虚拟化指南</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/virtualization_getting_started_guide/index<br></code></pre></td></tr></table></figure>

<p><strong>RedHat创建虚拟机数量限制：</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://access.redhat.com/articles/rhel-kvm-limits<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm23.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-1-2-KVM架构"><a href="#2-1-2-KVM架构" class="headerlink" title="2.1.2 KVM架构"></a>2.1.2 KVM架构</h3><p>KVM 是基于虚拟化扩展（Intel VT 或者 AMD-V）的 X86 硬件的开源的 Linux 原生的全虚拟化解决方案。KVM 中，虚拟机被实现为常规的 Linux 进程，由标准 Linux 调度程序进行调度；虚机的每个虚拟CPU 被实现为一个常规的 Linux 进程。这使得 KVM 能够使用 Linux 内核的已有功能。</p>
<p>但是，KVM 本身不执行任何硬件模拟，需要客户空间程序通过 /dev/kvm 接口设置一个客户机虚拟服务器的地址空间，向它提供模拟的 I/O，并将它的视频显示映射回宿主的显示屏。目前这个应用程序是QEMU。</p>
<h4 id="2-1-2-1-KVM-体系结构"><a href="#2-1-2-1-KVM-体系结构" class="headerlink" title="2.1.2.1 KVM 体系结构"></a>2.1.2.1 KVM 体系结构</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm24.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li>KVM： 初始化CPU硬件,打开虚拟机模式,负责CPU,内存,中断控制器,时钟. 由内核模块kvm_xxx.ko实现，工作于hypervisor，设备/dev/kvm，是一个字符设备，在用户空间可通过ioctl()系统调用来完成VM创建、启动，为VM分配内存、读写VCPU的寄存器、向VCPU注入中断、时钟等管理功能</li>
<li>QEMU进程：工作于用户空间，主要用于实现模拟IO设备,如显卡，网卡，硬盘等， qemu-kvm进程：工作于用户空间，用于实现一个虚拟机实例</li>
<li>Libvirt：提供统一API，守护进程libvirtd和相关工具，如:virsh，virt-manager等</li>
</ul>
<h4 id="2-1-2-2-KVM-模块载入后的系统的运行模式"><a href="#2-1-2-2-KVM-模块载入后的系统的运行模式" class="headerlink" title="2.1.2.2 KVM 模块载入后的系统的运行模式"></a>2.1.2.2 KVM 模块载入后的系统的运行模式</h4><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm25.png" srcset="/blog/img/loading.gif" style="zoom:150%;" />

<p>内核模式：GuestOS执行I/O类操作，或其它的特殊指令的操作；称作“来宾-内核”模式</p>
<p>用户模式：代表GuestOS请求I/O类操作</p>
<p>来宾模式：GuestOS的非I/O类操作；它被称作“来宾-用户”模式,称作虚拟机的用户模式更贴切.</p>
<h4 id="2-1-2-3-KVM-的组件"><a href="#2-1-2-3-KVM-的组件" class="headerlink" title="2.1.2.3 KVM 的组件"></a>2.1.2.3 KVM 的组件</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm26.png" srcset="/blog/img/loading.gif"></p>
<p>KVM：运行在内核空间，提供 CPU 和内存的虚级化，以及客户机的 I/O拦截，Guest的部分I/O被KVM拦截后，交给QEMU处理。</p>
<p><strong>两类组件：</strong></p>
<ul>
<li>(kvm.ko)/dev/kvm：工作为hypervisor，在用户空间可通过系统调用ioctl()与内核中的kvm模块交互，从而完成虚拟机的创建、启动、停止、删除等各种管理功能，可虚拟CPU和内存</li>
<li>qemu-kvm进程：工作于用户空间，用于实现IO设备模拟；也用于实现一个虚拟机实例</li>
</ul>
<h4 id="2-1-2-4-KVM-功能"><a href="#2-1-2-4-KVM-功能" class="headerlink" title="2.1.2.4 KVM 功能"></a>2.1.2.4 KVM 功能</h4><p>KVM 所支持的功能包括：</p>
<ul>
<li>支持CPU 和 memory 超分（Overcommit）</li>
<li>支持半虚拟化I/O （virtio）</li>
<li>支持热插拔 （cpu，块设备、网络设备等）</li>
<li>支持对称多处理（Symmetric Multi-Processing，缩写为 SMP ）</li>
<li>支持实时迁移（Live Migration）</li>
<li>支持 PCI 设备直接分配和 单根I/O 虚拟化 （SR-IOV）</li>
<li>支持内核同页合并 （KSM ）</li>
<li>支持NUMA （Non-Uniform Memory Access，非一致存储访问结构 ）</li>
</ul>
<h4 id="2-1-2-5-QEMU"><a href="#2-1-2-5-QEMU" class="headerlink" title="2.1.2.5 QEMU"></a>2.1.2.5 QEMU</h4><p>QEMU是一个广泛使用的开源计算机仿真器和虚拟机。当作为仿真器时，可在一种架构(如PC机)下运行另一种架构(如ARM)下的操作系统和程序。而通过动态转化，其可以获得很高的运行效率。当作为一个虚拟机时，qemu可以通过直接使用物理机的系统资源，让虚拟系统能够获得接近于物理机的性能表现。qemu支持xen或者kvm模式下的虚拟化。当用kvm时，qemu可以虚拟x86、服务器和嵌入式powerpc，以及s390的系统</p>
<p>QEMU 当运行与主机架构相同的目标架构时可以使用 KVM。例如，当在一个x86兼容处理器上运行qemu-system-x86 时，可以利用 KVM 加速——为宿主机和客户机提供更好的性能</p>
<p>Qemu是纯软件实现的虚拟化模拟器，几乎可以模拟任何硬件设备，最熟悉的就是能够模拟一台能够独立运行操作系统的虚拟机，虚拟机认为自己和硬件打交道，但其实是和 Qemu 模拟出来的硬件打交道，Qemu 将这些指令转译给真正的硬件，正因为 Qemu 是纯软件实现的，所有的指令都要经Qemu，性能非常低，所以，在生产环境中，大多数的做法都是配合 KVM 来完成虚拟化工作，KVM完成复杂及要求比较高的设备虚拟化，而Qemu完成像鼠标、键盘等设备的虚拟化。</p>
<p>QEMU有如下几个部分组成：</p>
<ul>
<li>处理器模拟器(x86、PowerPC和Sparc)</li>
<li>仿真设备(显卡、网卡、硬盘、鼠标等)</li>
<li>用于将仿真设备连接至主机设备(真实设备)的通用设备，实现透传</li>
<li>模拟机的描述信息</li>
<li>调试器</li>
<li>与模拟器交互的用户接口</li>
</ul>
<h4 id="2-1-2-6-KVM-局限性"><a href="#2-1-2-6-KVM-局限性" class="headerlink" title="2.1.2.6 KVM 局限性"></a>2.1.2.6 KVM 局限性</h4><ul>
<li>CPU overcommit：过载使用，性能下降</li>
<li>时间记录难以精确，依赖于时间同步机制，如NTP</li>
<li>VM量特别大时，MAC地址存在冲突的可能性</li>
<li>实时迁移：共享存储，CPU架构，版本等</li>
<li>性能局限性</li>
</ul>
<h3 id="2-1-3-比较-KVM-和-Xen"><a href="#2-1-3-比较-KVM-和-Xen" class="headerlink" title="2.1.3 比较 KVM 和 Xen"></a>2.1.3 比较 KVM 和 Xen</h3><p>KVM与XEN对比</p>
<table>
<thead>
<tr>
<th></th>
<th>XEN</th>
<th>KVM</th>
</tr>
</thead>
<tbody><tr>
<td>问世时间</td>
<td>2003年</td>
<td>2007年</td>
</tr>
<tr>
<td>支持企业</td>
<td>Citrix、Novell、Oracle、Sun、Ret Hat（RHEL5）和Virtual Iron</td>
<td>Redhat、Ubuntu等</td>
</tr>
<tr>
<td>支持的虚拟化技术</td>
<td>全虚拟化、半虚拟化</td>
<td>全虚拟化</td>
</tr>
<tr>
<td>支持架构</td>
<td>x86、IA64和AMD、Fujitsu、IBM、Sun等公司的ARM，以及 x86/64 CPU商家和Intel嵌入式的支持</td>
<td>支持虚拟化的CPU</td>
</tr>
<tr>
<td>支持操作系统</td>
<td>UNIX、Linux和Microsoft Windows</td>
<td>UNIX、Linux和Microsoft Windows</td>
</tr>
<tr>
<td>动态迁移</td>
<td>支持</td>
<td>支持（以前不支持）</td>
</tr>
<tr>
<td>内核支持</td>
<td>需要对内核打补丁</td>
<td>内置在内核中</td>
</tr>
</tbody></table>
<p>IBM文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://www.ibm.com/developerworks/cn/linux/l-using-kvm/<br></code></pre></td></tr></table></figure>

<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ada">Xen 虚拟化环境在传统上提供了 Linux 系统上性能最高的开源虚拟化技术。Xen 使用一个虚拟机管理程序来管理虚拟机和相关的资源，还支持半虚拟化，这可在 “知道” 自己已实现虚拟化的虚拟机中提供更高的性能。Xen 提供了一个专门执行资源和虚拟管理与计划的开源虚拟机管理程序。在裸机物理硬件上引导系统时，Xen 虚拟机管理程序启动一个称为 Domain0 或管理域的主虚拟机，该虚拟机提供了对所有在该物理主机上运行的其他虚拟机（称为 Domain1 到 DomainN，或者简单地称为 Xen Guest）的中央虚拟机管理功能。<br><br>不同于 Xen，KVM 虚拟化使用 Linux 内核作为它的虚拟机管理程序。对 KVM 虚拟化的支持自 <span class="hljs-number">2.6</span>.<span class="hljs-number">20</span>版开始已成为主流 Linux 内核的默认部分。使用 Linux 内核作为虚拟机管理程序是 KVM 受到批评的一个主要方面，因为（在默认情况下）Linux 内核并不符合 <span class="hljs-keyword">Type</span> <span class="hljs-type">1 </span>虚拟机管理程序的传统定义—“一个小操作系统”。尽管大多数 Linux 发行版所提供的默认内核的确如此，但可以轻松地配置 Linux 内核来减少它的编译大小，以便它仅提供作为 <span class="hljs-keyword">Type</span> <span class="hljs-type">1 </span>虚拟机管理程序运行所需的功能和驱动程序。Red Hat 自己的Enterprise Virtualization 产品仅依靠这样一种特殊配置的、相对轻量型的 Linux 内核来运行。但更重要的是，“小”只是一个相对的词汇，如今具有数 GB 内存的 <span class="hljs-number">64</span> 位服务器可轻松地提供现代 Linux 内核所需的几 MB 空间。<br><br>KVM 超越 Xen 成为大多数企业环境首选的开源裸机虚拟化技术，这有多个原因：<br><br>KVM 支持自 <span class="hljs-number">2.6</span>.<span class="hljs-number">20</span> 版开始已自动包含在每个 Linux 内核中。在 Linux 内核 <span class="hljs-number">3.0</span> 版之前，将 Xen支持集成到 Linux 内核中需要应用大量的补丁，但这仍然无法保证每个可能硬件设备的每个驱动程序都能在Xen 环境中正确工作。Xen 支持所需的内核源代码补丁仅提供给特定的内核版本，这阻止了 Xen 虚拟化环境利用仅在其他内核版本中可用的新驱动程序、子系统及内核修复和增强。KVM 在 Linux 内核中的集成使它能够自动利用新 Linux内核版本中的任何改进。<br><br>Xen 要求在物理虚拟机服务器上运行一个特殊配置的 Linux 内核，以用作在该服务器上运行的所有虚拟机的管理域。KVM 可在物理服务器上使用在该物理系统上运行的 Linux VM 中使用的相同内核。<br><br>Xen 的虚拟机管理程序是一段单独的源代码，它自己的潜在缺陷与它所托管的操作系统中的缺陷无关。因为KVM 是 Linux 内核的一个集成部分，所以只有内核缺陷能够影响它作为 KVM 虚拟机管理程序的用途。<br><br>尽管 Xen 仍可提供比 KVM 性能更高的裸机虚拟化，但这些性能改进的价值常常比不上 KVM 虚拟化的简单性和易用性价值。<br></code></pre></td></tr></table></figure>

<p>目前在各大公有云厂商新购买的虚拟机基本运行在KVM环境下，就连早期一直使用Xen的AWS也在2017年开始逐渐转换到KVM环境，以下是AWS基于KVM技术提供的最新示例部分性能。</p>
<table>
<thead>
<tr>
<th>Instance Name</th>
<th>vCPUs</th>
<th>RAM</th>
<th>EBS Bandwidth</th>
<th>Network Bandwidth</th>
</tr>
</thead>
<tbody><tr>
<td>c5.large</td>
<td>2</td>
<td>4 GiB</td>
<td>Up to 2.25 Gbps</td>
<td>Up to 10 Gbps</td>
</tr>
<tr>
<td>c5.xlarge</td>
<td>4</td>
<td>8 GiB</td>
<td>Up to 2.25 Gbps</td>
<td>Up to 10 Gbps</td>
</tr>
<tr>
<td>c5.2xlarge</td>
<td>8</td>
<td>16 GiB</td>
<td>Up to 2.25 Gbps</td>
<td>Up to 10 Gbps</td>
</tr>
<tr>
<td>c5.4xlarge</td>
<td>16</td>
<td>32 GiB</td>
<td>2.25 Gbps</td>
<td>Up to 10 Gbps</td>
</tr>
<tr>
<td>c5.9xlarge</td>
<td>36</td>
<td>72 GiB</td>
<td>4.5 Gbps</td>
<td>10 Gbps</td>
</tr>
<tr>
<td>c5.18xlarge</td>
<td>72</td>
<td>144 GiB</td>
<td>9 Gbps</td>
<td>25 Gbps</td>
</tr>
</tbody></table>
<p>KVM的虚拟化需要硬件支持（如Intel VT技术或者AMD V技术)，是基于硬件的完全虚拟化，而Xen早期则是基于软件模拟的半虚拟化，新版本则是支持基于硬件支持的完全虚拟化，但Xen本身有自己的进程调度器，存储管理模块等，所以代码较为庞大.</p>
<p>广为流传的商业系统虚拟化软件VMware ESXI系列是Full-Virtualization</p>
<h3 id="2-1-4-RHEL-CentOS-对虚拟设备三种工作模式"><a href="#2-1-4-RHEL-CentOS-对虚拟设备三种工作模式" class="headerlink" title="2.1.4 RHEL(CentOS)对虚拟设备三种工作模式"></a>2.1.4 RHEL(CentOS)对虚拟设备三种工作模式</h3><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Red</span> <span class="hljs-variable">Hat</span> <span class="hljs-variable">Enterprise</span> <span class="hljs-variable">Linux</span> <span class="hljs-number">7</span> 的虚拟化功能为虚拟机提供了三种不同形式的系统设备。这些硬件设备都被显示为物理连接到虚拟机，但设备的驱动以不同方式工作。这三种形式包括：<br>虚拟和仿真设备<br>半虚拟化设备<br>物理共享设备<br></code></pre></td></tr></table></figure>

<h5 id="2-1-2-4-1-虚拟和仿真设备"><a href="#2-1-2-4-1-虚拟和仿真设备" class="headerlink" title="2.1.2.4.1 虚拟和仿真设备"></a>2.1.2.4.1 虚拟和仿真设备</h5><p>KVM 实现了虚拟机的多个核心设备。这些仿真硬件设备对虚拟化操作系统至关重要。仿真设备即完全使用软件实现的虚拟化设备<br>仿真驱动可能使用物理设备，或虚拟化软件设备。仿真驱动是虚拟机和 Linux 内核（管理源设备）间的“翻译层”。设备层的指示会由 KVM 虚拟机监控程序进行完全转换。任何可以被 Linux 内核识别的同类设备（储存、网络、键盘和鼠标），都可以作为仿真驱动的后端源设备</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs tap">虚拟化 CPU （vCPU）：无论主机 CPU 的数量有多少，主机系统都可以为客机提供多达<span class="hljs-number"> 160 </span>个虚拟化CPU （vCPU）<br><br>仿真图形设备：有两种仿真图形设备可供选择。这类设备可以使用 SPICE （Simple Protocol for Independent Computing Environments）协议或 VNC 进行连接：Cirrus CLGD<span class="hljs-number"> 5446 </span>PCI VGA 卡（使用 cirrus 设备）标准 VGA 图形卡，带有 Bochs VESA 扩展程序（硬件等级，包括所有非标准模式）<br><br>仿真系统组件：仿真以下核心系统组件来提供基本系统功能：Intel i440FX 主机 PCI 网桥，PIIX3 PCI 到 ISA 的网桥，PS/2 鼠标和键盘，EvTouch USB 图形平板设备，PCI UHCI USB 控制器与虚拟化 USB 集线器，仿真串口，EHCI 控制器，虚拟化 USB 存储和 USB 鼠标，USB 3.0 xHCI 主机控制器<br><br>仿真声音设备<br><br>仿真监视器设备：提供了两种仿真监视器设备。监视器可以在虚拟机超载或未响应时，自动重启虚拟机。watchdog 程序包务必安装在客机上<br>两种可供选择的设备为：<br>i6300esb，仿真 Intel<span class="hljs-number"> 6300 </span>ESB PCI 监视器设备。为推荐使用设备<br>ib700，仿真 iBase<span class="hljs-number"> 700 </span>ISA 监视器设备<br><br><br>仿真网络设备<br>两种仿真网络设备可供选择：<br>e1000 设备仿真了 Intel E1000 网络适配器（Intel 82540EM、82573L、82544GC）<br>rtl8139 设备仿真了 Realtek<span class="hljs-number"> 8139 </span>网络适配器。<br>仿真储存驱动：储存驱动与储存池可以使用这些仿真设备，将储存设备与虚拟机相连。客机使用仿真储存驱动可访问储存池<br>注意，同所有虚拟设备一样，储存驱动不是储存设备。对于虚拟机器，该驱动作为备用储存设备、文件或储存池容量进行使用。备用储存设备可为任何支持的储存设备、文件、或储存池容量形式<br><br>仿真 IDE 驱动：KVM 提供两种仿真 PCI IDE 接口。仿真 IDE 驱动可以用于将多达四个虚拟化 IDE 硬盘或虚拟化 IDE 光盘驱动组合与每台虚拟机相连接。仿真 IDE 驱动同样可用于虚拟化 CDROM和 DVD-ROM驱动<br><br>仿真软盘驱动：仿真软盘驱动用于创造虚拟化软驱<br><br>仿真 AHCI 控制器：仿真 Advanced Host Controller Interface（AHCI）是 IDE 的一种替代产品<br></code></pre></td></tr></table></figure>

<h5 id="2-1-2-4-2-半虚拟化设备"><a href="#2-1-2-4-2-半虚拟化设备" class="headerlink" title="2.1.2.4.2 半虚拟化设备"></a>2.1.2.4.2 半虚拟化设备</h5><p>半虚拟化设备：半虚拟化为客机使用主机上的设备提供了快速且高效的通讯方式。KVM 为虚拟机提供准虚拟化设备，它使用Virtio API 作为虚拟机监控程序和客机的中间层一些半虚拟化设备可以减少 I/O 的延迟，并把 I/O 的吞吐量提高至近裸机水平，而其它准虚拟化设备可以把本来无法使用的功能添加到虚拟机上。当虚拟机运行大小需要密集 I/O 操作的应用程序时，推荐使用半虚拟化设备，而不是使用仿真设备所有 virtio 设备都有两部分：主机设备和客机驱动。半虚拟化设备驱动允许客机操作系统访问主机系统上的物理设备半虚拟化设备的驱动必须安装在客机操作系统上。半虚拟化设备驱动须在 Windows 客机上手动安装</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs less">半虚拟化网络设备（<span class="hljs-selector-tag">virtio-net</span>）：半虚拟化网络设备是虚拟化网络设备，它为虚拟机提供了网络访问能力，并可以提供网络性能及减少网络延迟。<br><br>半虚拟化块设备（<span class="hljs-selector-tag">virtio-blk</span>）：半虚拟化块设备是高性能虚拟化储存设备，它可以为虚拟机提供高性能、低延迟的 <span class="hljs-selector-tag">I</span>/<span class="hljs-selector-tag">O</span> 存储。半虚拟化块设备由虚拟机监控程序支持，与虚拟机相连（软盘驱动除外，它只能被仿真）<br><br>半虚拟化控制器设备（<span class="hljs-selector-tag">virtio-scsi</span>）：半虚拟化 <span class="hljs-selector-tag">SCSI</span> 控制器设备是一种更为灵活且可扩展的 <span class="hljs-selector-tag">virtio-blk</span> 替代品。<span class="hljs-selector-tag">virtio-scsi</span> 客机能继承目标设备的各种特征，并且能操作几百个设备，相比之下，<span class="hljs-selector-tag">virtio-blk</span> 仅能处理 <span class="hljs-selector-tag">28</span><br><br>半虚拟化时钟：使用时间戳计数器（<span class="hljs-selector-tag">TSC</span>，<span class="hljs-selector-tag">Time</span> <span class="hljs-selector-tag">Stamp</span> <span class="hljs-selector-tag">Counter</span>）作为时钟源的客机可能会出现与时间相关的问题。<span class="hljs-selector-tag">KVM</span> 在主机外围工作，这些主机在向客机提供半虚拟化时间时没有固定的 <span class="hljs-selector-tag">TSC</span>。此外，半虚拟化时钟会在客机运行 <span class="hljs-selector-tag">S3</span> 或挂起 <span class="hljs-selector-tag">RAM</span> 时帮助调整所需时间。半虚拟化时钟不支持 <span class="hljs-selector-tag">Windows</span> 客机<br><br>半虚拟化串口设备 (virtio-serial)：半虚拟化串口设备是面向比特流的字符流设备，它为主机用户空间与客机用户空间之间提供了一个简单的交流接口气球设备（<span class="hljs-selector-tag">virtio-balloon</span>）：气球（<span class="hljs-selector-tag">ballon</span>）设备可以指定虚拟机的部分内存为没有被使用（这个过程被称为气球“充气 ” —<span class="hljs-selector-tag">inflation</span>），从而使这部分内存可以被主机（或主机上的其它虚拟机）使用。当虚拟机这部分内存时，气球可以进行“放气 ”（<span class="hljs-selector-tag">deflated</span>），主机就会把这部分内存重新分配给虚拟机<br><br>半虚拟化随机数字生成器 （<span class="hljs-selector-tag">virtio-rng</span>：半虚拟化随机数字生成器使虚拟机可以直接从主机收集熵或随意值来使用，以进行数据加密和安全。因为典型的输入数据（如硬件使用情况）不可用，虚拟机常常急需熵。取得熵很耗时；<span class="hljs-selector-tag">virtiorng</span>通过直接把熵从主机注入客机虚拟机从而使这个过程加快<br><br>半虚拟化图形卡（<span class="hljs-selector-tag">QXL</span>）：半虚拟化图形卡与 <span class="hljs-selector-tag">QXL</span> 驱动一同提供了一个有效地显示来自远程主机的虚拟机图形界面。<span class="hljs-selector-tag">SPICE</span>需要 <span class="hljs-selector-tag">QXL</span> 驱动<br></code></pre></td></tr></table></figure>

<h5 id="2-1-2-4-3-透传物理主机设备"><a href="#2-1-2-4-3-透传物理主机设备" class="headerlink" title="2.1.2.4.3 透传物理主机设备"></a>2.1.2.4.3 透传物理主机设备</h5><p>物理主机设备：特定硬件平台允许虚拟机直接访问多种硬件设备及组件。在虚拟化中，此操作被称为“设备分配 ”（device assignment）。设备分配又被称作 “传递 ”（passthrough）</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">VFIO</span> 设备分配：虚拟功能 <span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span>（<span class="hljs-variable">VFIO</span>）是 <span class="hljs-variable">RHEL</span> <span class="hljs-number">7</span> 中一个新的内核驱动，它为虚拟机提供了高性能的访问物理硬件。<span class="hljs-variable">VFIO</span> 把主机系统上的 <span class="hljs-variable">PCI</span> 设备与虚拟机直接相连，允许客机在执行特定任务时有独自访问<span class="hljs-variable">PCI</span> 设备的权限。这就象 <span class="hljs-variable">PCI</span> 设备物理地连接到客机虚拟机上一样。通过把设备分配从 <span class="hljs-variable">KVM</span> 虚拟机监控系统中移出，并在内核级中强制进行设备隔离，<span class="hljs-variable">VFIO</span> 比以前的<span class="hljs-variable">PCI</span> 设备分配有很大改进。<span class="hljs-variable">VFIO</span> 安全性更高。<span class="hljs-variable">VFIO</span> 也支持对<span class="hljs-variable">NVIDIA</span> <span class="hljs-variable">GPU</span> 的分配<br><br><span class="hljs-variable">USB</span> 传递：<span class="hljs-variable">KVM</span> <span class="hljs-variable">hyperviso</span> 支持把主机系统上的 <span class="hljs-variable">USB</span> 设备连接到虚拟机。<span class="hljs-variable">USB</span> 设备分配允许客机拥有在执行特定任务时有专有访问 <span class="hljs-variable">USB</span> 设备的权利。这就象 <span class="hljs-variable">USB</span> 设备物理地连接到虚拟机上一样<br><br><span class="hljs-variable">SR</span><span class="hljs-operator">-</span><span class="hljs-variable">IOV</span>：<span class="hljs-variable">SR</span><span class="hljs-operator">-</span><span class="hljs-variable">IOV</span> （<span class="hljs-variable">Single</span> <span class="hljs-built_in">Root</span> <span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span> <span class="hljs-variable">Virtualization</span>）是一个 <span class="hljs-variable">PCI</span> 快捷标准，把单一物理 <span class="hljs-variable">PCI</span>功能扩展到同分散的虚拟化功能（<span class="hljs-variable">VF</span>）一样共享 <span class="hljs-variable">PCI</span> 资源。通过 <span class="hljs-variable">PCI</span> 设备分配，每个功能可以被不同虚拟机使用。支持 <span class="hljs-variable">SR</span><span class="hljs-operator">-</span><span class="hljs-variable">IOV</span> 的 <span class="hljs-variable">PCI</span><span class="hljs-operator">-</span><span class="hljs-variable">e</span> 设备提供一个单一根功能（如单一以太网接口），并把多个各自分离的虚拟设备作为独特 <span class="hljs-variable">PCI</span> 设备功能。每个虚拟化设备都可能有自身独特的 <span class="hljs-variable">PCI</span> 配置空间、内存映射的寄存器以及单独的基于 <span class="hljs-variable">MSI</span> 的中断系统<br><br><span class="hljs-variable">NPIV</span>：<span class="hljs-type">N_Port</span> <span class="hljs-variable">ID</span> <span class="hljs-variable">Virtualization</span>（<span class="hljs-variable">NPIV</span>）是对光纤通道设备有效的功能。<span class="hljs-variable">NPIV</span> 共享单一物理<span class="hljs-type">N_Port</span> 作为多个 <span class="hljs-type">N_Port</span> <span class="hljs-variable">ID</span>。<span class="hljs-variable">NPIV</span> 为 <span class="hljs-variable">HBA</span>（光纤通道主机总线适配器，<span class="hljs-variable">Fibre</span> <span class="hljs-variable">Channel</span> <span class="hljs-variable">Host</span> <span class="hljs-variable">BusAdapter</span>）提供和 <span class="hljs-variable">SR</span><span class="hljs-operator">-</span><span class="hljs-variable">IOV</span> 为 <span class="hljs-variable">PCIe</span> 接口提供的功能相似的功能。有了 <span class="hljs-variable">NPIV</span>，可以为 <span class="hljs-variable">SAN</span>（存储区域网络，<span class="hljs-variable">Storage</span> <span class="hljs-built_in">Area</span> <span class="hljs-variable">Network</span>）提供带有虚拟光纤通道发起程序的虚拟机。<span class="hljs-variable">NPIV</span> 可以提供带有企业级存储解决方案的高密度虚拟环境<br></code></pre></td></tr></table></figure>

<h3 id="2-1-5-KVM-集中管理与控制"><a href="#2-1-5-KVM-集中管理与控制" class="headerlink" title="2.1.5 KVM 集中管理与控制"></a>2.1.5 KVM 集中管理与控制</h3><p><a target="_blank" rel="noopener" href="http://www.linux-kvm.org/page/Management_Tools">http://www.linux-kvm.org/page/Management_Tools</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm27.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li>oVirt功能强大，是Redhat虚拟化管理平台RHEV的开源版本。<br><a target="_blank" rel="noopener" href="http://www.ovirt.org/">http://www.ovirt.org/</a></li>
<li>WebVirtMgr<br><a target="_blank" rel="noopener" href="https://www.webvirtmgr.net/">https://www.webvirtmgr.net</a><br>virt-manager的Web模式的替代品</li>
<li>OpenStack 最主流的开源虚拟化管理平台</li>
<li>Proxmox virtualization environment<br> 简称PVE，是一个开源免费的基于linux的企业级虚拟化方案，功能不输专业收费的VMware。是一个完整的企业虚拟化开源平台。借助内置的Web界面，您可以轻松管理VM和容器，软件定义的存储和网络，高可用性集群以及单个解决方案上的多个开箱即用工具。</li>
</ul>
<h2 id="2-2-宿主机环境准备"><a href="#2-2-宿主机环境准备" class="headerlink" title="2.2 宿主机环境准备"></a>2.2 宿主机环境准备</h2><p>KVM需要宿主机CPU必须支持虚拟化功能，因此如果是在vmware workstation上使用虚拟机做宿主机，那么必须要在虚拟机配置界面的处理器选项中开启虚拟机化功能。</p>
<h3 id="2-2-1-CPU开启虚拟化"><a href="#2-2-1-CPU开启虚拟化" class="headerlink" title="2.2.1 CPU开启虚拟化"></a>2.2.1 CPU开启虚拟化</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm28.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-2-2-验证开启虚拟化"><a href="#2-2-2-验证开启虚拟化" class="headerlink" title="2.2.2 验证开启虚拟化"></a>2.2.2 验证开启虚拟化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep -Em 1  <span class="hljs-string">&quot;vmx|svm&quot;</span> /proc/cpuinfo<br><br><span class="hljs-comment">#Intel CPU 对应 vmx</span><br><span class="hljs-comment">#AMD CPU 对应 svm</span><br></code></pre></td></tr></table></figure>

<p>范例: 验证是否开启虚拟化支持</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># grep -Em 1 &quot;vmx|svm&quot; /proc/cpuinfo</span><br>flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc rep_good nopl tsc_reliable nonstop_tsc cpuid extd_apicid aperfmperf pni pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c hypervisor lahf_lm svm extapic cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw ssbd mba ibpb stibp vmmcall fsgsbase bmi1 avx2 smep bmi2 adx smap xsaveopt xsavec xgetbv1 xsaves clzero irperf xsaveerptr wbnoinvd arat npt svm_lock nrip_save vmcb_clean flushbyasid decodeassists<br><br>[root@centos7 ~]<span class="hljs-comment"># grep -Em 1  &quot;vmx|svm&quot; /proc/cpuinfo</span><br>flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc art rep_good nopl tsc_reliable nonstop_tsc extd_apicid aperfmperf eagerfpu pni pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c hypervisor lahf_lm svm extapic cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw fsgsbase bmi1 avx2 smep bmi2 adx smap xsaveopt xsavec xgetbv1 arat npt svm_lock nrip_save vmcb_clean flushbyasid decodeassists<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm29.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm30.png" srcset="/blog/img/loading.gif"></p>
<p>范例: 查看AMD主机的内核模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># lscpu|grep svm</span><br>Flags:               fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc rep_good nopl tsc_reliable nonstop_tsc cpuid extd_apicid aperfmperf pni pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c hypervisor lahf_lm svm extapic cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw ssbd mba ibpb stibp vmmcall fsgsbase bmi1 avx2 smep bmi2 adx smap xsaveopt xsavec xgetbv1 xsaves clzero irperf xsaveerptr wbnoinvd arat npt svm_lock nrip_save vmcb_clean flushbyasid decodeassists<br><br>[root@centos8 ~]<span class="hljs-comment"># lsmod |grep kvm</span><br>kvm_amd               110592  0<br>ccp                    98304  1 kvm_amd<br>kvm                   798720  1 kvm_amd<br>irqbypass              16384  1 kvm<br><br>[root@centos8 ~]<span class="hljs-comment"># ll /dev/kvm</span><br>crw-rw-rw- 1 root kvm 10, 232 Jul 30 21:09 /dev/kvm<br><br>[root@centos7 ~]<span class="hljs-comment"># lscpu|grep svm</span><br>Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc art rep_good nopl tsc_reliable nonstop_tsc extd_apicid aperfmperf eagerfpu pni pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c hypervisor lahf_lm svm extapic cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw fsgsbase bmi1 avx2 smep bmi2 adx smap xsaveopt xsavec xgetbv1 arat npt svm_lock nrip_save vmcb_clean flushbyasid decodeassists<br><br>[root@centos7 ~]<span class="hljs-comment"># lsmod |grep kvm</span><br>kvm_amd                69849  0 <br>kvm                   566340  1 kvm_amd<br>irqbypass              13503  1 kvm<br><br>[root@centos7 ~]<span class="hljs-comment"># ll /dev/kvm</span><br>crw------- 1 root root 10, 232 Jul 30 21:05 /dev/kvm<br></code></pre></td></tr></table></figure>

<h2 id="2-3-安装KVM工具包"><a href="#2-3-安装KVM工具包" class="headerlink" title="2.3 安装KVM工具包"></a>2.3 安装KVM工具包</h2><h3 id="2-3-1-KVM-相关工具包介绍"><a href="#2-3-1-KVM-相关工具包介绍" class="headerlink" title="2.3.1 KVM 相关工具包介绍"></a>2.3.1 KVM 相关工具包介绍</h3><ul>
<li>qemu-kvm: 为kvm提供底层仿真支持</li>
<li>libvirt-daemon: libvirtd守护进程，管理虚拟机</li>
<li>libvirt-client: 用户端软件，提供客户端管理命令</li>
<li>libvirt-daemon-driver-qemu: libvirtd连接qemu的驱动libvirt: 使用最多的KVM虚拟化管理工具和应用程序接口，即通过libvirt调用KVM创建虚拟机，<br>libvirt是KVM通用的访问API，其不但能管理KVM，还能管理VMware、Xen、Hyper-V、virtualBox等虚拟化方案。</li>
<li>virt-manager: 图形界面管理工具,其底层也是调用libvirt API来完成对虚拟机的操作，包括虚拟机的创建、删除、启动、停止以及一些简单的监控功能等。</li>
<li>virt-install: 虚拟机命令行安装工具</li>
<li>virsh: 命令行工具是基于 libvirt API 创建的命令行工具，它可以作为图形化的 virt-manager 应用的备选工具。virsh 命令可以被用来创建虚拟化任务管理脚本，如安装、启动和停止虚拟机</li>
<li>virt-viewer: 通过 VNC 和 SPICE 协议显示虚拟机器图形控制台的最小工具。该工具在其同名软件包中：virtviewer</li>
<li>cockpit: CentOS8 专门提供的基于Web的虚拟机管理界面</li>
</ul>
<h3 id="2-3-2-libvirt-包功能"><a href="#2-3-2-libvirt-包功能" class="headerlink" title="2.3.2 libvirt 包功能"></a>2.3.2 libvirt 包功能</h3><h4 id="2-3-2-1-libvirt-介绍"><a href="#2-3-2-1-libvirt-介绍" class="headerlink" title="2.3.2.1 libvirt 介绍"></a>2.3.2.1 libvirt 介绍</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm31.png" srcset="/blog/img/loading.gif"></p>
<p>libvirt 程序包是一个与虚拟机监控程序相独立的虚拟化应用程序接口，它可以与操作系统的一系列虚拟化性能进行交互</p>
<p>libvirt 程序包提供：</p>
<ul>
<li>一个稳定的通用层来安全地管理主机上的虚拟机。</li>
<li>一个管理本地系统和连网主机的通用接口。</li>
</ul>
<p>在虚拟机监控程序支持的情况下，部署、创建、修改、监测、控制、迁移以及停止虚拟机操作都需要这些API。尽管 libvirt 可同时访问多个主机，但 API 只限于单节点操作</p>
<p>libvirt 程序包被设计为用来构建高级管理工具和应用程序，例如 virt-manager 与 virsh 命令行管理工具。libvirt 主要的功能是管理单节点主机，并提供 API 来列举、监测和使用管理节点上的可用资源，其中包括CPU、内存、储存、网络和非一致性内存访问（NUMA）分区。管理工具可以位于独立于主机的物理机上，并通过安全协议和主机进行交流</p>
<h4 id="2-3-2-2-libvirt-结构图"><a href="#2-3-2-2-libvirt-结构图" class="headerlink" title="2.3.2.2 libvirt 结构图"></a>2.3.2.2 libvirt 结构图</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm32.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-3-3-安装KVM相关包"><a href="#2-3-3-安装KVM相关包" class="headerlink" title="2.3.3 安装KVM相关包"></a>2.3.3 安装KVM相关包</h3><h4 id="2-3-3-1-CentOS-安装-KVM"><a href="#2-3-3-1-CentOS-安装-KVM" class="headerlink" title="2.3.3.1 CentOS 安装 KVM"></a>2.3.3.1 CentOS 安装 KVM</h4><p>使用虚拟化，需要至少 qemu-kvm 和 qemu-img(安装qemu-kvm会自动安装) 软件包</p>
<p>建议安装：yum install qemu-kvm libvirt virt-manager virt-install</p>
<p>范例: CentOS 8 安装 KVM相关工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install qemu-kvm libvirt virt-manager virt-install virt-viewer</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl start --now libvirtd</span><br></code></pre></td></tr></table></figure>

<p>范例: CentOS 8 还提供基于Web的虚拟机管理方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install cockpit</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable --now cockpit.socket</span><br>Created symlink /etc/systemd/system/sockets.target.wants/cockpit.socket → /usr/lib/systemd/system/cockpit.socket.<br>[root@centos8 ~]<span class="hljs-comment"># dnf -y install cockpit</span><br><br><span class="hljs-comment">#打开浏览器，访问以下地址：</span><br>https://centos8主机:9090<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm33.png" srcset="/blog/img/loading.gif"></p>
<h5 id="2-3-3-2-Ubuntu-安装-KVM"><a href="#2-3-3-2-Ubuntu-安装-KVM" class="headerlink" title="2.3.3.2 Ubuntu 安装 KVM"></a>2.3.3.2 Ubuntu 安装 KVM</h5><p>Ubuntu 18.04：<br>官方文档: <a target="_blank" rel="noopener" href="https://ubuntu.com/server/docs/virtualization-libvirt">https://ubuntu.com/server/docs/virtualization-libvirt</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># apt install qemu-kvm virt-manager libvirt-daemon-system</span><br><span class="hljs-comment"># kvm-ok #验证是否支持kvm,只有Ubuntu支持,CentOS 不支持</span><br>INFO: /dev/kvm exists<br>KVM acceleration can be used<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment"># apt -y install qemu-kvm virt-manager libvirt-daemon-system</span><br>[root@ubuntu1804 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:40:27:06 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe40:2706/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN<br>group default qlen 1000<br> link/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff<br> inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>   valid_lft forever preferred_lft forever<br>4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state<br>DOWN group default qlen 1000<br> link/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff<br> <br><span class="hljs-comment">#如果没有开启CPU虚拟化功能会提示以下信息</span><br>[root@ubuntu1804 ~]<span class="hljs-comment"># kvm-ok</span><br>INFO: Your CPU does not support KVM extensions<br>KVM acceleration can NOT be used<br><br><span class="hljs-comment">#添加CPU的虚拟化支持再执行</span><br>[root@ubuntu1804 ~]<span class="hljs-comment"># kvm-ok</span><br>INFO: /dev/kvm exists<br>KVM acceleration can be used<br></code></pre></td></tr></table></figure>

<h3 id="2-2-4-图形化工具-virt-manager"><a href="#2-2-4-图形化工具-virt-manager" class="headerlink" title="2.2.4 图形化工具 virt-manager"></a>2.2.4 图形化工具 virt-manager</h3><p>范例: CentOS 上管理工具 virt-manager</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先现在xmanager，然后安装，最后打开xmanager</span><br><span class="hljs-comment">#执行一下命令</span><br>[root@centos8 ~]<span class="hljs-comment"># export DISPLAY=10.0.0.1:0.0</span><br>[root@centos8 ~]<span class="hljs-comment"># virt-manager</span><br>[root@centos8 ~]<span class="hljs-comment"># libGL error: No matching fbConfigs or visuals found</span><br>libGL error: failed to load driver: swrast<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm34.png" srcset="/blog/img/loading.gif"></p>
<p>范例: Ubuntu 上管理工具 virt-manager</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment"># virt-manager</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm35.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-2-5-默认网络配置"><a href="#2-2-5-默认网络配置" class="headerlink" title="2.2.5 默认网络配置"></a>2.2.5 默认网络配置</h3><p>安装完虚拟工具后,会自动生成一个 virbr0 网卡,类似于Vmware workstation 生成的VMnet8 网卡,充当<br>虚拟机的 NAT 网卡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:ed brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.201/24 brd 10.0.0.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::a8be:f183:9c8f:7fee/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br>3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>       valid_lft forever preferred_lft forever<br>4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br> <br>[root@centos8 ~]<span class="hljs-comment"># grep -R 192.168.122.1 /etc/libvirt/*</span><br>/etc/libvirt/qemu/networks/autostart/default.xml:  &lt;ip address=<span class="hljs-string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="hljs-string">&#x27;255.255.255.0&#x27;</span>&gt;<br>/etc/libvirt/qemu/networks/default.xml:  &lt;ip address=<span class="hljs-string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="hljs-string">&#x27;255.255.255.0&#x27;</span>&gt;<br>[root@centos8 ~]<span class="hljs-comment"># ip a show virbr0</span><br>3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>       valid_lft forever preferred_lft forever<br>   <br>[root@centos8 ~]<span class="hljs-comment">#cat /etc/libvirt/qemu/networks/default.xml</span><br>&lt;!--<br>WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br>OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br>  virsh net-edit default<br>or other application using the libvirt API.<br>--&gt;<br><br>&lt;network&gt;<br>  &lt;name&gt;default&lt;/name&gt;<br>  &lt;uuid&gt;18af3672-ec30-4a3c-9299-7f74072414c1&lt;/uuid&gt;<br>  &lt;forward mode=<span class="hljs-string">&#x27;nat&#x27;</span>/&gt;<br>  &lt;bridge name=<span class="hljs-string">&#x27;virbr0&#x27;</span> stp=<span class="hljs-string">&#x27;on&#x27;</span> delay=<span class="hljs-string">&#x27;0&#x27;</span>/&gt;<br>  &lt;mac address=<span class="hljs-string">&#x27;52:54:00:b9:24:09&#x27;</span>/&gt;<br>  &lt;ip address=<span class="hljs-string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="hljs-string">&#x27;255.255.255.0&#x27;</span>&gt;<br>    &lt;dhcp&gt;<br>      &lt;range start=<span class="hljs-string">&#x27;192.168.122.2&#x27;</span> end=<span class="hljs-string">&#x27;192.168.122.254&#x27;</span>/&gt;<br>    &lt;/dhcp&gt;<br>  &lt;/ip&gt;<br>&lt;/network&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># nmcli connection show virbr0</span><br>connection.id:                          virbr0<br>connection.uuid:                        aa096851-9ddb-49fa-8ee8-0da0ddde297f<br>connection.stable-id:                   --<br>connection.type:                        bridge<br>connection.interface-name:              virbr0<br>connection.autoconnect:                 no<br>connection.autoconnect-priority:        0<br>connection.autoconnect-retries:         -1 (default)<br>connection.multi-connect:               0 (default)<br>connection.auth-retries:                -1<br>connection.timestamp:                   1627742436<br>connection.read-only:                   no<br>connection.permissions:                 --<br>connection.zone:                        --<br>connection.master:                      --<br>connection.slave-type:                  --<br>connection.autoconnect-slaves:          -1 (default)<br>connection.secondaries:                 --<br>connection.gateway-ping-timeout:        0<br>connection.metered:                     unknown<br>connection.lldp:                        default<br>connection.mdns:                        -1 (default)<br>connection.llmnr:                       -1 (default)<br>connection.wait-device-timeout:         -1<br>ipv4.method:                            manual<br>ipv4.dns:                               --<br>ipv4.dns-search:                        --<br>ipv4.dns-options:                       --<br>ipv4.dns-priority:                      100<br>ipv4.addresses:                         192.168.122.1/24<br>ipv4.gateway:                           --<br>ipv4.routes:                            --<br>ipv4.route-metric:                      -1<br>ipv4.route-table:                       0 (unspec)<br>ipv4.routing-rules:                     --<br>ipv4.ignore-auto-routes:                no<br>ipv4.ignore-auto-dns:                   no<br>ipv4.dhcp-client-id:                    --<br>ipv4.dhcp-iaid:                         --<br>ipv4.dhcp-timeout:                      0 (default)<br>ipv4.dhcp-send-hostname:                yes<br>ipv4.dhcp-hostname:                     --<br>ipv4.dhcp-fqdn:                         --<br>ipv4.dhcp-hostname-flags:               0x0 (none)<br>ipv4.never-default:                     no<br>ipv4.may-fail:                          yes<br>ipv4.dad-timeout:                       -1 (default)<br>ipv4.dhcp-vendor-class-identifier:      --<br>ipv6.method:                            ignore<br>ipv6.dns:                               --<br>ipv6.dns-search:                        --<br>ipv6.dns-options:                       --<br>ipv6.dns-priority:                      100<br>ipv6.addresses:                         --<br>ipv6.gateway:                           --<br>ipv6.routes:                            --<br>ipv6.route-metric:                      -1<br>ipv6.route-table:                       0 (unspec)<br>ipv6.routing-rules:                     --<br>ipv6.ignore-auto-routes:                no<br>ipv6.ignore-auto-dns:                   no<br>ipv6.never-default:                     no<br>ipv6.may-fail:                          yes<br>ipv6.ip6-privacy:                       -1 (unknown)<br>ipv6.addr-gen-mode:                     stable-privacy<br>ipv6.ra-timeout:                        0 (default)<br>ipv6.dhcp-duid:                         --<br>ipv6.dhcp-iaid:                         --<br>ipv6.dhcp-timeout:                      0 (default)<br>ipv6.dhcp-send-hostname:                yes<br>ipv6.dhcp-hostname:                     --<br>ipv6.dhcp-hostname-flags:               0x0 (none)<br>ipv6.token:                             --<br>bridge.mac-address:                     --<br>bridge.stp:                             yes<br>bridge.priority:                        32768<br>bridge.forward-delay:                   2<br>bridge.hello-time:                      2<br>bridge.max-age:                         20<br>bridge.ageing-time:                     300<br>bridge.group-forward-mask:              0<br>bridge.multicast-hash-max:              512<br>bridge.multicast-snooping:              yes<br>bridge.vlan-filtering:                  no<br>bridge.vlan-default-pvid:               1<br>bridge.vlans:                           --<br>proxy.method:                           none<br>proxy.browser-only:                     no<br>proxy.pac-url:                          --<br>proxy.pac-script:                       --<br>GENERAL.NAME:                           virbr0<br>GENERAL.UUID:                           aa096851-9ddb-49fa-8ee8-0da0ddde297f<br>GENERAL.DEVICES:                        virbr0<br>GENERAL.IP-IFACE:                       virbr0<br>GENERAL.STATE:                          activated<br>GENERAL.DEFAULT:                        no<br>GENERAL.DEFAULT6:                       no<br>GENERAL.SPEC-OBJECT:                    --<br>GENERAL.VPN:                            no<br>GENERAL.DBUS-PATH:                      /org/freedesktop/NetworkManager/ActiveConnection/2<br>GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/Settings/2<br>GENERAL.ZONE:                           --<br>GENERAL.MASTER-PATH:                    --<br>IP4.ADDRESS[1]:                         192.168.122.1/24<br>IP4.GATEWAY:                            --<br>IP4.ROUTE[1]:                           dst = 192.168.122.0/24, nh = 0.0.0.0, mt = 0<br>IP6.GATEWAY:                            --<br><br>[root@centos8 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>范例: Ubuntu 网络配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:40:27:06 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0<br>  valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe40:2706/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN<br>group default qlen 1000<br> link/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff<br> inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>   valid_lft forever preferred_lft forever<br>4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state<br>DOWN group default qlen 1000<br> link/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff<br>[root@ubuntu1804 ~]<span class="hljs-comment"># brctl show</span><br>bridge name bridge id STP enabled interfaces<br>virbr0 8000.5254008da6fe yes virbr0-nic<br><br>[root@ubuntu1804 ~]<span class="hljs-comment"># cat /etc/libvirt/qemu/networks/default.xml</span><br>&lt;!--<br>WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br>OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br>virsh net-edit default<br>or other application using the libvirt API.<br>--&gt;<br>&lt;network&gt;<br>&lt;name&gt;default&lt;/name&gt;<br>&lt;uuid&gt;a3235b68-6dc0-4951-8a35-7a60a567f1a7&lt;/uuid&gt;<br>&lt;forward mode=<span class="hljs-string">&#x27;nat&#x27;</span>/&gt;<br>&lt;bridge name=<span class="hljs-string">&#x27;virbr0&#x27;</span> stp=<span class="hljs-string">&#x27;on&#x27;</span> delay=<span class="hljs-string">&#x27;0&#x27;</span>/&gt;<br>&lt;mac address=<span class="hljs-string">&#x27;52:54:00:8d:a6:fe&#x27;</span>/&gt;<br>&lt;ip address=<span class="hljs-string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="hljs-string">&#x27;255.255.255.0&#x27;</span>&gt;<br> &lt;dhcp&gt;<br>  &lt;range start=<span class="hljs-string">&#x27;192.168.122.2&#x27;</span> end=<span class="hljs-string">&#x27;192.168.122.254&#x27;</span>/&gt;<br> &lt;/dhcp&gt;<br>&lt;/ip&gt;<br>&lt;/network&gt;<br></code></pre></td></tr></table></figure>

<h2 id="2-4-准备安装系统的ISO相关文件"><a href="#2-4-准备安装系统的ISO相关文件" class="headerlink" title="2.4 准备安装系统的ISO相关文件"></a>2.4 准备安装系统的ISO相关文件</h2><p>将需要安装的系统的ISO文件上传到宿主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># mkdir -pv /data/isos/</span><br>[root@centos8 ~]<span class="hljs-comment"># ls /data/isos/</span><br>CentOS-7-x86_64-Minimal-2003.iso<br>CentOS-8.2.2004-x86_64-minimal.iso<br>cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso<br></code></pre></td></tr></table></figure>

<h2 id="2-5-AMD-CPU-创建虚拟机时的故障排错"><a href="#2-5-AMD-CPU-创建虚拟机时的故障排错" class="headerlink" title="2.5 AMD CPU 创建虚拟机时的故障排错"></a>2.5 AMD CPU 创建虚拟机时的故障排错</h2><p>AMD CPU 使用virt-manager 或 virt-install 在创建虚拟机可能会出错,用下面方法解决</p>
<h3 id="2-5-1-AMD-CPU-使用virt-manager创建虚拟机出错提示"><a href="#2-5-1-AMD-CPU-使用virt-manager创建虚拟机出错提示" class="headerlink" title="2.5.1 AMD CPU 使用virt-manager创建虚拟机出错提示"></a>2.5.1 AMD CPU 使用virt-manager创建虚拟机出错提示</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm36.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-5-2-AMD-CPU-使用virt-install创建虚拟机出错提示"><a href="#2-5-2-AMD-CPU-使用virt-install创建虚拟机出错提示" class="headerlink" title="2.5.2 AMD CPU 使用virt-install创建虚拟机出错提示"></a>2.5.2 AMD CPU 使用virt-install创建虚拟机出错提示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virt-install --virt-type kvm --name centos7 --ram 1024 --vcpus 2 --cdrom=/data/isos/CentOS-7-x86_64-Minimal-2003.iso --disk path=/var/lib/libvirt/images/centos7.qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><br>WARNING No operating system detected, VM performance may suffer. Specify an OS with --os-variant <span class="hljs-keyword">for</span> optimal results.<br><br>Starting install...<br>ERROR  internal error: qemu unexpectedly closed the monitor: 2020-08-09T15:57:08.872365Z qemu-kvm: error: failed to <span class="hljs-built_in">set</span> MSR 0xe1 to 0x0 qemu-kvm: /builddir/build/BUILD/qemu-2.12.0/target/i386/kvm.c:2119: kvm_buf_set_msrs: Assertion `ret == cpu-&gt;kvm_msr_buf-&gt;nmsrs<span class="hljs-string">&#x27; failed. </span><br><span class="hljs-string">Domain installation does not appear to have been successful. If it was, you can restart your domain by running: virsh --connect qemu:///system start centos7 otherwise, please restart your installation.</span><br></code></pre></td></tr></table></figure>

<h3 id="2-5-3-AMD-CPU-创建虚拟机故障修复方法"><a href="#2-5-3-AMD-CPU-创建虚拟机故障修复方法" class="headerlink" title="2.5.3 AMD CPU 创建虚拟机故障修复方法"></a>2.5.3 AMD CPU 创建虚拟机故障修复方法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#修复以上故障</span><br>[root@centos8 ~]<span class="hljs-comment"># tee /etc/modprobe.d/qemu-system-x86.conf &lt;&lt; EOF</span><br>&gt; options kvm ignore_msrs=1<br>&gt; EOF<br>options kvm ignore_msrs=1<br>[root@centos8 ~]<span class="hljs-comment">#reboot</span><br></code></pre></td></tr></table></figure>

<h1 id="三、-创建虚拟机"><a href="#三、-创建虚拟机" class="headerlink" title="三、 创建虚拟机"></a>三、 创建虚拟机</h1><h2 id="3-1-使用-virt-manager-创建虚拟机"><a href="#3-1-使用-virt-manager-创建虚拟机" class="headerlink" title="3.1 使用 virt-manager 创建虚拟机"></a>3.1 使用 virt-manager 创建虚拟机</h2><p>virt-manager 是一个图形化虚拟机管理工具,方便管理和查看虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># export DISPLAY=10.0.0.1:0.0</span><br>[root@centos8 ~]<span class="hljs-comment"># virt-manager</span><br>[root@centos8 ~]<span class="hljs-comment"># libGL error: No matching fbConfigs or visuals found</span><br>libGL error: failed to load driver: swrast<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm37.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm38.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm39.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm40.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm41.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm42.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm43.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm44.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm45.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm46.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm47.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm48.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm49.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm50.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm51.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm52.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm53.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm54.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># ll /var/lib/libvirt/images/centos8.qcow2 -h</span><br>-rw------- 1 qemu qemu 21G Aug  3 10:46 /var/lib/libvirt/images/centos8.qcow2<br></code></pre></td></tr></table></figure>

<h2 id="3-2-使用-virt-install-创建虚拟机"><a href="#3-2-使用-virt-install-创建虚拟机" class="headerlink" title="3.2 使用 virt-install 创建虚拟机"></a>3.2 使用 virt-install 创建虚拟机</h2><p>虽然使用virt-manager 可以方便的管理虚拟机,但如果需要批量进行虚拟机的创建管理,命令行工具virt-<br>install 更加适合</p>
<h3 id="3-2-1-virt-install-使用说明"><a href="#3-2-1-virt-install-使用说明" class="headerlink" title="3.2.1 virt-install 使用说明"></a>3.2.1 virt-install 使用说明</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># virt-install --help</span><br>usage: virt-install --name NAME --ram RAM STORAGE INSTALL [options]<br><br>使用 <span class="hljs-string">&#x27;--option=?&#x27;</span> 或者 <span class="hljs-string">&#x27;--option help&#x27;</span> 查看可用子选项有关示例及完整选项语法，请查看 man page。<br><br>使用指定安装介质新建虚拟机<br>optional arguments:<br>-h, --<span class="hljs-built_in">help</span> show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span><br>--version show program<span class="hljs-string">&#x27;s version number and exit</span><br><span class="hljs-string">--connect URI 使用 libvirt URI 连接到 hypervisor</span><br><span class="hljs-string"></span><br><span class="hljs-string">通用选项:</span><br><span class="hljs-string">-n NAME, --name NAME 客户端虚拟机的名称</span><br><span class="hljs-string">--memory MEMORY 配置虚拟机内存分配</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--memory 1024 (in MiB)</span><br><span class="hljs-string">--memory 512,maxmemory=1024</span><br><span class="hljs-string">--vcpus VCPUS 为虚拟机配置的 vcpus 数。</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--vcpus 5</span><br><span class="hljs-string">--vcpus 5,maxcpus=10,cpuset=1-4,6,8</span><br><span class="hljs-string">--vcpus sockets=2,cores=4,threads=2</span><br><span class="hljs-string"></span><br><span class="hljs-string">--cpu CPU CPU 型号及功能。</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--cpu coreduo,+x2apic</span><br><span class="hljs-string">--cpu host</span><br><span class="hljs-string"></span><br><span class="hljs-string">--metadata METADATA 配置虚拟机元数据</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--metadata name=foo,title=&quot;My pretty title&quot;,uuid=...</span><br><span class="hljs-string">--metadata description=&quot;My nice long description&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">安装方法选项:</span><br><span class="hljs-string">--cdrom CDROM 光驱安装介质</span><br><span class="hljs-string">-l LOCATION, --location LOCATION 安装源</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">nfs:host:/path</span><br><span class="hljs-string">http://host/path</span><br><span class="hljs-string">ftp://host/path</span><br><span class="hljs-string"></span><br><span class="hljs-string">--pxe 使用 PXE 协议从网络引导</span><br><span class="hljs-string">--import 在磁盘映像中构建虚拟机</span><br><span class="hljs-string">--livecd 将光驱介质视为 Live CD</span><br><span class="hljs-string">-x EXTRA_ARGS, --extra-args EXTRA_ARGS 附加到使用 --location 引导的内核的参数</span><br><span class="hljs-string">--initrd-inject INITRD_INJECT 使用 --location 为 initrd 的 root 添加给定文件</span><br><span class="hljs-string">--os-variant DISTRO_VARIANT 在其中安装 OS 变体的虚拟机，如:&#x27;</span>fedora18<span class="hljs-string">&#x27;、&#x27;</span>rhel6<span class="hljs-string">&#x27;、&#x27;</span>winxp<span class="hljs-string">&#x27; 等等</span><br><span class="hljs-string"></span><br><span class="hljs-string">--boot BOOT 配置虚拟机引导设置。</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--boot hd,cdrom,menu=on</span><br><span class="hljs-string">--boot init=/sbin/init (for containers)</span><br><span class="hljs-string"></span><br><span class="hljs-string">--idmap IDMAP 为 LXC 容器启用用户名称空间。</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--idmap uid_start=0,uid_target=1000,uid_count=10</span><br><span class="hljs-string"></span><br><span class="hljs-string">设备选项:</span><br><span class="hljs-string">--disk DISK 使用不同选项指定存储。例如：</span><br><span class="hljs-string">--disk size=10 (new 10GiB image in default location)</span><br><span class="hljs-string">--disk /my/existing/disk,cache=none</span><br><span class="hljs-string">--disk device=cdrom,bus=scsi</span><br><span class="hljs-string">--disk=?</span><br><span class="hljs-string"></span><br><span class="hljs-string">-w NETWORK, --network NETWORK 配置虚拟机网络接口。</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--network bridge=mybr0</span><br><span class="hljs-string">--network network=my_libvirt_virtual_net</span><br><span class="hljs-string">--network network=mynet,model=virtio,mac=00:11...</span><br><span class="hljs-string">--network none</span><br><span class="hljs-string">--network help</span><br><span class="hljs-string"></span><br><span class="hljs-string">--graphics GRAPHICS 配置虚拟机显示设置。</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--graphics vnc</span><br><span class="hljs-string">--graphics spice,port=5901,tlsport=5902</span><br><span class="hljs-string">--graphics none</span><br><span class="hljs-string">--graphics vnc,password=foobar,port=5910,keymap=ja</span><br><span class="hljs-string"></span><br><span class="hljs-string">--controller CONTROLLER 配置虚拟机控制程序设备。</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--controller type=usb,model=ich9-ehci1</span><br><span class="hljs-string"></span><br><span class="hljs-string">--input INPUT 配置虚拟机输入设备。</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--input tablet</span><br><span class="hljs-string">--input keyboard,bus=usb</span><br><span class="hljs-string"></span><br><span class="hljs-string">--serial SERIAL 配置虚拟机串口设备</span><br><span class="hljs-string">--parallel PARALLEL 配置虚拟机并口设备</span><br><span class="hljs-string">--channel CHANNEL 配置虚拟机沟通频道</span><br><span class="hljs-string">--console CONSOLE 配置虚拟机与主机之间的文本控制台连接</span><br><span class="hljs-string">--hostdev HOSTDEV 将物理 USB/PCI/etc 主机设备配置为与虚拟机共享</span><br><span class="hljs-string">--filesystem FILESYSTEM 将主机目录传递给虚拟机。</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--filesystem /my/source/dir,/dir/in/guest</span><br><span class="hljs-string">--filesystem template_name,/,type=template</span><br><span class="hljs-string"></span><br><span class="hljs-string">--sound [SOUND] 配置虚拟机声音设备模拟</span><br><span class="hljs-string">--watchdog WATCHDOG 配置虚拟机 watchdog 设备</span><br><span class="hljs-string">--video VIDEO 配置虚拟机视频硬件。</span><br><span class="hljs-string">--smartcard SMARTCARD 配置虚拟机智能卡设备。例如：--smartcard mode=passthrough</span><br><span class="hljs-string"></span><br><span class="hljs-string">--redirdev REDIRDEV 配置虚拟机重定向设备。例如：--redirdev usb,type=tcp,server=192.168.1.1:4000</span><br><span class="hljs-string">--memballoon MEMBALLOON 配置虚拟机 memballoon 设备。例如：--memballoon model=virtio</span><br><span class="hljs-string">--tpm TPM 配置虚拟机 TPM 设备。例如：--tpm /dev/tpm</span><br><span class="hljs-string">--rng RNG 配置虚拟机 RNG 设备。例如：--rng /dev/random</span><br><span class="hljs-string">--panic PANIC 配置虚拟机 panic 设备。例如：--panic default</span><br><span class="hljs-string"></span><br><span class="hljs-string">虚拟机配置选项:</span><br><span class="hljs-string">--security SECURITY 设定域安全驱动器配置。</span><br><span class="hljs-string">--numatune NUMATUNE 为域进程调整 NUMA 策略。</span><br><span class="hljs-string">--memtune MEMTUNE 为域进程调整内粗策略。</span><br><span class="hljs-string">--blkiotune BLKIOTUNE为域进程调整 blkio 策略。</span><br><span class="hljs-string">--memorybacking MEMORYBACKING 为域进程设置内存后备策略。例如：</span><br><span class="hljs-string">--memorybacking hugepages=on</span><br><span class="hljs-string">--features FEATURES 设置域 &lt;features&gt; XML。</span><br><span class="hljs-string">例如：</span><br><span class="hljs-string">--features acpi=off</span><br><span class="hljs-string">--features apic=on,eoi=on</span><br><span class="hljs-string"></span><br><span class="hljs-string">--clock CLOCK 设置域 &lt;clock&gt; XML。例如：--clock</span><br><span class="hljs-string">offset=localtime,rtc_tickpolicy=catchup</span><br><span class="hljs-string">--pm PM 配置 VM 电源管理功能</span><br><span class="hljs-string">--events EVENTS 配置 VM 生命周期管理策略</span><br><span class="hljs-string">--resource RESOURCE 配置 VM 资源分区（cgroups）</span><br><span class="hljs-string"></span><br><span class="hljs-string">虚拟化平台选项:</span><br><span class="hljs-string">-v, --hvm 客户端应该是一个全虚拟客户端</span><br><span class="hljs-string">-p, --paravirt 这个客户端一个是一个半虚拟客户端</span><br><span class="hljs-string">--container 这台虚拟机需要一个容器客户端</span><br><span class="hljs-string">--virt-type HV_TYPE 要使用的管理程序名称(kvm、qemu、xen等等)</span><br><span class="hljs-string">--arch ARCH 模拟的 CPU 构架</span><br><span class="hljs-string">--machine MACHINE 要模拟的机器类型</span><br><span class="hljs-string"></span><br><span class="hljs-string">其它选项:</span><br><span class="hljs-string">--autostart 引导主机时自动启动域。</span><br><span class="hljs-string">--wait WAIT 等待安装完成的分钟数。</span><br><span class="hljs-string">--noautoconsole 不要自动尝试连接到客户端控制台</span><br><span class="hljs-string">--noreboot 完成安装后不要引导虚拟机。</span><br><span class="hljs-string">--print-xml [XMLONLY] 输出所生成域 XML，而不是创建虚拟机。</span><br><span class="hljs-string">--dry-run 完成安装步骤，但不要创建设备或者定义虚拟机。</span><br><span class="hljs-string">--check CHECK 启用或禁用验证检查。例如：</span><br><span class="hljs-string">--check path_in_use=off</span><br><span class="hljs-string">--check all=off</span><br><span class="hljs-string">-q, --quiet 禁止无错误输出</span><br><span class="hljs-string">-d, --debug 输入故障排除信息</span><br></code></pre></td></tr></table></figure>

<h3 id="3-2-2-virt-install-命令创建虚拟机"><a href="#3-2-2-virt-install-命令创建虚拟机" class="headerlink" title="3.2.2 virt-install 命令创建虚拟机"></a>3.2.2 virt-install 命令创建虚拟机</h3><h4 id="3-2-2-1-利用-qemu-img命令创建虚拟磁盘"><a href="#3-2-2-1-利用-qemu-img命令创建虚拟磁盘" class="headerlink" title="3.2.2.1 利用 qemu-img命令创建虚拟磁盘"></a>3.2.2.1 利用 qemu-img命令创建虚拟磁盘</h4><p><strong>注意: qemu-img create 一定要确认对应路径下没有此文件,如果存在将覆盖原文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 /var/lib/libvirt/images/centos7.qcow2 20G</span><br>Formatting <span class="hljs-string">&#x27;/var/lib/libvirt/images/centos7.qcow2&#x27;</span>, fmt=qcow2 size=21474836480 cluster_size=65536 lazy_refcounts=off refcount_bits=16<br><br><span class="hljs-comment">#观察文件虚拟磁盘大小</span><br>[root@centos8 ~]<span class="hljs-comment"># ll -h /var/lib/libvirt/images/centos7.qcow2</span><br>-rw-r--r-- 1 root root 193K Sep 13 21:25 /var/lib/libvirt/images/centos7.qcow2<br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-2-利用-osinfo-query命令查看支持的OS版本"><a href="#3-2-2-2-利用-osinfo-query命令查看支持的OS版本" class="headerlink" title="3.2.2.2 利用 osinfo-query命令查看支持的OS版本"></a>3.2.2.2 利用 osinfo-query命令查看支持的OS版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看支持的OS</span><br>[root@centos8 ~]<span class="hljs-comment"># osinfo-query os| grep centos</span><br> centos-stream8       | CentOS Stream 8                                    | 8        | http://centos.org/centos-stream/8       <br> centos5.0            | CentOS 5.0                                         | 5.0      | http://centos.org/centos/5.0            <br> centos5.1            | CentOS 5.1                                         | 5.1      | http://centos.org/centos/5.1            <br> centos5.10           | CentOS 5.10                                        | 5.10     | http://centos.org/centos/5.10           <br> centos5.11           | CentOS 5.11                                        | 5.11     | http://centos.org/centos/5.11           <br> centos5.2            | CentOS 5.2                                         | 5.2      | http://centos.org/centos/5.2            <br> centos5.3            | CentOS 5.3                                         | 5.3      | http://centos.org/centos/5.3            <br> centos5.4            | CentOS 5.4                                         | 5.4      | http://centos.org/centos/5.4            <br> centos5.5            | CentOS 5.5                                         | 5.5      | http://centos.org/centos/5.5            <br> centos5.6            | CentOS 5.6                                         | 5.6      | http://centos.org/centos/5.6            <br> centos5.7            | CentOS 5.7                                         | 5.7      | http://centos.org/centos/5.7            <br> centos5.8            | CentOS 5.8                                         | 5.8      | http://centos.org/centos/5.8            <br> centos5.9            | CentOS 5.9                                         | 5.9      | http://centos.org/centos/5.9            <br> centos6.0            | CentOS 6.0                                         | 6.0      | http://centos.org/centos/6.0            <br> centos6.1            | CentOS 6.1                                         | 6.1      | http://centos.org/centos/6.1            <br> centos6.10           | CentOS 6.10                                        | 6.10     | http://centos.org/centos/6.10           <br> centos6.2            | CentOS 6.2                                         | 6.2      | http://centos.org/centos/6.2            <br> centos6.3            | CentOS 6.3                                         | 6.3      | http://centos.org/centos/6.3            <br> centos6.4            | CentOS 6.4                                         | 6.4      | http://centos.org/centos/6.4            <br> centos6.5            | CentOS 6.5                                         | 6.5      | http://centos.org/centos/6.5            <br> centos6.6            | CentOS 6.6                                         | 6.6      | http://centos.org/centos/6.6            <br> centos6.7            | CentOS 6.7                                         | 6.7      | http://centos.org/centos/6.7            <br> centos6.8            | CentOS 6.8                                         | 6.8      | http://centos.org/centos/6.8            <br> centos6.9            | CentOS 6.9                                         | 6.9      | http://centos.org/centos/6.9            <br> centos7.0            | CentOS 7                                           | 7        | http://centos.org/centos/7.0            <br> centos8              | CentOS 8                                           | 8        | http://centos.org/centos/8<br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-3-创建虚拟机光盘启动并手动安装"><a href="#3-2-2-3-创建虚拟机光盘启动并手动安装" class="headerlink" title="3.2.2.3 创建虚拟机光盘启动并手动安装"></a>3.2.2.3 创建虚拟机光盘启动并手动安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建默认NAT模式的虚拟机,并不自动打开virt-viewer连接console,需要手动打开virt-manager 连接,并手动安装系统</span><br>[root@centos8 ~]<span class="hljs-comment"># virt-install --virt-type kvm --name centos7 --ram 1024 --vcpus 2 --cdrom=/data/isos/CentOS-7-x86_64-Minimal-2003.iso --disk path=/var/lib/libvirt/images/centos7.qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole --os-variant=centos7.0</span><br><br>Starting install...<br>Domain installation still <span class="hljs-keyword">in</span> progress. You can reconnect to the console to complete the installation process<br><br>[root@centos8 ~]<span class="hljs-comment"># export DISPLAY=10.0.0.1:0.0</span><br>[root@centos8 ~]<span class="hljs-comment"># virt-manager</span><br><br><span class="hljs-comment">#查看虚拟硬盘大小,注意到只要正在运行的虚拟对应的硬盘文件所有者和组为qemu,而虚拟机关机的为root</span><br>[root@centos8 ~]<span class="hljs-comment"># ll /var/lib/libvirt/images/ -h</span><br>total 22G<br>-rw-r--r-- 1 qemu qemu 1.6G Sep 13 22:05 centos7.qcow2<br>-rw------- 1 root root 21G Sep 13 22:05 centos8.qcow2<br><br><span class="hljs-comment">#安装过程略</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm55.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-2-2-4-创建虚拟机从光盘启动并利用kickstart自动安装系统"><a href="#3-2-2-4-创建虚拟机从光盘启动并利用kickstart自动安装系统" class="headerlink" title="3.2.2.4 创建虚拟机从光盘启动并利用kickstart自动安装系统"></a>3.2.2.4 创建虚拟机从光盘启动并利用kickstart自动安装系统</h4><h5 id="3-2-2-4-1-准备-yum-仓库-和-kickstart-环境"><a href="#3-2-2-4-1-准备-yum-仓库-和-kickstart-环境" class="headerlink" title="3.2.2.4.1 准备 yum 仓库 和 kickstart 环境"></a>3.2.2.4.1 准备 yum 仓库 和 kickstart 环境</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install httpd</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable --now httpd</span><br>[root@centos8 ~]<span class="hljs-comment"># mkdir -pv /var/www/html/centos/&#123;6,7,8&#125;/os/x86_64/</span><br>[root@centos8 ~]<span class="hljs-comment"># mount /data/isos/CentOS-8.2.2004-x86_64-minimal.iso  /var/www/html/centos/8/os/x86_64/</span><br>[root@centos8 ~]<span class="hljs-comment"># mkdir -p /var/www/html/ks/</span><br><span class="hljs-comment">#参考博客https://blog.csdn.net/mpu_nice/article/details/107922312</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /var/www/html/ks/centos8.cfg</span><br>ignoredisk --only-use=sda<br>zerombr<br>text<br>reboot<br>clearpart --all --initlabel<br>selinux --disabled<br>firewall --disabled<br>url --url=http://10.0.0.201/centos/8/os/x86_64/<br>keyboard --vckeymap=us --xlayouts=<span class="hljs-string">&#x27;us&#x27;</span><br>lang en_US.UTF-8<br><br>bootloader --append=<span class="hljs-string">&quot;net.ifnames=0&quot;</span> --location=mbr --boot-drive=sda<br>network  --bootproto=dhcp --device=eth0 --ipv6=auto --activate<br><br>network  --hostname=centos8.magedu.org<br>rootpw --iscrypted $6$j9YhzDUnQVnxaAk8<span class="hljs-variable">$qv7rkMcPAEbV5yvwsP666DXWYadd3jYjkA9fpxAo9qYotjGGBUclCGoP1TRvgHBpqgc5n0RypMsPTQnVDcpO01</span><br>firstboot --<span class="hljs-built_in">enable</span><br>skipx<br>services --disabled=<span class="hljs-string">&quot;chronyd&quot;</span><br>timezone Asia/Shanghai --isUtc --nontp<br>user --name=wang --password=6oUfb/02CWfLb5l8f<span class="hljs-variable">$sgEZeR7c7DpqfpmFDH6huSmDbW1XQNR4qKl2EPns</span>.gOXqlnAIgv9pTogtFVaDtEpMOC.SWXKYqxfVtd9MCwxb1 --iscrypted --gecos=<span class="hljs-string">&quot;wang&quot;</span><br><br>autopart --<span class="hljs-built_in">type</span>=lvm<br>%packages<br>@^minimal-environment<br>kexec-tools<br>%end<br>%addon com_redhat_kdump --<span class="hljs-built_in">enable</span> --reserve-mb=<span class="hljs-string">&#x27;auto&#x27;</span><br>%end<br>%anaconda<br>pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty<br>pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok<br>pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty<br>%end<br><br>%post<br>useradd long<br><span class="hljs-built_in">echo</span> centos8 | passwd --stdin long &amp;&gt; /dev/null<br>%end<br></code></pre></td></tr></table></figure>

<h5 id="3-2-2-4-2-创建虚拟机利用kickstart实现自动安装方法1"><a href="#3-2-2-4-2-创建虚拟机利用kickstart实现自动安装方法1" class="headerlink" title="3.2.2.4.2 创建虚拟机利用kickstart实现自动安装方法1"></a>3.2.2.4.2 创建虚拟机利用kickstart实现自动安装方法1</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 /var/lib/libvirt/images/centos8-vm2.qcow2 20G</span><br>Formatting <span class="hljs-string">&#x27;/var/lib/libvirt/images/centos8-vm2.qcow2&#x27;</span>, fmt=qcow2<br>size=21474836480 cluster_size=65536 lazy_refcounts=off refcount_bits=16<br><br>[root@centos8 ~]<span class="hljs-comment"># virt-install --virt-type kvm --name centos8-vm2 --ram 2048 --vcpus 2 --cdrom=/data/isos/CentOS-8.2.2004-x86_64-minimal.iso --disk path=/var/lib/libvirt/images/centos8-vm2.qcow2 --network network=default --graphics vnc,listen=0.0.0.0</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm56.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm57.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm58.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-2-2-4-3-创建虚拟机利用kickstart实现自动安装方法2"><a href="#3-2-2-4-3-创建虚拟机利用kickstart实现自动安装方法2" class="headerlink" title="3.2.2.4.3 创建虚拟机利用kickstart实现自动安装方法2"></a>3.2.2.4.3 创建虚拟机利用kickstart实现自动安装方法2</h5><p>利用virt-install的两项选项实现kickstart安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">virt-install<br>--location=/data/isos/CentOS-8.2.2004-x86_64-minimal.iso<br>--extra-args=<span class="hljs-string">&quot;ks=http://10.0.0.8/ks/centos8.cfg&quot;</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 /var/lib/libvirt/images/centos8-vm3.qcow2 20G</span><br>Formatting <span class="hljs-string">&#x27;/var/lib/libvirt/images/centos8-vm2.qcow2&#x27;</span>, fmt=qcow2 size=21474836480 cluster_size=65536 lazy_refcounts=off refcount_bits=16<br><br>[root@centos8 ~]<span class="hljs-comment"># virt-install --virt-type kvm --name centos8-vm3 --ram 2048 --vcpus 2 --disk path=/var/lib/libvirt/images/centos8-vm3.qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --location=/data/isos/CentOS-8.2.2004-x86_64-minimal.iso --extra-args=&quot;ks=http://10.0.0.8/ks/centos8.cfg&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm59.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm60.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm61.png" srcset="/blog/img/loading.gif"></p>
<h4 id="3-2-2-5-验证宿主机进程"><a href="#3-2-2-5-验证宿主机进程" class="headerlink" title="3.2.2.5 验证宿主机进程"></a>3.2.2.5 验证宿主机进程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># ps aux|grep qemu-kvm</span><br>qemu        3278 79.5 23.1 4454648 1881280 ?     Sl   11:56   1:18 /usr/libexec/qemu-kvm -name guest=centos7-vm1,debug-threads=on -S -object secret,id=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-5-centos7-vm1/master-key.aes -machine pc-q35-rhel8.2.0,accel=kvm,usb=off,dump-guest-core=off -cpu EPYC-IBPB,x2apic=on,tsc-deadline=on,hypervisor=on,tsc-adjust=on,stibp=on,arch-capabilities=on,ssbd=on,xsaves=on,clzero=on,xsaveerptr=on,wbnoinvd=on,amd-stibp=on,amd-ssbd=on,virt-ssbd=on,rdctl-no=on,skip-l1dfl-vmentry=on,mds-no=on,pschange-mc-no=on,monitor=off,rdrand=off,rdseed=off,clflushopt=off,sha-ni=off,svm=off -m 2048 -overcommit mem-lock=off -smp 2,sockets=2,cores=1,threads=1 -uuid 4959ea09-935f-4d30-b19e-46bb23f494de -no-user-config -nodefaults -chardev socket,id=charmonitor,fd=38,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-reboot -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 -boot strict=on -kernel /var/lib/libvirt/boot/virtinst-t13gfv8y-vmlinuz -initrd /var/lib/libvirt/boot/virtinst-28zms92r-initrd.img -append ks=http://10.0.0.201/ks/centos7.cfg -device pcie-root-port,port=0x10,chassis=1,id=pci.1,bus=pcie.0,multifunction=on,addr=0x2 -device pcie-root-port,port=0x11,chassis=2,id=pci.2,bus=pcie.0,addr=0x2.0x1 -device pcie-root-port,port=0x12,chassis=3,id=pci.3,bus=pcie.0,addr=0x2.0x2 -device pcie-root-port,port=0x13,chassis=4,id=pci.4,bus=pcie.0,addr=0x2.0x3 -device pcie-root-port,port=0x14,chassis=5,id=pci.5,bus=pcie.0,addr=0x2.0x4 -device pcie-root-port,port=0x15,chassis=6,id=pci.6,bus=pcie.0,addr=0x2.0x5 -device pcie-root-port,port=0x16,chassis=7,id=pci.7,bus=pcie.0,addr=0x2.0x6 -device qemu-xhci,p2=15,p3=15,id=usb,bus=pci.2,addr=0x0 -device virtio-serial-pci,id=virtio-serial0,bus=pci.3,addr=0x0 -blockdev &#123;<span class="hljs-string">&quot;driver&quot;</span>:<span class="hljs-string">&quot;file&quot;</span>,<span class="hljs-string">&quot;filename&quot;</span>:<span class="hljs-string">&quot;/var/lib/libvirt/images/centos7-vm1.qcow2&quot;</span>,<span class="hljs-string">&quot;node-name&quot;</span>:<span class="hljs-string">&quot;libvirt-2-storage&quot;</span>,<span class="hljs-string">&quot;auto-read-only&quot;</span>:<span class="hljs-literal">true</span>,<span class="hljs-string">&quot;discard&quot;</span>:<span class="hljs-string">&quot;unmap&quot;</span>&#125; -blockdev &#123;<span class="hljs-string">&quot;node-name&quot;</span>:<span class="hljs-string">&quot;libvirt-2-format&quot;</span>,<span class="hljs-string">&quot;read-only&quot;</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">&quot;driver&quot;</span>:<span class="hljs-string">&quot;qcow2&quot;</span>,<span class="hljs-string">&quot;file&quot;</span>:<span class="hljs-string">&quot;libvirt-2-storage&quot;</span>,<span class="hljs-string">&quot;backing&quot;</span>:null&#125; -device virtio-blk-pci,scsi=off,bus=pci.4,addr=0x0,drive=libvirt-2-format,id=virtio-disk0,bootindex=1 -blockdev &#123;<span class="hljs-string">&quot;driver&quot;</span>:<span class="hljs-string">&quot;file&quot;</span>,<span class="hljs-string">&quot;filename&quot;</span>:<span class="hljs-string">&quot;/data/isos/CentOS-7-x86_64-Minimal-2009.iso&quot;</span>,<span class="hljs-string">&quot;node-name&quot;</span>:<span class="hljs-string">&quot;libvirt-1-storage&quot;</span>,<span class="hljs-string">&quot;auto-read-only&quot;</span>:<span class="hljs-literal">true</span>,<span class="hljs-string">&quot;discard&quot;</span>:<span class="hljs-string">&quot;unmap&quot;</span>&#125; -blockdev &#123;<span class="hljs-string">&quot;node-name&quot;</span>:<span class="hljs-string">&quot;libvirt-1-format&quot;</span>,<span class="hljs-string">&quot;read-only&quot;</span>:<span class="hljs-literal">true</span>,<span class="hljs-string">&quot;driver&quot;</span>:<span class="hljs-string">&quot;raw&quot;</span>,<span class="hljs-string">&quot;file&quot;</span>:<span class="hljs-string">&quot;libvirt-1-storage&quot;</span>&#125; -device ide-cd,bus=ide.0,drive=libvirt-1-format,id=sata0-0-0 -netdev tap,fd=40,id=hostnet0,vhost=on,vhostfd=41 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:dc:f1:14,bus=pci.1,addr=0x0 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,fd=42,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -device usb-tablet,id=input0,bus=usb.0,port=1 -vnc 0.0.0.0:0 -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pcie.0,addr=0x1 -device virtio-balloon-pci,id=balloon0,bus=pci.5,addr=0x0 -object rng-random,id=objrng0,filename=/dev/urandom -device virtio-rng-pci,rng=objrng0,id=rng0,bus=pci.6,addr=0x0 -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on<br>root        3365  0.0  0.0  12112   988 pts/1    S+   11:58   0:00 grep --color=auto qemu-kvm<br>[root@centos8 ~]<span class="hljs-comment"># pstree -p |grep kvm</span><br>     |-qemu-kvm(3278)-+-&#123;qemu-kvm&#125;(3285)<br>           |                |-&#123;qemu-kvm&#125;(3292)<br>           |                |-&#123;qemu-kvm&#125;(3293)<br>           |                |-&#123;qemu-kvm&#125;(3294)<br>           |                |-&#123;qemu-kvm&#125;(3299)<br>           |                |-&#123;qemu-kvm&#125;(3300)<br>           |                |-&#123;qemu-kvm&#125;(3335)<br>           |                |-&#123;qemu-kvm&#125;(3336)<br>           |                |-&#123;qemu-kvm&#125;(3337)<br>           |                |-&#123;qemu-kvm&#125;(3338)<br>           |                |-&#123;qemu-kvm&#125;(3339)<br>           |                |-&#123;qemu-kvm&#125;(3340)<br>           |                |-&#123;qemu-kvm&#125;(3341)<br>           |                |-&#123;qemu-kvm&#125;(3342)<br>           |                |-&#123;qemu-kvm&#125;(3343)<br>           |                |-&#123;qemu-kvm&#125;(3344)<br>           |                |-&#123;qemu-kvm&#125;(3345)<br>           |                |-&#123;qemu-kvm&#125;(3346)<br>           |                |-&#123;qemu-kvm&#125;(3347)<br>           |                |-&#123;qemu-kvm&#125;(3357)<br>           |                |-&#123;qemu-kvm&#125;(3358)<br>           |                |-&#123;qemu-kvm&#125;(3359)<br>           |                |-&#123;qemu-kvm&#125;(3360)<br>           |                |-&#123;qemu-kvm&#125;(3366)<br>           |                |-&#123;qemu-kvm&#125;(3367)<br>           |                |-&#123;qemu-kvm&#125;(3368)<br>           |                |-&#123;qemu-kvm&#125;(3369)<br>           |                |-&#123;qemu-kvm&#125;(3370)<br>           |                |-&#123;qemu-kvm&#125;(3371)<br>           |                |-&#123;qemu-kvm&#125;(3372)<br>           |                |-&#123;qemu-kvm&#125;(3373)<br>           |                |-&#123;qemu-kvm&#125;(3374)<br>           |                |-&#123;qemu-kvm&#125;(3375)<br>           |                |-&#123;qemu-kvm&#125;(3376)<br>           |                |-&#123;qemu-kvm&#125;(3377)<br>           |                |-&#123;qemu-kvm&#125;(3378)<br>           |                |-&#123;qemu-kvm&#125;(3379)<br>           |                |-&#123;qemu-kvm&#125;(3380)<br>           |                |-&#123;qemu-kvm&#125;(3381)<br>           |                |-&#123;qemu-kvm&#125;(3382)<br>           |                |-&#123;qemu-kvm&#125;(3383)<br>           |                |-&#123;qemu-kvm&#125;(3384)<br>           |                `-&#123;qemu-kvm&#125;(3385)<br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-6-vnc-连接虚拟机"><a href="#3-2-2-6-vnc-连接虚拟机" class="headerlink" title="3.2.2.6 vnc 连接虚拟机"></a>3.2.2.6 vnc 连接虚拟机</h4><p>虚拟机安装过程中,宿主机可以看到打开了5900端口,如果有多个虚拟机会打开5901,5902等端口</p>
<p>虚拟机安装完成后,虚拟机启动状态时,也会宿主机自动打开5900以上的端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># ss -ntl</span><br>State           Recv-Q          Send-Q                    Local Address:Port                     Peer Address:Port          <br>LISTEN          0               128                             0.0.0.0:111                           0.0.0.0:*             <br>LISTEN          0               32                        192.168.122.1:53                            0.0.0.0:*             <br>LISTEN          0               128                             0.0.0.0:22                            0.0.0.0:*             <br>LISTEN          0               5                             127.0.0.1:631                           0.0.0.0:*             <br>LISTEN          0               1                               0.0.0.0:5900                          0.0.0.0:*             <br>LISTEN          0               128                                [::]:111                              [::]:*             <br>LISTEN          0               128                                   *:80                                  *:*             <br>LISTEN          0               128                                [::]:22                               [::]:*             <br>LISTEN          0               5                                 [::1]:631                              [::]:*             <br>LISTEN          0               128                                   *:9090                                *:*<br></code></pre></td></tr></table></figure>

<p>可以修改VNC端口的范围,默认5900-65535</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># grep remote_display_port /etc/libvirt/qemu.conf</span><br><span class="hljs-comment">#remote_display_port_min = 5900</span><br><span class="hljs-comment">#remote_display_port_max = 65535</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm62.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm63.png" srcset="/blog/img/loading.gif"></p>
<p><strong>注意:</strong></p>
<ul>
<li>同时只能有一个VNC客户端连接虚拟机</li>
<li>virt-viewer 连接虚拟机,会自动断开VNC客户端的连接</li>
</ul>
<p>否则会下面提示错误</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm64.png" srcset="/blog/img/loading.gif"></p>
<h2 id="3-3-基于现有虚拟机磁盘为模版创建新的虚拟机"><a href="#3-3-基于现有虚拟机磁盘为模版创建新的虚拟机" class="headerlink" title="3.3 基于现有虚拟机磁盘为模版创建新的虚拟机"></a>3.3 基于现有虚拟机磁盘为模版创建新的虚拟机</h2><h3 id="3-3-1-利用virt-manager实现"><a href="#3-3-1-利用virt-manager实现" class="headerlink" title="3.3.1 利用virt-manager实现"></a>3.3.1 利用virt-manager实现</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#基于已经安装好虚拟机磁盘文件,创建新的磁盘文件</span><br>[root@centos8 ~]<span class="hljs-comment"># cp -a /var/lib/libvirt/images/centos7.0.qcow2 /var/lib/libvirt/images/centos7-1.qcow2</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm65.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm66.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-3-2-利用virt-install实现"><a href="#3-3-2-利用virt-install实现" class="headerlink" title="3.3.2 利用virt-install实现"></a>3.3.2 利用virt-install实现</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 images]<span class="hljs-comment"># pwd</span><br>/var/lib/libvirt/images<br>[root@centos8 images]<span class="hljs-comment">#cp centos8.qcow2 centos8-2.qcow2</span><br><br>[root@centos8 images]<span class="hljs-comment"># virt-install --virt-type kvm --name centos8-2 --ram 2048 --vcpus 2 --disk bus=virtio,path=/var/lib/libvirt/images/centos8-2.qcow2 --network network=default,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br><br>WARNING No operating system detected, VM performance may suffer. Specify an OS<br>with --os-variant <span class="hljs-keyword">for</span> optimal results.<br><br>Starting install...<br>Domain creation completed.<br><br><span class="hljs-comment">#运行工具,可以看到下面出现新的虚拟机</span><br>[root@centos8 images]<span class="hljs-comment">#virt-manager</span><br></code></pre></td></tr></table></figure>



<h1 id="四、管理虚拟机"><a href="#四、管理虚拟机" class="headerlink" title="四、管理虚拟机"></a>四、管理虚拟机</h1><h2 id="4-1-使用半虚拟化驱动-virtio"><a href="#4-1-使用半虚拟化驱动-virtio" class="headerlink" title="4.1 使用半虚拟化驱动 virtio"></a>4.1 使用半虚拟化驱动 virtio</h2><h3 id="4-1-1-半虚拟化驱动virtio的工作原理"><a href="#4-1-1-半虚拟化驱动virtio的工作原理" class="headerlink" title="4.1.1 半虚拟化驱动virtio的工作原理"></a>4.1.1 半虚拟化驱动virtio的工作原理</h3><p>为了提高内存、硬盘、网络的性能，需要支持半虚拟化</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm67.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm68.png" srcset="/blog/img/loading.gif"></p>
<p>virtio 是一种 I/O 半虚拟化解决方案，是一套通用 I/O 设备虚拟化的程序，是对半虚拟化 Hypervisor中的一组通用 I/O 设备的抽象，提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM，Xen，VMware等）之间的通信框架和编程接口，减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率，windows 系统需要单独安装virtio驱 动，linux系统自带virtio驱动。</p>
<img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm69.png" srcset="/blog/img/loading.gif" style="zoom: 67%;" />

<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">Virtio</span> 使用 <span class="hljs-variable">virtqueue</span> 来实现 <span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span> 机制，每个 <span class="hljs-variable">virtqueue</span> 就是一个承载大量数据的队列，具体使用多少个队列取决于需求，例如，<span class="hljs-variable">virtio</span>网络驱动程序（<span class="hljs-variable">virtio</span><span class="hljs-operator">-</span><span class="hljs-variable">net</span>）使用两个队列（一个用于接受，另一个用于发送），而<span class="hljs-variable">virtio</span>块驱动程序（<span class="hljs-variable">virtio</span><span class="hljs-operator">-</span><span class="hljs-variable">blk</span>）仅使用一个队列<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm70.png" srcset="/blog/img/loading.gif"></p>
<p>实现IO虚拟化主要有三种方式：全虚拟化、半虚拟化和透传，全虚拟化Guest OS不会感知到自己是虚拟机，也无需修改Guest OS，但是它的效率比较低，半虚拟化Guest OS知道自己是虚拟机，通过Frontend/Backend驱动模拟实现IO虚拟化，透传就是直接分配物理设备给VM用，但是需要解决单个硬件在多个虚拟机共享使用的问题。</p>
<p><strong>性能比较</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://www.ilsistemista.net/index.php/virtualization/42-kvm-virtio-paravirtualized-drivers-why-they-matter.htm<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm71.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm72.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-1-2-半虚拟化设备统一接口virtio"><a href="#4-1-2-半虚拟化设备统一接口virtio" class="headerlink" title="4.1.2 半虚拟化设备统一接口virtio"></a>4.1.2 半虚拟化设备统一接口virtio</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm73.png" srcset="/blog/img/loading.gif"></p>
<p>通过统一的接口virtio以支持的多种硬件设备</p>
<ul>
<li>不同的虚拟设备和不同的虚拟机可以有不同的前端驱动</li>
<li>不同的硬件设备可以有不同的后端驱动</li>
<li>两者之间的交互遵循virtio的标准</li>
</ul>
<h3 id="4-1-3-驱动获取"><a href="#4-1-3-驱动获取" class="headerlink" title="4.1.3 驱动获取"></a>4.1.3 驱动获取</h3><h4 id="4-1-3-1-Linux-的-VirtIO-驱动"><a href="#4-1-3-1-Linux-的-VirtIO-驱动" class="headerlink" title="4.1.3.1 Linux 的 VirtIO 驱动"></a>4.1.3.1 Linux 的 VirtIO 驱动</h4><p>红帽RHEL 4.8之后自动加载和安装virtio驱动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># lsmod | grep virtio</span><br>virtio_balloon         20480  0<br>virtio_console         36864  0<br>virtio_blk             20480  3<br>virtio_net             53248  0<br>net_failover           24576  1 virtio_net<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm74.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-1-3-2-Windows-操作系统需要额外安装-virtio-的驱动"><a href="#4-1-3-2-Windows-操作系统需要额外安装-virtio-的驱动" class="headerlink" title="4.1.3.2 Windows 操作系统需要额外安装 virtio 的驱动"></a>4.1.3.2 Windows 操作系统需要额外安装 virtio 的驱动</h4><p>方法1∶如果有红帽的RHN订阅，可以从以下位置下载virtio-win包:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://rhn.redhat.com/rhn/software/packages/details/Overview.do?pid=868414<br></code></pre></td></tr></table></figure>

<p>方法2∶从社区获得</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">http://www.linux-kvm.org/page/Downloads<br>https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm75.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm76.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm77.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-1-4-Linux-测试安装virtio驱动前后的虚拟机性能变化"><a href="#4-1-4-Linux-测试安装virtio驱动前后的虚拟机性能变化" class="headerlink" title="4.1.4 Linux 测试安装virtio驱动前后的虚拟机性能变化"></a>4.1.4 Linux 测试安装virtio驱动前后的虚拟机性能变化</h3><p>默认虚拟机使用的是全虚拟化IDE磁盘,以下测试性能</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm78.png" srcset="/blog/img/loading.gif"></p>
<p>将硬盘默认的总线IDE修改为VirtIO</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm79.png" srcset="/blog/img/loading.gif"></p>
<p><strong>重新启动后,执行相同的操作,比较性能</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm80.png" srcset="/blog/img/loading.gif"></p>
<p>默认网卡为e1000,将之修改网卡驱动为virtIO</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm81.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-1-5-安装-Windows-Server-虚拟机"><a href="#4-1-5-安装-Windows-Server-虚拟机" class="headerlink" title="4.1.5 安装 Windows Server 虚拟机"></a>4.1.5 安装 Windows Server 虚拟机</h3><h4 id="4-1-5-1-下载并准备相关文件"><a href="#4-1-5-1-下载并准备相关文件" class="headerlink" title="4.1.5.1 下载并准备相关文件"></a>4.1.5.1 下载并准备相关文件</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># virtio下载地址：</span><br>https:<span class="hljs-regexp">//</span>fedorapeople.org<span class="hljs-regexp">/groups/</span>virt<span class="hljs-regexp">/virtio-win/</span>direct-downloads/<br><br><span class="hljs-comment"># virtio 历史版本下载地址：</span><br>https:<span class="hljs-regexp">//</span>fedorapeople.org<span class="hljs-regexp">/groups/</span>virt<span class="hljs-regexp">/virtio-win/</span>direct-downloads<span class="hljs-regexp">/archive-virtio/</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm82.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#ll /data/isos/</span><br>total 6031060<br>-rw-r--r-- 1 qemu qemu 1085276160 Aug  9 16:38 CentOS-7-x86_64-Minimal-2003.iso<br>-rw-r--r-- 1 qemu qemu 1718616064 Aug  9 16:31 CentOS-8.2.2004-x86_64-minimal.iso<br>-rw-r--r-- 1 root root 3368962048 Aug 11 12:00<br>cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso<br>-rw-r--r-- 1 root root   2949120 Aug 11 12:01 virtio-win-0.1.141_amd64.vfd<br></code></pre></td></tr></table></figure>

<h4 id="4-1-5-2-创建-Windows-Server-2008-虚拟机"><a href="#4-1-5-2-创建-Windows-Server-2008-虚拟机" class="headerlink" title="4.1.5.2 创建 Windows Server 2008 虚拟机"></a>4.1.5.2 创建 Windows Server 2008 虚拟机</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建磁盘文件</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 /var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2 200G</span><br>Formatting <span class="hljs-string">&#x27;/var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2&#x27;</span>, fmt=qcow2 size=214748364800 cluster_size=65536 lazy_refcounts=off refcount_bits=16<br><br><span class="hljs-comment">#查看支持的windows版本</span><br>[root@centos8 ~]<span class="hljs-comment"># osinfo-query os| grep win</span><br>win1.0               | Microsoft Windows 1.0                              | 1.0      | http://microsoft.com/win/1.0            <br> win10                | Microsoft Windows 10                               | 10.0     | http://microsoft.com/win/10             <br> win2.0               | Microsoft Windows 2.0                              | 2.0      | http://microsoft.com/win/2.0            <br> win2.1               | Microsoft Windows 2.1                              | 2.1      | http://microsoft.com/win/2.1            <br> win2k                | Microsoft Windows 2000                             | 5.0      | http://microsoft.com/win/2k             <br> win2k12              | Microsoft Windows Server 2012                      | 6.3      | http://microsoft.com/win/2k12           <br> win2k12r2            | Microsoft Windows Server 2012 R2                   | 6.3      | http://microsoft.com/win/2k12r2         <br> win2k16              | Microsoft Windows Server 2016                      | 10.0     | http://microsoft.com/win/2k16           <br> win2k19              | Microsoft Windows Server 2019                      | 10.0     | http://microsoft.com/win/2k19           <br> win2k3               | Microsoft Windows Server 2003                      | 5.2      | http://microsoft.com/win/2k3            <br> win2k3r2             | Microsoft Windows Server 2003 R2                   | 5.2      | http://microsoft.com/win/2k3r2          <br> win2k8               | Microsoft Windows Server 2008                      | 6.0      | http://microsoft.com/win/2k8            <br> win2k8r2             | Microsoft Windows Server 2008 R2                   | 6.1      | http://microsoft.com/win/2k8r2          <br> win3.1               | Microsoft Windows 3.1                              | 3.1      | http://microsoft.com/win/3.1            <br> win7                 | Microsoft Windows 7                                | 6.1      | http://microsoft.com/win/7              <br> win8                 | Microsoft Windows 8                                | 6.2      | http://microsoft.com/win/8              <br> win8.1               | Microsoft Windows 8.1                              | 6.3      | http://microsoft.com/win/8.1            <br> win95                | Microsoft Windows 95                               | 4.0      | http://microsoft.com/win/95             <br> win98                | Microsoft Windows 98                               | 4.1      | http://microsoft.com/win/98             <br> winme                | Microsoft Windows Millennium Edition               | 4.9      | http://microsoft.com/win/me             <br> winnt3.1             | Microsoft Windows NT Server 3.1                    | 3.1      | http://microsoft.com/winnt/3.1          <br> winnt3.5             | Microsoft Windows NT Server 3.5                    | 3.5      | http://microsoft.com/winnt/3.5          <br> winnt3.51            | Microsoft Windows NT Server 3.51                   | 3.51     | http://microsoft.com/winnt/3.51         <br> winnt4.0             | Microsoft Windows NT Server 4.0                    | 4.0      | http://microsoft.com/winnt/4.0          <br> winvista             | Microsoft Windows Vista                            | 6.0      | http://microsoft.com/win/vista          <br> winxp                | Microsoft Windows XP                               | 5.1      | http://microsoft.com/win/xp<br>  <br><span class="hljs-comment">#创建 Windows 虚拟机</span><br>[root@centos8 ~]<span class="hljs-comment"># virt-install --virt-type kvm --name Win2008 --memory 3072 --vcpus=2 --os-variant=win2k8r2 --cdrom=/data/isos/cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso --disk path=/var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2,format=qcow2,bus=virtio --disk path=/data/isos/virtio-win-0.1.141_amd64.vfd,device=floppy --network bridge=virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart</span><br><br>Starting install...<br>Domain installation still <span class="hljs-keyword">in</span> progress. You can reconnect to<br>the console to complete the installation process.<br><br>[root@centos8 ~]<span class="hljs-comment">#virt-manager</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-5-3-安装-Windows-Server-2008"><a href="#4-1-5-3-安装-Windows-Server-2008" class="headerlink" title="4.1.5.3 安装 Windows Server 2008"></a>4.1.5.3 安装 Windows Server 2008</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm83.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm84.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm85.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm86.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm87.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm88.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm89.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm90.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm91.png" srcset="/blog/img/loading.gif"></p>
<p>注意: 不要选中 GPU</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm92.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm93.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm94.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm95.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm96.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm97.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm98.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-1-5-4-验证-Windows-virtio-驱动"><a href="#4-1-5-4-验证-Windows-virtio-驱动" class="headerlink" title="4.1.5.4 验证 Windows virtio 驱动"></a>4.1.5.4 验证 Windows virtio 驱动</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm99.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-1-5-5-安装PCI-内存管理驱动"><a href="#4-1-5-5-安装PCI-内存管理驱动" class="headerlink" title="4.1.5.5 安装PCI 内存管理驱动"></a>4.1.5.5 安装PCI 内存管理驱动</h4><p>挂载virtio-win的光盘,进行安装驱动</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm100.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm101.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm102.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm103.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm104.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm105.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-1-5-6-生成Windows-Server-2008-镜像模版"><a href="#4-1-5-6-生成Windows-Server-2008-镜像模版" class="headerlink" title="4.1.5.6 生成Windows Server 2008 镜像模版"></a>4.1.5.6 生成Windows Server 2008 镜像模版</h4><p>利用sysprep工具,清除个性信息,下次Windows开机时, 会自动生成初始化个性信息</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm106.png" srcset="/blog/img/loading.gif"></p>
<p><strong>下次开机需要重新初始化</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm107.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-1-6-安装-Windows-10-虚拟机"><a href="#4-1-6-安装-Windows-10-虚拟机" class="headerlink" title="4.1.6 安装 Windows 10 虚拟机"></a>4.1.6 安装 Windows 10 虚拟机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#ll /data/isos/</span><br>total 11221160<br>-rw-r--r-- 1 qemu qemu 1085276160 Aug  9 16:38 CentOS-7-x86_64-Minimal-2003.iso<br>-rw-r--r-- 1 qemu qemu 1718616064 Aug  9 16:31 CentOS-8.2.2004-x86_64-minimal.iso<br>-rw-r--r-- 1 root root 5311711232 Aug 11 12:40<br>cn_windows_10_business_editions_version_1909_updated_jan_2020_x64_dvd_b3e1f3a6.iso<br>-rw-r--r-- 1 qemu qemu 3368962048 Aug 11 12:00<br>cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso<br>-rw-r--r-- 1 qemu qemu   2949120 Aug 11 12:21 virtio-win-0.1.141_amd64.vfd<br>-rw-r--r-- 1 root root   2949120 Aug 11 12:34 virtio-win-0.1.185_amd64.vfd<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 /var/lib/libvirt/images/Windows10.qcow2 200G</span><br>Formatting <span class="hljs-string">&#x27;/var/lib/libvirt/images/Windows10.qcow2&#x27;</span>, fmt=qcow2<br>size=214748364800 cluster_size=65536 lazy_refcounts=off refcount_bits=16<br><br>[root@centos8 ~]<span class="hljs-comment"># virt-install --virt-type kvm --name Windows10 --ram 3072 --vcpus=2 --os-variant=win10 --cdrom=/data/isos/cn_windows_10_business_editions_version_1909_updated_jan_2020_x64_dvd_b3e1f3a6.iso --disk path=/var/lib/libvirt/images/Windows10.qcow2,format=qcow2,bus=virtio --disk path=/data/isos/virtio-win-0.1.185_amd64.vfd,device=floppy --network bridge=virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart</span><br><br>Starting install...<br>Domain installation still <span class="hljs-keyword">in</span> progress. You can reconnect to<br>the console to complete the installation process.<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm108.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm109.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm110.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm111.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm112.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm113.png" srcset="/blog/img/loading.gif" alt="点击加载驱动程序"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm114.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm115.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm116.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm117.png" srcset="/blog/img/loading.gif" alt="按ctrl键全选"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm118.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm119.png" srcset="/blog/img/loading.gif"></p>
<p>第一次启动,初始化会比较长时间</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm120.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm120.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm121.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm122.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm123.png" srcset="/blog/img/loading.gif"></p>
<p><strong>选择”改为域加入”</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm124.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm125.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm126.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm127.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-2-安装与配置-QEMU-guest-agent"><a href="#4-2-安装与配置-QEMU-guest-agent" class="headerlink" title="4.2 安装与配置 QEMU guest agent"></a>4.2 安装与配置 QEMU guest agent</h2><h3 id="4-2-1-QEMU-guest-agent-功能"><a href="#4-2-1-QEMU-guest-agent-功能" class="headerlink" title="4.2.1 QEMU guest agent 功能"></a>4.2.1 QEMU guest agent 功能</h3><p>如果VM中安装QEMU guest agent，Host就可以使用libivrt向VM发送命令，例如“冻结”、“释放”文件系统，虚拟CPU的热添加及移除等。</p>
<p>在安装QEMU guest agent后，通过libvirt来使用QEMU guest agent, 可以对libvirt命令有如下的增强</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh shutdown --mode=agent  <span class="hljs-comment">#比--mode=acpi更加安全地关闭操作系统</span><br>virsh snapshot-create -quiesce  <span class="hljs-comment">#在创建快照之前面，将缓存的内容刷入到磁盘</span><br>virsh domfsfreeze  <span class="hljs-comment">#静默文件系统</span><br>virsh domfsthaw  <span class="hljs-comment">#恢复静默的文件系统</span><br>virsh domfstrim   <span class="hljs-comment">#让虚拟机trim文件系统</span><br>virsh domtime    <span class="hljs-comment">#获得虚拟机的时间</span><br>virsh setvcpus    <span class="hljs-comment">#配置虚拟机的vCPU</span><br>virsh domifaddr --<span class="hljs-built_in">source</span> agent  <span class="hljs-comment">#查询虚拟机的IP地址</span><br>virsh domfsinfo   <span class="hljs-comment">#显示虚拟机的文件系统列表</span><br>virsh set-user-password <span class="hljs-comment">#设置虚拟机用户的密码</span><br></code></pre></td></tr></table></figure>

<h3 id="4-2-2-安装-QEMU-guest-agent-安装方法"><a href="#4-2-2-安装-QEMU-guest-agent-安装方法" class="headerlink" title="4.2.2 安装 QEMU guest agent 安装方法"></a>4.2.2 安装 QEMU guest agent 安装方法</h3><ul>
<li>RHEL/CentOS 中有相应的安装包。qemu-guest-agent-xxx.rpm</li>
<li>Windows 需要手工安装</li>
</ul>
<h4 id="4-2-2-1-在-Linux-安装"><a href="#4-2-2-1-在-Linux-安装" class="headerlink" title="4.2.2.1 在 Linux 安装"></a>4.2.2.1 在 Linux 安装</h4><p><strong>在虚拟机上安装，不是在宿主机安装</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#yum info qemu-guest-agent</span><br>Last metadata expiration check: 2:46:09 ago on Thu 17 Sep 2020 09:08:54 AM CST.<br>Available Packages<br>Name     : qemu-guest-agent<br>Epoch    : 15<br>Version   : 2.12.0<br>Release   : 99.module_el8.2.0+320+13f867d7<br>Architecture : x86_64<br>Size     : 216 k<br>Source    : qemu-kvm-2.12.0-99.module_el8.2.0+320+13f867d7.src.rpm<br>Repository  : AppStream<br>Summary   : QEMU guest agent<br>URL     : http://www.qemu.org/<br>License   : GPLv2 and GPLv2+ and CC-BY<br>Description : qemu-kvm is an open <span class="hljs-built_in">source</span> virtualizer that provides hardware<br>emulation <span class="hljs-keyword">for</span><br>      : the KVM hypervisor.<br>      :<br>      : This package provides an agent to run inside guests, <span class="hljs-built_in">which</span><br>communicates<br>      : with the host over a virtio-serial channel named<br><span class="hljs-string">&quot;org.qemu.guest_agent.0&quot;</span><br>      :<br>      : This package does not need to be installed on the host OS.<br><br>[root@centos8 ~]<span class="hljs-comment">#yum -y install qemu-guest-agent</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-2-2-在-Windows-安装-QEMU-guest-agent"><a href="#4-2-2-2-在-Windows-安装-QEMU-guest-agent" class="headerlink" title="4.2.2.2 在 Windows 安装 QEMU guest agent"></a>4.2.2.2 在 Windows 安装 QEMU guest agent</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm128.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm129.png" srcset="/blog/img/loading.gif"></p>
<p>安装完毕后,可以服务管理中看到两个相关的服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">QEMU Guest Agent<br>QEMU Guest Agent VSS provider <span class="hljs-comment">#实现卷影副本</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm130.png" srcset="/blog/img/loading.gif"></p>
<h2 id="4-3-安装和配置-SPICE-agent"><a href="#4-3-安装和配置-SPICE-agent" class="headerlink" title="4.3 安装和配置 SPICE agent"></a>4.3 安装和配置 SPICE agent</h2><p>通过在VM操作系统中安装SPICE client，SPICE agent使virt-manager等图形应用程序更加流畅。例如:</p>
<ul>
<li>在virt-manager中调整窗口尺寸，SPICE agent 自动调整X会话的分辨率</li>
<li>在Host与Guest之间复制与粘贴</li>
<li>防止鼠标拖尾等</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm131.png" srcset="/blog/img/loading.gif"></p>
<p>官方下载链接:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://www.spice-space.org/download/<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm132.png" srcset="/blog/img/loading.gif"></p>
<h1 id="五、libvirt-管理虚拟机"><a href="#五、libvirt-管理虚拟机" class="headerlink" title="五、libvirt 管理虚拟机"></a>五、libvirt 管理虚拟机</h1><h2 id="5-1-libvirt-架构"><a href="#5-1-libvirt-架构" class="headerlink" title="5.1 libvirt 架构"></a>5.1 libvirt 架构</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm133.png" srcset="/blog/img/loading.gif"></p>
<p><strong>注意: 如果libvirtd服务意外关闭,将导致相关工具,如:virt-manager等无法和虚拟机连接,但虚拟机仍会正常运行</strong></p>
<p>范例: libvirtd 服务功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>2   centos8            running<br>3   Win_2008_r2-x86_64       running<br><br>[root@centos8 ~]<span class="hljs-comment">#systemctl stop libvirtd</span><br>[root@centos8 ~]<span class="hljs-comment">#virsh list</span><br>error: failed to connect to the hypervisor<br>error: Failed to connect socket to <span class="hljs-string">&#x27;/var/run/libvirt/libvirt-sock&#x27;</span>: No such fileor directory<br><span class="hljs-comment">#virt-manager工具也无法连接虚拟机</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm134.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#systemctl start libvirtd</span><br>[root@centos8 ~]<span class="hljs-comment">#virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>2   centos8            running<br>3   Win_2008_r2-x86_64       running<br><br><span class="hljs-comment">#virt-manager工具也恢复连接虚拟机</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm135.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-2-virt-manager-管理虚拟机"><a href="#5-2-virt-manager-管理虚拟机" class="headerlink" title="5.2 virt-manager 管理虚拟机"></a>5.2 virt-manager 管理虚拟机</h2><p>virt-manager是一个图形化工具,主要功能:</p>
<ul>
<li>定义和创建虚拟机</li>
<li>硬件管理</li>
<li>性能监视</li>
<li>控制台</li>
<li>在线和离线迁移</li>
<li>虚拟机的保存和恢复、暂停和继续、关闭和启动</li>
</ul>
<h3 id="5-2-1-启动菜单"><a href="#5-2-1-启动菜单" class="headerlink" title="5.2.1 启动菜单"></a>5.2.1 启动菜单</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm136.png" srcset="/blog/img/loading.gif"></p>
<p>开机后,按提示按ESC键,会出下面启动菜单</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm137.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-2-使用USB设备"><a href="#5-2-2-使用USB设备" class="headerlink" title="5.2.2 使用USB设备"></a>5.2.2 使用USB设备</h3><h4 id="5-2-2-1-添加USB设备"><a href="#5-2-2-1-添加USB设备" class="headerlink" title="5.2.2.1 添加USB设备"></a>5.2.2.1 添加USB设备</h4><p><strong>先在宿主机配置USB兼容性</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm138.png" srcset="/blog/img/loading.gif"></p>
<p>在宿主机接入U盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#dmesg</span><br>[23687.183727] usb-storage 4-1:1.0: USB Mass Storage device detected<br>[23687.184183] scsi host3: usb-storage 4-1:1.0<br>[23687.184720] usbcore: registered new interface driver usb-storage<br>[23687.188873] usbcore: registered new interface driver uas<br>[23688.211730] scsi 3:0:0:0: Direct-Access   Kingston DataTraveler 3.0 PMAPPQ: 0 ANSI: 6<br>[23688.214257] sd 3:0:0:0: Attached scsi generic sg2 <span class="hljs-built_in">type</span> 0<br>[23688.216842] sd 3:0:0:0: [sdb] 60555264 512-byte logical blocks: (31.0GB/28.9GiB)<br>[23688.218094] sd 3:0:0:0: [sdb] Write Protect is off<br>[23688.218097] sd 3:0:0:0: [sdb] Mode Sense: 45 00 00 00<br>[23688.220335] sd 3:0:0:0: [sdb] Write cache: disabled, <span class="hljs-built_in">read</span> cache: enabled,<br>doesn<span class="hljs-string">&#x27;t support DPO or FUA</span><br><span class="hljs-string">[23688.248203] sdb: sdb1</span><br><span class="hljs-string">[23688.257440] sd 3:0:0:0: [sdb] Attached SCSI removable disk</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm139.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm140.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm141.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm142.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]<span class="hljs-comment">#yum -y install usbutils</span><br>[root@localhost ~]<span class="hljs-comment"># lsusb</span><br>Bus 002 Device 002: ID 0951:1666 Kingston Technology DataTraveler 100 G3/G4/SE9<br>G2<br>Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub<br>Bus 001 Device 002: ID 0627:0001 Adomax Technology Co., Ltd<br>Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub<br>[root@localhost ~]<span class="hljs-comment"># lsblk</span><br>NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT<br>sda      8:0   1  28.9G  0 disk<br>└─sda1     8:1   1  28.9G  0 part<br>sr0      11:0   1 393.4M  0 rom <br>vda     252:0   0  20G  0 disk<br>├─vda1    252:1   0   1G  0 part /boot<br>└─vda2    252:2   0  19G  0 part<br>├─cl-root 253:0   0  17G  0 lvm /<br>└─cl-swap 253:1   0   2G  0 lvm [SWAP]<br></code></pre></td></tr></table></figure>

<h4 id="5-2-2-2-重定向USB设备"><a href="#5-2-2-2-重定向USB设备" class="headerlink" title="5.2.2.2 重定向USB设备"></a>5.2.2.2 重定向USB设备</h4><p>重定向指将客户端的物理设备重定向到虚拟机中</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm143.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm144.png" srcset="/blog/img/loading.gif"></p>
<p>查看到新加的USB设备</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm145.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-3-远程管理KVM宿主机"><a href="#5-2-3-远程管理KVM宿主机" class="headerlink" title="5.2.3 远程管理KVM宿主机"></a>5.2.3 远程管理KVM宿主机</h3><p>可以连接到远程的宿主机进行虚拟机的管理</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm146.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm147.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm148.png" srcset="/blog/img/loading.gif"></p>
<p>解决上面问题的方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#方法1:在本机安装openssh-askpass包</span><br>[root@centos8 ~]<span class="hljs-comment">#yum -y install openssh-askpass</span><br><br><span class="hljs-comment">#方法2:实现基于本机到远程主机的key验证</span><br>[root@centos8 ~]<span class="hljs-comment">#ssh-copy-id 10.0.0.18</span><br>/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed:<br><span class="hljs-string">&quot;/root/.ssh/id_rsa.pub&quot;</span><br>The authenticity of host <span class="hljs-string">&#x27;10.0.0.18 (10.0.0.18)&#x27;</span> can<span class="hljs-string">&#x27;t be established.</span><br><span class="hljs-string">ECDSA key fingerprint is SHA256:divKS+okAaeOzwWk/rHnrmZXWo3DUBPkkAnbofk+rbA.</span><br><span class="hljs-string">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br><span class="hljs-string">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter</span><br><span class="hljs-string">out any that are already installed</span><br><span class="hljs-string">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are</span><br><span class="hljs-string">prompted now it is to install the new keys</span><br><span class="hljs-string">root@10.0.0.18&#x27;</span>s password:<br><br>Number of key(s) added: 1<br><br>Now try logging into the machine, with:  <span class="hljs-string">&quot;ssh &#x27;10.0.0.18&#x27;&quot;</span><br>and check to make sure that only the key(s) you wanted were added.<br></code></pre></td></tr></table></figure>

<p>再次连接成功</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm149.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm150.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm151.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-4-虚拟机的性能监控"><a href="#5-2-4-虚拟机的性能监控" class="headerlink" title="5.2.4 虚拟机的性能监控"></a>5.2.4 虚拟机的性能监控</h3><p>先选择需要监控的项目</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm152.png" srcset="/blog/img/loading.gif"></p>
<p>根据上面的项目,选择对应显示的项目(可选项由前一页的项目决定)</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm153.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-3-virsh-命令行工具"><a href="#5-3-virsh-命令行工具" class="headerlink" title="5.3 virsh 命令行工具"></a>5.3 virsh 命令行工具</h2><h3 id="5-3-1-virsh-命令说明"><a href="#5-3-1-virsh-命令说明" class="headerlink" title="5.3.1 virsh 命令说明"></a>5.3.1 virsh 命令说明</h3><p>virsh是使用libvirt managementAPI构建的管理工具,相比virt-manager可以提高效率</p>
<p>virsh的名称的含义是virtualization shell</p>
<h4 id="5-3-1-1-两种工作模式"><a href="#5-3-1-1-两种工作模式" class="headerlink" title="5.3.1.1 两种工作模式"></a>5.3.1.1 两种工作模式</h4><ul>
<li>交互模式</li>
<li>非交互模式</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm154.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm155.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-1-2-virsh-主要功能"><a href="#5-3-1-2-virsh-主要功能" class="headerlink" title="5.3.1.2 virsh 主要功能"></a>5.3.1.2 virsh 主要功能</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh help</span><br>Domain Management (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;domain&#x27;</span>):<br>Domain Monitoring (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;monitor&#x27;</span>):<br>Host and Hypervisor (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;host&#x27;</span>):<br>Interface (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;interface&#x27;</span>):<br>Network Filter (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;filter&#x27;</span>):<br>Networking (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;network&#x27;</span>):<br>Node Device (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;nodedev&#x27;</span>):<br>Secret (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;secret&#x27;</span>):<br>Snapshot (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;snapshot&#x27;</span>):<br>Storage Pool (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;pool&#x27;</span>):<br>Storage Volume (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;volume&#x27;</span>):<br>Virsh itself (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;virsh&#x27;</span>):<br></code></pre></td></tr></table></figure>

<h4 id="5-3-1-3-virsh-命令格式"><a href="#5-3-1-3-virsh-命令格式" class="headerlink" title="5.3.1.3 virsh 命令格式"></a>5.3.1.3 virsh 命令格式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh --help</span><br><br>virsh [options]... [&lt;command_string&gt;]<br>virsh [options]... &lt;<span class="hljs-built_in">command</span>&gt; [args...]<br><br>options:<br>  -c | --connect=URI   hypervisor connection URI<br>  -d | --debug=NUM    debug level [0-4]<br>  -e | --escape &lt;char&gt;   <span class="hljs-built_in">set</span> escape sequence <span class="hljs-keyword">for</span> console<br>  -h | --<span class="hljs-built_in">help</span>       this <span class="hljs-built_in">help</span><br>  -k | --keepalive-interval=NUM<br>             keepalive interval <span class="hljs-keyword">in</span> seconds, 0 <span class="hljs-keyword">for</span> <span class="hljs-built_in">disable</span><br>  -K | --keepalive-count=NUM<br>             number of possible missed keepalive messages<br>  -l | --<span class="hljs-built_in">log</span>=FILE     output logging to file<br>  -q | --quiet      quiet mode<br>  -r | --<span class="hljs-built_in">readonly</span>     connect <span class="hljs-built_in">readonly</span><br>  -t | --timing      <span class="hljs-built_in">print</span> timing information<br>  -v           short version<br>  -V           long version<br>    --version[=TYPE]  version, TYPE is short or long (default short)<br></code></pre></td></tr></table></figure>

<h4 id="5-3-1-4-virsh-子命令说明"><a href="#5-3-1-4-virsh-子命令说明" class="headerlink" title="5.3.1.4 virsh 子命令说明"></a>5.3.1.4 virsh 子命令说明</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">help</span>                   <span class="hljs-comment">#打印基本帮助信息</span><br>attach-device          <span class="hljs-comment">#使用XML文件中的设备定义在虚拟机中添加设备</span><br>attach-disk            <span class="hljs-comment">#在虚拟机中附加新磁盘设备</span><br>attach-interface       <span class="hljs-comment">#在虚拟机中附加新网络接口</span><br>create                 <span class="hljs-comment">#从 XML 配置文件生成虚拟机并启动新虚拟机</span><br>define                 <span class="hljs-comment">#为虚拟机输出XML配置文件</span><br>destroy                <span class="hljs-comment">#强制虚拟机停止</span><br>detach-device          <span class="hljs-comment">#从虚拟机中分离设备，使用同样的XML 描述作为命令attach-device</span><br>detach-disk            <span class="hljs-comment">#从虚拟机中分离磁盘设备</span><br>detach-interface       <span class="hljs-comment">#从虚拟机中分离网络接口</span><br>domblkstat             <span class="hljs-comment">#显示正在运行的虚拟机的块设备统计</span><br>domid                  <span class="hljs-comment">#显示虚拟机ID</span><br>domifstat              <span class="hljs-comment">#显示正在运行的虚拟机的网络接口统计</span><br>dominfo                <span class="hljs-comment">#显示虚拟机信息</span><br>domname                <span class="hljs-comment">#显示虚拟机名称</span><br>domstate               <span class="hljs-comment">#显示虚以机状态</span><br>domuuid                <span class="hljs-comment">#显示虚拟机UUID</span><br>dumpxml                <span class="hljs-comment">#输出虚拟机 XML配置文件</span><br>list                   <span class="hljs-comment">#列出所有虚拟机</span><br>migrate                <span class="hljs-comment">#将虚拟机迁移到另一台主机中</span><br>nodeinfo               <span class="hljs-comment">#有关管理程序的输出信息</span><br>quit                   <span class="hljs-comment">#退出这个互动终端</span><br>reboot                 <span class="hljs-comment">#重新启动虚拟机</span><br>restore                <span class="hljs-comment">#恢复以前保存在文件中的虚拟机</span><br>resume                 <span class="hljs-comment">#恢复暂停的虚拟机</span><br>save                   <span class="hljs-comment">#将虚拟机当前状态保存到某个文件中</span><br>setmaxmem              <span class="hljs-comment">#为管理程序设定内存上限</span><br>setmem                 <span class="hljs-comment">#为虚拟机设定分配的内存</span><br>setvcpus               <span class="hljs-comment">#修改为虚拟机分配的虚拟CPU数目</span><br>shutdown               <span class="hljs-comment">#关闭某个虚拟机</span><br>start                  <span class="hljs-comment">#启动未激活的虚拟机</span><br><span class="hljs-built_in">suspend</span>                <span class="hljs-comment">#暂停虚拟机</span><br>undefine               <span class="hljs-comment">#删除与虚拟机关联的所有文件</span><br>vepuinfo               <span class="hljs-comment">#显示虚以机的虚拟CPU信息</span><br>vcpupin                <span class="hljs-comment">#控制虚拟机的虚拟CPU亲和性</span><br>version                <span class="hljs-comment">#显示virsh版本</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-1-5-查看子命令帮助"><a href="#5-3-1-5-查看子命令帮助" class="headerlink" title="5.3.1.5 查看子命令帮助"></a>5.3.1.5 查看子命令帮助</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh <span class="hljs-built_in">help</span> COMMAND<br></code></pre></td></tr></table></figure>

<p>范例: 查看子命令 list 命令用法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh help list</span><br>  NAME<br>    list - list domains<br><br>  SYNOPSIS<br>    list [--inactive] [--all] [--transient] [--persistent] [--with-snapshot] [--without-snapshot] [--state-running] [--state-paused] [--state-shutoff] [--state-other] [--autostart] [--no-autostart] [--with-managed-save] [--without-managed-save] [--uuid] [--name] [--table] [--managed-save] [--title]<br><br>  DESCRIPTION<br>    Returns list of domains.<br><br>  OPTIONS<br>    --inactive       list inactive domains<br>    --all            list inactive &amp; active domains<br>    --transient      list transient domains<br>    --persistent     list persistent domains<br>    --with-snapshot  list domains with existing snapshot<br>    --without-snapshot  list domains without a snapshot<br>    --state-running  list domains <span class="hljs-keyword">in</span> running state<br>    --state-paused   list domains <span class="hljs-keyword">in</span> paused state<br>    --state-shutoff  list domains <span class="hljs-keyword">in</span> shutoff state<br>    --state-other    list domains <span class="hljs-keyword">in</span> other states<br>    --autostart      list domains with autostart enabled<br>    --no-autostart   list domains with autostart disabled<br>    --with-managed-save  list domains with managed save state<br>    --without-managed-save  list domains without managed save<br>    --uuid           list uuid<span class="hljs-string">&#x27;s only</span><br><span class="hljs-string">    --name           list domain names only</span><br><span class="hljs-string">    --table          list table (default)</span><br><span class="hljs-string">    --managed-save   mark inactive domains with managed save state</span><br><span class="hljs-string">    --title          show domain title</span><br></code></pre></td></tr></table></figure>

<h3 id="5-3-2-启动和关闭虚拟机"><a href="#5-3-2-启动和关闭虚拟机" class="headerlink" title="5.3.2 启动和关闭虚拟机"></a>5.3.2 启动和关闭虚拟机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看当前启动的虚拟机</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>1   Win_2008_r2-x86_64       running<br><br><span class="hljs-comment">#查看所有虚拟机</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh list --all</span><br>Id  Name              State<br>----------------------------------------------------<br>1   Win_2008_r2-x86_64       running<br>-   centos7            shut off<br>-   centos8            shut off<br>-   centos8-vm2          shut off<br>-   centos8-vm3          shut off<br>-   centos8-vm4          shut off<br><br><span class="hljs-comment">#启动</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh start centos8</span><br>Domain centos8 started<br><br>[root@centos8 ~]<span class="hljs-comment">#virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>1   Win_2008_r2-x86_64       running<br>2   centos8            running<br><br><span class="hljs-comment">#正常关机</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh shutdown 1</span><br>Domain 1 is being shutdown<br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>1   Win_2008_r2-x86_64       running<br>2   centos8            running<br><br><span class="hljs-comment">#强制关机</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh destroy 1</span><br>Domain 1 destroyed<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>2   centos8            running<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh shutdown 2</span><br>Domain 2 is being shutdown<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br></code></pre></td></tr></table></figure>

<p>在virt-manager 中可以看到关机状态</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm156.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm157.png" srcset="/blog/img/loading.gif"></p>
<p><strong>查看虚拟机UUID,通过UUID启动关闭虚拟机</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>1   centos8            running<br><br><span class="hljs-comment">#查看虚拟机的UUID</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh domuuid 1</span><br>99765478-cfb1-4164-b038-f62004ccab9e<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh destroy 99765478-cfb1-4164-b038-f62004ccab9e</span><br>Domain 99765478-cfb1-4164-b038-f62004ccab9e destroyed<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list --all</span><br>Id  Name              State<br>----------------------------------------------------<br>-   centos7            shut off<br>-   centos8            shut off<br>-   centos8-vm2          shut off<br>-   centos8-vm3          shut off<br>-   centos8-vm4          shut off<br>-   Win_2008_r2-x86_64       shut off<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh domuuid centos8</span><br>99765478-cfb1-4164-b038-f62004ccab9e<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh start 99765478-cfb1-4164-b038-f62004ccab9e</span><br>Domain centos8 started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>2   centos8            running<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh domuuid centos8</span><br>99765478-cfb1-4164-b038-f62004ccab9e<br></code></pre></td></tr></table></figure>

<h3 id="5-3-3-暂停和恢复虚拟机"><a href="#5-3-3-暂停和恢复虚拟机" class="headerlink" title="5.3.3 暂停和恢复虚拟机"></a>5.3.3 暂停和恢复虚拟机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>1   centos8            running<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh suspend centos8</span><br>Domain centos8 suspended<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>1   centos8            paused<br><br><span class="hljs-comment">#虚拟机暂停后,宿主机中还存有相关的进程</span><br>[root@centos8 ~]<span class="hljs-comment"># ps aux|grep kvm</span><br>qemu     1699 36.9 16.0 4439296 1309300 ?   Sl  10:10  5:28<br>/usr/libexec/qemu-kvm -name guest=centos8,debug-threads=on -S -object<br>secret,id=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-<br>......<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh resume 1</span><br>Domain 1 resumed<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>1   centos8            running<br></code></pre></td></tr></table></figure>

<p><strong>5.3.4 配置虚拟机开机自动启动</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh list --all</span><br>Id  Name              State<br>----------------------------------------------------<br>1   Win_2008_r2-x86_64       running<br>-   centos7            shut off<br>-   centos8            shut off<br>-   centos8-vm2          shut off<br>-   centos8-vm3          shut off<br>-   centos8-vm4          shut off<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh autostart centos8</span><br>Domain centos8 marked as autostarted<br><br>[root@centos8 ~]<span class="hljs-comment"># ll /etc/libvirt/qemu/autostart/</span><br>total 0<br>lrwxrwxrwx 1 root root 29 Sep 17 18:53 centos8.xml -&gt; /etc/libvirt/qemu/centos8.xml<br>lrwxrwxrwx 1 root root 40 Sep 17 09:18 Win_2008_r2-x86_64.xml -&gt;<br>/etc/libvirt/qemu/Win_2008_r2-x86_64.xml<br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>1   Win_2008_r2-x86_64       running<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh autostart 1 --disable #取消自动开机</span><br>Domain 1 unmarked as autostarted<br><br>[root@centos8 ~]<span class="hljs-comment"># ll /etc/libvirt/qemu/autostart/</span><br>total 0<br>lrwxrwxrwx 1 root root 29 Sep 17 18:53 centos8.xml -&gt;<br>/etc/libvirt/qemu/centos8.xml<br>[root@centos8 ~]<span class="hljs-comment"># reboot</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>1   centos8            running<br></code></pre></td></tr></table></figure>

<p>在virt-manager工具中也可以配置开机自启动</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm158.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-3-5-查看虚拟机配置"><a href="#5-3-5-查看虚拟机配置" class="headerlink" title="5.3.5 查看虚拟机配置"></a>5.3.5 查看虚拟机配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh list --all</span><br>Id  Name              State<br>----------------------------------------------------<br>2   centos8            running<br>-   centos7            shut off<br>-   centos8-vm2          shut off<br>-   centos8-vm3          shut off<br>-   centos8-vm4          shut off<br>-   Win_2008_r2-x86_64       shut off<br><br><span class="hljs-comment">#每个虚拟机配置都存放在/etc/libvirt/qemu目录下的xml文件中</span><br>[root@centos8 ~]<span class="hljs-comment"># ls /etc/libvirt/qemu/ -l</span><br>total 32<br>drwxr-xr-x 2 root root  25 Sep 17 18:54 autostart<br>-rw------- 1 root root 3618 Sep 17 15:14 centos7.xml<br>-rw------- 1 root root 3673 Sep 13 22:43 centos8-vm2.xml<br>-rw------- 1 root root 3601 Sep 13 22:42 centos8-vm3.xml<br>-rw------- 1 root root 3379 Sep 14 00:15 centos8-vm4.xml<br>-rw------- 1 root root 6024 Sep 17 15:47 centos8.xml<br>drwx------ 3 root root  42 Sep 13 19:03 networks<br>-rw------- 1 root root 5369 Sep 17 11:31 Win_2008_r2-x86_64.xml<br><br><span class="hljs-comment">#查看指定虚拟机的配置,以下命令相当于查看 /etc/libvirt/qemu/centos8.xml</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh dumpxml centos8</span><br>&lt;domain <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;qemu&#x27;</span> id=<span class="hljs-string">&#x27;2&#x27;</span>&gt;<br>&lt;name&gt;centos8&lt;/name&gt;<br>&lt;uuid&gt;99765478-cfb1-4164-b038-f62004ccab9e&lt;/uuid&gt;<br>&lt;metadata&gt;<br> &lt;libosinfo:libosinfo<br>xmlns:libosinfo=<span class="hljs-string">&quot;http://libosinfo.org/xmlns/libvirt/domain/1.0&quot;</span>&gt;<br>  &lt;libosinfo:os id=<span class="hljs-string">&quot;http://centos.org/centos/8&quot;</span>/&gt;<br> &lt;/libosinfo:libosinfo&gt;<br>&lt;/metadata&gt;<br>&lt;memory unit=<span class="hljs-string">&#x27;KiB&#x27;</span>&gt;2097152&lt;/memory&gt;<br>&lt;currentMemory unit=<span class="hljs-string">&#x27;KiB&#x27;</span>&gt;2097152&lt;/currentMemory&gt;<br>&lt;vcpu placement=<span class="hljs-string">&#x27;static&#x27;</span>&gt;2&lt;/vcpu&gt;<br>&lt;resource&gt;<br> &lt;partition&gt;/machine&lt;/partition&gt;<br>&lt;/resource&gt;<br>&lt;os&gt;<br> &lt;<span class="hljs-built_in">type</span> arch=<span class="hljs-string">&#x27;x86_64&#x27;</span> machine=<span class="hljs-string">&#x27;pc-q35-rhel7.6.0&#x27;</span>&gt;hvm&lt;/<span class="hljs-built_in">type</span>&gt;<br>  &lt;boot dev=<span class="hljs-string">&#x27;hd&#x27;</span>/&gt;<br> &lt;bootmenu <span class="hljs-built_in">enable</span>=<span class="hljs-string">&#x27;yes&#x27;</span>/&gt;<br>&lt;/os&gt;<br>&lt;features&gt;<br> &lt;acpi/&gt;<br> &lt;apic/&gt;<br> &lt;vmport state=<span class="hljs-string">&#x27;off&#x27;</span>/&gt;<br>&lt;/features&gt;<br>&lt;clock offset=<span class="hljs-string">&#x27;utc&#x27;</span>&gt;<br> &lt;timer name=<span class="hljs-string">&#x27;rtc&#x27;</span> tickpolicy=<span class="hljs-string">&#x27;catchup&#x27;</span>/&gt;<br> &lt;timer name=<span class="hljs-string">&#x27;pit&#x27;</span> tickpolicy=<span class="hljs-string">&#x27;delay&#x27;</span>/&gt;<br> &lt;timer name=<span class="hljs-string">&#x27;hpet&#x27;</span> present=<span class="hljs-string">&#x27;no&#x27;</span>/&gt;<br>&lt;/clock&gt;<br>&lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;<br>&lt;on_reboot&gt;restart&lt;/on_reboot&gt;<br>&lt;on_crash&gt;destroy&lt;/on_crash&gt;<br>&lt;pm&gt;<br> &lt;suspend-to-mem enabled=<span class="hljs-string">&#x27;no&#x27;</span>/&gt;<br> &lt;suspend-to-disk enabled=<span class="hljs-string">&#x27;no&#x27;</span>/&gt;<br>&lt;/pm&gt;<br>&lt;devices&gt;<br> &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;<br> &lt;disk <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;file&#x27;</span> device=<span class="hljs-string">&#x27;disk&#x27;</span>&gt;<br>  &lt;driver name=<span class="hljs-string">&#x27;qemu&#x27;</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;qcow2&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">source</span> file=<span class="hljs-string">&#x27;/var/lib/libvirt/images/centos8.qcow2&#x27;</span>/&gt;<br>  &lt;backingStore/&gt;<br>  &lt;target dev=<span class="hljs-string">&#x27;vda&#x27;</span> bus=<span class="hljs-string">&#x27;virtio&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;virtio-disk0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x04&#x27;</span> slot=<span class="hljs-string">&#x27;0x00&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br> &lt;/disk&gt;<br> &lt;disk <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;file&#x27;</span> device=<span class="hljs-string">&#x27;cdrom&#x27;</span>&gt;<br>  &lt;driver name=<span class="hljs-string">&#x27;qemu&#x27;</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;raw&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">source</span> file=<span class="hljs-string">&#x27;/data/isos/virtio-win-0.1.185.iso&#x27;</span>/&gt;<br>  &lt;backingStore/&gt;<br>  &lt;target dev=<span class="hljs-string">&#x27;sda&#x27;</span> bus=<span class="hljs-string">&#x27;sata&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">readonly</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;sata0-0-0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;drive&#x27;</span> controller=<span class="hljs-string">&#x27;0&#x27;</span> bus=<span class="hljs-string">&#x27;0&#x27;</span> target=<span class="hljs-string">&#x27;0&#x27;</span> unit=<span class="hljs-string">&#x27;0&#x27;</span>/&gt;<br> &lt;/disk&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;usb&#x27;</span> index=<span class="hljs-string">&#x27;0&#x27;</span> model=<span class="hljs-string">&#x27;qemu-xhci&#x27;</span> ports=<span class="hljs-string">&#x27;15&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;usb&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x02&#x27;</span> slot=<span class="hljs-string">&#x27;0x00&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;sata&#x27;</span> index=<span class="hljs-string">&#x27;0&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;ide&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x1f&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x2&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> index=<span class="hljs-string">&#x27;0&#x27;</span> model=<span class="hljs-string">&#x27;pcie-root&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;pcie.0&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> index=<span class="hljs-string">&#x27;1&#x27;</span> model=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>&gt;<br>  &lt;model name=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>/&gt;<br>  &lt;target chassis=<span class="hljs-string">&#x27;1&#x27;</span> port=<span class="hljs-string">&#x27;0x10&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;pci.1&#x27;</span>/&gt;<br>    &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x02&#x27;</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x0&#x27;</span><br>multifunction=<span class="hljs-string">&#x27;on&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> index=<span class="hljs-string">&#x27;2&#x27;</span> model=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>&gt;<br>  &lt;model name=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>/&gt;<br>  &lt;target chassis=<span class="hljs-string">&#x27;2&#x27;</span> port=<span class="hljs-string">&#x27;0x11&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;pci.2&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x02&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x1&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> index=<span class="hljs-string">&#x27;3&#x27;</span> model=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>&gt;<br>  &lt;model name=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>/&gt;<br>  &lt;target chassis=<span class="hljs-string">&#x27;3&#x27;</span> port=<span class="hljs-string">&#x27;0x12&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;pci.3&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x02&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x2&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> index=<span class="hljs-string">&#x27;4&#x27;</span> model=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>&gt;<br>  &lt;model name=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>/&gt;<br>  &lt;target chassis=<span class="hljs-string">&#x27;4&#x27;</span> port=<span class="hljs-string">&#x27;0x13&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;pci.4&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x02&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x3&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> index=<span class="hljs-string">&#x27;5&#x27;</span> model=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>&gt;<br>  &lt;model name=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>/&gt;<br>  &lt;target chassis=<span class="hljs-string">&#x27;5&#x27;</span> port=<span class="hljs-string">&#x27;0x14&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;pci.5&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x02&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x4&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> index=<span class="hljs-string">&#x27;6&#x27;</span> model=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>&gt;<br>  &lt;model name=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>/&gt;<br>  &lt;target chassis=<span class="hljs-string">&#x27;6&#x27;</span> port=<span class="hljs-string">&#x27;0x15&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;pci.6&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x02&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x5&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> index=<span class="hljs-string">&#x27;7&#x27;</span> model=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>&gt;<br>  &lt;model name=<span class="hljs-string">&#x27;pcie-root-port&#x27;</span>/&gt;<br>  &lt;target chassis=<span class="hljs-string">&#x27;7&#x27;</span> port=<span class="hljs-string">&#x27;0x16&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;pci.7&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x02&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x6&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;controller <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;virtio-serial&#x27;</span> index=<span class="hljs-string">&#x27;0&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;virtio-serial0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x03&#x27;</span> slot=<span class="hljs-string">&#x27;0x00&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br> &lt;/controller&gt;<br> &lt;interface <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;network&#x27;</span>&gt;<br>  &lt;mac address=<span class="hljs-string">&#x27;52:54:00:83:9d:51&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">source</span> network=<span class="hljs-string">&#x27;default&#x27;</span> bridge=<span class="hljs-string">&#x27;virbr0&#x27;</span>/&gt;<br>  &lt;target dev=<span class="hljs-string">&#x27;vnet0&#x27;</span>/&gt;<br>  &lt;model <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;virtio&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;net0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x01&#x27;</span> slot=<span class="hljs-string">&#x27;0x00&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br>  &lt;/interface&gt;<br> &lt;serial <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pty&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">source</span> path=<span class="hljs-string">&#x27;/dev/pts/0&#x27;</span>/&gt;<br>  &lt;target <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;isa-serial&#x27;</span> port=<span class="hljs-string">&#x27;0&#x27;</span>&gt;<br>   &lt;model name=<span class="hljs-string">&#x27;isa-serial&#x27;</span>/&gt;<br>  &lt;/target&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;serial0&#x27;</span>/&gt;<br> &lt;/serial&gt;<br> &lt;console <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pty&#x27;</span> tty=<span class="hljs-string">&#x27;/dev/pts/0&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">source</span> path=<span class="hljs-string">&#x27;/dev/pts/0&#x27;</span>/&gt;<br>  &lt;target <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;serial&#x27;</span> port=<span class="hljs-string">&#x27;0&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;serial0&#x27;</span>/&gt;<br> &lt;/console&gt;<br> &lt;channel <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;unix&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">source</span> mode=<span class="hljs-string">&#x27;bind&#x27;</span> path=<span class="hljs-string">&#x27;/var/lib/libvirt/qemu/channel/target/domain-2-</span><br><span class="hljs-string">centos8/org.qemu.guest_agent.0&#x27;</span>/&gt;<br>  &lt;target <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;virtio&#x27;</span> name=<span class="hljs-string">&#x27;org.qemu.guest_agent.0&#x27;</span> state=<span class="hljs-string">&#x27;disconnected&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;channel0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;virtio-serial&#x27;</span> controller=<span class="hljs-string">&#x27;0&#x27;</span> bus=<span class="hljs-string">&#x27;0&#x27;</span> port=<span class="hljs-string">&#x27;1&#x27;</span>/&gt;<br> &lt;/channel&gt;<br> &lt;channel <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;spicevmc&#x27;</span>&gt;<br>  &lt;target <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;virtio&#x27;</span> name=<span class="hljs-string">&#x27;com.redhat.spice.0&#x27;</span> state=<span class="hljs-string">&#x27;disconnected&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;channel1&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;virtio-serial&#x27;</span> controller=<span class="hljs-string">&#x27;0&#x27;</span> bus=<span class="hljs-string">&#x27;0&#x27;</span> port=<span class="hljs-string">&#x27;2&#x27;</span>/&gt;<br> &lt;/channel&gt;<br> &lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;tablet&#x27;</span> bus=<span class="hljs-string">&#x27;usb&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;input0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;usb&#x27;</span> bus=<span class="hljs-string">&#x27;0&#x27;</span> port=<span class="hljs-string">&#x27;1&#x27;</span>/&gt;<br> &lt;/input&gt;<br> &lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;mouse&#x27;</span> bus=<span class="hljs-string">&#x27;ps2&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;input1&#x27;</span>/&gt;<br> &lt;/input&gt;<br> &lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;keyboard&#x27;</span> bus=<span class="hljs-string">&#x27;ps2&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;input2&#x27;</span>/&gt;<br> &lt;/input&gt;<br> &lt;graphics <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;spice&#x27;</span> port=<span class="hljs-string">&#x27;5900&#x27;</span> autoport=<span class="hljs-string">&#x27;yes&#x27;</span> listen=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>&gt;<br>  &lt;listen <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;address&#x27;</span> address=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>/&gt;<br>  &lt;image compression=<span class="hljs-string">&#x27;off&#x27;</span>/&gt;<br> &lt;/graphics&gt;<br> &lt;sound model=<span class="hljs-string">&#x27;ich9&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;sound0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x1b&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br> &lt;/sound&gt;<br> &lt;video&gt;<br>  &lt;model <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;qxl&#x27;</span> ram=<span class="hljs-string">&#x27;65536&#x27;</span> vram=<span class="hljs-string">&#x27;65536&#x27;</span> vgamem=<span class="hljs-string">&#x27;16384&#x27;</span> heads=<span class="hljs-string">&#x27;1&#x27;</span><br>primary=<span class="hljs-string">&#x27;yes&#x27;</span>/&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;video0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x01&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br> &lt;/video&gt;<br> &lt;redirdev bus=<span class="hljs-string">&#x27;usb&#x27;</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;spicevmc&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;redir0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;usb&#x27;</span> bus=<span class="hljs-string">&#x27;0&#x27;</span> port=<span class="hljs-string">&#x27;2&#x27;</span>/&gt;<br> &lt;/redirdev&gt;<br> &lt;redirdev bus=<span class="hljs-string">&#x27;usb&#x27;</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;spicevmc&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;redir1&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;usb&#x27;</span> bus=<span class="hljs-string">&#x27;0&#x27;</span> port=<span class="hljs-string">&#x27;3&#x27;</span>/&gt;<br>   &lt;/redirdev&gt;<br> &lt;redirdev bus=<span class="hljs-string">&#x27;usb&#x27;</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;spicevmc&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;redir2&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;usb&#x27;</span> bus=<span class="hljs-string">&#x27;0&#x27;</span> port=<span class="hljs-string">&#x27;4&#x27;</span>/&gt;<br> &lt;/redirdev&gt;<br> &lt;memballoon model=<span class="hljs-string">&#x27;virtio&#x27;</span>&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;balloon0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x05&#x27;</span> slot=<span class="hljs-string">&#x27;0x00&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br> &lt;/memballoon&gt;<br> &lt;rng model=<span class="hljs-string">&#x27;virtio&#x27;</span>&gt;<br>  &lt;backend model=<span class="hljs-string">&#x27;random&#x27;</span>&gt;/dev/urandom&lt;/backend&gt;<br>  &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;rng0&#x27;</span>/&gt;<br>  &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x06&#x27;</span> slot=<span class="hljs-string">&#x27;0x00&#x27;</span><br><span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br> &lt;/rng&gt;<br>&lt;/devices&gt;<br>&lt;seclabel <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;dynamic&#x27;</span> model=<span class="hljs-string">&#x27;dac&#x27;</span> relabel=<span class="hljs-string">&#x27;yes&#x27;</span>&gt;<br> &lt;label&gt;+107:+107&lt;/label&gt;<br> &lt;imagelabel&gt;+107:+107&lt;/imagelabel&gt;<br>&lt;/seclabel&gt;<br>&lt;/domain&gt;<br></code></pre></td></tr></table></figure>

<h3 id="5-3-6-删除虚拟机配置"><a href="#5-3-6-删除虚拟机配置" class="headerlink" title="5.3.6 删除虚拟机配置"></a>5.3.6 删除虚拟机配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh list --all</span><br>Id  Name              State<br>----------------------------------------------------<br>2   centos8            running<br>-   centos7            shut off<br>-   centos8-vm2          shut off<br>-   centos8-vm3          shut off<br>-   centos8-vm4          shut off<br>-   Win_2008_r2-x86_64       shut off<br><br><span class="hljs-comment">#删除虚拟机配置,但不删除磁盘文件</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh undefine centos8-vm4</span><br>Domain centos8-vm4 has been undefined<br><br>[root@centos8 ~]<span class="hljs-comment">#virsh list --all</span><br>Id  Name              State<br>----------------------------------------------------<br>2   centos8            running<br>-   centos7            shut off<br>-   centos8-vm2          shut off<br>-   centos8-vm3          shut off<br>-   Win_2008_r2-x86_64       shut off<br><br><span class="hljs-comment">#对应虚拟机xml的配置文件被删除</span><br>[root@centos8 ~]<span class="hljs-comment">#ll /etc/libvirt/qemu/</span><br>total 28<br>drwxr-xr-x 2 root root  25 Sep 17 18:54 autostart<br>-rw------- 1 root root 3618 Sep 17 15:14 centos7.xml<br>-rw------- 1 root root 3673 Sep 13 22:43 centos8-vm2.xml<br>-rw------- 1 root root 3601 Sep 13 22:42 centos8-vm3.xml<br>-rw------- 1 root root 6024 Sep 17 15:47 centos8.xml<br>drwx------ 3 root root  42 Sep 13 19:03 networks<br>-rw------- 1 root root 5369 Sep 17 11:31 Win_2008_r2-x86_64.xml<br><br><span class="hljs-comment">#对应的磁盘文件并没有删除</span><br>[root@centos8 ~]<span class="hljs-comment">#ls /var/lib/libvirt/images/</span><br>centos7.qcow2 centos8.qcow2 centos8-vm2.qcow2 centos8-vm3.qcow2 centos8-vm4.qcow2 Windows-2008_r2-x86_64.qcow2<br></code></pre></td></tr></table></figure>

<h1 id="六、-存储管理"><a href="#六、-存储管理" class="headerlink" title="六、 存储管理"></a>六、 存储管理</h1><h2 id="6-1-KVM存储模式"><a href="#6-1-KVM存储模式" class="headerlink" title="6.1 KVM存储模式"></a>6.1 KVM存储模式</h2><p>通过存储池来简介存储的管理</p>
<p><strong>基于文件系统的存储</strong></p>
<ul>
<li>dir: Filesystem Directory 需要有挂载点的文件系统</li>
<li>fs: Pre-Formatted Block Device 无需挂载的文件系统,如:位于SAN存储的文件系统,可支持多个主机同时访问,而本地文件系统不支持</li>
<li>netfs: Network Exported Directory 网络文件系统,比如:NFS,SAMBA等 </li>
</ul>
<p><strong>基于设备的存储</strong><br>无需文件系统,性能更好,但可管理性差,无法实现快照</p>
<ul>
<li>Disk: Physical Disk Device</li>
<li>Iscsi: isCSI Target</li>
<li>logical:LVM Volume Group </li>
</ul>
<h2 id="6-2-虚拟磁盘类型"><a href="#6-2-虚拟磁盘类型" class="headerlink" title="6.2 虚拟磁盘类型"></a>6.2 虚拟磁盘类型</h2><ul>
<li><p>固定Fixed</p>
<p>在配置时，指定磁盘大小</p>
<p>不管在虚拟磁盘上实际存储多少数据，都将占用相同大小宿主机的磁盘空间</p>
</li>
<li><p>动态Dynamic</p>
<p>初始空间占用小</p>
<p>随着空间的使用逐渐增长到最大容量，但是只根据需求使用更多的空间</p>
</li>
<li><p>差异Differencing</p>
<p>因为创建是差异磁盘，所以只保存变更的数据</p>
<p>例如，将操作系统安装在父盘，然后创建差异化磁盘来执行进一步配置 </p>
</li>
</ul>
<h2 id="6-3-虚拟镜像文件格式"><a href="#6-3-虚拟镜像文件格式" class="headerlink" title="6.3 虚拟镜像文件格式"></a>6.3 虚拟镜像文件格式</h2><p>镜像文件储存在主机文件系统中。它可以储存在本地文件系统中，如 ext4 或 xfs；或网络文件系统中，如 NFS 。例如 libguestfs 这样的工具，能管理、备份及监控文件。KVM 上的磁盘镜像格式包括：</p>
<ul>
<li>raw </li>
</ul>
<p>此为默认磁盘格式,但并是一种真正的磁盘格式，而是代表虚拟机所使用的原始镜像,它并不存储元数据，因此可作为保证虚拟机兼容性的候选方案。然而，也正因为它不存储元数据，因此不支持某些高级特往，比如快照和压缩等格式简单，容易转换为其他的格式。</p>
<p>如果主机文件系统允许，raw 文件可以是预分配（pre-allocated）或 稀疏（sparse）。稀疏文件根据需求分配主机磁盘空间，因此它是一种精简配置形式（thin provisioning）。预分配文件的所有空间需要被预先分配，但它比稀疏文件性能好。当对磁盘 I/O 性能要求非常高，而且通常不需要通过网络传输镜像文件时，可以使用 raw文件</p>
<p>优点 : 性能好</p>
<p>缺点 : 空间占用大,功能较少,生产不推荐使用</p>
<ul>
<li><p>cow : copy-on-write格式，昙花一现</p>
</li>
<li><p>qcow : QEMU早期的copy-on-write格式，过渡性方案</p>
</li>
<li><p>qcow2</p>
</li>
</ul>
<p>qcow2 镜像文件提供许多高级磁盘镜像特征，如快照、压缩及加密。它们可以用来代表通过模板镜像创建的虚拟机。因为只有虚拟机写入的扇区部分才会分配在镜像中，所以 qcow2 文件的网络传输效率较高。RHEL 7.0 及更新版本支持 qcow2 v3 镜像文件格式</p>
<p>按需进行分配磁盘空间，不管文件系统是否支持</p>
<p>支持快照</p>
<p>支持zlib的磁盘压缩</p>
<p>支持AES的加密</p>
<p>优点 : 空间节约,功能丰富</p>
<p>缺点 : 性能较差,生产推荐使用</p>
<ul>
<li><p>vmdk( Virtual Machine Disk ): VMware环境当中默认使用的磁盘格式</p>
</li>
<li><p>vhd \ vhdx ( Virtual Hard Disk ):微软默认采用的文件格式</p>
</li>
<li><p>vdi : VirtualBox 采用的文件格式</p>
</li>
</ul>
<p><strong>查看支持格式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># qemu-img --help</span><br>qemu-img version 1.5.3, Copyright (c) 2004-2008 Fabrice Bellard<br>usage: qemu-img <span class="hljs-built_in">command</span> [<span class="hljs-built_in">command</span> options]<br>QEMU disk image utility<br><br>Command syntax:<br>  check [-q] [-f fmt] [--output=ofmt] [-r [leaks | all]] [-T src_cache] filename<br>  create [-q] [-f fmt] [-o options] filename [size]<br>  commit [-q] [-f fmt] [-t cache] filename<br>  compare [-f fmt] [-F fmt] [-T src_cache] [-p] [-q] [-s] filename1 filename2<br>  convert [-c] [-p] [-q] [-n] [-f fmt] [-t cache] [-T src_cache] [-O output_fmt] [-o options] [-s snapshot_name] [-S sparse_size] filename [filename2 [...]] output_filename<br>  info [-f fmt] [--output=ofmt] [--backing-chain] filename<br>  map [-f fmt] [--output=ofmt] filename<br>  snapshot [-q] [-l | -a snapshot | -c snapshot | -d snapshot] filename<br>  rebase [-q] [-f fmt] [-t cache] [-T src_cache] [-p] [-u] -b backing_file [-F backing_fmt] filename<br>  resize [-q] filename [+ | -]size<br>  amend [-q] [-f fmt] [-t cache] -o options filename<br></code></pre></td></tr></table></figure>

<p>范例: 查看KVM支持的磁盘格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># qemu-img --help|grep Support</span><br>Supported formats: blkdebug blkreplay blkverify copy-on-read file ftp ftps<br>gluster host_cdrom host_device http https iscsi iser luks nbd null-aio null-co<br>nvme qcow2 quorum raw rbd ssh throttle vhdx vmdk vpc<br></code></pre></td></tr></table></figure>

<h2 id="6-4-使用qemu-img管理虚拟磁盘文件"><a href="#6-4-使用qemu-img管理虚拟磁盘文件" class="headerlink" title="6.4 使用qemu-img管理虚拟磁盘文件"></a>6.4 使用qemu-img管理虚拟磁盘文件</h2><h3 id="6-4-1-qemu-img-概述"><a href="#6-4-1-qemu-img-概述" class="headerlink" title="6.4.1 qemu-img 概述"></a>6.4.1 qemu-img 概述</h3><p>qemu-img 是一个功能强大的磁盘镜像管理工具</p>
<p>查看帮助: qemu-img –help</p>
<p>qemu-img 包括以下子命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">check     <span class="hljs-comment">#检查完整性</span><br>create    <span class="hljs-comment">#创建镜像</span><br>commit    <span class="hljs-comment">#提交更改</span><br>compare   <span class="hljs-comment">#比较</span><br>convert   <span class="hljs-comment">#转换</span><br>info      <span class="hljs-comment">#获得信息</span><br>map       <span class="hljs-comment">#映射</span><br>snapshot  <span class="hljs-comment">#快照管理</span><br>rebase    <span class="hljs-comment">#在已有的镜像的基础上创建新的镜像</span><br>resize    <span class="hljs-comment">#调整大小</span><br>amend     <span class="hljs-comment">#修订镜像格式选项</span><br></code></pre></td></tr></table></figure>

<h3 id="6-4-2-创建虚拟磁盘文件"><a href="#6-4-2-创建虚拟磁盘文件" class="headerlink" title="6.4.2 创建虚拟磁盘文件"></a>6.4.2 创建虚拟磁盘文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">create [-q] [--object objectdef] [-f fmt] [-b backing_file] [-F backing_fmt] [-<br>u] [-o options] filename [size]<br></code></pre></td></tr></table></figure>

<h4 id="6-4-2-1-创建默认配置的磁盘"><a href="#6-4-2-1-创建默认配置的磁盘" class="headerlink" title="6.4.2.1 创建默认配置的磁盘"></a>6.4.2.1 创建默认配置的磁盘</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#默认为raw格式稀疏文件</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img create vm1.img 1g</span><br>Formatting <span class="hljs-string">&#x27;vm1.img&#x27;</span>, fmt=raw size=1073741824<br>[root@centos8 ~]<span class="hljs-comment">#file vm1.img</span><br>vm1.img: data<br><br><span class="hljs-comment">#显示文件大小</span><br>[root@centos8 ~]<span class="hljs-comment"># ll -h vm1.img</span><br>-rw-r--r-- 1 root root 1.0G Sep 20 12:17 vm1.img<br><br><span class="hljs-comment">#实际文件只占4k空间</span><br>[root@centos8 ~]<span class="hljs-comment"># du -h vm1.img</span><br>4.0K vm1.img<br><br><span class="hljs-comment">#显示文件信息</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info vm1.img</span><br>image: vm1.img<br>file format: raw<br>virtual size: 1.0G (1073741824 bytes)<br>disk size: 4.0K<br></code></pre></td></tr></table></figure>

<h4 id="6-4-2-2-查看不同磁盘文件格式支持选项"><a href="#6-4-2-2-查看不同磁盘文件格式支持选项" class="headerlink" title="6.4.2.2 查看不同磁盘文件格式支持选项"></a>6.4.2.2 查看不同磁盘文件格式支持选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f raw -o ?</span><br>Supported options:<br>size       Virtual disk size<br>[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 -o ?</span><br>Supported qcow2 options:<br>  backing_file=&lt;str&gt;     - File name of a base image<br>  backing_fmt=&lt;str&gt;      - Image format of the base image<br>  cluster_size=&lt;size&gt;    - qcow2 cluster size<br>  compat=&lt;str&gt;           - Compatibility level (v2 [0.10] or v3 [1.1])<br>  data_file=&lt;str&gt;        - File name of an external data file<br>  data_file_raw=&lt;bool (on/off)&gt; - The external data file must stay valid as a raw image<br>  encrypt.cipher-alg=&lt;str&gt; - Name of encryption cipher algorithm<br>  encrypt.cipher-mode=&lt;str&gt; - Name of encryption cipher mode<br>  encrypt.format=&lt;str&gt;   - Encrypt the image, format choices: <span class="hljs-string">&#x27;aes&#x27;</span>, <span class="hljs-string">&#x27;luks&#x27;</span><br>  encrypt.hash-alg=&lt;str&gt; - Name of encryption <span class="hljs-built_in">hash</span> algorithm<br>  encrypt.iter-time=&lt;num&gt; - Time to spend <span class="hljs-keyword">in</span> PBKDF <span class="hljs-keyword">in</span> milliseconds<br>  encrypt.ivgen-alg=&lt;str&gt; - Name of IV generator algorithm<br>  encrypt.ivgen-hash-alg=&lt;str&gt; - Name of IV generator <span class="hljs-built_in">hash</span> algorithm<br>  encrypt.key-secret=&lt;str&gt; - ID of secret providing qcow AES key or LUKS passphrase<br>  encryption=&lt;bool (on/off)&gt; - Encrypt the image with format <span class="hljs-string">&#x27;aes&#x27;</span>. (Deprecated <span class="hljs-keyword">in</span> favor of encrypt.format=aes)<br>  lazy_refcounts=&lt;bool (on/off)&gt; - Postpone refcount updates<br>  preallocation=&lt;str&gt;    - Preallocation mode (allowed values: off, metadata, falloc, full)<br>  refcount_bits=&lt;num&gt;    - Width of a reference count entry <span class="hljs-keyword">in</span> bits<br>  size=&lt;size&gt;            - Virtual disk size<br><br>The protocol level may support further options.<br>Specify the target filename to include those options.<br></code></pre></td></tr></table></figure>

<h4 id="6-4-2-3-qcow2-格式选项"><a href="#6-4-2-3-qcow2-格式选项" class="headerlink" title="6.4.2.3 qcow2 格式选项"></a>6.4.2.3 qcow2 格式选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">backing_file    <span class="hljs-comment">#指定后端镜像文件。</span><br>backing_fmt     <span class="hljs-comment">#设置后端镜像的镜像格式。</span><br>cluster_size    <span class="hljs-comment">#设置镜像中的簇大小，取值在512到2M之间，默认值为64K。</span><br>preallocation   <span class="hljs-comment">#设置镜像文件空间的预分配模式</span><br>encryption      <span class="hljs-comment">#用于设置加密</span><br></code></pre></td></tr></table></figure>

<h4 id="6-4-2-4-创建raw格式非稀疏文件（占内存）"><a href="#6-4-2-4-创建raw格式非稀疏文件（占内存）" class="headerlink" title="6.4.2.4 创建raw格式非稀疏文件（占内存）"></a>6.4.2.4 创建raw格式非稀疏文件（占内存）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># dd if=/dev/zero of=vm2.img bs=1M count=1024</span><br>1024+0 records <span class="hljs-keyword">in</span><br>1024+0 records out<br>1073741824 bytes (1.1 GB, 1.0 GiB) copied, 3.20332 s, 335 MB/s<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info vm2.img</span><br>image: vm2.img<br>file format: raw<br>virtual size: 1.0G (1073741824 bytes)<br>disk size: 1.0G<br><br>[root@centos8 ~]<span class="hljs-comment"># ls -hl vm2.img</span><br>-rw-r--r-- 1 root root 1.0G Sep 20 12:31 vm2.img<br>[root@centos8 ~]<span class="hljs-comment"># du -h vm2.img</span><br>1.0G vm2.img<br></code></pre></td></tr></table></figure>

<h4 id="6-4-2-5-创建raw格式稀疏文件（不占内存）"><a href="#6-4-2-5-创建raw格式稀疏文件（不占内存）" class="headerlink" title="6.4.2.5 创建raw格式稀疏文件（不占内存）"></a>6.4.2.5 创建raw格式稀疏文件（不占内存）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># dd if=/dev/zero of=vm3.img bs=1M count=0 seek=1024</span><br>0+0 records <span class="hljs-keyword">in</span><br>0+0 records out<br>0 bytes copied, 9.2173e-05 s, 0.0 kB/s<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info vm3.img</span><br>image: vm3.img<br>file format: raw<br>virtual size: 1.0G (1073741824 bytes)<br>disk size: 0<br><br>[root@centos8 ~]<span class="hljs-comment"># ll -h vm3.img</span><br>-rw-r--r-- 1 root root 1.0G Sep 20 12:34 vm3.img<br>[root@centos8 ~]<span class="hljs-comment"># du -h vm3.img</span><br>0 vm3.img<br></code></pre></td></tr></table></figure>

<h4 id="6-4-2-6-raw文件复制的格式控制"><a href="#6-4-2-6-raw文件复制的格式控制" class="headerlink" title="6.4.2.6 raw文件复制的格式控制"></a>6.4.2.6 raw文件复制的格式控制</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#复制非稀疏文件,默认为非稀疏文件</span><br>[root@centos8 ~]<span class="hljs-comment"># cp vm2.img vm2.img.bak</span><br>[root@centos8 ~]<span class="hljs-comment"># du -h vm2.img.bak</span><br>1.0G vm2.img.bak<br>[root@centos8 ~]<span class="hljs-comment"># ll -h vm2.img.bak</span><br>-rw-r--r-- 1 root root 1.0G Sep 20 12:38 vm2.img.bak<br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info vm2.img.bak</span><br>image: vm2.img.bak<br>file format: raw<br>virtual size: 1.0G (1073741824 bytes)<br>disk size: 1.0G<br><br><span class="hljs-comment">#复制稀疏文件,默认为稀疏文件</span><br>[root@centos8 ~]<span class="hljs-comment"># cp vm3.img vm3.img.bak</span><br>[root@centos8 ~]<span class="hljs-comment"># ll -h vm3.img.bak</span><br>-rw-r--r-- 1 root root 1.0G Sep 20 12:36 vm3.img.bak<br>[root@centos8 ~]<span class="hljs-comment"># du -h vm3.img.bak</span><br>0 vm3.img.bak<br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info vm3.img.bak</span><br>image: vm3.img.bak<br>file format: raw<br>virtual size: 1.0G (1073741824 bytes)<br>disk size: 0<br><br><span class="hljs-comment">#指定将非稀疏文件复制为稀疏格式格式</span><br>[root@centos8 ~]<span class="hljs-comment"># cp --sparse=always vm2.img vm2.img.bak2</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info vm2.img</span><br>image: vm2.img<br>file format: raw<br>virtual size: 1.0G (1073741824 bytes)<br>disk size: 1.0G<br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info vm2.img.bak2</span><br>image: vm2.img.bak2<br>file format: raw<br>virtual size: 1.0G (1073741824 bytes)<br>disk size: 0<br><br><span class="hljs-comment">#指定将稀疏文件复制为非稀疏格式格式</span><br>[root@centos8 ~]<span class="hljs-comment"># cp --sparse=never vm3.img vm3.img.bak2</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info vm3.img</span><br>image: vm3.img<br>file format: raw<br>virtual size: 1.0G (1073741824 bytes)<br>disk size: 0<br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info vm3.img.bak2</span><br>image: vm3.img.bak2<br>file format: raw<br>virtual size: 1.0G (1073741824 bytes)<br>disk size: 1.0G<br></code></pre></td></tr></table></figure>

<h3 id="6-4-3-检查虚拟磁盘"><a href="#6-4-3-检查虚拟磁盘" class="headerlink" title="6.4.3 检查虚拟磁盘"></a>6.4.3 检查虚拟磁盘</h3><p>对于关机状态的虚拟机磁盘,可以检查文件错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>2   centos8            running<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img check /var/lib/libvirt/images/centos8.qcow2</span><br>qemu-img: Could not open <span class="hljs-string">&#x27;/var/lib/libvirt/images/centos8.qcow2&#x27;</span>: Failed to get<br>shared <span class="hljs-string">&quot;write&quot;</span> lock<br>Is another process using the image [/var/lib/libvirt/images/centos8.qcow2]?<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh suspend centos8</span><br>Domain centos8 suspended<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>2   centos8            paused<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img check /var/lib/libvirt/images/centos8.qcow2</span><br>qemu-img: Could not open <span class="hljs-string">&#x27;/var/lib/libvirt/images/centos8.qcow2&#x27;</span>: Failed to get<br>shared <span class="hljs-string">&quot;write&quot;</span> lock<br>Is another process using the image [/var/lib/libvirt/images/centos8.qcow2]?<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img check /var/lib/libvirt/images/centos7.qcow2</span><br>No errors were found on the image.<br>25572/327680 = 7.80% allocated, 1.44% fragmented, 0.00% compressed clusters<br>Image end offset: 1676869632<br></code></pre></td></tr></table></figure>

<h3 id="6-4-4-磁盘预分配策略"><a href="#6-4-4-磁盘预分配策略" class="headerlink" title="6.4.4 磁盘预分配策略"></a>6.4.4 磁盘预分配策略</h3><p>raw 文件的预分配策略和文件系统是否支持有关,而qcow2则无关</p>
<p>预分配策略</p>
<ul>
<li><p>off</p>
<p>此为缺省（默认）策略，即不使用预分配策略,预分配后的虚拟磁盘占用空间很小,不属于稀疏映像类型,生成的磁盘文件很小</p>
</li>
<li><p>metadata</p>
<p>只预分配元数据(metadata)，预分配后的磁盘文件属于稀疏映像类型,相当于vmware中的磁盘置备选项: Thin Provision(精简配置)</p>
</li>
<li><p>falloc</p>
<p>分配文件的块并标识它们的状态为未初始化，即只分配空间,但不置零. 预分配后的虚拟磁盘属于非稀疏映像类型,相对full模式来说，创建虚拟磁盘的速度要快很多,相当于vmware中的磁盘置备选项:厚置备延迟置零</p>
</li>
<li><p>full</p>
<p>分配所有磁盘空间并置零，预分配后的虚拟磁盘属于非稀疏映像类型,创建最慢,相当于vmware中的磁盘置备选项: 厚置备置零</p>
</li>
</ul>
<p>范例: 创建预分配置策略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 test1.qcow2 1g</span><br>Formatting <span class="hljs-string">&#x27;test1.qcow2&#x27;</span>, fmt=qcow2 size=1073741824 cluster_size=65536 lazy_refcounts=off refcount_bits=16<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info test1.qcow2</span><br>image: test1.qcow2<br>file format: qcow2<br>virtual size: 1 GiB (1073741824 bytes)<br>disk size: 196 KiB<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">false</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br> <br><span class="hljs-comment">#指定关闭预分配</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 test2.qcow2 1g -o preallocation=off</span><br>Formatting <span class="hljs-string">&#x27;test2.qcow2&#x27;</span>, fmt=qcow2 size=1073741824 cluster_size=65536<br>preallocation=off lazy_refcounts=off refcount_bits=16<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info test2.qcow2</span><br>image: test2.qcow2<br>file format: qcow2<br>virtual size: 1 GiB (1073741824 bytes)<br>disk size: 196 KiB<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">false</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br> <br><span class="hljs-comment">#指定预分配metadata（不占真实内存）</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 test3.qcow2 1g -o preallocation=metadata</span><br>Formatting <span class="hljs-string">&#x27;test3.qcow2&#x27;</span>, fmt=qcow2 size=1073741824 cluster_size=65536 preallocation=metadata lazy_refcounts=off refcount_bits=16<br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info test3.qcow2</span><br>image: test3.qcow2<br>file format: qcow2<br>virtual size: 1 GiB (1073741824 bytes)<br>disk size: 832 KiB<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">false</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br> <br><span class="hljs-comment">#指定预分配falloc</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 test4.qcow2 1g -o preallocation=falloc</span><br>Formatting <span class="hljs-string">&#x27;test4.qcow2&#x27;</span>, fmt=qcow2 size=1073741824 cluster_size=65536<br>preallocation=falloc lazy_refcounts=off refcount_bits=16<br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info test4.qcow2</span><br>image: test4.qcow2<br>file format: qcow2<br>virtual size: 1 GiB (1073741824 bytes)<br>disk size: 2 GiB<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">false</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br><br><span class="hljs-comment">#指定预分配full</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 test5.qcow2 1g -o preallocation=full</span><br>Formatting <span class="hljs-string">&#x27;test5.qcow2&#x27;</span>, fmt=qcow2 size=1073741824 cluster_size=65536<br>preallocation=full lazy_refcounts=off refcount_bits=16<br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info test5.qcow2</span><br>image: test5.qcow2<br>file format: qcow2<br>virtual size: 1 GiB (1073741824 bytes)<br>disk size: 1 GiB<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">false</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br><br><span class="hljs-comment">#文件系统显示大小</span><br>[root@centos8 ~]<span class="hljs-comment"># ll -h test*.qcow2</span><br>-rw-r--r-- 1 root root 193K Sep 20 13:31 test1.qcow2<br>-rw-r--r-- 1 root root 193K Sep 20 13:32 test2.qcow2<br>-rw-r--r-- 1 root root 1.1G Sep 20 13:35 test3.qcow2<br>-rw-r--r-- 1 root root 1.1G Sep 20 13:36 test4.qcow2<br>-rw-r--r-- 1 root root 1.1G Sep 20 13:37 test5.qcow2<br><br><span class="hljs-comment">#查看真实大小</span><br>[root@centos8 ~]<span class="hljs-comment"># du -h test*.qcow2</span><br>196K test1.qcow2<br>196K test2.qcow2<br>836K test3.qcow2<br>1.1G test4.qcow2<br>1.1G test5.qcow2<br></code></pre></td></tr></table></figure>

<h3 id="6-4-5-后备差异虚拟磁盘"><a href="#6-4-5-后备差异虚拟磁盘" class="headerlink" title="6.4.5 后备差异虚拟磁盘"></a>6.4.5 后备差异虚拟磁盘</h3><h4 id="6-4-5-1-后备差异虚拟磁盘介绍"><a href="#6-4-5-1-后备差异虚拟磁盘介绍" class="headerlink" title="6.4.5.1 后备差异虚拟磁盘介绍"></a>6.4.5.1 后备差异虚拟磁盘介绍</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm159.png" srcset="/blog/img/loading.gif"></p>
<p>有很多虚拟机中磁盘的内容有很多相同的部分,可以使用后备差异虚拟磁盘节约磁盘的占用</p>
<p>先创建一个镜像磁盘,并在磁盘中安装相同的应用配置,用此磁盘文件做为为模版,在此基础上建立多个后备差异虚拟磁盘文件,再分别分配给需求不同的虚拟机使用,后备差异虚拟磁盘相当于Vmware中的链接克隆</p>
<p><strong>后备差异虚拟磁盘特点</strong></p>
<ul>
<li>存储与基础镜像（父）磁盘的变化</li>
<li>基础镜像（父）磁盘不会改变</li>
<li>差异磁盘隔离变化</li>
<li>多个差异磁盘可以使用相同的基础镜像（父）磁盘</li>
</ul>
<p>优点: 标准化基础镜像，节省空间</p>
<p>缺点: 增加了开销，较差的性能</p>
<h4 id="6-4-5-2-创建后备差异虚拟磁盘并用virt-install启动虚拟机"><a href="#6-4-5-2-创建后备差异虚拟磁盘并用virt-install启动虚拟机" class="headerlink" title="6.4.5.2 创建后备差异虚拟磁盘并用virt-install启动虚拟机"></a>6.4.5.2 创建后备差异虚拟磁盘并用virt-install启动虚拟机</h4><p>创建后备差异虚拟磁盘命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-img create -f qcow2  -o backing_file=base.qcow2(或者raw)  diff.qcow2<br><span class="hljs-comment">#注意:模版镜像文件可以是raw或qcow2,但是后备差异磁盘文件必须是qcow2格式</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建后备差异虚拟磁盘</span><br>[root@centos8 images]<span class="hljs-comment"># pwd</span><br>/var/lib/libvirt/images<br><br><span class="hljs-comment">#以centos8.qcow2创建centos8-test.qcow2的后背差异虚拟磁盘</span><br>[root@centos8 images]<span class="hljs-comment"># qemu-img create -f qcow2 -o backing_file=centos8.qcow2 centos8-test1.qcow2</span><br>Formatting <span class="hljs-string">&#x27;centos8-test1.qcow2&#x27;</span>, fmt=qcow2 size=21474836480<br>backing_file=centos8.qcow2 cluster_size=65536 lazy_refcounts=off<br>refcount_bits=16<br><br>[root@centos8 images]<span class="hljs-comment"># qemu-img info centos8-test1.qcow2</span><br>image: centos8-test1.qcow2<br>file format: qcow2<br>virtual size: 20 GiB (21474836480 bytes)<br>disk size: 196 KiB<br>cluster_size: 65536<br>backing file: centos8.qcow2<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">false</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br> <br>[root@centos8 images]<span class="hljs-comment"># qemu-img info centos8.qcow2</span><br>image: centos8.qcow2<br>file format: qcow2<br>virtual size: 20 GiB (21474836480 bytes)<br>disk size: 24 GiB<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">true</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br> <br>[root@centos8 images]<span class="hljs-comment"># ll -h centos8*</span><br>-rw------- 1 qemu qemu 21G Sep 20 13:10 centos8.qcow2<br>-rw-r--r-- 1 qemu qemu 193K Sep 20 14:08 centos8-test1.qcow2<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list --all</span><br>Id  Name              State<br>----------------------------------------------------<br>-   centos7            shut off<br>-   centos8            shut off<br><br><span class="hljs-comment">#基于已安装系统的磁盘文件直接启动虚拟机</span><br><span class="hljs-comment">#注意模版镜像磁盘对应的虚拟机需要是关机状态才可以创建新的虚拟机</span><br>[root@centos8 images]<span class="hljs-comment"># virt-install --import --name=centos8-test1 --vcpus=1 --ram=2048 --disk path=/var/lib/libvirt/images/centos8-test1.qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --os-type=linux --os-variant=centos8</span><br>WARNING Graphics requested but DISPLAY is not <span class="hljs-built_in">set</span>. Not running virt-viewer.<br>WARNING No console to launch <span class="hljs-keyword">for</span> the guest, defaulting to --<span class="hljs-built_in">wait</span> -1<br><br>Starting install...<br>Domain installation still <span class="hljs-keyword">in</span> progress.<br>Waiting <span class="hljs-keyword">for</span> installation to complete.<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>5   centos8-test1         running<br><br>[root@centos8 images]<span class="hljs-comment"># ll -h centos8*</span><br>-rw------- 1 qemu qemu 21G Sep 20 13:10 centos8.qcow2<br>-rw-r--r-- 1 qemu qemu 32M Sep 20 14:06 centos8-test1.qcow2<br></code></pre></td></tr></table></figure>

<h4 id="6-4-5-3-创建后备差异虚拟磁盘并用virt-manager启动虚拟机"><a href="#6-4-5-3-创建后备差异虚拟磁盘并用virt-manager启动虚拟机" class="headerlink" title="6.4.5.3 创建后备差异虚拟磁盘并用virt-manager启动虚拟机"></a>6.4.5.3 创建后备差异虚拟磁盘并用virt-manager启动虚拟机</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 images]<span class="hljs-comment"># pwd</span><br>/var/lib/libvirt/images<br><br>[root@centos8 images]<span class="hljs-comment"># qemu-img create -f qcow2 -o backing_file=centos8.qcow2 centos8-test2.qcow2</span><br>Formatting <span class="hljs-string">&#x27;centos8-test2.qcow2&#x27;</span>, fmt=qcow2 size=21474836480<br>backing_file=centos8.qcow2 cluster_size=65536 lazy_refcounts=off<br>refcount_bits=16<br><br>[root@centos8 images]<span class="hljs-comment"># qemu-img info centos8-test2.qcow2</span><br>image: centos8-test2.qcow2<br>file format: qcow2<br>virtual size: 20 GiB (21474836480 bytes)<br>disk size: 196 KiB<br>cluster_size: 65536<br>backing file: centos8.qcow2<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">false</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br> <br>[root@centos8 images]<span class="hljs-comment"># ll centos8-test2.qcow2 -h</span><br>-rw-r--r-- 1 root root 193K Sep 20 15:33 centos8-test2.qcow2<br><br>[root@centos8 images]<span class="hljs-comment"># virt-manager</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm160.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm161.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm162.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm163.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm164.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm165.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm166.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-4-5-4-后备差异虚拟磁盘依赖关系"><a href="#6-4-5-4-后备差异虚拟磁盘依赖关系" class="headerlink" title="6.4.5.4 后备差异虚拟磁盘依赖关系"></a>6.4.5.4 后备差异虚拟磁盘依赖关系</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 images]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br><br>[root@centos8 images]<span class="hljs-comment"># mv centos8.qcow2 centos8.qcow2.bak</span><br><br><span class="hljs-comment">#如果没有基础镜像文件,将无法启动使用后备差异虚拟磁盘的虚拟机</span><br>[root@centos8 images]<span class="hljs-comment"># virsh start centos8-test1</span><br>error: Failed to start domain centos8-test1<br>error: Cannot access backing file <span class="hljs-string">&#x27;/var/lib/libvirt/images/centos8.qcow2&#x27;</span> of<br>storage file <span class="hljs-string">&#x27;/var/lib/libvirt/images/centos8-test1.qcow2&#x27;</span> (as uid:107,<br>gid:107): No such file or directory<br><br><span class="hljs-comment">#恢复基础镜像文件,再次启动虚拟机成功</span><br>[root@centos8 images]<span class="hljs-comment"># mv centos8.qcow2.bak centos8.qcow2</span><br>[root@centos8 images]<span class="hljs-comment"># virsh start centos8-test1</span><br>Domain centos8-test1 started<br><br>[root@centos8 images]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>10  centos8-test1         running<br></code></pre></td></tr></table></figure>

<h3 id="6-4-6-虚拟磁盘格式转换"><a href="#6-4-6-虚拟磁盘格式转换" class="headerlink" title="6.4.6 虚拟磁盘格式转换"></a>6.4.6 虚拟磁盘格式转换</h3><p>qemu-img 可以将不同格式的虚拟磁盘文件进行格式转化</p>
<p><strong>语法格式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-img convert [--object objectdef] [--image-opts] [--target-image-opts] [-U]<br>[-C] [-c] [-p] [-q] [-n] [-f fmt] [-t cache] [-T src_cache] [-O output_fmt] [-B<br>backing_file] [-o options] [-s snapshot_id_or_name] [-l snapshot_param] [-S<br>sparse_size] [-m num_coroutines] [-W] filename [filename2 [...]] output_filename<br></code></pre></td></tr></table></figure>

<p><strong>范例: 将vmdk转化为raw 和qcow2格式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># qemu-img info CentOS8.2.vmdk</span><br>image: CentOS8.2.vmdk<br>file format: vmdk<br>virtual size: 200G (214748364800 bytes)<br>disk size: 1.6G<br>cluster_size: 65536<br>Format specific information:<br>    cid: 2898578192<br>    parent cid: 4294967295<br>    create <span class="hljs-built_in">type</span>: monolithicSparse<br>    extents:<br>      [0]:<br>        virtual size: 214748364800<br>        filename: CentOS8.2.vmdk<br>        cluster size: 65536<br>        format:<br>     <br><span class="hljs-comment">#默认转化为raw格式</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img convert CentOS8.2.vmdk CentOS8.2.img</span><br><br><span class="hljs-comment">#比较大小</span><br>[root@centos8 ~]<span class="hljs-comment"># ll -h CentOS8.2.vmdk CentOS8.2.img</span><br>-rw-r--r-- 1 root root 1.6G Sep 20 16:00 CentOS8.2.vmdk<br>-rw-r--r-- 1 root root 200G Sep 20 16:10 CentOS8.2.img<br><br>[root@centos8 ~]<span class="hljs-comment"># du -h CentOS8.2.vmdk CentOS8.2.img</span><br>1.6G CentOS8.2.vmdk<br>1.5G CentOS8.2.img<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info CentOS8.2.img</span><br>image: CentOS8.2.img<br>file format: raw<br>virtual size: 200G (214748364800 bytes)<br>disk size: 1.4G<br><br>[root@centos8 ~]<span class="hljs-comment"># mv CentOS8.2.img /var/lib/libvirt/images/</span><br><br>[root@centos8 ~]<span class="hljs-comment"># virt-install --import --name=centos8-test2 --vcpus=1 --ram=2048 --disk bus=scsi,path=/var/lib/libvirt/images/CentOS8.2.img --network network=default --graphics vnc,listen=0.0.0.0 --os-type=linux --os-variant=centos8 --noautoconsole --boot hd</span><br><br><span class="hljs-comment">#转化为qcow2格式</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img convert -f vmdk -O qcow2 CentOS8.2.vmdk CentOS8.2.qcow2</span><br><br><span class="hljs-comment">#比较大小</span><br>[root@centos8 ~]<span class="hljs-comment"># ll -h CentOS8.2.vmdk CentOS8.2.qcow2</span><br>-rw-r--r-- 1 root root 1.6G Sep 20 16:00 CentOS8.2.vmdk<br>-rw-r--r-- 1 root root 1.6G Sep 20 16:12 CentOS8.2.qcow2<br>[root@centos8 ~]<span class="hljs-comment"># du -h CentOS8.2.vmdk CentOS8.2.qcow2</span><br>1.6G CentOS8.2.vmdk<br>1.6G CentOS8.2.qcow2<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info CentOS8.2.qcow2</span><br>image: CentOS8.2.qcow2<br>file format: qcow2<br>virtual size: 200G (214748364800 bytes)<br>disk size: 1.5G<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">false</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br> <br>[root@centos8 ~]<span class="hljs-comment"># mv CentOS8.2.qcow2 /var/lib/libvirt/images/</span><br><br>[root@centos8 ~]<span class="hljs-comment"># virt-install --import --name=centos8-test3 --vcpus=1 --ram=2048 --disk bus=scsi,path=/var/lib/libvirt/images/CentOS8.2.qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --os-type=linux --os-variant=centos8 --noautoconsole --boot hd</span><br></code></pre></td></tr></table></figure>

<h3 id="6-4-7-调整虚拟磁盘大小"><a href="#6-4-7-调整虚拟磁盘大小" class="headerlink" title="6.4.7 调整虚拟磁盘大小"></a>6.4.7 调整虚拟磁盘大小</h3><p>虚拟磁盘文件创建后,还可以调整虚拟磁盘大小</p>
<p>语法格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">qemu-img resize [--shrink] filename [+l -]size<br></code></pre></td></tr></table></figure>

<ul>
<li>操作之前，一定要做好数据备份</li>
<li>增加文件大小后，需要在客户机中使用fdisk、parted等分区工具进行相应的操作才能真正让客户<br>机使用到增加后的镜像空间。</li>
<li>缩小镜像之前，要在客户机中保证里面的文件系统有空余空间，否则会数据丢失。另外xfs文件系<br>统不支持缩减</li>
<li>qcow2不支持缩小镜像的操作</li>
</ul>
<p>范例: 扩展拟磁盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># qemu-img info /var/lib/libvirt/images/centos8.qcow2</span><br>image: /var/lib/libvirt/images/centos8.qcow2<br>file format: qcow2<br>virtual size: 20G (21474836480 bytes)<br>disk size: 20G<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">true</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br> <br><span class="hljs-comment">#增加10G空间</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img resize /var/lib/libvirt/images/centos8.qcow2 +10G</span><br>Image resized.<br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info /var/lib/libvirt/images/centos8.qcow2</span><br>image: /var/lib/libvirt/images/centos8.qcow2<br>file format: qcow2<br>virtual size: 30G (32212254720 bytes)<br>disk size: 20G<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">true</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br> <br><span class="hljs-comment">#启动虚拟机后,还需要使用fdisk等工具进行空间的继续管理才能使用</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm168.png" srcset="/blog/img/loading.gif"></p>
<p>范例: 缩减虚拟磁盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 images]<span class="hljs-comment"># qemu-img info centos7.qcow2</span><br>image: centos7.qcow2<br>file format: qcow2<br>virtual size: 20G (21474836480 bytes)<br>disk size: 1.6G<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">false</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br>[root@centos8 images]<span class="hljs-comment"># qemu-img resize --shrink /var/lib/libvirt/images/centos7.qcow2 -2G</span><br>Image resized.<br>[root@centos8 images]<span class="hljs-comment">#qemu-img info centos7.qcow2</span><br>image: centos7.qcow2<br>file format: qcow2<br>virtual size: 18G (19327352832 bytes)<br>disk size: 1.6G<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: <span class="hljs-literal">false</span><br>    refcount bits: 16<br>    corrupt: <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<h2 id="6-5-磁盘快照管理"><a href="#6-5-磁盘快照管理" class="headerlink" title="6.5 磁盘快照管理"></a>6.5 磁盘快照管理</h2><h3 id="6-5-1-快照Snapshot介绍"><a href="#6-5-1-快照Snapshot介绍" class="headerlink" title="6.5.1 快照Snapshot介绍"></a>6.5.1 快照Snapshot介绍</h3><h4 id="6-5-1-1-快照分类"><a href="#6-5-1-1-快照分类" class="headerlink" title="6.5.1.1 快照分类"></a>6.5.1.1 快照分类</h4><ul>
<li><p>磁盘快照</p>
<p>对磁盘数据进行快照</p>
<p>主要用于虚拟机备份等场合</p>
</li>
<li><p>内存快照</p>
<p>对虚拟机的内存/设备信息进行保存</p>
<p>该机制同时用于休眠恢复，迁移等场景</p>
<p>主要使用virsh save ( qemu migrate to file）实现，只能对运行的虚拟机进行</p>
</li>
<li><p>检查点Checkpoint快照</p>
<p>同时保存虚拟机的磁盘快照和内存快照</p>
<p>用于将虚拟机恢复到某个时间点</p>
<p>可以保证数据的一致性</p>
</li>
</ul>
<h4 id="6-5-1-2-磁盘快照分类"><a href="#6-5-1-2-磁盘快照分类" class="headerlink" title="6.5.1.2 磁盘快照分类"></a>6.5.1.2 磁盘快照分类</h4><ul>
<li><p>按快照信息保存分为:</p>
<p>内置快照∶快照数据和base磁盘数据放在同一个qcow2文件中</p>
<p>外置快照︰快照数据单独的另一个qcow2文件存放</p>
</li>
<li><p>按虚拟机状态可以分为:</p>
<p>关机态快照︰数据可以保证一致性</p>
<p>运行态快照∶数据无法保证一致性，类似与系统crash后的磁盘数据。使用是可能需要fsck等操作。</p>
</li>
<li><p>按磁盘数量可以分为:</p>
<p>单盘:单盘快照不涉及原子性</p>
<p>多盘:涉及原子性。主要分两个方面:1.是所有盘快照点相同2.所有盘要么都快照成功，要么都快照失败。主要依赖于qemu的transaction实现</p>
</li>
</ul>
<h3 id="6-5-2-qemu-img-管理磁盘快照"><a href="#6-5-2-qemu-img-管理磁盘快照" class="headerlink" title="6.5.2 qemu-img 管理磁盘快照"></a>6.5.2 qemu-img 管理磁盘快照</h3><p>命令格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-img snapshot [--object objectdef] [--image-opts] [-U] [-q] [-l | -a<br>snapshot | -c snapshot | -d snapshot] filename<br><br>snapshot is the name of the snapshot to create, apply or delete<br>-a applies a snapshot (revert disk to saved state)<br>-c creates a snapshot<br>-d deletes a snapshot<br>-l lists all snapshots <span class="hljs-keyword">in</span> the given image<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看块设备</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh domblklist centos7</span><br>Target   Source<br>------------------------------------------------<br>hda    /var/lib/libvirt/images/centos7.qcow2<br>hdb     -<br><br><span class="hljs-comment">#查看快照,如果没有快照,则无显示信息</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2</span><br><br><span class="hljs-comment">#创建快照</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img snapshot -c centos7-s1 /var/lib/libvirt/images/centos7.qcow2</span><br><br><span class="hljs-comment">#查看快照</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2</span><br>Snapshot list:<br>ID        TAG                 VM SIZE                DATE       VM CLOCK<br>1         centos7-s1                0 2021-08-05 16:42:16   00:00:00.000<br><br><span class="hljs-comment">#查看快照信息</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info /var/lib/libvirt/images/centos7.qcow2</span><br>image: /var/lib/libvirt/images/centos7.qcow2<br>file format: qcow2<br>virtual size: 20G (21474836480 bytes)<br>disk size: 1.6G<br>cluster_size: 65536<br>Snapshot list:<br>ID        TAG                 VM SIZE                DATE       VM CLOCK<br>1         centos7-s1                0 2021-08-05 16:42:16   00:00:00.000<br>Format specific information:<br>     compat: 1.1<br>     lazy refcounts: <span class="hljs-literal">false</span><br>     refcount bits: 16<br>     corrupt: <span class="hljs-literal">false</span><br> <br><span class="hljs-comment">#删除文件,模拟破坏</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm169.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#关机后才能还原快照修复故障</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img snapshot -a centos7-s1 /var/lib/libvirt/images/centos7.qcow2</span><br></code></pre></td></tr></table></figure>

<p>查看文件恢复</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm170.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#关机后才能删除快照</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img snapshot -d centos7-s1 /var/lib/libvirt/images/centos7.qcow2</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2</span><br></code></pre></td></tr></table></figure>

<h3 id="6-5-3-virsh-管理虚拟机快照"><a href="#6-5-3-virsh-管理虚拟机快照" class="headerlink" title="6.5.3 virsh 管理虚拟机快照"></a>6.5.3 virsh 管理虚拟机快照</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh snapshot-list centos8</span><br>Name         Creation Time       State<br>------------------------------------------------------------<br><br><span class="hljs-comment">#创建虚拟机快照</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh snapshot-create centos8</span><br>Domain snapshot 1600593611 created<br>[root@centos8 ~]<span class="hljs-comment"># virsh snapshot-list centos8</span><br>Name         Creation Time       State<br>------------------------------------------------------------<br>1600593611      2020-09-20 17:20:11 +0800 shutoff<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm171.png" srcset="/blog/img/loading.gif"></p>
<p><strong>使用virsh 命令还原快照</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br><br><span class="hljs-comment">#先关机后再还原快照</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh snapshot-revert centos8 --snapshotname 1600593611 --running</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name              State<br>----------------------------------------------------<br>23  centos8            running<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm172.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#删除快照</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh snapshot-delete centos8 --snapshotname 1600593611</span><br>Domain snapshot 1600593611 deleted<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh snapshot-list centos8</span><br>Name         Creation Time       State<br>------------------------------------------------------------<br></code></pre></td></tr></table></figure>

<h3 id="6-5-4-virt-manager-管理快照"><a href="#6-5-4-virt-manager-管理快照" class="headerlink" title="6.5.4 virt-manager 管理快照"></a>6.5.4 virt-manager 管理快照</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm173.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm174.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm175.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm176.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm177.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm178.png" srcset="/blog/img/loading.gif" alt="强制关机"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm179.png" srcset="/blog/img/loading.gif" alt="再次打开"></p>
<p>还原快照</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm180.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm181.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm182.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#ll /var/lib/libvirt/qemu/snapshot/centos8/</span><br>total 8<br>-rw------- 1 root root 5802 Aug 11 13:28 snapshot1.xml<br></code></pre></td></tr></table></figure>

<h2 id="6-6-存储池管理"><a href="#6-6-存储池管理" class="headerlink" title="6.6 存储池管理"></a>6.6 存储池管理</h2><h3 id="6-6-1-存储池介绍"><a href="#6-6-1-存储池介绍" class="headerlink" title="6.6.1 存储池介绍"></a>6.6.1 存储池介绍</h3><h4 id="6-6-1-1-存储池基本概念"><a href="#6-6-1-1-存储池基本概念" class="headerlink" title="6.6.1.1 存储池基本概念"></a>6.6.1.1 存储池基本概念</h4><p>Libvirt可以以存储池的形式对存储进行统一管理、简化操作</p>
<p>对于虚拟机操作，存储池和卷并不是必需的,一个存储池中可以有多个存储卷</p>
<p>支持以下存储池</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">dir: Filesystem Directory<br>disk: Physical Disk Device<br>fs: Pre-Formatted Block Device<br>gluster: Gluster FileSystem<br>iscsi: iSCSI Target<br>logical: LVM Volume Group<br>mpath: Multipath Device Enumerator<br>netfs: Network Export Directory<br>rbd:RADOS Block Device/Ceph<br>scsi: SCSI Host Adapter<br>sheepdog: Sheepdog Filesystem <span class="hljs-comment">#分布式文件系统</span><br></code></pre></td></tr></table></figure>

<p><strong>virt-manager 可以创建和管理存储池</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm183.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm184.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-6-1-2-virsh中的存储池相关命令"><a href="#6-6-1-2-virsh中的存储池相关命令" class="headerlink" title="6.6.1.2 virsh中的存储池相关命令"></a>6.6.1.2 virsh中的存储池相关命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">find-storage-pool-sources-as <span class="hljs-comment">#通过参数查找存储池源find potential storage pool sources</span><br>find-storage-pool-sources <span class="hljs-comment">#通过XML文档查找存储池源找到潜在存储池源</span><br>pool-autostart <span class="hljs-comment">#自动启动某个池</span><br>pool-build <span class="hljs-comment">#建立池</span><br>pool-create-as <span class="hljs-comment">#在一组变量中定义池</span><br>pool-create <span class="hljs-comment">#从一个XML文件中创建一个池</span><br>pool-define-as <span class="hljs-comment">#从一组变量中创建一个池</span><br>pool-define <span class="hljs-comment">#在一个XML文件中定义（但不启动）一个池或修改已经有池</span><br>pool-delete <span class="hljs-comment">#删除池</span><br>pool-destroy <span class="hljs-comment">#销毁（停止）池</span><br>pool-dumpxml <span class="hljs-comment">#将池信息保存到XML文件中的</span><br>pool-edit <span class="hljs-comment">#为存储池编辑XML配置</span><br>pool-info <span class="hljs-comment">#存储池信息</span><br>pool-list <span class="hljs-comment">#列出池</span><br>pool-name <span class="hljs-comment">#把一个池名称转换为池UUID</span><br>pool-refresh <span class="hljs-comment">#刷新池</span><br>pool-start <span class="hljs-comment">#启动一个（以前定义的）非活跃的池</span><br>pool-undefine <span class="hljs-comment">#取消定义一个不活跃的池</span><br>pool-uuid <span class="hljs-comment">#将池UUID转换为池名称</span><br></code></pre></td></tr></table></figure>

<p>命令帮助</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh COMMAND --<span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --help</span><br>  NAME<br>    pool-list - list pools<br><br>  SYNOPSIS<br>    pool-list [--inactive] [--all] [--transient] [--persistent] [--autostart] [--no-autostart] [--<span class="hljs-built_in">type</span> &lt;string&gt;] [--details] [--uuid] [--name]<br><br>  DESCRIPTION<br>    Returns list of pools.<br><br>  OPTIONS<br>    --inactive       list inactive pools<br>    --all            list inactive &amp; active pools<br>    --transient      list transient pools<br>    --persistent     list persistent pools<br>    --autostart      list pools with autostart enabled<br>    --no-autostart   list pools with autostart disabled<br>    --<span class="hljs-built_in">type</span> &lt;string&gt;  only list pool of specified <span class="hljs-built_in">type</span>(s) (<span class="hljs-keyword">if</span> supported)<br>    --details        display extended details <span class="hljs-keyword">for</span> pools<br>    --uuid           list UUID of active pools only<br>    --name           list name of active pools only<br></code></pre></td></tr></table></figure>

<h3 id="6-6-2-显示存储池信息"><a href="#6-6-2-显示存储池信息" class="headerlink" title="6.6.2 显示存储池信息"></a>6.6.2 显示存储池信息</h3><p>存储池相关配置文件都在下面目录存放</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">/etc/libvirt/storage/<br></code></pre></td></tr></table></figure>

<p>范例: 显示存储池</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br> Name      State    Autostart<br>-------------------------------<br> default   active   yes<br> isos      active   yes<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --uuid</span><br>b164fec8-1861-4f07-86ae-5023ea17f925<br>a707038c-c21b-4570-bdef-d94c00554daa<br><br><span class="hljs-comment">#通过存储池的名称查找UUID</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-uuid default</span><br>b164fec8-1861-4f07-86ae-5023ea17f925<br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-uuid isos</span><br>a707038c-c21b-4570-bdef-d94c00554daa<br><br><span class="hljs-comment">#通过UUID查找存储池的名称</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-name b164fec8-1861-4f07-86ae-5023ea17f925</span><br>default<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-info default</span><br>Name:         default<br>UUID:         b164fec8-1861-4f07-86ae-5023ea17f925<br>State:        running<br>Persistent:   yes<br>Autostart:    yes<br>Capacity:     99.95 GiB<br>Allocation:   34.58 GiB<br>Available:    65.37 GiB<br><br><span class="hljs-comment">#每个存储池对应的配置文件</span><br>[root@centos8 ~]<span class="hljs-comment"># ll /etc/libvirt/storage/</span><br>total 8<br>drwxr-xr-x 2 root root  41 Sep 13 19:28 autostart<br>-rw------- 1 root root 538 Sep 13 19:05 default.xml<br>-rw------- 1 root root 519 Sep 13 19:28 isos.xml<br><br>[root@centos8 ~]<span class="hljs-comment"># ll /etc/libvirt/storage/autostart/</span><br>total 0<br>lrwxrwxrwx 1 root root 32 Sep 13 19:05 default.xml -&gt;<br>/etc/libvirt/storage/default.xml<br>lrwxrwxrwx 1 root root 29 Sep 13 19:28 isos.xml -&gt; /etc/libvirt/storage/isos.xml<br><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/libvirt/storage/default.xml</span><br>&lt;!--<br>WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br>OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br>  virsh pool-edit default<br>or other application using the libvirt API.<br>--&gt;<br><br>&lt;pool <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;dir&#x27;</span>&gt;<br> &lt;name&gt;default&lt;/name&gt;<br> &lt;uuid&gt;b164fec8-1861-4f07-86ae-5023ea17f925&lt;/uuid&gt;<br> &lt;capacity unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/capacity&gt;<br> &lt;allocation unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/allocation&gt;<br> &lt;available unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/available&gt;<br> &lt;<span class="hljs-built_in">source</span>&gt;<br> &lt;/<span class="hljs-built_in">source</span>&gt;<br> &lt;target&gt;<br>  &lt;path&gt;/var/lib/libvirt/images&lt;/path&gt;<br> &lt;/target&gt;<br>&lt;/pool&gt;<br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/libvirt/storage/isos.xml</span><br>&lt;!--<br>WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br>OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br>  virsh pool-edit isos<br>or other application using the libvirt API.<br>--&gt;<br><br>&lt;pool <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;dir&#x27;</span>&gt;<br> &lt;name&gt;isos&lt;/name&gt;<br> &lt;uuid&gt;a707038c-c21b-4570-bdef-d94c00554daa&lt;/uuid&gt;<br> &lt;capacity unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/capacity&gt;<br> &lt;allocation unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/allocation&gt;<br> &lt;available unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/available&gt;<br> &lt;<span class="hljs-built_in">source</span>&gt;<br> &lt;/<span class="hljs-built_in">source</span>&gt;<br> &lt;target&gt;<br>  &lt;path&gt;/data/isos&lt;/path&gt;<br> &lt;/target&gt;<br>&lt;/pool&gt;<br></code></pre></td></tr></table></figure>

<h3 id="6-6-3-基于目录的存储池"><a href="#6-6-3-基于目录的存储池" class="headerlink" title="6.6.3 基于目录的存储池"></a>6.6.3 基于目录的存储池</h3><h4 id="6-6-3-1-创建存储池"><a href="#6-6-3-1-创建存储池" class="headerlink" title="6.6.3.1 创建存储池"></a>6.6.3.1 创建存储池</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#目录需要事先创建,否则虽然可以创建存储池,但无法直接启动,后期也可以先创建存储池,再使用 pool-</span><br>build 自动创建目录<br>[root@centos8 ~]<span class="hljs-comment"># mkdir -p /data/vm_images</span><br><span class="hljs-comment">#基于安装考虚可以设置权限</span><br>[root@centos8 ~]<span class="hljs-comment"># chmod 700 /data/vm_images</span><br><br><span class="hljs-comment">#查看帮助</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-define-as --help</span><br><br><span class="hljs-comment">#创建存储池</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-define-as vm_images dir --target /data/vm_images</span><br>Pool vm_images defined<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br> Name      State    Autostart<br>-------------------------------<br> default   active   yes<br> isos      active   yes <br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --all</span><br> Name        State      Autostart<br>-----------------------------------<br> default     active     yes<br> isos        active     yes<br> vm_images   inactive   no<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-start vm_images #开启存储池</span><br>Pool vm_images started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list </span><br> Name        State    Autostart<br>---------------------------------<br> default     active   yes<br> isos        active   yes<br> vm_images   active   no<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-autostart vm_images #开启自动开启存储池</span><br>Pool vm_images marked as autostarted<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br> Name        State    Autostart<br>---------------------------------<br> default     active   yes<br> isos        active   yes<br> vm_images   active   yes <br><br>[root@centos8 ~]<span class="hljs-comment"># ll /etc/libvirt/storage/</span><br>total 12<br>drwxr-xr-x 2 root root  62 Sep 20 18:44 autostart<br>-rw------- 1 root root 538 Sep 13 19:05 default.xml<br>-rw------- 1 root root 519 Sep 13 19:28 isos.xml<br>-rw------- 1 root root 534 Sep 20 18:42 vm_images.xml<br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/libvirt/storage/vm_images.xml</span><br>&lt;!--<br>WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br>OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br>  virsh pool-edit vm_images<br>or other application using the libvirt API.<br>--&gt;<br><br>&lt;pool <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;dir&#x27;</span>&gt;<br>  &lt;name&gt;vm_images&lt;/name&gt;<br>  &lt;uuid&gt;cc851d99-1726-4cf9-8853-820441585bfa&lt;/uuid&gt;<br>  &lt;capacity unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/capacity&gt;<br>  &lt;allocation unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/allocation&gt;<br>  &lt;available unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/available&gt;<br>  &lt;<span class="hljs-built_in">source</span>&gt;<br>  &lt;/<span class="hljs-built_in">source</span>&gt;<br>  &lt;target&gt;<br>   &lt;path&gt;/data/vm_images&lt;/path&gt;<br>  &lt;/target&gt;<br>&lt;/pool&gt;<br></code></pre></td></tr></table></figure>

<p><strong>在virt-manager 工具可以管理和查看存储池</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm185.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-6-3-2-删除存储池"><a href="#6-6-3-2-删除存储池" class="headerlink" title="6.6.3.2 删除存储池"></a>6.6.3.2 删除存储池</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先停止存储池后才能删除</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-destroy --pool vm_images</span><br>Pool vm_images destroyed<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --all</span><br> Name        State      Autostart<br>-----------------------------------<br> default     active     yes<br> isos        active     yes<br> vm_images   inactive   yes<br><br><span class="hljs-comment">#删除存储池的相关数据目录</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-delete --pool vm_images</span><br>Pool vm_images deleted<br><br>[root@centos8 ~]<span class="hljs-comment"># ls /data</span><br>isos<br><br><span class="hljs-comment">#但存储池的配置还在</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --all</span><br> Name        State      Autostart<br>-----------------------------------<br> default     active     yes<br> isos        active     yes<br> vm_images   inactive   yes <br><br><span class="hljs-comment">#删除存储池配置文件</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-undefine --pool vm_images</span><br>Pool vm_images has been undefined<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --all</span><br> Name      State    Autostart<br>-------------------------------<br> default   active   yes<br> isos      active   yes<br><br>[root@centos8 ~]<span class="hljs-comment"># ll /etc/libvirt/storage/</span><br>total 8<br>drwxr-xr-x 2 root root  41 Sep 20 18:54 autostart<br>-rw------- 1 root root 538 Sep 13 19:05 default.xml<br>-rw------- 1 root root 519 Sep 13 19:28 isos.xml<br></code></pre></td></tr></table></figure>

<h3 id="6-6-4-基于文件系统的存储池"><a href="#6-6-4-基于文件系统的存储池" class="headerlink" title="6.6.4 基于文件系统的存储池"></a>6.6.4 基于文件系统的存储池</h3><h4 id="6-6-4-1-实现基于文件系统的存储池过程"><a href="#6-6-4-1-实现基于文件系统的存储池过程" class="headerlink" title="6.6.4.1 实现基于文件系统的存储池过程"></a>6.6.4.1 实现基于文件系统的存储池过程</h4><ul>
<li>准备分区并创建文件系统<br>fdisk /dev/sda<br>mkfs.ext4 /dev/sda6</li>
<li>准备存储池的挂载点目录<br>mkdir /vm_images</li>
<li>创建分区的存储池</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh pool-define-as vm_images_fs fs --source-dev <span class="hljs-string">&quot;/dev/sda6&quot;</span> --target <span class="hljs-string">&quot;/vm_images&quot;</span><br><br><span class="hljs-comment">#Source Path:块设备名</span><br><span class="hljs-comment">#Target Path : mount到的目录名</span><br><span class="hljs-comment">#libvirtd 会自动 mount 分区</span><br></code></pre></td></tr></table></figure>

<h4 id="6-6-4-2-管理基于分区的存储池"><a href="#6-6-4-2-管理基于分区的存储池" class="headerlink" title="6.6.4.2 管理基于分区的存储池"></a>6.6.4.2 管理基于分区的存储池</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># lsblk</span><br>NAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT<br>sda     8:0   0  200G  0 disk<br>├─sda1  8:1   0    1G  0 part /boot<br>├─sda2  8:2   0  100G  0 part /<br>├─sda3  8:3   0   50G  0 part /data<br>├─sda4  8:4   0    1K  0 part<br>└─sda5  8:5   0    2G  0 part [SWAP]<br>sr0    11:0   1  7.7G  0 rom <br>[root@centos8 ~]<span class="hljs-comment"># fdisk /dev/sda</span><br><br>Welcome to fdisk (util-linux 2.32.1).<br>Changes will remain <span class="hljs-keyword">in</span> memory only, until you decide to write them.<br>Be careful before using the write <span class="hljs-built_in">command</span>.<br><br>Command (m <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>): n<br>All primary partitions are <span class="hljs-keyword">in</span> use.<br>Adding logical partition 6<br>First sector (320870400-419430399, default 320870400):<br>Last sector, +sectors or +size&#123;K,M,G,T,P&#125; (320870400-419430399, default 419430399): +10G<br><br>Created a new partition 6 of <span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;Linux&#x27;</span> and of size 10 GiB.<br><br>Command (m <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>): w<br>The partition table has been altered.<br>Syncing disks.<br><br>[root@centos8 ~]<span class="hljs-comment"># mkfs.ext4 /dev/sda6</span><br>mke2fs 1.45.4 (23-Sep-2019)<br>Creating filesystem with 2621440 4k blocks and 655360 inodes<br>Filesystem UUID: 523c18c7-7f0f-4fe2-b21e-ab5cbc29d5c7<br>Superblock backups stored on blocks:<br>32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632<br><br>Allocating group tables: <span class="hljs-keyword">done</span>              <br>Writing inode tables: <span class="hljs-keyword">done</span>              <br>Creating journal (16384 blocks): <span class="hljs-keyword">done</span><br>Writing superblocks and filesystem accounting information: <span class="hljs-keyword">done</span><br><br>[root@centos8 ~]<span class="hljs-comment"># lsblk</span><br>NAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT<br>sda     8:0    0 200G  0 disk<br>├─sda1  8:1    0   1G  0 part /boot<br>├─sda2  8:2    0 100G  0 part /<br>├─sda3  8:3    0  50G  0 part /data<br>├─sda4  8:4    0   1K  0 part<br>├─sda5  8:5    0   2G  0 part [SWAP]<br>└─sda6  8:6    0  10G  0 part<br>sr0    11:0    1 7.7G  0 rom <br><br><span class="hljs-comment">#创建存储池定义</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-define-as vm_images_fs fs --source-dev &quot;/dev/sda6&quot; --target &quot;/vm_images&quot;</span><br>Pool vm_images_fs defined<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --all</span><br> Name      State    Autostart<br>-------------------------------<br> default   active   yes<br> isos      active   yes<br> vm_images_fs inactive  no    <br><br>[root@centos8 ~]<span class="hljs-comment"># df</span><br>Filesystem   1K-blocks     Used Available Use% Mounted on<br>devtmpfs       4050832        0   4050832   0% /dev<br>tmpfs          4067612        0   4067612   0% /dev/shm<br>tmpfs          4067612     9380   4058232   1% /run<br>tmpfs          4067612        0   4067612   0% /sys/fs/cgroup<br>/dev/sda2    104806400 36337664  68468736  35% /<br>/dev/sda3     52403200 12331584  40071616  24% /data<br>/dev/sda1       999320   120528    809980  13% /boot<br>tmpfs           813520        8    813512   1% /run/user/0<br><br><span class="hljs-comment">#因为没有挂载点无法启动</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-start vm_images_fs</span><br>error: Failed to start pool vm_images_fs<br>error: internal error: Child process (/usr/bin/mount -t auto /dev/sda6<br>/vm_images) unexpected <span class="hljs-built_in">exit</span> status 32: mount: /vm_images: mount point does not<br>exist.<br><br><span class="hljs-comment">#构建存储池会自动创建挂截点</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-build vm_images_fs</span><br>Pool vm_images_fs built<br><br>[root@centos8 ~]<span class="hljs-comment"># ll -d /vm_images/</span><br>drwx--x--x 2 root root 6 Sep 20 19:18 /vm_images/<br><br><span class="hljs-comment">#启动存储池,自动挂载</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-start vm_images_fs</span><br>Pool vm_images_fs started<br><br>[root@centos8 ~]<span class="hljs-comment"># df</span><br>Filesystem   1K-blocks     Used Available Use% Mounted on<br>devtmpfs       4050832        0   4050832   0% /dev<br>tmpfs          4067612        0   4067612   0% /dev/shm<br>tmpfs          4067612     9384   4058228   1% /run<br>tmpfs          4067612        0   4067612   0% /sys/fs/cgroup<br>/dev/sda2    104806400 36337648  68468752  35% /<br>/dev/sda3     52403200 12331584  40071616  24% /data<br>/dev/sda1       999320   120528    809980  13% /boot<br>tmpfs           813520        8    813512   1% /run/user/0<br>/dev/sda6     10255636    36888   9678076   1% /vm_images<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-info vm_images_fs</span><br>Name:         vm_images_fs<br>UUID:         157759a3-46ce-49ed-ba9d-eaf71c6dde30<br>State:        running<br>Persistent:   yes<br>Autostart:    no<br>Capacity:     9.78 GiB<br>Allocation:   36.02 MiB<br>Available:    9.75 GiB<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --all</span><br> Name      State    Autostart<br>-------------------------------<br> default   active   yes<br> isos      active   yes  <br> vm_images_fs  active   no <br><br><span class="hljs-comment">#由于没有设为自动启动,重启后不会挂载</span><br>[root@centos8 ~]<span class="hljs-comment"># reboot</span><br>[root@centos8 ~]<span class="hljs-comment"># df</span><br>Filesystem   1K-blocks     Used Available Use% Mounted on<br>devtmpfs       4050832        0   4050832   0% /dev<br>tmpfs          4067612        0   4067612   0% /dev/shm<br>tmpfs          4067612     9372   4058240   1% /run<br>tmpfs          4067612        0   4067612   0% /sys/fs/cgroup<br>/dev/sda2    104806400 36339572  68466828  35% /<br>/dev/sda3     52403200 12331584  40071616  24% /data<br>/dev/sda1       999320   120528    809980  13% /boot<br>tmpfs           813520        0    813520   0% /run/user/0<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --all</span><br> Name      State    Autostart<br>-------------------------------<br> default   active   yes<br> isos      active   yes  <br> vm_images_fs  inactive  no    <br><br><span class="hljs-comment">#设为自动启动</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-autostart vm_images_fs</span><br>Pool vm_images_fs marked as autostarted<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --all</span><br> Name      State    Autostart<br>-------------------------------<br> default   active   yes<br> isos      active   yes   <br> vm_images_fs  inactive  yes <br><br><span class="hljs-comment">#重新启动自动启动存储池并挂载</span><br>[root@centos8 ~]<span class="hljs-comment"># reboot</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br> Name      State    Autostart<br>-------------------------------<br> default   active   yes<br> isos      active   yes <br> vm_images_fs     active   yes  <br><br>[root@centos8 ~]<span class="hljs-comment">#df</span><br>Filesystem   1K-blocks     Used Available Use% Mounted on<br>devtmpfs       4050824        0   4050824   0% /dev<br>tmpfs          4067604        0   4067604   0% /dev/shm<br>tmpfs          4067604     9364   4058240   1% /run<br>tmpfs          4067604        0   4067604   0% /sys/fs/cgroup<br>/dev/sda2    104806400 36340572  68465828  35% /<br>/dev/sda3     52403200 12331584  40071616  24% /data<br>/dev/sda1       999320   120528    809980  13% /boot<br>/dev/sda6     10255636    36888   9678076   1% /vm_images<br>tmpfs           813520        0    813520   0% /run/user/0<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm185.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm186.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-6-4-3-删除基于分区的存储池"><a href="#6-6-4-3-删除基于分区的存储池" class="headerlink" title="6.6.4.3 删除基于分区的存储池"></a>6.6.4.3 删除基于分区的存储池</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh pool-destroy vm_images_fs</span><br>Pool vm_images_fs destroyed<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-delete vm_images_fs</span><br>Pool vm_images_fs deleted<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-undefine vm_images_fs</span><br>Pool vm_images_fs has been undefined<br><br>[root@centos8 ~]<span class="hljs-comment"># df</span><br>Filesystem   1K-blocks     Used Available Use% Mounted on<br>devtmpfs       4050824        0   4050824   0% /dev<br>tmpfs          4067604        0   4067604   0% /dev/shm<br>tmpfs          4067604     9360   4058244   1% /run<br>tmpfs          4067604        0   4067604   0% /sys/fs/cgroup<br>/dev/sda2    104806400 36340696  68465704  35% /<br>/dev/sda3     52403200 12331584  40071616  24% /data<br>/dev/sda1       999320   120528    809980  13% /boot<br>tmpfs           813520        0    813520   0% /run/user/0<br><br>[root@centos8 ~]<span class="hljs-comment"># ll /vm_images/</span><br>total 0<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --all</span><br>Name         State   Autostart<br>-------------------------------------------<br>default      active   yes   <br>isos         active   yes<br><br>[root@centos8 ~]<span class="hljs-comment"># ll /etc/libvirt/storage/</span><br>total 8<br>drwxr-xr-x 2 root root  41 Sep 20 19:30 autostart<br>-rw------- 1 root root 538 Sep 13 19:05 default.xml<br>-rw------- 1 root root 519 Sep 13 19:28 isos.xml<br></code></pre></td></tr></table></figure>

<h3 id="6-6-5-基于磁盘的存储池"><a href="#6-6-5-基于磁盘的存储池" class="headerlink" title="6.6.5 基于磁盘的存储池"></a>6.6.5 基于磁盘的存储池</h3><p>创建前需要添加新的磁盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@centos8 ~]<span class="hljs-comment"># lsblk</span><br>NAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT<br>sda     8:0    0 200G  0 disk<br>├─sda1  8:1    0   1G  0 part /boot<br>├─sda2  8:2    0 100G  0 part /<br>├─sda3  8:3    0  50G  0 part /data<br>├─sda4  8:4    0   1K  0 part<br>├─sda5  8:5    0   2G  0 part [SWAP]<br>└─sda6  8:6    0  10G  0 part<br>sdb     8:16   0  20G  0 disk<br>sr0    11:0    1 7.7G  0 rom<br><br>[root@centos8 ~]<span class="hljs-comment"># parted /dev/sdb mklabel gpt</span><br>Information: You may need to update /etc/fstab.<br><br>[root@centos8 ~]<span class="hljs-comment"># parted /dev/sdb print</span><br>Model: VMware, VMware Virtual S (scsi)<br>Disk /dev/sdb: 21.5GB<br>Sector size (logical/physical): 512B/512B<br>Partition Table: gpt<br>Disk Flags:<br><br>Number Start End Size File system Name Flags<br><br><span class="hljs-comment">#准备磁盘存储池对应的xml文件</span><br>[root@centos8 ~]<span class="hljs-comment"># vim vm_images_disk.xml</span><br>[root@centos8 ~]<span class="hljs-comment"># cat vm_images_disk.xml</span><br>&lt;pool <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;disk&#x27;</span>&gt;<br>&lt;name&gt;vm_images_disk&lt;/name&gt;<br>&lt;<span class="hljs-built_in">source</span>&gt;<br> &lt;device path=<span class="hljs-string">&#x27;/dev/sdb&#x27;</span>/&gt;<br> &lt;format <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;gpt&#x27;</span>/&gt;<br>&lt;/<span class="hljs-built_in">source</span>&gt;<br>&lt;target&gt;<br> &lt;path&gt;/dev&lt;/path&gt;<br>&lt;/target&gt;<br>&lt;/pool&gt;<br><br><span class="hljs-comment">#基于XML创建存储池</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-define vm_images_disk.xml</span><br>Pool vm_images_disk defined from vm_images_disk.xml<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-start vm_images_disk</span><br>Pool vm_images_disk started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br> Name             State    Autostart<br>--------------------------------------<br> default          active   yes<br> isos             active   yes<br> vm_images_disk   active   no<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm187.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#停止存储池</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-destroy vm_images_disk</span><br>Pool vm_images_disk destroyed<br><br><span class="hljs-comment">#再删除,注意基于磁盘的存储池不支持pool-delete</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-undefine vm_images_disk</span><br>Pool vm_images_disk has been undefined<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br> Name      State    Autostart<br>-------------------------------<br> default   active   yes<br> isos      active   yes <br></code></pre></td></tr></table></figure>

<h3 id="6-6-6-基于LVM的存储池"><a href="#6-6-6-基于LVM的存储池" class="headerlink" title="6.6.6 基于LVM的存储池"></a>6.6.6 基于LVM的存储池</h3><p>基于LVM的存储池要求使用VG中的全部磁盘空间</p>
<p>创建存储池，有两种方法</p>
<ul>
<li>创建新的 VG 创建存储池</li>
<li>使用现有的 VG 创建存储池</li>
</ul>
<h4 id="6-6-6-1-无存在的卷组直接创建存储池"><a href="#6-6-6-1-无存在的卷组直接创建存储池" class="headerlink" title="6.6.6.1 无存在的卷组直接创建存储池"></a>6.6.6.1 无存在的卷组直接创建存储池</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#source-dev 指定硬盘设备,事先无卷组时此项才需要指定</span><br><span class="hljs-comment">#source-name 指定已有卷组名,此项利用已有卷组创建存储池才需指定,事先无卷组无需指定</span><br><br>[root@centos8 ~]<span class="hljs-comment"># pvs</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-define-as vm_images_lvm logical --source-dev=/dev/sdb </span><br>Pool vm_images_lvm defined<br><br><span class="hljs-comment">#无卷组无法启存储池</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-start vm_images_lvm</span><br>error: Failed to start pool vm_images_lvm<br>error: unsupported configuration: cannot find logical volume group name<br><span class="hljs-string">&#x27;vm_images_lvm&#x27;</span><br><br><span class="hljs-comment">#构建存储池同时创建卷组</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-build vm_images_lvm</span><br>Pool vm_images_lvm built<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-start vm_images_lvm</span><br>Pool vm_images_lvm started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br> Name            State    Autostart<br>-------------------------------------<br> default         active   yes<br> isos            active   yes<br> vm_images_lvm   active   no   <br><br>[root@centos8 ~]<span class="hljs-comment"># pvs</span><br>  PV         VG            Fmt  Attr PSize   PFree  <br>  /dev/sdb   vm_images_lvm lvm2 a--  &lt;20.00g &lt;20.00g<br>[root@centos8 ~]<span class="hljs-comment"># vgs</span><br>  VG            <span class="hljs-comment">#PV #LV #SN Attr   VSize   VFree  </span><br>  vm_images_lvm   1   0   0 wz--n- &lt;20.00g &lt;20.00g<br></code></pre></td></tr></table></figure>

<h4 id="6-6-6-2-利用已有的卷组创建存储池"><a href="#6-6-6-2-利用已有的卷组创建存储池" class="headerlink" title="6.6.6.2 利用已有的卷组创建存储池"></a>6.6.6.2 利用已有的卷组创建存储池</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># pvs</span><br>  PV         VG            Fmt  Attr PSize   PFree  <br>  /dev/sdb   vm_images_lvm lvm2 a--  &lt;20.00g &lt;20.00g<br>[root@centos8 ~]<span class="hljs-comment"># vgs</span><br>  VG            <span class="hljs-comment">#PV #LV #SN Attr   VSize   VFree  </span><br>  vm_images_lvm   1   0   0 wz--n- &lt;20.00g &lt;20.00g<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-define-as vm_images_lvm logical --source-name=vm_images_lvm</span><br>Pool vm_images_lvm defined<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-start vm_images_lvm</span><br>Pool vm_images_lvm started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br> Name            State    Autostart<br>-------------------------------------<br> default         active   yes<br> isos            active   yes<br> vm_images_lvm   active   no<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm188.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm190.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-6-6-3-virt-manager-利用已有的卷组创建存储池"><a href="#6-6-6-3-virt-manager-利用已有的卷组创建存储池" class="headerlink" title="6.6.6.3 virt-manager 利用已有的卷组创建存储池"></a>6.6.6.3 virt-manager 利用已有的卷组创建存储池</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm191.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm192.png" srcset="/blog/img/loading.gif"></p>
<h3 id="6-6-7-基于NFS的存储池"><a href="#6-6-7-基于NFS的存储池" class="headerlink" title="6.6.7 基于NFS的存储池"></a>6.6.7 基于NFS的存储池</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm193.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-6-7-1-创建NFS共享"><a href="#6-6-7-1-创建NFS共享" class="headerlink" title="6.6.7.1 创建NFS共享"></a>6.6.7.1 创建NFS共享</h4><p>先在另一台主机10.0.0.18 创建NFS服务及共享NFS目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install nfs-utils</span><br><br>[root@centos8 ~]<span class="hljs-comment"># mkdir -p /data/kvmdata</span><br>[root@centos8 ~]<span class="hljs-comment"># echo &#x27;/data/kvmdata *(rw,no_root_squash)&#x27; &gt; /etc/exports</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/exports</span><br>/data/kvmdata *(rw,no_root_squash)<br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable --now nfs-server.service</span><br>[root@centos8 ~]<span class="hljs-comment"># exportfs -v</span><br>/data/kvmdata 	&lt;world&gt;(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)<br></code></pre></td></tr></table></figure>

<h4 id="6-6-7-2-创建基于NFS服务的存储池"><a href="#6-6-7-2-创建基于NFS服务的存储池" class="headerlink" title="6.6.7.2 创建基于NFS服务的存储池"></a>6.6.7.2 创建基于NFS服务的存储池</h4><p>在宿主机创建存储池</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh pool-define-as vm_images_nfs netfs --source-host 10.0.0.18 --source-path /data/kvmdata --target /data/vm_images_nfs</span><br>Pool vm_images_nfs defined<br><br><span class="hljs-comment">#pool-build自动生成挂载点</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-build vm_images_nfs</span><br>Pool vm_images_nfs built<br><br><span class="hljs-comment">#或者手动创建挂载点</span><br>[root@centos8 ~]<span class="hljs-comment"># mkdir -p /data/vm_images_nfs</span><br><br><span class="hljs-comment">#开启存储池</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-start vm_images_nfs</span><br>Pool vm_images_nfs started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br> Name            State    Autostart<br>-------------------------------------<br> default         active   yes<br> isos            active   yes<br> vm_images_nfs   active   no<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-info vm_images_nfs</span><br>Name:           vm_images_nfs<br>UUID:           08e458ab-bdc1-48e6-a202-d2b32e380856<br>State:          running<br>Persistent:     yes<br>Autostart:      no<br>Capacity:       98.26 GiB<br>Allocation:     16.40 GiB<br>Available:      81.85 GiB<br><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/libvirt/storage/vm_images_nfs.xml</span><br>&lt;!--<br>WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br>OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br>  virsh pool-edit vm_images_nfs<br>or other application using the libvirt API.<br>--&gt;<br><br>&lt;pool <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;netfs&#x27;</span>&gt;<br>  &lt;name&gt;vm_images_nfs&lt;/name&gt;<br>  &lt;uuid&gt;08e458ab-bdc1-48e6-a202-d2b32e380856&lt;/uuid&gt;<br>  &lt;capacity unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/capacity&gt;<br>  &lt;allocation unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/allocation&gt;<br>  &lt;available unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;0&lt;/available&gt;<br>  &lt;<span class="hljs-built_in">source</span>&gt;<br>    &lt;host name=<span class="hljs-string">&#x27;10.0.0.18&#x27;</span>/&gt;<br>    &lt;dir path=<span class="hljs-string">&#x27;/data/kvmdata&#x27;</span>/&gt;<br>    &lt;format <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;auto&#x27;</span>/&gt;<br>  &lt;/<span class="hljs-built_in">source</span>&gt;<br>  &lt;target&gt;<br>    &lt;path&gt;/data/vm_images_nfs&lt;/path&gt;<br>  &lt;/target&gt;<br>&lt;/pool&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># df</span><br>Filesystem              1K-blocks     Used Available Use% Mounted on<br>devtmpfs                  4050832        0   4050832   0% /dev<br>tmpfs                     4067612        0   4067612   0% /dev/shm<br>tmpfs                     4067612     9396   4058216   1% /run<br>tmpfs                     4067612        0   4067612   0% /sys/fs/cgroup<br>/dev/sda2               104806400 36338748  68467652  35% /<br>/dev/sda3                52403200 12331584  40071616  24% /data<br>/dev/sda1                  999320   120528    809980  13% /boot<br>tmpfs                      813520        8    813512   1% /run/user/0<br>10.0.0.18:/data/kvmdata  52403200   398336  52004864   1% /data/vm_images_nfs<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm194.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-6-7-3-删除存储池"><a href="#6-6-7-3-删除存储池" class="headerlink" title="6.6.7.3 删除存储池"></a>6.6.7.3 删除存储池</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh pool-destroy vm_images_nfs</span><br>Pool vm_images_nfs destroyed<br><br>[root@centos8 ~]<span class="hljs-comment"># df</span><br>Filesystem   1K-blocks     Used Available Use% Mounted on<br>devtmpfs       4050832        0   4050832   0% /dev<br>tmpfs          4067612        0   4067612   0% /dev/shm<br>tmpfs          4067612     9388   4058224   1% /run<br>tmpfs          4067612        0   4067612   0% /sys/fs/cgroup<br>/dev/sda2    104806400 36339252  68467148  35% /<br>/dev/sda3     52403200 12331584  40071616  24% /data<br>/dev/sda1       999320   120528    809980  13% /boot<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-undefine vm_images_nfs</span><br>Pool vm_images_nfs has been undefined<br><br>[root@centos8 ~]<span class="hljs-comment"># ls /data/</span><br>isos/     vm_images_nfs/<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list --all</span><br> Name      State    Autostart<br>-------------------------------<br> default   active   yes<br> isos      active   yes<br></code></pre></td></tr></table></figure>

<h2 id="6-7-存储卷管理"><a href="#6-7-存储卷管理" class="headerlink" title="6.7 存储卷管理"></a>6.7 存储卷管理</h2><h3 id="6-7-1-存储卷概述"><a href="#6-7-1-存储卷概述" class="headerlink" title="6.7.1 存储卷概述"></a>6.7.1 存储卷概述</h3><h4 id="6-7-1-1-存储卷介绍"><a href="#6-7-1-1-存储卷介绍" class="headerlink" title="6.7.1.1 存储卷介绍"></a>6.7.1.1 存储卷介绍</h4><p>一个存储池被分割为多个存储卷（Storage Volume)</p>
<p>存储卷可以为以下多种形式</p>
<ul>
<li>文件</li>
<li>块设备（如物理分区、LVM逻辑卷等）</li>
<li>libvirt管理的其他类型存储的抽象</li>
</ul>
<h4 id="6-7-1-2-存储卷管理相关命令"><a href="#6-7-1-2-存储卷管理相关命令" class="headerlink" title="6.7.1.2 存储卷管理相关命令"></a>6.7.1.2 存储卷管理相关命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">vol-clone <span class="hljs-comment">#克隆卷</span><br>vol-create-as <span class="hljs-comment">#通过一组参数创建卷</span><br>vol-create <span class="hljs-comment">#通过XML文件创建卷</span><br>vol-create-from <span class="hljs-comment">#通过输入的其他卷创建—个新的卷</span><br>vol-delete <span class="hljs-comment">#删除一个卷</span><br>vol-download <span class="hljs-comment">#下载卷的内容到一个文件</span><br>vol-dumpxml <span class="hljs-comment">#保存卷信息的信息到xML文件中</span><br>vol-info <span class="hljs-comment">#存储卷的信息</span><br>vol-key <span class="hljs-comment">#根据卷名或路径返回卷的key</span><br>vol-list <span class="hljs-comment">#列出卷</span><br>vol-name <span class="hljs-comment">#根据卷的key或路径返回卷名</span><br>vol-path <span class="hljs-comment">#根据卷名或key返回卷的路径</span><br>vol-pool <span class="hljs-comment">#根据卷的key或路径返回存储池</span><br>vol-resize <span class="hljs-comment">#调整卷大小</span><br>vol-upload <span class="hljs-comment">#上传文件内容到一个卷</span><br>vol-wipe <span class="hljs-comment">#wipe ─个卷</span><br></code></pre></td></tr></table></figure>

<p>范例: 查看帮助</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh help volume</span><br> Storage Volume (<span class="hljs-built_in">help</span> keyword <span class="hljs-string">&#x27;volume&#x27;</span>):<br>    vol-clone                      <span class="hljs-built_in">clone</span> a volume.<br>    vol-create-as                  create a volume from a <span class="hljs-built_in">set</span> of args<br>    vol-create                     create a vol from an XML file<br>    vol-create-from                create a vol, using another volume as input<br>    vol-delete                     delete a vol<br>    vol-download                   download volume contents to a file<br>    vol-dumpxml                    vol information <span class="hljs-keyword">in</span> XML<br>    vol-info                       storage vol information<br>    vol-key                        returns the volume key <span class="hljs-keyword">for</span> a given volume name or path<br>    vol-list                       list vols<br>    vol-name                       returns the volume name <span class="hljs-keyword">for</span> a given volume key or path<br>    vol-path                       returns the volume path <span class="hljs-keyword">for</span> a given volume name or key<br>    vol-pool                       returns the storage pool <span class="hljs-keyword">for</span> a given volume key or path<br>    vol-resize                     resize a vol<br>    vol-upload                     upload file contents to a volume<br>    vol-wipe                       wipe a vol<br> <br>[root@centos8 ~]<span class="hljs-comment"># virsh vol-create-as --help</span><br>  NAME<br>    vol-create-as - create a volume from a <span class="hljs-built_in">set</span> of args<br><br>  SYNOPSIS<br>    vol-create-as &lt;pool&gt; &lt;name&gt; &lt;capacity&gt; [--allocation &lt;string&gt;] [--format &lt;string&gt;] [--backing-vol &lt;string&gt;] [--backing-vol-format &lt;string&gt;] [--prealloc-metadata] [--print-xml]<br><br>  DESCRIPTION<br>    Create a vol.<br><br>  OPTIONS<br>    [--pool] &lt;string&gt;  pool name<br>    [--name] &lt;string&gt;  name of the volume<br>    [--capacity] &lt;string&gt;  size of the vol, as scaled <span class="hljs-built_in">integer</span> (default bytes)<br>    --allocation &lt;string&gt;  initial allocation size, as scaled <span class="hljs-built_in">integer</span> (default bytes)<br>    --format &lt;string&gt;  file format <span class="hljs-built_in">type</span> raw,bochs,qcow,qcow2,qed,vmdk<br>    --backing-vol &lt;string&gt;  the backing volume <span class="hljs-keyword">if</span> taking a snapshot<br>    --backing-vol-format &lt;string&gt;  format of backing volume <span class="hljs-keyword">if</span> taking a snapshot<br>    --prealloc-metadata  preallocate metadata (<span class="hljs-keyword">for</span> qcow2 instead of full allocation)<br>    --print-xml      <span class="hljs-built_in">print</span> XML document, but don<span class="hljs-string">&#x27;t define/create</span><br></code></pre></td></tr></table></figure>

<h3 id="6-7-2-基于目录的存储池的存储卷管理"><a href="#6-7-2-基于目录的存储池的存储卷管理" class="headerlink" title="6.7.2 基于目录的存储池的存储卷管理"></a>6.7.2 基于目录的存储池的存储卷管理</h3><h4 id="6-7-2-1-创建基于目录的存储池"><a href="#6-7-2-1-创建基于目录的存储池" class="headerlink" title="6.7.2.1 创建基于目录的存储池"></a>6.7.2.1 创建基于目录的存储池</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># mkdir /data/vm_images_dir</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-define-as vm_images_dir dir --target /data/vm_images_dir</span><br>Pool vm_images_dir defined<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-start vm_images_dir</span><br>Pool vm_images_dir started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br> Name            State    Autostart<br>-------------------------------------<br> default         active   yes<br> isos            active   yes<br> vm_images_dir   active   no<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-dumpxml vm_images_dir</span><br>&lt;pool <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;dir&#x27;</span>&gt;<br>  &lt;name&gt;vm_images_dir&lt;/name&gt;<br>  &lt;uuid&gt;82fb9c9c-744f-4f9d-81e7-d30125b1aa08&lt;/uuid&gt;<br>  &lt;capacity unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;104964661248&lt;/capacity&gt;<br>  &lt;allocation unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;36729888768&lt;/allocation&gt;<br>  &lt;available unit=<span class="hljs-string">&#x27;bytes&#x27;</span>&gt;68234772480&lt;/available&gt;<br>  &lt;<span class="hljs-built_in">source</span>&gt;<br>  &lt;/<span class="hljs-built_in">source</span>&gt;<br>  &lt;target&gt;<br>    &lt;path&gt;/data/vm_images_dir&lt;/path&gt;<br>    &lt;permissions&gt;<br>      &lt;mode&gt;0755&lt;/mode&gt;<br>      &lt;owner&gt;0&lt;/owner&gt;<br>      &lt;group&gt;0&lt;/group&gt;<br>    &lt;/permissions&gt;<br>  &lt;/target&gt;<br>&lt;/pool&gt;<br></code></pre></td></tr></table></figure>

<h4 id="6-7-2-2-创建基于目录的存储池的存储卷"><a href="#6-7-2-2-创建基于目录的存储池的存储卷" class="headerlink" title="6.7.2.2 创建基于目录的存储池的存储卷"></a>6.7.2.2 创建基于目录的存储池的存储卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh vol-create-as vm_images_dir test1.qcow2 1g --format qcow2</span><br>Vol test1.qcow2 created<br><br>[root@centos8 ~]<span class="hljs-comment"># ls /data/vm_images_dir/ -lh</span><br>total 196K<br>-rw------- 1 root root 193K Sep 20 21:47 test1.qcow2<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh vol-list vm_images_dir</span><br> Name          Path<br>------------------------------------------------<br> test1.qcow2   /data/vm_images_dir/test1.qcow2<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh vol-info test1.qcow2 --pool vm_images_dir</span><br>Name:           test1.qcow2<br>Type:           file<br>Capacity:       1.00 GiB<br>Allocation:     196.00 KiB<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh vol-info /data/vm_images_dir/test1.qcow2</span><br>Name:           test1.qcow2<br>Type:           file<br>Capacity:       1.00 GiB<br>Allocation:     196.00 KiB<br><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img info /data/vm_images_dir/test1.qcow2</span><br>image: /data/vm_images_dir/test1.qcow2<br>file format: qcow2<br>virtual size: 1 GiB (1073741824 bytes)<br>disk size: 196 KiB<br>cluster_size: 65536<br>Format specific information:<br>    compat: 0.10<br>    refcount bits: 16<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm195.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-7-2-3-删除基于目录的存储池的存储卷"><a href="#6-7-2-3-删除基于目录的存储池的存储卷" class="headerlink" title="6.7.2.3 删除基于目录的存储池的存储卷"></a>6.7.2.3 删除基于目录的存储池的存储卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh vol-delete test1.qcow2 vm_images_dir</span><br>Vol test1.qcow2 deleted<br><br>[root@centos8 ~]<span class="hljs-comment"># ls /data/</span><br>isos/     vm_images_dir/ vm_images_nfs/<br>[root@centos8 ~]<span class="hljs-comment"># ls /data/vm_images_dir/</span><br><span class="hljs-comment">#删除物理卷</span><br>[root@centos8 ~]<span class="hljs-comment"># vgremove vm_images_lvm</span><br>[root@centos8 ~]<span class="hljs-comment"># pvremove /dev/sdb</span><br>  Labels on physical volume <span class="hljs-string">&quot;/dev/sdb&quot;</span> successfully wiped.<br></code></pre></td></tr></table></figure>

<h3 id="6-7-3-基于LVM的存储池的存储卷管理"><a href="#6-7-3-基于LVM的存储池的存储卷管理" class="headerlink" title="6.7.3 基于LVM的存储池的存储卷管理"></a>6.7.3 基于LVM的存储池的存储卷管理</h3><h4 id="6-7-3-1-创建基于LVM的存储池"><a href="#6-7-3-1-创建基于LVM的存储池" class="headerlink" title="6.7.3.1 创建基于LVM的存储池"></a>6.7.3.1 创建基于LVM的存储池</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># pvs</span><br><br><span class="hljs-comment">#添加新硬盘</span><br>[root@centos8 ~]<span class="hljs-comment"># lsblk</span><br>NAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT<br>sda     8:0    0 200G  0 disk<br>├─sda1  8:1    0   1G  0 part /boot<br>├─sda2  8:2    0 100G  0 part /<br>├─sda3  8:3    0  50G  0 part /data<br>├─sda4  8:4    0   1K  0 part<br>├─sda5  8:5    0   2G  0 part [SWAP]<br>└─sda6  8:6    0  10G  0 part<br>sdb     8:16   0  20G  0 disk<br>sr0    11:0    1 7.7G  0 rom <br><br><span class="hljs-comment">#指定新硬盘直接创建基于LVM的存储池</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-define-as vm_images_lvm logical --source-dev=/dev/sdb</span><br>Pool vm_images_lvm defined<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-build vm_images_lvm</span><br>Pool vm_images_lvm built<br><br>[root@centos8 ~]<span class="hljs-comment"># pvs</span><br>  PV         VG            Fmt  Attr PSize   PFree  <br>  /dev/sdb   vm_images_lvm lvm2 a--  &lt;20.00g &lt;20.00g<br>[root@centos8 ~]<span class="hljs-comment"># vgs</span><br>  VG            <span class="hljs-comment">#PV #LV #SN Attr   VSize   VFree  </span><br>  vm_images_lvm   1   0   0 wz--n- &lt;20.00g &lt;20.00g<br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-start vm_images_lvm</span><br>Pool vm_images_lvm started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh pool-list</span><br>Name             State    Autostart<br>-------------------------------------------<br>default          active   yes   <br>isos             active   yes   <br>vm_images_dir    active   no    <br>vm_images_lvm    active   no <br><br><span class="hljs-comment">#没有逻辑卷</span><br>[root@centos8 ~]<span class="hljs-comment"># lvs</span><br></code></pre></td></tr></table></figure>

<h4 id="6-7-3-2-创建基于LVM的存储池的存储卷"><a href="#6-7-3-2-创建基于LVM的存储池的存储卷" class="headerlink" title="6.7.3.2 创建基于LVM的存储池的存储卷"></a>6.7.3.2 创建基于LVM的存储池的存储卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh vol-create-as vm_images_lvm lvvol1 10g</span><br>Vol lvvol1 created<br><br><span class="hljs-comment">#自动创建逻辑卷</span><br>[root@centos8 ~]<span class="hljs-comment"># lvs</span><br>  LV     VG            Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert<br>  lvvol1 vm_images_lvm -wi-a----- 10.00g <br><br>[root@centos8 ~]<span class="hljs-comment"># virsh vol-list vm_images_lvm</span><br> Name     Path<br>-------------------------------------<br> lvvol1   /dev/vm_images_lvm/lvvol1<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm196.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-7-3-3-利用存储卷创建虚拟机"><a href="#6-7-3-3-利用存储卷创建虚拟机" class="headerlink" title="6.7.3.3 利用存储卷创建虚拟机"></a>6.7.3.3 利用存储卷创建虚拟机</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm197.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm198.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm199.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm200.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm201.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm202.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm203.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm204.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-7-3-4-删除基于LVM的存储池的存储卷"><a href="#6-7-3-4-删除基于LVM的存储池的存储卷" class="headerlink" title="6.7.3.4 删除基于LVM的存储池的存储卷"></a>6.7.3.4 删除基于LVM的存储池的存储卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh vol-delete lvvol1 vm_images_lvm</span><br>Vol lvvol1 deleted<br><br>[root@centos8 ~]<span class="hljs-comment">#lvs</span><br></code></pre></td></tr></table></figure>

<h3 id="6-7-4-克隆存储卷"><a href="#6-7-4-克隆存储卷" class="headerlink" title="6.7.4 克隆存储卷"></a>6.7.4 克隆存储卷</h3><h4 id="6-7-4-1-克隆基于文件的存储卷"><a href="#6-7-4-1-克隆基于文件的存储卷" class="headerlink" title="6.7.4.1 克隆基于文件的存储卷"></a>6.7.4.1 克隆基于文件的存储卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh vol-list default</span><br>Name         Path                  <br>------------------------------------------------------------------------------<br>centos7-vm1.qcow2  /var/lib/libvirt/images/centos7-vm1.qcow2<br>centos7-vm2.qcow2  /var/lib/libvirt/images/centos7-vm2.qcow2<br>centos7.qcow2    /var/lib/libvirt/images/centos7.qcow2 <br>centos8-test1.qcow2 /var/lib/libvirt/images/centos8-test1.qcow2<br>centos8.qcow2    /var/lib/libvirt/images/centos8.qcow2 <br>Windows-2008_r2-x86_64.qcow2 /var/lib/libvirt/images/Windows-2008_r2-<br>x86_64.qcow2<br><br>[root@centos8 ~]<span class="hljs-comment">#virsh vol-info  centos7.qcow2 default</span><br>Name:      centos7.qcow2<br>Type:      file<br>Capacity:    20.00 GiB<br>Allocation:   1.56 GiB<br><br>[root@centos8 ~]<span class="hljs-comment">#virsh vol-clone centos7.qcow2 centos7_clone.qcow2 default</span><br>Vol centos7_clone.qcow2 cloned from centos7.qcow2<br><br>[root@centos8 ~]<span class="hljs-comment">#virsh vol-info  centos7_clone.qcow2 default</span><br>Name:      centos7_clone.qcow2<br>Type:      file<br>Capacity:    20.00 GiB<br>Allocation:   1.52 GiB<br><br>[root@centos8 ~]<span class="hljs-comment">#virsh vol-list default</span><br>Name                           Path                  <br>------------------------------------------------------------------------------<br>centos7-vm1.qcow2              /var/lib/libvirt/images/centos7-vm1.qcow2<br>centos7-vm2.qcow2              /var/lib/libvirt/images/centos7-vm2.qcow2<br>centos7.qcow2                  /var/lib/libvirt/images/centos7.qcow2 <br>centos7_clone.qcow2            /var/lib/libvirt/images/centos7_clone.qcow2<br>centos8-test1.qcow2            /var/lib/libvirt/images/centos8-test1.qcow2<br>centos8.qcow2                  /var/lib/libvirt/images/centos8.qcow2 <br>Windows-2008_r2-x86_64.qcow2   /var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2<br><br>[root@centos8 ~]<span class="hljs-comment"># ll -h /var/lib/libvirt/images/centos7.qcow2 /var/lib/libvirt/images/centos7_clone.qcow2</span><br>-rw-r--r-- 1 root root 1.6G Sep 20 22:22 /var/lib/libvirt/images/centos7_clone.qcow2<br>-rw-r--r-- 1 root root 1.6G Sep 20 18:09 /var/lib/libvirt/images/centos7.qcow2 /var/lib/libvirt/images/centos7_clone.qcow2<br></code></pre></td></tr></table></figure>

<h4 id="6-7-4-2-克隆基于LVM的存储卷"><a href="#6-7-4-2-克隆基于LVM的存储卷" class="headerlink" title="6.7.4.2 克隆基于LVM的存储卷"></a>6.7.4.2 克隆基于LVM的存储卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh vol-list vm_images_lvm</span><br>Name         Path                  <br>------------------------------------------------------------------------------<br>lvvol1        /dev/vm_images_lvm/lvvol<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh vol-clone  lvvol1 lvvol1_clone vm_images_lvm</span><br>Vol lvvol1_clone cloned from lvvol1<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh vol-list vm_images_lvm</span><br>Name             Path                  <br>------------------------------------------------------------------------------<br>lvvol1           /dev/vm_images_lvm/lvvol1       <br>lvvol1_clone     /dev/vm_images_lvm/lvvol1_clone <br><br>[root@centos8 ~]<span class="hljs-comment"># lvs</span><br>LV           VG            Attr       LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert<br>lvvol1       vm_images_lvm -wi-a----- 1.00g                 <br>        <br>lvvol1_clone vm_images_lvm -wi-a----- 1.00g <br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm205.png" srcset="/blog/img/loading.gif"></p>
<h3 id="6-7-5-向虚拟机添加存储卷"><a href="#6-7-5-向虚拟机添加存储卷" class="headerlink" title="6.7.5 向虚拟机添加存储卷"></a>6.7.5 向虚拟机添加存储卷</h3><p>可以通过attach-device和attach-disk给现有虚拟机添加存储卷,从而实现给虚拟机新添加虚拟磁盘</p>
<h4 id="6-7-5-1-attach-device-通过XML文件给已有虚拟机添加存储卷"><a href="#6-7-5-1-attach-device-通过XML文件给已有虚拟机添加存储卷" class="headerlink" title="6.7.5.1 attach-device 通过XML文件给已有虚拟机添加存储卷"></a>6.7.5.1 attach-device 通过XML文件给已有虚拟机添加存储卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh vol-list vm_images_dir</span><br> Name          Path<br>------------------------------------------------<br> test1.qcow2   /data/vm_images_dir/test1.qcow2<br><br>[root@centos8 ~]<span class="hljs-comment"># vim disk.xml</span><br>&lt;disk <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;file&#x27;</span> device=<span class="hljs-string">&#x27;disk&#x27;</span>&gt;<br>&lt;driver name=<span class="hljs-string">&#x27;qemu&#x27;</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;qcow2&#x27;</span> cache=<span class="hljs-string">&#x27;none&#x27;</span>/&gt;<br>&lt;<span class="hljs-built_in">source</span> file=<span class="hljs-string">&#x27;/data/vm_images_dir/test1.qcow2&#x27;</span>/&gt;<br>&lt;target dev=<span class="hljs-string">&#x27;vdb&#x27;</span>/&gt;<br>&lt;/disk&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh start centos7</span><br>Domain centos7 started<br><br><span class="hljs-comment">#默认只是临时添加设备,使用选项--persistent实现持久保存</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh attach-device centos7 disk.xml --persistent</span><br>Device attached successfully<br><br><span class="hljs-comment">#查看虚拟机当前的块设备信息</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh domblklist centos7</span><br> Target   Source<br>-------------------------------------------------<br> vda      /var/lib/libvirt/images/centos7.qcow2<br> vdb      /data/vm_images_dir/test1.qcow2<br> sda      -<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm206.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm207.png" srcset="/blog/img/loading.gif"></p>
<h4 id="6-7-5-2-attach-disk-给已有虚拟机添加存储卷"><a href="#6-7-5-2-attach-disk-给已有虚拟机添加存储卷" class="headerlink" title="6.7.5.2 attach-disk 给已有虚拟机添加存储卷"></a>6.7.5.2 attach-disk 给已有虚拟机添加存储卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh start centos7</span><br>Domain centos7 started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh attach-disk --domain centos7 --sourcetype block --source /dev/vm_images_lvm/lvvol1 --target vdb</span><br>Disk attached successfully<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm208.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm209.png" srcset="/blog/img/loading.gif"></p>
<h2 id="6-8-离线工具"><a href="#6-8-离线工具" class="headerlink" title="6.8 离线工具"></a>6.8 离线工具</h2><p>不启动虚拟机的情况下,直接访问管理虚拟机对应的磁盘,即离线访问</p>
<h3 id="6-8-1-离线工具应用"><a href="#6-8-1-离线工具应用" class="headerlink" title="6.8.1 离线工具应用"></a>6.8.1 离线工具应用</h3><ul>
<li>观看或下载位于虚拟机磁盘中的文件</li>
<li>编辑或上传文件到虚拟机磁盘</li>
<li>读取或写入的虚拟机配置</li>
<li>准备新的磁盘映像，其中包含文件、目录、文件系统、分区、逻辑卷和其他选项</li>
<li>拯救和修复客户无法启动或需要更改启动配置的虚拟机</li>
<li>监控虚拟机的磁盘使用情况</li>
<li>根据组织安全标准审计虚拟机的合规性</li>
<li>通过克隆和修改模板来部署虚拟机</li>
<li>读取CD和DVD ISO和软盘映像</li>
</ul>
<h3 id="6-8-2-guestfs-工具"><a href="#6-8-2-guestfs-工具" class="headerlink" title="6.8.2 guestfs 工具"></a>6.8.2 guestfs 工具</h3><p>Libguestfs 提供了一个简单地访问虚机磁盘镜像文件的方法，即使是在虚拟机无法启动的情况下</p>
<p>Libguestfs 是由一组丰富的工具集组成，可以让管理员访问虚机文件，甚至调整和挽救文件。</p>
<p>guestfish 是一个基于libguestfs API的交互shell</p>
<h4 id="6-8-2-1-安装和使用guestfs"><a href="#6-8-2-1-安装和使用guestfs" class="headerlink" title="6.8.2.1 安装和使用guestfs"></a>6.8.2.1 安装和使用guestfs</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install libguestfs-tools</span><br><br><span class="hljs-comment">#查看虚拟机的磁盘文件</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh domblklist centos7</span><br> Target   Source<br>-------------------------------------------------<br> vda      /var/lib/libvirt/images/centos7.qcow2<br> vdb      /data/vm_images_dir/test1.qcow2<br> sda      -<br> <br>[root@centos8 ~]<span class="hljs-comment"># virsh destroy centos7</span><br><br><span class="hljs-comment">#只读方式打开虚拟磁盘</span><br>[root@centos8 ~]<span class="hljs-comment"># guestfish --ro -a /var/lib/libvirt/images/centos7.qcow2</span><br><br>Welcome to guestfish, the guest filesystem shell <span class="hljs-keyword">for</span><br>editing virtual machine filesystems and disk images.<br><br>Type: ‘<span class="hljs-built_in">help</span>’ <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> on commands<br>      ‘man’ to <span class="hljs-built_in">read</span> the manual<br>      ‘quit’ to quit the shell<br><br>&gt;&lt;fs&gt; <span class="hljs-built_in">help</span><br>Add disk images to examine using the ‘-a’ or ‘-d’ options, or the ‘add’<br><span class="hljs-built_in">command</span>.<br>Or create a new disk image using ‘-N’, or the ‘alloc’ or ‘sparse’ commands.<br>Once you have <span class="hljs-keyword">done</span> this, use the ‘run’ <span class="hljs-built_in">command</span>.<br><br>For more information about a <span class="hljs-built_in">command</span>, use ‘<span class="hljs-built_in">help</span> cmd’.<br><br>To <span class="hljs-built_in">read</span> the manual, <span class="hljs-built_in">type</span> ‘man’.<br><br>&gt;&lt;fs&gt; run        <span class="hljs-comment">#扫描磁盘</span><br>◓ 75% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ 100%<br>⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00<br>&gt;&lt;fs&gt; list-filesystems  <span class="hljs-comment">#列出文件系统</span><br>/dev/sda1: xfs<br>/dev/centos/root: xfs<br>/dev/centos/swap: swap<br>&gt;&lt;fs&gt;<br><br>&gt;&lt;fs&gt; mount /dev/sda1 /   <span class="hljs-comment">#挂载</span><br>&gt;&lt;fs&gt; ls / <span class="hljs-comment">#查看</span><br>.vmlinuz-3.10.0-1127.el7.x86_64.hmac<br>System.map-3.10.0-1127.el7.x86_64<br>config-3.10.0-1127.el7.x86_64<br>efi<br>grub<br>grub2<br>initramfs-0-rescue-1d660cbcc84f4a399d9f991578c3c6f8.img<br>initramfs-3.10.0-1127.el7.x86_64.img<br>initramfs-3.10.0-1127.el7.x86_64kdump.img<br>symvers-3.10.0-1127.el7.x86_64.gz<br>vmlinuz-0-rescue-1d660cbcc84f4a399d9f991578c3c6f8<br>vmlinuz-3.10.0-1127.el7.x86_64<br></code></pre></td></tr></table></figure>

<h4 id="6-8-2-2-guestfs-自动挂载文件系统"><a href="#6-8-2-2-guestfs-自动挂载文件系统" class="headerlink" title="6.8.2.2 guestfs 自动挂载文件系统"></a>6.8.2.2 guestfs 自动挂载文件系统</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#虚拟机开机无法访问虚拟磁盘</span><br><span class="hljs-comment">#选项-d指定虚拟机domain打开虚拟磁盘</span><br>[root@centos8 ~]<span class="hljs-comment"># guestfish -d centos7</span><br>libguestfs: error: error: domain is a live virtual machine.Writing to the disks of a running virtual machine can cause disk corruption.Either use read-only access, or <span class="hljs-keyword">if</span> the guest is running the guestfsd daemon specify live access. In most libguestfs tools these options are --ro or --live respectively. Consult the documentation <span class="hljs-keyword">for</span> further information.<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh destroy centos7</span><br>Domain centos7 destroyed<br><br><span class="hljs-comment">#选项-i 可以实现自动探查后进行自动挂载</span><br>[root@centos8 ~]<span class="hljs-comment"># guestfish --ro -a /var/lib/libvirt/images/centos7.qcow2 -i</span><br><br>Welcome to guestfish, the guest filesystem shell <span class="hljs-keyword">for</span><br>editing virtual machine filesystems and disk images.<br><br>Type: ‘<span class="hljs-built_in">help</span>’ <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> on commands<br>  ‘man’ to <span class="hljs-built_in">read</span> the manual<br>  ‘quit’ to quit the shell<br>  <br>Operating system: CentOS Linux release 7.8.2003 (Core)<br>/dev/centos/root mounted on /<br>/dev/sda1 mounted on /boot<br><br>&gt;&lt;fs&gt; ls /<br>bin<br>boot<br>dev<br>etc<br>home<br>lib<br>lib64<br>media<br>mnt<br>opt<br>proc<br>root<br>run<br>sbin<br>srv<br>sys<br>tmp<br>usr<br>var<br></code></pre></td></tr></table></figure>

<h4 id="6-8-2-3-guestfs-离线修改虚拟磁盘内的文件"><a href="#6-8-2-3-guestfs-离线修改虚拟磁盘内的文件" class="headerlink" title="6.8.2.3 guestfs 离线修改虚拟磁盘内的文件"></a>6.8.2.3 guestfs 离线修改虚拟磁盘内的文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#默认读写方式打开虚拟磁盘</span><br>[root@centos8 ~]<span class="hljs-comment"># guestfish -d centos7 -i</span><br><br>Welcome to guestfish, the guest filesystem shell <span class="hljs-keyword">for</span><br>editing virtual machine filesystems and disk images.<br><br>Type: ‘<span class="hljs-built_in">help</span>’ <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> on commands<br>      ‘man’ to <span class="hljs-built_in">read</span> the manual<br>      ‘quit’ to quit the shell<br><br>Operating system: CentOS Linux release 7.9.2009 (Core)<br>/dev/centos/root mounted on /<br>/dev/sda1 mounted on /boot<br><br>&gt;&lt;fs&gt; edit /etc/issue  <span class="hljs-comment">#调用vi打开修改文件</span><br>hello world<br><br>\S<br>Kernel \r on an \m<br>&gt;&lt;fs&gt; <span class="hljs-built_in">exit</span><br><br>[root@centos8 ~]<span class="hljs-comment">#virsh start centos7</span><br>Domain centos7 started<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm210.png" srcset="/blog/img/loading.gif"></p>
<h3 id="6-8-3-其它离线工具"><a href="#6-8-3-其它离线工具" class="headerlink" title="6.8.3 其它离线工具"></a>6.8.3 其它离线工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">virt-df <span class="hljs-comment">#监视磁盘使用</span><br>virt-resize <span class="hljs-comment">#离线调整虚拟磁盘大小</span><br>virt-inspector <span class="hljs-comment">#虚拟机检视</span><br>virt-win-reg <span class="hljs-comment">#Windows注册表读取和修改</span><br>virt-sysprep <span class="hljs-comment">#虚拟机设置重置</span><br></code></pre></td></tr></table></figure>

<h1 id="七、网络管理"><a href="#七、网络管理" class="headerlink" title="七、网络管理"></a>七、网络管理</h1><p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://wiki.libvirt.org/page/VirtualNetworking<br></code></pre></td></tr></table></figure>

<h2 id="7-1-Linux-网桥实现"><a href="#7-1-Linux-网桥实现" class="headerlink" title="7.1 Linux 网桥实现"></a>7.1 Linux 网桥实现</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建网桥</span><br>nmcli con add <span class="hljs-built_in">type</span> bridge con-name br0 ifname br0<br>nmcli connection modify br0 ipv4.addresses 10.0.0.100/24 ipv4.method manual<br>nmcli con up br0<br><br><span class="hljs-comment">#加入物理网卡</span><br>nmcli con add <span class="hljs-built_in">type</span> bridge-slave con-name br0-port0 ifname eth0 master br0<br>nmcli con add <span class="hljs-built_in">type</span> bridge-slave con-name br0-port1 ifname eth1 master br0<br>nmcli con up br0-port0<br>nmcli con up br0-port1<br><br><span class="hljs-comment">#查看网桥配置文件</span><br>cat /etc/sysconfig/network-scripts/ifcfg-br0<br>DEVICE=br0<br>NAME=br0<br>STP=yes<br>TYPE=Bridge<br>BOOTPROTO=static<br>IPADDR=10.0.0.100<br>PREFIX=24<br>cat /etc/sysconfig/network-scripts/ifcfg-br0-port0<br>TYPE=Ethernet<br>NAME=br0-port0<br>DEVICE=eth0<br>ONBOOT=yes<br>BRIDGE=br0<br>UUID=23f41d3b-b57c-4e26-9b17-d5f02dafd12d<br><br><span class="hljs-comment">#安装管理软件包,注意:CentOS8取消了此包</span><br>yum install bridge-utils<br><br><span class="hljs-comment">#查看网桥</span><br>brctl show<br>ip link show master br0<br>bridge link show<br><span class="hljs-comment">#删除br0</span><br>nmcli con down br0<br>rm /etc/sysconfig/network-scripts/ifcfg-br0*<br>nmcli con reload<br></code></pre></td></tr></table></figure>

<h2 id="7-2-qemu-kvm支持的网络"><a href="#7-2-qemu-kvm支持的网络" class="headerlink" title="7.2 qemu-kvm支持的网络"></a>7.2 qemu-kvm支持的网络</h2><p>虚拟机的网络模式:</p>
<ul>
<li>基于NAT ( Network Addresss Translation)的虚拟网络,此为virt-install的默认模式</li>
<li>基于自定义网桥（Bridge ）的虚拟网络</li>
<li>用户自定义的隔离的虚拟网络</li>
<li>直接分配物理网络设备（包括VT-d和SR-IOV),性能最好</li>
</ul>
<p>虚拟机的网卡设备:</p>
<ul>
<li>RTL8139、e1000、….</li>
<li>virtio 生产建议使用</li>
</ul>
<p>范例: 查看qemu-kvm支持的网卡型号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># /usr/libexec/qemu-kvm -net nic,model=?</span><br>qemu: Supported NIC models: e1000,e1000-82540em,e1000e,rtl8139,virtio-net-pci<br></code></pre></td></tr></table></figure>

<h2 id="7-3-默认的网络配置NAT模式"><a href="#7-3-默认的网络配置NAT模式" class="headerlink" title="7.3 默认的网络配置NAT模式"></a>7.3 默认的网络配置NAT模式</h2><h3 id="7-3-1-默认网络连接的架构图"><a href="#7-3-1-默认网络连接的架构图" class="headerlink" title="7.3.1 默认网络连接的架构图"></a>7.3.1 默认网络连接的架构图</h3><p>默认虚拟机网络配置为NAT模式,相当于vmware的NAT模式的Vmnet8</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm211.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-3-2-宿主机默认网络相关服务和信息"><a href="#7-3-2-宿主机默认网络相关服务和信息" class="headerlink" title="7.3.2 宿主机默认网络相关服务和信息"></a>7.3.2 宿主机默认网络相关服务和信息</h3><p>默认宿主机安装dnsmasq包指供DHCP服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># rpm -q dnsmasq</span><br>dnsmasq-2.79-11.el8.x86_64<br><br>[root@centos8 ~]<span class="hljs-comment"># cat /var/lib/libvirt/dnsmasq/default.conf</span><br><span class="hljs-comment">##WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span><br><span class="hljs-comment">##OVERWRITTEN AND LOST. Changes to this configuration should be made using:</span><br><span class="hljs-comment">##  virsh net-edit default</span><br><span class="hljs-comment">## or other application using the libvirt API.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## dnsmasq conf file created by libvirt</span><br>strict-order<br>pid-file=/var/run/libvirt/network/default.pid<br>except-interface=lo<br>bind-dynamic<br>interface=virbr0<br>dhcp-range=192.168.122.2,192.168.122.254<br>dhcp-no-override<br>dhcp-authoritative<br>dhcp-lease-max=253<br>dhcp-hostsfile=/var/lib/libvirt/dnsmasq/default.hostsfile<br>addn-hosts=/var/lib/libvirt/dnsmasq/default.addnhosts<br></code></pre></td></tr></table></figure>

<p>范例: 查看宿主机的网桥信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh list --all</span><br>Id  Name                 State<br>----------------------------------------------------<br>-   centos7              shut off<br>-   centos7-2            shut off<br>-   centos8              shut off<br>-   Win_2008_r2-x86_64   shut off<br><br>[root@centos8 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe44:c3fe/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN<br>group default qlen 1000<br> link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff<br> inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>   valid_lft forever preferred_lft forever<br>4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state<br>DOWN group default qlen 1000<br> link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff<br> <br>[root@centos8 ~]<span class="hljs-comment"># virsh start centos7</span><br>Domain centos7 started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh start centos8</span><br>Domain centos8 started<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh list</span><br>Id  Name               State<br>----------------------------------------------------<br>2   centos7            running<br>3   centos8            running<br><br>[root@centos8 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe44:c3fe/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP<br>group default qlen 1000<br> link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff<br> inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>   valid_lft forever preferred_lft forever<br>4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state<br>DOWN group default qlen 1000<br> link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff<br>6: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master<br>virbr0 state UNKNOWN group default qlen 1000<br> link/ether fe:54:00:95:25:fb brd ff:ff:ff:ff:ff:ff<br> inet6 fe80::fc54:ff:fe95:25fb/64 scope link<br>   valid_lft forever preferred_lft forever<br>7: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master<br>virbr0 state UNKNOWN group default qlen 1000<br> link/ether fe:54:00:83:9d:51 brd ff:ff:ff:ff:ff:ff<br> inet6 fe80::fc54:ff:fe83:9d51/64 scope link<br>   valid_lft forever preferred_lft forever<br>   <br><span class="hljs-comment">#查看virbr0网络的情况</span><br>[root@centos8 ~]<span class="hljs-comment"># ip link show master virbr0</span><br>4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN mode DEFAULT group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>8: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr0 state UNKNOWN mode DEFAULT group default qlen 1000<br>    link/ether fe:54:00:61:1c:73 brd ff:ff:ff:ff:ff:ff<br>9: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr0 state UNKNOWN mode DEFAULT group default qlen 1000<br>    link/ether fe:54:00:9d:2e:19 brd ff:ff:ff:ff:ff:ff<br> <br><span class="hljs-comment">#查看所有桥接网卡信息及对应网桥</span><br>[root@centos8 ~]<span class="hljs-comment"># bridge link show</span><br>4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled priority 32 cost 100 <br>8: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr0 state forwarding priority 32 cost 100 <br>9: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr0 state forwarding priority 32 cost 100<br><br>[root@centos8 ~]<span class="hljs-comment"># nmtui</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm212.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm213.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm214.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm215.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm216.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm217.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh net-list</span><br> Name      State    Autostart   Persistent<br>--------------------------------------------<br> default   active   yes         yes<br><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/libvirt/qemu/networks/default.xml</span><br>&lt;!--<br>WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br>OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br>  virsh net-edit default<br>or other application using the libvirt API.<br>--&gt;<br><br>&lt;network&gt;<br>  &lt;name&gt;default&lt;/name&gt;<br>  &lt;uuid&gt;18af3672-ec30-4a3c-9299-7f74072414c1&lt;/uuid&gt;<br>  &lt;forward mode=<span class="hljs-string">&#x27;nat&#x27;</span>/&gt;<br>  &lt;bridge name=<span class="hljs-string">&#x27;virbr0&#x27;</span> stp=<span class="hljs-string">&#x27;on&#x27;</span> delay=<span class="hljs-string">&#x27;0&#x27;</span>/&gt;<br>  &lt;mac address=<span class="hljs-string">&#x27;52:54:00:b9:24:09&#x27;</span>/&gt;<br>  &lt;ip address=<span class="hljs-string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="hljs-string">&#x27;255.255.255.0&#x27;</span>&gt;<br>    &lt;dhcp&gt;<br>      &lt;range start=<span class="hljs-string">&#x27;192.168.122.2&#x27;</span> end=<span class="hljs-string">&#x27;192.168.122.254&#x27;</span>/&gt;<br>    &lt;/dhcp&gt;<br>  &lt;/ip&gt;<br>&lt;/network&gt;<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh net-dumpxml default</span><br>&lt;network connections=<span class="hljs-string">&#x27;2&#x27;</span>&gt;<br>  &lt;name&gt;default&lt;/name&gt;<br>  &lt;uuid&gt;18af3672-ec30-4a3c-9299-7f74072414c1&lt;/uuid&gt;<br>  &lt;forward mode=<span class="hljs-string">&#x27;nat&#x27;</span>&gt;<br>    &lt;nat&gt;<br>      &lt;port start=<span class="hljs-string">&#x27;1024&#x27;</span> end=<span class="hljs-string">&#x27;65535&#x27;</span>/&gt;<br>    &lt;/nat&gt;<br>  &lt;/forward&gt;<br>  &lt;bridge name=<span class="hljs-string">&#x27;virbr0&#x27;</span> stp=<span class="hljs-string">&#x27;on&#x27;</span> delay=<span class="hljs-string">&#x27;0&#x27;</span>/&gt;<br>  &lt;mac address=<span class="hljs-string">&#x27;52:54:00:b9:24:09&#x27;</span>/&gt;<br>  &lt;ip address=<span class="hljs-string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="hljs-string">&#x27;255.255.255.0&#x27;</span>&gt;<br>    &lt;dhcp&gt;<br>      &lt;range start=<span class="hljs-string">&#x27;192.168.122.2&#x27;</span> end=<span class="hljs-string">&#x27;192.168.122.254&#x27;</span>/&gt;<br>    &lt;/dhcp&gt;<br>  &lt;/ip&gt;<br>&lt;/network&gt;<br><br><span class="hljs-comment">#查看NAT策略实现从虚拟机可以访问外部网络,反之不通,此策略由libvirtd服务启动时自动加载到NAT表</span><br>[root@centos8 ~]<span class="hljs-comment"># iptables -vnL -t nat</span><br>Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>  177 13523 LIBVIRT_PRT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           <br><br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain LIBVIRT_PRT (1 references)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>    0     0 RETURN     all  --  *      *       192.168.122.0/24     224.0.0.0/24        <br>    0     0 RETURN     all  --  *      *       192.168.122.0/24     255.255.255.255     <br>    4   240 MASQUERADE  tcp  --  *      *       192.168.122.0/24    !192.168.122.0/24     masq ports: 1024-65535<br>    0     0 MASQUERADE  udp  --  *      *       192.168.122.0/24    !192.168.122.0/24     masq ports: 1024-65535<br>    0     0 MASQUERADE  all  --  *      *       192.168.122.0/24    !192.168.122.0/24<br><br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br></code></pre></td></tr></table></figure>

<h3 id="7-3-3-虚拟机网卡默认设置"><a href="#7-3-3-虚拟机网卡默认设置" class="headerlink" title="7.3.3 虚拟机网卡默认设置"></a>7.3.3 虚拟机网卡默认设置</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm218.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm219.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm220.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm221.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh dumpxml centos7 |sed -n &#x27;/interface/,/interface/p&#x27;</span><br>    &lt;interface <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;network&#x27;</span>&gt;<br>      &lt;mac address=<span class="hljs-string">&#x27;52:54:00:61:1c:73&#x27;</span>/&gt;<br>      &lt;<span class="hljs-built_in">source</span> network=<span class="hljs-string">&#x27;default&#x27;</span> portid=<span class="hljs-string">&#x27;a58bf0ef-7408-40ce-8058-539f0a389d41&#x27;</span> bridge=<span class="hljs-string">&#x27;virbr0&#x27;</span>/&gt;<br>      &lt;target dev=<span class="hljs-string">&#x27;vnet0&#x27;</span>/&gt;<br>      &lt;model <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;virtio&#x27;</span>/&gt;<br>      &lt;<span class="hljs-built_in">alias</span> name=<span class="hljs-string">&#x27;net0&#x27;</span>/&gt;<br>      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x01&#x27;</span> slot=<span class="hljs-string">&#x27;0x00&#x27;</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br>    &lt;/interface&gt;<br></code></pre></td></tr></table></figure>

<h3 id="7-3-4-virsh-查看虚拟机网络配置"><a href="#7-3-4-virsh-查看虚拟机网络配置" class="headerlink" title="7.3.4 virsh 查看虚拟机网络配置"></a>7.3.4 virsh 查看虚拟机网络配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看虚拟机的网卡配置</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh domiflist centos8</span><br> Interface   Type      Source    Model    MAC<br>-------------------------------------------------------------<br> vnet1       network   default   virtio   52:54:00:9d:2e:19<br><br><span class="hljs-comment">#查看虚拟机的网卡地址信息</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh domifaddr centos8</span><br> Name       MAC address          Protocol     Address<br>-------------------------------------------------------------------------------<br> vnet0      52:54:00:9d:2e:19    ipv4         192.168.122.94/24<br><br><span class="hljs-comment">#查看虚拟机的指定网卡的状态</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh domifstat centos8 vnet0</span><br>vnet0 rx_bytes 39672<br>vnet0 rx_packets 739<br>vnet0 rx_errs 0<br>vnet0 rx_drop 0<br>vnet0 tx_bytes 1742<br>vnet0 tx_packets 19<br>vnet0 tx_errs 0<br>vnet0 tx_drop 0<br></code></pre></td></tr></table></figure>

<h3 id="7-3-5-向虚拟机添加虚拟网络连接"><a href="#7-3-5-向虚拟机添加虚拟网络连接" class="headerlink" title="7.3.5 向虚拟机添加虚拟网络连接"></a>7.3.5 向虚拟机添加虚拟网络连接</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm222.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm223.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-4-配置虚拟机网卡桥接到宿主机的物理网卡"><a href="#7-4-配置虚拟机网卡桥接到宿主机的物理网卡" class="headerlink" title="7.4 配置虚拟机网卡桥接到宿主机的物理网卡"></a>7.4 配置虚拟机网卡桥接到宿主机的物理网卡</h2><p>相当于vmware的桥接模式的Vmnet0</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm224.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm225.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># virsh domiflist centos7</span><br>Interface Type    Source   Model    MAC<br>-------------------------------------------------------<br>macvtap0  direct   eth0    virtio    52:54:00:95:25:fb<br><br>[root@centos8 ~]<span class="hljs-comment"># virsh domifaddr centos7</span><br>Name    MAC address     Protocol   Address<br>-------------------------------------------------------------------------------<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm226.png" srcset="/blog/img/loading.gif"></p>
<p>在宿主机上自动生成虚拟网卡macvtap0@eth0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host<br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br>    link/ether 00:0c:29:e1:0e:53 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fee1:e53/64 scope link<br>       valid_lft forever preferred_lft forever<br>3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000<br>    link/ether 52:54:00:8b:be:ee brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>       valid_lft forever preferred_lft forever<br>4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000<br>    link/ether 52:54:00:8b:be:ee brd ff:ff:ff:ff:ff:ff<br>6: macvtap0@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel<br>state UP group default qlen 500<br>    link/ether 52:54:00:0d:8a:0e brd ff:ff:ff:ff:ff:ff<br>    inet6 fe80::5054:ff:fe0d:8a0e/64 scope link<br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<h2 id="7-5-基于自定义网桥的虚拟网络"><a href="#7-5-基于自定义网桥的虚拟网络" class="headerlink" title="7.5 基于自定义网桥的虚拟网络"></a>7.5 基于自定义网桥的虚拟网络</h2><h3 id="7-5-1-自定义网桥架构"><a href="#7-5-1-自定义网桥架构" class="headerlink" title="7.5.1 自定义网桥架构"></a>7.5.1 自定义网桥架构</h3><p>桥接网络可以让运行在宿主机上的虚拟机使用和宿主机相同网段的IP，并且可以从外部直接访问到虚拟机，目前企业中大部分场景都使用桥接网络。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm227.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-5-2-创建虚拟机PXE启动并利用kickstart自动安装系统"><a href="#7-5-2-创建虚拟机PXE启动并利用kickstart自动安装系统" class="headerlink" title="7.5.2 创建虚拟机PXE启动并利用kickstart自动安装系统"></a>7.5.2 创建虚拟机PXE启动并利用kickstart自动安装系统</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm228.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-5-2-1-在宿主机准备PXE环境"><a href="#7-5-2-1-在宿主机准备PXE环境" class="headerlink" title="7.5.2.1 在宿主机准备PXE环境"></a>7.5.2.1 在宿主机准备PXE环境</h4><p><strong>注意: 取消vmnet8的DHCP功能</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install dhcp-server tftp-server httpd syslinux-nonlinux</span><br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable --now httpd tftp dhcpd</span><br>Created symlink /etc/systemd/system/sockets.target.wants/tftp.socket → /usr/lib/systemd/system/tftp.socket.<br>Created symlink /etc/systemd/system/multi-user.target.wants/dhcpd.service → /usr/lib/systemd/system/dhcpd.service.<br>Job <span class="hljs-keyword">for</span> dhcpd.service failed because the control process exited with error code.<br>See <span class="hljs-string">&quot;systemctl status dhcpd.service&quot;</span> and <span class="hljs-string">&quot;journalctl -xe&quot;</span> <span class="hljs-keyword">for</span> details. <span class="hljs-comment">#此时会产生错误，这是正常的</span><br><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/dhcp/dhcpd.conf</span><br>option domain-name <span class="hljs-string">&quot;magedu.org&quot;</span>;<br>option domain-name-servers 180.76.76.76,223.6.6.6;<br>default-lease-time 600;<br>max-lease-time 7200;<br>log-facility local7;<br>subnet 10.0.0.0 netmask 255.255.255.0 &#123;<br>range 10.0.0.100 10.0.0.200;<br>option routers 10.0.0.2;<br>next-server 10.0.0.8;<br>filename <span class="hljs-string">&quot;pxelinux.0&quot;</span>;<br>&#125;<br>[root@centos8 ~]<span class="hljs-comment"># systemctl start dhcpd</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl status dhcpd</span><br>● dhcpd.service - DHCPv4 Server Daemon<br>   Loaded: loaded (/usr/lib/systemd/system/dhcpd.service; enabled; vendor preset: disabled)<br>   Active: active (running) since Sat 2021-08-07 10:19:58 CST; 8s ago<br>     Docs: man:dhcpd(8)<br>           man:dhcpd.conf(5)<br> Main PID: 3105 (dhcpd)<br>   Status: <span class="hljs-string">&quot;Dispatching packets...&quot;</span><br>    Tasks: 1 (<span class="hljs-built_in">limit</span>: 50411)<br>   Memory: 5.0M<br>   CGroup: /system.slice/dhcpd.service<br>           └─3105 /usr/sbin/dhcpd -f -cf /etc/dhcp/dhcpd.conf -user dhcpd -group dhcpd --no-pid<br><br>[root@centos8 ~]<span class="hljs-comment"># mkdir /var/lib/tftpboot/centos&#123;6,7,8&#125;</span><br>[root@centos8 ~]<span class="hljs-comment"># cp /usr/share/syslinux/&#123;pxelinux.0,menu.c32&#125; /var/lib/tftpboot/</span><br>[root@centos8 ~]<span class="hljs-comment"># cp /var/www/html/centos/8/os/x86_64/isolinux/&#123;vmlinuz,initrd.img&#125; /var/lib/tftpboot/centos8</span><br>[root@centos8 ~]<span class="hljs-comment"># cp /var/www/html/centos/8/os/x86_64/isolinux/&#123;ldlinux.c32,libcom32.c32,libutil.c32&#125; /var/lib/tftpboot/</span><br>[root@centos8 ~]<span class="hljs-comment"># mkdir /var/lib/tftpboot/pxelinux.cfg/</span><br>[root@centos8 ~]<span class="hljs-comment"># cp /var/www/html/centos/8/os/x86_64/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default #注意：复制过来后文件为只读格式</span><br><br>[root@centos8 ~]<span class="hljs-comment"># cat /var/lib/tftpboot/pxelinux.cfg/default</span><br>default menu.c32<br>timeout 600<br>menu title Install CentOS Linux<br><br>label linux8<br>menu default<br>menu label Auto Install CentOS Linux ^8<br>kernel centos8/vmlinuz<br>append initrd=centos8/initrd.img ks=http://10.0.0.8/ks/centos8.cfg<br><br>label manual<br>menu label ^Manual Install CentOS Linux 8.0<br>kernel centos8/vmlinuz<br>append initrd=centos8/initrd.img inst.repo=http://10.0.0.8/centos/8/os/x86_64/<br><br>label rescue<br>menu label ^Rescue a CentOS Linux system 8<br>kernel centos8/vmlinuz<br>append initrd=centos8/initrd.img inst.repo=http://10.0.0.8/centos/8/os/x86_64/<br>rescue<br><br>label <span class="hljs-built_in">local</span><br>menu label Boot from ^<span class="hljs-built_in">local</span> drive<br>localboot 0xffff<br><br>[root@centos8 ~]<span class="hljs-comment"># tree /var/lib/tftpboot/</span><br>/var/lib/tftpboot/<br>├── centos6<br>├── centos7<br>├── centos8<br>│  ├── initrd.img<br>│  └── vmlinuz<br>├── ldlinux.c32<br>├── libcom32.c32<br>├── libutil.c32<br>├── menu.c32<br>├── pxelinux.0<br>└── pxelinux.cfg<br> └── default<br> <br>4 directories, 8 files<br><br><span class="hljs-comment">#应答文件</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /var/www/html/ks/centos8.cfg</span><br>ignoredisk --only-use=vda  <span class="hljs-comment">#因为使用virtIO磁盘,注意磁盘名称为vda</span><br>zerombr<br>text<br>reboot<br>clearpart --all --initlabel<br>selinux --disabled<br>firewall --disabled<br>url --url=http://10.0.0.8/centos/8/os/x86_64/<br>keyboard --vckeymap=us --xlayouts=<span class="hljs-string">&#x27;us&#x27;</span><br>lang en_US.UTF-8<br><br>bootloader --append=<span class="hljs-string">&quot;net.ifnames=0&quot;</span> --location=mbr --boot-drive=vda  <span class="hljs-comment">#因为使用virtIO磁盘,注意磁盘名称为vda</span><br>network  --bootproto=dhcp --device=eth0 --ipv6=auto --activate<br><br>network  --hostname=centos8.magedu.org<br>rootpw --iscrypted<br>$6$j9YhzDUnQVnxaAk8<span class="hljs-variable">$qv7rkMcPAEbV5yvwsP666DXWYadd3jYjkA9fpxAo9qYotjGGBUclCGoP1TRvgHBpqgc5n0RypMsPTQnVDcpO01</span><br>firstboot --<span class="hljs-built_in">enable</span><br>skipx<br>services --disabled=<span class="hljs-string">&quot;chronyd&quot;</span><br>timezone Asia/Shanghai --isUtc --nontp<br>user --name=wang --<br>password=6oUfb/02CWfLb5l8f<span class="hljs-variable">$sgEZeR7c7DpqfpmFDH6huSmDbW1XQNR4qKl2EPns</span>.gOXqlnAIgv9pTogtFVaDtEpMOC.SWXKYqxfVtd9MCwxb1 --iscrypted --gecos=<span class="hljs-string">&quot;wang&quot;</span><br><br>autopart --<span class="hljs-built_in">type</span>=lvm<br>%packages<br>@^minimal-environment<br>kexec-tools<br>%end<br>%addon com_redhat_kdump --<span class="hljs-built_in">enable</span> --reserve-mb=<span class="hljs-string">&#x27;auto&#x27;</span><br>%end<br>%anaconda<br>pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty<br>pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok<br>pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty<br>%end<br><br>%post<br>useradd mage<br><span class="hljs-built_in">echo</span> magedu | passwd --stdin mage &amp;&gt; /dev/null<br>%end<br></code></pre></td></tr></table></figure>

<h4 id="7-5-2-2-在宿主机创建网桥"><a href="#7-5-2-2-在宿主机创建网桥" class="headerlink" title="7.5.2.2 在宿主机创建网桥"></a>7.5.2.2 在宿主机创建网桥</h4><h5 id="7-5-2-2-1-CentOS-创建桥接网卡"><a href="#7-5-2-2-1-CentOS-创建桥接网卡" class="headerlink" title="7.5.2.2.1 CentOS 创建桥接网卡"></a>7.5.2.2.1 CentOS 创建桥接网卡</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 network-scripts]<span class="hljs-comment"># pwd</span><br>/etc/sysconfig/network-scripts<br><br><span class="hljs-comment">#创建网桥配置文件</span><br>[root@centos8 network-scripts]<span class="hljs-comment"># vim ifcfg-virbr1</span><br>TYPE=Bridge<br>NAME=virbr1<br>DEVICE=virbr1<br>ONBOOT=yes<br>BOOTPROTO=static<br>IPADDR=10.0.0.8<br>NETMASK=255.255.255.0<br>GATEWAY=10.0.0.2<br>DNS1=180.76.76.76<br>DNS2=223.6.6.6<br><br><span class="hljs-comment">#将物理网卡eth0加入网桥，可以先将eth0配置先备份</span><br>[root@centos8 network-scripts]<span class="hljs-comment"># vim ifcfg-eth0</span><br>TYPE=Ethernet<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>BRIDGE=virbr1<br><br>[root@centos8 network-scripts]<span class="hljs-comment"># nmcli connection reload</span><br>[root@centos8 network-scripts]<span class="hljs-comment"># nmcli connection up virbr1</span><br>[root@centos8 network-scripts]<span class="hljs-comment"># nmcli connection up eth0</span><br>  <br>[root@centos8 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1 state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:ed brd ff:ff:ff:ff:ff:ff<br>4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>       valid_lft forever preferred_lft forever<br>5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>18: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:ed brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute virbr1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe29:f3ed/64 scope link <br>       valid_lft forever preferred_lft forever<br>   <br>[root@centos8 ~]<span class="hljs-comment"># bridge link show</span><br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr1 state forwarding priority 32 cost 100 <br>5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled priority 32 cost 100 <br>[root@centos8 ~]<span class="hljs-comment"># ip link show master virbr1</span><br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1 state UP mode DEFAULT group default qlen 1000<br>    link/ether 00:0c:29:29:f3:ed brd ff:ff:ff:ff:ff:ff<br><br></code></pre></td></tr></table></figure>

<h5 id="7-5-2-2-2-Ubuntu-创建桥接网卡"><a href="#7-5-2-2-2-Ubuntu-创建桥接网卡" class="headerlink" title="7.5.2.2.2 Ubuntu 创建桥接网卡"></a>7.5.2.2.2 Ubuntu 创建桥接网卡</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># cat /etc/netplan/01-netcfg.yaml</span><br><span class="hljs-comment"># This file describes the network interfaces available on your system</span><br><span class="hljs-comment"># For more information, see netplan(5).</span><br>network:<br>version: 2<br>renderer: networkd<br>ethernets:<br> eth0:<br>  dhcp4: no<br>  dhcp6: no<br> bridges:<br>   br0:<br>  dhcp4: no<br>  dhcp6: no<br>  addresses: [10.0.0.100/16]<br>  gateway4: 10.0.0.2<br>  nameservers:<br>   addresses: [223.6.6.6]<br>  interfaces:<br>   - eth0<br></code></pre></td></tr></table></figure>

<h5 id="7-5-2-2-3-使用virt-manager创建网桥"><a href="#7-5-2-2-3-使用virt-manager创建网桥" class="headerlink" title="7.5.2.2.3 使用virt-manager创建网桥"></a>7.5.2.2.3 使用virt-manager创建网桥</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm229.png" srcset="/blog/img/loading.gif"></p>
<p>注意:CentOS8 取消了此功能,以下图示为CentOS8 的virt-manager界面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm230.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-5-2-3-创建桥接自定网桥的虚拟机基于PXE启动并利用kickstart自动安装系统"><a href="#7-5-2-3-创建桥接自定网桥的虚拟机基于PXE启动并利用kickstart自动安装系统" class="headerlink" title="7.5.2.3 创建桥接自定网桥的虚拟机基于PXE启动并利用kickstart自动安装系统"></a>7.5.2.3 创建桥接自定网桥的虚拟机基于PXE启动并利用kickstart自动安装系统</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建磁盘</span><br>[root@centos8 ~]<span class="hljs-comment"># qemu-img create -f qcow2 /var/lib/libvirt/images/centos8-pxe.qcow2 10G</span><br><br><span class="hljs-comment">#创建接自定网桥的虚拟机</span><br>[root@centos8 ~]<span class="hljs-comment"># virt-install --virt-type kvm --name centos8-pxe --ram 2048 --vcpus 2 --disk bus=virtio,path=/var/lib/libvirt/images/centos8-pxe.qcow2 --graphics vnc,listen=0.0.0.0 --network=bridge:virbr1,model=virtio --pxe</span><br></code></pre></td></tr></table></figure>

<h4 id="7-5-2-4-虚拟机安装过程"><a href="#7-5-2-4-虚拟机安装过程" class="headerlink" title="7.5.2.4 虚拟机安装过程"></a>7.5.2.4 虚拟机安装过程</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm231.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm232.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm233.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm234.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm235.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-5-2-4-验证虚拟机设置"><a href="#7-5-2-4-验证虚拟机设置" class="headerlink" title="7.5.2.4 验证虚拟机设置"></a>7.5.2.4 验证虚拟机设置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># ip link show master virbr1</span><br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1<br>state UP mode DEFAULT group default qlen 1000<br> link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff<br>27: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master<br>virbr1 state UNKNOWN mode DEFAULT group default qlen 1000<br> link/ether fe:54:00:c5:0a:9d brd ff:ff:ff:ff:ff:ff<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm236.png" srcset="/blog/img/loading.gif"></p>
<p><strong>在virt-manager 查看网桥</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm237.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm238.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-5-2-5-从外部主机连接虚拟机"><a href="#7-5-2-5-从外部主机连接虚拟机" class="headerlink" title="7.5.2.5 从外部主机连接虚拟机"></a>7.5.2.5 从外部主机连接虚拟机</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">C:\Users\Wang&gt;ssh root@10.0.0.185<br>The authenticity of host <span class="hljs-string">&#x27;10.0.0.185 (10.0.0.185)&#x27;</span> can<span class="hljs-string">&#x27;t be established.</span><br><span class="hljs-string">ECDSA key fingerprint is SHA256:0yIg7Pvfpp5C0w5CT/AmJsGfBdVnQm9wQXqn9gSirno.</span><br><span class="hljs-string">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="hljs-string">Warning: Permanently added &#x27;</span>10.0.0.185<span class="hljs-string">&#x27; (ECDSA) to the list of known hosts.</span><br><span class="hljs-string">root@10.0.0.185&#x27;</span>s password:<br>Last login: Mon Sep 21 23:25:42 2020 from 10.0.0.1<br>Last login: Mon Sep 21 23:25:42 2020 from 10.0.0.1<br><br>[root@centos8 ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.185<br>[root@centos8 ~]<span class="hljs-comment"># yum -yq install pciutils</span><br>warning: /var/cache/dnf/BaseOS-929b586ef1f72f69/packages/pciutils-3.5.6-<br>4.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 8483c65d: NOKEY<br>Importing GPG key 0x8483C65D:<br>Userid   : <span class="hljs-string">&quot;CentOS (CentOS Official Signing Key) &lt;security@centos.org&gt;&quot;</span><br>Fingerprint: 99DB 70FA E1D7 CE22 7FB6 4882 05B5 55B3 8483 C65D<br>From    : /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial<br>[root@centos8 ~]<span class="hljs-comment"># lspci</span><br>00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)<br>00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]<br>00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]<br>00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)<br>00:02.0 VGA compatible controller: Red Hat, Inc. QXL paravirtual graphic card (rev 04)<br>00:03.0 Ethernet controller: Red Hat, Inc. Virtio network device<br>00:04.0 USB controller: Intel Corporation 82801I (ICH9 Family) USB UHCI Controller <span class="hljs-comment">#1 (rev 03)</span><br>00:04.1 USB controller: Intel Corporation 82801I (ICH9 Family) USB UHCI Controller <span class="hljs-comment">#2 (rev 03)</span><br>00:04.2 USB controller: Intel Corporation 82801I (ICH9 Family) USB UHCI Controller <span class="hljs-comment">#3 (rev 03)</span><br>00:04.7 USB controller: Intel Corporation 82801I (ICH9 Family) USB2 EHCI Controller <span class="hljs-comment">#1 (rev 03)</span><br>00:05.0 SCSI storage controller: Red Hat, Inc. Virtio block device<br>00:06.0 Unclassified device [00ff]: Red Hat, Inc. Virtio memory balloon<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm239.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-5-2-6-虚拟机手动克隆"><a href="#7-5-2-6-虚拟机手动克隆" class="headerlink" title="7.5.2.6 虚拟机手动克隆"></a>7.5.2.6 虚拟机手动克隆</h4><p>先关机后再克隆</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm240.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm241.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm242.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm243.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm244.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm245.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># ll -h /var/lib/libvirt/images/</span><br>total 5.7G<br>-rw------- 1 root root 1.8G Sep 21 23:33 centos8-clone.qcow2<br>-rw-r--r-- 1 root root 1.9G Sep 21 23:32 centos8.qcow2<br></code></pre></td></tr></table></figure>

<h4 id="7-5-2-7-基于现有虚拟机镜像批量创建新虚拟机"><a href="#7-5-2-7-基于现有虚拟机镜像批量创建新虚拟机" class="headerlink" title="7.5.2.7 基于现有虚拟机镜像批量创建新虚拟机"></a>7.5.2.7 基于现有虚拟机镜像批量创建新虚拟机</h4><p>将前面生成的虚拟机做为模版,生成新的虚拟机</p>
<p><strong>注意:先在前面的模块虚拟机修改配置,如:关闭firewalld和SELinux,禁用NetworkManager(CentOS 7)等,安装常用包等</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 images]<span class="hljs-comment"># pwd</span><br>/var/lib/libvirt/images<br><br>[root@centos8 images]<span class="hljs-comment"># cp centos8.qcow2 centos8-2.qcow2</span><br>[root@centos8 images]<span class="hljs-comment"># virt-install --virt-type kvm --name centos8-2 --ram 2048 --vcpus 2 --disk bus=virtio,path=/var/lib/libvirt/images/centos8-2.qcow2 --network bridge=virbr1,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br><br>WARNING No operating system detected, VM performance may suffer. Specify an OS<br>with --os-variant <span class="hljs-keyword">for</span> optimal results.<br><br>Starting install...<br>Domain creation completed.<br><br><span class="hljs-comment">#运行工具,可以看到下面出现新的虚拟机</span><br>[root@centos8 images]<span class="hljs-comment"># virt-manager</span><br><br><span class="hljs-comment">#开启的虚拟机磁盘文件所有者为qemu,关闭后为root</span><br>[root@centos8 ~]<span class="hljs-comment"># ll /var/lib/libvirt/images</span><br>total 9977352<br>-rw-r--r-- 1 qemu qemu 2029518848 Sep 21 23:37 centos8-2.qcow2<br>-rw------- 1 root root 1929183232 Sep 21 23:33 centos8-clone.qcow2<br>-rw-r--r-- 1 root root 2004221952 Sep 21 23:32 centos8.qcow2<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm246.png" srcset="/blog/img/loading.gif"></p>
<h4 id="7-5-2-8-查看新虚拟机设置"><a href="#7-5-2-8-查看新虚拟机设置" class="headerlink" title="7.5.2.8 查看新虚拟机设置"></a>7.5.2.8 查看新虚拟机设置</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm247.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm248.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm249.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm250.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-6-用户自定义的隔离的虚拟网络"><a href="#7-6-用户自定义的隔离的虚拟网络" class="headerlink" title="7.6 用户自定义的隔离的虚拟网络"></a>7.6 用户自定义的隔离的虚拟网络</h2><p>此模式类似于Vmware中的仅主机的网卡模式,但无法和物理主机相通,只能在虚拟机之间互通</p>
<h3 id="7-6-1-用户自定义的隔离的虚拟网络架构"><a href="#7-6-1-用户自定义的隔离的虚拟网络架构" class="headerlink" title="7.6.1 用户自定义的隔离的虚拟网络架构"></a>7.6.1 用户自定义的隔离的虚拟网络架构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm251.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-6-2-创建用户自定义的隔离的虚拟网络"><a href="#7-6-2-创建用户自定义的隔离的虚拟网络" class="headerlink" title="7.6.2 创建用户自定义的隔离的虚拟网络"></a>7.6.2 创建用户自定义的隔离的虚拟网络</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm252.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm253.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm254.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1 state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:ed brd ff:ff:ff:ff:ff:ff<br>4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>       valid_lft forever preferred_lft forever<br>5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>6: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:ed brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.201/24 brd 10.0.0.255 scope global noprefixroute virbr1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe29:f3ed/64 scope link <br>       valid_lft forever preferred_lft forever<br>18: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1 state UNKNOWN group default qlen 1000<br>    link/ether fe:54:00:09:53:ff brd ff:ff:ff:ff:ff:ff<br>    inet6 fe80::fc54:ff:fe09:53ff/64 scope link <br>       valid_lft forever preferred_lft forever<br>29: virbr2: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000<br>    link/ether 52:54:00:b6:0c:a6 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.100.1/24 brd 192.168.100.255 scope global virbr2<br>       valid_lft forever preferred_lft forever<br>30: virbr2-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr2 state DOWN group default qlen 1000<br>    link/ether 52:54:00:b6:0c:a6 brd ff:ff:ff:ff:ff:ff<br> <br>[root@centos8 ~]<span class="hljs-comment"># ip link show master virbr2</span><br>30: virbr2-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr2 state DOWN mode DEFAULT group default qlen 1000<br>    link/ether 52:54:00:b6:0c:a6 brd ff:ff:ff:ff:ff:ff<br>[root@centos8 ~]<span class="hljs-comment"># bridge link show</span><br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr1 state forwarding priority 32 cost 100 <br>5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled priority 32 cost 100 <br>30: virbr2-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr2 state disabled priority 32 cost 100<br><br><span class="hljs-comment">#查看网络</span><br>[root@centos8 ~]<span class="hljs-comment"># virsh net-list</span><br> Name       State    Autostart   Persistent<br>---------------------------------------------<br> default    active   yes         yes<br> rlin-net   active   yes         yes<br></code></pre></td></tr></table></figure>

<h3 id="7-6-3-修改虚拟机的网卡使用创建的隔离网络"><a href="#7-6-3-修改虚拟机的网卡使用创建的隔离网络" class="headerlink" title="7.6.3 修改虚拟机的网卡使用创建的隔离网络"></a>7.6.3 修改虚拟机的网卡使用创建的隔离网络</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm255.png" srcset="/blog/img/loading.gif"></p>
<p>修改第二个虚拟机也使用一样的网络</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm256.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-6-4-验证自定义的隔离网络主机之间通信"><a href="#7-6-4-验证自定义的隔离网络主机之间通信" class="headerlink" title="7.6.4 验证自定义的隔离网络主机之间通信"></a>7.6.4 验证自定义的隔离网络主机之间通信</h3><p>建议先重启后在ping</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm257.png" srcset="/blog/img/loading.gif"></p>
<h3 id="7-6-5-宿主机查看桥接关系"><a href="#7-6-5-宿主机查看桥接关系" class="headerlink" title="7.6.5 宿主机查看桥接关系"></a>7.6.5 宿主机查看桥接关系</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># bridge  link show</span><br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr1 state forwarding priority 32 cost 100 <br>5: virbr2-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr2 state disabled priority 32 cost 100 <br>30: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled priority 32 cost 100 <br>31: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr2 state forwarding priority 32 cost 100 <br>32: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr2 state forwarding priority 32 cost 100<br></code></pre></td></tr></table></figure>



<h1 id="八、实战案例"><a href="#八、实战案例" class="headerlink" title="八、实战案例"></a>八、实战案例</h1><h2 id="8-1-连接NAS共享存储实现虚拟机实时迁移"><a href="#8-1-连接NAS共享存储实现虚拟机实时迁移" class="headerlink" title="8.1 连接NAS共享存储实现虚拟机实时迁移"></a>8.1 连接NAS共享存储实现虚拟机实时迁移</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm258.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">环境: 三台主机</span><br><br>两台KVM宿主机<br>一台CentOS8 10.0.0.8<br>一台CentOS7 10.0.0.7<br><br><span class="hljs-section">一台NFS服务器: CentOS8 10.0.0.18</span><br><br><span class="hljs-comment">#注意:</span><br>两台宿主机的虚拟机都要一样的网卡配置,都事先实现virbr1的桥接<br>要迁移的虚拟机必须是运行状态才可以迁移<br><span class="hljs-section">建议从低版本向高版本的宿主机迁移,如:将CentOS7宿主机虚拟机迁移到CentOS8的宿主机上,反之可能失败</span><br></code></pre></td></tr></table></figure>

<p>第一台KVM宿主机虚拟机</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm259.png" srcset="/blog/img/loading.gif"></p>
<p>第二台KVM宿主机虚拟机</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm260.png" srcset="/blog/img/loading.gif"></p>
<p>第一台宿主机的虚拟机网络</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm261.png" srcset="/blog/img/loading.gif"></p>
<p>第二台宿主机的虚拟机网络</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm262.png" srcset="/blog/img/loading.gif"></p>
<p>将第二台宿主机的虚拟机迁移动到第一台宿主机上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#第一台宿主机的网络配置</span><br>[root@centos8 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1<br>state UP group default qlen 1000<br> link/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff<br>3: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP<br>group default qlen 1000<br> link/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute virbr1<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::b441:41ff:fed6:f6f3/64 scope link<br>   valid_lft forever preferred_lft forever<br>4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN<br>group default qlen 1000<br> link/ether 52:54:00:23:8b:86 brd ff:ff:ff:ff:ff:ff<br> inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>   valid_lft forever preferred_lft forever<br>5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state<br>DOWN group default qlen 1000<br> link/ether 52:54:00:23:8b:86 brd ff:ff:ff:ff:ff:ff<br> 8: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master<br>virbr1 state UNKNOWN group default qlen 1000<br> link/ether fe:54:00:9c:9a:88 brd ff:ff:ff:ff:ff:ff<br> inet6 fe80::fc54:ff:fe9c:9a88/64 scope link<br>   valid_lft forever preferred_lft forever<br>10: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master<br>virbr1 state UNKNOWN group default qlen 1000<br> link/ether fe:54:00:5b:ab:6e brd ff:ff:ff:ff:ff:ff<br> inet6 fe80::fc54:ff:fe5b:ab6e/64 scope link<br>   valid_lft forever preferred_lft forever<br>   <br>   <span class="hljs-comment">#第二台宿主机的网络配置</span><br>[root@centos7 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master<br>virbr1 state UP group default qlen 1000<br> link/ether 00:0c:29:01:f9:48 brd ff:ff:ff:ff:ff:ff<br>3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN<br>group default qlen 1000<br> link/ether 52:54:00:83:1f:cb brd ff:ff:ff:ff:ff:ff<br> inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>   valid_lft forever preferred_lft forever<br>4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0<br>state DOWN group default qlen 1000<br> link/ether 52:54:00:83:1f:cb brd ff:ff:ff:ff:ff:ff<br>8: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP<br>group default qlen 1000<br> link/ether 00:0c:29:01:f9:48 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute virbr1<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe01:f948/64 scope link<br>   valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<h3 id="8-2-1-先实现NFS服务"><a href="#8-2-1-先实现NFS服务" class="headerlink" title="8.2.1 先实现NFS服务"></a>8.2.1 先实现NFS服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install nfs-utils</span><br>[root@centos8 ~]<span class="hljs-comment"># mkdir /data/kvmdata</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /etc/exports</span><br>/data/kvmdata *(rw,no_root_squash)<br><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable --now nfs-server.service</span><br></code></pre></td></tr></table></figure>

<h3 id="8-2-2-在宿主机的磁盘文件从目录中移到临时目录"><a href="#8-2-2-在宿主机的磁盘文件从目录中移到临时目录" class="headerlink" title="8.2.2 在宿主机的磁盘文件从目录中移到临时目录"></a>8.2.2 在宿主机的磁盘文件从目录中移到临时目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># mv /var/lib/libvirt/images/* /opt</span><br>[root@centos7 ~]<span class="hljs-comment"># mv /var/lib/libvirt/images/* /opt</span><br></code></pre></td></tr></table></figure>

<h3 id="8-2-3-在两台宿主机都实现存储"><a href="#8-2-3-在两台宿主机都实现存储" class="headerlink" title="8.2.3 在两台宿主机都实现存储"></a>8.2.3 在两台宿主机都实现存储</h3><h4 id="8-2-3-1-在第一台宿主机实现"><a href="#8-2-3-1-在第一台宿主机实现" class="headerlink" title="8.2.3.1 在第一台宿主机实现"></a>8.2.3.1 在第一台宿主机实现</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm263.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm264.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm265.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm266.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># df</span><br>Filesystem               1K-blocks      Used Available Use% Mounted on<br>devtmpfs                   4050832         0   4050832   0% /dev<br>tmpfs                      4067612         0   4067612   0% /dev/shm<br>tmpfs                      4067612      9316   4058296   1% /run<br>tmpfs                      4067612         0   4067612   0% /sys/fs/cgroup<br>/dev/sda2                104806400   6816776  97989624   7% /<br>/dev/sda3                 52403200   3136576  49266624   6% /data<br>/dev/sda1                   999320    120528    809980  13% /boot<br>tmpfs                       813520         8    813512   1% /run/user/0<br>10.0.0.18:/data/kvmdata   52403200    398336  52004864   1% /var/lib/libvirt/images<br></code></pre></td></tr></table></figure>

<h4 id="8-2-3-2-在第二台宿主机实现"><a href="#8-2-3-2-在第二台宿主机实现" class="headerlink" title="8.2.3.2 在第二台宿主机实现"></a>8.2.3.2 在第二台宿主机实现</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm267.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm268.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm269.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm270.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-2-4-将原有磁盘文件从临时目录移回原目录"><a href="#8-2-4-将原有磁盘文件从临时目录移回原目录" class="headerlink" title="8.2.4 将原有磁盘文件从临时目录移回原目录"></a>8.2.4 将原有磁盘文件从临时目录移回原目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># mv /opt/centos8* /var/lib/libvirt/images/</span><br>[root@centos7 ~]<span class="hljs-comment"># mv /opt/centos7.qcow2 /var/lib/libvirt/images/</span><br>[root@centos8 ~]<span class="hljs-comment"># ll /var/lib/libvirt/images/</span><br>total 5724996<br>-rw-r--r-- 1 root root 1688731648 Aug 11 10:03 centos7.qcow2<br>-rw-r--r-- 1 root root 2081947648 Aug 11 09:38 centos8-2.qcow2<br>-rw-r--r-- 1 root root 2091712512 Aug 11 09:26 centos8.qcow2<br></code></pre></td></tr></table></figure>

<h3 id="8-2-5-在第一台宿主机连接到第二台宿主机"><a href="#8-2-5-在第一台宿主机连接到第二台宿主机" class="headerlink" title="8.2.5 在第一台宿主机连接到第二台宿主机"></a>8.2.5 在第一台宿主机连接到第二台宿主机</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm271.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm272.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm273.png" srcset="/blog/img/loading.gif"></p>
<p>在第一台宿主机安装相关软件包或配置基于Key验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install openssh-askpass</span><br></code></pre></td></tr></table></figure>

<p>再次连接,可以看到提示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm274.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm275.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm276.png" srcset="/blog/img/loading.gif"></p>
<h3 id="8-2-6-进行迁移"><a href="#8-2-6-进行迁移" class="headerlink" title="8.2.6 进行迁移"></a>8.2.6 进行迁移</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm277.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm278.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm279.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm280.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm281.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm282.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm283.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#可以看到迁移过来的虚拟机文件已经被移动到目标宿主机</span><br>[root@centos8 ~]<span class="hljs-comment"># tree /etc/libvirt/qemu</span><br>/etc/libvirt/qemu<br>├── autostart<br>│  ├── centos8-2.xml -&gt; /etc/libvirt/qemu/centos8-2.xml<br>│  └── centos8.xml -&gt; /etc/libvirt/qemu/centos8.xml<br>├── centos7.xml<br>├── centos8-2.xml<br>├── centos8.xml<br>└── networks<br> ├── autostart<br> │  └── default.xml -&gt; ../default.xml<br> └── default.xml<br><br>3 directories, 7 files<br><br><span class="hljs-comment">#在源宿主机虚拟机文件被删除</span><br>[root@centos7 ~]<span class="hljs-comment"># tree /etc/libvirt/qemu</span><br>/etc/libvirt/qemu<br>├── autostart<br>└── networks<br> ├── autostart<br> │  └── default.xml -&gt; ../default.xml<br> └── default.xml<br><br>3 directories, 2 files<br></code></pre></td></tr></table></figure>

<h3 id="8-2-7-再迁移回来"><a href="#8-2-7-再迁移回来" class="headerlink" title="8.2.7 再迁移回来"></a>8.2.7 再迁移回来</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4<br>centos8.wangxiaochun.com<br>::1     localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.0.0.7 centos7.wangxiaochun.com<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm284.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm285.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm286.png" srcset="/blog/img/loading.gif"></p>
<p><strong>将CentOS8 的虚拟移到CentOS7 是会报错</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm287.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm288.png" srcset="/blog/img/loading.gif"></p>
<h2 id="8-2-内外网络隔离综合案例"><a href="#8-2-内外网络隔离综合案例" class="headerlink" title="8.2 内外网络隔离综合案例"></a>8.2 内外网络隔离综合案例</h2><p>实现一个外网的web服务和内网的数据库相互隔离的环境</p>
<p>两台宿主机host1和host2</p>
<p>每个宿主机上面各有两个虚拟机,分别连接外网和内网交换机</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/kvm/kvm289.png" srcset="/blog/img/loading.gif"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/linux-kvm/">linux kvm</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93Redis/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">企业级NoSQL数据库Redis</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4Keepalived/">
                        <span class="hidden-mobile">高可用性集群keepalived</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
