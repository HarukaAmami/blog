

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>ELK - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="ELK">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-02 14:33" pubdate>
        2021年9月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      18.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      291
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ELK</h1>
            
            <div class="markdown-body">
              <h1 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h1><h1 id="一、ELK介绍"><a href="#一、ELK介绍" class="headerlink" title="一、ELK介绍"></a>一、ELK介绍</h1><h2 id="1-1-什么是ELK"><a href="#1-1-什么是ELK" class="headerlink" title="1.1 什么是ELK"></a>1.1 什么是ELK</h2><p>通俗来讲，ELK 是由 Elasticsearch、Logstash、Kibana 三个开源软件的组成的 一个组合体，ELK 是 elastic 公司研发的一套完整的日志收集、分析和展示的企业 级解决方案，在这三个软件当中，每个软件用于完成不同的功能，ELK 又称为 ELK  stack，官方域名为 elastic.co，ELK stack 的主要优点有如下几个： </p>
<p>处理方式灵活： elasticsearch 是实时全文索引，具有强大的搜索功能 </p>
<p>配置相对简单：elasticsearch的API全部使用JSON接口，logstash使用模块配置，kibana的配置文件部分更简单。 </p>
<p>检索性能高效：基于优秀的设计，虽然每次查询都是实时，但是也可以达到百 亿级数据的查询秒级响应。 </p>
<p>集群线性扩展：elasticsearch 和 logstash 都可以灵活线性扩展 </p>
<p>前端操作绚丽：kibana 的前端设计比较绚丽，而且操作简单</p>
<h2 id="1-2-什么是Elasticsearch"><a href="#1-2-什么是Elasticsearch" class="headerlink" title="1.2 什么是Elasticsearch"></a>1.2 什么是Elasticsearch</h2><p>是一个高度可扩展的开源全文搜索和分析引擎，它可实现数据的实时全文搜索、支持分布式可实现高可用、提供 API 接口，可以处理大规模日志数据，比如 Nginx、Tomcat、系统日志等功能。</p>
<p>Elasticsearch 使用 Java 语言开发，是建立在全文搜索引擎 Apache Lucene 基础之上的搜索引擎，<a target="_blank" rel="noopener" href="https://lucene.apache.org/%E3%80%82">https://lucene.apache.org/。</a><br>Elasticsearch 的特点：</p>
<ol>
<li>实时搜索、实时分析</li>
<li>分布式架构、实时文件存储</li>
<li>文档导向，所有对象都是文档</li>
<li>高可用，易扩展，支持集群，分片与复制</li>
<li>接口友好，支持 json</li>
</ol>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk123.png" srcset="/blog/img/loading.gif"></p>
<h2 id="1-3-什么是Logstash"><a href="#1-3-什么是Logstash" class="headerlink" title="1.3 什么是Logstash"></a>1.3 什么是Logstash</h2><p>Logstash 是一个具有实时传输能力的数据收集引擎，其可以通过插件实现日志收集和转发，支持日志过滤，支持普通 log、自定义 json 格式的日志解析，最终把经过处理的日志发送给 elasticsearch。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk124.png" srcset="/blog/img/loading.gif"></p>
<h2 id="1-4-什么是Kibana"><a href="#1-4-什么是Kibana" class="headerlink" title="1.4 什么是Kibana"></a>1.4 什么是Kibana</h2><p>Kibana 为 elasticsearch 提供一个查看数据的 web 界面，其主要是通过elasticsearch 的 API 接口进行数据查找，并进行前端数据可视化的展现，另外还可以针对特定格式的数据生成相应的表格、柱状图、饼图等。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk125.png" srcset="/blog/img/loading.gif"></p>
<h2 id="1-5-为什么使用ELK"><a href="#1-5-为什么使用ELK" class="headerlink" title="1.5 为什么使用ELK"></a>1.5 为什么使用ELK</h2><p>ELK 组件在海量日志系统的运维中，可用于解决以下主要问题：</p>
<ul>
<li>分布式日志数据统一收集，实现集中式查询和管理</li>
<li>故障排查</li>
<li>安全信息和事件管理</li>
<li>报表功能</li>
</ul>
<h2 id="1-6-ELK的好处"><a href="#1-6-ELK的好处" class="headerlink" title="1.6 ELK的好处"></a>1.6 ELK的好处</h2><p>ELK 组件在大数据运维系统中，主要可解决的问题如下：</p>
<ul>
<li>日志查询，问题排查，故障恢复，故障自愈</li>
<li>应用日志分析，错误报警</li>
<li>性能分析，用户行为分析</li>
</ul>
<h2 id="1-7-谁再使用ELK"><a href="#1-7-谁再使用ELK" class="headerlink" title="1.7 谁再使用ELK"></a>1.7 谁再使用ELK</h2><p>使用场景</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk126.png" srcset="/blog/img/loading.gif"></p>
<p>通常情况下，一个业务一套负载均衡，一套mysql，一套redis集群，一套ES集群，都是分开的。除非没有服务器。并且不能长时间混用，一旦出现问题，那么影响就会很大。</p>
<h1 id="二、Elasticsearch部署"><a href="#二、Elasticsearch部署" class="headerlink" title="二、Elasticsearch部署"></a>二、Elasticsearch部署</h1><p><a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch">https://github.com/elastic/elasticsearch</a> #基于 java 开发</p>
<p><strong>环境规划</strong></p>
<table>
<thead>
<tr>
<th>hostname</th>
<th>ip</th>
<th>安装软件</th>
</tr>
</thead>
<tbody><tr>
<td>es-node1</td>
<td>172.31.2.101</td>
<td>elasticsearch-7.6.2,kibana-7.6.2</td>
</tr>
<tr>
<td>es-node2</td>
<td>172.31.2.102</td>
<td>elasticsearch-7.6.2</td>
</tr>
<tr>
<td>es-node3</td>
<td>172.31.2.103</td>
<td>elasticsearch-7.6.2</td>
</tr>
<tr>
<td>log-node1</td>
<td>172.31.2.104</td>
<td>logstash,jdk,tomcat-8.5.43,nginx-1.16.1,filebeat</td>
</tr>
<tr>
<td>log-node2</td>
<td>172.31.2.105</td>
<td>logstash,jdk,tomcat-8.5.43,nginx-1.16.1,filebeat</td>
</tr>
<tr>
<td>redis</td>
<td>172.31.2.106</td>
<td>redis</td>
</tr>
</tbody></table>
<h2 id="2-1-环境初始化"><a href="#2-1-环境初始化" class="headerlink" title="2.1 环境初始化"></a>2.1 环境初始化</h2><p>最小化安装 Centos 7.x/Ubuntu x86_64 操作系统的虚拟机，vcpu 2，内存 4G 或更多，操作系统盘 100G ，主机名设置规则为 es-nodex ，其中node1,node2,node3 为elasticsearch 服务器，为保证效果特额外添加一块单独的数据磁盘大小为 50G 并格式化挂载到/data。</p>
<h3 id="2-1-1-主机名和磁盘挂载"><a href="#2-1-1-主机名和磁盘挂载" class="headerlink" title="2.1.1 主机名和磁盘挂载"></a>2.1.1 主机名和磁盘挂载</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#es各机配置自己的主机名</span><br><span class="hljs-comment"># hostnamectl set-hostname es-node1</span><br><br><span class="hljs-comment"># vim /etc/security/limits.conf</span><br>..... <span class="hljs-comment">#添加以下内容，然后关机</span><br>elasticsearch soft core unlimited<br>elasticsearch hard core unlimited<br>elasticsearch soft nproc 1000000<br>elasticsearch hard nproc 1000000<br>elasticsearch soft nofile 1000000<br>elasticsearch hard nofile 1000000<br>elasticsearch soft memlock 32000<br>elasticsearch hard memlock 32000<br>elasticsearch soft msgqueue 8192000<br>elasticsearch hard msgqueue 8192000<br><br><span class="hljs-comment"># init 0</span><br></code></pre></td></tr></table></figure>

<p><strong>添加一个100G的磁盘，然后开机</strong></p>
<p>注意：将虚拟磁盘存储为单个文件</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk1.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#格式化新加的磁盘</span><br><span class="hljs-comment"># mkfs.xfs /dev/sdb</span><br><span class="hljs-comment"># mkdir -p /data/esdata/&#123;data,logs&#125;</span><br><span class="hljs-comment">#最好使用UUID挂载</span><br><span class="hljs-comment"># vim /etc/fstab</span><br>/dev/sdb /data/esdata xfs defaults 0 0<br><span class="hljs-comment"># mount -a</span><br><span class="hljs-comment">#查看是否能挂载上</span><br><span class="hljs-comment"># df -TH </span><br></code></pre></td></tr></table></figure>

<h3 id="2-1-2-防火墙和selinux"><a href="#2-1-2-防火墙和selinux" class="headerlink" title="2.1.2 防火墙和selinux"></a>2.1.2 防火墙和selinux</h3><p>关闭防所有服务器的火墙和 selinux，包括 web 服务器、redis 和 logstash 服务器的防火墙和 selinux 全部关闭，此步骤是为了避免出现因为防火墙策略或 selinux 安全权限引起的各种未知问题 ，以下只显示命令，但是其他服务器都要执行 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl disable firewalld</span><br><br><span class="hljs-comment"># systemctl disable NetworkManager</span><br><br><span class="hljs-comment"># sed -i &#x27;/SELINUX/s/enforcing/disabled/&#x27; /etc/selinux/config</span><br> <br><span class="hljs-comment"># echo &quot;* soft nofile 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br><br><span class="hljs-comment"># echo &quot;* hard nofile 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br></code></pre></td></tr></table></figure>

<h3 id="2-1-3-各服务器配置本地域名解析"><a href="#2-1-3-各服务器配置本地域名解析" class="headerlink" title="2.1.3 各服务器配置本地域名解析"></a>2.1.3 各服务器配置本地域名解析</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/hosts</span><br>172.31.2.101 es-node1<br>172.31.2.102 es-node2<br>172.31.2.103 es-node3<br>172.31.2.104 log-node1<br>172.31.2.105 log-node2<br>172.31.2.106 <br>172.31.2.107<br>172.31.2.108<br>172.31.2.109<br></code></pre></td></tr></table></figure>

<h3 id="2-1-4-设置epel-apt源、安装基本操作命令并同步时间"><a href="#2-1-4-设置epel-apt源、安装基本操作命令并同步时间" class="headerlink" title="2.1.4 设置epel/apt源、安装基本操作命令并同步时间"></a>2.1.4 设置epel/apt源、安装基本操作命令并同步时间</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#centos7.x</span><br><span class="hljs-comment"># yum install -y net-tools vim lrzsz tree screen lsof tcpdump wget ntpdate</span><br><br><span class="hljs-comment"># cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><br><span class="hljs-comment"># echo &quot;*/5 * * * * ntpdate time1.aliyun.com &amp;&gt; /dev/null &amp;&amp; hwclock -w&quot; &gt;&gt; /var/spool/cron/root</span><br><br><span class="hljs-comment"># systemctl restart crond</span><br><br><span class="hljs-comment"># # reboot #重启检查各项配置是否生效，没有问题的话给虚拟机做快照以方便后期还原</span><br><br><span class="hljs-comment"># ubuntu</span><br><br></code></pre></td></tr></table></figure>

<h2 id="2-2-在三台主机分别安装Elasticsearch"><a href="#2-2-在三台主机分别安装Elasticsearch" class="headerlink" title="2.2 在三台主机分别安装Elasticsearch"></a>2.2 在三台主机分别安装Elasticsearch</h2><p><a target="_blank" rel="noopener" href="https://github.com/elastic">https://github.com/elastic</a> #github 地址</p>
<h3 id="2-2-1-在三台服务器准备java环境"><a href="#2-2-1-在三台服务器准备java环境" class="headerlink" title="2.2.1 在三台服务器准备java环境"></a>2.2.1 在三台服务器准备java环境</h3><p><strong>注意：新版本的elasticsearch有包含jdk的安装包，也有不包含jdk的安装包，所以不是一定要安装jdk</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sh">方式一：使用yum/apt直接安装<br><span class="hljs-comment">#centos7.x</span><br><span class="hljs-comment"># yum install -y java-1.8.0*</span><br><br><span class="hljs-comment">#ubuntu</span><br><span class="hljs-comment"># apt install -y openjdk-8-jdk</span><br><br>方式二：本地安装oracle下载的rpm/deb包<br><span class="hljs-comment">#centos7.x</span><br><span class="hljs-comment"># yum localinstall jdk-8u9x-linux-x64.rpm</span><br><br>方式三：下载二进制包自定义 profile 环境变量<br><span class="hljs-comment"># tar xvf jdk-8u121-linux-x64.tar.gz -C /usr/local/</span><br><span class="hljs-comment"># ln -sv /usr/local/jdk1.8.0_121 /usr/local/jdk</span><br><span class="hljs-comment"># ln -sv /usr/local/jdk/bin/java /usr/bin/</span><br><span class="hljs-comment">#  vim /etc/profile</span><br><span class="hljs-built_in">export</span> HISTTIMEFORMAT=<span class="hljs-string">&quot;%F %T `whoami` &quot;</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/dt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin<br><span class="hljs-comment"># source /etc/profile</span><br><span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_121&quot;</span> <span class="hljs-comment">#确认可以出现当前的 java 版本号</span><br>Java(TM) SE Runtime Environment (build 1.8.0_121-b13)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)<br></code></pre></td></tr></table></figure>

<h2 id="2-3-官方下载Elasticsearch并安装"><a href="#2-3-官方下载Elasticsearch并安装" class="headerlink" title="2.3 官方下载Elasticsearch并安装"></a>2.3 官方下载Elasticsearch并安装</h2><p>ES官方地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></p>
<p>清华源地址：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/elasticstack/">https://mirrors.tuna.tsinghua.edu.cn/elasticstack/</a></p>
<h3 id="2-3-1-三台服务器分别安装Elasticsearch"><a href="#2-3-1-三台服务器分别安装Elasticsearch" class="headerlink" title="2.3.1 三台服务器分别安装Elasticsearch"></a>2.3.1 三台服务器分别安装Elasticsearch</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#centos</span><br><span class="hljs-comment"># yum localinstall -y elasticsearch-7.6.2.rpm</span><br><br><span class="hljs-comment">#ubuntu</span><br><span class="hljs-comment">#下载elk包</span><br><span class="hljs-comment"># cd /usr/local/src </span><br><span class="hljs-comment"># ls </span><br>elasticsearch-7.6.2-amd64.deb<br><br><span class="hljs-comment"># dpkg -i elasticsearch-7.6.2-amd64.deb</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-2-编辑各Elasticsearch服务器的服务配置文件"><a href="#2-3-2-编辑各Elasticsearch服务器的服务配置文件" class="headerlink" title="2.3.2 编辑各Elasticsearch服务器的服务配置文件"></a>2.3.2 编辑各Elasticsearch服务器的服务配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ll /etc/elasticsearch</span><br>total 52<br>drwxr-s---  2 root elasticsearch  4096 Aug 22 20:35 ./<br>drwxr-xr-x 91 root root           4096 Aug 22 20:35 ../<br>-rw-rw----  1 root elasticsearch   199 Aug 22 20:35 elasticsearch.keystore<br>-rw-r--r--  1 root elasticsearch    76 Aug 22 20:35 .elasticsearch.keystore.initial_md5sum<br>-rw-rw----  1 root elasticsearch  2847 Mar 26  2020 elasticsearch.yml<br>-rw-rw----  1 root elasticsearch  2373 Mar 26  2020 jvm.options<br>-rw-rw----  1 root elasticsearch 17545 Mar 26  2020 log4j2.properties<br>-rw-rw----  1 root elasticsearch   473 Mar 26  2020 role_mapping.yml<br>-rw-rw----  1 root elasticsearch   197 Mar 26  2020 roles.yml<br>-rw-rw----  1 root elasticsearch     0 Mar 26  2020 users<br>-rw-rw----  1 root elasticsearch     0 Mar 26  2020 users_roles<br><br><span class="hljs-comment"># https://www.ibm.com/docs/zh/bpm/8.5.6?topic=service-elasticsearch-configuration-properties</span><br><span class="hljs-comment">#三台主机都要修改</span><br><span class="hljs-comment"># vim /etc/elasticsearch/elasticsearch.yml #创建集群必须修改此文件</span><br>cluster.name: rlin-es-cluster <span class="hljs-comment">#ELK 的集群名称，名称相同即属于是同一个集群</span><br>node.name: node-1 <span class="hljs-comment">#当前节点在集群内的节点名称</span><br>path.data: /data/esdata/data <span class="hljs-comment">#ES 数据保存目录</span><br>path.logs: /data/esdata/logs <span class="hljs-comment">#ES 日志保存目</span><br>bootstrap.memory_lock: <span class="hljs-literal">true</span> <span class="hljs-comment">#服务启动的时候锁定足够内存，防止数据写入swap</span><br>network.host: 0.0.0.0 <span class="hljs-comment">#监听IP</span><br>http.port: 9200 <span class="hljs-comment">#监听端口</span><br><span class="hljs-comment">#集群中node节点发现列表</span><br>discovery.seed_hosts: [<span class="hljs-string">&quot;172.31.2.101&quot;</span>,<span class="hljs-string">&quot;172.31.2.102&quot;</span>,<span class="hljs-string">&quot;172.31.2.103&quot;</span>]<br><span class="hljs-comment">#集群初始化哪些节点被选举为master</span><br>cluster,initial_master_nodes: [<span class="hljs-string">&quot;172.31.2.101&quot;</span>,<span class="hljs-string">&quot;172.31.2.102&quot;</span>,<span class="hljs-string">&quot;172.31.2.103&quot;</span>]<br><span class="hljs-comment">#一个集群中的N个节点启动后，才允许进行数据恢复处理，默认是一。但是一般都设置为集群服务器数量的一半向上取整</span><br>gateway.recover_after_nodes: 2<br><span class="hljs-comment">#设置是否可以通过正则或者_all删除或者关闭索引，默认true表示必须需要显示指定索引库名称，生产环境建议设置为true，删除索引库的时候必须指定，否则可能会误删索引库中的索引。</span><br>action.destruction_requires_name:<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-3-修改内存限制，并同步配置文件"><a href="#2-3-3-修改内存限制，并同步配置文件" class="headerlink" title="2.3.3 修改内存限制，并同步配置文件"></a>2.3.3 修改内存限制，并同步配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/elasticsearch/jvm.options #修改最小和最大内存限制，官方配置文档最带建议30G以内</span><br>-Xms2g<br>-Xmx2g<br><br><span class="hljs-comment">#早期版本在修改上文件后会重启失败，需要修改下面的配置</span><br><span class="hljs-comment">#vim /usr/lib/systemd/system/elasticsearch.service </span><br>LimitMEMLOCK=infinity <span class="hljs-comment">#添加，无限制使用内存</span><br><br><span class="hljs-comment">#内存锁定的配置参数：</span><br><span class="hljs-comment">#https://discuss.elastic.co/t/memory-lock-not-working/70576</span><br><br><span class="hljs-comment">#问题：为什么最小和最大内存设置一样大？</span><br><span class="hljs-comment">#https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-4-目录权限修改"><a href="#2-3-4-目录权限修改" class="headerlink" title="2.3.4 目录权限修改"></a>2.3.4 目录权限修改</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir /data/esdata/&#123;data.logs&#125; -p</span><br><span class="hljs-comment"># chown -R elasticsearch.elasticsearch /data/esdata</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-5-启动Elasticsearch服务并验证"><a href="#2-3-5-启动Elasticsearch服务并验证" class="headerlink" title="2.3.5 启动Elasticsearch服务并验证"></a>2.3.5 启动Elasticsearch服务并验证</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl start elasticsearch</span><br><span class="hljs-comment"># systemctl enable elasticsearch</span><br><span class="hljs-comment"># tail -f /data/esdata/logs/rlin-es-cluster.log#查看es是否能成功启动</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk3.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-3-6-验证端口监听成功"><a href="#2-3-6-验证端口监听成功" class="headerlink" title="2.3.6 验证端口监听成功"></a>2.3.6 验证端口监听成功</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ss -tnl #出现9200说明已经成功启动</span><br>State          Recv-Q          Send-Q                    Local Address:Port                      Peer Address:Port          <br>LISTEN         0               20480                                 *:9200                                 *:*             <br><span class="hljs-comment"># lsof -i:9200</span><br>COMMAND  PID          USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>java    1551 elasticsearch  301u  IPv6  35364      0t0  TCP *:9200 (LISTEN)<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk2.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-3-7-通过浏览器访问Elasticsearch服务端口"><a href="#2-3-7-通过浏览器访问Elasticsearch服务端口" class="headerlink" title="2.3.7 通过浏览器访问Elasticsearch服务端口"></a>2.3.7 通过浏览器访问Elasticsearch服务端口</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk4.png" srcset="/blog/img/loading.gif" alt="浏览器访问：ip:9200"></p>
<h2 id="2-4-安装Elasticsearch插件之head"><a href="#2-4-安装Elasticsearch插件之head" class="headerlink" title="2.4 安装Elasticsearch插件之head"></a>2.4 安装Elasticsearch插件之head</h2><p>插件是为了完成不同的功能，官方提供了一些插件但大部分是收费的，另外也有一些开发爱好者提供的插件，可以实现对 elasticsearch 集群的状态监控与管理配置等功能。</p>
<h3 id="2-4-1-安装5-x版本的head插件"><a href="#2-4-1-安装5-x版本的head插件" class="headerlink" title="2.4.1 安装5.x版本的head插件"></a>2.4.1 安装5.x版本的head插件</h3><p>在 elasticsearch 5.x 版本以后不再支持直接安装 head 插件，而是需要通过启动一个服务方式，git 地址：<a target="_blank" rel="noopener" href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y npm # NPM 的全称是 Node Package Manager，是随同 NodeJS 一起安装的包管理和分发工具，它很方便让 JavaScript 开发者下载、安装、上传以及管理已经安装的包。</span><br><span class="hljs-comment"># cd /usr/local/src/</span><br><span class="hljs-comment"># git clone git://github.com/mobz/elasticsearch-head.git</span><br><span class="hljs-comment"># cd elasticsearch-head/</span><br><span class="hljs-comment"># yum install npm -y</span><br><span class="hljs-comment"># npm install grunt -save</span><br><span class="hljs-comment"># ll node_modules/grunt #确认生成文件</span><br><span class="hljs-comment"># npm install #执行安装</span><br><span class="hljs-comment"># npm run start &amp; #后台启动服务</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk127.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-4-1-1-修改Elasticsearch服务配置文件"><a href="#2-4-1-1-修改Elasticsearch服务配置文件" class="headerlink" title="2.4.1.1 修改Elasticsearch服务配置文件"></a>2.4.1.1 修改Elasticsearch服务配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#哪个需要连接到哪个elasticsearch服务器就再哪个elasticsearch添加</span><br><span class="hljs-comment"># vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="hljs-comment">#添加以下内容</span><br>http.cors.enabled: <span class="hljs-literal">true</span>         <span class="hljs-comment">#开启支持跨域访问</span><br>http.cors.allow-origin: <span class="hljs-string">&quot;*&quot;</span>     <span class="hljs-comment">#指定允许访问范围</span><br><br><span class="hljs-comment"># systemctl restart elasticsearch</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-1-2-docker版本启动head插件"><a href="#2-4-1-2-docker版本启动head插件" class="headerlink" title="2.4.1.2 docker版本启动head插件"></a>2.4.1.2 docker版本启动head插件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim docker-install.sh</span><br><span class="hljs-comment">#!/bin.bash</span><br><span class="hljs-comment">#step 1: 安装必要的一些系统工具</span><br>sudo apt-get update<br>sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common<br><span class="hljs-comment">#step 2: 安装GPG证书</span><br>curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -<br><span class="hljs-comment">#Step 3: 写入软件源信息</span><br>sudo add-apt-repository <span class="hljs-string">&quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="hljs-subst">$(lsb_release -cs)</span> stable&quot;</span><br><span class="hljs-comment">#Step 4: 更新并安装Docker-CE</span><br>sudo apt-get -y update<br>sudo apt-get -y install docker-ce<br><br><span class="hljs-comment"># bash docker-install.sh</span><br><span class="hljs-comment"># 按需求修改docker配置文件</span><br><span class="hljs-comment"># systemctl start docker &amp;&amp; systemctl enable docker</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-1-3-Master与Slave的区别"><a href="#2-4-1-3-Master与Slave的区别" class="headerlink" title="2.4.1.3 Master与Slave的区别"></a>2.4.1.3 Master与Slave的区别</h4><h4 id="2-4-1-4-安装docker镜像"><a href="#2-4-1-4-安装docker镜像" class="headerlink" title="2.4.1.4 安装docker镜像"></a>2.4.1.4 安装docker镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># docker run -d -p 9100:9100 mobz/elasticsearch-head:5 #从地本地 docker images 启动</span><br></code></pre></td></tr></table></figure>

<p>浏览器访问<a target="_blank" rel="noopener" href="http://172.31.2.101:9100/">http://172.31.2.101:9100</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk5.png" srcset="/blog/img/loading.gif"></p>
<p><strong>由于宿主机内存不做，系统内核会将占用内润最大的进程强制kill掉，以保证系统正常运行以及其他服务的正常运行</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk128.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk129.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-4-2-Elasticsearch插件之kopf"><a href="#2-4-2-Elasticsearch插件之kopf" class="headerlink" title="2.4.2 Elasticsearch插件之kopf"></a>2.4.2 Elasticsearch插件之kopf</h3><h4 id="2-4-2-1-kopf"><a href="#2-4-2-1-kopf" class="headerlink" title="2.4.2.1 kopf"></a>2.4.2.1 kopf</h4><p>Git 地址为 <a target="_blank" rel="noopener" href="https://github.com/lmenezes/elasticsearch-kopf%EF%BC%8C%E4%BD%86%E6%98%AF%E7%9B%AE%E5%89%8D%E8%BF%98%E4%B8%8D%E6%94%AF%E6%8C%81">https://github.com/lmenezes/elasticsearch-kopf，但是目前还不支持</a> 5.x版本的 elasticsearch，但是可以安装在 elasticsearc 1.x 或 2.x 的版本安装。</p>
<h3 id="2-4-3-cerebro"><a href="#2-4-3-cerebro" class="headerlink" title="2.4.3 cerebro"></a>2.4.3 cerebro</h3><h4 id="2-4-3-1-安装cerbro"><a href="#2-4-3-1-安装cerbro" class="headerlink" title="2.4.3.1 安装cerbro"></a>2.4.3.1 安装cerbro</h4><p>新开源的 elasticsearch 集群 web 管理程序，需要 java1.8 或者更高版本，<a target="_blank" rel="noopener" href="https://github.com/lmenezes/cerebro">https://github.com/lmenezes/cerebro</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt update</span><br><br><span class="hljs-comment"># apt install -y openjdk-8-jdk #或者用oracle的jdk</span><br><br><span class="hljs-comment"># cd /usr/local/src</span><br><br><span class="hljs-comment"># wget https://github.com/lmenezes/cerebro/releases/download/v0.9.2/cerebro-0.9.2.tgz</span><br><br><span class="hljs-comment"># tar xf cerebro-0.9.2.tgz</span><br><br><span class="hljs-comment"># cd cerebro-0.9.2</span><br><br><span class="hljs-comment"># vim conf/application.conf</span><br>host = [<br><br>&#123;<br><br>host = <span class="hljs-string">&quot;http://172.31.2.101:9200&quot;</span><br><br>name = <span class="hljs-string">&quot;rlin-es-cluster1&quot;</span><br><br>......<br><br>&#125;<br><br>]<br><br><span class="hljs-comment"># ./bin/cerebro</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk6.png" srcset="/blog/img/loading.gif" alt="ip:9000"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk7.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-4-3-2-在cerebro创建index"><a href="#2-4-3-2-在cerebro创建index" class="headerlink" title="2.4.3.2 在cerebro创建index"></a>2.4.3.2 在cerebro创建index</h4><p>more–create index</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk8.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk9.png" srcset="/blog/img/loading.gif" alt="输入名称，分片数量，备份数量"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk10.png" srcset="/blog/img/loading.gif" alt="点击create"></p>
<p>创建成功</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk11.png" srcset="/blog/img/loading.gif"></p>
<p>在head插件查看结果</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk12.png" srcset="/blog/img/loading.gif"></p>
<p>在cerebro插件查看结果</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk13.png" srcset="/blog/img/loading.gif"></p>
<h2 id="2-5-监控Elasticsearch集群状态"><a href="#2-5-监控Elasticsearch集群状态" class="headerlink" title="2.5 监控Elasticsearch集群状态"></a>2.5 监控Elasticsearch集群状态</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_cluster_health.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/_cluster_health.html</a></p>
<h3 id="2-5-1-通过shell命令获取集群状态"><a href="#2-5-1-通过shell命令获取集群状态" class="headerlink" title="2.5.1 通过shell命令获取集群状态"></a>2.5.1 通过shell命令获取集群状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># curl -sXGET http://172.31.2.101:9200/_cluster/health?pretty=true</span><br>&#123;<br>  <span class="hljs-string">&quot;cluster_name&quot;</span> : <span class="hljs-string">&quot;rlin-es-cluster&quot;</span>,<br>  <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;green&quot;</span>,<br>  <span class="hljs-string">&quot;timed_out&quot;</span> : <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;number_of_nodes&quot;</span> : 3,<br>  <span class="hljs-string">&quot;number_of_data_nodes&quot;</span> : 3,<br>  <span class="hljs-string">&quot;active_primary_shards&quot;</span> : 1,<br>  <span class="hljs-string">&quot;active_shards&quot;</span> : 2,<br>  <span class="hljs-string">&quot;relocating_shards&quot;</span> : 0,<br>  <span class="hljs-string">&quot;initializing_shards&quot;</span> : 0,<br>  <span class="hljs-string">&quot;unassigned_shards&quot;</span> : 0,<br>  <span class="hljs-string">&quot;delayed_unassigned_shards&quot;</span> : 0,<br>  <span class="hljs-string">&quot;number_of_pending_tasks&quot;</span> : 0,<br>  <span class="hljs-string">&quot;number_of_in_flight_fetch&quot;</span> : 0,<br>  <span class="hljs-string">&quot;task_max_waiting_in_queue_millis&quot;</span> : 0,<br>  <span class="hljs-string">&quot;active_shards_percent_as_number&quot;</span> : 100.0<br>&#125;<br><br><span class="hljs-comment">#获取到的是一个 json 格式的返回值，那就可以通过 python 对其中的信息进行分析，例如对 status 进行分析，如果等于 green(绿色)就是运行在正常，等于yellow(黄色)表示副本分片丢失，red(红色)表示主分片丢失</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk14.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-5-2-python脚本"><a href="#2-5-2-python脚本" class="headerlink" title="2.5.2 python脚本"></a>2.5.2 python脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># cat els-cluster-monitor.py</span><br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br><br><span class="hljs-keyword">import</span> smtplib<br><span class="hljs-keyword">from</span> email.mime.text <span class="hljs-keyword">import</span> MIMEText<br><span class="hljs-keyword">from</span> email.utils <span class="hljs-keyword">import</span> formataddr<br><span class="hljs-keyword">import</span> subprocess<br>body = <span class="hljs-string">&quot;&quot;</span><br>false=<span class="hljs-string">&quot;false&quot;</span><br>obj = subprocess.Popen((<span class="hljs-string">&quot;curl -sXGET  http://172.31.2.101:9200/_cluster/health?pretty=true&quot;</span>),shell=<span class="hljs-literal">True</span>,stdout=subprocess.PIPE)<br>data = obj.stdout.read()<br>data1 = <span class="hljs-built_in">eval</span>(data)<br>status = data1.get(<span class="hljs-string">&quot;status&quot;</span>)<br><span class="hljs-keyword">if</span> status == <span class="hljs-string">&quot;green&quot;</span>:<br> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;50&quot;</span>)<br><span class="hljs-keyword">else</span>:<br> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;100&quot;</span>)<br></code></pre></td></tr></table></figure>

<h3 id="2-5-3-脚本执行结果"><a href="#2-5-3-脚本执行结果" class="headerlink" title="2.5.3 脚本执行结果"></a>2.5.3 脚本执行结果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># python els-cluster-monitor.py 或python3 els-cluster-monitor.py</span><br>50<br><span class="hljs-comment">#停止ES集群中的每个节点再次进行测试</span><br><span class="hljs-comment"># systemctl stop elasticsearch</span><br><span class="hljs-comment"># python ls-cluster-monitor.py</span><br>100<br></code></pre></td></tr></table></figure>

<h3 id="2-5-4-zabbix-添加监控"><a href="#2-5-4-zabbix-添加监控" class="headerlink" title="2.5.4 zabbix 添加监控"></a>2.5.4 zabbix 添加监控</h3><h1 id="三、部署Logstash环境及安装"><a href="#三、部署Logstash环境及安装" class="headerlink" title="三、部署Logstash环境及安装"></a>三、部署Logstash环境及安装</h1><h2 id="3-1-Lostash环境准备及安装"><a href="#3-1-Lostash环境准备及安装" class="headerlink" title="3.1 Lostash环境准备及安装"></a>3.1 Lostash环境准备及安装</h2><p>Logstash 是一个开源的数据收集引擎，可以水平伸缩，而且 logstash 整个 ELK当中拥有最多插件的一个组件，其可以接收来自不同来源的数据并统一输出到指定的且可以是多个不同目的地。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/elastic/logstash">https://github.com/elastic/logstash</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Ruby/11419">https://baike.baidu.com/item/Ruby/11419</a> #基于 ruby 开发</p>
<h3 id="3-1-1-环境准备"><a href="#3-1-1-环境准备" class="headerlink" title="3.1.1 环境准备"></a>3.1.1 环境准备</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#关闭防火墙和 selinux，并且安装 java 环境</span><br><span class="hljs-comment"># apt update</span><br><br><span class="hljs-comment"># apt install -y openjdk-8-jdk #或者用oracle的jdk</span><br></code></pre></td></tr></table></figure>

<h3 id="3-1-2-安装Logstash"><a href="#3-1-2-安装Logstash" class="headerlink" title="3.1.2 安装Logstash"></a>3.1.2 安装Logstash</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 下载并安装logstash</span><br><span class="hljs-comment"># cd /usr/local/src</span><br><br><span class="hljs-comment"># dpkg -c logstash-7.6.2.deb | grep /etc/logstash/</span><br>drwxrwxr-x 0/0               0 2020-03-26 16:54 ./etc/logstash/<br>-rw-r--r-- 0/0            2019 2020-03-26 16:51 ./etc/logstash/jvm.options <span class="hljs-comment">#logstash配置文件</span><br>drwxrwxr-x 0/0               0 2020-03-26 16:54 ./etc/logstash/conf.d/<br>-rw-r--r-- 0/0            8880 2020-03-26 16:51 ./etc/logstash/log4j2.properties<br>-rw-r--r-- 0/0             342 2020-03-26 16:51 ./etc/logstash/logstash-sample.conf<br>-rw-r--r-- 0/0            8834 2020-03-26 16:51 ./etc/logstash/logstash.yml<br>-rw-r--r-- 0/0             285 2020-03-26 16:51 ./etc/logstash/pipelines.yml<br>-rw-r--r-- 0/0            1696 2020-03-26 16:51 ./etc/logstash/startup.options<br><br><span class="hljs-comment"># dpkg -i logstash-7.6.2.deb</span><br><br><span class="hljs-comment"># chown logstash.logstash /usr/share/logstash/data/queue -R</span><br></code></pre></td></tr></table></figure>

<h2 id="3-2-测试Logstash"><a href="#3-2-测试Logstash" class="headerlink" title="3.2 测试Logstash"></a>3.2 测试Logstash</h2><h3 id="3-2-1-测试标准输入和输出"><a href="#3-2-1-测试标准输入和输出" class="headerlink" title="3.2.1 测试标准输入和输出"></a>3.2.1 测试标准输入和输出</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -e &#x27;input &#123; stdin&#123;&#125; &#125; output &#123; stdout&#123; codec =&gt; rubydebug &#125;&#125;&#x27; #标准输入和输出</span><br><br>...... <br><br>[INFO ] 2021-08-23 13:30:11.421 [Api Webserver] agent - Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;<br><br><span class="hljs-comment">#需要等带logstash开启</span><br><br>hello1<br>&#123;<br>       <span class="hljs-string">&quot;message&quot;</span> =&gt; <span class="hljs-string">&quot;hello1&quot;</span>,<br>    <span class="hljs-string">&quot;@timestamp&quot;</span> =&gt; 2021-08-23T05:30:25.223Z,<br>          <span class="hljs-string">&quot;host&quot;</span> =&gt; <span class="hljs-string">&quot;log-node1&quot;</span>,<br>      <span class="hljs-string">&quot;@version&quot;</span> =&gt; <span class="hljs-string">&quot;1&quot;</span><br>&#125;<br><br>hello2<br><br>hello1<br>&#123;<br>       <span class="hljs-string">&quot;message&quot;</span> =&gt; <span class="hljs-string">&quot;hello2&quot;</span>,<br>    <span class="hljs-string">&quot;@timestamp&quot;</span> =&gt; 2021-08-23T05:30:38.005Z,<br>          <span class="hljs-string">&quot;host&quot;</span> =&gt; <span class="hljs-string">&quot;log-node1&quot;</span>,<br>      <span class="hljs-string">&quot;@version&quot;</span> =&gt; <span class="hljs-string">&quot;1&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk15.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-2-2-测试输出到文件"><a href="#3-2-2-测试输出到文件" class="headerlink" title="3.2.2 测试输出到文件"></a>3.2.2 测试输出到文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#使用命令写数据</span><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -e &#x27;input &#123; stdin&#123;&#125; &#125; output &#123; file &#123; path =&gt; &quot;/tmp/rlin-log-%&#123;+YYYY.MM.dd&#125;.log&quot;&#125;&#125;&#x27;</span><br><br>......<br><br>[INFO ] 2021-08-23 13:32:51.219 [Api Webserver] agent - Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;<br>hello1<br>[INFO ] 2021-08-23 13:32:59.910 [[main]&gt;worker2] file - Opening file &#123;:path=&gt;<span class="hljs-string">&quot;/tmp/rlin-log-2021.08.23.log&quot;</span>&#125;<br>hello2<br>[INFO ] 2021-08-23 13:33:20.260 [[main]&gt;worker2] file - Closing file /tmp/rlin-log-2021.08.23.log<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk16.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#cat /tmp/rlin-log-2021.08.23.log </span><br><br>&#123;<span class="hljs-string">&quot;@timestamp&quot;</span>:<span class="hljs-string">&quot;2021-08-23T05:32:59.617Z&quot;</span>,<span class="hljs-string">&quot;@version&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;log-node1&quot;</span>,<span class="hljs-string">&quot;message&quot;</span>:<span class="hljs-string">&quot;hhello1&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;@timestamp&quot;</span>:<span class="hljs-string">&quot;2021-08-23T05:33:03.114Z&quot;</span>,<span class="hljs-string">&quot;@version&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;log-node1&quot;</span>,<span class="hljs-string">&quot;message&quot;</span>:<span class="hljs-string">&quot;hello2&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-3-测试输出到Elasticsearch"><a href="#3-2-3-测试输出到Elasticsearch" class="headerlink" title="3.2.3 测试输出到Elasticsearch"></a>3.2.3 测试输出到Elasticsearch</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/share/logstash/bin/logstash -e <span class="hljs-string">&#x27;input &#123; stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts =&gt;[&quot;172.31.2.101:9200&quot;] index =&gt; &quot;rlin-logstash-mytest-%&#123;+YYYY.MM.dd&#125;&quot; &#125;&#125;&#x27;</span><br><br>......<br><br>[INFO ] 2021-08-23 13:35:20.538 [Api Webserver] agent - Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;<br>hello1     <br><br>hello2<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk17.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#使用文件写数据</span><br><span class="hljs-comment"># vim /etc/logstash/conf.d/rlin-log-es.conf #文件名称为.conf</span><br><br>input &#123; <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/syslog&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>    &#125; <br>&#125; <br>output &#123; <br>    elasticsearch &#123;<br>        hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>        index =&gt; <span class="hljs-string">&quot;rlin-logstash-testindex-%&#123;+YYYY.MM.dd&#125;&quot;</span> <br>    &#125;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/tmp/rlin-logstash-testindex.logt-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#测试文件语法</span><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rlin-log-es.conf -t </span><br>WARNING: Could not find logstash.yml <span class="hljs-built_in">which</span> is typically located <span class="hljs-keyword">in</span> <span class="hljs-variable">$LS_HOME</span>/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults<br>Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config <span class="hljs-built_in">which</span> logs errors to the console<br>[WARN ] 2021-08-23 14:17:40.441 [LogStash::Runner] multilocal - Ignoring the <span class="hljs-string">&#x27;pipelines.yml&#x27;</span> file because modules or <span class="hljs-built_in">command</span> line options are specified<br>[INFO ] 2021-08-23 14:17:41.296 [LogStash::Runner] Reflections - Reflections took 37 ms to scan 1 urls, producing 20 keys and 40 values <br>Configuration OK<br>[INFO ] 2021-08-23 14:17:41.888 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash<br><br><span class="hljs-comment">#以进程的方式启动文件，在执行之后还可以通过标准输入来写入数据</span><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rlin-log-es.conf</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk18.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-2-4-Elasticsearch服务器验证收到数据"><a href="#3-2-4-Elasticsearch服务器验证收到数据" class="headerlink" title="3.2.4 Elasticsearch服务器验证收到数据"></a>3.2.4 Elasticsearch服务器验证收到数据</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ll /data/esdata/data/nodes/0/indices/</span><br>total 0<br>drwxr-xr-x 4 elasticsearch elasticsearch 66 Aug 23 14:17 ./<br>drwxr-xr-x 4 elasticsearch elasticsearch 52 Aug 23 13:53 ../<br>drwxr-xr-x 4 elasticsearch elasticsearch 29 Aug 23 14:17 3eEs6BNbSda8t7sfcYIEZA/<br>drwxr-xr-x 4 elasticsearch elasticsearch 29 Aug 23 13:53 kFjAGm1PTeWrlHFXd6Zg1g/<br></code></pre></td></tr></table></figure>

<p><strong>早期的 elasticsearch，如 1.X 和 2.X 直接显示 index 的名称</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk130.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-2-5-logstash注意点"><a href="#3-2-5-logstash注意点" class="headerlink" title="3.2.5 logstash注意点"></a>3.2.5 logstash注意点</h3><ol>
<li>logstash在使用input的时候可能会因为（有肯能是日志）文件的权限问题而被拒绝。<ul>
<li>解决办法1：将文件权限改为644</li>
<li>解决办法2：将logstash改为root或有权限的用户启动</li>
</ul>
</li>
</ol>
<h1 id="四、Kibana部署及日志收集"><a href="#四、Kibana部署及日志收集" class="headerlink" title="四、Kibana部署及日志收集"></a>四、Kibana部署及日志收集</h1><p>Kibana 是一款开源的数据分析和可视化平台，它是 Elastic Stack 成员之一，设计用于和 Elasticsearch 协作,可以使用 Kibana 对 Elasticsearch 索引中的数据进行搜索、查看、交互操作,您可以很方便的利用图表、表格及地图对数据进行多元化的分析和呈现。<br><a target="_blank" rel="noopener" href="https://github.com/elastic/kibana">https://github.com/elastic/kibana</a><br><a target="_blank" rel="noopener" href="https://typescript.bootcss.com/">https://typescript.bootcss.com/</a> #目前基于 TypeScript 语言开发</p>
<p>Kibana 可以使大数据通俗易懂。它很简单，基于浏览器的界面便于您快速创建和分享动态数据仪表板来追踪 Elasticsearch 的实时数据变化。</p>
<h2 id="4-1-安装并配置Kibana"><a href="#4-1-安装并配置Kibana" class="headerlink" title="4.1 安装并配置Kibana"></a>4.1 安装并配置Kibana</h2><p>可以通过 rpm/deb 包或者二进制的方式进行安装</p>
<h3 id="4-1-1-rpm-deb方式安装"><a href="#4-1-1-rpm-deb方式安装" class="headerlink" title="4.1.1 rpm/deb方式安装"></a>4.1.1 rpm/deb方式安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment">#下载并安装kibana</span><br>wget https://artifacts.elastic.co/downloads/kibana/kibana-7.6.2-amd64.deb<br>dpkg -i kibana-7.6.2-amd64.deb<br><br><span class="hljs-comment">#修改配置文件</span><br><span class="hljs-comment"># vim /etc/kibana/kibana.yml</span><br>server.port: 5601<br>server.host: <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>elasticsearch.hosts: [<span class="hljs-string">&quot;http://172.31.2.101:9200&quot;</span>]<br>i18n.locale: <span class="hljs-string">&quot;zh-CN&quot;</span> <span class="hljs-comment">#支持中文</span><br></code></pre></td></tr></table></figure>

<h3 id="4-1-2-启动kibana服务并验证"><a href="#4-1-2-启动kibana服务并验证" class="headerlink" title="4.1.2 启动kibana服务并验证"></a>4.1.2 启动kibana服务并验证</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl start kibana #启动需要一点时间</span><br><br><span class="hljs-comment"># systemctl enable kibana</span><br><br><span class="hljs-comment">#ss -tnl | grep 5601</span><br>LISTEN   0         511                 0.0.0.0:5601             0.0.0.0:*<br><br><span class="hljs-comment"># lsof -i:5601</span><br>COMMAND  PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>node    2621 kibana   25u  IPv4 100235      0t0  TCP *:5601 (LISTEN)<br></code></pre></td></tr></table></figure>

<h3 id="4-1-3-查看状态"><a href="#4-1-3-查看状态" class="headerlink" title="4.1.3 查看状态"></a>4.1.3 查看状态</h3><p><a target="_blank" rel="noopener" href="http://172.31.2.101:5601/status">http://172.31.2.101:5601/status</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk41.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-1-4-添加上一步写入的索引"><a href="#4-1-4-添加上一步写入的索引" class="headerlink" title="4.1.4 添加上一步写入的索引"></a>4.1.4 添加上一步写入的索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk19.png" srcset="/blog/img/loading.gif"></p>
<p>Management–索引模式–创建索引模式</p>
<p>索引模式输入：rlin-logstash-testindex-*</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk20.png" srcset="/blog/img/loading.gif"></p>
<p>配置设置–时间筛选字段名称--@timeestamp</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk21.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk22.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">如果默认没有显示柱状的图，可能是最近没有写入新的数据，可以查看较长日期当中的数据或者通过 logstash 新写入数据即可<br><span class="hljs-comment"># echo &quot;123&quot; &gt;&gt; /var/log/syslog</span><br><br><span class="hljs-comment"># echo &quot;234&quot; &gt;&gt; /var/log/syslog</span><br><br><span class="hljs-comment"># echo &quot;345&quot; &gt;&gt; /var/log/syslog</span><br></code></pre></td></tr></table></figure>

<h3 id="4-1-5-Kibana验证数据"><a href="#4-1-5-Kibana验证数据" class="headerlink" title="4.1.5 Kibana验证数据"></a>4.1.5 Kibana验证数据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk23.png" srcset="/blog/img/loading.gif"></p>
<h1 id="五、通过Logstash收集日志"><a href="#五、通过Logstash收集日志" class="headerlink" title="五、通过Logstash收集日志"></a>五、通过Logstash收集日志</h1><h2 id="5-1-收集单个系统日志并输出至文件"><a href="#5-1-收集单个系统日志并输出至文件" class="headerlink" title="5.1 收集单个系统日志并输出至文件"></a>5.1 收集单个系统日志并输出至文件</h2><p>前提需要 logstash 用户对被收集的日志文件有读的权限并对写入的文件有写权限。</p>
<h3 id="5-1-1-Logstash配置文件"><a href="#5-1-1-Logstash配置文件" class="headerlink" title="5.1.1 Logstash配置文件"></a>5.1.1 Logstash配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cat /etc/logstash/conf.d/system-log.conf</span><br>input &#123;<br>    file &#123;<br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;syslog&quot;</span><br>        path =&gt; <span class="hljs-string">&quot;/var/log/&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span> <span class="hljs-comment">#第一次从头收集，之后从新添加的日志收集</span><br>        &#125;<br>&#125;<br>output &#123;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/tmp/%&#123;type&#125;.%&#123;+yyyy.MM.dd&#125;&quot;</span><br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-1-2-检测配置文件语法是否正确"><a href="#5-1-2-检测配置文件语法是否正确" class="headerlink" title="5.1.2 检测配置文件语法是否正确."></a>5.1.2 检测配置文件语法是否正确.</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system-log.conf -t</span><br>WARNING: Could not find logstash.yml <span class="hljs-built_in">which</span> is typically located <span class="hljs-keyword">in</span> <span class="hljs-variable">$LS_HOME</span>/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults<br>Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config <span class="hljs-built_in">which</span> logs errors to the console<br>[WARN ] 2021-08-23 20:15:35.524 [LogStash::Runner] multilocal - Ignoring the <span class="hljs-string">&#x27;pipelines.yml&#x27;</span> file because modules or <span class="hljs-built_in">command</span> line options are specified<br>[INFO ] 2021-08-23 20:15:36.317 [LogStash::Runner] Reflections - Reflections took 33 ms to scan 1 urls, producing 20 keys and 40 values <br>Configuration OK<br>[INFO ] 2021-08-23 20:15:36.642 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk24.png" srcset="/blog/img/loading.gif" alt="24"></p>
<h3 id="5-1-3-生成数据并验证"><a href="#5-1-3-生成数据并验证" class="headerlink" title="5.1.3 生成数据并验证"></a>5.1.3 生成数据并验证</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system-log.conf #执行配置文件</span><br><span class="hljs-comment"># echo &quot;test&quot; &gt;&gt; /var/log/syslog #生成数据</span><br><span class="hljs-comment"># tail /tmp/syslog.2021.08.23</span><br>&#123;<span class="hljs-string">&quot;path&quot;</span>:<span class="hljs-string">&quot;/var/log/syslog&quot;</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;syslog&quot;</span>,<span class="hljs-string">&quot;message&quot;</span>:<span class="hljs-string">&quot;test&quot;</span>,<span class="hljs-string">&quot;@version&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;@timestamp&quot;</span>:<span class="hljs-string">&quot;2021-08-23T12:29:21.971Z&quot;</span>,<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;log-node1&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-1-4-查看Logstash日志，确认有权限收集日志"><a href="#5-1-4-查看Logstash日志，确认有权限收集日志" class="headerlink" title="5.1.4 查看Logstash日志，确认有权限收集日志"></a>5.1.4 查看Logstash日志，确认有权限收集日志</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk188.png" srcset="/blog/img/loading.gif" alt="权限不够"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk25.png" srcset="/blog/img/loading.gif" alt="权限足够elk"></p>
<h3 id="5-1-5-授权读取文件"><a href="#5-1-5-授权读取文件" class="headerlink" title="5.1.5 授权读取文件"></a>5.1.5 授权读取文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># chmod 644 /var/log/syslog</span><br><span class="hljs-comment">#或</span><br><span class="hljs-comment"># vim /etc/systemd/system/logstash.service</span><br><span class="hljs-comment">#修改为root启动</span><br>User=root<br>Group=root<br><span class="hljs-comment"># systemctl daemon-reload</span><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk26.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-2-通过Logstash收集多个日志文件"><a href="#5-2-通过Logstash收集多个日志文件" class="headerlink" title="5.2 通过Logstash收集多个日志文件"></a>5.2 通过Logstash收集多个日志文件</h2><h3 id="5-2-1-Logstash配置"><a href="#5-2-1-Logstash配置" class="headerlink" title="5.2.1 Logstash配置"></a>5.2.1 Logstash配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#先测试收集多个日志文件，不发送到es里</span><br><span class="hljs-comment"># vim /etc/logstash/conf.d/rlin-log-es.conf </span><br>input &#123; <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/syslog&quot;</span> <span class="hljs-comment">#日志路径</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span>  <span class="hljs-comment">#第一次收集日志的位置</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span>  <span class="hljs-comment">#日志收集的间隔时间</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;systemlog&quot;</span> <span class="hljs-comment">#事件的唯一类型</span><br>    &#125; <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/vmware-network*&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;vmware-log&quot;</span><br>    &#125; <br>&#125; <br>output &#123; <br>    <span class="hljs-comment">#elasticsearch &#123;</span><br>    <span class="hljs-comment">#    hosts =&gt; [&quot;172.31.2.101:9200&quot;] </span><br>    <span class="hljs-comment">#    index =&gt; &quot;rlin-logstash-testindex-%&#123;+YYYY.MM.dd&#125;&quot; </span><br>    <span class="hljs-comment">#&#125;</span><br>    <span class="hljs-comment">#file &#123;</span><br>    <span class="hljs-comment">#    path =&gt; &quot;/tmp/rlin-logstash-testindex.logt-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>    <span class="hljs-comment">#&#125;</span><br>    <br>    stdout &#123;<br>        codec =&gt; <span class="hljs-string">&quot;rubydebug&quot;</span><br>    &#125;<br>&#125;<br><span class="hljs-comment"># systemctl stop logstash</span><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rlin-log-es.conf -t</span><br><span class="hljs-comment"># usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rlin-log-es.conf</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk27.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#收集日志，且发送到es里</span><br><span class="hljs-comment"># cat /etc/logstash/conf.d/rlin-log-es.conf</span><br>input &#123; <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/syslog&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;systemlog&quot;</span><br>    &#125; <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/vmware-network*&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;vmware-log&quot;</span><br>    &#125; <br>&#125; <br>output &#123; <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] ==<span class="hljs-string">&quot;systemlog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-testindex-%&#123;+YYYY.MM.dd&#125;&quot;</span> <br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;vmware-log&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-vmware-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># systemctl restart logstash.service </span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk28.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk29.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-2-重启Logstash并查看日志是否报错"><a href="#5-2-2-重启Logstash并查看日志是否报错" class="headerlink" title="5.2.2 重启Logstash并查看日志是否报错"></a>5.2.2 重启Logstash并查看日志是否报错</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk30.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-3-向被收集的文件中写入数据"><a href="#5-2-3-向被收集的文件中写入数据" class="headerlink" title="5.2.3 向被收集的文件中写入数据"></a>5.2.3 向被收集的文件中写入数据</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># echo &quot;123&quot; &gt;&gt; /var/log/vmware-network.1.log</span><br><span class="hljs-comment"># echo &quot;456&quot; &gt;&gt; /var/log/syslog</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk31.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk32.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk33.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-4-在kibana界面添加索引"><a href="#5-2-4-在kibana界面添加索引" class="headerlink" title="5.2.4 在kibana界面添加索引"></a>5.2.4 在kibana界面添加索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk131.png" srcset="/blog/img/loading.gif" alt="131"></p>
<h3 id="5-2-5-在kibana界面添加索引"><a href="#5-2-5-在kibana界面添加索引" class="headerlink" title="5.2.5 在kibana界面添加索引"></a>5.2.5 在kibana界面添加索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk132.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-6-Kibana展示"><a href="#5-2-6-Kibana展示" class="headerlink" title="5.2.6 Kibana展示"></a>5.2.6 Kibana展示</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk133.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-2-7-Kibana展示"><a href="#5-2-7-Kibana展示" class="headerlink" title="5.2.7 Kibana展示"></a>5.2.7 Kibana展示</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk134.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-3-通过Logstash收集tomcat合java日志"><a href="#5-3-通过Logstash收集tomcat合java日志" class="headerlink" title="5.3 通过Logstash收集tomcat合java日志"></a>5.3 通过Logstash收集tomcat合java日志</h3><p>收集 Tomcat 服务器的访问日志以及 Tomcat 错误日志进行实时统计，在 kibana页面进行搜索展现，每台 Tomcat 服务器要安装 logstash 负责收集日志，然后将日志转发给 elasticsearch 进行分析，在通过 kibana 在前端展现</p>
<h3 id="5-3-1-服务器部署tomcat服务"><a href="#5-3-1-服务器部署tomcat服务" class="headerlink" title="5.3.1 服务器部署tomcat服务"></a>5.3.1 服务器部署tomcat服务</h3><p>需要安装 java 环境，并自定义一个 web 界面进行测试。</p>
<h3 id="5-3-1-1-配置java环境并部署tomcat"><a href="#5-3-1-1-配置java环境并部署tomcat" class="headerlink" title="5.3.1.1 配置java环境并部署tomcat"></a>5.3.1.1 配置java环境并部署tomcat</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt update</span><br><br><span class="hljs-comment">#安装jdk</span><br><span class="hljs-comment"># apt install -y openjdk-8-jdk</span><br><br><span class="hljs-comment">#安装tmocat</span><br><span class="hljs-comment"># mkdir -p /apps</span><br><br><span class="hljs-comment"># cd /apps/</span><br><br><span class="hljs-comment"># tar xf apache-tomcat-8.5.43.tar.gz</span><br><br><span class="hljs-comment"># ln -sv apache-tomcat-8.5.43 tomcat</span><br><br><span class="hljs-comment"># cd tomcat/webapps</span><br><br><span class="hljs-comment"># mkdir linux</span><br><br><span class="hljs-comment"># vim linux/index.html</span><br>&lt;h1&gt;tomcat <span class="hljs-built_in">test</span>&lt;/h1&gt;<br><br><span class="hljs-comment"># /apps/tomcat/bin/catalina.sh start</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-1-2-确认web可以访问"><a href="#5-3-1-2-确认web可以访问" class="headerlink" title="5.3.1.2 确认web可以访问"></a>5.3.1.2 确认web可以访问</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk34.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-1-3-tomcat日志转json"><a href="#5-3-1-3-tomcat日志转json" class="headerlink" title="5.3.1.3 tomcat日志转json"></a>5.3.1.3 tomcat日志转json</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd ..</span><br><span class="hljs-comment"># vim conf/server.xml</span><br>&lt;Valve className=...... prefix=<span class="hljs-string">&quot;tomcat_access_log&quot;</span> suffix=<span class="hljs-string">&quot;.log&quot;</span><br><span class="hljs-comment"># 原来那个pattern删除</span><br>pattern=<span class="hljs-string">&quot;&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;method&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;AgentVersion&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;&quot;</span>/&gt;<br><br><span class="hljs-comment"># /apps/tomcat/bin/catalina.sh start</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-1-4-验证日志是否转json格式"><a href="#5-3-1-4-验证日志是否转json格式" class="headerlink" title="5.3.1.4 验证日志是否转json格式"></a>5.3.1.4 验证日志是否转json格式</h4><p><a target="_blank" rel="noopener" href="http://www.kjson.com/">http://www.kjson.com/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tail -f /apps/tomcat/logs/tomcat_access_log.xxx.log</span><br><span class="hljs-comment">#浏览器访问：172.31.2.107:8080/linux</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk35.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk36.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-1-5-如何获取日志行中的IP"><a href="#5-3-1-5-如何获取日志行中的IP" class="headerlink" title="5.3.1.5 如何获取日志行中的IP"></a>5.3.1.5 如何获取日志行中的IP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#Python 脚本解析：</span><br><span class="hljs-comment"># cat tomcatlog.py</span><br><span class="hljs-comment">#!/usr/bin/env python</span><br>status_200= []<br>status_404= []<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/apps/tomcat/logs/tomcat_access_log.2021-08-23.log&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>        line = <span class="hljs-built_in">eval</span>(line)<br>        <span class="hljs-built_in">print</span> (line.get(<span class="hljs-string">&quot;clientip&quot;</span>))<br>        <span class="hljs-keyword">if</span> line.get(<span class="hljs-string">&quot;status&quot;</span>) == <span class="hljs-string">&quot;200&quot;</span>:<br>            status_200.append(line.get)<br>        <span class="hljs-keyword">elif</span> line.get(<span class="hljs-string">&quot;status&quot;</span>) == <span class="hljs-string">&quot;404&quot;</span>:<br>            status_404.append(line.get)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;状态码 ERROR&quot;</span>)<br>f.close()<br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;状态码 200 的有--:&quot;</span>,<span class="hljs-built_in">len</span>(status_200))<br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;状态码 404 的有--:&quot;</span>,<span class="hljs-built_in">len</span>(status_404))<br><br><span class="hljs-comment"># python3 tomcatlog.py</span><br></code></pre></td></tr></table></figure>

<h3 id="5-3-2-在tomcat服务器安装Logstash收集tomcat系统日志"><a href="#5-3-2-在tomcat服务器安装Logstash收集tomcat系统日志" class="headerlink" title="5.3.2 在tomcat服务器安装Logstash收集tomcat系统日志"></a>5.3.2 在tomcat服务器安装Logstash收集tomcat系统日志</h3><p>需要部署 tomcat 并安装配置 logstash</p>
<h4 id="5-3-2-1-安装配置Logstash"><a href="#5-3-2-1-安装配置Logstash" class="headerlink" title="5.3.2.1 安装配置Logstash"></a>5.3.2.1 安装配置Logstash</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#安装logstash</span><br><span class="hljs-comment">#dpkg -i logstash-7.6.2.deb</span><br><br><span class="hljs-comment"># vim /etc/logstash/conf.d/rlin-log-es.conf</span><br>input &#123; <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/syslog&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;systemlog&quot;</span><br>    &#125; <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/vmware-network*&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;vmware-log&quot;</span><br>    &#125; <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/apps/tomcat/logs/tomcat_access_log.*.log&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;tomcat-accesslog&quot;</span><br>        <br>    &#125;<br>&#125; <br>output &#123; <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] ==<span class="hljs-string">&quot;systemlog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-testindex-%&#123;+YYYY.MM.dd&#125;&quot;</span> <br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;vmware-log&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-vmware-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;tomcat-accesslog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-tomcat-accesslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="5-3-2-2-重启Logstash并确认"><a href="#5-3-2-2-重启Logstash并确认" class="headerlink" title="5.3.2.2 重启Logstash并确认"></a>5.3.2.2 重启Logstash并确认</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart logstash #更改完配置文件重启 logstash</span><br><span class="hljs-comment"># tail -f /var/log/logstash/logstash-plain.log #验证日志</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk37.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-2-3-访问tomcat并生成日志"><a href="#5-3-2-3-访问tomcat并生成日志" class="headerlink" title="5.3.2.3 访问tomcat并生成日志"></a>5.3.2.3 访问tomcat并生成日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># curl 172.31.2.104:8080/linux/index.html</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-2-4-访问head插件验证索引"><a href="#5-3-2-4-访问head插件验证索引" class="headerlink" title="5.3.2.4 访问head插件验证索引"></a>5.3.2.4 访问head插件验证索引</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk38.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-2-5-在Kibana添加索引并验证数据"><a href="#5-3-2-5-在Kibana添加索引并验证数据" class="headerlink" title="5.3.2.5 在Kibana添加索引并验证数据"></a>5.3.2.5 在Kibana添加索引并验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk39.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-2-6-多个tomcat服务器收集logstash日志"><a href="#5-3-2-6-多个tomcat服务器收集logstash日志" class="headerlink" title="5.3.2.6 多个tomcat服务器收集logstash日志"></a>5.3.2.6 多个tomcat服务器收集logstash日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#安装jdk</span><br><span class="hljs-comment"># apt update</span><br><span class="hljs-comment"># apt -y install openjdk-8-jdk</span><br><span class="hljs-comment">#安装logstash</span><br><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># dpkg -i logstash-7.6.2.deb</span><br><span class="hljs-comment">#安装tomcat</span><br><span class="hljs-comment"># mkdir /apps</span><br><span class="hljs-comment"># tar xf apache-tomcat-8.5.43.tar.gz</span><br><span class="hljs-comment"># ln -sv apache-tomcat-8.5.43 tomcat</span><br><span class="hljs-comment">#修改logstash启动文件</span><br><span class="hljs-comment"># vim /etc/systemd/system/logstash.service </span><br>[Unit]<br>Description=logstash<br><br>[Service]<br>Type=simple<br>User=root<br>Group=root<br><span class="hljs-comment"># Load env vars from /etc/default/ and /etc/sysconfig/ if they exist.</span><br><span class="hljs-comment"># Prefixing the path with &#x27;-&#x27; makes it try to load, but if the file doesn&#x27;t</span><br><span class="hljs-comment"># exist, it continues onward.</span><br>EnvironmentFile=-/etc/default/logstash<br>EnvironmentFile=-/etc/sysconfig/logstash<br>ExecStart=/usr/share/logstash/bin/logstash <span class="hljs-string">&quot;--path.settings&quot;</span> <span class="hljs-string">&quot;/etc/logstash&quot;</span><br>Restart=always<br>WorkingDirectory=/<br>Nice=19<br>LimitNOFILE=16384<br><br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-comment">#修改tomcat配置文件</span><br><span class="hljs-comment"># cd /apps/tomcat/conf</span><br><span class="hljs-comment"># vim server.xml</span><br>......<br>&lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="hljs-string">&quot;logs&quot;</span><br>		prefix=<span class="hljs-string">&quot;tomcat_access_log&quot;</span> suffix=<span class="hljs-string">&quot;.log&quot;</span><br>		pattern=<span class="hljs-string">&quot;&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;method&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;AgentVersion&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;&quot;</span>/&gt;<br><span class="hljs-comment">#tomcat添加页面</span><br><span class="hljs-comment"># cd ..</span><br><span class="hljs-comment"># mkdir webapps/linux</span><br><span class="hljs-comment"># vim webapps/linux/index,html</span><br>&lt;h1&gt;tomcat <span class="hljs-built_in">test</span>&lt;/h1&gt;<br><span class="hljs-comment">#logstash添加配置文件</span><br><span class="hljs-comment"># vim /etc/logstash/conf.d/rlin-log-es.conf</span><br>input &#123; <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/syslog&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;systemlog&quot;</span><br>    &#125; <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/vmware-network*&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;vmware-log&quot;</span><br>    &#125;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/apps/tomcat/logs/tomcat_access_log.*.log&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;tomcat-accesslog&quot;</span><br>        <br>    &#125;<br>&#125; <br>output &#123; <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] ==<span class="hljs-string">&quot;systemlog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-sys-log-%&#123;+YYYY.MM.dd&#125;&quot;</span> <br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;vmware-log&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-vmware-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;tomcat-accesslog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-tomcat-accesslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">#启动logstash和tomcat</span><br><span class="hljs-comment"># systemclt restart logstash</span><br><span class="hljs-comment"># /apps/tomcat/bin/catalina.sh start</span><br><span class="hljs-comment">#同时访问多个tomcat网页</span><br><span class="hljs-comment"># while true;do curl 172.31.2.104:8080/linux/index.html;sleep 0.5;done</span><br><span class="hljs-comment"># while true;do curl 172.31.2.105:8080/linux/index.html;sleep 0.5;done</span><br></code></pre></td></tr></table></figure>

<p>验证是否由收集两个tomcat日志</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk40.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-2-8-在其他服务器使用ab批量访问并验证数据"><a href="#5-3-2-8-在其他服务器使用ab批量访问并验证数据" class="headerlink" title="5.3.2.8 在其他服务器使用ab批量访问并验证数据"></a>5.3.2.8 在其他服务器使用ab批量访问并验证数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ab -n1000 -c100 http://172.31.2.104/linux/index.html</span><br><br><span class="hljs-comment"># ab -n1000 -c100 http://172.31.2.105/linux/index.html</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk41.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-3-3-收集java日志"><a href="#5-3-3-收集java日志" class="headerlink" title="5.3.3 收集java日志"></a>5.3.3 收集java日志</h3><p>使用codec的multiline插件实现多行匹配，这是一个可以将多行进行合并的插件，而且可以使用what指定将匹配到的行与前面的行合并还是和后面的行合并，<br><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html">https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html</a></p>
<h4 id="5-3-3-1-在Elasticsearch服务部署Logstash"><a href="#5-3-3-1-在Elasticsearch服务部署Logstash" class="headerlink" title="5.3.3.1 在Elasticsearch服务部署Logstash"></a>5.3.3.1 在Elasticsearch服务部署Logstash</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#可以发送es的日志到lotstash里代替在es服务器里安装logstash</span><br><br><span class="hljs-comment"># scp /data/esdata/logs/rlin-es-cluster.log 172.31.2.104:/var/log/</span><br><br><span class="hljs-comment"># systmctl stop logstash</span><br><br><span class="hljs-comment"># cd /etc/logstash/conf.d/</span><br><br><span class="hljs-comment"># vim rlin-javalog-to-es.conf</span><br>input &#123;<br>    stdin &#123;<br>        codec =&gt; multiline &#123;<br>            pattern =&gt; <span class="hljs-string">&quot;^\[&quot;</span> <span class="hljs-comment">#当遇到[开头的行时候将多行进行合并</span><br>            negate =&gt; <span class="hljs-literal">true</span> <span class="hljs-comment">#true 为匹配成功进行操作，false 为不成功进行操作</span><br>            what =&gt; <span class="hljs-string">&quot;previous&quot;</span> <span class="hljs-comment">#与以前的行合并，如果是下面的行合并就是 next</span><br>        &#125;<br>    &#125;<br>&#125;<br>filter &#123; <span class="hljs-comment">#日志过滤，如果所有的日志都过滤就写这里，如果只针对某一个过滤就写在 input 里面的日志输入里面</span><br>output &#123; <br>    stdout &#123;<br>        codec =&gt; <span class="hljs-string">&quot;rubydebug&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-3-3-2-测试可以正常启动"><a href="#5-3-3-2-测试可以正常启动" class="headerlink" title="5.3.3.2 测试可以正常启动"></a>5.3.3.2 测试可以正常启动</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#测试语法</span><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f rlin-javalog-to-es.conf -t</span><br><br><span class="hljs-comment">#启动</span><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f rlin-javalog-to-es.conf </span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-3-3-测试标准输入和标准输出"><a href="#5-3-3-3-测试标准输入和标准输出" class="headerlink" title="5.3.3.3 测试标准输入和标准输出"></a>5.3.3.3 测试标准输入和标准输出</h4><p>日志内容可以在es服务器的es日志里获取</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk42.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-3-4-配置读取日志文件写入到文件"><a href="#5-3-3-4-配置读取日志文件写入到文件" class="headerlink" title="5.3.3.4 配置读取日志文件写入到文件"></a>5.3.3.4 配置读取日志文件写入到文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim rlin-javalog-to-es.conf</span><br>input &#123;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/rlin-es-cluster.log&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;java-errorlog&quot;</span><br>        codec =&gt; multiline &#123;<br>            pattern =&gt; <span class="hljs-string">&quot;^\[&quot;</span> <br>            negate =&gt; <span class="hljs-literal">true</span> <span class="hljs-comment">#</span><br>            what =&gt; <span class="hljs-string">&quot;previous&quot;</span> <br>        &#125;<br>    &#125;<br>&#125;<br><br>output &#123; <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;java-errorlog&quot;</span> &#123;<br>        stdout &#123;<br>            codec =&gt; rubydebug<br>        &#125;<br>        file &#123;<br>            path =&gt; <span class="hljs-string">&quot;/tmp/m.txt&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-3-3-5-语法验证"><a href="#5-3-3-5-语法验证" class="headerlink" title="5.3.3.5 语法验证"></a>5.3.3.5 语法验证</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#测试语法</span><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f rlin-javalog-to-es.conf -t</span><br><br><span class="hljs-comment">#启动</span><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f rlin-javalog-to-es.conf</span><br><br><span class="hljs-comment">#注入新日志</span><br><span class="hljs-comment"># cp /var/log/rlin-es-cluster.log /var/log/rlin-es-cluster.log.bak</span><br><span class="hljs-comment"># cat /var/log/rlin-es-cluster.log.bak &gt;&gt; /var/log/rlin-es-cluster.log</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk44.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk43.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-3-6-将输出改为Elasticsearch"><a href="#5-3-3-6-将输出改为Elasticsearch" class="headerlink" title="5.3.3.6 将输出改为Elasticsearch"></a>5.3.3.6 将输出改为Elasticsearch</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim rlin-javalog-to-es.conf</span><br>input &#123;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/rlin-es-cluster.log&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;java-errorlog&quot;</span><br>        codec =&gt; multiline &#123;<br>            pattern =&gt; <span class="hljs-string">&quot;^\[&quot;</span> <br>            negate =&gt; <span class="hljs-literal">true</span><br>            what =&gt; <span class="hljs-string">&quot;previous&quot;</span> <br>        &#125;<br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;java-errorlog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-java-errorlog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f rlin-javalog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk45.png" srcset="/blog/img/loading.gif" alt="测试"></p>
<h4 id="5-3-3-7-Kibana界面添加javae-errorlog索引"><a href="#5-3-3-7-Kibana界面添加javae-errorlog索引" class="headerlink" title="5.3.3.7 Kibana界面添加javae-errorlog索引"></a>5.3.3.7 Kibana界面添加javae-errorlog索引</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk46.png" srcset="/blog/img/loading.gif"></p>
<p>添加索引</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk47.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk48.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk49.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-3-8-生成数据"><a href="#5-3-3-8-生成数据" class="headerlink" title="5.3.3.8 生成数据"></a>5.3.3.8 生成数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp /var/log/rlin-es-cluster.log /var/log/rlin-es-cluster.log.bak</span><br><span class="hljs-comment"># cat /var/log/rlin-es-cluster.log.bak &gt;&gt; /var/log/rlin-es-cluster.log</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-3-9-Kibana界面查看数据"><a href="#5-3-3-9-Kibana界面查看数据" class="headerlink" title="5.3.3.9 Kibana界面查看数据"></a>5.3.3.9 Kibana界面查看数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk50.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-3-10-关于sincedb"><a href="#5-3-3-10-关于sincedb" class="headerlink" title="5.3.3.10 关于sincedb"></a>5.3.3.10 关于sincedb</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cat /var/lib/logstash/plugins/inputs/file/.sincedb_3f88adb6e3d880fb6111d679dd3080b5 </span><br>1311145 0 2049 76629 1629904396.137926 /var/<span class="hljs-built_in">log</span>/rlin-es-cluster.log  <span class="hljs-comment">#记录了收集文件的 inode 信息</span><br><br><span class="hljs-comment"># ll -li /var/log/rlin-es-cluster.log</span><br>1311145 -rw-r--r-- 1 root root 76629 Aug 25 23:13 /var/<span class="hljs-built_in">log</span>/rlin-es-cluster.log<br></code></pre></td></tr></table></figure>

<h2 id="5-4-收集nginx访问日志"><a href="#5-4-收集nginx访问日志" class="headerlink" title="5.4 收集nginx访问日志"></a>5.4 收集nginx访问日志</h2><h3 id="5-4-1-部署nginx服务"><a href="#5-4-1-部署nginx服务" class="headerlink" title="5.4.1 部署nginx服务"></a>5.4.1 部署nginx服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment">#下载nginx</span><br><span class="hljs-comment"># tar xf nginx-1.16.1.tar.gz</span><br><span class="hljs-comment"># cd nginx-1.16.1</span><br><span class="hljs-comment"># ./configure --prefix=/apps/nginx</span><br><span class="hljs-comment"># make &amp;&amp; make install</span><br></code></pre></td></tr></table></figure>

<h3 id="5-4-2-编辑nginx配置"><a href="#5-4-2-编辑nginx配置" class="headerlink" title="5.4.2 编辑nginx配置"></a>5.4.2 编辑nginx配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /apps/nginx/</span><br><span class="hljs-comment"># vim conf/nginx.conf</span><br>server&#123;<br>......<br>        location /web &#123;<br>            root   html;<br>            index  index.html index.htm;<br>        &#125;<br>&#125;<br><br><span class="hljs-comment"># mkdir /apps/nginx/html/web</span><br><span class="hljs-comment"># echo &quot;nginx testpage&quot; &gt; /apps/nginx/html/web/index.html</span><br></code></pre></td></tr></table></figure>

<h3 id="5-4-3-启动nginx并验证"><a href="#5-4-3-启动nginx并验证" class="headerlink" title="5.4.3 启动nginx并验证"></a>5.4.3 启动nginx并验证</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/nginx/sbin/nginx -t #测试配置文件语法</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br><span class="hljs-comment"># /apps/nginx/sbin/nginx #启动服务</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload #重读配置文件</span><br><span class="hljs-comment"># lsof -i:80</span><br>COMMAND  PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>nginx   9170   root    6u  IPv4  76728      0t0  TCP *:http (LISTEN)<br>nginx   9173 nobody    6u  IPv4  76728      0t0  TCP *:http (LISTEN)<br></code></pre></td></tr></table></figure>

<h3 id="5-4-4-访问nginx页面"><a href="#5-4-4-访问nginx页面" class="headerlink" title="5.4.4 访问nginx页面"></a>5.4.4 访问nginx页面</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># curl 172.31.2.104/web/index.html</span><br>nginx testpage<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk51.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-4-5-将nginx日志转换为json格式"><a href="#5-4-5-将nginx日志转换为json格式" class="headerlink" title="5.4.5 将nginx日志转换为json格式"></a>5.4.5 将nginx日志转换为json格式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br>.....<br>http&#123;<br>......<br>log_format access_json <span class="hljs-string">&#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br><span class="hljs-string">&#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br><span class="hljs-string">&#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span><br><span class="hljs-string">&#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br><span class="hljs-string">&#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br><span class="hljs-string">&#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span><br><span class="hljs-string">&#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span><br><span class="hljs-string">&#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span><br><span class="hljs-string">&#x27;&quot;url&quot;:&quot;$uri&quot;,&#x27;</span><br><span class="hljs-string">&#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span><br><span class="hljs-string">&#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span><br><span class="hljs-string">&#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span><br><span class="hljs-string">&#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;</span>;<br>access_log /var/<span class="hljs-built_in">log</span>/nginx/access.log access_json;<br><br>&#125;<br><br><span class="hljs-comment"># mkdir /var/log/nginx/</span><br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h3 id="5-4-6-确认日志格式为json"><a href="#5-4-6-确认日志格式为json" class="headerlink" title="5.4.6 确认日志格式为json"></a>5.4.6 确认日志格式为json</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># tail -f /var/log/nginx/access.log #执行命令后访问nginx网页</span><br>&#123;<span class="hljs-string">&quot;@timestamp&quot;</span>:<span class="hljs-string">&quot;2021-08-26T09:46:33+08:00&quot;</span>,<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;172.31.2.104&quot;</span>,<span class="hljs-string">&quot;clientip&quot;</span>:<span class="hljs-string">&quot;172.31.2.105&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:15,<span class="hljs-string">&quot;responsetime&quot;</span>:0.000,<span class="hljs-string">&quot;upstreamtime&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;upstreamhost&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;http_host&quot;</span>:<span class="hljs-string">&quot;172.31.2.104&quot;</span>,<span class="hljs-string">&quot;url&quot;</span>:<span class="hljs-string">&quot;/web/index.html&quot;</span>,<span class="hljs-string">&quot;domain&quot;</span>:<span class="hljs-string">&quot;172.31.2.104&quot;</span>,<span class="hljs-string">&quot;xff&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;referer&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;status&quot;</span>:<span class="hljs-string">&quot;200&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk52.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-4-7-配置Logstash收集nginx访问日志"><a href="#5-4-7-配置Logstash收集nginx访问日志" class="headerlink" title="5.4.7 配置Logstash收集nginx访问日志"></a>5.4.7 配置Logstash收集nginx访问日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /etc/logstash/conf.d/</span><br><br><span class="hljs-comment"># cp  rlin-javalog-to-es.conf  rlin-nginxlog-to-es.conf</span><br><br><span class="hljs-comment"># vim rlin-nginxlog-to-es.conf</span><br>input &#123;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/nginx/access.log&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;nginx-access-log&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span> <br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;nginx-access-log&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>] <br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-nginx-accesslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f rlin-javalog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<p><strong>注意：多个服务器也是同样的配置，设置好收集日志的conf文件即可</strong></p>
<h3 id="5-4-8-Kibana界面添加索引"><a href="#5-4-8-Kibana界面添加索引" class="headerlink" title="5.4.8 Kibana界面添加索引"></a>5.4.8 Kibana界面添加索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk53.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk54.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-4-9-Kibana界面验证数据"><a href="#5-4-9-Kibana界面验证数据" class="headerlink" title="5.4.9 Kibana界面验证数据"></a>5.4.9 Kibana界面验证数据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk55.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-5-收集TCP-UDP日志-用的不多"><a href="#5-5-收集TCP-UDP日志-用的不多" class="headerlink" title="5.5 收集TCP/UDP日志(用的不多)"></a>5.5 收集TCP/UDP日志(用的不多)</h2><p>通过 logstash 的 tcp/udp 插件收集日志，通常用于在向 elasticsearch 日志补录丢失的部分日志，可以将丢失的日志写到一个文件，然后通过 TCP 日志收集方式直接发送给 logstash 然后再写入到 elasticsearch 服务器。<br><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.6/input-plugins.html">https://www.elastic.co/guide/en/logstash/7.6/input-plugins.html</a></p>
<h3 id="5-5-1-Logstash配置文件，先进行收集测试"><a href="#5-5-1-Logstash配置文件，先进行收集测试" class="headerlink" title="5.5.1 Logstash配置文件，先进行收集测试"></a>5.5.1 Logstash配置文件，先进行收集测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/rlin-tcp-to-es.conf</span><br>input &#123;<br>    tcp &#123;<br>        host =&gt; <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;tcp-log&quot;</span><br>        port =&gt; 9998<br>    &#125;<br>&#125;<br><br>output &#123;<br>    stdout &#123;<br>    codec =&gt; <span class="hljs-string">&quot;rubydebug&quot;</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># systemctl stop logstash</span><br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f rlin-tcp-to-es.conf -t</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-2-验证端口启动成功"><a href="#5-5-2-验证端口启动成功" class="headerlink" title="5.5.2 验证端口启动成功"></a>5.5.2 验证端口启动成功</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f rlin-tcp-to-es.conf</span><br><br><span class="hljs-comment"># ss -tnl</span><br>State         Recv-Q         Send-Q                         Local Address:Port                    Peer Address:Port<br>LISTEN        0              1024                                       *:9998                               *:*<br><br><span class="hljs-comment"># lsof -i:9998</span><br>COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>java    9466 root  119u  IPv6  81840      0t0  TCP *:9998 (LISTEN)<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk56.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-5-3-在其他服务器安装nc命令"><a href="#5-5-3-在其他服务器安装nc命令" class="headerlink" title="5.5.3 在其他服务器安装nc命令"></a>5.5.3 在其他服务器安装nc命令</h3><p>NetCat 简称 nc，在网络工具中有“瑞士军刀”美誉，其功能实用，是一个简单、可靠的网络工具，可通过 TCP 或 UDP 协议传输读写数据，另外还具有很多其他功能。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#centos7</span><br><br><span class="hljs-comment"># yum instll nc –y</span><br><br><span class="hljs-comment">#ubuntu </span><br><br><span class="hljs-comment"># apt install -y nc</span><br><br><span class="hljs-comment"># echo &quot;msg test1&quot;|nc 172.31.2.104 9998</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-4-验证Logstash是否接收到数据"><a href="#5-5-4-验证Logstash是否接收到数据" class="headerlink" title="5.5.4 验证Logstash是否接收到数据"></a>5.5.4 验证Logstash是否接收到数据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk57.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-5-5-通过nc命令发送一个文件"><a href="#5-5-5-通过nc命令发送一个文件" class="headerlink" title="5.5.5 通过nc命令发送一个文件"></a>5.5.5 通过nc命令发送一个文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># nc 172.31.2.104 9998 &lt; /var/log/syslog</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-6-Logstash验证数据"><a href="#5-5-6-Logstash验证数据" class="headerlink" title="5.5.6 Logstash验证数据"></a>5.5.6 Logstash验证数据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk58.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-5-7-通过伪设备的方式发送消息"><a href="#5-5-7-通过伪设备的方式发送消息" class="headerlink" title="5.5.7 通过伪设备的方式发送消息"></a>5.5.7 通过伪设备的方式发送消息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># echo &quot;伪设备&quot; &gt; /dev/tcp/172.31.2.104/9998</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-8-Logstash验证数据"><a href="#5-5-8-Logstash验证数据" class="headerlink" title="5.5.8 Logstash验证数据"></a>5.5.8 Logstash验证数据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk59.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-5-9-将输出改为Elasticsearch"><a href="#5-5-9-将输出改为Elasticsearch" class="headerlink" title="5.5.9 将输出改为Elasticsearch"></a>5.5.9 将输出改为Elasticsearch</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/rlin-tcp-to-es.conf</span><br>input &#123;<br>    tcp &#123;<br>        host =&gt; <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;tcp-log&quot;</span><br>        port =&gt; 9998<br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;tcp-log&quot;</span>&#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;rlin-logstash-tcp-log-%&#123;+YYYY.ww&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f rlin-tcp-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl start logstash</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-10-通过nc命令或伪设备输入日志"><a href="#5-5-10-通过nc命令或伪设备输入日志" class="headerlink" title="5.5.10 通过nc命令或伪设备输入日志"></a>5.5.10 通过nc命令或伪设备输入日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># echo &quot;伪设备 1&quot; &gt; /dev/tcp/172.31.2.104/9998</span><br><br><span class="hljs-comment"># echo &quot;伪设备 2&quot; &gt; /dev/tcp/172.31.2.104/9998</span><br><br><span class="hljs-comment"># nc 172.31.2.104 9998 &lt; /var/log/syslog</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-11-在Kibana界面添加索引"><a href="#5-5-11-在Kibana界面添加索引" class="headerlink" title="5.5.11 在Kibana界面添加索引"></a>5.5.11 在Kibana界面添加索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk60.png" srcset="/blog/img/loading.gif" alt="61"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk61.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk63.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-6-通过rsyslog收集haproxy日志"><a href="#5-6-通过rsyslog收集haproxy日志" class="headerlink" title="5.6 通过rsyslog收集haproxy日志"></a>5.6 通过rsyslog收集haproxy日志</h2><p>rsyslog 提供高性能，高安全性功能和模块化设计。 虽然它最初是作为常规系统日志开发的，但是 rsyslog 已经发展成为一种瑞士军刀，可以接受来自各种来源的输入，转换它们，并将结果输出到不同的目的地。</p>
<p>当应用有限的处理时，RSYSLOG 每秒可以向本地目的地传送超过一百万条消息。</p>
<p>即使有远程目的地和更复杂的处理，性能通常被认为是“惊人的”。在 centos 6 及之前的版本叫做 syslog，centos 7 开始叫做 rsyslog，根据官方的介绍，rsyslog(2013 年版本)可以达到每秒转发百万条日志的级别。</p>
<p>官方网址：<a target="_blank" rel="noopener" href="http://www.rsyslog.com/">http://www.rsyslog.com/</a></p>
<h3 id="5-6-1-安装配置haproxy"><a href="#5-6-1-安装配置haproxy" class="headerlink" title="5.6.1 安装配置haproxy"></a>5.6.1 安装配置haproxy</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y haproxy</span><br><span class="hljs-comment"># cat /etc/haproxy/haproxy.cfg</span><br>global<br>maxconn 100000<br>chroot /usr/<span class="hljs-built_in">local</span>/haproxy<br>uid 99<br>gid 99<br>daemon<br>nbproc 1<br>pidfile /usr/<span class="hljs-built_in">local</span>/haproxy/run/haproxy.pid<br><span class="hljs-built_in">log</span> 127.0.0.1 local5<br>defaults<br>option http-keep-alive<br>option forwardfor<br>maxconn 100000<br>mode http<br>timeout connect 300000ms<br>timeout client 300000ms<br>timeout server 300000ms<br><br>listen stats <span class="hljs-comment">#可以就添加listen status作为测试</span><br>mode http<br><span class="hljs-built_in">bind</span> 0.0.0.0:9999<br>stats <span class="hljs-built_in">enable</span><br><span class="hljs-built_in">log</span> global<br>stats uri /haproxy-status<br>stats auth haadmin:123456<br><br><span class="hljs-comment">#frontend web_port</span><br>frontend web_port<br><span class="hljs-built_in">bind</span> 0.0.0.0:80<br>mode http<br>option httplog<br><span class="hljs-built_in">log</span> global<br>option forwardfor<br><span class="hljs-comment">###################ACL Setting##########################</span><br>acl pc hdr_dom(host) -i www.elk.com<br>acl mobile hdr_dom(host) -i m.elk.com<br><span class="hljs-comment">###################USE ACL##############################</span><br>use_backend pc_host <span class="hljs-keyword">if</span> pc<br>use_backend mobile_host <span class="hljs-keyword">if</span> mobile<br><span class="hljs-comment">########################################################</span><br><br>backend pc_host<br>mode http<br>option httplog<br>balance <span class="hljs-built_in">source</span><br>server web1 192.168.15.11:80 check inter 2000 rise 3 fall 2 weight 1<br>backend mobile_host<br>mode http<br>option httplog<br>balance <span class="hljs-built_in">source</span><br>server web1 192.168.15.11:80 check inter 2000 rise 3 fall 2 weight 1<br><br><span class="hljs-comment">#或者：</span><br>frontend kibana_web_port<br><span class="hljs-built_in">bind</span> 192.168.15.12:80<br>mode http<br><span class="hljs-built_in">log</span> global <span class="hljs-comment">#必须开启日志</span><br>default_backend kibana_web_http_nodes<br>backend kibana_web_http_nodes<br>mode http<br><span class="hljs-comment">#balance source</span><br>balance roundrobin<br>cookie SESSION_COOKIE insert indirect nocache<br><span class="hljs-comment">#option httpchk GET /XXX/XXX.</span><br>server 192.168.15.11 192.168.15.11:5601 cookie kafka-web1 check inter<br>2000 fall 3 rise 5<br><br>listen kibana<br><span class="hljs-built_in">bind</span> 192.168.7.105:5601<br>mode tcp<br>server 192.168.7.101 192.168.7.101:5601 check inter 3s fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h3 id="5-6-2-编辑rsyslog服务配置文件"><a href="#5-6-2-编辑rsyslog服务配置文件" class="headerlink" title="5.6.2 编辑rsyslog服务配置文件"></a>5.6.2 编辑rsyslog服务配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/rsyslog.conf</span><br><span class="hljs-variable">$ModLoad</span> imudp<br><span class="hljs-variable">$UDPServerRun</span> 514<br><br><span class="hljs-variable">$ModLoad</span> imtcp<br><span class="hljs-variable">$InputTCPServerRun</span> 514 <span class="hljs-comment">#去掉 15/16/19/20 行前面的注释</span><br><br>local5.* /var/<span class="hljs-built_in">log</span>/haproxy.log <span class="hljs-comment">#测试可以正常将日志写入本地自定义文件</span><br>local5.* @@172.31.2.104:514 <span class="hljs-comment">#最后面一行添加，local5 对应 haproxy 配置文件定义的 local 级别</span><br></code></pre></td></tr></table></figure>

<h3 id="5-6-3-重新启动haproxy和rsyslog"><a href="#5-6-3-重新启动haproxy和rsyslog" class="headerlink" title="5.6.3 重新启动haproxy和rsyslog"></a>5.6.3 重新启动haproxy和rsyslog</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart haproxy</span><br><span class="hljs-comment"># systemctl restart rsyslog</span><br></code></pre></td></tr></table></figure>

<h3 id="5-6-4-验证端口及服务"><a href="#5-6-4-验证端口及服务" class="headerlink" title="5.6.4 验证端口及服务"></a>5.6.4 验证端口及服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ss -tunl</span><br>Netid  State      Recv-Q Send-Q              Local Address:Port                             Peer Address:Port                               <br>udp    UNCONN     0      0                               *:514                                         *:*                  <br>udp    UNCONN     0      0                              :::514                                        :::*                  <br>tcp    LISTEN     0      128                             *:9999                                        *:*                  <br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk64.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk65.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-6-5-测试及访问"><a href="#5-6-5-测试及访问" class="headerlink" title="5.6.5 测试及访问"></a>5.6.5 测试及访问</h3><p>浏览器访问：haproxy-ip:9999/haproxy-status，多刷新几次</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk66.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-6-6-查看日志"><a href="#5-6-6-查看日志" class="headerlink" title="5.6.6 查看日志"></a>5.6.6 查看日志</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk67.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-6-7-编辑Logstash配置文件"><a href="#5-6-7-编辑Logstash配置文件" class="headerlink" title="5.6.7 编辑Logstash配置文件"></a>5.6.7 编辑Logstash配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/rlin-syslog-to-es.conf</span><br>input &#123;<br>    syslog &#123;<br>        host =&gt; <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>        port =&gt; 514<br>    &#125;<br>&#125;<br><br>output &#123;<br>    stdout &#123;<br>        codec =&gt; <span class="hljs-string">&quot;rubydebug&quot;</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># systemctl stop logstash</span><br></code></pre></td></tr></table></figure>

<h3 id="5-6-8-通过-f命令测试Logstash"><a href="#5-6-8-通过-f命令测试Logstash" class="headerlink" title="5.6.8 通过-f命令测试Logstash"></a>5.6.8 通过-f命令测试Logstash</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rlin-syslog-to-es.conf -t</span><br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rlin-syslog-to-es.conf</span><br></code></pre></td></tr></table></figure>

<h3 id="5-6-9-访问haproxy管理界面"><a href="#5-6-9-访问haproxy管理界面" class="headerlink" title="5.6.9 访问haproxy管理界面"></a>5.6.9 访问haproxy管理界面</h3><p>多刷新几次</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk68.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-6-10-验证Logstash输出"><a href="#5-6-10-验证Logstash输出" class="headerlink" title="5.6.10 验证Logstash输出"></a>5.6.10 验证Logstash输出</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk69.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-6-13-将输出改为Elasticsearch"><a href="#5-6-13-将输出改为Elasticsearch" class="headerlink" title="5.6.13 将输出改为Elasticsearch"></a>5.6.13 将输出改为Elasticsearch</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/rlin-syslog-to-es.conf</span><br>input &#123;<br>    syslog &#123;<br>        host =&gt; <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>        port =&gt; 514<br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;router-syslog&quot;</span><br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] ==<span class="hljs-string">&quot;router-syslog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;rlin-router-syslog-%&#123;+YYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d//etc/logstash/conf.d/rlin-syslog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h3 id="5-6-14-访问haproxy管理界面以生成新日志"><a href="#5-6-14-访问haproxy管理界面以生成新日志" class="headerlink" title="5.6.14 访问haproxy管理界面以生成新日志"></a>5.6.14 访问haproxy管理界面以生成新日志</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk70.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-6-15-Kibana界面添加索引"><a href="#5-6-15-Kibana界面添加索引" class="headerlink" title="5.6.15 Kibana界面添加索引"></a>5.6.15 Kibana界面添加索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk71.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk72.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-6-16-Kibana验证数据"><a href="#5-6-16-Kibana验证数据" class="headerlink" title="5.6.16 Kibana验证数据"></a>5.6.16 Kibana验证数据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk73.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-7-Logstash收集日志并写入redis"><a href="#5-7-Logstash收集日志并写入redis" class="headerlink" title="5.7 Logstash收集日志并写入redis"></a>5.7 Logstash收集日志并写入redis</h2><p>用一台服务器按照部署 redis 服务，专门用于日志缓存使用，用于 web 服务器产生大量日志的场景，例如下面的服务器内存即将被使用完毕，查看是因为 redis服务保存了大量的数据没有被读取而占用了大量的内存空间。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk135.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-1-部署redis"><a href="#5-7-1-部署redis" class="headerlink" title="5.7.1 部署redis"></a>5.7.1 部署redis</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt update</span><br><br><span class="hljs-comment"># apt install -y redis</span><br><br><span class="hljs-comment"># vim /etc/redis/redis.conf</span><br><span class="hljs-comment"># grep &quot;^[a-Z]&quot;/etc/redis/redis.conf</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br>protected-mode yes<br>port 6379<br>tcp-backlog 511<br>timeout 0<br>tcp-keepalive 300<br>daemonize yes<br>supervised no<br>pidfile /var/run/redis_6379.pid<br>loglevel notice<br>logfile <span class="hljs-string">&quot;&quot;</span><br>databases 16<br>save <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment">#不需要做快照</span><br>rdbcompression no <span class="hljs-comment">#是否压缩</span><br>rdbchecksum no <span class="hljs-comment">#是否校验</span><br></code></pre></td></tr></table></figure>

<h3 id="5-7-2-设置redis访问密码"><a href="#5-7-2-设置redis访问密码" class="headerlink" title="5.7.2 设置redis访问密码"></a>5.7.2 设置redis访问密码</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; config <span class="hljs-built_in">set</span> requirepass 12345678 <span class="hljs-comment">#动态设置，重启后无效</span><br>OK<br><br><span class="hljs-comment"># vim /etc/redis/redis.conf</span><br>480 requirepass 123456 <span class="hljs-comment">#redis.conf 配置文件</span><br></code></pre></td></tr></table></figure>

<h3 id="5-7-3-启动并测试redis服务"><a href="#5-7-3-启动并测试redis服务" class="headerlink" title="5.7.3 启动并测试redis服务"></a>5.7.3 启动并测试redis服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl start redis</span><br><span class="hljs-comment"># lsof -i:6379</span><br>COMMAND    PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>redis-ser 2459 redis    6u  IPv4  34940      0t0  TCP localhost:6379 (LISTEN)<br>redis-ser 2459 redis    7u  IPv6  34941      0t0  TCP localhost:6379 (LISTEN)<br><span class="hljs-comment"># redis-cli</span><br>127.0.0.1:6379&gt; ping<br>PONG<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk74.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-4-配置Logstash将日志写入至redis"><a href="#5-7-4-配置Logstash将日志写入至redis" class="headerlink" title="5.7.4 配置Logstash将日志写入至redis"></a>5.7.4 配置Logstash将日志写入至redis</h3><p>将 tomcat 服务器的 logstash 收集之后的 tomcat 访问日志写入到 redis 服务器，然后通过另外的 logstash 将 redis 服务器的数据取出在写入到 elasticsearch 服务器。</p>
<p>官 方 文 档 ： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html">https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#tomcat日志</span><br><span class="hljs-comment"># vim /etc/logstash/conf.d/tomcat-accesslog-to-redis.conf</span><br>input &#123;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/apps/tomcat/logs/tomcat_access_log.*.log&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;tomcat-access-log&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>    &#125;<br>&#125;<br><br>output &#123; <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;tomcat-access-log&quot;</span> &#123;<br>        redis &#123;<br>            host =&gt;<span class="hljs-string">&quot;172.31.2.106&quot;</span><br>            port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>            password =&gt; 123456<br>            db =&gt; 1<br>            data_type =&gt; list<br>            key =&gt; <span class="hljs-string">&quot;rlin-tomcat-accesslog&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rlin-nginxlog-to-es.conf -t</span><br><br><span class="hljs-comment">#系统日志</span><br><span class="hljs-comment"># vim /etc/logstash/conf.d/syslog-to-redis.conf</span><br>input &#123;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/syslog&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;syslog-to-redis&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>    &#125;<br>&#125;<br><br>output &#123; <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;syslog-to-redis&quot;</span> &#123;<br>        redis &#123;<br>            host =&gt;<span class="hljs-string">&quot;172.31.2.106&quot;</span><br>            port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>            password =&gt; 123456<br>            db =&gt; 1<br>            data_type =&gt; list<br>            key =&gt; <span class="hljs-string">&quot;rlin-syslog&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/syslog-to-redis.conf -t</span><br><br><span class="hljs-comment">#nginx日志</span><br><span class="hljs-comment"># vim /etc/logstash/conf.d/nginxlog-to-es.conf</span><br>input &#123;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/apps/nginx/logs/access.log&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;nginx-access-log&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>    &#125;<br>&#125;<br><br>output &#123; <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;nginx-access-log&quot;</span> &#123;<br>        redis &#123;<br>            host =&gt;<span class="hljs-string">&quot;172.31.2.106&quot;</span><br>            port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>            password =&gt; 123456<br>            db =&gt; 1<br>            data_type =&gt; list<br>            key =&gt; <span class="hljs-string">&quot;rlin-nginx-accesslog&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginxlog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h3 id="5-7-5-测试Logstash配置文件语法是否正确"><a href="#5-7-5-测试Logstash配置文件语法是否正确" class="headerlink" title="5.7.5 测试Logstash配置文件语法是否正确"></a>5.7.5 测试Logstash配置文件语法是否正确</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f tomcat-accesslog-to-redis.conf -t</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk75.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-6-访问tomcat的web界面并生成系统日志"><a href="#5-7-6-访问tomcat的web界面并生成系统日志" class="headerlink" title="5.7.6 访问tomcat的web界面并生成系统日志"></a>5.7.6 访问tomcat的web界面并生成系统日志</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk76.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-7-验证redis是否有数据"><a href="#5-7-7-验证redis是否有数据" class="headerlink" title="5.7.7 验证redis是否有数据"></a>5.7.7 验证redis是否有数据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk77.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-8-配置其他Logstash服务器从redis读取数据"><a href="#5-7-8-配置其他Logstash服务器从redis读取数据" class="headerlink" title="5.7.8 配置其他Logstash服务器从redis读取数据"></a>5.7.8 配置其他Logstash服务器从redis读取数据</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#logstash从redis取tomcat日志</span><br><span class="hljs-comment"># vim /etc/logstash/conf.d/redis-tomcat-accesslog-to-es.conf</span><br>input &#123;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;1&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-tomcat-accesslog&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span> <br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;tomcat-access-log&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-tomcat-accesslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#logstash从redis系统日志</span><br><span class="hljs-comment"># vim /etc/logstash/conf.d/redis-syslog-to-es.conf</span><br>input &#123;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;1&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-syslog&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;syslog-to-redis&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.102:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><br><br><span class="hljs-comment">#logstash从redis取nginx日志</span><br><span class="hljs-comment"># vim /etc/logstash/conf.d/redis-nginx-accesslog-to-es.conf</span><br>input &#123;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;1&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-nginx-accesslog&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span> <br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;nginx-access-log&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.103:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-nginx-accesslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<h3 id="5-7-9-测试Logstash"><a href="#5-7-9-测试Logstash" class="headerlink" title="5.7.9 测试Logstash"></a>5.7.9 测试Logstash</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-nginx-accesslog-to-es.conf -t</span><br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-syslog-to-es.conf -t</span><br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-nginx-accesslog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk78.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-10-验证redis的数据是否被去除"><a href="#5-7-10-验证redis的数据是否被去除" class="headerlink" title="5.7.10 验证redis的数据是否被去除"></a>5.7.10 验证redis的数据是否被去除</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk79.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-11-在head插件验证数据"><a href="#5-7-11-在head插件验证数据" class="headerlink" title="5.7.11 在head插件验证数据"></a>5.7.11 在head插件验证数据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk80.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-12-Kibana添加tomcat访问日志索引"><a href="#5-7-12-Kibana添加tomcat访问日志索引" class="headerlink" title="5.7.12 Kibana添加tomcat访问日志索引"></a>5.7.12 Kibana添加tomcat访问日志索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk81.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-13-Kibana添加系统日志索引"><a href="#5-7-13-Kibana添加系统日志索引" class="headerlink" title="5.7.13 Kibana添加系统日志索引"></a>5.7.13 Kibana添加系统日志索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk83.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-17-14-Kibana添加nginx日志索引"><a href="#5-17-14-Kibana添加nginx日志索引" class="headerlink" title="5.17.14 Kibana添加nginx日志索引"></a>5.17.14 Kibana添加nginx日志索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk84.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-15-Kibana验证tomcat访问日志"><a href="#5-7-15-Kibana验证tomcat访问日志" class="headerlink" title="5.7.15 Kibana验证tomcat访问日志"></a>5.7.15 Kibana验证tomcat访问日志</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk82.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-16-Kibana验证系统日志"><a href="#5-7-16-Kibana验证系统日志" class="headerlink" title="5.7.16 Kibana验证系统日志"></a>5.7.16 Kibana验证系统日志</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk85.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-17-Kibana验证nginx日志"><a href="#5-7-17-Kibana验证nginx日志" class="headerlink" title="5.7.17 Kibana验证nginx日志"></a>5.7.17 Kibana验证nginx日志</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk86.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-8-Logstash收集日志并写入kafka"><a href="#5-8-Logstash收集日志并写入kafka" class="headerlink" title="5.8 Logstash收集日志并写入kafka"></a>5.8 Logstash收集日志并写入kafka</h2><h3 id="5-8-1-配置Logstash收集单日志文件"><a href="#5-8-1-配置Logstash收集单日志文件" class="headerlink" title="5.8.1 配置Logstash收集单日志文件"></a>5.8.1 配置Logstash收集单日志文件</h3><h4 id="5-8-1-1-收集单个Nginx日志文件配置"><a href="#5-8-1-1-收集单个Nginx日志文件配置" class="headerlink" title="5.8.1.1 收集单个Nginx日志文件配置"></a>5.8.1.1 收集单个Nginx日志文件配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/rlin-nginx-to-kafka.conf</span><br>input &#123;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/apps/nginx/logs/access.log&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;nginx-access-log&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>    &#125;<br>&#125;<br><br>output &#123; <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;nginx-access-log&quot;</span> &#123;<br>        kafka &#123;<br>            bootstrap_servers =&gt; <span class="hljs-string">&quot;192.168.15.11:9092&quot;</span> <span class="hljs-comment">#kafka 服务器地址</span><br>            topic_id =&gt; <span class="hljs-string">&quot;nginx-access-log&quot;</span><br>            codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rlin-nginx-to-kafaka.conf -t</span><br></code></pre></td></tr></table></figure>

<h4 id="5-8-1-2-重启Logstash"><a href="#5-8-1-2-重启Logstash" class="headerlink" title="5.8.1.2 重启Logstash"></a>5.8.1.2 重启Logstash</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl restart logstash<br></code></pre></td></tr></table></figure>

<h4 id="5-8-1-3-访问Nginx-Web界面"><a href="#5-8-1-3-访问Nginx-Web界面" class="headerlink" title="5.8.1.3 访问Nginx Web界面"></a>5.8.1.3 访问Nginx Web界面</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk108.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-8-1-4-验证日志写入到kafka服务器"><a href="#5-8-1-4-验证日志写入到kafka服务器" class="headerlink" title="5.8.1.4 验证日志写入到kafka服务器"></a>5.8.1.4 验证日志写入到kafka服务器</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk109.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-8-1-5-配置Logstash从kafka读取日志"><a href="#5-8-1-5-配置Logstash从kafka读取日志" class="headerlink" title="5.8.1.5 配置Logstash从kafka读取日志"></a>5.8.1.5 配置Logstash从kafka读取日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/rlin-nginx-accesslog-to-es.conf</span><br>input &#123;<br>    kafka &#123;<br>        bootstrap_servers =&gt; <span class="hljs-string">&quot;192.168.15.11:9092&quot;</span><br>        topics =&gt; <span class="hljs-string">&quot;nginx-access-log&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>        consumer_threads =&gt; 1<br>        <span class="hljs-comment">#decorate_events =&gt; true #是否装饰事件</span><br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;nginx-access-log&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.103:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-kafka-nginx-accesslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-8-1-6-测试语法并重启Logstash"><a href="#5-8-1-6-测试语法并重启Logstash" class="headerlink" title="5.8.1.6 测试语法并重启Logstash"></a>5.8.1.6 测试语法并重启Logstash</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rlin-nginx-accesslog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h4 id="5-8-1-7-在head插件验证数据"><a href="#5-8-1-7-在head插件验证数据" class="headerlink" title="5.8.1.7 在head插件验证数据"></a>5.8.1.7 在head插件验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk110.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-8-1-9-Kibana添加Nginx访问日志索引"><a href="#5-8-1-9-Kibana添加Nginx访问日志索引" class="headerlink" title="5.8.1.9 Kibana添加Nginx访问日志索引"></a>5.8.1.9 Kibana添加Nginx访问日志索引</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk111.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-8-2-使用logstash收集多日志并写入kafka"><a href="#5-8-2-使用logstash收集多日志并写入kafka" class="headerlink" title="5.8.2 使用logstash收集多日志并写入kafka"></a>5.8.2 使用logstash收集多日志并写入kafka</h3><h4 id="5-8-2-1-配置Logstash收集message日志"><a href="#5-8-2-1-配置Logstash收集message日志" class="headerlink" title="5.8.2.1 配置Logstash收集message日志"></a>5.8.2.1 配置Logstash收集message日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/logstash/conf.d/rlin-syslog-to-kafka.conf<br>input &#123;<br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/syslog&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;syslog-to-kafka&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>    &#125;<br>    <br>    file &#123;<br>        path =&gt; <span class="hljs-string">&quot;/var/log/vmware-network*&quot;</span><br>        start_position =&gt; <span class="hljs-string">&quot;beginning&quot;</span><br>        <span class="hljs-built_in">type</span> =&gt; <span class="hljs-string">&quot;vmware-log-to-kafka&quot;</span><br>        stat_interval =&gt; <span class="hljs-string">&quot;3&quot;</span><br>    &#125;<br>&#125;<br><br>output &#123; <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;syslog-to-kafka&quot;</span> &#123;<br>        kafka &#123;<br>            bootstrap_servers =&gt; <span class="hljs-string">&quot;192.168.15.11:9092&quot;</span> <span class="hljs-comment">#kafka 服务器地址</span><br>            topic_id =&gt; <span class="hljs-string">&quot;system-log&quot;</span><br>            codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;vmware-log-to-kafka&quot;</span> &#123;<br>        kafka &#123;<br>            bootstrap_servers =&gt; <span class="hljs-string">&quot;192.168.15.11:9092&quot;</span> <span class="hljs-comment">#kafka 服务器地址</span><br>            topic_id =&gt; <span class="hljs-string">&quot;vmware-log&quot;</span><br>            codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-8-2-2-测试并重启Logstash"><a href="#5-8-2-2-测试并重启Logstash" class="headerlink" title="5.8.2.2 测试并重启Logstash"></a>5.8.2.2 测试并重启Logstash</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rlin-syslog-to-kafka.conf -t</span><br><br><span class="hljs-comment"># systemclt restart logstash</span><br></code></pre></td></tr></table></figure>

<h4 id="5-8-2-3-验证日志写入到kafka"><a href="#5-8-2-3-验证日志写入到kafka" class="headerlink" title="5.8.2.3 验证日志写入到kafka"></a>5.8.2.3 验证日志写入到kafka</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/local/kafka/bin/kafka-topics.sh --list --zookeeper 192.168.15.11:2181,192.168.15.12:2181,192.168.15.13:2181</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk112.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-8-2-4-配置Logstash从kafka读取系统日志"><a href="#5-8-2-4-配置Logstash从kafka读取系统日志" class="headerlink" title="5.8.2.4 配置Logstash从kafka读取系统日志"></a>5.8.2.4 配置Logstash从kafka读取系统日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/logstash/conf.d/kafka-syslog-to-es.conf<br>input &#123;<br>    kafka &#123;<br>        bootstrap_servers =&gt; <span class="hljs-string">&quot;192.168.15.11:9092&quot;</span><br>        topics =&gt; <span class="hljs-string">&quot;system-log&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>        consumer_threads =&gt; 1<br>        <span class="hljs-comment">#decorate_events =&gt; true #是否装饰事件</span><br>    &#125;<br>    <br>     kafka &#123;<br>        bootstrap_servers =&gt; <span class="hljs-string">&quot;192.168.15.11:9092&quot;</span><br>        topics =&gt; <span class="hljs-string">&quot;vmware-log&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>        consumer_threads =&gt; 1<br>        <span class="hljs-comment">#decorate_events =&gt; true #是否装饰事件</span><br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;syslog-to-kafka&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.103:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-kafka-systemlog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>    <br>     <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;vmware-log-to-kafka&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.103:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-kafka-vmwarelog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-8-2-6-验证配置并启动Logstash"><a href="#5-8-2-6-验证配置并启动Logstash" class="headerlink" title="5.8.2.6 验证配置并启动Logstash"></a>5.8.2.6 验证配置并启动Logstash</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/kafka-syslog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h4 id="5-8-2-7-在head插件验证数据"><a href="#5-8-2-7-在head插件验证数据" class="headerlink" title="5.8.2.7 在head插件验证数据"></a>5.8.2.7 在head插件验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk113.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-8-2-8-在Kibana添加索引"><a href="#5-8-2-8-在Kibana添加索引" class="headerlink" title="5.8.2.8 在Kibana添加索引"></a>5.8.2.8 在Kibana添加索引</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk114.ng" srcset="/blog/img/loading.gif" alt="114"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk115.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-9-使用filebeat收集日志并写入redis"><a href="#5-9-使用filebeat收集日志并写入redis" class="headerlink" title="5.9 使用filebeat收集日志并写入redis"></a>5.9 使用filebeat收集日志并写入redis</h2><h3 id="5-9-1-服务器安装filebeat"><a href="#5-9-1-服务器安装filebeat" class="headerlink" title="5.9.1 服务器安装filebeat"></a>5.9.1 服务器安装filebeat</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># dpkg -i filebeat-7.6.2-amd64.deb</span><br></code></pre></td></tr></table></figure>

<h3 id="5-9-2-使用filebeat收集单个系统日志"><a href="#5-9-2-使用filebeat收集单个系统日志" class="headerlink" title="5.9.2 使用filebeat收集单个系统日志"></a>5.9.2 使用filebeat收集单个系统日志</h3><h4 id="5-9-2-1-修改filebeat配置文件"><a href="#5-9-2-1-修改filebeat配置文件" class="headerlink" title="5.9.2.1 修改filebeat配置文件"></a>5.9.2.1 修改filebeat配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/filebeat/filebeat.yml</span><br>=====filebeat inputs=====<br><span class="hljs-built_in">enable</span>: <span class="hljs-literal">true</span><br>paths:<br>  - /var/<span class="hljs-built_in">log</span>/syslog<br>fields:<br>  <span class="hljs-built_in">type</span>: systemlog<br>  host: 172.31.2.104<br><br><span class="hljs-comment">#在中间的发送日志到elasticsearch的要注释</span><br>    <br><span class="hljs-comment">#在配置文件的最后面添加</span><br>output.redis:<br>  hosts: [<span class="hljs-string">&quot;172.31.2.106&quot;</span>] <span class="hljs-comment">#redis默认端口是6379，如果目标端口不是6379就在后面写上端口</span><br>  password: <span class="hljs-string">&quot;123456&quot;</span><br>  key: <span class="hljs-string">&quot;rlin-filebeat-log&quot;</span><br>  db: 2<br>  timeout: 5<br></code></pre></td></tr></table></figure>

<h4 id="5-9-2-2-启动filebeat并验证redis是否有数据"><a href="#5-9-2-2-启动filebeat并验证redis是否有数据" class="headerlink" title="5.9.2.2 启动filebeat并验证redis是否有数据"></a>5.9.2.2 启动filebeat并验证redis是否有数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart filebeat</span><br><br><span class="hljs-comment"># redis-cli</span><br>AUTH 123456<br>SELECT 2<br>KEY *<br><br>RPOP rlin-filebeat-log<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk87.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-9-2-3-配置Logstash从redis读取日志到Elasticsearch"><a href="#5-9-2-3-配置Logstash从redis读取日志到Elasticsearch" class="headerlink" title="5.9.2.3 配置Logstash从redis读取日志到Elasticsearch"></a>5.9.2.3 配置Logstash从redis读取日志到Elasticsearch</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/redis-syslog-to-es.conf</span><br>input &#123;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;2&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-filebeat-log&quot;</span><br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span> &#123; <span class="hljs-comment">#type的值是在filebeat里syslog里设置的</span><br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-9-2-4-验证配置并重启Logstash"><a href="#5-9-2-4-验证配置并重启Logstash" class="headerlink" title="5.9.2.4 验证配置并重启Logstash"></a>5.9.2.4 验证配置并重启Logstash</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-syslog-to-es.conf -t</span><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h4 id="5-9-2-5-在head插件验证数据"><a href="#5-9-2-5-在head插件验证数据" class="headerlink" title="5.9.2.5 在head插件验证数据"></a>5.9.2.5 在head插件验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk88.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-9-2-6-在Kibana界面添加索引"><a href="#5-9-2-6-在Kibana界面添加索引" class="headerlink" title="5.9.2.6 在Kibana界面添加索引"></a>5.9.2.6 在Kibana界面添加索引</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk89.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-9-2-7-Kibana验证数据"><a href="#5-9-2-7-Kibana验证数据" class="headerlink" title="5.9.2.7 Kibana验证数据"></a>5.9.2.7 Kibana验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk90.png" srcset="/blog/img/loading.gif" alt="90"></p>
<h3 id="5-9-3-使用filebeat在收集多个日志文件"><a href="#5-9-3-使用filebeat在收集多个日志文件" class="headerlink" title="5.9.3 使用filebeat在收集多个日志文件"></a>5.9.3 使用filebeat在收集多个日志文件</h3><h4 id="5-9-3-1-修改filebeat配置文件"><a href="#5-9-3-1-修改filebeat配置文件" class="headerlink" title="5.9.3.1 修改filebeat配置文件"></a>5.9.3.1 修改filebeat配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/filebeat/filebeat.yml</span><br>......<br>- <span class="hljs-built_in">type</span>: <span class="hljs-built_in">log</span><br>  enabled: <span class="hljs-literal">true</span><br>  paths:<br>    - /apps/tomcat/logs/catalina.out<br>  fields:<br>    <span class="hljs-built_in">type</span>: catalina-log<br><br>===== filebeat modules =====<br></code></pre></td></tr></table></figure>

<h4 id="5-9-3-2-重启filebeat"><a href="#5-9-3-2-重启filebeat" class="headerlink" title="5.9.3.2 重启filebeat"></a>5.9.3.2 重启filebeat</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart filebeat</span><br></code></pre></td></tr></table></figure>

<h4 id="5-9-3-3-验证是否写入redis"><a href="#5-9-3-3-验证是否写入redis" class="headerlink" title="5.9.3.3 验证是否写入redis"></a>5.9.3.3 验证是否写入redis</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk91.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-9-3-4-配置Logstash从redis读取日志到Elasticsearch"><a href="#5-9-3-4-配置Logstash从redis读取日志到Elasticsearch" class="headerlink" title="5.9.3.4 配置Logstash从redis读取日志到Elasticsearch"></a>5.9.3.4 配置Logstash从redis读取日志到Elasticsearch</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/redis-syslog-to-es.conf</span><br>input &#123;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;2&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-filebeat-log&quot;</span><br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span> &#123; <span class="hljs-comment">#type的值是在filebeat里syslog里设置的</span><br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;catalina-log&quot;</span> &#123; <span class="hljs-comment">#type的值是在filebeat里syslog里设置的</span><br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-nginxcalog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-9-3-5-验证配置并重启Logstash"><a href="#5-9-3-5-验证配置并重启Logstash" class="headerlink" title="5.9.3.5 验证配置并重启Logstash"></a>5.9.3.5 验证配置并重启Logstash</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-syslog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h4 id="5-9-3-6-在head插件验证数据"><a href="#5-9-3-6-在head插件验证数据" class="headerlink" title="5.9.3.6 在head插件验证数据"></a>5.9.3.6 在head插件验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk92.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-9-3-7-在Kibana界面添加索引"><a href="#5-9-3-7-在Kibana界面添加索引" class="headerlink" title="5.9.3.7 在Kibana界面添加索引"></a>5.9.3.7 在Kibana界面添加索引</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk93.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-9-3-8-Kibana验证数据"><a href="#5-9-3-8-Kibana验证数据" class="headerlink" title="5.9.3.8 Kibana验证数据"></a>5.9.3.8 Kibana验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk94.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-10-使用filebeat收集日志并写入kafka"><a href="#5-10-使用filebeat收集日志并写入kafka" class="headerlink" title="5.10 使用filebeat收集日志并写入kafka"></a>5.10 使用filebeat收集日志并写入kafka</h2><h3 id="5-10-1-服务器安装filebeat"><a href="#5-10-1-服务器安装filebeat" class="headerlink" title="5.10.1 服务器安装filebeat"></a>5.10.1 服务器安装filebeat</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># dpkg -i filebeat-7.6.2-amd64.deb</span><br></code></pre></td></tr></table></figure>

<h3 id="5-10-2-使用filebeat收集单个系统日志"><a href="#5-10-2-使用filebeat收集单个系统日志" class="headerlink" title="5.10.2 使用filebeat收集单个系统日志"></a>5.10.2 使用filebeat收集单个系统日志</h3><h4 id="5-10-2-1-配置filebeat收集日志"><a href="#5-10-2-1-配置filebeat收集日志" class="headerlink" title="5.10.2.1 配置filebeat收集日志"></a>5.10.2.1 配置filebeat收集日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/filebeat/filebeat.yml</span><br>=====filebeat inputs=====<br><span class="hljs-built_in">enable</span>: <span class="hljs-literal">true</span><br>paths:<br>  - /var/<span class="hljs-built_in">log</span>/syslog<br>fields:<br>    <span class="hljs-built_in">type</span>: systemlog<br>    host: 172.31.2.104<br>    <br><span class="hljs-comment">#在文件的最后添加</span><br>output.kafka: <span class="hljs-comment">#写入 kafka</span><br>  hosts: [<span class="hljs-string">&quot;192.168.15.11:9092&quot;</span>,<span class="hljs-string">&quot;192.168.15.12:9092&quot;</span>,<span class="hljs-string">&quot;192.168.15.13:9092&quot;</span>]<br>  topic: <span class="hljs-string">&quot;filebeat-logs&quot;</span><br>  partition.round_robin:<br>    reachable_only: <span class="hljs-literal">true</span><br>  required_acks: 1 <span class="hljs-comment">#本地写入完成</span><br>  compression: gzip <span class="hljs-comment">#开启压缩</span><br>  max_message_bytes: 1000000 <span class="hljs-comment">#消息最大值</span><br></code></pre></td></tr></table></figure>

<h4 id="5-10-2-2-启动filebeat"><a href="#5-10-2-2-启动filebeat" class="headerlink" title="5.10.2.2 启动filebeat"></a>5.10.2.2 启动filebeat</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart filebeat</span><br></code></pre></td></tr></table></figure>

<h4 id="5-10-2-3-验证是否写入kafka"><a href="#5-10-2-3-验证是否写入kafka" class="headerlink" title="5.10.2.3 验证是否写入kafka"></a>5.10.2.3 验证是否写入kafka</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/local/kafka/bin/kafka-topics.sh --list --zookpeeper 192.168.15.11:2181,192.168.15.12:2181,192.168.15.13:2181</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk116.png" srcset="/blog/img/loading.gif" alt="116"></p>
<h4 id="5-10-2-4-配置Logstash从kafka读取日志到Elasticsearch"><a href="#5-10-2-4-配置Logstash从kafka读取日志到Elasticsearch" class="headerlink" title="5.10.2.4 配置Logstash从kafka读取日志到Elasticsearch"></a>5.10.2.4 配置Logstash从kafka读取日志到Elasticsearch</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/kafka-syslog-to-es.conf</span><br>input &#123;   <br>     kafka &#123;<br>        bootstrap_servers =&gt; <span class="hljs-string">&quot;192.168.15.11:9092&quot;</span><br>        topics =&gt; <span class="hljs-string">&quot;filebeat-logs&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>        consumer_threads =&gt; 1<br>        <span class="hljs-comment">#decorate_events =&gt; true #是否装饰事件</span><br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span> &#123; <span class="hljs-comment">#type的值是在filebeat里syslog里设置的</span><br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-10-2-5-验证配置并重启Logstash"><a href="#5-10-2-5-验证配置并重启Logstash" class="headerlink" title="5.10.2.5 验证配置并重启Logstash"></a>5.10.2.5 验证配置并重启Logstash</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/kafka-syslog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h4 id="5-10-2-6-在head插件验证数据"><a href="#5-10-2-6-在head插件验证数据" class="headerlink" title="5.10.2.6 在head插件验证数据"></a>5.10.2.6 在head插件验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk117.png" srcset="/blog/img/loading.gif" alt="117"></p>
<h4 id="5-10-2-7-在Kibana界面添加索引"><a href="#5-10-2-7-在Kibana界面添加索引" class="headerlink" title="5.10.2.7 在Kibana界面添加索引"></a>5.10.2.7 在Kibana界面添加索引</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk118.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-10-2-8-syslog追加日志"><a href="#5-10-2-8-syslog追加日志" class="headerlink" title="5.10.2.8 syslog追加日志"></a>5.10.2.8 syslog追加日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp /var/log/syslog /var/log/syslog.bak</span><br><span class="hljs-comment"># cat /var/log/syslog.bak &gt;&gt; /var/log/syslog</span><br></code></pre></td></tr></table></figure>

<h4 id="5-10-2-9-Kibana验证数据"><a href="#5-10-2-9-Kibana验证数据" class="headerlink" title="5.10.2.9 Kibana验证数据"></a>5.10.2.9 Kibana验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk119.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-10-3-使用filebeat在收集多个日志文件"><a href="#5-10-3-使用filebeat在收集多个日志文件" class="headerlink" title="5.10.3 使用filebeat在收集多个日志文件"></a>5.10.3 使用filebeat在收集多个日志文件</h3><h4 id="5-10-3-1-配置filebeat再收集Nginx访问日志"><a href="#5-10-3-1-配置filebeat再收集Nginx访问日志" class="headerlink" title="5.10.3.1 配置filebeat再收集Nginx访问日志"></a>5.10.3.1 配置filebeat再收集Nginx访问日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/filebeat/filebeat.yml</span><br>......<br>- <span class="hljs-built_in">type</span>: <span class="hljs-built_in">log</span> <span class="hljs-comment">#使用这个格式可以收集多个日志</span><br>  enabled: <span class="hljs-literal">true</span><br>  paths:<br>    - /apps/tomcat/logs/catalina.out<br>  fields:<br>    <span class="hljs-built_in">type</span>: catalina-log<br><br>===== filebeat modules =====<br></code></pre></td></tr></table></figure>

<h4 id="5-10-3-2-重启filebeat"><a href="#5-10-3-2-重启filebeat" class="headerlink" title="5.10.3.2 重启filebeat"></a>5.10.3.2 重启filebeat</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart filebeat</span><br></code></pre></td></tr></table></figure>

<h4 id="5-10-3-3-验证是否写入kafka"><a href="#5-10-3-3-验证是否写入kafka" class="headerlink" title="5.10.3.3 验证是否写入kafka"></a>5.10.3.3 验证是否写入kafka</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/local/kafka/bin/kafka-topics.sh --list --zookeeper 192.168.15.11:2181,192.168.15.12:2181,192.168.15.13:2181</span><br></code></pre></td></tr></table></figure>

<h4 id="5-10-3-4-配置Logstash从kafka读取nginx日志写入Elasticsearch"><a href="#5-10-3-4-配置Logstash从kafka读取nginx日志写入Elasticsearch" class="headerlink" title="5.10.3.4 配置Logstash从kafka读取nginx日志写入Elasticsearch"></a>5.10.3.4 配置Logstash从kafka读取nginx日志写入Elasticsearch</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/kafka-syslog-to-es.conf</span><br>input &#123;   <br>     kafka &#123;<br>        bootstrap_servers =&gt; <span class="hljs-string">&quot;192.168.15.11:9092&quot;</span><br>        topics =&gt; <span class="hljs-string">&quot;filebeat-logs&quot;</span><br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>        consumer_threads =&gt; 1<br>        <span class="hljs-comment">#decorate_events =&gt; true #是否装饰事件</span><br>    &#125;<br>&#125;<br><br>output &#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span> &#123; <span class="hljs-comment">#type的值是在filebeat里syslog里设置的</span><br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;catalina-log&quot;</span> &#123; <span class="hljs-comment">#type的值是在filebeat里syslog里设置的</span><br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-nginxcalog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-10-3-5-测试配置文件并重启"><a href="#5-10-3-5-测试配置文件并重启" class="headerlink" title="5.10.3.5 测试配置文件并重启"></a>5.10.3.5 测试配置文件并重启</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/kafka-syslog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h4 id="5-10-3-6-在head插件验证数据"><a href="#5-10-3-6-在head插件验证数据" class="headerlink" title="5.10.3.6 在head插件验证数据"></a>5.10.3.6 在head插件验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk120.png" srcset="/blog/img/loading.gif" alt="120"></p>
<h4 id="5-10-3-7-在Kibana界面添加索引"><a href="#5-10-3-7-在Kibana界面添加索引" class="headerlink" title="5.10.3.7 在Kibana界面添加索引"></a>5.10.3.7 在Kibana界面添加索引</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk121.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-10-3-8-Kibana界面验证数据"><a href="#5-10-3-8-Kibana界面验证数据" class="headerlink" title="5.10.3.8 Kibana界面验证数据"></a>5.10.3.8 Kibana界面验证数据</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk122.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-11-filebeat收集日志并写入logstash"><a href="#5-11-filebeat收集日志并写入logstash" class="headerlink" title="5.11 filebeat收集日志并写入logstash"></a>5.11 filebeat收集日志并写入logstash</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/logstash-output.html">https://www.elastic.co/guide/en/beats/filebeat/current/logstash-output.html</a></p>
<p>目前只收集了系统日志，下面将 tomcat 的访问日志和启动时生成的 catalina.txt文件的日志进行收集，另外测试多行匹配，并将输出改为 logstash 进根据日志类型判断写入到不同的 redis key 当中，在一个 filebeat 服务上面同时收集不同类型的日志，比如收集系统日志的时候还要收集 tomcat 的访问日志，那么直接带来的问题就是要在写入至 redis 的时候要根据不同的日志类型写入到 reids 不通的<br>key 当中，首先通过 logstash 监听一个端口，并做标准输出测试。</p>
<h3 id="5-11-1-结合-logstash-进行输出测试"><a href="#5-11-1-结合-logstash-进行输出测试" class="headerlink" title="5.11.1 结合 logstash 进行输出测试"></a>5.11.1 结合 logstash 进行输出测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/beats.conf</span><br>input &#123;<br>    beats &#123;<br>        host =&gt; <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>        port =&gt; 5044<br>    &#125;<br>&#125;<br><br>output&#123;<br>    stdout &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-11-2-测试语法并启动"><a href="#5-11-2-测试语法并启动" class="headerlink" title="5.11.2 测试语法并启动"></a>5.11.2 测试语法并启动</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf -t</span><br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-3-检查端口是否有被启动"><a href="#5-11-3-检查端口是否有被启动" class="headerlink" title="5.11.3 检查端口是否有被启动"></a>5.11.3 检查端口是否有被启动</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@log-node1:~<span class="hljs-comment"># ss -tnl</span><br>State          Recv-Q          Send-Q                         Local Address:Port                    Peer Address:Port                <br>LISTEN         0               20480                                      *:5044                               *:*<br><br><span class="hljs-comment"># lsof -i:5044</span><br>COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>java    5070 root  121u  IPv6  69605      0t0  TCP *:5044 (LISTEN)<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk95.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-11-4-将fliebeat的输出指向logstash"><a href="#5-11-4-将fliebeat的输出指向logstash" class="headerlink" title="5.11.4 将fliebeat的输出指向logstash"></a>5.11.4 将fliebeat的输出指向logstash</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/filebeat/filebeat.yml</span><br>.....<br><span class="hljs-comment">#在最后添加</span><br>output.logstash:<br>  hosts: [<span class="hljs-string">&quot;192.168.15.11:5044&quot;</span>] <span class="hljs-comment">#logstash 服务器地址，可以是多个</span><br>  enabled: <span class="hljs-literal">true</span> <span class="hljs-comment">#是否开启输出至 logstash，默认即为 true</span><br>  worker: 1 <span class="hljs-comment">#工作线程数</span><br>  <span class="hljs-comment">#compression_level: 3 #压缩级别</span><br>  <span class="hljs-comment">#loadbalance: true #多个输出的时候开启负载</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-5-重启filebeat"><a href="#5-11-5-重启filebeat" class="headerlink" title="5.11.5 重启filebeat"></a>5.11.5 重启filebeat</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart filebeat</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-6-查看filebeat是否有将日志写入到logstash"><a href="#5-11-6-查看filebeat是否有将日志写入到logstash" class="headerlink" title="5.11.6 查看filebeat是否有将日志写入到logstash"></a>5.11.6 查看filebeat是否有将日志写入到logstash</h3><p>原来在测试的logstash不要取消测试，没有日志的可以追加</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk96.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-11-7-修改logstash配置文件，将收集到的日志分类输出"><a href="#5-11-7-修改logstash配置文件，将收集到的日志分类输出" class="headerlink" title="5.11.7 修改logstash配置文件，将收集到的日志分类输出"></a>5.11.7 修改logstash配置文件，将收集到的日志分类输出</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/beats.conf</span><br>input &#123;<br>    beats &#123;<br>        host =&gt; <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>        port =&gt; 5044<br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>    &#125;<br>&#125;<br><br>output&#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span>&#123;<br>        stdout &#123;<br>            codec =&gt; <span class="hljs-string">&quot;rubydebug&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-11-8-测试并启动"><a href="#5-11-8-测试并启动" class="headerlink" title="5.11.8 测试并启动"></a>5.11.8 测试并启动</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf -t</span><br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-9-查看结果"><a href="#5-11-9-查看结果" class="headerlink" title="5.11.9 查看结果"></a>5.11.9 查看结果</h3><p>向syslog追加日志</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk97.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-11-10-修改logstash配置文件，将输出指向redis服务器"><a href="#5-11-10-修改logstash配置文件，将输出指向redis服务器" class="headerlink" title="5.11.10 修改logstash配置文件，将输出指向redis服务器"></a>5.11.10 修改logstash配置文件，将输出指向redis服务器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/beats.conf</span><br>input &#123;<br>    beats &#123;<br>        host =&gt; <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>        port =&gt; 5044<br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>    &#125;<br>&#125;<br><br>output&#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span>&#123;<br>        redis &#123;<br>            host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>            port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>            password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>            db =&gt; <span class="hljs-string">&quot;4&quot;</span><br>            data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>            key =&gt; <span class="hljs-string">&quot;rlin-filebeat-systemlog&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-11-11-测试并重启logstash"><a href="#5-11-11-测试并重启logstash" class="headerlink" title="5.11.11 测试并重启logstash"></a>5.11.11 测试并重启logstash</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-12-追加日志"><a href="#5-11-12-追加日志" class="headerlink" title="5.11.12 追加日志"></a>5.11.12 追加日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cp /var/log/syslog /var/log/syslog.bak #注意日志大小</span><br><span class="hljs-comment"># cat /var/log/syslog.bak &gt;&gt; /var/log/syslog</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-13-查看redis"><a href="#5-11-13-查看redis" class="headerlink" title="5.11.13 查看redis"></a>5.11.13 查看redis</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli</span><br>AUTH 123456<br>SELECT 4<br>KEY *<br>RPOP rlin-filebeat-systemlog<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk98.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-11-14-将redis日志写入到elasticsearch"><a href="#5-11-14-将redis日志写入到elasticsearch" class="headerlink" title="5.11.14 将redis日志写入到elasticsearch"></a>5.11.14 将redis日志写入到elasticsearch</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/filebeat-syslog-to-es.conf</span><br>input&#123;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;4&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-filebeat-systemlog&quot;</span><br>    &#125;<br>&#125;<br><br>output&#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-11-15-验证并重启"><a href="#5-11-15-验证并重启" class="headerlink" title="5.11.15 验证并重启"></a>5.11.15 验证并重启</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-16-查看es"><a href="#5-11-16-查看es" class="headerlink" title="5.11.16 查看es"></a>5.11.16 查看es</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk99.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-11-17-kibana添加索引"><a href="#5-11-17-kibana添加索引" class="headerlink" title="5.11.17 kibana添加索引"></a>5.11.17 kibana添加索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk100.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-11-18-filebeat收集多个日志"><a href="#5-11-18-filebeat收集多个日志" class="headerlink" title="5.11.18 filebeat收集多个日志"></a>5.11.18 filebeat收集多个日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#不用修改output</span><br><span class="hljs-comment"># vim /etc/filebeat/filebeat.yml</span><br>......<br>- <span class="hljs-built_in">type</span>: <span class="hljs-built_in">log</span> <span class="hljs-comment">#使用这个格式可以收集多个日志</span><br>  enabled: <span class="hljs-literal">true</span><br>  paths:<br>    - /apps/nginx/logs/access.log<br>  fields:<br>    <span class="hljs-built_in">type</span>: access-log<br><br>===== filebeat modules =====<br><br><span class="hljs-comment"># systemctl restart filebeat</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-19-修改logstash配置文件"><a href="#5-11-19-修改logstash配置文件" class="headerlink" title="5.11.19 修改logstash配置文件"></a>5.11.19 修改logstash配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/beats.conf</span><br>input &#123;<br>    beats &#123;<br>        host =&gt; <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>        port =&gt; 5044<br>        codec =&gt; <span class="hljs-string">&quot;json&quot;</span><br>    &#125;<br>&#125;<br><br>output&#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span>&#123;<br>        redis &#123;<br>            host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>            port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>            password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>            db =&gt; <span class="hljs-string">&quot;4&quot;</span><br>            data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>            key =&gt; <span class="hljs-string">&quot;rlin-filebeat-systemlog&quot;</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;access-log&quot;</span>&#123;<br>        redis &#123;<br>            host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>            port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>            password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>            db =&gt; <span class="hljs-string">&quot;4&quot;</span><br>            data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>            key =&gt; <span class="hljs-string">&quot;rlin-filebeat-nginx-accesslog&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-20-查看redis访问日志"><a href="#5-11-20-查看redis访问日志" class="headerlink" title="5.11.20 查看redis访问日志"></a>5.11.20 查看redis访问日志</h3><p>多访问几次nginx网页</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli</span><br>AUTH 123456<br>SELECT 4<br>KEY *<br>RPOP rlin-filebeat-nginx-accesslog<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk101.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-11-21-将redis日志写入到elasticsearch"><a href="#5-11-21-将redis日志写入到elasticsearch" class="headerlink" title="5.11.21 将redis日志写入到elasticsearch"></a>5.11.21 将redis日志写入到elasticsearch</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/filebeat-syslog-to-es.conf</span><br>input&#123;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;4&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-filebeat-systemlog&quot;</span><br>    &#125;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;4&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-filebeat-nginx-accesslog&quot;</span><br>    &#125;<br>&#125;<br><br>output&#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;access-log&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-nginx-accesslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/filebeat-syslog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-22-查看es"><a href="#5-11-22-查看es" class="headerlink" title="5.11.22 查看es"></a>5.11.22 查看es</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk102.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-11-23-kibana添加索引"><a href="#5-11-23-kibana添加索引" class="headerlink" title="5.11.23 kibana添加索引"></a>5.11.23 kibana添加索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk103.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-12-使用metricbeat从elasticsearch收集日志"><a href="#5-12-使用metricbeat从elasticsearch收集日志" class="headerlink" title="5.12 使用metricbeat从elasticsearch收集日志"></a>5.12 使用metricbeat从elasticsearch收集日志</h2><h3 id="5-12-1部署metricbeat"><a href="#5-12-1部署metricbeat" class="headerlink" title="5.12.1部署metricbeat"></a>5.12.1部署metricbeat</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#下载并安装metricbear</span><br><span class="hljs-comment"># dpkg -i metricbear-7.6.2-amd64.deb</span><br><span class="hljs-comment"># vim /etc/metricbear/metricbeat.yml</span><br><br>======== Kibana ========<br><br>host: <span class="hljs-string">&quot;172.3132.101:5601&quot;</span><br><br>-------- elas....--------<br><br>hosts: [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br><br><span class="hljs-comment"># systemctl restart metricbeat</span><br><span class="hljs-comment"># systemctl enable metricbeat</span><br></code></pre></td></tr></table></figure>

<h3 id="5-12-2-在kibana展示收集的数据"><a href="#5-12-2-在kibana展示收集的数据" class="headerlink" title="5.12.2 在kibana展示收集的数据"></a>5.12.2 在kibana展示收集的数据</h3><p>" srcset="/blog/img/loading.gif<img src=""></p>
<h2 id="5-13-使用heartbeat测试网络服务"><a href="#5-13-使用heartbeat测试网络服务" class="headerlink" title="5.13 使用heartbeat测试网络服务"></a>5.13 使用heartbeat测试网络服务</h2><h3 id="5-13-1-部署heartbeat"><a href="#5-13-1-部署heartbeat" class="headerlink" title="5.13.1 部署heartbeat"></a>5.13.1 部署heartbeat</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#下载并安装heartbeat</span><br><br><span class="hljs-comment"># dpkg -i heartbeat-7.6.2-amd64.deb</span><br><br><span class="hljs-comment"># vim /etc/heartbeat/heartbeat.yml</span><br><br>/- <span class="hljs-built_in">type</span>: http <span class="hljs-comment">#初始配置文件监控的项目只有http，其他监控项目可以通过官方文档来添加</span><br><br>     urls: [<span class="hljs-string">&quot;http://www.baidu.com&quot;</span>,<span class="hljs-string">&quot;http://www.cilicili.cc/&quot;</span>]<br><br>/- <span class="hljs-built_in">type</span> icmp<br><br>    schedule: <span class="hljs-string">&#x27;\*/5* * * * * *&#x27;</span><br><br>    hosts: [<span class="hljs-string">&quot;172.31.2.102&quot;</span>]<br><br>======kibana======<br><br>host: <span class="hljs-string">&quot;172.31.2.101:5601&quot;</span><br><br>------ela...------<br><br>hosts: [<span class="hljs-string">&quot;172.31.2.103:9200&quot;</span>]<br><br><br><br><span class="hljs-comment"># systemctl restart heartbeat-elastic</span><br></code></pre></td></tr></table></figure>

<h3 id="5-13-2-kibana创建索引"><a href="#5-13-2-kibana创建索引" class="headerlink" title="5.13.2 kibana创建索引"></a>5.13.2 kibana创建索引</h3><p>" srcset="/blog/img/loading.gif<img src=""></p>
<h2 id="5-14-通过haproxy-keepalived代理kibana和Elasticsearch"><a href="#5-14-通过haproxy-keepalived代理kibana和Elasticsearch" class="headerlink" title="5.14 通过haproxy+keepalived代理kibana和Elasticsearch"></a>5.14 通过haproxy+keepalived代理kibana和Elasticsearch</h2><p>elasticsearch和kibana都是安装在一起的，有多少个es就有多少个es。</p>
<p>logstash即使在发送日志的时候可以添加多个es地址，但是难免es的ip地址会改变，那么每次es的ip地址的改变就要修改logstash的配置文件，这样会增加繁琐的工作。所以logstash只需访问VIP就可以访问到es服务器，即使es服务器的ip地址改变</p>
<h3 id="5-14-1-安装haproxy和keepalived"><a href="#5-14-1-安装haproxy和keepalived" class="headerlink" title="5.14.1 安装haproxy和keepalived"></a>5.14.1 安装haproxy和keepalived</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt update</span><br><span class="hljs-comment"># apt install -y haproxy keepalived</span><br></code></pre></td></tr></table></figure>

<h3 id="5-14-2-配置文件"><a href="#5-14-2-配置文件" class="headerlink" title="5.14.2 配置文件"></a>5.14.2 配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/keepalived/keepalived.conf</span><br>......<br>virtual_ipaddress &#123;<br>     172.31.5.88 dev eth0 label eth0:0<br>&#125;<br><br><span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>....<br><br>listen es-9200<br>  mode tcp<br>  balance roundrobin<br>  <span class="hljs-built_in">bind</span> 172.31.5.88:9200<br>  server 172.31.2.101 172.31.2.101:9200 check inter 3s fall 3 rise 5<br>  server 172.31.2.102 172.31.2.102:9200 check inter 3s fall 3 rise 5<br>  server 172.31.2.103 172.31.2.103:9200 check inter 3s fall 3 rise 5<br>  <br><span class="hljs-comment">#先重启haproxy和keepalived后经过测试再修改</span><br><span class="hljs-comment"># vim /etc/logstash/conf.d/xxx.conf</span><br>....<br>output &#123;<br>    <span class="hljs-keyword">if</span> .... &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.5.88&quot;</span>] <span class="hljs-comment">#将地址改为VIP地址</span><br>            ......<br>        &#125;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-14-3-重启所有服务"><a href="#5-14-3-重启所有服务" class="headerlink" title="5.14.3 重启所有服务"></a>5.14.3 重启所有服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart keepalived</span><br><span class="hljs-comment"># systemctl restart haproxy</span><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h3 id="5-14-4-添加日志"><a href="#5-14-4-添加日志" class="headerlink" title="5.14.4 添加日志"></a>5.14.4 添加日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># echo &quot;111111&quot; &gt;&gt; /var/log/syslog</span><br></code></pre></td></tr></table></figure>

<h3 id="5-14-5-查看es"><a href="#5-14-5-查看es" class="headerlink" title="5.14.5 查看es"></a>5.14.5 查看es</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk104.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-14-6-在kibana添加索引"><a href="#5-14-6-在kibana添加索引" class="headerlink" title="5.14.6 在kibana添加索引"></a>5.14.6 在kibana添加索引</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk105.png" srcset="/blog/img/loading.gif" alt="只添加其中一个"></p>
<h2 id="5-15-通过nginx实现kibana登录认证"><a href="#5-15-通过nginx实现kibana登录认证" class="headerlink" title="5.15 通过nginx实现kibana登录认证"></a>5.15 通过nginx实现kibana登录认证</h2><h3 id="5-15-1-修改kibana配置文件"><a href="#5-15-1-修改kibana配置文件" class="headerlink" title="5.15.1 修改kibana配置文件"></a>5.15.1 修改kibana配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/kibana/kibana.yml</span><br>server.host: <span class="hljs-string">&quot;127.0.0.1&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-15-2-安装nginx"><a href="#5-15-2-安装nginx" class="headerlink" title="5.15.2 安装nginx"></a>5.15.2 安装nginx</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#在5.13的环境中安装nginx每台都要装</span><br><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment">#下载nginx</span><br><span class="hljs-comment"># tar xf nginx-1.16.1.tar.gz</span><br><span class="hljs-comment"># cd nginx-1.16.1</span><br><span class="hljs-comment"># ./configure --prefix=/apps/nginx</span><br><span class="hljs-comment"># make &amp;&amp; make install</span><br></code></pre></td></tr></table></figure>

<h3 id="5-15-3-生成密码认证文件"><a href="#5-15-3-生成密码认证文件" class="headerlink" title="5.15.3 生成密码认证文件"></a>5.15.3 生成密码认证文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install -y apache2-utils</span><br><br>htpasswd -bc /apps/nginx/.htpasswd kibana 123456<br>htpasswd -b /apps/nginx/.htpasswd rlin 123456 <span class="hljs-comment">#第二次不用加-c，不然会覆盖文件</span><br></code></pre></td></tr></table></figure>

<h3 id="5-15-4-添加配置文件"><a href="#5-15-4-添加配置文件" class="headerlink" title="5.15.4 添加配置文件"></a>5.15.4 添加配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /apps/nginx/conf</span><br><span class="hljs-comment"># mkdir kibana</span><br><span class="hljs-comment"># vim kibana/kibana.conf</span><br>upstream kibana_server &#123;<br>  server 127.0.0.1:5601 weight=1 max_fails=3 fail_timeout=60;<br>&#125;<br>server &#123;<br>  listen 80;<br>  server_name www.kibanabe.com;<br>  auth_basic <span class="hljs-string">&quot;Restricted Access&quot;</span>;<br>  auth_basic_user_file /apps/nginx/.htpasswd;<br>  location / &#123;<br>    proxy_pass http://kibana_server;<br>    proxy_http_version 1.1;<br>    proxy_set_header Upgrade <span class="hljs-variable">$http_upgrade</span>;<br>    proxy_set_header Connection <span class="hljs-string">&#x27;upgrade&#x27;</span>;<br>    proxy_set_header Host <span class="hljs-variable">$host</span>;<br>    proxy_cache_bypass <span class="hljs-variable">$http_upgrade</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment"># vim nginx.conf</span><br>....<br>include /apps/nginx/conf/kibana/*.conf;<br></code></pre></td></tr></table></figure>

<h3 id="5-15-5-开启nginx和kibana"><a href="#5-15-5-开启nginx和kibana" class="headerlink" title="5.15.5 开启nginx和kibana"></a>5.15.5 开启nginx和kibana</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/nginx/sbin/nginx</span><br><span class="hljs-comment"># systemctl restart kibana</span><br></code></pre></td></tr></table></figure>

<h3 id="5-15-6-添加hosts解析然后登录"><a href="#5-15-6-添加hosts解析然后登录" class="headerlink" title="5.15.6 添加hosts解析然后登录"></a>5.15.6 添加hosts解析然后登录</h3><p>修改windows的hosts</p>
<p>172.31.2.101 <a target="_blank" rel="noopener" href="http://www.kibanabe.com/">www.kibanabe.com</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk106.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk107.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-16-kibana高可用负载均衡"><a href="#5-16-kibana高可用负载均衡" class="headerlink" title="5.16 kibana高可用负载均衡"></a>5.16 kibana高可用负载均衡</h2><p>每一个elasticsearch服务器都会安装kibana和nginx，然后通过haproxy和keepalived在实现高可用负载均衡</p>
<h3 id="5-16-1-修改haproxy配置文件"><a href="#5-16-1-修改haproxy配置文件" class="headerlink" title="5.16.1 修改haproxy配置文件"></a>5.16.1 修改haproxy配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#基于5.13和5.14环境实现</span><br><span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>.....<br><br>listen es-9200<br>  mode tcp<br>  balance roundrobin<br>  <span class="hljs-built_in">bind</span> 172.31.5.88:9200<br>  server 172.31.2.101 172.31.2.101:9200 check inter 3s fall 3 rise 5<br>  server 172.31.2.102 172.31.2.102:9200 check inter 3s fall 3 rise 5<br>  server 172.31.2.103 172.31.2.103:9200 check inter 3s fall 3 rise 5<br>  <br>listen kibana-80<br>  mode tcp<br>  balance roundrobin<br>  <span class="hljs-built_in">bind</span> 172.31.5.88:80<br>  server 172.31.2.101 172.31.2.101:80 check inter 3s fall 3 rise 5<br>  server 172.31.2.102 172.31.2.102:80 check inter 3s fall 3 rise 5<br>  server 172.31.2.103 172.31.2.103:80 check inter 3s fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h3 id="5-16-2-访问kibana"><a href="#5-16-2-访问kibana" class="headerlink" title="5.16.2 访问kibana"></a>5.16.2 访问kibana</h3><p>通过浏览器访问kibana，就会随机的访问101，102，103的kibana网页</p>
<h2 id="5-17-通过坐标地图统计客户IP所在城市"><a href="#5-17-通过坐标地图统计客户IP所在城市" class="headerlink" title="5.17 通过坐标地图统计客户IP所在城市"></a>5.17 通过坐标地图统计客户IP所在城市</h2><h3 id="5-17-1-下载并解压地址数据文件"><a href="#5-17-1-下载并解压地址数据文件" class="headerlink" title="5.17.1 下载并解压地址数据文件"></a>5.17.1 下载并解压地址数据文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#在logstash2版本的时候使用的是</span><br>http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz<br><span class="hljs-comment">#但是在logstash5 版本时候更换为了</span><br>http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz，<br><span class="hljs-comment">#即5版本和2版本使用的是不一样的地址库文件：</span><br><br><span class="hljs-comment"># cd /etc/logstash/</span><br><span class="hljs-comment"># wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz</span><br><span class="hljs-comment"># gunzip GeoLite2-City.tar.gz</span><br><span class="hljs-comment"># tar xf GeoLite2-City.tar</span><br></code></pre></td></tr></table></figure>

<h3 id="5-17-2-配置logstash使用地址库"><a href="#5-17-2-配置logstash使用地址库" class="headerlink" title="5.17.2 配置logstash使用地址库"></a>5.17.2 配置logstash使用地址库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/filebeat-syslog-to-es.conf</span><br>input&#123;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;2&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-filebeat-systemlog&quot;</span><br>    &#125;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;2&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-filebeat-nginx-accesslog&quot;</span><br>    &#125;<br>&#125;<br>    <br>filter &#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;access-log&quot;</span> &#123;<br>        geoip &#123;<br>            <span class="hljs-built_in">source</span> =&gt; <span class="hljs-string">&quot;clientip&quot;</span><br>            target =&gt; <span class="hljs-string">&quot;geoip&quot;</span><br>            database =&gt; <span class="hljs-string">&quot;/etc/logstash/GeoLite2-City_20202922/GeoLite2-City.mmdb&quot;</span><br>            add_field =&gt; [ <span class="hljs-string">&quot;[geoip][coordinates]&quot;</span>, <span class="hljs-string">&quot;%&#123;[geoip][longitude]&#125;&quot;</span> ]<br>            add_field =&gt; [ <span class="hljs-string">&quot;[geoip][coordinates]&quot;</span>, <span class="hljs-string">&quot;%&#123;[geoip][latitude]&#125;&quot;</span> ]<br>&#125;<br>        mutate &#123;<br>            convert =&gt; [ <span class="hljs-string">&quot;[geoip][coordinates]&quot;</span>, <span class="hljs-string">&quot;float&quot;</span>]<br>        &#125;<br>    &#125;<br>&#125;<br><br>output&#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;access-log&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-nginx-accesslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>        <br>        jdbc &#123;<br>            connection_string =&gt; <span class="hljs-string">&quot;jdbc:mysql://192.168.15.11/elk?user=elk&amp;password=123456&amp;useUnicode=true&amp;characterEncoding=UTF8&quot;</span><br>            statement =&gt; [<span class="hljs-string">&quot;INSERT INTO elklog(host,clientip,status,AgentVersion)VALUES(?,?,?,?)&quot;</span>, <span class="hljs-string">&quot;host&quot;</span>,<span class="hljs-string">&quot;clientip&quot;</span>,<span class="hljs-string">&quot;status&quot;</span>,<span class="hljs-string">&quot;AgentVersion&quot;</span>] <span class="hljs-comment">#要跟表的时候的字段一一对应，在VALUES里插入了多少个字段就输入多少个问号</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-17-3-重启logstash服务并写入日志数据"><a href="#5-17-3-重启logstash服务并写入日志数据" class="headerlink" title="5.17.3 重启logstash服务并写入日志数据"></a>5.17.3 重启logstash服务并写入日志数据</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/filebeat-syslog-to-es.conf -t</span><br><br><span class="hljs-comment"># systemctl restart logstash</span><br><br><span class="hljs-comment"># cat access.log &gt;&gt; /apps/nginx/logs/access.log</span><br></code></pre></td></tr></table></figure>

<h3 id="5-17-4-验证Kibana界面是否可以看到地图数据"><a href="#5-17-4-验证Kibana界面是否可以看到地图数据" class="headerlink" title="5.17.4 验证Kibana界面是否可以看到地图数据"></a>5.17.4 验证Kibana界面是否可以看到地图数据</h3><p>kibana–Maps–创建地图–添加图层–选择收集的日志–添加图层</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk136.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk137.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk138.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-18-日志写入数据库"><a href="#5-18-日志写入数据库" class="headerlink" title="5.18 日志写入数据库"></a>5.18 日志写入数据库</h2><p>写入数据库的目的是用于持久化保存重要数据，比如状态码、客户端 IP、客户端浏览器版本等等，用于后期按月做数据统计等。</p>
<h3 id="5-18-1-安装数据库"><a href="#5-18-1-安装数据库" class="headerlink" title="5.18.1 安装数据库"></a>5.18.1 安装数据库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install mysql-server mysql-client</span><br><br><span class="hljs-comment"># vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br>bind-address = 0.0.0.0<br><br><span class="hljs-comment"># systemctl restart mysql</span><br><br><span class="hljs-comment"># ss -tnl</span><br></code></pre></td></tr></table></figure>

<h3 id="5-18-2-授权用户登录"><a href="#5-18-2-授权用户登录" class="headerlink" title="5.18.2 授权用户登录"></a>5.18.2 授权用户登录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mysql</span><br>create database elk character <span class="hljs-built_in">set</span> utf8 collate utf8_bin;<br><br>grant all privileges on elk.* to elk@<span class="hljs-string">&quot;%&quot;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br><br>flush privileges;<br></code></pre></td></tr></table></figure>

<h3 id="5-18-3-测试用户可以远程登录"><a href="#5-18-3-测试用户可以远程登录" class="headerlink" title="5.18.3 测试用户可以远程登录"></a>5.18.3 测试用户可以远程登录</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk139.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-18-4-logstash配置mysql-connector-java包"><a href="#5-18-4-logstash配置mysql-connector-java包" class="headerlink" title="5.18.4 logstash配置mysql-connector-java包"></a>5.18.4 logstash配置mysql-connector-java包</h3><p>MySQL Connector/J 是 MySQL 官方 JDBC 驱动程序，JDBC（Java Data BaseConnectivity,java 数据库连接）是一种用于执行 SQL 语句的 Java API，可以为多种关系数据库提供统一访问，它由一组用 Java 语言编写的类和接口组成。注意jdbc的版本问题，mysql太新会出现错误</p>
<p>官方下载地址：<a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/connector/">https://dev.mysql.com/downloads/connector/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># dpkg -c mysql-connector-java_8.0.21-1ubuntu18.01_all.deb</span><br><br><span class="hljs-comment"># mkdir -pv /usr/share/logstash/vendor/jar/jdbc</span><br><br><span class="hljs-comment"># dpkg -i mysql-connector-java_8.0.21-1ubuntu18.01_all.deb</span><br><br><span class="hljs-comment"># cp /usr/share/java/mysql-connector-java-8.0.21.jar /usr/share/logstash/vendor/jar/jdbc</span><br><br><span class="hljs-comment"># chown -R logstash.logstash /usr/share/logstash/vendor</span><br></code></pre></td></tr></table></figure>

<h3 id="5-18-5-更改gem源"><a href="#5-18-5-更改gem源" class="headerlink" title="5.18.5 更改gem源"></a>5.18.5 更改gem源</h3><p>国外的 gem 源由于网络原因，从国内访问太慢而且不稳定，还经常安装不成功 ， 因 此 之 前 一 段 时 间很多人都是使用国内淘宝的gem源<a target="_blank" rel="noopener" href="https://ruby.taobao.org/%EF%BC%8C%E7%8E%B0%E5%9C%A8%E6%B7%98%E5%AE%9D%E7%9A%84gem%E6%BA%90%E8%99%BD%E7%84%B6%E8%BF%98%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E5%B7%B2%E7%BB%8F%E5%81%9C%E6%AD%A2%E7%BB%B4%E6%8A%A4%E6%9B%B4%E6%96%B0%EF%BC%8C%E5%85%B6%E5%AE%98%E6%96%B9%E4%BB%8B%E7%BB%8D%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8">https://ruby.taobao.org/，现在淘宝的gem源虽然还可以使用已经停止维护更新，其官方介绍推荐使用</a> <a target="_blank" rel="noopener" href="https://gems.ruby-china.org./">https://gems.ruby-china.org。</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install ruby</span><br><span class="hljs-comment"># gem source list</span><br></code></pre></td></tr></table></figure>

<h3 id="5-18-6-安装配置插件"><a href="#5-18-6-安装配置插件" class="headerlink" title="5.18.6 安装配置插件"></a>5.18.6 安装配置插件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash-plugin list #当前已经安装的所有插件</span><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash-plugin list | grep jdbc</span><br><span class="hljs-comment"># /usr/share/logstash/bin/logstash-plugin install logstash-output-jdbc</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk140.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-18-7-连接数据库创建表"><a href="#5-18-7-连接数据库创建表" class="headerlink" title="5.18.7 连接数据库创建表"></a>5.18.7 连接数据库创建表</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk141.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-18-8-保存表"><a href="#5-18-8-保存表" class="headerlink" title="5.18.8 保存表"></a>5.18.8 保存表</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk142.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-18-9-配置logastash将日志写入数据库"><a href="#5-18-9-配置logastash将日志写入数据库" class="headerlink" title="5.18.9 配置logastash将日志写入数据库"></a>5.18.9 配置logastash将日志写入数据库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/logstash/conf.d/filebeat-syslog-to-es.conf</span><br>input&#123;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;2&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-filebeat-systemlog&quot;</span><br>    &#125;<br>    redis &#123;<br>        host =&gt; <span class="hljs-string">&quot;172.31.2.106&quot;</span><br>        port =&gt; <span class="hljs-string">&quot;6379&quot;</span><br>        password =&gt; <span class="hljs-string">&quot;123456&quot;</span><br>        db =&gt; <span class="hljs-string">&quot;2&quot;</span><br>        data_type =&gt; <span class="hljs-string">&quot;list&quot;</span><br>        key =&gt; <span class="hljs-string">&quot;rlin-filebeat-nginx-accesslog&quot;</span><br>    &#125;<br>&#125;<br><br>output&#123;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;systemlog&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> [fields][<span class="hljs-built_in">type</span>] == <span class="hljs-string">&quot;access-log&quot;</span> &#123;<br>        elasticsearch &#123;<br>            hosts =&gt; [<span class="hljs-string">&quot;172.31.2.101:9200&quot;</span>]<br>            index =&gt; <span class="hljs-string">&quot;logstash-filebeat-nginx-accesslog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>        &#125;<br>        <br>        jdbc &#123;<br>            connection_string =&gt; <span class="hljs-string">&quot;jdbc:mysql://192.168.15.11/elk?user=elk&amp;password=123456&amp;useUnicode=true&amp;characterEncoding=UTF8&quot;</span><br>            statement =&gt; [<span class="hljs-string">&quot;INSERT INTO elklog(host,clientip,status,AgentVersion)VALUES(?,?,?,?)&quot;</span>, <span class="hljs-string">&quot;host&quot;</span>,<span class="hljs-string">&quot;clientip&quot;</span>,<span class="hljs-string">&quot;status&quot;</span>,<span class="hljs-string">&quot;AgentVersion&quot;</span>] <span class="hljs-comment">#要跟表的时候的字段一一对应，在VALUES里插入了多少个字段就输入多少个问号</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-18-10-检查logstash配置并重启服务"><a href="#5-18-10-检查logstash配置并重启服务" class="headerlink" title="5.18.10 检查logstash配置并重启服务"></a>5.18.10 检查logstash配置并重启服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/filebeat-syslog-to-es.conf -t </span><br><span class="hljs-comment"># systemctl restart logstash</span><br></code></pre></td></tr></table></figure>

<h3 id="5-18-11-访问tomcat以产生日志"><a href="#5-18-11-访问tomcat以产生日志" class="headerlink" title="5.18.11 访问tomcat以产生日志"></a>5.18.11 访问tomcat以产生日志</h3><p>ab -n10 -c5 <a target="_blank" rel="noopener" href="http://192.168.15.12:8080/webdir/index.html">http://192.168.15.12:8080/webdir/index.html</a></p>
<h3 id="5-18-12-验证数据库是否写入数据"><a href="#5-18-12-验证数据库是否写入数据" class="headerlink" title="5.18.12 验证数据库是否写入数据"></a>5.18.12 验证数据库是否写入数据</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk146.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-18-13-time默认值没有定义为CURRENT-TIMESTAMP的状态"><a href="#5-18-13-time默认值没有定义为CURRENT-TIMESTAMP的状态" class="headerlink" title="5.18.13 time默认值没有定义为CURRENT_TIMESTAMP的状态"></a>5.18.13 time默认值没有定义为CURRENT_TIMESTAMP的状态</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk147.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-19-监控redis数据长度"><a href="#5-19-监控redis数据长度" class="headerlink" title="5.19 监控redis数据长度"></a>5.19 监控redis数据长度</h2><p>实际环境当中，可能会出现 reids 当中堆积了大量的数据而 logstash 由于种种原因未能及时提取日志，此时会导致 redis 服务器的内存被大量使用，甚至出现如下内存即将被使用完毕的情景</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk148.png" srcset="/blog/img/loading.gif"></p>
<p>查看 reids 中的日志队列长度发现有大量的日志堆积在 redis 当中</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk149.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-19-1-脚本内容"><a href="#5-19-1-脚本内容" class="headerlink" title="5.19.1 脚本内容"></a>5.19.1 脚本内容</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br><span class="hljs-comment">#Author Zhang jie</span><br><span class="hljs-keyword">import</span> redis<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">redis_conn</span>():</span><br><br>pool=redis.ConnectionPool(host=<span class="hljs-string">&quot;192.168.15.12&quot;</span>,port=<span class="hljs-number">6379</span>,db=<span class="hljs-number">0</span>,password=<span class="hljs-number">123456</span>)<br>conn = redis.Redis(connection_pool=pool)<br>data = conn.llen(<span class="hljs-string">&#x27;tomcat-accesslog-1512&#x27;</span>)<br><span class="hljs-built_in">print</span>(data)<br>redis_conn()<br></code></pre></td></tr></table></figure>

<h2 id="5-20-kibana画图功能详解"><a href="#5-20-kibana画图功能详解" class="headerlink" title="5.20 kibana画图功能详解"></a>5.20 kibana画图功能详解</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/kibana/current/introduction.html">https://www.elastic.co/guide/cn/kibana/current/introduction.html</a></p>
<h3 id="5-20-1面积图"><a href="#5-20-1面积图" class="headerlink" title="5.20.1面积图"></a>5.20.1面积图</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk150.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk152.png" srcset="/blog/img/loading.gif"></p>
<p>选择要统计的index 名称</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk153.png" srcset="/blog/img/loading.gif"></p>
<p>定义查询的信息及属性</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk154.png" srcset="/blog/img/loading.gif"></p>
<p>保存查询结果，方便下次可以直接点击查询</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk155.png" srcset="/blog/img/loading.gif"></p>
<p>下次点击visualize 之后，可以直接自定义名称进行查询</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk156.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-20-2-数据表"><a href="#5-20-2-数据表" class="headerlink" title="5.20.2 数据表"></a>5.20.2 数据表</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk157.png" srcset="/blog/img/loading.gif"></p>
<p>可以讲结果导出，通过excel 查看</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk158.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk159.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-20-3-热力图"><a href="#5-20-3-热力图" class="headerlink" title="5.20.3 热力图"></a>5.20.3 热力图</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk160.png" srcset="/blog/img/loading.gif"></p>
<p>可以自定义颜色显示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk161.png" srcset="/blog/img/loading.gif"></p>
<p>保存热图</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk162.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-20-4-折线图"><a href="#5-20-4-折线图" class="headerlink" title="5.20.4 折线图"></a>5.20.4 折线图</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk163.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk164.png" srcset="/blog/img/loading.gif"></p>
<p>保存折线图</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk165.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-20-5-markdown"><a href="#5-20-5-markdown" class="headerlink" title="5.20.5 markdown"></a>5.20.5 markdown</h3><p>| 日期 |    联系电话    | 姓名    |</p>
<p><img src="file:///C:\Users\kinci\AppData\Local\Temp\ksohtml\wpsE659.tmp.png" srcset="/blog/img/loading.gif" alt="img">| :  : | :    : |    |</p>
<p>| 周一 | 18600000001 | user1 |</p>
<p>| 周二 | 18600000002 | user2 |</p>
<p>| 周三 | 18600000003 | user3 |</p>
<p>| 周四 | 18600000004 | user4 |</p>
<p>| 周五 | 18600000005 | user5 |</p>
<p>| 周六 | 18600000006 | user6 |</p>
<p>| 周日 | 18600000007 | user7 |</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk166.png" srcset="/blog/img/loading.gif" alt="166"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk167.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-20-6-饼图"><a href="#5-20-6-饼图" class="headerlink" title="5.20.6 饼图"></a>5.20.6 饼图</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk168.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-20-6-1-kibana"><a href="#5-20-6-1-kibana" class="headerlink" title="5.20.6.1 kibana"></a>5.20.6.1 kibana</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk169.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-20-6-2-5版本kibana"><a href="#5-20-6-2-5版本kibana" class="headerlink" title="5.20.6.2 5版本kibana"></a>5.20.6.2 5版本kibana</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk170.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk171.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-20-7-地图"><a href="#5-20-7-地图" class="headerlink" title="5.20.7 地图"></a>5.20.7 地图</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk172.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk173.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-20-8-垂直条形图"><a href="#5-20-8-垂直条形图" class="headerlink" title="5.20.8 垂直条形图"></a>5.20.8 垂直条形图</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk174.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk175.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk176.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-20-9-添加仪表盘"><a href="#5-20-9-添加仪表盘" class="headerlink" title="5.20.9 添加仪表盘"></a>5.20.9 添加仪表盘</h3><p>当前保存好的单个图形</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk177.png" srcset="/blog/img/loading.gif"></p>
<p>加之前保存的搜索结果到仪表盘</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk178.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk179.png" srcset="/blog/img/loading.gif"></p>
<p>添加保存好的搜索结果</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk180.png" srcset="/blog/img/loading.gif"></p>
<p>添加图形后的结果</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk181.png" srcset="/blog/img/loading.gif"></p>
<p>保存当前仪表盘</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk182.png" srcset="/blog/img/loading.gif"></p>
<p>在添加一个地图</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk183.png" srcset="/blog/img/loading.gif"></p>
<p>页面共享</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk184.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk185.png" srcset="/blog/img/loading.gif"></p>
<p>写一个html页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs html">!DOCTYPE html&gt; <br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span> <br>    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span> <br>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span> <br>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>马哥教育<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span> <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span> <br>        马哥教育 Linux 云计算工程师 <br>        <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://192.168.7.101:5601/goto/c74b10cdbd00552deb2ca95 9d8695902?embed=true&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;1080&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;1920&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span> <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>浏览器打开页面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk186.png" srcset="/blog/img/loading.gif"></p>
<h1 id="六、日志收集实战"><a href="#六、日志收集实战" class="headerlink" title="六、日志收集实战"></a>六、日志收集实战</h1><h2 id="6-1-架构规划"><a href="#6-1-架构规划" class="headerlink" title="6.1 架构规划"></a>6.1 架构规划</h2><p>在下面的图当中从左向右看，当要访问 ELK 日志统计平台的时候，首先访问的是两台nginx+keepalived 做的负载高可用，访问的地址是 keepalived 的 IP，当一台 nginx 代理服务器挂掉之后也不影响访问，然后 nginx 将请求转发到kibana，kibana 再去 elasticsearch 获取数据，elasticsearch 是两台做的集群，数据会随机保存在任意一台 elasticsearch 服务器，redis 服务器做数据的临时保存，避免 web 服务器日志量过大的时候造成的数据收集与保存不一致导致的日志丢失，可以临时保存到 redis，redis 可以是集群，然后再由 logstash 服务器在非高峰时期从 redis 持续的取出即可，另外有一台 mysql 数据库服务器，用于持久化保存特定的数据，web 服务器的日志由 filebeat 收集之后发送给另外的一台logstash，再有其写入到 redis 即可完成日志的收集，从图中可以看出，redis 服务器处于前端结合的最中间，其左右都要依赖于 redis 的正常运行，web 服务删个日志经过 filebeat 收集之后通过日志转发层的 logstash 写入到 redis 不同的 key当中，然后提取层 logstash 再从 redis 将数据提取并安按照不同的类型写入到elasticsearch 的不同 index 当中，用户最终通过 nginx 代理的 kibana 查看到收集到的日志的具体内容</p>
<p>按照下面的规划图，自行根据实际需求设计并搭建一个日志收集系统，要求有详细的实施文档或博客，搭建zabbix监控，对Elasticsearch和redis进行监控并设置报警</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ELK/elk187.png" srcset="/blog/img/loading.gif"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/linux-elasticsearch-logstash-filebeat-kibana/">linux elasticsearch logstash filebeat kibana</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/09/25/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MySQL数据库</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                        <span class="hidden-mobile">消息队列与微服务</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
