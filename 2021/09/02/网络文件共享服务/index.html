

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>网络文件共享服务 - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="网络文件共享服务">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-02 14:32" pubdate>
        2021年9月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      17.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      254
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">网络文件共享服务</h1>
            
            <div class="markdown-body">
              <h1 id="网络文件共享服务"><a href="#网络文件共享服务" class="headerlink" title="网络文件共享服务"></a>网络文件共享服务</h1><h1 id="一、存储类型"><a href="#一、存储类型" class="headerlink" title="一、存储类型"></a>一、存储类型</h1><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile1.png" srcset="/blog/img/loading.gif"></p>
<p>存储类型分为三种</p>
<ul>
<li>直连式存储：Direct-Attached Storage，简称DAS</li>
<li>网络附加存储：Network-Attached Storage，简称NAS</li>
<li>存储区域网络：Storage Area Network，简称SAN</li>
</ul>
<h2 id="1-1-DAS存储"><a href="#1-1-DAS存储" class="headerlink" title="1.1 DAS存储"></a>1.1 DAS存储</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile2.png" srcset="/blog/img/loading.gif"></p>
<p>DAS存储是最常见的一种存储方式，尤其是在中小企业应用中。PC中的硬盘或只有一个外部SCSI接口的JBOD都属于DAS架构。DAS是指存储设备直接连接到服务器总线上，存储设备只与一台独立的主机连接，其他主机不能使用这个存储设备。DAS存储设备与服务器主机之间的连接通道通常采用SCSI连接，DAS存储设备主要是磁盘阵列（RAID: Redundant Arrays of Independent Disks）、磁盘簇（JBOD:Just a Bunch Of Disks）等。</p>
<h2 id="1-2-NAS存储"><a href="#1-2-NAS存储" class="headerlink" title="1.2 NAS存储"></a>1.2 NAS存储</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile3.png" srcset="/blog/img/loading.gif"></p>
<p>NAS存储就是存储设备通过标准的网络拓扑结构(比如以太网)添加到一群计算机上。与DAS以及SAN不同，NAS是文件级的存储方法。采用NAS较多的功能是用来进行文件共享。</p>
<p>NAS存储也通常被称为附加存储，顾名思义，就是存储设备通过标准的网络拓扑结构(例如以太网)添加到一群计算机上。NAS是文件级的存储方法，它的重点在于帮助工作组和部门级机构解决迅速增加存储容量的需求。如今更多的亲们采用NAS较多的功能是用来文档共享、图片共享、电影共享等等，而且随着云计算的发展，一些NAS厂商也推出了云存储功能，大大方便了企业和亲们等个人用户的使用。</p>
<p>NAS产品是真正即插即用的产品。NAS设备一般支持多计算机平台，用户通过网络支持协议可进入相同的文档，因而NAS设备无需改造即可用于混合Unix/Windows NT局域网内，同时NAS的应用非常灵活。</p>
<p>但NAS有一个关键性问题，即备份过程中的带宽消耗。与将备份数据流从LAN中转移出去的存储区域网（SAN）不同，NAS仍使用网络进行备份和恢复。NAS 的一个缺点是它将存储事务由并行SCSI连接转移到了网络上。这就是说LAN除了必须处理正常的最终用户传输流外，还必须处理包括备份操作的存储磁盘请求。</p>
<h2 id="1-3-SAN存储"><a href="#1-3-SAN存储" class="headerlink" title="1.3 SAN存储"></a>1.3 SAN存储</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile4.png" srcset="/blog/img/loading.gif"></p>
<p>存储区域网络，这个是通过光纤通道或以太网交换机连接存储阵列和服务器主机，最后成为一个专用的存储网络。SAN经过十多年历史的发展，已经相当成熟，成为业界的事实标准（但各个厂商的光纤交换技术不完全相同，其服务器和SAN存储有兼容性的要求）。</p>
<p>SAN提供了一种与现有LAN连接的简易方法，并且通过同一物理通道支持广泛使用的SCSI和IP协议。</p>
<p>SAN不受现今主流的、基于SCSI存储结构的布局限制。特别重要的是，随着存储容量的爆炸性增长，SAN允许企业独立地增加它们的存储容量。SAN的结构允许任何服务器连接到任何存储阵列，这样不管数据置放在那里，服务器都可直接存取所需的数据。因为采用了光纤接口，SAN还具有更高的带宽。</p>
<p>如今的SAN解决方案通常会采取以下两种形式：光纤信道以及iSCSI或者基于IP的SAN，也就是FC SAN和IP SAN。光纤信道是SAN解决方案中大家最熟悉的类型，但是，最近一段时间以来，基于iSCSI的SAN解决方案开始大量出现在市场上，与光纤通道技术相比较而言，这种技术具有良好的性能，而且价格低廉。</p>
<p>SAN的优势：</p>
<ul>
<li><p>随着存储容量的增长，SAN允许企业独立地增加他们的存储容量。</p>
</li>
<li><p>SAN允许任何服务器连接到任何存储阵列（好处是：不管数据放在哪里，服务器都可以直接存取所需的数据）</p>
</li>
<li><p>由于使用光纤接口，SAN具有更高的带宽。除了FC连接，SAN连接还有ISCSI（SCSI over IP）以及SAS（Serial Attached SCSI）接口。</p>
</li>
<li><p>光纤接口可以提供10公里那么长那么远的连接长度，非常容易实现物理分离的存储</p>
</li>
</ul>
<h2 id="1-4-三种存储比较"><a href="#1-4-三种存储比较" class="headerlink" title="1.4 三种存储比较"></a>1.4 三种存储比较</h2><p>SAN与NAS的主要区别体现在文件系统所在的位置</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile5.png" srcset="/blog/img/loading.gif"></p>
<p><strong>三种存储架构的应用场景</strong></p>
<ul>
<li>DAS虽然比较古老了，但是还是很适用于那些数据量不大，对磁盘访问速度要求较高的中小企业</li>
<li>NAS多适用于文件服务器，用来存储非结构化数据，虽然受限于以太网的速度，但是部署灵活，成本低</li>
<li>SAN则适用于大型应用或数据库系统，缺点是成本高、较为复杂</li>
</ul>
<h1 id="二、FTP-文件传输协议"><a href="#二、FTP-文件传输协议" class="headerlink" title="二、FTP 文件传输协议"></a>二、FTP 文件传输协议</h1><h2 id="2-1-FTP工作原理介绍"><a href="#2-1-FTP工作原理介绍" class="headerlink" title="2.1 FTP工作原理介绍"></a>2.1 FTP工作原理介绍</h2><p>文件传输协议：File Transfer Protocol 早期的三个应用级协议之一，基于C/S结构</p>
<p>数据传输格式：二进制（默认）和文本</p>
<p>双通道协议：命令和数据连接</p>
<p>两种模式：从服务器角度</p>
<ul>
<li>主动(PORT style)：服务器主动连接<br>命令（控制）：客户端：随机port —&gt; 服务器：21/tcp<br>数据：客户端：随机port &lt;—服务器：20/tcp</li>
<li>被动(PASV style)：客户端主动连接<br>命令（控制）：客户端：随机port —&gt; 服务器：21/tcp<br>数据：客户端：随机port —&gt; 服务器：随机port /tcp</li>
</ul>
<p>范例：服务器被动模式数据端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">227 Entering Passive Mode (172,16,0,1,224,59)<br></code></pre></td></tr></table></figure>

<p>服务器数据端口为：224*256+59</p>
<p>范例: windows 连接FTP服务器默认使用主动模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">C:\Users\Wang&gt;ftp 10.0.0.8<br>连接到 10.0.0.8。<br>220<br>200 Always <span class="hljs-keyword">in</span> UTF8 mode.<br>用户(10.0.0.8:(none)): ftp<br>331 Please specify the password.<br>密码:<br>230 Login successful.<br>ftp&gt; ls<br>200 PORT <span class="hljs-built_in">command</span> successful. Consider using PASV.<br>150 Here comes the directory listing.<br>mail.txt<br>pub<br>upload<br>226 Directory send OK.<br>ftp: 收到 26 字节，用时 0.00秒 13.00千字节/秒。<br>ftp&gt; literal pasv<br>227 Entering Passive Mode (10,0,0,8,64,127).<br></code></pre></td></tr></table></figure>

<p><strong>FTP服务状态码：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">1XX：信息 125：数据连接打开<br>2XX：成功类状态 200：命令OK   230：登录成功<br>3XX：补充类   331：用户名OK<br>4XX：客户端错误 425：不能打开数据连接<br>5XX：服务器错误 530：不能登录<br></code></pre></td></tr></table></figure>

<p><strong>用户认证：</strong></p>
<p>匿名用户：ftp,anonymous,对应Linux用户ftp<br>系统用户：Linux用户,用户/etc/passwd,密码/etc/shadow<br>虚拟用户：特定服务的专用用户，独立的用户/密码文件</p>
<h2 id="2-2-常见-FTP-相关软件"><a href="#2-2-常见-FTP-相关软件" class="headerlink" title="2.2 常见 FTP 相关软件"></a>2.2 常见 FTP 相关软件</h2><p><strong>FTP服务器端软件</strong></p>
<p>Wu-ftpd,Proftpd,Pureftpd,Filezilla Server,Serv-U,Wing FTP Server,IIS</p>
<p>vsftpd：Very Secure FTP Daemon，CentOS 默认FTP服务器</p>
<p>  高速，稳定，下载速度是WU-FTP的两倍</p>
<p>  ftp.redhat.com数据:单机最多可支持15000个并发</p>
<p>vsftpd官网： <a target="_blank" rel="noopener" href="https://security.appspot.com/vsftpd.html">https://security.appspot.com/vsftpd.html</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile6.png" srcset="/blog/img/loading.gif"></p>
<p>Filezilla官网： <a target="_blank" rel="noopener" href="https://filezilla-project.org/index.php">https://filezilla-project.org/index.php</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile7.png" srcset="/blog/img/loading.gif"></p>
<p>客户端软件：<br>ftp，lftp，lftpget，wget，curl<br>ftp -A ftpserver port -A 主动模式 -p 被动模式<br>lftp -u username ftpserver<br>lftp username@ftpserver<br>lftpget <a href="ftp://ftpserver/pub/file">ftp://ftpserver/pub/file</a><br>gftp：GUI centos5 最新版2.0.19 (11/30/2008)，官网：<a target="_blank" rel="noopener" href="https://www.gftp.org/">https://www.gftp.org/</a><br>filezilla，FTP Rush，CuteFtp，FlashFXP，LeapFtp<br>IE <a href="ftp://username:password@ftpserver/">ftp://username:password@ftpserver</a></p>
<h2 id="2-3-vsftpd-软件介绍"><a href="#2-3-vsftpd-软件介绍" class="headerlink" title="2.3 vsftpd 软件介绍"></a>2.3 vsftpd 软件介绍</h2><p>由 vsftpd 包提供，不再由xinetd管理</p>
<h3 id="2-3-1-vsftpd安装"><a href="#2-3-1-vsftpd安装" class="headerlink" title="2.3.1 vsftpd安装"></a>2.3.1 vsftpd安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#centos安装vsftpd</span><br>[root@centos7 ~]<span class="hljs-comment"># yum install -y vsftpd</span><br><span class="hljs-comment">#ubuntu安装vsftpd</span><br>root@ubuntu1804:~<span class="hljs-comment"># sudo apt install -y vsftpd</span><br><br>[root@centos7 ~]<span class="hljs-comment"># systemctl start vsftpd</span><br>[root@centos7 ~]<span class="hljs-comment"># systemctl enable vsftpd</span><br>Created symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.<br></code></pre></td></tr></table></figure>

<h3 id="2-3-2-vsftpd安装内容"><a href="#2-3-2-vsftpd安装内容" class="headerlink" title="2.3.2 vsftpd安装内容"></a>2.3.2 vsftpd安装内容</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># rpm -ql vsftpd</span><br>/etc/logrotate.d/vsftpd<br>/etc/pam.d/vsftpd <span class="hljs-comment">#用户认证配置文件</span><br>/etc/vsftpd<br>/etc/vsftpd/ftpusers<br>/etc/vsftpd/user_list<br>/etc/vsftpd/vsftpd.conf<br>/etc/vsftpd/vsftpd_conf_migrate.sh<br>/usr/lib/systemd/system-generators/vsftpd-generator<br>/usr/lib/systemd/system/vsftpd.service<br>/usr/lib/systemd/system/vsftpd.target<br>/usr/lib/systemd/system/vsftpd@.service<br>/usr/sbin/vsftpd<br>/usr/share/doc/vsftpd-3.0.2<br>/usr/share/doc/vsftpd-3.0.2/AUDIT<br>/usr/share/doc/vsftpd-3.0.2/BENCHMARKS<br>/usr/share/doc/vsftpd-3.0.2/BUGS<br>/usr/share/doc/vsftpd-3.0.2/COPYING<br>/usr/share/doc/vsftpd-3.0.2/Changelog<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/INTERNET_SITE<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/INTERNET_SITE/README<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/INTERNET_SITE/README.configuration<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/INTERNET_SITE/vsftpd.conf<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/INTERNET_SITE/vsftpd.xinetd<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/INTERNET_SITE_NOINETD<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/INTERNET_SITE_NOINETD/README<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/INTERNET_SITE_NOINETD/README.configuration<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/INTERNET_SITE_NOINETD/vsftpd.conf<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/PER_IP_CONFIG<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/PER_IP_CONFIG/README<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/PER_IP_CONFIG/README.configuration<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/PER_IP_CONFIG/hosts.allow<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/README<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/VIRTUAL_HOSTS<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/VIRTUAL_HOSTS/README<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/VIRTUAL_USERS<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/VIRTUAL_USERS/README<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/VIRTUAL_USERS/README.configuration<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/VIRTUAL_USERS/logins.txt<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/VIRTUAL_USERS/vsftpd.conf<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/VIRTUAL_USERS/vsftpd.pam<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/VIRTUAL_USERS_2<br>/usr/share/doc/vsftpd-3.0.2/EXAMPLE/VIRTUAL_USERS_2/README<br>/usr/share/doc/vsftpd-3.0.2/FAQ<br>/usr/share/doc/vsftpd-3.0.2/INSTALL<br>/usr/share/doc/vsftpd-3.0.2/LICENSE<br>/usr/share/doc/vsftpd-3.0.2/README<br>/usr/share/doc/vsftpd-3.0.2/README.security<br>/usr/share/doc/vsftpd-3.0.2/REWARD<br>/usr/share/doc/vsftpd-3.0.2/SECURITY<br>/usr/share/doc/vsftpd-3.0.2/SECURITY/DESIGN<br>/usr/share/doc/vsftpd-3.0.2/SECURITY/IMPLEMENTATION<br>/usr/share/doc/vsftpd-3.0.2/SECURITY/OVERVIEW<br>/usr/share/doc/vsftpd-3.0.2/SECURITY/TRUST<br>/usr/share/doc/vsftpd-3.0.2/SIZE<br>/usr/share/doc/vsftpd-3.0.2/SPEED<br>/usr/share/doc/vsftpd-3.0.2/TODO<br>/usr/share/doc/vsftpd-3.0.2/TUNING<br>/usr/share/doc/vsftpd-3.0.2/vsftpd.xinetd<br>/usr/share/man/man5/vsftpd.conf.5.gz<br>/usr/share/man/man8/vsftpd.8.gz<br>/var/ftp<br>/var/ftp/pub<br></code></pre></td></tr></table></figure>

<h3 id="2-3-3-启动服务相关文件"><a href="#2-3-3-启动服务相关文件" class="headerlink" title="2.3.3 启动服务相关文件"></a>2.3.3 启动服务相关文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/lib/systemd/system/vsftpd.service<br>/usr/sbin/vsftpd<br></code></pre></td></tr></table></figure>

<h3 id="2-3-4-配置文件："><a href="#2-3-4-配置文件：" class="headerlink" title="2.3.4 配置文件："></a>2.3.4 配置文件：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/etc/vsftpd/vsftpd.conf<br></code></pre></td></tr></table></figure>

<h3 id="2-3-5-vsftpd帮助"><a href="#2-3-5-vsftpd帮助" class="headerlink" title="2.3.5 vsftpd帮助"></a>2.3.5 vsftpd帮助</h3><p>帮助：man 5 vsftpd.conf</p>
<p>配置文件格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">option=value<br></code></pre></td></tr></table></figure>

<p>注意：= 前后不要有空格<br>用户和其共享目录</p>
<ul>
<li>匿名用户（映射为系统用户ftp ）共享文件位置：/var/ftp</li>
<li>系统用户共享文件位置：用户家目录</li>
<li>虚拟用户共享文件位置：为其映射的系统用户的家目录</li>
</ul>
<h2 id="2-4-vsftpd服务常见配置"><a href="#2-4-vsftpd服务常见配置" class="headerlink" title="2.4 vsftpd服务常见配置"></a>2.4 vsftpd服务常见配置</h2><h3 id="2-4-1-命令端口"><a href="#2-4-1-命令端口" class="headerlink" title="2.4.1 命令端口"></a>2.4.1 命令端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen_port=2121 默认值为21<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#ftp 10.0.0.8 2121</span><br>[root@centos6 ~]<span class="hljs-comment">#lftp 10.0.0.8 -p 2121</span><br></code></pre></td></tr></table></figure>

<h3 id="2-4-2-主动模式端口"><a href="#2-4-2-主动模式端口" class="headerlink" title="2.4.2 主动模式端口"></a>2.4.2 主动模式端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">connect_from_port_20=YES 主动模式端口为20<br>ftp_data_port=20 （默认） 指定主动模式的端口<br></code></pre></td></tr></table></figure>

<h3 id="2-4-3-被动模式端口范围"><a href="#2-4-3-被动模式端口范围" class="headerlink" title="2.4.3 被动模式端口范围"></a>2.4.3 被动模式端口范围</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">linux               <span class="hljs-comment">#ftp 客户端默认使用被动模式</span><br>windows             <span class="hljs-comment">#ftp 客户端默认使用主动模式</span><br>pasv_min_port=6000  <span class="hljs-comment">#0为随机分配，端口范围会影响客户端的并发数</span><br>pasv_max_port=6010<br></code></pre></td></tr></table></figure>

<h3 id="2-4-4-使用当地时间"><a href="#2-4-4-使用当地时间" class="headerlink" title="2.4.4 使用当地时间"></a>2.4.4 使用当地时间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">use_localtime=YES <span class="hljs-comment">#使用当地时间（默认为NO，使用GMT）</span><br></code></pre></td></tr></table></figure>

<h3 id="2-4-5-匿名用户登录"><a href="#2-4-5-匿名用户登录" class="headerlink" title="2.4.5 匿名用户登录"></a>2.4.5 匿名用户登录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">anonymous_enable=YES <span class="hljs-comment">#支持匿名用户，CentOS8 默认不允许匿名</span><br>no_anon_password=YES <span class="hljs-comment">#匿名用户略过口令检查 , 默认NO</span><br></code></pre></td></tr></table></figure>

<h3 id="2-4-6-匿名用户上传"><a href="#2-4-6-匿名用户上传" class="headerlink" title="2.4.6 匿名用户上传"></a>2.4.6 匿名用户上传</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">anon_upload_enable=YES <span class="hljs-comment">#匿名上传，注意:文件系统权限</span><br>anon_mkdir_write_enable=YES <span class="hljs-comment">#匿名建目录</span><br><br>setfacl -m u:ftp:rwx /var/ftp/pub<br></code></pre></td></tr></table></figure>

<p>注意：还需要开启文件系统访问的权限，不能给FTP根目录写权限，只能级子目录写权限，否则报如下错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ftp 10.0.0.8</span><br>Connected to 10.0.0.8 (10.0.0.8).<br>220 (vsFTPd 3.0.3)<br>Name (10.0.0.8:root): ftp<br>331 Please specify the password.<br>Password:<br>500 OOPS: vsftpd: refusing to run with writable root inside chroot()<br>Login failed.<br>421 Service not available, remote server has closed connection<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">anon_world_readable_only=NO 只能下载全部读的文件, 默认YES<br>anon_umask=0333 指定匿名上传文件的<span class="hljs-built_in">umask</span>，默认077，注意：0333中的0不能省略<br>anon_other_write_enable=YES 可删除和修改上传的文件，默认NO<br></code></pre></td></tr></table></figure>

<h3 id="2-4-7-指定匿名用户的上传文件的默认的所有者和权限"><a href="#2-4-7-指定匿名用户的上传文件的默认的所有者和权限" class="headerlink" title="2.4.7 指定匿名用户的上传文件的默认的所有者和权限"></a>2.4.7 指定匿名用户的上传文件的默认的所有者和权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">chown_uploads=YES     <span class="hljs-comment">#默认NO</span><br>chown_username=wang<br>chown_upload_mode=0644<br></code></pre></td></tr></table></figure>

<h3 id="2-4-8-Linux系统用户"><a href="#2-4-8-Linux系统用户" class="headerlink" title="2.4.8 Linux系统用户"></a>2.4.8 Linux系统用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">local_enable=YES 是否允许linux用户登录<br>write_enable=YES 允许linux用户上传文件<br>local_umask=022 指定系统用户上传文件的默认权限对应<span class="hljs-built_in">umask</span><br></code></pre></td></tr></table></figure>

<h3 id="2-4-9-将系统用户映射为指定的guest用户"><a href="#2-4-9-将系统用户映射为指定的guest用户" class="headerlink" title="2.4.9 将系统用户映射为指定的guest用户"></a>2.4.9 将系统用户映射为指定的guest用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">guest_enable=YES 所有系统用户都映射成guest用户<br>guest_username=ftp  配合上面选项才生效，指定guest用户<br>local_root=/ftproot 指定guest用户登录所在目录,但不影响匿名用户的登录目录<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile8.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-4-10-禁锢系统用户"><a href="#2-4-10-禁锢系统用户" class="headerlink" title="2.4.10 禁锢系统用户"></a>2.4.10 禁锢系统用户</h3><p><strong>禁锢所有系统在家目录中</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">chroot_local_user=YES <span class="hljs-comment">#禁锢系统用户，默认NO，即不禁锢</span><br></code></pre></td></tr></table></figure>

<p><strong>禁锢或不禁锢特定的系统用户在家目录中，与上面设置功能相反</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">chroot_list_enable=YES   <span class="hljs-comment">#默认是NO</span><br>chroot_list_file=/etc/vsftpd/chroot_list  <span class="hljs-comment">#默认值</span><br><br>当chroot_local_user=YES和chroot_list_enable=YES时，则chroot_list中用户不禁锢，即白名单<br>当chroot_local_user=NO和chroot_list_enable=YES时， 则chroot_list中用户禁锢，即黑名单<br></code></pre></td></tr></table></figure>

<h3 id="2-4-11-日志"><a href="#2-4-11-日志" class="headerlink" title="2.4.11 日志"></a>2.4.11 日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#wu-ftp 日志：默认启用</span><br>xferlog_enable=YES 启用记录上传下载日志，此为默认值<br>xferlog_std_format=YES 使用wu-ftp日志格式，此为默认值<br>xferlog_file=/var/<span class="hljs-built_in">log</span>/xferlog 可自动生成， 此为默认值<br><br><span class="hljs-comment">#vsftpd日志：默认不启用</span><br>dual_log_enable=YES 使用vsftpd日志格式，默认不启用<br>vsftpd_log_file=/var/<span class="hljs-built_in">log</span>/vsftpd.log 可自动生成， 此为默认值<br></code></pre></td></tr></table></figure>

<h3 id="2-4-12-提示信息"><a href="#2-4-12-提示信息" class="headerlink" title="2.4.12 提示信息"></a>2.4.12 提示信息</h3><p><strong>登录提示信息</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ftpd_banner=<span class="hljs-string">&quot;welcome to mage ftp server&quot;</span><br>banner_file=/etc/vsftpd/ftpbanner.txt <br></code></pre></td></tr></table></figure>

<p><strong>目录访问提示信息</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">dirmessage_enable=YES 此为默认值<br>message_file=.message 信息存放在指定目录下.message ，此为默认值,只支持单行说明<br></code></pre></td></tr></table></figure>

<h3 id="2-4-13-PAM模块实现用户访问控制"><a href="#2-4-13-PAM模块实现用户访问控制" class="headerlink" title="2.4.13 PAM模块实现用户访问控制"></a>2.4.13 PAM模块实现用户访问控制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">pam_service_name=vsftpd<br><br><span class="hljs-comment">#pam配置文件:/etc/pam.d/vsftpd</span><br>/etc/vsftpd/ftpusers 默认文件中用户拒绝登录，默认是黑名单，但也可以是白名单<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#ldd /usr/sbin/vsftpd |grep pam</span><br>   libpam.so.0 =&gt; /lib64/libpam.so.0 (0x00007fb286c34000)<br><span class="hljs-comment">#修改PAM配置，使ftpusers成为白名单</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/pam.d/vsftpd</span><br><span class="hljs-comment">#%PAM-1.0</span><br>session  optional   pam_keyinit.so  force revoke<br><span class="hljs-comment">#将sense=deny 修改为 sense=allow</span><br>auth    required   pam_listfile.so item=user sense=allow<br>file=/etc/vsftpd/ftpusers onerr=succeed<br>auth    required   pam_shells.so<br>auth    include   password-auth<br>account  include   password-auth<br>session  required   pam_loginuid.so<br>session  include   password-auth<br></code></pre></td></tr></table></figure>

<h3 id="2-4-14-是否启用控制用户登录的列表文件"><a href="#2-4-14-是否启用控制用户登录的列表文件" class="headerlink" title="2.4.14 是否启用控制用户登录的列表文件"></a>2.4.14 是否启用控制用户登录的列表文件</h3><p>never allow users in this file, and do not even prompt for a password.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">userlist_enable=YES                   此为默认值<br>userlist_deny=YES(默认值)              黑名单,不提示口令，NO为白名单<br>userlist_file=/etc/vsftpd/user_list   此为默认值<br></code></pre></td></tr></table></figure>

<h3 id="2-4-14-vsftpd服务指定用户身份运行"><a href="#2-4-14-vsftpd服务指定用户身份运行" class="headerlink" title="2.4.14 vsftpd服务指定用户身份运行"></a>2.4.14 vsftpd服务指定用户身份运行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nopriv_user=nobody  此为默认值<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#pstree -p |grep vsftpd</span><br>     `-vsftpd(82694)-+-vsftpd(83268)---vsftpd(83270)<br>             `-vsftpd(83610)---vsftpd(83612)<br>[root@centos8 ~]<span class="hljs-comment">#ps auxf|grep vsftpd</span><br>root    84248  0.0  0.1  12108  1088 pts/1  S+  15:04  0:00 |     <br>\_ grep --color=auto vsftpd<br>root    82694  0.0  0.0  26980  408 ?    Ss  15:00  0:00<br>/usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf<br>nobody   83268  0.0  0.5  61756  4104 ?    Ss  15:01  0:00 \_<br>/usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf<br>wang    83270  0.0  0.4  74336  3800 ?    S   15:02  0:00 |  \_<br>/usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf<br>nobody   83610  0.0  0.3  37276  2616 ?    Ss  15:03  0:00 \_<br>/usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf<br>ftp    83612  0.0  0.4  67868  3760 ?    S   15:03  0:00   \_<br>/usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile9.png" srcset="/blog/img/loading.gif" alt="netfile8"></p>
<h3 id="2-4-15-连接数限制"><a href="#2-4-15-连接数限制" class="headerlink" title="2.4.15 连接数限制"></a>2.4.15 连接数限制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">max_clients=0 <span class="hljs-comment">#最大并发连接数</span><br></code></pre></td></tr></table></figure>

<p>如果超出连接，会报如下提示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile10.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">max_per_ip=0 <span class="hljs-comment">#每个IP同时发起的最大连接数</span><br></code></pre></td></tr></table></figure>

<p>如果超出连接，会报如下提示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile11.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-4-16-传输速率，单位：字节-秒"><a href="#2-4-16-传输速率，单位：字节-秒" class="headerlink" title="2.4.16 传输速率，单位：字节/秒"></a>2.4.16 传输速率，单位：字节/秒</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">anon_max_rate=0 匿名用户的最大传输速率,以字节为单位,比如:1024000表示1MB/s<br>local_max_rate=0 本地用户的最大传输速率<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#限速</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/vsftpd/vsftpd.conf</span><br>anon_max_rate=1024000<br>local_max_rate=10240000<br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart vsftpd</span><br><br><span class="hljs-comment">#生成测试文件</span><br>[root@centos8 ~]<span class="hljs-comment">#dd if=/dev/zero of=/var/ftp/pub/bigfile bs=1M count=100</span><br>[root@centos8 ~]<span class="hljs-comment">#dd if=/dev/zero of=/home/wang/bigfile bs=1M count=100</span><br><br><span class="hljs-comment">#测试匿名下载速度</span><br>[root@centos7 ~]<span class="hljs-comment">#wget ftp://10.0.0.8/pub/bigfile</span><br>--2020-10-30 18:09:02-- ftp://10.0.0.8/pub/bigfile<br>     =&gt; ‘bigfile.3’<br>Connecting to 10.0.0.8:21... connected.<br>Logging <span class="hljs-keyword">in</span> as anonymous ... Logged <span class="hljs-keyword">in</span>!<br>==&gt; SYST ... <span class="hljs-keyword">done</span>.   ==&gt; PWD ... <span class="hljs-keyword">done</span>.<br>==&gt; TYPE I ... <span class="hljs-keyword">done</span>.  ==&gt; CWD (1) /pub ... <span class="hljs-keyword">done</span>.<br>==&gt; SIZE bigfile ... 104857600<br>==&gt; PASV ... <span class="hljs-keyword">done</span>.   ==&gt; RETR bigfile ... <span class="hljs-keyword">done</span>.<br>Length: 104857600 (100M) (unauthoritative)<br>100%<br>[=====================================================================================================&gt;] 104,857,600 1014KB/s  <span class="hljs-keyword">in</span> 1m 42s<br>2020-10-30 18:10:44 (1001 KB/s) - ‘bigfile.3’ saved [104857600]<br><span class="hljs-comment">#测试本地用户下载速度</span><br>[root@centos7 ~]<span class="hljs-comment">#wget ftp://wang:magedu@10.0.0.8/bigfile</span><br>--2020-10-30 18:08:04-- ftp://wang:*password*@10.0.0.8/bigfile<br>     =&gt; ‘bigfile’<br>Connecting to 10.0.0.8:21... connected.<br>Logging <span class="hljs-keyword">in</span> as wang ... Logged <span class="hljs-keyword">in</span>!<br>==&gt; SYST ... <span class="hljs-keyword">done</span>.   ==&gt; PWD ... <span class="hljs-keyword">done</span>.<br>==&gt; TYPE I ... <span class="hljs-keyword">done</span>.  ==&gt; CWD not needed.<br>==&gt; SIZE bigfile ... 104857600<br>==&gt; PASV ... <span class="hljs-keyword">done</span>.   ==&gt; RETR bigfile ... <span class="hljs-keyword">done</span>.<br>Length: 104857600 (100M) (unauthoritative)<br>100%<br>[=====================================================================================================&gt;] 104,857,600 9.78MB/s  <span class="hljs-keyword">in</span> 10s  <br>2020-10-30 18:08:14 (9.77 MB/s) - ‘bigfile’ saved [104857600]<br></code></pre></td></tr></table></figure>

<h3 id="2-4-17-连接时间：秒为单位"><a href="#2-4-17-连接时间：秒为单位" class="headerlink" title="2.4.17 连接时间：秒为单位"></a>2.4.17 连接时间：秒为单位</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">connect_timeout=60 主动模式数据连接超时时长<br>accept_timeout=60 被动模式数据连接超时时长<br>data_connection_timeout=300 数据连接无数据输超时时长<br>idle_session_timeout=60 无命令操作超时时长<br></code></pre></td></tr></table></figure>

<h3 id="2-4-18-优先以文本方式传输"><a href="#2-4-18-优先以文本方式传输" class="headerlink" title="2.4.18 优先以文本方式传输"></a>2.4.18 优先以文本方式传输</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ascii_upload_enable=YES<br>ascii_download_enable=YES<br></code></pre></td></tr></table></figure>

<p>说明：不建议使用文本方式，因为可能导致二进制文件内容被破坏</p>
<h3 id="2-4-19-实现基于-SSL-的-FTPS"><a href="#2-4-19-实现基于-SSL-的-FTPS" class="headerlink" title="2.4.19 实现基于 SSL 的 FTPS"></a>2.4.19 实现基于 SSL 的 FTPS</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile12.png" srcset="/blog/img/loading.gif"></p>
<p>查看是否支持SSL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ldd `<span class="hljs-built_in">which</span> vsftpd` <span class="hljs-comment">#查看到libssl.so</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#ldd `which vsftpd`|grep libssl</span><br>libssl.so.1.1 =&gt; /lib64/libssl.so.1.1 (0x00007f8878e2c000)<br></code></pre></td></tr></table></figure>

<p>范例: 实现SSL的FTP服务<br>1 创建自签名证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#CentOS 7 上可以实现直接生成一个包括私钥和证书的文件</span><br>[root@centos7 ~]<span class="hljs-comment">#mkdir /etc/vsftpd/ssl</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /etc/pki/tls/certs/</span><br>[root@centos7 certs]<span class="hljs-comment">#make /etc/vsftpd/ssl/vsftpd.pem</span><br>[root@centos7 certs]<span class="hljs-comment">#openssl x509 -in /etc/vsftpd/ssl/vsftpd.pem -noout -text</span><br><br><span class="hljs-comment">#在CentOS8上手动分别生成一个证书和私钥文件，再合并成一个文件</span><br>[root@centos8 ~]<span class="hljs-comment">#mkdir /etc/vsftpd/ssl</span><br>[root@centos8 ~]<span class="hljs-comment">#cd /etc/vsftpd/ssl</span><br>[root@centos8 ssl]<span class="hljs-comment">#openssl req -x509 -nodes -keyout vsftpd.key -out vsftpd.crt -days 365 -newkey rsa:2048</span><br>[root@centos8 ssl]<span class="hljs-comment">#cat vsftpd.crt vsftpd.key &gt; /etc/vsftpd/ssl/vsftpd.pem</span><br></code></pre></td></tr></table></figure>

<p>2 配置vsftpd服务支持SSL：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#vim /etc/vsftpd/vsftpd.conf</span><br>ssl_enable=YES <span class="hljs-comment">#启用SSL</span><br>allow_anon_ssl=NO <span class="hljs-comment">#匿名不支持SSL</span><br>force_local_logins_ssl=YES <span class="hljs-comment">#本地用户登录加密</span><br>force_local_data_ssl=YES <span class="hljs-comment">#本地用户数据传输加密</span><br>rsa_cert_file=/etc/vsftpd/ssl/vsftpd.pem  <span class="hljs-comment">#一个包括证书和私钥两个内容的文件</span><br><br><span class="hljs-comment">#rsa_private_key_file /path/file  #此项如果没有指定，私钥也在证书文件中</span><br><span class="hljs-comment">#ssl_tlsv1=YES</span><br><span class="hljs-comment">#ssl_sslv2=NO</span><br><span class="hljs-comment">#ssl_sslv3=NO</span><br><span class="hljs-comment">#require_ssl_reuse=NO</span><br><span class="hljs-comment">#ssl_ciphers=HIGH</span><br><br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart vsftpd</span><br><br>[root@centos7 ~]<span class="hljs-comment">#ftp 192.168.100.8</span><br>Connected to 192.168.100.8 (192.168.100.8).<br>220-welcome to magedu<br>220<br>Name (192.168.100.8:root): wang<br>530 Non-anonymous sessions must use encryption.<br>Login failed.<br>421 Service not available, remote server has closed connection<br><br><span class="hljs-comment">#用filezilla等工具测试</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile13.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile14.png" srcset="/blog/img/loading.gif"></p>
<h2 id="2-5-vsftpd-虚拟用户"><a href="#2-5-vsftpd-虚拟用户" class="headerlink" title="2.5 vsftpd 虚拟用户"></a>2.5 vsftpd 虚拟用户</h2><p>虚拟用户：给特定服务使用的用户帐号</p>
<ul>
<li>所有虚拟用户会统一映射为一个指定的系统帐号：访问共享位置，即为此系统帐号的家目录</li>
<li>各虚拟用户可被赋予不同的访问权限，通过匿名用户的权限控制参数进行指定虚拟用户帐号的存储方式：</li>
<li>文件：创建文本文件，奇数行为用户名，偶数行为密码,再被编码为hash 格式Berkeley DB database文件</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">db_load -T -t hash -f vusers.txt vusers.db<br></code></pre></td></tr></table></figure>

<ul>
<li>关系型数据库中的表中：实时查询数据库完成用户认证<br>vsftpd 支持mysql库：pam要依赖于pam-mysql</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">/lib64/security/pam_mysql.so<br>/usr/share/doc/pam_mysql-0.7/README<br></code></pre></td></tr></table></figure>

<h3 id="2-5-1-实现基于文件验证的vsftpd虚拟用户"><a href="#2-5-1-实现基于文件验证的vsftpd虚拟用户" class="headerlink" title="2.5.1 实现基于文件验证的vsftpd虚拟用户"></a>2.5.1 实现基于文件验证的vsftpd虚拟用户</h3><h4 id="2-5-1-1-创建用户数据库文件"><a href="#2-5-1-1-创建用户数据库文件" class="headerlink" title="2.5.1.1 创建用户数据库文件"></a>2.5.1.1 创建用户数据库文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#rpm -qf `which db_load`</span><br>libdb-utils-5.3.28-37.el8.x86_64<br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/vsftpd/vusers.txt</span><br>ftp_wang<br>wangpass<br>ftp_mage<br>magepass<br>[root@centos8 ~]<span class="hljs-comment">#db_load -T -t hash -f /etc/vsftpd/vusers.txt</span><br>/etc/vsftpd/vusers.db<br>[root@centos8 ~]<span class="hljs-comment">#chmod 600 /etc/vsftpd/vusers.*</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-2-创建用户和访问FTP目录"><a href="#2-5-1-2-创建用户和访问FTP目录" class="headerlink" title="2.5.1.2 创建用户和访问FTP目录"></a>2.5.1.2 创建用户和访问FTP目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#useradd -d /data/ftproot -s /sbin/nologin -r vuser</span><br>[root@centos8 ~]<span class="hljs-comment">#mkdir -pv /data/ftproot/upload</span><br>[root@centos8 ~]<span class="hljs-comment">#setfacl -m u:vuser:rwx /data/ftproot/upload</span><br><br><span class="hljs-comment">#chmod a=rx /data/ftproot/ 如果自动创建家目录，需修改权限</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-3-创建pam配置文件"><a href="#2-5-1-3-创建pam配置文件" class="headerlink" title="2.5.1.3 创建pam配置文件"></a>2.5.1.3 创建pam配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#vim /etc/pam.d/vsftpd.db</span><br>auth required pam_userdb.so db=/etc/vsftpd/vusers<br>account required pam_userdb.so db=/etc/vsftpd/vusers<br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-4-指定pam配置文件"><a href="#2-5-1-4-指定pam配置文件" class="headerlink" title="2.5.1.4 指定pam配置文件"></a>2.5.1.4 指定pam配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#vim /etc/vsftpd/vsftpd.conf</span><br>guest_enable=YES<br>guest_username=vuser<br>pam_service_name=vsftpd.db<br></code></pre></td></tr></table></figure>

<h4 id="2-5-1-5-虚拟用户建立独立的配置文件"><a href="#2-5-1-5-虚拟用户建立独立的配置文件" class="headerlink" title="2.5.1.5 虚拟用户建立独立的配置文件"></a>2.5.1.5 虚拟用户建立独立的配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#指定各个用户配置文件存放的路径</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/vsftpd/vsftpd.conf</span><br>user_config_dir=/etc/vsftpd/conf.d/<br><br><span class="hljs-comment">#创建各个用户配置文件存放的路径</span><br>[root@centos8 ~]<span class="hljs-comment">#mkdir /etc/vsftpd/conf.d/</span><br><br><span class="hljs-comment">#创建各用户自已的配置文件,允许wang用户可读写，其它用户只读</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/vsftpd/conf.d/ftp_wang </span><br>anon_upload_enable=YES<br>anon_mkdir_write_enable=YES<br>anon_other_write_enable=YES<br><span class="hljs-comment">#创建各用户自已的配置文件</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/vsftpd/conf.d/ftp_mage </span><br><span class="hljs-comment">#登录目录改变至指定的目录</span><br>local_root=/data/ftproot2 <br><br><span class="hljs-comment">#针对ftp_mage用户建立对应的数据目录</span><br>[root@centos8 ~]<span class="hljs-comment">#mkdir /data/ftproot2/</span><br></code></pre></td></tr></table></figure>

<h3 id="2-5-2-实现基于MYSQL验证的vsftpd虚拟用户"><a href="#2-5-2-实现基于MYSQL验证的vsftpd虚拟用户" class="headerlink" title="2.5.2 实现基于MYSQL验证的vsftpd虚拟用户"></a>2.5.2 实现基于MYSQL验证的vsftpd虚拟用户</h3><p>利用 pam_mysql 模块可以实现基于MySQL的FTP虚拟用户功能</p>
<p>项目网站：<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/pam-mysql/">https://sourceforge.net/projects/pam-mysql/</a></p>
<p><strong>注意:因为此项目年代久远不再更新，当前只支持CentOS 6,7，不支持CentOS 8</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile15.png" srcset="/blog/img/loading.gif"></p>
<p><strong>环境准备</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">本实验在两台主机上实现<br>一台做为FTP服务器,CentOS 7<br>一台做MySQL 数据库服务器<br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-1-在数据库服务器上安装mysql数据库"><a href="#2-5-2-1-在数据库服务器上安装mysql数据库" class="headerlink" title="2.5.2.1 在数据库服务器上安装mysql数据库"></a>2.5.2.1 在数据库服务器上安装mysql数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注意：MySQL8.0由于取消了PASSWORD()函数不支持,因此选择Mariadb</span><br>[root@centos8 ~]<span class="hljs-comment">#yum -y install mariadb-server</span><br>[root@centos8 ~]<span class="hljs-comment">#systemctl enable --now mariadb.service</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-2-在数据库服务上配置数据库支持vsftpd服务"><a href="#2-5-2-2-在数据库服务上配置数据库支持vsftpd服务" class="headerlink" title="2.5.2.2 在数据库服务上配置数据库支持vsftpd服务"></a>2.5.2.2 在数据库服务上配置数据库支持vsftpd服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#建立存储虚拟用户数据库和表</span><br>[root@centos8 ~]<span class="hljs-comment">#mysql</span><br>mysql&gt; CREATE DATABASE vsftpd;<br>mysql&gt; USE vsftpd;<br>mysql&gt; CREATE TABLE users (<br>id INT AUTO_INCREMENT NOT NULL PRIMARY KEY,<br>name CHAR(50) BINARY NOT NULL,<br>password CHAR(48) BINARY NOT NULL<br>);<br><span class="hljs-comment">#添加虚拟用户，为了安全应该使用PASSWORD函数加密其密码后存储</span><br>mysql&gt; INSERT INTO users(name,password) values(<span class="hljs-string">&#x27;ftp_wang&#x27;</span>,password(<span class="hljs-string">&#x27;magedu&#x27;</span>));<br>mysql&gt; INSERT INTO users(name,password) values(<span class="hljs-string">&#x27;ftp_mage&#x27;</span>,password(<span class="hljs-string">&#x27;magedu&#x27;</span>));<br>mysql&gt; select * from users;<br>+----+-----------+-------------------------------------------+<br>| id | name      | password                                  |<br>+----+-----------+-------------------------------------------+<br>|  1 | ftp_wang  | *6B8CCC83799A26CD19D7AD9AEEADBCD30D8A8664 |<br>|  2 | ftp_wang  | *6B8CCC83799A26CD19D7AD9AEEADBCD30D8A8664 |<br>+----+-----------+-------------------------------------------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.001 sec)<br><br><span class="hljs-comment">#创建连接的数据库用户</span><br>mysql&gt; GRANT SELECT ON vsftpd.* TO vsftpd@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;magedu&#x27;</span>;<br>mysql&gt; FLUSH PRIVILEGES;<br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-3-在FTP服务器上安装vsftpd-和-pam-mysql包"><a href="#2-5-2-3-在FTP服务器上安装vsftpd-和-pam-mysql包" class="headerlink" title="2.5.2.3 在FTP服务器上安装vsftpd 和 pam_mysql包"></a>2.5.2.3 在FTP服务器上安装vsftpd 和 pam_mysql包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#yum install vsftpd</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-4-在FTP服务器上安装-pam-mysql"><a href="#2-5-2-4-在FTP服务器上安装-pam-mysql" class="headerlink" title="2.5.2.4 在FTP服务器上安装 pam_mysql"></a>2.5.2.4 在FTP服务器上安装 pam_mysql</h4><p>对于 centos 6：pam_mysql由EPEL的源中提供</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#yum install pam_mysql</span><br></code></pre></td></tr></table></figure>

<p>对于 centos7 和 8：无对应rpm包，需手动编译安装<br><strong>pam-mysql源码进行编译</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装相关包</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install vsftpd gcc gcc-c++ make mariadb-devel pam-devel</span><br><span class="hljs-comment">#下载pam-mysql源码进行编译</span><br>[root@centos7 ~]<span class="hljs-comment">#wget http://prdownloads.sourceforge.net/pam-mysql/pam_mysql-0.7RC1.tar.gz</span><br><span class="hljs-comment">#https://github.com/NigelCunningham/pam-MySQL/archive/v0.8.1.tar.gz</span><br>[root@centos7 ~]<span class="hljs-comment">#tar xvf pam_mysql-0.7RC1.tar.gz</span><br>[root@centos7 ~]<span class="hljs-comment">#cd pam_mysql-0.7RC1/</span><br>[root@centos7 pam_mysql-0.7RC1]<span class="hljs-comment">#./configure --with-pam-mods-dir=/lib64/security</span><br><br><br><span class="hljs-comment">#如果上面命令不指定 --with-pam-mods-dir=/lib64/security 会报以下错误</span><br><span class="hljs-comment">#checking if the second argument of pam_conv.conv() takes const pointer... no</span><br>configure: error: Your system doesn<span class="hljs-string">&#x27;t appear to be configured to use PAM.</span><br><span class="hljs-string">Perhaps you need to specify the correct location where the PAM modules reside.</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 pam_mysql-0.7RC1]#make install</span><br><span class="hljs-string">[root@centos7 pam_mysql-0.7RC1]#ll /lib64/security/pam_mysql*</span><br><span class="hljs-string">-rwxr-xr-x 1 root root   882 Dec 17 14:34 /lib64/security/pam_mysql.la</span><br><span class="hljs-string">-rwxr-xr-x 1 root root 141712 Dec 17 14:34 /lib64/security/pam_mysql.so</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-5-在FTP服务器上建立pam认证所需文件"><a href="#2-5-2-5-在FTP服务器上建立pam认证所需文件" class="headerlink" title="2.5.2.5 在FTP服务器上建立pam认证所需文件"></a>2.5.2.5 在FTP服务器上建立pam认证所需文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vi /etc/pam.d/vsftpd.mysql</span><br><span class="hljs-comment">#添加如下两行</span><br>auth required pam_mysql.so user=vsftpd passwd=magedu host=mysqlserver db=vsftpd<br>table=users usercolumn=name passwdcolumn=password crypt=2<br>account required pam_mysql.so user=vsftpd passwd=magedu host=mysqlserver<br>db=vsftpd table=users usercolumn=name passwdcolumn=password crypt=2<br></code></pre></td></tr></table></figure>

<p>注意：以上参考 README文档<br><strong>crypt 加密方式：</strong></p>
<ul>
<li>0表示不加密</li>
<li>1表示crypt(3)加密</li>
<li>2表示使用mysql password()函数加密</li>
<li>3表示md5加密</li>
<li>4表示sha1加密</li>
</ul>
<p><strong>配置字段说明</strong></p>
<ul>
<li>auth 表示认证</li>
<li>account 验证账号密码正常使用</li>
<li>required 表示认证要通过</li>
<li>pam_mysql.so模块是默认的相对路径，是相对/lib64/security/路径而言，也可以写绝对路径；后面为给此模块传递的参数</li>
<li>user=vsftpd为登录mysql的用户</li>
<li>passwd=magedu 登录mysql的的密码</li>
<li>host=mysqlserver mysql服务器的主机名或ip地址</li>
<li>db=vsftpd 指定连接msyql的数据库名称</li>
<li>table=users 指定连接数据库中的表名</li>
<li>usercolumn=name 当做用户名的字段</li>
<li>passwdcolumn=password 当做用户名字段的密码</li>
<li>crypt=2 密码的加密方式为mysql password()函数加密</li>
</ul>
<h4 id="2-5-2-6-建立相应用户和修改vsftpd配置文件"><a href="#2-5-2-6-建立相应用户和修改vsftpd配置文件" class="headerlink" title="2.5.2.6 建立相应用户和修改vsftpd配置文件"></a>2.5.2.6 建立相应用户和修改vsftpd配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#建立虚拟用户映射的系统用户及对应的目录</span><br>[root@centos7 ~]<span class="hljs-comment">#useradd -s /sbin/nologin -d /data/ftproot -r vuser</span><br><span class="hljs-comment">#centos7 需除去ftp根目录的写权限</span><br><br>[root@centos7 ~]<span class="hljs-comment">#mkdir -pv /data/ftproot/upload</span><br>[root@centos7 ~]<span class="hljs-comment">#setfacl -m u:vuser:rwx /data/ftproot/upload</span><br><br><span class="hljs-comment">#确保/etc/vsftpd/vsftpd.conf中已经启用了以下选项</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/vsftpd/vsftpd.conf</span><br>anonymous_enable=YES<br><span class="hljs-comment">#添加下面两项</span><br>guest_enable=YES<br>guest_username=vuser<br><br><span class="hljs-comment">#修改下面一项，原系统用户无法登录</span><br>pam_service_name=vsftpd.mysql<br><br><span class="hljs-comment">#启动vsftpd服务</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl enable --now vsftpd</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-7-在FTP服务器上配置虚拟用户具有不同的访问权限"><a href="#2-5-2-7-在FTP服务器上配置虚拟用户具有不同的访问权限" class="headerlink" title="2.5.2.7 在FTP服务器上配置虚拟用户具有不同的访问权限"></a>2.5.2.7 在FTP服务器上配置虚拟用户具有不同的访问权限</h4><p>vsftpd可以在配置文件目录中为每个用户提供单独的配置文件以定义其ftp服务访问权限，每个虚拟用户的配置文件名同虚拟用户的用户名。配置文件目录可以是任意未使用目录，只需要在vsftpd.conf指定其路径及名称即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#配置vsftpd为虚拟用户使用配置文件目录</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/vsftpd/vsftpd.conf</span><br><span class="hljs-comment">#添加如下选项</span><br>user_config_dir=/etc/vsftpd/conf.d/<br><br><span class="hljs-comment">#创建所需要目录，并为虚拟用户提供配置文件</span><br>[root@centos7 ~]<span class="hljs-comment">#mkdir /etc/vsftpd/conf.d/</span><br><span class="hljs-comment">#配置虚拟用户的访问权限</span><br><span class="hljs-comment">#虚拟用户对vsftpd服务的访问权限是通过匿名用户的相关指令进行的。如要让用户wang具有上传文件的权限，可修改/etc/vsftpd/vusers.d/wang文件，在里面添加如下选项并设置为YES即可,只读则设为NO</span><br><span class="hljs-comment">#注意：需确保对应的映射用户对于文件系统有写权限</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/vsftpd/conf.d/ftp_wang</span><br>anon_upload_enable=&#123;YES|NO&#125;<br>anon_mkdir_write_enable=&#123;YES|NO&#125;<br>anon_other_write_enable=&#123;YES|NO&#125;<br><span class="hljs-comment">#登录目录改变至指定的目录</span><br>local_root=/data/ftproot2<br></code></pre></td></tr></table></figure>



<h1 id="三、NFS-服务"><a href="#三、NFS-服务" class="headerlink" title="三、NFS 服务"></a>三、NFS 服务</h1><h2 id="3-1-NFS工作原理"><a href="#3-1-NFS工作原理" class="headerlink" title="3.1 NFS工作原理"></a>3.1 NFS工作原理</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile16.png" srcset="/blog/img/loading.gif"></p>
<p>NFS：Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件，基于RPC（Remote Procedure CallProtocol 远程过程调用）实现RPC采用C/S模式，客户机请求程序调用进程发送一个有进程参数的调用信息到服务进程，然后等待应答信息。在服务器端，进程保持睡眠状态直到调用信息到达为止。当一个调用信息到达，服务器获得进程参数，计算结果，发送答复信息，然后等待下一个调用信息，最后，客户端调用进程接收答复信息，获得进程结果，然后调用执行继续进行</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile17.png" srcset="/blog/img/loading.gif"></p>
<p>NFS优势：节省本地存储空间，将常用的数据,如：/home目录，存放在NFS服务器上且可以通过网络访问，本地终端将可减少自身存储空间的使用</p>
<h2 id="3-2-NFS软件介绍"><a href="#3-2-NFS软件介绍" class="headerlink" title="3.2 NFS软件介绍"></a>3.2 NFS软件介绍</h2><p>软件包：nfs-utils（包括服务器和客户端相关工具，CentOS8 最小化安装时默认没有安装）</p>
<p>相关软件包：rpcbind（必须），tcp_wrappers</p>
<p>Kernel支持：nfs.ko</p>
<p>端口：2049(nfsd), 其它端口由portmap(111)分配</p>
<p>NFS服务主要进程：</p>
<ul>
<li>rpc.nfsd 最主要的NFS进程，管理客户端是否可登录</li>
<li>rpc.mountd 挂载和卸载NFS文件系统，包括权限管理</li>
<li>rpc.lockd 非必要，管理文件锁，避免同时写出错</li>
<li>rpc.statd 非必要，检查文件一致性，可修复文件</li>
</ul>
<p>说明：CentOS 6 开始portmap进程由rpcbind代替</p>
<p>日志：/var/lib/nfs/<br>NFS配置文件：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">/etc/exports<br>/etc/exports.d/*.exports<br></code></pre></td></tr></table></figure>

<h2 id="3-3-NFS共享配置文件格式"><a href="#3-3-NFS共享配置文件格式" class="headerlink" title="3.3 NFS共享配置文件格式"></a>3.3 NFS共享配置文件格式</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">/dir 主机1(opt1,opt2) 主机2(opt1,opt2)...<br></code></pre></td></tr></table></figure>

<p>格式说明：</p>
<ul>
<li>以#开始的行为注释</li>
<li>主机格式：</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">anonymous：表示使用*通配所有客户端<br>单个主机：ipv4，ipv6，FQDN<br><br>IP networks：两种掩码格式均支持<br>172.18.0.0/255.255.0.0<br>172.18.0.0/16<br><br>wildcards：主机名通配，例如:*.magedu.com，IP不可以<br><br>netgroups：NIS域的主机组，@group_name<br></code></pre></td></tr></table></figure>

<ul>
<li>每个条目指定目录导出到的哪些主机，及相关的权限和选项</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">默认选项：(ro,sync,root_squash,no_all_squash)<br>ro,rw 只读和读写<br>async 异步，数据变化后不立即写磁盘，先写入到缓冲区中，过一段时间再写入磁盘，性能高,安全性低<br>sync（1.0.0后为默认）同步，数据在请求时立即写入共享存储磁盘,性能低,安全性高<br>root_squash （默认）远程root映射为nfsnobody,UID为65534，CentOS8 为nobody,CentOS7以前的版本为nfsnobody<br>no_root_squash 远程root映射成NFS服务器的root用户<br>all_squash 所有远程用户(包括root)都变成nfsnobody,CentOS8 为nobody<br>no_all_squash （默认）保留共享文件的UID和GID<br>anonuid和anongid 指明匿名用户映射为特定用户UID和组GID，而非nobody,可配合all_squash使用<br></code></pre></td></tr></table></figure>

<p>范例：NFS配置示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/exports<br>/myshare server.example.com<br>/myshare *.example.com<br>/myshare server?.example.com<br>/myshare server[0-20].example.com<br>/myshare 172.25.11.10<br>/myshare 172.25.0.0/16<br>/myshare 2000:472:18:b51:c32:a21<br>/myshare 2000:472:18:b51::/64<br>/myshare *.example.com 172.25.0.0/16<br>/myshare desktop.example.com(ro)<br>/myshare desktop.example.com(ro) server[0-20].example.com(rw)<br>/myshare diskless.example.com(rw,no_root_squash)<br></code></pre></td></tr></table></figure>

<h2 id="3-4-NFS工具"><a href="#3-4-NFS工具" class="headerlink" title="3.4 NFS工具"></a>3.4 NFS工具</h2><h3 id="3-4-1-rpcinfo"><a href="#3-4-1-rpcinfo" class="headerlink" title="3.4.1 rpcinfo"></a>3.4.1 rpcinfo</h3><p>rpcinfo 工具可以查看RPC相关信息</p>
<p>查看注册在指定主机的RPC程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpcinfo -p hostname<br></code></pre></td></tr></table></figure>

<p>查看RPC注册程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpcinfo -s hostname<br></code></pre></td></tr></table></figure>

<p>范例：rpcinfo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#rpcinfo -p</span><br> program vers proto  port  service<br>  100000   4  tcp   111 portmapper<br>  100000   3  tcp   111 portmapper<br>  100000   2  tcp   111 portmapper<br>  100000   4  udp   111 portmapper<br>  100000   3  udp   111 portmapper<br>  100000   2  udp   111 portmapper<br>  100024   1  udp  58875 status<br>  100024   1  tcp  49005 status<br>  100005   1  udp  20048 mountd<br>  100005   1  tcp  20048 mountd<br>  100005   2  udp  20048 mountd<br>  100005   2  tcp  20048 mountd<br>  100005   3  udp  20048 mountd<br>  100005   3  tcp  20048 mountd<br>  100003   3  tcp  2049 nfs<br>  100003   4  tcp  2049 nfs<br>  100227   3  tcp  2049 nfs_acl<br>  100021   1  udp  38963 nlockmgr<br>  100021   3  udp  38963 nlockmgr<br>  100021   4  udp  38963 nlockmgr<br>  100021   1  tcp  35503 nlockmgr<br>  100021   3  tcp  35503 nlockmgr<br>  100021   4  tcp  35503 nlockmgr<br>  <br>[root@centos8 ~]<span class="hljs-comment">#rpcinfo -s</span><br> program version(s) netid(s)             service   owner<br>  100000  2,3,4   <span class="hljs-built_in">local</span>,udp,tcp,udp6,tcp6     portmapper superuser<br>  100024  1     tcp6,udp6,tcp,udp        status    29<br>  <br><span class="hljs-comment">#查看远程主机</span><br>[root@centos7 ~]<span class="hljs-comment">#rpcinfo -p 10.0.0.8</span><br> program vers proto  port  service<br>  100000   4  tcp   111 portmapper<br>  100000   3  tcp   111 portmapper<br>  100000   2  tcp   111 portmapper<br>  100000   4  udp   111 portmapper<br>  100000   3  udp   111 portmapper<br>  100000   2  udp   111 portmapper<br>  100024   1  udp  38427 status<br>  100024   1  tcp  34335 status<br>  100005   1  udp  20048 mountd<br>  100005   1  tcp  20048 mountd<br>  100005   2  udp  20048 mountd<br>  100005   2  tcp  20048 mountd<br>  100005   3  udp  20048 mountd<br>  100005   3  tcp  20048 mountd<br>  100003   3  tcp  2049 nfs<br>  100003   4  tcp  2049 nfs<br>  100227   3  tcp  2049 nfs_acl<br>  100021   1  udp  44185 nlockmgr<br>  100021   3  udp  44185 nlockmgr<br>  100021   4  udp  44185 nlockmgr<br>  100021   1  tcp  46603 nlockmgr<br>  100021   3  tcp  46603 nlockmgr<br>  100021   4  tcp  46603 nlockmgr<br>[root@centos7 ~]<span class="hljs-comment">#rpcinfo -s 10.0.0.8</span><br> program version(s) netid(s)             service   owner<br>  100000  2,3,4   <span class="hljs-built_in">local</span>,udp,tcp,udp6,tcp6     portmapper superuser<br>  100024  1     tcp6,udp6,tcp,udp        status    29<br>  100005  3,2,1   tcp6,udp6,tcp,udp        mountd   superuser<br>  100003  4,3    tcp6,tcp             nfs     superuser<br>  100227  3     tcp6,tcp             nfs_acl   superuser<br>  100021  4,3,1   tcp6,udp6,tcp,udp        nlockmgr  superuser<br></code></pre></td></tr></table></figure>

<h3 id="3-4-2-exportfs"><a href="#3-4-2-exportfs" class="headerlink" title="3.4.2 exportfs"></a>3.4.2 exportfs</h3><p>exportfs:可用于管理NFS导出的文件系统</p>
<p>常见选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">-v <span class="hljs-comment">#查看本机所有NFS共享</span><br>-r <span class="hljs-comment">#重读配置文件，并共享目录</span><br>-a <span class="hljs-comment">#输出本机所有共享</span><br>-au <span class="hljs-comment">#停止本机所有共享</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-3-showmount"><a href="#3-4-3-showmount" class="headerlink" title="3.4.3 showmount"></a>3.4.3 showmount</h3><p>常见用法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看远程主机的NFS共享</span><br>showmount -e hostname<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#showmount -e 10.0.0.8</span><br>Export list <span class="hljs-keyword">for</span> 10.0.0.8:<br>/data/wordpress *<br></code></pre></td></tr></table></figure>

<h3 id="3-4-4-mount-nfs"><a href="#3-4-4-mount-nfs" class="headerlink" title="3.4.4 mount.nfs"></a>3.4.4 mount.nfs</h3><p>客户端NFS挂载</p>
<p>NFS相关的挂载选项：man 5 nfs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">fg</span> <span class="hljs-comment">#（默认）前台挂载</span><br><span class="hljs-built_in">bg</span> <span class="hljs-comment">#后台挂载</span><br>hard <span class="hljs-comment">#（默认）持续请求</span><br>soft  <span class="hljs-comment">#非持续请求</span><br>intr  <span class="hljs-comment">#和hard配合，请求可中断</span><br>rsize <span class="hljs-comment">#和wsize 一次读和写数据最大字节数，rsize=32768</span><br>_netdev <span class="hljs-comment">#无网络连接不挂载</span><br>vers   <span class="hljs-comment">#指定版本，客户端centos8默认4.2 ，centos7默认4.1 centos6默认4.0</span><br></code></pre></td></tr></table></figure>

<p>提示：基于安全考虑，建议使用 nosuid,<em>netdev,noexec 挂载选项</em></p>
<p>范例：临时挂载NFS共享</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mount -o rw,nosuid,<span class="hljs-built_in">fg</span>,hard,intr 172.16.0.1:/testdir /mnt/nfs/<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#mkdir /mnt/nfs</span><br>[root@centos7 ~]<span class="hljs-comment">#mount 10.0.0.8:/data/wordpress /mnt/nfs</span><br>[root@centos7 ~]<span class="hljs-comment">#ls /mnt/nfs</span><br>index.html<br>[root@centos7 ~]<span class="hljs-comment">#df -T /mnt/nfs</span><br>Filesystem        Type 1K-blocks  Used Available Use% Mounted on<br>10.0.0.8:/data/wordpress nfs4  52403200 398336  52004864  1% /mnt/nfs<br></code></pre></td></tr></table></figure>

<p>范例：开机挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/fstab <br>172.16.0.1:/public  /mnt/nfs  nfs  defaults,_netdev  0  0<br></code></pre></td></tr></table></figure>

<p>范例: 远程的 root 映射为NFS服务器的nobody用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#grep nobody /etc/passwd</span><br>nobody:x:99:99:Nobody:/:/sbin/nologin<br>nfsnobody:x:65534:65534:Anonymous NFS User:/var/lib/nfs:/sbin/nologin<br><br>[root@centos7 ~]<span class="hljs-comment">#grep nobody /etc/passwd</span><br>nobody:x:99:99:Nobody:/:/sbin/nologin<br>nfsnobody:x:65534:65534:Anonymous NFS User:/var/lib/nfs:/sbin/nologin<br><br>[root@centos8 ~]<span class="hljs-comment">#grep nobody /etc/passwd</span><br>nobody:x:65534:65534:Kernel Overflow User:/:/sbin/nologin<br></code></pre></td></tr></table></figure>

<h2 id="3-5-自动挂载"><a href="#3-5-自动挂载" class="headerlink" title="3.5 自动挂载"></a>3.5 自动挂载</h2><p>可使用 autofs 服务按需要挂载外围设备，NFS共享等，并在空闲5分钟后后自动卸载</p>
<h3 id="3-5-1-相关包和文件"><a href="#3-5-1-相关包和文件" class="headerlink" title="3.5.1 相关包和文件"></a>3.5.1 相关包和文件</h3><p>软件包：autofs</p>
<p>服务文件：/usr/lib/systemd/system/autofs.service</p>
<p>配置文件：/etc/auto.master</p>
<h3 id="3-5-2-配置文件格式"><a href="#3-5-2-配置文件格式" class="headerlink" title="3.5.2 配置文件格式"></a>3.5.2 配置文件格式</h3><p>参看帮助：man 5 autofs</p>
<p>所有导出到网络中的NFS启用特殊匹配 -host 至“browse”</p>
<p>范例：/net目录可以自动挂载NFS共享</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat /etc/auto.master<br>/net  -hosts<br><span class="hljs-built_in">cd</span> /net/192.168.8.100/<br></code></pre></td></tr></table></figure>

<p>自动挂载资源有两种格式：</p>
<ul>
<li>相对路径法：将mount point 路径分成 dirname 和 basename 分别配置，可能会影响现有的目录结构</li>
<li>绝对路径法：直接匹配全部的绝对路径名称，都写入到指定的配置文件里,不会影响本地目录结构</li>
</ul>
<h4 id="3-5-2-1-相对路径法"><a href="#3-5-2-1-相对路径法" class="headerlink" title="3.5.2.1 相对路径法"></a>3.5.2.1 相对路径法</h4><ol>
<li>/etc/auto.master 格式</li>
</ol>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">挂载点的dirname   指定目录的配置文件路径,如:/etc/test.auto<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>指定目录的配置文件格式</li>
</ol>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">#/etc/test.auto<br>挂载点的basename   挂载选项   选项设备<br></code></pre></td></tr></table></figure>

<p>范例：相对路径法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#vim /etc/auto.master</span><br>/misc  /etc/auto.misc<br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/auto.misc</span><br><span class="hljs-built_in">cd</span>    -fstype=iso9660,ro,nosuid,nodev  :/dev/cdrom<br></code></pre></td></tr></table></figure>

<p>范例：相对路径法为支持通配符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/auto.master<br>/misc  /etc/auto.misc<br><br>vim /etc/auto.misc<br><span class="hljs-comment">#表示/misc下面的子目录和nfs共享/export目录的子目录同名</span><br>* server:/<span class="hljs-built_in">export</span>/&amp;<br></code></pre></td></tr></table></figure>

<h4 id="3-5-2-2-绝对路径法"><a href="#3-5-2-2-绝对路径法" class="headerlink" title="3.5.2.2 绝对路径法"></a>3.5.2.2 绝对路径法</h4><ol>
<li><p>/etc/auto.master 格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/-     指定配置文件路径<br></code></pre></td></tr></table></figure></li>
<li><p>指定配置文件格式</p>
</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">挂载点完整的绝对路径    挂载选项   选项设备<br></code></pre></td></tr></table></figure>

<p>范例：绝对路径法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/auto.master:<br>/- /etc/auto.direct<br><br>vim /etc/auto.direct:<br>/foo -fstype=nfs server1:/<span class="hljs-built_in">export</span>/foo<br>/user/<span class="hljs-built_in">local</span>/ -fstype=nfs,vers=3 server1:/usr/<span class="hljs-built_in">local</span><br>/mnt/cdrom -fstype=iso9660 :/dev/cdrom<br></code></pre></td></tr></table></figure>

<h2 id="3-7-实战案例"><a href="#3-7-实战案例" class="headerlink" title="3.7 实战案例"></a>3.7 实战案例</h2><h3 id="3-7-1-目标"><a href="#3-7-1-目标" class="headerlink" title="3.7.1 目标"></a>3.7.1 目标</h3><p>将NFS的共享目录，通过autofs 发布出来，做为远程主机用户的家目录</p>
<h3 id="3-7-2-环境准备"><a href="#3-7-2-环境准备" class="headerlink" title="3.7.2 环境准备"></a>3.7.2 环境准备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">共三台主机<br><br>一台主机 nfs server<br>IP:10.0.0.8<br><br>另两台当 nfs client<br>IP:10.0.0.7<br>IP:10.0.0.6<br></code></pre></td></tr></table></figure>

<h3 id="3-7-3-步骤"><a href="#3-7-3-步骤" class="headerlink" title="3.7.3 步骤"></a>3.7.3 步骤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#NFS服务器创建用户和相应的家目录，将用户wang的家目录共享</span><br>[root@centos8 ~]<span class="hljs-comment">#mkdir -pv /data/home</span><br>[root@centos8 ~]<span class="hljs-comment">#useradd -d /data/home/user1 -u 2000 user1</span><br>[root@centos8 ~]<span class="hljs-comment">#Vim /etc/exports.d/test.exports</span><br>/data/home *(rw)<br>[root@centos8 ~]<span class="hljs-comment">#exportfs -r</span><br><br><span class="hljs-comment">#在第一台NFS客户端主机10.0.0.7上实现相对路径法的autofs</span><br>[root@centos7 ~]<span class="hljs-comment">#useradd -M -u 2000 user1</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/auto.master</span><br>/home  /etc/auto.home<br><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/auto.home</span><br>*  -fstype=nfs,vers=3 10.0.0.8:/data/home/&amp;<br><br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart autofs</span><br>[root@centos7 ~]<span class="hljs-comment">#su - user1</span><br>Last login: Fri Jul  3 16:33:34 CST 2020 on pts/0<br>[user1@centos7 ~]<span class="hljs-variable">$pwd</span><br>/home/user1<br>[user1@centos7 ~]<span class="hljs-variable">$df</span> /home/user1 -T<br>Filesystem        Type 1K-blocks  Used Available Use% Mounted on<br>10.0.0.8:/data/home/user1 nfs4  52403200 398464  52004736  1% /home/user1<br><br><span class="hljs-comment">#注意：home目录下其它用户家目录无法访问</span><br>[root@centos7 ~]<span class="hljs-comment">#ls /home</span><br>user1<br><br><span class="hljs-comment">#在第二台NFS客户端主机10.0.0.6上实现绝对路径法的autofs</span><br>[root@centos6 ~]<span class="hljs-comment">#useradd -M -u 2000 user1</span><br>[root@centos6 ~]<span class="hljs-comment">#vim /etc/auto.master</span><br>/- /etc/auto.home<br>[root@centos6 ~]<span class="hljs-comment">#vim /etc/auto.home</span><br>/home/user1  -fstype=nfs,vers=3 nfsserver:/data/home/user1<br>[root@centos6 ~]<span class="hljs-comment">#service autofs restart</span><br>[root@centos6 ~]<span class="hljs-comment">#su - user1</span><br>[user1@centos6 ~]<span class="hljs-variable">$pwd</span><br>/home/user1<br>[user1@centos6 ~]<span class="hljs-variable">$df</span> -T /home/user1<br>Filesystem      Type 1K-blocks  Used Available Use% Mounted on<br>10.0.0.8:/data/home/user1<br>                nfs  52403200 398464  52004736  1% /home/user1<br>[user1@centos6 ~]<span class="hljs-variable">$ls</span> /home<br>mage user1 wang<br></code></pre></td></tr></table></figure>



<h1 id="四、-SAMBA-服务"><a href="#四、-SAMBA-服务" class="headerlink" title="四、 SAMBA 服务"></a>四、 SAMBA 服务</h1><h2 id="4-1-SAMBA-服务简介"><a href="#4-1-SAMBA-服务简介" class="headerlink" title="4.1 SAMBA 服务简介"></a>4.1 SAMBA 服务简介</h2><p>SMB：Server Message Block 服务器消息块，IBM发布，最早是DOS网络文件共享协议,是私有协议</p>
<p>CIFS：common internet file system，微软基于SMB发布</p>
<p>SAMBA：1991年Andrew Tridgell,实现 windows和UNIX相通</p>
<p>官方网站：<a target="_blank" rel="noopener" href="http://www.samba.org/">http://www.samba.org/</a></p>
<p>SAMBA的功能：</p>
<ul>
<li>共享文件和打印，实现在线编辑</li>
<li>实现登录SAMBA用户的身份认证</li>
<li>可以进行NetBIOS名称解析</li>
<li>外围设备共享</li>
</ul>
<p>Windows计算机网络管理模式：</p>
<ul>
<li>工作组WORKGROUP：计算机对等关系，帐号信息各自管理</li>
<li>域DOMAIN：C/S结构，帐号信息集中管理，DC,AD</li>
</ul>
<h2 id="4-2-SAMBA-软件介绍"><a href="#4-2-SAMBA-软件介绍" class="headerlink" title="4.2 SAMBA 软件介绍"></a>4.2 SAMBA 软件介绍</h2><p>相关包：</p>
<ul>
<li>samba 提供smb服务器端</li>
<li>samba-client 客户端软件</li>
<li>samba-common 通用软件</li>
<li>cifs-utils smb客户端工具</li>
<li>samba-winbind 和AD相关</li>
</ul>
<p>相关服务进程：</p>
<ul>
<li>smbd 提供smb（cifs）服务 TCP:139,445</li>
<li>nmbd NetBIOS名称解析 UDP:137,138</li>
</ul>
<p>主配置文件：/etc/samba/smb.conf 帮助参看：man smb.conf</p>
<p>语法检查： testparm [-v] [/etc/samba/smb.conf]</p>
<p>客户端工具：smbclient，mount.cifs</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">dnf install samba<br>systemctl start smb<br>systemctl start nmb<br></code></pre></td></tr></table></figure>

<h2 id="4-3-SAMBA客户端工具"><a href="#4-3-SAMBA客户端工具" class="headerlink" title="4.3 SAMBA客户端工具"></a>4.3 SAMBA客户端工具</h2><p>UNC路径: Universal Naming Convention,通用命名规范，格式如下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">\\sambaserver\sharename<br></code></pre></td></tr></table></figure>

<h3 id="4-3-1-使用smbclient-访问SAMBA服务器"><a href="#4-3-1-使用smbclient-访问SAMBA服务器" class="headerlink" title="4.3.1 使用smbclient 访问SAMBA服务器"></a>4.3.1 使用smbclient 访问SAMBA服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">smbclient -L instructor.example.com<br>smbclient -L instructor.example.com -U smb用户%password<br><span class="hljs-comment">#可以使用-U选项来指定用户%密码，或通过设置和导出USER和PASSWD环境变量来指定</span><br>smbclient //instructor.example.com/shared -U wang<br>&gt;<span class="hljs-built_in">cd</span> directory    <br>&gt;get file1<br>&gt;put file2<br></code></pre></td></tr></table></figure>

<h3 id="4-3-2-挂载CIFS文件系统"><a href="#4-3-2-挂载CIFS文件系统" class="headerlink" title="4.3.2 挂载CIFS文件系统"></a>4.3.2 挂载CIFS文件系统</h3><p>范例：手动挂载</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">mount -o user=wang,password=magedu //server//shared  /mnt/smb<br></code></pre></td></tr></table></figure>

<p>范例：开机自动挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat /etc/fstab<br><span class="hljs-comment">#可以用文件代替用户名和密码的输入</span><br>//server/homes /mnt cifs credentials或cred=/etc/smb.txt 0 0<br><br>cat /etc/smb.txt<br>username=wang <span class="hljs-comment">#或 user=wang</span><br>password=password <span class="hljs-comment">#或 pass=password</span><br><br>chmod 600 /etc/smb.txt<br><br><span class="hljs-comment">#此方法需要安装cifs-utils包</span><br></code></pre></td></tr></table></figure>

<p>范例: SMB协议版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#man mount.cifs</span><br>vers=arg<br>SMB protocol version. Allowed values are:<br>· 1.0 - The classic CIFS/SMBv1 protocol.<br>· 2.0 - The SMBv2.002 protocol. This was initially introduced <span class="hljs-keyword">in</span> Windows Vista<br>Service Pack  1,<br>and Windows Server  2008. Note that the initial release version of Windows<br>Vista spoke a slightly different dialect (2.000) that is not supported.<br>· 2.0 - The SMBv2.002 protocol. This was initially introduced <span class="hljs-keyword">in</span> Windows Vista<br>Service Pack  1,<br>    and Windows Server  2008. Note that the initial release version of<br>Windows Vista spoke a<br>    slightly different dialect (2.000) that is not supported.<br>· 2.1 - The SMBv2.1 protocol that was introduced <span class="hljs-keyword">in</span> Microsoft Windows  7 and<br>Windows Server  2008R2.<br>· 3.0  - The SMBv3.0 protocol that was introduced <span class="hljs-keyword">in</span> Microsoft Windows 8 and<br>Windows Server   2012.<br>· 3.02 or 3.0.2 - The SMBv3.0.2 protocol that was introduced <span class="hljs-keyword">in</span> Microsoft<br>Windows 8.1 and Windows Server 2012R2.<br>· 3.1.1 or  3.11 - The SMBv3.1.1 protocol that was introduced <span class="hljs-keyword">in</span> Microsoft<br>Windows 10 and Windows Server 2016.<br>· 3 - The SMBv3.0 protocol version and above.<br>· default - Tries to negotiate the highest SMB2+ version supported by both<br>the client and server.<br><br>[root@centos7 ~]<span class="hljs-comment">#man mount.cifs</span><br>vers=<br>SMB protocol version. Allowed values are:<br>·  1.0 - The classic CIFS/SMBv1 protocol. This is the default.<br>·  2.0 - The SMBv2.002 protocol. This was initially introduced <span class="hljs-keyword">in</span> Windows Vista<br>Service Pack 1,<br> and Windows Server 2008. Note that the initial release version of Windows<br>Vista spoke a<br> slightly different dialect (2.000) that is not supported.<br>·  2.1 - The SMBv2.1 protocol that was introduced <span class="hljs-keyword">in</span> Microsoft Windows 7 and<br>Windows Server 2008R2.<br>·  3.0 - The SMBv3.0 protocol that was introduced <span class="hljs-keyword">in</span> Microsoft Windows 8 and<br>Windows Server 2012.<br></code></pre></td></tr></table></figure>

<h2 id="4-4-管理SAMBA用户"><a href="#4-4-管理SAMBA用户" class="headerlink" title="4.4 管理SAMBA用户"></a>4.4 管理SAMBA用户</h2><h3 id="4-4-1-实现samba用户说明"><a href="#4-4-1-实现samba用户说明" class="headerlink" title="4.4.1 实现samba用户说明"></a>4.4.1 实现samba用户说明</h3><ul>
<li>包：samba-common-tools</li>
<li>工具：smbpasswd pdbedit</li>
<li>用户数据库：/var/lib/samba/private/passdb.tdb</li>
<li>说明：samba用户须是Linux用户，建议使用/sbin/nologin</li>
</ul>
<h3 id="4-4-2-管理用户命令"><a href="#4-4-2-管理用户命令" class="headerlink" title="4.4.2 管理用户命令"></a>4.4.2 管理用户命令</h3><p>添加 samba用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">smbpasswd -a &lt;user&gt;<br>pdbedit -a -u &lt;user&gt;<br></code></pre></td></tr></table></figure>

<p>修改用户密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">smbpasswd &lt;user&gt;<br></code></pre></td></tr></table></figure>

<p>删除用户和密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">smbpasswd -x &lt;user&gt;<br>pdbedit  -x -u &lt;user&gt;<br></code></pre></td></tr></table></figure>

<p>查看samba用户列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pdbedit -L -v<br></code></pre></td></tr></table></figure>

<p>范例: 创建samba用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注意不要用-r 设为系统用户,因为不会生成家目录</span><br>[root@centos8 ~]<span class="hljs-comment">#useradd -s /sbin/nologin smb1</span><br>[root@centos8 ~]<span class="hljs-comment">#useradd -s /sbin/nologin smb2</span><br>[root@centos8 ~]<span class="hljs-comment">#useradd -s /sbin/nologin smb3</span><br>[root@centos8 ~]<span class="hljs-comment">#smbpasswd -a smb1</span><br>[root@centos8 ~]<span class="hljs-comment">#smbpasswd -a smb2</span><br>[root@centos8 ~]<span class="hljs-comment">#smbpasswd -a smb3</span><br>[root@centos8 ~]<span class="hljs-comment">#pdbedit -L</span><br>No <span class="hljs-built_in">builtin</span> backend found, trying to load plugin<br>smb1:1002:<br>smb2:1003:<br>smb3:1004:<br>[root@centos8 ~]<span class="hljs-comment">#pdbedit -L -v</span><br>---------------<br>Unix username:    smb3<br>NT username:     <br>Account Flags:    [U     ]<br>User SID:       S-1-5-21-4058051812-2047530699-1442708195-1004<br>Primary Group SID:  S-1-5-21-4058051812-2047530699-1442708195-513<br>Full Name:      <br>Home Directory:    \\centos8\smb3<br>HomeDir Drive:    <br>Logon Script:    <br>Profile Path:     \\centos8\smb3\profile<br>Domain:        CENTOS8<br>Account desc:    <br>Workstations:    <br>Munged dial:     <br>Logon time:      0<br>Logoff time:     Wed, 06 Feb 2036 23:06:39 CST<br>Kickoff time:     Wed, 06 Feb 2036 23:06:39 CST<br>Password last <span class="hljs-built_in">set</span>:  Fri, 03 Jul 2020 18:16:47 CST<br>Password can change: Fri, 03 Jul 2020 18:16:47 CST<br>Password must change: never<br>Last bad password  : 0<br>Bad password count : 0<br>Logon hours     : FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF<br>---------------<br>Unix username:    smb1<br>NT username:     <br>Account Flags:    [U     ]<br>User SID:       S-1-5-21-4058051812-2047530699-1442708195-1003<br>Primary Group SID:  S-1-5-21-4058051812-2047530699-1442708195-513<br>Full Name:      <br>Home Directory:    \\centos8\smb1<br>HomeDir Drive:    <br>Logon Script:    <br>Profile Path:     \\centos8\smb1\profile<br>Domain:        CENTOS8<br>Account desc:    <br>Workstations:    <br>Munged dial:     <br>Logon time:      0<br>Logoff time:     Wed, 06 Feb 2036 23:06:39 CST<br>Kickoff time:     Wed, 06 Feb 2036 23:06:39 CST<br>Password last <span class="hljs-built_in">set</span>:  Fri, 03 Jul 2020 18:16:39 CST<br>Password can change: Fri, 03 Jul 2020 18:16:39 CST<br>Password must change: never<br>Last bad password  : 0<br>Bad password count : 0<br>Logon hours     : FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF<br>---------------<br>Unix username:    smb2<br>NT username:     <br>Account Flags:    [U     ]<br>User SID:       S-1-5-21-4058051812-2047530699-1442708195-1005<br>Primary Group SID:  S-1-5-21-4058051812-2047530699-1442708195-513<br>Full Name:      <br>Home Directory:    \\centos8\smb2<br>HomeDir Drive:    <br>Logon Script:    <br>Profile Path:     \\centos8\smb2\profile<br>Domain:        CENTOS8<br>Account desc:    <br>Workstations:    <br>Munged dial:     <br>Logon time:      0<br>Logoff time:     Wed, 06 Feb 2036 23:06:39 CST<br>Kickoff time:     Wed, 06 Feb 2036 23:06:39 CST<br>Password last <span class="hljs-built_in">set</span>:  Fri, 03 Jul 2020 18:16:59 CST<br>Password can change: Fri, 03 Jul 2020 18:16:59 CST<br>Password must change: never<br>Last bad password  : 0<br>Bad password count : 0<br>Logon hours     : FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF<br></code></pre></td></tr></table></figure>

<p>查看samba服务器状态：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">smbstatus<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#smbstatus</span><br><br>Samba version 4.11.2<br>PID   Username   Group    Machine                 <br>Protocol Version Encryption      Signing       <br>--------------------------------------------------------------------------------<br>--------------------------------------------------------<br>3286  smb1     smb1     10.0.0.7 (ipv4:10.0.0.7:38944)     <br>SMB3_02      -          partial(AES-128-CMAC)<br>Service   pid   Machine    Connected at           Encryption <br>Signing  <br>--------------------------------------------------------------------------------<br>-------------<br>IPC$     3286   10.0.0.7   Fri Jul  3 06:41:50 PM 2020 CST  -     <br>AES-128-CMAC<br>smb1     3286   10.0.0.7   Fri Jul  3 06:41:50 PM 2020 CST  -     <br>AES-128-CMAC<br><br>No locked files<br></code></pre></td></tr></table></figure>

<h2 id="4-5-SAMBA服务器配置"><a href="#4-5-SAMBA服务器配置" class="headerlink" title="4.5 SAMBA服务器配置"></a>4.5 SAMBA服务器配置</h2><p>samba 配置文件 /etc/smb.conf 格式 ，使用.ini文件的格式</p>
<p>帮助：man smb.conf</p>
<p>用 [ ] 分成以下几部分</p>
<ul>
<li>全局设置：</li>
</ul>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[global]</span> 服务器通用或全局设置的部分<br></code></pre></td></tr></table></figure>

<ul>
<li>特定共享设置：</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">homes</span>] 用户的家目录共享<br>[<span class="hljs-meta">printers</span>] 定义打印机资源和服务<br>[<span class="hljs-meta">sharename</span>] 自定义的共享目录配置<br><br>其中：<span class="hljs-meta">#和;开头的语句为注释，大小写不敏感</span><br></code></pre></td></tr></table></figure>

<p><strong>samba配置中的宏定义：</strong></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-tag">%<span class="hljs-selector-tag">m</span></span> 客户端主机的NetBIOS名 <br><span class="hljs-tag">%<span class="hljs-selector-tag">M</span></span> 客户端主机的FQDN<br><span class="hljs-tag">%<span class="hljs-selector-tag">H</span></span> 当前用户家目录路径<br><span class="hljs-tag">%<span class="hljs-selector-tag">U</span></span> 当前用户的用户名<br><span class="hljs-tag">%<span class="hljs-selector-tag">g</span></span> 当前用户所属组<br><span class="hljs-tag">%<span class="hljs-selector-tag">h</span></span> samba服务器的主机名<br><span class="hljs-tag">%<span class="hljs-selector-tag">L</span></span> samba服务器的NetBIOS名<br><span class="hljs-tag">%<span class="hljs-selector-tag">I</span></span> 客户端主机的IP，是i的大写字母<br><span class="hljs-tag">%<span class="hljs-selector-tag">T</span></span> 当前日期和时间 <br><span class="hljs-tag">%<span class="hljs-selector-tag">S</span></span> 可登录的用户名<br></code></pre></td></tr></table></figure>

<h3 id="4-5-1-SAMBA服务器全局配置"><a href="#4-5-1-SAMBA服务器全局配置" class="headerlink" title="4.5.1 SAMBA服务器全局配置"></a>4.5.1 SAMBA服务器全局配置</h3><ul>
<li>workgroup 指定工作组名称</li>
<li>server string 主机注释信息</li>
<li>netbios name 指定NetBIOS名，可以被SAMBA客户端使用,但不支持ping</li>
</ul>
<p>注意：netbios name需要启动nmb服务</p>
<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[global]<br>workgroup = workgroup<br>netbios name = smbserver  <span class="hljs-comment">#此设置需要启动nmb服务才可能生效</span><br></code></pre></td></tr></table></figure>

<ul>
<li>interfaces 指定服务侦听接口和IP</li>
<li>hosts allow 可用逗号，空格，或tab分隔，默认允许所有主机访问，也可在每个共享独立配置，如在[global]设置，将应用并覆盖所有共享设置，可以是以下格式：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">IPv4 network/prefix: 172.16.0.0/24 IPv4 前缀: 172.16.0.<br>IPv4 network/netmask: 172.16.0.0/255.255.255.0<br>主机名: desktop.example.com<br>以example.com后缀的主机名: .example.com<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">hosts allow = 172.16.  .example.com<br></code></pre></td></tr></table></figure>

<ul>
<li>hosts deny 拒绝指定主机访问，格式和hosts allow 相同</li>
<li>config file=/etc/samba/conf.d/%U 用户独立的配置文件</li>
<li>Log file=/var/log/samba/log.%I 不同客户机采用不同日志</li>
<li>log level = 2 日志级别，默认为0，不记录日志</li>
</ul>
<p>范例：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stata">[<span class="hljs-keyword">global</span>]                                  <br>  <br><span class="hljs-keyword">Log</span> <span class="hljs-keyword">file</span>=/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/samba/<span class="hljs-keyword">log</span>.%I<br><span class="hljs-keyword">log</span> level = 2<br></code></pre></td></tr></table></figure>

<ul>
<li>max log size=50 日志文件达到50K，将轮循rotate,单位KB</li>
<li>Security三种认证方式：<br>user：samba用户（采有linux用户，samba的独立口令）<br>share：匿名(CentOS7不再支持)，已不建议使用<br>server：已不建议使用</li>
<li>passdb backend = tdbsam 密码数据库格式</li>
</ul>
<h3 id="4-5-2-配置特定目录共享"><a href="#4-5-2-配置特定目录共享" class="headerlink" title="4.5.2 配置特定目录共享"></a>4.5.2 配置特定目录共享</h3><p>每个共享目录应该有独立的[ ]部分</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[共享名称]  <span class="hljs-comment">#远程网络看到的共享名称</span><br>comment <span class="hljs-comment">#注释信息</span><br>path <span class="hljs-comment">#所共享的目录路径</span><br>public <span class="hljs-comment">#能否被guest访问的共享，默认no，和guest=ok 类似</span><br>browsable <span class="hljs-comment">#是否允许所有用户浏览此共享,默认为yes,no为隐藏</span><br>writable=yes <span class="hljs-comment">#可以被所有用户读写，默认为no</span><br><span class="hljs-built_in">read</span> only=no <span class="hljs-comment">#和writable=yes等价，如与以上设置冲突，放在后面的设置生效，默认只读</span><br>write list  <span class="hljs-comment">#用户，@组名，+组名 之间用逗号分隔，如：writable=no，列表中用户或组可读写，不在列表中用户只读</span><br>valid users <span class="hljs-comment">#特定用户才能访问该共享，如为空，将允许所有用户，用户名之间用空格分隔</span><br></code></pre></td></tr></table></figure>

<p>范例：基于特定用户和组的共享</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/samba/smb.conf<br>[share]<br>path = /data/dir<br>valid users=wang,@admins<br>writeable = no<br>browseable = no<br></code></pre></td></tr></table></figure>

<h2 id="4-6-实战案例"><a href="#4-6-实战案例" class="headerlink" title="4.6 实战案例"></a>4.6 实战案例</h2><h3 id="4-6-1-实战案例：利用SAMBA实现指定目录共享"><a href="#4-6-1-实战案例：利用SAMBA实现指定目录共享" class="headerlink" title="4.6.1 实战案例：利用SAMBA实现指定目录共享"></a>4.6.1 实战案例：利用SAMBA实现指定目录共享</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在samba服务器上安装samba包</span><br>yum -y install samba<br><span class="hljs-comment">#创建samba用户和组</span><br>groupadd -r admins<br>useradd -s /sbin/nologin -G admins wang<br>smbpasswd -a wang<br>useradd -s /sbin/nologin mage<br>smbpasswd -a mage<br><br><span class="hljs-comment">#创建samba共享目录,并设置SElinux</span><br>mkdir /testdir/smbshare<br>chgrp admins /testdir/smbshare<br>chmod 2775 /testdir/smbshare<br><br><span class="hljs-comment">#samba服务器配置</span><br>vim /etc/samba/smb.conf<br>...省略...<br>[share]<br>path = /testdir/smbshare<br>write list = @admins<br><br>systemctl <span class="hljs-built_in">enable</span> --now smb nmb<br><br><span class="hljs-comment">#samba客户端访问</span><br>yum -y install cifs-utils<br><br><span class="hljs-comment">#用wang用户挂载smb共享并访问</span><br>mkdir /mnt/wang<br>mount -o username=wang //smbserver/share /mnt/wang<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Hello wang&quot;</span> &gt;/mnt/wang/wangfile.txt<br><br><span class="hljs-comment">#用mage用户挂载smb共享并访问</span><br>mkdir /mnt/mage<br>mount -o username=mage //smbserver/share /mnt/mage<br>touch /mnt/mage/magefile.txt<br></code></pre></td></tr></table></figure>

<h3 id="4-6-2-实战案例2：实现不同samba用户访问相同的samba共享，实现不同的配置"><a href="#4-6-2-实战案例2：实现不同samba用户访问相同的samba共享，实现不同的配置" class="headerlink" title="4.6.2 实战案例2：实现不同samba用户访问相同的samba共享，实现不同的配置"></a>4.6.2 实战案例2：实现不同samba用户访问相同的samba共享，实现不同的配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建三个samba用户,并指定密码为magedu</span><br>useradd -s /sbin/nologin smb1<br>useradd -s /sbin/nologin smb2<br>useradd -s /sbin/nologin smb3<br>smbpasswd -a smb1<br>smbpasswd -a smb2<br>smbpasswd -a smb3<br><br><span class="hljs-comment">#修改samba配置文件</span><br>Vim /etc/samba/smb.conf<br><span class="hljs-comment">#在workgroup下加一行</span><br>config file= /etc/samba/conf.d/%U  <span class="hljs-comment">#说明：%U表示用户名</span><br>[share]<br>Path=/data/dir<br>Read only= NO<br>Guest ok = yes<br>write list=@wheel<br><br><span class="hljs-comment">#针对smb1和smb2用户创建单独的配置文件</span><br>vim /etc/samba/conf.d/smb1<br>[share]<br>Path=/data/dir1<br>Read only= NO 等价于writable = yes<br>Create mask=0644  <br><span class="hljs-comment">#说明：默认为744</span><br><br>Vim /etc/samba/conf.d/smb2<br>[share]<br>path=/data/dir2<br><br>systemctl restart smb nmb<br><br><span class="hljs-comment">#用户smb1，smb2,smb3访问share共享目录，看到目录是不同目录</span><br>smbclient //sambaserver/share -U smb1%magedu<br>smbclient //sambaserver/share -U smb2%magedu<br>smbclient //sambaserver/share -U smb3%magedu<br></code></pre></td></tr></table></figure>



<h1 id="五、数据的实时同步"><a href="#五、数据的实时同步" class="headerlink" title="五、数据的实时同步"></a>五、数据的实时同步</h1><p>在生产环境，有时会需要两台主机的特定目录实现实时同步。比如，将NFS共享目录的数据文件，自动实时同步到备份服务器特定目录中</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile18.png" srcset="/blog/img/loading.gif"></p>
<h2 id="5-1-实时同步技术介绍"><a href="#5-1-实时同步技术介绍" class="headerlink" title="5.1 实时同步技术介绍"></a>5.1 实时同步技术介绍</h2><p>实现实时同步的方法</p>
<ul>
<li>inotify + rsync 方式实现数据同步</li>
<li>sersync ：前金山公司周洋（花椒直播）在 inotify 软件基础上进行开发的，功能更加强大</li>
</ul>
<p><strong>工作原理：</strong></p>
<ul>
<li>要利用监控服务（inotify），监控同步数据服务器目录中信息的变化</li>
<li>发现目录中数据产生变化，就利用rsync服务推送到备份服务器上</li>
</ul>
<p><strong>inotify：</strong></p>
<p>异步的文件系统事件监控机制，利用事件驱动机制，而无须通过诸如cron等的轮询机制来获取事件，linux内核从2.6.13起支持 inotify，通过inotify可以监控文件系统中添加、删除，修改、移动等各种事件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@data-centos8 ~]<span class="hljs-comment">#grep -i inotify /boot/config-4.18.0-80.el8.x86_64</span><br>CONFIG_INOTIFY_USER=y<br></code></pre></td></tr></table></figure>

<p><strong>实现inotify软件：</strong></p>
<ul>
<li>inotify-tools</li>
<li>sersync</li>
<li>lrsyncd</li>
</ul>
<p><strong>inotify+rsync使用方式</strong></p>
<ul>
<li>inotify 对同步数据目录信息的监控</li>
<li>rsync 完成对数据的同步</li>
<li>利用脚本进行结合</li>
</ul>
<h2 id="5-2-实现-inotify"><a href="#5-2-实现-inotify" class="headerlink" title="5.2 实现 inotify"></a>5.2 实现 inotify</h2><h3 id="5-2-1-内核支持"><a href="#5-2-1-内核支持" class="headerlink" title="5.2.1 内核支持"></a>5.2.1 内核支持</h3><p><strong>内核是否支持inotify</strong></p>
<p>Linux支持inotify的内核最小版本为 2.6.13，参看man 7 inotify</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#列出下面的文件，说明服务器内核支持inotify</span><br>[root@centos8 ~]<span class="hljs-comment">#ls -l /proc/sys/fs/inotify </span><br>-rw-r--r-- 1 root root 0 Dec  7 10:10 max_queued_events<br>-rw-r--r-- 1 root root 0 Dec  7 10:10 max_user_instances<br>-rw-r--r-- 1 root root 0 Dec  6 05:54 max_user_watches<br><br>[root@centos8 ~]<span class="hljs-comment">#cat /proc/sys/fs/inotify/max_queued_events</span><br>16384<br>[root@centos8 ~]<span class="hljs-comment">#cat /proc/sys/fs/inotify/max_user_instances</span><br>128<br>[root@centos8 ~]<span class="hljs-comment">#cat /proc/sys/fs/inotify/max_user_watches</span><br>8192<br></code></pre></td></tr></table></figure>

<p><strong>inotify内核参数说明：</strong></p>
<ul>
<li>max_queued_events：inotify 事件队列最大长度，如值太小会出现 Event Queue Overflow 错误，默认值：16384, 生产环境建议调大,比如:327679</li>
<li>max_user_instances：每个用户创建inotify实例最大值，默认值：128</li>
<li>max_user_watches：可以监视的文件的总数量（inotifywait 单进程），默认值：8192,建议调大</li>
</ul>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@data-centos8 ~]<span class="hljs-comment">#vim /etc/sysctl.conf</span><br>fs.inotify.max_queued_events=66666<br>fs.inotify.max_user_watches=100000  <br>[root@centos8 ~]<span class="hljs-comment">#sysctl -p</span><br>fs.inotify.max_queued_events = 66666<br>fs.inotify.max_user_watches = 100000<br>[root@centos8 ~]<span class="hljs-comment">#cat /proc/sys/fs/inotify/*</span><br>66666<br>128<br>100000<br></code></pre></td></tr></table></figure>

<h3 id="5-2-2-inotify-tools工具"><a href="#5-2-2-inotify-tools工具" class="headerlink" title="5.2.2 inotify-tools工具"></a>5.2.2 inotify-tools工具</h3><p>inotify-tools参考文档：<a target="_blank" rel="noopener" href="https://github.com/rvoicilas/inotify-tools/wiki">https://github.com/rvoicilas/inotify-tools/wiki</a></p>
<p>安装inotify-tools：基于epel源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@data-centos8 ~]<span class="hljs-comment"># yum -y install inotify-tools</span><br></code></pre></td></tr></table></figure>

<p><strong>inotify-tools包主要工具：</strong></p>
<ul>
<li>inotifywait： 在被监控的文件或目录上等待特定文件系统事件（open ，close，delete等）发生，常用于实时同步的目录监控</li>
<li>inotifywatch：收集被监控的文件系统使用的统计数据，指文件系统事件发生的次数统计</li>
</ul>
<p><strong>inotifywait 命令</strong><br>格式:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">inotifywait [ options ] file1 [ file2 ] [ file3 ] [ ... ]<br></code></pre></td></tr></table></figure>

<p>常用选项:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">-m, --monitor           始终保持事件监听<br>-d, --daemon            以守护进程方式执行，和-m相似，配合-o使用<br>-r, --recursive         递归监控目录数据信息变化<br>-q, --quiet             输出少量事件信息<br>--exclude &lt;pattern&gt;     指定排除文件或目录，使用扩展的正则表达式匹配的模式实现<br>--excludei &lt;pattern&gt;    和exclude相似，不区分大小写<br>-o, --outfile &lt;file&gt;    打印事件到文件中，相当于标准正确输出，注意：使用绝对路径<br>-s, --syslogOutput      发送错误到syslog相当于标准错误输出<br>--timefmt &lt;fmt&gt;         指定时间输出格式<br>--format &lt;fmt&gt;          指定的输出格式；即实际监控输出内容<br>-e                      指定监听指定的事件，如果省略，表示所有事件都进行监听<br></code></pre></td></tr></table></figure>

<p><strong>inotifywait 的–timefmt 时间格式</strong><br>参考 man 3 strftime</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">%Y    <span class="hljs-comment">#年份信息，包含世纪信息</span><br>%y    <span class="hljs-comment">#年份信息，不包括世纪信息</span><br>%m    <span class="hljs-comment">#显示月份，范围 01-12</span><br>%d    <span class="hljs-comment">#每月的第几天，范围是 01-31</span><br>%H    <span class="hljs-comment">#小时信息，使用 24小时制，范围 00-23</span><br>%M    <span class="hljs-comment">#分钟，范围 00-59</span><br>%S    <span class="hljs-comment">#秒，范例 0-60</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">--timefmt &quot;%Y-%m-%d %H:%M:%S&quot;<br></code></pre></td></tr></table></figure>

<p><strong>inotifywait 的 –format 格式定义</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">%T  <span class="hljs-comment">#输出时间格式中定义的时间格式信息，通过 --timefmt option 语法格式指定时间信息</span><br>%w  <span class="hljs-comment">#事件出现时，监控文件或目录的名称信息，相当于dirname</span><br>%f  <span class="hljs-comment">#事件出现时，将显示监控目录下触发事件的文件或目录信息，否则为空，相当于basename</span><br>%e  <span class="hljs-comment">#显示发生的事件信息，不同的事件默认用逗号分隔</span><br>%Xe <span class="hljs-comment">#显示发生的事件信息，不同的事件指定用X进行分隔</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">--format &quot;%T %w%f event: %;e&quot;<br>--format &#x27;%T %w %f&#x27;<br></code></pre></td></tr></table></figure>

<p><strong>inotifywait -e 选项指定的事件类型</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">create               <span class="hljs-comment">#文件或目录创建</span><br>delete               <span class="hljs-comment">#文件或目录被删除</span><br>modify               <span class="hljs-comment">#文件或目录内容被写入</span><br>attrib               <span class="hljs-comment">#文件或目录属性改变</span><br>close_write          <span class="hljs-comment">#文件或目录关闭，在写入模式打开之后关闭的</span><br>close_nowrite        <span class="hljs-comment">#文件或目录关闭，在只读模式打开之后关闭的</span><br>close                <span class="hljs-comment">#文件或目录关闭，不管读或是写模式</span><br>open                 <span class="hljs-comment">#文件或目录被打开</span><br>lsdir                <span class="hljs-comment">#浏览目录内容</span><br>moved_to             <span class="hljs-comment">#文件或目录被移动到监控的目录中</span><br>moved_from           <span class="hljs-comment">#文件或目录从监控的目录中被移动</span><br>move                 <span class="hljs-comment">#文件或目录不管移动到或是移出监控目录都触发事件</span><br>access               <span class="hljs-comment">#文件或目录内容被读取</span><br>delete_self          <span class="hljs-comment">#文件或目录被删除，目录本身被删除</span><br>unmount              <span class="hljs-comment">#取消挂载</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">-e create,delete,moved_to,close_write,attrib<br></code></pre></td></tr></table></figure>

<p>范例：使用inotifywait</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#监控一次性事件</span><br>inotifywait /data/www<br>Setting up watches.<br>Watches established.<br>/data/www/ CREATE f1.txt<br><br><span class="hljs-comment">#持续前台监控</span><br>inotifywait -mrq /data/www  --exclude=<span class="hljs-string">&quot;.*\.swx|\.swp&quot;</span><br>/data/www/ OPEN f1.txt<br>/data/www/ ACCESS f1.txt<br>/data/www/ CLOSE_NOWRITE,CLOSE f1.txt<br><br><span class="hljs-comment">#持续后台监控，并记录日志</span><br>inotifywait -o /root/inotify.log -drq /data/www --timefmt <span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span> --format <span class="hljs-string">&quot;%T %w%f event: %e&quot;</span><br><br><span class="hljs-comment">#持续前台监控特定事件</span><br>inotifywait -mrq /data/www --timefmt <span class="hljs-string">&quot;%F %H:%M:%S&quot;</span> --format <span class="hljs-string">&quot;%T %w%f event:%;e&quot;</span> -e create,delete,moved_to,close_write,attrib<br></code></pre></td></tr></table></figure>

<h2 id="5-3-rsync"><a href="#5-3-rsync" class="headerlink" title="5.3 rsync"></a>5.3 rsync</h2><p>rsync 常用于做为 linux系统下的数据镜像备份工具，实现远程同步，支持本地复制，或者与其他SSH、rsync主机同步数据，支持增量备份，配合任务计划，rsync能实现定时或间隔同步，配合inotify或sersync，可以实现触发式的实时数据同步</p>
<p>官方网站: <a target="_blank" rel="noopener" href="http://rsync.samba.org/">http://rsync.samba.org/</a></p>
<p>软件包：rsync，rsync-daemon（CentOS 8）</p>
<p>服务文件：/usr/lib/systemd/system/rsyncd.service</p>
<p>配置文件：/etc/rsyncd.conf</p>
<p>端口：873/tcp</p>
<h3 id="5-3-1-rsync命令"><a href="#5-3-1-rsync命令" class="headerlink" title="5.3.1 rsync命令"></a>5.3.1 rsync命令</h3><p><strong>rsync 格式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#Local: </span><br>rsync [OPTION...] SRC... [DEST]<br><br><span class="hljs-comment">#Access via remote shell:</span><br>Pull:<br>rsync [OPTION...] [USER@]HOST:SRC... [DEST]<br>Push:<br>rsync [OPTION...] SRC... [USER@]HOST:DEST<br><br><span class="hljs-comment">#Access via rsync daemon:</span><br>Pull:<br>rsync [OPTION...] [USER@]HOST::SRC... [DEST]<br>rsync [OPTION...] rsync://[USER@]HOST[:PORT]/SRC... [DEST]<br><br>Push:<br>rsync [OPTION...] SRC... [USER@]HOST::DEST<br>rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST<br><br>The <span class="hljs-string">&#x27;:&#x27;</span> usages connect via remote shell, <span class="hljs-keyword">while</span> <span class="hljs-string">&#x27;::&#x27;</span> &amp; <span class="hljs-string">&#x27;rsync://&#x27;</span> usages connect<br>to an rsync daemon, and require SRC or DEST to start with a module name.<br></code></pre></td></tr></table></figure>

<p>rsync有三种工作方式：</p>
<ol>
<li>本地文件系统上实现同步。命令行语法格式为上述”Local”段的格式。</li>
<li>本地主机使用远程shell和远程主机通信。命令行语法格式为上述”Access via remote shell”段的格式。</li>
<li>本地主机通过网络套接字连接远程主机上的rsync daemon。命令行语法格式为上述”Access viarsync daemon”段的格式。</li>
</ol>
<p>前两者的本质是通过本地或远程shell，而第3种方式则是让远程主机上运行rsyncd服务，使其监听在一个端口上，等待客户端的连接。</p>
<p>常见选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">-v：显示rsync过程中详细信息。可以使用<span class="hljs-string">&quot;-vvvv&quot;</span>获取更详细信息。<br>-P：显示文件传输的进度信息。(实际上<span class="hljs-string">&quot;-P&quot;</span>=<span class="hljs-string">&quot;--partial --progress&quot;</span>，其中的<span class="hljs-string">&quot;--progress&quot;</span>才是显示进度信息的)。<br>-n --dry-run ：仅测试传输，而不实际传输。常和<span class="hljs-string">&quot;-vvvv&quot;</span>配合使用来查看rsync是如何工作的。<br>-a --archive ：归档模式，表示递归传输并保持文件属性。等同于<span class="hljs-string">&quot;-rtopgDl&quot;</span>。<br>-r --recursive：递归到目录中去。<br>-t --<span class="hljs-built_in">times</span>：保持mtime属性。强烈建议任何时候都加上<span class="hljs-string">&quot;-t&quot;</span>，否则目标文件mtime会设置为系统时间，导致下次更新<br>    ：检查出mtime不同从而导致增量传输无效。<br>-o --owner：保持owner属性(属主)。<br>-g --group：保持group属性(属组)。<br>-p --perms：保持perms属性(权限，不包括特殊权限)。<br>-D    ：是<span class="hljs-string">&quot;--device --specials&quot;</span>选项的组合，即也拷贝设备文件和特殊文件。<br>-l --links：如果文件是软链接文件，则拷贝软链接本身而非软链接所指向的对象<br>-z    ：传输时进行压缩提高效率<br>-R --relative：使用相对路径。意味着将命令行中指定的全路径而非路径最尾部的文件名发送给服务端，包括它们的属性。用法见下文示例。<br>--size-only ：默认算法是检查文件大小和mtime不同的文件，使用此选项将只检查文件大小。<br>-u --update ：仅在源mtime比目标已存在文件的mtime新时才拷贝。注意，该选项是接收端判断的，不会影响删除行为。<br>-d --<span class="hljs-built_in">dirs</span>  ：以不递归的方式拷贝目录本身。默认递归时，如果源为<span class="hljs-string">&quot;dir1/file1&quot;</span>，则不会拷贝dir1目录，使用该选项将拷贝dir1但不拷贝file1。<br>--max-size ：限制rsync传输的最大文件大小。可以使用单位后缀，还可以是一个小数值(例如：<span class="hljs-string">&quot;--</span><br><span class="hljs-string">max-size=1.5m&quot;</span>)<br>--min-size ：限制rsync传输的最小文件大小。这可以用于禁止传输小文件或那些垃圾文件。<br>--exclude  ：指定排除规则来排除不需要传输的文件。<br>--delete  ：以SRC为主，对DEST进行同步。多则删之，少则补之。注意<span class="hljs-string">&quot;--delete&quot;</span>是在接收端执行的，所以它是在<br>     ：exclude/include规则生效之后才执行的。<br>-b --backup ：对目标上已存在的文件做一个备份，备份的文件名后默认使用<span class="hljs-string">&quot;~&quot;</span>做后缀。<br>--backup-dir：指定备份文件的保存路径。不指定时默认和待备份文件保存在同一目录下。<br>-e     ：指定所要使用的远程shell程序，默认为ssh。<br>--port   ：连接daemon时使用的端口号，默认为873端口。<br>--password-file：daemon模式时的密码文件，可以从中读取密码实现非交互式。注意，这不是远程shell认证的密码，而是rsync模块认证的密码。<br>-W --whole-file：rsync将不再使用增量传输，而是全量传输。在网络带宽高于磁盘带宽时，该选项比增量传输更高效。<br>--existing ：要求只更新目标端已存在的文件，目标端还不存在的文件不传输。注意，使用相对路径时如果上层目录不存在也不会传输。<br>--ignore-existing：要求只更新目标端不存在的文件。和<span class="hljs-string">&quot;--existing&quot;</span>结合使用有特殊功能，见下文示例。<br>--remove-source-files：要求删除源端已经成功传输的文件<br></code></pre></td></tr></table></figure>

<p>范例：两种格式访问 rsync daemon 服务</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile19.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在备份服务器启动 rsync 进程</span><br>[root@backup-centos8 ~]<span class="hljs-comment">#rsync --daemon</span><br>Failed to parse config file: /etc/rsyncd.conf<br>[root@backup-centos8 ~]<span class="hljs-comment">#touch /etc/rsyncd.conf</span><br>[root@backup-centos8 ~]<span class="hljs-comment">#rsync --daemon</span><br>[root@backup-centos8 ~]<span class="hljs-comment">#ss -ntlp|grep rsync</span><br>LISTEN  0     5          0.0.0.0:873        0.0.0.0:*   <br>users:((<span class="hljs-string">&quot;rsync&quot;</span>,pid=2921,fd=4)) <br>LISTEN  0     5           [::]:873         [::]:*   <br>users:((<span class="hljs-string">&quot;rsync&quot;</span>,pid=2921,fd=5)) <br>[root@backup-centos8 ~]<span class="hljs-comment">#</span><br><br>[root@backup-centos8 ~]<span class="hljs-comment">#cat /etc/rsyncd.conf</span><br>[backup]<br>path = /data/backup/<br><span class="hljs-built_in">read</span> only = no  <span class="hljs-comment">#指定可读写,默认只读</span><br><br><span class="hljs-comment">#指定目录给nobody权限，默认用户以nobody访问此目录</span><br>[root@backup-centos8 ~]<span class="hljs-comment">#setfacl -m u:nobody:rwx /data/backup/</span><br><br><span class="hljs-comment">#查看rsync服务器的模块名称</span><br>[root@data-centos8 ~]<span class="hljs-comment">#rsync rsync://backup-server</span><br>backup<br>[root@data-centos8 ~]<span class="hljs-comment">#rsync backup-server::</span><br>backup<br><br><span class="hljs-comment">#访问rsync服务器的共享目录</span><br><span class="hljs-comment">#推</span><br>[root@data-centos8 ~]<span class="hljs-comment">#rsync /etc/networks  root@backup-server::backup</span><br>[root@data-centos8 ~]<span class="hljs-comment">#rsync /etc/issue   wang@backup-server::backup</span><br>[root@data-centos8 ~]<span class="hljs-comment">#rsync /etc/passwd  backup-server::backup</span><br>[root@data-centos8 ~]<span class="hljs-comment">#rsync /etc/shells  rsync://root@backup-server/backup</span><br><br><span class="hljs-comment">#拉</span><br>[root@data-server ~]<span class="hljs-comment">#rsync backup-server::backup/* /opt</span><br>[root@data-server ~]<span class="hljs-comment">#rsync  rsync://backup-server/backup/* /mnt</span><br></code></pre></td></tr></table></figure>

<h3 id="5-3-2-以独立服务方式运行rsync并实现验证功能"><a href="#5-3-2-以独立服务方式运行rsync并实现验证功能" class="headerlink" title="5.3.2 以独立服务方式运行rsync并实现验证功能"></a>5.3.2 以独立服务方式运行rsync并实现验证功能</h3><p>范例：以独立服务方式运行 rsync</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@backup-centos8 ~]<span class="hljs-comment">#dnf install rsync-daemon</span><br><span class="hljs-comment">#创建rsync服务器的配置文件</span><br>[root@centos8 ~]<span class="hljs-comment">#vi /etc/rsyncd.conf</span><br>uid = root  <span class="hljs-comment">#提定以哪个用户来访问共享目录，将之指定为生成的文件所有者，默认为nobody</span><br>gid = root  <span class="hljs-comment">#默认为nobody</span><br><span class="hljs-comment">#port = 874 可指定非标准端口,默认873/tcp</span><br><span class="hljs-comment">#use chroot = no</span><br>max connections = 0<br>ignore errors<br>exclude = lost+found/<br><span class="hljs-built_in">log</span> file = /var/<span class="hljs-built_in">log</span>/rsyncd.log<br>pid file = /var/run/rsyncd.pid<br>lock file = /var/run/rsyncd.lock<br>reverse lookup = no<br><span class="hljs-comment">#hosts allow = 10.0.0.0/24</span><br>[backup]  <span class="hljs-comment">#每个模块名对应一个不同的path目录，如果同名后面模块生效</span><br>path = /data/backup/ <br>comment = backup dir<br><span class="hljs-built_in">read</span> only = no   <span class="hljs-comment">#默认是yes,即只读</span><br>auth users = rsyncuser  <span class="hljs-comment">#默认anonymous可以访问rsync服务器</span><br>secrets file = /etc/rsync.pas<br><br><span class="hljs-comment">#服务器端准备目录</span><br>[root@backup-centos8 ~]<span class="hljs-comment">#mkdir -pv /data/backup</span><br><br><span class="hljs-comment">#服务器端准备目录</span><br>[root@backup-centos8 ~]<span class="hljs-comment">#mkdir -pv /data/backup</span><br><br><span class="hljs-comment">#服务器端启动rsync服务</span><br>[root@backup-centos8 ~]<span class="hljs-comment">#rsync --daemon #可加入/etc/rc.d/rc.local实现开机启动</span><br>[root@backup-centos8 ~]<span class="hljs-comment">#systemctl start rsyncd  #CentOS 7 以上版本</span><br><br><span class="hljs-comment">#客户端配置密码文件</span><br><span class="hljs-comment">#也可将密码赋值给环境变量RSYNC_PASSWORD变量,但不安全</span><br><span class="hljs-comment">#export RSYNC_PASSWORD=magedu</span><br>[root@data-centos8 ~]<span class="hljs-comment">#echo &quot;magedu&quot; &gt; /etc/rsync.pas</span><br>[root@data-centos8 ~]<span class="hljs-comment">#chmod 600 /etc/rsync.pas  #此为必要项,权限必须修改</span><br><br><span class="hljs-comment">#查看远程rsync服务器的模块信息</span><br>[root@data-server ~]<span class="hljs-comment">#rsync  rsync://rsync服务器IP</span><br>backup     backup dir<br><br><span class="hljs-comment">#查看具体模块内的文件需要验证</span><br>[root@data-server ~]<span class="hljs-comment">#rsync  rsync:/rsync服务器IP/backup</span><br>Password:<br><br><span class="hljs-comment">#客户端测试同步数据</span><br>[root@data-centos8 ~]<span class="hljs-comment">#rsync -avz --delete --password-file=/etc/rsync.pas /data/www/ rsyncuser@rsync服务器IP::backup</span><br><br>[root@data-centos8 ~]<span class="hljs-comment">#rsync -avz --delete  --password-file=/etc/rsync.pas rsyncuser@rsync服务器IP::backup  /data/www/</span><br></code></pre></td></tr></table></figure>

<h2 id="5-4-inotify-rsync-shell-脚本实现实时数据同步"><a href="#5-4-inotify-rsync-shell-脚本实现实时数据同步" class="headerlink" title="5.4 inotify+rsync+shell 脚本实现实时数据同步"></a>5.4 inotify+rsync+shell 脚本实现实时数据同步</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile20.png" srcset="/blog/img/loading.gif"></p>
<p>按 5.3 搭建好 rsyncd的备份服务器，在数据服务器上创建inotify_rsync.sh脚本</p>
<p><strong>注意: 此脚本执行前先确保两主机初始数据处于同步状态,此脚本实现后续的数据同步</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@data-centos8 ~]<span class="hljs-comment">#vim inotify_rsync.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>SRC=<span class="hljs-string">&#x27;/data/www/&#x27;</span>   <span class="hljs-comment">#注意最后的/</span><br>DEST=<span class="hljs-string">&#x27;rsyncuser@rsync服务器IP::backup&#x27;</span><br>rpm -q rsync &amp;&gt; /dev/null || yum -y install rsync<br>inotifywait  -mrq  --exclude=<span class="hljs-string">&quot;.*\.swp&quot;</span> --timefmt <span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span> --format<br><span class="hljs-string">&#x27;%T %w %f&#x27;</span> -e create,delete,moved_to,close_write,attrib <span class="hljs-variable">$&#123;SRC&#125;</span> |<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> DATE<br>TIME DIR FILE;<span class="hljs-keyword">do</span><br>    FILEPATH=<span class="hljs-variable">$&#123;DIR&#125;</span><span class="hljs-variable">$&#123;FILE&#125;</span><br>   rsync -az --delete  --password-file=/etc/rsync.pas <span class="hljs-variable">$SRC</span> <span class="hljs-variable">$DEST</span> &amp;&amp; <span class="hljs-built_in">echo</span><br><span class="hljs-string">&quot;At <span class="hljs-variable">$&#123;TIME&#125;</span> on <span class="hljs-variable">$&#123;DATE&#125;</span>, file <span class="hljs-variable">$FILEPATH</span> was backuped up via rsync&quot;</span> &gt;&gt;<br>/var/<span class="hljs-built_in">log</span>/changelist.log<br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment">#查看文件传输日志</span><br>[root@data-centos8 ~]<span class="hljs-comment">#tail -f /var/log/changelist.log</span><br></code></pre></td></tr></table></figure>

<h2 id="5-5-sersync-实现实时数据同步"><a href="#5-5-sersync-实现实时数据同步" class="headerlink" title="5.5 sersync 实现实时数据同步"></a>5.5 sersync 实现实时数据同步</h2><h3 id="5-5-1-sersync-介绍"><a href="#5-5-1-sersync-介绍" class="headerlink" title="5.5.1 sersync 介绍"></a>5.5.1 sersync 介绍</h3><p>sersync类似于inotify，同样用于监控，但它克服了inotify的缺点.<br>inotify最大的不足是会产生重复事件，或者同一个目录下多个文件的操作会产生多个事件，例如，当监控目录中有5个文件时，删除目录时会产生6个监控事件，从而导致重复调用rsync命令。另外比如：vim文件时，inotify会监控到临时文件的事件，但这些事件相对于rsync来说是不应该被监控的<br><strong>sersync 优点：</strong></p>
<ul>
<li>sersync是使用c++编写，而且对linux系统文件系统产生的临时文件和重复的文件操作进行过滤，所以在结合rsync同步的时候，节省了运行时耗和网络资源。因此更快。</li>
<li>sersync配置很简单，其中提供了静态编译好的二进制文件和xml配置文件，直接使用即可</li>
<li>sersync使用多线程进行同步，尤其在同步较大文件时，能够保证多个服务器实时保持同步状态</li>
<li>sersync有出错处理机制，通过失败队列对出错的文件重新同步，如果仍旧失败，则按设定时长对同步失败的文件重新同步</li>
<li>sersync不仅可以实现实时同步，另外还自带crontab功能，只需在xml配置文件中开启，即也可以按要求隔一段时间整体同步一次，而无需再额外配置crontab功能</li>
<li>sersync 可以二次开发</li>
</ul>
<p>sersync项目地址： <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/sersync/">https://code.google.com/archive/p/sersync/</a></p>
<p>sersync下载地址： <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/sersync/downloads">https://code.google.com/archive/p/sersync/downloads</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile21.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-5-2-基于rsync-daemon-实现-sersync"><a href="#5-5-2-基于rsync-daemon-实现-sersync" class="headerlink" title="5.5.2 基于rsync daemon 实现 sersync"></a>5.5.2 基于rsync daemon 实现 sersync</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在数据服务器上下载sersync，并拷贝至相应的目录，设置PATH变量</span><br>[root@data-centos8 ~]<span class="hljs-comment">#wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/sersync/sersync2.5.4_64bit_binary_stable_final.tar.gz</span><br>[root@data-centos8 ~]<span class="hljs-comment">#tar xf sersync2.5.4_64bit_binary_stable_final.tar.gz</span><br>[root@data-centos8 ~]<span class="hljs-comment">#cp -a GNU-Linux-x86 /usr/local/sersync</span><br>[root@data-centos8 ~]<span class="hljs-comment">#echo &#x27;PATH=/usr/local/sersync:$PATH&#x27; &gt; /etc/profile.d/sersync.sh</span><br>[root@data-centos8 ~]<span class="hljs-comment">#source /etc/profile.d/sersync.sh</span><br><br><span class="hljs-comment">#sersync目录只有两个文件：一个是二进制程序文件，一个是xml格式的配置文件</span><br>[root@data-centos8 ~]<span class="hljs-comment">#ls /usr/local/sersync/</span><br>confxml.xml sersync2<br><br><span class="hljs-comment">#确认安装rsync客户端工具</span><br>[root@data-centos8 ~]<span class="hljs-comment">#rpm -q rsync &amp;&gt; /dev/null || dnf -y install rsync</span><br><br><span class="hljs-comment">#备份sersync配置文件</span><br>[root@data-centos8 ~]<span class="hljs-comment">#cp /usr/local/sersync/confxml.xml&#123;,.bak&#125;</span><br><br><span class="hljs-comment">#修改sersync配置文件</span><br>[root@data-centos8 ~]<span class="hljs-comment">#vim /usr/local/sersync/confxml.xml</span><br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;ISO-8859-1&quot;</span>?&gt;<br>&lt;head version=<span class="hljs-string">&quot;2.5&quot;</span>&gt;<br> &lt;host hostip=<span class="hljs-string">&quot;localhost&quot;</span> port=<span class="hljs-string">&quot;8008&quot;</span>&gt;&lt;/host&gt;<br> &lt;debug start=<span class="hljs-string">&quot;false&quot;</span>/&gt; <span class="hljs-comment"># 是否开启调试模式</span><br> &lt;fileSystem xfs=<span class="hljs-string">&quot;false&quot;</span>/&gt;<br> &lt;filter start=<span class="hljs-string">&quot;false&quot;</span>&gt; <span class="hljs-comment">#不开启文件过滤功能，当为true时,以下类型的文件将不同步</span><br> &lt;exclude expression=<span class="hljs-string">&quot;(.*)\.svn&quot;</span>&gt;&lt;/exclude&gt;<br>&lt;exclude expression=<span class="hljs-string">&quot;(.*)\.gz&quot;</span>&gt;&lt;/exclude&gt;<br>&lt;exclude expression=<span class="hljs-string">&quot;^info/*&quot;</span>&gt;&lt;/exclude&gt;<br>&lt;exclude expression=<span class="hljs-string">&quot;^static/*&quot;</span>&gt;&lt;/exclude&gt;<br> &lt;/filter&gt;<br> &lt;inotify&gt; <span class="hljs-comment"># 监控事件，默认监控</span><br>delete/close_write/moved_from/moved_to/create folder<br>&lt;delete start=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br>&lt;createFolder start=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br>&lt;createFile start=<span class="hljs-string">&quot;false&quot;</span>/&gt;<br>&lt;closeWrite start=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br>&lt;moveFrom start=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br>&lt;moveTo start=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br>&lt;attrib start=<span class="hljs-string">&quot;true&quot;</span>/&gt;  <span class="hljs-comment">#修改此行为true，文件属性变化后也会同步</span><br>&lt;modify start=<span class="hljs-string">&quot;false&quot;</span>/&gt;<br> &lt;/inotify&gt;<br> <br> &lt;sersync&gt;  <span class="hljs-comment"># rsync命令的配置段</span><br>&lt;localpath watch=<span class="hljs-string">&quot;/data/www&quot;</span>&gt; <span class="hljs-comment">#修改此行,需要同步的源目录或文件，建议同步目录</span><br> &lt;remote ip=<span class="hljs-string">&quot;备份服务器IP&quot;</span> name=<span class="hljs-string">&quot;backup&quot;</span>/&gt;  <span class="hljs-comment">#修改此行,指定备份服务器地址和rsync daemon的模块名，如果下面开启了ssh start，此时name为远程shell方式运行时的目标目录</span><br> &lt;!--&lt;remote ip=<span class="hljs-string">&quot;192.168.8.39&quot;</span> name=<span class="hljs-string">&quot;tongbu&quot;</span>/&gt;--&gt;<br> &lt;!--&lt;remote ip=<span class="hljs-string">&quot;192.168.8.40&quot;</span> name=<span class="hljs-string">&quot;tongbu&quot;</span>/&gt;--&gt;<br>&lt;/localpath&gt;<br>&lt;rsync&gt;<br> &lt;commonParams params=<span class="hljs-string">&quot;-artuz&quot;</span>/&gt;  <span class="hljs-comment"># 指定rsync选项</span><br> &lt;auth start=<span class="hljs-string">&quot;true&quot;</span> users=<span class="hljs-string">&quot;rsyncuser&quot;</span> passwordfile=<span class="hljs-string">&quot;/etc/rsync.pas&quot;</span>/&gt; <span class="hljs-comment">#修改此行为true,指定备份服务器的rsync配置的用户和密码文件</span><br> &lt;userDefinedPort start=<span class="hljs-string">&quot;false&quot;</span> port=<span class="hljs-string">&quot;874&quot;</span>/&gt;&lt;!-- port=874 --&gt;<span class="hljs-comment">#指定rsync的非标准端口号</span><br> &lt;timeout start=<span class="hljs-string">&quot;false&quot;</span> time=<span class="hljs-string">&quot;100&quot;</span>/&gt;&lt;!-- timeout=100 --&gt;<br> &lt;ssh start=<span class="hljs-string">&quot;false&quot;</span>/&gt; <span class="hljs-comment">#默认使用rsync daemon运行rsync命令,true为使用远程shell模式</span><br>&lt;/rsync&gt;<br>&lt;failLog path=<span class="hljs-string">&quot;/tmp/rsync_fail_log.sh&quot;</span> timeToExecute=<span class="hljs-string">&quot;60&quot;</span>/&gt;&lt;!--default every<br>60mins execute once--&gt;          <span class="hljs-comment">#错误重传及日志文件路径</span><br>&lt;crontab start=<span class="hljs-string">&quot;false&quot;</span> schedule=<span class="hljs-string">&quot;600&quot;</span>&gt;&lt;!--600mins--&gt; <span class="hljs-comment">#不开启crontab功能</span><br> &lt;crontabfilter start=<span class="hljs-string">&quot;false&quot;</span>&gt;  <span class="hljs-comment">#不开启crontab定时传输的筛选功能</span><br>&lt;exclude expression=<span class="hljs-string">&quot;*.php&quot;</span>&gt;&lt;/exclude&gt;<br>&lt;exclude expression=<span class="hljs-string">&quot;info/*&quot;</span>&gt;&lt;/exclude&gt;<br> &lt;/crontabfilter&gt;<br>&lt;/crontab&gt;<br>&lt;plugin start=<span class="hljs-string">&quot;false&quot;</span> name=<span class="hljs-string">&quot;command&quot;</span>/&gt;<br> &lt;/sersync&gt;<br><span class="hljs-comment">#####################################以下行不需要修改</span><br><span class="hljs-comment">####################################</span><br> &lt;plugin name=<span class="hljs-string">&quot;command&quot;</span>&gt;<br>&lt;param prefix=<span class="hljs-string">&quot;/bin/sh&quot;</span> suffix=<span class="hljs-string">&quot;&quot;</span> ignoreError=<span class="hljs-string">&quot;true&quot;</span>/&gt; &lt;!--prefix<br>/opt/tongbu/mmm.sh suffix--&gt;<br>&lt;filter start=<span class="hljs-string">&quot;false&quot;</span>&gt;<br> &lt;include expression=<span class="hljs-string">&quot;(.*)\.php&quot;</span>/&gt;<br> &lt;include expression=<span class="hljs-string">&quot;(.*)\.sh&quot;</span>/&gt;<br>&lt;/filter&gt;<br> &lt;/plugin&gt;<br> &lt;plugin name=<span class="hljs-string">&quot;socket&quot;</span>&gt;<br>&lt;localpath watch=<span class="hljs-string">&quot;/opt/tongbu&quot;</span>&gt;<br>&lt;deshost ip=<span class="hljs-string">&quot;192.168.138.20&quot;</span> port=<span class="hljs-string">&quot;8009&quot;</span>/&gt;<br>&lt;/localpath&gt;<br> &lt;/plugin&gt;<br> &lt;plugin name=<span class="hljs-string">&quot;refreshCDN&quot;</span>&gt;<br>&lt;localpath watch=<span class="hljs-string">&quot;/data0/htdocs/cms.xoyo.com/site/&quot;</span>&gt;<br> &lt;cdninfo domainname=<span class="hljs-string">&quot;ccms.chinacache.com&quot;</span> port=<span class="hljs-string">&quot;80&quot;</span> username=<span class="hljs-string">&quot;xxxx&quot;</span><br>passwd=<span class="hljs-string">&quot;xxxx&quot;</span>/&gt;<br> &lt;sendurl base=<span class="hljs-string">&quot;http://pic.xoyo.com/cms&quot;</span>/&gt;<br> &lt;regexurl regex=<span class="hljs-string">&quot;false&quot;</span> match=<span class="hljs-string">&quot;cms.xoyo.com/site([/a-zA-Z0-</span><br><span class="hljs-string">9]*).xoyo.com/images&quot;</span>/&gt;<br>&lt;/localpath&gt;<br> &lt;/plugin&gt;<br>&lt;/head&gt;<br><br><span class="hljs-comment">#创建连接rsynd服务器的用户密码文件,并必须修改权限</span><br>[root@data-centos8 ~]<span class="hljs-comment">#echo magedu &gt; /etc/rsync.pas</span><br>[root@data-centos8 ~]<span class="hljs-comment">#chmod 600 /etc/rsync.pas</span><br><br><span class="hljs-comment">#查看帮助</span><br>[root@data-centos8 ~]<span class="hljs-comment">#sersync2 -h</span><br><span class="hljs-built_in">set</span> the system param<br>execute：<span class="hljs-built_in">echo</span> 50000000 &gt; /proc/sys/fs/inotify/max_user_watches<br>execute：<span class="hljs-built_in">echo</span> 327679 &gt; /proc/sys/fs/inotify/max_queued_events<br>parse the <span class="hljs-built_in">command</span> param<br>_______________________________________________________<br>参数-d:启用守护进程模式<br>参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍<br>c参数-n: 指定开启守护线程的数量，默认为10个<br>参数-o:指定配置文件，默认使用当前工作目录下的confxml.xml文件<br>参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块<br>参数-m:单独启用其他模块，使用 -m socket 开启socket模块<br>参数-m:单独启用其他模块，使用 -m http 开启http模块<br>不加-m参数，则默认执行同步程序<br><br><span class="hljs-comment">#以后台方式执行同步</span><br>[root@data-centos8 ~]<span class="hljs-comment">#sersync2 -dro /usr/local/sersync/confxml.xml</span><br><span class="hljs-built_in">set</span> the system param<br>execute：<span class="hljs-built_in">echo</span> 50000000 &gt; /proc/sys/fs/inotify/max_user_watches<br>execute：<span class="hljs-built_in">echo</span> 327679 &gt; /proc/sys/fs/inotify/max_queued_events<br>parse the <span class="hljs-built_in">command</span> param<br>option: -d run as a daemon<br>option: -r rsync all the <span class="hljs-built_in">local</span> files to the remote servers before the sersync<br>work<br>option: -o config xml name： /usr/<span class="hljs-built_in">local</span>/sersync/confxml.xml<br>daemon thread num: 10<br>parse xml config file<br>host ip : localhost host port: 8008<br>daemon start，sersync run behind the console<br>use rsync password-file :<br>user is rsyncuser<br>passwordfile is /etc/rsync.pas<br>config xml parse success<br>please <span class="hljs-built_in">set</span> /etc/rsyncd.conf max connections=0 Manually<br>sersync working thread 12  = 1(primary thread) + 1(fail retry thread) +<br>10(daemon sub threads)<br>Max threads numbers is: 22 = 12(Thread pool nums) + 10(Sub threads)<br>please according your cpu ，use -n param to adjust the cpu rate<br>------------------------------------------<br>rsync the directory recursivly to the remote servers once<br>working please <span class="hljs-built_in">wait</span>...<br><span class="hljs-comment">#如果同步失败,可以手动执行下面命令,观察过程</span><br>[root@data-centos8 ~]<span class="hljs-comment"># cd /data/www &amp;&amp; rsync -artuz -R --delete ./ rsyncuser@backup-server::backup --password-file=/etc/rsync.pas &gt;/dev/null 2&gt;&amp;1</span><br>run the sersync:<br>watch path is: /data/www<br><br>________________________________________________________________<br><br><span class="hljs-comment">#sersync支持多实例，也即监控多个目录时，只需分别配置不同配置文件，然后使用sersync2指定对应配置文件运行</span><br>[root@data-centos8 ~]<span class="hljs-comment">#sersync2 -rd -o /etc/sersync.d/nginx.xml</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-3-基于远程shell-实现-sersync"><a href="#5-5-3-基于远程shell-实现-sersync" class="headerlink" title="5.5.3 基于远程shell 实现 sersync"></a>5.5.3 基于远程shell 实现 sersync</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#不需要配置rsync daemon,只需要配置基于key验证的ssh即可</span><br>[root@data-centos8 ~]<span class="hljs-comment">#ssh-keygen</span><br>[root@data-centos8 ~]<span class="hljs-comment">#ssh-copy-id backup-server</span><br><br><span class="hljs-comment">#下载sersync，并拷贝至相应的目录，设置PATH变量同5.5.2</span><br><br><span class="hljs-comment">#修改sersync配置文件</span><br>[root@data-centos8 ~]<span class="hljs-comment">#cat /usr/local/sersync/confxml.xml</span><br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;ISO-8859-1&quot;</span>?&gt;<br>&lt;head version=<span class="hljs-string">&quot;2.5&quot;</span>&gt;<br> &lt;host hostip=<span class="hljs-string">&quot;localhost&quot;</span> port=<span class="hljs-string">&quot;8008&quot;</span>&gt;&lt;/host&gt;<br> &lt;debug start=<span class="hljs-string">&quot;false&quot;</span>/&gt;<br> &lt;fileSystem xfs=<span class="hljs-string">&quot;false&quot;</span>/&gt;<br> &lt;filter start=<span class="hljs-string">&quot;false&quot;</span>&gt;<br>&lt;exclude expression=<span class="hljs-string">&quot;(.*)\.svn&quot;</span>&gt;&lt;/exclude&gt;<br>&lt;exclude expression=<span class="hljs-string">&quot;(.*)\.gz&quot;</span>&gt;&lt;/exclude&gt;<br>&lt;exclude expression=<span class="hljs-string">&quot;^info/*&quot;</span>&gt;&lt;/exclude&gt;<br>&lt;exclude expression=<span class="hljs-string">&quot;^static/*&quot;</span>&gt;&lt;/exclude&gt;<br> &lt;/filter&gt;<br> &lt;inotify&gt;<br>&lt;delete start=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br>&lt;createFolder start=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br>&lt;createFile start=<span class="hljs-string">&quot;false&quot;</span>/&gt;<br>&lt;closeWrite start=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br>&lt;moveFrom start=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br>&lt;moveTo start=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br>&lt;attrib start=<span class="hljs-string">&quot;true&quot;</span>/&gt;  <span class="hljs-comment">#修改此行为true</span><br>&lt;modify start=<span class="hljs-string">&quot;false&quot;</span>/&gt;<br> &lt;/inotify&gt;<br> &lt;sersync&gt;<br>&lt;localpath watch=<span class="hljs-string">&quot;/data/www&quot;</span>&gt; <span class="hljs-comment">#修改此行,指定源数据目录</span><br> &lt;remote ip=<span class="hljs-string">&quot;备份服务器IP&quot;</span> name=<span class="hljs-string">&quot;/data/backup&quot;</span>/&gt; <span class="hljs-comment">#修改此行指定备份服务器地址和备份目标目录</span><br> &lt;!--&lt;remote ip=<span class="hljs-string">&quot;192.168.8.39&quot;</span> name=<span class="hljs-string">&quot;tongbu&quot;</span>/&gt;--&gt;<br> &lt;!--&lt;remote ip=<span class="hljs-string">&quot;192.168.8.40&quot;</span> name=<span class="hljs-string">&quot;tongbu&quot;</span>/&gt;--&gt;<br>&lt;/localpath&gt;<br>&lt;rsync&gt;<br> &lt;commonParams params=<span class="hljs-string">&quot;-artuz&quot;</span>/&gt;<br> &lt;auth start=<span class="hljs-string">&quot;false&quot;</span> users=<span class="hljs-string">&quot;root&quot;</span> passwordfile=<span class="hljs-string">&quot;/etc/rsync.pas&quot;</span>/&gt; <span class="hljs-comment">#必须修改此行,不启用认证</span><br> &lt;userDefinedPort start=<span class="hljs-string">&quot;false&quot;</span> port=<span class="hljs-string">&quot;874&quot;</span>/&gt;&lt;!-- port=874 --&gt;<br> &lt;timeout start=<span class="hljs-string">&quot;false&quot;</span> time=<span class="hljs-string">&quot;100&quot;</span>/&gt;&lt;!-- timeout=100 --&gt;<br> &lt;ssh start=<span class="hljs-string">&quot;true&quot;</span>/&gt; <span class="hljs-comment">#修改此行为true,使用远程shell方式的rsync连接方式，无需在目标主机上配置启动rsync daemon服务</span><br> <br><span class="hljs-comment">#####################################以下行不需要修改####################################</span><br>&lt;/rsync&gt;<br>&lt;failLog path=<span class="hljs-string">&quot;/tmp/rsync_fail_log.sh&quot;</span> timeToExecute=<span class="hljs-string">&quot;60&quot;</span>/&gt;&lt;!--default every<br>60mins execute once--&gt;<br>&lt;crontab start=<span class="hljs-string">&quot;false&quot;</span> schedule=<span class="hljs-string">&quot;600&quot;</span>&gt;&lt;!--600mins--&gt;<br> &lt;crontabfilter start=<span class="hljs-string">&quot;false&quot;</span>&gt;<br>&lt;exclude expression=<span class="hljs-string">&quot;*.php&quot;</span>&gt;&lt;/exclude&gt;<br>&lt;exclude expression=<span class="hljs-string">&quot;info/*&quot;</span>&gt;&lt;/exclude&gt;<br> &lt;/crontabfilter&gt;<br>&lt;/crontab&gt;<br>&lt;plugin start=<span class="hljs-string">&quot;false&quot;</span> name=<span class="hljs-string">&quot;command&quot;</span>/&gt;<br> &lt;/sersync&gt;<br><span class="hljs-comment">#将中间的行可以删除</span><br>&lt;/head&gt;<br><br>[root@data-centos8 ~]<span class="hljs-comment">#sersync2 -dro /usr/local/sersync/confxml.xml</span><br><span class="hljs-built_in">set</span> the system param<br>execute：<span class="hljs-built_in">echo</span> 50000000 &gt; /proc/sys/fs/inotify/max_user_watches<br>execute：<span class="hljs-built_in">echo</span> 327679 &gt; /proc/sys/fs/inotify/max_queued_events<br>parse the <span class="hljs-built_in">command</span> param<br>option: -d run as a daemon<br>option: -r rsync all the <span class="hljs-built_in">local</span> files to the remote servers before the sersync<br>work<br>option: -o config xml name： /apps/sersync/confxml.xml<br>daemon thread num: 10<br>parse xml config file<br>host ip : localhost host port: 8008<br>daemon start，sersync run behind the console<br>config xml parse success<br>please <span class="hljs-built_in">set</span> /etc/rsyncd.conf max connections=0 Manually<br>sersync working thread 12  = 1(primary thread) + 1(fail retry thread) +<br>10(daemon sub threads)<br>Max threads numbers is: 22 = 12(Thread pool nums) + 10(Sub threads)<br>please according your cpu ，use -n param to adjust the cpu rate<br>------------------------------------------<br>rsync the directory recursivly to the remote servers once<br>working please <span class="hljs-built_in">wait</span>...<br>execute <span class="hljs-built_in">command</span>: <span class="hljs-built_in">cd</span> /data/www &amp;&amp; rsync -auz -R --delete ./  -e ssh<br>10.0.0.18:/data/backup &gt;/dev/null 2&gt;&amp;1<br>run the sersync:<br>watch path is: /data/www<br></code></pre></td></tr></table></figure>

<h2 id="5-6-实战案例：实现基于分布式的LAMP架构，并将NFS实时同步到备份服务器"><a href="#5-6-实战案例：实现基于分布式的LAMP架构，并将NFS实时同步到备份服务器" class="headerlink" title="5.6 实战案例：实现基于分布式的LAMP架构，并将NFS实时同步到备份服务器"></a>5.6 实战案例：实现基于分布式的LAMP架构，并将NFS实时同步到备份服务器</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/netfile/netfile22.png" srcset="/blog/img/loading.gif" alt="netfile"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/linux-%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1/">linux 网络文件服务</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">消息队列与微服务</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%B0%83%E5%BA%A6%E5%99%A8LVS/">
                        <span class="hidden-mobile">企业级调度器LVS</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
