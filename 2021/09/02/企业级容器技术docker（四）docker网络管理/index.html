

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>企业级容器技术docker（四）docker网络管理 - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="企业级容器技术docker（四）docker网络管理">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-02 14:27" pubdate>
        2021年9月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      28k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      500
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">企业级容器技术docker（四）docker网络管理</h1>
            
            <div class="markdown-body">
              <h1 id="企业级容器技术docker"><a href="#企业级容器技术docker" class="headerlink" title="企业级容器技术docker"></a>企业级容器技术docker</h1><h1 id="四、-网络管理"><a href="#四、-网络管理" class="headerlink" title="四、 网络管理"></a>四、 网络管理</h1><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker64.png" srcset="/blog/img/loading.gif"></p>
<p>docker容器创建后，必不可少的要和其它主机或容器进行网络通信</p>
<p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://docs.docker.com/network/<br></code></pre></td></tr></table></figure>

<h2 id="4-1-Docker的默认的网络通信"><a href="#4-1-Docker的默认的网络通信" class="headerlink" title="4.1 Docker的默认的网络通信"></a>4.1 Docker的默认的网络通信</h2><h3 id="4-1-1-Docker安装后默认的网络设置"><a href="#4-1-1-Docker安装后默认的网络设置" class="headerlink" title="4.1.1 Docker安装后默认的网络设置"></a>4.1.1 Docker安装后默认的网络设置</h3><p>Docker服务安装完成之后，默认在每个宿主机会生成一个名称为docker0的网卡其IP地址都是172.17.0.1/16</p>
<p>范例: 安装Docker的默认的网络配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:ab:53:42 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:feab:5342/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:be:1d:57:9d brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		STP enabled	interfaces<br>docker0		8000.0242be1d579d	no<br></code></pre></td></tr></table></figure>

<p>范例: 安装Harbor的默认网络配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:01:f3:0c brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.102/24 brd 10.0.0.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe01:f30c/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state<br>DOWN group default<br> link/ether 02:42:f4:23:e8:29 brd ff:ff:ff:ff:ff:ff<br> inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>   valid_lft forever preferred_lft forever<br>4: br-9af624ecd23e: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>state UP group default<br> link/ether 02:42:e9:1c:1a:7b brd ff:ff:ff:ff:ff:ff<br> inet 172.18.0.1/16 brd 172.18.255.255 scope global br-9af624ecd23e<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::42:e9ff:fe1c:1a7b/64 scope link<br>   valid_lft forever preferred_lft forever<br>6: veth225895c@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master br-9af624ecd23e state UP group default<br> link/ether a6:f3:0f:ae:4b:43 brd ff:ff:ff:ff:ff:ff link-netnsid 0<br> inet6 fe80::a4f3:fff:feae:4b43/64 scope link<br>   valid_lft forever preferred_lft forever<br>8: veth244c237@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master br-9af624ecd23e state UP group default<br> link/ether 72:12:35:11:e8:14 brd ff:ff:ff:ff:ff:ff link-netnsid 1<br> inet6 fe80::7012:35ff:fe11:e814/64 scope link<br>   valid_lft forever preferred_lft forever<br>10: veth81ab8cb@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master br-9af624ecd23e state UP group default<br> link/ether 5e:07:f2:eb:43:c2 brd ff:ff:ff:ff:ff:ff link-netnsid 2<br> inet6 fe80::5c07:f2ff:feeb:43c2/64 scope link<br>    valid_lft forever preferred_lft forever<br>12: vethf8499d4@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master br-9af624ecd23e state UP group default<br> link/ether 4e:df:12:c5:58:83 brd ff:ff:ff:ff:ff:ff link-netnsid 4<br> inet6 fe80::4cdf:12ff:fec5:5883/64 scope link<br>   valid_lft forever preferred_lft forever<br>14: vethceabf74@if13: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master br-9af624ecd23e state UP group default<br> link/ether 06:c0:58:ea:51:2e brd ff:ff:ff:ff:ff:ff link-netnsid 5<br> inet6 fe80::4c0:58ff:feea:512e/64 scope link<br>   valid_lft forever preferred_lft forever<br>16: veth47c5069@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master br-9af624ecd23e state UP group default<br> link/ether c6:6f:aa:51:be:38 brd ff:ff:ff:ff:ff:ff link-netnsid 3<br> inet6 fe80::c46f:aaff:fe51:be38/64 scope link<br>   valid_lft forever preferred_lft forever<br>18: veth83fde4a@if17: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master br-9af624ecd23e state UP group default<br> link/ether 32:74:1e:e2:81:50 brd ff:ff:ff:ff:ff:ff link-netnsid 6<br> inet6 fe80::3074:1eff:fee2:8150/64 scope link<br>   valid_lft forever preferred_lft forever<br>20: veth2c51f87@if19: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master br-9af624ecd23e state UP group default<br> link/ether ca:b7:c9:da:87:92 brd ff:ff:ff:ff:ff:ff link-netnsid 7<br> inet6 fe80::c8b7:c9ff:feda:8792/64 scope link<br>   valid_lft forever preferred_lft forever<br>22: veth0f4a931@if21: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master br-9af624ecd23e state UP group default<br> link/ether fa:29:a4:4d:b1:c2 brd ff:ff:ff:ff:ff:ff link-netnsid 8<br> inet6 fe80::f829:a4ff:fe4d:b1c2/64 scope link<br>   valid_lft forever preferred_lft forever<br>24: veth55b6555@if23: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master br-9af624ecd23e state UP group default<br> link/ether aa:87:c4:2c:de:7c brd ff:ff:ff:ff:ff:ff link-netnsid 9<br> inet6 fe80::a887:c4ff:fe2c:de7c/64 scope link<br>   valid_lft forever preferred_lft forever<br>   <br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt -y install bridge-utils</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge name bridge id STP enabled interfaces<br>br-9af624ecd23e 8000.0242e91c1a7b no veth0f4a931<br>veth225895c<br>veth244c237<br>veth2c51f87<br>veth47c5069<br>veth55b6555<br>veth81ab8cb<br>veth83fde4a<br>vethceabf74<br>vethf8499d4<br>docker0 8000.0242f423e829 no<br></code></pre></td></tr></table></figure>

<h3 id="4-1-2-创建容器后的网络配置"><a href="#4-1-2-创建容器后的网络配置" class="headerlink" title="4.1.2 创建容器后的网络配置"></a>4.1.2 创建容器后的网络配置</h3><p>每次新建容器后</p>
<ul>
<li>宿主机多了一个虚拟网卡，和容器的网卡组合成一个网卡，比如: 137: veth8ca6d43@if136，而在容器内的网卡名为136，可以看出和宿主机的网卡之间的关联</li>
<li>容器会自动获取一个172.17.0.0/16网段的随机地址，默认从172.17.0.2开始，第二次容器为172.17.0.3，以此类推</li>
<li>容器获取的地址并不固定,每次容器重启,可能会发生地址变化</li>
</ul>
<h4 id="4-1-2-1-创建第一个容器后的网络状态"><a href="#4-1-2-1-创建第一个容器后的网络状态" class="headerlink" title="4.1.2.1 创建第一个容器后的网络状态"></a>4.1.2.1 创建第一个容器后的网络状态</h4><p>范例: 创建容器，容器自动获取IP地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm alpine:3.11 sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>7: eth0@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1	localhost<br>::1	localhost ip6-localhost ip6-loopback<br>fe00::0	ip6-localnet<br>ff00::0	ip6-mcastprefix<br>ff02::1	ip6-allnodes<br>ff02::2	ip6-allrouters<br>172.17.0.2	0f1ac6c7fef8<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE               COMMAND             CREATED              STATUS              PORTS               NAMES<br>0f1ac6c7fef8        alpine:3.11         <span class="hljs-string">&quot;sh&quot;</span>                About a minute ago   Up 58 seconds                           priceless_burnell<br></code></pre></td></tr></table></figure>

<p>范例: 新建第一个容器，宿主机的网卡多了一个新网卡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:ab:53:42 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:feab:5342/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default <br>    link/ether 02:42:84:a5:a7:44 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::42:84ff:fea5:a744/64 scope link <br>       valid_lft forever preferred_lft forever<br>5: veth84b9dfc@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default <br>    link/ether ce:e5:e6:ec:4a:20 brd ff:ff:ff:ff:ff:ff link-netnsid 0<br>    inet6 fe80::cce5:e6ff:feec:4a20/64 scope link <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<p>范例: 查看新建容器后桥接状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		STP enabled	interfaces<br>docker0		8000.024284a5a744	no		veth84b9dfc<br></code></pre></td></tr></table></figure>

<h4 id="4-1-2-2-创建第二个容器后面的网络状态"><a href="#4-1-2-2-创建第二个容器后面的网络状态" class="headerlink" title="4.1.2.2 创建第二个容器后面的网络状态"></a>4.1.2.2 创建第二个容器后面的网络状态</h4><p>范例: 再次创建第二个容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm alpine:3.11 sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>6: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1	localhost<br>::1	localhost ip6-localhost ip6-loopback<br>fe00::0	ip6-localnet<br>ff00::0	ip6-mcastprefix<br>ff02::1	ip6-allnodes<br>ff02::2	ip6-allrouters<br>172.17.0.2	37ed1d621b28<br>/ <span class="hljs-comment"># ping 37ed1d621b28</span><br>PING 37ed1d621b28 (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.040 ms<br>64 bytes from 172.17.0.2: seq=1 ttl=64 time=0.050 ms<br>^C<br>--- 37ed1d621b28 ping statistics ---<br>2 packets transmitted, 2 packets received, 0% packet loss<br>round-trip min/avg/max = 0.040/0.045/0.050 ms<br>/ <span class="hljs-comment"># ping 66354b21532e</span><br>ping: bad address <span class="hljs-string">&#x27;66354b21532e&#x27;</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE               COMMAND             CREATED              STATUS              PORTS               NAMES<br>66354b21532e        alpine:3.11         <span class="hljs-string">&quot;sh&quot;</span>                About a minute ago   Up About a minute                       interesting_pasteur<br>37ed1d621b28        alpine:3.11         <span class="hljs-string">&quot;sh&quot;</span>                2 minutes ago        Up 2 minutes                            awesome_leavitt<br></code></pre></td></tr></table></figure>

<p>范例: 新建第二个容器后宿主机又多了一个虚拟网卡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>11: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:ab:53:42 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:feab:5342/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default <br>    link/ether 02:42:84:a5:a7:44 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::42:84ff:fea5:a744/64 scope link <br>       valid_lft forever preferred_lft forever<br>7: vethdd7def3@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default <br>    link/ether 86:40:97:3a:0e:93 brd ff:ff:ff:ff:ff:ff link-netnsid 0<br>    inet6 fe80::8440:97ff:fe3a:e93/64 scope link <br>       valid_lft forever preferred_lft forever<br>9: vethff6a71e@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default <br>    link/ether 46:1d:92:4a:13:16 brd ff:ff:ff:ff:ff:ff link-netnsid 1<br>    inet6 fe80::441d:92ff:fe4a:1316/64 scope link <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<p>范例: 查看新建第二个容器后桥接状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		STP enabled	interfaces<br>docker0		8000.024284a5a744	no		vethdd7def3<br>							            vethff6a71e<br></code></pre></td></tr></table></figure>

<h3 id="4-1-3-容器间的通信"><a href="#4-1-3-容器间的通信" class="headerlink" title="4.1.3 容器间的通信"></a>4.1.3 容器间的通信</h3><h4 id="4-1-3-1-同一个宿主机的不同容器可相互通信"><a href="#4-1-3-1-同一个宿主机的不同容器可相互通信" class="headerlink" title="4.1.3.1 同一个宿主机的不同容器可相互通信"></a>4.1.3.1 同一个宿主机的不同容器可相互通信</h4><p>默认情况下</p>
<ul>
<li>同一个宿主机的不同容器之间可以相互通信</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">dockerd  --icc  Enable inter-container communication (default <span class="hljs-literal">true</span>)<br>--icc=<span class="hljs-literal">false</span>  <span class="hljs-comment">#此配置可以禁止同一个宿主机的容器之间通信</span><br></code></pre></td></tr></table></figure>

<ul>
<li>不同宿主机之间的容器IP地址重复，默认不能相互通信</li>
</ul>
<p>范例: 同一个宿主机的容器之间访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:34:df:91 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe34:df91/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP<br>group default<br> link/ether 02:42:02:7f:a8:c6 brd ff:ff:ff:ff:ff:ff<br> inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::42:2ff:fe7f:a8c6/64 scope link<br>   valid_lft forever preferred_lft forever<br>137: veth8ca6d43@if136: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master docker0 state UP group default<br> link/ether fa:96:37:77:a9:a9 brd ff:ff:ff:ff:ff:ff link-netnsid 0<br> inet6 fe80::f896:37ff:fe77:a9a9/64 scope link<br>   valid_lft forever preferred_lft forever<br>141: vethf599a47@if140: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue<br>master docker0 state UP group default<br> link/ether 96:e7:52:fe:67:54 brd ff:ff:ff:ff:ff:ff link-netnsid 1<br> inet6 fe80::94e7:52ff:fefe:6754/64 scope link<br>   valid_lft forever preferred_lft forever<br>[root@ubuntu1804 ~]<span class="hljs-comment"># </span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br>136: eth0@if137: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue<br>state UP<br> link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br> inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping 172.17.0.3</span><br>PING 172.17.0.3 (172.17.0.3): 56 data bytes<br>64 bytes from 172.17.0.3: seq=0 ttl=64 time=0.452 ms<br>64 bytes from 172.17.0.3: seq=1 ttl=64 time=0.190 ms<br>^C<br>--- 172.17.0.3 ping statistics ---<br>2 packets transmitted, 2 packets received, 0% packet loss<br>round-trip min/avg/max = 0.190/0.321/0.452 ms<br>/ <span class="hljs-comment"># ping 172.17.0.1</span><br>PING 172.17.0.1 (172.17.0.1): 56 data bytes<br>64 bytes from 172.17.0.1: seq=0 ttl=64 time=0.139 ms<br>64 bytes from 172.17.0.1: seq=1 ttl=64 time=0.183 ms<br>^C<br>--- 172.17.0.1 ping statistics ---<br>2 packets transmitted, 2 packets received, 0% packet loss<br>round-trip min/avg/max = 0.139/0.161/0.183 ms<br>/ <span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-3-2-禁止同一个宿主机的不同容器间通信"><a href="#4-1-3-2-禁止同一个宿主机的不同容器间通信" class="headerlink" title="4.1.3.2 禁止同一个宿主机的不同容器间通信"></a>4.1.3.2 禁止同一个宿主机的不同容器间通信</h4><p>范例: 同一个宿主机不同容器间禁止通信</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#vim /lib/systemd/system/docker.service</span><br>ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --icc=<span class="hljs-literal">false</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#systemctl daemon-reload</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#systemctl restart docker</span><br><br><span class="hljs-comment">#创建两个容器,测试无法通信</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name test1 --rm alpine sh</span><br>/ <span class="hljs-comment"># hostname -i</span><br>172.17.0.2<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name test2 --rm alpine sh</span><br>/ <span class="hljs-comment"># hostname -i</span><br>172.17.0.3<br>/ <span class="hljs-comment"># ping 172.17.0.2</span><br></code></pre></td></tr></table></figure>

<p>范例: 在第二个宿主机上创建容器，跨宿主机的容器之间默认不能通信</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker pull alpine</span><br>Using default tag: latest<br>latest: Pulling from library/alpine<br>5843afab3874: Pull complete <br>Digest: sha256:234cb88d3020898631af0ccbbcca9a66ae7306ecd30c9720690858c1b007d2a0<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> alpine:latest<br>docker.io/library/alpine:latest<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES<br>cab76bbb3db2        alpine              <span class="hljs-string">&quot;sh&quot;</span>                About a minute ago                      Up About a minute jolly_rosalind<br>[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:6b:54:d3 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.101/24 brd 10.0.0.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe6b:54d3/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state<br>DOWN group default<br> link/ether 02:42:1d:73:8b:71 brd ff:ff:ff:ff:ff:ff<br> inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>   valid_lft forever preferred_lft forever<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAME<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm alpine sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br>4: eth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue<br>state UP<br> link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br> inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping -c 1 172.17.0.3</span><br>PING 172.17.0.3 (172.17.0.3): 56 data bytes<br><br>--- 172.17.0.3 ping statistics ---<br>1 packets transmitted, 0 packets received, 100% packet loss<br></code></pre></td></tr></table></figure>

<h3 id="4-1-4-修改默认网络设置"><a href="#4-1-4-修改默认网络设置" class="headerlink" title="4.1.4 修改默认网络设置"></a>4.1.4 修改默认网络设置</h3><p>新建容器默认使用docker0的网络配置,可以修改默认指向自定义的网桥网络</p>
<p>范例: 用自定义的网桥代替默认的docker0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看默认网络</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:ab:53:42 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:feab:5342/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:84:a5:a7:44 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::42:84ff:fea5:a744/64 scope link <br>       valid_lft forever preferred_lft forever<br>   <br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt -y install bridge-utils</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl addbr br0</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ip a a 192.168.100.1/24 dev br0</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge      name	           bridge id		STP        enabled	     interfaces<br>br0		    8000.000000000000	                no		<br>docker0		8000.024284a5a744	                no<br>[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:ab:53:42 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:feab:5342/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:84:a5:a7:44 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::42:84ff:fea5:a744/64 scope link <br>       valid_lft forever preferred_lft forever<br>12: br0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000<br>    link/ether 1a:46:ce:f1:a8:3d brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.100.1/24 scope global br0<br>       valid_lft forever preferred_lft forever<br>   <br>[root@ubuntu1804 ~]<span class="hljs-comment">#vim /lib/systemd/system/docker.service</span><br>ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -b br0<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#systemctl daemon-reload</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#systemctl restart docker</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ps -ef |grep dockerd</span><br>root       2633      1  0 20:23 ?        00:00:00 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -b br0<br>root       2820   1931  0 20:24 pts/1    00:00:00 grep --color=auto docker<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run --rm alpine hostname -i</span><br>192.168.100.2<br></code></pre></td></tr></table></figure>

<h2 id="4-2-容器名称互联"><a href="#4-2-容器名称互联" class="headerlink" title="4.2 容器名称互联"></a>4.2 容器名称互联</h2><p>新建容器时，docker会自动分配容器名称，容器ID和IP地址，导致容器名称，容器ID和IP都不固定，那么如何区分不同的容器，实现和确定目标容器的通信呢？解决方案是给容器起个固定的名称，容器之间通过固定名称实现确定目标的通信</p>
<p>有两种固定名称:<br>容器名称<br>容器名称的别名</p>
<p>注意: 两种方式都最少需要两个容器才能实现</p>
<h3 id="4-2-1-通过容器名称互联"><a href="#4-2-1-通过容器名称互联" class="headerlink" title="4.2.1 通过容器名称互联"></a>4.2.1 通过容器名称互联</h3><h4 id="4-2-1-1-容器名称介绍"><a href="#4-2-1-1-容器名称介绍" class="headerlink" title="4.2.1.1 容器名称介绍"></a>4.2.1.1 容器名称介绍</h4><p>即在同一个宿主机上的容器之间可以通过自定义的容器名称相互访问，比如: 一个业务前端静态页面是使用nginx，动态页面使用的是tomcat，另外还需要负载均衡调度器，如: haproxy 对请求调度至nginx和tomcat的容器，由于容器在启动的时候其内部IP地址是DHCP 随机分配的，而给容器起个固定的名称，则是相对比较固定的，因此比较适用于此场景</p>
<p><strong>注意: 如果被引用的容器地址变化,必须重启当前容器才能生效</strong></p>
<h4 id="4-2-1-2-容器名称实现"><a href="#4-2-1-2-容器名称实现" class="headerlink" title="4.2.1.2 容器名称实现"></a>4.2.1.2 容器名称实现</h4><p>docker run 创建容器，可使用–link选项实现容器名称的引用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">--link list           <span class="hljs-comment">#Add link to another container</span><br>格式: <br>docker run --name &lt;容器名称&gt; <span class="hljs-comment">#先创建指定名称的容器</span><br>docker run --link &lt;目标通信的容器ID或容器名称&gt;   <span class="hljs-comment">#再创建容器时引用上面容器的名称,从而对容器进行互联</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-1-3-实战案例1-使用容器名称进行容器间通信"><a href="#4-2-1-3-实战案例1-使用容器名称进行容器间通信" class="headerlink" title="4.2.1.3 实战案例1: 使用容器名称进行容器间通信"></a>4.2.1.3 实战案例1: 使用容器名称进行容器间通信</h4><ol>
<li><strong>先创建第一个指定容器名称的容器</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name server1 --rm alpine:3.11 sh</span><br>/ <span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1	localhost<br>::1	localhost ip6-localhost ip6-loopback<br>fe00::0	ip6-localnet<br>ff00::0	ip6-mcastprefix<br>ff02::1	ip6-allnodes<br>ff02::2	ip6-allrouters<br>172.17.0.2	797d0a6f687d<br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>17: eth0@if18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping 172.17.0.2</span><br>PING 172.17.0.2 (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.034 ms<br>64 bytes from 172.17.0.2: seq=1 ttl=64 time=0.049 ms<br>^C<br>--- 172.17.0.2 ping statistics ---<br>2 packets transmitted, 2 packets received, 0% packet loss<br>round-trip min/avg/max = 0.034/0.041/0.049 ms<br>/ <span class="hljs-comment"># ping server1</span><br>ping: bad address <span class="hljs-string">&#x27;server1&#x27;</span><br>/ <span class="hljs-comment"># ping 797d0a6f687d</span><br>PING 797d0a6f687d (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.038 ms<br>^C<br>--- 797d0a6f687d ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.038/0.038/0.038 ms<br></code></pre></td></tr></table></figure>

<ol start="2">
<li><strong>新建第二个容器时引用第一个容器的名称</strong><br> 会自动将第一个主机的名称加入/etc/hosts文件,从而可以利用第一个容器名称进行访问</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm --name server2 --link server1 alpine:3.11 sh</span><br>/ <span class="hljs-comment"># env</span><br>HOSTNAME=a8438a36330a<br>SHLVL=1<br>HOME=/root<br>SERVER1_NAME=/server2/server1<br>TERM=xterm<br>PATH=/usr/<span class="hljs-built_in">local</span>/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin<br>PWD=/<br>/ <span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1	localhost<br>::1	localhost ip6-localhost ip6-loopback<br>fe00::0	ip6-localnet<br>ff00::0	ip6-mcastprefix<br>ff02::1	ip6-allnodes<br>ff02::2	ip6-allrouters<br>172.17.0.2	server1 797d0a6f687d<br>172.17.0.3	a8438a36330a<br>/ <span class="hljs-comment"># ping server1</span><br>PING server1 (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.068 ms<br>^C<br>--- server1 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.068/0.068/0.068 ms<br>/ <span class="hljs-comment"># ping server2</span><br>ping: bad address <span class="hljs-string">&#x27;server2&#x27;</span><br>/ <span class="hljs-comment"># ping 797d0a6f687d</span><br>PING 797d0a6f687d (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.056 ms<br>^C<br>--- 797d0a6f687d ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.056/0.056/0.056 ms<br>/ <span class="hljs-comment"># ping a8438a36330a</span><br>PING a8438a36330a (172.17.0.3): 56 data bytes<br>64 bytes from 172.17.0.3: seq=0 ttl=64 time=0.026 ms<br>^C<br>--- a8438a36330a ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.026/0.026/0.026 ms<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES<br>a8438a36330a        alpine:3.11         <span class="hljs-string">&quot;sh&quot;</span>                28 minutes ago      Up 28 minutes                           server2<br>797d0a6f687d        alpine:3.11         <span class="hljs-string">&quot;sh&quot;</span>                35 minutes ago      Up 35 minutes                           server1<br></code></pre></td></tr></table></figure>

<h4 id="4-2-1-4-实战案例2-实现-wordpress-和-MySQL-两个容器互连"><a href="#4-2-1-4-实战案例2-实现-wordpress-和-MySQL-两个容器互连" class="headerlink" title="4.2.1.4 实战案例2: 实现 wordpress 和 MySQL 两个容器互连"></a>4.2.1.4 实战案例2: 实现 wordpress 和 MySQL 两个容器互连</h4><p>改成docker实现lnmp</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#mkdir -p lamp_docker/mysql</span><br>[root@centos7 ~]<span class="hljs-comment">#vim lamp_docker/env_mysql.list</span><br>MYSQL_ROOT_PASSWORD=123456<br>MYSQL_DATABASE=wordpress<br>MYSQL_USER=wpuser<br>MYSQL_PASSWORD=wppass<br>[root@centos7 ~]<span class="hljs-comment">#vim lamp_docker/env_wordpress.list</span><br>WORDPRESS_DB_HOST=mysql:3306<br>WORDPRESS_DB_NAME=wordpress<br>WORDPRESS_DB_USER=wpuser<br>WORDPRESS_DB_PASSWORD=wppass<br>WORDPRESS_TABLE_PREFIX=wp_<br>[root@centos7 ~]<span class="hljs-comment">#vim lamp_docker/mysql/mysql_test.cnf</span><br>[mysqld]<br>server-id=100<br>log-bin=mysql-bin<br><br>[root@centos7 ~]<span class="hljs-comment"># tree lamp_docker/</span><br>lamp_docker/<br>├── env_mysql.list<br>├── env_wordpress.list<br>└── mysql<br>    └── mysql_test.cnf<br><br>1 directory, 3 files<br><br>[root@centos7 ~]<span class="hljs-comment"># mkdir -p /data/mysql</span><br><br>[root@centos7 ~]<span class="hljs-comment">#docker run --name mysql -v /root/lamp_docker/mysql/:/etc/mysql/conf.d -v /data/mysql:/var/lib/mysql --env-file=/root/lamp_docker/env_mysql.list -d -p 3306:3306 mysql:5.7.30</span><br><br>[root@centos7 ~]<span class="hljs-comment">#docker run -d --name wordpress --link mysql --env-file=/root/lamp_docker/env_wordpress.list -p 80:80 wordpress</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker65.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-2-2-通过自定义容器别名互联"><a href="#4-2-2-通过自定义容器别名互联" class="headerlink" title="4.2.2 通过自定义容器别名互联"></a>4.2.2 通过自定义容器别名互联</h3><h4 id="4-2-2-1-容器别名介绍"><a href="#4-2-2-1-容器别名介绍" class="headerlink" title="4.2.2.1 容器别名介绍"></a>4.2.2.1 容器别名介绍</h4><p>自定义的容器名称可能后期会发生变化，那么一旦名称发生变化，容器内程序之间也必须要随之发生变化，比如:程序通过固定的容器名称进行服务调用，但是容器名称发生变化之后再使用之前的名称肯定是无法成功调用，每次都进行更改的话又比较麻烦，因此可以使用自定义别名的方式解决，即容器名称可以随意更改，只要不更改别名即可</p>
<h4 id="4-2-2-2-容器别名实现"><a href="#4-2-2-2-容器别名实现" class="headerlink" title="4.2.2.2 容器别名实现"></a>4.2.2.2 容器别名实现</h4><p>命令格式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run --name &lt;容器名称&gt; <span class="hljs-comment">#先创建指定名称的容器</span><br>docker run -d --name 容器名称 --link &lt;目标容器名称&gt;:&lt;容器别名&gt; <span class="hljs-comment">#给上面创建的容器起别名,来创建新容器</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-2-3-实战案例-使用容器别名"><a href="#4-2-2-3-实战案例-使用容器别名" class="headerlink" title="4.2.2.3 实战案例: 使用容器别名"></a>4.2.2.3 实战案例: 使用容器别名</h4><p>范例: 创建第三个容器，引用前面创建的容器，并起别名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm --name server3 --link server1:server1-alias alpine:3.11 sh</span><br>/ <span class="hljs-comment"># env</span><br>HOSTNAME=395d8c3392ee<br>SHLVL=1<br>HOME=/root<br>TERM=xterm<br>SERVER1-ALIAS_NAME=/server3/server1-alias<br>PATH=/usr/<span class="hljs-built_in">local</span>/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin<br>PWD=/<br><br>/ <span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1	localhost<br>::1	localhost ip6-localhost ip6-loopback<br>fe00::0	ip6-localnet<br>ff00::0	ip6-mcastprefix<br>ff02::1	ip6-allnodes<br>ff02::2	ip6-allrouters<br>172.17.0.2	server1-alias 797d0a6f687d server1<br>172.17.0.4	c8c882fbdcda<br>/ <span class="hljs-comment"># ping server1</span><br>PING server1 (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.101 ms<br>^C<br>--- server1 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.101/0.101/0.101 ms<br>/ <span class="hljs-comment"># ping server1-alias</span><br>PING server1-alias (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.073 ms<br>^C<br>--- server1-alias ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.073/0.073/0.073 ms<br>/ <span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>范例: 创建第四个容器，引用前面创建的容器，并起多个别名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm --name server4 --link server1:&quot;server1-alias1 server1-alias2&quot; alpine:3.11 sh</span><br>/ <span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1	localhost<br>::1	localhost ip6-localhost ip6-loopback<br>fe00::0	ip6-localnet<br>ff00::0	ip6-mcastprefix<br>ff02::1	ip6-allnodes<br>ff02::2	ip6-allrouters<br>172.17.0.2	server1-alias1 server1-alias2 797d0a6f687d server1<br>172.17.0.5	0ca52ffcd771<br>/ <span class="hljs-comment"># ping server1</span><br>PING server1 (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.107 ms<br>^C<br>--- server1 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.107/0.107/0.107 ms<br>/ <span class="hljs-comment"># ping server1-alias1</span><br>PING server1-alias1 (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.126 ms<br>^C<br>--- server1-alias1 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.126/0.126/0.126 ms<br>/ <span class="hljs-comment"># ping server1-alias2</span><br>PING server1-alias2 (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.124 ms<br>^C<br>--- server1-alias2 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.124/0.124/0.124 ms<br>/ <span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h2 id="4-3-docker-网络连接模式"><a href="#4-3-docker-网络连接模式" class="headerlink" title="4.3 docker 网络连接模式"></a>4.3 docker 网络连接模式</h2><h3 id="4-3-1-网络模式介绍"><a href="#4-3-1-网络模式介绍" class="headerlink" title="4.3.1 网络模式介绍"></a>4.3.1 网络模式介绍</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker66.png" srcset="/blog/img/loading.gif"></p>
<p>Docker 的网络支持5种网络模式:</p>
<ul>
<li>none</li>
<li>bridge</li>
<li>host</li>
<li>container</li>
<li>network-name</li>
</ul>
<p>范例: 查看默认的网络模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker network ls</span><br>NETWORK ID          NAME                DRIVER              SCOPE<br>c1d3609830d6        bridge              bridge              <span class="hljs-built_in">local</span><br>dc26f609d476        host                host                <span class="hljs-built_in">local</span><br>51a2adcbb6c1        none                null                <span class="hljs-built_in">local</span><br></code></pre></td></tr></table></figure>

<h3 id="4-3-2-网络模式指定"><a href="#4-3-2-网络模式指定" class="headerlink" title="4.3.2 网络模式指定"></a>4.3.2 网络模式指定</h3><p>默认新建的容器使用Bridge模式，创建容器时，docker run 命令使用以下选项指定网络模式</p>
<p>格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run --network &lt;mode&gt;<br>docker run --net=&lt;mode&gt;<br><br>&lt;mode&gt;: 可是以下值<br>none<br>bridge<br>host<br>container:&lt;容器名或容器ID&gt;<br>&lt;自定义网络名称&gt;<br></code></pre></td></tr></table></figure>

<h3 id="4-3-3-bridge网络模式"><a href="#4-3-3-bridge网络模式" class="headerlink" title="4.3.3 bridge网络模式"></a>4.3.3 bridge网络模式</h3><h4 id="4-3-3-1-bridge-网络模式架构"><a href="#4-3-3-1-bridge-网络模式架构" class="headerlink" title="4.3.3.1 bridge 网络模式架构"></a>4.3.3.1 bridge 网络模式架构</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker67.png" srcset="/blog/img/loading.gif"></p>
<p>本模式是docker的默认模式，即不指定任何模式就是bridge模式，也是使用比较多的模式，此模式创建的容器会为每一个容器分配自己的网络 IP 等信息，并将容器连接到一个虚拟网桥与外界通信</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker68.png" srcset="/blog/img/loading.gif"></p>
<p>可以和外部网络之间进行通信，通过SNAT访问外网，使用DNAT可以让容器被外部主机访问，所以此模式也称为NAT模式</p>
<p>此模式宿主机需要启动ip_forward功能</p>
<p>bridge网络模式特点</p>
<ul>
<li>网络资源隔离: 不同宿主机的容器无法直接通信，各自使用独立网络</li>
<li>无需手动配置: 容器默认自动获取172.17.0.0/16的IP地址，此地址可以修改</li>
<li>可访问外网: 利用宿主机的物理网卡，SNAT连接外网</li>
<li>外部主机无法直接访问容器: 可以通过配置DNAT接受外网的访问</li>
<li>低性能较低: 因为可通过NAT，网络转换带来更的损耗</li>
<li>端口管理繁琐: 每个容器必须手动指定唯一的端口，容器产生端口冲容</li>
</ul>
<h4 id="4-3-3-2-bridge-模式的默认设置"><a href="#4-3-3-2-bridge-模式的默认设置" class="headerlink" title="4.3.3.2 bridge 模式的默认设置"></a>4.3.3.2 bridge 模式的默认设置</h4><p>范例: 查看bridge模式信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker network inspect bridge</span><br>[<br>    &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>        <span class="hljs-string">&quot;Id&quot;</span>: <span class="hljs-string">&quot;c1d3609830d62b2d7e6bdb16205beace2d9aad5df7299d2362dc0470b777558e&quot;</span>,<br>        <span class="hljs-string">&quot;Created&quot;</span>: <span class="hljs-string">&quot;2021-07-01T20:54:41.495944865+08:00&quot;</span>,<br>        <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>        <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>        <span class="hljs-string">&quot;EnableIPv6&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;IPAM&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>            <span class="hljs-string">&quot;Options&quot;</span>: null,<br>            <span class="hljs-string">&quot;Config&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;172.17.0.0/16&quot;</span>,<br>                    <span class="hljs-string">&quot;Gateway&quot;</span>: <span class="hljs-string">&quot;172.17.0.1&quot;</span><br>                &#125;<br>            ]<br>        &#125;,<br>        <span class="hljs-string">&quot;Internal&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Attachable&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Ingress&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;ConfigFrom&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;ConfigOnly&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Containers&quot;</span>: &#123;&#125;,<br>        <span class="hljs-string">&quot;Options&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;com.docker.network.bridge.default_bridge&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>            <span class="hljs-string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>            <span class="hljs-string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>            <span class="hljs-string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span>: <span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>            <span class="hljs-string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="hljs-string">&quot;docker0&quot;</span>,<br>            <span class="hljs-string">&quot;com.docker.network.driver.mtu&quot;</span>: <span class="hljs-string">&quot;1500&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;<br>    &#125;<br>]<br>[root@ubuntu1804 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>范例: 宿主机的网络状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装docker后.默认启用ip_forward</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cat /proc/sys/net/ipv4/ip_forward</span><br>1<br>[root@ubuntu1804 ~]<span class="hljs-comment">#iptables -vnL -t nat</span><br>Chain PREROUTING (policy ACCEPT 29 packets, 3561 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>    2   104 DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL<br><br>Chain INPUT (policy ACCEPT 2 packets, 104 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain OUTPUT (policy ACCEPT 30 packets, 2244 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>    0     0 DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL<br><br>Chain POSTROUTING (policy ACCEPT 37 packets, 2832 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>    2   106 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0           <br><br>Chain DOCKER (2 references)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>    0     0 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0<br></code></pre></td></tr></table></figure>

<p>范例: 通过宿主机的物理网卡利用SNAT访问外部网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在另一台主机上建立httpd服务器</span><br><span class="hljs-comment">#需要先安装httpd并开启</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl is-active httpd</span><br>active<br>[root@centos7 html]<span class="hljs-comment"># echo Website on 10.0.0.8 &gt; index.html</span><br><br><span class="hljs-comment">#启动容器，默认是bridge网络模式</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm alpine:3.11 sh</span><br>// <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>4: eth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br><span class="hljs-comment">#可能访问其它宿主机</span><br>/ <span class="hljs-comment"># ping 10.0.0.8</span><br>PING 10.0.0.8 (10.0.0.8): 56 data bytes<br>64 bytes from 10.0.0.8: seq=0 ttl=63 time=0.668 ms<br>64 bytes from 10.0.0.8: seq=1 ttl=63 time=0.300 ms<br>^C<br>--- 10.0.0.8 ping statistics ---<br>2 packets transmitted, 2 packets received, 0% packet loss<br>round-trip min/avg/max = 0.300/0.484/0.668 ms<br>/ <span class="hljs-comment"># ping www.baidu.com</span><br>PING www.baidu.com (182.61.200.7): 56 data bytes<br>64 bytes from 182.61.200.7: seq=0 ttl=127 time=54.221 ms<br>64 bytes from 182.61.200.7: seq=1 ttl=127 time=55.195 ms<br>^C<br>--- www.baidu.com ping statistics ---<br>2 packets transmitted, 2 packets received, 0% packet loss<br>round-trip min/avg/max = 54.221/54.708/55.195 ms<br>/ <span class="hljs-comment"># traceroute 10.0.0.8</span><br>traceroute to 10.0.0.8 (10.0.0.8), 30 hops max, 46 byte packets<br> 1  172.17.0.1 (172.17.0.1)  0.004 ms  0.004 ms  0.001 ms<br> 2  10.0.0.8 (10.0.0.8)  0.184 ms  0.118 ms  0.343 ms<br>/ <span class="hljs-comment"># wget -qO - 10.0.0.8</span><br>Website on 10.0.0.8<br>/ <span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         172.17.0.1      0.0.0.0         UG    0      0        0 eth0<br>172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0<br><br>[root@centos7 ~]<span class="hljs-comment">#curl 127.0.0.1</span><br>Website on 10.0.0.8<br><br>[root@centos7 ~]<span class="hljs-comment">#tail /var/log/httpd/access_log</span><br>127.0.0.1 - - [01/Feb/2020:19:31:16 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>10.0.0.100 - - [01/Feb/2020:19:31:21 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;Wget&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-3-3-修改默认的-bridge-模式网络配置"><a href="#4-3-3-3-修改默认的-bridge-模式网络配置" class="headerlink" title="4.3.3.3 修改默认的 bridge 模式网络配置"></a>4.3.3.3 修改默认的 bridge 模式网络配置</h4><p>范例: 修改bridge模式默认的网段方法1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:ab:53:42 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:feab:5342/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:a3:b8:0e:ab brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::42:a3ff:feb8:eab/64 scope link <br>       valid_lft forever preferred_lft forever<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm alpine sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>6: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment">#exit</span><br><br><span class="hljs-comment">#修改桥接地址</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#vim /lib/systemd/system/docker.service</span><br>ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --bip=10.100.0.1/24<br>[root@ubuntu1804 ~]<span class="hljs-comment">#systemctl daemon-reload</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#systemctl restart docker</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:ab:53:42 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:feab:5342/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:a3:b8:0e:ab brd ff:ff:ff:ff:ff:ff<br>    inet 10.100.0.1/24 brd 10.100.0.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::42:a3ff:feb8:eab/64 scope link <br>       valid_lft forever preferred_lft forever<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm alpine sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:0a:64:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 10.100.0.2/24 brd 10.100.0.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># exit</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker network inspect bridge</span><br>[<br>    &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>        <span class="hljs-string">&quot;Id&quot;</span>: <span class="hljs-string">&quot;5b06993963ab02477fb037c06438432258a0d4e88183d7388c269ba0e45d86f2&quot;</span>,<br>        <span class="hljs-string">&quot;Created&quot;</span>: <span class="hljs-string">&quot;2021-07-02T09:29:47.559321694+08:00&quot;</span>,<br>        <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>        <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>        <span class="hljs-string">&quot;EnableIPv6&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;IPAM&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>            <span class="hljs-string">&quot;Options&quot;</span>: null,<br>            <span class="hljs-string">&quot;Config&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;10.100.0.0/24&quot;</span>,<br>                    <span class="hljs-string">&quot;Gateway&quot;</span>: <span class="hljs-string">&quot;10.100.0.1&quot;</span><br>                &#125;<br>            ]<br>        &#125;,<br>        <span class="hljs-string">&quot;Internal&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Attachable&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Ingress&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;ConfigFrom&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;ConfigOnly&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Containers&quot;</span>: &#123;&#125;,<br>        <span class="hljs-string">&quot;Options&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;com.docker.network.bridge.default_bridge&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>            <span class="hljs-string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>            <span class="hljs-string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>            <span class="hljs-string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span>: <span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>            <span class="hljs-string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="hljs-string">&quot;docker0&quot;</span>,<br>            <span class="hljs-string">&quot;com.docker.network.driver.mtu&quot;</span>: <span class="hljs-string">&quot;1500&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;<br>    &#125;<br>]<br>[root@ubuntu1804 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>范例: 修改bridge网络配置方法2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#vim /etc/docker/daemon.json</span><br>&#123;<br> <span class="hljs-string">&quot;hosts&quot;</span>: [<span class="hljs-string">&quot;tcp://0.0.0.0:2375&quot;</span>, <span class="hljs-string">&quot;fd://&quot;</span>],<br> <span class="hljs-string">&quot;bip&quot;</span>: <span class="hljs-string">&quot;192.168.100.100/24&quot;</span>,     <span class="hljs-comment">#分配docker0网卡的IP,24是容器IP的netmask</span><br> <span class="hljs-string">&quot;fixed-cidr&quot;</span>: <span class="hljs-string">&quot;192.168.100.128/26&quot;</span>, <span class="hljs-comment">#分配容器IP范围,26不是容器IP的子网掩码,只表示地址范围</span><br> <span class="hljs-string">&quot;fixed-cidr-v6&quot;</span>: <span class="hljs-string">&quot;2001:db8::/64&quot;</span>,<br> <span class="hljs-string">&quot;mtu&quot;</span>: 1500,<br> <span class="hljs-string">&quot;default-gateway&quot;</span>: <span class="hljs-string">&quot;192.168.100.200&quot;</span>,  <span class="hljs-comment">#网关必须和bip在同一个网段</span><br> <span class="hljs-string">&quot;default-gateway-v6&quot;</span>: <span class="hljs-string">&quot;2001:db8:abcd::89&quot;</span>,<br> <span class="hljs-string">&quot;dns&quot;</span>: [ <span class="hljs-string">&quot;1.1.1.1&quot;</span>, <span class="hljs-string">&quot;8.8.8.8&quot;</span>]<br>&#125;<br>[root@ubuntu1804 ~]<span class="hljs-comment">#systemctl restart docker</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ip a show docker0</span><br>3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP<br>group default<br> link/ether 02:42:23:be:97:75 brd ff:ff:ff:ff:ff:ff<br> inet 192.168.100.100/24 brd 192.168.100.255 scope global docker0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::42:23ff:febe:9775/64 scope link<br>   valid_lft forever preferred_lft forever<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name b1 busybox</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br>36: eth0@if37: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue<br> link/ether 02:42:c0:a8:64:80 brd ff:ff:ff:ff:ff:ff<br> inet 192.168.100.128/24 brd 192.168.100.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># cat /etc/resolv.conf</span><br>search magedu.com magedu.org<br>nameserver 1.1.1.1<br>nameserver 8.8.8.8<br>/ <span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination   Gateway     Genmask     Flags Metric Ref  Use Iface<br>0.0.0.0     192.168.100.200 0.0.0.0     UG   0    0     0 eth0<br>192.168.100.0  0.0.0.0     255.255.255.0  U   0    0     0 eth0<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker network inspect bridge</span><br>[<br> &#123;<br>    <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>    <span class="hljs-string">&quot;Id&quot;</span>:<br><span class="hljs-string">&quot;381bc2df514b0901e2a7570708aa93a3af05f298f27d4d077b52a8b324fad66c&quot;</span>,<br>    <span class="hljs-string">&quot;Created&quot;</span>: <span class="hljs-string">&quot;2020-07-27T21:58:31.419420569+08:00&quot;</span>,<br>    <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>    <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>    <span class="hljs-string">&quot;EnableIPv6&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;IPAM&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>      <span class="hljs-string">&quot;Options&quot;</span>: null,<br>      <span class="hljs-string">&quot;Config&quot;</span>: [<br>       &#123;<br>          <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;192.168.100.0/24&quot;</span>,<br>          <span class="hljs-string">&quot;IPRange&quot;</span>: <span class="hljs-string">&quot;192.168.100.128/26&quot;</span>,<br>          <span class="hljs-string">&quot;Gateway&quot;</span>: <span class="hljs-string">&quot;192.168.100.100&quot;</span>,<br>          <span class="hljs-string">&quot;AuxiliaryAddresses&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;DefaultGatewayIPv4&quot;</span>: <span class="hljs-string">&quot;192.168.100.200&quot;</span><br>         &#125;<br>       &#125;,<br>       &#123;<br>          <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;2001:db8::/64&quot;</span>,<br>          <span class="hljs-string">&quot;AuxiliaryAddresses&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;DefaultGatewayIPv6&quot;</span>: <span class="hljs-string">&quot;2001:db8:abcd::89&quot;</span><br>         &#125;<br>       &#125;<br>     ]<br>   &#125;,<br>    <span class="hljs-string">&quot;Internal&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Attachable&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Ingress&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ConfigFrom&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>   &#125;,<br>    <span class="hljs-string">&quot;ConfigOnly&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Containers&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;2f16c9f5efc1eefe766f6ae6ba7fcfa3434e8f4876ecdcf48c3343acd9e45b2d&quot;</span>:<br>&#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;b1&quot;</span>,<br>        <span class="hljs-string">&quot;EndpointID&quot;</span>:<br><span class="hljs-string">&quot;0a0fdf3d786310dca53e04f0734b9f0eeaa79aac147c7a3c69ac8d04444570f3&quot;</span>,<br>        <span class="hljs-string">&quot;MacAddress&quot;</span>: <span class="hljs-string">&quot;02:42:c0:a8:64:80&quot;</span>,<br>        <span class="hljs-string">&quot;IPv4Address&quot;</span>: <span class="hljs-string">&quot;192.168.100.128/24&quot;</span>,<br>        <span class="hljs-string">&quot;IPv6Address&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>     &#125;<br>   &#125;,<br>    <span class="hljs-string">&quot;Options&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;com.docker.network.bridge.default_bridge&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span>: <span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="hljs-string">&quot;docker0&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.driver.mtu&quot;</span>: <span class="hljs-string">&quot;1500&quot;</span><br>   &#125;,<br>    <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;<br> &#125;<br>]<br></code></pre></td></tr></table></figure>

<h3 id="4-3-4-Host-模式"><a href="#4-3-4-Host-模式" class="headerlink" title="4.3.4 Host 模式"></a>4.3.4 Host 模式</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker69.png" srcset="/blog/img/loading.gif"></p>
<p>如果指定host模式启动的容器，那么新创建的容器不会创建自己的虚拟网卡，而是直接使用宿主机的网卡和IP地址，因此在容器里面查看到的IP信息就是宿主机的信息，访问容器的时候直接使用宿主机IP+容器端口即可，不过容器内除网络以外的其它资源，如: 文件系统、系统进程等仍然和宿主机保持隔离</p>
<p>此模式由于直接使用宿主机的网络无需转换，网络性能最高，但是各容器内使用的端口不能相同，多适用于运行容器端口比较固定的业务</p>
<p>Host 网络模式特点:</p>
<ul>
<li>使用参数 –network host 指定</li>
<li>共享宿主机网络</li>
<li>网络性能无损耗</li>
<li>网络故障排除相对简单</li>
<li>各容器网络无隔离</li>
<li>网络资源无法分别统计</li>
<li>端口管理困难: 容易产生端口冲突</li>
<li>不支持端口映射</li>
</ul>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看宿主机的网络设置</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ifconfig</span><br>docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500<br>        inet 10.100.0.1  netmask 255.255.255.0  broadcast 10.100.0.255<br>        inet6 fe80::42:a3ff:feb8:eab  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        ether 02:42:a3:b8:0e:ab  txqueuelen 0  (Ethernet)<br>        RX packets 40  bytes 2182 (2.1 KB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 55  bytes 10038 (10.0 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.101  netmask 255.255.0.0  broadcast 10.0.255.255<br>        inet6 fe80::20c:29ff:feab:5342  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        ether 00:0c:29:ab:53:42  txqueuelen 1000  (Ethernet)<br>        RX packets 9321  bytes 9750878 (9.7 MB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 5364  bytes 430500 (430.5 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 127.0.0.1  netmask 255.0.0.0<br>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;<br>        loop  txqueuelen 1000  (Local Loopback)<br>        RX packets 28  bytes 3116 (3.1 KB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 28  bytes 3116 (3.1 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#route -n</span><br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.2        0.0.0.0         UG    0      0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.0.0     U     0      0        0 eth0<br>10.100.0.0      0.0.0.0         255.255.255.0   U     0      0        0 docker0<br><br><span class="hljs-comment">#打开容器前确认宿主机的80/tcp端口没有打开</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ss -ntl|grep :80</span><br><br><span class="hljs-comment">#创建host模式的容器</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d --network host --name web1 nginx-ubuntu1804:1.16.1</span><br>2ec0231f3951a81b7815da1b59413ec7a5858d304481fcb0f64d10cb57e96f7a<br><br><span class="hljs-comment">#创建容器后，宿主机的80/tcp端口打开</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ss -ntlp|grep :80</span><br>LISTEN  0     128         0.0.0.0:80        0.0.0.0:*   <br>users:((<span class="hljs-string">&quot;nginx&quot;</span>,pid=43762,fd=6),(<span class="hljs-string">&quot;nginx&quot;</span>,pid=43737,fd=6))<br><br><span class="hljs-comment">#进入容器</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it web1 bash</span><br><br><span class="hljs-comment">#进入容器后仍显示宿主机的主机名提示符信息</span><br>[root@ubuntu1804 /]<span class="hljs-comment"># hostname</span><br>ubuntu1804<br>ocker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500<br>        inet 10.100.0.1  netmask 255.255.255.0  broadcast 10.100.0.255<br>        inet6 fe80::42:a3ff:feb8:eab  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        ether 02:42:a3:b8:0e:ab  txqueuelen 0  (Ethernet)<br>        RX packets 40  bytes 2182 (2.1 KB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 55  bytes 10038 (10.0 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.101  netmask 255.255.0.0  broadcast 10.0.255.255<br>        inet6 fe80::20c:29ff:feab:5342  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        ether 00:0c:29:ab:53:42  txqueuelen 1000  (Ethernet)<br>        RX packets 15392  bytes 16845630 (16.8 MB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 8749  bytes 677261 (677.2 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 127.0.0.1  netmask 255.0.0.0<br>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;<br>        loop  txqueuelen 1000  (Local Loopback)<br>        RX packets 42  bytes 4354 (4.3 KB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 42  bytes 4354 (4.3 KB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>[root@ubuntu1804 /]<span class="hljs-comment"># route -n</span><br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.2        0.0.0.0         UG    0      0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.0.0     U     0      0        0 eth0<br>10.100.0.0      0.0.0.0         255.255.255.0   U     0      0        0 docker0<br><br><span class="hljs-comment">#从容器访问远程主机</span><br>[root@ubuntu1804 /]<span class="hljs-comment"># curl 10.0.0.7</span><br>Website on 10.0.0.8<br><br><span class="hljs-comment">#查看远程主机的访问日志</span><br>[root@centos7 ~]<span class="hljs-comment">#tail -n1 /var/log/httpd/access_log</span><br>10.0.0.100 - - [01/Feb/2020:19:58:06 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br><br><span class="hljs-comment">#远程主机可以访问容器的web服务</span><br>[root@centos7 ~]<span class="hljs-comment">#curl 10.0.0.101/app/</span><br>Test Page <span class="hljs-keyword">in</span> app<br></code></pre></td></tr></table></figure>

<p>范例: host模式下端口映射无法实现</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#ss -ntl|grep :81</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d --network host --name web2 -p 81:80  nginx-ubuntu1804:1.16.1</span><br>WARNING: Published ports are discarded when using host network mode<br>5f89f9f99a333ecc3f21005146cdc7ea005cc09188a6e273b49f33aedd8170b9<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps -a</span><br>CONTAINER ID        IMAGE                     COMMAND             CREATED             STATUS                      PORTS               NAMES<br>5f89f9f99a33        nginx-ubuntu1804:1.16.1   <span class="hljs-string">&quot;nginx&quot;</span>             17 seconds ago      Exited (1) 14 seconds ago                       web2<br>2ec0231f3951        nginx-ubuntu1804:1.16.1   <span class="hljs-string">&quot;nginx&quot;</span>             9 minutes ago       Up 9 minutes                                    web1<br><br></code></pre></td></tr></table></figure>

<p>范例: 对比前面host模式的容器和bridge模式的端口映射</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker port web1</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker port web2</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d --network bridge -p 8001:80 --name web3 nginx-ubuntu1804:1.16.1</span><br>4095372b9a561704eac98ccef8041a80a2cdc2aa7b57d2798dec1a8dcb00c377<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker port web3</span><br>80/tcp -&gt; 0.0.0.0:8001<br></code></pre></td></tr></table></figure>

<h3 id="4-3-5-none-模式"><a href="#4-3-5-none-模式" class="headerlink" title="4.3.5 none 模式"></a>4.3.5 none 模式</h3><p>在使用none 模式后，Docker 容器不会进行任何网络配置，没有网卡、没有IP也没有路由，因此默认无法与外界通信，需要手动添加网卡配置IP等，所以极少使用</p>
<p>none模式特点</p>
<ul>
<li>使用参数 –network none 指定</li>
<li>默认无网络功能，无法和外部通信</li>
</ul>
<p>范例: 启动none模式的容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d --network none -p 8001:80 --name web1-none nginx-ubuntu1804:1.16.1</span><br>5207dcbd0aeea88548819267d3751135e337035475cf3cd63a5e1be6599c0208<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE                     COMMAND             CREATED             STATUS                      PORTS                           NAMES<br>7f093f4a1fb7        nginx-ubuntu1804:1.16.1   <span class="hljs-string">&quot;nginx&quot;</span>             7 seconds ago       Up 6 seconds                                                web1-none<br>bfc68db38ab2        nginx-ubuntu1804:1.16.1   <span class="hljs-string">&quot;nginx&quot;</span>             9 minutes ago       Up 9 minutes                443/tcp, 0.0.0.0:8001-&gt;80/tcp   web3<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker port web1-none</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it web1-none bash</span><br>[root@5207dcbd0aee /]<span class="hljs-comment"># ifconfig -a</span><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt; mtu 65536<br>   inet 127.0.0.1 netmask 255.0.0.0<br>   loop txqueuelen 1000 (Local Loopback)<br>   RX packets 0 bytes 0 (0.0 B)<br>   RX errors 0 dropped 0 overruns 0 frame 0<br>   TX packets 0 bytes 0 (0.0 B)<br>   TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0<br>   <br>[root@5207dcbd0aee /]<span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination   Gateway     Genmask     Flags Metric Ref  Use Iface<br>[root@5207dcbd0aee /]<span class="hljs-comment"># netstat -ntl</span><br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address      Foreign Address     State   <br>tcp     0    0 0.0.0.0:80        0.0.0.0:*        LISTEN  <br>[root@5207dcbd0aee /]<span class="hljs-comment"># ping www.baidu.com</span><br>ping: www.baidu.com: Name or service not known<br>[root@5207dcbd0aee /]<span class="hljs-comment"># ping 172.17.0.1</span><br>connect: Network is unreachable<br>[root@5207dcbd0aee /]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h3 id="4-3-6-Container-模式"><a href="#4-3-6-Container-模式" class="headerlink" title="4.3.6 Container 模式"></a>4.3.6 Container 模式</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker70.png" srcset="/blog/img/loading.gif"></p>
<p>使用此模式创建的容器需指定和一个已经存在的容器共享一个网络，而不是和宿主机共享网，新创建的容器不会创建自己的网卡也不会配置自己的IP，而是和一个被指定的已经存在的容器共享IP和端口范围，因此这个容器的端口不能和被指定容器的端口冲突，除了网络之外的文件系统、进程信息等仍然保持相互隔离，两个容器的进程可以通过lo网卡进行通信</p>
<p>Container 模式特点</p>
<ul>
<li>使用参数 –-network container:名称或ID 指定</li>
<li>与宿主机网络空间隔离</li>
<li>空器间共享网络空间</li>
<li>适合频繁的容器间的网络通信</li>
<li>直接使用对方的网络，较少使用</li>
</ul>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建第一个容器</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name server1 -p 80:80 alpine:3.11 sh</span><br>/ <span class="hljs-comment"># ifconfig</span><br>eth0   Link encap:Ethernet HWaddr 02:42:AC:11:00:02 <br>    inet addr:172.17.0.2 Bcast:172.17.255.255 Mask:255.255.0.0<br>    UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1<br>    RX packets:9 errors:0 dropped:0 overruns:0 frame:0<br>    TX packets:0 errors:0 dropped:0 overruns:0 carrier:0<br>    collisions:0 txqueuelen:0<br>    RX bytes:766 (766.0 B) TX bytes:0 (0.0 B)<br><br>lo    Link encap:Local Loopback <br>    inet addr:127.0.0.1 Mask:255.0.0.0<br>    UP LOOPBACK RUNNING MTU:65536 Metric:1<br>    RX packets:0 errors:0 dropped:0 overruns:0 frame:0<br>    TX packets:0 errors:0 dropped:0 overruns:0 carrier:0<br>    collisions:0 txqueuelen:1000<br>    RX bytes:0 (0.0 B) TX bytes:0 (0.0 B)<br><br>/ <span class="hljs-comment"># netstat -ntl</span><br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address      Foreign Address     State  <br>/ <span class="hljs-comment">#</span><br><br><span class="hljs-comment">#在另一个终端执行下面操作</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE               COMMAND             CREATED              STATUS              PORTS                NAMES<br>a7760a5f9f06        alpine:3.11         <span class="hljs-string">&quot;sh&quot;</span>                About a minute ago   Up About a minute   0.0.0.0:80-&gt;80/tcp   server1<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker port server1</span><br>80/tcp -&gt; 0.0.0.0:80<br><span class="hljs-comment">#无法访问web服务</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl 127.0.0.1/app/</span><br>curl: (52) Empty reply from server<br><br><span class="hljs-comment">#创建第二个容器，基于第一个容器的container的网络模式</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d --name server2 --network container:server1 nginx-ubuntu1804:1.16.1</span><br>7db90f38590ade11e1c833a8b2175810c71b3f222753c5177bb8b05952f08a7b<br><span class="hljs-comment">#可以访问web服务</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl 127.0.0.1/app/</span><br>Test Page <span class="hljs-keyword">in</span> app<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it server2 bash</span><br><span class="hljs-comment">#和第一个容器共享相同的网络</span><br>[root@4d342fac169f /]<span class="hljs-comment"># ifconfig</span><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500<br>   inet 172.17.0.2 netmask 255.255.0.0 broadcast 172.17.255.255<br>   ether 02:42:ac:11:00:02 txqueuelen 0 (Ethernet)<br>   RX packets 29 bytes 2231 (2.1 KiB)<br>   RX errors 0 dropped 0 overruns 0 frame 0<br>   TX packets 12 bytes 1366 (1.3 KiB)<br>   TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt; mtu 65536<br>   inet 127.0.0.1 netmask 255.0.0.0<br>   loop txqueuelen 1000 (Local Loopback)<br>   RX packets 10 bytes 860 (860.0 B)<br>   RX errors 0 dropped 0 overruns 0 frame 0<br>   TX packets 10 bytes 860 (860.0 B)<br>   TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0<br><br>[root@4d342fac169f /]<span class="hljs-comment"># netstat -ntl</span><br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address      Foreign Address     State   <br>tcp     0    0 0.0.0.0:80        0.0.0.0:*        LISTEN <br><br><span class="hljs-comment">#可访问外网</span><br>[root@4d342fac169f /]<span class="hljs-comment"># ping www.baidu.com</span><br>PING www.a.shifen.com (61.135.169.121) 56(84) bytes of data.<br>64 bytes from 61.135.169.121 (61.135.169.121): icmp_seq=1 ttl=127 time=3.99 ms<br>64 bytes from 61.135.169.121 (61.135.169.121): icmp_seq=2 ttl=127 time=5.03 ms<br>^C<br>--- www.a.shifen.com ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1002ms<br>rtt min/avg/max/mdev = 3.999/4.514/5.030/0.519 ms<br>[root@4d342fac169f /]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>范例: 第一个容器使用host网络模式,第二个容器与之共享网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d --name c1 --network host nginx-centos7.8:v5.0-1.18.0</span><br>5a60804f3917d82dfe32db140411cf475f20acce0fe4674d94e4557e1003d8e0<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name c2 --network container:c1 centos7.8:v1.0</span><br>[root@ubuntu1804 /]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br> link/ether 00:0c:29:63:8b:ac brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe63:8bac/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default<br> link/ether 02:42:24:86:98:fb brd ff:ff:ff:ff:ff:ff<br> inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::42:24ff:fe86:98fb/64 scope link<br>   valid_lft forever preferred_lft forever<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it c1 bash</span><br>[root@ubuntu1804 /]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br> link/ether 00:0c:29:63:8b:ac brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe63:8bac/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default<br> link/ether 02:42:24:86:98:fb brd ff:ff:ff:ff:ff:ff<br> inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::42:24ff:fe86:98fb/64 scope link<br>   valid_lft forever preferred_lft forever<br>[root@ubuntu1804 /]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>范例:第一个容器使用none网络模式,第二个容器与之共享网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d --name c1 --network none nginx-centos7.8:v5.0-1.18.0</span><br>caf5b57299c8359f21f30b8894c5f8496ff39b44ead6a732056000689cb0c91c<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name c2 --network container:c1 centos7.8:v1.0</span><br>[root@caf5b57299c8 /]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br>[root@caf5b57299c8 /]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h3 id="4-3-7-自定义网络模式"><a href="#4-3-7-自定义网络模式" class="headerlink" title="4.3.7 自定义网络模式"></a>4.3.7 自定义网络模式</h3><p>除了以上的网络模式，也可以自定义网络，使用自定义的网段地址，网关等信息</p>
<p><strong>注意: 自定义网络内的容器可以直接通过容器名进行相互的访问,而无需使用 –link</strong></p>
<p>可以使用自定义网络模式,实现不同集群应用的独立网络管理,而互不影响,而且在网一个网络内,可以直接利用容器名相互访问非常便利</p>
<h4 id="4-3-7-1-自定义网络实现"><a href="#4-3-7-1-自定义网络实现" class="headerlink" title="4.3.7.1 自定义网络实现"></a>4.3.7.1 自定义网络实现</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker network --help</span><br><br>Usage:	docker network COMMAND<br><br>Manage networks<br><br>Commands:<br>  connect     Connect a container to a network<br>  create      Create a network<br>  disconnect  Disconnect a container from a network<br>  inspect     Display detailed information on one or more networks<br>  ls          List networks<br>  prune       Remove all unused networks<br>  rm          Remove one or more networks<br><br>Run <span class="hljs-string">&#x27;docker network COMMAND --help&#x27;</span> <span class="hljs-keyword">for</span> more information on a <span class="hljs-built_in">command</span>.<br></code></pre></td></tr></table></figure>

<p>创建自定义网络:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker network create -d &lt;mode&gt; --subnet &lt;CIDR&gt; --gateway &lt;网关&gt; &lt;自定义网络名称&gt;<br><br><span class="hljs-comment">#注意mode不支持host和none</span><br></code></pre></td></tr></table></figure>

<p>查看自定义网络信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker network inspect &lt;自定义网络名称或网络ID&gt;<br></code></pre></td></tr></table></figure>

<p>引用自定议网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run --network &lt;自定义网络名称&gt; &lt;镜像名称&gt;<br></code></pre></td></tr></table></figure>

<p>删除自定义网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">doccker network rm &lt;自定义网络名称或网络ID&gt;<br></code></pre></td></tr></table></figure>

<h4 id="4-3-7-2-实战案例-自定义网络"><a href="#4-3-7-2-实战案例-自定义网络" class="headerlink" title="4.3.7.2 实战案例: 自定义网络"></a>4.3.7.2 实战案例: 自定义网络</h4><h5 id="4-3-7-2-1-创建自定义的网络"><a href="#4-3-7-2-1-创建自定义的网络" class="headerlink" title="4.3.7.2.1 创建自定义的网络"></a>4.3.7.2.1 创建自定义的网络</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker network create -d bridge --subnet 172.27.0.0/16 --gateway 172.27.0.1 test-net</span><br>f3308602221da0bb46c56361bdb81b28879afea4ca8ece0d545423f0315df572<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker network ls</span><br>NETWORK ID          NAME                DRIVER              SCOPE<br>1380df79916a        bridge              bridge              <span class="hljs-built_in">local</span><br>dc26f609d476        host                host                <span class="hljs-built_in">local</span><br>51a2adcbb6c1        none                null                <span class="hljs-built_in">local</span><br>f3308602221d        test-net            bridge              <span class="hljs-built_in">local</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker inspect test-net</span><br>[<br>    &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;test-net&quot;</span>,<br>        <span class="hljs-string">&quot;Id&quot;</span>: <span class="hljs-string">&quot;f3308602221da0bb46c56361bdb81b28879afea4ca8ece0d545423f0315df572&quot;</span>,<br>        <span class="hljs-string">&quot;Created&quot;</span>: <span class="hljs-string">&quot;2021-07-02T11:33:13.055168726+08:00&quot;</span>,<br>        <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>        <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>        <span class="hljs-string">&quot;EnableIPv6&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;IPAM&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>            <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>            <span class="hljs-string">&quot;Config&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;172.27.0.0/16&quot;</span>,<br>                    <span class="hljs-string">&quot;Gateway&quot;</span>: <span class="hljs-string">&quot;172.27.0.1&quot;</span><br>                &#125;<br>            ]<br>        &#125;,<br>        <span class="hljs-string">&quot;Internal&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Attachable&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Ingress&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;ConfigFrom&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;ConfigOnly&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Containers&quot;</span>: &#123;&#125;,<br>        <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>        <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;<br>    &#125;<br>]<br>[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:ab:53:42 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:feab:5342/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:ed:59:9a:44 brd ff:ff:ff:ff:ff:ff<br>    inet 10.100.0.1/24 brd 10.100.0.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::42:edff:fe59:9a44/64 scope link <br>       valid_lft forever preferred_lft forever<br><span class="hljs-comment">#新添加了一个虚拟网卡</span><br>8: br-f3308602221d: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:e0:2d:74:34 brd ff:ff:ff:ff:ff:ff<br>    inet 172.27.0.1/16 brd 172.27.255.255 scope global br-f3308602221d<br><br><span class="hljs-comment">#新加了一个网桥</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		STP enabled	interfaces<br>br-f3308602221d		8000.0242e02d7434	no		<br>docker0		8000.0242ed599a44	no		<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.2        0.0.0.0         UG    0      0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.0.0     U     0      0        0 eth0<br>10.100.0.0      0.0.0.0         255.255.255.0   U     0      0        0 docker0<br>172.27.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-f3308602221d<br></code></pre></td></tr></table></figure>

<p>4.3.7.2.2 利用自定义的网络创建容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm --network test-net alpine sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>9: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         172.27.0.1      0.0.0.0         UG    0      0        0 eth0<br>172.27.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0<br><br>/ <span class="hljs-comment"># cat /etc/resolv.conf</span><br>nameserver 127.0.0.11<br>options ndots:0<br><br>/ <span class="hljs-comment">#  ping -c1 www.baidu.com</span><br>PING www.baidu.com (182.61.200.6): 56 data bytes<br>64 bytes from 182.61.200.6: seq=0 ttl=127 time=54.696 ms<br><br>--- www.baidu.com ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 54.696/54.696/54.696 ms<br><br><span class="hljs-comment">#再开一个新终端窗口查看网络</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker inspect test-net</span><br>[<br>    &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;test-net&quot;</span>,<br>        <span class="hljs-string">&quot;Id&quot;</span>: <span class="hljs-string">&quot;f3308602221da0bb46c56361bdb81b28879afea4ca8ece0d545423f0315df572&quot;</span>,<br>        <span class="hljs-string">&quot;Created&quot;</span>: <span class="hljs-string">&quot;2021-07-02T11:33:13.055168726+08:00&quot;</span>,<br>        <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>        <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>        <span class="hljs-string">&quot;EnableIPv6&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;IPAM&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>            <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>            <span class="hljs-string">&quot;Config&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;172.27.0.0/16&quot;</span>,<br>                    <span class="hljs-string">&quot;Gateway&quot;</span>: <span class="hljs-string">&quot;172.27.0.1&quot;</span><br>                &#125;<br>            ]<br>        &#125;,<br>        <span class="hljs-string">&quot;Internal&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Attachable&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Ingress&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;ConfigFrom&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;ConfigOnly&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Containers&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;620572d112a991291b3a5ef65791549eece7be13db599d50af78f886d4c15ccb&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;loving_wilson&quot;</span>,<br>                <span class="hljs-string">&quot;EndpointID&quot;</span>: <span class="hljs-string">&quot;c6a130c41dea335de6eafee723f31a9de9b9c3a1c40d3f1986b4ce79f0f955b9&quot;</span>,<br>                <span class="hljs-string">&quot;MacAddress&quot;</span>: <span class="hljs-string">&quot;02:42:ac:1b:00:02&quot;</span>,<br>                <span class="hljs-string">&quot;IPv4Address&quot;</span>: <span class="hljs-string">&quot;172.27.0.2/16&quot;</span>,<br>                <span class="hljs-string">&quot;IPv6Address&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>            &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>        <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;<br>    &#125;<br>]<br></code></pre></td></tr></table></figure>

<h4 id="4-3-7-3-实战案例-自定义网络中的容器之间通信"><a href="#4-3-7-3-实战案例-自定义网络中的容器之间通信" class="headerlink" title="4.3.7.3 实战案例: 自定义网络中的容器之间通信"></a>4.3.7.3 实战案例: 自定义网络中的容器之间通信</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker network ls</span><br>NETWORK ID          NAME                DRIVER              SCOPE<br>1380df79916a        bridge              bridge              <span class="hljs-built_in">local</span><br>dc26f609d476        host                host                <span class="hljs-built_in">local</span><br>51a2adcbb6c1        none                null                <span class="hljs-built_in">local</span><br>f3308602221d        test-net            bridge              <span class="hljs-built_in">local</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm --network test-net --name test1 alpine sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>13: eth0@if14: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1	localhost<br>::1	localhost ip6-localhost ip6-loopback<br>fe00::0	ip6-localnet<br>ff00::0	ip6-mcastprefix<br>ff02::1	ip6-allnodes<br>ff02::2	ip6-allrouters<br>172.27.0.2	b5dd7f34e229<br><br><span class="hljs-comment">#等后面步骤中容器test2创建好可以再访问</span><br>/ <span class="hljs-comment"># ping -c1 test2</span><br>PING test2 (172.27.0.3): 56 data bytes<br>64 bytes from 172.27.0.3: seq=0 ttl=64 time=0.072 ms<br><br>--- test2 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.072/0.072/0.072 ms<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm --network test-net --name test2 alpine</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br>25: eth0@if26: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue<br>state UP<br> link/ether 02:42:ac:1b:00:03 brd ff:ff:ff:ff:ff:ff<br> inet 172.27.0.3/16 brd 172.27.255.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1 localhost<br>::1 localhost ip6-localhost ip6-loopback<br>fe00::0 ip6-localnet<br>ff00::0 ip6-mcastprefix<br>ff02::1 ip6-allnodes<br>ff02::2 ip6-allrouters<br>172.27.0.3 305fd14a4b70<br><br>/ <span class="hljs-comment"># ping -c1 test1</span><br>PING test1 (172.27.0.2): 56 data bytes<br>64 bytes from 172.27.0.2: seq=0 ttl=64 time=0.074 ms<br><br>--- test1 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.074/0.074/0.074 ms<br></code></pre></td></tr></table></figure>

<p><strong>结论: 自定义网络中的容器之间可以直接利用容器名进行通信</strong></p>
<h4 id="4-3-7-4-实战案例-利用自定义网络实现-Redis-Cluster"><a href="#4-3-7-4-实战案例-利用自定义网络实现-Redis-Cluster" class="headerlink" title="4.3.7.4 实战案例: 利用自定义网络实现 Redis Cluster"></a>4.3.7.4 实战案例: 利用自定义网络实现 Redis Cluster</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker71.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-3-7-4-1-创建自定义网络"><a href="#4-3-7-4-1-创建自定义网络" class="headerlink" title="4.3.7.4.1 创建自定义网络"></a>4.3.7.4.1 创建自定义网络</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker network create net-redis --subnet 172.18.0.0/16</span><br>ffcc6b0d34a0172e1df999cca9c8fd94acbde118eeaf1c02c98602413aba0aef<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker inspect net-redis</span><br>[<br>    &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;net-redis&quot;</span>,<br>        <span class="hljs-string">&quot;Id&quot;</span>: <span class="hljs-string">&quot;ffcc6b0d34a0172e1df999cca9c8fd94acbde118eeaf1c02c98602413aba0aef&quot;</span>,<br>        <span class="hljs-string">&quot;Created&quot;</span>: <span class="hljs-string">&quot;2021-07-02T11:47:53.305603244+08:00&quot;</span>,<br>        <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>        <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>        <span class="hljs-string">&quot;EnableIPv6&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;IPAM&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>            <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>            <span class="hljs-string">&quot;Config&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;172.18.0.0/16&quot;</span><br>                &#125;<br>            ]<br>        &#125;,<br>        <span class="hljs-string">&quot;Internal&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Attachable&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Ingress&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;ConfigFrom&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;ConfigOnly&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-string">&quot;Containers&quot;</span>: &#123;&#125;,<br>        <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>        <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;<br>    &#125;<br>]<br></code></pre></td></tr></table></figure>

<h5 id="4-3-7-4-2-创建6个redis容器配置"><a href="#4-3-7-4-2-创建6个redis容器配置" class="headerlink" title="4.3.7.4.2 创建6个redis容器配置"></a>4.3.7.4.2 创建6个redis容器配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 通过脚本创建六个redis容器配置</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#vim create_redis_init.sh</span><br><span class="hljs-comment">#/bin/bash</span><br><span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> &#123;1..6&#125;;<span class="hljs-keyword">do</span><br>mkdir -p /data/redis/node-<span class="hljs-variable">$&#123;port&#125;</span>/conf<br>cat &gt;&gt; /data/redis/node-<span class="hljs-variable">$&#123;port&#125;</span>/conf/redis.conf &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">port 6379</span><br><span class="hljs-string">bind 0.0.0.0</span><br><span class="hljs-string">masterauth 123456</span><br><span class="hljs-string">requirepass 123456</span><br><span class="hljs-string">cluster-enabled yes</span><br><span class="hljs-string">cluster-config-file nodes.conf</span><br><span class="hljs-string">cluster-node-timeout 5000</span><br><span class="hljs-string">cluster-announce-ip 172.18.0.1$&#123;port&#125;</span><br><span class="hljs-string">cluster-announce-port 6379</span><br><span class="hljs-string">cluster-announce-bus-port 16379</span><br><span class="hljs-string">appendonly yes</span><br><span class="hljs-string">EOF</span><br><span class="hljs-keyword">done</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#chmod +x create_redis_init.sh</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#./create_redis_init.sh</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#tree /data/redis/</span><br>/data/redis/<br>├── node-1<br>│  └── conf<br>│    └── redis.conf<br>├── node-2<br>│  └── conf<br>│    └── redis.conf<br>├── node-3<br>│  └── conf<br>│    └── redis.conf<br>├── node-4<br>│  └── conf<br>│    └── redis.conf<br>├── node-5<br>│  └── conf<br>│    └── redis.conf<br>└── node-6<br> └── conf<br>   └── redis.conf<br>12 directories, 6 files<br>[root@ubuntu1804 ~]<span class="hljs-comment">#cat /data/redis/node-1/conf/redis.conf</span><br>port 6379<br><span class="hljs-built_in">bind</span> 0.0.0.0<br>masterauth 123456<br>requirepass 123456<br>cluster-enabled yes<br>cluster-config-file nodes.conf<br>cluster-node-timeout 5000<br>cluster-announce-ip 172.18.0.11<br>cluster-announce-port 6379<br>cluster-announce-bus-port 16379<br>appendonly yes<br></code></pre></td></tr></table></figure>

<h5 id="4-3-7-4-3-创建6个-redis-容器"><a href="#4-3-7-4-3-创建6个-redis-容器" class="headerlink" title="4.3.7.4.3 创建6个 redis 容器"></a>4.3.7.4.3 创建6个 redis 容器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 通过脚本运行六个redis容器</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#vim create_redis_container.sh</span><br><span class="hljs-comment">#/bin/bash</span><br><span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> &#123;1..6&#125;;<span class="hljs-keyword">do</span><br>docker run -p 637<span class="hljs-variable">$&#123;port&#125;</span>:6379 -p 1667<span class="hljs-variable">$&#123;port&#125;</span>:16379 --name redis-<span class="hljs-variable">$&#123;port&#125;</span> \<br>-v /data/redis/node-<span class="hljs-variable">$&#123;port&#125;</span>/data:/data \<br>-v /data/redis/node-<span class="hljs-variable">$&#123;port&#125;</span>/conf/redis.conf:/etc/redis/redis.conf \<br>-d --net net-redis --ip 172.18.0.1<span class="hljs-variable">$&#123;port&#125;</span> redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf<br><span class="hljs-keyword">done</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#chmod +x create_redis_container.sh</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#./create_redis_container.sh</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE                    COMMAND                  CREATED             STATUS              PORTS                                              NAMES<br>90d9e9c016f9        redis:5.0.9-alpine3.11   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   17 minutes ago      Up 17 minutes       0.0.0.0:6376-&gt;6379/tcp, 0.0.0.0:16676-&gt;16379/tcp   redis-6<br>f3dfa523f125        redis:5.0.9-alpine3.11   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   17 minutes ago      Up 17 minutes       0.0.0.0:6375-&gt;6379/tcp, 0.0.0.0:16675-&gt;16379/tcp   redis-5<br>47e4ba82f369        redis:5.0.9-alpine3.11   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   17 minutes ago      Up 17 minutes       0.0.0.0:6374-&gt;6379/tcp, 0.0.0.0:16674-&gt;16379/tcp   redis-4<br>352b5c6136c0        redis:5.0.9-alpine3.11   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   17 minutes ago      Up 17 minutes       0.0.0.0:6373-&gt;6379/tcp, 0.0.0.0:16673-&gt;16379/tcp   redis-3<br>54b6a42b9560        redis:5.0.9-alpine3.11   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   17 minutes ago      Up 17 minutes       0.0.0.0:6372-&gt;6379/tcp, 0.0.0.0:16672-&gt;16379/tcp   redis-2<br>6fdd17947a37        redis:5.0.9-alpine3.11   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   17 minutes ago      Up 17 minutes       0.0.0.0:6371-&gt;6379/tcp, 0.0.0.0:16671-&gt;16379/tcp   redis-1<br></code></pre></td></tr></table></figure>

<h5 id="4-3-7-4-4-创建-redis-cluster"><a href="#4-3-7-4-4-创建-redis-cluster" class="headerlink" title="4.3.7.4.4 创建 redis cluster"></a>4.3.7.4.4 创建 redis cluster</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#连接redis cluster</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it redis-1 /bin/sh</span><br>/data <span class="hljs-comment"># redis-cli -a 123456</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>127.0.0.1:6379&gt; <span class="hljs-built_in">exit</span><br><span class="hljs-comment">#不支持 &#123; &#125; 扩展</span><br>/data <span class="hljs-comment"># echo &#123;1..10&#125;</span><br>&#123;1..10&#125;<br>/data <span class="hljs-comment"># echo $-</span><br>smi<br><br><span class="hljs-comment"># 创建集群</span><br>/data <span class="hljs-comment"># redis-cli -a 123456 --cluster create 172.18.0.11:6379 172.18.0.12:6379 172.18.0.13:6379 172.18.0.14:6379 172.18.0.15:6379 172.18.0.16:6379 --cluster-replicas 1</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>&gt;&gt;&gt; Performing <span class="hljs-built_in">hash</span> slots allocation on 6 nodes...<br>Master[0] -&gt; Slots 0 - 5460<br>Master[1] -&gt; Slots 5461 - 10922<br>Master[2] -&gt; Slots 10923 - 16383<br>Adding replica 172.18.0.15:6379 to 172.18.0.11:6379<br>Adding replica 172.18.0.16:6379 to 172.18.0.12:6379<br>Adding replica 172.18.0.14:6379 to 172.18.0.13:6379<br>M: d2bdc38338880c376798aae6ec1e18c3e8f167fa 172.18.0.11:6379<br>   slots:[0-5460] (5461 slots) master<br>M: ae3568f705a76109d78610f94562897612aec1a5 172.18.0.12:6379<br>   slots:[5461-10922] (5462 slots) master<br>M: 0c8b54ae0876e8dc139d336c9c331f1aee1a1fb4 172.18.0.13:6379<br>   slots:[10923-16383] (5461 slots) master<br>S: 8ba8948c3bbb733167e892d8174d705f820888f8 172.18.0.14:6379<br>   replicates 0c8b54ae0876e8dc139d336c9c331f1aee1a1fb4<br>S: 6b44d720e5364901468465936426eb3e79dee98e 172.18.0.15:6379<br>   replicates d2bdc38338880c376798aae6ec1e18c3e8f167fa<br>S: c8594063c12e7826cd7983426b6eef05cf62b2b7 172.18.0.16:6379<br>   replicates ae3568f705a76109d78610f94562897612aec1a5<br>Can I <span class="hljs-built_in">set</span> the above configuration? (<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;yes&#x27;</span> to accept): yes <span class="hljs-comment">#输入yes</span><br>&gt;&gt;&gt; Nodes configuration updated<br>&gt;&gt;&gt; Assign a different config epoch to each node<br>&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster<br>Waiting <span class="hljs-keyword">for</span> the cluster to join<br>...<br>&gt;&gt;&gt; Performing Cluster Check (using node 172.18.0.11:6379)<br>M: d2bdc38338880c376798aae6ec1e18c3e8f167fa 172.18.0.11:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>M: ae3568f705a76109d78610f94562897612aec1a5 172.18.0.12:6379<br>   slots:[5461-10922] (5462 slots) master<br>   1 additional replica(s)<br>S: c8594063c12e7826cd7983426b6eef05cf62b2b7 172.18.0.16:6379<br>   slots: (0 slots) slave<br>   replicates ae3568f705a76109d78610f94562897612aec1a5<br>M: 0c8b54ae0876e8dc139d336c9c331f1aee1a1fb4 172.18.0.13:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>S: 8ba8948c3bbb733167e892d8174d705f820888f8 172.18.0.14:6379<br>   slots: (0 slots) slave<br>   replicates 0c8b54ae0876e8dc139d336c9c331f1aee1a1fb4<br>S: 6b44d720e5364901468465936426eb3e79dee98e 172.18.0.15:6379<br>   slots: (0 slots) slave<br>   replicates d2bdc38338880c376798aae6ec1e18c3e8f167fa<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br></code></pre></td></tr></table></figure>

<h5 id="4-3-7-4-5-测试访问-redis-cluster"><a href="#4-3-7-4-5-测试访问-redis-cluster" class="headerlink" title="4.3.7.4.5 测试访问 redis cluster"></a>4.3.7.4.5 测试访问 redis cluster</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#连接redis cluster</span><br>/data <span class="hljs-comment"># redis-cli -a 123456 -c</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>127.0.0.1:6379&gt; cluster info<br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:6<br>cluster_size:3<br>cluster_current_epoch:6<br>cluster_my_epoch:1<br>cluster_stats_messages_ping_sent:97<br>cluster_stats_messages_pong_sent:107<br>cluster_stats_messages_sent:204<br>cluster_stats_messages_ping_received:102<br>cluster_stats_messages_pong_received:97<br>cluster_stats_messages_meet_received:5<br>cluster_stats_messages_received:204<br><br>127.0.0.1:6379&gt; cluster nodes<br><span class="hljs-comment">#看到172.18.0.&#123;11,12,13&#125;为master,172.18.0.&#123;14,15,16&#125;为slave</span><br><span class="hljs-comment">#以下为master/slave关系</span><br><span class="hljs-comment">#172.18.0.11&lt;---&gt;172.18.0.15</span><br><span class="hljs-comment">#172.18.0.12&lt;---&gt;172.18.0.16</span><br><span class="hljs-comment">#172.18.0.13&lt;---&gt;172.18.0.14</span><br>ae3568f705a76109d78610f94562897612aec1a5 172.18.0.12:6379@16379 master - 0 1625199597278 2 connected 5461-10922<br>c8594063c12e7826cd7983426b6eef05cf62b2b7 172.18.0.16:6379@16379 slave ae3568f705a76109d78610f94562897612aec1a5 0 1625199597000 6 connected<br>0c8b54ae0876e8dc139d336c9c331f1aee1a1fb4 172.18.0.13:6379@16379 master - 0 1625199597584 3 connected 10923-16383<br>8ba8948c3bbb733167e892d8174d705f820888f8 172.18.0.14:6379@16379 slave 0c8b54ae0876e8dc139d336c9c331f1aee1a1fb4 0 1625199597000 4 connected<br>d2bdc38338880c376798aae6ec1e18c3e8f167fa 172.18.0.11:6379@16379 myself,master - 0 1625199598000 1 connected 0-5460<br>6b44d720e5364901468465936426eb3e79dee98e 172.18.0.15:6379@16379 slave d2bdc38338880c376798aae6ec1e18c3e8f167fa 0 1625199598294 5 connected<br><br><span class="hljs-comment">#添加key到redis-2上</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> name wang<br>-&gt; Redirected to slot [5798] located at 172.18.0.12:6379<br>OK<br><span class="hljs-comment">#添加key到redis-1上</span><br>172.18.0.12:6379&gt; <span class="hljs-built_in">set</span> title cto<br>-&gt; Redirected to slot [2217] located at 172.18.0.11:6379<br>OK<br><br>172.18.0.11:6379&gt; get name<br>-&gt; Redirected to slot [5798] located at 172.18.0.12:6379<br><span class="hljs-string">&quot;wang&quot;</span><br>172.18.0.12:6379&gt; get title<br>-&gt; Redirected to slot [2217] located at 172.18.0.11:6379<br><span class="hljs-string">&quot;cto&quot;</span><br></code></pre></td></tr></table></figure>

<h5 id="4-3-7-4-5-测试故障实现-redis-cluster-高可用性"><a href="#4-3-7-4-5-测试故障实现-redis-cluster-高可用性" class="headerlink" title="4.3.7.4.5 测试故障实现 redis cluster 高可用性"></a>4.3.7.4.5 测试故障实现 redis cluster 高可用性</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#模拟redis-2故障</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker stop redis-2</span><br>redis-2<br><br><span class="hljs-comment">#再次查看cluster状态,可以看到redis-2出错</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it redis-1 /bin/sh</span><br>/data <span class="hljs-comment"># redis-cli -a 123456 --cluster check 127.0.0.1:6379</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>Could not connect to Redis at 172.18.0.12:6379: Host is unreachable<br><span class="hljs-comment">#查看到 172.18.0.16提升为新的master</span><br>127.0.0.1:6379 (d2bdc383...) -&gt; 1 keys | 5461 slots | 1 slaves.<br>172.18.0.16:6379 (c8594063...) -&gt; 1 keys | 5462 slots | 0 slaves.<br>172.18.0.13:6379 (0c8b54ae...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>[OK] 2 keys <span class="hljs-keyword">in</span> 3 masters.<br>0.00 keys per slot on average.<br>&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:6379)<br>M: d2bdc38338880c376798aae6ec1e18c3e8f167fa 127.0.0.1:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>M: c8594063c12e7826cd7983426b6eef05cf62b2b7 172.18.0.16:6379<br>   slots:[5461-10922] (5462 slots) master<br>M: 0c8b54ae0876e8dc139d336c9c331f1aee1a1fb4 172.18.0.13:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>S: 8ba8948c3bbb733167e892d8174d705f820888f8 172.18.0.14:6379<br>   slots: (0 slots) slave<br>   replicates 0c8b54ae0876e8dc139d336c9c331f1aee1a1fb4<br>S: 6b44d720e5364901468465936426eb3e79dee98e 172.18.0.15:6379<br>   slots: (0 slots) slave<br>   replicates d2bdc38338880c376798aae6ec1e18c3e8f167fa<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All 16384 slots covered.<br><br>/data <span class="hljs-comment"># redis-cli -a 123456 -c</span><br>Warning: Using a password with <span class="hljs-string">&#x27;-a&#x27;</span> or <span class="hljs-string">&#x27;-u&#x27;</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<br>127.0.0.1:6379&gt; cluster nodes<br>ae3568f705a76109d78610f94562897612aec1a5 172.18.0.12:6379@16379 master,fail - 1625199696343 1625199695836 2 connected<br>c8594063c12e7826cd7983426b6eef05cf62b2b7 172.18.0.16:6379@16379 master - 0 1625199967000 7 connected 5461-10922<br>0c8b54ae0876e8dc139d336c9c331f1aee1a1fb4 172.18.0.13:6379@16379 master - 0 1625199967000 3 connected 10923-16383<br>8ba8948c3bbb733167e892d8174d705f820888f8 172.18.0.14:6379@16379 slave 0c8b54ae0876e8dc139d336c9c331f1aee1a1fb4 0 1625199967559 4 connected<br>d2bdc38338880c376798aae6ec1e18c3e8f167fa 172.18.0.11:6379@16379 myself,master - 0 1625199967000 1 connected 0-5460<br>6b44d720e5364901468465936426eb3e79dee98e 172.18.0.15:6379@16379 slave d2bdc38338880c376798aae6ec1e18c3e8f167fa 0 1625199966128 5 connected<br>127.0.0.1:6379&gt; get name<br>-&gt; Redirected to slot [5798] located at 172.18.0.16:6379<br><span class="hljs-string">&quot;wang&quot;</span><br>172.18.0.16:6379&gt; get title<br>-&gt; Redirected to slot [2217] located at 172.18.0.15:6379<br><span class="hljs-string">&quot;cto&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="4-3-8-同一个宿主机之间不同网络的容器通信"><a href="#4-3-8-同一个宿主机之间不同网络的容器通信" class="headerlink" title="4.3.8 同一个宿主机之间不同网络的容器通信"></a>4.3.8 同一个宿主机之间不同网络的容器通信</h3><p>开两个容器，一个使用自定义网络容器，一个使用默认brideg网络的容器,默认因iptables规则导致无法通信</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker72.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm --name test1 alpine sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP<br>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping 172.27.0.2  #无法ping通自定义网络容器</span><br>PING 172.27.0.2 (172.27.0.2): 56 data bytes<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --rm --network test-net --name test2 alpine sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br>21: eth0@if22: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue<br>state UP<br> link/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff<br> inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping 172.17.0.2  #无法ping 通默认的网络容器</span><br>PING 172.27.0.2 (172.17.0.2): 56 data bytes<br></code></pre></td></tr></table></figure>

<h4 id="4-3-8-1-实战案例-1-修改iptables实现同一宿主机上的不同网络的容器间通信"><a href="#4-3-8-1-实战案例-1-修改iptables实现同一宿主机上的不同网络的容器间通信" class="headerlink" title="4.3.8.1 实战案例 1: 修改iptables实现同一宿主机上的不同网络的容器间通信"></a>4.3.8.1 实战案例 1: 修改iptables实现同一宿主机上的不同网络的容器间通信</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#确认开启ip_forward</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cat /proc/sys/net/ipv4/ip_forward</span><br>1<br><br><span class="hljs-comment">#默认网络和自定义网络是两个不同的网桥</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		STP enabled	interfaces<br>br-f3308602221d		8000.0242e02d7434	no		<br>br-ffcc6b0d34a0		8000.0242b2d19ca7	no		<br>docker0		8000.0242ed599a44	no<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#iptables -vnL</span><br>Chain INPUT (policy ACCEPT 435 packets, 27008 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>27301   31M DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0           <br>27301   31M DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0           <br>26714   31M ACCEPT     all  --  *      br-ffcc6b0d34a0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED<br>  585 35100 DOCKER     all  --  *      br-ffcc6b0d34a0  0.0.0.0/0            0.0.0.0/0           <br>    0     0 ACCEPT     all  --  br-ffcc6b0d34a0 !br-ffcc6b0d34a0  0.0.0.0/0            0.0.0.0/0           <br>  585 35100 ACCEPT     all  --  br-ffcc6b0d34a0 br-ffcc6b0d34a0  0.0.0.0/0            0.0.0.0/0           <br>    5   486 ACCEPT     all  --  *      br-f3308602221d  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED<br>    2   168 DOCKER     all  --  *      br-f3308602221d  0.0.0.0/0            0.0.0.0/0           <br>    5   370 ACCEPT     all  --  br-f3308602221d !br-f3308602221d  0.0.0.0/0            0.0.0.0/0           <br>    2   168 ACCEPT     all  --  br-f3308602221d br-f3308602221d  0.0.0.0/0            0.0.0.0/0           <br>    0     0 ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED<br>    0     0 DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           <br>    0     0 ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           <br>    0     0 ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0           <br><br>Chain OUTPUT (policy ACCEPT 316 packets, 32256 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain DOCKER (3 references)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain DOCKER-ISOLATION-STAGE-1 (1 references)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>    0     0 DOCKER-ISOLATION-STAGE-2  all  --  br-ffcc6b0d34a0 !br-ffcc6b0d34a0  0.0.0.0/0            0.0.0.0/0           <br>    5   370 DOCKER-ISOLATION-STAGE-2  all  --  br-f3308602221d !br-f3308602221d  0.0.0.0/0            0.0.0.0/0           <br>    0     0 DOCKER-ISOLATION-STAGE-2  all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           <br>27311   31M RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           <br><br>Chain DOCKER-ISOLATION-STAGE-2 (3 references)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>    0     0 DROP       all  --  *      br-ffcc6b0d34a0  0.0.0.0/0            0.0.0.0/0           <br>    0     0 DROP       all  --  *      br-f3308602221d  0.0.0.0/0            0.0.0.0/0           <br>    0     0 DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           <br>    5   370 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           <br><br>Chain DOCKER-USER (1 references)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>27311   31M RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0<br>   <br>[root@ubuntu1804 ~]<span class="hljs-comment">#</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#iptables-save</span><br><span class="hljs-comment"># Generated by iptables-save v1.6.1 on Sun Feb 2 14:33:19 2020</span><br>*filter<br>:INPUT ACCEPT [1283:90246]<br>:FORWARD DROP [0:0]<br>:OUTPUT ACCEPT [1489:217126]<br>:DOCKER - [0:0]<br>:DOCKER-ISOLATION-STAGE-1 - [0:0]<br>:DOCKER-ISOLATION-STAGE-2 - [0:0]<br>:DOCKER-USER - [0:0]<br>-A FORWARD -j DOCKER-USER<br>-A FORWARD -j DOCKER-ISOLATION-STAGE-1<br>-A FORWARD -o br-c90dee3b7937 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT<br>-A FORWARD -o br-c90dee3b7937 -j DOCKER<br>-A FORWARD -i br-c90dee3b7937 ! -o br-c90dee3b7937 -j ACCEPT<br>-A FORWARD -i br-c90dee3b7937 -o br-c90dee3b7937 -j ACCEPT<br>-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT<br>-A FORWARD -o docker0 -j DOCKER<br>-A FORWARD -i docker0 ! -o docker0 -j ACCEPT<br>-A FORWARD -i docker0 -o docker0 -j ACCEPT<br>-A DOCKER-ISOLATION-STAGE-1 -i br-c90dee3b7937 ! -o br-c90dee3b7937 -j DOCKER-ISOLATION-STAGE-2<br>-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2<br>-A DOCKER-ISOLATION-STAGE-1 -j RETURN<br>-A DOCKER-ISOLATION-STAGE-2 -o br-c90dee3b7937 -j DROP <span class="hljs-comment">#注意此行规则</span><br>-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP  <span class="hljs-comment">#注意此行规则</span><br>-A DOCKER-ISOLATION-STAGE-2 -j RETURN<br>-A DOCKER-USER -j RETURN COMMIT<br><span class="hljs-comment"># Completed on Sun Feb 2 14:33:19 2020</span><br><span class="hljs-comment"># Generated by iptables-save v1.6.1 on Sun Feb 2 14:33:19 2020</span><br>*nat<br>:PREROUTING ACCEPT [887:75032]<br>:INPUT ACCEPT [6:1028]<br>:OUTPUT ACCEPT [19:1444]<br>:POSTROUTING ACCEPT [19:1444]<br>:DOCKER - [0:0]<br>-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER<br>-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER<br>-A POSTROUTING -s 172.27.0.0/16 ! -o br-c90dee3b7937 -j MASQUERADE<br>-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE<br>-A DOCKER -i br-c90dee3b7937 -j RETURN<br>-A DOCKER -i docker0 -j RETURN<br>COMMIT<br><span class="hljs-comment"># Completed on Sun Feb 2 14:33:19 2020</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#iptables-save &gt; iptables.rule</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#vim iptables.rule</span><br><span class="hljs-comment">#修改下面两行的规则，约29，30行</span><br>-A DOCKER-ISOLATION-STAGE-2 -o br-c90dee3b7937 -j ACCEPT<br>-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j ACCEPT<br><span class="hljs-comment">#或者执行下面命令</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#iptables -I DOCKER-ISOLATION-STAGE-2 -j ACCEPT</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#iptables-restore &lt; iptables.rule</span><br><br><span class="hljs-comment">#再次两个容器之间可以相互通信</span><br>/ <span class="hljs-comment"># ping 172.27.0.2</span><br>PING 172.27.0.2 (172.27.0.2): 56 data bytes<br>64 bytes from 172.27.0.2: seq=896 ttl=63 time=0.502 ms<br>64 bytes from 172.27.0.2: seq=897 ttl=63 time=0.467 ms<br>64 bytes from 172.27.0.2: seq=898 ttl=63 time=0.227 ms<br><br>/ <span class="hljs-comment"># ping 172.17.0.2</span><br>PING 172.17.0.2 (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=63 time=0.163 ms<br>64 bytes from 172.17.0.2: seq=1 ttl=63 time=0.232 ms<br></code></pre></td></tr></table></figure>

<h4 id="4-3-8-2-实战案例-2-通过解决docker-network-connect-实现同一个宿主机不同网络的容器间通信"><a href="#4-3-8-2-实战案例-2-通过解决docker-network-connect-实现同一个宿主机不同网络的容器间通信" class="headerlink" title="4.3.8.2 实战案例 2: 通过解决docker network connect 实现同一个宿主机不同网络的容器间通信"></a>4.3.8.2 实战案例 2: 通过解决docker network connect 实现同一个宿主机不同网络的容器间通信</h4><p>可以使用docker netowrk connect命令实现同一个宿主机不同网络的容器间相互通信</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#将CONTAINER连入指定的NETWORK中,使此CONTAINER可以与NETWORK中的其它容器进行通信</span><br>docker network connect [OPTIONS] NETWORK CONTAINER<br>Connect a container to a network<br>Options:<br>   --<span class="hljs-built_in">alias</span> strings      Add network-scoped <span class="hljs-built_in">alias</span> <span class="hljs-keyword">for</span> the container<br>   --driver-opt strings   driver options <span class="hljs-keyword">for</span> the network<br>   --ip string        IPv4 address (e.g., 172.30.100.104)<br>   --ip6 string       IPv6 address (e.g., 2001:db8::33)<br>   --link list        Add link to another container<br>   --link-local-ip strings  Add a link-local address <span class="hljs-keyword">for</span> the container<br>  <br><span class="hljs-comment">#将CONTAINER与指定的NETWORK断开连接,使此CONTAINER可以与CONTAINER中的其它容器进行无法通信</span><br>docker network disconnect [OPTIONS] NETWORK CONTAINER<br><br>Disconnect a container from a network<br><br>Options:<br> -f, --force  Force the container to disconnect from a network<br></code></pre></td></tr></table></figure>

<h5 id="4-3-8-2-1-上面案例中test1和test2的容器间默认无法通信"><a href="#4-3-8-2-1-上面案例中test1和test2的容器间默认无法通信" class="headerlink" title="4.3.8.2.1 上面案例中test1和test2的容器间默认无法通信"></a>4.3.8.2.1 上面案例中test1和test2的容器间默认无法通信</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#每个网络中有属于此网络的容器信息</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker network inspect bridge</span><br>[<br> &#123;<br>    <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>    <span class="hljs-string">&quot;Id&quot;</span>: <span class="hljs-string">&quot;c2f770f19400aa482054a92f2ff6ce54cae2ed45a15c7d98e0959c64dfefd58d&quot;</span>,<br>    <span class="hljs-string">&quot;Created&quot;</span>: <span class="hljs-string">&quot;2020-07-22T09:23:20.265208248+08:00&quot;</span>,<br>    <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>    <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>    <span class="hljs-string">&quot;EnableIPv6&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;IPAM&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>      <span class="hljs-string">&quot;Options&quot;</span>: null,<br>      <span class="hljs-string">&quot;Config&quot;</span>: [<br>       &#123;<br>          <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;172.17.0.0/16&quot;</span>,<br>          <span class="hljs-string">&quot;Gateway&quot;</span>: <span class="hljs-string">&quot;172.17.0.1&quot;</span><br>       &#125;<br>     ]<br>   &#125;,<br>    <span class="hljs-string">&quot;Internal&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Attachable&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Ingress&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ConfigFrom&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>   &#125;,<br>    <span class="hljs-string">&quot;ConfigOnly&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Containers&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;9bc707b1a810c4bab39a4c0ed3ff5867cc45b21fe8ae6737f2a9d0163ed2c7a9&quot;</span>:<br>      &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;test1&quot;</span>,<br>        <span class="hljs-string">&quot;EndpointID&quot;</span>: <span class="hljs-string">&quot;475bba6925c426158b3c523e07b6773c884d404d82e6c19d5e4a41f54f8856c2&quot;</span>,<br>        <span class="hljs-string">&quot;MacAddress&quot;</span>: <span class="hljs-string">&quot;02:42:ac:11:00:02&quot;</span>,<br>        <span class="hljs-string">&quot;IPv4Address&quot;</span>: <span class="hljs-string">&quot;172.17.0.2/16&quot;</span>,<br>        <span class="hljs-string">&quot;IPv6Address&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>     &#125;<br>   &#125;,<br>    <span class="hljs-string">&quot;Options&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;com.docker.network.bridge.default_bridge&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span>: <span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="hljs-string">&quot;docker0&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.driver.mtu&quot;</span>: <span class="hljs-string">&quot;1500&quot;</span><br>   &#125;,<br>    <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;<br> &#125;<br>]<br><br><span class="hljs-comment">#每个网络中有属于此网络的容器信息</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker network inspect test-net</span><br>[<br> &#123;<br>    <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;test-net&quot;</span>,<br>    <span class="hljs-string">&quot;Id&quot;</span>: <span class="hljs-string">&quot;00ab0f2d29e82d387755e1bea19532dc279fa134a565e496d308ec62f7edf434&quot;</span>,<br>    <span class="hljs-string">&quot;Created&quot;</span>: <span class="hljs-string">&quot;2020-07-22T09:59:09.431393706+08:00&quot;</span>,<br>    <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>    <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>    <span class="hljs-string">&quot;EnableIPv6&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;IPAM&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>      <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>      <span class="hljs-string">&quot;Config&quot;</span>: [<br>       &#123;<br>          <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;172.27.0.0/16&quot;</span>,<br>          <span class="hljs-string">&quot;Gateway&quot;</span>: <span class="hljs-string">&quot;172.27.0.1&quot;</span><br>       &#125;<br>     ]<br>   &#125;,<br>    <span class="hljs-string">&quot;Internal&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Attachable&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Ingress&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ConfigFrom&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>   &#125;,<br>    <span class="hljs-string">&quot;ConfigOnly&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Containers&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;c3446876a38b3d7e70ca35429051dea7373643a95689d22f252faedc31f3c427&quot;</span>:<br>      &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;test2&quot;</span>,<br>        <span class="hljs-string">&quot;EndpointID&quot;</span>: <span class="hljs-string">&quot;13fb11baeca7e90abdc9183334315e95df4a55367d3add1472d741a556cb662c&quot;</span>,<br>        <span class="hljs-string">&quot;MacAddress&quot;</span>: <span class="hljs-string">&quot;02:42:ac:1b:00:02&quot;</span>,<br>        <span class="hljs-string">&quot;IPv4Address&quot;</span>: <span class="hljs-string">&quot;172.27.0.2/16&quot;</span>,<br>        <span class="hljs-string">&quot;IPv6Address&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>     &#125;<br>   &#125;,<br>    <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>    <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;<br> &#125;<br>]<br></code></pre></td></tr></table></figure>

<h5 id="4-3-8-2-2-让默认网络中容器test1可以连通自定义网络test-net的容器test2"><a href="#4-3-8-2-2-让默认网络中容器test1可以连通自定义网络test-net的容器test2" class="headerlink" title="4.3.8.2.2 让默认网络中容器test1可以连通自定义网络test-net的容器test2"></a>4.3.8.2.2 让默认网络中容器test1可以连通自定义网络test-net的容器test2</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker network connect test-net test1</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker network inspect test-net</span><br>[<br> &#123;<br>    <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;test-net&quot;</span>,<br>    <span class="hljs-string">&quot;Id&quot;</span>: <span class="hljs-string">&quot;00ab0f2d29e82d387755e1bea19532dc279fa134a565e496d308ec62f7edf434&quot;</span>,<br>    <span class="hljs-string">&quot;Created&quot;</span>: <span class="hljs-string">&quot;2020-07-22T09:59:09.431393706+08:00&quot;</span>,<br>    <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>    <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>    <span class="hljs-string">&quot;EnableIPv6&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;IPAM&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>      <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>      <span class="hljs-string">&quot;Config&quot;</span>: [<br>       &#123;<br>          <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;172.27.0.0/16&quot;</span>,<br>          <span class="hljs-string">&quot;Gateway&quot;</span>: <span class="hljs-string">&quot;172.27.0.1&quot;</span><br>       &#125;<br>     ]<br>   &#125;,<br>    <span class="hljs-string">&quot;Internal&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Attachable&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Ingress&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ConfigFrom&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>   &#125;,<br>    <span class="hljs-string">&quot;ConfigOnly&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Containers&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;9bc707b1a810c4bab39a4c0ed3ff5867cc45b21fe8ae6737f2a9d0163ed2c7a9&quot;</span>:<br>      &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;test1&quot;</span>,<br>        <span class="hljs-string">&quot;EndpointID&quot;</span>: <span class="hljs-string">&quot;600891a1f0727f0fddcb9c123540d02963a30a54d011554e0dfd1c108ecabdd2&quot;</span>,<br>        <span class="hljs-string">&quot;MacAddress&quot;</span>: <span class="hljs-string">&quot;02:42:ac:1b:00:03&quot;</span>,<br>        <span class="hljs-string">&quot;IPv4Address&quot;</span>: <span class="hljs-string">&quot;172.27.0.3/16&quot;</span>,<br>        <span class="hljs-string">&quot;IPv6Address&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>     &#125;,<br>      <span class="hljs-string">&quot;c3446876a38b3d7e70ca35429051dea7373643a95689d22f252faedc31f3c427&quot;</span>:<br>      &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;test2&quot;</span>,<br>        <span class="hljs-string">&quot;EndpointID&quot;</span>: <span class="hljs-string">&quot;13fb11baeca7e90abdc9183334315e95df4a55367d3add1472d741a556cb662c&quot;</span>,<br>        <span class="hljs-string">&quot;MacAddress&quot;</span>: <span class="hljs-string">&quot;02:42:ac:1b:00:02&quot;</span>,<br>        <span class="hljs-string">&quot;IPv4Address&quot;</span>: <span class="hljs-string">&quot;172.27.0.2/16&quot;</span>,<br>        <span class="hljs-string">&quot;IPv6Address&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>     &#125;<br>   &#125;,<br>    <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>    <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;<br> &#125;<br>]<br><br><span class="hljs-comment">#在test1容器中可以看到新添加了一个网卡,并且分配了test-net网络的IP信息</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>42: eth0@if43: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br><span class="hljs-comment">#test1可以连接test2容器</span><br>/ <span class="hljs-comment"># ping -c1 172.27.0.2</span><br>PING 172.27.0.2 (172.27.0.2): 56 data bytes<br>64 bytes from 172.27.0.2: seq=0 ttl=64 time=0.039 ms<br><br>--- 172.27.0.2 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.039/0.039/0.039 ms<br><br><span class="hljs-comment">#在test2容器中没有变化,仍然无法连接test1</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>40: eth0@if41: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:0a:64:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 10.100.0.2/24 brd 10.100.0.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>44: eth1@if45: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:ac:1b:00:03 brd ff:ff:ff:ff:ff:ff<br>    inet 172.27.0.3/16 brd 172.27.255.255 scope global eth1<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping -c1 172.17.0.2</span><br>PING 172.17.0.2 (172.17.0.2): 56 data bytes<br>^C<br>--- 172.17.0.2 ping statistics ---<br>1 packets transmitted, 0 packets received, 100% packet loss<br></code></pre></td></tr></table></figure>

<h5 id="4-3-8-2-3-让自定义网络中容器test2可以连通默认网络的容器test1"><a href="#4-3-8-2-3-让自定义网络中容器test2可以连通默认网络的容器test1" class="headerlink" title="4.3.8.2.3 让自定义网络中容器test2可以连通默认网络的容器test1"></a>4.3.8.2.3 让自定义网络中容器test2可以连通默认网络的容器test1</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#将自定义网络中的容器test2也加入到默认网络中,使之和默认网络中的容器test1通信</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker network connect bridge test2</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker network inspect bridge</span><br>[<br> &#123;<br>    <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>    <span class="hljs-string">&quot;Id&quot;</span>:<br><span class="hljs-string">&quot;c2f770f19400aa482054a92f2ff6ce54cae2ed45a15c7d98e0959c64dfefd58d&quot;</span>,<br>    <span class="hljs-string">&quot;Created&quot;</span>: <span class="hljs-string">&quot;2020-07-22T09:23:20.265208248+08:00&quot;</span>,<br>    <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>    <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;bridge&quot;</span>,<br>    <span class="hljs-string">&quot;EnableIPv6&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;IPAM&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>      <span class="hljs-string">&quot;Options&quot;</span>: null,<br>      <span class="hljs-string">&quot;Config&quot;</span>: [<br>       &#123;<br>          <span class="hljs-string">&quot;Subnet&quot;</span>: <span class="hljs-string">&quot;172.17.0.0/16&quot;</span>,<br>          <span class="hljs-string">&quot;Gateway&quot;</span>: <span class="hljs-string">&quot;172.17.0.1&quot;</span><br>       &#125;<br>     ]<br>   &#125;,<br>    <span class="hljs-string">&quot;Internal&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Attachable&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Ingress&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ConfigFrom&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>   &#125;,<br>    <span class="hljs-string">&quot;ConfigOnly&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;Containers&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;9bc707b1a810c4bab39a4c0ed3ff5867cc45b21fe8ae6737f2a9d0163ed2c7a9&quot;</span>:<br>      &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;test1&quot;</span>,<br>        <span class="hljs-string">&quot;EndpointID&quot;</span>: <span class="hljs-string">&quot;475bba6925c426158b3c523e07b6773c884d404d82e6c19d5e4a41f54f8856c2&quot;</span>,<br>        <span class="hljs-string">&quot;MacAddress&quot;</span>: <span class="hljs-string">&quot;02:42:ac:11:00:02&quot;</span>,<br>        <span class="hljs-string">&quot;IPv4Address&quot;</span>: <span class="hljs-string">&quot;172.17.0.2/16&quot;</span>,<br>        <span class="hljs-string">&quot;IPv6Address&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>     &#125;,<br>      <span class="hljs-string">&quot;c3446876a38b3d7e70ca35429051dea7373643a95689d22f252faedc31f3c427&quot;</span>:<br>      &#123;<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;test2&quot;</span>,<br>        <span class="hljs-string">&quot;EndpointID&quot;</span>: <span class="hljs-string">&quot;a049010b37dd5a40c1ff8e8d0b327b70727316dd86b2c69c05231bfd6c985af6&quot;</span>,<br>        <span class="hljs-string">&quot;MacAddress&quot;</span>: <span class="hljs-string">&quot;02:42:ac:11:00:03&quot;</span>,<br>        <span class="hljs-string">&quot;IPv4Address&quot;</span>: <span class="hljs-string">&quot;172.17.0.3/16&quot;</span>,<br>        <span class="hljs-string">&quot;IPv6Address&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>     &#125;<br>   &#125;,<br>    <span class="hljs-string">&quot;Options&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;com.docker.network.bridge.default_bridge&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span>: <span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="hljs-string">&quot;docker0&quot;</span>,<br>      <span class="hljs-string">&quot;com.docker.network.driver.mtu&quot;</span>: <span class="hljs-string">&quot;1500&quot;</span><br>   &#125;,<br>    <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;<br> &#125;<br>]<br><br><span class="hljs-comment">#确认自定义网络的容器test2中添加了新网卡,并设置默认网络的IP信息</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>40: eth0@if41: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:0a:64:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 10.100.0.2/24 brd 10.100.0.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>44: eth1@if45: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:ac:1b:00:03 brd ff:ff:ff:ff:ff:ff<br>    inet 172.27.0.3/16 brd 172.27.255.255 scope global eth1<br>       valid_lft forever preferred_lft forever<br><br><span class="hljs-comment">#test2可以连接test1容器</span><br>/ <span class="hljs-comment"># ping -c1 172.17.0.2</span><br>PING 172.17.0.2 (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.128 ms<br><br>--- 172.17.0.2 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.128/0.128/0.128 ms<br><br><span class="hljs-comment">#在test1中可以利用test2容器名通信</span><br>/ <span class="hljs-comment"># ping -c1 test2</span><br>PING test2 (172.27.0.2): 56 data bytes<br>64 bytes from 172.27.0.2: seq=0 ttl=64 time=0.076 ms<br><br><span class="hljs-comment">#在test2中可以利test1容器名通信</span><br>/ <span class="hljs-comment"># ping -c1 test1</span><br>PING test1 (172.27.0.3): 56 data bytes<br>64 bytes from 172.27.0.3: seq=0 ttl=64 time=0.075 ms<br></code></pre></td></tr></table></figure>

<h5 id="4-3-8-2-4-断开不同网络中容器的通信"><a href="#4-3-8-2-4-断开不同网络中容器的通信" class="headerlink" title="4.3.8.2.4 断开不同网络中容器的通信"></a>4.3.8.2.4 断开不同网络中容器的通信</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#将test1 断开和网络test-net中其它容器的通信</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker network disconnect test-net test1</span><br><br><span class="hljs-comment">#在容器test1中无法和test2通信</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br>27: eth0@if28: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue<br>state UP<br> link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br> inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping -c1 172.27.0.2</span><br>PING 172.27.0.2 (172.27.0.2): 56 data bytes<br><br>--- 172.27.0.2 ping statistics ---<br>1 packets transmitted, 0 packets received, 100% packet loss<br><br><span class="hljs-comment">#在容器test2中仍能和test1通信</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP<br>    link/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>31: eth1@if32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP<br>    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff<br>    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth1<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping -c1 172.17.0.2</span><br>PING 172.17.0.2 (172.17.0.2): 56 data bytes<br>64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.085 ms<br><br><span class="hljs-comment">#将test2 断开和默认网络中其它容器的通信</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker network disconnect bridge test2</span><br><br><span class="hljs-comment">#在容器test2中无法和test1通信</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP<br>    link/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff<br>    inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping -c1 172.17.0.2</span><br>PING 172.17.0.2 (172.17.0.2): 56 data bytes<br>--- 172.17.0.2 ping statistics ---<br>1 packets transmitted, 0 packets received, 100% packet loss<br></code></pre></td></tr></table></figure>

<h2 id="4-4-实现跨宿主机的容器之间网络互联"><a href="#4-4-实现跨宿主机的容器之间网络互联" class="headerlink" title="4.4 实现跨宿主机的容器之间网络互联"></a>4.4 实现跨宿主机的容器之间网络互联</h2><p>同一个宿主机之间的各个容器之间是可以直接通信的，但是如果访问到另外一台宿主机的容器呢？</p>
<h3 id="4-4-1-方式1-利用桥接实现跨宿主机的容器间互联"><a href="#4-4-1-方式1-利用桥接实现跨宿主机的容器间互联" class="headerlink" title="4.4.1 方式1: 利用桥接实现跨宿主机的容器间互联"></a>4.4.1 方式1: 利用桥接实现跨宿主机的容器间互联</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker73.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在两个宿主机上各启动一个容器,需要确保IP不同,相互测试访问</span><br><span class="hljs-comment">#第一个宿主机10.0.0.102</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name b1 busybox</span><br>/ <span class="hljs-comment"># hostname -i</span><br>172.17.0.2<br><br><span class="hljs-comment">#第二个宿主机的容器10.0.0.103</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it busybox #占住172.17.0.2</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name b2 busybox #占住172.17.0.3</span><br>/ <span class="hljs-comment"># hostname -i</span><br>172.17.0.3<br><br><span class="hljs-comment">#分别将两个宿主机都执行下面操作</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt -y install bridge-utils</span><br><span class="hljs-comment">#10.0.0.102</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		STP enabled	interfaces<br>docker0		8000.0242da0dde76	no		veth349f561<br><span class="hljs-comment">#10.0.0.103</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		STP enabled	interfaces<br>docker0		8000.02425875ffe1	no		vethd7e7df2<br><br><span class="hljs-comment">#分别将两个宿主机都执行下面操作</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl addif docker0 eth0 #该操作执行后，只能通过VMware来执行之后的命令</span><br><span class="hljs-comment">#10.0.0.102</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		STP enabled	interfaces<br>docker0		8000.0242da0dde76	no		eth0<br>                                        veth349f561<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it b1 sh</span><br>/ <span class="hljs-comment">#ping 172.17.0.3</span><br><br><span class="hljs-comment">#10.0.0.103</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		STP enabled	interfaces<br>docker0		8000.02425875ffe1	no		eth0<br>                                        vethd7e7df2<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it b2 sh</span><br>/ <span class="hljs-comment">#ping 172.17.0.2</span><br><br><span class="hljs-comment">#结果是双方都能ping通</span><br></code></pre></td></tr></table></figure>

<h3 id="4-4-2-方式2-利用NAT实现跨主机的容器间互联"><a href="#4-4-2-方式2-利用NAT实现跨主机的容器间互联" class="headerlink" title="4.4.2 方式2: 利用NAT实现跨主机的容器间互联"></a>4.4.2 方式2: 利用NAT实现跨主机的容器间互联</h3><h4 id="4-4-2-1-docker跨主机互联实现说明"><a href="#4-4-2-1-docker跨主机互联实现说明" class="headerlink" title="4.4.2.1 docker跨主机互联实现说明"></a>4.4.2.1 docker跨主机互联实现说明</h4><p>跨主机互联是说A宿主机的容器可以访问B主机上的容器，但是前提是保证各宿主机之间的网络是可以相互通信的，然后各容器才可以通过宿主机访问到对方的容器</p>
<p>实现原理: 是在宿主机做一个网络路由就可以实现A宿主机的容器访问B主机的容器的目的</p>
<p>注意: 此方式只适合小型网络环境，复杂的网络或者大型的网络可以使用google开源的k8s进行互联</p>
<h4 id="4-4-2-2-修改各宿主机网段"><a href="#4-4-2-2-修改各宿主机网段" class="headerlink" title="4.4.2.2 修改各宿主机网段"></a>4.4.2.2 修改各宿主机网段</h4><p>Docker默认网段是172.17.0.x/24,而且每个宿主机都是一样的，因此要做路由的前提就是各个主机的网络不能一致</p>
<h5 id="4-4-2-2-1-第一个宿主机A上更改网段"><a href="#4-4-2-2-1-第一个宿主机A上更改网段" class="headerlink" title="4.4.2.2.1 第一个宿主机A上更改网段"></a>4.4.2.2.1 第一个宿主机A上更改网段</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#vim /etc/docker/daemon.json</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cat /etc/docker/daemon.json</span><br>&#123;<br><span class="hljs-string">&quot;bip&quot;</span>: <span class="hljs-string">&quot;192.168.100.1/24&quot;</span>,<br><span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>]<br>&#125;<br><br>[root@ubuntu1804 ~]<span class="hljs-comment"># systemctl restart docker</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:11:07:4e brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.102/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe11:74e/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:1d:88:31:97 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.100.1/24 brd 192.168.100.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>[root@ubuntu1804 ~]<span class="hljs-comment">#route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.2        0.0.0.0         UG    0      0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.0.0     U     0      0        0 eth0<br>192.168.100.0   0.0.0.0         255.255.255.0   U     0      0        0 docker0<br></code></pre></td></tr></table></figure>

<h5 id="4-4-2-2-2-第二个宿主机B更改网段"><a href="#4-4-2-2-2-第二个宿主机B更改网段" class="headerlink" title="4.4.2.2.2 第二个宿主机B更改网段"></a>4.4.2.2.2 第二个宿主机B更改网段</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#vim /etc/docker/daemon.json</span><br>&#123;<br><span class="hljs-string">&quot;bip&quot;</span>: <span class="hljs-string">&quot;192.168.200.1/24&quot;</span>,<br><span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>]<br>&#125;<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#systemctl restart docker</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:1c:ce:a7 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.103/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe1c:cea7/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:37:61:dc:70 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.200.1/24 brd 192.168.200.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>[root@ubuntu1804 ~]<span class="hljs-comment">#route -n</span><br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.2        0.0.0.0         UG    0      0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.0.0     U     0      0        0 eth0<br>192.168.200.0   0.0.0.0         255.255.255.0   U     0      0        0 docker0<br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-3-在两个宿主机分别启动一个容器"><a href="#4-4-2-3-在两个宿主机分别启动一个容器" class="headerlink" title="4.4.2.3 在两个宿主机分别启动一个容器"></a>4.4.2.3 在两个宿主机分别启动一个容器</h4><p><strong>第一个宿主机启动容器server1</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name server1 --rm alpine sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>4: eth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:c0:a8:64:02 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.100.2/24 brd 192.168.100.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         192.168.100.1   0.0.0.0         UG    0      0        0 eth0<br>192.168.100.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0<br></code></pre></td></tr></table></figure>

<p><strong>第二个宿主机启动容器server2</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name server2 --rm alpine sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br>8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue<br>state UP<br> link/ether 02:42:c0:a8:c8:02 brd ff:ff:ff:ff:ff:ff<br> inet 192.168.200.2/24 brd 192.168.200.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination   Gateway     Genmask     Flags Metric Ref  Use Iface<br>0.0.0.0     192.168.200.1  0.0.0.0     UG   0    0     0 eth0<br>192.168.200.0  0.0.0.0     255.255.255.0  U   0    0     0 eth0<br></code></pre></td></tr></table></figure>

<p>从第一个宿主机的容器server1无法和第二个宿主机的server2相互访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name server1 --rm alpine sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>4: eth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:c0:a8:c8:02 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.200.2/24 brd 192.168.200.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         192.168.200.1   0.0.0.0         UG    0      0        0 eth0<br>192.168.200.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0<br>/ <span class="hljs-comment"># ping -c1 192.168.200.2</span><br>PING 192.168.200.2 (192.168.200.2): 56 data bytes<br>64 bytes from 192.168.200.2: seq=0 ttl=64 time=0.025 ms<br><br>--- 192.168.200.2 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 0.025/0.025/0.025 ms<br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-4-添加静态路由和iptables规则"><a href="#4-4-2-4-添加静态路由和iptables规则" class="headerlink" title="4.4.2.4 添加静态路由和iptables规则"></a>4.4.2.4 添加静态路由和iptables规则</h4><p>在各宿主机添加静态路由，网关指向对方宿主机的IP</p>
<h5 id="4-4-2-4-1-在第一台宿主机添加静态路由和iptables规则"><a href="#4-4-2-4-1-在第一台宿主机添加静态路由和iptables规则" class="headerlink" title="4.4.2.4.1 在第一台宿主机添加静态路由和iptables规则"></a>4.4.2.4.1 在第一台宿主机添加静态路由和iptables规则</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#route add -net 192.168.200.0/24 gw 10.0.0.102 #这里输入的ip地址为server2的ip地址</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#iptables -A FORWARD -s 10.0.0.0/24 -j ACCEPT</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-4-2-在第二台宿主机添加静态路由和iptables规则"><a href="#4-4-2-4-2-在第二台宿主机添加静态路由和iptables规则" class="headerlink" title="4.4.2.4.2 在第二台宿主机添加静态路由和iptables规则"></a>4.4.2.4.2 在第二台宿主机添加静态路由和iptables规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#route add -net 192.168.100.0/24 gw 10.0.0.101 #这里输入的ip地址为server1的ip地址</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#iptables -A FORWARD -s 10.0.0.0/24 -j ACCEPT</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-5-测试跨宿主机之间容器互联"><a href="#4-4-2-5-测试跨宿主机之间容器互联" class="headerlink" title="4.4.2.5 测试跨宿主机之间容器互联"></a>4.4.2.5 测试跨宿主机之间容器互联</h4><p>宿主机A的容器server1访问宿主机B容器server2，同时在宿主机B上tcpdump抓包观察</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">/ <span class="hljs-comment"># ping -c1 192.168.200.2</span><br>PING 192.168.200.2 (192.168.200.2): 56 data bytes<br>64 bytes from 192.168.200.2: seq=0 ttl=62 time=1.022 ms<br><br>--- 192.168.200.2 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 1.022/1.022/1.022 ms<br><br><span class="hljs-comment">#宿主机B的抓包可以观察到</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#tcpdump -i eth0 -nn icmp</span><br>tcpdump: verbose output suppressed, use -v or -vv <span class="hljs-keyword">for</span> full protocol decode<br>listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes<br>21:57:39.056580 IP 10.0.0.102 &gt; 192.168.200.2: ICMP <span class="hljs-built_in">echo</span> request, id 9, seq 0, length 64<br>21:57:39.056673 IP 192.168.200.2 &gt; 10.0.0.102: ICMP <span class="hljs-built_in">echo</span> reply, id 9, seq 0, length 64<br></code></pre></td></tr></table></figure>

<p>宿主机B的容器server2访问宿主机B容器server1，同时在宿主机A上tcpdump抓包观察</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">/ <span class="hljs-comment"># ping -c1 192.168.100.2</span><br>PING 192.168.100.2 (192.168.100.2): 56 data bytes<br>64 bytes from 192.168.100.2: seq=0 ttl=62 time=1.041 ms<br><br>--- 192.168.100.2 ping statistics ---<br>1 packets transmitted, 1 packets received, 0% packet loss<br>round-trip min/avg/max = 1.041/1.041/1.041 ms<br><br><span class="hljs-comment">#宿主机A的抓包可以观察到</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#tcpdump -i eth0 -nn icmp</span><br>tcpdump: verbose output suppressed, use -v or -vv <span class="hljs-keyword">for</span> full protocol decode<br>listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes<br>21:58:49.404052 IP 10.0.0.103 &gt; 192.168.100.2: ICMP <span class="hljs-built_in">echo</span> request, id 11, seq 0, length 64<br>21:58:49.404180 IP 192.168.100.2 &gt; 10.0.0.103: ICMP <span class="hljs-built_in">echo</span> reply, id 11, seq 0, length 64<br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-6-创建第三个容器测试"><a href="#4-4-2-6-创建第三个容器测试" class="headerlink" title="4.4.2.6 创建第三个容器测试"></a>4.4.2.6 创建第三个容器测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在第二个宿主机B上启动第一个提供web服务的nginx容器server3</span><br><span class="hljs-comment">#注意无需打开端口映射</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d --name server3 centos7-nginx:1.6.1</span><br>497ae5890fe1b299867669e1dce9a0c41bd336e97c26c95970820183e7993737<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it server3 bash</span><br>[root@497ae5890fe1 /]<span class="hljs-comment"># ifconfig</span><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 192.168.200.3  netmask 255.255.255.0  broadcast 192.168.200.255<br>        ether 02:42:c0:a8:c8:03  txqueuelen 0  (Ethernet)<br>        RX packets 10163  bytes 16874747 (16.0 MiB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 5515  bytes 301420 (294.3 KiB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 127.0.0.1  netmask 255.0.0.0<br>        loop  txqueuelen 1000  (Local Loopback)<br>        RX packets 0  bytes 0 (0.0 B)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 0  bytes 0 (0.0 B)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br><span class="hljs-comment">#从server1中访问server3的页面可以成功</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br>14: eth0@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue<br>state UP<br> link/ether 02:42:0a:64:00:02 brd ff:ff:ff:ff:ff:ff<br> inet 10.100.0.2/16 brd 10.100.255.255 scope global eth0<br>   valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># wget -qO - http://192.168.200.3/app 或 wget -qO - http://192.168.200.3</span><br>Test Page <span class="hljs-keyword">in</span> app<br><br>/ <span class="hljs-comment">#</span><br><br><span class="hljs-comment">#从server3容器观察访问日志，可以看到来自于第一个宿主机，而非server1容器</span><br>[root@497ae5890fe1 /]<span class="hljs-comment"># tail -f /apps/nginx/logs/access.log</span><br>10.0.0.101 - - [02/Feb/2020:09:02:00 +0000] <span class="hljs-string">&quot;GET /app HTTP/1.1&quot;</span> 301 169 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;Wget&quot;</span><br><span class="hljs-comment">#用tcpdump抓包80/tcp的包，可以观察到以下内容</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#tcpdump -i eth0 -nn port 80</span><br>22:37:44.507848 IP 10.0.0.102.55818 &gt; 192.168.200.3.80: Flags [S], seq 2779229035, win 29200, options [mss 1460,sackOK,TS val 1291830410 ecr 0,nop,wscale 9], length 0<br>22:37:44.507944 IP 192.168.200.3.80 &gt; 10.0.0.102.55818: Flags [S.], seq 1393710756, ack 2779229036, win 28960, options [mss 1460,sackOK,TS val 3173588737 ecr 1291830410,nop,wscale 9], length 0<br>22:37:44.508102 IP 10.0.0.102.55818 &gt; 192.168.200.3.80: Flags [.], ack 1, win 58, options [nop,nop,TS val 1291830411 ecr 3173588737], length 0<br>22:37:44.508187 IP 10.0.0.102.55818 &gt; 192.168.200.3.80: Flags [P.], seq 1:77, ack 1, win 58, options [nop,nop,TS val 1291830411 ecr 3173588737], length 76: HTTP: GET / HTTP/1.1<br>22:37:44.508210 IP 192.168.200.3.80 &gt; 10.0.0.102.55818: Flags [.], ack 77, win 57, options [nop,nop,TS val 3173588737 ecr 1291830411], length 0<br>22:37:44.508334 IP 192.168.200.3.80 &gt; 10.0.0.102.55818: Flags [P.], seq 1:232, ack 77, win 57, options [nop,nop,TS val 3173588737 ecr 1291830411], length 231: HTTP: HTTP/1.1 200 OK<br>22:37:44.508454 IP 192.168.200.3.80 &gt; 10.0.0.102.55818: Flags [FP.], seq 232:258, ack 77, win 57, options [nop,nop,TS val 3173588737 ecr 1291830411], length 26: HTTP<br>22:37:44.508688 IP 10.0.0.102.55818 &gt; 192.168.200.3.80: Flags [.], ack 232, win 60, options [nop,nop,TS val 1291830411 ecr 3173588737], length 0<br>22:37:44.508771 IP 10.0.0.102.55818 &gt; 192.168.200.3.80: Flags [F.], seq 77, ack 259, win 60, options [nop,nop,TS val 1291830411 ecr 3173588737], length 0<br>22:37:44.508789 IP 192.168.200.3.80 &gt; 10.0.0.102.55818: Flags [.], ack 78, win 57, options [nop,nop,TS val 3173588737 ecr 1291830411], length 0<br></code></pre></td></tr></table></figure>

<h3 id="4-4-3-方式3-利用Open-vSwitch实现跨主机的容器间互联"><a href="#4-4-3-方式3-利用Open-vSwitch实现跨主机的容器间互联" class="headerlink" title="4.4.3 方式3: 利用Open vSwitch实现跨主机的容器间互联"></a>4.4.3 方式3: 利用Open vSwitch实现跨主机的容器间互联</h3><h4 id="4-4-3-1-Open-vSwitch介绍"><a href="#4-4-3-1-Open-vSwitch介绍" class="headerlink" title="4.4.3.1 Open vSwitch介绍"></a>4.4.3.1 Open vSwitch介绍</h4><p>Open vSwitch，即Open Virtual Switch开放虚拟交换机，简称OVS, 是在开源的Apache2.0许可下的产品级质量的多层虚拟交换机。由Nicira Networks开发，主要实现代码为可移植的C代码。它的目的是让大规模网络自动化可以通过编程扩展，同时仍然支持标准的管理接口和协议(例如NetFlow, sFlow,SPAN, RSPAN, CLI, LACP, 802.1ag) ,即Open vSwitch通过软件的方式实现了交换机功能</p>
<p>跟传统的物理交换机相比，虚拟交换机同样具备众多优点，一是配置更加灵活。一台普通的服务器可以配置出数十台甚至上百台虚拟交换机，且端口数目可以灵活选择。例如，VMware的ESXi一台服务器可以仿真出248台虚拟交换机，且每台交换机预设虚拟端口即可达56个；二是成本更加低廉，通过虚拟交换往往可以获得昂贵的普通交换机才能达到的性能，例如微软的Hyper-V平台，虚拟机与虚拟交换机之间的联机速度轻易可达10Gbps。</p>
<p>官网: <a target="_blank" rel="noopener" href="http://www.openvswitch.org/">http://www.openvswitch.org/</a></p>
<p><strong>在生产中多数都是使用k8s网路解决方法来实现跨宿主机的网络应用</strong></p>
<p><strong>使用Open vSwitch实现跨主机容器连接一原理</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker74.png" srcset="/blog/img/loading.gif" alt="多个不同网段的主机通过ovs实现互联互通"></p>
<p>什么是GRE隧道?</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gcode">GRE:通用路由协议封装<br>隧道技术<span class="hljs-comment">(Tunneling)</span> 是一种通过使用互联网络的基础设施在网络之间传递数据的方式。使用隧道传递的数据<span class="hljs-comment">(或负载)</span>可以是不同协议的数据帧或包。隧道协议将其它协议的数据帧或包重新封装然后通过隧道发送。新的帧头提供路由信息,以便通过互联网传递被封装的负载数据。<br></code></pre></td></tr></table></figure>

<h4 id="4-3-3-2-利用Open-vSwitch实现docker跨主机网络"><a href="#4-3-3-2-利用Open-vSwitch实现docker跨主机网络" class="headerlink" title="4.3.3.2 利用Open vSwitch实现docker跨主机网络"></a>4.3.3.2 利用Open vSwitch实现docker跨主机网络</h4><p>实现目标: 将两台主机的容器利用Open vSwitch连接起来，实现互联互通</p>
<h5 id="4-3-3-2-1-环境准备"><a href="#4-3-3-2-1-环境准备" class="headerlink" title="4.3.3.2.1 环境准备"></a>4.3.3.2.1 环境准备</h5><table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">操作系统</th>
<th align="center">宿主机IP</th>
<th align="center">Docker0 IP</th>
<th align="center">容器 IP</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ovs1</td>
<td align="center">ubuntu 18.04</td>
<td align="center">10.0.0.101/24</td>
<td align="center">192.168.1.1/24</td>
<td align="center">192.168.1.0/24</td>
</tr>
<tr>
<td align="center">ovs2</td>
<td align="center">ubuntu 18.04</td>
<td align="center">10.0.0.102/24</td>
<td align="center">192.168.2.1/24</td>
<td align="center">192.168.2.0/24</td>
</tr>
</tbody></table>
<h5 id="4-3-3-2-2-修改两台主机的docker0分别使用不同的网段"><a href="#4-3-3-2-2-修改两台主机的docker0分别使用不同的网段" class="headerlink" title="4.3.3.2.2 修改两台主机的docker0分别使用不同的网段"></a>4.3.3.2.2 修改两台主机的docker0分别使用不同的网段</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#配置第一台主机</span><br>[root@ovs1 ~]<span class="hljs-comment">#vim /etc/docker/daemon.json</span><br>&#123;<br> <span class="hljs-string">&quot;bip&quot;</span>: <span class="hljs-string">&quot;192.168.1.1/24&quot;</span>,<br> <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>]<br>&#125;<br>[root@ovs1 ~]<span class="hljs-comment">#systemctl restart docker</span><br>[root@ovs1 ~]<span class="hljs-comment">#ip add show docker0</span><br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:de:78:7b:f8 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.1.1/24 brd 192.168.1.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br><br><span class="hljs-comment">#配置第二台主机</span><br>[root@ovs2 ~]<span class="hljs-comment">#vim /etc/docker/daemon.json</span><br>&#123;<br> <span class="hljs-string">&quot;bip&quot;</span>: <span class="hljs-string">&quot;192.168.2.1/24&quot;</span>,<br> <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>]<br>&#125;<br>[root@ovs2 ~]<span class="hljs-comment">#systemctl restart docker</span><br>[root@ovs2 ~]<span class="hljs-comment">#ip add show docker0</span><br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:b1:1c:12:0c brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.2.1/24 brd 192.168.2.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-2-3-在两个宿主机安装openvswitch-switch和bridge-utils和确认版本"><a href="#4-3-3-2-3-在两个宿主机安装openvswitch-switch和bridge-utils和确认版本" class="headerlink" title="4.3.3.2.3 在两个宿主机安装openvswitch-switch和bridge-utils和确认版本"></a>4.3.3.2.3 在两个宿主机安装openvswitch-switch和bridge-utils和确认版本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在第一个主机安装包</span><br>[root@ovs1 ~]<span class="hljs-comment">#apt -y install openvswitch-switch bridge-utils</span><br>[root@ovs1 ~]<span class="hljs-comment">#ps -e | grep ovs</span><br> 6766 ?     00:00:00 ovsdb-server<br> 6826 ?     00:00:00 ovs-vswitchd<br><br><span class="hljs-comment">#查看ovs版本信息和ovs支持的OpenFlow协议的版本</span><br>[root@ovs1 ~]<span class="hljs-comment">#ovs-appctl --version</span><br>ovs-appctl (Open vSwitch) 2.9.5<br>[root@ovs1 ~]<span class="hljs-comment">#ovs-ofctl --version</span><br>ovs-ofctl (Open vSwitch) 2.9.5<br>OpenFlow versions 0x1:0x5<br><br><span class="hljs-comment">#查看网桥</span><br>[root@ovs1 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		    STP enabled	interfaces<br>docker0		8000.0242de787bf8	no		<br><br><br><span class="hljs-comment">#在第二个主机安装包</span><br>[root@ovs2 ~]<span class="hljs-comment">#apt -y install openvswitch-switch bridge-utils</span><br>[root@ovs2 ~]<span class="hljs-comment">#ps -e | grep ovs</span><br> 6618 ?     00:00:00 ovsdb-server<br> 6680 ?     00:00:00 ovs-vswitchd<br><br><span class="hljs-comment">#查看ovs版本信息和ovs支持的OpenFlow协议的版本</span><br>[root@ovs2 ~]<span class="hljs-comment">#ovs-appctl --version</span><br>ovs-appctl (Open vSwitch) 2.9.5<br>[root@ovs2 ~]<span class="hljs-comment">#ovs-ofctl --version</span><br>ovs-ofctl (Open vSwitch) 2.9.5<br>OpenFlow versions 0x1:0x5<br><br>[root@ovs2 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		    STP enabled	interfaces<br>docker0		8000.0242b11c120c	no		<br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-2-4-在两个宿主机都创建obr0网桥并激活"><a href="#4-3-3-2-4-在两个宿主机都创建obr0网桥并激活" class="headerlink" title="4.3.3.2.4 在两个宿主机都创建obr0网桥并激活"></a>4.3.3.2.4 在两个宿主机都创建obr0网桥并激活</h5><p><strong>使用ovs创建的网桥不是传统意义上的网桥，使用brctl show是看不到新创建的网桥</strong></p>
<p><strong>新创建的obr网桥是出于DOWN状态，需要后续开启</strong></p>
<p><strong>在obr网桥开启之后，就会处于unkonw状态</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ovs1 ~]<span class="hljs-comment">#ovs-vsctl add-br obr0</span><br>[root@ovs1 ~]<span class="hljs-comment">#ip link set dev obr0 up</span><br>[root@ovs1 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:11:07:4e brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe11:74e/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:de:78:7b:f8 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.1.1/24 brd 192.168.1.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>4: ovs-system: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000<br>    link/ether 6a:ec:cc:23:c9:cf brd ff:ff:ff:ff:ff:ff<br>5: obr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/ether 42:4d:1c:c8:9d:47 brd ff:ff:ff:ff:ff:ff<br>    inet6 fe80::404d:1cff:fec8:9d47/64 scope link <br>       valid_lft forever preferred_lft forever<br>  <br><span class="hljs-comment">#第二台主机重复上面</span><br>[root@ovs2 ~]<span class="hljs-comment">#ovs-vsctl add-br obr0</span><br>[root@ovs2 ~]<span class="hljs-comment">#ip link set dev obr0 up</span><br>[root@ovs2 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:1c:ce:a7 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.102/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe1c:cea7/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:b1:1c:12:0c brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.2.1/24 brd 192.168.2.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>4: ovs-system: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000<br>    link/ether 26:33:c1:79:4f:ba brd ff:ff:ff:ff:ff:ff<br>5: obr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/ether ae:9a:dd:c3:2f:4c brd ff:ff:ff:ff:ff:ff<br>    inet6 fe80::ac9a:ddff:fec3:2f4c/64 scope link <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-2-5-在两个宿主机创建gre隧道-remote-ip为peer宿主机ip"><a href="#4-3-3-2-5-在两个宿主机创建gre隧道-remote-ip为peer宿主机ip" class="headerlink" title="4.3.3.2.5 在两个宿主机创建gre隧道(remote_ip为peer宿主机ip)"></a>4.3.3.2.5 在两个宿主机创建gre隧道(remote_ip为peer宿主机ip)</h5><p>注意: 如果有多台docker主机需要构建网络创建多个gre隧道</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#一条命令实现,remote_ip指向另一台宿主机的IP</span><br>[root@ovs1 ~]<span class="hljs-comment">#ovs-vsctl add-port obr0 gre0 -- set Interface gre0 type=gre options:remote_ip=10.0.0.102 </span><br><span class="hljs-comment">#或者两条命令实现</span><br>[root@ovs1 ~]<span class="hljs-comment">#ovs-vsctl add-port obr0 gre0</span><br>[root@ovs1 ~]<span class="hljs-comment">#ovs-vsctl set Interface gre0 type=gre options:remote_ip=10.0.0.102</span><br><br><span class="hljs-comment">#指向IP之后就会有一个叫gre0的隧道</span><br>[root@ovs1 ~]<span class="hljs-comment">#ovs-vsctl list-ports obr0</span><br>gre0<br><br>[root@ovs1 ~]<span class="hljs-comment">#ovs-vsctl show</span><br>0fe943e1-5586-49cf-a345-061ddcbf3caf<br>    Bridge <span class="hljs-string">&quot;obr0&quot;</span><br>        Port <span class="hljs-string">&quot;obr0&quot;</span><br>            Interface <span class="hljs-string">&quot;obr0&quot;</span><br>                <span class="hljs-built_in">type</span>: internal<br>        Port <span class="hljs-string">&quot;gre0&quot;</span><br>            Interface <span class="hljs-string">&quot;gre0&quot;</span><br>                <span class="hljs-built_in">type</span>: gre<br>                options: &#123;remote_ip=<span class="hljs-string">&quot;10.0.0.102&quot;</span>&#125;<br>    ovs_version: <span class="hljs-string">&quot;2.9.5&quot;</span><br><br><span class="hljs-comment">#多了一个叫gre的虚拟网卡</span><br>[root@ovs1 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:11:07:4e brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe11:74e/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:de:78:7b:f8 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.1.1/24 brd 192.168.1.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>4: ovs-system: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000<br>    link/ether 6a:ec:cc:23:c9:cf brd ff:ff:ff:ff:ff:ff<br>5: obr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/ether 42:4d:1c:c8:9d:47 brd ff:ff:ff:ff:ff:ff<br>    inet6 fe80::404d:1cff:fec8:9d47/64 scope link <br>       valid_lft forever preferred_lft forever<br>6: gre0@NONE: &lt;NOARP&gt; mtu 1476 qdisc noop state DOWN group default qlen 1000<br>    link/gre 0.0.0.0 brd 0.0.0.0<br>7: gretap0@NONE: &lt;BROADCAST,MULTICAST&gt; mtu 1462 qdisc noop state DOWN group default qlen 1000<br>    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff<br>8: erspan0@NONE: &lt;BROADCAST,MULTICAST&gt; mtu 1450 qdisc noop state DOWN group default qlen 1000<br>    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff<br>9: gre_sys@NONE: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 65000 qdisc fq_codel master ovs-system state UNKNOWN group default qlen 1000<br>    link/ether 8a:d0:c1:f8:bb:a4 brd ff:ff:ff:ff:ff:ff<br>    inet6 fe80::88d0:c1ff:fef8:bba4/64 scope link <br>       valid_lft forever preferred_lft forever<br><br><span class="hljs-comment">#配置第二个宿主机</span><br>[root@ovs2 ~]<span class="hljs-comment">#ovs-vsctl add-port obr0 gre0 -- set Interface gre0 type=gre options:remote_ip=10.0.0.101</span><br>[root@ovs2 ~]<span class="hljs-comment">#ovs-vsctl list-ports obr0</span><br>gre0<br><br>[root@ovs2 ~]<span class="hljs-comment">#ovs-vsctl show</span><br>e59205c0-77bb-44ec-a6df-d7ea25be5980<br>    Bridge <span class="hljs-string">&quot;obr0&quot;</span><br>        Port <span class="hljs-string">&quot;obr0&quot;</span><br>            Interface <span class="hljs-string">&quot;obr0&quot;</span><br>                <span class="hljs-built_in">type</span>: internal<br>        Port <span class="hljs-string">&quot;gre0&quot;</span><br>            Interface <span class="hljs-string">&quot;gre0&quot;</span><br>                <span class="hljs-built_in">type</span>: gre<br>                options: &#123;remote_ip=<span class="hljs-string">&quot;10.0.0.101&quot;</span>&#125;<br>    ovs_version: <span class="hljs-string">&quot;2.9.5&quot;</span><br> <br>[root@ovs2 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:1c:ce:a7 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.102/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe1c:cea7/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default <br>    link/ether 02:42:b1:1c:12:0c brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.2.1/24 brd 192.168.2.255 scope global docker0<br>       valid_lft forever preferred_lft forever<br>4: ovs-system: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000<br>    link/ether 26:33:c1:79:4f:ba brd ff:ff:ff:ff:ff:ff<br>5: obr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/ether ae:9a:dd:c3:2f:4c brd ff:ff:ff:ff:ff:ff<br>    inet6 fe80::ac9a:ddff:fec3:2f4c/64 scope link <br>       valid_lft forever preferred_lft forever<br>6: gre0@NONE: &lt;NOARP&gt; mtu 1476 qdisc noop state DOWN group default qlen 1000<br>    link/gre 0.0.0.0 brd 0.0.0.0<br>7: gretap0@NONE: &lt;BROADCAST,MULTICAST&gt; mtu 1462 qdisc noop state DOWN group default qlen 1000<br>    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff<br>8: erspan0@NONE: &lt;BROADCAST,MULTICAST&gt; mtu 1450 qdisc noop state DOWN group default qlen 1000<br>    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff<br>9: gre_sys@NONE: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 65000 qdisc fq_codel master ovs-system state UNKNOWN group default qlen 1000<br>    link/ether 1e:2e:b9:7e:c1:f3 brd ff:ff:ff:ff:ff:ff<br>    inet6 fe80::1c2e:b9ff:fe7e:c1f3/64 scope link <br>       valid_lft forever preferred_lft forever<br> <br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-2-6-在两个宿主机将obr0作为接口加入docker0网桥"><a href="#4-3-3-2-6-在两个宿主机将obr0作为接口加入docker0网桥" class="headerlink" title="4.3.3.2.6 在两个宿主机将obr0作为接口加入docker0网桥"></a>4.3.3.2.6 在两个宿主机将obr0作为接口加入docker0网桥</h5><p><strong>执行完以下两个命令之后，两宿主机就打通了</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#第一台宿主机执行</span><br>[root@ovs1 ~]<span class="hljs-comment">#brctl addif docker0 obr0</span><br>[root@ovs1 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		    STP enabled	  interfaces<br>docker0		8000.0242de787bf8	no		      obr0<br><br><span class="hljs-comment">#第二台宿主机执行同样操作</span><br>[root@ovs2 ~]<span class="hljs-comment">#brctl addif docker0 obr0</span><br>[root@ovs2 ~]<span class="hljs-comment">#brctl show</span><br>bridge name	bridge id		    STP enabled	   interfaces<br>docker0		8000.0242b11c120c	no		       obr0<br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-2-7-在两个宿主机添加静态路由-网段地址为-peer-Docker网段"><a href="#4-3-3-2-7-在两个宿主机添加静态路由-网段地址为-peer-Docker网段" class="headerlink" title="4.3.3.2.7 在两个宿主机添加静态路由(网段地址为 peer Docker网段)"></a>4.3.3.2.7 在两个宿主机添加静态路由(网段地址为 peer Docker网段)</h5><p><strong>两宿主机要添加对方宿主机容器的网段的静态路由，使生成的容器也能链接的上（前面设置了生成的容器的网段都设置为192网段）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ovs1 添加 peer docker net</span><br>[root@ovs1 ~]<span class="hljs-comment">#ip route add 192.168.2.0/24 dev docker0  #只要到192.168.2.0/24的网段，就要用docker0转发出去</span><br>[root@ovs1 ~]<span class="hljs-comment">#route -n</span><br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.2        0.0.0.0         UG    0      0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.0.0     U     0      0        0 eth0<br>192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0<br>192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0<br><br><span class="hljs-comment">#ovs2 添加 peer docker net</span><br>[root@ovs2 ~]<span class="hljs-comment">#ip route add 192.168.1.0/24 dev docker0 #只要到192.168.1.0/24的网段，就要用docker0转发出去</span><br>[root@ovs2 ~]<span class="hljs-comment">#route -n</span><br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.2        0.0.0.0         UG    0      0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.0.0     U     0      0        0 eth0<br>192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0<br>192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0<br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-2-8-在两个宿主机测试跨主机的容器之间的连通性"><a href="#4-3-3-2-8-在两个宿主机测试跨主机的容器之间的连通性" class="headerlink" title="4.3.3.2.8 在两个宿主机测试跨主机的容器之间的连通性"></a>4.3.3.2.8 在两个宿主机测试跨主机的容器之间的连通性</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ovs1 ~]<span class="hljs-comment">#docker run -it alpine /bin/sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>2: gre0@NONE: &lt;NOARP&gt; mtu 1476 qdisc noop state DOWN qlen 1000<br>    link/gre 0.0.0.0 brd 0.0.0.0<br>3: gretap0@NONE: &lt;BROADCAST,MULTICAST&gt; mtu 1462 qdisc noop state DOWN qlen 1000<br>    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff<br>4: erspan0@NONE: &lt;BROADCAST,MULTICAST&gt; mtu 1450 qdisc noop state DOWN qlen 1000<br>    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff<br>10: eth0@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:c0:a8:01:02 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.1.2/24 brd 192.168.1.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping -c 3 192.168.2.2 #这里要先把ovs2的docker运行起来</span><br>PING 192.168.2.2 (192.168.2.2): 56 data bytes<br>64 bytes from 192.168.2.2: seq=0 ttl=63 time=4.459 ms<br>64 bytes from 192.168.2.2: seq=1 ttl=63 time=1.279 ms<br>64 bytes from 192.168.2.2: seq=2 ttl=63 time=0.517 ms<br><br>--- 192.168.2.2 ping statistics ---<br>3 packets transmitted, 3 packets received, 0% packet loss<br>round-trip min/avg/max = 0.517/2.085/4.459 ms<br><br>[root@ovs2 ~]<span class="hljs-comment">#docker run -it alpine /bin/sh</span><br>/ <span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>2: gre0@NONE: &lt;NOARP&gt; mtu 1476 qdisc noop state DOWN qlen 1000<br>    link/gre 0.0.0.0 brd 0.0.0.0<br>3: gretap0@NONE: &lt;BROADCAST,MULTICAST&gt; mtu 1462 qdisc noop state DOWN qlen 1000<br>    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff<br>4: erspan0@NONE: &lt;BROADCAST,MULTICAST&gt; mtu 1450 qdisc noop state DOWN qlen 1000<br>    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff<br>10: eth0@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP <br>    link/ether 02:42:c0:a8:02:02 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.2.2/24 brd 192.168.2.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>/ <span class="hljs-comment"># ping -c 3 192.168.1.2</span><br>PING 192.168.1.2 (192.168.1.2): 56 data bytes<br>64 bytes from 192.168.1.2: seq=0 ttl=63 time=1.553 ms<br>64 bytes from 192.168.1.2: seq=1 ttl=63 time=1.136 ms<br>64 bytes from 192.168.1.2: seq=2 ttl=63 time=1.176 ms<br><br>--- 192.168.1.2 ping statistics ---<br>3 packets transmitted, 3 packets received, 0% packet loss<br>round-trip min/avg/max = 1.136/1.288/1.553 ms<br>/ <span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>在第二个主机上再打开一个nginx容器，从第一个主机的容器访问，观察来源的IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ovs2 ~]<span class="hljs-comment">#docker pull nginx</span><br>[root@ovs2 ~]<span class="hljs-comment">#docker run -d --name nginx nginx</span><br>b0ed78093bd8d7998a1a6b0473329d92123383a2c2a14975dc11eb882e4ec3d7<br>[root@ovs2 ~]<span class="hljs-comment">#docker exec -it nginx hostname -I</span><br>192.168.2.3 <br>[root@ovs2 ~]<span class="hljs-comment">#docker logs -f nginx</span><br>192.168.1.2 - - [27/Feb/2020:09:57:18 +0000] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 612 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;Wget&quot;</span><br><span class="hljs-string">&quot;-&quot;</span><br><br><span class="hljs-comment">#从第一个主机的容器发起请求，可以查看到上面的访问日志输出</span><br>[root@ovs1 ~]<span class="hljs-comment">#docker run -it alpine wget -qO - http://192.168.2.3/</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br>&lt;style&gt;<br>    body &#123;<br>        width: 35em;<br>        margin: 0 auto;<br>        font-family: Tahoma, Verdana, Arial, sans-serif;<br>    &#125;<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br>Commercial support is available at<br>&lt;a href=<span class="hljs-string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-2-9-在两个宿主机用脚本保存配置用于开机启动"><a href="#4-3-3-2-9-在两个宿主机用脚本保存配置用于开机启动" class="headerlink" title="4.3.3.2.9 在两个宿主机用脚本保存配置用于开机启动"></a>4.3.3.2.9 在两个宿主机用脚本保存配置用于开机启动</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ovs1配置</span><br>[root@ovs1 ~]<span class="hljs-comment">#cat &gt; net.sh &lt;&lt;EOF </span><br><span class="hljs-comment">#!/bin/bash</span><br>ip link <span class="hljs-built_in">set</span> dev obr0 up<br>brctl addif docker0 obr0<br>ip route add 192.168.2.0/24 dev docker0<br>EOF<br>[root@ovs1 ~]<span class="hljs-comment">#chmod +x net.sh</span><br><br><span class="hljs-comment">#ovs2配置</span><br>[root@ovs2 ~]<span class="hljs-comment">#cat &gt; net.sh &lt;&lt;EOF </span><br><span class="hljs-comment">#!/bin/bash</span><br>ip link <span class="hljs-built_in">set</span> dev obr0 up<br>brctl addif docker0 obr0<br>ip route add 192.168.1.0/24 dev docker0<br>EOF<br>[root@ovs1 ~]<span class="hljs-comment">#chmod +x net.sh</span><br></code></pre></td></tr></table></figure>

<h3 id="4-4-4-方式4-使用-weave-实现跨主机的容器间互联"><a href="#4-4-4-方式4-使用-weave-实现跨主机的容器间互联" class="headerlink" title="4.4.4 方式4: 使用 weave 实现跨主机的容器间互联"></a>4.4.4 方式4: 使用 weave 实现跨主机的容器间互联</h3><h4 id="4-4-4-1-weave-介绍"><a href="#4-4-4-1-weave-介绍" class="headerlink" title="4.4.4.1 weave 介绍"></a>4.4.4.1 weave 介绍</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker75.png" srcset="/blog/img/loading.gif"></p>
<p>weave 原意编织,意在建立一个虚拟的网络，用于将运行在不同主机的Docker容器连接起来</p>
<p>官网: <a target="_blank" rel="noopener" href="http://weave.works/">http://weave.works</a></p>
<p>github链接: <a target="_blank" rel="noopener" href="https://github.com/weaveworks/weave#readme">https://github.com/weaveworks/weave#readme</a></p>
<h4 id="4-4-4-2-weave实现跨主机容器互联的流程"><a href="#4-4-4-2-weave实现跨主机容器互联的流程" class="headerlink" title="4.4.4.2 weave实现跨主机容器互联的流程"></a>4.4.4.2 weave实现跨主机容器互联的流程</h4><p>官方文档: <a target="_blank" rel="noopener" href="https://www.weave.works/docs/net/latest/install/using-weave/">https://www.weave.works/docs/net/latest/install/using-weave/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker76.png" srcset="/blog/img/loading.gif"></p>
<p><strong>weave实现跨主机容器互联的流程</strong></p>
<ul>
<li>安装weave</li>
<li>启动weave $weave launch</li>
<li>连接不同主机</li>
<li>通过weave启动容器</li>
</ul>
<h4 id="4-4-4-3-实战案例-通过weave-实现跨主机容器的互联"><a href="#4-4-4-3-实战案例-通过weave-实现跨主机容器的互联" class="headerlink" title="4.4.4.3 实战案例: 通过weave 实现跨主机容器的互联"></a>4.4.4.3 实战案例: 通过weave 实现跨主机容器的互联</h4><h5 id="4-4-4-3-1-环境准备"><a href="#4-4-4-3-1-环境准备" class="headerlink" title="4.4.4.3.1 环境准备"></a>4.4.4.3.1 环境准备</h5><table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">操作系统</th>
<th align="center">宿主机IP</th>
<th align="center">Docker0 IP</th>
<th align="center">容器</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ubuntu1804</td>
<td align="center">ubuntu 18.04</td>
<td align="center">10.0.0.100/24</td>
<td align="center">172.17.0.1/16</td>
<td align="center">a1</td>
</tr>
<tr>
<td align="center">centos7</td>
<td align="center">centos 7.8</td>
<td align="center">10.0.0.200/24</td>
<td align="center">172.17.0.1/16</td>
<td align="center">a2</td>
</tr>
</tbody></table>
<h5 id="4-4-4-3-2-安装weave"><a href="#4-4-4-3-2-安装weave" class="headerlink" title="4.4.4.3.2 安装weave"></a>4.4.4.3.2 安装weave</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#wget -O /usr/bin/weave https://raw.githubusercontent.com/zettio/weave/master/weave</span><br>--2020-07-23 17:05:08--<br>https://raw.githubusercontent.com/zettio/weave/master/weave<br>Resolving raw.githubusercontent.com (raw.githubusercontent.com)...<br>151.101.108.133<br>Connecting to raw.githubusercontent.com<br>(raw.githubusercontent.com)|151.101.108.133|:443... connected.<br>HTTP request sent, awaiting response... 200 OK<br>Length: 52484 (51K) [text/plain]<br>Saving to: ‘/usr/bin/weave’<br>/usr/bin/weave        100%[===========================================&gt;]<br> 51.25K  174KB/s   <span class="hljs-keyword">in</span> 0.3s  <br>2020-07-23 17:05:15 (174 KB/s) - ‘/usr/bin/weave’ saved [52484/52484]<br>[root@ubuntu1804 ~]<span class="hljs-comment">#ll /usr/bin/weave</span><br>-rw-r--r-- 1 root root 52484 Jul 23 17:05 /usr/bin/weave<br><span class="hljs-comment">#在第二个宿主机重复一样的操作</span><br>[root@centos7 ~]<span class="hljs-comment">#wget -O /usr/bin/weave https://raw.githubusercontent.com/zettio/weave/master/weave</span><br>[root@centos7 ~]<span class="hljs-comment">#ll /usr/bin/weave -h</span><br>-rw-r--r-- 1 root root 52K Jul 23 17:08 /usr/bin/weave<br></code></pre></td></tr></table></figure>

<h5 id="4-4-4-3-3-第一个宿主机启动weave"><a href="#4-4-4-3-3-第一个宿主机启动weave" class="headerlink" title="4.4.4.3.3 第一个宿主机启动weave"></a>4.4.4.3.3 第一个宿主机启动weave</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#chmod +x /usr/bin/weave</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#weave launch</span><br>latest: Pulling from weaveworks/weave<br>21c83c524219: Pull complete <br>02ec35b6f627: Pull complete <br>c40f141adde9: Pull complete <br>a63db11be476: Pull complete <br>e8d3a1b4fb09: Pull complete <br>Digest: sha256:a4f1dd7b4fcd3a391c165f1ab20c5f72330c22fe0918c899be67763717bb2a28<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> weaveworks/weave:latest<br>docker.io/weaveworks/weave:latest<br>latest: Pulling from weaveworks/weavedb<br>a53a673d456f: Pull complete <br>Digest: sha256:69451a2121b288e09329241de9401af1aeddd05d93f145764bbb735a4ea05c76<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> weaveworks/weavedb:latest<br>docker.io/weaveworks/weavedb:latest<br>Unable to find image <span class="hljs-string">&#x27;weaveworks/weaveexec:latest&#x27;</span> locally<br>latest: Pulling from weaveworks/weaveexec<br>21c83c524219: Already exists <br>02ec35b6f627: Already exists <br>c40f141adde9: Already exists <br>a63db11be476: Already exists <br>e8d3a1b4fb09: Already exists <br>a32777c54c9c: Pull complete <br>62ae831e3996: Pull complete <br>4dce36b0e389: Pull complete <br>6f3464413eb4: Pull complete <br>Digest: sha256:847cdb3eb0d38ff6590b6066ec0f6b02ced47c1d76a78f3f93d8ca6145aecaa5<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> weaveworks/weaveexec:latest<br>eea87ea5cd83946e7e11f4c87899a2e8866e5e369d7dbd83a94c18b626c3215e<br></code></pre></td></tr></table></figure>

<h5 id="4-4-4-3-4-启动第二宿主机的weave并连接第一个宿主机"><a href="#4-4-4-3-4-启动第二宿主机的weave并连接第一个宿主机" class="headerlink" title="4.4.4.3.4 启动第二宿主机的weave并连接第一个宿主机"></a>4.4.4.3.4 启动第二宿主机的weave并连接第一个宿主机</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在第二个宿主机启动weave</span><br>[root@centos7 ~]<span class="hljs-comment">#chmod +x /usr/bin/weave</span><br>[root@centos7 ~]<span class="hljs-comment">#weave launch 10.0.0.100</span><br>latest: Pulling from weaveworks/weave<br>21c83c524219: Pull complete<br>cfdfcbee9cb6: Pull complete<br>a56e93dd024c: Pull complete<br>fea445d5ce38: Pull complete<br>59db32ebe99d: Pull complete<br>Digest: sha256:743ae84161f97bba965d5565344b04ff40770b32b06e1f55c8dfb1250c880e88<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> weaveworks/weave:latest<br>docker.io/weaveworks/weave:latest<br>latest: Pulling from weaveworks/weavedb<br>72bf8a6af285: Pull complete<br>Digest: sha256:7badb003b9c0bf5c51bf801be2a4d5d371f0738818f9cbe60a508f54fd07de9a<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> weaveworks/weavedb:latest<br>docker.io/weaveworks/weavedb:latest<br>Unable to find image <span class="hljs-string">&#x27;weaveworks/weaveexec:latest&#x27;</span> locally<br>latest: Pulling from weaveworks/weaveexec<br>21c83c524219: Already exists<br>cfdfcbee9cb6: Already exists<br>a56e93dd024c: Already exists<br>fea445d5ce38: Already exists<br>59db32ebe99d: Already exists<br>12d4ba695a4d: Pull complete<br>298ee7d058fb: Pull complete<br>85e41461f1eb: Pull complete<br>f322a47dd011: Pull complete<br>Digest: sha256:e666e66bf10c9da5dce52b777e86f9fbb62157169614a80f2dbe324b335c5602<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> weaveworks/weaveexec:latest<br>ab2ebef1670374ae81c3031c9de96df4136e55749f914eaddcb8e5e5aee60c6c<br><br><span class="hljs-comment">#查看两个宿主机的连接</span><br>[root@centos7 ~]<span class="hljs-comment">#ss -nt</span><br>State      Recv-Q Send-Q                 Local Address:Port                                Peer Address:Port                      ESTAB      0      0                         10.0.0.200:54102                                 10.0.0.100:6783 <br></code></pre></td></tr></table></figure>

<h5 id="4-4-4-3-5-通过weave-启动容器"><a href="#4-4-4-3-5-通过weave-启动容器" class="headerlink" title="4.4.4.3.5 通过weave 启动容器"></a>4.4.4.3.5 通过weave 启动容器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#第一个宿主机初始化环境</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#eval $(weave env)</span><br><span class="hljs-comment">#第一个宿主机开启动容器</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run --name a1 -ti weaveworks/ubuntu</span><br>root@a1:/<span class="hljs-comment"># hostname -i</span><br>10.32.0.1<br>root@a1:/<span class="hljs-comment"># ping -c1 a2 #第二个宿主机开启容器后才执行</span><br>PING a2 (10.44.0.0) 56(84) bytes of data.<br>64 bytes from a2.weave.local (10.44.0.0): icmp_seq=1 ttl=64 time=3.33 ms<br><br><span class="hljs-comment">#第二个宿主机初始化环境</span><br>[root@centos7 ~]<span class="hljs-comment">#eval $(weave env)</span><br><span class="hljs-comment">#第二个宿主机开启动容器</span><br>[root@centos7 ~]<span class="hljs-comment">#docker run --name a2 -ti weaveworks/ubuntu</span><br>root@a2:/<span class="hljs-comment"># hostname -i</span><br>10.44.0.0<br>root@a2:/<span class="hljs-comment"># ping -c1 a1</span><br>PING a1 (10.32.0.1) 56(84) bytes of data.<br>64 bytes from a1.weave.local (10.32.0.1): icmp_seq=1 ttl=64 time=0.474 ms<br></code></pre></td></tr></table></figure>

<h5 id="4-4-4-3-6-查看宿主机的容器"><a href="#4-4-4-3-6-查看宿主机的容器" class="headerlink" title="4.4.4.3.6 查看宿主机的容器"></a>4.4.4.3.6 查看宿主机的容器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#自动生成了weave相关的容器</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps -a</span><br>CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS               NAMES<br>023afc8c4a94        weaveworks/ubuntu             <span class="hljs-string">&quot;/w/w /bin/bash&quot;</span>         3 minutes ago       Up 3 minutes                            a1<br>eea87ea5cd83        weaveworks/weave:latest       <span class="hljs-string">&quot;/home/weave/weaver …&quot;</span>   14 minutes ago      Up 14 minutes                           weave<br>cd6f178bfe5a        weaveworks/weaveexec:latest   <span class="hljs-string">&quot;data-only&quot;</span>              14 minutes ago      Created                                 weavevolumes-latest<br>b49ceb1f851c        weaveworks/weavedb:latest     <span class="hljs-string">&quot;data-only&quot;</span>              14 minutes ago      Created                                 weavedb<br><br>[root@centos7 ~]<span class="hljs-comment">#docker ps -a</span><br>a0d5a7604644        weaveworks/ubuntu             <span class="hljs-string">&quot;/w/w /bin/bash&quot;</span>         About a minute ago   Up About a minute                       a2<br>876d24c2a286        weaveworks/weave:latest       <span class="hljs-string">&quot;/home/weave/weaver …&quot;</span>   5 minutes ago        Up 5 minutes                            weave<br>462bbe64dd75        weaveworks/weaveexec:latest   <span class="hljs-string">&quot;data-only&quot;</span>              5 minutes ago        Created                                 weavevolumes-latest<br>c4f6e70a242a        weaveworks/weavedb:latest     <span class="hljs-string">&quot;data-only&quot;</span>              5 minutes ago        Created                                 weavedb<br></code></pre></td></tr></table></figure>

<h2 id="4-5-实战案例-利用docker结合负载实现网络架构高可用"><a href="#4-5-实战案例-利用docker结合负载实现网络架构高可用" class="headerlink" title="4.5 实战案例: 利用docker结合负载实现网络架构高可用"></a>4.5 实战案例: 利用docker结合负载实现网络架构高可用</h2><h3 id="4-5-1-整体规划图"><a href="#4-5-1-整体规划图" class="headerlink" title="4.5.1 整体规划图"></a>4.5.1 整体规划图</h3><p>下图为一个小型的网络架构图，其中 nginx 使用docker 运行</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker77.png" srcset="/blog/img/loading.gif"></p>
<p><strong>环境准备</strong></p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>操作系统</th>
<th>宿主机IP</th>
<th>Docker0 IP</th>
<th>容器</th>
</tr>
</thead>
<tbody><tr>
<td>docker-server1</td>
<td>ubuntu 18.04</td>
<td>192.168.10.205/24</td>
<td>172.17.0.1/16</td>
<td>nginx-web1</td>
</tr>
<tr>
<td>docker-server2</td>
<td>ubuntu 18.04</td>
<td>192.168.10.206/24</td>
<td>172.17.0.1/16</td>
<td>nginx-web2</td>
</tr>
</tbody></table>
<h3 id="4-5-2-安装并配置keepalived"><a href="#4-5-2-安装并配置keepalived" class="headerlink" title="4.5.2 安装并配置keepalived"></a>4.5.2 安装并配置keepalived</h3><h4 id="4-5-2-1-Server1-安装并配置"><a href="#4-5-2-1-Server1-安装并配置" class="headerlink" title="4.5.2.1 Server1 安装并配置"></a>4.5.2.1 Server1 安装并配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker-server1 ~]<span class="hljs-comment"># apt install keepalived -y</span><br>[root@docker-server1 ~]<span class="hljs-comment"># vim /etc/keepalived/keepalived.conf</span><br>vrrp_instance MAKE_VIP_INT &#123;<br>state MASTER<br>interface eth0<br>virtual_router_id 1<br>priority 100<br>advert_int 1<br>unicast_src_ip 192.168.10.205<br>unicast_peer &#123;<br> 192.168.10.206<br>&#125;<br> authentication &#123;<br> auth_type PASS<br> auth_pass 1111<br>&#125;<br>virtual_ipaddress &#123;<br>  192.168.10.100/24 dev eth0 label eth0:1<br>&#125;<br>&#125;<br><br>[root@docker-server1~]<span class="hljs-comment"># systemctl restart keepalived</span><br>[root@docker-server1~]<span class="hljs-comment"># systemctl enable keepalived</span><br></code></pre></td></tr></table></figure>

<h4 id="4-5-2-2-Server2-安装并配置"><a href="#4-5-2-2-Server2-安装并配置" class="headerlink" title="4.5.2.2 Server2 安装并配置"></a>4.5.2.2 Server2 安装并配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker-server2 ~]<span class="hljs-comment"># apt install keepalived -y</span><br>[root@docker-server2 ~]<span class="hljs-comment"># vim /etc/keepalived/keepalived.conf</span><br>vrrp_instance MAKE_VIP_INT &#123;<br>state BACKUP<br>interface eth0<br>virtual_router_id 1<br>priority 50<br>advert_int 1<br>unicast_src_ip 192.168.10.206<br>unicast_peer &#123;<br>  192.168.10.205<br>&#125;<br>authentication &#123;<br> auth_type PASS<br> auth_pass 1111<br>&#125;<br>virtual_ipaddress &#123;<br>  192.168.10.100/24 dev eth0 label eth0:1<br>&#125;<br>&#125;<br><br>[root@docker-server2~]<span class="hljs-comment"># systemctl restart keepalived </span><br>[root@docker-server2~]<span class="hljs-comment"># systemctl enable keepalived</span><br></code></pre></td></tr></table></figure>

<h3 id="4-5-3-安装并配置haproxy"><a href="#4-5-3-安装并配置haproxy" class="headerlink" title="4.5.3 安装并配置haproxy"></a>4.5.3 安装并配置haproxy</h3><h4 id="4-5-3-1-修改系统内核使其可以监听本地不存在的IP"><a href="#4-5-3-1-修改系统内核使其可以监听本地不存在的IP" class="headerlink" title="4.5.3.1 修改系统内核使其可以监听本地不存在的IP"></a>4.5.3.1 修改系统内核使其可以监听本地不存在的IP</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker-server1 ~]<span class="hljs-comment"># sysctl -w net.ipv4.ip_nonlocal_bind=1</span><br>[root@docker-server2 ~]<span class="hljs-comment"># sysctl -w net.ipv4.ip_nonlocal_bind=1</span><br></code></pre></td></tr></table></figure>

<h4 id="4-5-3-2-Server1安装并配置haproxy"><a href="#4-5-3-2-Server1安装并配置haproxy" class="headerlink" title="4.5.3.2 Server1安装并配置haproxy"></a>4.5.3.2 Server1安装并配置haproxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker-server1 ~]<span class="hljs-comment"># apt install haproxy -y</span><br>[root@docker-server1 ~]<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>global<br>        <span class="hljs-comment">#chroot /var/lib/haproxy</span><br>        <span class="hljs-comment">#stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span><br>        <span class="hljs-comment">#stats timeout 30s</span><br>        <span class="hljs-comment">#user haproxy</span><br>        <span class="hljs-comment">#group haproxy</span><br>        uid 99<br>        gid 99<br>        daemon<br>        maxconn 100000<br>        daemon<br>        nbproc 1<br>        <span class="hljs-built_in">log</span> 127.0.0.1 local0 info<br><br>defaults<br>        option http-keep-alive<br>        <span class="hljs-comment">#option forwardfor</span><br>        maxconn 100000<br>        mode tcp<br>        timeout connect 500000ms<br>        timeout client 500000ms<br>        timeout server 500000ms<br><br>listen stats<br>        mode http<br>        <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br>        stats <span class="hljs-built_in">enable</span><br>        <span class="hljs-built_in">log</span> global<br>        stats uri /haproxy-status<br>        stats auth haadmin:q1w2e3r4ys<br><br>frontend docker_nginx_web<br>        <span class="hljs-built_in">bind</span> 192.168.10.100:80<br>        mode http        <br>        default_backend docker_nginx_hosts<br><br>backend docker_nginx_hosts<br>        mode http<br>        <span class="hljs-comment">#balance source</span><br>        balance roundrobin<br>        server 192.168.10.205 192.168.10.205:81 check inter 2000 fall 3 rise 5<br>        server 192.168.10.206 192.168.10.206:81 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h4 id="4-5-3-3-Server2安装并配置haproxy"><a href="#4-5-3-3-Server2安装并配置haproxy" class="headerlink" title="4.5.3.3 Server2安装并配置haproxy"></a>4.5.3.3 Server2安装并配置haproxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker-server2 ~]<span class="hljs-comment"># yum install haproxy -y</span><br>[root@docker-server2 ~]<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>global<br>        <span class="hljs-comment">#chroot /var/lib/haproxy</span><br>        <span class="hljs-comment">#stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span><br>        <span class="hljs-comment">#stats timeout 30s</span><br>        <span class="hljs-comment">#user haproxy</span><br>        <span class="hljs-comment">#group haproxy</span><br>        uid 99<br>        gid 99<br>        daemon<br>        maxconn 100000<br>        daemon<br>        nbproc 1<br>        <span class="hljs-built_in">log</span> 127.0.0.1 local0 info<br><br>defaults<br>        option http-keep-alive<br>        <span class="hljs-comment">#option forwardfor</span><br>        maxconn 100000<br>        mode tcp<br>        timeout connect 500000ms<br>        timeout client 500000ms<br>        timeout server 500000ms<br><br>listen stats<br>        mode http<br>        <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br>        stats <span class="hljs-built_in">enable</span><br>        <span class="hljs-built_in">log</span> global<br>        stats uri /haproxy-status<br>        stats auth haadmin:q1w2e3r4ys<br><br>frontend docker_nginx_web<br>        <span class="hljs-built_in">bind</span> 192.168.10.100:80<br>        mode http        <br>        default_backend docker_nginx_hosts<br><br>backend docker_nginx_hosts<br>        mode http<br>        <span class="hljs-comment">#balance source</span><br>        balance roundrobin<br>        server 192.168.10.205 192.168.10.205:81 check inter 2000 fall 3 rise 5<br>        server 192.168.10.206 192.168.10.206:81 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h4 id="4-5-3-4-各服务器别分启动haproxy"><a href="#4-5-3-4-各服务器别分启动haproxy" class="headerlink" title="4.5.3.4 各服务器别分启动haproxy"></a>4.5.3.4 各服务器别分启动haproxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker-server1 ~]<span class="hljs-comment"># systemctl enable haproxy</span><br>Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.<br>Executing: /lib/systemd/systemd-sysv-install <span class="hljs-built_in">enable</span> haproxy<br>[root@docker-server1 ~]<span class="hljs-comment"># systemctl restart haproxy</span><br>[root@docker-server2 ~]<span class="hljs-comment"># systemctl enable haproxy</span><br>Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.<br>Executing: /lib/systemd/systemd-sysv-install <span class="hljs-built_in">enable</span> haproxy<br>[root@docker-server2 ~]<span class="hljs-comment"># systemctl restart haproxy</span><br></code></pre></td></tr></table></figure>

<h3 id="4-5-4-服务器启动nginx容器并验证"><a href="#4-5-4-服务器启动nginx容器并验证" class="headerlink" title="4.5.4 服务器启动nginx容器并验证"></a>4.5.4 服务器启动nginx容器并验证</h3><h4 id="4-5-4-1-Server1和Server2-启动Nginx-容器"><a href="#4-5-4-1-Server1和Server2-启动Nginx-容器" class="headerlink" title="4.5.4.1 Server1和Server2 启动Nginx 容器"></a>4.5.4.1 Server1和Server2 启动Nginx 容器</h4><p>从本地Nginx镜像启动一个容器，并指定端口，默认协议是tcp方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker-server1 ~]<span class="hljs-comment"># docker rm -f `docker ps -a -q` #先删除之前所有的容器</span><br>[root@docker-server1 ~]<span class="hljs-comment"># docker run --name nginx-web1 -d -p 81:80 nginx-1.10.3:v1 nginx</span><br>5410e4042f731d2abe100519269f9241a7db2b3a188c6747b28423b5a584d020<br></code></pre></td></tr></table></figure>

<h4 id="4-5-4-2-Server1验证端口"><a href="#4-5-4-2-Server1验证端口" class="headerlink" title="4.5.4.2 Server1验证端口"></a>4.5.4.2 Server1验证端口</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker78.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-5-4-3-Server1验证web访问"><a href="#4-5-4-3-Server1验证web访问" class="headerlink" title="4.5.4.3 Server1验证web访问"></a>4.5.4.3 Server1验证web访问</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker79.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-5-4-4-Server1验证端口"><a href="#4-5-4-4-Server1验证端口" class="headerlink" title="4.5.4.4 Server1验证端口"></a>4.5.4.4 Server1验证端口</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker80.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-5-4-5-Server1验证web访问"><a href="#4-5-4-5-Server1验证web访问" class="headerlink" title="4.5.4.5 Server1验证web访问"></a>4.5.4.5 Server1验证web访问</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker81.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-5-4-6-访问VIP"><a href="#4-5-4-6-访问VIP" class="headerlink" title="4.5.4.6 访问VIP"></a>4.5.4.6 访问VIP</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker82.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-5-4-7-Server1-haproxy状态页面"><a href="#4-5-4-7-Server1-haproxy状态页面" class="headerlink" title="4.5.4.7 Server1 haproxy状态页面"></a>4.5.4.7 Server1 haproxy状态页面</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker83.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-5-4-8-Server2-haproxy状态页面"><a href="#4-5-4-8-Server2-haproxy状态页面" class="headerlink" title="4.5.4.8 Server2 haproxy状态页面"></a>4.5.4.8 Server2 haproxy状态页面</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker84.png" srcset="/blog/img/loading.gif"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/linux-docker/">linux docker</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AFdocker%EF%BC%88%E4%B8%89%EF%BC%89docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">企业级容器技术docker（三）docker数据管理</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AFdocker%EF%BC%88%E4%BA%94%EF%BC%89docker%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86/">
                        <span class="hidden-mobile">企业级容器技术docker（五）docker仓库管理</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
