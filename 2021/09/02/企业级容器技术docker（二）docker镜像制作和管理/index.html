

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>企业级容器技术docker（二）docker镜像制作和管理 - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="企业级容器技术docker（二）docker镜像制作和管理">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-02 14:30" pubdate>
        2021年9月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      22.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      374
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">企业级容器技术docker（二）docker镜像制作和管理</h1>
            
            <div class="markdown-body">
              <h1 id="企业级容器技术docker"><a href="#企业级容器技术docker" class="headerlink" title="企业级容器技术docker"></a>企业级容器技术docker</h1><h1 id="二、Docker-镜像制作和管理"><a href="#二、Docker-镜像制作和管理" class="headerlink" title="二、Docker 镜像制作和管理"></a>二、Docker 镜像制作和管理</h1><h2 id="2-1-Docker-镜像说明"><a href="#2-1-Docker-镜像说明" class="headerlink" title="2.1 Docker 镜像说明"></a>2.1 Docker 镜像说明</h2><h3 id="2-1-1-Docker-镜像中有没有内核"><a href="#2-1-1-Docker-镜像中有没有内核" class="headerlink" title="2.1.1 Docker 镜像中有没有内核"></a>2.1.1 Docker 镜像中有没有内核</h3><p>从镜像大小上面来说，一个比较小的镜像只有1MB多点或几MB，而内核文件需要几十MB， 因此镜像里面是没有内核的，镜像在被启动为容器后将直接使用宿主机的内核，而镜像本身则只提供相应的rootfs，即系统正常运行所必须的用户空间的文件系统，比如: /dev/，/proc，/bin，/etc等目录，容器当中/boot目录是空的，而/boot当中保存的就是与内核相关的文件和目录。</p>
<h3 id="2-1-2-为什么没有内核"><a href="#2-1-2-为什么没有内核" class="headerlink" title="2.1.2 为什么没有内核"></a>2.1.2 为什么没有内核</h3><p>由于容器启动和运行过程中是直接使用了宿主机的内核，不会直接调用物理硬件，所以也不会涉及到硬件驱动，因此也无需容器内拥有自已的内核和驱动。而如果使用虚拟机技术，对应每个虚拟机都有自已独立的内核</p>
<h3 id="2-1-3-容器中的程序后台运行会导致此容器启动后立即退出"><a href="#2-1-3-容器中的程序后台运行会导致此容器启动后立即退出" class="headerlink" title="2.1.3 容器中的程序后台运行会导致此容器启动后立即退出"></a>2.1.3 容器中的程序后台运行会导致此容器启动后立即退出</h3><p>Docker容器如果希望启动后能持续运行,就必须有一个能前台持续运行的进程，如果在容器中启动传统的服务，如:httpd,php-fpm等均为后台进程模式运行,就导致 docker 在前台没有运行的应用,这样的容器启动后会立即退出。所以一般会将服务程序以前台方式运行，对于有一些可能不知道怎么实现前台运行的程序,只需要在你启动的该程序之后添加类似于 tail ，top 这种可以前台运行的程序即可. 比较常用的方法，如 tail -f /etc/hosts 。</p>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#httpd</span><br>ENTRYPOINT [ <span class="hljs-string">&quot;/usr/sbin/apache2&quot;</span> ] <br>CMD [<span class="hljs-string">&quot;-D&quot;</span>, <span class="hljs-string">&quot;FOREGROUND&quot;</span>] <br><br><span class="hljs-comment">#nginx</span><br>ENTRYPOINT [ <span class="hljs-string">&quot;/usr/sbin/nginx&quot;</span>, <span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span> ] <br><br><span class="hljs-comment">#用脚本运行容器</span><br>cat run_haproxy.sh<br><span class="hljs-comment">#!/bin/bash</span><br>haproxy -f /etc/haproxy/haproxy.cfg<br>tail -f /etc/hosts<br><br>tail -n1 Dockerfile<br>CMD [<span class="hljs-string">&quot;run_haproxy.sh&quot;</span>]<br></code></pre></td></tr></table></figure>

<h3 id="2-1-4-docker-镜像生命周期"><a href="#2-1-4-docker-镜像生命周期" class="headerlink" title="2.1.4 docker 镜像生命周期"></a>2.1.4 docker 镜像生命周期</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker46.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-1-5-制作镜像方式"><a href="#2-1-5-制作镜像方式" class="headerlink" title="2.1.5 制作镜像方式"></a>2.1.5 制作镜像方式</h3><p>Docker 镜像制作类似于虚拟机的镜像（模版）制作，即按照公司的实际业务需求将需要安装的软件、相关配置等基础环境配置完成，然后将其做成镜像，最后再批量从镜像批量生成容器实例，这样可以极大的简化相同环境的部署工作.</p>
<p>Docker的镜像制作分为手动制作（基于容器）和自动制作(基于DockerFile)，企业通常都是基于Dockerfile制作镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker commit <span class="hljs-comment">#通过修改现有容器,将之手动构建为镜像</span><br>docker build  <span class="hljs-comment">#通过Dockerfile文件,批量构建为镜像</span><br></code></pre></td></tr></table></figure>

<h2 id="2-2-将现有容器通过-docker-commit-手动构建镜像"><a href="#2-2-将现有容器通过-docker-commit-手动构建镜像" class="headerlink" title="2.2 将现有容器通过 docker commit 手动构建镜像"></a>2.2 将现有容器通过 docker commit 手动构建镜像</h2><h3 id="2-2-1-基于容器手动制作镜像步骤"><a href="#2-2-1-基于容器手动制作镜像步骤" class="headerlink" title="2.2.1 基于容器手动制作镜像步骤"></a>2.2.1 基于容器手动制作镜像步骤</h3><p><strong>docker commit 格式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]<br><br><span class="hljs-comment">#选项</span><br>-a, --author string  Author (e.g., <span class="hljs-string">&quot;John Hannibal Smith &lt;hannibal@a-</span><br><span class="hljs-string">team.com&gt;&quot;</span>)<br>-c, --change list   Apply Dockerfile instruction to the created image<br>-m, --message string  Commit message<br>-p, --pause      Pause container during commit (default <span class="hljs-literal">true</span>)<br><br><span class="hljs-comment">#说明:</span><br>制作镜像和CONTAINER状态无关,停止状态也可以制作镜像<br>如果没有指定[REPOSITORY[:TAG]],REPOSITORY和TAG都为&lt;none&gt;<br>提交的时候标记TAG号: 生产当中常用，后期可以根据TAG标记创建不同版本的镜像以及创建不同版本的容器<br></code></pre></td></tr></table></figure>

<p>基于容器手动制作镜像步骤具体如下:</p>
<ol>
<li>下载一个系统的官方基础镜像，如: CentOS 或 Ubuntu</li>
<li>基于基础镜像启动一个容器,并进入到容器</li>
<li>在容器里面做配置操作</li>
</ol>
<ul>
<li>安装基础命令</li>
<li>配置运行环境</li>
<li>安装服务和配置服务</li>
<li>放业务程序代码</li>
</ul>
<ol start="4">
<li>提交为一个新镜像 docker commit</li>
<li>基于自己的的镜像创建容器并测试访问</li>
</ol>
<h3 id="2-2-2-实战案例-基于-busybox-制作-httpd-镜像"><a href="#2-2-2-实战案例-基于-busybox-制作-httpd-镜像" class="headerlink" title="2.2.2 实战案例: 基于 busybox 制作 httpd 镜像"></a>2.2.2 实战案例: 基于 busybox 制作 httpd 镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --name b1 busybox</span><br>/ <span class="hljs-comment"># ls</span><br>bin  dev  etc  home proc root sys  tmp  usr  var<br>/ <span class="hljs-comment"># mkdir /data/html -p</span><br>/ <span class="hljs-comment"># echo httpd website in busybox &gt; /data/html/index.html</span><br>/ <span class="hljs-comment"># httpd --help</span><br>BusyBox v1.32.0 (2020-06-27 00:20:57 UTC) multi-call binary<br><br>Usage: httpd [-ifv[v]] [-c CONFFILE] [-p [IP:]PORT] [-u USER[:GRP]] [-r REALM]<br>[-h HOME]<br><br>or httpd -d/-e/-m STRING<br><br>Listen <span class="hljs-keyword">for</span> incoming HTTP requests<br><br>-i Inetd mode<br>-f Don<span class="hljs-string">&#x27;t daemonize</span><br><span class="hljs-string">-v[v] Verbose 显示访问日志</span><br><span class="hljs-string">-p [IP:]PORT Bind to IP:PORT (default *:80)</span><br><span class="hljs-string">-u USER[:GRP] Set uid/gid after binding to port</span><br><span class="hljs-string">-r REALM Authentication Realm for Basic Authentication</span><br><span class="hljs-string">-h HOME Home directory (default .)</span><br><span class="hljs-string">-c FILE Configuration file (default &#123;/etc,HOME&#125;/httpd.conf)</span><br><span class="hljs-string">-m STRING MD5 crypt STRING</span><br><span class="hljs-string">-e STRING HTML encode STRING</span><br><span class="hljs-string">-d STRING URL decode STRING</span><br><span class="hljs-string">/ # exit</span><br><span class="hljs-string"></span><br><span class="hljs-string">#格式1</span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker commit -a &quot;rlin&lt;root@rlin.com&gt;&quot; -c &#x27;</span>CMD /bin/httpd -fv -h /data/html<span class="hljs-string">&#x27; -c &quot;EXPOSE 80&quot; b1 httpd-busybox:v1.0</span><br><span class="hljs-string">sha256:b80c85227ae7075df2f1d62e4fccbd630cac5d7b235c1001d45e5c4c820d4a52</span><br><span class="hljs-string"></span><br><span class="hljs-string">#格式2</span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker commit -a &quot;rlin&lt;root@rlin.com&gt;&quot; -c &#x27;</span>CMD [<span class="hljs-string">&quot;/bin/httpd&quot;</span>, <span class="hljs-string">&quot;-f&quot;</span>, <span class="hljs-string">&quot;-v&quot;</span>,<span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;/data/html&quot;</span>]<span class="hljs-string">&#x27; -c &quot;EXPOSE 80&quot; b1 httpd-busybox:v1.1</span><br><span class="hljs-string">sha256:dafcbf3c46ec586d2355bc997f6c522bcede47743e9214b3275491aea2d2acb2</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker images</span><br><span class="hljs-string">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="hljs-string">httpd-busybox       v1.1                dafcbf3c46ec        18 seconds ago      1.24MB</span><br><span class="hljs-string">httpd-busybox       v1.0                b80c85227ae7        2 minutes ago       1.24MB</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker run -d -P --name httpd01 httpd-busybox:v1.0</span><br><span class="hljs-string">360842f6bae8990e1a4c4aa690d368f530deee676315e7347cb065238964e6d8</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker port httpd01</span><br><span class="hljs-string">80/tcp -&gt; 0.0.0.0:10001</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker inspect -f &quot;&#123;&#123;.NetworkSettings.Networks.bridge.IPAddress&#125;&#125;&quot; httpd01</span><br><span class="hljs-string">172.17.0.2</span><br><span class="hljs-string"></span><br><span class="hljs-string">#对应格式1</span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker inspect -f &quot;&#123;&#123;.Config.Cmd&#125;&#125;&quot; httpd01</span><br><span class="hljs-string">[/bin/sh -c /bin/httpd -f -h /data/html]</span><br><span class="hljs-string"></span><br><span class="hljs-string">#对应格式2</span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker inspect -f &quot;&#123;&#123;.Config.Cmd&#125;&#125;&quot; httpd01</span><br><span class="hljs-string">[/bin/httpd -f -h /data/html]</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker exec -it httpd01 sh</span><br><span class="hljs-string">/ # pstree -p</span><br><span class="hljs-string">httpd(1)</span><br><span class="hljs-string">/ # ps aux</span><br><span class="hljs-string">PID  USER   TIME COMMAND</span><br><span class="hljs-string">  1 root    0:00 /bin/httpd -fv -h /data/html</span><br><span class="hljs-string">  7 root    0:00 sh</span><br><span class="hljs-string"> 13 root    0:00 ps aux</span><br><span class="hljs-string">/ #</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@ubuntu1804 ~]#curl 172.17.0.2</span><br><span class="hljs-string">httpd website in busybox</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@ubuntu1804 ~]#curl 127.0.0.1:10001</span><br><span class="hljs-string">httpd website in busybox</span><br><span class="hljs-string"></span><br><span class="hljs-string">#再次制作镜像v2.0版</span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker commit -a &quot;rlin&lt;root@rlin.com&gt;&quot; b1 httpd-busybox:v2.0</span><br><span class="hljs-string">sha256:7ee80a2e0cce4d06b574d74b6085ad154f91a03dc31118b906579de58732089c</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@ubuntu1804 ~]#docker run -d --name web2 -p 81:80 httpd-busybox:v2.0 /bin/httpd -fv -h /data/html</span><br><span class="hljs-string">bbb8b7befa998a04ac0e78f1620e66b9009e86f818de555d30d0a650b52c1f97</span><br><span class="hljs-string">[root@ubuntu1804:~]# docker port web2</span><br><span class="hljs-string">80/tcp -&gt; 0.0.0.0:81</span><br><span class="hljs-string">[root@ubuntu1804:~]# docker inspect -f &quot;&#123;&#123;.NetworkSettings.Networks.bridge.IPAddress&#125;&#125;&quot; web2</span><br><span class="hljs-string">172.17.0.3</span><br><span class="hljs-string">[root@ubuntu1804:~]# curl 172.17.0.3</span><br><span class="hljs-string">httpd website in busybox</span><br><span class="hljs-string">[root@ubuntu1804:~]# curl 127.0.0.3:81</span><br><span class="hljs-string">httpd website in busybox</span><br></code></pre></td></tr></table></figure>

<h3 id="2-2-3-实战案例-基于官方镜像生成的容器制作-tomcat-镜像"><a href="#2-2-3-实战案例-基于官方镜像生成的容器制作-tomcat-镜像" class="headerlink" title="2.2.3 实战案例: 基于官方镜像生成的容器制作 tomcat 镜像"></a>2.2.3 实战案例: 基于官方镜像生成的容器制作 tomcat 镜像</h3><h4 id="2-2-3-1-下载官方的tomcat镜像并运行"><a href="#2-2-3-1-下载官方的tomcat镜像并运行" class="headerlink" title="2.2.3.1 下载官方的tomcat镜像并运行"></a>2.2.3.1 下载官方的tomcat镜像并运行</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d -p 8080:8080 tomcat</span><br>Unable to find image <span class="hljs-string">&#x27;tomcat:latest&#x27;</span> locally<br>latest: Pulling from library/tomcat<br>0bc3020d05f1: Pull complete <br>a110e5871660: Pull complete <br>83d3c0fa203a: Pull complete <br>a8fd09c11b02: Pull complete <br>96ebf1506065: Pull complete <br>b8bf70f9cc4d: Pull complete <br>3f6da67b9e68: Pull complete <br>257407776119: Pull complete <br>541802ef66b7: Pull complete <br>1e119b3654ab: Pull complete <br>Digest: sha256:d0e769cea1684c065bb6a2e52f13cd5d7138a19a5ef3c16828f32e9bd8323f56<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> tomcat:latest<br>3e1822132db2d42cf978a6f705ba57941593e1dca77b7d4249548a1d3235c97a<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES<br>3e1822132db2        tomcat              <span class="hljs-string">&quot;catalina.sh run&quot;</span>   28 minutes ago      Up 28 minutes       0.0.0.0:8080-&gt;8080/tcp   elegant_mahavira<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl -I 127.0.0.1:8080</span><br>HTTP/1.1 404<br>Content-Type: text/html;charset=utf-8<br>Content-Language: en<br>Transfer-Encoding: chunked<br>Date: Mon, 20 Jul 2020 15:33:21 GMT<br></code></pre></td></tr></table></figure>

<h4 id="2-2-3-2-修改容器"><a href="#2-2-3-2-修改容器" class="headerlink" title="2.2.3.2 修改容器"></a>2.2.3.2 修改容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it 3e1822132db2 bash</span><br>root@3e1822132db2:/usr/<span class="hljs-built_in">local</span>/tomcat<span class="hljs-comment"># ls</span><br>BUILDING.txt	 LICENSE  README.md	 RUNNING.txt  conf  logs	    temp     webapps.dist<br>CONTRIBUTING.md  NOTICE   RELEASE-NOTES  bin	      lib   native-jni-lib  webapps  work<br>root@3e1822132db2:/usr/<span class="hljs-built_in">local</span>/tomcat<span class="hljs-comment"># ls webapps</span><br>root@3e1822132db2:/usr/<span class="hljs-built_in">local</span>/tomcat<span class="hljs-comment"># ls webapps.dist/</span><br>ROOT  docs  examples  host-manager  manager<br>root@3e1822132db2:/usr/<span class="hljs-built_in">local</span>/tomcat<span class="hljs-comment"># cp -a webapps.dist/* webapps/</span><br>root@3e1822132db2:/usr/<span class="hljs-built_in">local</span>/tomcat<span class="hljs-comment"># ls webapps</span><br>ROOT  docs  examples  host-manager  manager<br>root@3e1822132db2:/usr/<span class="hljs-built_in">local</span>/tomcat<span class="hljs-comment"># exit</span><br><span class="hljs-built_in">exit</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl -I 127.0.0.1:8080</span><br>HTTP/1.1 200<br>Content-Type: text/html;charset=UTF-8<br>Transfer-Encoding: chunked<br>Date: Mon, 20 Jul 2020 15:34:24 GMT<br></code></pre></td></tr></table></figure>

<h4 id="2-2-3-3-提交新镜像"><a href="#2-2-3-3-提交新镜像" class="headerlink" title="2.2.3.3 提交新镜像"></a>2.2.3.3 提交新镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker commit -m &quot;add webapps app&quot; -a &quot;wangxiaochun&quot; 3e1822132db2 tomcat:9.0.37-v1</span><br>sha256:1792d4c072d9ef255fe56ee589d00c0667e19e0d00bb5a2b7bd23d50880283a4<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>tomcat              9.0.37-v1           1792d4c072d9        22 seconds ago      672MB<br>tomcat              latest              b0bf9a4a7c93        45 hours ago        667MB<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker history tomcat:9.0.37-v1</span><br>IMAGE               CREATED              CREATED BY                                      SIZE                COMMENT<br>1792d4c072d9        About a minute ago   catalina.sh run                                 4.93MB              add webapps app<br>b0bf9a4a7c93        45 hours ago         /bin/sh -c <span class="hljs-comment">#(nop)  CMD [&quot;catalina.sh&quot; &quot;run&quot;]    0B                  </span><br>&lt;missing&gt;           45 hours ago         /bin/sh -c <span class="hljs-comment">#(nop)  EXPOSE 8080                  0B                  </span><br>&lt;missing&gt;           45 hours ago         /bin/sh -c <span class="hljs-built_in">set</span> -eux;  nativeLines=<span class="hljs-string">&quot;<span class="hljs-subst">$(catalin…   0B                  </span></span><br><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c set -eux;   savedAptMark=<span class="hljs-string">&quot;<span class="hljs-subst">$(apt-m…   20.3MB              </span></span></span></span><br><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c #(nop)</span>  ENV TOMCAT_SHA512=9fcde76…   0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c #(nop)  ENV TOMCAT_VERSION=9.0.48    0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c #(nop)  ENV TOMCAT_MAJOR=9           0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c #(nop)  ENV GPG_KEYS=48F8E69F6390…   0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c #(nop)  ENV LD_LIBRARY_PATH=/usr/…   0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c #(nop)  ENV TOMCAT_NATIVE_LIBDIR=…   0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c #(nop) WORKDIR /usr/local/tomcat     0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c mkdir -p &quot;</span>$CATALINA_HOME<span class="hljs-string">&quot;            0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c #(nop)  ENV PATH=/usr/local/tomca…   0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           45 hours ago         /bin/sh -c #(nop)  ENV CATALINA_HOME=/usr/lo…   0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           2 days ago           /bin/sh -c #(nop)  CMD [&quot;</span>jshell<span class="hljs-string">&quot;]               0B                  </span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           2 days ago           /bin/sh -c set -eux;   arch=&quot;</span>$(dpkg --print-…   342MB               </span></span><br><span class="hljs-subst"><span class="hljs-string">&lt;missing&gt;           4 days ago           /bin/sh -c #(nop)</span>  ENV JAVA_VERSION=11.0.11+9   0B                  </span><br><span class="hljs-string">&lt;missing&gt;           4 days ago           /bin/sh -c #(nop)  ENV LANG=C.UTF-8             0B                  </span><br><span class="hljs-string">&lt;missing&gt;           4 days ago           /bin/sh -c #(nop)  ENV PATH=/usr/local/openj…   0B                  </span><br><span class="hljs-string">&lt;missing&gt;           4 days ago           /bin/sh -c &#123; echo &#x27;#/bin/sh&#x27;; echo &#x27;echo &quot;</span><span class="hljs-variable">$J</span>…   27B                 <br>&lt;missing&gt;           4 days ago           /bin/sh -c <span class="hljs-comment">#(nop)  ENV JAVA_HOME=/usr/local/…   0B                  </span><br>&lt;missing&gt;           4 days ago           /bin/sh -c <span class="hljs-built_in">set</span> -eux;  apt-get update;  apt-g…   11.1MB              <br>&lt;missing&gt;           5 days ago           /bin/sh -c apt-get update &amp;&amp; apt-get install…   146MB               <br>&lt;missing&gt;           5 days ago           /bin/sh -c <span class="hljs-built_in">set</span> -ex;  <span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v gpg &gt; /…   17.5MB              <br>&lt;missing&gt;           5 days ago           /bin/sh -c <span class="hljs-built_in">set</span> -eux;  apt-get update;  apt-g…   16.5MB              <br>&lt;missing&gt;           5 days ago           /bin/sh -c <span class="hljs-comment">#(nop)  CMD [&quot;bash&quot;]                 0B                  </span><br>&lt;missing&gt;           5 days ago           /bin/sh -c <span class="hljs-comment">#(nop) ADD file:a232795a746e5842d…   114MB</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker inspect tomcat:9.0.37-v1 |tail -n20</span><br><span class="hljs-string">&quot;Type&quot;</span>: <span class="hljs-string">&quot;layers&quot;</span>,<br>            <span class="hljs-string">&quot;Layers&quot;</span>: [<br>                <span class="hljs-string">&quot;sha256:4e006334a6fdea37622f72b21eb75fe1484fc4f20ce8b8526187d6f7bd90a6fe&quot;</span>,<br>                <span class="hljs-string">&quot;sha256:e4d0e810d54a9c47e3dface412b0b88045d156b18809a2e0bbfb0fc8a45d8127&quot;</span>,<br>                <span class="hljs-string">&quot;sha256:fe6a4fdbedc0cbc560437fa700b3b034114e31a264f0818d0d32ed2ee6cbe7a3&quot;</span>,<br>                <span class="hljs-string">&quot;sha256:7095af798ace32173839a61cbf101048434e1065185c0f29cc888e67158d990b&quot;</span>,<br>                <span class="hljs-string">&quot;sha256:79c550eb7bd278d360284d86c39e05852c2026b64232267a43947300bcf54a2c&quot;</span>,<br>                <span class="hljs-string">&quot;sha256:c0848348e2f7a56acbdaa24e3ee321b5c85651fce0317aa47ada385a4f9a4e85&quot;</span>,<br>                <span class="hljs-string">&quot;sha256:6ea995e9b7d379dd368b12fcde9b116035765cd2a58a72fd0e2dab4ea01392b7&quot;</span>,<br>                <span class="hljs-string">&quot;sha256:b59bec8e923057ad30f9bacd026af8f91aa3faad3bcf084ebeb7ecb22eb479a6&quot;</span>,<br>                <span class="hljs-string">&quot;sha256:9dfdabdf2745656a4bf254852fa0cc15bc5626c731b99f080b72f1a595950c8d&quot;</span>,<br>                <span class="hljs-string">&quot;sha256:eb671b209e8d418fda78f5e2dace79c8ee9f49b10c33ae283e565c55aa9f660c&quot;</span>,<br>                <span class="hljs-string">&quot;sha256:2902101127c1861447bc23e9f1c72f2541ec7b98be22b17443bfcda0ee37cde6&quot;</span><br>            ]<br>        &#125;,<br>        <span class="hljs-string">&quot;Metadata&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;LastTagTime&quot;</span>: <span class="hljs-string">&quot;2021-06-28T10:19:57.26119554+08:00&quot;</span><br>        &#125;<br>    &#125;<br>]<br><br><span class="hljs-comment">#删除当前的容器</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker rm -f 3e1822132db2</span><br>3e1822132db2<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES<br></code></pre></td></tr></table></figure>

<h4 id="2-2-3-4-利用新镜像启动容器"><a href="#2-2-3-4-利用新镜像启动容器" class="headerlink" title="2.2.3.4 利用新镜像启动容器"></a>2.2.3.4 利用新镜像启动容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d -p 8080:8080 --name tomcat tomcat:9.0.37-v1</span><br>e4c841d7fc92656e263a532d84e3c5f0f17e5bad06b6b92d255153076e29a118<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES<br>e4c841d7fc92        tomcat:9.0.37-v1    <span class="hljs-string">&quot;catalina.sh run&quot;</span>   25 seconds ago      Up 23 seconds       0.0.0.0:8080-&gt;8080/tcp   tomcat<br></code></pre></td></tr></table></figure>

<h4 id="2-2-3-5-测试新镜像启动的容器"><a href="#2-2-3-5-测试新镜像启动的容器" class="headerlink" title="2.2.3.5 测试新镜像启动的容器"></a>2.2.3.5 测试新镜像启动的容器</h4><p>浏览器访问 <a target="_blank" rel="noopener" href="http://10.0.0.100:8080/">http://10.0.0.100:8080/</a> 可以看到下面显示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker47.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-2-4-实战案例-基于Ubuntu的基础镜像利用-apt-安装手动制作nginx-的镜像"><a href="#2-2-4-实战案例-基于Ubuntu的基础镜像利用-apt-安装手动制作nginx-的镜像" class="headerlink" title="2.2.4 实战案例: 基于Ubuntu的基础镜像利用 apt 安装手动制作nginx 的镜像"></a>2.2.4 实战案例: 基于Ubuntu的基础镜像利用 apt 安装手动制作nginx 的镜像</h3><h4 id="2-2-4-1-启动Ubuntu基础镜像并实现相关的配置"><a href="#2-2-4-1-启动Ubuntu基础镜像并实现相关的配置" class="headerlink" title="2.2.4.1 启动Ubuntu基础镜像并实现相关的配置"></a>2.2.4.1 启动Ubuntu基础镜像并实现相关的配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it -p 80 --name nginx_ubuntu ubuntu bash</span><br>root@9aad02c33b6d:/<span class="hljs-comment"># cat /etc/os-release </span><br>NAME=<span class="hljs-string">&quot;Ubuntu&quot;</span><br>VERSION=<span class="hljs-string">&quot;20.04.2 LTS (Focal Fossa)&quot;</span><br>ID=ubuntu<br>ID_LIKE=debian<br>PRETTY_NAME=<span class="hljs-string">&quot;Ubuntu 20.04.2 LTS&quot;</span><br>VERSION_ID=<span class="hljs-string">&quot;20.04&quot;</span><br>HOME_URL=<span class="hljs-string">&quot;https://www.ubuntu.com/&quot;</span><br>SUPPORT_URL=<span class="hljs-string">&quot;https://help.ubuntu.com/&quot;</span><br>BUG_REPORT_URL=<span class="hljs-string">&quot;https://bugs.launchpad.net/ubuntu/&quot;</span><br>PRIVACY_POLICY_URL=<span class="hljs-string">&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span><br>VERSION_CODENAME=focal<br>UBUNTU_CODENAME=focal<br>root@9aad02c33b6d:/<span class="hljs-comment"># ll /etc/apt/sources.list</span><br>-rw-r--r-- 1 root root 2777 Jun 28 02:35 /etc/apt/sources.list<br><br>root@9aad02c33b6d:/<span class="hljs-comment"># sed -i &quot;s@http://.*archive.ubuntu.com@http://repo.huaweicloud.com@g&quot; /etc/apt/sources.list     </span><br>root@9aad02c33b6d:/<span class="hljs-comment"># sed -i &quot;s@http://.*security.ubuntu.com@http://repo.huaweicloud.com@g&quot; /etc/apt/sources.list</span><br><br>root@9aad02c33b6d:/<span class="hljs-comment"># apt update</span><br>Get:1 http://repo.huaweicloud.com/ubuntu focal InRelease [265 kB]<br>Get:2 http://repo.huaweicloud.com/ubuntu focal-updates InRelease [114 kB]<br>Get:3 http://repo.huaweicloud.com/ubuntu focal-backports InRelease [101 kB]<br>Get:4 http://repo.huaweicloud.com/ubuntu focal-security InRelease [114 kB]<br>Get:5 http://repo.huaweicloud.com/ubuntu focal/restricted amd64 Packages [33.4 kB]<br>Get:6 http://repo.huaweicloud.com/ubuntu focal/universe amd64 Packages [11.3 MB]<br>Get:7 http://repo.huaweicloud.com/ubuntu focal/main amd64 Packages [1275 kB]                                               <br>Get:8 http://repo.huaweicloud.com/ubuntu focal/multiverse amd64 Packages [177 kB]                                          <br>Get:9 http://repo.huaweicloud.com/ubuntu focal-updates/restricted amd64 Packages [411 kB]                                  <br>Get:10 http://repo.huaweicloud.com/ubuntu focal-updates/universe amd64 Packages [1032 kB]                                  <br>Get:11 http://repo.huaweicloud.com/ubuntu focal-updates/main amd64 Packages [1356 kB]                                      <br>Get:12 http://repo.huaweicloud.com/ubuntu focal-updates/multiverse amd64 Packages [32.0 kB]                                <br>Get:13 http://repo.huaweicloud.com/ubuntu focal-backports/universe amd64 Packages [4305 B]                                 <br>Get:14 http://repo.huaweicloud.com/ubuntu focal-security/universe amd64 Packages [777 kB]                                  <br>Get:15 http://repo.huaweicloud.com/ubuntu focal-security/main amd64 Packages [925 kB]                                      <br>Get:16 http://repo.huaweicloud.com/ubuntu focal-security/multiverse amd64 Packages [27.6 kB]                               <br>Get:17 http://repo.huaweicloud.com/ubuntu focal-security/restricted amd64 Packages [368 kB]                                <br>Fetched 18.4 MB <span class="hljs-keyword">in</span> 9s (2101 kB/s)                                                                                          <br>Reading package lists... Done<br>Building dependency tree       <br>Reading state information... Done<br>9 packages can be upgraded. Run <span class="hljs-string">&#x27;apt list --upgradable&#x27;</span> to see them.<br><br>root@9aad02c33b6d:/<span class="hljs-comment"># apt install -y nginx</span><br>Reading package lists... Done<br>Building dependency tree       <br>Reading state information... Done<br>The following additional packages will be installed:<br>........<br>Configuring tzdata<br>------------------<br><br>Please select the geographic area <span class="hljs-keyword">in</span> <span class="hljs-built_in">which</span> you live. Subsequent configuration questions will narrow this down by presenting<br>a list of cities, representing the time zones <span class="hljs-keyword">in</span> <span class="hljs-built_in">which</span> they are located.<br><br>  1. Africa   3. Antarctica  5. Arctic  7. Atlantic  9. Indian    11. SystemV  13. Etc<br>  2. America  4. Australia   6. Asia    8. Europe    10. Pacific  12. US<br>Geographic area: 6<br><br>Please select the city or region corresponding to your time zone.<br><br>  1. Aden      14. Beirut      27. Gaza         40. Karachi       53. Muscat        66. Riyadh         79. Tokyo<br>  2. Almaty    15. Bishkek     28. Harbin       41. Kashgar       54. Nicosia       67. Sakhalin       80. Tomsk<br>  3. Amman     16. Brunei      29. Hebron       42. Kathmandu     55. Novokuznetsk  68. Samarkand      81. Ujung_Pandang<br>  4. Anadyr    17. Chita       30. Ho_Chi_Minh  43. Khandyga      56. Novosibirsk   69. Seoul          82. Ulaanbaatar<br>  5. Aqtau     18. Choibalsan  31. Hong_Kong    44. Kolkata       57. Omsk          70. Shanghai       83. Urumqi<br>  6. Aqtobe    19. Chongqing   32. Hovd         45. Krasnoyarsk   58. Oral          71. Singapore      84. Ust-Nera<br>  7. Ashgabat  20. Colombo     33. Irkutsk      46. Kuala_Lumpur  59. Phnom_Penh    72. Srednekolymsk  85. Vientiane<br>  8. Atyrau    21. Damascus    34. Istanbul     47. Kuching       60. Pontianak     73. Taipei         86. Vladivostok<br>  9. Baghdad   22. Dhaka       35. Jakarta      48. Kuwait        61. Pyongyang     74. Tashkent       87. Yakutsk<br>  10. Bahrain  23. Dili        36. Jayapura     49. Macau         62. Qatar         75. Tbilisi        88. Yangon<br>  11. Baku     24. Dubai       37. Jerusalem    50. Magadan       63. Qostanay      76. Tehran         89. Yekaterinburg<br>  12. Bangkok  25. Dushanbe    38. Kabul        51. Makassar      64. Qyzylorda     77. Tel_Aviv       90. Yerevan<br>  13. Barnaul  26. Famagusta   39. Kamchatka    52. Manila        65. Rangoon       78. Thimphu<br>Time zone: 70<br><br><br>Current default time zone: <span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span><br>Local time is now:      Mon Jun 28 10:37:06 CST 2021.<br>Universal Time is now:  Mon Jun 28 02:37:06 UTC 2021.<br>Run <span class="hljs-string">&#x27;dpkg-reconfigure tzdata&#x27;</span> <span class="hljs-keyword">if</span> you wish to change it.<br>......<br>Setting up nginx (1.18.0-0ubuntu1.2) ...<br>Processing triggers <span class="hljs-keyword">for</span> libc-bin (2.31-0ubuntu9.2) ...<br>root@9aad02c33b6d:/<span class="hljs-comment"># nginx -v</span><br>nginx version: nginx/1.18.0 (Ubuntu)<br>root@9aad02c33b6d:/<span class="hljs-comment"># grep include /etc/nginx/nginx.conf </span><br>include /etc/nginx/modules-enabled/*.conf;<br>	include /etc/nginx/mime.types;<br>	include /etc/nginx/conf.d/*.conf;<br>	include /etc/nginx/sites-enabled/*;<br>root@9aad02c33b6d:/<span class="hljs-comment"># grep root /etc/nginx/sites-enabled/default </span><br>	root /var/www/html;<br>	<span class="hljs-comment"># deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="hljs-comment">#	root /var/www/example.com;</span><br>root@9aad02c33b6d:/<span class="hljs-comment"># echo Nginx Website in Docker &gt; /var/www/html/index.html</span><br>root@9aad02c33b6d:/<span class="hljs-comment"># exit</span><br><span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-4-2-提交为镜像"><a href="#2-2-4-2-提交为镜像" class="headerlink" title="2.2.4.2 提交为镜像"></a>2.2.4.2 提交为镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker commit -a &#x27;wangxiaochun&#x27; -m &#x27;nginx-ubuntu:20.04&#x27; nginx_ubuntu nginx_ubuntu20.04:v1.18.0</span><br>sha256:ae81b509dba6bf9483f2391d5e25a6268253864d53866f2ea36663fcf986ab48<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>nginx_ubuntu20.04   v1.18.0             ae81b509dba6        40 seconds ago      161MB<br>ubuntu              latest              9873176a8ff5        10 days ago         72.7MB<br></code></pre></td></tr></table></figure>

<h4 id="2-2-4-3-从制作的新镜像启动容器并测试访问"><a href="#2-2-4-3-从制作的新镜像启动容器并测试访问" class="headerlink" title="2.2.4.3 从制作的新镜像启动容器并测试访问"></a>2.2.4.3 从制作的新镜像启动容器并测试访问</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d -p 80 --name nginx-web nginx_ubuntu20.04:v1.18.0 nginx -g &#x27;daemon off;&#x27;</span><br>b0c8496a497ba60f7b5bc430b075b00d40c7ace24068e71decac625e84df40de<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID    IMAGE            COMMAND         CREATED<br>      STATUS       PORTS          NAMES<br>b0c8496a497b    nginx_ubuntu20.04:v1.18.0  <span class="hljs-string">&quot;nginx -g &#x27;daemon of…&quot;</span>  7<br>seconds ago    Up 5 seconds     0.0.0.0:32771-&gt;80/tcp  nginx-web<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker port nginx-web</span><br>80/tcp -&gt; 0.0.0.0:32771<br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl http://127.0.0.1:32771</span><br>Nginx Website <span class="hljs-keyword">in</span> Docker<br></code></pre></td></tr></table></figure>

<h3 id="2-2-5-实战案例-基于CentOS的基础镜像利用-yum-安装手动制作-nginx-的镜像"><a href="#2-2-5-实战案例-基于CentOS的基础镜像利用-yum-安装手动制作-nginx-的镜像" class="headerlink" title="2.2.5 实战案例: 基于CentOS的基础镜像利用 yum 安装手动制作 nginx 的镜像"></a>2.2.5 实战案例: 基于CentOS的基础镜像利用 yum 安装手动制作 nginx 的镜像</h3><h4 id="2-2-5-1下载基础镜像并初始化系统"><a href="#2-2-5-1下载基础镜像并初始化系统" class="headerlink" title="2.2.5.1下载基础镜像并初始化系统"></a>2.2.5.1下载基础镜像并初始化系统</h4><p>基于某个基础镜像之上重新制作，因此需要先有一个基础镜像，本次使用官方提供的centos镜像为基础</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker pull centos:centos7.7.1908</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>centos              centos7.7.1908      08d05d1d5859        19 months ago       204MB<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it centos:centos7.7.1908 bash</span><br><br><span class="hljs-comment">#修改时区</span><br>[root@9caa8742e6ce /]<span class="hljs-comment">#rm -f /etc/localtime</span><br>[root@9caa8742e6ce /]<span class="hljs-comment">#ln -s ../usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br>[root@9caa8742e6ce /]<span class="hljs-comment"># yum -y install wget</span><br>[root@9caa8742e6ce /]<span class="hljs-comment"># rm -rf /etc/yum.repos.d/*</span><br><br><span class="hljs-comment">#更改yum 源</span><br>[root@9caa8742e6ce /]<span class="hljs-comment"># wget -P /etc/yum.repos.d/ http://mirrors.aliyun.com/repo/Centos-7.repo</span><br>[root@9caa8742e6ce /]<span class="hljs-comment"># wget -P /etc/yum.repos.d/ http://mirrors.aliyun.com/repo/epel-7.repo</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-2-安装相关软件和工具"><a href="#2-2-5-2-安装相关软件和工具" class="headerlink" title="2.2.5.2 安装相关软件和工具"></a>2.2.5.2 安装相关软件和工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#yum安装nginx</span><br>[root@9caa8742e6ce /]<span class="hljs-comment"># yum install nginx –y</span><br><br><span class="hljs-comment">#安装常用命令</span><br>[root@9caa8742e6ce /]<span class="hljs-comment"># yum install -y vim curl iproute net-tools</span><br><br><span class="hljs-comment">#清理yum缓存</span><br>[root@9caa8742e6ce /]<span class="hljs-comment"># rm -rf /var/cache/yum/*</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-3-修改服务的配置信息关闭服务后台运行"><a href="#2-2-5-3-修改服务的配置信息关闭服务后台运行" class="headerlink" title="2.2.5.3 修改服务的配置信息关闭服务后台运行"></a>2.2.5.3 修改服务的配置信息关闭服务后台运行</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#关闭nginx后台运行</span><br>[root@9caa8742e6ce /]<span class="hljs-comment"># vim /etc/nginx/nginx.conf</span><br>user nginx;<br>daemon off; <span class="hljs-comment">#关闭后台运行</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-4-准备程序和数据"><a href="#2-2-5-4-准备程序和数据" class="headerlink" title="2.2.5.4 准备程序和数据"></a>2.2.5.4 准备程序和数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#自定义web界面</span><br>[root@9caa8742e6ce ~]<span class="hljs-comment"># rm -f /usr/share/nginx/html/index.html</span><br>[root@9caa8742e6ce ~]<span class="hljs-comment"># echo &quot;Nginx Page in Docker&quot; &gt; /usr/share/nginx/html/index.html</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-5-提交为镜像"><a href="#2-2-5-5-提交为镜像" class="headerlink" title="2.2.5.5 提交为镜像"></a>2.2.5.5 提交为镜像</h4><p>docker commit 命令在宿主机基于容器ID 提交为镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#不关闭容器的情况,将容器提交为镜像</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker commit -a &quot;rlin&quot; -m &quot;nginx yum v1&quot; -c &quot;EXPOSE 80 443&quot; a9f25f27c072 rlin/centos7-nginx:1.16.1.v1</span><br>sha256:b6484f3c37e6ce63f0089b01a0d1840962b726d776a1ce36844e83e4c79c1030<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker images</span><br>REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE<br>rlin/centos7-nginx   1.16.1.v1           b6484f3c37e6        22 seconds ago      322MB<br>centos               centos7.7.1908      08d05d1d5859        19 months ago       204MB<br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-6-从制作的镜像启动容器"><a href="#2-2-5-6-从制作的镜像启动容器" class="headerlink" title="2.2.5.6 从制作的镜像启动容器"></a>2.2.5.6 从制作的镜像启动容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d -p 8080:80 --name my-centos-nginx rlin/centos7-nginx:1.16.1.v1 /usr/sbin/nginx</span><br>f29add45a4b2b8581e1ff037c9dd2dd3a95bc4b62cb02c5ba1cd89dc14dbd016<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE                          COMMAND             CREATED             STATUS              PORTS                           NAMES<br>f29add45a4b2        rlin/centos7-nginx:1.16.1.v1   <span class="hljs-string">&quot;/usr/sbin/nginx&quot;</span>   18 seconds ago      Up 16 seconds       443/tcp, 0.0.0.0:8080-&gt;80/tcp   my-centos-nginx<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker port my-centos-nginx</span><br>80/tcp -&gt; 0.0.0.0:8080<br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-7-访问测试镜像"><a href="#2-2-5-7-访问测试镜像" class="headerlink" title="2.2.5.7 访问测试镜像"></a>2.2.5.7 访问测试镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#curl 127.0.0.1:8080</span><br>Nginx Page <span class="hljs-keyword">in</span> Docker<br>[root@ubuntu1804 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h3 id="2-2-6-实战案例-基于CentOS-基础镜像手动制作编译版本-nginx-镜像"><a href="#2-2-6-实战案例-基于CentOS-基础镜像手动制作编译版本-nginx-镜像" class="headerlink" title="2.2.6 实战案例: 基于CentOS 基础镜像手动制作编译版本 nginx 镜像"></a>2.2.6 实战案例: 基于CentOS 基础镜像手动制作编译版本 nginx 镜像</h3><p>在CentOS 基础镜像的容器之上手动编译安装nginx，然后再将此容器提交为镜像</p>
<h4 id="2-2-6-1-下载镜像并初始化系统"><a href="#2-2-6-1-下载镜像并初始化系统" class="headerlink" title="2.2.6.1 下载镜像并初始化系统"></a>2.2.6.1 下载镜像并初始化系统</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker pull centos:centos7.7.1908</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker images</span><br>REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE<br>centos               centos7.7.1908      08d05d1d5859        19 months ago       204MB<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it centos:centos7.7.1908 /bin/bash</span><br><br><span class="hljs-comment">#生成yum源配置</span><br>[root@6d22a8f37641 /]<span class="hljs-comment"># yum install wget -y</span><br>[root@6d22a8f37641 /]<span class="hljs-comment"># rm -rf /etc/yum.repos.d/*</span><br>[root@6d22a8f37641 /]<span class="hljs-comment"># wget -P /etc/yum.repos.d/ http://mirrors.aliyun.com/repo/Centos-7.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-6-2-编译安装-nginx"><a href="#2-2-6-2-编译安装-nginx" class="headerlink" title="2.2.6.2 编译安装 nginx"></a>2.2.6.2 编译安装 nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@6d22a8f37641 /]<span class="hljs-comment"># useradd -r -s /sbin/nologin nginx</span><br><span class="hljs-comment">#安装基础包</span><br>[root@6d22a8f37641 /]<span class="hljs-comment"># yum -y install gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br><br>[root@6d22a8f37641 /]<span class="hljs-comment"># cd /usr/local/src</span><br>[root@6d22a8f37641 src]<span class="hljs-comment"># wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br>[root@6d22a8f37641 src]<span class="hljs-comment"># tar xf nginx-1.16.1.tar.gz</span><br>[root@6d22a8f37641 src]<span class="hljs-comment"># cd nginx-1.16.1</span><br>[root@6d22a8f37641 nginx-1.16.1]<span class="hljs-comment"># ./configure --prefix=/apps/nginx</span><br>[root@6d22a8f37641 nginx-1.16.1]<span class="hljs-comment"># make &amp;&amp; make install</span><br>[root@6d22a8f37641 nginx-1.16.1]<span class="hljs-comment"># rm -rf nginx*</span><br>[root@6d22a8f37641 nginx-1.16.1]<span class="hljs-comment"># rm -rf /var/cache/yum/*</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-6-3-关闭-nginx-后台运行"><a href="#2-2-6-3-关闭-nginx-后台运行" class="headerlink" title="2.2.6.3 关闭 nginx 后台运行"></a>2.2.6.3 关闭 nginx 后台运行</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@6d22a8f37641 nginx-1.16.1]<span class="hljs-comment"># cd /apps/nginx/  </span><br>[root@6d22a8f37641 nginx]<span class="hljs-comment"># ls</span><br>conf html logs sbin<br>[root@6d22a8f37641 nginx]<span class="hljs-comment"># vi conf/nginx.conf</span><br>user nginx;<br>daemon off;<br>[root@6d22a8f37641 nginx]<span class="hljs-comment"># ln -s /apps/nginx/sbin/nginx /usr/sbin/</span><br>[root@6d22a8f37641 nginx]<span class="hljs-comment"># ll /usr/sbin/nginx</span><br>lrwxrwxrwx 1 root root 22 Jan 28 05:29 /usr/sbin/nginx -&gt; /apps/nginx/sbin/nginx<br></code></pre></td></tr></table></figure>

<h4 id="2-2-6-4-准备相关数据自定义web界面"><a href="#2-2-6-4-准备相关数据自定义web界面" class="headerlink" title="2.2.6.4 准备相关数据自定义web界面"></a>2.2.6.4 准备相关数据自定义web界面</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@6d22a8f37641 nginx]<span class="hljs-comment"># echo &quot;Nginx Test Page in Docker&quot; &gt; /apps/nginx/html/index.html</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-6-5-提交为镜像"><a href="#2-2-6-5-提交为镜像" class="headerlink" title="2.2.6.5 提交为镜像"></a>2.2.6.5 提交为镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#不要退出容器，在另一个终端窗口执行以下命令</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker images</span><br>REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE<br>centos               centos7.7.1908      08d05d1d5859        19 months ago       204MB<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE                   COMMAND             CREATED             STATUS              PORTS               NAMES<br>6d22a8f37641        centos:centos7.7.1908   <span class="hljs-string">&quot;/bin/bash&quot;</span>         9 minutes ago       Up 9 minutes                            compassionate_nobel<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker commit -a &quot;rlin&quot;  -m &quot;nginx1.6.1&quot; -c &quot;CMD nginx&quot; 6d22a8f37641  centos7-nginx:1.6.1</span><br>sha256:a81565ed40583950a01c44129c67f28585ff7f51ffe2aa25c8e2cee7acb61a82<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker images</span><br>REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE<br>centos7-nginx        1.6.1               a81565ed4058        14 seconds ago      402MB<br>centos               centos7.7.1908      08d05d1d5859        19 months ago       204MB<br></code></pre></td></tr></table></figure>

<h4 id="2-2-6-6-从自己的镜像启动容器"><a href="#2-2-6-6-从自己的镜像启动容器" class="headerlink" title="2.2.6.6 从自己的镜像启动容器"></a>2.2.6.6 从自己的镜像启动容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d -p 80:80 centos7-nginx:1.6.1 nginx</span><br>2978d28cd8476ba398e0fab0d050fc3b35731cbc1ba857374d96367835c17883<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE                   COMMAND             CREATED             STATUS              PORTS                NAMES<br>2978d28cd847        centos7-nginx:1.6.1     <span class="hljs-string">&quot;nginx&quot;</span>             20 seconds ago      Up 18 seconds       0.0.0.0:80-&gt;80/tcp   peaceful_noether<br>6d22a8f37641        centos:centos7.7.1908   <span class="hljs-string">&quot;/bin/bash&quot;</span>         11 minutes ago      Up 11 minutes                            compassionate_nobel<br></code></pre></td></tr></table></figure>

<p>备注: 最后面的nginx是运行的命令，即镜像里面要运行一个nginx命令，所以前面软链接到/usr/sbin/nginx，目的为了让系统不需要指定路径就可以执行此命令</p>
<h4 id="2-2-6-7-访问测试"><a href="#2-2-6-7-访问测试" class="headerlink" title="2.2.6.7 访问测试"></a>2.2.6.7 访问测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#curl 127.0.0.1</span><br>Nginx Test Page <span class="hljs-keyword">in</span> Docker<br></code></pre></td></tr></table></figure>

<h4 id="2-2-6-8-查看Nginx访问日志和进程"><a href="#2-2-6-8-查看Nginx访问日志和进程" class="headerlink" title="2.2.6.8 查看Nginx访问日志和进程"></a>2.2.6.8 查看Nginx访问日志和进程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it 2978d28cd847 bash</span><br>[root@5df1c756b1eb /]<span class="hljs-comment">#  cat /apps/nginx/logs/access.log </span><br>172.17.0.1 - - [28/Jun/2021:08:12:25 +0000] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 32 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.58.0&quot;</span><br><br>[root@5df1c756b1eb /]<span class="hljs-comment"># ps aux</span><br>USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br>root          1  0.1  0.0  20572  2380 ?        Ss   08:11   0:00 nginx: master process nginx<br>nginx         6  0.0  0.0  21024  2408 ?        S    08:11   0:00 nginx: worker process<br>root          7  0.5  0.0  11840  3032 pts/0    Ss   08:12   0:00 bash<br>root         23  0.0  0.0  51768  3468 pts/0    R+   08:13   0:00 ps aux<br></code></pre></td></tr></table></figure>

<h2 id="2-3-利用-DockerFile-文件执行-docker-build-自动构建镜像"><a href="#2-3-利用-DockerFile-文件执行-docker-build-自动构建镜像" class="headerlink" title="2.3 利用 DockerFile 文件执行 docker build 自动构建镜像"></a>2.3 利用 DockerFile 文件执行 docker build 自动构建镜像</h2><h3 id="2-3-1-Dockfile-使用详解"><a href="#2-3-1-Dockfile-使用详解" class="headerlink" title="2.3.1 Dockfile 使用详解"></a>2.3.1 Dockfile 使用详解</h3><h4 id="2-3-1-1-Dockerfile-介绍"><a href="#2-3-1-1-Dockerfile-介绍" class="headerlink" title="2.3.1.1 Dockerfile 介绍"></a>2.3.1.1 Dockerfile 介绍</h4><p>DockerFile 是一种被Docker程序解释执行的脚本，由一条条的命令组成的，每条命令对应linux下面的一条命令，Docker程序将这些DockerFile指令再翻译成真正的linux命令，其有自己的书写方式和支持的命令，Docker程序读取DockerFile并根据指令生成Docker镜像，相比手动制作镜像的方式，DockerFile更能直观的展示镜像是怎么产生的，有了DockerFile，当后期有额外的需求时，只要在之前的DockerFile添加或者修改响应的命令即可重新生成新的Docker镜像，避免了重复手动制作镜像的麻烦,类似与shell脚本一样,可以方便高效的制作镜像</p>
<p>Docker守护程序 Dockerfile 逐一运行指令，如有必要，将每个指令的结果提交到新镜像，然后最终输出新镜像的ID。Docker守护程序将自动清理之前发送的上下文</p>
<p>请注意，每条指令都是独立运行的，并会导致创建新镜像，比如 RUN cd /tmp 对下一条指令不会有任何影响。</p>
<p>Docker将尽可能重用中间镜像层（缓存），以显著加速 docker build 命令的执行过程，这由 Using cache 控制台输出中的消息指示</p>
<h4 id="2-3-1-2-Dockerfile-镜像制作和使用流程"><a href="#2-3-1-2-Dockerfile-镜像制作和使用流程" class="headerlink" title="2.3.1.2 Dockerfile 镜像制作和使用流程"></a>2.3.1.2 Dockerfile 镜像制作和使用流程</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker48.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-3-1-3-Dockerfile文件的制作镜像的分层结构（每一层都是镜像，相当于每一层都有一个属于自己的dockerfile）"><a href="#2-3-1-3-Dockerfile文件的制作镜像的分层结构（每一层都是镜像，相当于每一层都有一个属于自己的dockerfile）" class="headerlink" title="2.3.1.3 Dockerfile文件的制作镜像的分层结构（每一层都是镜像，相当于每一层都有一个属于自己的dockerfile）"></a>2.3.1.3 Dockerfile文件的制作镜像的分层结构（每一层都是镜像，相当于每一层都有一个属于自己的dockerfile）</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker49.png" srcset="/blog/img/loading.gif"></p>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#按照业务类型或系统类型等方式划分创建目录环境，方便后期镜像比较多的时候进行分类</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#mkdir /data/dockerfile/&#123;web/&#123;nginx,apache,tomcat,jdk&#125;,system/&#123;centos,ubuntu,alpine,debian&#125;&#125; -p</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#tree /data/dockerfile/</span><br>/data/dockerfile/<br>├── system<br>│  ├── alpine<br>│  ├── centos<br>│  ├── debian<br>│  └── ubuntu<br>└── web<br> ├── apache<br> ├── jdk<br> ├── nginx<br> └── tomcat<br><br>10 directories, 0 files<br>[root@ubuntu1804 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-4-Dockerfile-文件格式"><a href="#2-3-1-4-Dockerfile-文件格式" class="headerlink" title="2.3.1.4 Dockerfile 文件格式"></a>2.3.1.4 Dockerfile 文件格式</h4><p>Dockerfile 是一个有特定语法格式的文本文件</p>
<p>dockerfile 官方说明: <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></p>
<p>帮助: man 5 dockerfile<br><strong>Dockerfile 文件说明</strong></p>
<ul>
<li>每一行以Dockerfile的指令开头，指令不区分大小写，但是惯例使用大写</li>
<li>使用 # 开始作为注释</li>
<li>每一行只支持一条指令，每条指令可以携带多个参数</li>
<li>指令按文件的顺序从上至下进行执行</li>
<li>每个指令的执行会生成一个新的镜像层，为了减少分层和镜像大小，尽可能将多条指令合并成一条指令</li>
<li>制作镜像一般可能需要反复多次，每次执行dockfile都按顺序执行，从头开始，已经执行过的指令已经缓存，不需要再执行，如果后续有一行新的指令没执行过，其往后的指令将会重新执行，所以为加速镜像制作，将最常变化的内容放下dockerfile的文件的后面</li>
</ul>
<h4 id="2-3-1-5-Dockerfile-相关指令"><a href="#2-3-1-5-Dockerfile-相关指令" class="headerlink" title="2.3.1.5 Dockerfile 相关指令"></a>2.3.1.5 Dockerfile 相关指令</h4><p>dockerfile 文件中的常见指令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">ADD<br>COPY<br>ENV<br>EXPOSE<br>FROM<br>LABEL<br>STOPSIGNAL<br>USER<br>VOLUME<br>WORKDIR<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-1-FROM-指定基础镜像"><a href="#2-3-1-5-1-FROM-指定基础镜像" class="headerlink" title="2.3.1.5.1 FROM: 指定基础镜像"></a>2.3.1.5.1 FROM: 指定基础镜像</h5><p>定制镜像，需要先有一个基础镜像，在这个基础镜像上进行定制。</p>
<p><strong>FROM</strong> 就是指定基础镜像，此指令通常必需放在Dockerfile文件第一个非注释行。后续的指令都是运行于此基准镜像所提供的运行环境</p>
<p>基础镜像可以是任何可用镜像文件，默认情况下，docker build会在docker主机上查找指定的镜像文件，在其不存在时，则会从Docker Hub Registry上拉取所需的镜像文件.如果找不到指定的镜像文件，docker build会返回一个错误信息</p>
<p><strong>如何选择合适的镜像呢？</strong></p>
<p>对于不同的软件官方都提供了相关的docker镜像，比如: nginx、redis、mysql、httpd、tomcat等服务类的镜像，也有操作系统类，如: centos、ubuntu、debian等。建议使用官方镜像，比较安全。</p>
<p>格式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM [--platform=&lt;platform&gt;] &lt;image&gt; [AS &lt;name&gt;]<br>FROM [--platform=&lt;platform&gt;] &lt;image&gt;[:&lt;tag&gt;] [AS &lt;name&gt;]<br>FROM [--platform=&lt;platform&gt;] &lt;image&gt;[@&lt;digest&gt;] [AS &lt;name&gt;]<br><br><span class="hljs-comment">#说明: </span><br>--platform 指定镜像的平台，比如: linux/amd64, linux/arm64, or windows/amd64<br>tag 和 digest是可选项，如果不指定，默认为latest<br></code></pre></td></tr></table></figure>

<p><strong>说明: 关于scratch 镜像</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM scratch<br>参考链接:<br>https://hub.docker.com/_/scratch?tab=description<br>https://docs.docker.com/develop/develop-images/baseimages/<br>该镜像是一个空的镜像，可以用于构建busybox等超小镜像，可以说是真正的从零开始构建属于自己的镜像<br>该镜像在构建基础镜像（例如debian和busybox）或超最小镜像（仅包含一个二进制文件及其所需内容，例如:hello-world）的上下文中最有用。<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804:~]<span class="hljs-comment"># vim /data/dockerfile/system/centos/Dockefile</span><br>FROM centos:7.7.1908<br>[root@ubuntu1804:~]<span class="hljs-comment"># vim /data/dockerfile/system/scratch/Dockefile</span><br>FROM scratch <span class="hljs-comment">#所有镜像的起源镜像，相当于Object类</span><br>[root@ubuntu1804:~]<span class="hljs-comment"># vim /data/dockerfile/system/ubuntu/Dockefile</span><br>FROM ubuntu<br>[root@ubuntu1804:~]<span class="hljs-comment"># vim /data/dockerfile/system/ubuntu/Dockefile</span><br>FROM ubuntu:bionic<br>[root@ubuntu1804:~]<span class="hljs-comment"># vim /data/dockerfile/system/debian/Dockefile</span><br>FROM debian:buster-slim<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-2-LABEL-指定镜像元数据"><a href="#2-3-1-5-2-LABEL-指定镜像元数据" class="headerlink" title="2.3.1.5.2 LABEL: 指定镜像元数据"></a>2.3.1.5.2 LABEL: 指定镜像元数据</h5><p>可以指定镜像元数据，如: 镜像作者等</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">LABEL &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; ...<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">LABEL <span class="hljs-string">&quot;com.example.vendor&quot;</span>=<span class="hljs-string">&quot;ACME Incorporated&quot;</span><br>LABEL com.example.label-with-value=<span class="hljs-string">&quot;foo&quot;</span><br>LABEL version=<span class="hljs-string">&quot;1.0&quot;</span><br>LABEL description=<span class="hljs-string">&quot;This text illustrates \</span><br><span class="hljs-string">that label-values can span multiple lines.&quot;</span><br></code></pre></td></tr></table></figure>

<p>一个镜像可以有多个label ,还可以写在一行中,即多标签写法,可以减少镜像的的大小</p>
<p>范例: 多标签写法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#一行格式</span><br>LABEL multi.label1=<span class="hljs-string">&quot;value1&quot;</span> multi.label2=<span class="hljs-string">&quot;value2&quot;</span> other=<span class="hljs-string">&quot;value3&quot;</span><br><br><span class="hljs-comment">#多行格式</span><br>LABEL multi.label1=<span class="hljs-string">&quot;value1&quot;</span> \<br>  multi.label2=<span class="hljs-string">&quot;value2&quot;</span> \<br>   other=<span class="hljs-string">&quot;value3&quot;</span><br></code></pre></td></tr></table></figure>

<p>docker inspect 命令可以查看LABEL</p>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;Labels&quot;</span>: &#123;<br>  <span class="hljs-string">&quot;com.example.vendor&quot;</span>: <span class="hljs-string">&quot;ACME Incorporated&quot;</span><br>  <span class="hljs-string">&quot;com.example.label-with-value&quot;</span>: <span class="hljs-string">&quot;foo&quot;</span>,<br>  <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;1.0&quot;</span>,<br>  <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;This text illustrates that label-values can span multiple lines.&quot;</span>,<br>  <span class="hljs-string">&quot;multi.label1&quot;</span>: <span class="hljs-string">&quot;value1&quot;</span>,<br>  <span class="hljs-string">&quot;multi.label2&quot;</span>: <span class="hljs-string">&quot;value2&quot;</span>,<br>  <span class="hljs-string">&quot;other&quot;</span>: <span class="hljs-string">&quot;value3&quot;</span><br>&#125;,<br></code></pre></td></tr></table></figure>

<p><strong>MAINTAINER: 指定维护者信息</strong><br>此指令已过时，用LABEL代替</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">MAINTAINER &lt;name&gt;<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">MAINTAINER wangxiaochun &lt;root@wangxiaochun.com&gt;<br><span class="hljs-comment">#用LABEL代替</span><br>LABEL maintainer=<span class="hljs-string">&quot;wangxiaochun &lt;root@wangxiaochun.com&gt;&quot;</span><br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-3-RUN-执行-shell命令"><a href="#2-3-1-5-3-RUN-执行-shell命令" class="headerlink" title="2.3.1.5.3 RUN: 执行 shell命令"></a>2.3.1.5.3 RUN: 执行 shell命令</h5><p><strong>RUN</strong> 指令用来在构建镜像阶段需要执行 FROM 指定镜像所支持的Shell命令。</p>
<p>通常各种基础镜像一般都支持丰富的shell命令</p>
<p>注意: RUN 可以写多个，每一个RUN指令都会建立一个镜像层，所以尽可能合并成一条指令,比如将多个shell命令通过 &amp;&amp; 连接一起成为在一条指令</p>
<p>每个RUN都是独立运行的,和前一个RUN无关</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#shell 格式: 相当于 /bin/sh -c &lt;命令&gt; 此种形式支持环境变量</span><br>RUN &lt;命令&gt;<br><br><span class="hljs-comment">#exec 格式: 此种形式不支持环境变量,注意:是双引号,不能是单引号</span><br>RUN [<span class="hljs-string">&quot;可执行文件&quot;</span>, <span class="hljs-string">&quot;参数1&quot;</span>, <span class="hljs-string">&quot;参数2&quot;</span>]<br><br><span class="hljs-comment">#exec格式可以指定其它shell</span><br>RUN [<span class="hljs-string">&quot;/bin/bash&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;echo hello wang&quot;</span>]<br></code></pre></td></tr></table></figure>

<p>说明:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">shell格式中，&lt;<span class="hljs-built_in">command</span>&gt;通常是一个shell命令，且以<span class="hljs-string">&quot;/bin/sh -c”来运行它，这意味着此进程在容器中的PID不为1，不能接收Unix信号，因此，当使用docker stop &lt;container&gt;命令停止容器时，此进程接收不到SIGTERM信号</span><br><span class="hljs-string"></span><br><span class="hljs-string">exec格式中的参数是一个JSON格式的数组，其中&lt;executable&gt;为要运行的命令，后面的&lt;paramN&gt;为传递给命令的选项或参数;然而，此种格式指定的命令不会以&quot;</span>/bin/sh -c<span class="hljs-string">&quot;来发起，因此常见的shell操作如变量替换以及通配符(?,*等)替换将不会进行;不过，如果要运行的命令依赖于此shell特性的话，可以将其替换为类似下面的格式。</span><br><span class="hljs-string">RUN [&quot;</span>/bin/bash<span class="hljs-string">&quot;, &quot;</span>-c<span class="hljs-string">&quot;, &quot;</span>&lt;executable&gt;<span class="hljs-string">&quot;, &quot;</span>&lt;param1&gt;<span class="hljs-string">&quot;]</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">RUN <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;&lt;h1&gt;Hello, Docker!&lt;/h1&gt;&#x27;</span> &gt; /usr/share/nginx/html/index.html<br>RUN [<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;echo hello world&quot;</span>]<br>RUN yum -y install epel-release \<br>  &amp;&amp; yum -y install nginx \<br>  &amp;&amp; rm -rf /usr/share/nginx/html/*<br>  &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;h1&gt; docker test nginx &lt;/h1&gt;&quot;</span> &gt; /usr/share/nginx/html/index.html<br></code></pre></td></tr></table></figure>

<p>范例: 多个 前后RUN 命令独立无关和shell命令不同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#world.txt并不存放在/app内</span><br>RUN <span class="hljs-built_in">cd</span> /app<br>RUN <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello&quot;</span> &gt; world.txt<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-4-ENV-设置环境变量"><a href="#2-3-1-5-4-ENV-设置环境变量" class="headerlink" title="2.3.1.5.4 ENV: 设置环境变量"></a>2.3.1.5.4 ENV: 设置环境变量</h5><p>ENV 可以定义环境变量和值，会被后续指令(如:ENV,ADD,COPY,RUN等)通过$KEY或${KEY}进行引用，并在容器运行时保持</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#变量赋值格式1</span><br>ENV &lt;key&gt; &lt;value&gt;  <span class="hljs-comment">#此格式只能对一个key赋值,&lt;key&gt;之后的所有内容均会被视作其&lt;value&gt;的组成部分</span><br><br><span class="hljs-comment">#变量赋值格式2</span><br>ENV &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt; \  <span class="hljs-comment">#此格式可以支持多个key赋值,定义多个变量建议使用,减少镜像层</span><br>&lt;key3&gt;=&lt;value3&gt; ...<br><br><span class="hljs-comment">#如果&lt;value&gt;中包含空格，可以以反斜线\进行转义，也可通过对&lt;value&gt;加引号进行标识;另外，反斜线也可用于续行</span><br><br><span class="hljs-comment">#只使用一次变量</span><br>RUN &lt;key&gt;=&lt;value&gt; &lt;<span class="hljs-built_in">command</span>&gt;<br> <br><span class="hljs-comment">#引用变量</span><br>RUN <span class="hljs-variable">$key</span> .....<br><br><span class="hljs-comment">#变量支持高级赋值格式</span><br><span class="hljs-variable">$&#123;key:-word&#125;</span><br><span class="hljs-variable">$&#123;kye:+word&#125;</span><br></code></pre></td></tr></table></figure>

<p>如果运行容器时如果需要修改变量,可以执行下面通过基于 exec 机制实现</p>
<p>注意: 下面方式只影响容器运行时环境,而不影响构建镜像的过程,即只能覆盖docker run时的环境变量,而不会影响docker build时环境变量的值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -e|--env &lt;key&gt;=&lt;value&gt;<br><br><span class="hljs-comment">#说明</span><br>-e, --env list  <span class="hljs-comment">#Set environment variables</span><br>  --env-file filename   <span class="hljs-comment">#Read in a file of environment variables</span><br></code></pre></td></tr></table></figure>

<p>示例: 两种格式功能相同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式1</span><br>ENV myName=<span class="hljs-string">&quot;John Doe&quot;</span> myDog=Rex\ The\ Dog \<br>  myCat=fluffy<br><br><span class="hljs-comment">#格式2</span><br>ENV myName John Doe<br>ENV myDog Rex The Dog<br>ENV myCat fluffy<br></code></pre></td></tr></table></figure>

<p> 范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">ENV VERSION=1.0 DEBUG=on NAME=<span class="hljs-string">&quot;Happy Feet&quot;</span><br>ENV PG_MAJOR 9.3<br>ENV PG_VERSION 9.3.4<br>RUN curl -SL http://example.com/postgres-<span class="hljs-variable">$PG_VERSION</span>.tar.xz | tar -xJC /usr/src/postgress &amp;&amp; …<br>ENV PATH /usr/<span class="hljs-built_in">local</span>/postgres-<span class="hljs-variable">$PG_MAJOR</span>/bin:<span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 dockerfile]<span class="hljs-comment">#cat Dockerfile</span><br>FROM busybox<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>ENV NAME rlin <br>RUN touch <span class="hljs-variable">$NAME</span>.txt<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br>TAG=<span class="hljs-variable">$1</span><br>docker build -t <span class="hljs-built_in">test</span>:<span class="hljs-variable">$TAG</span> .<br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#./build.sh v1.0</span><br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#docker run --rm --name c1 test:v1.0 env</span><br>PATH=/usr/<span class="hljs-built_in">local</span>/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin<br>HOSTNAME=c599109176c7<br>NAME=rlin<br>HOME=/root<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#docker run --rm -e NAME=mage --name c1 test:v5.0 env</span><br>PATH=/usr/<span class="hljs-built_in">local</span>/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin<br>HOSTNAME=b23500aa100d<br>NAME=mage<br>HOME=/root<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment"># docker run --rm -e NAME=rlin --name c1 test:v1.0 ls -l</span><br>total 36<br>drwxr-xr-x    2 root     root         12288 Jun  7 17:34 bin<br>drwxr-xr-x    5 root     root           340 Jun 28 12:36 dev<br>drwxr-xr-x    1 root     root          4096 Jun 28 12:36 etc<br>drwxr-xr-x    2 nobody   nobody        4096 Jun  7 17:34 home<br>dr-xr-xr-x  209 root     root             0 Jun 28 12:36 proc<br>-rw-r--r--    1 root     root             0 Jun 28 12:31 rlin.txt<br>drwx------    2 root     root          4096 Jun  7 17:34 root<br>dr-xr-xr-x   13 root     root             0 Jun 28 12:36 sys<br>drwxrwxrwt    2 root     root          4096 Jun  7 17:34 tmp<br>drwxr-xr-x    3 root     root          4096 Jun  7 17:34 usr<br>drwxr-xr-x    4 root     root          4096 Jun  7 17:34 var<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#vim env.txt</span><br>NAME=rlin<br>TITLE=cto<br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#docker run --rm --env-file env.txt --name c1 test:v1.0 env</span><br>PATH=/usr/<span class="hljs-built_in">local</span>/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin<br>HOSTNAME=44c054a34c52<br>NAME=rlin<br>TITLE=cto<br>HOME=/root<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-5-COPY-复制文本"><a href="#2-3-1-5-5-COPY-复制文本" class="headerlink" title="2.3.1.5.5 COPY: 复制文本"></a>2.3.1.5.5 COPY: 复制文本</h5><p>复制本地宿主机的 到容器中的 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;<br>COPY [--chown=&lt;user&gt;:&lt;group&gt;] [<span class="hljs-string">&quot;&lt;src&gt;&quot;</span>,... <span class="hljs-string">&quot;&lt;dest&gt;&quot;</span>] <span class="hljs-comment">#路径中有空白字符时,建议使用此格式</span><br></code></pre></td></tr></table></figure>

<p>说明:</p>
<ul>
<li>可以是多个,可以使用通配符，通配符规则满足Go的filepath.Match 规则filepath.Match 参考链接: <a target="_blank" rel="noopener" href="https://golang.org/pkg/path/filepath/#Match">https://golang.org/pkg/path/filepath/#Match</a></li>
<li>必须是build上下文中的路径(为 Dockerfile 所在目录的相对路径），不能是其父目录中的文件</li>
<li>如果是目录，则其内部文件或子目录会被递归复制，但目录自身不会被复制</li>
<li>如果指定了多个, 或在中使用了通配符，则必须是一个目录，且必须以 / 结尾</li>
<li>可以是绝对路径或者是 WORKDIR 指定的相对路径</li>
<li>使用 COPY 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等</li>
<li>如果事先不存在，它将会被自动创建，这包括其父目录路径,即递归创建目录</li>
</ul>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">COPY hom* /mydir/  <br>COPY hom?.txt /mydir/<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-6-ADD-复制和解包文件"><a href="#2-3-1-5-6-ADD-复制和解包文件" class="headerlink" title="2.3.1.5.6 ADD: 复制和解包文件"></a>2.3.1.5.6 ADD: 复制和解包文件</h5><p>该命令可认为是增强版的COPY，不仅支持COPY，还支持自动解缩。可以将复制指定的 到容器中的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ADD [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;<br>ADD [--chown=&lt;user&gt;:&lt;group&gt;] [<span class="hljs-string">&quot;&lt;src&gt;&quot;</span>,... <span class="hljs-string">&quot;&lt;dest&gt;&quot;</span>]<br></code></pre></td></tr></table></figure>

<p>说明:</p>
<ul>
<li><p>可以是Dockerfile所在目录的一个相对路径；也可是一个 URL；还可是一个 tar 文件（自动解压）</p>
</li>
<li><p>可以是绝对路径或者是 WORKDIR 指定的相对路径</p>
</li>
<li><p>如果是目录，只复制目录中的内容，而非目录本身</p>
</li>
<li><p>如果是一个 URL ，下载后的文件权限自动设置为 600</p>
</li>
<li><p>如果为URL且不以/结尾，则指定的文件将被下载并直接被创建为,如果以 / 结尾，则文件名URL指定的文件将被直接下载并保存为/&lt; filename&gt;</p>
</li>
<li><p>如果是一个本地文件系统上的打包文件,如: gz, bz2 ,xz ，它将被解包 ，其行为类似于”tar -x”命令,但是通过URL获取到的tar文件将不会自动展开</p>
</li>
<li><p>如果有多个，或其间接或直接使用了通配符，则必须是一个以/结尾的目录路径;如果不以/结尾，则其被视作一个普通文件，的内容将被直接写入到文件里</p>
</li>
</ul>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">ADD <span class="hljs-built_in">test</span> relativeDir/      <span class="hljs-comment"># adds &quot;test&quot; to `WORKDIR`/relativeDir/</span><br>ADD <span class="hljs-built_in">test</span> /absoluteDir/     <span class="hljs-comment"># adds &quot;test&quot; to /absoluteDir/</span><br>ADD --chown=55:mygroup files* /somedir/<br>ADD --chown=bin files* /somedir/<br>ADD --chown=1 files* /somedir/<br>ADD --chown=10:11 files* /somedir/<br>ADD ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /<br>ADD http://tva3.sinaimg.cn/large/0072Vf1pgy1fodqgiodg1j31gs1191im.jpg /data/<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-7-CMD-容器启动命令"><a href="#2-3-1-5-7-CMD-容器启动命令" class="headerlink" title="2.3.1.5.7 CMD: 容器启动命令"></a>2.3.1.5.7 CMD: 容器启动命令</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker50.png" srcset="/blog/img/loading.gif"></p>
<p>一个容器中需要持续运行的进程一般只有一个,CMD 用来指定启动容器时默认执行的一个命令，且其运行结束后,容器也会停止,所以一般CMD 指定的命令为持续运行且为前台命令.</p>
<ul>
<li>如果docker run没有指定任何的执行命令或者dockerfile里面也没有ENTRYPOINT，那么开启容器时就会使用执行CMD指定的默认的命令</li>
<li>前面介绍过的 RUN 命令是在构建镜像进执行的命令,注意二者的不同之处</li>
<li>每个 Dockerfile 只能有一条 CMD 命令。如指定了多条，只有最后一条被执行</li>
<li>如果用户启动容器时用 docker run xxx 指定运行的命令，则会覆盖 CMD 指定的命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用 exec 执行，推荐方式，第一个参数必须是命令的全路径,此种形式不支持环境变量</span><br>CMD [<span class="hljs-string">&quot;executable&quot;</span>,<span class="hljs-string">&quot;param1&quot;</span>,<span class="hljs-string">&quot;param2&quot;</span>]<br><br><span class="hljs-comment"># 在 /bin/sh 中执行，提供给需要交互的应用；此种形式支持环境变量</span><br>CMD <span class="hljs-built_in">command</span> param1 param2<br><br><span class="hljs-comment"># 提供给 ENTRYPOINT 命令的默认参数</span><br>CMD [<span class="hljs-string">&quot;param1&quot;</span>,<span class="hljs-string">&quot;param2&quot;</span>]<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">CMD [<span class="hljs-string">&quot;nginx&quot;</span>, <span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span>]<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 dockerfile]<span class="hljs-comment">#cat Dockerfile</span><br>FROM ubuntu:18.04<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>RUN apt update \<br>&amp;&amp; apt -y install  curl \<br>&amp;&amp; rm -rf /var/lib/apt/lists/*<br>CMD [<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;curl&quot;</span>, <span class="hljs-string">&quot;-s&quot;</span>,<span class="hljs-string">&quot;https://ip.cn&quot;</span>]<br><br>[root@centos8 ubuntu]<span class="hljs-comment">#podman run 9b</span><br>&#123;<span class="hljs-string">&quot;ip&quot;</span>: <span class="hljs-string">&quot;111.199.187.36&quot;</span>, <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;北京市&quot;</span>, <span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;联通&quot;</span>&#125;<br><br><span class="hljs-comment">#cat /etc/etc/issue覆盖了curl命令</span><br>[root@centos8 ubuntu]<span class="hljs-comment">#podman run 9b cat /etc/issue</span><br>Ubuntu 18.04.4 LTS \n \l<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 dockerfile]<span class="hljs-comment">#pwd</span><br>/data/dockerfile<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#cat Dockerfile</span><br>FROM busybox<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>ENV ROOT /data/website<br>COPY index.html <span class="hljs-variable">$&#123;ROOT&#125;</span>/index.html<br>CMD /bin/httpd -f -h <span class="hljs-variable">$&#123;ROOT&#125;</span><br>EXPOSE 80<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#cat index.html</span><br>Website <span class="hljs-keyword">in</span> Dockerfile<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br>TAG=<span class="hljs-variable">$1</span><br>docker build -t <span class="hljs-built_in">test</span>:<span class="hljs-variable">$TAG</span> .<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#./build.sh v1.0</span><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#docker run -d --rm -P --name c1 test:v1.0</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker port c1</span><br>80/tcp -&gt; 0.0.0.0:32781<br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl 127.0.0.1:32781</span><br>Website <span class="hljs-keyword">in</span> Dockerfile<br>[root@ubuntu1804 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 dockerfile]<span class="hljs-comment">#pwd</span><br>/data/dockerfile<br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#cat Dockerfile</span><br>FROM busybox<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>ENV ROOT /data/website<br>RUN mkdir -p <span class="hljs-variable">$&#123;ROOT&#125;</span> &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;&lt;h1&gt; Busybox httpd server in Dockerfile&lt;/h1&gt;&#x27;</span> &gt; <span class="hljs-variable">$&#123;ROOT&#125;</span>/index.html<br><span class="hljs-comment">#COPY index.html $&#123;ROOT&#125;/index.html</span><br>CMD [<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;/bin/httpd -f -h <span class="hljs-variable">$&#123;ROOT&#125;</span>&quot;</span>]<br><span class="hljs-comment">#CMD /bin/httpd -f -h $&#123;ROOT&#125;</span><br>EXPOSE 80<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br>TAG=<span class="hljs-variable">$1</span><br>docker build -t <span class="hljs-built_in">test</span>:<span class="hljs-variable">$TAG</span> .<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#ls</span><br>build.sh Dockerfile<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#./build.sh v2.0</span><br>Sending build context to Docker daemon  262.1kB<br>Step 1/6 : FROM busybox<br> ---&gt; 69593048aa3a<br>Step 2/6 : LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br> ---&gt; Using cache<br> ---&gt; 732d9d562135<br>Step 3/6 : ENV ROOT /data/website<br> ---&gt; Using cache<br> ---&gt; 43e92445231f<br>Step 4/6 : RUN mkdir -p <span class="hljs-variable">$&#123;ROOT&#125;</span> &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;&lt;h1&gt; Busybox httpd server in Dockerfile&lt;/h1&gt;&#x27;</span> &gt; <span class="hljs-variable">$&#123;ROOT&#125;</span>/index.html<br> ---&gt; Running <span class="hljs-keyword">in</span> 4edf27e5a708<br>Removing intermediate container 4edf27e5a708<br> ---&gt; 4c5923d47be9<br>Step 5/6 : CMD [<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;/bin/httpd -f -h <span class="hljs-variable">$&#123;ROOT&#125;</span>&quot;</span>]<br> ---&gt; Running <span class="hljs-keyword">in</span> 819a1297ebe2<br>Removing intermediate container 819a1297ebe2<br> ---&gt; f5863f1f3dfa<br>Step 6/6 : EXPOSE 80<br> ---&gt; Running <span class="hljs-keyword">in</span> 07a69fa08d9b<br>Removing intermediate container 07a69fa08d9b<br> ---&gt; 4d76ff8d7df0<br>Successfully built 4d76ff8d7df0<br>Successfully tagged <span class="hljs-built_in">test</span>:v2.0<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#docker run -d --rm -P --name c2 test:v2.0</span><br>46de8d307c14c71a0eeecf18a144410fb7a990e482928a6a00033dff842a569a<br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#docker port c2</span><br>80/tcp -&gt; 0.0.0.0:32785<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#curl 127.0.0.1:32785</span><br>&lt;h1&gt; Busybox httpd server <span class="hljs-keyword">in</span> Dockerfile&lt;/h1&gt;<br><br>[root@ubuntu1804 dockerfile]<span class="hljs-comment">#docker inspect -f &quot;&#123;&#123;.Config&#125;&#125;&quot; test:v2.0</span><br>&#123;   <span class="hljs-literal">false</span> <span class="hljs-literal">false</span> <span class="hljs-literal">false</span> map[80/tcp:&#123;&#125;] <span class="hljs-literal">false</span> <span class="hljs-literal">false</span> <span class="hljs-literal">false</span> [PATH=/usr/<span class="hljs-built_in">local</span>/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin ROOT=/data/website] [/bin/sh -c /bin/httpd -f -h <span class="hljs-variable">$&#123;ROOT&#125;</span>] &lt;nil&gt; <span class="hljs-literal">false</span> sha256:f5863f1f3dfae40ab3666961a0b66d2025026a91753747e8bdf5a44dbdd8d6a9 map[]  [] <span class="hljs-literal">false</span>  [] map[maintainer:rlin &lt;root@rlin.com&gt;]  &lt;nil&gt; []&#125;<br><span class="hljs-comment">#查看进程关系</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it c2 sh</span><br>/ <span class="hljs-comment"># ps</span><br>PID  USER   TIME COMMAND<br>  1 root    0:00 /bin/httpd -f -h /data/website<br>  8 root    0:00 sh<br> 13 root    0:00 ps<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-8-ENTRYPOINT-入口点"><a href="#2-3-1-5-8-ENTRYPOINT-入口点" class="headerlink" title="2.3.1.5.8 ENTRYPOINT: 入口点"></a>2.3.1.5.8 ENTRYPOINT: 入口点</h5><p>功能类似于CMD，配置容器启动后执行的命令及参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用 exec 执行</span><br>ENTRYPOINT [<span class="hljs-string">&quot;executable&quot;</span>, <span class="hljs-string">&quot;param1&quot;</span>, <span class="hljs-string">&quot;param2&quot;</span>]<br><br><span class="hljs-comment"># shell中执行</span><br>ENTRYPOINT <span class="hljs-built_in">command</span> param1 param2<br></code></pre></td></tr></table></figure>

<ul>
<li><p>ENTRYPOINT 不能被 docker run 提供的参数覆盖，而是追加,即如果docker run 命令有参数，那么参数全部都会作为ENTRYPOINT的参数</p>
</li>
<li><p>如果docker run 后面没有额外参数，但是dockerfile中的CMD里有（即上面CMD的第三种用法），即Dockerfile中即有CMD也有ENTRYPOINT,那么CMD的全部内容会作为ENTRYPOINT的参数</p>
<p>简而言之：ENTRYPOINT包含CMD的命令和docker run的命令参数</p>
</li>
<li><p>如果docker run 后面有额外参数，同时Dockerfile中即有CMD也有ENTRYPOINT,那么docker run后面的参数覆盖掉CMD参数内容,最终作为ENTRYPOINT的参数</p>
</li>
<li><p>可以通过docker run –entrypoint string 参数在运行时替换,注意string不要加空格</p>
</li>
<li><p>使用CMD要在运行时重新写命令本身,然后在后面才能追加运行参数，ENTRYPOINT则可以运行时无需重写命令就可以直接接受新参数</p>
</li>
<li><p>每个 Dockerfile 中只能有一个 ENTRYPOINT，当指定多个时，只有最后一个生效</p>
</li>
</ul>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -it --entrypoint cat alpine /etc/issue</span><br>Welcome to Alpine Linux 3.12<br>Kernel \r on an \m (\l)<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 dockerfile]<span class="hljs-comment">#cat Dockerfile</span><br>FROM ubuntu:18.04<br>RUN apt update \<br>&amp;&amp; apt -y install  curl \<br>&amp;&amp; rm -rf /var/lib/apt/lists/*<br>ENTRYPOINT [ <span class="hljs-string">&quot;curl&quot;</span>, <span class="hljs-string">&quot;-s&quot;</span>,<span class="hljs-string">&quot;https://ip.cn&quot;</span>]<br><br>[root@centos8 dockerfile]<span class="hljs-comment">#podman run -it --rm f68e006</span><br>&#123;<span class="hljs-string">&quot;ip&quot;</span>: <span class="hljs-string">&quot;111.199.187.36&quot;</span>, <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;北京市&quot;</span>, <span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;联通&quot;</span>&#125;<br><br><span class="hljs-comment">#追加-i参数</span><br>[root@centos8 dockerfile]<span class="hljs-comment">#podman run -it --rm f68e006 -i</span><br>HTTP/2 200<br>date: Sun, 23 Feb 2020 08:05:19 GMT<br>content-type: application/json; charset=UTF-8<br>set-cookie: __cfduid=d4a22496ea6f3b2861763354f8ca600711582445119; expires=Tue,<br>24-Mar-20 08:05:19 GMT; path=/; domain=.ip.cn; HttpOnly; SameSite=Lax<br>cf-cache-status: DYNAMIC<br>expect-ct: max-age=604800, report-uri=<span class="hljs-string">&quot;https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct&quot;</span><br>alt-svc: h3-25=<span class="hljs-string">&quot;:443&quot;</span>; ma=86400, h3-24=<span class="hljs-string">&quot;:443&quot;</span>; ma=86400, h3-23=<span class="hljs-string">&quot;:443&quot;</span>; ma=86400<br>server: cloudflare<br>cf-ray: 5697b1ac1862eb41-LAX<br><br>&#123;<span class="hljs-string">&quot;ip&quot;</span>: <span class="hljs-string">&quot;111.199.187.36&quot;</span>, <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;北京市&quot;</span>, <span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;联通&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<p>范例: 利用脚本实现指定环境变量动态生成配置文件内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment"># docker pull nginx:1.16.0-alpine</span><br>[root@ubuntu1804 ~]<span class="hljs-comment"># docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>nginx               1.16.0-alpine       ef04b00b089d        2 years ago         20.4MB<br>[root@ubuntu1804 ~]<span class="hljs-comment"># cd /data/dockerfile/web/nginx/</span><br>[root@ubuntu1804:/data/dockerfile/web/nginx]<span class="hljs-comment"># echo &#x27;Nginx rlin&#x27; &gt; index.html</span><br>[root@ubuntu1804:/data/dockerfile/web/nginx]<span class="hljs-comment">#cat Dockerfile</span><br>FROM nginx:1.16.0-alpine<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>ENV DOC_ROOT=<span class="hljs-string">&#x27;/data/website/&#x27;</span><br>ADD index.html <span class="hljs-variable">$&#123;DOC_ROOT&#125;</span><br>ADD entrypoint.sh /bin/<br>EXPOSE 80/tcp 8080<br><br><span class="hljs-comment">#HEALTHCHECK --start-period=3s CMD wget -0 - -q http://$&#123;IP:-0.0.0.0&#125;:&#123;PORT:-80&#125;/</span><br><br>CMD [<span class="hljs-string">&quot;/usr/sbin/nginx&quot;</span>,<span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span>]  <span class="hljs-comment">#CMD指令的内容都成为了ENTRYPOINT的参数</span><br>ENTRYPOINT [ <span class="hljs-string">&quot;/bin/entrypoint.sh&quot;</span>]<br><br>[root@ubuntu1804:/data/dockerfile/web/nginx]<span class="hljs-comment">#vim entrypoint.sh</span><br><span class="hljs-comment">#!/bin/sh</span><br>cat &gt; /etc/nginx/conf.d/www.conf &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">server &#123;</span><br><span class="hljs-string"> server_name $&#123;HOSTNAME&#125;;</span><br><span class="hljs-string"> listen $&#123;IP:-0.0.0.0&#125;:$&#123;PORT:-80&#125;;</span><br><span class="hljs-string"> root  $&#123;DOC_ROOT:-/usr/share/nginx/html&#125;;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br><span class="hljs-built_in">exec</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br><br>[root@ubuntu1804:/data/dockerfile/web/nginx]<span class="hljs-comment"># chmod +x entrypoint.sh</span><br>[root@ubuntu1804:/data/dockerfile/web/nginx]<span class="hljs-comment"># docker build -t nginx1.16.0:v1.0 .</span><br>[root@ubuntu1804:/data/dockerfile/web/nginx]<span class="hljs-comment"># docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>nginx1.16.0         v1.0                2f207e30f340        6 seconds ago       20.4MB<br>[root@ubuntu1804:/data/dockerfile/web/nginx]<span class="hljs-comment">#docker run --name n1 -d -P -e &quot;PORT=8080&quot; -e &quot;HOSTNAME=www.rlin.org&quot; nginx1.16.0:v1.0</span><br>root@ubuntu1804:/data/dockerfile/web/nginx<span class="hljs-comment"># docker exec -it n1 sh</span><br>/ <span class="hljs-comment"># ls /etc/nginx/conf.d</span><br>default.conf  www.conf<br>/ <span class="hljs-comment"># cat /etc/nginx/conf.d/www.conf </span><br>server &#123;<br> server_name www.rlin.org;<br> listen 0.0.0.0:8080;<br> root  /data/website/;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>范例：docker run添加参数，添加的参数最终作为ENTRYPOINT的参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#制作centos7.8.2003和编译工具的镜像镜像</span><br>[root@ubuntu1804 ~]<span class="hljs-comment"># cd /data/dockerfile/system/centos</span><br>[root@ubuntu1804:/data/dockerfile/system/centos]<span class="hljs-comment"># docker pull centos:centos7.8.2003</span><br>......<br>[root@ubuntu1804:/data/dockerfile/system/centos]<span class="hljs-comment"># vim Dockerfile</span><br>FROM centos:centos7.8.2003<br>LABEL maintainer=<span class="hljs-string">&quot;rlin root@rlin.com&gt;&quot;</span> \<br>      version=<span class="hljs-string">&quot;1.0&quot;</span><br>RUN rm -rf /etc/yum.repos.d/<br>COPY base.repo /etc/yum.repos.d/test.repo<br>RUN yum -y install vim wget bzip unzip zip gcc pcre-devel zlib-devel make net-tools iproute<br>[root@ubuntu1804:/data/dockerfile/system/centos]<span class="hljs-comment"># docker build -t centos7.8.2003:v1.0</span><br>......<br>[root@ubuntu1804:/data/dockerfile/system/centos]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>centos7.8.2003      v1.0                496e01f5739b        2 minutes ago       500MB<br>centos              centos7.8.2003      afb6fca791e0        13 months ago       203MB<br><br><span class="hljs-comment">#制作以centos7.8.2003:v1.0为基础镜像制作nginx镜像</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/nginx/</span><br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># vim Dockerfile</span><br>FROM centos7.8.2003:v1.0<br>LABEL maintainer=<span class="hljs-string">&quot;rlin root@rlin.com&gt;&quot;</span><br>ADD nginx-1.18.0.tar.gz /usr/<span class="hljs-built_in">local</span>/src<br>RUN <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/nginx-1.18.0 \<br>&amp;&amp; ./configure --prefix=/apps/nginx \<br>&amp;&amp; make \<br>&amp;&amp; make install<br>COPY index.html /apps/nginx/html<br>ENTRYPOINT [ <span class="hljs-string">&quot;/apps/nginx/sbin/nginx&quot;</span>,<span class="hljs-string">&quot;-g&quot;</span>,<span class="hljs-string">&quot;daemon off;&quot;</span>]<br><span class="hljs-comment">#下载nginx源码编译包</span><br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># wget https://nginx.org/download/nginx-1.18.0.tar.gz</span><br>--2021-06-29 11:05:30--  https://nginx.org/download/nginx-1.18.0.tar.gz<br>Resolving nginx.org (nginx.org)... 3.125.197.172, 52.58.199.22, 2a05:d014:edb:5704::6, ...<br>Connecting to nginx.org (nginx.org)|3.125.197.172|:443... connected.<br>HTTP request sent, awaiting response... 200 OK<br>Length: 1039530 (1015K) [application/octet-stream]<br>Saving to: ‘nginx-1.18.0.tar.gz’<br><br>nginx-1.18.0.tar.gz            100%[====================================================&gt;]   1015K   737KB/s    <span class="hljs-keyword">in</span> 1.4s    <br><br>2021-06-29 11:05:38 (737 KB/s) - ‘nginx-1.18.0.tar.gz’ saved [1039530/1039530]<br><br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># ls</span><br>Dockerfile  nginx-1.18.0.tar.gz<br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># echo Nginx rlin &gt; index.html</span><br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># docker build -t  nginx-centos7.8:v1.0-1.18.0 .</span><br>......<br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>nginx-centos7.8     v1.0-1.18.0         d81406322ee1        48 seconds ago      522MB<br>centos7.8.2003      v1.0                496e01f5739b        11 minutes ago      500MB<br>centos              centos7.8.2003      afb6fca791e0        13 months ago       203MB<br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># docker run -d -p 80:80 nginx-centos7.8:v1.0-1.18.0 </span><br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># url 10.0.0.101</span><br>Nginx rlin<br><br><span class="hljs-comment">#查看运行情况</span><br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># docker ps -a</span><br>CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                NAMES<br>1cf4f8d3d50f        nginx-centos7.8:v1.0-1.18.0   <span class="hljs-string">&quot;/apps/nginx/sbin/ng…&quot;</span>   22 seconds ago      Up 21 seconds       0.0.0.0:80-&gt;80/tcp   clever_chatelet<br><br><span class="hljs-comment">#暂停该容器</span><br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># docker ps -a -q | xargs docker stop</span><br>1cf4f8d3d50f<br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># docker run -d -p 80:80 nginx-centos7.8:v1.0-1.18.0 tail -f /etc/hosts</span><br><br><span class="hljs-comment">#再次查看启动容器运行情况，发现容器在开启后关闭了</span><br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># docker ps -a</span><br>CONTAINER ID        IMAGE                         COMMAND                  CREATED              STATUS                      PORTS               NAMES<br>c9e612d20d2a        nginx-centos7.8:v1.0-1.18.0   <span class="hljs-string">&quot;/apps/nginx/sbin/ng…&quot;</span>   9 seconds ago        Exited (1) 8 seconds ago                        dreamy_driscoll<br>1cf4f8d3d50f        nginx-centos7.8:v1.0-1.18.0   <span class="hljs-string">&quot;/apps/nginx/sbin/ng…&quot;</span>   About a minute ago   Exited (0) 42 seconds ago                       clever_chatelet<br><br><span class="hljs-comment">#80端口也没有开启</span><br>[root@ubuntu1804 /data/dockerfile/web/nginx]<span class="hljs-comment"># ss -tnl</span><br>State          Recv-Q          Send-Q                    Local Address:Port                      Peer Address:Port          <br>LISTEN         0               128                             0.0.0.0:111                            0.0.0.0:*             <br>LISTEN         0               128                       127.0.0.53%lo:53                             0.0.0.0:*             <br>LISTEN         0               128                             0.0.0.0:22                             0.0.0.0:*             <br>LISTEN         0               128                             0.0.0.0:58712                          0.0.0.0:*             <br>LISTEN         0               64                              0.0.0.0:12350                          0.0.0.0:*             <br>LISTEN         0               64                              0.0.0.0:2049                           0.0.0.0:*             <br>LISTEN         0               128                             0.0.0.0:42148                          0.0.0.0:*             <br>LISTEN         0               128                             0.0.0.0:26982                          0.0.0.0:*             <br>LISTEN         0               128                                [::]:111                               [::]:*             <br>LISTEN         0               64                                 [::]:12946                             [::]:*             <br>LISTEN         0               128                                [::]:22                                [::]:*             <br>LISTEN         0               128                                [::]:29402                             [::]:*             <br>LISTEN         0               64                                 [::]:2049                              [::]:*             <br>LISTEN         0               128                                [::]:14564                             [::]:*             <br>LISTEN         0               128                                [::]:51530                             [::]:*<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-9-ARG-构建参数"><a href="#2-3-1-5-9-ARG-构建参数" class="headerlink" title="2.3.1.5.9 ARG: 构建参数"></a>2.3.1.5.9 ARG: 构建参数</h5><p>ARG指令在build 阶段指定变量,和ENV不同的是，容器运行时不会存在这些环境变量</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">ARG &lt;name&gt;[=<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">default</span> <span class="hljs-attr">value</span>&gt;</span>]</span><br></code></pre></td></tr></table></figure>

<p><strong>如果和ENV同名，ENV覆盖ARG变量</strong></p>
<p>可以用 docker build –build-arg &lt;参数名&gt;=&lt;值&gt; 来覆盖</p>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment"># cd /data/dockerfile/system/busybox</span><br>[root@ubuntu1804:/data/dockerfile/system/busybox]<span class="hljs-comment"># docker pull busyvox</span><br>......<br>[root@ubuntu1804:/data/dockerfile/system/busybox]<span class="hljs-comment"># docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>busybox             latest              69593048aa3a        3 weeks ago         1.24MB<br>[root@ubuntu1804:/data/dockerfile/system/busybox]<span class="hljs-comment"># vim Dockerfile</span><br>FROM busybox<br>ARG author=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>LABEL maintainer=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;author&#125;</span>&quot;</span><br><br>[root@ubuntu1804:/data/dockerfile/system/busybox]<span class="hljs-comment"># docker build --build-arg author=&quot;346636558@qq.com&quot; -t busybox:v1.0 .</span><br>......<br>[root@ubuntu1804:/data/dockerfile/system/busybox]<span class="hljs-comment"># docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>busybox             v1.0                c2aeea441521        45 seconds ago      1.24MB<br>busybox             latest              69593048aa3a        3 weeks ago         1.24MB<br><br><span class="hljs-comment">#可以从一下结果看出maintainer的显示的结果为后来build指定的信息</span><br>[root@ubuntu1804:/data/dockerfile/system/busybox]<span class="hljs-comment"># docker inspect -f &quot;&#123;&#123;.ContainerConfig&#125;&#125;&quot; busybox:v1.0</span><br>&#123;cd95e3970c57   <span class="hljs-literal">false</span> <span class="hljs-literal">false</span> <span class="hljs-literal">false</span> map[] <span class="hljs-literal">false</span> <span class="hljs-literal">false</span> <span class="hljs-literal">false</span> [PATH=/usr/<span class="hljs-built_in">local</span>/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin] [/bin/sh -c <span class="hljs-comment">#(nop)  LABEL maintainer=346636558@qq.com] &lt;nil&gt; false sha256:1745aedc47a40de18833206e65fb3f19c251f4ee7e9cbc1a1d0a5c4e00b99809 map[]  [] false  [] map[maintainer:346636558@qq.com]  &lt;nil&gt; []&#125;</span><br></code></pre></td></tr></table></figure>

<p>说明: ARG 和 FROM</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#FROM指令支持由第一个FROM之前的任何ARG指令声明的变量</span><br><br><span class="hljs-comment">#示例:</span><br>ARG  CODE_VERSION=latest<br>FROM base:<span class="hljs-variable">$&#123;CODE_VERSION&#125;</span><br>CMD /code/run-app<br><br>FROM extras:<span class="hljs-variable">$&#123;CODE_VERSION&#125;</span><br>CMD /code/run-extras<br><br><span class="hljs-comment">#在FROM之前声明的ARG在构建阶段之外，所以它不能在FROM之后的任何指令中使用。 要使用在第一个FROM之前声明的ARG的默认值，请在构建阶段内使用没有值的ARG指令</span><br><br><span class="hljs-comment">#示例:</span><br>ARG VERSION=latest<br>FROM busybox:<span class="hljs-variable">$VERSION</span><br>ARG VERSION<br>RUN <span class="hljs-built_in">echo</span> <span class="hljs-variable">$VERSION</span> &gt; image_version<br><br><br></code></pre></td></tr></table></figure>

<p>总结：</p>
<p>1.ARG的变量名和ENV相同，会被ENV覆盖</p>
<p>2.ARG可以自己用可以给FROM用</p>
<p>3.如要给FROM用要先在FROM前赋值，然后在给FROM使用</p>
<h5 id="2-3-1-5-11-VOLUME-匿名卷"><a href="#2-3-1-5-11-VOLUME-匿名卷" class="headerlink" title="2.3.1.5.11 VOLUME: 匿名卷"></a>2.3.1.5.11 VOLUME: 匿名卷</h5><p>在容器中创建一个可以从本地主机或其他容器挂载的挂载点，一般用来存放数据库和需要保持的数据等，一般会将宿主机上的目录挂载至VOLUME指令指定的容器目录。即使容器后期被删除，此宿主机的目录仍会保留，从而实现容器数据的持久保存。</p>
<p>宿主机目录为</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">/var/lib/docker/volumes/&lt;volume_id&gt;/_data<br></code></pre></td></tr></table></figure>

<p>语法:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jsx">VOLUME &lt;容器内路径&gt;<br>VOLUME [<span class="hljs-string">&quot;&lt;容器内路径1&gt;&quot;</span>, <span class="hljs-string">&quot;&lt;容器内路径2&gt;&quot;</span>...]<br></code></pre></td></tr></table></figure>

<p>注意:</p>
<ul>
<li>Dockerfile中的VOLUME实现的是匿名数据卷,无法指定宿主机路径和容器目录的挂载关系</li>
<li>通过docker rm -fv &lt;容器ID&gt; 可以删除容器的同时删除VOLUME指定的卷</li>
</ul>
<p>范例: 在容器创建两个/data/ ,/data2的挂载点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">VOLUME [ <span class="hljs-string">&quot;/data1&quot;</span>,<span class="hljs-string">&quot;/data2&quot;</span> ] <br></code></pre></td></tr></table></figure>

<p>范例1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#vim /data/dockerfile/system/alpine/Dockerfile</span><br>FROM alpine:3.11<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>COPY repositories /etc/apk/repositories<br>VOLUME [ <span class="hljs-string">&quot;/testdata&quot;</span>,<span class="hljs-string">&quot;/testdata2&quot;</span> ]<br><br>[root@centos8 alpine]<span class="hljs-comment">#podman run -it --rm 8ef61dd3959da3f sh</span><br>/ <span class="hljs-comment"># df</span><br>Filesystem      1K-blocks   Used Available Use% Mounted on<br>overlay        104806400  3656380 101150020  3% /<br>tmpfs           65536     0   65536  0% /dev<br>/dev/sda2       104806400  3656380 101150020  3% /testdata2<br>/dev/sda2       104806400  3656380 101150020  3% /testdata<br>/ <span class="hljs-comment"># cp /etc/issue /testdata/f1.txt</span><br>/ <span class="hljs-comment"># cp /etc/issue /testdata2/f2.txt</span><br><br>[root@centos8 ~]<span class="hljs-comment">#tree /var/lib/containers/storage/volumes/</span><br>/var/lib/containers/storage/volumes/<br>├── 725f0f67921bdbffbe0aaf9b015d663a6e3ddd24674990d492025dfcf878529b<br>│  └── _data<br>│    └── f1.txt<br>└── fbd13e5253deb375e0dea917df832d2322e96b04ab43bae061584dcdbe7e89f2<br> └── _data<br>   └── f2.txt<br><br>4 directories, 2 files<br></code></pre></td></tr></table></figure>

<p>范例2：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment"># cd /data/dockerfile/system/alpine</span><br>[root@ubuntu1804:/data/dockerfile/system/alpine]<span class="hljs-comment"># vim Dockerfile</span><br>FROM alpine:3.11<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>VOLUME [ <span class="hljs-string">&quot;/testdata&quot;</span>,<span class="hljs-string">&quot;/testdata2&quot;</span> ]<br><br>[root@ubuntu1804:/data/dockerfile/system/alpine]<span class="hljs-comment"># docker build -t alpine3.11:v1.0 .</span><br>......<br>[root@ubuntu1804:/data/dockerfile/system/alpine]<span class="hljs-comment"># docker run -it --rm alpine3.11:v1.0 sh</span><br>/ <span class="hljs-comment"># df</span><br>Filesystem           1K-blocks      Used Available Use% Mounted on<br>overlay              102685624   5193072  92233392   5% /<br>tmpfs                    65536         0     65536   0% /dev<br>tmpfs                  2007828         0   2007828   0% /sys/fs/cgroup<br>shm                      65536         0     65536   0% /dev/shm<br>/dev/sda1            102685624   5193072  92233392   5% /testdata<br>/dev/sda1            102685624   5193072  92233392   5% /testdata2<br>......<br>/ <span class="hljs-comment"># cp /etc/issue /testdata/f1.txt</span><br>/ <span class="hljs-comment"># cp /etc/issue /testdata2/f2.txt</span><br><br>[root@ubuntu1804:/data/dockerfile/system/alpine]<span class="hljs-comment"># tree /var/lib/docker/volumes/</span><br>/var/lib/docker/volumes/<br>├── 875742214b9a15247d5b58ef5756f52a2a0a0960a8d8f74e4a2ae3ca0216668a<br>│   └── _data<br>│       └── f1.txt<br>├── b27e3903d0c74aed6020a0d912ba31e1d9835c58d83e206e139abc79bf13d470<br>│   └── _data<br>│       └── f2.txt<br>└── metadata.db<br><br>4 directories, 3 files<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-12-EXPOSE-暴露端口"><a href="#2-3-1-5-12-EXPOSE-暴露端口" class="headerlink" title="2.3.1.5.12 EXPOSE: 暴露端口"></a>2.3.1.5.12 EXPOSE: 暴露端口</h5><p>指定服务端的容器需要对外暴露(监听)的端口号，以实现容器与外部通信。</p>
<p>EXPOSE 仅仅是声明容器打算使用什么端口而已,并不会真正暴露端口,即不会自动在宿主进行端口映射</p>
<p>因此，在启动容器时需要通过 -P 或-p ，Docker 主机才会真正分配一个端口转发到指定暴露的端口才可使用</p>
<p>注意: <strong>即使 Dockerfile没有EXPOSE 端口指令,也可以通过docker run -p 临时暴露容器内程序真正监听的端口</strong>,所以EXPOSE 相当于指定默认的暴露端口,可以通过docker run -P 进行真正暴露</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">EXPOSE &lt;port&gt;[/ &lt;protocol&gt;] [&lt;port&gt;[/ &lt;protocol&gt;] ..]<br> <br><span class="hljs-comment">#说明</span><br>&lt;protocol&gt;用于指定传输层协议，可为tcp或udp二者之一，默认为TCP协议<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">EXPOSE 80 443<br>EXPOSE 11211/udp 11211/tcp<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 /data/dockerfile/system/busybox]<span class="hljs-comment">#pwd</span><br>/data/dockerfile/system/busybox<br>[root@ubuntu1804 /data/dockerfile/system/busybox]<span class="hljs-comment">#echo Website in Dockerfile &gt; index.html</span><br><br>[root@ubuntu1804 /data/dockerfile/system/busybox]<span class="hljs-comment">#vim Dockerfile</span><br>FROM busybox<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>COPY index.html /data/website/<br>EXPOSE 80<br><br>[root@ubuntu1804 /data/dockerfile/system/busybox]<span class="hljs-comment">#docker build -t busybox:v1.0 .</span><br>......<br><span class="hljs-comment">#打开后会卡在当前的页面，下面的命令需要在多开终端才能使用</span><br>[root@ubuntu1804 /data/dockerfile/system/busybox]<span class="hljs-comment">#docker run --rm -P --name c1 busybox:v1.0 /bin/httpd -f -h /data/website</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker port c1</span><br>80/tcp -&gt; 0.0.0.0:32773<br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl 127.0.0.1:32773</span><br>Website <span class="hljs-keyword">in</span> Dockerfile<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker kill c1</span><br>c1<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-13-WORKDIR-指定工作目录"><a href="#2-3-1-5-13-WORKDIR-指定工作目录" class="headerlink" title="2.3.1.5.13 WORKDIR: 指定工作目录"></a>2.3.1.5.13 WORKDIR: 指定工作目录</h5><p>为后续的 RUN、CMD、ENTRYPOINT 指令配置工作目录，当容器运行后，进入容器内WORKDIR指定的默认目录</p>
<p>WORKDIR 指定工作目录（或称当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，WORKDIR 会自行创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">WORKDIR /path/to/workdir<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#两次RUN独立运行,不在同一个目录，</span><br>RUN <span class="hljs-built_in">cd</span> /app<br>RUN <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello&quot;</span> &gt; world.txt<br><br><span class="hljs-comment">#如果想实现相同目录可以使用WORKDIR</span><br>WORKDIR /app <span class="hljs-comment">#约等于cd /app</span><br>RUN <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello&quot;</span> &gt; world.txt<br></code></pre></td></tr></table></figure>

<p>可以使用多个 WORKDIR 指令，后续命令如果参数是相对路径，则会基于之前命令指定的路径。例如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">WORKDIR /a<br>WORKDIR b<br>WORKDIR c<br>RUN <span class="hljs-built_in">pwd</span><br></code></pre></td></tr></table></figure>

<p>则最终路径为 /a/b/c</p>
<h5 id="2-3-1-5-14-ONBUILD-子镜像引用父镜像的指令"><a href="#2-3-1-5-14-ONBUILD-子镜像引用父镜像的指令" class="headerlink" title="2.3.1.5.14 ONBUILD: 子镜像引用父镜像的指令"></a>2.3.1.5.14 ONBUILD: 子镜像引用父镜像的指令</h5><p>可以用来配置当构建当前镜像的子镜像时，会自动触发执行的指令,但在当前镜像构建时,并不会执行,即延迟到子镜像构建时才执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ONBUILD [INSTRUCTION]<br></code></pre></td></tr></table></figure>

<p>例如，Dockerfile 使用如下的内容创建了镜像 image-A。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">...<br>ONBUILD ADD http://tva3.sinaimg.cn/large/0072Vf1pgy1fodqgiodg1j31gs1191im.jpg /data/<br>ONBUILD RUN rm -rf /*<br>ONBUILD RUN /usr/<span class="hljs-built_in">local</span>/bin/python-build --dir /app/src...<br></code></pre></td></tr></table></figure>

<p>如果基于 image-A 创建新的镜像image-B时，新的Dockerfile中使用 FROM image-A指定基础镜像时，会自动执行image-A里ONBUILD指令内容，等价于在后面添加了两条指令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM image-A<br><br><span class="hljs-comment">#Automatically run the following</span><br>ADD http://www.magedu.com/wp-content/uploads/2017/09/logo.png /data<br>RUN /usr/<span class="hljs-built_in">local</span>/bin/python-build --dir /app/src<br></code></pre></td></tr></table></figure>

<p>说明:</p>
<ul>
<li>尽管任何指令都可注册成为触发器指令，但ONBUILD不能自我能套，且不会触发FROM和MAINTAINER指令</li>
<li>使用 ONBUILD 指令的镜像，推荐在标签中注明，例如 ruby:1.9-onbuild</li>
</ul>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment"># cd /data/dockerfile/system/alpine</span><br>[root@ubuntu1804:/data/dockerfile/system/alpine]<span class="hljs-comment"># cat Dockerfile </span><br>FROM alpine:3.11<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>ONBUILD VOLUME [ <span class="hljs-string">&quot;/testdata&quot;</span> ]<br>ONBUILD ADD http://tva3.sinaimg.cn/large/0072Vf1pgy1fodqgiodg1j31gs1191im.jpg /data/<br>[root@ubuntu1804:/data/dockerfile/system/alpine]<span class="hljs-comment"># docker build -t alpine:v2.0 .</span><br>[root@ubuntu1804:/data/dockerfile/system/alpine]<span class="hljs-comment"># mv Dockerfile Dockerfile.bak</span><br>[root@ubuntu1804:/data/dockerfile/system/alpine]<span class="hljs-comment"># vim Docker file</span><br>FROM alpine:v3.0<br>[root@ubuntu1804:/data/dockerfile/system/alpine]<span class="hljs-comment"># docker build -t alpine:v3.0 .</span><br>[root@ubuntu1804:/data/dockerfile/system/alpine]<span class="hljs-comment">#docker run -it alpine:v3.0 sh</span><br>/ <span class="hljs-comment"># cd /data/</span><br>/data <span class="hljs-comment"># ls</span><br>0072Vf1pgy1fodqgiodg1j31gs1191im.jpg<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-15-USER-指定当前用户"><a href="#2-3-1-5-15-USER-指定当前用户" class="headerlink" title="2.3.1.5.15 USER: 指定当前用户"></a>2.3.1.5.15 USER: 指定当前用户</h5><p>指定运行容器时的用户名或 UID，后续的 RUN 也会使用指定用户</p>
<p>当服务不需要管理员权限时，可以通过该命令指定运行用户</p>
<p>这个用户必须是事先建立好的，否则无法切换</p>
<p>如果没有指定 USER,默认是 root 身份执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">USER &lt;user&gt;[:&lt;group&gt;]<br>USER &lt;UID&gt;[:&lt;GID&gt;]<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">RUN groupadd -r mysql &amp;&amp; useradd -r -g mysql mysql<br>USER mysql<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-16-HEALTHCHECK-健康检查"><a href="#2-3-1-5-16-HEALTHCHECK-健康检查" class="headerlink" title="2.3.1.5.16 HEALTHCHECK: 健康检查"></a>2.3.1.5.16 HEALTHCHECK: 健康检查</h5><p>检查容器的健康性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">HEALTHCHECK [选项] CMD &lt;命令&gt; <span class="hljs-comment">#设置检查容器健康状况的命令</span><br>HEALTHCHECK NONE <span class="hljs-comment">#如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令</span><br><br>HEALTHCHECK 支持下列选项: <br>--interval=&lt;间隔&gt;  <span class="hljs-comment">#两次健康检查的间隔，默认为 30 秒</span><br>--timeout=&lt;时长&gt;   <span class="hljs-comment">#健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒</span><br>--retries=&lt;次数&gt;   <span class="hljs-comment">#当连续失败指定次数后，则将容器状态视为 unhealthy，默认3次</span><br>--start-period=&lt;FDURATION&gt; <span class="hljs-comment">#default: 0s</span><br><br><span class="hljs-comment">#检查结果返回值:</span><br>0  <span class="hljs-comment">#success  the container is healthy and ready for use</span><br>1  <span class="hljs-comment">#unhealth  the container is not working correctly</span><br>2  <span class="hljs-comment">#reserved  do not use this exit code</span><br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM nginx<br>RUN apt-get update &amp;&amp; apt-get install -y curl &amp;&amp; rm -rf /var/lib/apt/lists/*<br>HEALTHCHECK --interval=5s --timeout=3s \<br>CMD curl -fs http://localhost/ || <span class="hljs-built_in">exit</span> 1<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-17-STOPSIGNAL-退出容器的信号"><a href="#2-3-1-5-17-STOPSIGNAL-退出容器的信号" class="headerlink" title="2.3.1.5.17 STOPSIGNAL: 退出容器的信号"></a>2.3.1.5.17 STOPSIGNAL: 退出容器的信号</h5><p>该 STOPSIGNAL 指令设置将被发送到容器退出的系统调用信号。该信号可以是与内核syscall表中的位置匹配的有效无符号数字（例如9），也可以是SIGNAME格式的信号名称（例如SIGKILL）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">STOPSIGNAL signal<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-18-SHELL-指定shell"><a href="#2-3-1-5-18-SHELL-指定shell" class="headerlink" title="2.3.1.5.18 SHELL : 指定shell"></a>2.3.1.5.18 SHELL : 指定shell</h5><p>SHELL指令允许覆盖用于命令的shell形式的默认SHELL, 必须在Dockerfile中以JSON形式编写SHELL指令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHELL [<span class="hljs-string">&quot;executable&quot;</span>, <span class="hljs-string">&quot;parameters&quot;</span>]<br></code></pre></td></tr></table></figure>

<p>在Linux上默认SHELL程序为[“/bin/sh”，“-c”]，在Windows上，默认SHELL程序为[“cmd”，“/S”，“/C”]。</p>
<p>SHELL指令在Windows上特别有用，在Windows上有两个常用且完全不同的本机SHELL:cmd和powershell，以及包括sh在内的备用shell。</p>
<p>SHELL指令可以出现多次。 每个SHELL指令将覆盖所有先前的SHELL指令，并影响所有后续的指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM microsoft/windowsservercore<br><br><span class="hljs-comment"># Executed as cmd /S /C echo default</span><br>RUN <span class="hljs-built_in">echo</span> default<br><br><span class="hljs-comment"># Executed as cmd /S /C powershell -command Write-Host default</span><br>RUN powershell -<span class="hljs-built_in">command</span> Write-Host default<br><br><span class="hljs-comment"># Executed as powershell -command Write-Host hello</span><br>SHELL [<span class="hljs-string">&quot;powershell&quot;</span>, <span class="hljs-string">&quot;-command&quot;</span>]<br>RUN Write-Host hello<br><br><span class="hljs-comment"># Executed as cmd /S /C echo hello</span><br>SHELL [<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;/S&quot;</span>, <span class="hljs-string">&quot;/C&quot;</span>]<br>RUN <span class="hljs-built_in">echo</span> hello<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-18-dockerignore文件"><a href="#2-3-1-5-18-dockerignore文件" class="headerlink" title="2.3.1.5.18 .dockerignore文件"></a>2.3.1.5.18 .dockerignore文件</h5><p>官方文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/#dockerignore-file">https://docs.docker.com/engine/reference/builder/#dockerignore-file</a> 与.gitignore文件类似，生成构建上下文时Docker客户端应忽略的文件和文件夹指定模式.dockerignore 使用 Go 的文件路径规则 filepath.Match</p>
<p>参考链接: <a target="_blank" rel="noopener" href="https://golang.org/pkg/path/filepath/#Match">https://golang.org/pkg/path/filepath/#Match</a></p>
<p><strong>完整的语法</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#   #以#开头的行为注释</span><br>*   <span class="hljs-comment">#匹配任何非分隔符字符序列</span><br>?   <span class="hljs-comment">#匹配任何单个非分隔符</span><br>\\   <span class="hljs-comment">#表示 \</span><br><br>**   <span class="hljs-comment">#匹配任意数量的目录（包括零）例如，**/*.go将排除在所有目录中以.go结尾的所有文件，包括构建上下文的根。</span><br>!   <span class="hljs-comment">#表示取反，可用于排除例外情况</span><br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">Rule</th>
<th align="center">Behavior</th>
</tr>
</thead>
<tbody><tr>
<td align="center"># comment</td>
<td align="center">Ignored.</td>
</tr>
<tr>
<td align="center">* /temp*</td>
<td align="center">Exclude files and directories whose names start with temp in any immediatesubdirectory of the root. For example, the plain file/somedir/temporary.txt is excluded, as is the directory /somedir/temp .</td>
</tr>
<tr>
<td align="center">* / * /temp*</td>
<td align="center">Exclude files and directories starting with temp from any subdirectory thatis two levels below the root. For example, /somedir/subdir/temporary.txtis excluded.</td>
</tr>
<tr>
<td align="center">temp?</td>
<td align="center">Exclude files and directories in the root directory whose names are a one-character extension of temp . For example, /tempa and /tempb are</td>
</tr>
</tbody></table>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#排除 test 目录下的所有文件</span><br><span class="hljs-built_in">test</span>/*<br><span class="hljs-comment">#排除 md 目录下的 xttblog.md 文件</span><br>md/xttblog.md<br><span class="hljs-comment">#排除 xttblog 目录下的所有 .md 的文件</span><br>xttblog/*.md<br><span class="hljs-comment">#排除以 xttblog 为前缀的文件和文件夹</span><br>xttblog?<br><span class="hljs-comment">#排除所有目录下的 .sql 文件夹</span><br>**/*.sql<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#除了README的md不排外，排除所有md文件，但不排除README-secret.md</span><br>*.md<br>!README*.md<br>README-secret.md<br><br><span class="hljs-comment">#除了所有README的md文件以外的md都排除</span><br>*.md<br>README-secret.md<br>!README*.md<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-5-19-Dockerfile-构建过程和指令总结"><a href="#2-3-1-5-19-Dockerfile-构建过程和指令总结" class="headerlink" title="2.3.1.5.19 Dockerfile 构建过程和指令总结"></a>2.3.1.5.19 Dockerfile 构建过程和指令总结</h5><p><strong>Dockerfile 构建过程</strong></p>
<ul>
<li>从基础镜像运行一个容器</li>
<li>执行一条指令，对容器做出修改</li>
<li>执行类似docker commit的操作，提交一个新的中间镜像层(可以利用中间层镜像创建容器进行调试和排错)</li>
<li>再基于刚提交的镜像运行一个新容器</li>
<li>执行Dockerfile中的下一条指令，直至所有指令执行完毕</li>
</ul>
<p><strong>Dockerfile 指令总结</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker51.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-3-1-6-构建镜像docker-build-命令"><a href="#2-3-1-6-构建镜像docker-build-命令" class="headerlink" title="2.3.1.6 构建镜像docker build 命令"></a>2.3.1.6 构建镜像docker build 命令</h4><p>docker build命令使用Dockerfile文件创建镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker build [OPTIONS] PATH | URL | -<br><br>说明: <br>PATH | URL | -   <span class="hljs-comment">#可以使是本地路径，也可以是URL路径。若设置为 - ，则从标准输入获取Dockerfile的内容</span><br>-f, --file string  <span class="hljs-comment">#Dockerfile文件名,默认为 PATH/Dockerfile</span><br>--force-rm  <span class="hljs-comment">#总是删除中间层容器,创建镜像失败时，删除临时容器</span><br>--no-cache  <span class="hljs-comment">#不使用之前构建中创建的缓存</span><br>-q  --quiet=<span class="hljs-literal">false</span>  <span class="hljs-comment">#不显示Dockerfile的RUN运行的输出结果</span><br>--rm=<span class="hljs-literal">true</span>  <span class="hljs-comment">#创建镜像成功时，删除临时容器</span><br>-t --tag list  <span class="hljs-comment">#设置注册名称、镜像名称、标签。格式为 &lt;注册名称&gt;/&lt;镜像名称&gt;:&lt;标签&gt;（标签默认为latest）</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker build .<br>docker build /usr/<span class="hljs-built_in">local</span>/src/nginx<br>docker build -f /path/to/a/Dockerfile .<br>docker build -t shykes/myapp .<br>docker build -t shykes/myapp:1.0.2 -t shykes/myapp:latest .<br>docker build -t <span class="hljs-built_in">test</span>/myapp .<br>docker build -t nginx:v1 /usr/<span class="hljs-built_in">local</span>/src/nginx<br></code></pre></td></tr></table></figure>

<p><strong>查看镜像的构建历史: docker history 镜像ID</strong></p>
<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804:~]<span class="hljs-comment"># docker images</span><br>REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE<br>centos7-nginx        1.6.1               a81565ed4058        19 minutes ago      402MB<br>rlin/centos7-nginx   1.16.1.v1           b6484f3c37e6        5 hours ago         322MB<br>nginx_ubuntu20.04    v1.18.0             ae81b509dba6        6 hours ago         161MB<br>tomcat               9.0.37-v1           1792d4c072d9        6 hours ago         672MB<br>httpd-busybox        v2.0                7ee80a2e0cce        7 hours ago         1.24MB<br>httpd-busybox        v1.1                dafcbf3c46ec        7 hours ago         1.24MB<br>httpd-busybox        v1.0                b80c85227ae7        7 hours ago         1.24MB<br>tomcat               latest              b0bf9a4a7c93        2 days ago          667MB<br>ubuntu               latest              9873176a8ff5        10 days ago         72.7MB<br>busybox              latest              69593048aa3a        2 weeks ago         1.24MB<br>mysql                5.7.32              cc8775c0fe94        5 months ago        449MB<br>centos               latest              300e315adb2f        6 months ago        209MB<br>mysql                5.7.30              9cfcce23593a        12 months ago       448MB<br>centos               centos7.7.1908      08d05d1d5859        19 months ago       204MB<br>[root@ubuntu1804:~]<span class="hljs-comment"># docker history 69593048aa3a</span><br>IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT<br>69593048aa3a        2 weeks ago         /bin/sh -c <span class="hljs-comment">#(nop)  CMD [&quot;sh&quot;]                   0B                  </span><br>&lt;missing&gt;           2 weeks ago         /bin/sh -c <span class="hljs-comment">#(nop) ADD file:ab1db978794665f04…   1.24MB              </span><br>[root@ubuntu1804:~]<span class="hljs-comment"># docker history 08d05d1d5859</span><br>IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT<br>08d05d1d5859        19 months ago       /bin/sh -c <span class="hljs-comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B                  </span><br>&lt;missing&gt;           19 months ago       /bin/sh -c <span class="hljs-comment">#(nop)  LABEL org.label-schema.sc…   0B                  </span><br>&lt;missing&gt;           19 months ago       /bin/sh -c <span class="hljs-comment">#(nop) ADD file:3e2a127b44ed01afc…   204MB               </span><br>[root@ubuntu1804:~]<span class="hljs-comment"># docker history a81565ed4058</span><br>IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT<br>a81565ed4058        20 minutes ago      /bin/bash                                       198MB               nginx1.6.1<br>08d05d1d5859        19 months ago       /bin/sh -c <span class="hljs-comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B                  </span><br>&lt;missing&gt;           19 months ago       /bin/sh -c <span class="hljs-comment">#(nop)  LABEL org.label-schema.sc…   0B                  </span><br>&lt;missing&gt;           19 months ago       /bin/sh -c <span class="hljs-comment">#(nop) ADD file:3e2a127b44ed01afc…   204MB</span><br></code></pre></td></tr></table></figure>

<p><strong>范例: 利用Dockerfile构建基于CentOS的nginx镜像</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#vim /data/dockerfile/web/nginx/Dockerfile</span><br>FROM centos<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>RUN yum install -y nginx &amp;&amp; <span class="hljs-built_in">echo</span> Nginx Website <span class="hljs-keyword">in</span> Docker &gt; /usr/share/nginx/html/index.html<br>EXPOSE 80<br>CMD [<span class="hljs-string">&quot;nginx&quot;</span>, <span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span>]<br><span class="hljs-comment">#ENTRYPOINT [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</span><br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker build -t nginx_centos8.2:v1.14.1 .</span><br>Step 1/5 : FROM centos<br>latest: Pulling from library/centos<br>7a0437f04f83: Pull complete <br>Digest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> centos:latest<br> ---&gt; 300e315adb2f<br>Step 2/5 : LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br> ---&gt; Running <span class="hljs-keyword">in</span> 3bcd649ade63<br>Removing intermediate container 3bcd649ade63<br> ---&gt; 521dbaf2b6db<br>Step 3/5 : RUN yum install -y nginx &amp;&amp; <span class="hljs-built_in">echo</span> Nginx Website <span class="hljs-keyword">in</span> Docker &gt; /usr/share/nginx/html/index.html<br> ---&gt; Running <span class="hljs-keyword">in</span> 78de8a7b5409<br>.......<br>Complete!<br>Removing intermediate container 78de8a7b5409<br> ---&gt; a69a9a34aedb<br>Step 4/5 : EXPOSE 80<br> ---&gt; Running <span class="hljs-keyword">in</span> c4de22e5002f<br>Removing intermediate container c4de22e5002f<br> ---&gt; 8e564649adac<br>Step 5/5 : CMD [<span class="hljs-string">&quot;nginx&quot;</span>, <span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span>]<br> ---&gt; Running <span class="hljs-keyword">in</span> c0faed560e31<br>Removing intermediate container c0faed560e31<br> ---&gt; 9bd53baddd33<br>Successfully built 9bd53baddd33<br>Successfully tagged nginx_centos8.2:v1.14.1<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d -P --name nginx-web nginx_centos8.2:v1.14.1</span><br>597e8c69d181da49afd167964814487d768461e19a8253fc1ae65b52e3c1c72d<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS              PORTS                   NAMES<br>597e8c69d181        nginx_centos8.2:v1.14.1   <span class="hljs-string">&quot;nginx -g &#x27;daemon of…&quot;</span>   14 seconds ago      Up 13 seconds       0.0.0.0:10006-&gt;80/tcp   nginx-web<br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl http://127.0.0.1/10006</span><br>curl: (7) Failed to connect to 127.0.0.1 port 80: Connection refused<br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl http://127.0.0.1:10006</span><br>Nginx Website <span class="hljs-keyword">in</span> Docker<br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl -I http://127.0.0.1:10006</span><br>HTTP/1.1 200 OK<br>Server: nginx/1.14.1<br>Date: Tue, 29 Jun 2021 07:28:51 GMT<br>Content-Type: text/html<br>Content-Length: 24<br>Last-Modified: Tue, 29 Jun 2021 07:26:35 GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;60dacb2b-18&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure>

<p>范例: 刷新镜像缓存重新构建新镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#cat /data/dockerfile/web/nginx/Dockerfile</span><br>FROM centos<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>RUN yum install -y nginx<br>RUN <span class="hljs-built_in">echo</span> Nginx Website <span class="hljs-keyword">in</span> Docker &gt; /usr/share/nginx/html/index.html<br><span class="hljs-comment">#修改下面行,从下面行开始不再使用缓存</span><br>ENV REFRESH_DATA 2020-01-01<br>EXPOSE 80<br>CMD [<span class="hljs-string">&quot;nginx&quot;</span>, <span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span>]<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker build  -t nginx_centos8.2:v1.14.1 .</span><br>Sending build context to Docker daemon  209.2MB<br>Step 1/7 : FROM centos<br>---&gt; 831691599b88<br>Step 2/7 : LABEL maintainer=<span class="hljs-string">&quot;wangxiaochun &lt;root@wangxiaochun.com&gt;&quot;</span><br>---&gt; Using cache<br>---&gt; 598318841b8a<br>Step 3/7 : RUN yum install -y nginx<br>---&gt; Using cache<br>---&gt; 8963fb608c33<br>Step 4/7 : RUN <span class="hljs-built_in">echo</span> Nginx Website <span class="hljs-keyword">in</span> Docker &gt; /usr/share/nginx/html/index.html<br>---&gt; Using cache<br>---&gt; 9a95e56b9bc0<br>Step 5/7 : ENV REFRESH_DATA 2020-01-01  <span class="hljs-comment">#从此行开始不再利用缓存</span><br>---&gt; Running <span class="hljs-keyword">in</span> 4607ee0d0e77<br>Removing intermediate container 4607ee0d0e77<br>---&gt; d6235889f336<br>Step 6/7 : EXPOSE 80<br>---&gt; Running <span class="hljs-keyword">in</span> 6924aab5c5c8<br>Removing intermediate container 6924aab5c5c8<br>---&gt; 545393760683<br>Step 7/7 : CMD [<span class="hljs-string">&quot;nginx&quot;</span>, <span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span>]<br>---&gt; Running <span class="hljs-keyword">in</span> 345bbc6179d8<br>Removing intermediate container 345bbc6179d8<br>---&gt; 4bafc2d0c7e0<br>Successfully built 4bafc2d0c7e0<br>Successfully tagged nginx_centos8.2:v1.14.1<br><br><span class="hljs-comment">#全部不利用缓存重新构建镜像</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker build --no-cache -t nginx_centos8.2:v1.14.1 /data/dockerfile/web/nginx/</span><br>Sending build context to Docker daemon  209.2MB<br>Step 1/7 : FROM centos<br>---&gt; 831691599b88<br>Step 2/7 : LABEL maintainer=<span class="hljs-string">&quot;wangxiaochun &lt;root@wangxiaochun.com&gt;&quot;</span><br>---&gt; Running <span class="hljs-keyword">in</span> 41f2aab6657f<br>Removing intermediate container 41f2aab6657f<br>---&gt; 091969d0ed9e<br>Step 3/7 : RUN yum install -y nginx<br>---&gt; Running <span class="hljs-keyword">in</span> 6e174d492348<br>CentOS-8 - AppStream               4.2 MB/s | 5.8 MB   00:01  <br>CentOS-8 - Base                 1.7 MB/s | 2.2 MB   00:01  <br>CentOS-8 - Extras                1.2 kB/s | 7.0 kB   00:05  <br>Dependencies resolved.<br>......               <br><br>Complete!<br>Removing intermediate container 6e174d492348<br>---&gt; ba62ac34b951<br>Step 4/7 : RUN <span class="hljs-built_in">echo</span> Nginx Website <span class="hljs-keyword">in</span> Docker &gt; /usr/share/nginx/html/index.html<br>---&gt; Running <span class="hljs-keyword">in</span> d6f785b28ef6<br>Removing intermediate container d6f785b28ef6<br>---&gt; 6e15fdc84e21<br>Step 5/7 : ENV REFRESH_DATA 2020-06-06<br>---&gt; Running <span class="hljs-keyword">in</span> c6fd87ed95f6<br>Removing intermediate container c6fd87ed95f6<br>---&gt; 328b8621ec36<br>Step 6/7 : EXPOSE 80<br>---&gt; Running <span class="hljs-keyword">in</span> 1af3d6964d81<br>Removing intermediate container 1af3d6964d81<br>---&gt; 7c513643b182<br>Step 7/7 : CMD [<span class="hljs-string">&quot;nginx&quot;</span>, <span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span>]<br>---&gt; Running <span class="hljs-keyword">in</span> fd9216490941<br>Removing intermediate container fd9216490941<br>---&gt; 0b2b61dd0445<br>Successfully built 0b2b61dd0445<br>Successfully tagged nginx_centos8.2:v1.14.1<br></code></pre></td></tr></table></figure>

<h3 id="2-3-2-实战案例-Dockerfile-制作基于基础镜像的Base镜像"><a href="#2-3-2-实战案例-Dockerfile-制作基于基础镜像的Base镜像" class="headerlink" title="2.3.2 实战案例: Dockerfile 制作基于基础镜像的Base镜像"></a>2.3.2 实战案例: Dockerfile 制作基于基础镜像的Base镜像</h3><h4 id="2-3-2-1-准备目录结构，下载镜像并初始化系统"><a href="#2-3-2-1-准备目录结构，下载镜像并初始化系统" class="headerlink" title="2.3.2.1 准备目录结构，下载镜像并初始化系统"></a>2.3.2.1 准备目录结构，下载镜像并初始化系统</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#按照业务类型或系统类型等方式划分创建目录环境，方便后期镜像比较多的时候进行分类</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#mkdir /data/dockerfile/&#123;web/&#123;nginx,apache,tomcat,jdk&#125;,system/&#123;centos,ubuntu,alpine,debian&#125;&#125; -p</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#tree /data/dockerfile/</span><br>/data/dockerfile/<br>├── system<br>│  ├── alpine<br>│  ├── centos<br>│  ├── debian<br>│  └── ubuntu<br>└── web<br> ├── apache<br> ├── jdk<br> ├── nginx<br> └── tomcat<br> <br>10 directories, 0 files<br>[root@ubuntu1804 ~]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#下载基础镜像</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker pull centos:centos7.7.1908</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>centos              centos7.7.1908      08d05d1d5859        19 months ago       204MB<br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-2-先制作基于基础镜像的系统Base镜像"><a href="#2-3-2-2-先制作基于基础镜像的系统Base镜像" class="headerlink" title="2.3.2.2 先制作基于基础镜像的系统Base镜像"></a>2.3.2.2 先制作基于基础镜像的系统Base镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先制作基于基础镜像的系统base镜像</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/system/centos/</span><br><span class="hljs-comment">#创建Dockerfile，注意可以是dockerfile，但无语法着色功能</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#vim Dockerfile</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#cat Dockerfile</span><br>FROM centos:centos7.7.1908<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>RUN yum clean all \ <br>&amp;&amp; yum -y install wget  vim-enhanced tcpdump lrzsz tree telnet bash-completion net-tools wget curl bzip2 lsof zip unzip nfs-utils gcc make gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel zlib-devel \<br>&amp;&amp; yum clean all \<br>&amp;&amp; rm -f /etc/localtime \<br>&amp;&amp; ln -s ../usr/share/zoneinfo/Asia/Shanghai /etc/localtime<br><br>[root@ubuntu1804 centos]<span class="hljs-comment">#vim build.sh</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br>docker build -t centos7.7base:<span class="hljs-variable">$1</span> .<br>[root@ubuntu1804 centos]<span class="hljs-comment">#chmod +x build.sh</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#./build.sh v1.0</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED              SIZE<br>centos7-base        v1.0                b8b67b5597af        About a minute ago   435MB<br>centos              centos7.7.1908      08d05d1d5859        19 months ago        204MB<br>[root@ubuntu1804 centos]<span class="hljs-comment">#docker image history centos7.7base:v1.0</span><br>IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT<br>b99493818e31        5 minutes ago       /bin/sh -c yum clean all &amp;&amp; yum -y install w…   231MB               <br>9237d0916357        7 minutes ago       /bin/sh -c <span class="hljs-comment">#(nop)  LABEL maintainer=rlin &lt;ro…   0B                  </span><br>08d05d1d5859        19 months ago       /bin/sh -c <span class="hljs-comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B                  </span><br>&lt;missing&gt;           19 months ago       /bin/sh -c <span class="hljs-comment">#(nop)  LABEL org.label-schema.sc…   0B                  </span><br>&lt;missing&gt;           19 months ago       /bin/sh -c <span class="hljs-comment">#(nop) ADD file:3e2a127b44ed01afc…   204MB</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-3-实战案例-Dockerfile-制作基于Base镜像的-nginx-镜像"><a href="#2-3-3-实战案例-Dockerfile-制作基于Base镜像的-nginx-镜像" class="headerlink" title="2.3.3 实战案例: Dockerfile 制作基于Base镜像的 nginx 镜像"></a>2.3.3 实战案例: Dockerfile 制作基于Base镜像的 nginx 镜像</h3><h4 id="2-3-3-1-在Dockerfile目录下准备编译安装的相关文件"><a href="#2-3-3-1-在Dockerfile目录下准备编译安装的相关文件" class="headerlink" title="2.3.3.1 在Dockerfile目录下准备编译安装的相关文件"></a>2.3.3.1 在Dockerfile目录下准备编译安装的相关文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#mkdir /data/dockerfile/web/nginx/1.16 -p</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/nginx/1.16</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#mkdir app/</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#echo &quot;Test Page in app&quot; &gt; app/index.html</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#tar zcf app.tar.gz app</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#ls</span><br>app app.tar.gz nginx-1.16.1.tar.gz <br></code></pre></td></tr></table></figure>

<h4 id="2-3-3-2-在一台测试机进行编译安装同一版本的nginx-生成模版配置文件"><a href="#2-3-3-2-在一台测试机进行编译安装同一版本的nginx-生成模版配置文件" class="headerlink" title="2.3.3.2 在一台测试机进行编译安装同一版本的nginx 生成模版配置文件"></a>2.3.3.2 在一台测试机进行编译安装同一版本的nginx 生成模版配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#yum -y install vim-enhanced tcpdump lrzsz tree telnet bash-completion net-tools wget bzip2 lsof tmux man-pages zip unzip nfs-utils gcc make gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel zlib-devel</span><br>[root@centos7 ~]<span class="hljs-comment">#wget -P /usr/local/src http://nginx.org/download/nginx-1.16.1.tar.gz</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /usr/local/src/</span><br>[root@centos7 src]<span class="hljs-comment">#tar xvf nginx-1.16.1.tar.gz</span><br>[root@centos7 src]<span class="hljs-comment">#cd nginx-1.16.1/</span><br>[root@centos7 nginx-1.16.1]<span class="hljs-comment">#./configure --prefix=/apps/nginx &amp;&amp; make &amp;&amp; make install</span><br><br><span class="hljs-comment">#将配置文件复制到nginx镜像的服务器相应目录下</span><br>[root@centos7 ~]<span class="hljs-comment">#scp /apps/nginx/conf/nginx.conf 10.0.0.101:/data/dockerfile/web/nginx/1.16</span><br><br><span class="hljs-comment">#准备配置文件</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#vim /data/dockerfile/web/nginx/1.16/nginx.conf</span><br>worker_processes  1;<br>user nginx;<br>daemon off;  <span class="hljs-comment">#增加此行,前台运行nginx</span><br><br></code></pre></td></tr></table></figure>

<h4 id="2-3-3-3-编写Dockerfile文件"><a href="#2-3-3-3-编写Dockerfile文件" class="headerlink" title="2.3.3.3 编写Dockerfile文件"></a>2.3.3.3 编写Dockerfile文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/nginx/1.16</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#vim Dockerfile</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#cat Dockerfile</span><br>FROM centos7-base:v1.0<br><br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br><br>ADD nginx-1.16.1.tar.gz /usr/<span class="hljs-built_in">local</span>/src<br><br>RUN <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1 \<br>&amp;&amp; ./configure --prefix=/apps/nginx \<br>&amp;&amp; make &amp;&amp; make install \<br>&amp;&amp; rm -rf /usr/<span class="hljs-built_in">local</span>/src/nginx* \<br>&amp;&amp; useradd -r nginx<br>COPY nginx.conf /apps/nginx/conf/<br><br>ADD app.tar.gz /apps/nginx/html/<br><br>EXPOSE 80 443<br><br>CMD [<span class="hljs-string">&quot;/apps/nginx/sbin/nginx&quot;</span>]<br>[root@ubuntu1804 1.16]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-3-4-生成nginx镜像"><a href="#2-3-3-4-生成nginx镜像" class="headerlink" title="2.3.3.4 生成nginx镜像"></a>2.3.3.4 生成nginx镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/nginx/1.16</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#ls</span><br>app app.tar.gz build.sh Dockerfile nginx-1.16.1.tar.gz nginx.conf<br>[root@ubuntu1804 1.16]<span class="hljs-comment">#vim build.sh</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br>docker build -t nginx-centos7:1.6.1 .<br>[root@ubuntu1804 1.16]<span class="hljs-comment">#chmod +x build.sh</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">#./build.sh</span><br>[root@ubuntu1804 1.16]<span class="hljs-comment">##docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>nginx-centos7       1.6.1               3df78837a39a        7 seconds ago       445MB<br>centos              centos7.7.1908      08d05d1d5859        19 months ago       204MB<br></code></pre></td></tr></table></figure>

<h4 id="2-3-3-5-生成的容器测试镜像"><a href="#2-3-3-5-生成的容器测试镜像" class="headerlink" title="2.3.3.5 生成的容器测试镜像"></a>2.3.3.5 生成的容器测试镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d -p 80:80 nginx-centos7:1.6.1</span><br>b16e97f4a0f738b31bfbeb9efb439853c6fb054d84228a778ece6885698d4877<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                         NAMES<br>b16e97f4a0f7        nginx-centos7:1.6.1   <span class="hljs-string">&quot;/bin/sh -c /apps/ng…&quot;</span>   16 seconds ago      Up 15 seconds       0.0.0.0:80-&gt;80/tcp, 443/tcp   objective_villani<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it b16e97f4a0f7 bash</span><br>[root@b16e97f4a0f7 /]<span class="hljs-comment"># ps aux</span><br>USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br>root          1  0.4  0.0  20572  2496 ?        Ss   16:12   0:00 nginx: master process /apps/nginx/sbin/nginx<br>nginx         7  0.0  0.0  21024  2392 ?        S    16:12   0:00 nginx: worker process<br>root          8  3.6  0.0  12336  3588 pts/0    Ss   16:13   0:00 bash<br>root         28  0.0  0.0  51768  3496 pts/0    R+   16:13   0:00 ps aux<br>[root@b16e97f4a0f7 /]<span class="hljs-comment"># exit</span><br><span class="hljs-built_in">exit</span><br>root@ubuntu1804:/data/dockerfile/web/nginx/1.16<span class="hljs-comment"># curl 127.0.0.1/app/</span><br>Test Page <span class="hljs-keyword">in</span> app<br></code></pre></td></tr></table></figure>

<h3 id="2-3-4-实战案例-Dockerfile-直接制作-nginx-镜像"><a href="#2-3-4-实战案例-Dockerfile-直接制作-nginx-镜像" class="headerlink" title="2.3.4 实战案例: Dockerfile 直接制作 nginx 镜像"></a>2.3.4 实战案例: Dockerfile 直接制作 nginx 镜像</h3><h4 id="2-3-4-1-在Dockerfile目录下准备编译安装的相关文件"><a href="#2-3-4-1-在Dockerfile目录下准备编译安装的相关文件" class="headerlink" title="2.3.4.1 在Dockerfile目录下准备编译安装的相关文件"></a>2.3.4.1 在Dockerfile目录下准备编译安装的相关文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#mkdir /data/dockerfile/web/nginx/1.16.1 -p</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/nginx/1.16.1</span><br>[root@ubuntu1804 1.16.1]<span class="hljs-comment">#vim nginx.conf #这里的nginx.conf文件最好还是使用经过yum安装或这使用编译后的nginx.conf文件经过修改后再使用，单纯这样的nginx.conf文件在生成容器的时候会有bug，生成容器后便会退出</span><br>user nginx;<br>worker_processes  1;<br>daemon off;<br>[root@ubuntu1804 1.16.1]<span class="hljs-comment">#wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-4-2-编写Dockerfile文件"><a href="#2-3-4-2-编写Dockerfile文件" class="headerlink" title="2.3.4.2 编写Dockerfile文件"></a>2.3.4.2 编写Dockerfile文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 1.16.1]<span class="hljs-comment">#pwd</span><br>/data/dockerfile/web/nginx/1.16.1<br>[root@ubuntu1804 1.16.1]<span class="hljs-comment">#vim Dockerfile</span><br>[root@ubuntu1804 1.16.1]<span class="hljs-comment">#cat Dockerfile</span><br><span class="hljs-comment">#Nginx Dockerfile</span><br><br>FROM centos:centos7.7.1908<br><br>MAINTAINER rlin &lt;root@rlin.com&gt;<br><br>RUN yum install -y  gcc gcc-c++ pcre pcre-devel zlib zlib-devel opensslopenssl-devel \<br> &amp;&amp; useradd -r -s /sbin/nologin nginx \<br> &amp;&amp; yum clean all<br><br>ADD nginx-1.16.1.tar.gz /usr/<span class="hljs-built_in">local</span>/src/<br><br>RUN <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1 \<br> &amp;&amp; ./configure --prefix=/apps/nginx \<br> &amp;&amp; make \<br> &amp;&amp; make install \<br> &amp;&amp; rm -rf /usr/<span class="hljs-built_in">local</span>/src/nginx*<br>ADD nginx.conf /apps/nginx/conf/nginx.conf<br><br>COPY index.html /apps/nginx/html/<br><br>RUN ln -s /apps/nginx/sbin/nginx /usr/sbin/nginx<br><br>EXPOSE 80 443<br><br><span class="hljs-comment">#CMD [&quot;/usr/sbin/nginx&quot;,&quot;-g&quot;,&quot;daemon off;&quot;]</span><br>CMD [<span class="hljs-string">&quot;/usr/sbin/nginx&quot;</span>]<br></code></pre></td></tr></table></figure>

<h4 id="2-3-4-3-生成nginx镜像"><a href="#2-3-4-3-生成nginx镜像" class="headerlink" title="2.3.4.3 生成nginx镜像"></a>2.3.4.3 生成nginx镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/nginx/1.16.1</span><br><span class="hljs-comment">#将yum源替换为华为源</span><br>[root@ubuntu1804 1.16.1]<span class="hljs-comment"># vim base.repo</span><br>[base]<br>name=CentOS-<span class="hljs-variable">$releasever</span> - Base - repo.huaweicloud.com<br>baseurl=https://repo.huaweicloud.com/centos/<span class="hljs-variable">$releasever</span>/os/<span class="hljs-variable">$basearch</span>/<br><span class="hljs-comment">#mirrorlist=https://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=os</span><br>gpgcheck=0<br>gpgkey=https://repo.huaweicloud.com/centos/RPM-GPG-KEY-CentOS-7<br> <br><span class="hljs-comment">#released updates </span><br>[updates]<br>name=CentOS-<span class="hljs-variable">$releasever</span> - Updates - repo.huaweicloud.com<br>baseurl=https://repo.huaweicloud.com/centos/<span class="hljs-variable">$releasever</span>/updates/<span class="hljs-variable">$basearch</span>/<br><span class="hljs-comment">#mirrorlist=https://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=updates</span><br>gpgcheck=0<br>gpgkey=https://repo.huaweicloud.com/centos/RPM-GPG-KEY-CentOS-7<br> <br><span class="hljs-comment">#additional packages that may be useful</span><br>[extras]<br>name=CentOS-<span class="hljs-variable">$releasever</span> - Extras - repo.huaweicloud.com<br>baseurl=https://repo.huaweicloud.com/centos/<span class="hljs-variable">$releasever</span>/extras/<span class="hljs-variable">$basearch</span>/<br><span class="hljs-comment">#mirrorlist=https://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=extras</span><br>gpgcheck=0<br>gpgkey=https://repo.huaweicloud.com/centos/RPM-GPG-KEY-CentOS-7<br> <br><span class="hljs-comment">#additional packages that extend functionality of existing packages</span><br>[centosplus]<br>name=CentOS-<span class="hljs-variable">$releasever</span> - Plus - repo.huaweicloud.com<br>baseurl=https://repo.huaweicloud.com/centos/<span class="hljs-variable">$releasever</span>/centosplus/<span class="hljs-variable">$basearch</span>/<br><span class="hljs-comment">#mirrorlist=https://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=centosplus</span><br>gpgcheck=0<br>enabled=0<br>gpgkey=https://repo.huaweicloud.com/centos/RPM-GPG-KEY-CentOS-7<br><br>[epel]<br>name=Extra Packages <span class="hljs-keyword">for</span> Enterprise Linux 7 - <span class="hljs-variable">$basearch</span><br>baseurl=https://repo.huaweicloud.com/epel/7/<span class="hljs-variable">$basearch</span><br><span class="hljs-comment">#metalink=https://mirrors.fedoraproject.org/#metalink?repo=epel-7&amp;arch=$basearch&amp;infra=$infra&amp;content=$contentdir</span><br>failovermethod=priority<br>enabled=1<br>gpgcheck=0<br>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7<br><br>[epel-debuginfo]<br>name=Extra Packages <span class="hljs-keyword">for</span> Enterprise Linux 7 - <span class="hljs-variable">$basearch</span> - Debug<br>baseurl=https://repo.huaweicloud.com/epel/7/<span class="hljs-variable">$basearch</span>/debug<br><span class="hljs-comment">#metalink=https://mirrors.fedoraproject.org/#metalink?repo=epel-debug-7&amp;arch=$basearch&amp;infra=$infra&amp;content=$contentdir</span><br>failovermethod=priority<br>enabled=0<br>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7<br>gpgcheck=0<br><br>[epel-source]<br>name=Extra Packages <span class="hljs-keyword">for</span> Enterprise Linux 7 - <span class="hljs-variable">$basearch</span> - Source<br>baseurl=https://repo.huaweicloud.com/epel/7/SRPMS<br><span class="hljs-comment">#metalink=https://mirrors.fedoraproject.org/#metalink?repo=epel-source-7&amp;arch=$basearch&amp;infra=$infra&amp;content=$contentdir</span><br>failovermethod=priority<br>enabled=0<br>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7<br>gpgcheck=0<br><br>[root@ubuntu1804 1.16.1]<span class="hljs-comment">#vim build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br>docker build -t nginx-centos7:1.6.1-v2.0 .<br>[root@ubuntu1804 1.16.1]<span class="hljs-comment">#chmod +x build.sh</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Test Page v2 in Docker&quot;</span> &gt; index.html<br>[root@ubuntu1804 1.16.1]<span class="hljs-comment">#ls</span><br>base.repo build.sh Dockerfile index.html nginx-1.16.1.tar.gz nginx.conf<br>[root@ubuntu1804 1.16.1]<span class="hljs-comment">#REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br>nginx-centos7       1.6.1-v2.0          867d07a6a68b        11 seconds ago      347MB<br>nginx-centos7       1.6.1               3df78837a39a        5 hours ago         445MB<br>[root@ubuntu1804 1.16.1]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>nginx-centos7       1.6.1-v2.0          867d07a6a68b        11 seconds ago      347MB<br>nginx-centos7       1.6.1               3df78837a39a        5 hours ago         445MB<br>centos              centos7.7.1908      08d05d1d5859        19 months ago       204MB<br></code></pre></td></tr></table></figure>

<h4 id="2-3-4-4-生成容器测试镜像"><a href="#2-3-4-4-生成容器测试镜像" class="headerlink" title="2.3.4.4 生成容器测试镜像"></a>2.3.4.4 生成容器测试镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d -p 80:80 nginx-centos7:1.6.1-v2.0</span><br>7ac669bcea0ec23eba0d19e8700fea28ba0a842e6a31b681e814340bb6f1d237<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps</span><br>CONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS                     PORTS                         NAMES<br>7ac669bcea0e        nginx-centos7:1.6.1-v2.0   <span class="hljs-string">&quot;/apps/nginx/sbin/ng…&quot;</span>   20 seconds ago      Up 19 seconds              0.0.0.0:80-&gt;80/tcp, 443/tcp   hungry_moser<br>[root@ubuntu1804 ~]<span class="hljs-comment">#curl 127.0.0.1</span><br>Test Page v2 <span class="hljs-keyword">in</span> Docker<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it 7ac669bcea0e bash</span><br>[root@7ac669bcea0e /]<span class="hljs-comment"># ps aux</span><br>USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br>root          1  0.2  0.0  20572  2440 ?        Ss   13:11   0:00 nginx: master process /apps/nginx/sbin/nginx<br>nginx         6  0.0  0.0  21024  2312 ?        S    13:11   0:00 nginx: worker process<br>root          7  2.8  0.0  11816  2960 pts/0    Ss   13:12   0:00 bash<br>root         20  0.0  0.0  51768  3424 pts/0    R+   13:12   0:00 ps aux<br>[root@7ac669bcea0e /]<span class="hljs-comment"># exit</span><br><span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>

<h2 id="2-4-生产案例-制作自定义tomcat业务镜像"><a href="#2-4-生产案例-制作自定义tomcat业务镜像" class="headerlink" title="2.4 生产案例: 制作自定义tomcat业务镜像"></a>2.4 生产案例: 制作自定义tomcat业务镜像</h2><p>基于官方提供的centos、debian、ubuntu、alpine等基础 镜像构建 JDK (Java环 境)，然后再基于自定义的 JDK 镜像构建出业务需要的tomcat 镜像</p>
<h3 id="2-4-1-自定义-Centos-系统基础镜像"><a href="#2-4-1-自定义-Centos-系统基础镜像" class="headerlink" title="2.4.1 自定义 Centos 系统基础镜像"></a>2.4.1 自定义 Centos 系统基础镜像</h3><p>先基于官方提供的基础镜像，制作出安装了常用命令的自定义基础镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#docker pull centos:centos7.7.1908</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#mkdir -p /data/dockerfile/&#123;web/&#123;nginx,tomcat,jdk&#125;,system/&#123;centos,ubuntu,alpine,debian&#125;&#125;</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/system/centos/</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#vim Dockerfile</span><br><span class="hljs-comment">#没有使用阿里云镜像加速</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#cat Dockerfile </span><br><span class="hljs-comment"># Centos Base Image</span><br>FROM centos:centos7.7.1908<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>RUN yum -y install wget &amp;&amp; rm -f /etc/yum.repos.d/* \ <br> &amp;&amp; wget -P /etc/yum.repos.d/ http://mirrors.aliyun.com/repo/epel-7.repo \<br> &amp;&amp; yum -y install vim-enhanced tcpdump lrzsz tree telnet bash-completion net-tools wget bzip2 lsof zip unzip nfs-utils gcc make gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel zlib-devel \<br> &amp;&amp; rm -rf /var/cache/yum \<br> &amp;&amp; rm -f /etc/localtime \<br> &amp;&amp; ln -s ../usr/share/zoneinfo/Asia/Shanghai /etc/localtime<br><span class="hljs-comment">#添加系统账户</span><br>RUN groupadd www -g 2019 &amp;&amp; useradd www -u 2019 -g www<br><br><span class="hljs-comment">#使用阿里云镜像加速</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#cat Dockerfile </span><br><span class="hljs-comment"># Centos Base Image</span><br>FROM centos:centos7.7.1908<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>RUN yum -y install wget vim-enhanced tcpdump lrzsz tree telnet bash-completion net-tools wget bzip2 lsof zip unzip nfs-utils gcc make gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel zlib-devel \<br> &amp;&amp; rm -rf /var/cache/yum \<br> &amp;&amp; rm -f /etc/localtime \<br> &amp;&amp; ln -s ../usr/share/zoneinfo/Asia/Shanghai /etc/localtime<br><span class="hljs-comment">#添加系统账户</span><br>RUN groupadd www -g 2019 &amp;&amp; useradd www -u 2019 -g www<br><br><span class="hljs-comment">#通过脚本构建镜像</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#vim build.sh</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#cat build.sh </span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br>docker build -t centos7.7base:v1.0 .<br><br>[root@ubuntu1804 centos]<span class="hljs-comment">#bash build.sh</span><br>[root@ubuntu1804 centos]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED              SIZE<br>centos7.7base       v1.0                87c2136795c2        About a minute ago   435MB<br>centos              centos7.7.1908      08d05d1d5859        19 months ago        204MB<br></code></pre></td></tr></table></figure>

<h3 id="2-4-2-构建JDK-镜像"><a href="#2-4-2-构建JDK-镜像" class="headerlink" title="2.4.2 构建JDK 镜像"></a>2.4.2 构建JDK 镜像</h3><h4 id="2-4-2-1-上传JDK压缩包和profile文件上传到Dockerfile当前目录"><a href="#2-4-2-1-上传JDK压缩包和profile文件上传到Dockerfile当前目录" class="headerlink" title="2.4.2.1 上传JDK压缩包和profile文件上传到Dockerfile当前目录"></a>2.4.2.1 上传JDK压缩包和profile文件上传到Dockerfile当前目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#将CentOS7主机上的/etc/profile文件传到 Dockerfile 所在目录下</span><br>[root@centos7 ~]<span class="hljs-comment"># scp /etc/profile 10.0.0.101:/data/dockerfile/web/jdk</span><br><br><span class="hljs-comment">#修改profile文件，加下面四行相关变量</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#vim /data/dockerfile/web/jdk/profile</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#tail -n 5 /data/dockerfile/web/jdk/profile</span><br><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/jdk<br><span class="hljs-built_in">export</span> TOMCAT_HOME=/apps/tomcat<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$JAVA_HOME</span>/jre/bin:<span class="hljs-variable">$TOMCAT_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> CLASSPATH=.<span class="hljs-variable">$CLASSPATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/lib:<span class="hljs-variable">$JAVA_HOME</span>/jre/lib:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br><br><span class="hljs-comment">#下载jdk文件传到Dockfile目录下</span><br><span class="hljs-comment">#https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</span><br><span class="hljs-comment">#百度云盘里下载</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#tree /data/dockerfile/web/jdk</span><br>/data/dockerfile/web/jdk<br>├── jdk-8u212-linux-x64.tar.gz<br>└── profile<br><br>0 directories, 2 files<br></code></pre></td></tr></table></figure>

<h4 id="2-4-2-2-准备Dockerfile文件"><a href="#2-4-2-2-准备Dockerfile文件" class="headerlink" title="2.4.2.2 准备Dockerfile文件"></a>2.4.2.2 准备Dockerfile文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#vim /data/dockerfile/web/jdk/Dockerfile</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cat /data/dockerfile/web/jdk/Dockerfile</span><br><span class="hljs-comment">#JDK Base Image</span><br>FROM centos7.7base:v1.0<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>ADD jdk-8u212-linux-x64.tar.gz /usr/<span class="hljs-built_in">local</span>/src/<br>RUN ln -s /usr/<span class="hljs-built_in">local</span>/src/jdk1.8.0_212 /usr/<span class="hljs-built_in">local</span>/jdk<br>ADD profile /etc/profile<br>ENV JAVA_HOME /usr/<span class="hljs-built_in">local</span>/jdk<br>ENV JRE_HOME <span class="hljs-variable">$JAVA_HOME</span>/jre<br>ENV CLASSPATH <span class="hljs-variable">$JAVA_HOME</span>/lib/:<span class="hljs-variable">$JRE_HOME</span>/lib/<br>ENV PATH <span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin<br></code></pre></td></tr></table></figure>

<h4 id="2-4-2-3-执行构建脚本制作镜像"><a href="#2-4-2-3-执行构建脚本制作镜像" class="headerlink" title="2.4.2.3 执行构建脚本制作镜像"></a>2.4.2.3 执行构建脚本制作镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#vim /data/dockerfile/web/jdk/build.sh</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cat /data/dockerfile/web/jdk/build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>docker build -t centos7-jdk:8u212 .<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#tree /data/dockerfile/web/jdk/</span><br>/data/dockerfile/web/jdk/<br>├── build.sh<br>├── Dockerfile<br>├── jdk-8u212-linux-x64.tar.gz<br>└── profile<br><br>0 directories, 4 files<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/jdk/</span><br>[root@ubuntu1804 jdk]<span class="hljs-comment">#chmod +x build.sh</span><br>[root@ubuntu1804 jdk]<span class="hljs-comment">#./build.sh</span><br>[root@ubuntu1804 jdk]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>centos7-jdk         8u212               b14c76ca5114        6 seconds ago       841MB<br>centos7.7base       v1.0                87c2136795c2        19 minutes ago      435MB<br>centos              centos7.7.1908      08d05d1d5859        19 months ago       204MB<br></code></pre></td></tr></table></figure>

<h4 id="2-3-4-4-从镜像启动容器测试"><a href="#2-3-4-4-从镜像启动容器测试" class="headerlink" title="2.3.4.4 从镜像启动容器测试"></a>2.3.4.4 从镜像启动容器测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 jdk]<span class="hljs-comment">#docker run -it --rm centos7-jdk:8u212 bash</span><br>[root@25c9c0266bd2 /]<span class="hljs-comment"># java -version</span><br>java version <span class="hljs-string">&quot;1.8.0_212&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_212-b10)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.212-b10, mixed mode)<br></code></pre></td></tr></table></figure>

<h3 id="2-4-3-从JDK镜像构建tomcat-8-Base镜像"><a href="#2-4-3-从JDK镜像构建tomcat-8-Base镜像" class="headerlink" title="2.4.3 从JDK镜像构建tomcat 8 Base镜像"></a>2.4.3 从JDK镜像构建tomcat 8 Base镜像</h3><p>基于自定义的 JDK 基础镜像，构建出通用的自定义 Tomcat 基础镜像，此镜像后期会被多个业务的多个服务共同引用(相同的JDK 版本和Tomcat 版本)</p>
<h4 id="2-4-3-1-上传tomcat-压缩包"><a href="#2-4-3-1-上传tomcat-压缩包" class="headerlink" title="2.4.3.1 上传tomcat 压缩包"></a>2.4.3.1 上传tomcat 压缩包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#mkdir -p /data/dockerfile/web/tomcat/tomcat-base-8.5.68</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/tomcat/tomcat-base-8.5.68</span><br><span class="hljs-comment">#留意tomcat版本更新</span><br>[root@ubuntu1804 tomcat-base-8.5.50]<span class="hljs-comment">#wget https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.68/bin/apache-tomcat-8.5.68.tar.gz</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-3-2-编辑Dockerfile"><a href="#2-4-3-2-编辑Dockerfile" class="headerlink" title="2.4.3.2 编辑Dockerfile"></a>2.4.3.2 编辑Dockerfile</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#vim /data/dockerfile/web/tomcat/tomcat-base-8.5.68/Dockerfile</span><br><span class="hljs-comment">#Tomcat Base Image</span><br>FROM centos7-jdk:8u212<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br><span class="hljs-comment">#env</span><br>ENV TZ <span class="hljs-string">&quot;Asia/Shanghai&quot;</span><br>ENV LANG en_US.UTF-8<br>ENV TERM xterm<br>ENV TOMCAT_MAJOR_VERSION 8<br>ENV TOMCAT_MINOR_VERSION 8.5.68<br>ENV CATALINA_HOME /apps/tomcat<br>ENV APP_DIR <span class="hljs-variable">$&#123;CATALINA_HOME&#125;</span>/webapps<br><br>RUN mkdir /apps <br>ADD apache-tomcat-8.5.68.tar.gz /apps <br>RUN ln -s /apps/apache-tomcat-8.5.68 /apps/tomcat<br></code></pre></td></tr></table></figure>

<h4 id="2-4-3-3-通过脚本构建tomcat-基础镜像"><a href="#2-4-3-3-通过脚本构建tomcat-基础镜像" class="headerlink" title="2.4.3.3 通过脚本构建tomcat 基础镜像"></a>2.4.3.3 通过脚本构建tomcat 基础镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-base-8.5.68]<span class="hljs-comment">#vim build.sh</span><br>[root@ubuntu1804 tomcat-base-8.5.68]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>docker build -t tomcat-base:v8.5.68 .<br><br>[root@ubuntu1804 tomcat-base-8.5.68]<span class="hljs-comment">#tree</span><br>.<br>├── apache-tomcat-8.5.68.tar.gz<br>├── build.sh<br>└── Dockerfile<br><br>0 directories, 3 files<br><br>[root@ubuntu1804 tomcat-base-8.5.50]<span class="hljs-comment">#chmod +x build.sh</span><br>[root@ubuntu1804 tomcat-base-8.5.50]<span class="hljs-comment">#./build.sh</span><br>[root@ubuntu1804 tomcat-base-8.5.50]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>tomcat-base         v8.5.50             9eca0bb63800        11 seconds ago      856MB<br>centos7-jdk         8u212               b14c76ca5114        7 minutes ago       841MB<br>centos7.7base       v1.0                87c2136795c2        26 minutes ago      435MB<br>centos              centos7.7.1908      08d05d1d5859        19 months ago       204MB<br></code></pre></td></tr></table></figure>

<h4 id="2-4-3-4-验证镜像构建完成"><a href="#2-4-3-4-验证镜像构建完成" class="headerlink" title="2.4.3.4 验证镜像构建完成"></a>2.4.3.4 验证镜像构建完成</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-base-8.5.50]<span class="hljs-comment">#docker run -it --rm -p 8080:8080 tomcat-base:v8.5.68 bash </span><br>[root@5a4ed7bf5e9e /]<span class="hljs-comment"># /apps/tomcat/bin/catalina.sh start</span><br>Using CATALINA_BASE:   /apps/tomcat<br>Using CATALINA_HOME:   /apps/tomcat<br>Using CATALINA_TMPDIR: /apps/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk/jre<br>Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar<br>Using CATALINA_OPTS:   <br>Tomcat started.<br>[root@5a4ed7bf5e9e /]<span class="hljs-comment"># netstat -ntl</span><br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address           Foreign Address         State      <br>tcp        0      0 127.0.0.1:8005          0.0.0.0:*               LISTEN     <br>tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN<br></code></pre></td></tr></table></figure>

<h3 id="2-4-4-构建业务镜像1"><a href="#2-4-4-构建业务镜像1" class="headerlink" title="2.4.4 构建业务镜像1"></a>2.4.4 构建业务镜像1</h3><p>创建tomcat-app1和tomcat-app2两个目录，代表不同的两个基于tomcat的业务。</p>
<h4 id="2-4-4-1-准备tomcat的配置文件"><a href="#2-4-4-1-准备tomcat的配置文件" class="headerlink" title="2.4.4.1 准备tomcat的配置文件"></a>2.4.4.1 准备tomcat的配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#mkdir -p /data/dockerfile/web/tomcat/tomcat-app&#123;1,2&#125;</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#tree /data/dockerfile/web/tomcat/</span><br>/data/dockerfile/web/tomcat/<br>├── tomcat-app1<br>├── tomcat-app2<br>└── tomcat-base-8.5.68<br> ├── apache-tomcat-8.5.68.tar.gz<br> ├── build.sh<br> └── Dockerfile<br>3 directories, 3 files<br><br><span class="hljs-comment">#上传和修改server.xml</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/tomcat/tomcat-base-8.5.68</span><br>[root@ubuntu1804 tomcat-base-8.5.68]<span class="hljs-comment">#tar xf apache-tomcat-8.5.68.tar.gz</span><br>[root@ubuntu1804 tomcat-base-8.5.68]<span class="hljs-comment">#cp apache-tomcat-8.5.68/conf/server.xml /data/dockerfile/web/tomcat/tomcat-app1/</span><br>[root@ubuntu1804 tomcat-base-8.5.68]<span class="hljs-comment">#cd /data/dockerfile/web/tomcat/tomcat-app1/</span><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#vim server.xml</span><br>......<br>152 &lt;Host name=<span class="hljs-string">&quot;localhost&quot;</span>  appBase=<span class="hljs-string">&quot;/data/tomcat/webapps&quot;</span> unpackWARs=<span class="hljs-string">&quot;true&quot;</span> autoDeploy=<span class="hljs-string">&quot;true&quot;</span>&gt;<br>......<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker52.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-4-4-2-准备自定义页面"><a href="#2-4-4-2-准备自定义页面" class="headerlink" title="2.4.4.2 准备自定义页面"></a>2.4.4.2 准备自定义页面</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#mkdir app</span><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#echo &quot;Tomcat Page in app1&quot; &gt; app/index.jsp</span><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#tar zcf app.tar.gz app</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-3-准备容器启动执行脚本"><a href="#2-4-4-3-准备容器启动执行脚本" class="headerlink" title="2.4.4.3 准备容器启动执行脚本"></a>2.4.4.3 准备容器启动执行脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#vim run_tomcat.sh</span><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#cat run_tomcat.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;nameserver 180.76.76.76&quot;</span> &gt; /etc/resolv.conf<br>su - www -c <span class="hljs-string">&quot;/apps/tomcat/bin/catalina.sh start&quot;</span><br>su - www -c <span class="hljs-string">&quot;tail -f /etc/hosts&quot;</span><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#chmod a+x run_tomcat.sh</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-4-准备Dockerfile"><a href="#2-4-4-4-准备Dockerfile" class="headerlink" title="2.4.4.4 准备Dockerfile"></a>2.4.4.4 准备Dockerfile</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#vim Dockerfile</span><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#cat Dockerfile</span><br><span class="hljs-comment">#Tomcat Web Image</span><br>FROM tomcat-base:v8.5.68<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;rootrlin.com&gt;&quot;</span><br>ADD server.xml /apps/tomcat/conf/server.xml<br>ADD run_tomcat.sh /apps/tomcat/bin/run_tomcat.sh<br>ADD app.tar.gz /data/tomcat/webapps/<br>RUN chown -R www.www /apps/ /data/tomcat/<br>EXPOSE 8080  8009<br>CMD [<span class="hljs-string">&quot;/apps/tomcat/bin/run_tomcat.sh&quot;</span>]<br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-5-执行构建脚本制作镜像"><a href="#2-4-4-5-执行构建脚本制作镜像" class="headerlink" title="2.4.4.5 执行构建脚本制作镜像"></a>2.4.4.5 执行构建脚本制作镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#vim build.sh</span><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>docker build -t tomcat-web:app1 .<br><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#pwd</span><br>/data/dockerfile/web/tomcat/tomcat-app1<br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#tree</span><br>.<br>├── app<br>│  └── index.jsp<br>├── app.tar.gz<br>├── build.sh<br>├── Dockerfile<br>├── run_tomcat.sh<br>└── server.xml<br><br>1 directory, 6 files<br><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#bash build.sh</span><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>tomcat-web          app1                c8393e89cfa7        17 seconds ago      871MB<br>tomcat-base         v8.5.50             9eca0bb63800        13 minutes ago      856MB<br>centos7-jdk         8u212               b14c76ca5114        19 minutes ago      841MB<br>centos7.7base       v1.0                87c2136795c2        39 minutes ago      435MB<br>centos              centos7.7.1908      08d05d1d5859        19 months ago       204MB<br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-6-从镜像启动测试容器"><a href="#2-4-4-6-从镜像启动测试容器" class="headerlink" title="2.4.4.6 从镜像启动测试容器"></a>2.4.4.6 从镜像启动测试容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#docker run -d -p 8080:8080 tomcat-web:app1</span><br>9feedcd96b0603a1bb41e79cde72412435b305c653741a2510f6a041d9e5553e<br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-7-访问测试"><a href="#2-4-4-7-访问测试" class="headerlink" title="2.4.4.7 访问测试"></a>2.4.4.7 访问测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#curl 127.0.0.1:8080/app/</span><br>Tomcat Page <span class="hljs-keyword">in</span> app1<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker exec -it 9feedcd96b06 bash</span><br>[root@9feedcd96b06 /]<span class="hljs-comment"># ps aux</span><br>USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br>root          1  0.3  0.0  13304  2924 ?        Ss   23:13   0:00 /bin/bash /apps/tomcat/bin/run_tomcat.sh<br>www          26  5.1  3.4 4550552 137248 ?      Sl   23:13   0:02 /usr/<span class="hljs-built_in">local</span>/jdk/bin/java -Djava.util.logging.config.file=/apps/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.prot<br>root         27  0.0  0.1  83596  4568 ?        S    23:13   0:00 su - www -c tail -f /etc/hosts<br>www          29  0.0  0.0   4416   732 ?        Ss   23:13   0:00 tail -f /etc/hosts<br>root         75  2.1  0.1  13944  4084 pts/0    Ss   23:14   0:00 bash<br>root         95  0.0  0.0  53368  3908 pts/0    R+   23:14   0:00 ps aux<br>[root@9feedcd96b06 /]<span class="hljs-comment"># vim /data/tomcat/webapps/app/index.jsp</span><br>[root@9feedcd96b06 /]<span class="hljs-comment"># cat /data/tomcat/webapps/app/index.jsp</span><br>Tomcat Page <span class="hljs-keyword">in</span> app1 v2<br>[root@9feedcd96b06 /]<span class="hljs-comment"># /apps/tomcat/bin/catalina.sh stop</span><br>Using CATALINA_BASE:   /apps/tomcat<br>Using CATALINA_HOME:   /apps/tomcat<br>Using CATALINA_TMPDIR: /apps/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk/jre<br>Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar<br>Using CATALINA_OPTS:<br>[root@9feedcd96b06 /]<span class="hljs-comment"># /apps/tomcat/bin/catalina.sh start</span><br>Using CATALINA_BASE:   /apps/tomcat<br>Using CATALINA_HOME:   /apps/tomcat<br>Using CATALINA_TMPDIR: /apps/tomcat/temp<br>Using JRE_HOME:        /usr/<span class="hljs-built_in">local</span>/jdk/jre<br>Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar<br>Using CATALINA_OPTS:   <br>Tomcat started.<br><br>[root@ubuntu1804 tomcat-app1]<span class="hljs-comment">#curl 127.0.0.1:8080/app/</span><br>Tomcat Page <span class="hljs-keyword">in</span> app1 v2<br></code></pre></td></tr></table></figure>

<h3 id="2-4-4-构建业务镜像2"><a href="#2-4-4-构建业务镜像2" class="headerlink" title="2.4.4 构建业务镜像2"></a>2.4.4 构建业务镜像2</h3><h4 id="2-4-4-1-准备自定义页面和其它数据"><a href="#2-4-4-1-准备自定义页面和其它数据" class="headerlink" title="2.4.4.1 准备自定义页面和其它数据"></a>2.4.4.1 准备自定义页面和其它数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat]<span class="hljs-comment">#pwd</span><br>/data/dockerfile/web/tomcat<br>[root@ubuntu1804 tomcat]<span class="hljs-comment">#cp -a tomcat-app1/* tomcat-app2/</span><br>[root@ubuntu1804 tomcat]<span class="hljs-comment">#tree tomcat-app2/</span><br>tomcat-app2/<br>├── app<br>│  └── index.jsp<br>├── app.tar.gz<br>├── build.sh<br>├── Dockerfile<br>├── run_tomcat.sh<br>└── server.xml<br><br>1 directory, 6 files<br><br>[root@ubuntu1804 tomcat]<span class="hljs-comment">#cd tomcat-app2</span><br>[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#echo &quot;Tomcat Page in app2&quot; &gt; app/index.html</span><br>[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#rm -f app.tar.gz</span><br>[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#tar zcf app.tar.gz app</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-2-准备容器启动脚本run-tomcat-sh"><a href="#2-4-4-2-准备容器启动脚本run-tomcat-sh" class="headerlink" title="2.4.4.2 准备容器启动脚本run_tomcat.sh"></a>2.4.4.2 准备容器启动脚本run_tomcat.sh</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#cat run_tomcat.sh </span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;nameserver 180.76.76.76&quot;</span> &gt; /etc/resolv.conf<br>su - www -c <span class="hljs-string">&quot;/apps/tomcat/bin/catalina.sh start&quot;</span><br>su - www -c <span class="hljs-string">&quot;tail -f /etc/hosts&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-3-准备Dockerfile"><a href="#2-4-4-3-准备Dockerfile" class="headerlink" title="2.4.4.3 准备Dockerfile"></a>2.4.4.3 准备Dockerfile</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#vim Dockerfile </span><br><span class="hljs-comment">#Tomcat Web Image</span><br>FROM tomcat-base:v8.5.68<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>ADD server.xml /apps/tomcat/conf/server.xml<br>ADD run_tomcat.sh /apps/tomcat/bin/run_tomcat.sh<br>ADD app.tar.gz /data/tomcat/webapps/<br>RUN chown -R www.www /apps/ /data/tomcat/<br>EXPOSE 8080  8009<br>CMD [<span class="hljs-string">&quot;/apps/tomcat/bin/run_tomcat.sh&quot;</span>]<br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-4-执行构建脚本制作镜像"><a href="#2-4-4-4-执行构建脚本制作镜像" class="headerlink" title="2.4.4.4 执行构建脚本制作镜像"></a>2.4.4.4 执行构建脚本制作镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#vim build.sh</span><br>[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>docker build -t tomcat-web:app2 .<br>[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#bash build.sh</span><br>[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>tomcat-web          app2                8b8871507191        8 seconds ago       871MB<br>tomcat-web          app1                c8393e89cfa7        11 hours ago        871MB<br>tomcat-base         v8.5.50             9eca0bb63800        11 hours ago        856MB<br>centos7-jdk         8u212               b14c76ca5114        11 hours ago        841MB<br>centos7.7base       v1.0                87c2136795c2        11 hours ago        435MB<br>centos              centos7.7.1908      08d05d1d5859        19 months ago       204MB<br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-5-从镜像启动容器测试"><a href="#2-4-4-5-从镜像启动容器测试" class="headerlink" title="2.4.4.5 从镜像启动容器测试"></a>2.4.4.5 从镜像启动容器测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#docker run -d -p 8082:8080 tomcat-web:app2</span><br>ae6612438d9368d635cc4bbbe173ad638218df56ff34db7847b04f98f9b322b9<br></code></pre></td></tr></table></figure>

<h4 id="2-4-4-6-访问测试"><a href="#2-4-4-6-访问测试" class="headerlink" title="2.4.4.6 访问测试"></a>2.4.4.6 访问测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 tomcat-app2]<span class="hljs-comment">#curl 127.0.0.1:8082/app/</span><br>Tomcat Page <span class="hljs-keyword">in</span> app2<br></code></pre></td></tr></table></figure>

<h2 id="2-5-生产案例-构建haproxy镜像"><a href="#2-5-生产案例-构建haproxy镜像" class="headerlink" title="2.5 生产案例: 构建haproxy镜像"></a>2.5 生产案例: 构建haproxy镜像</h2><h3 id="2-5-1-准备相关文件"><a href="#2-5-1-准备相关文件" class="headerlink" title="2.5.1 准备相关文件"></a>2.5.1 准备相关文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#准备haproxy源码文件</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#mkdir -p /data/dockerfile/web/haproxy/2.1.2-centos7</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/haproxy/2.1.2-centos7</span><br>[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#wget https://repo.huaweicloud.com/haproxy/2.1/src/haproxy-2.1.2.tar.gz</span><br><br><span class="hljs-comment">#准备haproxy启动脚本</span><br>[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#vim run_haproxy.sh</span><br>[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#cat run_haproxy.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>haproxy -f /etc/haproxy/haproxy.cfg<br>tail -f /etc/hosts<br></code></pre></td></tr></table></figure>

<h3 id="2-5-2-准备haproxy配置文件"><a href="#2-5-2-准备haproxy配置文件" class="headerlink" title="2.5.2 准备haproxy配置文件"></a>2.5.2 准备haproxy配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#准备haproxy配置文件</span><br>[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#vim haproxy.cfg</span><br>global<br>chroot /apps/haproxy<br><span class="hljs-comment">#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin</span><br>uid 99<br>gid 99<br>daemon<br>nbproc 1<br>pidfile /apps/haproxy/run/haproxy.pid<br><span class="hljs-built_in">log</span> 127.0.0.1 local3 info<br>defaults<br>option http-keep-alive<br>option forwardfor<br>mode http<br>timeout connect 300000ms<br>timeout client 300000ms<br>timeout server 300000ms<br>listen stats<br>  mode http<br>  <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br>  stats <span class="hljs-built_in">enable</span><br>  <span class="hljs-built_in">log</span> global<br>  stats uri  /haproxy-status<br>  stats auth haadmin:123456<br><br>listen web_port<br>  <span class="hljs-built_in">bind</span> 0.0.0.0:80<br>  mode http<br>  <span class="hljs-built_in">log</span> global<br>  balance roundrobin<br>  server web1 10.0.0.102:8080 check inter 3000 fall 2 rise 5<br>  server web2 10.0.0.103:8080 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h3 id="2-5-3-准备Dockerfile"><a href="#2-5-3-准备Dockerfile" class="headerlink" title="2.5.3 准备Dockerfile"></a>2.5.3 准备Dockerfile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#pwd</span><br>/data/dockerfile/web/haproxy/2.1.2-centos7<br><br>[root@ubuntu1804 haproxy]<span class="hljs-comment"># vim Dockerfile</span><br><span class="hljs-comment">#Haproxy Base Image</span><br>FROM centos7.7base:v1.0<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br><br>ADD haproxy-2.1.2.tar.gz /usr/<span class="hljs-built_in">local</span>/src/<br><br>RUN <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/haproxy-2.1.2 \<br> &amp;&amp; make ARCH=x86_64 TARGET=linux-glibc USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1 USE_CPU_AFFINITY=1 PREFIX=/apps/haproxy \<br>&amp;&amp; make install PREFIX=/apps/haproxy \<br>&amp;&amp; ln -s /apps/haproxy/sbin/haproxy /usr/sbin/ \<br>&amp;&amp; mkdir /apps/haproxy/run \<br>&amp;&amp; rm -rf /usr/<span class="hljs-built_in">local</span>/src/haproxy* <br><br>ADD haproxy.cfg /etc/haproxy/<br>ADD run_haproxy.sh /usr/bin<br><br>EXPOSE 80 9999<br>CMD [<span class="hljs-string">&quot;run_haproxy.sh&quot;</span>]<br></code></pre></td></tr></table></figure>

<h3 id="2-5-4-准备构建脚本构建haproxy镜像"><a href="#2-5-4-准备构建脚本构建haproxy镜像" class="headerlink" title="2.5.4 准备构建脚本构建haproxy镜像"></a>2.5.4 准备构建脚本构建haproxy镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#vim build.sh</span><br>[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>docker build -t haproxy-centos7:2.1.2 .<br><br>[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#ls</span><br>build.sh Dockerfile haproxy-2.1.2.tar.gz haproxy.cfg run_haproxy.sh<br><br>[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#bash build.sh</span><br>[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#docker images</span><br>REPOSITORY     TAG         IMAGE ID      CREATED      <br>SIZE<br>haproxy-centos7   2.1.2        5eccdb29a058     26 minutes ago  <br>428MB<br>nginx-ubuntu1804   1.16.1       19efdd23ac87     15 hours ago   <br>378MB<br>alpine-nginx     1.16.1       978a43bbb61d     16 hours ago   <br>211MB<br>nginx-alpine     1.16.1       978a43bbb61d     16 hours ago   <br>211MB<br>alpine-base     3.11        b162eecf4da9     17 hours ago   <br>182MB<br>tomcat-web     app2        0e1760fe79a6     37 hours ago   <br>838MB<br>tomcat-web     app1        76016219a0ca     37 hours ago   <br>838MB<br>tomcat-base     v8.5.50       8d5395cb72c4     38 hours ago   <br>824MB<br>centos7-jdk     8u212        e0fe770a7ccd     39 hours ago   <br>809MB<br>centos7-base    v1         34ab3afcd3b3     40 hours ago   <br>403MB<br>alpine        3.11        e7d92cdc71fe     12 days ago    <br>5.59MB<br>alpine       latest       e7d92cdc71fe     12 days ago    <br>5.59MB<br>ubuntu        18.04        ccc6e87d482b     2 weeks ago    <br>64.2MB<br>ubuntu       bionic       ccc6e87d482b     2 weeks ago    <br>64.2MB<br>centos       centos7.7.1908   08d05d1d5859     2 months ago   <br>204MB<br></code></pre></td></tr></table></figure>

<h3 id="2-5-5-从镜像启动容器"><a href="#2-5-5-从镜像启动容器" class="headerlink" title="2.5.5 从镜像启动容器"></a>2.5.5 从镜像启动容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#docker run -d -p 80:80 -p 9999:9999 haproxy-centos7:2.1.2</span><br>e0a7c827cb5fdd5a630f7dfe58b1f60822da18929a4dfeccb7490fb78403e3df<br></code></pre></td></tr></table></figure>

<h3 id="2-5-6-在另外两台主机启动容器"><a href="#2-5-6-在另外两台主机启动容器" class="headerlink" title="2.5.6 在另外两台主机启动容器"></a>2.5.6 在另外两台主机启动容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#导出本地相关镜像</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker save centos7-base:v1 &gt; /data/centos7-base.tar.gz</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker save centos7-jdk:8u212 &gt; /data/centos7-jdk.tar.gz</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker save tomcat-base:v8.5.50 &gt; /data/tomcat-base.tar.gz</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker save tomcat-web:app1 &gt; /data/tomcat-web-app1.tar.gz</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker save tomcat-web:app2 &gt; /data/tomcat-web-app2.tar.gz</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ls /data</span><br>centos7-base.tar.gz centos7-jdk.tar.gz dockerfile tomcat-base.tar.gz tomcat-web-app1.tar.gz tomcat-web-app2.tar.gz<br><br><span class="hljs-comment">#将镜像复制到另外两台主机</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#scp /data/*.gz 10.0.0.101:/data/</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#scp /data/*.gz 10.0.0.102:/data/ </span><br><br><span class="hljs-comment">#在另外两台主机上执行下面操作导入镜像</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#ls /data</span><br>centos7-base.tar.gz lost+found     tomcat-web-app1.tar.gz<br>centos7-jdk.tar.gz  tomcat-base.tar.gz tomcat-web-app2.tar.gz<br>[root@ubuntu1804 ~]<span class="hljs-comment">#for i in /data/*.gz;do docker load -i $i;done</span><br><br><span class="hljs-comment">#在另外两台主机上创建相关容器</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d -p 8080:8080 tomcat-web:app1</span><br>781681e73333396b23f404e70d0c781ab464a8e9b578f41c153583d23bd76a46<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker run -d -p 8080:8080 tomcat-web:app2</span><br>81fa01a688cb72cf397a5da46acc89a51f2a2f8de3a0072565d701625c43540a<br></code></pre></td></tr></table></figure>

<h3 id="2-5-7-web访问验证"><a href="#2-5-7-web访问验证" class="headerlink" title="2.5.7 web访问验证"></a>2.5.7 web访问验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#curl http://10.0.0.100/app/</span><br>Tomcat Page <span class="hljs-keyword">in</span> app1<br>[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#curl http://10.0.0.100/app/</span><br>Tomcat Page <span class="hljs-keyword">in</span> app2<br>[root@ubuntu1804 2.1.2-centos7]<span class="hljs-comment">#docker exec -it e0a7c827cb5 bash</span><br>[root@e0a7c827cb5f /]<span class="hljs-comment"># netstat -ntl</span><br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address      Foreign Address     State   <br>tcp     0    0 0.0.0.0:9999       0.0.0.0:*        LISTEN  <br>tcp     0    0 0.0.0.0:80        0.0.0.0:*        LISTEN  <br>[root@e0a7c827cb5f /]<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>[root@e0a7c827cb5f /]<span class="hljs-comment"># ps aux</span><br>USER    PID %CPU %MEM  VSZ  RSS TTY   STAT START  TIME COMMAND<br>root      1  0.0  0.2  11700  2428 ?    Ss  11:01  0:00 /bin/bash<br>/usr/bin/run_haproxy.sh<br>nobody     7  0.0  7.1 181076 70324 ?    Ss  11:01  0:00 haproxy -f<br>/etc/haproxy/haproxy.cfg<br>root      8  0.0  0.0  4416  772 ?    S   11:01  0:00 tail -f<br>/etc/hosts<br>root      9  0.1  0.3  12488  3696 pts/0  Ss  11:02  0:00 bash<br>root     54  0.0  0.3  51764  3448 pts/0  R+  11:06  0:00 ps aux<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker53.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker54.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在第二台主机上停止容器</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker stop 81fa01a688cb</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps -a</span><br>CONTAINER ID    IMAGE        COMMAND         CREATED    <br>  STATUS            PORTS        NAMES<br>81fa01a688cb    tomcat-web:app2   <span class="hljs-string">&quot;/apps/tomcat/bin/ru…&quot;</span>  28 minutes ago<br>  Exited (137) 39 seconds ago<br><span class="hljs-comment">#观察状态页，发现后端服务器down</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker55.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在第二台主机上恢复启动容器</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker start 81fa01a688cb</span><br>81fa01a688cb<br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker ps -a</span><br>CONTAINER ID    IMAGE        COMMAND         CREATED    <br>  STATUS       PORTS               NAMES<br>81fa01a688cb    tomcat-web:app2   <span class="hljs-string">&quot;/apps/tomcat/bin/ru…&quot;</span>  30 minutes ago<br>  Up 14 seconds    8009/tcp, 0.0.0.0:8080-&gt;8080/tcp  optimistic_shirley<br><span class="hljs-comment">#再次观察状态页，发现后端服务器上线</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/docker/docker56.png" srcset="/blog/img/loading.gif"></p>
<h2 id="2-6-基于-alpine-基础镜像制作nginx镜像"><a href="#2-6-基于-alpine-基础镜像制作nginx镜像" class="headerlink" title="2.6 基于 alpine 基础镜像制作nginx镜像"></a>2.6 基于 alpine 基础镜像制作nginx镜像</h2><h3 id="2-6-1-制作alpine的自定义系统镜像"><a href="#2-6-1-制作alpine的自定义系统镜像" class="headerlink" title="2.6.1 制作alpine的自定义系统镜像"></a>2.6.1 制作alpine的自定义系统镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载alpine镜像,打新标签</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker pull alpine:3.11</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>alpine              3.11                e389ae589224        2 months ago        5.62MB<br><br><span class="hljs-comment">#准备相关文件</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/system/alpine</span><br>[root@ubuntu1804 alpine]<span class="hljs-comment">#vim repositories</span><br>http://mirrors.aliyun.com/alpine/v3.11/main<br>http://mirrors.aliyun.com/alpine/v3.11/community<br><br><span class="hljs-comment">#准备Dockerfile文件</span><br>[root@ubuntu1804 alpine]<span class="hljs-comment">#vim Dockerfile</span><br>FROM alpine:3.11<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>COPY repositories /etc/apk/repositories<br>RUN apk update &amp;&amp; apk --no-cache add iotop gcc libgcc libc-dev libcurl libc-utils pcre-dev zlib-dev libnfs make pcre pcre2 zip unzip net-tools pstree wget libevent libevent-dev iproute2<br><br><span class="hljs-comment">#准备构建脚本</span><br>[root@ubuntu1804 alpine]<span class="hljs-comment">#vim build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>docker build -t alpine-base:3.11 .<br>[root@ubuntu1804 alpine]<span class="hljs-comment">#bash build.sh</span><br>[root@ubuntu1804 alpine]<span class="hljs-comment">#docker images alp*</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>alpine-base         3.11                56909ecc9056        5 minutes ago       183MB<br>alpine              3.11                e389ae589224        2 months ago        5.62MB<br></code></pre></td></tr></table></figure>

<h3 id="2-6-2-制作基于alpine自定义镜像的nginx镜像"><a href="#2-6-2-制作基于alpine自定义镜像的nginx镜像" class="headerlink" title="2.6.2 制作基于alpine自定义镜像的nginx镜像"></a>2.6.2 制作基于alpine自定义镜像的nginx镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#准备相关文件</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#mkdir /data/dockerfile/web/nginx/1.16.1-alpine/</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/nginx/1.16.1-alpine/</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#echo Test Page based nginx-alpine &gt; index.html</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#cp /data/dockerfile/web/nginx/1.16/nginx.conf .</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#cat nginx.conf</span><br>user nginx;<br>worker_processes  1;<br>daemon off;<br>...<br>location / &#123;<br>     root  /data/nginx/html;<br>...<br><br><span class="hljs-comment">#编写Dockerfile文件</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#vim Dockerfile</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#cat Dockerfile</span><br>FROM alpine-base:3.11<br>LABEL maintainer=<span class="hljs-string">&quot;wangxiaochun &lt;root@wangxiaochun.com&gt;&quot;</span><br>ADD nginx-1.16.1.tar.gz /usr/<span class="hljs-built_in">local</span>/src<br>RUN <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1 &amp;&amp; ./configure  --prefix=/apps/nginx &amp;&amp; make<br>&amp;&amp; make install &amp;&amp; ln -s /apps/nginx/sbin/nginx /usr/bin/<br>RUN addgroup  -g 2019 -S nginx &amp;&amp; adduser  -s /sbin/nologin -S -D  -u 2019 -G<br>nginx nginx<br>COPY nginx.conf /apps/nginx/conf/nginx.conf<br><br>ADD index.html /data/nginx/html/index.html<br>RUN chown  -R nginx.nginx /data/nginx/ /apps/nginx/<br>EXPOSE 80 443<br>CMD [<span class="hljs-string">&quot;nginx&quot;</span>]<br><br><span class="hljs-comment">#构建镜像</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#vim build.sh</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#********************************************************************</span><br>docker build -t nginx-alpine:1.16.1 .<br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#ls</span><br>build.sh Dockerfile index.html nginx-1.16.1.tar.gz nginx.conf<br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#bash build.sh</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#docker images</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED              SIZE<br>nginx-alpine        1.16.1              15817ac753e1        About a minute ago   212MB<br>alpine-base         3.11                56909ecc9056        16 minutes ago       183MB<br>alpine              3.11                e389ae589224        2 months ago         5.62MB<br><br><span class="hljs-comment">#生成容器测试镜像</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#docker run -d -p 80:80 nginx-alpine:1.16.1</span><br>847842a78c19bd986b170f944562f36951b25967c7d84a0ce22d81b80d00ea53<br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#curl 127.0.0.1</span><br>Test Page based nginx-alpine<br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#docker exec -it 847842a78c19 sh</span><br>/ <span class="hljs-comment"># ps aux</span><br>PID   USER     TIME  COMMAND<br>    1 root      0:00 nginx: master process nginx<br>    7 nginx     0:00 nginx: worker process<br>    8 root      0:00 sh<br>   14 root      0:00 ps aux<br>/ <span class="hljs-comment"># ls /data/nginx/html/ -l</span><br>total 4<br>-rw-r--r--    1 nginx    nginx           29 Jun 30 03:23 index.html<br>/ <span class="hljs-comment"># exit</span><br>[root@ubuntu1804 1.16.1-alpine]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h2 id="2-7-基于-Ubuntu-基础镜像制作-nginx-镜像"><a href="#2-7-基于-Ubuntu-基础镜像制作-nginx-镜像" class="headerlink" title="2.7 基于 Ubuntu 基础镜像制作 nginx 镜像"></a>2.7 基于 Ubuntu 基础镜像制作 nginx 镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载ubuntu1804镜像</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker pull ubuntu:18.04</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#docker images ubuntu*</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>ubuntu              18.04               7d0d8fa37224        12 days ago         63.1MB<br><span class="hljs-comment">#准备相关文件</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#mkdir -p /data/dockerfile/web/nginx/1.16.1-ubuntu1804</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#cd /data/dockerfile/web/nginx/1.16.1-ubuntu1804</span><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#vim sources.list</span><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#cat sources.list</span><br>deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe<br>multiverse<br><br>deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe<br>multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted<br>universe multiverse<br><br>deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe<br>multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted<br>universe multiverse<br><br>deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe<br>multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted<br>universe multiverse<br><br>deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe<br>multiverse<br>deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted<br>universe multiverse<br><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#cp ../1.16.1-alpine/nginx.conf .</span><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#echo Test Page based nginx-ubuntu1804 &gt; index.html</span><br><br><span class="hljs-comment">#编写Dockerfile文件</span><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#vim Dockerfile</span><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#cat Dockerfile</span><br>FROM ubuntu:18.04<br>LABEL maintainer=<span class="hljs-string">&quot;rlin &lt;root@rlin.com&gt;&quot;</span><br>COPY sources.list /etc/apt/sources.list<br>RUN apt update &amp;&amp;  apt install -y nfs-kernel-server nfs-common gcc openssh-server lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev  unzip zip make<br>ADD nginx-1.16.1.tar.gz /usr/<span class="hljs-built_in">local</span>/src<br>RUN <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1 &amp;&amp; ./configure --prefix=/apps/nginx &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s /apps/nginx/sbin/nginx /usr/bin &amp;&amp; rm -rf /usr/<span class="hljs-built_in">local</span>/src/nginx-1.16.1*<br>ADD nginx.conf /apps/nginx/conf/nginx.conf<br>ADD index.html /data/nginx/html/index.html<br>RUN groupadd -g 2019 nginx &amp;&amp; useradd -g nginx -s /usr/sbin/nologin -u 2019 nginx &amp;&amp; chown -R nginx.nginx /apps/nginx /data/nginx<br>EXPOSE 80 443<br>CMD [<span class="hljs-string">&quot;nginx&quot;</span>]<br><br><span class="hljs-comment">#构建镜像</span><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#vim build.sh</span><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#cat build.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>docker build -t nginx-ubuntu1804:1.16.1 .<br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#ls</span><br>build.sh Dockerfile index.html nginx-1.16.1.tar.gz nginx.conf sources.list<br><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#docker images &quot;nginx*&quot;</span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>nginx-ubuntu1804    1.16.1              f5d4e8278be8        3 minutes ago       386MB<br>ubuntu              18.04               7d0d8fa37224        12 days ago         63.1MB<br><br><span class="hljs-comment">#启动容器测试镜像</span><br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#docker run -d -p 80:80 nginx-ubuntu1804:1.16.1</span><br>58f8e9a8fd6eebb19bd2b7c27bd8d52a3a4d42637a942e1e9179ec1b2bcc559d<br>[root@ubuntu1804 1.16.1-ubuntu1804]<span class="hljs-comment">#curl 127.0.0.1</span><br>Test Page based nginx-ubuntu1804<br></code></pre></td></tr></table></figure>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/linux-docker/">linux docker</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AFdocker%EF%BC%88%E5%85%AB%EF%BC%89docker%E5%8F%AF%E8%A7%86%E5%8C%96%E5%9B%BE%E5%BD%A2%E5%B7%A5%E5%85%B7Portainer/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">企业级容器技术docker（八）docker可视化图形工具Portainer</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AFdocker%EF%BC%88%E5%85%AD%EF%BC%89docker%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92/">
                        <span class="hidden-mobile">企业级容器技术docker（六）docker单机编排</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
