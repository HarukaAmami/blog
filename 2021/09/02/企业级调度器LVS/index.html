

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>企业级调度器LVS - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="企业级调度器LVS">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-02 14:31" pubdate>
        2021年9月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      18.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      296
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">企业级调度器LVS</h1>
            
            <div class="markdown-body">
              <h1 id="企业级调度器LVS"><a href="#企业级调度器LVS" class="headerlink" title="企业级调度器LVS"></a>企业级调度器LVS</h1><h1 id="一、集群和分布式"><a href="#一、集群和分布式" class="headerlink" title="一、集群和分布式"></a>一、集群和分布式</h1><p>系统性能扩展方式：</p>
<ul>
<li>Scale UP：垂直扩展，向上扩展,增强，性能更强的计算机运行同样的服务</li>
<li>Scale Out：水平扩展，向外扩展,增加设备，并行地运行多个服务调度分配问题，Cluster</li>
</ul>
<p>垂直扩展不再提及：</p>
<p>随着计算机性能的增长，其价格会成倍增长</p>
<p>单台计算机的性能是有上限的，不可能无限制地垂直扩展</p>
<p>多核CPU意味着即使是单台计算机也可以并行的。那么，为什么不一开始就并行化技术？</p>
<h2 id="1-1-集群-Cluster"><a href="#1-1-集群-Cluster" class="headerlink" title="1.1 集群 Cluster"></a>1.1 集群 Cluster</h2><p>Cluster：集群,为解决某个特定问题将多台计算机组合起来形成的单个系统</p>
<p>Cluster分为三种类型：</p>
<ul>
<li>LB：Load Balancing，负载均衡，多个主机组成，每个主机只承担一部分访问请求</li>
<li>HA：High Availiablity，高可用，避免SPOF（single Point Of failure）<pre><code>MTBF:Mean Time Between Failure 平均无故障时间，正常时间
MTTR:Mean Time To Restoration（ repair）平均恢复前时间，故障时间
A = MTBF /（MTBF+MTTR） (0,1)：99%,99.5%,99.9%,99.99%,99.999%
</code></pre>
</li>
</ul>
<p><strong>SLA</strong>：服务等级协议（简称：SLA，全称：service level agreement）。是在一定开销下为保障服务的性能和可用性，服务提供商与用户间定义的一种双方认可的协定。通常这个开销是驱动提供服务质量的主要因素。在常规的领域中，总是设定所谓的三个9，四个9来进行表示，当没有达到这种水平的时候，就会有一些列的惩罚措施，而运维，最主要的目标就是达成这种服务水平。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">1年 = 365天 = 8760小时<br>90 = (1-90%)*365=36.5天<br>99 = 8760 * 1% = 87.6小时<br>99.9 = 8760 * 0.1% = 8760 * 0.001 = 8.76小时<br>99.99 = 8760 * 0.0001 = 0.876小时 = 0.876 * 60 = 52.6分钟<br>99.999 = 8760 * 0.00001 = 0.0876小时 = 0.0876 * 60 = 5.26分钟<br>99.9999= (1-99.9999%)*365*24*60*60=31秒<br></code></pre></td></tr></table></figure>

<p>停机时间又分为两种，一种是计划内停机时间，一种是计划外停机时间，而运维则主要关注计划外<br>停机时间。</p>
<ul>
<li>HPC：High-performance computing，高性能 <a target="_blank" rel="noopener" href="http://www.top500.org/">www.top500.org</a></li>
</ul>
<h2 id="1-2-分布式系统"><a href="#1-2-分布式系统" class="headerlink" title="1.2 分布式系统"></a>1.2 分布式系统</h2><p>分布式存储： Ceph，GlusterFS，FastDFS，MogileFS</p>
<p>分布式计算：hadoop，Spark</p>
<p>分布式常见应用</p>
<ul>
<li>分布式应用-服务按照功能拆分，使用微服务</li>
<li>分布式静态资源–静态资源放在不同的存储集群上</li>
<li>分布式数据和存储–使用key-value缓存系统</li>
<li>分布式计算–对特殊业务使用分布式计算，比如Hadoop集群</li>
</ul>
<h2 id="1-3-集群和分布式"><a href="#1-3-集群和分布式" class="headerlink" title="1.3 集群和分布式"></a>1.3 集群和分布式</h2><p>集群：同一个业务系统，部署在多台服务器上。集群中，每一台服务器实现的功能没有差别，数据和代码都是一样的。</p>
<p>分布式：一个业务被拆成多个子业务，或者本身就是不同的业务，部署在多台服务器上。分布式中，每一台服务器实现的功能是有差别的，数据和代码也是不一样的，分布式每台服务器功能加起来，才是完整的业务。</p>
<p>分布式是以缩短单个任务的执行时间来提升效率的，而集群则是通过提高单位时间内执行的任务数来提升效率。</p>
<p>对于大型网站，访问用户很多，实现一个群集，在前面部署一个负载均衡服务器，后面几台服务器完成同一业务。如果有用户进行相应业务访问时，负载均衡器根据后端哪台服务器的负载情况，决定由给哪一台去完成响应，并且一台服务器垮了，其它的服务器可以顶上来。分布式的每一个节点，都完成不同的业务，如果一个节点垮了，那这个业务可能就会失败。</p>
<h2 id="1-4-集群设计原则"><a href="#1-4-集群设计原则" class="headerlink" title="1.4 集群设计原则"></a>1.4 集群设计原则</h2><p>可扩展性—集群的横向扩展能力</p>
<p>可用性—无故障时间 (SLA service level agreement)</p>
<p>性能—访问响应时间</p>
<p>容量—单位时间内的最大并发吞吐量(C10K 并发问题)</p>
<h2 id="1-5-集群设计实现"><a href="#1-5-集群设计实现" class="headerlink" title="1.5 集群设计实现"></a>1.5 集群设计实现</h2><h3 id="1-5-1-基础设施层面"><a href="#1-5-1-基础设施层面" class="headerlink" title="1.5.1 基础设施层面"></a>1.5.1 基础设施层面</h3><p>提升硬件资源性能—从入口防火墙到后端 web server 均使用更高性能的硬件资源</p>
<p>多域名—DNS 轮询A记录解析</p>
<p>多入口—将A记录解析到多个公网IP入口</p>
<p>多机房—同城+异地容灾</p>
<p>CDN(Content Delivery Network)—基于GSLB(Global Server Load Balance)实现全局负载均衡，如：DNS</p>
<h3 id="1-5-2-业务层面"><a href="#1-5-2-业务层面" class="headerlink" title="1.5.2 业务层面"></a>1.5.2 业务层面</h3><p>分层：安全层、负载层、静态层、动态层、(缓存层、存储层)持久化与非持久化</p>
<p>分割：基于功能分割大业务为小服务</p>
<p>分布式：对于特殊场景的业务，使用分布式计算</p>
<h2 id="1-6-LB-Cluster-负载均衡集群"><a href="#1-6-LB-Cluster-负载均衡集群" class="headerlink" title="1.6 LB Cluster 负载均衡集群"></a>1.6 LB Cluster 负载均衡集群</h2><h3 id="1-6-1-按实现方式划分"><a href="#1-6-1-按实现方式划分" class="headerlink" title="1.6.1 按实现方式划分"></a>1.6.1 按实现方式划分</h3><ul>
<li>硬件</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs1.png" srcset="/blog/img/loading.gif"></p>
<p>F5 Big-IP</p>
<p>Citrix Netscaler</p>
<p>A10 A10</p>
<ul>
<li><p>软件</p>
<p>lvs：Linux Virtual Server，阿里四层 SLB (Server Load Balance)使用</p>
<p>nginx：支持七层调度，阿里七层SLB使用 Tengine</p>
<p>haproxy：支持七层调度</p>
<p>ats：Apache Traffic Server，yahoo捐助给apache</p>
<p>perlbal：Perl 编写</p>
<p>pound</p>
</li>
</ul>
<h3 id="1-6-2-基于工作的协议层次划分"><a href="#1-6-2-基于工作的协议层次划分" class="headerlink" title="1.6.2 基于工作的协议层次划分"></a>1.6.2 基于工作的协议层次划分</h3><ul>
<li><p>传输层（通用）：DNAT 和 DPORT<br>LVS：</p>
<p>nginx：stream</p>
<p>haproxy：mode tcp</p>
</li>
<li><p>应用层（专用）：针对特定协议，常称为 proxy server</p>
<p>http：nginx, httpd, haproxy(mode http), …</p>
<p>fastcgi：nginx, httpd, …</p>
<p>mysql：mysql-proxy, mycat…</p>
</li>
</ul>
<h3 id="1-6-3-负载均衡的会话保持"><a href="#1-6-3-负载均衡的会话保持" class="headerlink" title="1.6.3 负载均衡的会话保持"></a>1.6.3 负载均衡的会话保持</h3><ol>
<li><p>session sticky：同一用户调度固定服务器</p>
<p>Source IP：LVS sh算法（对某一特定服务而言）</p>
<p>Cookie</p>
</li>
<li><p>session replication：每台服务器拥有全部session</p>
<p>session multicast cluster</p>
</li>
<li><p>session server：专门的session服务器<br>Memcached，Redis</p>
</li>
</ol>
<h2 id="1-7-HA-高可用集群实现"><a href="#1-7-HA-高可用集群实现" class="headerlink" title="1.7 HA 高可用集群实现"></a>1.7 HA 高可用集群实现</h2><p>keepalived：vrrp协议</p>
<p>Ais：应用接口规范</p>
<p>heartbeat</p>
<p>cman+rgmanager(RHCS)</p>
<p>coresync_pacemaker</p>
<h1 id="二、Linux-Virtual-Server简介"><a href="#二、Linux-Virtual-Server简介" class="headerlink" title="二、Linux Virtual Server简介"></a>二、Linux Virtual Server简介</h1><h2 id="2-1-LVS介绍"><a href="#2-1-LVS介绍" class="headerlink" title="2.1 LVS介绍"></a>2.1 LVS介绍</h2><p>LVS：Linux Virtual Server，负载调度器，内核集成，章文嵩（花名 正明）, 阿里的四层SLB(Server</p>
<p>Load Balance)是基于LVS+keepalived实现。</p>
<p>LVS 官网：<a target="_blank" rel="noopener" href="http://www.linuxvirtualserver.org/">http://www.linuxvirtualserver.org/</a></p>
<p>阿里SLB和LVS：</p>
<p><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/1803">https://yq.aliyun.com/articles/1803</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/LVS">https://github.com/alibaba/LVS</a></p>
<p>整个SLB系统由3个部分构成，四层负载均衡，七层负载均衡和控制系统</p>
<ul>
<li>四层负载均衡，采用开源软件LVS（linux virtual server），并根据云计算需求对其进行定制化，该技术已经在阿里巴巴内部业务全面上线应用2年多。</li>
<li>七层负载均衡，采用开源软件Tengine，该技术已经在阿里巴巴内部业务全面上线3年多。</li>
<li>控制系统，用于配置和监控负载均衡系统。</li>
</ul>
<h2 id="2-2-LVS工作原理"><a href="#2-2-LVS工作原理" class="headerlink" title="2.2 LVS工作原理"></a>2.2 LVS工作原理</h2><p>VS根据请求报文的目标IP和目标协议及端口将其调度转发至某RS，根据调度算法来挑选RS。LVS是内核级功能，工作在INPUT链的位置，将发往INPUT的流量进行“处理”</p>
<p>范例：查看内核支持LVS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># grep -i -C 10 ipvs /boot/config-4.18.0-240.el8.x86_64</span><br>CONFIG_NETFILTER_XT_MATCH_DCCP=m<br>CONFIG_NETFILTER_XT_MATCH_DEVGROUP=m<br>CONFIG_NETFILTER_XT_MATCH_DSCP=m<br>CONFIG_NETFILTER_XT_MATCH_ECN=m<br>CONFIG_NETFILTER_XT_MATCH_ESP=m<br>CONFIG_NETFILTER_XT_MATCH_HASHLIMIT=m<br>CONFIG_NETFILTER_XT_MATCH_HELPER=m<br>CONFIG_NETFILTER_XT_MATCH_HL=m<br><span class="hljs-comment"># CONFIG_NETFILTER_XT_MATCH_IPCOMP is not set</span><br>CONFIG_NETFILTER_XT_MATCH_IPRANGE=m<br>CONFIG_NETFILTER_XT_MATCH_IPVS=m<br><span class="hljs-comment"># CONFIG_NETFILTER_XT_MATCH_L2TP is not set</span><br>CONFIG_NETFILTER_XT_MATCH_LENGTH=m<br>CONFIG_NETFILTER_XT_MATCH_LIMIT=m<br>CONFIG_NETFILTER_XT_MATCH_MAC=m<br>CONFIG_NETFILTER_XT_MATCH_MARK=m<br>CONFIG_NETFILTER_XT_MATCH_MULTIPORT=m<br><span class="hljs-comment"># CONFIG_NETFILTER_XT_MATCH_NFACCT is not set</span><br>CONFIG_NETFILTER_XT_MATCH_OSF=m<br>CONFIG_NETFILTER_XT_MATCH_OWNER=m<br>CONFIG_NETFILTER_XT_MATCH_POLICY=m<br>--<br>CONFIG_IP_SET_HASH_NETNET=m<br>CONFIG_IP_SET_HASH_NETPORT=m<br>CONFIG_IP_SET_HASH_NETIFACE=m<br>CONFIG_IP_SET_LIST_SET=m<br>CONFIG_IP_VS=m<br>CONFIG_IP_VS_IPV6=y<br><span class="hljs-comment"># CONFIG_IP_VS_DEBUG is not set</span><br>CONFIG_IP_VS_TAB_BITS=12<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IPVS transport protocol load balancing support</span><br><span class="hljs-comment">#</span><br>CONFIG_IP_VS_PROTO_TCP=y<br>CONFIG_IP_VS_PROTO_UDP=y<br>CONFIG_IP_VS_PROTO_AH_ESP=y<br>CONFIG_IP_VS_PROTO_ESP=y<br>CONFIG_IP_VS_PROTO_AH=y<br>CONFIG_IP_VS_PROTO_SCTP=y<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IPVS scheduler</span><br><span class="hljs-comment">#</span><br>CONFIG_IP_VS_RR=m<br>CONFIG_IP_VS_WRR=m<br>CONFIG_IP_VS_LC=m<br>CONFIG_IP_VS_WLC=m<br>CONFIG_IP_VS_FO=m<br>CONFIG_IP_VS_OVF=m<br>CONFIG_IP_VS_LBLC=m<br>CONFIG_IP_VS_LBLCR=m<br>CONFIG_IP_VS_DH=m<br>CONFIG_IP_VS_SH=m<br><span class="hljs-comment"># CONFIG_IP_VS_MH is not set</span><br>CONFIG_IP_VS_SED=m<br>CONFIG_IP_VS_NQ=m<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IPVS SH scheduler</span><br><span class="hljs-comment">#</span><br>CONFIG_IP_VS_SH_TAB_BITS=8<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IPVS MH scheduler</span><br><span class="hljs-comment">#</span><br>CONFIG_IP_VS_MH_TAB_INDEX=12<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IPVS application helper</span><br><span class="hljs-comment">#</span><br>CONFIG_IP_VS_FTP=m<br>CONFIG_IP_VS_NFCT=y<br>CONFIG_IP_VS_PE_SIP=m<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IP: Netfilter Configuration</span><br><span class="hljs-comment">#</span><br>CONFIG_NF_DEFRAG_IPV4=m<br>CONFIG_NF_SOCKET_IPV4=m<br><br>[root@centos7 ~]<span class="hljs-comment"># grep -i -C 10 ipvs /boot/config-3.10.0-693.el7.x86_64 </span><br>CONFIG_NETFILTER_XT_MATCH_CPU=m<br>CONFIG_NETFILTER_XT_MATCH_DCCP=m<br>CONFIG_NETFILTER_XT_MATCH_DEVGROUP=m<br>CONFIG_NETFILTER_XT_MATCH_DSCP=m<br>CONFIG_NETFILTER_XT_MATCH_ECN=m<br>CONFIG_NETFILTER_XT_MATCH_ESP=m<br>CONFIG_NETFILTER_XT_MATCH_HASHLIMIT=m<br>CONFIG_NETFILTER_XT_MATCH_HELPER=m<br>CONFIG_NETFILTER_XT_MATCH_HL=m<br>CONFIG_NETFILTER_XT_MATCH_IPRANGE=m<br>CONFIG_NETFILTER_XT_MATCH_IPVS=m<br>CONFIG_NETFILTER_XT_MATCH_LENGTH=m<br>CONFIG_NETFILTER_XT_MATCH_LIMIT=m<br>CONFIG_NETFILTER_XT_MATCH_MAC=m<br>CONFIG_NETFILTER_XT_MATCH_MARK=m<br>CONFIG_NETFILTER_XT_MATCH_MULTIPORT=m<br>CONFIG_NETFILTER_XT_MATCH_NFACCT=m<br>CONFIG_NETFILTER_XT_MATCH_OSF=m<br>CONFIG_NETFILTER_XT_MATCH_OWNER=m<br>CONFIG_NETFILTER_XT_MATCH_POLICY=m<br>CONFIG_NETFILTER_XT_MATCH_PHYSDEV=m<br>--<br>CONFIG_IP_SET_HASH_NET=m<br>CONFIG_IP_SET_HASH_NETPORT=m<br>CONFIG_IP_SET_HASH_NETIFACE=m<br>CONFIG_IP_SET_LIST_SET=m<br>CONFIG_IP_VS=m<br>CONFIG_IP_VS_IPV6=y<br><span class="hljs-comment"># CONFIG_IP_VS_DEBUG is not set</span><br>CONFIG_IP_VS_TAB_BITS=12<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IPVS transport protocol load balancing support</span><br><span class="hljs-comment">#</span><br>CONFIG_IP_VS_PROTO_TCP=y<br>CONFIG_IP_VS_PROTO_UDP=y<br>CONFIG_IP_VS_PROTO_AH_ESP=y<br>CONFIG_IP_VS_PROTO_ESP=y<br>CONFIG_IP_VS_PROTO_AH=y<br>CONFIG_IP_VS_PROTO_SCTP=y<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IPVS scheduler</span><br><span class="hljs-comment">#</span><br>CONFIG_IP_VS_RR=m<br>CONFIG_IP_VS_WRR=m<br>CONFIG_IP_VS_LC=m<br>CONFIG_IP_VS_WLC=m<br>CONFIG_IP_VS_LBLC=m<br>CONFIG_IP_VS_LBLCR=m<br>CONFIG_IP_VS_DH=m<br>CONFIG_IP_VS_SH=m<br>CONFIG_IP_VS_SED=m<br>CONFIG_IP_VS_NQ=m<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IPVS SH scheduler</span><br><span class="hljs-comment">#</span><br>CONFIG_IP_VS_SH_TAB_BITS=8<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IPVS application helper</span><br><span class="hljs-comment">#</span><br>CONFIG_IP_VS_FTP=m<br>CONFIG_IP_VS_NFCT=y<br>CONFIG_IP_VS_PE_SIP=m<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># IP: Netfilter Configuration</span><br><span class="hljs-comment">#</span><br>CONFIG_NF_DEFRAG_IPV4=m<br>CONFIG_NF_CONNTRACK_IPV4=m<br></code></pre></td></tr></table></figure>

<h2 id="2-3-LVS集群体系架构"><a href="#2-3-LVS集群体系架构" class="headerlink" title="2.3 LVS集群体系架构"></a>2.3 LVS集群体系架构</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs2.png" srcset="/blog/img/loading.gif"></p>
<h2 id="2-4-LVS-功能及组织架构"><a href="#2-4-LVS-功能及组织架构" class="headerlink" title="2.4 LVS 功能及组织架构"></a>2.4 LVS 功能及组织架构</h2><p>负载均衡的应用场景为高访问量的业务，提高应用程序的可用性和可靠性。</p>
<h3 id="2-4-1-应用于高访问量的业务"><a href="#2-4-1-应用于高访问量的业务" class="headerlink" title="2.4.1 应用于高访问量的业务"></a>2.4.1 应用于高访问量的业务</h3><p>如果您的应用访问量很高，可以通过配置监听规则将流量分发到不同的云服务器 ECS（Elastic Compute Service 弹性计算服务）实例上。此外，可以使用会话保持功能将同一客户端的请求转发到同一台后端ECS</p>
<h3 id="2-4-2-扩展应用程序"><a href="#2-4-2-扩展应用程序" class="headerlink" title="2.4.2 扩展应用程序"></a>2.4.2 扩展应用程序</h3><p>可以根据业务发展的需要，随时添加和移除ECS实例来扩展应用系统的服务能力，适用于各种Web服务器和App服务器。</p>
<h3 id="2-4-3-消除单点故障"><a href="#2-4-3-消除单点故障" class="headerlink" title="2.4.3 消除单点故障"></a>2.4.3 消除单点故障</h3><p>可以在负载均衡实例下添加多台ECS实例。当其中一部分ECS实例发生故障后，负载均衡会自动屏蔽故障的ECS实例，将请求分发给正常运行的ECS实例，保证应用系统仍能正常工作</p>
<h3 id="2-4-4-同城容灾-（多可用区容灾）"><a href="#2-4-4-同城容灾-（多可用区容灾）" class="headerlink" title="2.4.4 同城容灾 （多可用区容灾）"></a>2.4.4 同城容灾 （多可用区容灾）</h3><p>为了提供更加稳定可靠的负载均衡服务，阿里云负载均衡已在各地域部署了多可用区以实现同地域容灾。当主可用区出现机房故障或不可用时，负载均衡仍然有能力在非常短的时间内（如：大约30s中断）切换到另外一个备可用区恢复服务能力；当主可用区恢复时，负载均衡同样会自动切换到主可用区提供服务。</p>
<p>使用负载均衡时，您可以将负载均衡实例部署在支持多可用区的地域以实现同城容灾。此外，建议您结合自身的应用需要，综合考虑后端服务器的部署。如果您的每个可用区均至少添加了一台ECS实例，那么此种部署模式下的负载均衡服务的效率是最高的。</p>
<p>如下图所示，在负载均衡实例下绑定不同可用区的ECS实例。正常情况下，用户访问流量将同时转至发主、备可用区内的ECS实例；当可用区A发生故障时，用户访问流量将只转发至备可用区内的ECS实例。此种部署既可以避免因为单个可用区的故障而导致对外服务的不可用，也可以通过不同产品间可用区的选择来降低延迟。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs3.png" srcset="/blog/img/loading.gif"></p>
<p>如果采取如下图所示的部署方案，即在负载均衡实例的主可用区下绑定多台ECS实例，而在备可用区没有任何ECS实例。当主可用区发生故障时会造成业务中断，因为备可用区没有ECS实例来接收请求。这样的部署方式很明显是以牺牲高可用性为代价来获取低延时。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs4.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-4-5-跨地域容灾"><a href="#2-4-5-跨地域容灾" class="headerlink" title="2.4.5 跨地域容灾"></a>2.4.5 跨地域容灾</h3><p>您可以在不同地域下部署负载均衡实例，并分别挂载相应地域内不同可用区的ECS。上层利用云解析做智能DNS，将域名解析到不同地域的负载均衡实例服务地址下，可实现全局负载均衡。当某个地域出现不可用时，暂停对应解析即可实现所有用户访问不受影响。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs5.png" srcset="/blog/img/loading.gif"></p>
<h2 id="2-5-LVS应用场景"><a href="#2-5-LVS应用场景" class="headerlink" title="2.5 LVS应用场景"></a>2.5 LVS应用场景</h2><h3 id="2-5-1-音视频大流量场景"><a href="#2-5-1-音视频大流量场景" class="headerlink" title="2.5.1 音视频大流量场景"></a>2.5.1 音视频大流量场景</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs6.png" srcset="/blog/img/loading.gif"></p>
<p>对象存储(Object Storage Service,简称OSS),是阿里云对外提供的海量、安全和高可靠的云存储服务</p>
<p><strong>音视频海量流量自动分发</strong></p>
<p>音视频应用中由于用户与主播之间需要实时大量的互动，因此，用户的流量非常大，而直播业务的波峰波谷效应明显，这对整个系统的弹性、稳定性和可用性带来了巨大的挑战</p>
<p><strong>提高横向扩展能力</strong><br>添加或删减负载均衡后端的服务器实时生效，可根据业务流量大小实时增减</p>
<p><strong>抵御海量流量</strong><br>业务发展快，访问流量巨大，负载均衡可对多台云服务器进行流量分发服务</p>
<p><strong>提升应用可用性</strong><br>负载均衡提供后端服务器的健康检查，实时屏蔽异常服务器，提升系统可用性</p>
<h3 id="2-5-2-网络游戏动静分离场景"><a href="#2-5-2-网络游戏动静分离场景" class="headerlink" title="2.5.2 网络游戏动静分离场景"></a>2.5.2 网络游戏动静分离场景</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs7.png" srcset="/blog/img/loading.gif"></p>
<p><strong>动静请求分离，快速稳定交付</strong></p>
<p>游戏业务有很多图片等静态资源需要加载，通过CDN实现全球用户访问静态资源的加速；当用户在游戏中有互动时，产生的访问流量非常大，此时为了保证互动实时性，需要使用负载均衡进行流量分发</p>
<p><strong>动态请求流量分发</strong></p>
<p>动态请求量大，采用多台云服务器计算处理，并利用负载均衡服务随时进行流量分发</p>
<p><strong>静态请求快速加载</strong></p>
<p>静态内容选择对象存储，接入CDN服务，进一步优化内容分发链路，让内容即刻加载</p>
<h3 id="2-5-3-多层次容灾架构场景"><a href="#2-5-3-多层次容灾架构场景" class="headerlink" title="2.5.3 多层次容灾架构场景"></a>2.5.3 多层次容灾架构场景</h3><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs8.png" srcset="/blog/img/loading.gif" style="zoom:150%;" />

<p><strong>跨地域跨可用区的容灾方案</strong></p>
<p>用户业务遍布各地域，使用云解析DNS将不同地域用户智能解析访问到相应的业务系统内，使用负载均衡进行海量的访问流量分发，还可构建地域级、可用区级的多层容灾架构</p>
<p><strong>智能解析</strong></p>
<p>智能判断提供最佳的访问解析地址，使访问用户获得最快捷、最流畅的体验</p>
<p><strong>流量分发</strong></p>
<p>业务发展快，访问流量巨大，负载均衡可对多台云服务器进行流量分发服务</p>
<p><strong>多层次容灾</strong></p>
<p>云解析提供跨地域的高可用，负载均衡可实现可用区级的高可用</p>
<h3 id="2-5-4-海量访问流量分发场景"><a href="#2-5-4-海量访问流量分发场景" class="headerlink" title="2.5.4 海量访问流量分发场景"></a>2.5.4 海量访问流量分发场景</h3><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs9.png" srcset="/blog/img/loading.gif" style="zoom:150%;" />

<h2 id="2-6-LVS集群类型中的术语"><a href="#2-6-LVS集群类型中的术语" class="headerlink" title="2.6 LVS集群类型中的术语"></a>2.6 LVS集群类型中的术语</h2><p>VS：Virtual Server，Director Server(DS), Dispatcher(调度器)，Load Balancer</p>
<p>RS：Real Server(lvs), upstream server(nginx), backend server(haproxy)</p>
<p>CIP：Client IP</p>
<p>VIP：Virtual serve IP VS外网的IP</p>
<p>DIP：Director IP VS内网的IP</p>
<p>RIP：Real server IP</p>
<p>访问流程：CIP &lt;–&gt; VIP == DIP &lt;–&gt; RIP</p>
<h1 id="三、-LVS-工作模式和相关命令"><a href="#三、-LVS-工作模式和相关命令" class="headerlink" title="三、 LVS 工作模式和相关命令"></a>三、 LVS 工作模式和相关命令</h1><h2 id="3-1-LVS集群的工作模式"><a href="#3-1-LVS集群的工作模式" class="headerlink" title="3.1 LVS集群的工作模式"></a>3.1 LVS集群的工作模式</h2><p>lvs-nat：修改请求报文的目标IP,多目标IP的DNAT</p>
<p>lvs-dr：操纵封装新的MAC地址</p>
<p>lvs-tun：在原请求IP报文之外新加一个IP首部</p>
<p>lvs-fullnat：修改请求报文的源和目标IP</p>
<h3 id="3-1-1-LVS的NAT模式"><a href="#3-1-1-LVS的NAT模式" class="headerlink" title="3.1.1 LVS的NAT模式"></a>3.1.1 LVS的NAT模式</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs10.png" srcset="/blog/img/loading.gif"></p>
<p>用户通过互联网或者局域网访问，首先通过VIP，VIP使用调度算法，通过交换机转发给其他服务器</p>
<p>lvs-nat：本质是多目标IP的DNAT，通过将请求报文中的目标地址和目标端口修改为某挑出的RS的RIP和PORT实现转发</p>
<p>（1）RIP和DIP应在同一个IP网络，且应使用私网地址；RS的网关要指向DIP</p>
<p>（2）请求报文和响应报文都必须经由Director转发，Director易于成为系统瓶颈</p>
<p>（3）支持端口映射，可修改请求报文的目标PORT</p>
<p>（4）VS必须是Linux系统，RS可以是任意OS系统</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs11.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs12.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-1-2-LVS的DR模式"><a href="#1-1-2-LVS的DR模式" class="headerlink" title="1.1.2 LVS的DR模式"></a>1.1.2 LVS的DR模式</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs13.png" srcset="/blog/img/loading.gif"></p>
<p>用户从互联网或局域网访问，首先通过VIP，VIP将用户请求发给LVS服务器，LVS服务器再将请求转发给其他后端服务器。在后端服务器在处理完请求后的结果直接发给互联网或者在局域网里的用户，而不是由原路将结果返回到用户里。</p>
<p>后端服务器将结果通过互联网或者局域网直接返回到用户里的原理：后端服务器也同样要有VIP，因为用户一开始只是访问VIP，而后端服务器没有VIP且将结果直接返回用户的话，用户是接收不到的。</p>
<p>LVS-DR：Direct Routing，直接路由，LVS默认模式,应用最广泛,通过为请求报文重新封装一个MAC首部进行转发，源MAC是DIP所在的接口的MAC，目标MAC是某挑选出的RS的RIP所在接口的MAC地址；源IP/PORT，以及目标IP/PORT均保持不变</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs14.png" srcset="/blog/img/loading.gif"></p>
<p>DR模式的特点：</p>
<ol>
<li><p>Director和各RS都配置有VIP</p>
</li>
<li><p>确保前端路由器将目标IP为VIP的请求报文发往Director</p>
</li>
</ol>
<ul>
<li>在前端网关做静态绑定VIP和Director的MAC地址</li>
<li>在RS上使用arptables工具</li>
</ul>
  <figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata">arptables -A <span class="hljs-keyword">IN</span> -<span class="hljs-keyword">d</span> <span class="hljs-variable">$VIP</span> -j <span class="hljs-keyword">DROP</span><br>arptables -A <span class="hljs-keyword">OUT</span> -s <span class="hljs-variable">$VIP</span> -j mangle --mangle-ip-s <span class="hljs-variable">$RIP</span><br></code></pre></td></tr></table></figure>

<ul>
<li>在RS上修改内核参数以限制arp通告及应答级别</li>
</ul>
  <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/net/i</span>pv4<span class="hljs-regexp">/conf/</span>all/arp_ignore<br><span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/net/i</span>pv4<span class="hljs-regexp">/conf/</span>all/arp_announce<br></code></pre></td></tr></table></figure>

<ol start="3">
<li><p> RS的RIP可以使用私网地址，也可以是公网地址；RIP与DIP在同一IP网络；RIP的网关不能指向DIP，以确保响应报文不会经由Director</p>
</li>
<li><p> RS和Director要在同一个物理网络</p>
</li>
<li><p> 请求报文要经由Director，但响应报文不经由Director，而由RS直接发往Client</p>
</li>
<li><p> 不支持端口映射（端口不能修改）</p>
</li>
<li><p> 无需开启 ip_forward</p>
</li>
<li><p> RS可使用大多数OS系统</p>
</li>
</ol>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs15.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-1-3-LVS的TUN模式"><a href="#3-1-3-LVS的TUN模式" class="headerlink" title="3.1.3 LVS的TUN模式"></a>3.1.3 LVS的TUN模式</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs16.png" srcset="/blog/img/loading.gif"></p>
<p>转发方式：不修改请求报文的IP首部（源IP为CIP，目标IP为VIP），而在原IP报文之外再封装一个IP首部（源IP是DIP，目标IP是RIP），将报文发往挑选出的目标RS；RS直接响应给客户端（源IP是VIP，目标IP是CIP）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs17.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs18.png" srcset="/blog/img/loading.gif"></p>
<p>TUN模式特点：</p>
<ol>
<li>RIP和DIP可以不处于同一物理网络中，RS的网关一般不能指向DIP,且RIP可以和公网通信。也就是说集群节点可以跨互联网实现。DIP, VIP, RIP可以是公网地址</li>
<li>RealServer的tun接口上需要配置VIP地址，以便接收director转发过来的数据包，以及作为响应的报文源IP</li>
<li>Director转发给RealServer时需要借助隧道，隧道外层的IP头部的源IP是DIP，目标IP是RIP，而RealServer响应给客户端的IP头部是根据隧道内层的IP头分析得到的，源IP是VIP，目标IP是CIP</li>
<li>请求报文要经由Director，但响应不经由Director,响应由RealServer自己完成</li>
<li>不支持端口映射</li>
<li>RS的OS须支持隧道功能</li>
</ol>
<p>应用场景:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">一般来说，TUN模式常会用来负载调度缓存服务器组，这些缓存服务器一般放置在不同的网络环境，可以就近折返给客户端。在请求对象不在Cache服务器本地命中的情况下，Cache服务器要向源服务器发送请求，将结果取回，最后将结果返回给用户。<br><br>LAN环境一般多采用DR模式，WAN环境虽然可以用TUN模式，但是一般在WAN环境下，请求转发更多的被haproxy<span class="hljs-regexp">/nginx/</span>DNS等实现。因此，TUN模式实际应用的很少,跨机房的应用一般专线光纤连接或DNS调度<br></code></pre></td></tr></table></figure>

<h3 id="3-1-4-LVS的FULLNAT模式"><a href="#3-1-4-LVS的FULLNAT模式" class="headerlink" title="3.1.4 LVS的FULLNAT模式"></a>3.1.4 LVS的FULLNAT模式</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs19.png" srcset="/blog/img/loading.gif"></p>
<p>通过同时修改请求报文的源IP地址和目标IP地址进行转发</p>
<p>CIP –&gt; DIP</p>
<p>VIP –&gt; RIP</p>
<p>fullnat模式特点：</p>
<ol>
<li>VIP是公网地址，RIP和DIP是私网地址，且通常不在同一IP网络；因此，RIP的网关一般不会指向<br>DIP</li>
<li>RS收到的请求报文源地址是DIP，因此，只需响应给DIP；但Director还要将其发往Client</li>
<li>请求和响应报文都经由Director</li>
<li>相对NAT模式，可以更好的实现LVS-RealServer间跨VLAN通讯</li>
<li>支持端口映射</li>
</ol>
<p>注意：此类型kernel默认不支持</p>
<h3 id="3-1-5-LVS工作模式总结和比较"><a href="#3-1-5-LVS工作模式总结和比较" class="headerlink" title="3.1.5 LVS工作模式总结和比较"></a>3.1.5 LVS工作模式总结和比较</h3><table>
<thead>
<tr>
<th></th>
<th>NAT</th>
<th>TUN</th>
<th>DR</th>
</tr>
</thead>
<tbody><tr>
<td>Real Server</td>
<td>any</td>
<td>Tunneling</td>
<td>Non-arp device</td>
</tr>
<tr>
<td>Real server network</td>
<td>private</td>
<td>LAN/WAN</td>
<td>LAN</td>
</tr>
<tr>
<td>Real server number</td>
<td>low (10~20)</td>
<td>High (100)</td>
<td>High (100)</td>
</tr>
<tr>
<td>Real server gateway</td>
<td>load balancer</td>
<td>own router</td>
<td>own router</td>
</tr>
<tr>
<td>优点</td>
<td>端口转换</td>
<td>WAN</td>
<td>性能最好</td>
</tr>
<tr>
<td>缺点</td>
<td>性能瓶颈</td>
<td>支持隧道</td>
<td>不支持跨网段</td>
</tr>
</tbody></table>
<p>lvs-nat与lvs-fullnat：</p>
<ul>
<li><p>请求和响应报文都经由Director</p>
</li>
<li><p>lvs-nat：RIP的网关要指向DIP</p>
</li>
<li><p>lvs-fullnat：RIP和DIP未必在同一IP网络，但要能通信</p>
</li>
</ul>
<p>lvs-dr与lvs-tun：</p>
<ul>
<li><p> 请求报文要经由Director，但响应报文由RS直接发往Client</p>
</li>
<li><p> lvs-dr：通过封装新的MAC首部实现，通过MAC网络转发</p>
</li>
<li><p> lvs-tun：通过在原IP报文外封装新IP头实现转发，支持远距离通信</p>
</li>
</ul>
<h2 id="3-2-LVS-调试算法"><a href="#3-2-LVS-调试算法" class="headerlink" title="3.2 LVS 调试算法"></a>3.2 LVS 调试算法</h2><p>ipvs scheduler：根据其调度时是否考虑各RS当前的负载状态</p>
<p>分为两种：静态方法和动态方法</p>
<h3 id="3-2-1-静态方法"><a href="#3-2-1-静态方法" class="headerlink" title="3.2.1 静态方法"></a>3.2.1 静态方法</h3><p>仅根据算法本身进行调度</p>
<p>1、RR：roundrobin，轮询,较常用</p>
<p>2、WRR：Weighted RR，加权轮询,较常用</p>
<p>3、SH：Source Hashing，实现session sticky，源IP地址hash；将来自于同一个IP地址的请求始终发往第一次挑中的RS，从而实现会话绑定</p>
<p>4、DH：Destination Hashing；目标地址哈希，第一次轮询调度至RS，后续将发往同一个目标地址的请求始终转发至第一次挑中的RS，典型使用场景是正向代理缓存场景中的负载均衡,如: Web缓存</p>
<h3 id="3-2-2-动态方法"><a href="#3-2-2-动态方法" class="headerlink" title="3.2.2 动态方法"></a>3.2.2 动态方法</h3><p>主要根据每RS当前的负载状态及调度算法进行调度Overhead=value 较小的RS将被调度</p>
<p>1、LC：least connections 适用于长连接应用</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">Overhead=activeconns*256+inactiveconns<br></code></pre></td></tr></table></figure>

<p>2、WLC：Weighted LC，默认调度方法,较常用</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">Overhead=(activeconns*256+inactiveconns)/weight<br></code></pre></td></tr></table></figure>

<p>3、SED：Shortest Expection Delay，初始连接高权重优先,只检查活动连接,而不考虑非活动连接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">Overhead=(activeconns+1)*256/weight<br></code></pre></td></tr></table></figure>

<p>4、NQ：Never Queue，第一轮均匀分配，后续SED</p>
<p>5、LBLC：Locality-Based LC，动态的DH算法，使用场景：根据负载状态实现正向代理,实现Web Cache等</p>
<p>6、LBLCR：LBLC with Replication，带复制功能的LBLC，解决LBLC负载不均衡问题，从负载重的复制到负载轻的RS,实现Web Cache等</p>
<h3 id="3-2-3-内核版本-4-15-版本后新增调度算法：FO和OVF"><a href="#3-2-3-内核版本-4-15-版本后新增调度算法：FO和OVF" class="headerlink" title="3.2.3 内核版本 4.15 版本后新增调度算法：FO和OVF"></a>3.2.3 内核版本 4.15 版本后新增调度算法：FO和OVF</h3><p>FO（Weighted Fail Over）调度算法,在此FO算法中，遍历虚拟服务所关联的真实服务器链表，找到还未过载（未设置IP_VS_DEST_F_OVERLOAD标志）的且权重最高的真实服务器，进行调度.</p>
<p>OVF（Overflow-connection）调度算法，基于真实服务器的活动连接数量和权重值实现。将新连接调度到权重值最高的真实服务器，直到其活动连接数量超过权重值，之后调度到下一个权重值最高的真实服务器,在此OVF算法中，遍历虚拟服务相关联的真实服务器链表，找到权重值最高的可用真实服务器。一个可用的真实服务器需要同时满足以下条件：</p>
<ul>
<li>未过载（未设置IP_VS_DEST_F_OVERLOAD标志）</li>
<li>真实服务器当前的活动连接数量小于其权重值</li>
<li>其权重值不为零</li>
</ul>
<h2 id="3-3-LVS-相关软件"><a href="#3-3-LVS-相关软件" class="headerlink" title="3.3 LVS 相关软件"></a>3.3 LVS 相关软件</h2><h3 id="3-3-1-安装ipvsadm"><a href="#3-3-1-安装ipvsadm" class="headerlink" title="3.3.1 安装ipvsadm"></a>3.3.1 安装ipvsadm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ubuntu</span><br>apt install -y ipvsadm<br><br><span class="hljs-comment">#centos</span><br>yum install -y ipvsadm<br></code></pre></td></tr></table></figure>

<h3 id="3-3-2-程序包：ipvsadm"><a href="#3-3-2-程序包：ipvsadm" class="headerlink" title="3.3.2 程序包：ipvsadm"></a>3.3.2 程序包：ipvsadm</h3><p>Unit File: ipvsadm.service</p>
<ul>
<li>主程序：/usr/sbin/ipvsadm</li>
<li>规则保存工具：/usr/sbin/ipvsadm-save</li>
<li>规则重载工具：/usr/sbin/ipvsadm-restore</li>
<li>配置文件：/etc/sysconfig/ipvsadm-config</li>
<li>ipvs调度规则文件：/etc/sysconfig/ipvsadm</li>
</ul>
<h3 id="3-3-3-ipvsadm-命令"><a href="#3-3-3-ipvsadm-命令" class="headerlink" title="3.3.3 ipvsadm 命令"></a>3.3.3 ipvsadm 命令</h3><p>ipvsadm核心功能：</p>
<ul>
<li>集群服务管理：增、删、改</li>
<li>集群服务的RS管理：增、删、改</li>
<li>查看</li>
</ul>
<p>ipvsadm 工具用法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#管理集群服务</span><br>ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]] [-M netmask][--pe persistence_engine] [-b sched-flags]<br>ipvsadm -D -t|u|f service-address <span class="hljs-comment">#删除</span><br>ipvsadm –C <span class="hljs-comment">#清空</span><br>ipvsadm –R <span class="hljs-comment">#重载,相当于ipvsadm-restore</span><br>ipvsadm -S [-n] <span class="hljs-comment">#保存,相当于ipvsadm-save</span><br><br><span class="hljs-comment">#管理集群中的RS</span><br>ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight] <br>ipvsadm -d -t|u|f service-address -r server-address<br>ipvsadm -L|l [options]<br>ipvsadm -Z [-t|u|f service-address]<br></code></pre></td></tr></table></figure>

<p><strong>管理集群服务：增、改、删</strong><br><strong>增、修改：</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]<br></code></pre></td></tr></table></figure>

<p>说明</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">service-address：<br><br>-t|u|f：<br>    -t: TCP协议的端口，VIP:TCP_PORT 如: -t 10.0.0.100:80<br>    -u: UDP协议的端口，VIP:UDP_PORT<br>    -f：firewall MARK，标记，一个数字   <br>[-s scheduler]：指定集群的调度算法，默认为wlc<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ipvsadm -A -t 10.0.0.100:80 -s wrr<br></code></pre></td></tr></table></figure>

<p>删除：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ipvsadm -D -t|u|f service-address<br></code></pre></td></tr></table></figure>

<p><strong>管理集群上的RS：增、改、删</strong><br>增、改：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight]   <br></code></pre></td></tr></table></figure>

<p>删：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ipvsadm -d -t|u|f service-address -r server-address<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">server-address：<br>  rip[:port] 如省略port，不作端口映射<br>选项：<br>lvs类型：<br>  -g: gateway, dr类型，默认<br>  -i: ipip, tun类型<br>  -m: masquerade, nat类型    <br>-w weight：权重<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.8:8080 -m -w 3<br></code></pre></td></tr></table></figure>

<p>清空定义的所有内容：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ipvsadm -C<br></code></pre></td></tr></table></figure>

<p>清空计数器：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ipvsadm -Z [-t|u|f service-address]<br></code></pre></td></tr></table></figure>

<p>查看：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ipvsadm -L|l [options]<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">--numeric, -n：以数字形式输出地址和端口号<br>--exact：扩展信息，精确值  <br>--connection，-c：当前IPVS连接输出<br>--stats：统计信息<br>--rate ：输出速率信息<br></code></pre></td></tr></table></figure>

<p>ipvs规则：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">/proc/net/ip_vs<br></code></pre></td></tr></table></figure>

<p>ipvs连接：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">/proc/net/ip_vs_conn<br></code></pre></td></tr></table></figure>

<p>保存：建议保存至/etc/sysconfig/ipvsadm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ipvsadm-save &gt; /PATH/TO/IPVSADM_FILE<br>ipvsadm -S &gt; /PATH/TO/IPVSADM_FILE<br>systemctl stop ipvsadm.service  <span class="hljs-comment">#会自动保存规则至/etc/sysconfig/ipvsadm</span><br></code></pre></td></tr></table></figure>

<p>重载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ipvsadm-restore &lt; /PATH/FROM/IPVSADM_FILE<br>systemctl  start ipvsadm.service  <span class="hljs-comment">#会自动加载/etc/sysconfig/ipvsadm中规则</span><br></code></pre></td></tr></table></figure>

<h2 id="3-4-防火墙标记"><a href="#3-4-防火墙标记" class="headerlink" title="3.4 防火墙标记"></a>3.4 防火墙标记</h2><p>FWM：FireWall Mark</p>
<p>MARK target 可用于给特定的报文打标记</p>
<p>–set-mark value</p>
<p>其中：value 可为0xffff格式，表示十六进制数字</p>
<p>借助于防火墙标记来分类报文，而后基于标记定义集群服务；可将多个不同的应用使用同一个集群服务进行调度。</p>
<p>例子：在一个小组里有4个人（A,B务器），两男生（A服务器里的80和443端口），两女生（B服务器里的80和443端口）。被叫去干活的时候都是两男生或者两女生（每次访问都是A或者B服务器里的80和443端口）。现在提倡男女搭配的干活（要同时使用A和B服务器分担压力）。下次干活的时候一男一女为一组的干活（每次同时访问80和443段口时一个请求转发到分去A服务器，另一个请求转发到B服务器）。</p>
<p>实现方法：</p>
<p>在Director主机打标记：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables -t mangle -A PREROUTING -d <span class="hljs-variable">$vip</span> -p <span class="hljs-variable">$proto</span> -m multiport --dports <span class="hljs-variable">$port1</span>,<span class="hljs-variable">$port2</span>,... -j MARK --set-mark NUMBER<br></code></pre></td></tr></table></figure>

<p>在Director主机基于标记定义集群服务：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ipvsadm -A -f NUMBER [options]<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lvs ~]<span class="hljs-comment">#iptables -t mangle -A PREROUTING -d 172.16.0.100 -p tcp -m multiport --dports 80,443 -j MARK --set-mark 10 #设定的标记为10</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -C</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -A -f 10 -s rr #使用10这个标记添加集群，使用rr算法</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -a -f 10 -r 10.0.0.7 -g </span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -a -f 10 -r 10.0.0.17 -g</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port      Forward Weight ActiveConn InActConn<br> FWM  10 rr<br> -&gt; 10.0.0.7:0          Route  1    0      0    <br> -&gt; 10.0.0.17:0         Route  1    0      0    <br>[root@lvs ~]<span class="hljs-comment">#cat /proc/net/ip_vs</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn<br>FWM 0000000A rr<br> -&gt; 0A000011:0000   Route  1    0      9    <br> -&gt; 0A000007:0000   Route  1    0      9<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lvs ~]<span class="hljs-comment">#ipvsadm -A -f 10 #默认使用wlc算法</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -a -f 10 -r 10.0.0.7 -g</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -a -f 10 -r 10.0.0.17 -g</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port      Forward Weight ActiveConn InActConn<br>FWM  10 wlc<br> -&gt; 10.0.0.7:0        Route  1    0      0    <br> -&gt; 10.0.0.17:0       Route  1    0      0<br>[root@LVS ~]<span class="hljs-comment">#cat /proc/net/ip_vs</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn<br>TCP AC14C8C8:0050 rr <br> -&gt; 0A000011:0050   Masq   1    0      0    <br> -&gt; 0A000007:0050   Masq   1    0      0<br></code></pre></td></tr></table></figure>

<h2 id="3-5-LVS-持久连接"><a href="#3-5-LVS-持久连接" class="headerlink" title="3.5 LVS 持久连接"></a>3.5 LVS 持久连接</h2><p>session 绑定：对共享同一组RS的多个集群服务，需要统一进行绑定，lvs sh算法无法实现持久连接（ lvs persistence ）模板：实现无论使用任何调度算法，在一段时间内（默认360s ），能够实现将来自同一个地址的请求始终发往同一个RS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]<br></code></pre></td></tr></table></figure>

<p>持久连接实现方式：</p>
<ul>
<li>每端口持久（PPC）：每个端口定义为一个集群服务，每集群服务单独调度</li>
<li>每防火墙标记持久（PFWMC）：基于防火墙标记定义集群服务；可实现将多个端口上的应用统一调度，即所谓的port Affinity</li>
<li>每客户端持久（PCC）：基于0端口（表示所有服务）定义集群服务，即将客户端对所有应用的请求都调度至后端主机，必须定义为持久模式</li>
</ul>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lvs ~]<span class="hljs-comment">#ipvsadm -E -f 10 -p</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port      Forward Weight ActiveConn InActConn<br>FWM  10 wlc persistent 360 <span class="hljs-comment">#显示360秒</span><br>-&gt; 10.0.0.7:0        Route  1    0      15    <br> -&gt; 10.0.0.17:0       Route  1    0      7    <br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -E -f 10 -p 3600</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port      Forward Weight ActiveConn InActConn<br>FWM  10 wlc persistent 3600<br> -&gt; 10.0.0.7:0        Route  1    0      79    <br> -&gt; 10.0.0.17:0       Route  1    0      7<br>[root@lvs ~]<span class="hljs-comment">#cat /proc/net/ip_vs_conn</span><br>Pro FromIP  FPrt ToIP   TPrt DestIP  DPrt State    Expires PEName PEData<br>TCP C0A80006 C816 AC100064 01BB 0A000011 01BB FIN_WAIT     67<br>TCP C0A80006 C812 AC100064 01BB 0A000011 01BB FIN_WAIT     67<br>TCP C0A80006 9A36 AC100064 0050 0A000011 0050 FIN_WAIT     65<br>TCP C0A80006 C806 AC100064 01BB 0A000011 01BB FIN_WAIT     65<br>TCP C0A80006 9A3E AC100064 0050 0A000011 0050 FIN_WAIT     66<br>TCP C0A80006 C81A AC100064 01BB 0A000011 01BB FIN_WAIT     67<br>TCP C0A80006 C80A AC100064 01BB 0A000011 01BB FIN_WAIT     66<br>TCP C0A80006 9A3A AC100064 0050 0A000011 0050 FIN_WAIT     66<br>TCP C0A80006 9A4E AC100064 0050 0A000011 0050 FIN_WAIT     68<br>TCP C0A80006 9A42 AC100064 0050 0A000011 0050 FIN_WAIT     67<br>TCP C0A80006 9A46 AC100064 0050 0A000011 0050 FIN_WAIT     67<br>TCP C0A80006 C81E AC100064 01BB 0A000011 01BB FIN_WAIT     68<br>IP C0A80006 0000 0000000A 0000 0A000011 0000 NONE       948<br>TCP C0A80006 C80E AC100064 01BB 0A000011 01BB FIN_WAIT     66<br>TCP C0A80006 9A4A AC100064 0050 0A000011 0050 FIN_WAIT     67<br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -Lnc</span><br>IPVS connection entries<br>pro expire state    <span class="hljs-built_in">source</span>       virtual      destination<br>TCP 00:46 FIN_WAIT   192.168.10.6:51222  172.16.0.100:443  10.0.0.17:443<br>TCP 00:46 FIN_WAIT   192.168.10.6:51218  172.16.0.100:443  10.0.0.17:443<br>TCP 00:45 FIN_WAIT   192.168.10.6:39478  172.16.0.100:80   10.0.0.17:80<br>TCP 00:45 FIN_WAIT   192.168.10.6:51206  172.16.0.100:443  10.0.0.17:443<br>TCP 00:46 FIN_WAIT   192.168.10.6:39486  172.16.0.100:80   10.0.0.17:80<br>TCP 00:47 FIN_WAIT   192.168.10.6:51226  172.16.0.100:443  10.0.0.17:443<br>TCP 00:45 FIN_WAIT   192.168.10.6:51210  172.16.0.100:443  10.0.0.17:443<br>TCP 00:45 FIN_WAIT   192.168.10.6:39482  172.16.0.100:80   10.0.0.17:80<br>TCP 00:47 FIN_WAIT   192.168.10.6:39502  172.16.0.100:80   10.0.0.17:80<br>TCP 00:46 FIN_WAIT   192.168.10.6:39490  172.16.0.100:80   10.0.0.17:80<br>TCP 00:46 FIN_WAIT   192.168.10.6:39494  172.16.0.100:80   10.0.0.17:80<br>TCP 00:47 FIN_WAIT   192.168.10.6:51230  172.16.0.100:443  10.0.0.17:443<br>IP  15:27 NONE     192.168.10.6:0    0.0.0.10:0     10.0.0.17:0<br>TCP 00:46 FIN_WAIT   192.168.10.6:51214  172.16.0.100:443  10.0.0.17:443<br>TCP 00:47 FIN_WAIT   192.168.10.6:39498  172.16.0.100:80   10.0.0.17:80<br></code></pre></td></tr></table></figure>



<h1 id="四、LVS实战案例"><a href="#四、LVS实战案例" class="headerlink" title="四、LVS实战案例"></a>四、LVS实战案例</h1><h2 id="4-1-LVS-NAT模式案例"><a href="#4-1-LVS-NAT模式案例" class="headerlink" title="4.1 LVS-NAT模式案例"></a>4.1 LVS-NAT模式案例</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs20.png" srcset="/blog/img/loading.gif"></p>
<p>环境：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dns">共四台主机<br>一台： internet client：<span class="hljs-number">192.168.10.6</span>/<span class="hljs-number">24</span>  GW:无 仅主机<br><br>一台：lvs <br>eth1 仅主机 <span class="hljs-number">192.168.10.100</span>/<span class="hljs-number">16</span><br>eth0 NAT <span class="hljs-number">10.0.0.8</span>/<span class="hljs-number">24</span><br><br>两台RS：<br>RS1: <span class="hljs-number">10.0.0.7</span>/<span class="hljs-number">24</span> GW：<span class="hljs-number">10.0.0.8</span> NAT<br>RS2: <span class="hljs-number">10.0.0.17</span>/<span class="hljs-number">24</span> GW：<span class="hljs-number">10.0.0.8</span> NAT<br></code></pre></td></tr></table></figure>

<p>配置过程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#RS配置服务</span><br>[root@rs1 ~]<span class="hljs-comment">#yum install -y httpd</span><br>[root@rs1 ~]<span class="hljs-comment">#echo &quot;10.0.0.7 RS1&quot; &gt; /var/www/html/index.html</span><br>[root@rs1 ~]<span class="hljs-comment">#systemctl start httpd</span><br>[root@rs1 ~]<span class="hljs-comment">#curl 10.0.0.7</span><br>10.0.0.7 RS1<br>[root@rs1 ~]<span class="hljs-comment"># ss -tnl</span><br>State      Recv-Q Send-Q                 Local Address:Port                                Peer Address:Port              <br>LISTEN     0      128                                *:22                                             *:*                  <br>LISTEN     0      128                               :::80                                            :::*                  <br>LISTEN     0      128                               :::22                                            :::* <br><br>[root@rs2 ~]<span class="hljs-comment">#yum install -y httpd</span><br>[root@rs2 ~]<span class="hljs-comment">#echo &quot;10.0.0.17 RS2&quot; &gt; /var/www/html/index.html</span><br>[root@rs2 ~]<span class="hljs-comment">#systemctl start httpd</span><br>[root@rs2 ~]<span class="hljs-comment">#curl 10.0.0.17</span><br>10.0.0.17 RS2<br>[root@rs2 ~]<span class="hljs-comment"># ss -tnl</span><br>State      Recv-Q Send-Q                 Local Address:Port                                Peer Address:Port              <br>LISTEN     0      128                                *:22                                             *:*                  <br>LISTEN     0      128                               :::80                                            :::*                  <br>LISTEN     0      128                               :::22                                            :::*<br><br><span class="hljs-comment">#lvs修改配置</span><br>[root@lvs-server ~]<span class="hljs-comment">#vim /etc/sysctl.conf</span><br>net.ipv4.ip_forward = 1<br>[root@lvs-server ~]<span class="hljs-comment">#sysctl -p</span><br>net.ipv4.ip_forward = 1<br><span class="hljs-comment">#lvs安装ipvsadm</span><br>[root@lvs-server ~]<span class="hljs-comment">#yum install -y ipvsadm</span><br><br><span class="hljs-comment">#修改所有主机的网络配置</span><br>[root@internet ~]<span class="hljs-comment">#cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>DEVICE=eth0<br>NAME=eth0<br>BOOTPROTO=static<br>IPADDR=192.168.10.6<br>PREFIX=24<br>ONBOOT=yes<br><br>[root@lvs network-scripts]<span class="hljs-comment">#cat ifcfg-eth0</span><br>DEVICE=eth0<br>NAME=eth0<br>BOOTPROTO=static<br>IPADDR=10.0.0.8<br>PREFIX=24<br>ONBOOT=yes<br>[root@lvs network-scripts]<span class="hljs-comment">#cat ifcfg-eth1</span><br>DEVICE=eth1<br>NAME=eth1<br>BOOTPROTO=static<br>IPADDR=192.168.10.100<br>PREFIX=24<br>ONBOOT=yes<br><br>[root@rs1 ~]<span class="hljs-comment">#cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>DEVICE=eth0<br>NAME=eth0<br>BOOTPROTO=static<br>IPADDR=10.0.0.7<br>PREFIX=24<br>GATEWAY=10.0.0.8<br>ONBOOT=yes<br><br>[root@rs2 ~]<span class="hljs-comment">#cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>DEVICE=eth0<br>NAME=eth0<br>BOOTPROTO=static<br>IPADDR=10.0.0.17<br>PREFIX=24<br>GATEWAY=10.0.0.8<br>ONBOOT=yes<br><br>[root@lvs-server ~]<span class="hljs-comment">#ipvsadm -A -t 192.168.10.100:80 -s wrr</span><br>[root@lvs-server ~]<span class="hljs-comment">#ipvsadm -a -t 192.168.10.100:80 -r 10.0.0.7:80 -m</span><br>[root@lvs-server ~]<span class="hljs-comment">#ipvsadm -a -t 192.168.10.100:80 -r 10.0.0.17:80 -m</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln #此时可以在此服务器来ping通其他的服务器的</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  192.168.10.100:80 wrr<br>  -&gt; 10.0.0.7:80                  Masq    1      0          0         <br>  -&gt; 10.0.0.17:80                 Masq    1      0          0<br> <br>[root@internet ~]<span class="hljs-comment"># while :;do curl 192.168.10.100;sleep 0.5;done</span><br>10.0.0.17 RS2<br>10.0.0.7 RS1<br>10.0.0.17 RS2<br>10.0.0.7 RS1<br>10.0.0.17 RS2<br>10.0.0.7 RS1<br>10.0.0.17 RS2<br><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln --stats</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port               Conns   InPkts  OutPkts  InBytes OutBytes<br>  -&gt; RemoteAddress:Port<br>TCP  192.168.10.100:80                   7       42       28     2786     3287<br>  -&gt; 10.0.0.7:80                         3       18       12     1194     1407<br>  -&gt; 10.0.0.17:80                        4       24       16     1592     1880<br> <br>[root@lvs ~]<span class="hljs-comment"># cat /proc/net/ip_vs</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn<br>TCP  C0A80A64:0050 wrr  <br>  -&gt; 0A000011:0050      Masq    1      0          4         <br>  -&gt; 0A000007:0050      Masq    1      0          3 <br> <br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Lnc</span><br>IPVS connection entries<br>pro expire state       <span class="hljs-built_in">source</span>             virtual            destination<br>TCP 01:15  TIME_WAIT   192.168.10.6:42172 192.168.10.100:80  10.0.0.7:80<br>TCP 01:14  TIME_WAIT   192.168.10.6:42168 192.168.10.100:80  10.0.0.7:80<br>TCP 01:14  TIME_WAIT   192.168.10.6:42170 192.168.10.100:80  10.0.0.17:80<br>TCP 01:13  TIME_WAIT   192.168.10.6:42164 192.168.10.100:80  10.0.0.7:80<br>TCP 01:15  TIME_WAIT   192.168.10.6:42174 192.168.10.100:80  10.0.0.17:80<br>TCP 01:12  TIME_WAIT   192.168.10.6:42162 192.168.10.100:80  10.0.0.17:80<br>TCP 01:13  TIME_WAIT   192.168.10.6:42166 192.168.10.100:80  10.0.0.17:80<br><br>[root@lvs ~]<span class="hljs-comment"># cat /proc/net/ip_vs_conn</span><br>Pro FromIP   FPrt ToIP     TPrt DestIP   DPrt State       Expires PEName PEData<br>TCP C0A80A06 A4BC C0A80A64 0050 0A000007 0050 TIME_WAIT        57<br>TCP C0A80A06 A4B8 C0A80A64 0050 0A000007 0050 TIME_WAIT        56<br>TCP C0A80A06 A4BA C0A80A64 0050 0A000011 0050 TIME_WAIT        57<br>TCP C0A80A06 A4B4 C0A80A64 0050 0A000007 0050 TIME_WAIT        55<br>TCP C0A80A06 A4BE C0A80A64 0050 0A000011 0050 TIME_WAIT        58<br>TCP C0A80A06 A4B2 C0A80A64 0050 0A000011 0050 TIME_WAIT        54<br>TCP C0A80A06 A4B6 C0A80A64 0050 0A000011 0050 TIME_WAIT        56<br><br><span class="hljs-comment">#保存规则</span><br>[root@lvs-server ~]<span class="hljs-comment">#ipvsadm -Sn &gt; /etc/sysconfig/ipvsadm</span><br>[root@lvs-server ~]<span class="hljs-comment">#systemctl enable --now ipvsadm.service</span><br></code></pre></td></tr></table></figure>

<p>范例2：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs21.png" srcset="/blog/img/loading.gif"></p>
<ol>
<li>Director 服务器采用双网卡，一个是桥接网卡连接外网，一个是仅主机网卡与后端Web服务器相连</li>
<li>Web服务器采用仅主机网卡与director相连</li>
<li>Web服务器网关指向10.0.0.200</li>
<li>后端web服务器不需要连接外网</li>
</ol>
<p>环境：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dns">共四台主机<br>一台： internet client ：<span class="hljs-number">172.20.200.6</span>/<span class="hljs-number">16</span>  GW:无 仅主机<br><br>一台：lvs <br>eth1 仅主机 <span class="hljs-number">172.20.200.200</span>/<span class="hljs-number">16</span><br>eth0 NAT <span class="hljs-number">10.0.0.200</span>/<span class="hljs-number">24</span><br><br>两台RS：<br>RS1: <span class="hljs-number">10.0.0.7</span>/<span class="hljs-number">24</span> GW： <span class="hljs-number">10.0.0.200</span><br>RS2: <span class="hljs-number">10.0.0.17</span>/<span class="hljs-number">24</span> GW： <span class="hljs-number">10.0.0.200</span><br></code></pre></td></tr></table></figure>

<p>配置过程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#internet_client配置：</span><br>[root@internet_client ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=172.20.200.6<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>NETMASK=255.255.0.0<br>[root@internet_client ~]<span class="hljs-comment"># systemctl restart network</span><br><br><span class="hljs-comment">#lvs配置</span><br>[root@lvs ~]<span class="hljs-comment"># yum install -y ipvsadm</span><br>[root@lvs ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>TYPE=Ethernet<br>BOOTPROTO=static<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>IPADDR=10.0.0.200<br>NETMASK=255.255.255.0<br>PREFIX=24<br><br>[root@lvs ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth1</span><br>TYPE=Ethernet<br>BOOTPROTO=static<br>NAME=eth1<br>DEVICE=eth1<br>ONBOOT=yes<br>IPADDR=172.20.200.200<br>NETMASK=255.255.0.0<br>PREFIX=24<br><br>[root@lvs ~]<span class="hljs-comment"># nmcli c reload</span><br>[root@lvs ~]<span class="hljs-comment"># nmcli c up eth0</span><br>[root@lvs ~]<span class="hljs-comment"># nmcli c up eth1</span><br><br><span class="hljs-comment">#RS1和RS2配置</span><br>[root@rs1 ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=10.0.0.7<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=10.0.0.200<br>NETMASK=255.255.255.0<br>DNS1=223.5.5.5<br>[root@rs1 ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@rs1 ~]<span class="hljs-comment"># yum install -y httpd</span><br>[root@rs1 ~]<span class="hljs-comment"># echo &quot;RS1 10.0.0.7&quot; &gt; /var/www/html/index.html</span><br>[root@rs1 ~]<span class="hljs-comment"># systemctl start httpd</span><br>[root@rs1 ~]<span class="hljs-comment"># curl 10.0.0.7</span><br>RS1 10.0.0.7<br><br>[root@rs2 ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=10.0.0.17<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>IPV6_PRIVACY=<span class="hljs-string">&quot;no&quot;</span><br>GATEWAY=10.0.0.200<br>NETMASK=255.255.255.0<br>DNS1=223.5.5.5<br>[root@rs2 ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@rs2 ~]<span class="hljs-comment"># yum install -y httpd</span><br>[root@rs2 ~]<span class="hljs-comment"># echo &quot;RS2 10.0.0.17&quot; &gt; /var/www/html/index.html</span><br>[root@rs2 ~]<span class="hljs-comment"># systemctl start httpd</span><br>[root@rs2 ~]<span class="hljs-comment"># curl 10.0.0.17</span><br>RS2 10.0.0.17<br><br><br><span class="hljs-comment">#LVS启用IP_FORWORD功能</span><br>[root@lvs ~]<span class="hljs-comment">#vim /etc/sysctl.conf</span><br>net.ipv4.ip_forward = 1<br>[root@LVS ~]<span class="hljs-comment">#sysctl -p</span><br><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -A -t 172.20.200.200:80 -s rr</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -a -t 172.20.200.200:80 -r 10.0.0.7 -m</span><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -a -t 172.20.200.200:80 -r 10.0.0.17 -m</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  172.20.200.200:80 rr<br>  -&gt; 10.0.0.7:80                  Masq    1      0          0         <br>  -&gt; 10.0.0.17:80                 Masq    1      0          0<br> <br><span class="hljs-comment">#现在可以ping通所有的服务器</span><br>[root@lvs ~]<span class="hljs-comment"># ping 10.0.0.7</span><br>PING 10.0.0.7 (10.0.0.7) 56(84) bytes of data.<br>64 bytes from 10.0.0.7: icmp_seq=1 ttl=64 time=0.195 ms<br>64 bytes from 10.0.0.7: icmp_seq=2 ttl=64 time=0.187 ms<br>^C<br>--- 10.0.0.7 ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 26ms<br>rtt min/avg/max/mdev = 0.187/0.191/0.195/0.004 ms<br>[root@lvs ~]<span class="hljs-comment"># ping 10.0.0.17</span><br>PING 10.0.0.17 (10.0.0.17) 56(84) bytes of data.<br>64 bytes from 10.0.0.17: icmp_seq=7 ttl=64 time=0.207 ms<br>64 bytes from 10.0.0.17: icmp_seq=8 ttl=64 time=0.216 ms<br>^C<br>--- 10.0.0.17 ping statistics ---<br>8 packets transmitted, 2 received, 75% packet loss, time 162ms<br>rtt min/avg/max/mdev = 0.207/0.211/0.216/0.015 ms<br>[root@lvs ~]<span class="hljs-comment"># ping 172.20.200.6</span><br>PING 172.20.200.6 (172.20.200.6) 56(84) bytes of data.<br>64 bytes from 172.20.200.6: icmp_seq=1 ttl=64 time=0.287 ms<br>64 bytes from 172.20.200.6: icmp_seq=2 ttl=64 time=0.197 ms<br>^C<br>--- 172.20.200.6 ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 58ms<br>rtt min/avg/max/mdev = 0.197/0.242/0.287/0.045 ms<br> <br><span class="hljs-comment">#测试</span><br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS2 10.0.0.17<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS1 10.0.0.7<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS2 10.0.0.17<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS1 10.0.0.7<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS2 10.0.0.17<br><br>[root@lvs ~]<span class="hljs-comment"># cat /proc/net/ip_vs_conn</span><br>Pro FromIP   FPrt ToIP     TPrt DestIP   DPrt State       Expires PEName PEData<br>TCP AC14C806 8C32 AC14C8C8 0050 0A000007 0050 TIME_WAIT        95<br>TCP AC14C806 8C30 AC14C8C8 0050 0A000011 0050 TIME_WAIT        95<br>TCP AC14C806 8C34 AC14C8C8 0050 0A000011 0050 TIME_WAIT        97<br>TCP AC14C806 8C2C AC14C8C8 0050 0A000011 0050 TIME_WAIT        92<br>TCP AC14C806 8C2E AC14C8C8 0050 0A000007 0050 TIME_WAIT        94<br><br><span class="hljs-comment">#保存规则</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Sn &gt; /etc/sysconfig/ipvsadm</span><br>[root@lvs ~]<span class="hljs-comment"># cat /etc/sysconfig/ipvsadm</span><br>-A -t 172.20.200.200:80 -s rr<br>-a -t 172.20.200.200:80 -r 10.0.0.7:80 -m -w 1<br>-a -t 172.20.200.200:80 -r 10.0.0.17:80 -m -w 1<br><br><span class="hljs-comment">#清除规则</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -C</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br> <br><span class="hljs-comment">#重新加载规则</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -R &lt; /etc/sysconfig/ipvsadm</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  172.20.200.200:80 rr<br>  -&gt; 10.0.0.7:80                  Masq    1      0          0         <br>  -&gt; 10.0.0.17:80                 Masq    1      0          0<br> <br><span class="hljs-comment">#开机加载ipvs规则</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -C</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>[root@lvs ~]<span class="hljs-comment"># systemctl enable --now ipvsadm.service</span><br>Created symlink /etc/systemd/system/multi-user.target.wants/ipvsadm.service → /usr/lib/systemd/system/ipvsadm.service.<br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  172.20.200.200:80 rr<br>  -&gt; 10.0.0.7:80                  Masq    1      0          0         <br>  -&gt; 10.0.0.17:80                 Masq    1      0          0<br> <br>[root@rs1 ~]<span class="hljs-comment"># tail /var/log/httpd/access_log</span><br>10.0.0.7 - - [28/Jul/2021:20:36:16 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 13 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>172.20.200.6 - - [28/Jul/2021:20:41:11 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 13 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>172.20.200.6 - - [28/Jul/2021:20:41:12 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 13 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br><br><span class="hljs-comment">#修改调度算法为 WRR 和后端服务器的端口</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -E -t 172.20.200.200:80 -s wrr</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -d -t 172.20.200.200:80 -r 10.0.0.7</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -a -t 172.20.200.200:80 -r 10.0.0.7:8080 -m -w 3</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  172.20.200.200:80 wrr<br>  -&gt; 10.0.0.7:8080                Masq    3      0          0         <br>  -&gt; 10.0.0.17:80                 Masq    1      0          0<br> <br>[root@rs1 ~]<span class="hljs-comment">#vim /etc/httpd/conf/httpd.conf</span><br>Listen 8080<br>[root@rs1 ~]<span class="hljs-comment">#systemctl restart httpd</span><br>[root@rs1 ~]<span class="hljs-comment"># ss -tnl</span><br>State      Recv-Q Send-Q                 Local Address:Port                                Peer Address:Port              <br>LISTEN     0      128                                *:22                                             *:*                  <br>LISTEN     0      128                               :::8080                                          :::*                  <br>LISTEN     0      128                               :::22                                            :::*<br><br><span class="hljs-comment">#权重修改和端口修改测试</span><br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS1 10.0.0.7<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS2 10.0.0.17<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS1 10.0.0.7<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS1 10.0.0.7<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS1 10.0.0.7<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS2 10.0.0.17<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS1 10.0.0.7<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS1 10.0.0.7<br>[root@internet_client ~]<span class="hljs-comment"># curl 172.20.200.200</span><br>RS1 10.0.0.7<br></code></pre></td></tr></table></figure>

<h2 id="4-2-LVS-DR模式单网段案例"><a href="#4-2-LVS-DR模式单网段案例" class="headerlink" title="4.2 LVS-DR模式单网段案例"></a>4.2 LVS-DR模式单网段案例</h2><p>DR模型中各主机上均需要配置VIP，解决地址冲突的方式有三种：</p>
<p>(1) 在前端网关做静态绑定</p>
<p>(2) 在各RS使用arptables</p>
<p>(3) 在各RS修改内核参数，来限制arp响应和通告的级别</p>
<p><strong>限制响应级别：arp_ignore</strong></p>
<ul>
<li>0：默认值，表示可使用本地任意接口上配置的任意地址进行响应</li>
<li>1：仅在请求的目标IP配置在本地主机的接收到请求报文的接口上时，才给予响应</li>
</ul>
<p><strong>限制通告级别：arp_announce</strong></p>
<ul>
<li>0：默认值，把本机所有接口的所有信息向每个接口的网络进行通告</li>
<li>1：尽量避免将接口信息向非直接连接网络进行通告</li>
<li>2：必须避免将接口信息向非本网络进行通告</li>
</ul>
<p><strong>配置要点</strong></p>
<ol>
<li>Director 服务器采用双IP桥接网络，一个是VIP，一个DIP</li>
<li>Web服务器采用和DIP相同的网段和Director连接</li>
<li>每个Web服务器配置VIP</li>
<li>每个web服务器可以出外网</li>
</ol>
<p>范例:</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs22.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">环境：五台主机<br>一台：客户端 eth0:仅主机 192.168.10.6/24 GW:192.168.10.200<br><br>一台：ROUTER<br>eth0 :NAT  10.0.0.200/24<br>eth1: 仅主机 192.168.10.200/24<br>启用 IP_FORWARD<br><br>一台：LVS<br>eth0:NAT:DIP:10.0.0.8/24 GW:10.0.0.200<br><br>两台RS：<br>RS1：eth0:NAT:10.0.0.7/24  GW：10.0.0.200<br>RS2：eth0:NAT:10.0.0.17/24 GW：10.0.0.200<br></code></pre></td></tr></table></figure>

<h3 id="4-2-1-LVS的网络配置"><a href="#4-2-1-LVS的网络配置" class="headerlink" title="4.2.1 LVS的网络配置"></a>4.2.1 LVS的网络配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#所有主机禁用iptables和SELinux</span><br><span class="hljs-comment">#internet主机环境</span><br>[root@internet ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=192.168.10.6<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=192.168.10.200<br>NETMASK=255.255.255.0<br>[root@internet ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@internet ~]<span class="hljs-comment"># hostname</span><br>internet<br>[root@internet ~]<span class="hljs-comment"># hostname -I</span><br>192.168.10.6 <br>[root@internet ~]<span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         192.168.10.200  0.0.0.0         UG    100    0        0 eth0<br>192.168.10.0    0.0.0.0         255.255.255.0   U     100    0        0 eth0<br><br>[root@internet ~]<span class="hljs-comment"># ping 10.0.0.7 -c1</span><br>PING 10.0.0.7 (10.0.0.7) 56(84) bytes of data.<br>64 bytes from 10.0.0.7: icmp_seq=1 ttl=63 time=0.624 ms<br><br>--- 10.0.0.7 ping statistics ---<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min/avg/max/mdev = 0.624/0.624/0.624/0.000 ms<br><br>[root@internet ~]<span class="hljs-comment"># ping 10.0.0.17 -c1</span><br>PING 10.0.0.17 (10.0.0.17) 56(84) bytes of data.<br>64 bytes from 10.0.0.17: icmp_seq=1 ttl=63 time=0.334 ms<br><br>--- 10.0.0.17 ping statistics ---<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min/avg/max/mdev = 0.334/0.334/0.334/0.000 ms<br><span class="hljs-comment">################################################################################################################################</span><br><br><span class="hljs-comment">#路由器的网络配置</span><br>[root@router ~]<span class="hljs-comment"># echo &#x27;net.ipv4.ip_forward=1&#x27; &gt;&gt; /etc/sysctl.conf</span><br>[root@router ~]<span class="hljs-comment"># sysctl -p</span><br>net.ipv4.ip_forward = 1<br><br>[root@router ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>TYPE=Ethernet<br>BOOTPROTO=static<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>IPADDR=10.0.0.200<br>NETMASK=255.255.255.0<br>GATEWAY=10.0.0.200<br>DNS1=114.114.114.114<br>PREFIX=24<br>[root@router ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth1</span><br>TYPE=Ethernet<br>BOOTPROTO=static<br>NAME=eth1<br>DEVICE=eth1<br>ONBOOT=yes<br>IPADDR=192.168.10.200<br>NETMASK=255.255.255.0<br>PREFIX=24<br>[root@router ~]<span class="hljs-comment">#nmcli c reload</span><br>[root@router ~]<span class="hljs-comment">#nmcli c up eth0</span><br>[root@router ~]<span class="hljs-comment">#nmcli c up eth1</span><br><br><span class="hljs-comment">################################################################################################################################</span><br><span class="hljs-comment">#RS1的网络配置</span><br>[root@rs1 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=10.0.0.7<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=10.0.0.200<br>NETMASK=255.255.255.0<br>DNS1=223.5.5.5<br>[root@rs1 ~]<span class="hljs-comment"># hostname</span><br>rs1<br>[root@rs1 ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.7 <br>[root@rs1 ~]<span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<br><br>[root@rs1 ~]<span class="hljs-comment">#yum -y install httpd</span><br>[root@rs1 ~]<span class="hljs-comment">#systemctl enable --now httpd</span><br>[root@rs1 ~]<span class="hljs-comment">#hostname -I &gt; /var/www/html/index.html</span><br>[root@rs1 ~]<span class="hljs-comment">#ping 192.168.10.6 -c1</span><br>PING 192.168.10.6 (192.168.10.6) 56(84) bytes of data.<br>64 bytes from 192.168.10.6: icmp_seq=1 ttl=63 time=0.727 ms<br><br>--- 192.168.10.6 ping statistics ---<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min/avg/max/mdev = 0.727/0.727/0.727/0.000 ms<br><br>[root@rs1 ~]<span class="hljs-comment">#curl 10.0.0.7</span><br>10.0.0.7<br><br><span class="hljs-comment">######################################################################################</span><br><span class="hljs-comment">#RS2 的网络配置</span><br>[root@rs2 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=10.0.0.17<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=10.0.0.200<br>NETMASK=255.255.255.0<br>DNS1=223.5.5.5<br>[root@rs2 ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@rs2 ~]<span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<br><br>[root@rs2 ~]<span class="hljs-comment"># yum -y install httpd</span><br>[root@rs2 ~]<span class="hljs-comment"># systemctl enable --now httpd</span><br>[root@rs2 ~]<span class="hljs-comment"># hostname -I &gt; /var/www/html/index.html</span><br>[root@rs2 ~]<span class="hljs-comment"># curl 10.0.0.17</span><br>10.0.0.17<br>[root@rs1 ~]<span class="hljs-comment"># ping 192.168.10.6 -c1</span><br>PING 192.168.10.6 (192.168.10.6) 56(84) bytes of data.<br>64 bytes from 192.168.10.6: icmp_seq=1 ttl=63 time=0.437 ms<br><br>--- 192.168.10.6 ping statistics ---<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min/avg/max/mdev = 0.437/0.437/0.437/0.000 ms<br><br>[root@rs2 ~]<span class="hljs-comment">#curl 10.0.0.17</span><br>10.0.0.17<br><br><span class="hljs-comment">######################################################################################</span><br><span class="hljs-comment">#LVS的网络配置</span><br>[root@lvs ~]<span class="hljs-comment"># hostname</span><br>lvs<br>[root@lvs ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.8<br><br>[root@lvs ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>DEVICE=eth0<br>NAME=eth0<br>BOOTPROTO=static<br>IPADDR=10.0.0.8<br>PREFIX=24<br>GATEWAY=10.0.0.200<br>ONBOOT=yes<br>[root@lvs ~]<span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<br>[root@lvs ~]<span class="hljs-comment"># ping 192.168.10.6 -c1</span><br>PING 192.168.10.6 (192.168.10.6) 56(84) bytes of data.<br>64 bytes from 192.168.10.6: icmp_seq=1 ttl=128 time=0.542 ms<br><br>--- 192.168.10.6 ping statistics ---<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min/avg/max/mdev = 0.542/0.542/0.542/0.000 ms<br></code></pre></td></tr></table></figure>

<h3 id="4-2-2-后端RS的IPVS配置"><a href="#4-2-2-后端RS的IPVS配置" class="headerlink" title="4.2.2 后端RS的IPVS配置"></a>4.2.2 后端RS的IPVS配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#RS1的IPVS配置</span><br>[root@rs1 ~]<span class="hljs-comment"># echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore </span><br>[root@rs1 ~]<span class="hljs-comment"># echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce </span><br>[root@rs1 ~]<span class="hljs-comment"># echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore </span><br>[root@rs1 ~]<span class="hljs-comment"># echo 2 &gt; /proc//sys/net/ipv4/conf/lo/arp_announce</span><br>[root@rs1 ~]<span class="hljs-comment"># ifconfig lo:1 10.0.0.100/32</span><br>[root@rs1 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet 10.0.0.100/0 scope global lo:1<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000<br>    link/ether 00:0c:29:90:f4:50 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.7/24 brd 10.0.0.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::40d2:a76f:ddbe:7372/64 scope link <br>       valid_lft forever preferred_lft forever<br>   <br><span class="hljs-comment">#RS2的IPVS配置</span><br>[root@rs2 ~]<span class="hljs-comment"># echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore </span><br>[root@rs2 ~]<span class="hljs-comment"># echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br>[root@rs2 ~]<span class="hljs-comment"># echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce </span><br>[root@rs2 ~]<span class="hljs-comment"># echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce </span><br>[root@rs2 ~]<span class="hljs-comment"># ifconfig lo:1 10.0.0.100/32</span><br>[root@rs2 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet 10.0.0.100/0 scope global lo:1<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000<br>    link/ether 00:0c:29:56:c0:a3 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.17/24 brd 10.0.0.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::e533:4d3c:7c52:5754/64 scope link <br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::40d2:a76f:ddbe:7372/64 scope link tentative dadfailed <br>       valid_lft forever preferred_lft forever<br>   <br></code></pre></td></tr></table></figure>

<h3 id="4-2-3-LVS主机的配置"><a href="#4-2-3-LVS主机的配置" class="headerlink" title="4.2.3 LVS主机的配置"></a>4.2.3 LVS主机的配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在LVS上添加VIP</span><br>[root@lvs ~]<span class="hljs-comment"># ifconfig lo:1 10.0.0.100/32</span><br>[root@lvs ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet 10.0.0.100/0 scope global lo:1<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000<br>    link/ether 00:0c:29:5d:a5:50 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.8/24 brd 10.0.0.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::bf50:b493:747b:e419/64 scope link <br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::e533:4d3c:7c52:5754/64 scope link tentative dadfailed <br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::40d2:a76f:ddbe:7372/64 scope link tentative dadfailed <br>       valid_lft forever preferred_lft forever<br>   <br><span class="hljs-comment">#实现LVS 规则</span><br>[root@lvs ~]<span class="hljs-comment"># yum -y install ipvsadm</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -A -t 10.0.0.100:80 -s rr</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.7:80 -g</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.17:80 -g</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  10.0.0.100:80 rr<br>  -&gt; 10.0.0.7:80                  Route   1      0          0         <br>  -&gt; 10.0.0.17:80                 Route   1      0          0 <br>   <br></code></pre></td></tr></table></figure>

<h3 id="4-2-4-测试访问"><a href="#4-2-4-测试访问" class="headerlink" title="4.2.4 测试访问"></a>4.2.4 测试访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@internet ~]<span class="hljs-comment">#curl 10.0.0.100</span><br>10.0.0.17<br>[root@internet ~]<span class="hljs-comment">#curl 10.0.0.100</span><br>10.0.0.7<br><br>[root@rs1 ~]<span class="hljs-comment"># tail -f /var/log/httpd/access_log</span><br>192.168.10.6 - - [29/Jul/2021:10:34:59 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>192.168.10.6 - - [29/Jul/2021:10:34:59 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>192.168.10.6 - - [29/Jul/2021:10:35:00 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>192.168.10.6 - - [29/Jul/2021:10:35:00 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>192.168.10.6 - - [29/Jul/2021:10:35:01 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br><br>[root@rs2 ~]<span class="hljs-comment"># tail -f /var/log/httpd/access_log </span><br>192.168.10.6 - - [29/Jul/2021:10:34:59 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 11 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>192.168.10.6 - - [29/Jul/2021:10:35:00 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 11 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>192.168.10.6 - - [29/Jul/2021:10:35:00 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 11 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>192.168.10.6 - - [29/Jul/2021:10:35:01 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 11 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br>192.168.10.6 - - [29/Jul/2021:10:35:01 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 11 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span><br><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs23.png" srcset="/blog/img/loading.gif"></p>
<p><strong>范例：</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs24.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dns">环境：五台主机<br>一台：客户端 <br>eeh0: 仅主机 <span class="hljs-number">172.20.200.6</span>/<span class="hljs-number">16</span> GW:<span class="hljs-number">172.20.200.200</span><br><br>一台：ROUTER<br>eth0: NAT <span class="hljs-number">10.0.0.200</span>/<span class="hljs-number">24</span> VIP<br>eth1: 仅主机 <span class="hljs-number">172.20.200.200</span>/<span class="hljs-number">16</span><br>启用 IP_FORWARD<br><br>一台：LVS<br>eth0: <span class="hljs-number">10.0.0.8</span>/<span class="hljs-number">24</span> GW:<span class="hljs-number">10.0.0.200</span><br><br>两台RS：<br>RS<span class="hljs-number">1：10.0.0</span>.<span class="hljs-number">7</span>/<span class="hljs-number">24</span> GW：<span class="hljs-number">10.0.0.200</span><br>RS<span class="hljs-number">2：10.0.0</span>.<span class="hljs-number">17</span>/<span class="hljs-number">24</span> GW：<span class="hljs-number">10.0.0.200</span><br></code></pre></td></tr></table></figure>

<p>配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#internet配置</span><br>[root@internet ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=172.20.200.6<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>NETMASK=255.255.0.0<br>GATEWAY=172.20.200.200<br>ONBOOT=yes<br>[root@internet ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@internet ~]<span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         172.20.200.200  0.0.0.0         UG    100    0        0 eth0<br>172.20.0.0      0.0.0.0         255.255.0.0     U     100    0        0 eth0<br><br><span class="hljs-comment">#route配置</span><br>[root@route ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>TYPE=Ethernet<br>BOOTPROTO=static<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>IPADDR=10.0.0.200<br>PREFIX=24<br>[root@route ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth1</span><br>TYPE=Ethernet<br>BOOTPROTO=static<br>NAME=eth1<br>DEVICE=eth1<br>ONBOOT=yes<br>IPADDR=172.20.200.200<br>PREFIX=16<br>[root@route ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:ed brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.200/24 brd 10.0.0.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe29:f3ed/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:f7 brd ff:ff:ff:ff:ff:ff<br>    inet 172.20.200.200/16 brd 172.20.255.255 scope global noprefixroute eth1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe29:f3f7/64 scope link <br>       valid_lft forever preferred_lft forever<br>4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0<br>       valid_lft forever preferred_lft forever<br>5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>[root@router ~]<span class="hljs-comment"># vim /etc/sysctl.conf</span><br>net.ipv4.ip_forward=1<br>[root@router ~]<span class="hljs-comment"># sysctl -p</span><br><br><span class="hljs-comment">#rs1配置</span><br>[root@rs1 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=10.0.0.7<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>IPV6_PRIVACY=<span class="hljs-string">&quot;no&quot;</span><br>GATEWAY=10.0.0.200<br>PREFIX=24<br>DNS1=223.5.5.5<br>[root@rs1 ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@rs1 ~]<span class="hljs-comment"># yum install -y httpd</span><br>[root@rs1 ~]<span class="hljs-comment"># hostname -I &gt; /var/www/html/index.html</span><br>[root@rs1 ~]<span class="hljs-comment"># systemctl start httpd</span><br>[root@rs1 ~]<span class="hljs-comment"># curl 10.0.0.7</span><br>10.0.0.7<br>[root@rs1 ~]<span class="hljs-comment"># echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br>[root@rs1 ~]<span class="hljs-comment"># echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br>[root@rs1 ~]<span class="hljs-comment"># echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br>[root@rs1 ~]<span class="hljs-comment"># echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br>[root@rs1 ~]<span class="hljs-comment"># ifconfig lo:1 10.0.0.100/32</span><br>[root@rs1 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet 10.0.0.100/0 scope global lo:1<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000<br>    link/ether 00:0c:29:90:f4:50 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.7/24 brd 10.0.0.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::e533:4d3c:7c52:5754/64 scope link <br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::40d2:a76f:ddbe:7372/64 scope link tentative dadfailed <br>       valid_lft forever preferred_lft forever<br>   <br><span class="hljs-comment">#rs2配置</span><br>[root@rs2 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=10.0.0.17<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>IPV6_PRIVACY=<span class="hljs-string">&quot;no&quot;</span><br>GATEWAY=10.0.0.200<br>PREFIX=24<br>[root@rs2 ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@rs2 ~]<span class="hljs-comment"># yum install -y httpd</span><br>[root@rs2 ~]<span class="hljs-comment"># hostname -I &gt; /var/www/html/index.html</span><br>[root@rs2 ~]<span class="hljs-comment"># systemctl start httpd</span><br>[root@rs2 ~]<span class="hljs-comment"># curl 10.0.0.17</span><br>10.0.0.17<br>[root@rs2 ~]<span class="hljs-comment"># echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore </span><br>[root@rs2 ~]<span class="hljs-comment"># echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore </span><br>[root@rs2 ~]<span class="hljs-comment"># echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce </span><br>[root@rs2 ~]<span class="hljs-comment"># echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce </span><br>[root@rs2 ~]<span class="hljs-comment"># ifconfig lo:1 10.0.0.100/32</span><br>[root@rs2 ~]<span class="hljs-comment"># ifconfig </span><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.17  netmask 255.255.255.0  broadcast 10.0.0.255<br>        inet6 fe80::bf50:b493:747b:e419  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        inet6 fe80::40d2:a76f:ddbe:7372  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        inet6 fe80::e533:4d3c:7c52:5754  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        ether 00:0c:29:56:c0:a3  txqueuelen 1000  (Ethernet)<br>        RX packets 1035  bytes 91665 (89.5 KiB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 606  bytes 71428 (69.7 KiB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 127.0.0.1  netmask 255.0.0.0<br>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;<br>        loop  txqueuelen 1  (Local Loopback)<br>        RX packets 4  bytes 256 (256.0 B)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 4  bytes 256 (256.0 B)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>lo:1: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 10.0.0.100  netmask 0.0.0.0<br>        loop  txqueuelen 1  (Local Loopback)<br><br><span class="hljs-comment">#lvs配置</span><br>[root@lvs ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=10.0.0.8<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=10.0.0.200<br>PREFIX=24<br>[root@lvs ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@lvs ~]<span class="hljs-comment"># yum install -y ipvsadm</span><br>[root@lvs ~]<span class="hljs-comment"># ifconfig lo:1 10.0.0.100/32</span><br>[root@lvs ~]<span class="hljs-comment"># ifconfig </span><br>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.8  netmask 255.255.255.0  broadcast 10.0.0.255<br>        inet6 fe80::40d2:a76f:ddbe:7372  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        inet6 fe80::e533:4d3c:7c52:5754  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        ether 00:0c:29:5d:a5:50  txqueuelen 1000  (Ethernet)<br>        RX packets 14328  bytes 20408812 (19.4 MiB)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 6949  bytes 453746 (443.1 KiB)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 127.0.0.1  netmask 255.0.0.0<br>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;<br>        loop  txqueuelen 1  (Local Loopback)<br>        RX packets 0  bytes 0 (0.0 B)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 0  bytes 0 (0.0 B)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br>lo:1: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536<br>        inet 10.0.0.100  netmask 0.0.0.0<br>        loop  txqueuelen 1  (Local Loopback)<br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -A -t 10.0.0.100:80 -s wrr</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.7 -g -w 3</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.17 -g</span><br>[root@lvs ~]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  10.0.0.100:80 wrr<br>  -&gt; 10.0.0.7:80                  Route   3      0          0         <br>  -&gt; 10.0.0.17:80                 Route   1      0          0<br></code></pre></td></tr></table></figure>

<h2 id="4-3-LVS-DR模式多网段案例"><a href="#4-3-LVS-DR模式多网段案例" class="headerlink" title="4.3 LVS-DR模式多网段案例"></a>4.3 LVS-DR模式多网段案例</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs25.png" srcset="/blog/img/loading.gif"></p>
<p>范例:</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dns">环境：五台主机<br>一台：internet eth0:仅主机 <span class="hljs-number">192.168.10.6</span>/<span class="hljs-number">24</span> GW:<span class="hljs-number">192.168.10.200</span><br><br>一台：ROUTER<br>eth0 :NAT  <span class="hljs-number">10.0.0.200</span>/<span class="hljs-number">24 172.16.0</span>.<span class="hljs-number">200</span>/<span class="hljs-number">24</span><br>eth1: 仅主机 <span class="hljs-number">192.168.10.200</span>/<span class="hljs-number">24</span><br>启用 IP_FORWARD<br><br>一台：LVS<br>eth0:NAT:DIP:<span class="hljs-number">10.0.0.8</span>/<span class="hljs-number">24</span> GW:<span class="hljs-number">10.0.0.200</span><br><br>两台RS：<br>RS1：eth0:NAT:<span class="hljs-number">10.0.0.7</span>/<span class="hljs-number">24</span>  GW：<span class="hljs-number">10.0.0.200</span><br>RS2：eth0:NAT:<span class="hljs-number">10.0.0.17</span>/<span class="hljs-number">24</span> GW：<span class="hljs-number">10.0.0.200</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#internet配置</span><br>[root@internet ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=192.168.10.6<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=192.168.10.200<br>PREFIX=24<br>[root@internet ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@internet ~]<span class="hljs-comment"># hostname -I</span><br>192.168.10.6<br><br><span class="hljs-comment">#router的网络配置</span><br>[root@router ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>BOOTPROTO=static<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>IPADDR=10.0.0.200<br>PREFIX=24<br>[root@router ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth1</span><br>BOOTPROTO=static<br>NAME=eth1<br>DEVICE=eth1<br>ONBOOT=yes<br>IPADDR=192.168.10.200<br>PREFIX=24<br>[root@router ~]<span class="hljs-comment"># nmcli c reload</span><br>[root@router ~]<span class="hljs-comment"># nmcli c up eth0</span><br>[root@router ~]<span class="hljs-comment"># nmcli c up eth1</span><br>[root@router ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:ed brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.200/24 brd 10.0.0.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe29:f3ed/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:f7 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.10.200/24 brd 192.168.10.255 scope global noprefixroute eth1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe29:f3f7/64 scope link <br>       valid_lft forever preferred_lft forever<br>4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br><span class="hljs-comment">#添加172.16.0.200/24的地址</span><br>[root@router ~]<span class="hljs-comment"># ip addr add 172.16.0.200/24 dev eth0</span><br>[root@router ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:ed brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.200/24 brd 10.0.0.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet 172.16.0.200/24 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe29:f3ed/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:29:f3:f7 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.10.200/24 brd 192.168.10.255 scope global noprefixroute eth1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe29:f3f7/64 scope link <br>       valid_lft forever preferred_lft forever<br>4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000<br>    link/ether 52:54:00:b9:24:09 brd ff:ff:ff:ff:ff:ff<br>[root@router ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.200 172.16.0.200 192.168.10.200 192.168.122.1<br>[root@router ~]<span class="hljs-comment"># echo &#x27;net.ipv4.ip_forward=1&#x27; &gt;&gt; /etc/sysctl.conf</span><br>[root@router ~]<span class="hljs-comment"># sysctl -p</span><br>net.ipv4.ip_forward = 1<br><br><br><span class="hljs-comment">#lvs主机的网络配置</span><br>[root@lvs ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=10.0.0.8<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=10.0.0.200<br>[root@lvs ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@lvs ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.8<br>[root@lvs ~]<span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<br><br><span class="hljs-comment">#rs1配置</span><br>[root@rs1 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=10.0.0.7<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=10.0.0.200<br>[root@rs1 ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@rs1 ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.7<br>[root@rs1 ~]<span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<br><br><span class="hljs-comment">#rs2配置</span><br>[root@rs2 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=10.0.0.7<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=10.0.0.200<br>[root@rs2 ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@rs2 ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.17<br>[root@rs2 ~]<span class="hljs-comment">#route -n</span><br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<br><br><br><span class="hljs-comment">#在LVS主机运行的脚本</span><br>[root@lvs ~]<span class="hljs-comment">#cat lvs_dr_vs.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>vip=<span class="hljs-string">&#x27;172.16.0.100&#x27;</span><br>iface=<span class="hljs-string">&#x27;lo:1&#x27;</span><br>mask=<span class="hljs-string">&#x27;255.255.255.255&#x27;</span><br>port=<span class="hljs-string">&#x27;80&#x27;</span><br>rs1=<span class="hljs-string">&#x27;10.0.0.7&#x27;</span><br>rs2=<span class="hljs-string">&#x27;10.0.0.17&#x27;</span><br>scheduler=<span class="hljs-string">&#x27;wrr&#x27;</span><br><span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;-g&#x27;</span><br>rpm -q ipvsadm &amp;&gt; /dev/null || yum -y install ipvsadm &amp;&gt; /dev/null<br><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>start)<br> ifconfig <span class="hljs-variable">$iface</span> <span class="hljs-variable">$vip</span> netmask <span class="hljs-variable">$mask</span> <span class="hljs-comment">#broadcast $vip up</span><br> iptables -F<br> ipvsadm -A -t <span class="hljs-variable">$&#123;vip&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> -s <span class="hljs-variable">$scheduler</span><br> ipvsadm -a -t <span class="hljs-variable">$&#123;vip&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> -r <span class="hljs-variable">$&#123;rs1&#125;</span> <span class="hljs-variable">$type</span> -w 1<br> ipvsadm -a -t <span class="hljs-variable">$&#123;vip&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> -r <span class="hljs-variable">$&#123;rs2&#125;</span> <span class="hljs-variable">$type</span> -w 1<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The VS Server is Ready!&quot;</span><br>;;<br>stop)<br> ipvsadm -C<br> ifconfig <span class="hljs-variable">$iface</span> down<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The VS Server is Canceled!&quot;</span><br>;;<br>*)<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-subst">$(basename $0)</span> start|stop&quot;</span><br> <span class="hljs-built_in">exit</span> 1<br>;;<br><span class="hljs-keyword">esac</span><br><br>[root@lvs ~]<span class="hljs-comment">#bash lvs_dr_vs.sh start</span><br>The VS Server is Ready!<br><br><span class="hljs-comment">#在RS后端服务器运行的脚本</span><br>[root@rs1 ~]<span class="hljs-comment">#cat lvs_dr_rs.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>vip=172.16.0.100<br>mask=<span class="hljs-string">&#x27;255.255.255.255&#x27;</span><br>dev=lo:1<br>rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null<br>service httpd start &amp;&gt; /dev/null &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The httpd Server is Ready!&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;`hostname -I`&quot;</span> &gt; /var/www/html/index.html<br><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>start)<br> <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br> <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore<br> <span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce<br> <span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce<br> ifconfig <span class="hljs-variable">$dev</span> <span class="hljs-variable">$vip</span> netmask <span class="hljs-variable">$mask</span> <span class="hljs-comment">#broadcast $vip up</span><br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The RS Server is Ready!&quot;</span><br>;;<br>stop)<br> ifconfig <span class="hljs-variable">$dev</span> down<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The RS Server is Canceled!&quot;</span><br> ;;<br>*)<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-subst">$(basename $0)</span> start|stop&quot;</span><br> <span class="hljs-built_in">exit</span> 1<br>;;<br><span class="hljs-keyword">esac</span><br>[root@rs1 ~]<span class="hljs-comment">#bash lvs_dr_rs.sh start</span><br>The RS Server is Ready!<br><br><span class="hljs-comment">#在RS后端服务器运行的脚本和RS1是一样的</span><br>[root@rs2 ~]<span class="hljs-comment">#bash lvs_dr_rs.sh start</span><br>The RS Server is Ready!<br><br><span class="hljs-comment">#测试访问</span><br>[root@internet ~]<span class="hljs-comment">#curl 172.16.0.100</span><br>10.0.0.7<br>[root@internet ~]<span class="hljs-comment">#curl 172.16.0.100</span><br>10.0.0.17<br></code></pre></td></tr></table></figure>

<p>范例:2</p>
<img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs26.png" srcset="/blog/img/loading.gif" style="zoom:150%;" />

<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dns">环境：五台主机<br>一台：internet eth0:仅主机 <span class="hljs-number">172.16.0.123</span>/<span class="hljs-number">16</span> GW:<span class="hljs-number">172.16.0.200</span><br><br>一台：ROUTER<br>eth0:NAT   <span class="hljs-number">192.168.8.200</span>/<span class="hljs-number">24 10.0.0</span>.<span class="hljs-number">200</span>/<span class="hljs-number">24</span><br>eth1:仅主机 <span class="hljs-number">172.16.0.200</span>/<span class="hljs-number">16</span><br>启用 IP_FORWARD<br><br>一台：LVS<br>eth0:NAT:DIP:<span class="hljs-number">192.168.8.100</span>/<span class="hljs-number">24</span> GW:<span class="hljs-number">192.168.8.200</span><br><br>两台RS：<br>RS1：eth0:NAT:<span class="hljs-number">192.168.8.101</span>/<span class="hljs-number">24</span>  GW：<span class="hljs-number">192.168.8.200</span><br>RS2：eth0:NAT:<span class="hljs-number">192.168.8.102</span>/<span class="hljs-number">24</span> GW：<span class="hljs-number">192.168.8.200</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#internet配置</span><br>[root@internet ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=172.16.0.123<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=172.16.0.200<br>PREFIX=16<br>[root@internet ~]<span class="hljs-comment"># systemctl restart network</span><br><br><span class="hljs-comment">#router配置</span><br>[root@router ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>BOOTPROTO=static<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>IPADDR=192.168.8.200<br>PREFIX=24<br>[root@router ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth1</span><br>BOOTPROTO=static<br>NAME=eth1<br>DEVICE=eth1<br>ONBOOT=yes<br>IPADDR=172.16.0.200<br>PREFIX=16<br>[root@router ~]<span class="hljs-comment"># nmcli c reload</span><br>[root@router ~]<span class="hljs-comment"># nmcli c up eth0</span><br>[root@router ~]<span class="hljs-comment"># nmcli c up eth1</span><br>[root@router ~]<span class="hljs-comment"># ip addr add 10.0.0.200/24 dev eth0:1</span><br>[root@router ~]<span class="hljs-comment"># echo &#x27;net.ipv4.ip_forward=1&#x27; &gt;&gt; /etc/sysctl.conf</span><br>[root@router ~]<span class="hljs-comment"># sysctl -p</span><br>net.ipv4.ip_forward = 1<br><br><span class="hljs-comment">#lvs配置</span><br>[root@lvs ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=192.168.8.100<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=192.168.8.200<br>PREFIX=24<br>[root@lvs ~]<span class="hljs-comment"># systemctl restart network</span><br><br><span class="hljs-comment">#rs1配置</span><br>[root@rs1 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=192.168.8.101<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=192.168.8.200<br>PREFIX=24<br>[root@rs1 ~]<span class="hljs-comment"># systemctl restart network</span><br><br><span class="hljs-comment">#rs2配置</span><br>[root@rs2 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=192.168.8.102<br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>GATEWAY=192.168.8.200<br>PREFIX=24<br>[root@rs2 ~]<span class="hljs-comment"># systemctl restart network</span><br></code></pre></td></tr></table></figure>

<p><strong>RS 的配置脚本</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rs1 ~]<span class="hljs-comment"># cat lvs_dr_rs.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>vip=10.0.0.100<br>mask=<span class="hljs-string">&#x27;255.255.255.255&#x27;</span><br>dev=lo:1<br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>start)<br> <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br> <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore<br> <span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce<br> <span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce<br> ifconfig <span class="hljs-variable">$dev</span> <span class="hljs-variable">$vip</span> netmask <span class="hljs-variable">$You</span> can<span class="hljs-string">&#x27;t use &#x27;</span>macro parameter character <span class="hljs-comment">#&#x27; in math modemask #broadcast $vip up</span><br>  <span class="hljs-comment">#route add -host $vip dev $dev</span><br>;;<br>stop)<br> ifconfig <span class="hljs-variable">$dev</span> down<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce<br>;;<br>*)<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-subst">$(basename $0)</span> start|stop&quot;</span><br> <span class="hljs-built_in">exit</span> 1<br>;;<br><span class="hljs-keyword">esac</span><br></code></pre></td></tr></table></figure>

<p><strong>VS的配置脚本</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lvs ~]<span class="hljs-comment"># cat lvs_dr_vs.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>vip=<span class="hljs-string">&#x27;10.0.0.100&#x27;</span><br>iface=<span class="hljs-string">&#x27;lo:1&#x27;</span><br>mask=<span class="hljs-string">&#x27;255.255.255.255&#x27;</span><br>port=<span class="hljs-string">&#x27;80&#x27;</span><br>rs1=<span class="hljs-string">&#x27;192.168.8.101&#x27;</span><br>rs2=<span class="hljs-string">&#x27;192.168.8.102&#x27;</span><br>scheduler=<span class="hljs-string">&#x27;wrr&#x27;</span><br><span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;-g&#x27;</span><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>start)<br>ifconfig <span class="hljs-variable">$iface</span> <span class="hljs-variable">$vip</span> netmask <span class="hljs-variable">$mask</span> <span class="hljs-comment">#broadcast $vip up</span><br>iptables -F<br>ipvsadm -A -t <span class="hljs-variable">$&#123;vip&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> -s <span class="hljs-variable">$scheduler</span><br>ipvsadm -a -t <span class="hljs-variable">$&#123;vip&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> -r <span class="hljs-variable">$&#123;rs1&#125;</span> <span class="hljs-variable">$type</span> -w 1<br>ipvsadm -a -t <span class="hljs-variable">$&#123;vip&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> -r <span class="hljs-variable">$&#123;rs2&#125;</span> <span class="hljs-variable">$type</span> -w 1<br>;;<br>stop)<br>ipvsadm -C<br>ifconfig <span class="hljs-variable">$iface</span> down<br>;;<br>*)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage <span class="hljs-subst">$(basename $0)</span> start|stop“</span><br><span class="hljs-string">exit 1</span><br><span class="hljs-string">esac</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lvs ~]<span class="hljs-comment"># bash lvs_dr_vs.sh start</span><br><br>[root@rs1 ~]<span class="hljs-comment"># bash lvs_dr_rs.sh start</span><br><br>[root@rs2 ~]<span class="hljs-comment"># bash lvs_dr_rs.sh start</span><br><br><span class="hljs-comment">#测试访问</span><br>[root@internet ~]<span class="hljs-comment">#curl 10.0.0.100</span><br>192.168.8.101<br>[root@internet ~]<span class="hljs-comment">#curl 10.0.0.100</span><br>192.168.8.102<br></code></pre></td></tr></table></figure>

<p><strong>范例3: 跨网段DR模型案例</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs27.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dns">环境：五台主机<br>一台：internet eth0:仅主机 <span class="hljs-number">172.20.200.6</span>/<span class="hljs-number">16</span> GW:<span class="hljs-number">172.20.200.200</span><br><br>一台：ROUTER<br>eth0 :NAT  <span class="hljs-number">10.0.0.200</span>/<span class="hljs-number">24 192.168.0</span>.<span class="hljs-number">200</span>/<span class="hljs-number">24</span><br>eth1: 仅主机 <span class="hljs-number">172.20.200.200</span>/<span class="hljs-number">16</span><br>启用 IP_FORWARD<br><br>一台：LVS<br>eth0:NAT:DIP:<span class="hljs-number">10.0.0.8</span>/<span class="hljs-number">24</span> GW:<span class="hljs-number">10.0.0.200</span><br><br>两台RS：<br>RS1：eth0:NAT:<span class="hljs-number">10.0.0.7</span>/<span class="hljs-number">24</span>  GW：<span class="hljs-number">10.0.0.200</span><br>RS2：eth0:NAT:<span class="hljs-number">10.0.0.17</span>/<span class="hljs-number">24</span> GW：<span class="hljs-number">10.0.0.200</span><br></code></pre></td></tr></table></figure>

<p><strong>配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rs1 ~]<span class="hljs-comment">#cat lvs_dr_rs.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>vip=192.168.10100<br>mask=<span class="hljs-string">&#x27;255.255.255.255&#x27;</span><br>dev=lo:1<br>rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null<br>service httpd start &amp;&gt; /dev/null &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The httpd Server is Ready!&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot;</span> &gt; /var/www/html/index.html<br><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>start)<br> <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br> <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore<br> <span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce<br> <span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce<br> ifconfig <span class="hljs-variable">$dev</span> <span class="hljs-variable">$vip</span> netmask <span class="hljs-variable">$mask</span> <span class="hljs-comment">#broadcast $vip up</span><br>  <span class="hljs-comment">#route add -host $vip dev $dev</span><br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The RS Server is Ready!&quot;</span><br> ;;<br>stop)<br> ifconfig <span class="hljs-variable">$dev</span> down<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce<br> <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The RS Server is Canceled!&quot;</span><br>;;<br>*)<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-subst">$(basename $0)</span> start|stop&quot;</span><br> <span class="hljs-built_in">exit</span> 1<br>;;<br><span class="hljs-keyword">esac</span><br><br>[root@rs1 ~]<span class="hljs-comment">#bash lvs_dr_rs.sh start</span><br>[root@rs2 ~]<span class="hljs-comment">#bash lvs_dr_rs.sh start</span><br><br>[root@LVS ~]<span class="hljs-comment">#cat lvs_dr_vs.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>vip=<span class="hljs-string">&#x27;192.168.10100&#x27;</span><br>iface=<span class="hljs-string">&#x27;lo:1&#x27;</span><br>mask=<span class="hljs-string">&#x27;255.255.255.255&#x27;</span><br>port=<span class="hljs-string">&#x27;80&#x27;</span><br>rs1=<span class="hljs-string">&#x27;10.0.0.7&#x27;</span><br>rs2=<span class="hljs-string">&#x27;10.0.0.17&#x27;</span><br>scheduler=<span class="hljs-string">&#x27;wrr&#x27;</span><br><span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;-g&#x27;</span><br>rpm -q ipvsadm &amp;&gt; /dev/null || yum -y install ipvsadm &amp;&gt; /dev/null<br><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>start)<br> ifconfig <span class="hljs-variable">$iface</span> <span class="hljs-variable">$vip</span> netmask <span class="hljs-variable">$mask</span> <span class="hljs-comment">#broadcast $vip up</span><br> iptables -F<br> ipvsadm -A -t <span class="hljs-variable">$&#123;vip&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> -s <span class="hljs-variable">$scheduler</span><br> ipvsadm -a -t <span class="hljs-variable">$&#123;vip&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> -r <span class="hljs-variable">$&#123;rs1&#125;</span> <span class="hljs-variable">$type</span> -w 1<br> ipvsadm -a -t <span class="hljs-variable">$&#123;vip&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> -r <span class="hljs-variable">$&#123;rs2&#125;</span> <span class="hljs-variable">$type</span> -w 1<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The VS Server is Ready!&quot;</span><br> ;;<br>stop)<br> ipvsadm -C<br> ifconfig <span class="hljs-variable">$iface</span> down<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The VS Server is Canceled!&quot;</span><br> ;;<br>*)<br> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-subst">$(basename $0)</span> start|stop&quot;</span><br> <span class="hljs-built_in">exit</span> 1<br>;;<br><span class="hljs-keyword">esac</span><br><br>[root@lvs ~]<span class="hljs-comment">#bash lvs_dr_vs.sh start</span><br><br>[root@router ~]<span class="hljs-comment">#nmcli connection modify eth0 +ipv4.addresses 192.168.10.200/24</span><br>[root@router ~]<span class="hljs-comment">#nmcli connection reload</span><br>[root@router ~]<span class="hljs-comment">#nmcli connection up eth0</span><br>[root@router ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:4d:ef:3e brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.200/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet 192.168.10200/24 brd 192.168.10255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe4d:ef3e/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:4d:ef:48 brd ff:ff:ff:ff:ff:ff<br> inet 172.20.200.200/16 brd 172.20.255.255 scope global noprefixroute eth1<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe4d:ef48/64 scope link<br>   valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<h2 id="4-4-LVS-TUNNEL隧道模式案例"><a href="#4-4-LVS-TUNNEL隧道模式案例" class="headerlink" title="4.4 LVS-TUNNEL隧道模式案例"></a>4.4 LVS-TUNNEL隧道模式案例</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs28.png" srcset="/blog/img/loading.gif"></p>
<h3 id="4-4-1-LVS服务器配置"><a href="#4-4-1-LVS服务器配置" class="headerlink" title="4.4.1 LVS服务器配置"></a>4.4.1 LVS服务器配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe44:c3fe/64 scope link<br>   valid_lft forever preferred_lft forever<br>   <br><span class="hljs-comment">#开启tunnel网卡并配置VIP</span><br>[root@centos8 ~]<span class="hljs-comment">#ifconfig tunl0 10.0.0.100 netmask 255.255.255.255 up</span><br><span class="hljs-comment">#或者下面方法,注意设备名必须为tunl0</span><br>[root@centos8 ~]<span class="hljs-comment">#ip addr add 10.0.0.100/32 dev tunl0</span><br>[root@centos8 ~]<span class="hljs-comment">#ip link set up tunl0</span><br><br><span class="hljs-comment">#自动加载ipip模块</span><br>[root@centos8 ~]<span class="hljs-comment">#lsmod |grep ipip</span><br>ipip          16384  0<br>tunnel4         16384  1 ipip<br>ip_tunnel        28672  1 ipip<br>[root@centos8 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe44:c3fe/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/ipip 0.0.0.0 brd 0.0.0.0<br> inet 10.0.0.100/32 scope global tunl0<br>   valid_lft forever preferred_lft forever<br><br>[root@centos8 ~]<span class="hljs-comment">#yum -y install ipvsadm</span><br>[root@centos8 ~]<span class="hljs-comment">#ipvsadm -A -t 10.0.0.100:80 -s rr</span><br>[root@centos8 ~]<span class="hljs-comment">#ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.7 -i</span><br>[root@centos8 ~]<span class="hljs-comment">#ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.17 -i</span><br>[root@centos8 ~]<span class="hljs-comment">#ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port      Forward Weight ActiveConn InActConn<br>TCP  10.0.0.100:80 rr<br> -&gt; 10.0.0.7:80         Tunnel  1    0      0    <br> -&gt; 10.0.0.17:80         Tunnel  1    0      0 <br></code></pre></td></tr></table></figure>

<h3 id="4-4-2-RS服务器配置"><a href="#4-4-2-RS服务器配置" class="headerlink" title="4.4.2 RS服务器配置"></a>4.4.2 RS服务器配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#RS服务器配置,RS1和RS2配置相同</span><br>[root@rs1 ~]<span class="hljs-comment">#hostname</span><br>rs1.magedu.org<br>[root@rs1 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.7<br><br>[root@rs1 ~]<span class="hljs-comment">#route -n</span><br>Kernel IP routing table<br>Destination   Gateway     Genmask     Flags Metric Ref  Use Iface<br>0.0.0.0     10.0.0.200    0.0.0.0     UG   100   0     0 eth0<br>10.0.0.0     0.0.0.0     255.255.255.0  U   100   0     0 eth0<br><br><span class="hljs-comment">#开启tunnel网卡并配置VIP</span><br>[root@rs1 ~]<span class="hljs-comment">#ifconfig tunl0 10.0.0.100 netmask 255.255.255.255 up</span><br>[root@rs1 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP<br>group default qlen 1000<br> link/ether 00:0c:29:01:f9:48 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe01:f948/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/ipip 0.0.0.0 brd 0.0.0.0<br> inet 10.0.0.100/32 scope global tunl0<br>   valid_lft forever preferred_lft forever<br>   <br><span class="hljs-comment">#修改内核参数 </span><br>[root@rs1 ~]<span class="hljs-comment">#echo &quot;1&quot; &gt; /proc/sys/net/ipv4/conf/tunl0/arp_ignore    </span><br>[root@rs1 ~]<span class="hljs-comment">#echo &quot;2&quot; &gt; /proc/sys/net/ipv4/conf/tunl0/arp_announce</span><br>[root@rs1 ~]<span class="hljs-comment">#echo &quot;1&quot; &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br>[root@rs1 ~]<span class="hljs-comment">#echo &quot;2&quot; &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><br><span class="hljs-comment">#以下参数用来控制系统是否开启对数据包源地址的校验。0标示不开启地址校验；1表开启严格的反向路径校验。对每一个进行的数据包，校验其反向路径是否是最佳路径。如果反向路径不是最佳路径，则直接丢弃该数据包；2标示开启松散的反向路径校验，对每个进行的数据包，校验其源地址是否可以到达，即反向路径是否可以ping通，如反向路径不通，则直接丢弃该数据包。</span><br>[root@rs1 ~]<span class="hljs-comment">#echo &quot;0&quot; &gt; /proc/sys/net/ipv4/conf/tunl0/rp_filter</span><br>[root@rs1 ~]<span class="hljs-comment">#echo &quot;0&quot; &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span><br>[root@rs1 ~]<span class="hljs-comment">#yum -y install httpd</span><br>[root@rs1 ~]<span class="hljs-comment">#systemctl enable --now httpd</span><br>[root@rs1 ~]<span class="hljs-comment">#hostname &gt; /var/www/html/index.html</span><br></code></pre></td></tr></table></figure>

<h3 id="4-4-3-测试"><a href="#4-4-3-测试" class="headerlink" title="4.4.3 测试"></a>4.4.3 测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@internet ~]<span class="hljs-comment">#while :;do curl 10.0.0.100;sleep 0.3;done</span><br>rs2<br>rs1<br>rs2<br>rs1<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs29.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/lvs/lvs30.png" srcset="/blog/img/loading.gif"></p>
<h1 id="五、LVS-高可用性实现"><a href="#五、LVS-高可用性实现" class="headerlink" title="五、LVS 高可用性实现"></a>五、LVS 高可用性实现</h1><p><strong>LVS 不可用时：</strong></p>
<p>Director不可用，整个系统将不可用；SPoF Single Point of Failure</p>
<p>解决方案：高可用，keepalived、heartbeat/corosync</p>
<p><strong>RS 不可用时：</strong></p>
<p>某RS不可用时，Director依然会调度请求至此RS</p>
<p>解决方案： 由Director对各RS健康状态进行检查，失败时禁用，成功时启用</p>
<p>常用解决方案：</p>
<ul>
<li>keepalived</li>
<li>heartbeat/corosync</li>
<li>ldirectord</li>
</ul>
<p>检测方式：</p>
<ul>
<li>网络层检测，icmp</li>
<li>(b) 传输层检测，端口探测</li>
<li>(c) 应用层检测，请求某关键资源</li>
</ul>
<p>RS全不用时：backup server, sorry server</p>
<h2 id="5-1-ldirectord软件"><a href="#5-1-ldirectord软件" class="headerlink" title="5.1 ldirectord软件"></a>5.1 ldirectord软件</h2><p>ldirectord：监控和控制LVS守护进程，可管理LVS规则</p>
<p>包名：ldirectord-3.9.6-0rc1.1.1.x86_64.rpm</p>
<p>下载：<a target="_blank" rel="noopener" href="http://download.opensuse.org/repositories/network:/ha-clustering:/Stable/CentOS_CentOS-7/x86_64/">http://download.opensuse.org/repositories/network:/ha-clustering:/Stable/CentOS_CentOS-7/x86_64/</a></p>
<p>相关文件：</p>
<ul>
<li>/etc/ha.d/ldirectord.cf #主配置文件</li>
<li>/usr/share/doc/ldirectord-3.9.6/ldirectord.cf # 配置模版</li>
<li>/usr/lib/systemd/system/ldirectord.service # 服务</li>
<li>/usr/sbin/ldirectord #主程序,Perl实现</li>
<li>/var/log/ldirectord.log #日志</li>
<li>/var/run/ldirectord.ldirectord.pid #pid文件</li>
</ul>
<h2 id="5-2-ldirectord配置文件示例"><a href="#5-2-ldirectord配置文件示例" class="headerlink" title="5.2 ldirectord配置文件示例"></a>5.2 ldirectord配置文件示例</h2><p>范例：DR模型的HTTP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/ha.d/ldirectord.cf</span><br>checktimeout=3<br>checkinterval=1<br>autoreload=yes<br>logfile=<span class="hljs-string">&quot;/var/log/ldirectord.log&quot;</span><br>quiescent=no   <span class="hljs-comment">#当RS down时 yes将修改权重为0,此配置有bug ，no为从调度列表中删除RS</span><br><br>virtual=10.0.0.100:80<br>real=192.168.39.17 gate 1  <span class="hljs-comment">#gate 表示DR模式，1 表示weight</span><br>real=192.168.39.18 gate 2<br>fallback=127.0.0.1:80 gate<br>service=http<br>scheduler=wrr<br><span class="hljs-comment">#persistent=600</span><br><span class="hljs-comment">#netmask=255.255.255.255</span><br>protocol=tcp<br>checktype=negotiate<br>checkport=80<br><br>[root@lvs ~]<span class="hljs-comment">#ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port      Forward Weight ActiveConn InActConn<br>TCP  10.0.0.100:80 wrr<br> -&gt; 192.168.39.17:80       Route  1    0      31    <br> -&gt; 192.168.39.18:80       Route  2    0      62<br></code></pre></td></tr></table></figure>

<p>范例：DR模型的FWM</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># /etc/ha.d/ldirectord.cf</span><br>checktimeout=3<br>checkinterval=1<br>autoreload=yes<br>logfile=“/var/<span class="hljs-built_in">log</span>/ldirectord.log“   <span class="hljs-comment">#日志文件</span><br>quiescent=no       <span class="hljs-comment">#当RS down时 yes将修改权重为0,此配置有bug ，no为从调度列表中删除RS</span><br>virtual=66        <span class="hljs-comment">#指定VS的FWM 或 IP:PORT</span><br>real=172.16.0.7:80 gate 2   <span class="hljs-comment">#DR模型，权重为 2</span><br>real=172.16.0.8:80 gate 1<br>fallback=127.0.0.1:80 gate  <span class="hljs-comment">#sorry server</span><br>service=http<br>scheduler=wrr<br><span class="hljs-comment">#protocol=tcp   #如果FWM模式，此行必须注释掉</span><br>checktype=negotiate<br>checkport=80<br>request=<span class="hljs-string">&quot;index.html&quot;</span><br>receive=“Test Ldirectord<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/linux-lvs/">linux lvs</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">网络文件共享服务</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AFdocker%EF%BC%88%E5%85%AB%EF%BC%89docker%E5%8F%AF%E8%A7%86%E5%8C%96%E5%9B%BE%E5%BD%A2%E5%B7%A5%E5%85%B7Portainer/">
                        <span class="hidden-mobile">企业级容器技术docker（八）docker可视化图形工具Portainer</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
