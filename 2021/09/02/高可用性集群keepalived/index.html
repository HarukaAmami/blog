

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>高可用性集群keepalived - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="高可用性集群keepalived">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-02 14:20" pubdate>
        2021年9月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      21.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      368
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">高可用性集群keepalived</h1>
            
            <div class="markdown-body">
              <h1 id="高可用集群Keepalived"><a href="#高可用集群Keepalived" class="headerlink" title="高可用集群Keepalived"></a>高可用集群Keepalived</h1><h2 id="一、高可用集群"><a href="#一、高可用集群" class="headerlink" title="一、高可用集群"></a>一、高可用集群</h2><h3 id="1-1-集群类型"><a href="#1-1-集群类型" class="headerlink" title="1.1 集群类型"></a>1.1 集群类型</h3><ul>
<li><p>LB：Load Balance 负载均衡</p>
<p>LVS/HAProxy/nginx（http/upstream, stream/upstream）</p>
</li>
<li><p>HA：High Availability 高可用集群<br>数据库、Zookeeper、Redis<br>SPoF: Single Point of Failure，解决单点故障</p>
</li>
<li><p>HPC：High Performance Computing 高性能集群<br><a target="_blank" rel="noopener" href="https://www.top500.org/">https://www.top500.org</a></p>
</li>
</ul>
<h3 id="1-2-系统可用性"><a href="#1-2-系统可用性" class="headerlink" title="1.2 系统可用性"></a>1.2 系统可用性</h3><p>SLA：Service-Level Agreement 服务等级协议（提供服务的企业与客户之间就服务的品质、水准、性<br>能等方面所达成的双方共同认可的协议或契约）</p>
<p>A = MTBF / (MTBF+MTTR）</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">99.95%:(60*24*30)*(1-0.9995)=21.6分钟 #一般按一个月停机时间统计<br></code></pre></td></tr></table></figure>

<p>指标 ：99.9%, 99.99%, 99.999%,99.9999%</p>
<h3 id="1-3-系统故障"><a href="#1-3-系统故障" class="headerlink" title="1.3 系统故障"></a>1.3 系统故障</h3><p>硬件故障：设计缺陷、wear out（损耗）、自然灾害……<br>软件故障：设计缺陷 bug</p>
<h3 id="1-4-实现高可用"><a href="#1-4-实现高可用" class="headerlink" title="1.4 实现高可用"></a>1.4 实现高可用</h3><p>提升系统高用性的解决方案：降低MTTR- Mean Time To Repair(平均故障时间)<br>解决方案：建立冗余机制</p>
<ul>
<li>active/passive 主/备</li>
<li>active/active 双主</li>
<li>active –&gt; HEARTBEAT –&gt; passive</li>
<li>active &lt;–&gt; HEARTBEAT &lt;–&gt; active</li>
</ul>
<h3 id="1-5-高可用相关技术"><a href="#1-5-高可用相关技术" class="headerlink" title="1.5 高可用相关技术"></a>1.5 高可用相关技术</h3><h4 id="1-5-1-HA-service"><a href="#1-5-1-HA-service" class="headerlink" title="1.5.1 HA service"></a>1.5.1 HA service</h4><p>资源：组成一个高可用服务的“组件”，比如：vip，service process，shared storage<br>(1) passive node的数量<br>(2) 资源切换</p>
<h4 id="1-5-2-shared-storage"><a href="#1-5-2-shared-storage" class="headerlink" title="1.5.2 shared storage"></a>1.5.2 shared storage</h4><p>NAS(Network Attached Storage)：网络附加存储，基于网络的共享文件系统。<br>SAN(Storage Area Network)：存储区域网络，基于网络的块级别的共享</p>
<h4 id="1-5-3-Network-partition-网络分区"><a href="#1-5-3-Network-partition-网络分区" class="headerlink" title="1.5.3 Network partition 网络分区"></a>1.5.3 Network partition 网络分区</h4><h5 id="1-5-3-1-quorum-法定人数，仲裁"><a href="#1-5-3-1-quorum-法定人数，仲裁" class="headerlink" title="1.5.3.1 quorum 法定人数，仲裁"></a>1.5.3.1 quorum 法定人数，仲裁</h5><p>with quorum： &gt; total/2<br>without quorum: &lt;= total/2</p>
<h5 id="1-5-3-2-隔离设备-fence"><a href="#1-5-3-2-隔离设备-fence" class="headerlink" title="1.5.3.2 隔离设备 fence"></a>1.5.3.2 隔离设备 fence</h5><p>node：STONITH = Shooting The Other Node In The Head(强制下线/断电)</p>
<p>参考资料:<br><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/high_availability_add-on_reference/s1-unfence-haar">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/high_availability_add-on_reference/s1-unfence-haar</a></p>
<h4 id="1-5-5-双节点集群-TWO-nodes-Cluster"><a href="#1-5-5-双节点集群-TWO-nodes-Cluster" class="headerlink" title="1.5.5 双节点集群(TWO nodes Cluster)"></a>1.5.5 双节点集群(TWO nodes Cluster)</h4><p>辅助设备：仲裁设备，ping node, quorum disk</p>
<ul>
<li><p>Failover：故障切换，即某资源的主节点故障时，将资源转移至其它节点的操作</p>
</li>
<li><p>Failback：故障移回，即某资源的主节点故障后重新修改上线后，将之前已转移至其它节点的资源重新切回的过程</p>
</li>
</ul>
<h4 id="1-5-6-HA-Cluster实现方案"><a href="#1-5-6-HA-Cluster实现方案" class="headerlink" title="1.5.6 HA Cluster实现方案:"></a>1.5.6 HA Cluster实现方案:</h4><h5 id="1-5-6-1-AIS：Applicaiton-Interface-Specification-应用程序接口规范"><a href="#1-5-6-1-AIS：Applicaiton-Interface-Specification-应用程序接口规范" class="headerlink" title="1.5.6.1 AIS：Applicaiton Interface Specification 应用程序接口规范"></a>1.5.6.1 AIS：Applicaiton Interface Specification 应用程序接口规范</h5><p>RHCS：Red Hat Cluster Suite 红帽集群套件<br>参考资料：<a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/5/html/cluster_suite_overview/ch.gfscs.cluster-overview-cso">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/5/html/cluster_suite_overview/ch.gfscs.cluster-overview-cso</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Keeplived/keepalived1.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li>heartbeat：基于心跳监测实现服务高可用</li>
<li>pacemaker+corosync：资源管理与故障转移</li>
</ul>
<h5 id="1-5-6-2-VRRP-Virtual-Router-Redundancy-Protocol"><a href="#1-5-6-2-VRRP-Virtual-Router-Redundancy-Protocol" class="headerlink" title="1.5.6.2  VRRP:Virtual Router Redundancy Protocol"></a>1.5.6.2  VRRP:Virtual Router Redundancy Protocol</h5><p>虚拟路由冗余协议，解除静态网关单点风险</p>
<ul>
<li>物料物理层：路由器、三层交换机</li>
<li>软件层：keepalived</li>
</ul>
<h4 id="1-5-7-VRRP"><a href="#1-5-7-VRRP" class="headerlink" title="1.5.7 VRRP"></a>1.5.7 VRRP</h4><h5 id="1-5-7-1-VRRP-网络层硬件实现"><a href="#1-5-7-1-VRRP-网络层硬件实现" class="headerlink" title="1.5.7.1 VRRP 网络层硬件实现"></a>1.5.7.1 VRRP 网络层硬件实现</h5><p>参考链接：<br><a target="_blank" rel="noopener" href="https://support.huawei.com/enterprise/zh/doc/EDOC1000141382/19258d72/basic-concepts-of-vrrp">https://support.huawei.com/enterprise/zh/doc/EDOC1000141382/19258d72/basic-concepts-of-vrrp</a><br><a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/dc0afaa6f524ccbff1218416.html">https://wenku.baidu.com/view/dc0afaa6f524ccbff1218416.html</a><br><a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/281ae109ba1aa8114431d9d0.html">https://wenku.baidu.com/view/281ae109ba1aa8114431d9d0.html</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Keeplived/keepalived2.png" srcset="/blog/img/loading.gif"></p>
<h5 id="1-5-7-2-VRRP-相关术语"><a href="#1-5-7-2-VRRP-相关术语" class="headerlink" title="1.5.7.2 VRRP 相关术语"></a>1.5.7.2 VRRP 相关术语</h5><ul>
<li><p>虚拟路由器：Virtual Router</p>
</li>
<li><p>虚拟路由器标识：VRID(0-255)，唯一标识虚拟路由器</p>
</li>
<li><p>VIP：Virtual IP</p>
</li>
<li><p>VMAC：Virutal MAC (00-00-5e-00-01-VRID)</p>
</li>
<li><p>物理路由器：<br>master：主设备<br>backup：备用设备<br>priority：优先级</p>
<h5 id="1-5-7-3-VRRP-相关技术"><a href="#1-5-7-3-VRRP-相关技术" class="headerlink" title="1.5.7.3 VRRP 相关技术"></a>1.5.7.3 VRRP 相关技术</h5><p>通告：心跳，优先级等；周期性<br>工作方式：抢占式，非抢占式<br>安全认证：</p>
</li>
<li><p>无认证</p>
</li>
<li><p>简单字符认证：预共享密钥</p>
</li>
<li><p>MD5</p>
</li>
</ul>
<p>工作模式：</p>
<ul>
<li><p>主/备：单虚拟路径器</p>
</li>
<li><p> 主/主：主/备（虚拟路由器1），备/主（虚拟路由器2）</p>
</li>
</ul>
<h2 id="二、Keepalived-初步"><a href="#二、Keepalived-初步" class="headerlink" title="二、Keepalived 初步"></a>二、Keepalived 初步</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Keeplived/keepalived3.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-1-keepalived-介绍"><a href="#2-1-keepalived-介绍" class="headerlink" title="2.1 keepalived 介绍"></a>2.1 keepalived 介绍</h3><p>vrrp 协议的软件实现，原生设计目的为了高可用 ipvs服务<br>官网：<a target="_blank" rel="noopener" href="http://keepalived.org/">http://keepalived.org/</a><br>功能：</p>
<ul>
<li>基于vrrp协议完成地址流动</li>
<li>为vip地址所在的节点生成ipvs规则(在配置文件中预先定义)</li>
<li>为ipvs集群的各RS做健康状态检测</li>
<li>基于脚本调用接口完成脚本中定义的功能，进而影响集群事务，以此支持nginx、haproxy等服务</li>
</ul>
<h3 id="2-2-Keepalived-架构"><a href="#2-2-Keepalived-架构" class="headerlink" title="2.2 Keepalived 架构"></a>2.2 Keepalived 架构</h3><p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">https://keepalived.org/doc/<br>http://keepalived.org/documentation.html<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Keeplived/keepalived4.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li><p>用户空间核心组件：<br>vrrp stack：VIP消息通告<br>checkers：监测real server<br>system call：实现 vrrp 协议状态转换时调用脚本的功能</p>
<p>MTP：邮件组件<br>IPVS wrapper：生成IPVS规则<br>Netlink Reflector：网络接口<br>WatchDog：监控进程</p>
</li>
<li><p> 控制组件：提供keepalived.conf 的解析器，完成Keepalived配置</p>
</li>
<li><p> IO复用器：针对网络目的而优化的自己的线程抽象</p>
</li>
<li><p> 内存管理组件：为某些通用的内存管理功能（例如分配，重新分配，发布等）提供访问权限</p>
</li>
</ul>
<p><strong>Keepalived进程树</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">Keepalived &lt;-- Parent process monitoring children<br>\_ Keepalived &lt;-- VRRP child<br>\_ Keepalived &lt;-- Healthchecking child<br></code></pre></td></tr></table></figure>

<h3 id="2-3-Keepalived-环境准备"><a href="#2-3-Keepalived-环境准备" class="headerlink" title="2.3 Keepalived 环境准备"></a>2.3 Keepalived 环境准备</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Keeplived/keepalived5.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li>各节点时间必须同步：ntp, chrony</li>
<li>关闭防火墙及SELinux</li>
<li>各节点之间可通过主机名互相通信：非必须</li>
<li>建议使用/etc/hosts文件实现：非必须</li>
<li>各节点之间的root用户可以基于密钥认证的ssh服务完成互相通信：非必须</li>
</ul>
<table>
<thead>
<tr>
<th align="center">地址</th>
<th align="center">服务器名字</th>
<th align="center">安装的软件</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.0.0.6</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">10.0.0.8</td>
<td align="center">keepalived1</td>
<td align="center">keepalived</td>
</tr>
<tr>
<td align="center">10.0.0.18</td>
<td align="center">keepalived2</td>
<td align="center">keepalived</td>
</tr>
<tr>
<td align="center">10.0.0.7</td>
<td align="center">web1</td>
<td align="center">nginx</td>
</tr>
<tr>
<td align="center">10.0.0.17</td>
<td align="center">web2</td>
<td align="center">nginx</td>
</tr>
</tbody></table>
<h3 id="2-4-Keepalived-相关文件"><a href="#2-4-Keepalived-相关文件" class="headerlink" title="2.4 Keepalived 相关文件"></a>2.4 Keepalived 相关文件</h3><ul>
<li>软件包名：keepalived</li>
<li>主程序文件：/usr/sbin/keepalived</li>
<li>主配置文件：/etc/keepalived/keepalived.conf</li>
<li>配置文件示例：/usr/share/doc/keepalived/</li>
<li>Unit File：/lib/systemd/system/keepalived.service</li>
<li>Unit File的环境配置文件：<ul>
<li>/etc/sysconfig/keepalived CentOS</li>
<li>/etc/default/keepalived Ubuntu</li>
</ul>
</li>
</ul>
<p><strong>注意：CentOS 7 上有 bug，可能有下面情况出现</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">systemctl restart keepalived #新配置可能无法生效<br>systemctl stop keepalived;systemctl start keepalived #无法停止进程，需要kill 停止<br></code></pre></td></tr></table></figure>
<h3 id="2-5-Keepalived-安装"><a href="#2-5-Keepalived-安装" class="headerlink" title="2.5 Keepalived 安装"></a>2.5 Keepalived 安装</h3><h4 id="2-5-1-包安装"><a href="#2-5-1-包安装" class="headerlink" title="2.5.1 包安装"></a>2.5.1 包安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#CentOS</span><br>[root@centos ~]<span class="hljs-comment">#yum install keepalived -y</span><br><br><span class="hljs-comment">#ubuntu</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt -y install keepalived</span><br></code></pre></td></tr></table></figure>

<h5 id="2-5-1-1-CentOS-安装-keepalived"><a href="#2-5-1-1-CentOS-安装-keepalived" class="headerlink" title="2.5.1.1 CentOS 安装 keepalived"></a>2.5.1.1 CentOS 安装 keepalived</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#yum -y install keepalived</span><br>[root@centos8 ~]<span class="hljs-comment">#yum info keepalived</span><br>Last metadata expiration check: 0:00:24 ago on Thu 26 Mar 2020 07:28:36 PM CST.<br>Installed Packages<br>Name     : keepalived<br>Version   : 2.0.10<br>Release   : 4.el8_0.2<br>Architecture : x86_64<br>Size     : 1.4 M<br>Source    : keepalived-2.0.10-4.el8_0.2.src.rpm<br>Repository  : @System<br>From repo  : AppStream<br>Summary   : High Availability monitor built upon LVS, VRRP and service<br>pollers<br>URL     : http://www.keepalived.org/<br>License   : GPLv2+<br>Description : Keepalived provides simple and robust facilities <span class="hljs-keyword">for</span> load<br>balancing<br>      : and high availability to Linux system and Linux based<br>infrastructures.<br>      : The load balancing framework relies on well-known and widely used<br>      : Linux Virtual Server (IPVS) kernel module providing Layer4 load<br>      : balancing. Keepalived implements a <span class="hljs-built_in">set</span> of checkers to dynamically<br>and<br>      : adaptively maintain and manage load-balanced server pool<br>according<br>      : their health. High availability is achieved by VRRP protocol.<br>VRRP is<br>      : a fundamental brick <span class="hljs-keyword">for</span> router failover. In addition, keepalived<br>      : implements a <span class="hljs-built_in">set</span> of hooks to the VRRP finite state machine<br>providing<br>      : low-level and high-speed protocol interactions. Keepalived<br>frameworks<br>      : can be used independently or all together to provide resilient<br>      : infrastructures.<br><br>[root@centos8 ~]<span class="hljs-comment">#systemctl start keepalived.service</span><br>[root@centos8 ~]<span class="hljs-comment">#ps auxf |grep keepalived</span><br><br>root    12864  0.0  0.1  12108  1100 pts/0  S+  19:25  0:00     | <br>\_ grep --color=auto keepalive<br>root    12835  0.0  0.3  91444  2484 ?    Ss  19:24  0:00<br>/usr/sbin/keepalived -D<br>root    12836  0.0  0.5  91576  4212 ?    S   19:24  0:00 \_<br>/usr/sbin/keepalived -D<br>root    12837  0.0  0.5  91444  4620 ?    S   19:24  0:00 \_<br>/usr/sbin/keepalived -D<br><br>[root@centos8 ~]<span class="hljs-comment">#pstree -p</span><br>......<br>     ├─keepalived(12835)─┬─keepalived(12836)<br>     │          └─keepalived(12837)<br>......<br></code></pre></td></tr></table></figure>

<h5 id="2-5-1-2-Ubuntu-安装-keepalived"><a href="#2-5-1-2-Ubuntu-安装-keepalived" class="headerlink" title="2.5.1.2 Ubuntu 安装 keepalived"></a>2.5.1.2 Ubuntu 安装 keepalived</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#apt install keepalived -y</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#dpkg -s keepalived</span><br>Package: keepalived<br>Status: install ok installed<br>Priority: extra<br>Section: admin<br>Installed-Size: 824<br>Maintainer: Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;<br>Architecture: amd64<br>Version: 1:1.3.9-1ubuntu0.18.04.2<br>Depends: iproute2, libc6 (&gt;= 2.27), libglib2.0-0 (&gt;= 2.26.0), libip4tc0 (&gt;=<br>1.6.0+snapshot20161117), libip6tc0 (&gt;= 1.6.0+snapshot20161117), libnl-3-200 (&gt;=<br>3.2.27), libnl-genl-3-200 (&gt;= 3.2.7), libnl-route-3-200 (&gt;= 3.2.7), libsnmp30<br>(&gt;= 5.7.3+dfsg-1.8ubuntu3.1~dfsg), libssl1.1 (&gt;= 1.1.0), libxtables12 (&gt;=<br>1.6.0+snapshot20161117)<br>Recommends: ipvsadm<br>Conffiles:<br>/etc/dbus-1/system.d/org.keepalived.Vrrp1.conf 6b020ff46c6425d3a9cfa179814d7253<br>/etc/default/keepalived 6b2e3432e4ae31b444058ba2b0d1f06a<br>/etc/init.d/keepalived 0312972e0718331b4c90b3b98e623624<br>Description: Failover and monitoring daemon <span class="hljs-keyword">for</span> LVS clusters<br>keepalived is used <span class="hljs-keyword">for</span> monitoring real servers within a Linux<br>Virtual Server (LVS) cluster. keepalived can be configured to<br>remove real servers from the cluster pool <span class="hljs-keyword">if</span> it stops responding,<br>as well as send a notification email to make the admin aware of<br>the service failure.<br>.<br>In addition, keepalived implements an independent Virtual Router<br>Redundancy Protocol (VRRPv2; see rfc2338 <span class="hljs-keyword">for</span> additional info)<br>framework <span class="hljs-keyword">for</span> director failover.<br>.<br>You need a kernel &gt;= 2.4.28 or &gt;= 2.6.11 <span class="hljs-keyword">for</span> keepalived.<br>See README.Debian <span class="hljs-keyword">for</span> more information.<br>Homepage: http://keepalived.org<br>Original-Maintainer: Alexander Wirt &lt;formorer@debian.org&gt;<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#dpkg -L keepalived</span><br>/.<br>/etc<br>/etc/dbus-1<br>/etc/dbus-1/system.d<br>/etc/dbus-1/system.d/org.keepalived.Vrrp1.conf<br>/etc/default<br>/etc/default/keepalived<br>/etc/init.d<br>/etc/init.d/keepalived<br>/etc/keepalived<br>/lib<br>/lib/systemd<br>/lib/systemd/system<br>/lib/systemd/system/keepalived.service<br>/usr<br>/usr/bin<br>/usr/bin/genhash<br>/usr/sbin<br>/usr/sbin/keepalived<br>/usr/share<br>/usr/share/dbus-1<br>/usr/share/dbus-1/interfaces<br>/usr/share/dbus-1/interfaces/org.keepalived.Vrrp1.Instance.xml<br>/usr/share/dbus-1/interfaces/org.keepalived.Vrrp1.Vrrp.xml<br>/usr/share/doc<br>/usr/share/doc/keepalived<br>/usr/share/doc/keepalived/AUTHOR<br>/usr/share/doc/keepalived/CONTRIBUTORS<br>/usr/share/doc/keepalived/README<br>/usr/share/doc/keepalived/TODO<br>/usr/share/doc/keepalived/changelog.Debian.gz<br>/usr/share/doc/keepalived/copyright<br>/usr/share/doc/keepalived/keepalived.conf.SYNOPSIS.gz<br>/usr/share/doc/keepalived/samples<br>/usr/share/doc/keepalived/samples/client.pem<br>/usr/share/doc/keepalived/samples/dh1024.pem<br>/usr/share/doc/keepalived/samples/keepalived.conf.HTTP_GET.port<br>/usr/share/doc/keepalived/samples/keepalived.conf.IPv6<br>/usr/share/doc/keepalived/samples/keepalived.conf.SMTP_CHECK<br>/usr/share/doc/keepalived/samples/keepalived.conf.SSL_GET<br>/usr/share/doc/keepalived/samples/keepalived.conf.fwmark<br>/usr/share/doc/keepalived/samples/keepalived.conf.inhibit<br>/usr/share/doc/keepalived/samples/keepalived.conf.misc_check<br>/usr/share/doc/keepalived/samples/keepalived.conf.misc_check_arg<br>/usr/share/doc/keepalived/samples/keepalived.conf.quorum<br>/usr/share/doc/keepalived/samples/keepalived.conf.sample<br>/usr/share/doc/keepalived/samples/keepalived.conf.status_code<br>/usr/share/doc/keepalived/samples/keepalived.conf.track_interface<br>/usr/share/doc/keepalived/samples/keepalived.conf.virtual_server_group<br>/usr/share/doc/keepalived/samples/keepalived.conf.virtualhost<br>/usr/share/doc/keepalived/samples/keepalived.conf.vrrp<br>/usr/share/doc/keepalived/samples/keepalived.conf.vrrp.localcheck<br>/usr/share/doc/keepalived/samples/keepalived.conf.vrrp.lvs_syncd<br>/usr/share/doc/keepalived/samples/keepalived.conf.vrrp.routes<br>/usr/share/doc/keepalived/samples/keepalived.conf.vrrp.rules<br>/usr/share/doc/keepalived/samples/keepalived.conf.vrrp.scripts<br>/usr/share/doc/keepalived/samples/keepalived.conf.vrrp.static_ipaddress<br>/usr/share/doc/keepalived/samples/keepalived.conf.vrrp.sync<br>/usr/share/doc/keepalived/samples/root.pem<br>/usr/share/doc/keepalived/samples/sample.misccheck.smbcheck.sh<br>/usr/share/doc/keepalived/samples/sample_notify_fifo.sh<br>/usr/share/man<br>/usr/share/man/man1<br>/usr/share/man/man1/genhash.1.gz<br>/usr/share/man/man5<br>/usr/share/man/man5/keepalived.conf.5.gz<br>/usr/share/man/man8<br>/usr/share/man/man8/keepalived.8.gz<br>/usr/share/snmp<br>/usr/share/snmp/mibs<br>/usr/share/snmp/mibs/KEEPALIVED-MIB.txt<br>/usr/share/snmp/mibs/VRRP-MIB.txt<br>/usr/share/snmp/mibs/VRRPv3-MIB.txt<br>[root@ubuntu1804 ~]<span class="hljs-comment">#cp /usr/share/doc/keepalived/samples/keepalived.conf.sample</span><br>/etc/keepalived/keepalived.conf<br>[root@ubuntu1804 ~]<span class="hljs-comment">#systemctl start keepalived.service</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#systemctl status keepalived.service</span><br>● keepalived.service - Keepalive Daemon (LVS and VRRP)<br> Loaded: loaded (/lib/systemd/system/keepalived.service; enabled; vendor<br>preset: enabled)<br> Active: active (running) since Thu 2020-03-26 19:33:48 CST; 1min 9s ago<br>Process: 3208 ExecStart=/usr/sbin/keepalived <span class="hljs-variable">$DAEMON_ARGS</span> (code=exited,<br>status=0/SUCCESS)<br>Main PID: 3209 (keepalived)<br> Tasks: 3 (<span class="hljs-built_in">limit</span>: 1084)<br> CGroup: /system.slice/keepalived.service<br>     ├─3209 /usr/sbin/keepalived<br>     ├─3210 /usr/sbin/keepalived<br>     └─3211 /usr/sbin/keepalived<br>     <br>Mar 26 19:34:04 ubuntu1804.magedu.org Keepalived_healthcheckers[3210]: Timeout<br>connecting server [192.168.200.2]:tcp:1358.<br>Mar 26 19:34:10 ubuntu1804.magedu.org Keepalived_healthcheckers[3210]: Timeout<br>connecting server [192.168.200.2]:tcp:1358.<br>Mar 26 19:34:16 ubuntu1804.magedu.org Keepalived_healthcheckers[3210]: Timeout<br>connecting server [192.168.200.2]:tcp:1358.<br>Mar 26 19:34:16 ubuntu1804.magedu.org Keepalived_healthcheckers[3210]: Check on<br>service [192.168.200.2]:tcp:1358 failed after 3 retry.<br>Mar 26 19:34:16 ubuntu1804.magedu.org Keepalived_healthcheckers[3210]: Removing<br>service [192.168.200.2]:tcp:1358 to VS [10.10.10.2]:tc<br>Mar 26 19:34:16 ubuntu1804.magedu.org Keepalived_healthcheckers[3210]: Lost<br>quorum 1-0=1 &gt; 0 <span class="hljs-keyword">for</span> VS [10.10.10.2]:tcp:1358<br>Mar 26 19:34:16 ubuntu1804.magedu.org Keepalived_healthcheckers[3210]: Adding<br>sorry server [192.168.200.200]:tcp:1358 to VS [10.10.10.<br>Mar 26 19:34:16 ubuntu1804.magedu.org Keepalived_healthcheckers[3210]: Removing<br>alive servers from the pool <span class="hljs-keyword">for</span> VS [10.10.10.2]:tcp:13<br>Mar 26 19:34:16 ubuntu1804.magedu.org Keepalived_healthcheckers[3210]: Remote<br>SMTP server [192.168.200.1]:25 connected.<br>Mar 26 19:34:37 ubuntu1804.magedu.org Keepalived_healthcheckers[3210]: Error<br>reading data from remote SMTP server [192.168.200.1]:25.<br>[root@ubuntu1804 ~]<span class="hljs-comment">#ps auxf |grep keepalived</span><br>root    3224  0.0  0.1  14428  1040 pts/0  S+  19:34  0:00   |  \_<br>grep --color=auto keepalived<br>root    3209  0.0  0.3  91812  2996 ?    Ss  19:33  0:00<br>/usr/sbin/keepalived<br>root    3210  0.0  0.5  96100  5276 ?    S   19:33  0:00 \_<br>/usr/sbin/keepalived<br>root    3211  0.0  0.5  96152  5420 ?    S   19:33  0:00 \_<br>/usr/sbin/keepalived<br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-编译安装"><a href="#2-5-2-编译安装" class="headerlink" title="2.5.2 编译安装"></a>2.5.2 编译安装</h4><h5 id="2-5-2-1-centos编译安装keepalived"><a href="#2-5-2-1-centos编译安装keepalived" class="headerlink" title="2.5.2.1 centos编译安装keepalived"></a>2.5.2.1 centos编译安装keepalived</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#yum install gcc curl openssl-devel libnl3-devel net-snmp-devel</span><br><br>[root@centos7 ~]<span class="hljs-comment">#wget https://keepalived.org/software/keepalived-2.0.20.tar.gz</span><br><br>[root@centos7 ~]<span class="hljs-comment">#tar xvf keepalived-2.0.20.tar.gz -C /usr/local/src</span><br><br>[root@centos7 ~]<span class="hljs-comment">#cd /usr/local/src/keepalived-2.0.20/</span><br><span class="hljs-comment">#选项--disable-fwmark 可用于禁用iptables规则,可访止VIP无法访问,无此选项默认会启用ipatbles规则</span><br>[root@centos7 keepalived-2.0.20]<span class="hljs-comment">#./configure --prefix=/usr/local/keepalived #--disable-fwmark</span><br>[root@centos7 keepalived-2.0.20]<span class="hljs-comment">#make &amp;&amp; make install</span><br>[root@centos7 keepalived-2.0.20]<span class="hljs-comment">#cd</span><br>[root@centos7 ~]<span class="hljs-comment">#/usr/local/keepalived/sbin/keepalived -v</span><br>Keepalived v2.0.20 (01/22,2020)<br>Copyright(C) 2001-2020 Alexandre Cassen, &lt;acassen@gmail.com&gt;<br>Built with kernel headers <span class="hljs-keyword">for</span> Linux 3.10.0<br>Running on Linux 3.10.0-1062.el7.x86_64 <span class="hljs-comment">#1 SMP Wed Aug 7 18:08:02 UTC 2019</span><br>configure options: --prefix=/usr/<span class="hljs-built_in">local</span>/keepalived<br>Config options: LVS VRRP VRRP_AUTH OLD_CHKSUM_COMPAT FIB_ROUTING<br>System options: PIPE2 SIGNALFD INOTIFY_INIT1 VSYSLOG EPOLL_CREATE1<br>IPV6_ADVANCED_API LIBNL3 RTA_ENCAP RTA_EXPIRES RTA_PREF FRA_SUPPRESS_PREFIXLEN<br>FRA_TUN_ID RTAX_CC_ALGO RTAX_QUICKACK FRA_OIFNAME IFA_FLAGS IP_MULTICAST_ALL<br>NET_LINUX_IF_H_COLLISION LIBIPTC_LINUX_NET_IF_H_COLLISION LIBIPVS_NETLINK<br>VRRP_VMAC IFLA_LINK_NETNSID CN_PROC SOCK_NONBLOCK SOCK_CLOEXEC O_PATH GLOB_BRACE<br>INET6_ADDR_GEN_MODE SO_MARK SCHED_RESET_ON_FORK<br><br><span class="hljs-comment">#默认会自动生成unit文件</span><br>[root@centos7 ~]<span class="hljs-comment">#cat /usr/lib/systemd/system/keepalived.service</span><br>[Unit]<br>Description=LVS and VRRP High Availability Monitor<br>After=network-online.target syslog.target<br>Wants=network-online.target<br><br>[Service]<br>Type=forking<br>PIDFile=/run/keepalived.pid<br>KillMode=process<br>EnvironmentFile=-/usr/<span class="hljs-built_in">local</span>/keepalived/etc/sysconfig/keepalived<br>ExecStart=/usr/<span class="hljs-built_in">local</span>/keepalived/sbin/keepalived <span class="hljs-variable">$KEEPALIVED_OPTIONS</span><br>ExecReload=/bin/<span class="hljs-built_in">kill</span> -HUP <span class="hljs-variable">$MAINPID</span><br><br>[Install]<br>WantedBy=multi-user.target<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /usr/local/keepalived/etc/sysconfig/keepalived</span><br><span class="hljs-comment"># Options for keepalived. See `keepalived --help&#x27; output and keepalived(8) and</span><br><span class="hljs-comment"># keepalived.conf(5) man pages for a list of all options. Here are the most</span><br><span class="hljs-comment"># common ones :</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># --vrrp        -P  Only run with VRRP subsystem.</span><br><span class="hljs-comment"># --check       -C  Only run with Health-checker subsystem.</span><br><span class="hljs-comment"># --dont-release-vrrp -V  Dont remove VRRP VIPs &amp; VROUTEs on daemon stop.</span><br><span class="hljs-comment"># --dont-release-ipvs -I  Dont remove IPVS topology on daemon stop.</span><br><span class="hljs-comment"># --dump-conf     -d  Dump the configuration data.</span><br><span class="hljs-comment"># --log-detail     -D  Detailed log messages.</span><br><span class="hljs-comment"># --log-facility    -S  0-7 Set local syslog facility (default=LOG_DAEMON)</span><br><span class="hljs-comment">#</span><br><br>KEEPALIVED_OPTIONS=<span class="hljs-string">&quot;-D&quot;</span><br><br><span class="hljs-comment">#默认无法启动</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl start keepalived.service</span><br>Job <span class="hljs-keyword">for</span> keepalived.service failed because the control process exited with error<br>code. See <span class="hljs-string">&quot;systemctl status keepalived.service&quot;</span> and <span class="hljs-string">&quot;journalctl -xe&quot;</span> <span class="hljs-keyword">for</span><br>details.<br><br><span class="hljs-comment">#查看日志，可以看到是因为缺少配置文件导致无法启动</span><br>[root@centos7 ~]<span class="hljs-comment">#journalctl -xe</span><br>-- Subject: Unit keepalived.service has begun start-up<br>-- Defined-By: systemd<br>-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel<br>--<br>-- Unit keepalived.service has begun starting up.<br>Mar 29 00:38:17 centos7.magedu.org Keepalived[1123]: Starting Keepalived v2.0.20<br>(01/22,2020)<br>Mar 29 00:38:17 centos7.magedu.org Keepalived[1123]: Running on Linux 3.10.0-<br>1062.el7.x86_64 <span class="hljs-comment">#1 SMP Wed Aug 7</span><br>Mar 29 00:38:17 centos7.magedu.org Keepalived[1123]: Command line:<br><span class="hljs-string">&#x27;/usr/local/keepalived/sbin/keepalived&#x27;</span> <span class="hljs-string">&#x27;-D</span><br><span class="hljs-string">Mar 29 00:38:17 centos7.magedu.org Keepalived[1123]: Unable to find</span><br><span class="hljs-string">configuration file /etc/keepalived/keepali  #默认配置文件路径</span><br><span class="hljs-string">Mar 29 00:38:17 centos7.magedu.org Keepalived[1123]: Stopped Keepalived v2.0.20</span><br><span class="hljs-string">(01/22,2020)</span><br><span class="hljs-string">Mar 29 00:38:17 centos7.magedu.org systemd[1]: keepalived.service: control</span><br><span class="hljs-string">process exited, code=exited status=</span><br><span class="hljs-string">Mar 29 00:38:17 centos7.magedu.org systemd[1]: Failed to start LVS and VRRP High</span><br><span class="hljs-string">Availability Monitor.</span><br><span class="hljs-string">-- Subject: Unit keepalived.service has failed</span><br><span class="hljs-string">-- Defined-By: systemd</span><br><span class="hljs-string">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span><br><span class="hljs-string">--</span><br><span class="hljs-string">-- Unit keepalived.service has failed.</span><br><span class="hljs-string">--</span><br><span class="hljs-string">-- The result is failed.</span><br><span class="hljs-string">Mar 29 00:38:17 centos7.magedu.org systemd[1]: Unit keepalived.service entered</span><br><span class="hljs-string">failed state.</span><br><span class="hljs-string">Mar 29 00:38:17 centos7.magedu.org systemd[1]: keepalived.service failed.</span><br><span class="hljs-string">Mar 29 00:38:17 centos7.magedu.org polkitd[565]: Unregistered Authentication</span><br><span class="hljs-string">Agent for unix-process:1117:11546</span><br><span class="hljs-string"></span><br><span class="hljs-string">#创建配置文件</span><br><span class="hljs-string">[root@centos7 ~]#mkdir /etc/keepalived</span><br><span class="hljs-string">[root@centos7 ~]#cp /usr/local/keepalived/etc/keepalived/keepalived.conf</span><br><span class="hljs-string">/etc/keepalived</span><br><span class="hljs-string"></span><br><span class="hljs-string">#再次启动成功</span><br><span class="hljs-string">[root@centos7 ~]#systemctl enable --now keepalived.service</span><br><span class="hljs-string">Created symlink from /etc/systemd/system/multi-</span><br><span class="hljs-string">user.target.wants/keepalived.service to</span><br><span class="hljs-string">/usr/lib/systemd/system/keepalived.service.</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#systemctl status keepalived.service</span><br><span class="hljs-string">● keepalived.service - LVS and VRRP High Availability Monitor</span><br><span class="hljs-string"> Loaded: loaded (/usr/lib/systemd/system/keepalived.service; disabled; vendor</span><br><span class="hljs-string">preset: disabled)</span><br><span class="hljs-string"> Active: active (running) since Sun 2020-03-29 00:44:33 CST; 4s ago</span><br><span class="hljs-string">Process: 1191 ExecStart=/usr/local/keepalived/sbin/keepalived</span><br><span class="hljs-string">$KEEPALIVED_OPTIONS (code=exited, status=0/SUCCESS)</span><br><span class="hljs-string"> CGroup: /system.slice/keepalived.service</span><br><span class="hljs-string">     ├─1192 /usr/local/keepalived/sbin/keepalived -D</span><br><span class="hljs-string">     ├─1193 /usr/local/keepalived/sbin/keepalived -D</span><br><span class="hljs-string">     └─1194 /usr/local/keepalived/sbin/keepalived -D</span><br><span class="hljs-string">     </span><br><span class="hljs-string">Mar 29 00:44:37 centos7.magedu.org Keepalived_vrrp[1194]: Sending gratuitous ARP</span><br><span class="hljs-string">on eth0 for 192.168.200.18</span><br><span class="hljs-string">Mar 29 00:44:37 centos7.magedu.org Keepalived_vrrp[1194]: Sending gratuitous ARP</span><br><span class="hljs-string">on eth0 for 192.168.200.16</span><br><span class="hljs-string">Mar 29 00:44:37 centos7.magedu.org Keepalived_vrrp[1194]: Sending gratuitous ARP</span><br><span class="hljs-string">on eth0 for 192.168.200.17</span><br><span class="hljs-string">Mar 29 00:44:37 centos7.magedu.org Keepalived_vrrp[1194]: Sending gratuitous ARP</span><br><span class="hljs-string">on eth0 for 192.168.200.18</span><br><span class="hljs-string">Mar 29 00:44:37 centos7.magedu.org Keepalived_vrrp[1194]: Sending gratuitous ARP</span><br><span class="hljs-string">on eth0 for 192.168.200.16</span><br><span class="hljs-string">Mar 29 00:44:37 centos7.magedu.org Keepalived_vrrp[1194]: Sending gratuitous ARP</span><br><span class="hljs-string">on eth0 for 192.168.200.17</span><br><span class="hljs-string">Mar 29 00:44:37 centos7.magedu.org Keepalived_vrrp[1194]: Sending gratuitous ARP</span><br><span class="hljs-string">on eth0 for 192.168.200.18</span><br><span class="hljs-string">Mar 29 00:44:37 centos7.magedu.org Keepalived_vrrp[1194]: Sending gratuitous ARP</span><br><span class="hljs-string">on eth0 for 192.168.200.16</span><br><span class="hljs-string">Mar 29 00:44:37 centos7.magedu.org Keepalived_vrrp[1194]: Sending gratuitous ARP</span><br><span class="hljs-string">on eth0 for 192.168.200.17</span><br><span class="hljs-string">Mar 29 00:44:37 centos7.magedu.org Keepalived_vrrp[1194]: Sending gratuitous ARP</span><br><span class="hljs-string">on eth0 for 192.168.200.18</span><br><span class="hljs-string">[root@centos7 ~]#ip a</span><br><span class="hljs-string">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group</span><br><span class="hljs-string">default qlen 1000</span><br><span class="hljs-string"> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="hljs-string"> inet 127.0.0.1/8 scope host lo</span><br><span class="hljs-string">   valid_lft forever preferred_lft forever</span><br><span class="hljs-string"> inet6 ::1/128 scope host</span><br><span class="hljs-string">   valid_lft forever preferred_lft forever</span><br><span class="hljs-string">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP</span><br><span class="hljs-string">group default qlen 1000</span><br><span class="hljs-string"> link/ether 00:0c:29:32:80:38 brd ff:ff:ff:ff:ff:ff</span><br><span class="hljs-string"> inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="hljs-string">   valid_lft forever preferred_lft forever</span><br><span class="hljs-string"> inet 192.168.200.16/32 scope global eth0</span><br><span class="hljs-string">   valid_lft forever preferred_lft forever</span><br><span class="hljs-string"> inet 192.168.200.17/32 scope global eth0</span><br><span class="hljs-string">   valid_lft forever preferred_lft forever</span><br><span class="hljs-string">   inet 192.168.200.18/32 scope global eth0</span><br><span class="hljs-string">   valid_lft forever preferred_lft forever</span><br><span class="hljs-string"> inet6 fe80::20c:29ff:fe32:8038/64 scope link</span><br><span class="hljs-string">   valid_lft forever preferred_lft forever</span><br><span class="hljs-string">   </span><br><span class="hljs-string">[root@centos7 ~]#hostname -I</span><br><span class="hljs-string">10.0.0.7 192.168.200.16 192.168.200.17 192.168.200.18</span><br><span class="hljs-string">[root@centos7 ~]#ping 192.168.200.16</span><br><span class="hljs-string">PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.</span><br><span class="hljs-string">ping: sendmsg: Operation not permitted</span><br><span class="hljs-string">ping: sendmsg: Operation not permitted</span><br><span class="hljs-string">^C</span><br><span class="hljs-string">--- 192.168.200.16 ping statistics ---</span><br><span class="hljs-string">2 packets transmitted, 0 received, 100% packet loss, time 1000ms</span><br><span class="hljs-string"></span><br><span class="hljs-string">#默认生成iptables规则,无法访问VIP,编译时可以加--disable-fwmark禁用生成iptables规则</span><br><span class="hljs-string">[root@centos7 ~]#iptables -vnL</span><br><span class="hljs-string">Chain INPUT (policy ACCEPT 860 packets, 46129 bytes)</span><br><span class="hljs-string">pkts bytes target   prot opt in   out   source        destination</span><br><span class="hljs-string">   </span><br><span class="hljs-string">  0   0 DROP    all  -- *   *    0.0.0.0/0     </span><br><span class="hljs-string"> 192.168.200.18   </span><br><span class="hljs-string">  0   0 DROP    all  -- *   *    0.0.0.0/0     </span><br><span class="hljs-string"> 192.168.200.17   </span><br><span class="hljs-string">  0   0 DROP    all  -- *   *    0.0.0.0/0     </span><br><span class="hljs-string"> 192.168.200.16   </span><br><span class="hljs-string"></span><br><span class="hljs-string">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="hljs-string">pkts bytes target   prot opt in   out   source        destination</span><br><span class="hljs-string"></span><br><span class="hljs-string">Chain OUTPUT (policy ACCEPT 1737 packets, 1188K bytes)</span><br><span class="hljs-string">pkts bytes target   prot opt in   out   source        destination</span><br><span class="hljs-string">   </span><br><span class="hljs-string">  4  336 DROP    all  -- *   *    192.168.200.18    0.0.0.0/0 </span><br><span class="hljs-string">   </span><br><span class="hljs-string">  0   0 DROP    all  -- *   *    192.168.200.17    0.0.0.0/0 </span><br><span class="hljs-string">   </span><br><span class="hljs-string">  0   0 DROP    all  -- *   *    192.168.200.16    0.0.0.0/0 </span><br><span class="hljs-string">  </span><br><span class="hljs-string">[root@centos7 ~]#vim /etc/keepalived/keepalived.conf</span><br><span class="hljs-string">#注释下面一行</span><br><span class="hljs-string">#vrrp_strict</span><br><span class="hljs-string"></span><br><span class="hljs-string">#重启动不生效，有bug</span><br><span class="hljs-string">[root@centos7 ~]#systemctl restart keepalived.service</span><br><span class="hljs-string">[root@centos7 ~]#ping 192.168.200.16</span><br><span class="hljs-string">PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.</span><br><span class="hljs-string">ping: sendmsg: Operation not permitted</span><br><span class="hljs-string">ping: sendmsg: Operation not permitted</span><br><span class="hljs-string">^C</span><br><span class="hljs-string">--- 192.168.200.16 ping statistics ---</span><br><span class="hljs-string">2 packets transmitted, 0 received, 100% packet loss, time 999ms</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#iptables -vnL</span><br><span class="hljs-string">Chain INPUT (policy ACCEPT 1219 packets, 67647 bytes)</span><br><span class="hljs-string">pkts bytes target   prot opt in   out   source        destination</span><br><span class="hljs-string">0   0 DROP    all  -- *   *    0.0.0.0/0     </span><br><span class="hljs-string"> 192.168.200.18   </span><br><span class="hljs-string">  0   0 DROP    all  -- *   *    0.0.0.0/0     </span><br><span class="hljs-string"> 192.168.200.17   </span><br><span class="hljs-string">  0   0 DROP    all  -- *   *    0.0.0.0/0     </span><br><span class="hljs-string"> 192.168.200.16  </span><br><span class="hljs-string"> </span><br><span class="hljs-string">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="hljs-string">pkts bytes target   prot opt in   out   source        destination</span><br><span class="hljs-string"></span><br><span class="hljs-string">Chain OUTPUT (policy ACCEPT 2282 packets, 1233K bytes)</span><br><span class="hljs-string">pkts bytes target   prot opt in   out   source        destination</span><br><span class="hljs-string">   </span><br><span class="hljs-string">  4  336 DROP    all  -- *   *    192.168.200.18    0.0.0.0/0 </span><br><span class="hljs-string">   </span><br><span class="hljs-string">  0   0 DROP    all  -- *   *    192.168.200.17    0.0.0.0/0 </span><br><span class="hljs-string">   </span><br><span class="hljs-string">  4  336 DROP    all  -- *   *    192.168.200.16    0.0.0.0/0 </span><br><span class="hljs-string">  </span><br><span class="hljs-string">#无法关闭进程</span><br><span class="hljs-string">[root@centos7 ~]#systemctl stop keepalived.service</span><br><span class="hljs-string">[root@centos7 ~]#ps aux|grep keepalived</span><br><span class="hljs-string">root    1383  0.0  0.1  69672  1020 ?    Ss  00:57  0:00</span><br><span class="hljs-string">/usr/local/keepalived/sbin/keepalived -D</span><br><span class="hljs-string">root    1384  0.0  0.2  69804  2308 ?    S   00:57  0:00</span><br><span class="hljs-string">/usr/local/keepalived/sbin/keepalived -D</span><br><span class="hljs-string">root    1385  0.0  0.1  69672  1308 ?    S   00:57  0:00</span><br><span class="hljs-string">/usr/local/keepalived/sbin/keepalived -D</span><br><span class="hljs-string">root    1392  0.0  0.0 112712  964 pts/0  R+  00:59  0:00 grep --</span><br><span class="hljs-string">color=auto keepalived</span><br><span class="hljs-string"></span><br><span class="hljs-string">root@centos7 ~]#killall keepalived</span><br><span class="hljs-string">[root@centos7 ~]#systemctl start keepalived.service</span><br><span class="hljs-string">[root@centos7 ~]#ping 192.168.200.16</span><br><span class="hljs-string">PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.</span><br><span class="hljs-string">64 bytes from 192.168.200.16: icmp_seq=1 ttl=64 time=0.093 ms</span><br><span class="hljs-string">^C</span><br><span class="hljs-string">--- 192.168.200.16 ping statistics ---</span><br><span class="hljs-string">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="hljs-string">rtt min/avg/max/mdev = 0.093/0.093/0.093/0.000 ms</span><br><span class="hljs-string">[root@centos7 ~]#iptables -vnL</span><br><span class="hljs-string">Chain INPUT (policy ACCEPT 125 packets, 8493 bytes)</span><br><span class="hljs-string">pkts bytes target   prot opt in   out   source        destination</span><br><span class="hljs-string"></span><br><span class="hljs-string">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="hljs-string">pkts bytes target   prot opt in   out   source        destination</span><br><span class="hljs-string"></span><br><span class="hljs-string">Chain OUTPUT (policy ACCEPT 135 packets, 20190 bytes)</span><br><span class="hljs-string">pkts bytes target   prot opt in   out   source        destination</span><br></code></pre></td></tr></table></figure>

<h5 id="2-5-2-2-ubuntu编译安装keepalived"><a href="#2-5-2-2-ubuntu编译安装keepalived" class="headerlink" title="2.5.2.2 ubuntu编译安装keepalived"></a>2.5.2.2 ubuntu编译安装keepalived</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装环境准备</span><br>root@ubuntu1804:~<span class="hljs-comment"># apt install -y libssl-dev libpopt-dev daemon build-essential libssl-dev openssl libpopt-dev make</span><br><br><span class="hljs-comment">#下载编译安装包</span><br>root@ubuntu1804:~<span class="hljs-comment"># wget https://keepalived.org/software/keepalived-2.0.20.tar.gz</span><br><br><span class="hljs-comment">#编译安装</span><br>root@ubuntu1804:~<span class="hljs-comment"># tar xf keepalived-2.0.20.tar.gz -C /usr/local/src</span><br>root@ubuntu1804:~<span class="hljs-comment"># cd /usr/local/src/keepalived-2.0.20/</span><br><span class="hljs-comment">#选项--disable-fwmark 可用于禁用iptables规则,可访止VIP无法访问,无此选项默认会启用ipatbles规则</span><br>root@ubuntu1804:/usr/<span class="hljs-built_in">local</span>/src/keepalived-2.0.20<span class="hljs-comment"># ./configure --prefix=/usr/local/keepalived </span><br><span class="hljs-comment">#--disable-fwmark</span><br>root@ubuntu1804:/usr/<span class="hljs-built_in">local</span>/src/keepalived-2.0.20<span class="hljs-comment"># make &amp;&amp; make install</span><br><span class="hljs-comment">#查看编译安装版本</span><br>root@ubuntu1804:/usr/<span class="hljs-built_in">local</span>/src/keepalived-2.0.20<span class="hljs-comment"># cd</span><br>root@ubuntu1804:~<span class="hljs-comment"># /usr/local/keepalived/sbin/keepalived -v</span><br>Keepalived v2.0.20 (01/22,2020)<br><br>Copyright(C) 2001-2020 Alexandre Cassen, &lt;acassen@gmail.com&gt;<br><br>Built with kernel headers <span class="hljs-keyword">for</span> Linux 4.15.18<br>Running on Linux 4.15.0-55-generic <span class="hljs-comment">#60-Ubuntu SMP Tue Jul 2 18:22:20 UTC 2019</span><br><br>configure options: --prefix=/usr/<span class="hljs-built_in">local</span>/keepalived<br><br>Config options:  LVS VRRP VRRP_AUTH OLD_CHKSUM_COMPAT FIB_ROUTING<br><br>System options:  PIPE2 SIGNALFD INOTIFY_INIT1 VSYSLOG EPOLL_CREATE1 IPV4_DEVCONF IPV6_ADVANCED_API RTA_ENCAP RTA_EXPIRES RTA_NEWDST RTA_PREF FRA_SUPPRESS_PREFIXLEN FRA_SUPPRESS_IFGROUP FRA_TUN_ID RTAX_CC_ALGO RTAX_QUICKACK RTEXT_FILTER_SKIP_STATS FRA_L3MDEV FRA_UID_RANGE RTAX_FASTOPEN_NO_COOKIE RTA_VIA FRA_OIFNAME RTA_TTL_PROPAGATE IFA_FLAGS IP_MULTICAST_ALL LWTUNNEL_ENCAP_MPLS LWTUNNEL_ENCAP_ILA NET_LINUX_IF_H_COLLISION LIBIPTC_LINUX_NET_IF_H_COLLISION IPVS_DEST_ATTR_ADDR_FAMILY IPVS_SYNCD_ATTRIBUTES IPVS_64BIT_STATS VRRP_VMAC VRRP_IPVLAN IFLA_LINK_NETNSID CN_PROC SOCK_NONBLOCK SOCK_CLOEXEC O_PATH GLOB_BRACE INET6_ADDR_GEN_MODE VRF SO_MARK SCHED_RESET_ON_FORK<br><br><span class="hljs-comment">#守护进程和开机启动</span><br>root@ubuntu1804:/usr/<span class="hljs-built_in">local</span>/src/keepalived-2.0.20<span class="hljs-comment"># mkdir /etc/keepalived</span><br>root@ubuntu1804:/usr/<span class="hljs-built_in">local</span>/src/keepalived-2.0.20<span class="hljs-comment"># ln -sv /usr/local/keepalived/sbin/keepalived /usr/sbin/</span><br><span class="hljs-string">&#x27;/usr/sbin/keepalived&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/keepalived/sbin/keepalived&#x27;</span><br>root@ubuntu1804:/usr/<span class="hljs-built_in">local</span>/src/keepalived-2.0.20<span class="hljs-comment"># ln -sv /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf</span><br><span class="hljs-string">&#x27;/etc/keepalived/keepalived.conf&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/keepalived/etc/keepalived/keepalived.conf&#x27;</span><br>root@ubuntu1804:/usr/<span class="hljs-built_in">local</span>/src/keepalived-2.0.20<span class="hljs-comment"># ln -sv /usr/local/keepalived/etc/sysconfig/keepalived /etc/default/keepalived</span><br><span class="hljs-string">&#x27;/etc/default/keepalived&#x27;</span> -&gt; <span class="hljs-string">&#x27;/usr/local/keepalived/etc/sysconfig/keepalived&#x27;</span><br><br>root@ubuntu1804:~<span class="hljs-comment"># cp keepalived.service /lib/systemd/system/keepalived.service</span><br>root@ubuntu1804:~<span class="hljs-comment"># ln -s /lib/systemd/system/keepalived.service /etc/systemd/system/multi-user.target.wants/keepalived.service</span><br><br><span class="hljs-comment">#默认生成iptables规则,无法访问VIP,编译时可以加--disable-fwmark禁用生成iptables规则</span><br>root@ubuntu1804:~<span class="hljs-comment"># cd /etc/keepalived/</span><br>root@ubuntu1804:/etc/keepalived<span class="hljs-comment"># vim keepalived.conf</span><br>root@ubuntu1804:/etc/keepalived<span class="hljs-comment"># systemctl start keepalived</span><br>root@ubuntu1804:/etc/keepalived<span class="hljs-comment"># systemctl enable keepalived</span><br>root@ubuntu1804:/etc/keepalived<span class="hljs-comment"># iptables -vnL</span><br>Chain INPUT (policy ACCEPT 479 packets, 24436 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain OUTPUT (policy ACCEPT 889 packets, 56896 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination<br><br><br>root@ubuntu1804:/etc/keepalived<span class="hljs-comment"># ping 192.168.200.18</span><br>PING 192.168.200.18 (192.168.200.18) 56(84) bytes of data.<br>64 bytes from 192.168.200.18: icmp_seq=1 ttl=64 time=0.066 ms<br>64 bytes from 192.168.200.18: icmp_seq=2 ttl=64 time=0.045 ms<br>^C<br>--- 192.168.200.18 ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1001ms<br>rtt min/avg/max/mdev = 0.045/0.055/0.066/0.012 ms<br><br>root@ubuntu1804:/etc/keepalived<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:40:c8:67 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.101/16 brd 10.0.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet 192.168.200.16/32 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet 192.168.200.17/32 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet 192.168.200.18/32 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe40:c867/64 scope link <br>       valid_lft forever preferred_lft forever<br><br></code></pre></td></tr></table></figure>

<h4 id="2-5-3-web服务器配置"><a href="#2-5-3-web服务器配置" class="headerlink" title="2.5.3 web服务器配置"></a>2.5.3 web服务器配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#关闭防火墙，selinux</span><br>[root@web1 ~]<span class="hljs-comment"># yum install -y nginx;systemctl enable --now;web 10.0.0.7 &gt; /usr/share/nginx/html/index.html</span><br>[root@web2 ~]<span class="hljs-comment"># yum install -y nginx;systemctl enable --now;web 10.0.0.17 &gt; /usr/share/nginx/html/index.html</span><br></code></pre></td></tr></table></figure>

<h3 id="2-6-KeepAlived-配置说明"><a href="#2-6-KeepAlived-配置说明" class="headerlink" title="2.6 KeepAlived 配置说明"></a>2.6 KeepAlived 配置说明</h3><h4 id="2-6-1-配置文件组成部分"><a href="#2-6-1-配置文件组成部分" class="headerlink" title="2.6.1 配置文件组成部分"></a>2.6.1 配置文件组成部分</h4><p>/etc/keepalived/keepalived.conf 配置组成</p>
<ul>
<li>GLOBAL CONFIGURATION<br>Global definitions：定义邮件配置，route_id，vrrp配置，多播地址等</li>
<li>VRRP CONFIGURATION<br>VRRP instance(s)：定义每个vrrp虚拟路由器</li>
<li>LVS CONFIGURATION<br>Virtual server group(s)<br>Virtual server(s)：LVS集群的VS和RS</li>
</ul>
<h4 id="2-6-2-配置语法说明"><a href="#2-6-2-配置语法说明" class="headerlink" title="2.6.2 配置语法说明"></a>2.6.2 配置语法说明</h4><p>帮助</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">man keepalived.conf<br></code></pre></td></tr></table></figure>

<h5 id="2-6-2-1-全局配置"><a href="#2-6-2-1-全局配置" class="headerlink" title="2.6.2.1 全局配置"></a>2.6.2.1 全局配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#/etc/keepalived/keepalived.conf</span><br>global_defs &#123;<br>notification_email &#123;<br>root@localhost <span class="hljs-comment">#keepalived 发生故障切换时邮件发送的目标邮箱，可以按行区分写多个</span><br>root@wangxiaochun.com<br> 29308620@qq.com<br>&#125;<br>notification_email_from keepalived@localhost  <span class="hljs-comment">#发邮件的地址</span><br>smtp_server 127.0.0.1   <span class="hljs-comment">#邮件服务器地址</span><br>smtp_connect_timeout 30  <span class="hljs-comment">#邮件服务器连接timeout</span><br>router_id ka1.example.com <span class="hljs-comment">#每个keepalived主机唯一标识，建议使用当前主机名，但多节点重名不影响</span><br>vrrp_skip_check_adv_addr  <span class="hljs-comment">#对所有通告报文都检查，会比较消耗性能，启用此配置后，如果收到的通告报文和上一个报文是同一个路由器，则跳过检查，默认值为全检查</span><br>vrrp_strict <span class="hljs-comment">#严格遵守VRRP协议,启用此项后以下状况将无法启动服务:1.无VIP地址 2.配置了单播邻居 3.在VRRP版本2中有IPv6地址，开启动此项并且没有配置vrrp_iptables时会自动开启iptables防火墙规则，默认导致VIP无法访问,建议不加此项配置</span><br>vrrp_garp_interval 0 <span class="hljs-comment">#gratuitous ARP messages 报文发送延迟，0表示不延迟</span><br>vrrp_gna_interval 0  <span class="hljs-comment">#unsolicited NA messages （不请自来）消息发送延迟</span><br>vrrp_mcast_group4 224.0.0.18 <span class="hljs-comment">#指定组播IP地址范围：224.0.0.0到239.255.255.255,默认值：224.0.0.18。如果有多个keepalived集群应该用不同的组播地址。</span><br>vrrp_iptables     <span class="hljs-comment">#此项和vrrp_strict同时开启时，则不会添加防火墙规则,如果无配置vrrp_strict项,则无需启用此项配置，此项默认没有出现在配置文件上，也不开启</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="2-6-2-2-配置虚拟路由器"><a href="#2-6-2-2-配置虚拟路由器" class="headerlink" title="2.6.2.2 配置虚拟路由器"></a>2.6.2.2 配置虚拟路由器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">vrrp_instance &lt;STRING&gt; &#123; <span class="hljs-comment">#&lt;String&gt;为vrrp的实例名,一般为业务名称</span><br><span class="hljs-comment">#配置参数</span><br>......<br>&#125;<br><br><span class="hljs-comment">#配置参数：</span><br>state MASTER|BACKUP<span class="hljs-comment">#当前节点在此虚拟路由器上的初始状态，状态为MASTER或者BACKUP</span><br>interface IFACE_NAME <span class="hljs-comment">#绑定为当前虚拟路由器使用的物理接口，如：eth0,bond0,br0,可以和VIP不在一个网卡</span><br><br>virtual_router_id VRID <span class="hljs-comment">#每个虚拟路由器惟一标识，范围：0-255，每个虚拟路由器此值必须唯一，否则服务无法启动，同属一个虚拟路由器的多个keepalived节点必须相同,务必要确认在同一网络中此值必须唯一</span><br><br>priority 100 <span class="hljs-comment">#当前物理节点在此虚拟路由器的优先级，范围：1-254，每个keepalived主机节点此值不同，数字越大优先级越高</span><br>advert_int 1 <span class="hljs-comment">#vrrp通告的时间间隔，默认1s</span><br>authentication &#123; <span class="hljs-comment">#认证机制</span><br>    auth_type AH|PASS  <span class="hljs-comment">#AH为IPSEC认证(不推荐),PASS为简单密码(建议使用)</span><br>    auth_pass &lt;PASSWORD&gt; <span class="hljs-comment">#预共享密钥，仅前8位有效，同一个虚拟路由器的多个keepalived节点必须一样</span><br>&#125;<br>virtual_ipaddress &#123; <span class="hljs-comment">#虚拟IP,生产环境可能指定上百个IP地址</span><br>    &lt;IPADDR&gt;/&lt;MASK&gt; brd &lt;IPADDR&gt; dev &lt;STRING&gt; scope &lt;SCOPE&gt; label &lt;LABEL&gt;<br>    192.168.200.100 <span class="hljs-comment">#指定VIP，不指定网卡，默认为eth0,注意：不指定/prefix,默认为/32</span><br>    192.168.200.101/24 dev eth1  <span class="hljs-comment">#指定VIP的网卡，建议和interface指令指定的岗卡不在一个网卡</span><br>    192.168.200.102/24 dev eth2 label eth2:1 <span class="hljs-comment">#指定VIP的网卡label</span><br>&#125;<br>track_interface &#123; <span class="hljs-comment">#配置监控网络接口，一旦出现故障，则转为FAULT状态实现地址转移</span><br>   eth0<br>   eth1<br>   …<br>&#125;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br> notification_email &#123;<br>  acassen@firewall.loc<br>  failover@firewall.loc<br>  sysadmin@firewall.loc<br> &#125;<br>  notification_email_from Alexandre.Cassen@firewall.loc<br>  smtp_server 192.168.200.1<br>  smtp_connect_timeout 30<br>  router_id LVS_DEVEL<br>  vrrp_skip_check_adv_addr<br>  vrrp_strict <span class="hljs-comment">#开启限制，会自动生效防火墙设置，导致无访问VIP</span><br>  vrrp_garp_interval 0<br> &#125;<br> vrrp_instance VI_1 &#123;<br> state MASTER<br> interface eth0<br> virtual_router_id 80 <span class="hljs-comment">#修改此行</span><br> priority 100<br> advert_int 1<br> authentication &#123;<br>   auth_type PASS<br>   auth_pass 1111<br> &#125;<br> virtual_ipaddress &#123;<br>    192.168.200.16<br>    192.168.200.17<br>    192.168.200.18<br> &#125;<br>&#125;<br>[root@centos7 ~]<span class="hljs-comment">#systemctl start keepalived.service</span><br>[root@centos7 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP<br>group default qlen 1000<br> link/ether 00:0c:29:33:b4:1a brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.17/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet 192.168.200.16/32 scope global eth0<br>   valid_lft forever preferred_lft forever<br> inet 192.168.200.17/32 scope global eth0<br>   valid_lft forever preferred_lft forever<br> inet 192.168.200.18/32 scope global eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe33:b41a/64 scope link<br>   valid_lft forever preferred_lft forever<br><br>[root@centos7 ~]<span class="hljs-comment">#iptables -vnL</span><br>Chain INPUT (policy ACCEPT 59 packets, 3372 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br>   <br>  0   0 DROP    all  -- *   *    0.0.0.0/0     <br> 192.168.200.16   <br>  0   0 DROP    all  -- *   *    0.0.0.0/0     <br> 192.168.200.17   <br>  0   0 DROP    all  -- *   *    0.0.0.0/0     <br> 192.168.200.18 <br> <br> Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br><br>Chain OUTPUT (policy ACCEPT 33 packets, 6940 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br><br>[root@centos7 ~]<span class="hljs-comment">#ping 192.168.200.16</span><br>PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.<br>^C<br>--- 192.168.200.16 ping statistics ---<br>6 packets transmitted, 0 received, 100% packet loss, time 5002ms<br><br><span class="hljs-comment"># 如果是CentOS 8 ，会显示以下warning</span><br>[root@centos8 ~]<span class="hljs-comment">#iptables -vnL</span><br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br><br>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br>   <br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br><br><span class="hljs-comment"># Warning: iptables-legacy tables present, use iptables-legacy to see them</span><br><br><span class="hljs-comment">#无法访问VIP</span><br>[root@centos8 ~]<span class="hljs-comment">#ping 192.168.200.16</span><br>PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.<br>^C<br>--- 192.168.200.16 ping statistics ---<br>6 packets transmitted, 0 received, 100% packet loss, time 143ms<br></code></pre></td></tr></table></figure>

<h5 id="2-6-2-3-启用keepalived日志功能"><a href="#2-6-2-3-启用keepalived日志功能" class="headerlink" title="2.6.2.3 启用keepalived日志功能"></a>2.6.2.3 启用keepalived日志功能</h5><p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#如要开启日志功能，那所有安装了keepalived的服务器都需要开启</span><br>[root@ka1 ~]<span class="hljs-comment">#vim /etc/sysconfig/keepalived</span><br>KEEPALIVED_OPTIONS=<span class="hljs-string">&quot;-D -S 6&quot;</span><br><br>[root@ka1 ~]<span class="hljs-comment">#vim /etc/rsyslog.conf</span><br>local6.*                        /var/<span class="hljs-built_in">log</span>/keepalived.log<br><br>[root@ka1 ~]<span class="hljs-comment">#systemctl restart keepalived.service rsyslog.service</span><br><br>[root@ka1 ~]<span class="hljs-comment">#tail -f /var/log/keepalived.log</span><br>Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="hljs-keyword">for</span><br>10.0.0.10<br>Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="hljs-keyword">for</span><br>10.0.0.10<br>Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="hljs-keyword">for</span><br>10.0.0.10<br>Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="hljs-keyword">for</span><br>10.0.0.10<br>Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="hljs-keyword">for</span><br>10.0.0.10<br>Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: (VI_1) Sending/queueing gratuitous<br>ARPs on eth0 <span class="hljs-keyword">for</span> 10.0.0.10<br>Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="hljs-keyword">for</span><br>10.0.0.10<br>Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="hljs-keyword">for</span><br>10.0.0.10<br>Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="hljs-keyword">for</span><br>10.0.0.10<br>Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="hljs-keyword">for</span><br>10.0.0.10<br></code></pre></td></tr></table></figure>

<h5 id="2-6-2-4-实现独立子配置文件"><a href="#2-6-2-4-实现独立子配置文件" class="headerlink" title="2.6.2.4 实现独立子配置文件"></a>2.6.2.4 实现独立子配置文件</h5><p>当生产环境复杂时， /etc/keepalived/keepalived.conf 文件中内容过多，不易管理，可以将不同集<br>群的配置，比如：不同集群的VIP配置放在独立的子配置文件中<br>利用include 指令可以实现包含子配置文件<br>格式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">include /path/file<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ka1-centos8 ~]<span class="hljs-comment">#mkdir /etc/keepalived/conf.d/</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#vim /etc/keepalived/keepalived.conf</span><br>global_defs &#123;<br> notification_email &#123;<br>    29308620@qq.com<br> &#125;<br> notification_email_from 29308620@qq.com<br> smtp_server 127.0.0.1<br> smtp_connect_timeout 30<br> router_id ka1.magedu.org<br> vrrp_skip_check_adv_addr<br> vrrp_garp_interval 0<br> vrrp_gna_interval 0<br>&#125;<br>include /etc/keepalived/conf.d/*.conf  <span class="hljs-comment">#将VRRP相关配置放在子配置文件中</span><br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#vim /etc/keepalived/conf.d/cluster1.conf</span><br></code></pre></td></tr></table></figure>

<h5 id="2-6-2-5-实现浮动的ip"><a href="#2-6-2-5-实现浮动的ip" class="headerlink" title="2.6.2.5 实现浮动的ip"></a>2.6.2.5 实现浮动的ip</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@keepalived1 keepalived]<span class="hljs-comment"># vim keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>      root@localhost <span class="hljs-comment">#keepalived 发生故障切换时邮件发送的对象，可以按行区分写多个</span><br>   &#125;<br>   notification_email_from Alexandre.Cassen@firewall.loc<br>   smtp_server 127.0.0.1<br>   smtp_connect_timeout 30<br>   router_id ka1.rlin.com<br>   vrrp_skip_check_adv_addr <span class="hljs-comment">#所有报文都检查比较消耗性能，此配置为如果收到的报文和上一个报文是同一个路由器则跳过检查报文中的源地址</span><br>   <span class="hljs-comment">#vrrp_strict #严格遵守VRRP协议,禁止状况:1.无VIP地址,2.配置了单播邻居,3.在VRRP版本2中有IPv6地址</span><br>   vrrp_garp_interval 0 <span class="hljs-comment">#ARP报文发送延迟</span><br>   vrrp_gna_interval 0 <span class="hljs-comment">#消息发送延迟</span><br>   vrrp_mcast_group4 224.0.0.18 <span class="hljs-comment">#默认组播IP地址，可指定组播范围：224.0.0.0到239.255.255.255</span><br>&#125;<br><br>vrrp_instance web &#123;<br>    state MASTER <span class="hljs-comment">#在另一个结点上为BACKUP</span><br>    interface eth0<br>    virtual_router_id 51 <span class="hljs-comment">#每个虚拟路由器必须唯一，同属一个虚拟路由器的多个keepalived节点必须相同</span><br>    priority 100 <span class="hljs-comment">#在另一个结点上为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS <span class="hljs-comment">#预共享密钥认证，同一个虚拟路由器的keepalived节点必须一样</span><br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>&#125;<br><br>[root@keepalived2 keepalived]<span class="hljs-comment"># vim keepalived.conf </span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>      root@localhost<br>   &#125;<br>   notification_email_from Alexandre.Cassen@firewall.loc<br>   smtp_server 127.0.0.1<br>   smtp_connect_timeout 30<br>   router_id ka2.rlin.com<br>   vrrp_skip_check_adv_addr<br>   <span class="hljs-comment">#vrrp_strict #修改此行</span><br>   vrrp_garp_interval 0<br>   vrrp_gna_interval 0<br>   vrrp_mcast_group4 224.0.0.18<br>&#125;<br><br>vrrp_instance web &#123;<br>    state BACKUP <span class="hljs-comment">#修改此行</span><br>    interface eth0<br>    virtual_router_id 51<br>    priority 80 <span class="hljs-comment">#修改此行</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#开启keepalived</span><br></code></pre></td></tr></table></figure>



<h2 id="三、Keepalived-企业应用"><a href="#三、Keepalived-企业应用" class="headerlink" title="三、Keepalived 企业应用"></a>三、Keepalived 企业应用</h2><h3 id="3-1-实现master-slave的-Keepalived-单主架构"><a href="#3-1-实现master-slave的-Keepalived-单主架构" class="headerlink" title="3.1 实现master/slave的 Keepalived 单主架构"></a>3.1 实现master/slave的 Keepalived 单主架构</h3><h4 id="3-1-1-MASTER配置"><a href="#3-1-1-MASTER配置" class="headerlink" title="3.1.1 MASTER配置"></a>3.1.1 MASTER配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@keepalived1 keepalived]<span class="hljs-comment"># vim keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>      root@localhost <span class="hljs-comment">#keepalived 发生故障切换时邮件发送的对象，可以按行区分写多个</span><br>   &#125;<br>   notification_email_from Alexandre.Cassen@firewall.loc<br>   smtp_server 127.0.0.1<br>   smtp_connect_timeout 30<br>   router_id ka1.rlin.com<br>   vrrp_skip_check_adv_addr <span class="hljs-comment">#所有报文都检查比较消耗性能，此配置为如果收到的报文和上一个报文是同一个路由器则跳过检查报文中的源地址</span><br>   <span class="hljs-comment">#vrrp_strict #严格遵守VRRP协议,禁止状况:1.无VIP地址,2.配置了单播邻居,3.在VRRP版本2中有IPv6地址</span><br>   vrrp_garp_interval 0 <span class="hljs-comment">#ARP报文发送延迟</span><br>   vrrp_gna_interval 0 <span class="hljs-comment">#消息发送延迟</span><br>   vrrp_mcast_group4 224.0.0.18 <span class="hljs-comment">#默认组播IP地址，可指定组播范围：224.0.0.0到239.255.255.255</span><br>&#125;<br><br>vrrp_instance web &#123;<br>    state MASTER <span class="hljs-comment">#在另一个结点上为BACKUP</span><br>    interface eth0<br>    virtual_router_id 51 <span class="hljs-comment">#每个虚拟路由器必须唯一，同属一个虚拟路由器的多个keepalived节点必须相同</span><br>    priority 100 <span class="hljs-comment">#在另一个结点上为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS <span class="hljs-comment">#预共享密钥认证，同一个虚拟路由器的keepalived节点必须一样</span><br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-BACKUP配置"><a href="#3-1-2-BACKUP配置" class="headerlink" title="3.1.2 BACKUP配置"></a>3.1.2 BACKUP配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#配置文件和master基本一致，只需修改三行</span><br>[root@keepalived2 keepalived]<span class="hljs-comment"># vim keepalived.conf </span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>      root@localhost<br>   &#125;<br>   notification_email_from Alexandre.Cassen@firewall.loc<br>   smtp_server 127.0.0.1<br>   smtp_connect_timeout 30<br>   router_id ka2.rlin.com<br>   vrrp_skip_check_adv_addr<br>   <span class="hljs-comment">#vrrp_strict #修改此行</span><br>   vrrp_garp_interval 0<br>   vrrp_gna_interval 0<br>   vrrp_mcast_group4 224.0.0.18<br>&#125;<br><br>vrrp_instance web &#123;<br>    state BACKUP <span class="hljs-comment">#修改此行</span><br>    interface eth0<br>    virtual_router_id 51<br>    priority 80 <span class="hljs-comment">#修改此行</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>抓包观察</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump -i eth0 -nn host 224.0.0.18<br></code></pre></td></tr></table></figure>

<h3 id="3-2-抢占模式和非抢占模式"><a href="#3-2-抢占模式和非抢占模式" class="headerlink" title="3.2 抢占模式和非抢占模式"></a>3.2 抢占模式和非抢占模式</h3><h4 id="3-2-1-非抢占模式-nopreempt-（不建议生产环境使用）"><a href="#3-2-1-非抢占模式-nopreempt-（不建议生产环境使用）" class="headerlink" title="3.2.1 非抢占模式 nopreempt （不建议生产环境使用）"></a>3.2.1 非抢占模式 nopreempt （不建议生产环境使用）</h4><p>默认为抢占模式preempt，即当高优先级的主机恢复在线后，会抢占低先级的主机的master角色，造<br>成网络抖动，建议设置为非抢占模式 nopreempt ，即高优级主机恢复后，并不会抢占低优先级主机的master角色。</p>
<p>此外原主机down机迁移至新主机后续也发生down时,会将VIP迁移回原主机<br><strong>注意：要关闭 VIP抢占，必须将各 keepalived 服务器state配置为BACKUP</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ka1主机配置</span><br>vrrp_instance VI_1 &#123;<br>  state BACKUP   <span class="hljs-comment">#都为BACKUP</span><br>  interface eth0<br>  virtual_router_id 66<br>  priority 100  <span class="hljs-comment">#优先级高</span><br>  advert_int 1<br>  nopreempt     <span class="hljs-comment">#添加此行，都为nopreempt</span><br>  ......<br><br><span class="hljs-comment">#ka2主机配置</span><br>vrrp_instance VI_1 &#123;<br>  state BACKUP     <span class="hljs-comment">#都为BACKUP</span><br>  interface eth0<br>  virtual_router_id 66<br>  priority 80    <span class="hljs-comment">#优先级低</span><br>  advert_int 1<br>  nopreempt  <span class="hljs-comment">#添加此行，都为nopreempt</span><br>  ......<br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-抢占延迟模式-preempt-delay"><a href="#3-2-2-抢占延迟模式-preempt-delay" class="headerlink" title="3.2.2 抢占延迟模式 preempt_delay"></a>3.2.2 抢占延迟模式 preempt_delay</h4><p>抢占延迟模式，即优先级高的主机恢复后，不会立即抢回VIP，而是延迟一段时间（默认300s）再抢回<br>VIP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">preempt_delay <span class="hljs-comment">#   #指定抢占延迟时间为#s，默认延迟300s</span><br></code></pre></td></tr></table></figure>

<p><strong>注意：需要各keepalived服务器state为BACKUP,并且不要启用 vrrp_strict</strong><br>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ha1主机配置</span><br>vrrp_instance VI_1 &#123;<br>  state BACKUP   <span class="hljs-comment">#都为BACKUP</span><br>  interface eth0<br>  virtual_router_id 66<br>  priority 100 <span class="hljs-comment">#优先级高</span><br>  advert_int 1<br>  preempt_delay 60   <span class="hljs-comment">#抢占延迟模式，默认延迟300s</span><br>  ......<br><br><span class="hljs-comment">#ha2主机配置</span><br>vrrp_instance VI_1 &#123;<br>  state BACKUP    <span class="hljs-comment">#都为BACKUP</span><br>  interface eth0<br>  virtual_router_id 66<br>  priority 80 <span class="hljs-comment">#优先级低</span><br>  advert_int 1<br>  ......<br></code></pre></td></tr></table></figure>

<h3 id="3-3-VIP单播配置（生产推荐使用单播）"><a href="#3-3-VIP单播配置（生产推荐使用单播）" class="headerlink" title="3.3 VIP单播配置（生产推荐使用单播）"></a>3.3 VIP单播配置（生产推荐使用单播）</h3><p>默认keepalived主机之间利用多播相互通告消息，会造成网络拥塞，可以替换成单播，减少网络流量<br><strong>注意：启用 vrrp_strict 时，不能启用单播</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在所有节点vrrp_instance语句块中设置对方主机的IP，建议设置为专用于对应心跳线网络的地址，而非使用业务网络</span><br>unicast_src_ip &lt;IPADDR&gt;  <span class="hljs-comment">#指定发送单播的源IP</span><br>unicast_peer &#123;<br> &lt;IPADDR&gt;   <span class="hljs-comment">#指定接收单播的对方目标主机IP</span><br> ......<br>&#125;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#master 主机配置</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br> notification_email &#123;<br>  acassen@firewall.loc<br>  failover@firewall.loc<br>  sysadmin@firewall.loc<br> &#125;<br> notification_email_from Alexandre.Cassen@firewall.loc<br> smtp_server 192.168.200.1<br> smtp_connect_timeout 30<br> router_id ka1.magedu.org<br> vrrp_skip_check_adv_addr<br> <span class="hljs-comment">#vrrp_strict</span><br> vrrp_garp_interval 0<br> vrrp_gna_interval 0<br>&#125;<br>vrrp_instance VI_1 &#123;<br> state MASTER<br> interface eth0<br> virtual_router_id 66<br> priority 100<br> advert_int 1<br> authentication &#123;<br>   auth_type PASS<br>   auth_pass 123456<br> &#125;<br> virtual_ipaddress &#123;<br>    10.0.0.10/24 dev eth0 label eth0:1<br> &#125;<br> unicast_src_ip 10.0.0.8   <span class="hljs-comment">#本机IP</span><br> unicast_peer&#123;<br> 10.0.0.18 <span class="hljs-comment">#指向对方主机IP</span><br> 10.0.0.28 <span class="hljs-comment">#如果有多个keepalived,再加其它节点的IP</span><br> &#125;<br>&#125;<br><br>[root@ha1-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.8 10.0.0.10<br><br><span class="hljs-comment">#slave 主机配置</span><br>[root@ka2-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br> notification_email &#123;<br>  acassen@firewall.loc<br>  failover@firewall.loc<br>  sysadmin@firewall.loc<br> &#125;<br> notification_email_from Alexandre.Cassen@firewall.loc<br> smtp_server 192.168.200.1<br> smtp_connect_timeout 30<br> router_id ka2.magedu.org<br> vrrp_skip_check_adv_addr<br> <span class="hljs-comment">#vrrp_strict</span><br> vrrp_garp_interval 0<br> vrrp_gna_interval 0<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br> state SLAVE<br> interface eth0<br> virtual_router_id 66<br> priority 80<br> advert_int 1<br> authentication &#123;<br>   auth_type PASS<br>   auth_pass 123456<br> &#125;<br> virtual_ipaddress &#123;<br>    10.0.0.10/24 dev eth0 label eth0:1<br> &#125;<br> unicast_src_ip 10.0.0.18    <span class="hljs-comment">#本机IP</span><br> unicast_peer &#123;<br> 10.0.0.8 <span class="hljs-comment">#指向对方主机IP</span><br> &#125;<br>&#125;<br>[root@ka2-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.18<br></code></pre></td></tr></table></figure>

<p>抓包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@web2 html]<span class="hljs-comment"># tcpdump -i eth0 -nn host 10.0.0.8</span><br>tcpdump: verbose output suppressed, use -v or -vv <span class="hljs-keyword">for</span> full protocol decode<br>listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes<br>22:24:59.852442 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br>22:25:00.853850 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br>22:25:01.855177 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br>22:25:02.856280 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br>22:25:03.857536 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br>22:25:04.858865 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br>22:25:05.859458 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br>22:25:06.860902 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br>22:25:07.862136 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br>22:25:08.862886 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br>22:25:09.862982 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br> 22:25:10.863993 IP 10.0.0.8 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20<br></code></pre></td></tr></table></figure>

<h3 id="3-4-Keepalived-通知脚本配置"><a href="#3-4-Keepalived-通知脚本配置" class="headerlink" title="3.4 Keepalived 通知脚本配置"></a>3.4 Keepalived 通知脚本配置</h3><p>当keepalived的状态变化时，可以自动触发脚本的执行，比如：发邮件通知用户<br>默认以用户keepalived_script身份执行脚本，如果此用户不存在，以root执行脚本<br>可以用下面指令指定脚本执行用户的身份</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">global_defs &#123;<br>  ......<br>  script_user &lt;USER&gt;<br>  ......<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-1-通知脚本类型"><a href="#3-4-1-通知脚本类型" class="headerlink" title="3.4.1 通知脚本类型"></a>3.4.1 通知脚本类型</h4><ul>
<li>当前节点成为主节点时触发的脚本</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">notify_master &lt;STRING&gt;|&lt;QUOTED-STRING&gt;<br></code></pre></td></tr></table></figure>

<ul>
<li>当前节点转为备节点时触发的脚本</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">notify_backup &lt;STRING&gt;|&lt;QUOTED-STRING&gt;<br></code></pre></td></tr></table></figure>

<ul>
<li>当前节点转为“失败”状态时触发的脚本</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">notify_fault &lt;STRING&gt;|&lt;QUOTED-STRING&gt;<br></code></pre></td></tr></table></figure>

<ul>
<li>通用格式的通知触发机制，一个脚本可完成以上三种状态的转换时的通知</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">notify &lt;STRING&gt;|&lt;QUOTED-STRING&gt;<br></code></pre></td></tr></table></figure>

<ul>
<li>当停止VRRP时触发的脚本</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">notify_stop &lt;STRING&gt;|&lt;QUOTED-STRING&gt;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-2-脚本的调用方法"><a href="#3-4-2-脚本的调用方法" class="headerlink" title="3.4.2 脚本的调用方法"></a>3.4.2 脚本的调用方法</h4><p>在 vrrp_instance VI_1 语句块的末尾加下面行</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">notify_master &quot;/etc/keepalived/notify.sh master&quot;<br>notify_backup &quot;/etc/keepalived/notify.sh backup&quot;<br>notify_fault &quot;/etc/keepalived/notify.sh fault&quot;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-3-创建通知脚本"><a href="#3-4-3-创建通知脚本" class="headerlink" title="3.4.3 创建通知脚本"></a>3.4.3 创建通知脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注释的是使用钉钉通知</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/notify.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br>contact=<span class="hljs-string">&#x27;346636558@qq.com&#x27;</span><br><span class="hljs-comment">#content_type=&#x27;Content-type: application/json&#x27;</span><br><span class="hljs-comment">#webhook=&#x27;https://oapi.dingtalk.com/robot/send?access_token=xxxxxx&#x27;</span><br><br><span class="hljs-function"><span class="hljs-title">notify</span></span>() &#123;<br>  mailsubject=<span class="hljs-string">&quot;<span class="hljs-subst">$(hostname)</span> to be <span class="hljs-variable">$1</span>, vip floating&quot;</span><br>  mailbody=<span class="hljs-string">&quot;<span class="hljs-subst">$(date +&#x27;%F %T&#x27;)</span>: vrrp transition, <span class="hljs-subst">$(hostname)</span> changed to be <span class="hljs-variable">$1</span>&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$mailbody</span>&quot;</span> | mail -s <span class="hljs-string">&quot;<span class="hljs-variable">$mailsubject</span>&quot;</span> <span class="hljs-variable">$contact</span><br>  <span class="hljs-comment">#msgtype=&#x27;&#123;&quot;msgtype&quot;: &quot;text&quot;,&quot;text&quot;: &#123;&quot;content&quot;:&quot;&#x27;$mailbody&#x27;&quot;&#125;&#125;&#x27;</span><br>  <span class="hljs-comment">#curl &quot;$webhook&quot; -H &quot;$content_type&quot; -d &quot;$msgtype&quot;  &amp;&gt; /dev/null</span><br>&#125;<br><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>master)<br>  notify master<br>  ;;<br>backup)<br>  notify backup<br>  ;;<br>fault)<br>  notify fault<br>  ;;<br>*)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-subst">$(basename $0)</span> &#123;master|backup|fault&#125;&quot;</span><br>  <span class="hljs-built_in">exit</span> 1<br>  ;;<br><span class="hljs-keyword">esac</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-邮件配置"><a href="#3-4-4-邮件配置" class="headerlink" title="3.4.4 邮件配置"></a>3.4.4 邮件配置</h4><p>案例：QQ邮箱配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># vim /etc/mail.rc</span><br><span class="hljs-comment">#在最后面添加下面行</span><br><span class="hljs-built_in">set</span> from=29308620@qq.com<br><span class="hljs-built_in">set</span> smtp=smtp.qq.com<br><span class="hljs-built_in">set</span> smtp-auth-user=29308620@qq.com<br><span class="hljs-built_in">set</span> smtp-auth-password=esvnhbnqocirbicf<br><span class="hljs-built_in">set</span> smtp-auth=login<br><span class="hljs-built_in">set</span> ssl-verify=ignore<br></code></pre></td></tr></table></figure>

<p>范例：163 邮箱配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#vi /etc/mail.rc</span><br><span class="hljs-built_in">set</span> from=xxx@163.com <span class="hljs-comment">#之前设置好的邮箱地址</span><br><span class="hljs-built_in">set</span> smtp=smtp.163.com <span class="hljs-comment">#邮件服务器</span><br><span class="hljs-built_in">set</span> smtp-auth-user=xxx@163.com <span class="hljs-comment">#之前设置好的邮箱地址</span><br><span class="hljs-built_in">set</span> smtp-auth-password=yyy <span class="hljs-comment">#授权码</span><br><span class="hljs-built_in">set</span> smtp-auth=login <span class="hljs-comment">#默认login即可</span><br></code></pre></td></tr></table></figure>

<p>范例：发送测试邮件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># yum -y install mailx</span><br>[root@centos8 ~]<span class="hljs-comment"># echo &quot;Test Mail&quot;| mail -s Warning root@wangxiaochun.com</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-5-实战案例：实现-Keepalived-状态切换的通知脚本"><a href="#3-4-5-实战案例：实现-Keepalived-状态切换的通知脚本" class="headerlink" title="3.4.5 实战案例：实现 Keepalived 状态切换的通知脚本"></a>3.4.5 实战案例：实现 Keepalived 状态切换的通知脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在所有 keepalived节点配置如下</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/notify.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br>contact=<span class="hljs-string">&#x27;root@wangxiaochun.com&#x27;</span><br><span class="hljs-function"><span class="hljs-title">notify</span></span>() &#123;<br>    mailsubject=<span class="hljs-string">&quot;<span class="hljs-subst">$(hostname)</span> to be <span class="hljs-variable">$1</span>, vip floating&quot;</span><br>    mailbody=<span class="hljs-string">&quot;<span class="hljs-subst">$(date +&#x27;%F %T&#x27;)</span>: vrrp transition, <span class="hljs-subst">$(hostname)</span> changed to be <span class="hljs-variable">$1</span>&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$mailbody</span>&quot;</span> | mail -s <span class="hljs-string">&quot;<span class="hljs-variable">$mailsubject</span>&quot;</span> <span class="hljs-variable">$contact</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>master)<br>   notify master<br>    ;;<br>backup)<br>    notify backup<br>    ;;<br>fault)<br>    notify fault<br>    ;;<br>*)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-subst">$(basename $0)</span> &#123;master|backup|fault&#125;&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br>    ;;<br><span class="hljs-keyword">esac</span><br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#chmod a+x /etc/keepalived/notify.sh</span><br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#vim /etc/keepalived/keepalived.conf</span><br>vrrp_instance VI_1 &#123;<br>......<br>  virtual_ipaddress &#123;<br>      10.0.0.10 dev eth0 label eth0:1<br>  &#125;<br>  notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>  notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>  notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>&#125;<br><br><span class="hljs-comment">#模拟master故障</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#killall keepalived</span><br></code></pre></td></tr></table></figure>

<p><strong>查看钉钉通知如下：</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Keeplived/keepalived6.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-5-实现-master-master-的-Keepalived-双主架构"><a href="#3-5-实现-master-master-的-Keepalived-双主架构" class="headerlink" title="3.5 实现 master/master 的 Keepalived 双主架构"></a>3.5 实现 master/master 的 Keepalived 双主架构</h3><p>master/slave的单主架构，同一时间只有一个Keepalived对外提供服务，此主机繁忙，而另一台主机却很空闲，利用率低下，可以使用master/master的双主架构，解决此问题。</p>
<p><strong>master/master 的双主架构：</strong></p>
<p>即将两个或以上VIP分别运行在不同的keepalived服务器，以实现服务器并行提供web访问的目的，提<br>高服务器资源利用率</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ka1主机配置</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#vim /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>global_defs &#123;<br>    notification_email &#123;<br>        root@wangxiaochun.com<br>    &#125;<br>    notification_email_from keepalived@localhost<br>    smtp_server 127.0.0.1<br>    smtp_connect_timeout 30<br>    router_id ka1.magedu.org<br>    vrrp_mcast_group4 224.0.100.100<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER  <span class="hljs-comment">#在另一个主机上为BACKUP</span><br>    interface eth0<br>    virtual_router_id 66 <span class="hljs-comment">#每个vrrp_instance唯一</span><br>    priority 100  <span class="hljs-comment">#在另一个主机上为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 12345678<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1 <span class="hljs-comment">#指定vrrp_instance各自的VIP</span><br>    &#125;<br>&#125;<br><br>vrrp_instance VI_2 &#123;       <span class="hljs-comment">#添加 VI_2 实例</span><br>    state BACKUP  <span class="hljs-comment">#在另一个主机上为MASTER</span><br>    interface eth0<br>    virtual_router_id 88 <span class="hljs-comment">#每个vrrp_instance唯一</span><br>    priority 80   <span class="hljs-comment">#在另一个主机上为100</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 12345678<br>    &#125;<br>    virtual_ipaddress &#123;<br>         10.0.0.20/24 dev eth0 label eth0:1  <span class="hljs-comment">#指定vrrp_instance各自的VIP</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#ka2主机配置,和ka1配置只需五行不同</span><br>[root@ka2-centos8 ~]<span class="hljs-comment">#vim /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>global_defs &#123;<br>    notification_email &#123;<br>         root@wangxiaochun.com<br>    &#125;<br>    notification_email_from keepalived@localhost<br>    smtp_server 127.0.0.1<br>    smtp_connect_timeout 30<br>    router_id ka2.magedu.org     <span class="hljs-comment">#修改此行</span><br>    vrrp_mcast_group4 224.0.100.100<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state BACKUP <span class="hljs-comment">#此修改行为BACKUP</span><br>    interface eth0<br>    virtual_router_id 66<br>    priority 80  <span class="hljs-comment">#此修改行为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 12345678<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>&#125;<br>vrrp_instance VI_2 &#123;<br>    state MASTER  <span class="hljs-comment">#修改此行为MASTER</span><br>    interface eth0<br>    virtual_router_id 88<br>    priority 100  <span class="hljs-comment">#修改此行为100</span><br>    advert_int 1<br>    authentication &#123;<br>    auth_type PASS<br>    auth_pass 12345678<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.20/24 dev eth0 label eth0:1 <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-5-1-实战案例：利用子配置文件实现master-master的Keepalived双主架构"><a href="#3-5-1-实战案例：利用子配置文件实现master-master的Keepalived双主架构" class="headerlink" title="3.5.1 实战案例：利用子配置文件实现master/master的Keepalived双主架构"></a>3.5.1 实战案例：利用子配置文件实现master/master的Keepalived双主架构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>     acassen@firewall.loc<br>     failover@firewall.loc<br>     sysadmin@firewall.loc<br> &#125;<br>    notification_email_from Alexandre.Cassen@firewall.loc<br>    smtp_server 192.168.200.1<br>    smtp_connect_timeout 30<br>    router_id ha1.magedu.org<br>    vrrp_skip_check_adv_addr<br>    <span class="hljs-comment">#vrrp_strict</span><br>    vrrp_garp_interval 0<br>    vrrp_gna_interval 0<br>&#125;<br><br>include /etc/keepalived/conf.d/*.conf<br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#mkdir /etc/keepalived/conf.d/</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/conf.d/cluster1.conf</span><br>vrrp_instance VI_1 &#123;<br>    state MASTER<br>    interface eth0<br>    virtual_router_id 66<br>    priority 100<br>    advert_int 1<br>    authentication &#123;<br>      auth_type PASS<br>      auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>       10.0.0.10/24 dev eth0 lavel eth0:0<br>       10.0.0.11/24 dev eth0 lavel eth0:1<br>       10.0.0.12/24 dev eth0 lavel eth0:2<br>       10.0.0.13/24 dev eth0 lavel eth0:3<br>       10.0.0.14/24 dev eth0 lavel eth0:4<br>       10.0.0.15/24 dev eth0 lavel eth0:5<br>    &#125;<br>    unicast_src_ip 10.0.0.8<br>    unicast_peer&#123;<br>    10.0.0.18<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>&#125;<br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/conf.d/cluster2.conf</span><br>vrrp_instance VI_2 &#123;<br>    state BACKUP<br>    interface eth0<br>    virtual_router_id 88<br>    priority 80<br>    advert_int 1<br>    authentication &#123;<br>      auth_type PASS<br>      auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>       10.0.0.59/24 dev eth0 lavel eth0:49<br>        10.0.0.60/24 dev eth0 lavel eth0:50<br>        10.0.0.61/24 dev eth0 lavel eth0:51<br>        10.0.0.62/24 dev eth0 lavel eth0:52<br>        10.0.0.63/24 dev eth0 lavel eth0:53<br>        10.0.0.64/24 dev eth0 lavel eth0:54<br>    &#125;<br>    unicast_src_ip 10.0.0.8<br>    unicast_peer&#123;<br>    10.0.0.18<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>&#125;<br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#tree /etc/keepalived/</span><br>/etc/keepalived/<br>├── conf.d<br>│  ├── cluster1.conf<br>│  └── cluster2.conf<br>├── keepalived.conf<br>├── keepalived.conf.bak<br>└── notify.sh<br>1 directory, 5 files<br>[root@ka1-centos8 ~]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#ka2主机的配置</span><br>[root@ka2-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>    notification_email &#123;<br>     acassen@firewall.loc<br>     failover@firewall.loc<br>     sysadmin@firewall.loc<br>    &#125;<br>    notification_email_from Alexandre.Cassen@firewall.loc<br>    smtp_server 192.168.200.1<br>    smtp_connect_timeout 30<br>    router_id ha2.magedu.org<br>    vrrp_skip_check_adv_addr<br>    <span class="hljs-comment">#vrrp_strict</span><br>    vrrp_garp_interval 0<br>    vrrp_gna_interval 0<br>&#125;<br><br>include /etc/keepalived/conf.d/*.conf<br><br>[root@ka2-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/conf.d/cluster1.conf</span><br>vrrp_instance VI_1 &#123;<br>    state BACKUP<br>    interface eth0<br>    virtual_router_id 66<br>    priority 80<br>    advert_int 1<br>    authentication &#123;<br>      auth_type PASS<br>      auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>       0.0.0.10/24 dev eth0 lavel eth0:0<br>       10.0.0.11/24 dev eth0 lavel eth0:1<br>       10.0.0.12/24 dev eth0 lavel eth0:2<br>       10.0.0.13/24 dev eth0 lavel eth0:3<br>       10.0.0.14/24 dev eth0 lavel eth0:4<br>       10.0.0.15/24 dev eth0 lavel eth0:5<br>    &#125;<br>    unicast_src_ip 10.0.0.18<br>    unicast_peer &#123;<br>     10.0.0.8<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>&#125;<br>[root@ka2-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/conf.d/cluster2.conf</span><br>vrrp_instance VI_2 &#123;<br>    state MASTER<br>    interface eth0<br>    virtual_router_id 88<br>    priority 100<br>    advert_int 1<br>    authentication &#123;<br>      auth_type PASS<br>      auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>       10.0.0.59/24 dev eth0 lavel eth0:49<br>        10.0.0.60/24 dev eth0 lavel eth0:50<br>        10.0.0.61/24 dev eth0 lavel eth0:51<br>        10.0.0.62/24 dev eth0 lavel eth0:52<br>        10.0.0.63/24 dev eth0 lavel eth0:53<br>        10.0.0.64/24 dev eth0 lavel eth0:54<br>    &#125;<br>    unicast_src_ip 10.0.0.18<br>    unicast_peer&#123;<br>    10.0.0.8<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>&#125;<br><br><span class="hljs-comment">#查看IP</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.8 10.0.0.10 10.0.0.11 10.0.0.12 10.0.0.13 10.0.0.14 10.0.0.15<br>[root@ka2-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.18 10.0.0.59 10.0.0.60 10.0.0.61 10.0.0.62 10.0.0.63 10.0.0.64<br><br><span class="hljs-comment">#ka1主机故障，测试VIP漂移至ka2主机</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#killall keepalived</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.8<br><br>[root@ka2-centos8 ~]<span class="hljs-comment">#hostname -I | tr &#x27; &#x27; &#x27;\n&#x27;</span><br>10.0.0.18<br>10.0.0.59<br>10.0.0.60<br>10.0.0.61<br>10.0.0.62<br>10.0.0.63<br>10.0.0.64<br>10.0.0.10<br>10.0.0.11<br>10.0.0.12<br>10.0.0.13<br>10.0.0.14<br>10.0.0.15<br><br><span class="hljs-comment">#恢复ka1主机</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#systemctl start keepalived.service</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.8 10.0.0.10 10.0.0.11 10.0.0.12 10.0.0.13 10.0.0.14 10.0.0.15<br>[root@ka2-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.18 10.0.0.59 10.0.0.60 10.0.0.61 10.0.0.62 10.0.0.63 10.0.0.64<br></code></pre></td></tr></table></figure>

<h4 id="3-5-2-实战案例：三个节点的三主架构实现"><a href="#3-5-2-实战案例：三个节点的三主架构实现" class="headerlink" title="3.5.2 实战案例：三个节点的三主架构实现"></a>3.5.2 实战案例：三个节点的三主架构实现</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">第一个节点ka1配置：<br>Vrrp instance 1：MASTER，优先级100<br>Vrrp instance 2：BACKUP，优先级80<br>Vrrp instance 3：BACKUP，优先级60<br><br>第二个节点ka2配置：<br>Vrrp instance 1：BACKUP，优先级60<br>Vrrp instance 2：MASTER，优先级100<br>Vrrp instance 3：BACKUP，优先级80<br><br>第三个节点ka3配置：<br>Vrrp instance 1：BACKUP，优先级80<br>Vrrp instance 2：BACKUP，优先级60<br>Vrrp instance 3：MASTER，优先级100<br></code></pre></td></tr></table></figure>

<h3 id="3-6-实现IPVS的高可用性"><a href="#3-6-实现IPVS的高可用性" class="headerlink" title="3.6 实现IPVS的高可用性"></a>3.6 实现IPVS的高可用性</h3><h4 id="3-6-1-IPVS相关配置"><a href="#3-6-1-IPVS相关配置" class="headerlink" title="3.6.1 IPVS相关配置"></a>3.6.1 IPVS相关配置</h4><h5 id="3-6-1-1-虚拟服务器配置结构"><a href="#3-6-1-1-虚拟服务器配置结构" class="headerlink" title="3.6.1.1 虚拟服务器配置结构"></a>3.6.1.1 虚拟服务器配置结构</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">virtual_server IP port &#123;<br>   ...<br>  real_server &#123;<br>    ...<br>  &#125;<br>  real_server &#123;<br>    ...<br>  &#125;<br>  …<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-6-1-2-virtual-server-（虚拟服务器）的定义格式"><a href="#3-6-1-2-virtual-server-（虚拟服务器）的定义格式" class="headerlink" title="3.6.1.2 virtual server （虚拟服务器）的定义格式"></a>3.6.1.2 virtual server （虚拟服务器）的定义格式</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">virtual_server IP port   <span class="hljs-comment">#定义虚拟主机IP地址及其端口</span><br>virtual_server fwmark int <span class="hljs-comment">#ipvs的防火墙打标，实现基于防火墙的负载均衡集群</span><br>virtual_server group string <span class="hljs-comment">#使用虚拟服务器组</span><br></code></pre></td></tr></table></figure>

<h5 id="3-6-1-3-虚拟服务器组"><a href="#3-6-1-3-虚拟服务器组" class="headerlink" title="3.6.1.3 虚拟服务器组"></a>3.6.1.3 虚拟服务器组</h5><p>将多个虚拟服务器定义成一个组，统一对外服务，如：http和https定义成一个虚拟服务器组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#参考文档：/usr/share/doc/keepalived/keepalived.conf.virtual_server_group</span><br>virtual_server_group &lt;STRING&gt; &#123;<br>     <span class="hljs-comment"># Virtual IP Address and Port</span><br>     &lt;IPADDR&gt; &lt;PORT&gt;<br>     &lt;IPADDR&gt; &lt;PORT&gt;<br>     ...<br>     <span class="hljs-comment"># &lt;IPADDR RANGE&gt; has the form</span><br>     <span class="hljs-comment"># XXX.YYY.ZZZ.WWW-VVV eg 192.168.200.1-10</span><br>     <span class="hljs-comment"># range includes both .1 and .10 address</span><br>     &lt;IPADDR RANGE&gt; &lt;PORT&gt;<span class="hljs-comment"># VIP range VPORT</span><br>     &lt;IPADDR RANGE&gt; &lt;PORT&gt;<br>     ...<br>     <span class="hljs-comment"># Firewall Mark (fwmark)</span><br>     fwmark &lt;INTEGER&gt;<br>     fwmark &lt;INTEGER&gt;<br>     ...<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-6-1-4-虚拟服务器配置"><a href="#3-6-1-4-虚拟服务器配置" class="headerlink" title="3.6.1.4 虚拟服务器配置"></a>3.6.1.4 虚拟服务器配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">virtual_server IP port &#123; <span class="hljs-comment">#VIP和PORT</span><br>    delay_loop &lt;INT&gt; <span class="hljs-comment">#检查后端服务器的时间间隔</span><br>    lb_algo rr|wrr|lc|wlc|lblc|sh|dh <span class="hljs-comment">#定义调度方法</span><br>    lb_kind NAT|DR|TUN <span class="hljs-comment">#集群的类型,注意要大写</span><br>    persistence_timeout &lt;INT&gt; <span class="hljs-comment">#持久连接时长</span><br>    protocol TCP|UDP|SCTP <span class="hljs-comment">#指定服务协议,一般为TCP</span><br>    sorry_server &lt;IPADDR&gt; &lt;PORT&gt; <span class="hljs-comment">#所有RS故障时，备用服务器地址</span><br>    real_server &lt;IPADDR&gt; &lt;PORT&gt; &#123;      <span class="hljs-comment">#RS的IP和PORT</span><br>        weight &lt;INT&gt;  <span class="hljs-comment">#RS权重</span><br>        notify_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="hljs-comment">#RS上线通知脚本</span><br>        notify_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt; <span class="hljs-comment">#RS下线通知脚本</span><br>        HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK &#123; ... &#125; <span class="hljs-comment">#定义当前主机健康状态检测方法</span><br>        &#125;<br>&#125;<br><br><span class="hljs-comment">#注意:括号必须分行写,两个括号写在行,如: &#125;&#125; 会出错</span><br></code></pre></td></tr></table></figure>

<h5 id="3-6-1-5-应用层监测"><a href="#3-6-1-5-应用层监测" class="headerlink" title="3.6.1.5 应用层监测"></a>3.6.1.5 应用层监测</h5><p>应用层检测：HTTP_GET|SSL_GET</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">HTTP_GET|SSL_GET &#123;<br>url &#123;<br>    path &lt;URL_PATH&gt; <span class="hljs-comment">#定义要监控的URL</span><br>    status_code &lt;INT&gt; <span class="hljs-comment">#判断上述检测机制为健康状态的响应码，一般为 200</span><br>    &#125;<br>    connect_timeout &lt;INTEGER&gt; <span class="hljs-comment">#客户端请求的超时时长, 相当于haproxy的timeout server</span><br>    nb_get_retry &lt;INT&gt; <span class="hljs-comment">#重试次数</span><br>    delay_before_retry &lt;INT&gt; <span class="hljs-comment">#重试之前的延迟时长</span><br>    connect_ip &lt;IP ADDRESS&gt; <span class="hljs-comment">#向当前RS哪个IP地址发起健康状态检测请求</span><br>    connect_port &lt;PORT&gt; <span class="hljs-comment">#向当前RS的哪个PORT发起健康状态检测请求</span><br>    bindto &lt;IP ADDRESS&gt; <span class="hljs-comment">#向当前RS发出健康状态检测请求时使用的源地址</span><br>    bind_port &lt;PORT&gt; <span class="hljs-comment">#向当前RS发出健康状态检测请求时使用的源端口</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">virtual_server 10.0.0.10 80 &#123;<br>        delay_loop 3<br>        lb_algo rr<br>        lb_kind DR<br>        protocol TCP<br>        sorry_server 127.0.0.1 80<br>        real_server 10.0.0.7 80 &#123;<br>            weight 1<br>            HTTP_GET &#123;<br>                url &#123;<br>                    path /monitor.html<br>                    status_code 200<br>                &#125;<br>                connect_timeout 1<br>                nb_get_retry 3<br>                delay_before_retry 1<br>              &#125;<br>          &#125;<br>          real_server 10.0.0.17 80 &#123;<br>              weight 1<br>              HTTP_GET &#123;<br>                  url &#123;<br>                        path /<br>                        status_code 200<br>                  &#125;<br>                  connect_timeout 1<br>                  nb_get_retry 3<br>                  delay_before_retry 1<br>                &#125;<br>             &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-6-1-6-TCP监测"><a href="#3-6-1-6-TCP监测" class="headerlink" title="3.6.1.6 TCP监测"></a>3.6.1.6 TCP监测</h5><p>传输层检测：TCP_CHECK</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">TCP_CHECK &#123;<br>  connect_ip &lt;IP ADDRESS&gt; <span class="hljs-comment">#向当前RS的哪个IP地址发起健康状态检测请求</span><br>  connect_port &lt;PORT&gt; <span class="hljs-comment">#向当前RS的哪个PORT发起健康状态检测请求</span><br>  bindto &lt;IP ADDRESS&gt; <span class="hljs-comment">#发出健康状态检测请求时使用的源地址</span><br>  bind_port &lt;PORT&gt; <span class="hljs-comment">#发出健康状态检测请求时使用的源端口</span><br>  connect_timeout &lt;INTEGER&gt; <span class="hljs-comment">#客户端请求的超时时长, 等于haproxy的timeout server </span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">virtual_server 10.0.0.10 80 &#123;<br> delay_loop 6<br> lb_algo wrr<br> lb_kind DR<br>  <span class="hljs-comment">#persistence_timeout 120  #会话保持时间</span><br> protocol TCP<br> sorry_server 127.0.0.1 80<br> real_server 10.0.0.7 80 &#123;<br>   weight 1<br>   TCP_CHECK &#123;<br>   connect_timeout 5<br>   nb_get_retry 3<br>   delay_before_retry 3<br>    connect_port 80<br>   &#125;<br> &#125;<br> real_server 10.0.0.17 80 &#123;<br>   weight 1<br>   TCP_CHECK &#123;<br>   connect_timeout 5<br>   nb_get_retry 3<br>   delay_before_retry 3<br>    connect_port 80<br>   &#125;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-6-2-实战案例"><a href="#3-6-2-实战案例" class="headerlink" title="3.6.2 实战案例"></a>3.6.2 实战案例</h4><h5 id="3-6-2-1-实战案例1：实现单主的-LVS-DR-模式"><a href="#3-6-2-1-实战案例1：实现单主的-LVS-DR-模式" class="headerlink" title="3.6.2.1 实战案例1：实现单主的 LVS-DR 模式"></a>3.6.2.1 实战案例1：实现单主的 LVS-DR 模式</h5><p><strong>准备web服务器并使用脚本绑定VIP至web服务器lo网卡</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#准备两台后端RS主机</span><br>[root@rs1 ~]<span class="hljs-comment">#cat lvs_dr_rs.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#Author:wangxiaochun</span><br><span class="hljs-comment">#Date:2017-08-13</span><br>vip=10.0.0.10<br>mask=<span class="hljs-string">&#x27;255.255.255.255&#x27;</span><br>dev=lo:1<br>rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null<br>service httpd start &amp;&gt; /dev/null &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The httpd Server is Ready!&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot;</span> &gt; /var/www/html/index.html<br><span class="hljs-comment">#rpm -q nginx &amp;&gt; /dev/null || yum -y install nginx &amp;&gt;/dev/null</span><br><span class="hljs-comment">#service nginx start &amp;&gt; /dev/null &amp;&amp; echo &quot;The nginx Server is Ready!&quot;</span><br><span class="hljs-comment">#echo &quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html</span><br><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>start)<br>  <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br>  <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore<br>  <span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce<br>  <span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce<br> ifconfig <span class="hljs-variable">$dev</span> <span class="hljs-variable">$vip</span> netmask <span class="hljs-variable">$mask</span> <span class="hljs-comment">#broadcast $vip up</span><br>  <span class="hljs-comment">#route add -host $vip dev $dev</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The RS Server is Ready!&quot;</span><br> ;;<br>stop)<br> ifconfig <span class="hljs-variable">$dev</span> down<br>  <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br>  <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore<br>  <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce<br>  <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The RS Server is Canceled!&quot;</span><br> ;;<br>*)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-subst">$(basename $0)</span> start|stop&quot;</span><br>  <span class="hljs-built_in">exit</span> 1<br> ;;<br><span class="hljs-keyword">esac</span><br><br>[root@rs1 ~]<span class="hljs-comment">#bash lvs_dr_rs.sh start</span><br>The httpd Server is Ready!<br>The RS Server is Ready!<br>[root@rs1 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet 10.0.0.10/32 scope global lo:1<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP<br>group default qlen 1000<br> link/ether 00:0c:29:32:80:38 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe32:8038/64 scope link<br>   valid_lft forever preferred_lft forever   <br>   <br>[root@rs2 ~]<span class="hljs-comment">#bash lvs_dr_rs.sh start</span><br>The httpd Server is Ready!<br>The RS Server is Ready!<br><br>[root@rs2 ~]<span class="hljs-comment">#ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet 10.0.0.10/32 scope global lo:1<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP<br>group default qlen 1000<br> link/ether 00:0c:29:33:b4:1a brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.17/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe33:b41a/64 scope link<br> <br> <span class="hljs-comment">#测试直接访问两台RS</span><br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.7</span><br>&lt;h1&gt;rs1.magedu.org&lt;/h1&gt;<br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.17</span><br>&lt;h1&gt;rs2.magedu.org&lt;/h1&gt;<br></code></pre></td></tr></table></figure>

<p><strong>配置keepalived</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ka1节点的配置</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#cat  /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>    global_defs &#123;<br>        notification_email &#123;<br>            root@localhost<br>        &#125;<br>        notification_email_from keepalived@localhost<br>        smtp_server 127.0.0.1<br>        smtp_connect_timeout 30<br>        router_id ka1.magedu.org<br>        vrrp_mcast_group4 224.0.100.10<br>    &#125;<br>vrrp_instance VI_1 &#123;<br>    state MASTER<br>    interface eth0<br>    virtual_router_id 66<br>    priority 100<br>    advert_int 1<br>authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>        notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>        notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>        notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>&#125;<br>        <br><span class="hljs-comment">#正常情况下都应该使用同样的检测</span><br>virtual_server 10.0.0.10 80 &#123;<br>        delay_loop 3<br>        lb_algo rr<br>        lb_kind DR<br>        protocol TCP<br>        sorry_server 127.0.0.1 80<br>        real_server 10.0.0.7 80 &#123;<br>            weight 1<br>            HTTP_GET &#123;        <span class="hljs-comment">#应用层检测</span><br>                url &#123;<br>                    path /<br>                    status_code 200<br>                &#125;<br>                connect_timeout 1<br>                nb_get_retry 3<br>                delay_before_retry 1<br>            &#125;<br>        &#125;<br>        real_server 10.0.0.17 80 &#123;<br>            weight 1<br>            TCP_CHECK &#123;        <span class="hljs-comment">#另一台主机使用TCP检测</span><br>                connect_timeout 5<br>                nb_get_retry 3<br>                delay_before_retry 3<br>                connect_port 80<br>                &#125;<br>        &#125;<br>&#125;<br><br><span class="hljs-comment">#ka2节点的配置，配置和ka1基本相同，只需修改三行</span><br>[root@ka2-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>    global_defs &#123;<br>        notification_email &#123;<br>        root@localhost<br>        &#125;<br>        notification_email_from keepalived@localhost<br>        smtp_server 127.0.0.1<br>        smtp_connect_timeout 30<br>        router_id ka1.magedu.org       <span class="hljs-comment">#修改此行</span><br>        vrrp_mcast_group4 224.0.100.10<br>    &#125;<br>vrrp_instance VI_1 &#123;<br>    state BACKUP <span class="hljs-comment">#修改此行</span><br>    interface eth0<br>    virtual_router_id 66<br>    priority 80 <span class="hljs-comment">#修改此行</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br> &#125;<br>virtual_server 10.0.0.10 80 &#123;<br>    delay_loop 3<br>    lb_algo rr<br>    lb_kind DR<br>    protocol TCP<br>    sorry_server 127.0.0.1 80<br>    real_server 10.0.0.7 80 &#123;<br>        weight 1<br>        HTTP_GET &#123;<br>            url &#123;<br>                path /<br>                status_code 200<br>            &#125;<br>            connect_timeout 1<br>            nb_get_retry 3<br>            delay_before_retry 1<br>        &#125;<br>    &#125;<br>    real_server 10.0.0.17 80 &#123;<br>        weight 1<br>       TCP_CHECK &#123;<br>            connect_timeout 5<br>            nb_get_retry 3<br>            delay_before_retry 3<br>            connect_port 80<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>访问测试结果</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10</span><br>&lt;h1&gt;rs1.magedu.org&lt;/h1&gt;<br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10</span><br>&lt;h1&gt;rs2.magedu.org&lt;/h1&gt;<br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#yum -y install ipvsadm</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port      Forward Weight ActiveConn InActConn<br>TCP  10.0.0.10:80 rr<br> -&gt; 10.0.0.7:80         Route  1    0      0    <br> -&gt; 10.0.0.17:80         Route  1    0      0 <br></code></pre></td></tr></table></figure>

<p><strong>模拟故障</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#第一台RS1故障，自动切换至RS2</span><br>[root@rs1 ~]<span class="hljs-comment">#chmod 0 /var/www/html/index.html</span><br><br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10</span><br>&lt;h1&gt;rs2.magedu.org&lt;/h1&gt;<br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10</span><br>&lt;h1&gt;rs2.magedu.org&lt;/h1&gt;<br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#dnf -y install ipvsadm</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port      Forward Weight ActiveConn InActConn<br>TCP  10.0.0.10:80 rr<br> -&gt; 10.0.0.17:80         Route  1    0      3 <br> <br><span class="hljs-comment">#后端RS服务器都故障，启动Sorry Server</span><br>[root@rs2 ~]<span class="hljs-comment">#systemctl stop httpd</span><br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10</span><br>Sorry Server on ka1<br>[root@ka1-centos8 ~]<span class="hljs-comment">#ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port      Forward Weight ActiveConn InActConn<br>TCP  10.0.0.10:80 rr<br> -&gt; 127.0.0.1:80         Route  1    0      0 <br> <br><span class="hljs-comment">#ka1故障，自动切换至ka2</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#killall keepalived</span><br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10</span><br>Sorry Server on ka2<br><br><span class="hljs-comment">#恢复都有后端 RS</span><br>[root@rs1 ~]<span class="hljs-comment">#chmod 644 /var/www/html/index.html</span><br>[root@rs2 ~]<span class="hljs-comment">#systemctl start httpd</span><br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10</span><br>&lt;h1&gt;rs1.magedu.org&lt;/h1&gt;<br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10</span><br>&lt;h1&gt;rs2.magedu.org&lt;/h1&gt;<br>[root@ka1-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.8<br>[root@ka2-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.18 10.0.0.10<br><br><span class="hljs-comment">#恢复ka1服务器，又抢占回原来的VIP</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#systemctl start keepalived.service</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.8 10.0.0.10<br>[root@ka2-centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.18<br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10</span><br>&lt;h1&gt;rs1.magedu.org&lt;/h1&gt;<br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10</span><br>&lt;h1&gt;rs2.magedu.org&lt;/h1&gt;<br><br><span class="hljs-comment">#问题：为什么停掉后端服务器就不去调度停掉的服务器</span><br><span class="hljs-comment">#答：因为会将停掉的服务器会从lvs的调度规则踢掉</span><br><span class="hljs-comment">#例子：</span><br>[root@keepalived1 conf.d]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  10.0.0.10:80 rr<br>  -&gt; 10.0.0.7:80                  Route   1      0          119       <br>  -&gt; 10.0.0.17:80                 Route   1      0          119 <br>  <br>[root@web2 ~]<span class="hljs-comment"># systemctl stop nginx</span><br><br>[root@keepalived1 conf.d]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  10.0.0.10:80 rr<br>  -&gt; 10.0.0.7:80                  Route   1      0          39    <br><br><span class="hljs-comment">#如果两服务器都停掉，就会只想本机的127.0.0.1:80，可以在本机安装服务器并且设定sorryserver页面</span><br>[root@keepalived1 conf.d]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  10.0.0.10:80 rr<br>  -&gt; 127.0.0.1:80                 Route   1      0          4         <br>You have new mail <span class="hljs-keyword">in</span> /var/spool/mail/root<br><br><span class="hljs-comment">#问题：如果lvs指向的端口跟应用层的端口一致为什么不会冲突</span><br><span class="hljs-comment">#答：因为lvs指向的端口是内核级别，它是工作在input的链的前面。而应用层的端口是应用几倍，是工作在input的链的后面。其实是lvs把链接截住了，链接不同通向应用层。</span><br></code></pre></td></tr></table></figure>

<h5 id="3-6-3-2-实战案例2：实现双主的-LVS-DR-模式"><a href="#3-6-3-2-实战案例2：实现双主的-LVS-DR-模式" class="headerlink" title="3.6.3.2 实战案例2：实现双主的 LVS-DR 模式"></a>3.6.3.2 实战案例2：实现双主的 LVS-DR 模式</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ka1-centos8 ~]<span class="hljs-comment">#vim /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>    global_defs &#123;<br>        notification_email &#123;<br>            root@localhost<br>        &#125;<br>        notification_email_from keepalived@localhost<br>        smtp_server 127.0.0.1<br>        smtp_connect_timeout 30<br>        router_id ka1.magedu.org  <span class="hljs-comment">#另一个节点为ka2.magedu.org</span><br>        vrrp_mcast_group4 224.0.100.10<br>    &#125;<br>    <br>vrrp_instance VI_1 &#123;<br>    state MASTER   <span class="hljs-comment">#在另一个结点上为BACKUP</span><br>    interface eth0<br>    virtual_router_id 66<br>    priority 100     <span class="hljs-comment">#在另一个结点上为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1 <span class="hljs-comment">#指定VIP</span><br>    &#125;<br>&#125;<br><br>vrrp_instance VI_2 &#123;<br>    state BACKUP   <span class="hljs-comment">#在另一个结点上为MASTER</span><br>    interface eth0<br>    virtual_router_id  88<br>    priority 80     <span class="hljs-comment">#在另一个结点上为100</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.20/24 dev eth0 label eth0:2 <span class="hljs-comment">#指定VIP2</span><br>    &#125;<br>&#125;<br><br>virtual_server 10.0.0.10 80 &#123; <br>    delay_loop 6<br>    lb_algo rr<br>    lb_kind DR<br>    protocol TCP<br>    sorry_server 127.0.0.1 80<br>    real_server 10.0.0.7 80 &#123;  <span class="hljs-comment">#指定RS1地址</span><br>        weight 1<br>        HTTP_GET &#123;<br>            url &#123;<br>                path /<br>                status_code 200<br>            &#125;<br>            connect_timeout 3<br>            nb_get_retry 3<br>            delay_before_retry 3<br>        &#125;<br>    &#125;<br>    real_server 10.0.0.17 80 &#123;  <span class="hljs-comment">#指定RS2地址</span><br>        weight 1<br>        HTTP_GET &#123;<br>            url &#123;<br>                path /<br>                status_code 200<br>            &#125;<br>            connect_timeout 3<br>            nb_get_retry 3<br>            delay_before_retry 3<br>        &#125;<br>    &#125;<br>&#125;<br><br>virtual_server 10.0.0.20 80 &#123; <span class="hljs-comment">#指定VIP2</span><br>    delay_loop 6<br>    lb_algo rr<br>    lb_kind DR<br>    protocol TCP<br>    sorry_server 127.0.0.1 80<br>    real_server 10.0.0.27 80 &#123; <span class="hljs-comment">#指定RS3地址</span><br>        weight 1<br>        HTTP_GET &#123;<br>            url &#123;<br>                path /<br>                status_code 200<br>            &#125;<br>            connect_timeout 3<br>            nb_get_retry 3<br>            delay_before_retry 3<br>        &#125;<br>    &#125;<br>    real_server 10.0.0.37 80 &#123;  <span class="hljs-comment">#指定RS4地址</span><br>        weight 1<br>        HTTP_GET &#123;<br>        url &#123;<br>            path /<br>            status_code 200<br>        &#125;<br>        connect_timeout 3<br>        nb_get_retry 3<br>        delay_before_retry 3<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>范例: 双主分别实现httpd和mysql服务的调度</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Keeplived/keepalived7.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@web1 ~]<span class="hljs-comment"># yum install -y mariadb-server</span><br>[root@web1 ~]<span class="hljs-comment">#systemctl enable --now mariadb</span><br>[root@web1 ~]<span class="hljs-comment">#mysql -e &#x27;grant all on *.* to test@&quot;10.0.0.%&quot; identified by &quot;123456&quot;&#x27;</span><br><br>[root@web2 ~]<span class="hljs-comment"># yum install -y mariadb-server</span><br>[root@web2 ~]<span class="hljs-comment">#systemctl enable --now mariadb</span><br>[root@web2 ~]<span class="hljs-comment">#mysql -e &#x27;grant all on *.* to test@&quot;10.0.0.%&quot; identified by &quot;123456&quot;&#x27;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># mysql -utest -p123456 -h10.0.0.7 -e&#x27;status&#x27;</span><br>--------------<br>mysql  Ver 15.1 Distrib 5.5.68-MariaDB, <span class="hljs-keyword">for</span> Linux (x86_64) using readline 5.1<br><br>Connection id:		6<br>Current database:	<br>Current user:		<span class="hljs-built_in">test</span>@10.0.0.6<br>SSL:			Not <span class="hljs-keyword">in</span> use<br>Current pager:		stdout<br>Using outfile:		<span class="hljs-string">&#x27;&#x27;</span><br>Using delimiter:	;<br>Server:			MariaDB<br>Server version:		5.5.68-MariaDB MariaDB Server<br>Protocol version:	10<br>Connection:		10.0.0.7 via TCP/IP<br>Server characterset:	latin1<br>Db     characterset:	latin1<br>Client characterset:	utf8<br>Conn.  characterset:	utf8<br>TCP port:		3306<br>Uptime:			13 min 35 sec<br><br>Threads: 1  Questions: 15  Slow queries: 0  Opens: 0  Flush tables: 2  Open tables: 26  Queries per second avg: 0.018<br>--------------<br><br>[root@centos7 ~]<span class="hljs-comment"># mysql -utest -p123456 -h10.0.0.17 -e&#x27;status&#x27;</span><br>--------------<br>mysql  Ver 15.1 Distrib 5.5.68-MariaDB, <span class="hljs-keyword">for</span> Linux (x86_64) using readline 5.1<br><br>Connection id:		3<br>Current database:	<br>Current user:		<span class="hljs-built_in">test</span>@10.0.0.6<br>SSL:			Not <span class="hljs-keyword">in</span> use<br>Current pager:		stdout<br>Using outfile:		<span class="hljs-string">&#x27;&#x27;</span><br>Using delimiter:	;<br>Server:			MariaDB<br>Server version:		5.5.68-MariaDB MariaDB Server<br>Protocol version:	10<br>Connection:		10.0.0.17 via TCP/IP<br>Server characterset:	latin1<br>Db     characterset:	latin1<br>Client characterset:	utf8<br>Conn.  characterset:	utf8<br>TCP port:		3306<br>Uptime:			11 min 8 sec<br><br>Threads: 1  Questions: 8  Slow queries: 0  Opens: 0  Flush tables: 2  Open tables: 26  Queries per second avg: 0.011<br>--------------<br>[root@centos7 ~]<span class="hljs-comment"># mysql -utest -p123456 -h10.0.0.7 -e&#x27;show variables like &quot;%hostname&quot;&#x27;</span><br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| hostname      | web1  |<br>+---------------+-------+<br>[root@centos7 ~]<span class="hljs-comment"># mysql -utest -p123456 -h10.0.0.17 -e&#x27;show variables like &quot;%hostname&quot;&#x27;</span><br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| hostname      | web2  |<br>+---------------+-------+<br><br>[root@keepalived1 conf.d]<span class="hljs-comment"># ls</span><br>lvs_mysql.conf  lvs_web1.conf  mysql_vip.conf  web1.conf<br>[root@keepalived1 conf.d]<span class="hljs-comment"># cat web1.conf</span><br>vrrp_instance web1 &#123;<br>    state MASTER<br>    interface eth0<br>    virtual_router_id 66<br>    priority 100<br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:10<br>    &#125;<br>        notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span>                 <br>        notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>        notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>&#125;<br><br><br>[root@keepalived1 conf.d]<span class="hljs-comment"># cat lvs_web1.conf</span><br>virtual_server 10.0.0.10 80 &#123;<br>    delay_loop 3<br>    lb_algo rr<br>    lb_kind DR<br>    protocol TCP<br>    sorry_server 127.0.0.1 80<br>    real_server 10.0.0.7 80 &#123;<br>        weight 1<br>        HTTP_GET &#123;<br>            url &#123;<br>                path /monitor.html<br>                status_code 200<br>            &#125;<br>            connect_timeout 1<br>            nb_get_retry 3<br>            delay_before_retry 1<br>        &#125;<br>    &#125;<br>    real_server 10.0.0.17 80 &#123;<br>        weight 1<br>        TCP_CHECK &#123;<br>            connect_timeout 5<br>            nb_get_retry 3<br>            delay_before_retry 3<br>            connect_port 80<br>        &#125;<br>    &#125;<br>&#125;<br><br>[root@keepalived1 conf.d]<span class="hljs-comment"># cat mysql_vip.conf</span><br>vrrp_instance mysql&#123;<br>    state BACKUP<br>    interface eth0<br>    virtual_router_id 88<br>    priority 80<br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.20/24 dev eth0 label eth0:20<br>    &#125;<br>&#125;<br><br>[root@keepalived1 conf.d]<span class="hljs-comment"># cat lvs_mysql.conf</span><br>virtual_server 10.0.0.20 3306 &#123;<br>    delay_loop 3<br>    lb_algo rr<br>    lb_kind DR<br>    protocol TCP<br>    real_server 10.0.0.7 3306 &#123;<br>        weight 1<br>        TCP_CHECK &#123;<br>            connect_timeout 5<br>            nb_get_retry 3<br>            delay_before_retry 3<br>            connect_port 3306<br>        &#125;<br>    &#125;<br>    real_server 10.0.0.17 3306 &#123;<br>        weight 1<br>        TCP_CHECK &#123;<br>            connect_timeout 5<br>            nb_get_retry 3<br>            delay_before_retry 3<br>            connect_port 3306<br>        &#125;<br>    &#125;<br>&#125;<br><br>[root@ka1 conf.d]<span class="hljs-comment"># systemctl restart keepalived</span><br>[root@ka1 conf.d]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  10.0.0.10:80 rr<br>  -&gt; 10.0.0.7:80                  Route   1      0          0         <br>  -&gt; 10.0.0.17:80                 Route   1      0          0         <br>TCP  10.0.0.20:3306 rr<br>  -&gt; 10.0.0.7:3306                Route   1      0          0         <br>  -&gt; 10.0.0.17:3306               Route   1      0          0  <br>[root@ka1 conf.d]<span class="hljs-comment"># hostname -I</span><br>10.0.0.8 10.0.0.10<br><br>[root@ka2 conf.d]<span class="hljs-comment"># ls</span><br>lvs_mysql.conf  lvs_web1.conf  mysql_vip.conf  web1.conf<br>[root@keepalived2 conf.d]<span class="hljs-comment"># cat web1.conf</span><br>vrrp_instance web1 &#123;<br>    state BACKUP<br>    interface eth0<br>    virtual_router_id 66<br>    priority 80<br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:10<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>&#125;<br>[root@keepalived2 conf.d]<span class="hljs-comment"># cat lvs_web1.conf</span><br>virtual_server 10.0.0.10 80 &#123;<br>    delay_loop 3<br>    lb_algo rr<br>    lb_kind DR<br>    protocol TCP<br>    sorry_server 127.0.0.1 80<br>    real_server 10.0.0.7 80 &#123;<br>        weight 1<br>        HTTP_GET &#123;<br>            url &#123;<br>                path /<br>                status_code 200<br>            &#125;<br>            connect_timeout 1<br>            nb_get_retry 3<br>            delay_before_retry 1<br>        &#125;<br>    &#125;<br>    real_server 10.0.0.17 80 &#123;<br>        weight 1<br>       TCP_CHECK &#123;<br>            connect_timeout 5<br>            nb_get_retry 3<br>            delay_before_retry 3<br>            connect_port 80<br>        &#125;<br>    &#125;<br>&#125;<br><br>[root@keepalived2 conf.d]<span class="hljs-comment"># cat mysql_vip.conf</span><br>vrrp_instance mysql &#123;<br>    state MASTER<br>    interface eth0<br>    virtual_router_id 88<br>    priority 80<br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.20/24 dev eth0 label eth0:20<br>    &#125;<br>&#125;<br><br>[root@keepalived2 conf.d]<span class="hljs-comment"># cat lvs_mysql.conf</span><br>virtual_server 10.0.0.20 3306 &#123;<br>        delay_loop 3<br>        lb_algo rr<br>        lb_kind DR<br>        protocol TCP<br>    real_server 10.0.0.7 3306 &#123;<br>        weight 1<br>        TCP_CHECK &#123;<br>            connect_timeout 5<br>            nb_get_retry 3<br>            delay_before_retry 3<br>            connect_port 3306<br>        &#125;<br>    &#125;<br>    real_server 10.0.0.17 3306 &#123;<br>        weight 1<br>        TCP_CHECK &#123;<br>            connect_timeout 5<br>            nb_get_retry 3<br>            delay_before_retry 3<br>            connect_port 3306<br>        &#125;<br>    &#125;<br>&#125;<br><br>[root@keepalived2 conf.d]<span class="hljs-comment"># systemctl restart keepalived</span><br>[root@keepalived2 conf.d]<span class="hljs-comment"># ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  10.0.0.10:80 rr<br>  -&gt; 10.0.0.7:80                  Route   1      0          0         <br>  -&gt; 10.0.0.17:80                 Route   1      0          0         <br>TCP  10.0.0.20:3306 rr<br>  -&gt; 10.0.0.7:3306                Route   1      0          0         <br>  -&gt; 10.0.0.17:3306               Route   1      0          0       <br>[root@ka2 conf.d]<span class="hljs-comment"># hostname -I</span><br>10.0.0.18 10.0.0.20 <br><br><br><span class="hljs-comment">#注意:在后端服务器要实现两个VIP的配置</span><br>[root@web1 ~]<span class="hljs-comment"># ifconfig lo:2 10.0.0.20/32</span><br>[root@web2 ~]<span class="hljs-comment"># ifconfig lo:2 10.0.0.20/32</span><br>[root@web1 ~]<span class="hljs-comment">#ip a show lo</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet 10.0.0.100/32 scope global lo:1<br>   valid_lft forever preferred_lft forever<br> inet 10.0.0.200/32 scope global lo:2<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>   <br>[root@ka1 ~]<span class="hljs-comment">#ipvsadm -Ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br> -&gt; RemoteAddress:Port      Forward Weight ActiveConn InActConn<br>TCP  10.0.0.100:80 rr<br> -&gt; 10.0.0.7:80         Route  1    0      0    <br> -&gt; 10.0.0.17:80         Route  1    0      0    <br>TCP  10.0.0.200:3306 rr<br> -&gt; 10.0.0.7:3306        Route  1    0      0    <br> -&gt; 10.0.0.17:3306        Route  1    0      0  <br> <br> <span class="hljs-comment">#测试</span><br>[root@client ~]<span class="hljs-comment">#while true;do mysql -utest -p123456 -h10.0.0.20 -e &#x27;show variables like &quot;%hostname%&quot;&#x27;;curl 10.0.0.10;sleep 0.5;done</span><br>+---------------+-----------------+<br>| Variable_name | Value      |<br>+---------------+-----------------+<br>| hostname   | web1.magedu.org |<br>+---------------+-----------------+<br>10.0.0.17<br>+---------------+-----------------+<br>| Variable_name | Value      |<br>+---------------+-----------------+<br>| hostname   | web2.magedu.org |<br>+---------------+-----------------+<br>10.0.0.7<br></code></pre></td></tr></table></figure>

<h5 id="3-6-3-3-实战案例3：实现单主的-LVS-DR-模式，利用FWM绑定成多个服务为一个集群服务"><a href="#3-6-3-3-实战案例3：实现单主的-LVS-DR-模式，利用FWM绑定成多个服务为一个集群服务" class="headerlink" title="3.6.3.3 实战案例3：实现单主的 LVS-DR 模式，利用FWM绑定成多个服务为一个集群服务"></a>3.6.3.3 实战案例3：实现单主的 LVS-DR 模式，利用FWM绑定成多个服务为一个集群服务</h5><p>参考文档： 注意有bug</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/share/doc/keepalived/keepalived.conf.fwmark<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#两个服务器都要执行以下操作</span><br>[root@web1 ~]<span class="hljs-comment"># yum -y install mod_ssl httpd</span><br>[root@web1 ~]<span class="hljs-comment"># systemctl start httpd</span><br>[root@web1 ~]<span class="hljs-comment"># ss -tnl #会生成443端口</span><br>State      Recv-Q Send-Q                    Local Address:Port                                   Peer Address:Port              <br>LISTEN     0      50                                    *:3306                                              *:*                  <br>LISTEN     0      128                                   *:22                                                *:*                  <br>LISTEN     0      100                           127.0.0.1:25                                                *:*                  <br>LISTEN     0      128                                [::]:80                                             [::]:*                  <br>LISTEN     0      128                                [::]:22                                             [::]:*                  <br>LISTEN     0      100                               [::1]:25                                             [::]:*                  <br>LISTEN     0      128                                [::]:443                                            [::]:*            <br><br>[root@centos7 ~]<span class="hljs-comment"># curl -k https://10.0.0.7/</span><br>10.0.0.7<br>[root@centos7 ~]<span class="hljs-comment"># curl -k https://10.0.0.17/</span><br>10.0.0.17<br><br><br><span class="hljs-comment">#两个节点都执行以下操作</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#iptables -t mangle -A PREROUTING -d 10.0.0.10 -p tcp -m multiport --dports 80,443 -j MARK --set-mark 6</span><br>[root@keepalived1 ~]<span class="hljs-comment"># iptables -t mangle -vnL</span><br>Chain PREROUTING (policy ACCEPT 167 packets, 14347 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br>    0     0 MARK       tcp  --  *      *       0.0.0.0/0            10.0.0.10            multiport dports 80,443 MARK <span class="hljs-built_in">set</span> 0x6<br><br>Chain INPUT (policy ACCEPT 167 packets, 14347 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain OUTPUT (policy ACCEPT 211 packets, 12478 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br>Chain POSTROUTING (policy ACCEPT 211 packets, 12478 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         <br><br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#vim /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>    global_defs &#123;<br>        notification_email &#123;<br>         root@localhost<br>        &#125;<br>    notification_email_from kaadmin@localhost<br>    smtp_server 127.0.0.1<br>    smtp_connect_timeout 30<br>    router_id ka1.magedu.org <span class="hljs-comment">#在另一个节点为ka2.magedu.org</span><br>    vrrp_mcast_group4 224.100.100.100<br>    &#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER <span class="hljs-comment">#在另一个节点为BACKUP</span><br>    interface eth0<br>    virtual_router_id 66<br>    priority 100 <span class="hljs-comment">#在另一个节点为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>    track_interface &#123;<br>        eth0<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>&#125;<br><br>virtual_server fwmark 6 &#123;  <span class="hljs-comment">#指定FWM为6</span><br>    delay_loop 2<br>    lb_algo rr<br>    lb_kind DR<br>    sorry_server 127.0.0.1 80  <span class="hljs-comment">#注意端口必须指定</span><br>    real_server 10.0.0.7 80 &#123;  <span class="hljs-comment">#注意端口必须指定</span><br>        weight 1<br>        HTTP_GET &#123;<br>            url &#123;<br>                path /<br>                status_code 200<br>            &#125;<br>            connect_timeout 2<br>            nb_get_retry 3<br>            delay_before_retry 3<br>        &#125;<br>    &#125;<br>    real_server 10.0.0.17 80 &#123; <span class="hljs-comment">#注意端口必须指定</span><br>    weight 1<br>    HTTP_GET &#123;<br>        url &#123;<br>            path /<br>            status_code 200<br>        &#125;<br>        connect_timeout 2<br>        nb_get_retry 3<br>        delay_before_retry 3<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#在RS1和RS2运行下面脚本</span><br>[root@rs1 ~]<span class="hljs-comment">#cat lvs_dr_rs.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#Author:wangxiaochun</span><br><span class="hljs-comment">#Date:2017-08-13</span><br>vip=10.0.0.10<br>vip2=10.0.0.20<br>mask=<span class="hljs-string">&#x27;255.255.255.255&#x27;</span><br>dev=lo:1<br>dev2=lo:2<br>rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null<br>service httpd start &amp;&gt; /dev/null &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The httpd Server is Ready!&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot;</span> &gt; /var/www/html/index.html<br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>start)<br>  <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br>  <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore<br>  <span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce<br>  <span class="hljs-built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce<br> ifconfig <span class="hljs-variable">$dev</span> <span class="hljs-variable">$vip</span> netmask <span class="hljs-variable">$mask</span> <span class="hljs-comment">#broadcast $vip up</span><br> ifconfig <span class="hljs-variable">$dev2</span> <span class="hljs-variable">$vip2</span> netmask <span class="hljs-variable">$mask</span> <span class="hljs-comment">#broadcast $vip up</span><br>  <span class="hljs-comment">#route add -host $vip dev $dev</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The RS Server is Ready!&quot;</span><br> ;;<br>stop)<br> ifconfig <span class="hljs-variable">$dev</span> down<br> ifconfig <span class="hljs-variable">$dev2</span> down<br>  <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br>  <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore<br>  <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce<br>  <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The RS Server is Canceled!&quot;</span><br> ;;<br>*)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-subst">$(basename $0)</span> start|stop&quot;</span><br>  <span class="hljs-built_in">exit</span> 1<br> ;;<br><span class="hljs-keyword">esac</span><br><br>[root@rs1 ~]<span class="hljs-comment">#bash lvs_dr_rs.sh start</span><br>[root@rs2 ~]<span class="hljs-comment">#bash lvs_dr_rs.sh start</span><br><br><span class="hljs-comment">#访问测试</span><br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.10;curl -k https://10.0.0.20</span><br>&lt;h1&gt;rs1.magedu.org&lt;/h1&gt;<br>&lt;h1&gt;rs2.magedu.org&lt;/h1&gt;<br></code></pre></td></tr></table></figure>

<h3 id="3-7-实现其它应用的高可用性-VRRP-Script"><a href="#3-7-实现其它应用的高可用性-VRRP-Script" class="headerlink" title="3.7 实现其它应用的高可用性 VRRP Script"></a>3.7 实现其它应用的高可用性 VRRP Script</h3><p>keepalived利用 VRRP Script 技术，可以调用外部的辅助脚本进行资源监控，并根据监控的结果实现优先动态调整，从而实现其它应用的高可用性功能</p>
<p>参考配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/share/doc/keepalived/keepalived.conf.vrrp.localcheck<br></code></pre></td></tr></table></figure>

<h4 id="3-7-1-VRRP-Script-配置"><a href="#3-7-1-VRRP-Script-配置" class="headerlink" title="3.7.1 VRRP Script 配置"></a>3.7.1 VRRP Script 配置</h4><p>分两步实现：</p>
<ul>
<li><p>定义脚本<br>vrrp_script：自定义资源监控脚本，vrrp实例根据脚本返回值，公共定义，可被多个实例调用，定义在vrrp实例之外的独立配置块，一般放在<strong>global_defs</strong>设置块之后。</p>
<p>通常此脚本用于监控指定应用的状态。一旦发现应用的状态异常，则触发对MASTER节点的权重减<br>至低于SLAVE节点，从而实现 VIP 切换到 SLAVE 节点</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">vrrp_script &lt;SCRIPT_NAME&gt; &#123;<br>    script &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="hljs-comment">#此脚本返回值为非0时，会触发下面OPTIONS执行</span><br>    OPTIONS<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>调用脚本<br>track_script：调用vrrp_script定义的脚本去监控资源，定义在VRRP实例之内，调用事先定义的<br>vrrp_script</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">track_script &#123;<br>    SCRIPT_NAME_1<br>    SCRIPT_NAME_2<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-7-1-1-定义-VRRP-script"><a href="#3-7-1-1-定义-VRRP-script" class="headerlink" title="3.7.1.1 定义 VRRP script"></a>3.7.1.1 定义 VRRP script</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">vrrp_script &lt;SCRIPT_NAME&gt; &#123; <span class="hljs-comment">#定义一个检测脚本，在global_defs 之外配置</span><br>    script &lt;STRING&gt;|&lt;QUOTED-STRING&gt; <span class="hljs-comment">#shell命令或脚本路径</span><br>    interval &lt;INTEGER&gt; <span class="hljs-comment">#间隔时间，单位为秒，默认1秒</span><br>    timeout &lt;INTEGER&gt; <span class="hljs-comment">#超时时间</span><br>    weight &lt;INTEGER:-254..254&gt; <span class="hljs-comment">#默认为0,如果设置此值为负数，当上面脚本返回值为非0时，会将此值与本节点权重相加可以降低本节点权重，即表示fall. 如果是正数，当脚本返回值为0，会将此值与本节点权重相加可以提高本节点权重，即表示 rise.通常使用负值</span><br>    fall &lt;INTEGER&gt;    <span class="hljs-comment">#脚本几次失败转换为失败，建议设为2以上</span><br>    rise &lt;INTEGER&gt;    <span class="hljs-comment">#脚本连续监测成功后，把服务器从失败标记为成功的次数</span><br>    user USERNAME [GROUPNAME] <span class="hljs-comment">#执行监测脚本的用户或组   </span><br>    init_fail     <span class="hljs-comment">#设置默认标记为失败状态，监测成功之后再转换为成功状态</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-7-1-2-调用-VRRP-script"><a href="#3-7-1-2-调用-VRRP-script" class="headerlink" title="3.7.1.2 调用 VRRP script"></a>3.7.1.2 调用 VRRP script</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vrrp_instance VI_1 &#123;<br>    …<br>    track_script &#123;<br>        chk_down<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-7-2-实战案例：利用脚本实现主从角色切换"><a href="#3-7-2-实战案例：利用脚本实现主从角色切换" class="headerlink" title="3.7.2 实战案例：利用脚本实现主从角色切换"></a>3.7.2 实战案例：利用脚本实现主从角色切换</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>    global_defs &#123;<br>        notification_email &#123;<br>        root@localhost<br>        &#125;<br>    notification_email_from kaadmin@localhost<br>    smtp_server 127.0.0.1<br>    smtp_connect_timeout 30<br>    router_id ka1.magedu.org <span class="hljs-comment">#在另一个节点为ka2.magedu.org</span><br>    vrrp_mcast_group4 224.0.100.100<br>&#125;<br><br>vrrp_script check_down &#123;<br>    script <span class="hljs-string">&quot;[ ! -f /etc/keepalived/down ]&quot;</span> <span class="hljs-comment">#/etc/keepalived/down存在时返回非0，触发权重-30。注意：如果这样写有问题的话可以将shell命令写到脚本里，然后在填上脚本的地址</span><br>    interval 1<br>    weight -30<br>    fall 3<br>    rise 2<br>    timeout 2<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER <span class="hljs-comment">#在另一个节点为BACKUP</span><br>    interface eth0<br>    virtual_router_id 66<br>    priority 100 <span class="hljs-comment">#在另一个节点为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>    track_interface &#123;<br>        eth0<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>    track_script &#123;<br>        check_down      <span class="hljs-comment">#调用前面定义的脚本</span><br>    &#125;<br>&#125;<br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#touch /etc/keepalived/down</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#tail -f /var/log/messages</span><br>Mar 28 19:47:03 ka1-centos8 Keepalived_vrrp[7200]: Script `check_down` now<br>returning 1<br>Mar 28 19:47:05 ka1-centos8 Keepalived_vrrp[7200]: VRRP_Script(chk_down) failed<br>(exited with status 1)<br>Mar 28 19:47:05 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Changing effective<br>priority from 100 to 70<br>Mar 28 19:47:07 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Master received advert<br>from 10.0.0.18 with higher priority 80, ours 70<br>Mar 28 19:47:07 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Entering BACKUP STATE<br>Mar 28 19:47:07 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) removing VIPs.<br>[root@rs1 ~]<span class="hljs-comment">#tcpdump -i eth0 -nn 224.0.100.100</span><br>19:42:09.578203 IP 10.0.0.8 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66,<br>prio 100, authtype simple, intvl 1s, length 20<br>19:42:10.579304 IP 10.0.0.8 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66,<br>prio 70, authtype simple, intvl 1s, length 20<br><br>[root@ka1-centos8 ~]<span class="hljs-comment">#rm -f /etc/keepalived/down</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#tail -f /var/log/messages</span><br>Mar 28 19:47:45 ka1-centos8 Keepalived_vrrp[7200]: Script `check_down` now<br>returning 0<br>Mar 28 19:47:46 ka1-centos8 Keepalived_vrrp[7200]: VRRP_Script(check_down)<br>succeeded<br>Mar 28 19:47:46 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Changing effective<br>priority from 70 to 100<br>Mar 28 19:47:46 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) received lower<br>priority (80) advert from 10.0.0.18 - discarding<br>Mar 28 19:47:47 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) received lower<br>priority (80) advert from 10.0.0.18 - discarding<br>Mar 28 19:47:48 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) received lower<br>priority (80) advert from 10.0.0.18 - discarding<br>Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Receive advertisement<br>timeout<br>Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Entering MASTER STATE<br>Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) setting VIPs.<br>Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: Sending gratuitous ARP on<br>eth0 <span class="hljs-keyword">for</span> 10.0.0.10<br>Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Sending/queueing<br>gratuitous ARPs on eth0 <span class="hljs-keyword">for</span> 10.0.0.10<br>Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: Sending gratuitous ARP on<br>eth0 <span class="hljs-keyword">for</span> 10.0.0.10<br>Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: Sending gratuitous ARP on<br>eth0 <span class="hljs-keyword">for</span> 10.0.0.10<br><br>[root@rs1 ~]<span class="hljs-comment">#tcpdump -i eth0 -nn 224.0.100.100</span><br>19:49:16.199462 IP 10.0.0.18 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66,<br>prio 80, authtype simple, intvl 1s, length 20<br>19:49:17.199897 IP 10.0.0.18 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66,<br>prio 80, authtype simple, intvl 1s, length 20<br>19:49:17.810376 IP 10.0.0.8 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66,<br>prio 100, authtype simple, intvl 1s, length 20<br>19:49:18.811048 IP 10.0.0.8 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66,<br>prio 100, authtype simple, intvl 1s, length 20<br></code></pre></td></tr></table></figure>

<h4 id="3-7-3-实战案例：实现单主模式的Nginx反向代理的高可用"><a href="#3-7-3-实战案例：实现单主模式的Nginx反向代理的高可用" class="headerlink" title="3.7.3 实战案例：实现单主模式的Nginx反向代理的高可用"></a>3.7.3 实战案例：实现单主模式的Nginx反向代理的高可用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在两个节点都配置nginx反向代理</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#vim /etc/nginx/nginx.conf</span><br>http &#123;<br>upstream websrvs &#123;<br>server 10.0.0.7:80 weight=1;<br>server 10.0.0.17:80 weight=1;<br>&#125;<br>server &#123;<br>listen 80;<br>location /&#123;<br>proxy_pass http://websrvs/;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">#在两个节点都配置实现nginx反向代理高可用</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>    global_defs &#123;<br>        notification_email &#123;<br>        root@localhost<br>        &#125;<br>    notification_email_from kaadmin@localhost<br>    smtp_server 127.0.0.1<br>    smtp_connect_timeout 30<br>    router_id ka1.magedu.org <span class="hljs-comment">#在另一个节点为ka2.magedu.org</span><br>    vrrp_mcast_group4 224.0.100.100<br>&#125;<br>vrrp_script check_nginx &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/check_nginx.sh&quot;</span><br>    <span class="hljs-comment">#script &quot;/usr/bin/killall -0 nginx&quot;  此写法支持</span><br>    <span class="hljs-comment">#script &quot;/usr/bin/killall -0 nginx &amp;&gt;/dev/null&quot; 不支持&amp;&gt;此写法</span><br>    interval 1<br>    weight -30<br>    fall 3<br>    rise 5<br>    timeout 2<br>&#125;<br>vrrp_instance VI_1 &#123;<br>    state MASTER <span class="hljs-comment">#在另一个节点为BACKUP</span><br>    interface eth0<br>    virtual_router_id 66<br>    priority 100 <span class="hljs-comment">#在另一个节点为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>    track_interface &#123;<br>        eth0<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>    track_script &#123;<br>    check_nginx<br>    &#125;<br>&#125;<br><br>[root@ka1-centos8 ~]<span class="hljs-comment"># yum install psmisc -y</span><br>[root@ka1-centos8 ~]<span class="hljs-comment"># cat /etc/keepalived/check_nginx.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>/usr/bin/killall -0 nginx || systemctl restart nginx <span class="hljs-comment">#后面的为nginx自动修复功能</span><br>[root@ka1-centos8 ~]<span class="hljs-comment"># chmod a+x /etc/keepalived/check_nginx.sh</span><br></code></pre></td></tr></table></figure>

<p>范例: 利用通知脚本,实现切换时，自动重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/keepalived/notify.sh<br>!/bin/bash<br>contact=<span class="hljs-string">&#x27;root@localhost&#x27;</span><br><span class="hljs-function"><span class="hljs-title">notify</span></span>() &#123;<br>    mailsubject=<span class="hljs-string">&quot;<span class="hljs-subst">$(hostname)</span> to be  <span class="hljs-variable">$1</span>:vip floating&quot;</span><br>    mailbody=<span class="hljs-string">&quot;<span class="hljs-subst">$(date +&#x27;%F %T&#x27;)</span>:vrrp transition,<span class="hljs-subst">$(hostname)</span> change to be <span class="hljs-variable">$1</span>&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$mailbody</span> | mail -s <span class="hljs-string">&quot;<span class="hljs-variable">$mailsubject</span>&quot;</span> <span class="hljs-variable">$contract</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>master)<br>    notify master<br>    systemctl start nginx<br>    ;;<br>backup)<br>    notify backup<br>    systemctl restart nginx<br>    ;;<br>fault)<br>    notify fault<br>    ;;<br>*)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-subst">$(basename $0)</span> &#123;master|backup|fault&#125;&quot;</span><br><span class="hljs-keyword">esac</span><br></code></pre></td></tr></table></figure>

<h4 id="3-7-4-实战案例：实现双主模式Nginx反向代理的高可用"><a href="#3-7-4-实战案例：实现双主模式Nginx反向代理的高可用" class="headerlink" title="3.7.4 实战案例：实现双主模式Nginx反向代理的高可用"></a>3.7.4 实战案例：实现双主模式Nginx反向代理的高可用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在两个节点都配置nginx反向代理</span><br>[root@ka1-centos8 ~]vim /etc/nginx/nginx.conf<br>http &#123;<br>    upstream websrvs &#123;<br>        server 10.0.0.7:80 weight=1;<br>        server 10.0.0.17:80 weight-1;<br>    &#125;<br>    upstream websrvs2 &#123;<br>        server 10.0.0.27:80 weight=1;<br>        server 10.0.0.37:80 weight-1;<br>    &#125;<br><br>    server &#123;<br>        listen 80;<br>        server_name www.a.com;<br>        location /&#123;<br>            proxy_pass http://webservs/;<br>        &#125;<br>    &#125;<br>    server &#123;<br>        listen 80;<br>        server_name www.b.com;<br>        location /&#123;<br>            proxy_pass http://webservs2/;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#在两个节点都配置实现双主模式的nginx反向代理高可用</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>    global_defs &#123;<br>        notification_email &#123;<br>        root@localhost<br>        &#125;<br>    notification_email_from kaadmin@localhost<br>    smtp_server 127.0.0.1<br>    smtp_connect_timeout 30<br>    router_id ka1.magedu.org <span class="hljs-comment">#在另一个节点为ka2.magedu.org</span><br>    vrrp_mcast_group4 224.100.100.100<br>&#125;<br>vrrp_script check_nginx &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/check_nginx.sh&quot;</span><br>    <span class="hljs-comment">#script &quot;/usr/bin/killall -0 nginx&quot;</span><br>    interval 1<br>    weight -30<br>    fall 3<br>    rise 5<br>    timeout 2<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER <span class="hljs-comment">#在另一个节点为BACKUP</span><br>    interface eth0<br>    virtual_router_id 66<br>    priority 100 <span class="hljs-comment">#在另一个节点为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>    track_interface &#123;<br>        eth0<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>    track_script &#123;<br>        check_nginx<br>    &#125;<br>&#125;<br><br>vrrp_instance VI_2 &#123;<br>    state BACKUP <span class="hljs-comment">#在另一个节点为MASTER</span><br>    interface eth0<br>    virtual_router_id 88<br>    priority 80 <span class="hljs-comment">#在另一个节点为100</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.20/24 dev eth0 label eth0:2<br>    &#125;<br>    track_interface &#123;<br>        eth0<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>    track_script &#123;<br>        check_nginx<br>    &#125;<br>&#125;<br><br>[root@ka1-centos8 ~]<span class="hljs-comment"># yum install psmisc -y</span><br>[root@ka1-centos8 ~]<span class="hljs-comment"># cat /etc/keepalived/check_nginx.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>/usr/bin/killall -0 nginx  <br>[root@ka1-centos8 ~]<span class="hljs-comment"># chmod a+x /etc/keepalived/check_nginx.sh</span><br></code></pre></td></tr></table></figure>

<h4 id="3-7-5-实战案例：实现HAProxy高可用"><a href="#3-7-5-实战案例：实现HAProxy高可用" class="headerlink" title="3.7.5 实战案例：实现HAProxy高可用"></a>3.7.5 实战案例：实现HAProxy高可用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在两个ka1和ka2先实现haproxy的配置</span><br>[root@ka1 ~]<span class="hljs-comment">#cat /etc/haproxy/haproxy.cfg</span><br>listen magedu_http<br>    <span class="hljs-built_in">bind</span> 10.0.0.10:80<br>    server web1 10.0.0.7:80 check<br>    server web2 10.0.0.17:80 check<br> <br>listen stats<br>    mode http<br>    <span class="hljs-built_in">bind</span> 10.0.0.8:9999<br>    stats <span class="hljs-built_in">enable</span><br>    <span class="hljs-built_in">log</span> global<br>    stats uri   /haproxy-status<br>    stats auth  haadmin:123456<br>    <br><span class="hljs-comment">#在两个ka1和ka2两个节点启用内核参数</span><br>[root@ka1，2 ~]<span class="hljs-comment">#vim /etc/sysctl.conf</span><br>net.ipv4.ip_nonlocal_bind = 1<br>[root@ka1，2 ~]<span class="hljs-comment">#sysctl -p</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>    global_defs &#123;<br>        notification_email &#123;<br>        root@localhost<br>    &#125;<br>    notification_email_from kaadmin@localhost<br>    smtp_server 127.0.0.1<br>    smtp_connect_timeout 30<br>    router_id ka1.magedu.org <span class="hljs-comment">#在另一个节点为ka2.magedu.org</span><br>    vrrp_mcast_group4 224.0.100.100<br>&#125;<br>vrrp_script check_haproxy &#123; <span class="hljs-comment">#定义脚本</span><br>    script <span class="hljs-string">&quot;/etc/keepalived/check_haproxy.sh&quot;</span><br>    interval 1<br>    weight -30<br>    fall 3<br>    rise 2<br>    timeout 2<br>&#125;<br>vrrp_instance VI_1 &#123;<br>    state MASTER <span class="hljs-comment">#在另一个节点为BACKUP</span><br>    interface eth0<br>    virtual_router_id 66<br>    priority 100 <span class="hljs-comment">#在另一个节点为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>    track_interface &#123;<br>        eth0<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>    track_script &#123;<br>        check_haproxy <span class="hljs-comment">#调用上面定义的脚本</span><br>    &#125;<br>&#125;<br><br>[root@ka1-centos8 ~]<span class="hljs-comment"># yum install psmisc -y</span><br>[root@ka1-centos8 ~]<span class="hljs-comment"># cat /etc/keepalived/check_haproxy.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>/usr/bin/killall -0 haproxy || systemctl restart haproxy<br>[root@ka1-centos8 ~]<span class="hljs-comment"># chmod a+x /etc/keepalived/check_haproxy.sh</span><br></code></pre></td></tr></table></figure>

<h4 id="3-7-6-实战案例：实现MySQL双主模式的高可用"><a href="#3-7-6-实战案例：实现MySQL双主模式的高可用" class="headerlink" title="3.7.6 实战案例：实现MySQL双主模式的高可用"></a>3.7.6 实战案例：实现MySQL双主模式的高可用</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Keeplived/keepalived8.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-7-6-1-方法一：（参考：https-www-cnblogs-com-kevingrace-p-6710136-html）"><a href="#3-7-6-1-方法一：（参考：https-www-cnblogs-com-kevingrace-p-6710136-html）" class="headerlink" title="3.7.6.1 方法一：（参考：https://www.cnblogs.com/kevingrace/p/6710136.html）"></a>3.7.6.1 方法一：（参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/kevingrace/p/6710136.html%EF%BC%89">https://www.cnblogs.com/kevingrace/p/6710136.html）</a></h5><p><strong>1.MySQL主主同步环境部署</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><code class="hljs bash">-----ka1服务器操作-----<br>[root@keepalived1 ~]<span class="hljs-comment">#yum install -y mariadb-server</span><br>[root@keepalived1 ~]<span class="hljs-comment">#systemctl enable --now mariadb</span><br>[root@keepalived1 ~]<span class="hljs-comment"># mysql_secure_installation #设置密码</span><br>[root@keepalived1 ~]<span class="hljs-comment">#vim /etc/my.cnf</span><br>[mysqld]配置区域添加下面内容：<br>server-id = 1         <br>log-bin = mysql-bin     <br>sync_binlog = 1<br>binlog_checksum = none<br>binlog_format = mixed<br>auto-increment-increment = 2     <br>auto-increment-offset = 1    <br>slave-skip-errors = all<br>[root@keepalived1 ~]<span class="hljs-comment">#systemctl restart mariadb</span><br><br><span class="hljs-comment">#数据同步授权（iptables防火墙开启3306端口）这样I/O线程就可以以这个用户的身份连接到主服务器，并且读取它的二进制日志。</span><br>[root@keepalived1 ~]<span class="hljs-comment">#mysql</span><br>MariaDB [(none)]&gt; grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected (0.00 sec)<br><br>MariaDB [(none)]&gt; flush privileges;<br>Query OK, 0 rows affected (0.01 sec)<br><br><span class="hljs-comment">#最好将库锁住，仅仅允许读，以保证数据一致性；待主主同步环境部署后再解锁；锁住后，就不能往表里写数据，但是重启mysql服务后就会自动解锁！</span><br>MariaDB [(none)] flush tables with <span class="hljs-built_in">read</span> lock;  <span class="hljs-comment">#注意该参数设置后，如果自己同步对方数据，同步前一定要记得先解锁！</span><br>Query OK, 0 rows affected (0.00 sec)<br><br><span class="hljs-comment">#查看下log bin日志和pos值位置</span><br>MariaDB [(none)]&gt; show master status;<br>+------------------+----------+--------------+------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |<br>+------------------+----------+--------------+------------------+<br>| mysql-bin.000003 |     1794 |              |                  |<br>+------------------+----------+--------------+------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>-----k2服务器操作-----<br>[root@keepalived2 ~]<span class="hljs-comment">#yum install -y mariadb-server</span><br>[root@keepalived2 ~]<span class="hljs-comment">#systemctl enable --now mariadb</span><br>[root@keepalived2 ~]<span class="hljs-comment"># mysql_secure_installation #设置密码</span><br>[root@keepalived2 ~]<span class="hljs-comment">#vim /etc/my.cnf</span><br>[mysqld]配置区域添加下面内容：<br>server-id = 2        <br>log-bin = mysql-bin    <br>sync_binlog = 1<br>binlog_checksum = none<br>binlog_format = mixed<br>auto-increment-increment = 2     <br>auto-increment-offset = 2    <br>slave-skip-errors = all<br>[root@keepalived2 ~]<span class="hljs-comment"># systemctl restart mariadb</span><br>[root@keepalived2 ~]<span class="hljs-comment"># mysql</span><br><br><br>MariaDB [(none)]&gt; grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected (0.01 sec)<br><br>MariaDB [(none)]&gt; flush privileges;<br>Query OK, 0 rows affected (0.00 sec)<br><br>MariaDB [(none)]&gt; flush tables with <span class="hljs-built_in">read</span> lock;<br>Query OK, 0 rows affected (0.00 sec)<br><br>MariaDB [(none)]&gt; show master status;<br>+------------------+----------+--------------+------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |<br>+------------------+----------+--------------+------------------+<br>| mysql-bin.000003 |     1794 |              |                  |<br>+------------------+----------+--------------+------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>-----k1服务器同步操作-----<br>MariaDB [(none)]&gt; unlock tables;<br>Query OK, 0 rows affected (0.00 sec)<br><br>MariaDB [(none)]&gt; change master to master_host=<span class="hljs-string">&#x27;10.0.0.18&#x27;</span>,master_user=<span class="hljs-string">&#x27;repluser&#x27;</span>,master_password=<span class="hljs-string">&#x27;123456&#x27;</span>,master_log_file=<span class="hljs-string">&#x27;mysql-bin.000001&#x27;</span>,master_log_pos=481;<br>Query OK, 0 rows affected (0.02 sec)<br><br>MariaDB [(none)]&gt; start slave;<br>Query OK, 0 rows affected (0.00 sec)<br><br>MariaDB [(none)]&gt; show slave status\G <span class="hljs-comment">#注意要有两个yes</span><br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> master to send event<br>                  Master_Host: 10.0.0.18<br>                  Master_User: repluser<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000003<br>          Read_Master_Log_Pos: 1794<br>               Relay_Log_File: mariadb-relay-bin.000002<br>                Relay_Log_Pos: 529<br>        Relay_Master_Log_File: mysql-bin.000003<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB: <br>          Replicate_Ignore_DB: <br>           Replicate_Do_Table: <br>       Replicate_Ignore_Table: <br>      Replicate_Wild_Do_Table: <br>  Replicate_Wild_Ignore_Table: <br>                   Last_Errno: 0<br>                   Last_Error: <br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 1794<br>              Relay_Log_Space: 825<br>              Until_Condition: None<br>               Until_Log_File: <br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File: <br>           Master_SSL_CA_Path: <br>              Master_SSL_Cert: <br>            Master_SSL_Cipher: <br>               Master_SSL_Key: <br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 2<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><span class="hljs-comment">#k1就和k2实现了主从同步，即k1同步k2的数据。</span><br><br>-----k2服务器同步操作-----<br>MariaDB [(none)]&gt; unlock tables;  <span class="hljs-comment">#先解锁，将对方数据同步到自己的数据库中</span><br>Query OK, 0 rows affected (0.00 sec) <br><br>MariaDB [(none)]&gt; slave stop;<br>Query OK, 0 rows affected, 1 warning (0.00 sec)<br><br>MariaDB [(none)]&gt; change master to master_host=<span class="hljs-string">&#x27;10.0.0.8&#x27;</span>,master_user=<span class="hljs-string">&#x27;repluser&#x27;</span>,master_password=<span class="hljs-string">&#x27;123456&#x27;</span>,master_log_file=<span class="hljs-string">&#x27;mysql-bin.000003&#x27;</span>,master_log_pos=1794;<br>Query OK, 0 rows affected (0.00 sec)<br><br>MariaDB [(none)]&gt; start slave;<br>Query OK, 0 rows affected (0.00 sec)<br><br>MariaDB [(none)]&gt; show slave status\G; <span class="hljs-comment">#注意要有两个yes</span><br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> master to send event<br>                  Master_Host: 10.0.0.8<br>                  Master_User: repluser<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000003<br>          Read_Master_Log_Pos: 1794<br>               Relay_Log_File: mariadb-relay-bin.000002<br>                Relay_Log_Pos: 529<br>        Relay_Master_Log_File: mysql-bin.000003<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB: <br>          Replicate_Ignore_DB: <br>           Replicate_Do_Table: <br>       Replicate_Ignore_Table: <br>      Replicate_Wild_Do_Table: <br>  Replicate_Wild_Ignore_Table: <br>                   Last_Errno: 0<br>                   Last_Error: <br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 1794<br>              Relay_Log_Space: 825<br>              Until_Condition: None<br>               Until_Log_File: <br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File: <br>           Master_SSL_CA_Path: <br>              Master_SSL_Cert: <br>            Master_SSL_Cipher: <br>               Master_SSL_Key: <br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 1<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>ERROR: No query specified<br><br><span class="hljs-comment">#k2就和k1实现了主从同步，即k2也同步k1的数据。</span><br><br>-----主主同步效果验证-----<br><span class="hljs-comment">#在k1数据库上写入新数据</span><br>MariaDB [(none)]&gt; unlock tables;<br>Query OK, 0 rows affected (0.00 sec)<br><br>MariaDB [(none)]&gt; create database rlin;<br>Query OK, 1 row affected (0.00 sec)<br><br>MariaDB [(none)]&gt; use rlin;<br>Database changed<br>MariaDB [rlin]&gt; create table <span class="hljs-keyword">if</span> not exists t1(<br>    -&gt; id int(10) PRIMARY KEY AUTO_INCREMENT,<br>    -&gt; name varchar(50) NOT NULL);<br>Query OK, 0 rows affected (0.02 sec)<br><br>MariaDB [rlin]&gt; insert into t1 values(1,<span class="hljs-string">&quot;laowang&quot;</span>);<br>Query OK, 1 row affected, 1 warning (0.00 sec)<br><br>MariaDB [rlin]&gt; insert into t1 values(2,<span class="hljs-string">&quot;chuanchuan&quot;</span>);<br>Query OK, 1 row affected, 1 warning (0.00 sec)<br><br>MariaDB [rlin]&gt; select * from t1;<br>+----+------------+<br>| id | name       |<br>+----+------------+<br>|  1 | laowang    |<br>|  2 | chuanchuan |<br>+----+------------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#k2数据库上查看，发现数据已经同步过来了!</span><br>MariaDB [(none)]&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| rlin               |<br>+--------------------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>Database changed<br>MariaDB [rlin]&gt; show tables;<br>+----------------+<br>| Tables_in_rlin |<br>+----------------+<br>| t1             |<br>+----------------+<br>1 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>MariaDB [rlin]&gt; select * from t1；<br>+----+------------+<br>| id | name       |<br>+----+------------+<br>|  1 | laowang    |<br>|  2 | chuanchuan |<br>+----+------------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#在k2数据库上写入新数据</span><br>MariaDB [rlin]&gt; create database zeta;<br>Query OK, 1 row affected (0.00 sec)<br><br>MariaDB [rlin]&gt; insert into rlin.t1 values(3,<span class="hljs-string">&quot;zongduizhang&quot;</span>),(4,<span class="hljs-string">&quot;jiangzong&quot;</span>);<br>Query OK, 2 rows affected (0.00 sec)<br>Records: 2  Duplicates: 0  Warnings: 0<br><br><span class="hljs-comment">#在k1数据库上查看，发现数据也已经同步过来了!</span><br>MariaDB [rlin]&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| rlin               |<br>| zeta               |<br>+--------------------+<br>5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br><br>MariaDB [rlin]&gt; select * from rlin.t1;<br>+----+--------------+<br>| id | name         |<br>+----+--------------+<br>|  1 | laowang      |<br>|  2 | chuanchuan   |<br>|  3 | zongduizhang |<br>|  4 | jiangzong    |<br>+----+--------------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#MYSQL主主同步环境已经实现</span><br></code></pre></td></tr></table></figure>

<p><strong>2.配置MySQL+keepalived故障转移的高可用环境</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装keepalived，过程略</span><br><span class="hljs-comment">#k1和k2都要修改的配置文件</span><br>[root@ka1-centos8 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>    global_defs &#123;<br>        notification_email &#123;<br>        root@localhost<br>    &#125;<br>    notification_email_from kaadmin@localhost<br>    smtp_server 127.0.0.1<br>    smtp_connect_timeout 30<br>    router_id ka1.magedu.org <span class="hljs-comment">#在另一个节点为ka2.magedu.org</span><br>    vrrp_mcast_group4 224.0.100.100<br>&#125;<br>vrrp_script check_mysql &#123; <span class="hljs-comment">#只需在第一个节点上实现脚本</span><br>    script <span class="hljs-string">&quot;/etc/keepalived/check_mysql.sh&quot;</span><br>    interval 1<br>    weight -30<br>    fall 3<br>    rise 2<br>    timeout 2<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER <span class="hljs-comment">#在另一个节点为BACKUP</span><br>    interface eth0<br>    virtual_router_id 66<br>    priority 100 <span class="hljs-comment">#在另一个节点为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>    track_interface &#123;<br>        eth0<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>    track_script &#123;<br>        check_mysql <span class="hljs-comment">#只需在第一个节点上实现脚本</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#重启keepalived</span><br>[root@keepalived1 conf.d]<span class="hljs-comment"># systemctl restart keepalved</span><br>[root@keepalived2 conf.d]<span class="hljs-comment"># systemctl restart keepalved</span><br>[root@keepalived1 conf.d]<span class="hljs-comment"># hostname -I</span><br>10.0.0.8 10.0.0.10<br>[root@keepalived2 conf.d]<span class="hljs-comment"># hostname -I</span><br>10.0.0.18<br><br><span class="hljs-comment">#k1和k2两台服务器都要授权允许root用户远程登录，用户在客户端登录测试</span><br>[root@keepalived1 conf.d]<span class="hljs-comment"># mysql -uroot -p123456</span><br>MariaDB [(none)]&gt; grant all on *.* to root@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&quot;123456&quot;</span>;<br>Query OK, 0 rows affected (0.00 sec)<br><br>MariaDB [(none)]&gt; flush privileges;<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure>

<p><strong>3.Mysql＋keepalived故障转移的高可用测试</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#通过Mysql客户端通过VIP连接，看是否连接成功。</span><br><span class="hljs-comment">#比如，在远程一台测试机上连接，通过vip地址可以正常连接（下面的连接权限要是在服务端提前授权的）</span><br>[root@centos7 ~]<span class="hljs-comment"># mysql -h10.0.0.10 -uroot -p123456</span><br>Welcome to the MariaDB monitor.  Commands end with ; or \g.<br>Your MariaDB connection id is 22<br>Server version: 5.5.68-MariaDB MariaDB Server<br><br>Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>MariaDB [(none)]&gt; select * from rlin.t2;<br>+----+--------------+<br>| id | name         |<br>+----+--------------+<br>|  1 | laowang      |<br>|  2 | chuanchuan   |<br>|  3 | zongduizhang |<br>|  4 | jiangzong    |<br>+----+--------------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#停止k1机器上的mysql服务，根据配置中的脚本，mysql服务停了，keepalived也会停，从而vip资源将会切换到k2机器上。（mysql服务没有起来的时候，keepalived服务也无法顺利启动）</span><br>[root@keepalived1 conf.d]<span class="hljs-comment"># systemctl stop mariadb</span><br>[root@keepalived1 conf.d]<span class="hljs-comment"># hostname -I</span><br>10.0.0.8 <br>[root@keepalived2 conf.d]<span class="hljs-comment"># hostname -I</span><br>10.0.0.18 10.0.0.10  <span class="hljs-comment">#此时vip已经切换到k2上</span><br><br><span class="hljs-comment">#再次启动k1的mysql和keepalived服务。（注意：如果restart重启mysql，那么还要启动下keepalived，因为mysql重启，根据脚本会造成keepalived关闭）</span><br><span class="hljs-comment">#注意：一定要先启动mysql服务，然后再启动keepalived服务。如果先启动keepalived服务，按照上面的配置，mysql没有起来，就会自动关闭keepalived。</span><br>[root@keepalived1 conf.d]<span class="hljs-comment"># systemctl start mariadb</span><br>[root@keepalived1 conf.d]<span class="hljs-comment"># systemctl start keepalived</span><br>[root@keepalived1 conf.d]<span class="hljs-comment"># hostname -I</span><br>10.0.0.8 10.0.0.10 <span class="hljs-comment">#此时vip已经切换到k1上</span><br>[root@keepalived2 conf.d]<span class="hljs-comment"># hostname -I</span><br>10.0.0.18<br><br><span class="hljs-comment">#vip资源切换过程中，对于客户端连接mysql（使用vip连接）来说几乎是没有任何影响的。</span><br></code></pre></td></tr></table></figure>

<h5 id="3-7-6-2-方法二"><a href="#3-7-6-2-方法二" class="headerlink" title="3.7.6.2 方法二"></a>3.7.6.2 方法二</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先实现MySQL的双主架构</span><br>[root@keepalived1 ~]<span class="hljs-comment">#yum install -y mariadb-server</span><br>[root@keepalived1 ~]<span class="hljs-comment">#systemctl enable --now mariadb</span><br>[root@keepalived1 ~]<span class="hljs-comment">#mysql_secure_installation #设置密码</span><br>[root@keepalived1 ~]<span class="hljs-comment">#vim /etc/my.cnf.d/mariadb-server.cnf</span><br>[mysqld]<br>server-id=8<br>log-bin<br>auto_increment_offset=1     <span class="hljs-comment">#开始点</span><br>auto_increment_increment=2    <span class="hljs-comment">#增长幅度 </span><br><br>[root@keepalived2 ~]<span class="hljs-comment">#yum install -y mariadb-server</span><br>[root@keepalived2 ~]<span class="hljs-comment">#systemctl enable --now mariadb</span><br>[root@keepalived2 ~]<span class="hljs-comment">#mysql_secure_installation #设置密码</span><br><span class="hljs-comment">#在ka2第二个节点创建连接MySQL查看同步状态的授权用户</span><br>[root@ka2-centos8 ~]<span class="hljs-comment">#mysql -uroot -p123456</span><br>MariaDB [(none)]&gt; grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br><br>MariaDB [(none)]&gt; flush privileges;<br>Query OK, 0 rows affected (0.00 sec)<br><br><span class="hljs-comment">#实现MySQL的健康性检测脚本1</span><br>[root@keepalived1 ~]<span class="hljs-comment">#vi /etc/keepalived/check_mysql.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>slave_is=( $(mysql -uroot -p123456 -h10.0.0.18 -e <span class="hljs-string">&quot;show slave status\G&quot;</span> | grep<br><span class="hljs-string">&quot;Slave_.*_Running:&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>) )<br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;slave_is[0]&#125;</span>&quot;</span> = <span class="hljs-string">&quot;Yes&quot;</span> -a <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;slave_is[1]&#125;</span>&quot;</span> = <span class="hljs-string">&quot;Yes&quot;</span> ];<span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">exit</span> 0<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">#实现MySQL的健康性检测脚本2</span><br>[root@keepalived1 ~]<span class="hljs-comment">#vi /etc/keepalived/check_mysql.sh</span><br>mysqladmin -uroot -p123456  ping &amp;&gt; /dev/null<br><br><span class="hljs-comment">#实现MySQL的健康性检测脚本3</span><br>[root@keepalived1 ~]<span class="hljs-comment">#vi /etc/keepalived/check_mysql.sh</span><br>mysql  -uroot -p123456 -e <span class="hljs-string">&#x27;status&#x27;</span> &amp;&gt; /dev/null<br><br><span class="hljs-comment">#实现MySQL的健康性检测脚本4</span><br>[root@keepalived1 ~]<span class="hljs-comment">#vi /etc/keepalived/check_mysql.sh</span><br>systemctl is-active mariadb &amp;&gt; /dev/null<br><br><span class="hljs-comment">#配置keepalived调用上面脚本</span><br>[root@keepalived1 ~]<span class="hljs-comment">#cat /etc/keepalived/keepalived.conf</span><br>! Configuration File <span class="hljs-keyword">for</span> keepalived<br>    global_defs &#123;<br>        notification_email &#123;<br>        root@localhost<br>    &#125;<br>    notification_email_from kaadmin@localhost<br>    smtp_server 127.0.0.1<br>    smtp_connect_timeout 30<br>    router_id ka1.magedu.org <span class="hljs-comment">#在另一个节点为ka2.magedu.org</span><br>    vrrp_mcast_group4 224.0.100.100<br>&#125;<br>vrrp_script check_mysql &#123; <span class="hljs-comment">#只需在第一个节点上实现脚本</span><br>    script <span class="hljs-string">&quot;/etc/keepalived/check_mysql.sh&quot;</span><br>    interval 1<br>    weight -30<br>    fall 3<br>    rise 2<br>    timeout 2<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER <span class="hljs-comment">#在另一个节点为BACKUP</span><br>    interface eth0<br>    virtual_router_id 66<br>    priority 100 <span class="hljs-comment">#在另一个节点为80</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 123456<br>    &#125;<br>    virtual_ipaddress &#123;<br>        10.0.0.10/24 dev eth0 label eth0:1<br>    &#125;<br>    track_interface &#123;<br>        eth0<br>    &#125;<br>    notify_master <span class="hljs-string">&quot;/etc/keepalived/notify.sh master&quot;</span><br>    notify_backup <span class="hljs-string">&quot;/etc/keepalived/notify.sh backup&quot;</span><br>    notify_fault <span class="hljs-string">&quot;/etc/keepalived/notify.sh fault&quot;</span><br>    track_script &#123;<br>        check_mysql <span class="hljs-comment">#只需在第一个节点上实现脚本</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-8-同步组"><a href="#3-8-同步组" class="headerlink" title="3.8 同步组"></a>3.8 同步组</h3><p>LVS NAT 模型VIP和DIP需要同步，需要同步组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">vrrp_sync_group VG_1 &#123;<br>    group &#123;<br>        VI_1  <span class="hljs-comment"># name of vrrp_instance (below)</span><br>        VI_2  <span class="hljs-comment"># One for each moveable IP</span><br>    &#125;<br>&#125;<br>vrrp_instance VI_1 &#123;<br>    eth0<br>    vip<br>&#125;<br>vrrp_instance VI_2 &#123;<br>    eth1<br>    dip<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="四、综合实战案例（暂时没空做，以后补充，要求使用直接在虚拟机实现和使用docker实现）"><a href="#四、综合实战案例（暂时没空做，以后补充，要求使用直接在虚拟机实现和使用docker实现）" class="headerlink" title="四、综合实战案例（暂时没空做，以后补充，要求使用直接在虚拟机实现和使用docker实现）"></a>四、综合实战案例（暂时没空做，以后补充，要求使用直接在虚拟机实现和使用docker实现）</h2><h3 id="4-1-实战案例：Keepalived-LVS"><a href="#4-1-实战案例：Keepalived-LVS" class="headerlink" title="4.1 实战案例：Keepalived+LVS"></a>4.1 实战案例：Keepalived+LVS</h3><ul>
<li>编译安装 keepalived</li>
<li>实现keepalived(20个以上的VIP) + Nginx 双主高可用</li>
<li>实现keepalived(60个以上的VIP) + HAProxy 三服务器高可用</li>
<li>实现keepalived(100个以上的VIP) + LVS高可用、Real Server状态监测及规则管理</li>
</ul>
<h3 id="4-2-实战案例：Keepalived-HAProxy"><a href="#4-2-实战案例：Keepalived-HAProxy" class="headerlink" title="4.2 实战案例：Keepalived+HAProxy"></a>4.2 实战案例：Keepalived+HAProxy</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/Keeplived/keepalived9.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li>编译安装HAProxy较新 LTS 版本，选择编译安装keepalived</li>
<li>开启HAProxy多进程，进程数与CPU核心数保持一致并实现HAProxy进程绑定</li>
<li>因业务较多避免配置文件误操作，需要按每业务一个配置文件并统一保存至/etc/haproxy/conf 目录中</li>
<li>实现keepalived include导入配置文件功能，使用LVS-DR模型代理后端Nginx web服务器</li>
<li>基于ACL实现单IP多域名负载功能(适用于企业较少公网IP多域名场景)</li>
<li>实现MySQL主从复制，并通过HAProxy对MySQL进行反向代理</li>
<li>最终完成HAProxy+Nginx+Tomcat+ Redis，并实现session会话保持统一保存到Redis</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/linxu-keepalived/">linxu keepalived</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/06/07/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86HAPROXY/">
                        <span class="hidden-mobile">企业级反向代理HAPROXY</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
