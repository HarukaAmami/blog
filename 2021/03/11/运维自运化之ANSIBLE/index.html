

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>运维自运化之ANSIBLE - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="运维自运化之ANSIBLE">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-03-11 18:09" pubdate>
        2021年3月11日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      24.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      401
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">运维自运化之ANSIBLE</h1>
            
            <div class="markdown-body">
              <h1 id="运维自运化之ANSIBLE"><a href="#运维自运化之ANSIBLE" class="headerlink" title="运维自运化之ANSIBLE"></a>运维自运化之ANSIBLE</h1><h1 id="一、自动化运维应用场景"><a href="#一、自动化运维应用场景" class="headerlink" title="一、自动化运维应用场景"></a>一、自动化运维应用场景</h1><h2 id="1-1-云计算运维工程师核心职能"><a href="#1-1-云计算运维工程师核心职能" class="headerlink" title="1.1 云计算运维工程师核心职能"></a>1.1 云计算运维工程师核心职能</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible1.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible2.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible3.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible4.jpg" srcset="/blog/img/loading.gif"></p>
<p><strong>相关工具</strong></p>
<ul>
<li>代码管理（SCM）：GitHub、GitLab、BitBucket、SubVersion</li>
<li>构建工具：maven、Ant、Gradle</li>
<li>自动部署：Capistrano、CodeDeploy</li>
<li>持续集成（CI）：Jenkins、Travis</li>
<li>配置管理：Ansible、SaltStack、Chef、Puppet</li>
<li>容器：Docker、Podman、LXC、第三方厂商如AWS</li>
<li>编排：Kubernetes、Core、Apache Mesos</li>
<li>服务注册与发现：Zookeeper、etcd、Consul</li>
<li>脚本语言：python、ruby、shell</li>
<li>日志管理：ELK、Logentries</li>
<li>系统监控：Prometheus、Zabbix、Datadog、Graphite、Ganglia、Nagios</li>
<li>性能监控：AppDynamics、New Relic、Splunk</li>
<li>压力测试：JMeter、Blaze Meter、loader.io</li>
<li>应用服务器：Tomcat、JBoss、IIS</li>
<li>Web服务器：Apache、Nginx</li>
<li>数据库：MySQL、Oracle、PostgreSQL等关系型数据库；mongoDB、redis等NoSQL数据库</li>
<li>项目管理（PM）：Jira、Asana、Taiga、Trello、Basecamp、Pivotal Tracker</li>
</ul>
<h2 id="1-2-运维职业发展路线"><a href="#1-2-运维职业发展路线" class="headerlink" title="1.2 运维职业发展路线"></a>1.2 运维职业发展路线</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible5.jpg" srcset="/blog/img/loading.gif"></p>
<p><strong>运维的未来是什么？</strong><br><strong>一切皆自动化</strong><br>“运维的未来是，让研发人员能够借助工具、自动化和流程，并且让他们能够在运维干预极少的情况下部署和运营服务，从而实现自助服务。每个角色都应该努力使工作实现自动化。”——《运维的未来》</p>
<h2 id="1-3-企业实际应用场景分析"><a href="#1-3-企业实际应用场景分析" class="headerlink" title="1.3 企业实际应用场景分析"></a>1.3 企业实际应用场景分析</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible6.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="1-3-1-Dev开发环境"><a href="#1-3-1-Dev开发环境" class="headerlink" title="1.3.1 Dev开发环境"></a>1.3.1 Dev开发环境</h3><p>使用者：程序员<br>功能：程序员个人的办公电脑或项目的开发测试环境，部署开发软件，测试个人或项目整体的BUG的环境<br>管理者：程序员</p>
<h3 id="1-3-2-测试环境"><a href="#1-3-2-测试环境" class="headerlink" title="1.3.2 测试环境"></a>1.3.2 测试环境</h3><p>使用者：QA测试工程师<br>功能：测试经过Dev环境测试通过的软件的功能和性能，判断是否达到项目的预期目标，生成测试报告<br>管理者：运维<br>说明：测试环境往往有多套,测试环境满足测试功能即可，不宜过多<br> 1、测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，意味着多个版本同步测试<br>2、通常测试环境有多少套和产品线数量保持一样</p>
<h3 id="1-3-3-预发布环境"><a href="#1-3-3-预发布环境" class="headerlink" title="1.3.3 预发布环境"></a>1.3.3 预发布环境</h3><p>使用者：运维<br>功能：使用和生产环境一样的数据库，缓存服务等配置，测试是否正常</p>
<h3 id="1-3-4-发布环境"><a href="#1-3-4-发布环境" class="headerlink" title="1.3.4 发布环境"></a>1.3.4 发布环境</h3><p>包括代码发布机，有些公司为堡垒机（安全屏障）<br>使用者：运维<br>功能：发布代码至生产环境<br>管理者：运维（有经验）<br>发布机：往往需要有2台（主备）</p>
<h3 id="1-3-5-生产环境"><a href="#1-3-5-生产环境" class="headerlink" title="1.3.5 生产环境"></a>1.3.5 生产环境</h3><p>使用者：运维，少数情况开放权限给核心开发人员，极少数公司将权限完全开放给开发人员并其维护<br>功能：对用户提供公司产品的服务<br>管理者：只能是运维<br>生产环境服务器数量：一般比较多，且应用非常重要。往往需要自动工具协助部署配置应用</p>
<h3 id="1-3-6-灰度环境"><a href="#1-3-6-灰度环境" class="headerlink" title="1.3.6 灰度环境"></a>1.3.6 灰度环境</h3><p>属于生产环境的一部分<br>使用者：运维<br>功能：在全量发布代码前将代码的功能面向少量精准用户发布的环境,可基于主机或用户执行灰度发布<br>案例：共100台生产服务器，先发布其中的10台服务器，这10台服务器就是灰度服务器<br>管理者：运维<br>灰度环境：往往该版本功能变更较大，为保险起见特意先让一部分用户优化体验该功能，待这部分用户使用没有重大问题的时候，再全量发布至所有服务器</p>
<h2 id="1-4-程序发布"><a href="#1-4-程序发布" class="headerlink" title="1.4 程序发布"></a>1.4 程序发布</h2><p>程序发布要求：<br>不能导致系统故障或造成系统完全不可用<br>不能影响用户体验<br>预发布验证：<br>新版本的代码先发布到服务器（跟线上环境配置完全相同，只是未接入到调度器）<br>灰度发布：<br>基于主机，用户，业务<br>发布路径：<br>/webapp/tuangou<br>/webapp/tuangou-1.1<br>/webapp/tuangou-1.2</p>
<p><strong>发布过程：</strong></p>
<ol>
<li>在调度器上下线一批主机(标记为maintenance 状态)</li>
<li>关闭服务</li>
<li>部署新版本的应用程序</li>
<li>启动服务</li>
<li>在调度器上启用这一批服务器</li>
</ol>
<p><strong>自动化灰度发布：</strong></p>
<ul>
<li>脚本</li>
<li>发布平台</li>
</ul>
<h2 id="1-5-自动化运维应用场景"><a href="#1-5-自动化运维应用场景" class="headerlink" title="1.5 自动化运维应用场景"></a>1.5 自动化运维应用场景</h2><ul>
<li>文件传输</li>
<li>应用部署</li>
<li>配置管理</li>
<li>任务流编排</li>
</ul>
<h2 id="1-6-常用自动化运维工具"><a href="#1-6-常用自动化运维工具" class="headerlink" title="1.6 常用自动化运维工具"></a>1.6 常用自动化运维工具</h2><ul>
<li>Ansible：python，Agentless，中小型应用环境</li>
<li>Saltstack：python，一般需部署agent，执行效率更高</li>
<li>Puppet：ruby, 功能强大，配置复杂，重型，适合大型环境</li>
<li>Fabric：python，agentless</li>
<li>Chef：ruby，国内应用少</li>
<li>Cfengine</li>
<li>func</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible7.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible8.jpg" srcset="/blog/img/loading.gif"></p>
<p>同类自动化工具GitHub关注程度（2016-07-10）</p>
<table>
<thead>
<tr>
<th>自动化运维工具</th>
<th>Watch（关注）</th>
<th>Star（点赞）</th>
<th>Fork（复制）</th>
<th>Contributors(贡献者)</th>
</tr>
</thead>
<tbody><tr>
<td>Ansible</td>
<td>1387</td>
<td>17716</td>
<td>5356</td>
<td>1428</td>
</tr>
<tr>
<td>Saltstack</td>
<td>530</td>
<td>6678</td>
<td>3022</td>
<td>1520</td>
</tr>
<tr>
<td>Puppet</td>
<td>463</td>
<td>4044</td>
<td>1678</td>
<td>425</td>
</tr>
<tr>
<td>Chef</td>
<td>383</td>
<td>4333</td>
<td>1806</td>
<td>464</td>
</tr>
<tr>
<td>Fabric</td>
<td>379</td>
<td>7334</td>
<td>1235</td>
<td>116</td>
</tr>
</tbody></table>
<h1 id="二、Ansible-介绍和架构"><a href="#二、Ansible-介绍和架构" class="headerlink" title="二、Ansible 介绍和架构"></a>二、Ansible 介绍和架构</h1><p>公司计划在年底做一次大型市场促销活动，全面冲刺下交易额，为明年的上市做准备。公司要求各业务组对年底大促做准备，运维部要求所有业务容量进行三倍的扩容，并搭建出多套环境可以共开发和测试人员做测试，运维老大为了在年底有所表现，要求运维部门同学尽快实现，当你接到这个任务时，有没有更快的解决方案？</p>
<h2 id="2-1-Ansible发展史"><a href="#2-1-Ansible发展史" class="headerlink" title="2.1 Ansible发展史"></a>2.1 Ansible发展史</h2><p>作者：Michael DeHaan（ Cobbler 与 Func 作者）</p>
<p>ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗</p>
<p>2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购<br>官网：<a target="_blank" rel="noopener" href="https://www.ansible.com/">https://www.ansible.com/</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.ansible.com/">https://docs.ansible.com/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible9.jpg" srcset="/blog/img/loading.gif"></p>
<h2 id="2-2-Ansible-特性"><a href="#2-2-Ansible-特性" class="headerlink" title="2.2 Ansible 特性"></a>2.2 Ansible 特性</h2><ul>
<li>模块化：调用特定的模块完成特定任务，支持自定义模块，可使用任何编程语言写模块</li>
<li>Paramiko（python对ssh的实现），PyYAML，Jinja2（模板语言）三个关键模块</li>
<li>基于Python语言实现</li>
<li>部署简单，基于python和SSH(默认已安装)，agentless，无需代理不依赖PKI（无需ssl）</li>
<li>安全，基于OpenSSH</li>
<li>幂等性：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况,此特性非绝对</li>
<li>支持playbook编排任务，YAML格式，编排任务，支持丰富的数据结构</li>
<li>较强大的多层解决方案 role</li>
</ul>
<h2 id="2-3-Ansible-架构"><a href="#2-3-Ansible-架构" class="headerlink" title="2.3 Ansible 架构"></a>2.3 Ansible 架构</h2><h3 id="2-3-1-Ansible-组成"><a href="#2-3-1-Ansible-组成" class="headerlink" title="2.3.1 Ansible 组成"></a>2.3.1 Ansible 组成</h3><p>组合INVENTORY、API、MODULES、PLUGINS的绿框，为ansible命令工具，其为核心执行工具</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible10.jpg" srcset="/blog/img/loading.gif"></p>
<ul>
<li>INVENTORY：Ansible管理主机的清单/etc/anaible/hosts</li>
<li>MODULES：Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</li>
<li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</li>
<li>API：供第三方程序调用的应用程序编程接口</li>
</ul>
<h3 id="2-3-2-Ansible-命令执行来源"><a href="#2-3-2-Ansible-命令执行来源" class="headerlink" title="2.3.2 Ansible 命令执行来源"></a>2.3.2 Ansible 命令执行来源</h3><ul>
<li>USER 普通用户，即SYSTEM ADMINISTRATOR</li>
<li>PLAYBOOKS：任务剧本（任务集），编排定义Ansible任务集的配置文件，由Ansible顺序依次执行，通常是JSON格式的YML文件</li>
<li>CMDB（配置管理数据库） API 调用</li>
<li>PUBLIC/PRIVATE CLOUD API调用</li>
<li>USER-&gt; Ansible Playbook -&gt; Ansibile</li>
</ul>
<h3 id="2-3-3-注意事项"><a href="#2-3-3-注意事项" class="headerlink" title="2.3.3 注意事项"></a>2.3.3 注意事项</h3><ul>
<li>执行ansible的主机一般称为管理端, 主控端，中控，master或堡垒机</li>
<li>主控端Python版本需要2.6或以上</li>
<li>被控端Python版本小于2.4，需要安装python-simplejson</li>
<li>被控端如开启SELinux需要安装libselinux-python</li>
<li>windows 不能做为主控端</li>
</ul>
<h1 id="三、Ansible-安装和入门"><a href="#三、Ansible-安装和入门" class="headerlink" title="三、Ansible 安装和入门"></a>三、Ansible 安装和入门</h1><h2 id="3-1-Ansible安装"><a href="#3-1-Ansible安装" class="headerlink" title="3.1 Ansible安装"></a>3.1 Ansible安装</h2><p>ansible的安装方法有多种</p>
<p>官方方档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html<br></code></pre></td></tr></table></figure>

<p>下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://releases.ansible.com/ansible/<br></code></pre></td></tr></table></figure>

<p>pip 下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://pypi.org/project/ansible/   <br></code></pre></td></tr></table></figure>

<h3 id="3-1-1-EPEL源的rpm包安装"><a href="#3-1-1-EPEL源的rpm包安装" class="headerlink" title="3.1.1 EPEL源的rpm包安装:"></a>3.1.1 EPEL源的rpm包安装:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install ansible -y<br></code></pre></td></tr></table></figure>

<h3 id="3-1-2-编译安装"><a href="#3-1-2-编译安装" class="headerlink" title="3.1.2 编译安装"></a>3.1.2 编译安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum -y install python-jinja2 PyYAML python-paramiko python-babel python-crypto<br><br>wget https://releases.ansible.com/ansible/ansible-1.5.4.tar.gz<br><br>tar xf ansible-1.5.4.tar.gz<br><span class="hljs-built_in">cd</span> ansible-1.5.4<br>python setup.py build<br>python setup.py install<br>mkdir /etc/ansible<br>cp -r examples/* /etc/ansible<br></code></pre></td></tr></table></figure>

<h3 id="3-1-3-Git方式"><a href="#3-1-3-Git方式" class="headerlink" title="3.1.3 Git方式"></a>3.1.3 Git方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> git://github.com/ansible/ansible.git --recursive<br><span class="hljs-built_in">cd</span> ./ansible<br><span class="hljs-built_in">source</span> ./hacking/env-setup<br></code></pre></td></tr></table></figure>

<h3 id="3-1-4-pip-安装"><a href="#3-1-4-pip-安装" class="headerlink" title="3.1.4 pip 安装"></a>3.1.4 pip 安装</h3><p>pip 是安装Python包的管理器，类似 yum</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#yum install python-pip</span><br>[root@centos7 ~]<span class="hljs-comment">#pip install --upgrade pip</span><br>[root@centos7 ~]<span class="hljs-comment">#pip install ansible --upgrade</span><br>[root@centos7 ~]<span class="hljs-comment">#ansible --version</span><br>/usr/lib64/python2.7/site-packages/cryptography/__init__.py:39:<br>CryptographyDeprecationWarning: Python 2 is no longer supported by the Python<br>core team. Support <span class="hljs-keyword">for</span> it is now deprecated <span class="hljs-keyword">in</span> cryptography, and will be removedin a future release.<br>CryptographyDeprecationWarning,<br>ansible 2.9.12<br>config file = None<br>configured module search path = [u<span class="hljs-string">&#x27;/root/.ansible/plugins/modules&#x27;</span>,<br>u<span class="hljs-string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]<br>ansible python module location = /usr/lib/python2.7/site-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 2.7.5 (default, Apr  2 2020, 13:16:51) [GCC 4.8.5 20150623<br>(Red Hat 4.8.5-39)]<br><br>[root@centos7 ~]<span class="hljs-comment">#ll /opt/etc/ansible/ansible.cfg</span><br>-rw-r--r-- 1 wang bin 19980 Aug 11 21:34 /opt/etc/ansible/ansible.cfg<br></code></pre></td></tr></table></figure>

<h3 id="3-1-5-确认安装"><a href="#3-1-5-确认安装" class="headerlink" title="3.1.5 确认安装"></a>3.1.5 确认安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible --version</span><br>ansible 2.9.5<br>config file = /etc/ansible/ansible.cfg<br>configured module search path = [<span class="hljs-string">&#x27;/root/.ansible/plugins/modules&#x27;</span>,<br><span class="hljs-string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]<br>ansible python module location = /usr/lib/python3.6/site-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 3.6.8 (default, Nov 21 2019, 19:31:34) [GCC 8.3.1 20190507<br>(Red Hat 8.3.1-4)]<br></code></pre></td></tr></table></figure>

<h2 id="3-2-Ansible-相关文件"><a href="#3-2-Ansible-相关文件" class="headerlink" title="3.2 Ansible 相关文件"></a>3.2 Ansible 相关文件</h2><h3 id="3-2-1-配置文件"><a href="#3-2-1-配置文件" class="headerlink" title="3.2.1 配置文件"></a>3.2.1 配置文件</h3><ul>
<li>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性</li>
<li>/etc/ansible/hosts 主机清单</li>
<li>/etc/ansible/roles/ 存放角色的目录</li>
</ul>
<h3 id="3-2-2-ansible-主配置文件"><a href="#3-2-2-ansible-主配置文件" class="headerlink" title="3.2.2 ansible 主配置文件"></a>3.2.2 ansible 主配置文件</h3><p>Ansible 的配置文件 /etc/ansible/ansible.cfg ,其中大部分的配置内容无需进行修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/ansible/ansible.cfg<br>[defaults]<br><span class="hljs-comment">#inventory   = /etc/ansible/hosts # 主机列表配置文件</span><br><span class="hljs-comment">#library = /usr/share/my_modules/ # 库文件存放目录</span><br><span class="hljs-comment">#remote_tmp = $HOME/.ansible/tmp #临时py命令文件存放在远程主机目录</span><br><span class="hljs-comment">#local_tmp   = $HOME/.ansible/tmp # 本机的临时命令执行目录</span><br><span class="hljs-comment">#forks     = 5  # 默认并发数</span><br><span class="hljs-comment">#sudo_user   = root # 默认sudo 用户</span><br><span class="hljs-comment">#ask_sudo_pass = True #每次执行ansible命令是否询问ssh密码</span><br><span class="hljs-comment">#ask_pass   = True </span><br><span class="hljs-comment">#remote_port  = 22</span><br><span class="hljs-comment">#host_key_checking = False # 检查对应服务器的host_key，建议取消注释</span><br><span class="hljs-comment">#log_path=/var/log/ansible.log #日志文件，建议启用</span><br><span class="hljs-comment">#module_name = command  #默认模块，可以修改为shell模块</span><br></code></pre></td></tr></table></figure>

<h3 id="3-2-3-inventory-主机清单"><a href="#3-2-3-inventory-主机清单" class="headerlink" title="3.2.3 inventory 主机清单"></a>3.2.3 inventory 主机清单</h3><p>ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory file中将其分组命名</p>
<p>默认的inventory file为 /etc/ansible/hosts</p>
<p>inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成</p>
<p>官方文档:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html<br></code></pre></td></tr></table></figure>

<p><strong>主机清单文件格式</strong><br>inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中</p>
<p>此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明</p>
<p>如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/ansible/hosts<br>ntp.magedu.com<br><br>[webservers]<br>www1.magedu.com:2222<br>www2.magedu.com<br><br>[dbservers]<br>db1.magedu.com<br>db2.magedu.com<br>db3.magedu.com<br><br>[websrvs]<br>www[1:100].example.com<br><br>[dbsrvs]<br>db-[a:f].example.com<br><br>[appsrvs]<br>10.0.0.[1:100]<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/ansible/hosts<br><br>[<span class="hljs-built_in">test</span>]<br>10.0.0.8  ansible_connection=<span class="hljs-built_in">local</span>  <span class="hljs-comment">#指定本地连接,无需ssh配置</span><br><br>[websrvs]<br>10.0.0.7<br>10.0.0.8<br><br>[appsrvs]<br>10.0.0.7<br>10.0.0.6<br><br>[dbsrvs]<br>10.0.0.8<br>10.0.0.18 ansible_connection=<span class="hljs-built_in">local</span><br><br><br><span class="hljs-comment">#ansible_connection=ssh 需要StrictHostKeyChecking no</span><br><span class="hljs-comment">#一般使用ansible控制别的主机都是使用root，所以后面的参数这些可以省略不写</span><br>10.0.0.7  ansible_connection=ssh  ansible_port=2222  ansible_user=wang ansible_password=magedu <br>10.0.0.6  ansible_connection=ssh  ansible_user=root  ansible_password=123456<br><br><span class="hljs-comment">#查看可以连接的主机</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all --list-hosts</span><br>  hosts (4):<br>    10.0.0.7<br>    10.0.0.6<br>    10.0.0.8<br>    10.0.0.18<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs --list-hosts</span><br>  hosts (2):<br>    10.0.0.7<br>    10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment"># ansible appsrvs --list-hosts</span><br>  hosts (2):<br>    10.0.0.7<br>    10.0.0.6<br>[root@centos7 ~]<span class="hljs-comment"># ansible dbsrvs --list-hosts</span><br>  hosts (2):<br>    10.0.0.8<br>    10.0.0.18<br></code></pre></td></tr></table></figure>

<h2 id="3-3-Ansible相关工具"><a href="#3-3-Ansible相关工具" class="headerlink" title="3.3 Ansible相关工具"></a>3.3 Ansible相关工具</h2><ul>
<li><p>/usr/bin/ansible 主程序，临时命令执行工具</p>
</li>
<li><p>/usr/bin/ansible-doc 查看配置文档，模块功能查看工具,相当于man</p>
</li>
<li><p>/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具,相当于脚本</p>
</li>
<li><p>/usr/bin/ansible-pull 远程执行命令的工具</p>
</li>
<li><p>/usr/bin/ansible-vault 文件加密工具</p>
</li>
<li><p>/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</p>
</li>
<li><p>/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台</p>
</li>
</ul>
<p><strong>利用ansible实现管理的主要方式：</strong></p>
<ul>
<li>Ad-Hoc 即利用ansible命令，主要用于临时命令使用场景</li>
<li>Ansible-playbook 主要用于长期规划好的，大型项目的场景，需要有前期的规划过程</li>
</ul>
<h3 id="3-3-1-ansible-doc"><a href="#3-3-1-ansible-doc" class="headerlink" title="3.3.1 ansible-doc"></a>3.3.1 ansible-doc</h3><p>此工具用来显示模块帮助,相当于man</p>
<p>格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible-doc [options] [module...]<br>-l, --list    <span class="hljs-comment">#列出可用模块</span><br>-s, --snippet <span class="hljs-comment">#显示指定模块的playbook片段</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#列出所有模块</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible-doc -l </span><br>[root@centos7 ~]<span class="hljs-comment"># ansible-doc -l | wc -l</span><br>3387<br><br><span class="hljs-comment">#查看指定模块帮助用法</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible-doc ping </span><br><br><span class="hljs-comment">#查看指定模块帮助用法</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible-doc -s ping</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># date</span><br>Wed Jun 17 16:08:09 CST 2020<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible --version</span><br>ansible 2.9.9<br>config file = /etc/ansible/ansible.cfg<br>configured module search path = [<span class="hljs-string">&#x27;/root/.ansible/plugins/modules&#x27;</span>,<span class="hljs-string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]<br>ansible python module location = /usr/lib/python3.6/site-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 3.6.8 (default, Apr 16 2020, 01:36:27) [GCC 8.3.1 20191121<br>(Red Hat 8.3.1-5)]<br><br>[root@centos7 ~]<span class="hljs-comment">#ansible-doc -l|wc -l</span><br>3387<br></code></pre></td></tr></table></figure>

<h3 id="3-3-2-ansible"><a href="#3-3-2-ansible" class="headerlink" title="3.3.2 ansible"></a>3.3.2 ansible</h3><p>此工具通过ssh协议，实现对远程主机的配置管理、应用部署、任务执行等功能</p>
<p>建议：使用此工具前，先配置ansible主控端能基于密钥认证的方式联系各个被管理节点</p>
<p>范例：利用sshpass批量实现基于key验证脚本1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#其他被管理的主机</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/ssh/ssh_config</span><br><span class="hljs-comment">#修改下面一行</span><br>StrictHostKeyChecking no<br><br>[root@centos7 ~]<span class="hljs-comment">#cat hosts.list</span><br>10.0.0.18<br>10.0.0.28<br><br>[root@centos7 ~]<span class="hljs-comment">#vim push_ssh_key.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass <br>[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa  -P <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-built_in">export</span> SSHPASS=magedu<br><span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> IP;<span class="hljs-keyword">do</span><br> sshpass -e ssh-copy-id -o StrictHostKeyChecking=no <span class="hljs-variable">$IP</span><br><span class="hljs-keyword">done</span> &lt; hosts.list<br></code></pre></td></tr></table></figure>

<p>范例: 实现基于key验证的脚本2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在控制的主机中使用</span><br>[root@centos7 ~]<span class="hljs-comment">#cat ssh_key.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#Author: wangxiaochun</span><br><span class="hljs-comment">#QQ: 29308620</span><br><span class="hljs-comment">#Date: 2020-08-11</span><br><span class="hljs-comment">#FileName： ssh_key.sh</span><br><span class="hljs-comment">#URL: http://www.wangxiaochun.com</span><br><span class="hljs-comment">#Description： The test script</span><br><span class="hljs-comment">#Copyright (C): 2020 All rights reserved</span><br><span class="hljs-comment">#********************************************************************</span><br>IPLIST=<span class="hljs-string">&quot;</span><br><span class="hljs-string">10.0.0.8</span><br><span class="hljs-string">10.0.0.18</span><br><span class="hljs-string">10.0.0.7</span><br><span class="hljs-string">10.0.0.6</span><br><span class="hljs-string">10.0.0.200&quot;</span><br><br>rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass <br>[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-built_in">export</span> SSHPASS=123456<br><span class="hljs-keyword">for</span> IP <span class="hljs-keyword">in</span> <span class="hljs-variable">$IPLIST</span>;<span class="hljs-keyword">do</span><br> sshpass -e ssh-copy-id -o StrictHostKeyChecking=no <span class="hljs-variable">$IP</span><br><span class="hljs-keyword">done</span><br><br>bash ssh_key.sh<br></code></pre></td></tr></table></figure>

<p>格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible &lt;host-pattern&gt; [-m module_name] [-a args]<br></code></pre></td></tr></table></figure>

<p>选项说明：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">--version <span class="hljs-comment">#显示版本</span><br>-m module  <span class="hljs-comment">#指定模块，默认为command</span><br>-v <span class="hljs-comment">#详细过程 –vv -vvv更详细</span><br>--list-hosts <span class="hljs-comment">#显示主机列表，可简写 --list</span><br>-C, --check  <span class="hljs-comment">#检查，并不执行</span><br>-T, --timeout=TIMEOUT <span class="hljs-comment">#执行命令的超时时间，默认10s</span><br>-k, --ask-pass   <span class="hljs-comment">#提示输入ssh连接密码，默认Key验证</span><br>-u, --user=REMOTE_USER <span class="hljs-comment">#执行远程执行的用户</span><br>-b, --become   <span class="hljs-comment">#代替旧版的sudo 切换</span><br>--become-user=USERNAME  <span class="hljs-comment">#指定sudo的runas用户，默认为root</span><br>-K, --ask-become-pass  <span class="hljs-comment">#提示输入sudo时的口令</span><br></code></pre></td></tr></table></figure>

<p><strong>ansible的Host-pattern</strong>：用于匹配被控制的主机的列表</p>
<p><strong>All</strong> ：表示所有Inventory中的所有主机</p>
<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#没有针对被管理的主机进行key验证</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m ping</span><br>The authenticity of host <span class="hljs-string">&#x27;10.0.0.7 (10.0.0.7)&#x27;</span> can<span class="hljs-string">&#x27;t be established.</span><br><span class="hljs-string">ECDSA key fingerprint is SHA256:/g7oV8Ok5sNGS6xH99L8QltH2EC3xhhP4p8agvdUV9s.</span><br><span class="hljs-string">ECDSA key fingerprint is MD5:2e:bd:75:ec:7d:0d:77:80:1e:90:ad:83:63:5e:4a:ac.</span><br><span class="hljs-string">Are you sure you want to continue connecting (yes/no)? The authenticity of host &#x27;</span>10.0.0.6 (10.0.0.6)<span class="hljs-string">&#x27; can&#x27;</span>t be established.<br>ECDSA key fingerprint is SHA256:/g7oV8Ok5sNGS6xH99L8QltH2EC3xhhP4p8agvdUV9s.<br>ECDSA key fingerprint is MD5:2e:bd:75:ec:7d:0d:77:80:1e:90:ad:83:63:5e:4a:ac.<br>Are you sure you want to <span class="hljs-built_in">continue</span> connecting (yes/no)? The authenticity of host <span class="hljs-string">&#x27;10.0.0.8 (10.0.0.8)&#x27;</span> can<span class="hljs-string">&#x27;t be established.</span><br><span class="hljs-string">ECDSA key fingerprint is SHA256:/g7oV8Ok5sNGS6xH99L8QltH2EC3xhhP4p8agvdUV9s.</span><br><span class="hljs-string">ECDSA key fingerprint is MD5:2e:bd:75:ec:7d:0d:77:80:1e:90:ad:83:63:5e:4a:ac.</span><br><span class="hljs-string">Are you sure you want to continue connecting (yes/no)? 10.0.0.18 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">yes</span><br><span class="hljs-string">10.0.0.7 | UNREACHABLE! =&gt; &#123;</span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;msg&quot;: &quot;Failed to connect to the host via ssh: Warning: Permanently added &#x27;</span>10.0.0.7<span class="hljs-string">&#x27; (ECDSA) to the list of known hosts.\r\nPermission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&quot;, </span><br><span class="hljs-string">    &quot;unreachable&quot;: true</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">yes</span><br><span class="hljs-string">10.0.0.6 | UNREACHABLE! =&gt; &#123;</span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;msg&quot;: &quot;Failed to connect to the host via ssh: Warning: Permanently added &#x27;</span>10.0.0.6<span class="hljs-string">&#x27; (ECDSA) to the list of known hosts.\r\nPermission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&quot;, </span><br><span class="hljs-string">    &quot;unreachable&quot;: true</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">yes</span><br><span class="hljs-string">10.0.0.8 | UNREACHABLE! =&gt; &#123;</span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;msg&quot;: &quot;Failed to connect to the host via ssh: Warning: Permanently added &#x27;</span>10.0.0.8<span class="hljs-string">&#x27; (ECDSA) to the list of known hosts.\r\nPermission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&quot;, </span><br><span class="hljs-string">    &quot;unreachable&quot;: true</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">#没有针对被管理的主机进行key验证，但是有输入密码的，默认是root</span><br><span class="hljs-string">[root@centos7 ~]# ansible 10.0.0.7 -k -m ping</span><br><span class="hljs-string">SSH password: </span><br><span class="hljs-string">10.0.0.7 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">#有对主机进行key验证</span><br><span class="hljs-string">[root@centos7 ~]# ansible all -m ping</span><br><span class="hljs-string">10.0.0.18 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">10.0.0.7 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">10.0.0.8 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">10.0.0.6 | SUCCESS =&gt; &#123;</span><br><span class="hljs-string">    &quot;ansible_facts&quot;: &#123;</span><br><span class="hljs-string">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="hljs-string">    &#125;, </span><br><span class="hljs-string">    &quot;changed&quot;: false, </span><br><span class="hljs-string">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>

<p>*:通配符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible &quot;*&quot; -m ping</span><br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible 10.0.0.* -m ping</span><br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;*srvs&quot; -m ping</span><br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;10.0.0.6 10.0.0.7&quot; -m ping</span><br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>或关系</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible &quot;websrvs:appsrvs&quot; -m ping</span><br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;10.0.0.6:10.0.0.7&quot; -m ping</span><br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;10.0.0.6:10.0.0.7:10.0.0.8&quot; -m ping</span><br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>逻辑与</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在websrvs组并且在dbsrvs组中的主机</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;websrvs:&amp;dbsrvs&quot; -m ping</span><br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>逻辑非</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在websrvs组，但不在dbsrvs组中的主机</span><br><span class="hljs-comment">#注意：此处为单引号</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible &#x27;websrvs:!dbsrvs&#x27; -m ping</span><br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>综合逻辑</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible &#x27;websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs&#x27; -m ping</span><br>[WARNING]: Could not match supplied host pattern, ignoring: ftpsrvs<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>正则表达式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible &quot;websrvs:dbsrvs&quot; -m ping</span><br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible &quot;~(web|db).*&quot; -m ping</span><br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible &#x27;kube*:etcd:!10.0.0.101&#x27; -a reboot&amp;&amp;reboot</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible all --list-hosts </span><br>hosts (3):<br>  10.0.0.6<br>  10.0.0.7<br>  10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment">#ansible websrvs --list-hosts </span><br>hosts (3):<br>  10.0.0.6<br>  10.0.0.7<br>  10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment">#ansible appsrvs --list-hosts </span><br>hosts (2):<br>  10.0.0.7<br>  10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment">#ansible &quot;appsrvs:dbsrvs&quot; --list-hosts </span><br>hosts (3):<br>  10.0.0.7<br>  10.0.0.8<br>  10.0.0.6<br>[root@centos7 ~]<span class="hljs-comment">#ansible &quot;dbsrvs&quot; --list-hosts </span><br>hosts (2):<br>  10.0.0.6<br>  10.0.0.7<br>[root@centos7 ~]<span class="hljs-comment">#ansible appsrvs --list-hosts </span><br>hosts (2):<br>  10.0.0.7<br>  10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment">#ansible &quot;appsrvs:dbsrvs&quot; --list-hosts </span><br>hosts (3):<br>  10.0.0.7<br>  10.0.0.8<br>  10.0.0.6<br>[root@centos7 ~]<span class="hljs-comment">#ansible &quot;appsrvs:&amp;dbsrvs&quot; --list-hosts </span><br>hosts (1):<br>  10.0.0.7<br>[root@centos7 ~]<span class="hljs-comment">#ansible &quot;appsrvs:!dbsrvs&quot; --list-hosts </span><br>-bash: !dbsrvs: event not found<br>[root@centos7 ~]<span class="hljs-comment">#ansible &#x27;appsrvs:!dbsrvs&#x27; --list-hosts </span><br>hosts (1):<br>  10.0.0.8<br></code></pre></td></tr></table></figure>

<p><strong>ansible命令执行过程</strong></p>
<ol>
<li><p>加载自己的配置文件,默认/etc/ansible/ansible.cfg</p>
</li>
<li><p>加载自己对应的模块文件，如：command</p>
</li>
<li><p>通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服务器的对应执行用户 $HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件</p>
</li>
<li><p>给文件+x执行</p>
</li>
<li><p>执行并返回结果</p>
</li>
<li><p>删除临时py文件，退出</p>
</li>
</ol>
<p><strong>ansible 的执行状态：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#grep -A 14 &#x27;\[colors\]&#x27; /etc/ansible/ansible.cfg</span><br>[colors]<br><span class="hljs-comment">#highlight = white</span><br><span class="hljs-comment">#verbose = blue</span><br><span class="hljs-comment">#warn = bright purple</span><br><span class="hljs-comment">#error = red</span><br><span class="hljs-comment">#debug = dark gray</span><br><span class="hljs-comment">#deprecate = purple</span><br><span class="hljs-comment">#skip = cyan</span><br><span class="hljs-comment">#unreachable = red</span><br><span class="hljs-comment">#ok = green</span><br><span class="hljs-comment">#changed = yellow</span><br><span class="hljs-comment">#diff_add = green</span><br><span class="hljs-comment">#diff_remove = red</span><br><span class="hljs-comment">#diff_lines = cyan</span><br></code></pre></td></tr></table></figure>

<ul>
<li>绿色：执行成功并且不需要做改变的操作</li>
<li>黄色：执行成功并且对目标主机做变更</li>
<li>红色：执行失败</li>
</ul>
<p><strong>ansible使用范例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#以wang用户执行ping存活检测</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m ping -u rlin -k</span><br>SSH password: <br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>, <br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">#以rlin sudo至root执行ping存活检测</span><br><span class="hljs-string">ansible all -m ping -u rlin -k -b</span><br><span class="hljs-string">#以rlin sudo至mage用户执行ping存活检测</span><br><span class="hljs-string">ansible all -m ping -u rlin -k -b --become-user=mage</span><br><span class="hljs-string">#以rlin sudo至root用户执行ls</span><br><span class="hljs-string">ansible all -m command -u rlin -a &#x27;ls /root&#x27; -b --become-user=root -k -K</span><br></code></pre></td></tr></table></figure>

<h3 id="3-3-3-ansible-playbook"><a href="#3-3-3-ansible-playbook" class="headerlink" title="3.3.3 ansible-playbook"></a>3.3.3 ansible-playbook</h3><p>此工具用于执行编写好的 playbook 任务</p>
<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim hello.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment">#hello world yml file</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span> <span class="hljs-string">world</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/usr/bin/wall</span> <span class="hljs-string">hello</span> <span class="hljs-string">world</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook hello.yml</span><br><br><span class="hljs-string">PLAY</span> [<span class="hljs-string">websrvs</span>] <span class="hljs-string">******************************************************************************************************</span><br><br><span class="hljs-string">TASK</span> [<span class="hljs-string">hello</span> <span class="hljs-string">world</span>] <span class="hljs-string">**************************************************************************************************</span><br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span>]<br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span>]<br><br><span class="hljs-string">PLAY</span> <span class="hljs-string">RECAP</span> <span class="hljs-string">**********************************************************************************************************</span><br><span class="hljs-attr">10.0.0.7                   :</span> <span class="hljs-string">ok=1</span>    <span class="hljs-string">changed=1</span>    <span class="hljs-string">unreachable=0</span>    <span class="hljs-string">failed=0</span>    <span class="hljs-string">skipped=0</span>    <span class="hljs-string">rescued=0</span>    <span class="hljs-string">ignored=0</span>   <br><span class="hljs-attr">10.0.0.8                   :</span> <span class="hljs-string">ok=1</span>    <span class="hljs-string">changed=1</span>    <span class="hljs-string">unreachable=0</span>    <span class="hljs-string">failed=0</span>    <span class="hljs-string">skipped=0</span>    <span class="hljs-string">rescued=0</span>    <span class="hljs-string">ignored=0</span>  <br></code></pre></td></tr></table></figure>

<h3 id="3-3-4-ansible-vault"><a href="#3-3-4-ansible-vault" class="headerlink" title="3.3.4 ansible-vault"></a>3.3.4 ansible-vault</h3><p>此工具可以用于加密解密yml文件</p>
<p>格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible-vault [create|decrypt|edit|encrypt|rekey|view]<br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible-vault encrypt hello.yml <span class="hljs-comment">#加密</span><br>ansible-vault decrypt hello.yml <span class="hljs-comment">#解密</span><br>ansible-vault view hello.yml <span class="hljs-comment">#查看</span><br>ansible-vault edit hello.yml <span class="hljs-comment">#编辑加密文件</span><br>ansible-vault rekey hello.yml <span class="hljs-comment">#修改口令</span><br>ansible-vault create new.yml <span class="hljs-comment">#创建新文件</span><br></code></pre></td></tr></table></figure>

<p>范例：加密hello.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible-vault encrypt hello.yml</span><br>New Vault password: <br>Confirm New Vault password: <br>Encryption successful<br><br><span class="hljs-comment">#查看加密后的yml文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cat hello.yml </span><br><span class="hljs-variable">$ANSIBLE_VAULT</span>;1.1;AES256<br>39643437646163303761663565383564383436346436646530363764356531613435653838306437<br>3165623061363337643163353533363738636232613561630a623766363132323064663963636631<br>36643637353835663065663530646161333839636165646530623964346564396562633237373962<br>3035636531336263310a393365333663613735626462373934616633653932336336656637663735<br>30306364656438623135396636623965306330393163656632666465616464656361363634373762<br>38643334333939326435396464313264323362626261366664613534623335336135333364643864<br>37343031396639626137383534383566353463366635633364363364643432376337646237366337<br>33353432366338346437643635363561623063316234383465643031363831386661343738336661<br>33356462303966376239626230313566663035636333666463623264333335303361356135373463<br>33616661633237326132623433633233633364376437666135306563636131396665393332363538<br>66653436623465343263636536626236343936353836383462323830613065306339646463633666<br>33636264643539386231<br></code></pre></td></tr></table></figure>

<p>范例：解密hello.yml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible-vault decrypt hello.yml</span><br>Vault password: <br>Decryption successful<br><br><span class="hljs-comment">#查看解密后的yml文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cat hello.yml </span><br>---<br><span class="hljs-comment">#hello world yml file</span><br>- hosts: websrvs<br>  remote_user: root<br>  gather_facts: no<br>  tasks:<br>    - name: hello world<br>      <span class="hljs-built_in">command</span>: /usr/bin/wall hello world<br></code></pre></td></tr></table></figure>

<h3 id="3-3-5-ansible-console"><a href="#3-3-5-ansible-console" class="headerlink" title="3.3.5 ansible-console"></a>3.3.5 ansible-console</h3><p>此工具可交互执行命令，支持tab，ansible 2.0+新增</p>
<p>提示符格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$<br></code></pre></td></tr></table></figure>

<p><strong>常用子命令：</strong></p>
<ul>
<li>设置并发数： forks n 例如： forks 10</li>
<li>切换组： cd 主机组 例如： cd web</li>
<li>列出当前组主机列表： list</li>
<li>列出所有的内置命令： ?或help</li>
</ul>
<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@centos7 ~]<span class="hljs-comment">#ansible-console</span><br>Welcome to the ansible console.<br>Type <span class="hljs-built_in">help</span> or ? to list commands.<br><br>root@all (3)[f:5]$ ping<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br> &#125;,<br>  <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br> &#125;,<br>  <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span><br> &#125;,<br> <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>root@all (3)[f:5]$ list<br>10.0.0.8<br>10.0.0.7<br>10.0.0.6<br>root@all (3)[f:5]$ <span class="hljs-built_in">cd</span> websrvs<br>root@websrvs (2)[f:5]$ list<br>10.0.0.7<br>10.0.0.8<br>root@websrvs (2)[f:5]$ forks 10<br>root@websrvs (2)[f:10]$ <span class="hljs-built_in">cd</span> appsrvs<br>root@appsrvs (2)[f:5]$ yum name=httpd state=present<br>root@appsrvs (2)[f:5]$ service name=httpd state=started<br></code></pre></td></tr></table></figure>

<h3 id="3-3-6-ansible-galaxy"><a href="#3-3-6-ansible-galaxy" class="headerlink" title="3.3.6 ansible-galaxy"></a>3.3.6 ansible-galaxy</h3><p>此工具会连接 <a target="_blank" rel="noopener" href="https://galaxy.ansible.com/">https://galaxy.ansible.com</a> 下载相应的roles<br>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#列出所有已安装的galaxy</span><br>ansible-galaxy list<br><span class="hljs-comment">#安装galaxy</span><br>ansible-galaxy install geerlingguy.mysql<br>ansible-galaxy install geerlingguy.redis<br><span class="hljs-comment">#删除galaxy</span><br>ansible-galaxy remove geerlingguy.redis<br>ansible-galaxy install geerlingguy.mysql<br></code></pre></td></tr></table></figure>

<h2 id="3-4-Ansible常用模块"><a href="#3-4-Ansible常用模块" class="headerlink" title="3.4 Ansible常用模块"></a>3.4 Ansible常用模块</h2><p>2015年底270多个模块，2016年达到540个，2018年01月12日有1378个模块，2018年07月15日1852个模块,2019年05月25日（ansible 2.7.10）时2080个模块，2020年03月02日有3387个模块。虽然模块众多，但最常用的模块也就2，30个而已，针对特定业务只用10几个模块。</p>
<p>常用模块帮助文档参考：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.ansible.com/ansible/2.9/modules/modules_by_category.html<br>https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html<br><br>https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html<br>https://docs.ansible.com/ansible/latest/modules/modules_by_category.html<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible11.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible12.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="3-4-1-Command-模块"><a href="#3-4-1-Command-模块" class="headerlink" title="3.4.1 Command 模块"></a>3.4.1 Command 模块</h3><p>功能：在远程主机执行命令，此为默认模块，可忽略-m选项</p>
<p>注意：此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等，用shell模块实现</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible websrvs -m command -a &#x27;chdir=/etc cat centos-release&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>CentOS Linux release 7.7.1908 (Core)<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>CentOS Linux release 8.1.1911 (Core)<br>[root@centos7 ~]<span class="hljs-comment">#ansible websrvs -m command -a &#x27;chdir=/etc creates=/data/f1.txt cat centos-release&#x27;</span><br>cat centos-release<span class="hljs-string">&#x27;</span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">CentOS Linux release 7.7.1908 (Core)</span><br><span class="hljs-string">10.0.0.8 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="hljs-string">skipped, since /data/f1.txt exists</span><br><span class="hljs-string">[root@centos7 ~]#ansible websrvs -m command -a &#x27;</span><span class="hljs-built_in">chdir</span>=/etc removes=/data/f1.txt cat centos-release<span class="hljs-string">&#x27;</span><br><span class="hljs-string">10.0.0.7 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="hljs-string">skipped, since /data/f1.txt does not exist</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">CentOS Linux release 8.1.1911 (Core)</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible all -m command -a &#x27;</span>hostname<span class="hljs-string">&#x27;</span><br><span class="hljs-string">10.0.0.18 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">centos7.4</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">centos7.4</span><br><span class="hljs-string">10.0.0.6 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">centos7.4</span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">centos7.4</span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>mkdir -p /data<span class="hljs-string">&#x27;</span><br><span class="hljs-string">[WARNING]: Consider using the file module with state=directory rather than running &#x27;</span>mkdir<span class="hljs-string">&#x27;.  If you need to use</span><br><span class="hljs-string">command because file is insufficient you can add &#x27;</span>warn: <span class="hljs-literal">false</span><span class="hljs-string">&#x27; to this command task or set &#x27;</span>command_warnings=False<span class="hljs-string">&#x27;</span><br><span class="hljs-string">in ansible.cfg to get rid of this message.</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>touch /data/ansible.log<span class="hljs-string">&#x27;</span><br><span class="hljs-string">[WARNING]: Consider using the file module with state=touch rather than running &#x27;</span>touch<span class="hljs-string">&#x27;.  If you need to use command</span><br><span class="hljs-string">because file is insufficient you can add &#x27;</span>warn: <span class="hljs-literal">false</span><span class="hljs-string">&#x27; to this command task or set &#x27;</span>command_warnings=False<span class="hljs-string">&#x27; in</span><br><span class="hljs-string">ansible.cfg to get rid of this message.</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>ls /data -l<span class="hljs-string">&#x27;</span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">total 0</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:49 ansible.log</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">total 0</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:49 ansible.log</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>touch /data/hello.log<span class="hljs-string">&#x27;</span><br><span class="hljs-string">[WARNING]: Consider using the file module with state=touch rather than running &#x27;</span>touch<span class="hljs-string">&#x27;.  If you need to use command</span><br><span class="hljs-string">because file is insufficient you can add &#x27;</span>warn: <span class="hljs-literal">false</span><span class="hljs-string">&#x27; to this command task or set &#x27;</span>command_warnings=False<span class="hljs-string">&#x27; in</span><br><span class="hljs-string">ansible.cfg to get rid of this message.</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>creates=/data/ansible2.log touch /data/ansible2.log<span class="hljs-string">&#x27;</span><br><span class="hljs-string">[WARNING]: Consider using the file module with state=touch rather than running &#x27;</span>touch<span class="hljs-string">&#x27;.  If you need to use command</span><br><span class="hljs-string">because file is insufficient you can add &#x27;</span>warn: <span class="hljs-literal">false</span><span class="hljs-string">&#x27; to this command task or set &#x27;</span>command_warnings=False<span class="hljs-string">&#x27; in</span><br><span class="hljs-string">ansible.cfg to get rid of this message.</span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]# ansible websrvs -m command -a &#x27;</span>ls -l /data<span class="hljs-string">&#x27;</span><br><span class="hljs-string">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">total 0</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:52 ansible2.log</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:49 ansible.log</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:50 hello.log</span><br><span class="hljs-string">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="hljs-string">total 0</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:52 ansible2.log</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:49 ansible.log</span><br><span class="hljs-string">-rw-r--r--. 1 root root 0 Mar  8 21:50 hello.log</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-2-Shell-模块"><a href="#3-4-2-Shell-模块" class="headerlink" title="3.4.2 Shell 模块"></a>3.4.2 Shell 模块</h4><p>功能：和command相似，用shell执行命令,支持各种符号,比如:*,$, &gt;</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m shell -a &quot;echo $HOSTNAME&quot;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>ansible<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>ansible<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m shell -a &#x27;echo $HOSTNAME&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>centos7.wangxiaochun.com<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>centos8.localdomain<br>[root@centos7 ~]<span class="hljs-comment">#ansible websrvs -m shell -a &#x27;echo centos | passwd --stdin wang&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>Changing password <span class="hljs-keyword">for</span> user wang.<br>passwd: all authentication tokens updated successfully.<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>Changing password <span class="hljs-keyword">for</span> user wang.<br>passwd: all authentication tokens updated successfully.<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m shell -a &#x27;ls -l /etc/shadow&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>---------- 1 root root 889 Mar  2 14:34 /etc/shadow<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>---------- 1 root root 944 Mar  2 14:34 /etc/shadow<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m shell -a &#x27;echo hello &gt; /data/hello.log&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m shell -a &#x27;cat /data/hello.log&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>hello<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>hello<br></code></pre></td></tr></table></figure>

<p><strong>注意：调用bash执行命令 类似 cat /tmp/test.md | awk -F’|’ ‘{print $1,$2}’ &amp;&gt; /tmp/example.txt 这些复杂命令，即使使用shell也可能会失败，解决办法：写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器</strong></p>
<p>范例：将shell模块代替command，设为模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># vim /etc/ansible/ansible.cfg</span><br><span class="hljs-comment">#修改下面一行</span><br>module_name = shell<br></code></pre></td></tr></table></figure>

<h3 id="3-4-3-Script-模块"><a href="#3-4-3-Script-模块" class="headerlink" title="3.4.3 Script 模块"></a>3.4.3 Script 模块</h3><p>功能：在远程主机上运行ansible服务器上的脚本(无需执行权限)</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># vim test.sh</span><br><span class="hljs-built_in">echo</span> `uname -a`<br><span class="hljs-built_in">echo</span> `hostname -I`<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m script -a test.sh</span><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;rc&quot;</span>: 0, <br>    <span class="hljs-string">&quot;stderr&quot;</span>: <span class="hljs-string">&quot;Shared connection to 10.0.0.7 closed.\r\n&quot;</span>, <br>    <span class="hljs-string">&quot;stderr_lines&quot;</span>: [<br>        <span class="hljs-string">&quot;Shared connection to 10.0.0.7 closed.&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;stdout&quot;</span>: <span class="hljs-string">&quot;Linux centos7.4 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n10.0.0.7\r\n&quot;</span>, <br>    <span class="hljs-string">&quot;stdout_lines&quot;</span>: [<br>        <span class="hljs-string">&quot;Linux centos7.4 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux&quot;</span>, <br>        <span class="hljs-string">&quot;10.0.0.7&quot;</span><br>    ]<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;rc&quot;</span>: 0, <br>    <span class="hljs-string">&quot;stderr&quot;</span>: <span class="hljs-string">&quot;Shared connection to 10.0.0.8 closed.\r\n&quot;</span>, <br>    <span class="hljs-string">&quot;stderr_lines&quot;</span>: [<br>        <span class="hljs-string">&quot;Shared connection to 10.0.0.8 closed.&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;stdout&quot;</span>: <span class="hljs-string">&quot;Linux centos7.4 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n10.0.0.8\r\n&quot;</span>, <br>    <span class="hljs-string">&quot;stdout_lines&quot;</span>: [<br>        <span class="hljs-string">&quot;Linux centos7.4 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux&quot;</span>, <br>        <span class="hljs-string">&quot;10.0.0.8&quot;</span><br>    ]<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="3-4-4-Copy-模块"><a href="#3-4-4-Copy-模块" class="headerlink" title="3.4.4 Copy 模块"></a>3.4.4 Copy 模块</h3><p>功能：从ansible服务器主控端复制文件到远程主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#如目标存在，默认覆盖，此处指定先备份</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m copy -a &quot;src=/etc/centos-release dest=/data/release.txt  owner=wang mode=600 backup=yes&quot;</span><br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;0b2b27eb190f790ec5ff65897b3a1ef844f254c5&quot;</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/release.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;md5sum&quot;</span>: <span class="hljs-string">&quot;1bbbbf90102ed1317186597c4660e84a&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0600&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;wang&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;system_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 38, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615212848.14-8218-49950772426522/source&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1001<br>&#125;<br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;0b2b27eb190f790ec5ff65897b3a1ef844f254c5&quot;</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/release.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;md5sum&quot;</span>: <span class="hljs-string">&quot;1bbbbf90102ed1317186597c4660e84a&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0600&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;wang&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;system_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 38, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615212848.14-8217-112917478920795/source&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1001<br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs  -m command -a &#x27;ls -l /data&#x27;</span><br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>total 8<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>total 8<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br><br><br><span class="hljs-comment">#指定内容，直接生成目标文件  </span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m copy -a &quot;content=&#x27;test line1\ntest line2&#x27; dest=/data/test.txt&quot;</span><br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;43791ccbbcf72774b2bbbe6fe8d7ab488359b922&quot;</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;md5sum&quot;</span>: <span class="hljs-string">&quot;f0e596e1a1a3ef7d278f2dda4d4e6ec8&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;system_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 21, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615212961.65-8378-107969903896386/source&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;43791ccbbcf72774b2bbbe6fe8d7ab488359b922&quot;</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;md5sum&quot;</span>: <span class="hljs-string">&quot;f0e596e1a1a3ef7d278f2dda4d4e6ec8&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;system_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 21, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615212961.65-8377-267508619796205/source&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs  -m command -a &#x27;ls -l /data&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br><br><br><span class="hljs-comment">#复制/etc目录自身,注意/etc/后面没有/</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m copy -a &quot;src=/etc dest=/backup&quot;</span><br><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/backup/&quot;</span>, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/etc&quot;</span><br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/backup/&quot;</span>, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/etc&quot;</span><br>&#125;<br><br><span class="hljs-comment">#复制/etc/下的文件，不包括/etc/目录自身,注意/etc/后面有/</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m copy -a &quot;src=/etc/ dest=/backup&quot;</span><br><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/backup/&quot;</span>, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/etc/&quot;</span><br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/backup/&quot;</span>, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/etc/&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-4-5-Fetch-模块"><a href="#3-4-5-Fetch-模块" class="headerlink" title="3.4.5 Fetch 模块"></a>3.4.5 Fetch 模块</h3><p>功能：从远程主机提取文件至ansible的主控端，copy相反，目前不支持目录</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m fetch -a &#x27;src=/root/test.sh dest=/data/scripts&#x27;</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible  all -m fetch -a &#x27;src=/etc/redhat-release</span><br>dest=/data/os<span class="hljs-string">&#x27;</span><br><span class="hljs-string">[root@centos7 ~]#tree /data/os/</span><br><span class="hljs-string">/data/os/</span><br><span class="hljs-string">├── 10.0.0.6</span><br><span class="hljs-string">│  └── etc</span><br><span class="hljs-string">│    └── redhat-release</span><br><span class="hljs-string">├── 10.0.0.7</span><br><span class="hljs-string">│  └── etc</span><br><span class="hljs-string">│    └── redhat-release</span><br><span class="hljs-string">└── 10.0.0.8</span><br><span class="hljs-string"> └── etc</span><br><span class="hljs-string">   └── redhat-release</span><br><span class="hljs-string">6 directories, 3 files</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-6-File-模块"><a href="#3-4-6-File-模块" class="headerlink" title="3.4.6 File 模块"></a>3.4.6 File 模块</h3><p>功能：设置文件属性,创建软链接等</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建空文件</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m file -a &#x27;path=/data/test.txt state=touch&#x27;</span><br>10.0.0.18 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test1.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 0, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test1.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 0, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.6 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test1.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 0, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/test1.txt&quot;</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0644&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 0, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m file -a &quot;path=/root/test.sh owner=wang mode=755&quot;</span><br><br><span class="hljs-comment">#创建目录-例1</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m file -a &#x27;dest=/data/filedir state=directory&#x27;</span><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m command -a &#x27;ls -l /data&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>drwxr-xr-x. 2 root root  6 Mar  9 17:59 filedir<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>drwxr-xr-x. 2 root root  6 Mar  9 18:00 filedir<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br><br><span class="hljs-comment">#创建目录-例2</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m file -a &quot;path=/data/rlindir state=directory owner=rlin group=rlin&quot;</span><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 1000, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/rlindir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1000<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 1000, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/rlindir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1000<br>&#125;<br>10.0.0.18 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 1000, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/rlindir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1000<br>&#125;<br>10.0.0.6 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 1000, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;rlin&quot;</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/rlindir&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 6, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1000<br>&#125;<br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m command -a &#x27;ls -l /data&#x27;</span><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>drwxr-xr-x. 2 root root  6 Mar  9 17:59 filedir<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>drwxr-xr-x. 2 root root  6 Mar  9 18:01 mysql<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>drwxr-xr-x. 2 rlin rlin  6 Mar  9 18:01 rlindir<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br>10.0.0.6 | CHANGED | rc=0 &gt;&gt;<br>total 0<br>drwxr-xr-x. 2 rlin rlin 6 Mar  9 18:01 rlindir<br>10.0.0.8 | CHANGED | rc=0 &gt;&gt;<br>total 12<br>-rw-r--r--. 1 root root  0 Mar  8 21:52 ansible2.log<br>-rw-r--r--. 1 root root  0 Mar  8 21:49 ansible.log<br>drwxr-xr-x. 2 root root  6 Mar  9 18:00 filedir<br>-rw-r--r--. 1 root root  6 Mar  8 22:03 hello.log<br>drwxr-xr-x. 2 root root  6 Mar  9 18:01 mysql<br>-rw-------. 1 wang root 38 Mar  8 22:14 release.txt<br>drwxr-xr-x. 2 rlin rlin  6 Mar  9 18:01 rlindir<br>-rw-r--r--. 1 root root 21 Mar  8 22:16 test.txt<br>10.0.0.18 | CHANGED | rc=0 &gt;&gt;<br>total 0<br>drwxr-xr-x. 2 rlin rlin 6 Mar  9 18:01 rlindir<br><br><br><span class="hljs-comment">#创建软链接</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m file -a &#x27;src=/data/testfile path|dest|name=/data/testfile-link state=link&#x27;</span><br><br><br><span class="hljs-comment">#递归修改目录属性=chown mysql.mysql -R</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m file -a &quot;path=/data/mysql state=directory owner=mysql group=mysql recurse=yes&quot;</span><br><br><span class="hljs-comment">#删除文件</span><br>[root@centos7 ~]<span class="hljs-comment">#  ansible websrvs -m file -a &#x27;dest=/data/filedir/a.txt state=absent&#x27;</span><br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir/a.txt&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;absent&quot;</span><br>&#125;<br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir/a.txt&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;absent&quot;</span><br>&#125;<br><br><span class="hljs-comment">#删除文件夹</span><br>[root@centos7 ~]<span class="hljs-comment">#  ansible websrvs -m file -a &#x27;dest=/data/filedir state=absent&#x27;</span><br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;absent&quot;</span><br>&#125;<br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/data/filedir&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;absent&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="3-4-7-unarchive-模块"><a href="#3-4-7-unarchive-模块" class="headerlink" title="3.4.7 unarchive 模块"></a>3.4.7 unarchive 模块</h3><p>功能：解包解压缩</p>
<p>实现有两种用法：</p>
<p>1、将ansible主机上的压缩包传到远程主机后解压缩至特定目录，设置copy=yes</p>
<p>2、将远程主机上的某个压缩包解压缩到指定路径下，设置copy=no</p>
<p>常见参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">copy：默认为yes，当copy=yes，拷贝的文件是从ansible主机复制到远程主机上，如果设置为copy=no，会在远程主机上寻找src源文件<br>remote_src：和copy功能一样且互斥，yes表示在远程主机，不在ansible主机，no表示文件在ansible主机上<br>src：源路径，可以是ansible主机上的路径，也可以是远程主机(被管理端或者第三方主机)上的路径，如果是远程主机上的路径，则需要设置copy=no<br>dest：远程主机上的目标路径<br>mode：设置解压缩后的文件权限<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible all -m unarchive -a &#x27;src=/data/foo.tgz dest=/var/lib/foo owner=wang group=bin&#x27;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m unarchive -a &#x27;src=/tmp/foo.zip dest=/data copy=no mode=0777&#x27;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m unarchive -a &#x27;src=https://example.com/example.zip dest=/data copy=no&#x27;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m unarchive -a &#x27;src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/data/  owner=mysql remote_src=yes&#x27;</span><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/&quot;</span>, <br>    <span class="hljs-string">&quot;extract_results&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;cmd&quot;</span>: [<br>            <span class="hljs-string">&quot;/usr/bin/gtar&quot;</span>, <br>            <span class="hljs-string">&quot;--extract&quot;</span>, <br>            <span class="hljs-string">&quot;-C&quot;</span>, <br>            <span class="hljs-string">&quot;/data/&quot;</span>, <br>            <span class="hljs-string">&quot;-z&quot;</span>, <br>            <span class="hljs-string">&quot;--owner=rlin&quot;</span>, <br>            <span class="hljs-string">&quot;-f&quot;</span>, <br>            <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615286342.0-95739-108372540609757/ansible-2.1.6.0-0.1.rc1.tar2EP0sV.gz&quot;</span><br>        ], <br>        <span class="hljs-string">&quot;err&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <br>        <span class="hljs-string">&quot;out&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <br>        <span class="hljs-string">&quot;rc&quot;</span>: 0<br>    &#125;, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;handler&quot;</span>: <span class="hljs-string">&quot;TgzArchive&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 165, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615286342.0-95739-108372540609757/ansible-2.1.6.0-0.1.rc1.tar2EP0sV.gz&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/&quot;</span>, <br>    <span class="hljs-string">&quot;extract_results&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;cmd&quot;</span>: [<br>            <span class="hljs-string">&quot;/usr/bin/gtar&quot;</span>, <br>            <span class="hljs-string">&quot;--extract&quot;</span>, <br>            <span class="hljs-string">&quot;-C&quot;</span>, <br>            <span class="hljs-string">&quot;/data/&quot;</span>, <br>            <span class="hljs-string">&quot;-z&quot;</span>, <br>            <span class="hljs-string">&quot;--owner=rlin&quot;</span>, <br>            <span class="hljs-string">&quot;-f&quot;</span>, <br>            <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615286341.99-95740-138957129216327/ansible-2.1.6.0-0.1.rc1.taro0JQVk.gz&quot;</span><br>        ], <br>        <span class="hljs-string">&quot;err&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <br>        <span class="hljs-string">&quot;out&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <br>        <span class="hljs-string">&quot;rc&quot;</span>: 0<br>    &#125;, <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;handler&quot;</span>: <span class="hljs-string">&quot;TgzArchive&quot;</span>, <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0755&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 165, <br>    <span class="hljs-string">&quot;src&quot;</span>: <span class="hljs-string">&quot;/root/.ansible/tmp/ansible-tmp-1615286341.99-95740-138957129216327/ansible-2.1.6.0-0.1.rc1.taro0JQVk.gz&quot;</span>, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;directory&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 0<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="3-4-8-Archive-模块"><a href="#3-4-8-Archive-模块" class="headerlink" title="3.4.8 Archive 模块"></a>3.4.8 Archive 模块</h3><p>功能：打包压缩保存在被管理节点<br>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m archive  -a &#x27;path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=wang mode=0600&#x27;</span><br>10.0.0.7 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;archived&quot;</span>: [<br>        <span class="hljs-string">&quot;/var/log/tallylog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/grubby_prune_debug&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/lastlog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/vmware-vgauthsvc.log.0&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/vmware-vmsvc.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/firewalld&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/yum.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/dmesg.old&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/dmesg&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/cron-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/cron&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/maillog-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/maillog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/messages-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/messages&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/secure-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/secure&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/spooler-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/spooler&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/btmp-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/btmp&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log-20210308&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log-20210309&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/wtmp-20210309&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/wtmp&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/tuned/tuned.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.4&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.3&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.2&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.1&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/anaconda.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/syslog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/X.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/program.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/packaging.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/storage.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ifcfg.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ks-script-14N23b.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ks-script-azeNm9.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/journal.log&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;arcroot&quot;</span>: <span class="hljs-string">&quot;/var/log/&quot;</span>, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/log.tar.bz2&quot;</span>, <br>    <span class="hljs-string">&quot;expanded_exclude_paths&quot;</span>: [], <br>    <span class="hljs-string">&quot;expanded_paths&quot;</span>: [<br>        <span class="hljs-string">&quot;/var/log/&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;missing&quot;</span>: [], <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0600&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;wang&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 1206553, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1001<br>&#125;<br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;archived&quot;</span>: [<br>        <span class="hljs-string">&quot;/var/log/tallylog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/grubby_prune_debug&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/lastlog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/vmware-vgauthsvc.log.0&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/vmware-vmsvc.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/firewalld&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/yum.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/dmesg.old&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/cron-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/cron&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/maillog-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/maillog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/messages-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/messages&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/secure-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/secure&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/spooler-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/spooler&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/btmp-20210307&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/btmp&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/dmesg&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/boot.log-20210309&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/wtmp-20210309&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/wtmp&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/tuned/tuned.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.4&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.3&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.2&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log.1&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/audit/audit.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/anaconda.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/syslog&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/X.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/program.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/packaging.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/storage.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ifcfg.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ks-script-14N23b.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/ks-script-azeNm9.log&quot;</span>, <br>        <span class="hljs-string">&quot;/var/log/anaconda/journal.log&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;arcroot&quot;</span>: <span class="hljs-string">&quot;/var/log/&quot;</span>, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;dest&quot;</span>: <span class="hljs-string">&quot;/data/log.tar.bz2&quot;</span>, <br>    <span class="hljs-string">&quot;expanded_exclude_paths&quot;</span>: [], <br>    <span class="hljs-string">&quot;expanded_paths&quot;</span>: [<br>        <span class="hljs-string">&quot;/var/log/&quot;</span><br>    ], <br>    <span class="hljs-string">&quot;gid&quot;</span>: 0, <br>    <span class="hljs-string">&quot;group&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>, <br>    <span class="hljs-string">&quot;missing&quot;</span>: [], <br>    <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0600&quot;</span>, <br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;wang&quot;</span>, <br>    <span class="hljs-string">&quot;secontext&quot;</span>: <span class="hljs-string">&quot;unconfined_u:object_r:default_t:s0&quot;</span>, <br>    <span class="hljs-string">&quot;size&quot;</span>: 1262391, <br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>, <br>    <span class="hljs-string">&quot;uid&quot;</span>: 1001<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-4-9-Hostname-模块"><a href="#3-4-9-Hostname-模块" class="headerlink" title="3.4.9 Hostname 模块"></a>3.4.9 Hostname 模块</h3><p>功能：管理主机名</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible node1 -m hostname -a &quot;name=websrv&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible 10.0.0.8 -m hostname -a &#x27;name=node18.rlin.com&#x27;</span><br>10.0.0.8 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;ansible_domain&quot;</span>: <span class="hljs-string">&quot;ilxnetworks.com&quot;</span>, <br>        <span class="hljs-string">&quot;ansible_fqdn&quot;</span>: <span class="hljs-string">&quot;cius-ilx-lc420401.ilxnetworks.com&quot;</span>, <br>        <span class="hljs-string">&quot;ansible_hostname&quot;</span>: <span class="hljs-string">&quot;node18&quot;</span>, <br>        <span class="hljs-string">&quot;ansible_nodename&quot;</span>: <span class="hljs-string">&quot;node18.rlin.com&quot;</span>, <br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;node18.rlin.com&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-4-10-Cron-模块"><a href="#3-4-10-Cron-模块" class="headerlink" title="3.4.10 Cron 模块"></a>3.4.10 Cron 模块</h3><p>功能：计划任务</p>
<p>支持时间：minute，hour，day，month，weekday</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#备份数据库脚本</span><br>[root@centos7 ~]<span class="hljs-comment">#cat /root/mysql_backup.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>mysqldump -A -F --single-transaction --master-data=2 -q -uroot | gzip &gt; /data/mysql_`date +%F_%T`.sql.gz<br><br><span class="hljs-comment">#创建任务</span><br><span class="hljs-comment">#周一到周五的2:30备份mysql数据</span><br>ansible dbsrvs -m cron -a <span class="hljs-string">&#x27;hour=2 minute=30 weekday=1-5 name=&quot;backup mysql&quot; job=/root/mysql_backup.sh&#x27;</span> <br><span class="hljs-comment">#每隔5分钟与阿里云同步一次时间</span><br>ansible websrvs -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate ntp.aliyun.com &amp;&gt;/dev/null&#x27; name=Synctime&quot;</span> <span class="hljs-comment">#</span><br><br><span class="hljs-comment">#禁用计划任务</span><br>ansible websrvs -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate 172.20.0.1 &amp;&gt;/dev/null&#x27; name=Synctime disabled=yes&quot;</span><br><br><span class="hljs-comment">#启用计划任务</span><br>ansible websrvs -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate 172.20.0.1 &amp;&gt;/dev/null&#x27; name=Synctime disabled=no&quot;</span><br><br><span class="hljs-comment">#删除任务</span><br>ansible websrvs -m cron -a <span class="hljs-string">&quot;name=&#x27;backup mysql&#x27; state=absent&quot;</span><br>ansible websrvs -m cron -a <span class="hljs-string">&#x27;state=absent name=Synctime&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-11-Yum-和-Apt-模块"><a href="#3-4-11-Yum-和-Apt-模块" class="headerlink" title="3.4.11 Yum 和 Apt 模块"></a>3.4.11 Yum 和 Apt 模块</h3><p>功能：<br>yum 管理软件包，只支持RHEL，CentOS，fedora，不支持Ubuntu其它版本</p>
<p><strong>yum模块常用参数</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>是否必须</th>
<th>默认值</th>
<th>选项值</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td>conf_file</td>
<td>no</td>
<td></td>
<td></td>
<td>设定远程yum执行时所依赖的yum配置文件</td>
</tr>
<tr>
<td>disable_gpg_check</td>
<td>no</td>
<td>no</td>
<td>yes/no</td>
<td>在安装包前检查包，只会影响state参数为<em>present</em>或者<em>latest</em>的时候</td>
</tr>
<tr>
<td>list</td>
<td>no</td>
<td></td>
<td></td>
<td>只能由ansible调用，不支持playbook</td>
</tr>
<tr>
<td>name</td>
<td>yes</td>
<td></td>
<td></td>
<td>你需要安装的包的名字，也能如此使用<em>name=python=2.7</em>安装python2.7</td>
</tr>
<tr>
<td>state</td>
<td>no</td>
<td>present</td>
<td>present/latest/absent</td>
<td>用于描述安装包最终状态，<em>present/latest</em>用于安装包，<em>absent</em>用于remove安装包</td>
</tr>
<tr>
<td>update_cache</td>
<td>no</td>
<td>no</td>
<td>yes/no</td>
<td>用于安装包前执行更新list,只会影响state参数为<em>present/latest</em>的时候</td>
</tr>
</tbody></table>
<p>apt 模块管理 Debian 相关版本的软件包</p>
<p><strong>apt模块参数</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>是否必须</th>
<th>默认值</th>
<th>选项值</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td>cache_valid_time</td>
<td>no</td>
<td></td>
<td></td>
<td>如果update_cache参数起作用的时候，这个参数才会起作用。其用来控制update_cache的整体有效时间</td>
</tr>
<tr>
<td>deb</td>
<td>no</td>
<td></td>
<td></td>
<td>这个用于安装远程机器上的.deb后缀的软件包</td>
</tr>
<tr>
<td>default_release</td>
<td>no</td>
<td></td>
<td></td>
<td>等同于apt命令的-t选项，这里就不多说了</td>
</tr>
<tr>
<td>force</td>
<td>no</td>
<td>no</td>
<td>yes/no</td>
<td>强制执行apt install/remove</td>
</tr>
<tr>
<td>install_recommends</td>
<td>no</td>
<td>Ture</td>
<td>yes/no</td>
<td>这个参数可以控制远程电脑上是否只是下载软件包，还是下载后安装，默认参数为true,设置为false的时候光下载软件包，不安装</td>
</tr>
<tr>
<td>name</td>
<td>no</td>
<td></td>
<td></td>
<td>apt要下载的软件包名字，支持name=git=1.6 这种制定版本的模式</td>
</tr>
<tr>
<td>purge</td>
<td>no</td>
<td></td>
<td>yes/no</td>
<td>如果state参数值为absent,这个参数为yes的时候，将会强行干净的卸载</td>
</tr>
<tr>
<td>state</td>
<td>no</td>
<td>present</td>
<td>latest/absent/present</td>
<td>定义软件包的最终状态，latest时为安装最新软件</td>
</tr>
<tr>
<td>update_cache</td>
<td>no</td>
<td></td>
<td>yes/no</td>
<td>当这个参数为yes的时候等于apt-get update</td>
</tr>
<tr>
<td>upgrade</td>
<td>no</td>
<td>yes</td>
<td>yes/safe/full/dist</td>
<td>如果参数为yes或者safe，等同于apt-get upgrade.如果是<em>full</em>就是完整更新。如果是dist等于apt-get dist-upgrade。</td>
</tr>
</tbody></table>
<p>yum范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装httpd</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=httpd state=present&#x27;  </span><br><span class="hljs-comment">#删除</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=httpd state=absent&#x27;  </span><br><span class="hljs-comment">#安装最新版本的httpd</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=httpd state=latest&#x27;</span><br><span class="hljs-comment">#安装某个版本的httpd</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=httpd-2.2.29-1.4.amzn1 state=present&#x27;</span><br><span class="hljs-comment"># 升级所有软件包</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=* state=latest&#x27;</span><br><span class="hljs-comment">#从一个远程yum仓库安装nginx</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=http://nginx.org/packages/centos/6/x86_64/RPMS/nginx-1.16.1-1.el6.ngx.x86_64.rpm state=present&#x27;</span><br><span class="hljs-comment">#从本地仓库安装nginx</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=/usr/local/src/nginx-1.16.1-1.el6.ngx.x86_64.rpm state=present&#x27;</span><br><span class="hljs-comment">#安装整个Development tools相关的软件包</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m yum -a &#x27;name=@Development tools state=present&#x27;</span><br></code></pre></td></tr></table></figure>

<p>apt范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装nginx软件前更新然后安装nginx</span><br>root@ubuntu ~<span class="hljs-comment"># ansible 10.0.0.100 -m apt -a &#x27;name=nginx update_cache=yes&#x27;</span><br><span class="hljs-comment">#移除nginx软件包</span><br>root@ubuntu ~<span class="hljs-comment"># ansible websrvs -m apt -a &#x27;name=nginx state=absent&#x27;</span><br><span class="hljs-comment">#安装nginx软件包</span><br>root@ubuntu ~<span class="hljs-comment"># ansible websrvs -m apt -a &#x27;name=nginx state=present&#x27;</span><br><span class="hljs-comment">#安装nginx 1.14.0软件安装包</span><br>root@ubuntu ~<span class="hljs-comment"># ansible websrvs -m apt -a &#x27;name=nginx=1.14.0-0ubuntu1.9 state=absent&#x27;</span><br><span class="hljs-comment">#安装nginx最新的名字为squeeze-backport发布包，并且安装前执行更新</span><br>root@ubuntu ~<span class="hljs-comment"># ansible websrvs -m apt -a &#x27;name=nginx state=latest default_release=squeeze-backport update_cache=yes&#x27;</span><br><span class="hljs-comment">#只下载openjdk-6-jdk最新安装包，不安装</span><br>root@ubuntu ~<span class="hljs-comment"># ansible websrvs -m apt -a &#x27;name=nginx state=latest install_recommends=no&#x27;</span><br><span class="hljs-comment">#安装所有软件包到最新版本</span><br>root@ubuntu ~<span class="hljs-comment"># ansible websrvs -m apt -a &#x27;upgrade=dist&#x27;</span><br><span class="hljs-comment">#更新apt-get的list</span><br>root@ubuntu ~<span class="hljs-comment"># ansible websrvs -m apt -a &#x27;update_cache=yes&#x27;</span><br><span class="hljs-comment">#3600秒后停止update_cache</span><br>root@ubuntu ~<span class="hljs-comment"># ansible websrvs -m apt -a &#x27;update_cache=yes cache_valid_time=3600&#x27;</span><br><span class="hljs-comment">#安装远程节点上的/usr/local/src/xxx.deb包</span><br>root@ubuntu ~<span class="hljs-comment"># ansible websrvs -m apt -a &#x27;deb=/usr/local/src/xxx.deb&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-12-Service-模块"><a href="#3-4-12-Service-模块" class="headerlink" title="3.4.12 Service 模块"></a>3.4.12 Service 模块</h3><p>功能：管理服务</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible all -m service -a &#x27;name=httpd state=started enabled=yes&#x27;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m service -a &#x27;name=httpd state=stopped&#x27;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m service -a &#x27;name=httpd state=reloaded&#x27;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m shell -a &quot;sed -i &#x27;s/^Listen 80/Listen 8080/&#x27; /etc/httpd/conf/httpd.conf&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m service -a &#x27;name=httpd state=restarted&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-13-User-模块"><a href="#3-4-13-User-模块" class="headerlink" title="3.4.13 User 模块"></a>3.4.13 User 模块</h3><p>功能：管理用户</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建用户</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m user -a &#x27;name=user1 comment=&quot;test user&quot; uid=2048 home=/app/user1 group=root&#x27;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m user -a &#x27;name=nginx comment=nginx uid=88 group=nginx groups=&quot;root,daemon&quot; shell=/sbin/nologin system=yes create_home=no home=/data/nginx non_unique=yes&#x27;</span><br><br><span class="hljs-comment">#remove=yes表示删除用户及家目录等数据,默认remove=no</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m user -a &#x27;name=nginx state=absent remove=yes&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-14-Group-模块"><a href="#3-4-14-Group-模块" class="headerlink" title="3.4.14 Group 模块"></a>3.4.14 Group 模块</h3><p>功能：管理组</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建组</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m group  -a &#x27;name=nginx gid=88 system=yes&#x27;</span><br><span class="hljs-comment">#删除组</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m group  -a &#x27;name=nginx state=absent&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-15-Lineinfile-模块"><a href="#3-4-15-Lineinfile-模块" class="headerlink" title="3.4.15 Lineinfile 模块"></a>3.4.15 Lineinfile 模块</h3><p>ansible在使用sed进行替换时，经常会遇到需要转义的问题，而且ansible在遇到特殊符号进行替换时，存在问题，无法正常进行替换 。其实在ansible自身提供了两个模块：lineinfile模块和replace模块，可以方便的进行替换</p>
<p>一般在ansible当中去修改某个文件的单行进行替换的时候需要使用lineinfile模块</p>
<p><strong>regexp参数 ：使用正则表达式匹配对应的行，当替换文本时，如果有多行文本都能被匹配，则只有最后面被匹配到的那行文本才会被替换，当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除。</strong></p>
<p><strong>如果想进行多行匹配进行替换需要使用replace模块</strong></p>
<p>功能：相当于sed，可以修改文件内容</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible websrvs -m lineinfile -a &quot;path=/etc/httpd/conf/httpd.conf regexp=&#x27;^Listen&#x27; line=&#x27;Listen 80&#x27;&quot;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m  lineinfile -a &quot;path=/etc/selinux/config regexp=&#x27;^SELINUX=&#x27; line=&#x27;SELINUX=disabled&#x27;&quot;</span><br><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m lineinfile  -a &#x27;dest=/etc/fstab state=absent regexp=&quot;^#&quot;&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-16-Replace-模块"><a href="#3-4-16-Replace-模块" class="headerlink" title="3.4.16 Replace 模块"></a>3.4.16 Replace 模块</h3><p>该模块有点类似于sed命令，主要也是基于正则进行匹配和替换，建议使用</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible all -m replace -a &quot;path=/etc/fstab regexp=&#x27;^(UUID.*)&#x27; replace=&#x27;#\1&#x27;&quot; </span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m replace -a &quot;path=/etc/fstab regexp=&#x27;^#(UUID.*)&#x27; replace=&#x27;\1&#x27;&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-17-Setup-模块"><a href="#3-4-17-Setup-模块" class="headerlink" title="3.4.17 Setup 模块"></a>3.4.17 Setup 模块</h3><p>功能： setup 模块来收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机较多，会影响执行速度，可以使用 gather_facts: no 来禁止 Ansible 收集 facts 信息</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_nodename&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_hostname&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_domain&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_memtotal_mb&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_memory_mb&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_memfree_mb&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_os_family&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_distribution_major_version&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_distribution_version&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_processor_vcpus&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_all_ipv4_addresses&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_architecture&quot;</span><br>[root@centos7 ~]<span class="hljs-comment"># ansible all -m setup -a &quot;filter=ansible_processor*&quot;</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#ansible all -m setup -a &#x27;filter=ansible_python_version&#x27;</span><br>10.0.0.7 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;ansible_python_version&quot;</span>: <span class="hljs-string">&quot;2.7.5&quot;</span>,<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br> &#125;,<br>  <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br>10.0.0.6 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;ansible_python_version&quot;</span>: <span class="hljs-string">&quot;2.6.6&quot;</span>,<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br> &#125;,<br>  <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br>10.0.0.8 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;ansible_python_version&quot;</span>: <span class="hljs-string">&quot;3.6.8&quot;</span>,<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span><br> &#125;,<br>  <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br>[root@centos7 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>范例：取IP地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#取所有IP</span><br>ansible 10.0.0.101 -m setup -a <span class="hljs-string">&#x27;filter=ansible_all_ipv4_addresses&#x27;</span><br>10.0.0.101 | SUCCESS =&gt; &#123;<br> <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>   <span class="hljs-string">&quot;ansible_all_ipv4_addresses&quot;</span>: [<br>      <span class="hljs-string">&quot;192.168.0.1&quot;</span>,<br>      <span class="hljs-string">&quot;192.168.0.2&quot;</span>,<br>      <span class="hljs-string">&quot;192.168.64.238&quot;</span>,<br>      <span class="hljs-string">&quot;192.168.13.36&quot;</span>,<br>      <span class="hljs-string">&quot;10.0.0.101&quot;</span>,<br>      <span class="hljs-string">&quot;172.16.1.0&quot;</span>,<br>      <span class="hljs-string">&quot;172.17.0.1&quot;</span><br>    ]<br>  &#125;,<br> <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">#取默认IP</span><br>ansible all -m setup -a <span class="hljs-string">&#x27;filter=&quot;ansible_default_ipv4&quot;&#x27;</span><br>10.0.0.101 | SUCCESS =&gt; &#123;<br> <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>   <span class="hljs-string">&quot;ansible_default_ipv4&quot;</span>: &#123;<br>     <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;10.0.0.101&quot;</span>,<br>     <span class="hljs-string">&quot;alias&quot;</span>: <span class="hljs-string">&quot;eth0&quot;</span>,<br>     <span class="hljs-string">&quot;broadcast&quot;</span>: <span class="hljs-string">&quot;10.0.0.255&quot;</span>,<br>     <span class="hljs-string">&quot;gateway&quot;</span>: <span class="hljs-string">&quot;10.0.0.2&quot;</span>,<br>     <span class="hljs-string">&quot;interface&quot;</span>: <span class="hljs-string">&quot;eth0&quot;</span>,<br>     <span class="hljs-string">&quot;macaddress&quot;</span>: <span class="hljs-string">&quot;00:0c:29:e8:c7:9b&quot;</span>,<br>     <span class="hljs-string">&quot;mtu&quot;</span>: 1500,<br>     <span class="hljs-string">&quot;netmask&quot;</span>: <span class="hljs-string">&quot;255.255.255.0&quot;</span>,<br>     <span class="hljs-string">&quot;network&quot;</span>: <span class="hljs-string">&quot;10.0.0.0&quot;</span>,<br>     <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;ether&quot;</span><br>    &#125;<br>  &#125;,<br> <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="四、Playbook"><a href="#四、Playbook" class="headerlink" title="四、Playbook"></a>四、Playbook</h1><h2 id="4-1-playbook介绍"><a href="#4-1-playbook介绍" class="headerlink" title="4.1 playbook介绍"></a>4.1 playbook介绍</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible13.jpg" srcset="/blog/img/loading.gif"></p>
<ul>
<li>playbook 剧本是由一个或多个”play”组成的列表</li>
<li>play的主要功能在于将预定义的一组主机，装扮成事先通过ansible中的task定义好的角色。Task实际是调用ansible的一个module，将多个play组织在一个playbook中，即可以让它们联合起来，按事先编排的机制执行预定义的动作</li>
<li>Playbook 文件是采用YAML语言编写的</li>
</ul>
<h2 id="4-2-YAML-语言"><a href="#4-2-YAML-语言" class="headerlink" title="4.2 YAML 语言"></a>4.2 YAML 语言</h2><h3 id="4-2-1-YAMl-语言介绍"><a href="#4-2-1-YAMl-语言介绍" class="headerlink" title="4.2.1 YAMl 语言介绍"></a>4.2.1 YAMl 语言介绍</h3><p>YAML：YAML Ain’t Markup Language，即YAML不是XML。不过，在开发的这种语言时，YAML的意思其实是：”Yet Another Markup Language”（仍是一种标记语言）</p>
<p>YAML是一个可读性高的用来表达资料序列的格式。</p>
<p>YAML参考了其他多种语言，包括：XML、C语言、Python、Perl以及电子邮件格式RFC2822等。Clark Evans在2001年在首次发表了这种语言，另外Ingydöt Net与Oren Ben-Kiki也是这语言的共同设计者,目前很多最新的软件比较流行采用此格式的文件存放配置信息，如:ubuntu，anisble，docker，kubernetes等</p>
<p>YAML 官方网站：<a target="_blank" rel="noopener" href="http://www.yaml.org/">http://www.yaml.org</a></p>
<h3 id="4-2-2-YAML-语言特性"><a href="#4-2-2-YAML-语言特性" class="headerlink" title="4.2.2 YAML 语言特性"></a>4.2.2 YAML 语言特性</h3><ul>
<li>YAML的可读性好</li>
<li>YAML和脚本语言的交互性好</li>
<li>YAML使用实现语言的数据类型</li>
<li>YAML有一个一致的信息模型</li>
<li>YAML易于实现</li>
<li>YAML可以基于流来处理</li>
<li>YAML表达能力强，扩展性好</li>
</ul>
<h3 id="4-2-3-YAML语法简介"><a href="#4-2-3-YAML语法简介" class="headerlink" title="4.2.3 YAML语法简介"></a>4.2.3 YAML语法简介</h3><ul>
<li>在单一文件第一行，用连续三个连字号”-“ 开始，还有选择性的连续三个点号( … )用来表示文件的结尾</li>
<li>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</li>
<li>使用#号注释代码</li>
<li>缩进必须是统一的，不能空格和tab混用</li>
<li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</li>
<li>YAML文件内容是区别大小写的，key/value的值均需大小写敏感</li>
<li>多个key/value可同行写也可换行写，同行使用，分隔</li>
<li>key后面冒号要加一个空格 比如: key: value</li>
<li>value可是个字符串，也可是另一个列表</li>
<li>YAML文件扩展名通常为yml或yaml</li>
</ul>
<h3 id="4-2-4-支持的数据类型"><a href="#4-2-4-支持的数据类型" class="headerlink" title="4.2.4 支持的数据类型"></a>4.2.4 支持的数据类型</h3><p>YAML 支持以下常用几种数据类型：</p>
<ul>
<li><p>标量：单个的、不可再分的值</p>
</li>
<li><p>对象：键值对的集合，又称为映射（mapping）/ 哈希（hashes） / 字典（dictionary）</p>
</li>
<li><p>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</p>
</li>
</ul>
<h4 id="4-2-4-1-scalar-标量"><a href="#4-2-4-1-scalar-标量" class="headerlink" title="4.2.4.1 scalar 标量"></a>4.2.4.1 scalar 标量</h4><p>key对应value</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">wang</span><br></code></pre></td></tr></table></figure>

<p>使用缩进的方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span><br>  <span class="hljs-string">wang</span><br></code></pre></td></tr></table></figure>

<p>标量是最基本的，不可再分的值，包括：</p>
<ul>
<li>字符串</li>
<li> 布尔值</li>
<li> 整数</li>
<li> 浮点数</li>
<li> Null</li>
<li> 时间</li>
<li> 日期</li>
</ul>
<h4 id="4-2-4-2-Dictionary-字典"><a href="#4-2-4-2-Dictionary-字典" class="headerlink" title="4.2.4.2 Dictionary 字典"></a>4.2.4.2 Dictionary 字典</h4><p>字典由多个key与value构成，key和value之间用 ：分隔, 并且 : 后面有一个空格，所有k/v可以放在一行，或者每个 k/v 分别放在不同行</p>
<p>格式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">account:</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">wang</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">30</span> &#125;<br></code></pre></td></tr></table></figure>

<p>使用缩进方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">account:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">wang</span><br>  <span class="hljs-attr">age:</span> <span class="hljs-number">30</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#不同行</span><br><span class="hljs-comment"># An employee record</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">Example</span> <span class="hljs-string">Developer</span><br><span class="hljs-attr">job:</span> <span class="hljs-string">Developer</span><br><span class="hljs-attr">skill:</span> <span class="hljs-string">Elite(社会精英)</span><br><br><span class="hljs-comment">#同一行,也可以将key:value放置于&#123;&#125;中进行表示，用,分隔多个key:value</span><br><span class="hljs-comment"># An employee record</span><br>&#123;<span class="hljs-attr">name:</span> <span class="hljs-string">&quot;Example Developer&quot;</span>, <span class="hljs-attr">job:</span> <span class="hljs-string">&quot;Developer&quot;</span>, <span class="hljs-attr">skill:</span> <span class="hljs-string">&quot;Elite&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-2-4-2-List-列表"><a href="#4-2-4-2-List-列表" class="headerlink" title="4.2.4.2 List 列表"></a>4.2.4.2 List 列表</h3><p>列表由多个元素组成，每个元素放在不同行，且元素前均使用”-“打头，并且 - 后有一个空格, 或者将所有元素用 [ ] 括起来放在同一行</p>
<p>格式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">course:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">linux</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">golang</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">python</span><br></code></pre></td></tr></table></figure>

<p>也可以使用[ ]</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">course:</span> [ <span class="hljs-string">linux</span> , <span class="hljs-string">golang</span> , <span class="hljs-string">python</span> ]<br></code></pre></td></tr></table></figure>

<p>数据里面也可以包含对象</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">course:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">linux:</span> <span class="hljs-string">manjaro</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">golang:</span> <span class="hljs-string">gin</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">python:</span> <span class="hljs-string">django</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#不同行,行以-开头,后面有一个空格</span><br><span class="hljs-comment"># A list of tasty fruits</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Apple</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Orange</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Strawberry</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Mango</span><br><br><span class="hljs-comment">#同一行</span><br>[<span class="hljs-string">Apple</span>,<span class="hljs-string">Orange</span>,<span class="hljs-string">Strawberry</span>,<span class="hljs-string">Mango</span>]<br></code></pre></td></tr></table></figure>

<p>范例：YAML 表示一个家庭</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">John</span> <span class="hljs-string">Smith</span><br><span class="hljs-attr">age:</span> <span class="hljs-number">41</span><br><span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span><br><span class="hljs-attr">spouse:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">Jane</span> <span class="hljs-string">Smith</span><br>  <span class="hljs-attr">age:</span> <span class="hljs-number">37</span><br>  <span class="hljs-attr">gender:</span> <span class="hljs-string">Female</span><br>  <span class="hljs-attr">children:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Jimmy</span> <span class="hljs-string">Smith</span><br>      <span class="hljs-attr">age:</span> <span class="hljs-number">17</span><br>      <span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span><br>    <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">Jenny</span> <span class="hljs-string">Smith</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">13</span>, <span class="hljs-attr">gender:</span> <span class="hljs-string">Female</span>&#125;<br>    <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">hao</span> <span class="hljs-string">Smith</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">20</span>, <span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span> &#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-2-5-三种常见的数据格式"><a href="#4-2-5-三种常见的数据格式" class="headerlink" title="4.2.5 三种常见的数据格式"></a>4.2.5 三种常见的数据格式</h3><ul>
<li>XML：Extensible Markup Language，可扩展标记语言，可用于数据交换和配置</li>
<li>JSON：JavaScript Object Notation, JavaScript 对象表记法，主要用来数据交换或配置，不支持注释</li>
<li>YAML：YAML Ain’t Markup Language YAML 不是一种标记语言， 主要用来配置，大小写敏感，不支持tab</li>
</ul>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible14.jpg" srcset="/blog/img/loading.gif"></p>
<p><strong>可以用工具互相转换，参考网站：</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.json2yaml.com/">https://www.json2yaml.com/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.bejson.com/json/json2yaml/">http://www.bejson.com/json/json2yaml/</a></p>
<h2 id="4-3-Playbook-核心组件"><a href="#4-3-Playbook-核心组件" class="headerlink" title="4.3 Playbook 核心组件"></a>4.3 Playbook 核心组件</h2><p>一个playbook 中由列表组成,其中所用到的常见组件类型如下:</p>
<ul>
<li>Hosts 执行的远程主机列表</li>
<li>Tasks 任务集,由多个task的元素组成的列表实现,每个task是一个字典,一个完整的代码块功能需最少元素需包括 name 和 task,一个name只能包括一个task</li>
<li>Variables 内置变量或自定义变量在playbook中调用</li>
<li>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li>
<li>Handlers 和 notify 结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li>
<li>tags 标签，指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断</li>
</ul>
<h3 id="4-3-1-hosts-组件"><a href="#4-3-1-hosts-组件" class="headerlink" title="4.3.1 hosts 组件"></a>4.3.1 hosts 组件</h3><p>Hosts：playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">one.example.com<br>one.example.com:two.example.com<br>192.168.1.50<br>192.168.1.*<br>Websrvs:dbsrvs   <span class="hljs-comment">#或者，两个组的并集</span><br>Websrvs:&amp;dbsrvs  <span class="hljs-comment">#与，两个组的交集</span><br>webservers:!dbsrvs  <span class="hljs-comment">#在websrvs组，但不在dbsrvs组</span><br></code></pre></td></tr></table></figure>

<p>案例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs:appsrvs</span><br></code></pre></td></tr></table></figure>

<h3 id="4-3-2-remote-user-组件"><a href="#4-3-2-remote-user-组件" class="headerlink" title="4.3.2 remote_user 组件"></a>4.3.2 remote_user 组件</h3><p>remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span> <span class="hljs-string">connection</span><br>      <span class="hljs-attr">ping:</span><br>      <span class="hljs-attr">remote_user:</span> <span class="hljs-string">magedu</span><br>      <span class="hljs-attr">sudo:</span> <span class="hljs-literal">yes</span> <span class="hljs-comment">#默认sudo为root</span><br>      <span class="hljs-string">sudo_user:wang</span>   <span class="hljs-comment">#sudo为wang</span><br></code></pre></td></tr></table></figure>

<h3 id="4-3-3-task列表和action组件"><a href="#4-3-3-task列表和action组件" class="headerlink" title="4.3.3 task列表和action组件"></a>4.3.3 task列表和action组件</h3><p>play的主体部分是task list，task list中有一个或多个task,各个task 按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个task后，再开始第二个task</p>
<p>task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致</p>
<p>每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤。</p>
<p>如果未提供name，则action的结果将用于输出</p>
<p><strong>task两种格式：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">action:</span> <span class="hljs-string">module</span> <span class="hljs-string">arguments</span><br><span class="hljs-attr">module:</span> <span class="hljs-string">arguments</span>  <span class="hljs-comment">#建议使用</span><br></code></pre></td></tr></table></figure>

<p>注意：shell和command模块后面跟命令，而非key=value</p>
<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#  vim install_httpd.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>      <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook -C install_httpd.yml </span><br><br><span class="hljs-string">PLAY</span> [<span class="hljs-string">websrvs</span>] <span class="hljs-string">*************************************************************************************************************</span><br><br><span class="hljs-string">TASK</span> [<span class="hljs-string">install</span> <span class="hljs-string">httpd</span>] <span class="hljs-string">*******************************************************************************************************</span><br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span>]<br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span>]<br><br><span class="hljs-string">TASK</span> [<span class="hljs-string">start</span> <span class="hljs-string">httpd</span>] <span class="hljs-string">*********************************************************************************************************</span><br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span>]<br><span class="hljs-attr">changed:</span> [<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span>]<br><br><span class="hljs-string">PLAY</span> <span class="hljs-string">RECAP</span> <span class="hljs-string">*****************************************************************************************************************</span><br><span class="hljs-attr">10.0.0.7                   :</span> <span class="hljs-string">ok=2</span>    <span class="hljs-string">changed=2</span>    <span class="hljs-string">unreachable=0</span>    <span class="hljs-string">failed=0</span>    <span class="hljs-string">skipped=0</span>    <span class="hljs-string">rescued=0</span>    <span class="hljs-string">ignored=0</span>   <br><span class="hljs-attr">10.0.0.8                   :</span> <span class="hljs-string">ok=2</span>    <span class="hljs-string">changed=2</span>    <span class="hljs-string">unreachable=0</span>    <span class="hljs-string">failed=0</span>    <span class="hljs-string">skipped=0</span>    <span class="hljs-string">rescued=0</span>    <span class="hljs-string">ignored=0</span>   <br></code></pre></td></tr></table></figure>

<h3 id="4-3-4-其它组件"><a href="#4-3-4-其它组件" class="headerlink" title="4.3.4 其它组件"></a>4.3.4 其它组件</h3><p>某任务的状态在运行后为changed时，可通过”notify”通知给相应的handlers任务可以通过”tags”打标签，可在ansible-playbook命令上使用-t指定进行调用</p>
<h3 id="4-3-5-ShellScripts-VS-Playbook-案例"><a href="#4-3-5-ShellScripts-VS-Playbook-案例" class="headerlink" title="4.3.5 ShellScripts VS Playbook 案例"></a>4.3.5 ShellScripts VS Playbook 案例</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#SHELL脚本实现</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># 安装Apache</span><br><span class="hljs-string">yum</span> <span class="hljs-string">install</span> <span class="hljs-string">--quiet</span> <span class="hljs-string">-y</span> <span class="hljs-string">httpd</span><br><span class="hljs-comment"># 复制配置文件</span><br><span class="hljs-string">cp</span> <span class="hljs-string">/tmp/httpd.conf</span> <span class="hljs-string">/etc/httpd/conf/httpd.conf</span><br><span class="hljs-string">cp</span> <span class="hljs-string">/tmp/vhosts.conf</span> <span class="hljs-string">/etc/httpd/conf.d/</span><br><span class="hljs-comment"># 启动Apache，并设置开机启动</span><br><span class="hljs-string">systemctl</span> <span class="hljs-string">enable</span> <span class="hljs-string">--now</span> <span class="hljs-string">httpd</span><br><br><span class="hljs-comment">#Playbook实现</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;安装Apache&quot;</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;复制配置文件&quot;</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/tmp/httpd.conf</span> <span class="hljs-string">dest=/etc/httpd/conf/</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;复制配置文件&quot;</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/tmp/vhosts.conf</span> <span class="hljs-string">dest=/etc/httpd/conf.d/</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;启动Apache，并设置开机启动&quot;</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br></code></pre></td></tr></table></figure>

<h2 id="4-4-playbook-命令"><a href="#4-4-playbook-命令" class="headerlink" title="4.4 playbook 命令"></a>4.4 playbook 命令</h2><p>格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># ansible-playbook &lt;filename.yml&gt; ... [options]</span><br></code></pre></td></tr></table></figure>

<p>常见选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">--syntax-check    <span class="hljs-comment">#语法检查</span><br>-C --check <span class="hljs-comment">#只检测可能会发生的改变，但不真正执行操作</span><br>--list-hosts   <span class="hljs-comment">#列出运行任务的主机</span><br>--list-tags <span class="hljs-comment">#列出tag</span><br>--list-tasks <span class="hljs-comment">#列出task</span><br>--<span class="hljs-built_in">limit</span> 主机列表 <span class="hljs-comment">#只针对主机列表中的特定主机执行</span><br>-v -vv  -vvv <span class="hljs-comment">#显示过程</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ansible]<span class="hljs-comment"># cat hello.yml</span><br>---<br>- hosts: websrvs<br>  tasks:<br>    - name: hello<br>      <span class="hljs-built_in">command</span>: <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello ansible&quot;</span><br>[root@cetnso7 ansible]<span class="hljs-comment"># ansible-playbook hello.yml</span><br>[root@cetnso7 ansible]<span class="hljs-comment"># ansible-playbook -v hello.yml</span><br></code></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@cetnso7 ansible]<span class="hljs-comment"># ansible-playbook file.yml --check #只检测</span><br>[root@cetnso7 ansible]<span class="hljs-comment"># ansible-playbook file.yml </span><br>[root@cetnso7 ansible]<span class="hljs-comment"># ansible-playbook file.yml --limit websrvs</span><br></code></pre></td></tr></table></figure>

<h2 id="4-5-Playbook-初步"><a href="#4-5-Playbook-初步" class="headerlink" title="4.5 Playbook 初步"></a>4.5 Playbook 初步</h2><h3 id="4-5-1-利用-playbook-创建-mysql-用户"><a href="#4-5-1-利用-playbook-创建-mysql-用户" class="headerlink" title="4.5.1 利用 playbook 创建 mysql 用户"></a>4.5.1 利用 playbook 创建 mysql 用户</h3><p>范例：mysql_user.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">group</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">system=yes</span> <span class="hljs-string">gid=306</span>&#125;<br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">shell=/sbin/nologin</span> <span class="hljs-string">system=yes</span> <span class="hljs-string">group=mysql</span> <span class="hljs-string">uid=306</span> <span class="hljs-string">home=/data/mysql</span> <span class="hljs-string">create_home=no</span> <br></code></pre></td></tr></table></figure>

<h3 id="4-5-2-利用-playbook-安装-nginx"><a href="#4-5-2-利用-playbook-安装-nginx" class="headerlink" title="4.5.2 利用 playbook 安装 nginx"></a>4.5.2 利用 playbook 安装 nginx</h3><p>范例：install_nginx.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">group</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">user</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span> <span class="hljs-string">group=nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web</span> <span class="hljs-string">page</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=files/index.html</span> <span class="hljs-string">dest=/usr/share/nginx/html/index.html</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Start</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br></code></pre></td></tr></table></figure>

<h3 id="4-5-3-利用-playbook-安装和卸载-httpd"><a href="#4-5-3-利用-playbook-安装和卸载-httpd" class="headerlink" title="4.5.3 利用 playbook 安装和卸载 httpd"></a>4.5.3 利用 playbook 安装和卸载 httpd</h3><p>范例：install_httpd.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment">#install httpd</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">configure</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=files/httpd.conf</span> <span class="hljs-string">dest=/etc/httpd/conf/</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">modify</span> <span class="hljs-string">config</span><br>      <span class="hljs-attr">lineinfile:</span> <span class="hljs-string">path=/etc/httpd/conf/httpd.conf</span> <span class="hljs-string">regexp=&#x27;^Listen&#x27;</span> <span class="hljs-string">line=&#x27;Listen</span> <span class="hljs-number">8080</span><span class="hljs-string">&#x27;  </span><br><span class="hljs-string">    - name: mkdir website dir</span><br><span class="hljs-string">      file: path=/data/html state=directory</span><br><span class="hljs-string">    - name: web html</span><br><span class="hljs-string">      copy: src=files/index.html  dest=/data/html/</span><br><span class="hljs-string">    - name: start service</span><br><span class="hljs-string">      service: name=httpd state=started enabled=yes </span><br><span class="hljs-string">     </span><br><span class="hljs-string">[root@cetnso7 ansible]# ansible-playbookinstall_httpd.yml --limit 10.0.0.8</span><br></code></pre></td></tr></table></figure>

<p>范例：remove_httpd.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#remove_httpd.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">httpd</span> <span class="hljs-string">package</span><br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=absent</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">apache</span> <span class="hljs-string">user</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">name=apache</span> <span class="hljs-string">state=absent</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>    <span class="hljs-attr">file:</span> <span class="hljs-string">name=/etc/httpd</span> <span class="hljs-string">state=absent</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">web</span> <span class="hljs-string">html</span><br>    <span class="hljs-attr">file:</span> <span class="hljs-string">name=/data/html/</span> <span class="hljs-string">state=absent</span><br></code></pre></td></tr></table></figure>

<h3 id="4-5-4-利用-playbook-安装-mysql"><a href="#4-5-4-利用-playbook-安装-mysql" class="headerlink" title="4.5.4 利用 playbook 安装 mysql"></a>4.5.4 利用 playbook 安装 mysql</h3><p><strong>范例：安装mysql-5.6.46-linux-glibc2.12</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ls -l /data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">403177622</span> <span class="hljs-string">Dec</span>  <span class="hljs-number">4</span> <span class="hljs-number">13</span><span class="hljs-string">:05</span> <span class="hljs-string">/data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#cat /data/ansible/files/my.cnf</span><br>[<span class="hljs-string">mysqld</span>]<br><span class="hljs-string">socket=/tmp/mysql.sock</span><br><span class="hljs-string">user=mysql</span><br><span class="hljs-string">symbolic-links=0</span><br><span class="hljs-string">datadir=/data/mysql</span><br><span class="hljs-string">innodb_file_per_table=1</span><br><span class="hljs-string">log-bin</span><br><span class="hljs-string">pid-file=/data/mysql/mysqld.pid</span><br><br>[<span class="hljs-string">client</span>]<br><span class="hljs-string">port=3306</span><br><span class="hljs-string">socket=/tmp/mysql.sock</span><br><br>[<span class="hljs-string">mysqld_safe</span>]<br><span class="hljs-string">log-error=/var/log/mysqld.log</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#cat /data/ansible/files/secure_mysql.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-string">/usr/local/mysql/bin/mysql_secure_installation</span> <span class="hljs-string">&lt;&lt;EOF</span><br><br><span class="hljs-string">y</span><br><span class="hljs-string">magedu</span><br><span class="hljs-string">magedu</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">EOF</span><br><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#tree /data/ansible/files/</span><br><span class="hljs-string">/data/ansible/files/</span><br><span class="hljs-string">├──</span> <span class="hljs-string">my.cnf</span><br><span class="hljs-string">├──</span> <span class="hljs-string">mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz</span><br><span class="hljs-string">└──</span> <span class="hljs-string">secure_mysql.sh</span><br><br><span class="hljs-number">0</span> <span class="hljs-string">directories,</span> <span class="hljs-number">3</span> <span class="hljs-string">files</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#cat /data/ansible/install_mysql.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># install mysql-5.6.44-linux-glibc2.12-x86_64.tar.gz </span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">packages</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=libaio,perl-Data-Dumper,perl-Getopt-Long</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">mysql</span> <span class="hljs-string">group</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">gid=306</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">mysql</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">uid=306</span> <span class="hljs-string">group=mysql</span> <span class="hljs-string">shell=/sbin/nologin</span> <span class="hljs-string">system=yes</span> <span class="hljs-string">create_home=no</span> <span class="hljs-string">home=/data/mysql</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">tar</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">host</span> <span class="hljs-string">and</span> <span class="hljs-string">file</span> <span class="hljs-string">mode</span><br>      <span class="hljs-attr">unarchive:</span> <span class="hljs-string">src=/data/ansible/files/ql-5.6.44-linux-glibc2.12-x86_64.tar.gz</span> <span class="hljs-string">dest=/usr/local/</span> <span class="hljs-string">owner=root</span> <span class="hljs-string">group=root</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">linkfile</span> <span class="hljs-string">/usr/local/mysql</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">src=/usr/local/mysql-5.6.44-linux-glibc2.12-x86_64</span> <span class="hljs-string">dest=/usr/local/mysql</span> <span class="hljs-string">state=link</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">data</span> <span class="hljs-string">dir</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">chdir=/usr/local/mysql/</span> <span class="hljs-string">./scripts/mysql_install_db</span> <span class="hljs-string">--datadir=/data/mysql</span> <span class="hljs-string">--user=mysql</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">data</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span> <span class="hljs-string">my.cnf</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/data/ansible/files/my.cnf</span>  <span class="hljs-string">dest=/etc/my.cnf</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">service</span> <span class="hljs-string">script</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">/bin/cp</span> <span class="hljs-string">/usr/local/mysql/support-files/mysql.server</span> <span class="hljs-string">/etc/init.d/mysqld</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">enable</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">/etc/init.d/mysqld</span> <span class="hljs-string">start;chkconfig</span> <span class="hljs-string">--add</span> <span class="hljs-string">mysqld;chkconfig</span> <span class="hljs-string">mysqld</span> <span class="hljs-string">on</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">service</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">PATH</span> <span class="hljs-string">variable</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">content=&#x27;PATH=/usr/local/mysql/bin:$PATH&#x27;</span> <span class="hljs-string">dest=/etc/profile.d/mysql.sh</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secure</span> <span class="hljs-string">script</span><br>      <span class="hljs-attr">script:</span> <span class="hljs-string">/data/ansible/files/secure_mysql.sh</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">script</span><br></code></pre></td></tr></table></figure>

<p><strong>范例：install_mariadb.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment">#Installing MariaDB Binary Tarballs</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">group</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">gid=27</span> <span class="hljs-string">system=yes</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">uid=27</span> <span class="hljs-string">system=yes</span> <span class="hljs-string">group=mysql</span> <span class="hljs-string">shell=/sbin/nologin</span> <span class="hljs-string">home=/data/mysql</span> <span class="hljs-string">create_home=no</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mkdir</span> <span class="hljs-string">datadir</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">path=/data/mysql</span> <span class="hljs-string">owner=mysql</span> <span class="hljs-string">group=mysql</span> <span class="hljs-string">state=directory</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">unarchive</span> <span class="hljs-string">package</span><br>      <span class="hljs-attr">unarchive:</span> <span class="hljs-string">src=/data/ansible/files/mariadb-10.2.27-linux-x86_64.tar.gz</span> <span class="hljs-string">dest=/usr/local/</span> <span class="hljs-string">owner=root</span> <span class="hljs-string">group=root</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">link</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">src=/usr/local/mariadb-10.2.27-linux-x86_64</span> <span class="hljs-string">path=/usr/local/mysql</span> <span class="hljs-string">state=link</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">database</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">chdir=/usr/local/mysql</span>  <span class="hljs-string">./scripts/mysql_install_db</span> <span class="hljs-string">--datadir=/data/mysql</span> <span class="hljs-string">--user=mysql</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/data/ansible/files/my.cnf</span>  <span class="hljs-string">dest=/etc/</span> <span class="hljs-string">backup=yes</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">service</span> <span class="hljs-string">script</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">/bin/cp</span> <span class="hljs-string">/usr/local/mysql/support-files/mysql.server</span> <span class="hljs-string">/etc/init.d/mysqld</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=mysqld</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">PATH</span> <span class="hljs-string">variable</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">content=&#x27;PATH=/usr/local/mysql/bin:$PATH&#x27;</span> <span class="hljs-string">dest=/etc/profile.d/mysql.sh</span><br></code></pre></td></tr></table></figure>

<h2 id="4-6-Playbook中使用handlers和notify"><a href="#4-6-Playbook中使用handlers和notify" class="headerlink" title="4.6 Playbook中使用handlers和notify"></a>4.6 Playbook中使用handlers和notify</h2><p>Handlers本质是task list ，类似于MySQL中的触发器触发的行为，其中的task与前述的task并没有本质上的不同，主要用于当关注的资源发生变化时，才会采取一定的操作。而Notify对应的action可用于在每个play的最后被触发，这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作</p>
<p>案例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim install_httpd.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">configure</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=files/httpd.conf</span> <span class="hljs-string">dest=/etc/httpd/conf/</span><br>      <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">httpd</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ensure</span> <span class="hljs-string">apache</span> <span class="hljs-string">is</span> <span class="hljs-string">running</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>   <br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=restarted</span><br><br><span class="hljs-comment">#注意notify和handlers同时存在</span><br></code></pre></td></tr></table></figure>

<p>案例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">group</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">user</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span> <span class="hljs-string">group=nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/root/config.txt</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>      <span class="hljs-attr">notify:</span> [<span class="hljs-string">&quot;Restart Nginx&quot;</span>,<span class="hljs-string">&quot;Check Nginx Process&quot;</span>] <span class="hljs-comment">#或者下面格式</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Nginx</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">Check</span> <span class="hljs-string">Nginx</span> <span class="hljs-string">Process</span><br>        <br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=restarted</span> <span class="hljs-string">enabled=yes</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">Nginx</span> <span class="hljs-string">process</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">killall</span> <span class="hljs-number">-0</span> <span class="hljs-string">nginx</span> <span class="hljs-string">&amp;&gt;</span> <span class="hljs-string">/tmp/nginx.log</span><br></code></pre></td></tr></table></figure>

<h2 id="4-7-Playbook中使用tags组件"><a href="#4-7-Playbook中使用tags组件" class="headerlink" title="4.7 Playbook中使用tags组件"></a>4.7 Playbook中使用tags组件</h2><p>在playbook文件中，可以利用tags组件，为特定 task 指定标签，当在执行playbook时，可以只执行特定tags的task,而非整个playbook文件</p>
<p>案例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment"># tags example</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">configure</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=files/httpd.conf</span> <span class="hljs-string">dest=/etc/httpd/conf/</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">conf</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">httpd</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>      <br><span class="hljs-comment">#可以只执行playbook里的某个标签</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook –t conf,service httpd.yml</span><br></code></pre></td></tr></table></figure>

<h2 id="4-8-Playbook中使用变量"><a href="#4-8-Playbook中使用变量" class="headerlink" title="4.8 Playbook中使用变量"></a>4.8 Playbook中使用变量</h2><p>变量名：仅能由字母、数字和下划线组成，且只能以字母开头</p>
<p><strong>变量定义：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">variable=value<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http_port=80<br></code></pre></td></tr></table></figure>

<p><strong>变量调用方式：</strong>通过 调用变量，且变量名前后建议加空格，有时用”“才生效</p>
<p><strong>变量来源：</strong></p>
<ol>
<li>ansible 的 setup facts 远程主机的所有变量都可直接调用</li>
<li>通过命令行指定变量，优先级最高</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible-playbook -e varname=value test.yml<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>在playbook文件中定义</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">vars:</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">var1:</span> <span class="hljs-string">value1</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">var2:</span> <span class="hljs-string">value2</span><br></code></pre></td></tr></table></figure>

<ol start="4">
<li>在独立的变量YAML文件中定义</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yacas">- hosts: all<br>  vars_files:<br>    - vars.yml<br></code></pre></td></tr></table></figure>

<ol start="5">
<li><p>在 /etc/ansible/hosts 中定义<br>主机（普通）变量：主机组中主机单独定义，优先级高于公共变量<br>组（公共）变量：针对主机组中所有主机定义统一变量</p>
</li>
<li><p>在role中定义</p>
</li>
</ol>
<h3 id="4-8-1-使用-setup-模块中变量"><a href="#4-8-1-使用-setup-模块中变量" class="headerlink" title="4.8.1 使用 setup 模块中变量"></a>4.8.1 使用 setup 模块中变量</h3><p>本模块自动在playbook调用，不要用ansible命令调用</p>
<p>案例：使用setup变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 files]<span class="hljs-comment"># ansible 10.0.0.8 -m setup -a &#x27;filter=&quot;ansible_default_ipv4&quot;&#x27;</span><br>10.0.0.8 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;ansible_default_ipv4&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;10.0.0.8&quot;</span>, <br>            <span class="hljs-string">&quot;alias&quot;</span>: <span class="hljs-string">&quot;eth0&quot;</span>, <br>            <span class="hljs-string">&quot;broadcast&quot;</span>: <span class="hljs-string">&quot;10.0.0.255&quot;</span>, <br>            <span class="hljs-string">&quot;gateway&quot;</span>: <span class="hljs-string">&quot;10.0.0.2&quot;</span>, <br>            <span class="hljs-string">&quot;interface&quot;</span>: <span class="hljs-string">&quot;eth0&quot;</span>, <br>            <span class="hljs-string">&quot;macaddress&quot;</span>: <span class="hljs-string">&quot;00:0c:29:cc:02:c4&quot;</span>, <br>            <span class="hljs-string">&quot;mtu&quot;</span>: 1500, <br>            <span class="hljs-string">&quot;netmask&quot;</span>: <span class="hljs-string">&quot;255.255.255.0&quot;</span>, <br>            <span class="hljs-string">&quot;network&quot;</span>: <span class="hljs-string">&quot;10.0.0.0&quot;</span>, <br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;ether&quot;</span><br>        &#125;, <br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;, <br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br><br>[root@centos7 ~]<span class="hljs-comment"># ansible 10.0.0.9 -m setup -a &quot;filter=ansible_nodename&quot;</span><br>10.0.0.9 | SUCCESS =&gt; &#123;<br>  <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;ansible_nodename&quot;</span>: <span class="hljs-string">&quot;centos8.magedu.org&quot;</span>,<br>    <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span>&#125;,<br>  <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment">#var1.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">yes</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">log</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">name=/data/&#123;&#123;</span> <span class="hljs-string">ansible_nodename</span> <span class="hljs-string">&#125;&#125;.log</span> <span class="hljs-string">state=touch</span> <span class="hljs-string">owner=wang</span> <span class="hljs-string">mode=600</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook var.yml</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim test.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span> <span class="hljs-string">var</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">path=/data/&#123;&#123;</span> <span class="hljs-string">ansible_facts[&quot;eth0&quot;][&quot;ipv4&quot;][&quot;address&quot;]</span> <span class="hljs-string">&#125;&#125;.log</span> <span class="hljs-string">state=touch</span><br>      <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook test.yml</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ll /data/10.0.0.8.log</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">0</span> <span class="hljs-string">Oct</span> <span class="hljs-number">16</span> <span class="hljs-number">18</span><span class="hljs-string">:22</span> <span class="hljs-string">/data/10.0.0.8.log</span><br></code></pre></td></tr></table></figure>

<h3 id="4-8-2-在playbook命令行中定义变量"><a href="#4-8-2-在playbook命令行中定义变量" class="headerlink" title="4.8.2 在playbook命令行中定义变量"></a>4.8.2 在playbook命令行中定义变量</h3><p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">vim</span> <span class="hljs-string">var2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">package</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">pkname</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br><br><span class="hljs-comment">#在命令中使用变量</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook –e &#x27;pkname=vsftpd&#x27; var2.yml</span><br><span class="hljs-comment">#使用在文件中定义的变量</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># cat vars</span><br><span class="hljs-comment">#需要yaml格式</span><br><span class="hljs-attr">pkname:</span> <span class="hljs-string">memcached</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook -e &#x27;@vars&#x27; var2.yml</span><br></code></pre></td></tr></table></figure>

<h3 id="4-8-3-在playbook文件中定义变量"><a href="#4-8-3-在playbook文件中定义变量" class="headerlink" title="4.8.3 在playbook文件中定义变量"></a>4.8.3 在playbook文件中定义变量</h3><p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim var3.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">user1</span><br>    <span class="hljs-attr">groupname:</span> <span class="hljs-string">group1</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">group</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">groupname</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">username</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">groupname</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>  <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook -e &quot;username=user2 groupname=group2&quot; var3.yml</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#cat var4.yaml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">collect_info:</span> <span class="hljs-string">&quot;/data/test/<span class="hljs-template-variable">&#123;&#123;ansible_default_ipv4[&#x27;address&#x27;]&#125;&#125;</span>/&quot;</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">IP</span> <span class="hljs-string">directory</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">name=&quot;&#123;&#123;collect_info&#125;&#125;&quot;</span> <span class="hljs-string">state=directory</span><br><br><span class="hljs-comment">#执行结果</span><br><span class="hljs-string">tree</span> <span class="hljs-string">/data/test/</span><br><span class="hljs-string">/data/test/</span><br><span class="hljs-string">└──</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.102</span><br><span class="hljs-number">1</span> <span class="hljs-string">directory,</span> <span class="hljs-number">0</span> <span class="hljs-string">files</span><br></code></pre></td></tr></table></figure>

<h3 id="4-8-4-使用变量文件"><a href="#4-8-4-使用变量文件" class="headerlink" title="4.8.4 使用变量文件"></a>4.8.4 使用变量文件</h3><p>可以在一个独立的playbook文件中定义变量，在另一个playbook文件中引用变量文件中的变量，比playbook中定义的变量优化级高</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim vars.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># variables file</span><br><span class="hljs-attr">package_name:</span> <span class="hljs-string">mariadb-server</span><br><span class="hljs-attr">service_name:</span> <span class="hljs-string">mariadb</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim var5.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment">#install package and start service</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars_files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">vars.yml</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">package</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">package_name</span> <span class="hljs-string">&#125;&#125;</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">install</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">service_name</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br></code></pre></td></tr></table></figure>

<p>范例：playbook使用设置好变量的yml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># cat vars2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">var1:</span> <span class="hljs-string">httpd</span><br><span class="hljs-attr">var2:</span> <span class="hljs-string">nginx</span><br>   <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># cat var6.yml</span><br><span class="hljs-meta">---    </span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">web</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars_files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">vars2.yml</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">httpd</span> <span class="hljs-string">log</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">name=/app/&#123;&#123;</span> <span class="hljs-string">var1</span> <span class="hljs-string">&#125;&#125;.log</span> <span class="hljs-string">state=touch</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">nginx</span> <span class="hljs-string">log</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">name=/app/&#123;&#123;</span> <span class="hljs-string">var2</span> <span class="hljs-string">&#125;&#125;.log</span> <span class="hljs-string">state=touch</span><br></code></pre></td></tr></table></figure>

<h3 id="4-8-5-主机清单文件中定义变量"><a href="#4-8-5-主机清单文件中定义变量" class="headerlink" title="4.8.5 主机清单文件中定义变量"></a>4.8.5 主机清单文件中定义变量</h3><h4 id="4-8-5-1-主机变量"><a href="#4-8-5-1-主机变量" class="headerlink" title="4.8.5.1 主机变量"></a>4.8.5.1 主机变量</h4><p>在inventory 主机清单文件中为指定的主机定义变量以便于在playbook中使用</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[websrvs]<br>www1.magedu.com http_port=80 maxRequestsPerChild=808<br>www2.magedu.com http_port=8080 maxRequestsPerChild=909<br></code></pre></td></tr></table></figure>

<h4 id="4-8-5-2-组（公共）变量"><a href="#4-8-5-2-组（公共）变量" class="headerlink" title="4.8.5.2 组（公共）变量"></a>4.8.5.2 组（公共）变量</h4><p>在inventory主机清单文件中赋予给指定组内所有主机上的在playbook中可用的变量，如果和主机变量是同名，优先级低于主机变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[websrvs]<br>www1.magedu.com http_port=8080<br>www2.magedu.com<br><br>[websrvs:vars]<br>http_port=80<br>ntp_server=ntp.magedu.com<br>nfs_server=nfs.magedu.com<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/ansible/hosts</span><br>[websrvs]<br>10.0.0.8 hname=www1 domain=magedu.io<br>10.0.0.7 hname=www2<br><br>[websvrs:vars]<br>mark=<span class="hljs-string">&quot;-&quot;</span><br>domain=magedu.org<br><br>[root@centos7 ~]<span class="hljs-comment">#ansible websvrs –m hostname –a &#x27;name=&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; domain &#125;&#125;&#x27;</span><br><span class="hljs-comment">#命令行指定变量：</span><br>[root@centos7 ~]<span class="hljs-comment">#ansible websvrs –e domain=magedu.cn –m hostname –a  &#x27;name=&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; domain &#125;&#125;&#x27;</span><br></code></pre></td></tr></table></figure>

<p>范例: k8s 的ansible 变量文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[etcd]<br>10.0.0.104 NODE_NAME=etcd1<br>10.0.0.105 NODE_NAME=etcd2<br>10.0.0.106 NODE_NAME=etcd3<br><br>[kube-master]<br>10.0.0.103 NEW_MASTER=yes<br>10.0.0.101<br>10.0.0.102<br><br>[kube-node]<br>10.0.0.109 NEW_NODE=yes<br>10.0.0.107<br>10.0.0.108<br><br>[harbor]<br><br>[ex-lb]<br>10.0.0.111 LB_ROLE=master EX_APISERVER_VIP=10.0.0.100 EX_APISERVER_PORT=8443<br>10.0.0.112 LB_ROLE=backup EX_APISERVER_VIP=10.0.0.100 EX_APISERVER_PORT=8443<br><br>[chrony]<br><br>[all:vars]<br>CONTAINER_RUNTIME=<span class="hljs-string">&quot;docker&quot;</span><br>CLUSTER_NETWORK=<span class="hljs-string">&quot;calico&quot;</span><br>PROXY_MODE=<span class="hljs-string">&quot;ipvs&quot;</span><br>SERVICE_CIDR=<span class="hljs-string">&quot;192.168.0.0/16&quot;</span><br>CLUSTER_CIDR=<span class="hljs-string">&quot;172.16.0.0/16&quot;</span><br>NODE_PORT_RANGE=<span class="hljs-string">&quot;20000-60000&quot;</span><br>CLUSTER_DNS_DOMAIN=<span class="hljs-string">&quot;magedu.local.&quot;</span><br>bin_dir=<span class="hljs-string">&quot;/usr/bin&quot;</span><br>ca_dir=<span class="hljs-string">&quot;/etc/kubernetes/ssl&quot;</span><br>base_dir=<span class="hljs-string">&quot;/etc/ansible&quot;</span><br></code></pre></td></tr></table></figure>

<h2 id="4-9-template-模板"><a href="#4-9-template-模板" class="headerlink" title="4.9 template 模板"></a>4.9 template 模板</h2><p>模板是一个文本文件，可以做为生成文件的模版，并且模板文件中还可嵌套jinja语法</p>
<h3 id="4-9-1-jinja2语言"><a href="#4-9-1-jinja2语言" class="headerlink" title="4.9.1 jinja2语言"></a>4.9.1 jinja2语言</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible15.jpg" srcset="/blog/img/loading.gif"></p>
<p>官方网站：</p>
<p><a target="_blank" rel="noopener" href="http://jinja.pocoo.org/">http://jinja.pocoo.org/</a></p>
<p><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/2.11.x/">https://jinja.palletsprojects.com/en/2.11.x/</a></p>
<p>jinja2 语言支持多种数据类型和操作:</p>
<p>字面量，如: 字符串：使用单引号或双引号,数字：整数，浮点数</p>
<p>列表：[item1, item2, …]</p>
<p>元组：(item1, item2, …)</p>
<p>字典：{key1:value1, key2:value2, …}</p>
<p>布尔型：true/false</p>
<p>算术运算：+, -, *, /, //, %, **</p>
<p>比较操作：==, !=, &gt;, &gt;=, &lt;, &lt;=</p>
<p>逻辑运算：and，or，not</p>
<p>流表达式：For，If，When</p>
<p><strong>字面量：</strong></p>
<p>表达式最简单的形式就是字面量。字面量表示诸如字符串和数值的 Python 对象。如”Hello World”双引号或单引号中间的一切都是字符串。无论何时你需要在模板中使用一个字符串（比如函数调用、过滤器或只是包含或继承一个模板的参数），如42，42.23数值可以为整数和浮点数。如果有小数点，则为浮点数，否则为整数。在 Python 里， 42 和 42.0 是不一样的</p>
<p><strong>算术运算：</strong><br>Jinja 允许用计算值。支持下面的运算符</p>
<p>+：把两个对象加到一起。通常对象是素质，但是如果两者是字符串或列表，你可以用这 种方式来衔接它们。无论如何这不是首选的连接字符串的方式！连接字符串见 ~ 运算符。 2 等于 2</p>
<p>-：用第一个数减去第二个数。 1 等于 1</p>
<p>/：对两个数做除法。返回值会是一个浮点数。 0.5 等于 0.5</p>
<p>//：对两个数做除法，返回整数商。 2 等于 2</p>
<p>%：计算整数除法的余数。 4 等于 4</p>
<p>*：用右边的数乘左边的操作数。 4 会返回 4 。也可以用于重 复一个字符串多次。 NaN会打印 80 个等号的横条\</p>
<p>**：取左操作数的右操作数次幂。 8 会返回 8</p>
<p><strong>比较操作符</strong></p>
<p>== 比较两个对象是否相等</p>
<p>!= 比较两个对象是否不等</p>
<p>&gt; 如果左边大于右边，返回 true</p>
<p>\ &gt; = 如果左边大于等于右边，返回 true</p>
<p>\ &lt; 如果左边小于右边，返回 true</p>
<p>\ &lt;= 如果左边小于等于右边，返回 true</p>
<p><strong>逻辑运算符</strong></p>
<p>对于 if 语句，在 for 过滤或 if 表达式中，它可以用于联合多个表达式</p>
<p>and 如果左操作数和右操作数同为真，返回 true</p>
<p>or 如果左操作数和右操作数有一个为真，返回 true</p>
<p>not 对一个表达式取反</p>
<p>(expr)表达式组</p>
<p>true / false true 永远是 true ，而 false 始终是 false</p>
<h3 id="4-9-2-template"><a href="#4-9-2-template" class="headerlink" title="4.9.2 template"></a>4.9.2 template</h3><p>template功能：可以根据和参考模块文件，动态生成相类似的配置文件</p>
<p>template文件必须存放于templates目录下，且命名为 .j2 结尾</p>
<p>yaml/yml 文件需和templates目录平级，目录结构如下示例：<br>./<br>├── temnginx.yml<br>└── templates<br>            └── nginx.conf.j2<br>范例：利用template 同步nginx配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#准备templates/nginx.conf.j2文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim temnginx.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">hosts</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook temnginx.yml</span><br></code></pre></td></tr></table></figure>

<p><strong>template变更替换</strong><br>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#修改文件nginx.conf.j2</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#mkdir templates</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim templates/nginx.conf.j2</span><br><span class="hljs-string">......</span><br><span class="hljs-comment">#setup的模块：ansible_processor_vcpus</span><br><span class="hljs-string">worker_processes</span> &#123;&#123; <span class="hljs-string">ansible_processor_vcpus</span> &#125;&#125;<span class="hljs-string">;</span><br><span class="hljs-string">......</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim temnginx2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">hosts</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>  <br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook temnginx2.yml</span><br></code></pre></td></tr></table></figure>

<p><strong>template算术运算</strong><br>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim nginx.conf.j2<br>worker_processes &#123;&#123; ansible_processor_vcpus**2 &#125;&#125;;  <br>worker_processes &#123;&#123; ansible_processor_vcpus+2 &#125;&#125;;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment">#vim templates/nginx.conf.j2</span><br><span class="hljs-string">worker_processes</span> &#123;&#123; <span class="hljs-string">ansible_processor_vcpus**3</span> &#125;&#125;<span class="hljs-string">;</span><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment">#cat templnginx.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">hosts</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>      <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br><br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=restarted</span><br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#-playbook templnginx.yml --limit 10.0.0.8</span><br></code></pre></td></tr></table></figure>

<h3 id="4-9-3-template中使用流程控制-for-和-if"><a href="#4-9-3-template中使用流程控制-for-和-if" class="headerlink" title="4.9.3 template中使用流程控制 for 和 if"></a>4.9.3 template中使用流程控制 for 和 if</h3><p>template中也可以使用流程控制 for 循环和 if 条件判断，实现动态生成文件功能</p>
<p>范例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#temlnginx2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">nginx_vhosts:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">81</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">82</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">83</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf2.j2</span> <span class="hljs-string">dest=/data/nginx.conf</span><br><br><span class="hljs-comment">#templates/nginx.conf2.j2</span><br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">for</span> <span class="hljs-string">vhost</span> <span class="hljs-string">in</span> <span class="hljs-string">nginx_vhosts</span> <span class="hljs-string">%</span>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> &#123;&#123; <span class="hljs-string">vhost</span> &#125;&#125;<br>&#125;<br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">endfor</span> <span class="hljs-string">%</span>&#125;<br><br><span class="hljs-string">ansible-playbook</span> <span class="hljs-string">-C</span> <span class="hljs-string">templnginx2.yml</span> <span class="hljs-string">--limit</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span><br><br><span class="hljs-comment">#生成的结果：</span><br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">81</span> <br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">82</span> <br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">83</span> <br>&#125;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#temlnginx3.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">nginx_vhosts:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-attr">listen:</span> <span class="hljs-number">8080</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf3.j2</span> <span class="hljs-string">dest=/data/nginx3.conf</span><br><br><span class="hljs-comment">#templates/nginx.conf3.j2</span><br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">for</span> <span class="hljs-string">vhost</span> <span class="hljs-string">in</span> <span class="hljs-string">nginx_vhosts</span> <span class="hljs-string">%</span>&#125; <br><span class="hljs-string">server</span> &#123;<br><span class="hljs-string">listen</span> &#123;&#123; <span class="hljs-string">vhost.listen</span> &#125;&#125;<br>&#125;<br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">endfor</span> <span class="hljs-string">%</span>&#125;<br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook  templnginx3.yml --limit 10.0.0.8</span><br><br><span class="hljs-comment">#生成的结果</span><br><span class="hljs-string">server</span> &#123;<br><span class="hljs-string">listen</span> <span class="hljs-number">8080</span> <br>&#125;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#templnginx4.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">nginx_vhosts:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">listen:</span> <span class="hljs-number">8080</span><br>        <span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;web1.magedu.com&quot;</span><br>        <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web1/&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">listen:</span> <span class="hljs-number">8081</span><br>        <span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;web2.magedu.com&quot;</span><br>        <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web2/&quot;</span><br>      <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">listen:</span> <span class="hljs-number">8082</span>, <span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;web3.magedu.com&quot;</span>, <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web3/&quot;</span>&#125;<br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf4.j2</span> <span class="hljs-string">dest=/data/nginx4.conf</span><br>  <br><span class="hljs-comment"># templates/nginx.conf4.j2</span><br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">for</span> <span class="hljs-string">vhost</span> <span class="hljs-string">in</span> <span class="hljs-string">nginx_vhosts</span> <span class="hljs-string">%</span>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> &#123;&#123; <span class="hljs-string">vhost.listen</span> &#125;&#125;<br> <span class="hljs-string">server_name</span> &#123;&#123; <span class="hljs-string">vhost.server_name</span> &#125;&#125;<br> <span class="hljs-string">root</span> &#123;&#123; <span class="hljs-string">vhost.root</span> &#125;&#125; <br> &#125;<br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">endfor</span> <span class="hljs-string">%</span>&#125;<br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook templnginx4.yml --limit 10.0.0.8</span><br><br><span class="hljs-comment">#生成结果：</span><br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8080</span><br> <span class="hljs-string">server_name</span> <span class="hljs-string">web1.magedu.com</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web1/</span> <br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8081</span><br> <span class="hljs-string">server_name</span> <span class="hljs-string">web2.magedu.com</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web2/</span> <br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8082</span><br> <span class="hljs-string">server_name</span> <span class="hljs-string">web3.magedu.com</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web3/</span> <br>&#125;<br></code></pre></td></tr></table></figure>

<p>在模版文件中还可以使用 if条件判断，决定是否生成相关的配置信息</p>
<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#templnginx5.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">nginx_vhosts:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">web1:</span><br>        <span class="hljs-attr">listen:</span> <span class="hljs-number">8080</span><br>        <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web1/&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">web2:</span><br>        <span class="hljs-attr">listen:</span> <span class="hljs-number">8080</span><br>        <span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;web2.magedu.com&quot;</span><br>        <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web2/&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">web3:</span><br>        <span class="hljs-attr">listen:</span> <span class="hljs-number">8080</span><br>        <span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;web3.magedu.com&quot;</span><br>        <span class="hljs-attr">root:</span> <span class="hljs-string">&quot;/var/www/nginx/web3/&quot;</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span> <span class="hljs-string">to</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf5.j2</span> <span class="hljs-string">dest=/data/nginx5.conf</span><br>    <br>    <br><span class="hljs-comment">#templates/nginx.conf5.j2</span><br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">for</span> <span class="hljs-string">vhost</span> <span class="hljs-string">in</span> <span class="hljs-string">nginx_vhosts</span> <span class="hljs-string">%</span>&#125;<br><span class="hljs-string">server</span> &#123;<br>   <span class="hljs-string">listen</span> &#123;&#123; <span class="hljs-string">vhost.listen</span> &#125;&#125;<br>   &#123;<span class="hljs-string">%</span> <span class="hljs-string">if</span> <span class="hljs-string">vhost.server_name</span> <span class="hljs-string">is</span> <span class="hljs-string">defined</span> <span class="hljs-string">%</span>&#125;<br><span class="hljs-string">server_name</span> &#123;&#123; <span class="hljs-string">vhost.server_name</span> &#125;&#125;  <span class="hljs-comment">#注意缩进</span><br>   &#123;<span class="hljs-string">%</span> <span class="hljs-string">endif</span> <span class="hljs-string">%</span>&#125;<br><span class="hljs-string">root</span>  &#123;&#123; <span class="hljs-string">vhost.root</span> &#125;&#125;         <span class="hljs-comment">#注意缩进</span><br>&#125;<br>&#123;<span class="hljs-string">%</span> <span class="hljs-string">endfor</span> <span class="hljs-string">%</span>&#125;<br><br><span class="hljs-comment">#生成的结果</span><br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8080</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web1/</span><br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8080</span><br> <span class="hljs-string">server_name</span> <span class="hljs-string">web2.magedu.com</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web2/</span><br>&#125;<br><span class="hljs-string">server</span> &#123;<br> <span class="hljs-string">listen</span> <span class="hljs-number">8080</span><br> <span class="hljs-string">server_name</span> <span class="hljs-string">web3.magedu.com</span><br> <span class="hljs-string">root</span> <span class="hljs-string">/var/www/nginx/web3/</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-10-playbook使用-when"><a href="#4-10-playbook使用-when" class="headerlink" title="4.10 playbook使用 when"></a>4.10 playbook使用 when</h2><p>when语句，可以实现条件测试。如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试,通过在task后添加when子句即可使用条件测试，jinja2的语法格式</p>
<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;shutdown RedHat flavored systems&quot;</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-h</span> <span class="hljs-string">now</span><br>      <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_os_family</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;RedHat&quot;</span><br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;shut down CentOS 6 and Debian 7 systems&quot;</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-t</span> <span class="hljs-string">now</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">(ansible_facts[&#x27;distribution&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;CentOS&quot;</span> <span class="hljs-string">and</span> <span class="hljs-string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span><span class="hljs-string">)</span> <span class="hljs-string">or</span> <span class="hljs-string">(ansible_facts[&#x27;distribution&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;Debian&quot;</span> <span class="hljs-string">and</span> <span class="hljs-string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;7&quot;</span><span class="hljs-string">)</span><br></code></pre></td></tr></table></figure>

<p>范例: 关闭CentOS 7 版本的主机</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;shut down CentOS 6 systems&quot;</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-r</span> <span class="hljs-string">now</span><br>      <span class="hljs-attr">when:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">ansible_facts[&#x27;distribution&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;CentOS&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;7&quot;</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">group</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">user</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span> <span class="hljs-string">group=nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">Nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=restarted</span><br>      <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br> <br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">conf</span> <span class="hljs-string">file</span> <span class="hljs-string">to</span> <span class="hljs-string">centos7</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.c7.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>      <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;7&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">conf</span> <span class="hljs-string">file</span> <span class="hljs-string">to</span> <span class="hljs-string">centos6</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.c6.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>      <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span><br></code></pre></td></tr></table></figure>

<h2 id="4-11-playbook-使用迭代-with-items-loop"><a href="#4-11-playbook-使用迭代-with-items-loop" class="headerlink" title="4.11 playbook 使用迭代 with_items(loop)"></a>4.11 playbook 使用迭代 with_items(loop)</h2><p>迭代：当有需要重复性执行的任务时，可以使用迭代机制对迭代项的引用，固定内置变量名为”item”要在task中使用with_items给定要迭代的元素列表</p>
<p>注意: ansible2.5版本后,可以用loop代替with_items</p>
<p><strong>列表元素格式：</strong></p>
<ul>
<li><p>字符串</p>
</li>
<li><p>字典</p>
</li>
</ul>
<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br><span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">several</span> <span class="hljs-string">users</span><br>  <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span> <span class="hljs-string">groups=wheel</span><br>  <span class="hljs-attr">with_items:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">testuser1</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">testuser2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">testuser3</span><br>    <span class="hljs-comment">#上面语句的功能等同于下面的语句</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">several</span> <span class="hljs-string">users</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">name=testuser1</span> <span class="hljs-string">state=present</span> <span class="hljs-string">groups=wheel</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">several</span> <span class="hljs-string">users</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">name=testuser2</span> <span class="hljs-string">state=present</span> <span class="hljs-string">groups=wheel</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">several</span> <span class="hljs-string">users</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">name=testuser3</span> <span class="hljs-string">state=present</span> <span class="hljs-string">groups=wheel</span><br></code></pre></td></tr></table></figure>

<p>范例：卸载 mariadb</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment">#remove mariadb server</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">appsrvs:!10.0.0.8</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">stop</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">/etc/init.d/mysqld</span> <span class="hljs-string">stop</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">delete</span> <span class="hljs-string">files</span> <span class="hljs-string">and</span> <span class="hljs-string">dir</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">path=&#123;&#123;item&#125;&#125;</span> <span class="hljs-string">state=absent</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/usr/local/mysql</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/usr/local/mariadb-10.2.27-linux-x86_64</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/init.d/mysqld</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/profile.d/mysql.sh</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/my.cnf</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/data/mysql</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">delete</span> <span class="hljs-string">user</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">state=absent</span> <span class="hljs-string">remove=yes</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">hosts：websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-string">tasks</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">some</span> <span class="hljs-string">packages</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">memcached</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">php-fpm</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br> <br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">dest=/tmp/&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">file1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">file2</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">file3</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">yum</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span>  <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">apr</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">apr-util</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">httpd</span><br></code></pre></td></tr></table></figure>

<p><strong>迭代嵌套子变量：</strong>在迭代中，还可以嵌套子变量，关联多个变量在一起使用</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">groups</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">apache</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">users</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item.name</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">item.group</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;nginx&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;nginx&#x27;</span> &#125;<br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;mysql&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;mysql&#x27;</span> &#125;<br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;apache&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;apache&#x27;</span> &#125;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># cat with_item2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">groups</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">g1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">g2</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">g3</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">users</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item.name</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">item.group</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">home=&#123;&#123;</span> <span class="hljs-string">item.home</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">create_home=yes</span> <span class="hljs-string">state=present</span><br>      <span class="hljs-attr">with_items:</span><br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user1&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;g1&#x27;</span>, <span class="hljs-attr">home:</span> <span class="hljs-string">&#x27;/data/user1&#x27;</span> &#125;<br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user2&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;g2&#x27;</span>, <span class="hljs-attr">home:</span> <span class="hljs-string">&#x27;/data/user2&#x27;</span> &#125;<br>        <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user3&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;g3&#x27;</span>, <span class="hljs-attr">home:</span> <span class="hljs-string">&#x27;/data/user3&#x27;</span> &#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-12-管理节点过多导致的超时问题解决方法"><a href="#4-12-管理节点过多导致的超时问题解决方法" class="headerlink" title="4.12 管理节点过多导致的超时问题解决方法"></a>4.12 管理节点过多导致的超时问题解决方法</h2><p>默认情况下，Ansible将尝试并行管理playbook中所有的机器。对于滚动更新用例，可以使用serial关键字定义Ansible一次应管理多少主机，还可以将serial关键字指定为百分比，表示每次并行执行的主机数占总数的比例</p>
<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#vim test_serial.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">serial:</span> <span class="hljs-number">2</span>  <span class="hljs-comment">#每次只同时处理2个主机,将所有task执行完成后,再选下2个主机再执行所有task,直至所有主机</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">False</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task</span> <span class="hljs-string">one</span><br>      <span class="hljs-attr">comand:</span> <span class="hljs-string">hostname</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task</span> <span class="hljs-string">two</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">hostname</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span> <span class="hljs-string">serail</span><br>  <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">serial:</span> <span class="hljs-string">&quot;20%&quot;</span>  <span class="hljs-comment">#每次只同时处理20%的主机</span><br></code></pre></td></tr></table></figure>



<h1 id="五、Roles-角色"><a href="#五、Roles-角色" class="headerlink" title="五、Roles 角色"></a>五、Roles 角色</h1><p>角色是ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中运维复杂的场景：建议使用 roles，代码复用度高</p>
<p>roles：多个角色的集合目录， 可以将多个的role，分别放至roles目录下的独立子目录中,如下示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">roles/</span><br>    <span class="hljs-string">mysql/</span><br>    <span class="hljs-string">nginx/</span><br>    <span class="hljs-string">tomcat/</span><br>    <span class="hljs-string">redis/</span><br></code></pre></td></tr></table></figure>

<p>默认roles存放路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">/root/.ansible/roles<br>/usr/share/ansible/roles<br>/etc/ansible/roles<br></code></pre></td></tr></table></figure>

<h2 id="5-1-Ansible-Roles目录编排"><a href="#5-1-Ansible-Roles目录编排" class="headerlink" title="5.1 Ansible Roles目录编排"></a>5.1 Ansible Roles目录编排</h2><p>roles目录结构如下所示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/ansible/ansible16.jpg" srcset="/blog/img/loading.gif"></p>
<p>每个角色，以特定的层级目录结构进行组织<br><strong>roles目录结构：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">playbook.yml</span><br><span class="hljs-string">roles/</span><br>  <span class="hljs-string">project/</span><br>  <span class="hljs-string">tasks/</span><br>  <span class="hljs-string">files/</span><br>  <span class="hljs-string">vars/</span>   <br>  <span class="hljs-string">templates/</span><br>  <span class="hljs-string">handlers/</span><br>  <span class="hljs-string">default/</span>  <br>  <span class="hljs-string">meta/</span><br></code></pre></td></tr></table></figure>

<p><strong>Roles各目录作用</strong><br>roles/project/ :项目名称,有以下子目录</p>
<ul>
<li>files/ ：存放由copy或script模块等调用的文件</li>
<li>templates/：template模块查找所需要模板文件的目录</li>
<li>tasks/：定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li>
<li>handlers/：至少应该包含一个名为main.yml的文件；此目录下的其它的文件需要在此文件中通过include进行包含</li>
<li>vars/：定义变量，至少应该包含一个名为main.yml的文件；此目录下的其它的变量文件需要在此文件中通过include进行包含</li>
<li>meta/：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含</li>
<li>default/：设定默认变量时使用此目录中的main.yml文件，比vars的优先级低</li>
</ul>
<h2 id="5-2-创建-role"><a href="#5-2-创建-role" class="headerlink" title="5.2 创建 role"></a>5.2 创建 role</h2><p>创建role的步骤</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">1 创建以roles命名的目录<br>2 在roles目录中分别创建以各角色名称命名的目录，如mysql等<br>3 在每个角色命名的目录中分别创建files、handlers、tasks、templates和vars等目录；用不到的目录可以创建为空目录，也可以不创建<br>4 在每个角色相关的子目录中创建相应的文件,如 tasks/main.yml,templates/nginx.conf.j2<br>5 在playbook文件中，调用需要的角色<br></code></pre></td></tr></table></figure>

<p>针对大型项目使用Roles进行编排<br>范例：roles的目录结构</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">nginx-role.yml</span><br><span class="hljs-string">roles/</span><br><span class="hljs-string">└──</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-string">├──</span> <span class="hljs-string">files</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br>  <span class="hljs-string">├──</span> <span class="hljs-string">tasks</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-string">groupadd.yml</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-string">install.yml</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-string">main.yml</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-string">restart.yml</span><br>  <span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-string">useradd.yml</span><br>  <span class="hljs-string">└──</span> <span class="hljs-string">vars</span><br>    <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br></code></pre></td></tr></table></figure>

<h2 id="5-3-playbook-调用角色"><a href="#5-3-playbook-调用角色" class="headerlink" title="5.3 playbook 调用角色"></a>5.3 playbook 调用角色</h2><p><strong>调用角色方法1：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">memcached</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span> <br></code></pre></td></tr></table></figure>

<p><strong>调用角色方法2：</strong><br>role用于指定角色名称，后续的k/v用于传递变量给角色</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">nginx</span>, <span class="hljs-attr">username:</span> <span class="hljs-string">nginx</span> &#125;<br></code></pre></td></tr></table></figure>

<p><strong>调用角色方法3：</strong><br>还可基于条件测试实现角色调用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">nginx</span>, <span class="hljs-attr">username:</span> <span class="hljs-string">nginx</span>, <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;7&#x27;</span> &#125;<br></code></pre></td></tr></table></figure>

<h2 id="5-4-roles-中-tags-使用"><a href="#5-4-roles-中-tags-使用" class="headerlink" title="5.4 roles 中 tags 使用"></a>5.4 roles 中 tags 使用</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vi app-role.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">appsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">nginx</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;nginx&#x27;</span>, <span class="hljs-string">&#x27;web&#x27;</span> ] ,<span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span> &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">httpd</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;httpd&#x27;</span>, <span class="hljs-string">&#x27;web&#x27;</span> ] &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">mysql</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;mysql&#x27;</span>, <span class="hljs-string">&#x27;db&#x27;</span> ] &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">mariadb</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;mariadb&#x27;</span>, <span class="hljs-string">&#x27;db&#x27;</span> ] &#125;<br><br>[<span class="hljs-string">root@centos7</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># ansible-playbook --tags=&quot;nginx,httpd,mysql&quot; app-role.yml</span><br></code></pre></td></tr></table></figure>

<h2 id="5-5-实战案例"><a href="#5-5-实战案例" class="headerlink" title="5.5 实战案例"></a>5.5 实战案例</h2><h3 id="5-5-1-案例1：实现-httpd-角色"><a href="#5-5-1-案例1：实现-httpd-角色" class="headerlink" title="5.5.1 案例1：实现 httpd 角色"></a>5.5.1 案例1：实现 httpd 角色</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建角色相关的目录</span><br>[root@centos7 ~]<span class="hljs-comment">#mkdir -pv /data/ansible/roles/httpd/&#123;tasks,handlers,files&#125;</span><br><br><span class="hljs-comment">#创建角色相关的文件</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /data/ansible/roles/httpd/</span><br><br><span class="hljs-comment">#main.yml 是task的入口文件</span><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/main.yml</span><br>- include: group.yml<br>- include: user.yml<br>- include: install.yml<br>- include: config.yml<br>- include: index.yml<br>- include: service.yml<br><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/group.yml</span><br>- name: create apache group<br>  group: name=apache system=yes gid=80<br><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/user.yml</span><br>- name: create apache user<br>  user: name=apache system=yes shell=/sbin/nologin home=/var/www/ uid=80 group=apache<br><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/install.yml</span><br>- name: install httpd package<br>  yum: name=httpd<br><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/config.yml</span><br>- name: config file<br>  copy: src=httpd.conf dest=/etc/httpd/conf/ backup=yes<br>  notify: restart<br><br>[root@centos7 ~]<span class="hljs-comment"># tasks/index.yml</span><br>- name: index.html<br>  copy: src=index.html dest=/var/www/html/<br><br>[root@centos7 ~]<span class="hljs-comment">#vim tasks/service.yml</span><br>- name: start service<br>  service: name=httpd state=started enabled=yes<br><br>[root@centos7 ~]<span class="hljs-comment">#vim handlers/main.yml</span><br>- name: restart<br>  service: name=httpd state=restarted<br><br><span class="hljs-comment">#在files目录下准备两个文件</span><br>[root@centos7 ~]<span class="hljs-comment">#ls files/</span><br>httpd.conf index.html<br><br>[root@centos7 ~]<span class="hljs-comment">#tree /data/ansible/roles/httpd/</span><br>/data/ansible/roles/httpd/<br>├── files<br>│  ├── httpd.conf<br>│  └── index.html<br>├── handlers<br>│  └── main.yml<br>└── tasks<br> ├── config.yml<br> ├── group.yml<br> ├── index.yml<br> ├── install.yml<br> ├── main.yml<br> ├── service.yml<br> └── user.yml<br>3 directories, 10 files<br><br><span class="hljs-comment">#在playbook中调用角色</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /data/ansible/role_httpd.yml</span><br>---<br><span class="hljs-comment"># httpd role</span><br>- hosts: websrvs<br>  remote_user: root<br>  roles:<br>    - httpd<br> <br><span class="hljs-comment">#运行playbook</span><br>[root@centos7 ~]<span class="hljs-comment">#ansible-playbook /data/ansible/role_httpd.yml</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-2-案例2：实现-nginx-角色"><a href="#5-5-2-案例2：实现-nginx-角色" class="headerlink" title="5.5.2 案例2：实现 nginx 角色"></a>5.5.2 案例2：实现 nginx 角色</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#mkdir -pv</span><br>/data/ansible/roles/nginx/&#123;tasks,handlers,templates,vars&#125;<br><br><span class="hljs-comment">#创建task文件</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /data/ansible/roles/nginx/</span><br><br>[root@ansible nginx]<span class="hljs-comment">#vim tasks/main.yml</span><br>- include: install.yml<br>- include: config.yml<br>- include: index.yml<br>- include: service.yml<br><br>[root@centos7 nginx]<span class="hljs-comment">#vim tasks/install.yml</span><br>- name: install<br>  yum: name=nginx<br><br>[root@centos7 nginx]<span class="hljs-comment">#vim tasks/config.yml</span><br>- name: config file <span class="hljs-keyword">for</span> centos7<br>  template: src=nginx7.conf.j2 dest=/etc/nginx/nginx.conf<br>  when: ansible_distribution_major_version==<span class="hljs-string">&quot;7&quot;</span><br>  notify: restart<br>- name: config file <span class="hljs-keyword">for</span> centos8<br>  template: src=nginx8.conf.j2 dest=/etc/nginx/nginx.conf<br>  when: ansible_distribution_major_version==<span class="hljs-string">&quot;8&quot;</span><br>  notify: restart<br><br><span class="hljs-comment">#跨角色调用文件</span><br>[root@centos7 nginx]<span class="hljs-comment">#vim tasks/index.yml</span><br>- name: index.html<br>  copy: src=roles/httpd/files/index.html dest=/usr/share/nginx/html/<br><br>[root@centos7 nginx]<span class="hljs-comment">#vim tasks/service.yml</span><br>- name: start service<br>  service: name=nginx state=started enabled=yes<br><br><span class="hljs-comment">#创建handler文件</span><br>[root@centos7 nginx]<span class="hljs-comment">#cat handlers/main.yml</span><br>- name: restart<br>  service: name=nginx state=restarted<br><br><span class="hljs-comment">#创建两个template文件</span><br>[root@centos7 nginx]<span class="hljs-comment">#cat templates/nginx7.conf.j2</span><br>...省略...<br>user &#123;&#123;user&#125;&#125;;<br>worker_processes &#123;&#123;ansible_processor_vcpus+3&#125;&#125;;  <span class="hljs-comment">#修改此行</span><br>error_log /var/<span class="hljs-built_in">log</span>/nginx/error.log;<br>pid /run/nginx.pid;<br>...省略...<br><br>[root@centos7 nginx]<span class="hljs-comment">#cat templates/nginx8.conf.j2</span><br>...省略...<br>user nginx;<br>worker_processes &#123;&#123;ansible_processor_vcpus**3&#125;&#125;;  <span class="hljs-comment">#修改此行</span><br>error_log /var/<span class="hljs-built_in">log</span>/nginx/error.log;<br>pid /run/nginx.pid;<br>...省略...<br><br><span class="hljs-comment">#创建变量文件</span><br>[root@centos7 nginx]<span class="hljs-comment">#vim vars/main.yml</span><br>user: daemon<br><br><span class="hljs-comment">#目录结构如下</span><br>[root@centos7 ~]<span class="hljs-comment">#tree /data/ansible/roles/nginx/</span><br>/data/ansible/roles/nginx/<br>├── handlers<br>│  └── main.yml<br>├── tasks<br>│  ├── config.yml<br>│  ├── file.yml<br>│  ├── install.yml<br>│  ├── main.yml<br>│  └── service.yml<br>├── templates<br>│  ├── nginx7.conf.j2<br>│  └── nginx8.conf.j2<br>└── vars<br> └── main.yml<br>4 directories, 9 files<br><br><span class="hljs-comment">#在playbook中调用角色</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /data/ansible/role_nginx.yml</span><br>---<br><span class="hljs-comment">#nginx role</span><br>- hosts: websrvs<br>  roles:<br>    - role: nginx<br> <br><span class="hljs-comment">#运行playbook</span><br>[root@centos7 ~]<span class="hljs-comment">#ansible-playbook /data/ansible/role_nginx.yml</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-3-案例3：实现-memcached-角色"><a href="#5-5-3-案例3：实现-memcached-角色" class="headerlink" title="5.5.3 案例3：实现 memcached 角色"></a>5.5.3 案例3：实现 memcached 角色</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#mkdir -pv /data/ansible/roles/memcached/&#123;tasks,templates&#125;</span><br><br>[root@centos7 ~]<span class="hljs-comment">#cd /data/ansible/roles/memcached</span><br><br>[root@ansible memcached]<span class="hljs-comment">#vim tasks/main.yml</span><br>- include: install.yml<br>- include: config.yml<br>- include: service.yml<br><br>[root@centos7 memcached]<span class="hljs-comment">#vim tasks/install.yml</span><br>- name: install<br>  yum: name=memcached<br><br>[root@centos7 memcached]<span class="hljs-comment">#vim tasks/config.yml</span><br>- name: config file<br>  template: src=memcached.j2  dest=/etc/sysconfig/memcached<br><br>[root@centos7 memcached]<span class="hljs-comment">#vim tasks/service.yml</span><br>- name: service<br>  service: name=memcached state=started enabled=yes<br><br>[root@centos7 memcached]<span class="hljs-comment">#vim templates/memcached.j2</span><br>PORT=<span class="hljs-string">&quot;11211&quot;</span><br>USER=<span class="hljs-string">&quot;memcached&quot;</span><br>MAXCONN=<span class="hljs-string">&quot;1024&quot;</span><br>CACHESIZE=<span class="hljs-string">&quot;&#123;&#123;ansible_memtotal_mb//4&#125;&#125;&quot;</span><br>OPTIONS=<span class="hljs-string">&quot;&quot;</span><br><br>[root@centos7 memcached]<span class="hljs-comment">#tree /data/ansible/roles/memcached/</span><br>/data/ansible/roles/memcached/<br>├── tasks<br>│  ├── config.yml<br>│  ├── install.yml<br>│  ├── main.yml<br>│  └── service.yml<br>└── templates<br> └── memcached.j2<br>2 directories, 5 files<br><br>[root@centos7 ~]<span class="hljs-comment">#vim /data/ansible/role_memcached.yml</span><br>---<br>- hosts: appsrvs<br>  roles:<br>    - role: memcached<br> <br>[root@centos7 ~]<span class="hljs-comment">#ansible-play /data/ansible/role_memcached.yml</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-4-案例4：实现-mysql-5-6-的角色"><a href="#5-5-4-案例4：实现-mysql-5-6-的角色" class="headerlink" title="5.5.4 案例4：实现 mysql 5.6 的角色"></a>5.5.4 案例4：实现 mysql 5.6 的角色</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/files/my.cnf</span><br>[mysqld]<br>socket=/tmp/mysql.sock<br>user=mysql<br>symbolic-links=0<br>datadir=/data/mysql<br>innodb_file_per_table=1<br>log-bin<br>pid-file=/data/mysql/mysqld.pid<br>[client]<br>port=3306<br>socket=/tmp/mysql.sock<br>[mysqld_safe]<br>log-error=/var/<span class="hljs-built_in">log</span>/mysqld.log<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/files/secure_mysql.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>/usr/<span class="hljs-built_in">local</span>/mysql/bin/mysql_secure_installation &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">y</span><br><span class="hljs-string">magedu</span><br><span class="hljs-string">magedu</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">y</span><br><span class="hljs-string">EOF</span><br><br>[root@centos7 ~]<span class="hljs-comment">#chmod +x /data/ansible/roles/mysql/files/secure_mysql.sh</span><br><br>[root@centos7 ~]<span class="hljs-comment">#ls /data/ansible/roles/mysql/files/</span><br>my.cnf mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz secure_mysql.sh<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/main.yml</span><br>- include: install.yml<br>- include: group.yml<br>- include: user.yml<br>- include: unarchive.yml<br>- include: link.yml<br>- include: data.yml<br>- include: config.yml<br>- include: service.yml<br>- include: path.yml<br>- include: secure.yml<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/install.yml</span><br>- name: install packages                      <br>  yum: name=libaio,perl-Data-Dumper,perl-Getopt-Long<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/group.yml</span><br>- name: create mysql group<br>  group: name=mysql gid=306<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/user.yml</span><br>- name: create mysql user<br>  user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/unarchive.yml</span><br>- name: copy tar to remote host and file mode<br>  unarchive: src=mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz dest=/usr/<span class="hljs-built_in">local</span>/ owner=root group=root<br><br>[root@ansible ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/link.yml</span><br>- name: mkdir /usr/<span class="hljs-built_in">local</span>/mysql<br>  file: src=/usr/<span class="hljs-built_in">local</span>/mysql-5.6.46-linux-glibc2.12-x86_64 dest=/usr/<span class="hljs-built_in">local</span>/mysql state=link<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ans</span><br>ible/roles/mysql/tasks/data.yml<br>- name: data dir<br>  shell: <span class="hljs-built_in">chdir</span>=/usr/<span class="hljs-built_in">local</span>/mysql/ ./scripts/mysql_install_db -- datadir=/data/mysql --user=mysql<br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/config.yml</span><br>- name: config my.cnf<br>  copy: src=my.cnf  dest=/etc/my.cnf<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/service.yml</span><br>- name: service script<br>  shell: /bin/cp /usr/<span class="hljs-built_in">local</span>/mysql/support-files/mysql.server<br>/etc/init.d/mysqld;chkconfig --add mysqld;chkconfig mysqld on;/etc/init.d/mysqld start<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/path.yml</span><br>- name: PATH variable<br>  copy: content=<span class="hljs-string">&#x27;PATH=/usr/local/mysql/bin:$PATH&#x27;</span> dest=/etc/profile.d/mysql.sh <br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/roles/mysql/tasks/secure.yml</span><br>- name: secure script<br>  script: secure_mysql.sh<br><br>[root@centos7 ~]<span class="hljs-comment">#tree /data/ansible/roles/mysql/</span><br>/data/ansible/roles/mysql/<br>├── files<br>│  ├── my.cnf<br>│  ├── mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz<br>│  └── secure_mysql.sh<br>└── tasks<br> ├── config.yml<br> ├── data.yml<br> ├── group.yml<br> ├── install.yml<br> ├── link.yml<br> ├── main.yml<br> ├── path.yml<br> ├── secure.yml<br> ├── service.yml<br> ├── unarchive.yml<br> └── user.yml<br>2 directories, 14 files<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /data/ansible/mysql_roles.yml</span><br>- hosts: dbsrvs<br>  remote_user: root<br>  roles:<br>    - &#123;role: mysql,tags: [<span class="hljs-string">&quot;mysql&quot;</span>,<span class="hljs-string">&quot;db&quot;</span>]&#125;<br>    - &#123;role: nginx,tage: [<span class="hljs-string">&quot;nginx&quot;</span>,<span class="hljs-string">&quot;web&quot;</span>]&#125;<br> <br>[root@centos7 ~]<span class="hljs-comment">#ansible-playbook -t mysql /data/ansible/mysql_roles.yml</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-5-案例5-：实现多角色的选择"><a href="#5-5-5-案例5-：实现多角色的选择" class="headerlink" title="5.5.5 案例5 ：实现多角色的选择"></a>5.5.5 案例5 ：实现多角色的选择</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /data/ansible/role_httpd_nginx.yml</span><br>---<br>- hosts: websrvs<br>  roles:<br>    - &#123;role: httpd,tags: [httpd,web], when: ansible_distribution_major_version==<span class="hljs-string">&quot;7&quot;</span> &#125;<br>    - &#123;role: nginx,tags: [nginx,web], when: ansible_distribution_major_version==<span class="hljs-string">&quot;8&quot;</span> &#125;<br><br>[root@centos7 ~]<span class="hljs-comment">#ansible-playbook -t nginx /data/ansible/role_httpd_nginx.yml</span><br></code></pre></td></tr></table></figure>



<h2 id="六、Ansible-推荐学习资料"><a href="#六、Ansible-推荐学习资料" class="headerlink" title="六、Ansible 推荐学习资料"></a>六、Ansible 推荐学习资料</h2><p><a target="_blank" rel="noopener" href="http://galaxy.ansible.com/">http://galaxy.ansible.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://galaxy.ansible.com/explore#/">https://galaxy.ansible.com/explore#/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/">https://github.com/</a></p>
<p><a target="_blank" rel="noopener" href="http://ansible.com.cn/">http://ansible.com.cn/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ansible/ansible">https://github.com/ansible/ansible</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ansible/ansible-examples">https://github.com/ansible/ansible-examples</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/Linux-ANSIBLE/">Linux ANSIBLE</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/03/12/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%A0%A1%E5%9E%92%E6%9C%BAJumpServer/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">企业级堡垒机JumpServer</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/03/02/%E4%BC%81%E4%B8%9A%E7%BA%A7VPN%E6%9C%8D%E5%8A%A1OpenVPN/">
                        <span class="hidden-mobile">企业级VPN服务OpenVPN</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
