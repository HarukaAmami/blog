

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>企业级VPN服务OpenVPN - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="企业级VPN服务OpenVPN">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-03-02 14:42" pubdate>
        2021年3月2日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      23.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      414
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">企业级VPN服务OpenVPN</h1>
            
            <div class="markdown-body">
              <h1 id="企业级VPN服务-OpenVPN"><a href="#企业级VPN服务-OpenVPN" class="headerlink" title="企业级VPN服务 OpenVPN"></a>企业级VPN服务 OpenVPN</h1><h2 id="一、OpenVPN简介"><a href="#一、OpenVPN简介" class="headerlink" title="一、OpenVPN简介"></a>一、OpenVPN简介</h2><h3 id="1-1VPN-介绍"><a href="#1-1VPN-介绍" class="headerlink" title="1.1VPN 介绍"></a>1.1VPN 介绍</h3><p>专用网：专用网就是在两个网络（例如，北京和广州）之间架设一条专用线路，但是它并不需要真正地去铺设光缆之类的物理线路。虽然没有亲自去铺设，但是需要向电信运营商申请租用专线，在这条专用的线路上只传输自己的信息,所以安全稳定,同时也费用高昂</p>
<p>VPN：Virtual Private Network，虚拟私有网络，又称为虚拟专用网络，用于在不安全的线路上安全的传输数据。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-intrduce1.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="1-2-OpenVPN"><a href="#1-2-OpenVPN" class="headerlink" title="1.2 OpenVPN"></a>1.2 OpenVPN</h3><p>OpenVPN：一个实现VPN的开源软件，OpenVPN 是一个健壮的、高度灵活的 VPN 守护进程。它支持SSL/TLS 安全、Ethernet bridging、经由代理的 TCP 或 UDP 隧道和 NAT。另外，它也支持动态 IP 地址以及DHCP，可伸缩性足以支持数百或数千用户的使用场景，同时可移植至大多数主流操作系统平台上。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://openvpn.net/">https://openvpn.net</a><br>GitHub地址：<a target="_blank" rel="noopener" href="https://github.com/OpenVPN/openvpn">https://github.com/OpenVPN/openvpn</a></p>
<p><strong>OpenVPN 示意图</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-intrduce2.jpg" srcset="/blog/img/loading.gif"></p>
<h2 id="二、OpenVPN-部署"><a href="#二、OpenVPN-部署" class="headerlink" title="二、OpenVPN 部署"></a>二、OpenVPN 部署</h2><h3 id="2-1-准备-OpenVPN-部署环境"><a href="#2-1-准备-OpenVPN-部署环境" class="headerlink" title="2.1 准备 OpenVPN 部署环境"></a>2.1 准备 OpenVPN 部署环境</h3><p>官文文档: <a target="_blank" rel="noopener" href="https://openvpn.net/community-resources/how-to/">https://openvpn.net/community-resources/how-to/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup1.jpg" srcset="/blog/img/loading.gif"></p>
<p><strong>可选择以下两套环境之一实现OpenVPN</strong></p>
<h4 id="2-1-1-环境1-阿里云OpenVPN-实战环境"><a href="#2-1-1-环境1-阿里云OpenVPN-实战环境" class="headerlink" title="2.1.1 环境1: 阿里云OpenVPN 实战环境"></a>2.1.1 环境1: 阿里云OpenVPN 实战环境</h4><p><strong>准备阿里云网络实验环境</strong></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-number">1</span> 阿里云创建专有网络<br>指定城市和可用区<span class="hljs-symbol">:</span>华北<span class="hljs-number">3</span>张家口可用区A区<br>网段名magedu-net1和地址段<span class="hljs-number">172.16</span>.0.0/<span class="hljs-number">12</span>,默认资源组<br>交换机名magedu-net1-sw1 可用区A IPv4的地址段 <span class="hljs-number">172.30</span>.0.0/<span class="hljs-number">24</span><br>安全组开放<span class="hljs-number">22</span>端口<br><br><span class="hljs-number">2</span> 创建OpenVPN服务器有公网IP的实例<span class="hljs-number">1</span>个<br>指定城市和可用区<span class="hljs-symbol">:</span>华北<span class="hljs-number">3</span>张家口可用区A区<br>计算型c6 <span class="hljs-number">2</span>vCPU <span class="hljs-number">4</span>G<br>网络<span class="hljs-symbol">:magedu-net1</span> 交换机<span class="hljs-symbol">:magedu-net1-sw1</span><br>公网IP 按量收费 <span class="hljs-number">10</span>M<br>默认安全组 默认配置 <span class="hljs-number">22</span>,<span class="hljs-number">3389</span>,icmp<br>centos8.<span class="hljs-number">2</span><br>系统盘 存储默认高效云盘<span class="hljs-number">40</span>G<br><br>0.<span class="hljs-number">3</span>元/小时 公网流量0.<span class="hljs-number">8</span>元/G<br><br><span class="hljs-number">3</span> 创建局域网的服务器无公网IP的实例<span class="hljs-number">2</span>个<br>按量付费<br>指定城市和可用区<span class="hljs-symbol">:</span>华北<span class="hljs-number">3</span>张家口可用区A区<br>共享型 <span class="hljs-number">2</span>vCPU2G<br>centos8.<span class="hljs-number">2</span><br><br>系统盘 存储默认高效云盘<span class="hljs-number">40</span>G<br>网络<span class="hljs-symbol">:magedu-net1</span> magedu-net1-sw1<br>无公网IP<br>默认安全组<br>主网卡sw1<br><br><span class="hljs-number">4</span> 重设所有实例密码<br><br><span class="hljs-number">5</span> 修改安全组打开 <span class="hljs-number">1194</span>/TCP/UDP<br></code></pre></td></tr></table></figure>

<h5 id="2-1-1-1-购买第一台有公网IP的ECS"><a href="#2-1-1-1-购买第一台有公网IP的ECS" class="headerlink" title="2.1.1.1 购买第一台有公网IP的ECS"></a>2.1.1.1 购买第一台有公网IP的ECS</h5><p>阿里云购买链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://ecs-buy.aliyun.com/wizard?<br>spm=5176.8789780.1092585.1.1db055ca1sGhza<span class="hljs-comment">#/prepay/cn-hangzhou?</span><br>periodType=Yearly&amp;period=1&amp;instanceType=ecs.g5.large<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup2.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup3.jpg" srcset="/blog/img/loading.gif"></p>
<h5 id="2-1-1-2-先创建网络和交换机"><a href="#2-1-1-2-先创建网络和交换机" class="headerlink" title="2.1.1.2 先创建网络和交换机"></a>2.1.1.2 先创建网络和交换机</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup4.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup5.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup6.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup7.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup8.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup9.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup10.jpg" srcset="/blog/img/loading.gif"></p>
<h5 id="2-1-1-3-再购买两台内网无公网的ECS"><a href="#2-1-1-3-再购买两台内网无公网的ECS" class="headerlink" title="2.1.1.3 再购买两台内网无公网的ECS"></a>2.1.1.3 再购买两台内网无公网的ECS</h5><p>注意和第一台主机在同一个地域和可用区</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup11.jpg" srcset="/blog/img/loading.gif"></p>
<p>网络和第一台主机一样,无公网IP</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup12.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup13.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup14.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup15.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup16.jpg" srcset="/blog/img/loading.gif"></p>
<h5 id="2-1-1-4-验证主机配置"><a href="#2-1-1-4-验证主机配置" class="headerlink" title="2.1.1.4 验证主机配置"></a>2.1.1.4 验证主机配置</h5><p>创建完成,三台主机</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup17.jpg" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#有公网IP的ECS</span><br>ssh 39.100.145.14<br>root@39.100.145.14<span class="hljs-string">&#x27;s password:</span><br><span class="hljs-string">Welcome to Alibaba Cloud Elastic Compute Service !</span><br><span class="hljs-string">Activate the web console with: systemctl enable --now cockpit.socket</span><br><span class="hljs-string">Last failed login: Tue Sep 15 10:15:15 CST 2020 from 222.137.18.20 on ssh:notty</span><br><span class="hljs-string">There was 1 failed login attempt since the last successful login.</span><br><span class="hljs-string">Last login: Tue Sep 15 10:13:10 2020 from 222.137.18.20</span><br><span class="hljs-string"></span><br><span class="hljs-string">hostname -I</span><br><span class="hljs-string">172.30.0.1</span><br><span class="hljs-string"></span><br><span class="hljs-string">hostname</span><br><span class="hljs-string">vpn-server.magedu.org</span><br><span class="hljs-string"></span><br><span class="hljs-string">cat /etc/centos-release</span><br><span class="hljs-string">CentOS Linux release 8.2.2004 (Core)</span><br><span class="hljs-string"></span><br><span class="hljs-string">#无公网IP的ECS1</span><br><span class="hljs-string">hostname -I</span><br><span class="hljs-string">172.30.0.100</span><br><span class="hljs-string"></span><br><span class="hljs-string">hostname</span><br><span class="hljs-string">web1.magedu.org</span><br><span class="hljs-string"></span><br><span class="hljs-string">cat /etc/centos-release</span><br><span class="hljs-string">CentOS Linux release 8.2.2004 (Core)</span><br><span class="hljs-string"></span><br><span class="hljs-string">#无公网IP的ECS2</span><br><span class="hljs-string">hostname</span><br><span class="hljs-string">web2.magedu.org</span><br><span class="hljs-string"></span><br><span class="hljs-string">hostname -I</span><br><span class="hljs-string">172.30.0.200</span><br><span class="hljs-string"></span><br><span class="hljs-string">cat /etc/centos-release</span><br><span class="hljs-string">CentOS Linux release 8.2.2004 (Core)</span><br></code></pre></td></tr></table></figure>

<h5 id="2-1-1-5-修改网络防火墙规则"><a href="#2-1-1-5-修改网络防火墙规则" class="headerlink" title="2.1.1.5 修改网络防火墙规则"></a>2.1.1.5 修改网络防火墙规则</h5><p>默认VPN的端口无法访问,修改网络防火墙规则,添加1规则实现1194/TCP/UDP端口允许通过</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup18.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup19.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup20.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup21.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="2-1-2-环境2-局域网-OpenVPN-实战环境"><a href="#2-1-2-环境2-局域网-OpenVPN-实战环境" class="headerlink" title="2.1.2 环境2: 局域网 OpenVPN 实战环境"></a>2.1.2 环境2: 局域网 OpenVPN 实战环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">共四台主机<br>1 openvpn server：<br>CentOS 7.4<br>eth0:10.0.0.8/24 NAT模式,模拟公网IP<br>eth1:10.20.0.1/24 仅主机模式,私网IP<br><br>2 内网主机两台<br>第一台主机<br>eth0:10.20.0.100/24 仅主机模式,私网IP<br>第二台主机<br>eth0:10.20.0.200/24 仅主机模式,私网IP<br><br>3 Windows 客户端<br>Windows 10<br></code></pre></td></tr></table></figure>

<h3 id="2-2-安装-OpenVPN-软件包"><a href="#2-2-安装-OpenVPN-软件包" class="headerlink" title="2.2 安装 OpenVPN 软件包"></a>2.2 安装 OpenVPN 软件包</h3><h4 id="2-2-1查看版本"><a href="#2-2-1查看版本" class="headerlink" title="2.2.1查看版本"></a>2.2.1查看版本</h4><h5 id="2-2-1-1-查看官网的OpenVPN的版本"><a href="#2-2-1-1-查看官网的OpenVPN的版本" class="headerlink" title="2.2.1.1 查看官网的OpenVPN的版本"></a>2.2.1.1 查看官网的OpenVPN的版本</h5><p>访问官网：<a target="_blank" rel="noopener" href="https://openvpn.net/">https://openvpn.net</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup22.jpg" srcset="/blog/img/loading.gif"></p>
<h5 id="2-2-1-2-在不同OS上查看OpenVPN版本"><a href="#2-2-1-2-在不同OS上查看OpenVPN版本" class="headerlink" title="2.2.1.2 在不同OS上查看OpenVPN版本"></a>2.2.1.2 在不同OS上查看OpenVPN版本</h5><p><strong>CentOS系统上的EPEL源OpenVPN版本比Ubuntu的仓库中版本更新,以下选择在CentOS7上部署OpenVPN</strong></p>
<p>范例: CentOS 查看OpenVPN版本</p>
<p>（注意：使用阿里云的epel源寻找openvpn的时，需要直接指定epel源的完整路径，不然会找不到包）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum list openvpn</span><br>openvpn.x86_64      2.4.10-1.el7                    epel<br>[root@centos7 ~]<span class="hljs-comment"># yum list easy-rsa</span><br>easy-rsa.noarch     3.0.8-1.el7                      epel<br></code></pre></td></tr></table></figure>

<p>范例: Ubuntu1804 查看OpenVPN版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt list openvpn<br>Listing... Done<br>openvpn/bionic-proposed 2.4.4-2ubuntu1.4 amd64<br>N: There are 2 additional versions. Please use the <span class="hljs-string">&#x27;-a&#x27;</span> switch to see the<br><br>apt-cache madison openvpn<br> openvpn | 2.4.4-2ubuntu1.4 | http://mirrors.aliyun.com/ubuntu bionic-<br>proposed/main amd64 Packages<br> openvpn | 2.4.4-2ubuntu1.3 | http://mirrors.aliyun.com/ubuntu bionic-<br>updates/main amd64 Packages<br> openvpn | 2.4.4-2ubuntu1 | http://mirrors.aliyun.com/ubuntu bionic/main amd64<br>Packages<br> openvpn | 2.4.4-2ubuntu1 | http://mirrors.aliyun.com/ubuntu bionic/main<br>Sources<br> openvpn | 2.4.4-2ubuntu1.3 | http://mirrors.aliyun.com/ubuntu bionic-<br>updates/main Sources<br> openvpn | 2.4.4-2ubuntu1.4 | http://mirrors.aliyun.com/ubuntu bionic-<br>proposed/main Sources<br><br>apt-cache madison easy-rsa<br>easy-rsa |   2.2.2-2 | http://mirrors.aliyun.com/ubuntu bionic/universe amd64<br>Packages<br>easy-rsa |   2.2.2-2 | http://mirrors.aliyun.com/ubuntu bionic/universe i386<br>Packages<br>easy-rsa |   2.2.2-2 | http://mirrors.aliyun.com/ubuntu bionic/universe<br>Sources<br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-安装-OpenVPN"><a href="#2-2-2-安装-OpenVPN" class="headerlink" title="2.2.2 安装 OpenVPN"></a>2.2.2 安装 OpenVPN</h4><h5 id="2-2-2-1-安装OpenVPN和证书工具"><a href="#2-2-2-1-安装OpenVPN和证书工具" class="headerlink" title="2.2.2.1 安装OpenVPN和证书工具"></a>2.2.2.1 安装OpenVPN和证书工具</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#OpenVPN服务器端</span><br>[root@centos7 ~]<span class="hljs-comment"># yum -y install openvpn</span><br><br><span class="hljs-comment">#证书管理工具</span><br>[root@centos7 ~]<span class="hljs-comment"># yum -y install easy-rsa</span><br></code></pre></td></tr></table></figure>

<h5 id="2-2-2-2-查看包中相关文件"><a href="#2-2-2-2-查看包中相关文件" class="headerlink" title="2.2.2.2 查看包中相关文件"></a>2.2.2.2 查看包中相关文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># rpm -qi openvpn easy-rsa</span><br>Name        : openvpn<br>Version     : 2.4.10<br>Release     : 1.el7<br>Architecture: x86_64<br>Install Date: Wed 03 Mar 2021 11:33:01 AM CST<br>Group       : Unspecified<br>Size        : 1282923<br>License     : GPLv2<br>Signature   : RSA/SHA256, Thu 10 Dec 2020 02:15:14 AM CST, Key ID 6a2faea2352c64e5<br>Source RPM  : openvpn-2.4.10-1.el7.src.rpm<br>Build Date  : Thu 10 Dec 2020 01:00:01 AM CST<br>Build Host  : buildhw-x86-10.iad2.fedoraproject.org<br>Relocations : (not relocatable)<br>Packager    : Fedora Project<br>Vendor      : Fedora Project<br>URL         : https://community.openvpn.net/<br>Bug URL     : https://bugz.fedoraproject.org/openvpn<br>Summary     : A full-featured SSL VPN solution<br>Description :<br>OpenVPN is a robust and highly flexible tunneling application that uses all<br>of the encryption, authentication, and certification features of the<br>OpenSSL library to securely tunnel IP networks over a single UDP or TCP<br>port.  It can use the Marcus Franz Xaver Johannes Oberhumers LZO library<br><span class="hljs-keyword">for</span> compression.<br>Name        : easy-rsa<br>Version     : 3.0.8<br>Release     : 1.el7<br>Architecture: noarch<br>Install Date: Wed 03 Mar 2021 11:33:11 AM CST<br>Group       : Unspecified<br>Size        : 122756<br>License     : GPLv2<br>Signature   : RSA/SHA256, Thu 10 Sep 2020 09:23:24 PM CST, Key ID 6a2faea2352c64e5<br>Source RPM  : easy-rsa-3.0.8-1.el7.src.rpm<br>Build Date  : Thu 10 Sep 2020 09:21:31 PM CST<br>Build Host  : buildhw-x86-11.iad2.fedoraproject.org<br>Relocations : (not relocatable)<br>Packager    : Fedora Project<br>Vendor      : Fedora Project<br>URL         : https://github.com/OpenVPN/easy-rsa<br>Bug URL     : https://bugz.fedoraproject.org/easy-rsa<br>Summary     : Simple shell based CA utility<br>Description :<br>This is a small RSA key management package, based on the openssl<br><span class="hljs-built_in">command</span> line tool, that can be found <span class="hljs-keyword">in</span> the easy-rsa subdirectory<br>of the OpenVPN distribution. While this tool is primary concerned<br>with key management <span class="hljs-keyword">for</span> the SSL VPN application space, it can also<br>be used <span class="hljs-keyword">for</span> building web certificates.<br><br>[root@centos7 ~]<span class="hljs-comment"># rpm -ql openvpn</span><br>/etc/openvpn<br>/etc/openvpn/client<br>/etc/openvpn/server<br>/run/openvpn-client<br>/run/openvpn-server<br>/usr/lib/systemd/system/openvpn-client@.service<br>/usr/lib/systemd/system/openvpn-server@.service<br>/usr/lib/systemd/system/openvpn@.service<br>/usr/lib/tmpfiles.d/openvpn.conf<br>/usr/lib64/openvpn<br>/usr/lib64/openvpn/plugins<br>/usr/lib64/openvpn/plugins/openvpn-plugin-auth-pam.so<br>/usr/lib64/openvpn/plugins/openvpn-plugin-down-root.so<br>/usr/sbin/openvpn<br>/usr/share/doc/openvpn-2.4.10<br>/usr/share/doc/openvpn-2.4.10/AUTHORS<br>/usr/share/doc/openvpn-2.4.10/COPYING<br>/usr/share/doc/openvpn-2.4.10/COPYRIGHT.GPL<br>/usr/share/doc/openvpn-2.4.10/ChangeLog<br>/usr/share/doc/openvpn-2.4.10/Changes.rst<br>/usr/share/doc/openvpn-2.4.10/README<br>/usr/share/doc/openvpn-2.4.10/README.auth-pam<br>/usr/share/doc/openvpn-2.4.10/README.down-root<br>/usr/share/doc/openvpn-2.4.10/README.systemd<br>/usr/share/doc/openvpn-2.4.10/contrib<br>/usr/share/doc/openvpn-2.4.10/contrib/OCSP_check<br>/usr/share/doc/openvpn-2.4.10/contrib/OCSP_check/OCSP_check.sh<br>/usr/share/doc/openvpn-2.4.10/contrib/README<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/README<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/fwmarkroute.down<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/fwmarkroute.up<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf/client.down<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf/client.up<br>/usr/share/doc/openvpn-2.4.10/management-notes.txt<br>/usr/share/doc/openvpn-2.4.10/sample<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/README<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/client.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/firewall.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/home.up<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/loopback-client<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/loopback-server<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/office.up<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/openvpn-shutdown.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/openvpn-startup.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/roadwarrior-client.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/roadwarrior-server.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/server.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/static-home.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/static-office.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/tls-home.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/tls-office.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/xinetd-client-config<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/xinetd-server-config<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/auth-pam.pl<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/bridge-start<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/bridge-stop<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/ucn.pl<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/verify-cn<br>/usr/share/doc/openvpn-2.4.10/sample/sample-windows<br>/usr/share/doc/openvpn-2.4.10/sample/sample-windows/sample.ovpn<br>/usr/share/man/man8/openvpn.8.gz<br>/var/lib/openvpn<br><br>[root@centos7 ~]<span class="hljs-comment"># rpm -ql easy-rsa</span><br>/etc/openvpn<br>/etc/openvpn/client<br>/etc/openvpn/server<br>/run/openvpn-client<br>/run/openvpn-server<br>/usr/lib/systemd/system/openvpn-client@.service<br>/usr/lib/systemd/system/openvpn-server@.service<br>/usr/lib/systemd/system/openvpn@.service<br>/usr/lib/tmpfiles.d/openvpn.conf<br>/usr/lib64/openvpn<br>/usr/lib64/openvpn/plugins<br>/usr/lib64/openvpn/plugins/openvpn-plugin-auth-pam.so<br>/usr/lib64/openvpn/plugins/openvpn-plugin-down-root.so<br>/usr/sbin/openvpn<br>/usr/share/doc/openvpn-2.4.10<br>/usr/share/doc/openvpn-2.4.10/AUTHORS<br>/usr/share/doc/openvpn-2.4.10/COPYING<br>/usr/share/doc/openvpn-2.4.10/COPYRIGHT.GPL<br>/usr/share/doc/openvpn-2.4.10/ChangeLog<br>/usr/share/doc/openvpn-2.4.10/Changes.rst<br>/usr/share/doc/openvpn-2.4.10/README<br>/usr/share/doc/openvpn-2.4.10/README.auth-pam<br>/usr/share/doc/openvpn-2.4.10/README.down-root<br>/usr/share/doc/openvpn-2.4.10/README.systemd<br>/usr/share/doc/openvpn-2.4.10/contrib<br>/usr/share/doc/openvpn-2.4.10/contrib/OCSP_check<br>/usr/share/doc/openvpn-2.4.10/contrib/OCSP_check/OCSP_check.sh<br>/usr/share/doc/openvpn-2.4.10/contrib/README<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/README<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/fwmarkroute.down<br>/usr/share/doc/openvpn-2.4.10/contrib/openvpn-fwmarkroute-1.00/fwmarkroute.up<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf/client.down<br>/usr/share/doc/openvpn-2.4.10/contrib/pull-resolv-conf/client.up<br>/usr/share/doc/openvpn-2.4.10/management-notes.txt<br>/usr/share/doc/openvpn-2.4.10/sample<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/README<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/client.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/firewall.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/home.up<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/loopback-client<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/loopback-server<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/office.up<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/openvpn-shutdown.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/openvpn-startup.sh<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/roadwarrior-client.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/roadwarrior-server.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/server.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/static-home.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/static-office.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/tls-home.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/tls-office.conf<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/xinetd-client-config<br>/usr/share/doc/openvpn-2.4.10/sample/sample-config-files/xinetd-server-config<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/auth-pam.pl<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/bridge-start<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/bridge-stop<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/ucn.pl<br>/usr/share/doc/openvpn-2.4.10/sample/sample-scripts/verify-cn<br>/usr/share/doc/openvpn-2.4.10/sample/sample-windows<br>/usr/share/doc/openvpn-2.4.10/sample/sample-windows/sample.ovpn<br>/usr/share/man/man8/openvpn.8.gz<br>/var/lib/openvpn<br>[root@centos7 yum.repos.d]<span class="hljs-comment"># rpm -ql easy-rsa</span><br>/usr/share/doc/easy-rsa-3.0.8<br>/usr/share/doc/easy-rsa-3.0.8/COPYING.md<br>/usr/share/doc/easy-rsa-3.0.8/ChangeLog<br>/usr/share/doc/easy-rsa-3.0.8/README.md<br>/usr/share/doc/easy-rsa-3.0.8/README.quickstart.md<br>/usr/share/doc/easy-rsa-3.0.8/vars.example<br>/usr/share/easy-rsa<br>/usr/share/easy-rsa/3<br>/usr/share/easy-rsa/3.0<br>/usr/share/easy-rsa/3.0.8<br>/usr/share/easy-rsa/3.0.8/easyrsa<br>/usr/share/easy-rsa/3.0.8/openssl-easyrsa.cnf<br>/usr/share/easy-rsa/3.0.8/x509-types<br>/usr/share/easy-rsa/3.0.8/x509-types/COMMON<br>/usr/share/easy-rsa/3.0.8/x509-types/ca<br>/usr/share/easy-rsa/3.0.8/x509-types/client<br>/usr/share/easy-rsa/3.0.8/x509-types/code-signing<br>/usr/share/easy-rsa/3.0.8/x509-types/email<br>/usr/share/easy-rsa/3.0.8/x509-types/kdc<br>/usr/share/easy-rsa/3.0.8/x509-types/server<br>/usr/share/easy-rsa/3.0.8/x509-types/serverClient<br>/usr/share/licenses/easy-rsa-3.0.8<br>/usr/share/licenses/easy-rsa-3.0.8/gpl-2.0.txt<br></code></pre></td></tr></table></figure>

<h5 id="2-2-2-3-准备相关配置文件"><a href="#2-2-2-3-准备相关配置文件" class="headerlink" title="2.2.2.3 准备相关配置文件"></a>2.2.2.3 准备相关配置文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#生成服务器配置文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cp /usr/share/doc/openvpn-2.4.10/sample/sample-config-files/server.conf /etc/openvpn/</span><br><br><span class="hljs-comment">#准备证书签发相关文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server</span><br><br><span class="hljs-comment">#准备签发证书相关变量的配置文件</span><br>[root@centos7 ~]<span class="hljs-comment"># cp /usr/share/doc/easy-rsa-3.0.8/vars.example /etc/openvpn/easy-rsa-server/3/vars</span><br><br><span class="hljs-comment">#建议修改给CA和OpenVPN服务器颁发的证书的有效期,可适当加长</span><br>[root@centos7 ~]<span class="hljs-comment"># vim /etc/openvpn/easy-rsa-server/3/vars</span><br><span class="hljs-comment">#CA的证书有效期默为为10年,可以适当延长,比如:36500天</span><br><span class="hljs-comment">#set_var EASYRSA_CA_EXPIRE   3650</span><br>set_var EASYRSA_CA_EXPIRE    36500<br><br><span class="hljs-comment">#服务器证书默为为825天,可适当加长,比如:3650天</span><br><span class="hljs-comment">#set_var EASYRSA_CERT_EXPIRE  825</span><br><span class="hljs-comment">#将上面行修改为下面</span><br>set_var EASYRSA_CERT_EXPIRE   3650<br><br>[root@centos7 ~]<span class="hljs-comment"># tree /etc/openvpn/</span><br>/etc/openvpn/<br>├── client<br>├── easy-rsa-server<br>│  ├── 3 -&gt; 3.0.7<br>│  ├── 3.0 -&gt; 3.0.7<br>│  └── 3.0.7<br>│    ├── easyrsa<br>│    ├── openssl-easyrsa.cnf<br>│    ├── vars<br>│    └── x509-types<br>│      ├── ca<br>│      ├── client<br>│      ├── code-signing<br>│      ├── COMMON<br>│      ├── email<br>│      ├── kdc<br>│      ├── server<br>│      └── serverClient<br>├── server<br>└── server.conf<br>7 directories, 12 files<br></code></pre></td></tr></table></figure>

<h3 id="2-3-准备证书相关文件"><a href="#2-3-准备证书相关文件" class="headerlink" title="2.3 准备证书相关文件"></a>2.3 准备证书相关文件</h3><h4 id="2-3-1-初始化PKI和CA签发机构环境"><a href="#2-3-1-初始化PKI和CA签发机构环境" class="headerlink" title="2.3.1 初始化PKI和CA签发机构环境"></a>2.3.1 初始化PKI和CA签发机构环境</h4><h5 id="2-3-1-1-脚本easyrsa帮助用法"><a href="#2-3-1-1-脚本easyrsa帮助用法" class="headerlink" title="2.3.1.1 脚本easyrsa帮助用法"></a>2.3.1.1 脚本easyrsa帮助用法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3/cd /etc/openvpn/easy-rsa-server/3/</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-server/3<br>[root@centos7 3]<span class="hljs-comment"># file ./easyrsa</span><br>./easyrsa: POSIX shell script, ASCII text executable<br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa </span><br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa/3.0.7/vars<br><br>Easy-RSA 3 usage and overview<br><br>USAGE: easyrsa [options] COMMAND [command-options]<br><br>A list of commands is shown below. To get detailed usage and <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> a<br><span class="hljs-built_in">command</span>, run:<br>./easyrsa <span class="hljs-built_in">help</span> COMMAND<br><br>For a listing of options that can be supplied before the <span class="hljs-built_in">command</span>, use:<br>./easyrsa <span class="hljs-built_in">help</span> options<br><br>Here is the list of commands available with a short syntax reminder. Use the<br><span class="hljs-string">&#x27;help&#x27;</span> <span class="hljs-built_in">command</span> above to get full usage details.<br><br>init-pki<br>build-ca [ cmd-opts ]<br>gen-dh<br>gen-req &lt;filename_base&gt; [ cmd-opts ]<br>sign-req &lt;<span class="hljs-built_in">type</span>&gt; &lt;filename_base&gt;<br>build-client-full &lt;filename_base&gt; [ cmd-opts ]<br>build-server-full &lt;filename_base&gt; [ cmd-opts ]<br>revoke &lt;filename_base&gt; [cmd-opts]<br>renew &lt;filename_base&gt; [cmd-opts]<br>build-serverClient-full &lt;filename_base&gt; [ cmd-opts ]<br>gen-crl<br>update-db<br>show-req &lt;filename_base&gt; [ cmd-opts ]<br>show-cert &lt;filename_base&gt; [ cmd-opts ]<br>show-ca [ cmd-opts ]<br>import-req &lt;request_file_path&gt; &lt;short_basename&gt;<br>export-p7 &lt;filename_base&gt; [ cmd-opts ]<br>export-p12 &lt;filename_base&gt; [ cmd-opts ]<br>set-rsa-pass &lt;filename_base&gt; [ cmd-opts ]<br>set-ec-pass &lt;filename_base&gt; [ cmd-opts ]<br>upgrade &lt;<span class="hljs-built_in">type</span>&gt;<br><br>DIRECTORY STATUS (commands would take effect on these locations)<br>EASYRSA: /etc/openvpn/easy-rsa/3.0.7<br>  PKI: /etc/openvpn/easy-rsa/3/pki<br></code></pre></td></tr></table></figure>

<h5 id="2-3-1-2-初始化PKI生成PKI相关目录和文件"><a href="#2-3-1-2-初始化PKI生成PKI相关目录和文件" class="headerlink" title="2.3.1.2 初始化PKI生成PKI相关目录和文件"></a>2.3.1.2 初始化PKI生成PKI相关目录和文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3/</span><br>root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-server/3<br><br>[root@centos7 3]<span class="hljs-comment"># ls</span><br>easyrsa openssl-easyrsa.cnf vars x509-types<br><span class="hljs-comment">#初始化数据,在当前目录下生成pki目录及相关文件</span><br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa init-pki</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>init-pki complete; you may now create a CA or requests.<br>Your newly created PKI dir is: /etc/openvpn/easy-rsa-server/3/pki<br><br>[root@centos7 3]<span class="hljs-comment"># tree</span><br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki      <span class="hljs-comment">#生成一个新目录及相关文件</span><br>│  ├── openssl-easyrsa.cnf<br>│  ├── private<br>│  ├── reqs<br>│  └── safessl-easyrsa.cnf<br>├── vars<br>└── x509-types<br> ├── ca<br> ├── client<br> ├── code-signing<br> ├── COMMON<br> ├── email<br> ├── kdc<br> ├── server<br> └── serverClient<br>4 directories, 13 files<br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-创建CA机构"><a href="#2-3-2-创建CA机构" class="headerlink" title="2.3.2 创建CA机构"></a>2.3.2 创建CA机构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># tree pki</span><br>pki<br>├── openssl-easyrsa.cnf<br>├── private<br>├── reqs<br>└── safessl-easyrsa.cnf<br><br>2 directories, 2 files<br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa build-ca nopass</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating RSA private key, 2048 bit long modulus (2 primes)<br>...................................................+++++<br>........+++++<br>e is 65537 (0x010001)<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [Easy-RSA CA]: <span class="hljs-comment">#接受默认值,直接回车</span><br><br>CA creation complete and you may now import and sign cert requests.<br>Your new CA certificate file <span class="hljs-keyword">for</span> publishing is at:<br>/etc/openvpn/easy-rsa-server/3/pki/ca.crt  <span class="hljs-comment">#生成自签名的证书文件</span><br><br>[root@centos7 3]<span class="hljs-comment"># tree pki</span><br>pki<br>├── ca.crt <span class="hljs-comment">#生成自签名的证书文件</span><br>├── certs_by_serial<br>├── index.txt<br>├── index.txt.attr<br>├── issued<br>├── openssl-easyrsa.cnf<br>├── private<br>│  └── ca.key <span class="hljs-comment">#生成私钥文件</span><br>├── renewed<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── reqs<br>├── revoked<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>└── serial<br>12 directories, 7 files<br><br><span class="hljs-comment">#生成CA相关的文件</span><br>[root@centos7 3]<span class="hljs-comment"># cat pki/serial</span><br>01<br>[root@centos7 3]<span class="hljs-comment"># ll pki/index.txt</span><br>-rw------- 1 root root 0 Aug  2 16:42 pki/index.txt<br>[root@centos7 3]<span class="hljs-comment"># cat pki/serial</span><br>01<br>[root@centos7 3]<span class="hljs-comment"># ll pki/ca.crt pki/private/ca.key</span><br>-rw------- 1 root root 1204 Aug  2 16:42 pki/ca.crt<br>-rw------- 1 root root 1675 Aug  2 16:42 pki/private/ca.key<br><br><span class="hljs-comment">#查看生成的自签名证书</span><br>cat pki/ca.crt<br>-----BEGIN CERTIFICATE-----<br>MIIDSzCCAjOgAwIBAgIUfOBoVD77VY3WI6i+X6tUbayrRnowDQYJKoZIhvcNAQEL<br>BQAwFjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0EwHhcNMjAwODAyMDg0MjI3WhcNMzAw<br>NzMxMDg0MjI3WjAWMRQwEgYDVQQDDAtFYXN5LVJTQSBDQTCCASIwDQYJKoZIhvcN<br>AQEBBQADggEPADCCAQoCggEBAMejJZdSXakfGPfkSsXEzaIuVwMy7is9+DuhdxiZ<br>UiZfuLs7clzRtd0arSSytDQEn+Fjf0zc8HCqvtYjJ3HdXx0bhBkGX4ikszbGcBJD<br>JuE25Qu86P3CsNjhcSvAWTRlivKoYXJA1lIUNOXpBlUBA/7XbkvUdVM0CXechnSr<br>1sddffqISu/xnrsPpFsdjfgfwPRuYIUDiitozGk2jE8/fZo3VwwHbqe5GURFlv0k<br>Y6/afOP2YJBwOFcjvoa1p5+VOhsVG5lhLBdXKc0kHrchzXPLjTODOKoNW0xxCvty<br>B69b7l/t5HGNue2se3FuzH45mkQfNvi/t9Ms7F7FE4euuAsCAwEAAaOBkDCBjTAd<br>BgNVHQ4EFgQU7IEA8jlzixju11dvjoC65Ula6rIwUQYDVR0jBEowSIAU7IEA8jlz<br>ixju11dvjoC65Ula6rKhGqQYMBYxFDASBgNVBAMMC0Vhc3ktUlNBIENBghR84GhU<br>PvtVjdYjqL5fq1RtrKtGejAMBgNVHRMEBTADAQH/MAsGA1UdDwQEAwIBBjANBgkq<br>hkiG9w0BAQsFAAOCAQEAZjyvrAL23EONViFexiAwVN0ypAd7X8yMwSJsHz/uPg/N<br>HXBlEzFZLvny7hWcdoa3gaPOAawBR4ab2riuKFRiiqWu6VM9P/pGufGDBVXkYVnJ<br>buxHtA4kCbFIy1LlqHw9pfZbRJ4esprLfr5KSgqdqFf2v2Vwq3RlapFTiSjJsIWj<br>lsgboc2PtpXcB9YKN/x11Dqt1o15hmjjCHwFnE90NNQ/P/ENwhh2xZCfVVvg3Sr3<br>t/qwEi2uImBkBuJUhExykcl3jptwEse1Ql3SUs8VGkkCic03m8glwxjTGnaKNkG+<br>9DiTvn57iCoM+VtKDgkOeusl36PDvG86XUZZUD5Vww==<br>-----END CERTIFICATE-----<br>[root@centos7 3]<span class="hljs-comment"># openssl x509 -in pki/ca.crt -noout -text</span><br>Certificate:<br> Data:<br>   Version: 3 (0x2)<br>   Serial Number:<br>     7c:e0:68:54:3e:fb:55:8d:d6:23:a8:be:5f:ab:54:6d:ac:ab:46:7a<br>   Signature Algorithm: sha256WithRSAEncryption<br>   Issuer: CN = Easy-RSA CA<br>   Validity<br>     Not Before: Aug  2 08:42:27 2020 GMT<br>     Not After : Jul 31 08:42:27 2030 GMT<br>   Subject: CN = Easy-RSA CA<br>   Subject Public Key Info:<br>     Public Key Algorithm: rsaEncryption<br>       RSA Public-Key: (2048 bit)<br>       Modulus:<br>          00:c7:a3:25:97:52:5d:a9:1f:18:f7:e4:4a:c5:c4:<br>          <span class="hljs-built_in">cd</span>:a2:2e:57:03:32:ee:2b:3d:f8:3b:a1:77:18:99:<br>          52:26:5f:b8:bb:3b:72:5c:d1:b5:dd:1a:ad:24:b2:<br>          b4:34:04:9f:e1:63:7f:4c:dc:f0:70:aa:be:d6:23:<br>          27:71:dd:5f:1d:1b:84:19:06:5f:88:a4:b3:36:c6:<br>          70:12:43:26:e1:36:e5:0b:bc:e8:fd:c2:b0:d8:e1:<br>          71:2b:c0:59:34:65:8a:f2:a8:61:72:40:d6:52:14:<br>          34:e5:e9:06:55:01:03:fe:d7:6e:4b:d4:75:53:34:<br>          09:77:9c:86:74:ab:d6:c7:5d:7d:fa:88:4a:ef:f1:<br>         9e:bb:0f:a4:5b:1d:8d:f8:1f:c0:f4:6e:60:85:03:<br>         8a:2b:68:cc:69:36:8c:4f:3f:7d:9a:37:57:0c:07:<br>         6e:a7:b9:19:44:45:96:fd:24:63:af:da:7c:e3:f6:<br>          60:90:70:38:57:23:be:86:b5:a7:9f:95:3a:1b:15:<br>         1b:99:61:2c:17:57:29:<span class="hljs-built_in">cd</span>:24:1e:b7:21:<span class="hljs-built_in">cd</span>:73:cb:<br>         8d:33:83:38:aa:0d:5b:4c:71:0a:fb:72:07:af:5b:<br>         ee:5f:ed:e4:71:8d:b9:ed:ac:7b:71:6e:cc:7e:39:<br>         9a:44:1f:36:f8:bf:b7:d3:2c:ec:5e:c5:13:87:ae:<br>         b8:0b<br>       Exponent: 65537 (0x10001)<br>   X509v3 extensions:<br>     X509v3 Subject Key Identifier:<br>       EC:81:00:F2:39:73:8B:18:EE:D7:57:6F:8E:80:BA:E5:49:5A:EA:B2<br>     X509v3 Authority Key Identifier:<br>     <br>keyid:EC:81:00:F2:39:73:8B:18:EE:D7:57:6F:8E:80:BA:E5:49:5A:EA:B2<br>       DirName:/CN=Easy-RSA CA<br>       <br>serial:7C:E0:68:54:3E:FB:55:8D:D6:23:A8:BE:5F:AB:54:6D:AC:AB:46:7A<br><br>     X509v3 Basic Constraints:<br>       CA:TRUE<br>     X509v3 Key Usage:<br>       Certificate Sign, CRL Sign<br> Signature Algorithm: sha256WithRSAEncryption<br>    66:3c:af:ac:02:f6:dc:43:8d:56:21:5e:c6:20:30:54:dd:32:<br>    a4:07:7b:5f:cc:8c:c1:22:6c:1f:3f:ee:3e:0f:<span class="hljs-built_in">cd</span>:1d:70:65:<br>    13:31:59:2e:f9:f2:ee:15:9c:76:86:b7:81:a3:ce:01:ac:01:<br>    47:86:9b:da:b8:ae:28:54:62:8a:a5:ae:e9:53:3d:3f:fa:46:<br>    b9:f1:83:05:55:e4:61:59:c9:6e:ec:47:b4:0e:24:09:b1:48:<br>    cb:52:e5:a8:7c:3d:a5:f6:5b:44:9e:1e:b2:9a:cb:7e:be:4a:<br>    4a:0a:9d:a8:57:f6:bf:65:70:ab:74:65:6a:91:53:89:28:c9:<br>    b0:85:a3:96:c8:1b:a1:<span class="hljs-built_in">cd</span>:8f:b6:95:dc:07:d6:0a:37:<span class="hljs-built_in">fc</span>:75:<br>    d4:3a:ad:d6:8d:79:86:68:e3:08:7c:05:9c:4f:74:34:d4:3f:<br>    3f:f1:0d:c2:18:76:c5:90:9f:55:5b:e0:dd:2a:f7:b7:fa:b0:<br>    12:2d:ae:22:60:64:06:e2:54:84:4c:72:91:c9:77:8e:9b:70:<br>    12:c7:b5:42:5d:d2:52:cf:15:1a:49:02:89:<span class="hljs-built_in">cd</span>:37:9b:c8:25:<br>    c3:18:d3:1a:76:8a:36:41:be:f4:38:93:be:7e:7b:88:2a:0c:<br>    f9:5b:4a:0e:09:0e:7a:eb:25:df:a3:c3:bc:6f:3a:5d:46:59:<br>    50:3e:55:c3<br></code></pre></td></tr></table></figure>

<h4 id="2-3-3-创建服务端证书申请"><a href="#2-3-3-创建服务端证书申请" class="headerlink" title="2.3.3 创建服务端证书申请"></a>2.3.3 创建服务端证书申请</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-server/3<br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-req server nopass</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating a RSA private key<br>..................+++++<br>................................................................................<br>....................................................+++++<br>writing new private key to <span class="hljs-string">&#x27;/etc/openvpn/easy-rsa-server/3/pki/easy-rsa-</span><br><span class="hljs-string">2135.JNDCBg/tmp.6nXb8b&#x27;</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [server]: <span class="hljs-comment">#接受Common Name的默认值,直接回车</span><br><br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-server/3/pki/reqs/server.req      <span class="hljs-comment">#生成请求文件</span><br>key: /etc/openvpn/easy-rsa-server/3/pki/private/server.key    <span class="hljs-comment">#生成私钥文件</span><br><br>[root@centos7 3]<span class="hljs-comment"># tree pki</span><br>pki<br>├── ca.crt<br>├── certs_by_serial<br>├── index.txt<br>├── index.txt.attr<br>├── issued<br>├── openssl-easyrsa.cnf<br>├── private<br>│  ├── ca.key<br>│  └── server.key    <span class="hljs-comment">#生成私钥文件</span><br>├── renewed<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── reqs<br>│  └── server.req    <span class="hljs-comment">#生成请求文件</span><br>├── revoked<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>└── serial<br><br>12 directories, 9 files<br></code></pre></td></tr></table></figure>

<h4 id="2-3-4-签发服务端证书"><a href="#2-3-4-签发服务端证书" class="headerlink" title="2.3.4 签发服务端证书"></a>2.3.4 签发服务端证书</h4><h5 id="2-3-4-1-查看颁发证书命令用法"><a href="#2-3-4-1-查看颁发证书命令用法" class="headerlink" title="2.3.4.1 查看颁发证书命令用法"></a>2.3.4.1 查看颁发证书命令用法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa help sign</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>sign-req &lt;<span class="hljs-built_in">type</span>&gt; &lt;filename_base&gt;<br>  Sign a certificate request of the defined <span class="hljs-built_in">type</span>. &lt;<span class="hljs-built_in">type</span>&gt; must be a known<br>  <span class="hljs-built_in">type</span> such as <span class="hljs-string">&#x27;client&#x27;</span>, <span class="hljs-string">&#x27;server&#x27;</span>, <span class="hljs-string">&#x27;serverClient&#x27;</span>, or <span class="hljs-string">&#x27;ca&#x27;</span> (or a user-added<br><span class="hljs-built_in">type</span>.)<br>  This request file must exist <span class="hljs-keyword">in</span> the reqs/ dir and have a .req file<br>  extension. See import-req below <span class="hljs-keyword">for</span> importing reqs from other sources.<br></code></pre></td></tr></table></figure>

<h5 id="2-3-4-2-颁发服务端证书"><a href="#2-3-4-2-颁发服务端证书" class="headerlink" title="2.3.4.2 颁发服务端证书"></a>2.3.4.2 颁发服务端证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#将上面server.req的申请,颁发server类型的证书</span><br>[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa sign server server</span><br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br><br>You are about to sign the following certificate.<br>Please check over the details shown below <span class="hljs-keyword">for</span> accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br><span class="hljs-built_in">source</span> or that you have verified the request checksum with the sender.<br><br>Request subject, to be signed as a server certificate <span class="hljs-keyword">for</span> 3650 days:  <span class="hljs-comment">#可以看到vars文件指定的有效期</span><br><br>subject=<br> commonName         = server<br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Confirm request details: yes <span class="hljs-comment">#输入yes回车</span><br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-<br>2334.MEAQFE/tmp.SIdgaC<br>Check that the request matches the signature<br>Signature ok<br>The Subject<span class="hljs-string">&#x27;s Distinguished Name is as follows</span><br><span class="hljs-string">commonName      :ASN.1 12:&#x27;</span>server<span class="hljs-string">&#x27;</span><br><span class="hljs-string">Certificate is to be certified until Oct 31 09:19:43 2020 GMT (90 days)</span><br><span class="hljs-string"></span><br><span class="hljs-string">Write out database with 1 new entries</span><br><span class="hljs-string">Data Base Updated</span><br><span class="hljs-string"></span><br><span class="hljs-string">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt #生成服务器证书文件</span><br></code></pre></td></tr></table></figure>

<h5 id="2-3-4-3-验证结果"><a href="#2-3-4-3-验证结果" class="headerlink" title="2.3.4.3 验证结果"></a>2.3.4.3 验证结果</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># tree pki</span><br>pki<br>├── ca.crt<br>├── certs_by_serial<br>│  └── EDAEBAB8D65066D307AE58ADC1A56682.pem  <span class="hljs-comment">#服务器证书文件</span><br>├── index.txt<br>├── index.txt.attr<br>├── index.txt.attr.old<br>├── index.txt.old<br>├── issued<br>│  └── server.crt      <span class="hljs-comment">#服务器证书文件</span><br>├── openssl-easyrsa.cnf<br>├── private<br>│  ├── ca.key<br>│  └── server.key<br>├── renewed<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── reqs<br>│  └── server.req<br>├── revoked<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>├── serial<br>└── serial.old<br><br>12 directories, 14 files<br><br>[root@centos7 3]<span class="hljs-comment"># diff pki/certs_by_serial/EDAEBAB8D65066D307AE58ADC1A56682.pem pki/issued/server.crt</span><br><br><span class="hljs-comment">#ll !*</span><br>ll pki/certs_by_serial/EDAEBAB8D65066D307AE58ADC1A56682.pem<br>pki/issued/server.crt<br>-rw------- 1 root root 4608 Aug  2 17:19<br>pki/certs_by_serial/EDAEBAB8D65066D307AE58ADC1A56682.pem<br>-rw------- 1 root root 4608 Aug  2 17:19 pki/issued/server.crt<br><br>[root@centos7 3]<span class="hljs-comment"># cat pki/issued/server.crt</span><br>Certificate:<br> Data:<br>   Version: 3 (0x2)<br>   Serial Number:<br>     ed:ae:ba:b8:d6:50:66:d3:07:ae:58:ad:c1:a5:66:82<br>   Signature Algorithm: sha256WithRSAEncryption<br>   Issuer: CN=Easy-RSA CA<br>   Validity<br>     Not Before: Aug  2 09:19:43 2020 GMT<br>     Not After : Aug  2 09:19:43 2030 GMT<br>   Subject: CN=server<br>   Subject Public Key Info:<br>     Public Key Algorithm: rsaEncryption<br>       RSA Public-Key: (2048 bit)<br>       Modulus:<br>       00:e2:64:ae:f4:b2:5e:32:15:d6:4c:43:b3:24:79:<br>         d6:7c:44:5f:1b:d8:18:81:1a:e3:52:39:39:a3:11:<br>         c8:b8:ea:73:94:72:6f:af:ed:69:ab:4d:57:5e:53:<br>         e2:95:de:c4:c5:bd:58:77:ae:0e:56:a7:0b:46:81:<br>          13:b0:92:06:<span class="hljs-built_in">cd</span>:3a:f7:f7:ad:f2:39:4e:15:b4:16:<br>          24:8e:64:a6:bf:39:61:16:47:24:b1:67:3c:9a:d3:<br>         e3:e6:9e:f2:dc:9e:90:b3:14:95:af:00:b8:6a:e2:<br>         4a:83:3b:ff:5c:82:ef:5b:81:8f:b0:<span class="hljs-built_in">fc</span>:11:15:b6:<br>         2c:ac:e4:24:<span class="hljs-built_in">fc</span>:f8:15:6f:d6:8e:24:05:71:f7:63:<br>         dd:8e:62:eb:d3:11:33:d8:d4:5a:9e:6e:14:0d:f0:<br>         9a:db:3d:98:33:1f:a3:4e:aa:80:db:d1:63:1e:51:<br>          63:ac:ff:ca:9b:4c:3f:45:d7:e2:a1:11:a2:9c:ff:<br>         bd:fd:09:33:94:fd:da:96:4d:40:20:dc:1c:4f:1a:<br>         0d:52:93:ea:0d:30:6c:b6:b4:b6:7c:9e:f0:78:d7:<br>          44:2b:e2:90:fb:0b:20:e0:5f:fe:84:f2:3e:7f:d3:<br>         bf:88:f6:14:f2:a2:a0:7c:d1:bf:49:9e:c8:8f:51:<br>         d5:f0:08:c8:3f:e9:4f:b9:5b:27:a9:94:c5:74:9d:<br>         f4:5b<br>       Exponent: 65537 (0x10001)<br>   X509v3 extensions:<br>     X509v3 Basic Constraints:<br>       CA:FALSE<br>     X509v3 Subject Key Identifier:<br>       2B:96:04:F2:CC:99:52:8A:35:43:5A:AF:BC:8B:AE:F7:A4:21:19:AF<br>     X509v3 Authority Key Identifier:<br>     <br>keyid:EC:81:00:F2:39:73:8B:18:EE:D7:57:6F:8E:80:BA:E5:49:5A:EA:B2<br>       DirName:/CN=Easy-RSA CA<br>       <br>serial:7C:E0:68:54:3E:FB:55:8D:D6:23:A8:BE:5F:AB:54:6D:AC:AB:46:7A<br><br>     X509v3 Extended Key Usage:<br>       TLS Web Server Authentication<br>     X509v3 Key Usage:<br>       Digital Signature, Key Encipherment<br>     X509v3 Subject Alternative Name:<br>       DNS:server<br> Signature Algorithm: sha256WithRSAEncryption<br>    b4:1e:b2:57:2f:3d:6c:93:8f:38:7f:03:e6:50:51:50:35:51:<br>    21:ac:02:27:c4:01:68:8f:52:f9:55:7a:01:f3:8f:02:64:59:<br>    04:56:58:8c:44:43:31:f6:0e:0f:81:8a:97:3d:16:50:0a:40:<br>    5e:20:0c:18:23:d1:1c:3d:cf:92:9c:9f:75:62:58:e9:91:5f:<br>    7e:8a:a5:90:51:0e:34:5c:61:4b:00:7a:35:3b:3c:23:61:86:<br>    32:52:30:d3:50:de:51:e5:b8:b8:e5:3b:da:87:ce:94:1e:6b:<br>    c4:9e:f8:e2:a9:01:df:8a:21:38:8f:a9:09:81:87:<span class="hljs-built_in">fc</span>:9e:b0:<br>    a6:35:72:99:05:8e:06:a8:2b:49:ab:0b:89:92:<span class="hljs-built_in">fc</span>:fd:1a:02:<br>    20:23:c3:ef:d9:40:93:2e:b8:53:07:59:1e:94:7f:ec:41:55:<br>    2d:74:91:32:55:22:bb:da:b9:8b:4d:64:f0:ec:67:b5:9c:30:<br>    05:de:85:e1:9d:2e:31:86:66:0e:25:7c:82:a3:83:68:10:1b:<br>    a5:7a:45:f7:b7:e1:22:4b:0e:73:dd:14:6a:34:79:13:e6:10:<br>    62:2d:ff:44:8e:7b:ff:96:d7:40:5a:a6:ee:5b:53:e5:02:87:<br>    29:ab:5d:8c:fb:ed:16:38:7d:99:71:66:36:18:c0:e4:b9:a9:<br>    32:b8:ef:ce<br>-----BEGIN CERTIFICATE-----<br>MIIDaDCCAlCgAwIBAgIRAO2uurjWUGbTB65YrcGlZoIwDQYJKoZIhvcNAQELBQAw<br>FjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0EwHhcNMjAwODAyMDkxOTQzWhcNMjAxMDMx<br>MDkxOTQzWjARMQ8wDQYDVQQDDAZzZXJ2ZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IB<br>DwAwggEKAoIBAQDiZK70sl4yFdZMQ7MkedZ8RF8b2BiBGuNSOTmjEci46nOUcm+v<br>7WmrTVdeU+KV3sTFvVh3rg5WpwtGgROwkgbNOvf3rfI5ThW0FiSOZKa/OWEWRySx<br>Zzya0+PmnvLcnpCzFJWvALhq4kqDO/9cgu9bgY+w/BEVtiys5CT8+BVv1o4kBXH3<br>Y92OYuvTETPY1FqebhQN8JrbPZgzH6NOqoDb0WMeUWOs/8qbTD9F1+KhEaKc/739<br>CTOU/dqWTUAg3BxPGg1Sk+oNMGy2tLZ8nvB410Qr4pD7CyDgX/6E8j5/07+I9hTy<br>oqB80b9JnsiPUdXwCMg/6U+5WyeplMV0nfRbAgMBAAGjgbUwgbIwCQYDVR0TBAIw<br>ADAdBgNVHQ4EFgQUK5YE8syZUoo1Q1qvvIuu96QhGa8wUQYDVR0jBEowSIAU7IEA<br>8jlzixju11dvjoC65Ula6rKhGqQYMBYxFDASBgNVBAMMC0Vhc3ktUlNBIENBghR8<br>4GhUPvtVjdYjqL5fq1RtrKtGejATBgNVHSUEDDAKBggrBgEFBQcDATALBgNVHQ8E<br>BAMCBaAwEQYDVR0RBAowCIIGc2VydmVyMA0GCSqGSIb3DQEBCwUAA4IBAQC0HrJX<br>Lz1sk484fwPmUFFQNVEhrAInxAFoj1L5VXoB848CZFkEVliMREMx9g4PgYqXPRZQ<br>CkBeIAwYI9EcPc+SnJ91YljpkV9+iqWQUQ40XGFLAHo1OzwjYYYyUjDTUN5R5bi4<br>5Tvah86UHmvEnvjiqQHfiiE4j6kJgYf8nrCmNXKZBY4GqCtJqwuJkvz9GgIgI8Pv<br>2UCTLrhTB1kelH/sQVUtdJEyVSK72rmLTWTw7Ge1nDAF3oXhnS4xhmYOJXyCo4No<br>EBulekX3t+EiSw5z3RRqNHkT5hBiLf9Ejnv/ltdAWqbuW1PlAocpq12M++0WOH2Z<br>cWY2GMDkuakyuO/O<br>-----END CERTIFICATE-----<br><br><span class="hljs-comment">#证书相关文件</span><br>[root@centos7 3]<span class="hljs-comment"># cat pki/serial</span><br>EDAEBAB8D65066D307AE58ADC1A56683<br>[root@centos7 3]<span class="hljs-comment"># cat pki/index.txt</span><br>V 201031091943Z EDAEBAB8D65066D307AE58ADC1A56682 unknown /CN=server<br>[root@centos7 3]<span class="hljs-comment"># cat pki/serial.old</span><br>edaebab8d65066d307ae58adc1a56682<br></code></pre></td></tr></table></figure>

<h4 id="2-3-5-创建-Diffie-Hellman-密钥"><a href="#2-3-5-创建-Diffie-Hellman-密钥" class="headerlink" title="2.3.5 创建 Diffie-Hellman 密钥"></a>2.3.5 创建 Diffie-Hellman 密钥</h4><h5 id="2-3-5-1-Diffie-Hellman-算法"><a href="#2-3-5-1-Diffie-Hellman-算法" class="headerlink" title="2.3.5.1 Diffie-Hellman 算法"></a>2.3.5.1 Diffie-Hellman 算法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">Diffie-Hellman 密钥交换方法，由惠特菲尔德·迪菲（Bailey Whitfield Diffie）、马丁·赫尔曼<br>（Martin Edward Hellman）于1976年发表。它是一种安全协议，让双方在完全没有对方任何预先信息的条件下通过不安全信道建立起一个密钥，这个密钥一般作为“对称加密”的密钥而被双方在后续数据传输中使用。DH数学原理是base离散对数问题。做类似功能的还有非对称加密类算法，如：RSA。其应用非常广泛，在SSH、VPN、Https等都有应用。<br><br>wiki参考链接: https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange<br></code></pre></td></tr></table></figure>

<h5 id="2-3-5-2-创建-Diffie-Hellman-密钥"><a href="#2-3-5-2-创建-Diffie-Hellman-密钥" class="headerlink" title="2.3.5.2 创建 Diffie-Hellman 密钥"></a>2.3.5.2 创建 Diffie-Hellman 密钥</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>[root@centos7 3]<span class="hljs-comment"># /etc/openvpn/easy-rsa-server/3</span><br><br><span class="hljs-comment">#方法1</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-dh</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating DH parameters, 2048 bit long safe prime, generator 2<br>This is going to take a long time<br>................+..................................+............................<br>..........................++*++*++*++*<br>.......<span class="hljs-comment">#需要等待一会儿</span><br>DH parameters of size 2048 created at /etc/openvpn/easy-rsa-sever/3/pki/dh.pem<br><br><span class="hljs-comment">#查看生成的文件</span><br>[root@centos7 3]<span class="hljs-comment"># ll pki/dh.pem</span><br>-rw------- 1 root root 424 Aug  2 17:41 pki/dh.pem<br><br>[root@centos7 3]<span class="hljs-comment"># cat pki/dh.pem</span><br>-----BEGIN DH PARAMETERS-----<br>MIIBCAKCAQEAkOTKU13dlokdC6nPi/Saa3T0ubfb2k3YvbA+ZTSWKUPvtlzf7IC1<br>IF9XvWJO5jC7m2XL7Gld1i43GmUU+vYfyxQ9av6BgiT/Ug1BJbuQMtLzyS8O9zY/<br>nPw95ouT50y3SACe9BF+2mRm/91bX+XyrHG/XxpKpKN+6q1M4RwMFnE7iRpfUTUv<br>/DGml3pvLdtG7tMF5QOtmNlbRyA6iiuzABQ903tXQurOusQnDKolLp5DPgzSCKEQ<br>qMwMGapXzwtfk/wxsaiPHDh4Erjo4SMu4msRM9DY2Q6b5heidEihB5Ud0UXLSelg<br>vkqdEoqfWWzYZ5RKsugYgsIjc6uXhxxGiwIBAg==<br>-----END DH PARAMETERS-----<br><br><span class="hljs-comment">#方法2</span><br>[root@centos7 3]<span class="hljs-comment"># openssl dhparam -out /etc/openvpn/dh2048.pem 2048s</span><br>ll /etc/openvpn/dh2048.pem<br>-rw-r--r-- 1 root root 424 Aug  3 20:50 /etc/openvpn/dh2048.pem  <br></code></pre></td></tr></table></figure>

<h4 id="2-3-6-准备客户端证书环境"><a href="#2-3-6-准备客户端证书环境" class="headerlink" title="2.3.6 准备客户端证书环境"></a>2.3.6 准备客户端证书环境</h4><p><strong>上面服务端证书配置完成，下面是配置客户端证书</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 3]<span class="hljs-comment"># cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client</span><br><br>[root@centos7 3]<span class="hljs-comment"># cp /usr/share/doc/easy-rsa/vars.example /etc/openvpn//easy-rsa-client/3/vars</span><br><br>[root@centos7 3]<span class="hljs-comment"># cd /etc/openvpn//easy-rsa-client/3/</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>[root@centos7 3]<span class="hljs-comment"># /etc/openvpn/easy-rsa-client/3</span><br>[root@centos7 3]<span class="hljs-comment"># ls</span><br>easyrsa openssl-easyrsa.cnf vars x509-types<br><br>[root@centos7 3]<span class="hljs-comment"># tree</span><br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── vars<br>└── x509-types<br> ├── ca<br> ├── client<br> ├── code-signing<br> ├── COMMON<br> ├── email<br> ├── kdc<br> ├── server<br> └── serverClient<br> <br>1 directory, 11 files<br><br><span class="hljs-comment">#生成证书申请所需目录pki和文件</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa init-pki</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars<br><br>init-pki complete; you may now create a CA or requests.<br>Your newly created PKI dir is: /etc/openvpn/easy-rsa-client/3/pki  <span class="hljs-comment">#生成新目录</span><br><br>[root@centos7 3]<span class="hljs-comment"># tree</span><br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki                 <span class="hljs-comment">#生成新目录</span><br>│  ├── openssl-easyrsa.cnf<br>│  ├── private<br>│  ├── reqs<br>│  └── safessl-easyrsa.cnf<br>├── vars<br>└── x509-types<br> ├── ca<br> ├── client<br> ├── code-signing<br> ├── COMMON<br> ├── email<br> ├── kdc<br> ├── server<br> └── serverClient<br> <br>4 directories, 13 files<br></code></pre></td></tr></table></figure>

<h4 id="2-3-7-创建客户端证书申请"><a href="#2-3-7-创建客户端证书申请" class="headerlink" title="2.3.7 创建客户端证书申请"></a>2.3.7 创建客户端证书申请</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-client/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-client/3<br><span class="hljs-comment">#生成客户端用户的证书申请</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-req wangxiaochun nopass</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating a RSA private key<br>.......................................................+++++<br>................................................................................<br>.........................+++++<br>writing new private key to <span class="hljs-string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-</span><br><span class="hljs-string">3467.v5FPPS/tmp.GsttV6&#x27;</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [wangxiaochun]:  <span class="hljs-comment">#接受默认值,直接回车</span><br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-client/3/pki/reqs/wangxiaochun.req    <span class="hljs-comment">#私钥文件</span><br>key: /etc/openvpn/easy-rsa-client/3/pki/private/wangxiaochun.key   <span class="hljs-comment">#证书申请文件</span><br><br><span class="hljs-comment">#生成两个新文件</span><br>[root@centos7 3]<span class="hljs-comment"># tree</span><br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki<br>│  ├── openssl-easyrsa.cnf<br>│  ├── private<br>│  │  └── wangxiaochun.key  <span class="hljs-comment">#私钥文件</span><br>│  ├── reqs<br>│  │  └── wangxiaochun.req  <span class="hljs-comment">#证书申请文件</span><br>│  └── safessl-easyrsa.cnf<br>├── vars<br>└── x509-types<br> ├── ca<br> ├── client<br> ├── code-signing<br> ├── COMMON<br> ├── email<br> ├── kdc<br> ├── server<br> └── serverClient<br>4 directories, 15 files<br></code></pre></td></tr></table></figure>

<h4 id="2-3-8-签发客户端证书"><a href="#2-3-8-签发客户端证书" class="headerlink" title="2.3.8 签发客户端证书"></a>2.3.8 签发客户端证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-server/3<br><span class="hljs-comment">#将客户端证书请求文件复制到CA的工作目录</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/wangxiaochun.req wangxiaochun</span><br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br><br>The request has been successfully imported with a short name of: wangxiaochun<br>You may now use this name to perform signing operations on this request.<br><br>[root@centos7 3]<span class="hljs-comment"># tree pki</span><br>pki<br>├── ca.crt<br>├── certs_by_serial<br>│  └── EDAEBAB8D65066D307AE58ADC1A56682.pem<br>├── dh.pem<br>├── index.txt<br>├── index.txt.attr<br>├── index.txt.attr.old<br>├── index.txt.old<br>├── issued<br>│  └── server.crt<br>├── openssl-easyrsa.cnf<br>├── private<br>│  ├── ca.key<br>│  └── server.key<br>├── renewed<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── reqs<br>│  ├── server.req<br>│  └── wangxiaochun.req  <span class="hljs-comment">#导入文件</span><br>├── revoked<br>│  ├── certs_by_serial<br>│  ├── private_by_serial<br>│  └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>├── serial<br>└── serial.old<br><br>12 directories, 16 files<br><br>[root@centos7 3]<span class="hljs-comment"># ll pki/reqs/wangxiaochun.req /etc/openvpn/easy-rsa-client/3/pki/reqs/wangxiaochun.req</span><br>-rw------- 1 root root 895 Aug  2 23:22 /etc/openvpn/easy-rsa-<br>client/3/pki/reqs/wangxiaochun.req<br>-rw------- 1 root root 895 Aug  2 23:30 pki/reqs/wangxiaochun.req<br><br><span class="hljs-comment">#修改给客户端颁发的证书的有效期</span><br>[root@centos7 3]<span class="hljs-comment"># vim vars</span><br><span class="hljs-comment">#建议修改给客户端颁发证书的有效期,可适当减少,比如:90天</span><br><span class="hljs-comment">#set_var EASYRSA_CERT_EXPIRE  825</span><br><span class="hljs-comment">#将上面行修改为下面</span><br>set_var EASYRSA_CERT_EXPIRE 90<br><br><span class="hljs-comment">#签发客户端证书</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa sign client wangxiaochun</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br><br>You are about to sign the following certificate.<br>Please check over the details shown below <span class="hljs-keyword">for</span> accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br><span class="hljs-built_in">source</span> or that you have verified the request checksum with the sender.<br><br>Request subject, to be signed as a client certificate <span class="hljs-keyword">for</span> 90 days:<br><br>subject=<br> commonName         = wangxiaochun<br> <br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Confirm request details: yes            <span class="hljs-comment">#输入yes后回车</span><br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-<br>3617.XN7fIU/tmp.P7NKo8<br>Check that the request matches the signature<br>Signature ok<br>The Subject<span class="hljs-string">&#x27;s Distinguished Name is as follows</span><br><span class="hljs-string">commonName      :ASN.1 12:&#x27;</span>wangxiaochun<span class="hljs-string">&#x27;</span><br><span class="hljs-string">Certificate is to be certified until Oct 31 15:38:15 2020 GMT (90 days)</span><br><span class="hljs-string"></span><br><span class="hljs-string">Write out database with 1 new entries</span><br><span class="hljs-string">Data Base Updated</span><br><span class="hljs-string"></span><br><span class="hljs-string">Certificate created at: /etc/openvpn/easy-rsa-</span><br><span class="hljs-string">server/3/pki/issued/wangxiaochun.crt #证书文件</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# tree pki</span><br><span class="hljs-string">pki</span><br><span class="hljs-string">├── ca.crt</span><br><span class="hljs-string">├── certs_by_serial</span><br><span class="hljs-string">│  ├── 5FE114ACC4FE6AB89D17E1B0EECF2B78.pem</span><br><span class="hljs-string">│  └── EDAEBAB8D65066D307AE58ADC1A56682.pem</span><br><span class="hljs-string">├── dh.pem</span><br><span class="hljs-string">├── index.txt</span><br><span class="hljs-string">├── index.txt.attr</span><br><span class="hljs-string">├── index.txt.attr.old</span><br><span class="hljs-string">├── index.txt.old</span><br><span class="hljs-string">├── issued</span><br><span class="hljs-string">│  ├── server.crt</span><br><span class="hljs-string">│  └── wangxiaochun.crt #生成客户端证书</span><br><span class="hljs-string">├── openssl-easyrsa.cnf</span><br><span class="hljs-string">├── private</span><br><span class="hljs-string">│  ├── ca.key</span><br><span class="hljs-string">│  └── server.key</span><br><span class="hljs-string">├── renewed</span><br><span class="hljs-string">│  ├── certs_by_serial</span><br><span class="hljs-string">│  ├── private_by_serial</span><br><span class="hljs-string">│  └── reqs_by_serial</span><br><span class="hljs-string">├── reqs</span><br><span class="hljs-string">│  ├── server.req</span><br><span class="hljs-string">│  └── wangxiaochun.req</span><br><span class="hljs-string">├── revoked</span><br><span class="hljs-string">│  ├── certs_by_serial</span><br><span class="hljs-string">│  ├── private_by_serial</span><br><span class="hljs-string">│  └── reqs_by_serial</span><br><span class="hljs-string">├── safessl-easyrsa.cnf</span><br><span class="hljs-string">├── serial</span><br><span class="hljs-string">└── serial.old</span><br><span class="hljs-string">12 directories, 18 files</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# cat pki/index.txt</span><br><span class="hljs-string">V 201031091943Z EDAEBAB8D65066D307AE58ADC1A56682 unknown /CN=server</span><br><span class="hljs-string">V 201031153815Z 5FE114ACC4FE6AB89D17E1B0EECF2B78 unknown /CN=wangxiaochun</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# ll pki/issued/</span><br><span class="hljs-string">total 16</span><br><span class="hljs-string">-rw------- 1 root root 4608 Aug  2 17:19 server.crt</span><br><span class="hljs-string">-rw------- 1 root root 4506 Aug  2 23:38 wangxiaochun.crt</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# ll pki/certs_by_serial/</span><br><span class="hljs-string">total 16</span><br><span class="hljs-string">-rw------- 1 root root 4506 Aug  2 23:38 5FE114ACC4FE6AB89D17E1B0EECF2B78.pem</span><br><span class="hljs-string">-rw------- 1 root root 4608 Aug  2 17:19 EDAEBAB8D65066D307AE58ADC1A56682.pem</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# cat pki/issued/wangxiaochun.crt</span><br><span class="hljs-string">Certificate:</span><br><span class="hljs-string"> Data:</span><br><span class="hljs-string">   Version: 3 (0x2)</span><br><span class="hljs-string">   Serial Number:</span><br><span class="hljs-string">     5f:e1:14:ac:c4:fe:6a:b8:9d:17:e1:b0:ee:cf:2b:78</span><br><span class="hljs-string">   Signature Algorithm: sha256WithRSAEncryption</span><br><span class="hljs-string">   Issuer: CN=Easy-RSA CA</span><br><span class="hljs-string">   Validity</span><br><span class="hljs-string">     Not Before: Aug  2 15:38:15 2020 GMT</span><br><span class="hljs-string">     Not After : Oct 31 15:38:15 2020 GMT</span><br><span class="hljs-string">   Subject: CN=wangxiaochun</span><br><span class="hljs-string">   Subject Public Key Info:</span><br><span class="hljs-string">     Public Key Algorithm: rsaEncryption</span><br><span class="hljs-string">       RSA Public-Key: (2048 bit)</span><br><span class="hljs-string">       Modulus:</span><br><span class="hljs-string">          00:c9:86:68:4d:2b:b6:4d:f7:e0:05:97:01:fa:e0:</span><br><span class="hljs-string">         8d:a8:83:4c:67:e4:59:16:a8:78:37:85:8b:cf:74:</span><br><span class="hljs-string">          29:ca:24:71:27:c6:ff:71:ac:e6:2f:66:93:62:fb:</span><br><span class="hljs-string">          28:6b:c3:4a:b6:5e:9f:e8:14:a3:73:f8:f5:27:7a:</span><br><span class="hljs-string">         a3:80:4e:b3:51:e8:f8:92:63:a6:4a:f4:82:17:01:</span><br><span class="hljs-string">          26:a8:ad:ea:79:53:c0:51:ab:f6:82:d2:ae:26:27:</span><br><span class="hljs-string">          cd:67:ef:65:a3:60:1a:3d:4f:09:8f:22:74:c7:79:</span><br><span class="hljs-string">         b4:50:19:78:9c:4e:b3:d7:5f:ff:cb:3a:9a:b3:e5:</span><br><span class="hljs-string">         1c:75:b2:46:55:c4:c9:a5:8b:40:db:3d:75:a5:33:</span><br><span class="hljs-string">         d0:cf:97:bb:bc:d8:f1:57:f1:60:e2:a6:b9:bb:6c:</span><br><span class="hljs-string">          30:fd:d2:15:c4:f8:56:b0:31:c8:c8:2f:36:96:e7:</span><br><span class="hljs-string">          45:12:17:05:dd:bf:f2:1d:37:7b:be:de:df:f1:4c:</span><br><span class="hljs-string">         a9:e0:8a:a3:ea:96:6d:17:04:0b:1d:11:7f:96:97:</span><br><span class="hljs-string">         5e:f3:64:58:7c:8c:d8:f0:fa:20:31:9e:53:d4:1f:</span><br><span class="hljs-string">         7b:0b:39:2b:81:78:84:4e:81:34:42:c7:64:fb:ed:</span><br><span class="hljs-string">         9f:47:8b:34:10:80:56:f1:db:48:8f:f8:d4:49:a7:</span><br><span class="hljs-string">         f0:1c:50:9f:7a:e7:38:e4:a5:0f:cf:5b:eb:23:17:</span><br><span class="hljs-string">          23:59</span><br><span class="hljs-string">       Exponent: 65537 (0x10001)</span><br><span class="hljs-string">   X509v3 extensions:</span><br><span class="hljs-string">     X509v3 Basic Constraints:</span><br><span class="hljs-string">       CA:FALSE</span><br><span class="hljs-string">     X509v3 Subject Key Identifier:</span><br><span class="hljs-string">        33:B6:15:7C:7B:F5:C4:5C:97:4D:1F:0E:94:2D:1C:79:64:36:2E:39</span><br><span class="hljs-string">     X509v3 Authority Key Identifier:</span><br><span class="hljs-string">      </span><br><span class="hljs-string">keyid:EC:81:00:F2:39:73:8B:18:EE:D7:57:6F:8E:80:BA:E5:49:5A:EA:B2</span><br><span class="hljs-string">       DirName:/CN=Easy-RSA CA</span><br><span class="hljs-string">      </span><br><span class="hljs-string">serial:7C:E0:68:54:3E:FB:55:8D:D6:23:A8:BE:5F:AB:54:6D:AC:AB:46:7A</span><br><span class="hljs-string">     X509v3 Extended Key Usage:</span><br><span class="hljs-string">       TLS Web Client Authentication</span><br><span class="hljs-string">     X509v3 Key Usage:</span><br><span class="hljs-string">       Digital Signature</span><br><span class="hljs-string"> Signature Algorithm: sha256WithRSAEncryption</span><br><span class="hljs-string">    72:85:bf:0f:02:66:15:06:9d:60:8e:8f:99:54:63:4a:de:cc:</span><br><span class="hljs-string">    15:cb:a5:67:4b:15:90:09:c9:ff:bb:58:ec:c6:4d:39:b1:2b:</span><br><span class="hljs-string">    81:3c:cc:46:b8:0c:ab:10:b5:5a:1e:76:df:ed:56:1b:f5:77:</span><br><span class="hljs-string">    72:ff:b9:14:1e:9d:06:7d:a6:7a:04:6d:79:ab:25:38:36:67:</span><br><span class="hljs-string">    32:6b:ec:9b:95:67:7c:8b:3b:5a:e1:2d:97:85:a3:e5:91:da:</span><br><span class="hljs-string">    c2:eb:28:2e:d3:98:10:25:34:d1:2d:99:b9:64:d3:96:fa:c7:</span><br><span class="hljs-string">    69:2e:f0:58:78:9e:63:03:89:86:04:3c:9c:7f:cb:33:0e:95:</span><br><span class="hljs-string">    af:99:56:96:c9:73:9a:3a:ef:3b:7c:fc:92:f9:25:ac:63:46:</span><br><span class="hljs-string">    68:83:76:bf:4a:bf:8a:1d:6b:75:27:7a:40:3b:15:d2:53:29:</span><br><span class="hljs-string">    01:58:14:cf:9f:cb:25:81:47:ae:76:ba:1c:95:74:96:16:f5:</span><br><span class="hljs-string">    ee:5f:71:a7:32:b1:6b:0a:e8:c5:c0:e9:29:b4:45:b5:71:91:</span><br><span class="hljs-string">    6e:8d:be:48:99:c5:33:97:12:db:cb:60:6c:06:ed:5c:a9:23:</span><br><span class="hljs-string">    ee:40:a7:bc:00:bd:96:ed:9b:57:f0:49:b2:07:dc:dc:d7:06:</span><br><span class="hljs-string">    ce:08:18:5e:28:13:24:e5:0b:8d:e9:d4:45:f0:11:30:70:2d:</span><br><span class="hljs-string">    e4:a5:79:92</span><br><span class="hljs-string">-----BEGIN CERTIFICATE-----</span><br><span class="hljs-string">MIIDWjCCAkKgAwIBAgIQX+EUrMT+aridF+Gw7s8reDANBgkqhkiG9w0BAQsFADAW</span><br><span class="hljs-string">MRQwEgYDVQQDDAtFYXN5LVJTQSBDQTAeFw0yMDA4MDIxNTM4MTVaFw0yMDEwMzEx</span><br><span class="hljs-string">NTM4MTVaMBcxFTATBgNVBAMMDHdhbmd4aWFvY2h1bjCCASIwDQYJKoZIhvcNAQEB</span><br><span class="hljs-string">BQADggEPADCCAQoCggEBAMmGaE0rtk334AWXAfrgjaiDTGfkWRaoeDeFi890Kcok</span><br><span class="hljs-string">cSfG/3Gs5i9mk2L7KGvDSrZen+gUo3P49Sd6o4BOs1Ho+JJjpkr0ghcBJqit6nlT</span><br><span class="hljs-string">wFGr9oLSriYnzWfvZaNgGj1PCY8idMd5tFAZeJxOs9df/8s6mrPlHHWyRlXEyaWL</span><br><span class="hljs-string">QNs9daUz0M+Xu7zY8VfxYOKmubtsMP3SFcT4VrAxyMgvNpbnRRIXBd2/8h03e77e</span><br><span class="hljs-string">3/FMqeCKo+qWbRcECx0Rf5aXXvNkWHyM2PD6IDGeU9Qfews5K4F4hE6BNELHZPvt</span><br><span class="hljs-string">n0eLNBCAVvHbSI/41Emn8BxQn3rnOOSlD89b6yMXI1kCAwEAAaOBojCBnzAJBgNV</span><br><span class="hljs-string">HRMEAjAAMB0GA1UdDgQWBBQzthV8e/XEXJdNHw6ULRx5ZDYuOTBRBgNVHSMESjBI</span><br><span class="hljs-string">gBTsgQDyOXOLGO7XV2+OgLrlSVrqsqEapBgwFjEUMBIGA1UEAwwLRWFzeS1SU0Eg</span><br><span class="hljs-string">Q0GCFHzgaFQ++1WN1iOovl+rVG2sq0Z6MBMGA1UdJQQMMAoGCCsGAQUFBwMCMAsG</span><br><span class="hljs-string">A1UdDwQEAwIHgDANBgkqhkiG9w0BAQsFAAOCAQEAcoW/DwJmFQadYI6PmVRjSt7M</span><br><span class="hljs-string">FculZ0sVkAnJ/7tY7MZNObErgTzMRrgMqxC1Wh523+1WG/V3cv+5FB6dBn2megRt</span><br><span class="hljs-string">easlODZnMmvsm5VnfIs7WuEtl4Wj5ZHawusoLtOYECU00S2ZuWTTlvrHaS7wWHie</span><br><span class="hljs-string">YwOJhgQ8nH/LMw6Vr5lWlslzmjrvO3z8kvklrGNGaIN2v0q/ih1rdSd6QDsV0lMp</span><br><span class="hljs-string">AVgUz5/LJYFHrna6HJV0lhb17l9xpzKxawroxcDpKbRFtXGRbo2+SJnFM5cS28tg</span><br><span class="hljs-string">bAbtXKkj7kCnvAC9lu2bV/BJsgfc3NcGzggYXigTJOULjenURfARMHAt5KV5kg==</span><br><span class="hljs-string">-----END CERTIFICATE-----</span><br></code></pre></td></tr></table></figure>

<p>如果需要颁发的客户端证书较多,可以使用下面脚本实现客户端证书的批量颁发</p>
<p><strong>客户端证书自动颁发脚本</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat openvpn-user-crt.sh<br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#Author: wangxiaochun</span><br><span class="hljs-comment">#QQ: 29308620</span><br><span class="hljs-comment">#Date: 2020-08-02</span><br><span class="hljs-comment">#FileName： openvpn-user-crt.sh</span><br><span class="hljs-comment">#URL: http://www.wangxiaochun.com</span><br><span class="hljs-comment">#Description： The test script</span><br><span class="hljs-comment">#Copyright (C): 2020 All rights reserved</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入用户的姓名拼音(如:<span class="hljs-variable">$&#123;NAME&#125;</span>): &quot;</span> NAME<br><span class="hljs-built_in">cd</span> /etc/openvpn/easy-rsa-client/3<br>./easyrsa gen-req <span class="hljs-variable">$&#123;NAME&#125;</span> nopass &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-built_in">cd</span> /etc/openvpn/easy-rsa-server/3<br>./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="hljs-variable">$&#123;NAME&#125;</span>.req <span class="hljs-variable">$&#123;NAME&#125;</span><br><br>./easyrsa sign client <span class="hljs-variable">$&#123;NAME&#125;</span> &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">yes</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-9-将ca和服务器证书相关文件复制到服务器相应的目录"><a href="#2-3-9-将ca和服务器证书相关文件复制到服务器相应的目录" class="headerlink" title="2.3.9 将ca和服务器证书相关文件复制到服务器相应的目录"></a>2.3.9 将ca和服务器证书相关文件复制到服务器相应的目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 3]<span class="hljs-comment"># mkdir /etc/openvpn/certs</span><br><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/</span><br><br>[root@centos7 3]<span class="hljs-comment"># ll /etc/openvpn/certs/</span><br>total 20<br>-rw------- 1 root root 1204 Aug  3 20:34 ca.crt<br>-rw------- 1 root root  424 Aug  3 20:35 dh.pem<br>-rw------- 1 root root 4608 Aug  3 20:34 server.crt<br>-rw------- 1 root root 1704 Aug  3 20:35 server.key<br></code></pre></td></tr></table></figure>

<h4 id="2-3-10-将客户端私钥与证书相关文件复制到服务器相关的目录"><a href="#2-3-10-将客户端私钥与证书相关文件复制到服务器相关的目录" class="headerlink" title="2.3.10 将客户端私钥与证书相关文件复制到服务器相关的目录"></a>2.3.10 将客户端私钥与证书相关文件复制到服务器相关的目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 3]<span class="hljs-comment"># mkdir /etc/openvpn/client/wangxiaochun/</span><br><br>[root@centos7 3]<span class="hljs-comment"># find /etc/openvpn/ -name &quot;wangxiaochun.key&quot; -o -name &quot;wangxiaochun.crt&quot; -o -name ca.crt</span><br>/etc/openvpn/easy-rsa-client/3.0.7/pki/private/wangxiaochun.key<br>/etc/openvpn/easy-rsa-server/3.0.7/pki/issued/wangxiaochun.crt<br>/etc/openvpn/easy-rsa-server/3.0.7/pki/ca.crt<br>/etc/openvpn/certs/ca.crt<br><br>[root@centos7 3]<span class="hljs-comment"># find /etc/openvpn/ \( -name &quot;wangxiaochun.key&quot; -o -name &quot;wangxiaochun.crt&quot; -o -name ca.crt \) -exec cp &#123;&#125; /etc/openvpn/client/wangxiaochun \;</span><br><br>[root@centos7 3]<span class="hljs-comment"># ll /etc/openvpn/client/wangxiaochun/</span><br>total 16<br>-rw------- 1 root root 1204 Aug  3 21:05 ca.crt<br>-rw------- 1 root root 4506 Aug  3 21:05 wangxiaochun.crt<br>-rw------- 1 root root 1704 Aug  3 21:05 wangxiaochun.key<br></code></pre></td></tr></table></figure>

<h3 id="2-4-准备-OpenVPN-服务器配置文件"><a href="#2-4-准备-OpenVPN-服务器配置文件" class="headerlink" title="2.4 准备 OpenVPN 服务器配置文件"></a>2.4 准备 OpenVPN 服务器配置文件</h3><h3 id="2-4-1-服务器端配置文件说明"><a href="#2-4-1-服务器端配置文件说明" class="headerlink" title="2.4.1 服务器端配置文件说明"></a>2.4.1 服务器端配置文件说明</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#server.conf文件中以#或;开头的行都为注释</span><br><span class="hljs-comment">#grep -Ev &quot;^#|^$&quot; /etc/openvpn/server.conf</span><br>;<span class="hljs-built_in">local</span> a.b.c.d  <span class="hljs-comment">#本机监听IP,默认为本机所有IP</span><br>port 1194    <span class="hljs-comment">#端口</span><br>;proto tcp    <span class="hljs-comment">#协议,生产推荐使用TCP</span><br>proto udp <span class="hljs-comment">#默认协议</span><br>;dev tap  <span class="hljs-comment">#创建一个以太网隧道，以太网使用tap,一个tap设备允许完整的以太网帧通过Openvpn隧道，可提供非ip协议的支持，比如IPX协议和AppleTalk协议,tap等同于一个以太网设备，它操作第二层数据包如以太网数据帧。</span><br>dev tun   <span class="hljs-comment">#创建一个路由IP隧道，生产推存使用tun.互联网使用tun,一个tun设备大多时候，被用于基于IP协议的通讯。tun模拟了网络层设备，操作第三层数据包比如IP数据封包。</span><br>;dev-node MyTap  <span class="hljs-comment">#TAP-Win32适配器。非windows不需要配置</span><br>ca ca.crt    <span class="hljs-comment">#ca证书文件</span><br>cert server.crt  <span class="hljs-comment">#服务器证书文件</span><br>key server.key  <span class="hljs-comment">#服务器私钥文件</span><br>dh dh2048.pem   <span class="hljs-comment">#dh参数文件</span><br>;topology subnet<br>server 10.8.0.0 255.255.255.0  <span class="hljs-comment">#客户端连接后分配IP的地址池，服务器默认会占用第一个IP10.8.0.1将做为客户端的网关</span><br>ifconfig-pool-persist ipp.txt  <span class="hljs-comment">#为客户端分配固定IP，不需要配置,建议注释</span><br>;server-bridge 10.8.0.4 255.255.255.0 10.8.0.50 10.8.0.100  <span class="hljs-comment">#配置网桥模式，不需要配置,建议注释</span><br>;server-bridge<br>;push <span class="hljs-string">&quot;route 192.168.10.0 255.255.255.0&quot;</span>  <span class="hljs-comment">#给客户端生成的到达服务器后面网段的静态路由，</span><br>下一跳为openvpn服务器的10.8.0.1<br>;push <span class="hljs-string">&quot;route 192.168.20.0 255.255.255.0&quot;</span>  <span class="hljs-comment">#推送路由信息到客户端，以允许客户端能够连接到服务器背后的其它私有子网</span><br>;client-config-dir ccd <span class="hljs-comment">#为指定的客户端添加路由，此路由通常是客户端后面的内网</span><br>网段而不是服务端的，也不需要设置<br>;route 192.168.40.128 255.255.255.248<br>;client-config-dir ccd  <br>;route 10.9.0.0 255.255.255.252<br>;learn-address ./script         <span class="hljs-comment">#运行外部脚本，创建不同组的iptables规则，无需配置</span><br>;push <span class="hljs-string">&quot;redirect-gateway def1 bypass-dhcp&quot;</span> <span class="hljs-comment">#启用后，客户端所有流量都将通过VPN服务器，因此生产一般无需配置此项</span><br>;push <span class="hljs-string">&quot;dhcp-option DNS 208.67.222.222&quot;</span>  <span class="hljs-comment">#推送DNS服务器，不需要配置</span><br>;push <span class="hljs-string">&quot;dhcp-option DNS 208.67.220.220&quot;</span><br>;client-to-client            <span class="hljs-comment">#允许不同的client直接通信,不安全,生产环境一般无需要配置</span><br>;duplicate-cn              <span class="hljs-comment">#多个用户共用一个证书，一般用于测试环境，生产环境都是一个用户一个证书,无需开启</span><br>keepalive 10 120     <span class="hljs-comment">#设置服务端检测的间隔和超时时间，默认为每10秒ping一次，如果 120秒没有回应则认为对方已经down</span><br>tls-auth ta.key 0 <span class="hljs-comment">#访止DoS等攻击的安全增强配置,可以使用以下命令来生成：openvpn --</span><br>genkey --secret ta.key <span class="hljs-comment">#服务器和每个客户端都需要拥有该密钥的一个拷贝。第二个参数在服务器端应该为’0’，在客户端应该为’1’</span><br>cipher AES-256-CBC  <span class="hljs-comment">#加密算法</span><br>;compress lz4-v2   <span class="hljs-comment">#启用Openvpn2.4.X新版压缩算法</span><br>;push <span class="hljs-string">&quot;compress lz4-v2&quot;</span>  <span class="hljs-comment">#推送客户端使用新版压缩算法,和下面的comp-lzo不要同时使用</span><br>;comp-lzo      <span class="hljs-comment">#旧户端兼容的压缩配置，需要客户端配置开启压缩,openvpn2.4.X等新版可以不用开启</span><br>;max-clients 100  <span class="hljs-comment">#最大客户端数</span><br>;user nobody     <span class="hljs-comment">#运行openvpn服务的用户和组</span><br>;group nobody<br>persist-key      <span class="hljs-comment">#重启VPN服务时默认会重新读取key文件，开启此配置后保留使用第一次的key文件,生产环境无需开启</span><br>persist-tun      <span class="hljs-comment">#启用此配置后,当重启vpn服务时，一直保持tun或者tap设备是up的，否则会先down然后再up,生产环境无需开启</span><br>status openvpn-status.log <span class="hljs-comment">#openVPN状态记录文件，每分钟会记录一次</span><br>;<span class="hljs-built_in">log</span>     openvpn.log  <span class="hljs-comment">#第一种日志记录方式,并指定日志路径，log会在openvpn启动的时候清空日志文件,不建议使用</span><br>;log-append openvpn.log  <span class="hljs-comment">#第二种日志记录方式,并指定日志路径，重启openvpn后在之前的日志后面追加新的日志,生产环境建议使用</span><br>verb 3          <span class="hljs-comment">#设置日志级别，0-9，级别越高记录的内容越详细,0 表示静默运行，只记录致命错误,4 表示合理的常规用法,5 和 6 可以帮助调试连接错误。9 表示极度冗余，输出非常详细的日志信息</span><br><br>;mute 20         <span class="hljs-comment">#相同类别的信息只有前20条会输出到日志文件中</span><br>explicit-exit-notify 1  <span class="hljs-comment">#通知客户端，在服务端重启后自动重新连接，仅能用于udp模式，tcp模式不需要配置即可实现断开重新连接,且开启此项后tcp配置后将导致openvpn服务无法启动,所以tcp时必须不能开启此项</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-2-修改服务器端配置文件"><a href="#2-4-2-修改服务器端配置文件" class="headerlink" title="2.4.2 修改服务器端配置文件"></a>2.4.2 修改服务器端配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#参照/usr/share/doc/openvpn-2.4.10/sample/sample-config-files文件</span><br>[root@centos7 ~]<span class="hljs-comment"># vim /etc/openvpn/server.conf #这里可以将原来的文件备份后，删除原来文件的所有内容，粘贴下来</span><br>port 1194<br>proto tcp<br>dev tun<br>ca /etc/openvpn/certs/ca.crt<br>cert /etc/openvpn/certs/server.crt<br>key /etc/openvpn/certs/server.key  <span class="hljs-comment"># This file should be kept secret</span><br>dh /etc/openvpn/certs/dh.pem<br>server 10.8.0.0 255.255.255.0<br>push <span class="hljs-string">&quot;route 172.30.0.0 255.255.255.0&quot;</span><br>keepalive 10 120<br>cipher AES-256-CBC<br>compress lz4-v2<br>push <span class="hljs-string">&quot;compress lz4-v2&quot;</span><br>max-clients 2048<br>user openvpn<br>group openvpn<br>status /var/<span class="hljs-built_in">log</span>/openvpn/openvpn-status.log<br>log-append /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log<br>verb 3<br>mute 20<br><br><span class="hljs-comment">#准备目志相关目录</span><br>[root@centos7 ~]<span class="hljs-comment"># getent passwd openvpn</span><br>openvpn:x:993:990:OpenVPN:/etc/openvpn:/sbin/nologin<br>[root@centos7 ~]<span class="hljs-comment"># mkdir /var/log/openvpn</span><br>[root@centos7 ~]<span class="hljs-comment"># chown openvpn.openvpn /var/log/openvpn</span><br>[root@centos7 ~]<span class="hljs-comment"># ll -d /var/log/openvpn</span><br>drwxr-xr-x 2 openvpn openvpn 6 Aug  3 23:07 /var/<span class="hljs-built_in">log</span>/openvpn<br></code></pre></td></tr></table></figure>

<h3 id="2-5-准备-iptables-规则和内核参数"><a href="#2-5-准备-iptables-规则和内核参数" class="headerlink" title="2.5 准备 iptables 规则和内核参数"></a>2.5 准备 iptables 规则和内核参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在服务器开启ip_forward转发功能</span><br>[root@centos7 ~]<span class="hljs-comment"># echo net.ipv4.ip_forward = 1 &gt;&gt; /etc/sysctl.conf</span><br>root@centos7 ~]<span class="hljs-comment"># sysctl -p</span><br>net.ipv4.ip_forward = 1<br><br><span class="hljs-comment">#添加SNAT规则</span><br>[root@centos7 ~]<span class="hljs-comment"># echo &#x27;iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE&#x27; &gt;&gt; /etc/rc.d/rc.local</span><br>[root@centos7 ~]<span class="hljs-comment"># chmod +x /etc/rc.d/rc.local</span><br>[root@centos7 ~]<span class="hljs-comment"># /etc/rc.d/rc.local</span><br>[root@centos7 ~]<span class="hljs-comment"># iptables -vnL</span><br><br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br><br>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br>   <br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br><br>[root@centos7 ~]<span class="hljs-comment"># iptables -vnL -t nat</span><br>Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br>   <br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br>   <br>Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br>   <br>  0   0 MASQUERADE all  -- *   *    10.8.0.0/24      0.0.0.0/0 <br>   <br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br>pkts bytes target   prot opt <span class="hljs-keyword">in</span>   out   <span class="hljs-built_in">source</span>        destination<br></code></pre></td></tr></table></figure>

<h3 id="2-6-启动-OpenVPN-服务"><a href="#2-6-启动-OpenVPN-服务" class="headerlink" title="2.6 启动 OpenVPN 服务"></a>2.6 启动 OpenVPN 服务</h3><h4 id="2-6-1-启动-OpenVPN-服务"><a href="#2-6-1-启动-OpenVPN-服务" class="headerlink" title="2.6.1 启动 OpenVPN 服务"></a>2.6.1 启动 OpenVPN 服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># rpm -ql openvpn|grep systemd</span><br>/usr/lib/systemd/system/openvpn-client@.service<br>/usr/lib/systemd/system/openvpn-server@.service<br>/usr/lib/systemd/system/openvpn@.service<br>/usr/share/doc/openvpn-2.4.9/README.systemd<br><span class="hljs-comment">#CentOS8 缺失unit文件,从CentOS7复制文件</span><br>[root@centos7 ~]<span class="hljs-comment"># rpm -ql openvpn|grep systemd</span><br>/usr/lib/systemd/system/openvpn-client@.service<br>/usr/lib/systemd/system/openvpn-server@.service<br>/usr/share/doc/openvpn/README.systemd<br><br>[root@centos7 ~]<span class="hljs-comment"># cat /usr/lib/systemd/system/openvpn@.service</span><br>[Unit]<br>Description=OpenVPN Robust And Highly Flexible Tunneling Application On %I<br>After=network.target<br>[Service]<br>Type=notify<br>PrivateTmp=<span class="hljs-literal">true</span><br>ExecStart=/usr/sbin/openvpn --<span class="hljs-built_in">cd</span> /etc/openvpn/ --config %i.conf<br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment">#centos8</span><br>[root@centos8 ~]<span class="hljs-comment"># scp /lib/systemd/system/openvpn@.service 10.0.0.8:/lib/systemd/system/</span><br><br>[root@centos7 ~]<span class="hljs-comment"># systemctl daemon-reload</span><br><br>[root@centos7 ~]<span class="hljs-comment"># systemctl enable --now openvpn@server</span><br><span class="hljs-comment">#如启动有错误请安装以下依赖包</span><br>yum install -y lz4-devel lzo-devel pam-devel openssl-devel systemd-devel sqlite-devel<br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-查看服务状态"><a href="#2-6-2-查看服务状态" class="headerlink" title="2.6.2 查看服务状态"></a>2.6.2 查看服务状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># systemctl status  openvpn@server</span><br>● openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling<br>Application On server<br> Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; enabled; vendor<br>preset: disabled)<br> Active: active (running) since Tue 2020-08-04 00:30:12 CST; 31s ago<br>Main PID: 7340 (openvpn)<br> Status: <span class="hljs-string">&quot;Initialization Sequence Completed&quot;</span><br> Tasks: 1 (<span class="hljs-built_in">limit</span>: 5882)<br> Memory: 2.4M<br> CGroup: /system.slice/system-openvpn.slice/openvpn@server.service<br>     └─7340 /usr/sbin/openvpn --<span class="hljs-built_in">cd</span> /etc/openvpn/ --config server.conf<br>     <br>Aug 04 00:30:12 centos8.wangxiaochun.com systemd[1]: Starting OpenVPN Robust And<br>Highly Flexible Tunneling Application &gt;<br>Aug 04 00:30:12 centos8.wangxiaochun.com systemd[1]: Started OpenVPN Robust And<br>Highly Flexible Tunneling Application<br><br><span class="hljs-comment">#注意端口号</span><br>[root@centos7 ~]<span class="hljs-comment"># ss -ntlp</span><br>State  Recv-Q  Send-Q Local Address:Port Peer Address:Port         <br>         <br>LISTEN  0     32      0.0.0.0:1194    0.0.0.0:*    users:<br>((<span class="hljs-string">&quot;openvpn&quot;</span>,pid=7340,fd=9))<br>LISTEN  0     128      0.0.0.0:22     0.0.0.0:*    users:<br>((<span class="hljs-string">&quot;sshd&quot;</span>,pid=761,fd=4))  <br>LISTEN  0     100     127.0.0.1:25     0.0.0.0:*    users:<br>((<span class="hljs-string">&quot;master&quot;</span>,pid=1093,fd=16))<br>LISTEN  0     128       [::]:22      [::]:*    users:<br>((<span class="hljs-string">&quot;sshd&quot;</span>,pid=761,fd=6))  <br>LISTEN  0     100      [::1]:25      [::]:*    users:<br>((<span class="hljs-string">&quot;master&quot;</span>,pid=1093,fd=17))<br><br>[root@centos7 ~]<span class="hljs-comment"># ps -ef | grep &#x27;open&#x27;</span><br>openvpn    3310      1  0 13:22 ?        00:00:00 /usr/sbin/openvpn --<span class="hljs-built_in">cd</span> /etc/openvpn/ --config server.conf<br>root       3344   2260  0 13:25 pts/0    00:00:00 grep --color=auto open<br><br><br>[root@centos7 ~]<span class="hljs-comment"># cat /var/log/openvpn/openvpn.log</span><br>Tue Aug  4 00:30:12 2020 OpenVPN 2.4.9 x86_64-redhat-linux-gnu [SSL (OpenSSL)]<br>[LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Apr 24 2020<br>Tue Aug  4 00:30:12 2020 library versions: OpenSSL 1.1.1c FIPS  28 May 2019, LZO<br>2.08<br>Tue Aug  4 00:30:12 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-tun -- this may cause restarts to fail<br>Tue Aug  4 00:30:12 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-key -- this may cause restarts to fail<br>Tue Aug  4 00:30:12 2020 Diffie-Hellman initialized with 2048 bit key<br>Tue Aug  4 00:30:12 2020 ROUTE_GATEWAY 10.0.0.2/255.255.255.0 IFACE=eth0<br>HWADDR=00:0c:29:8a:51:21<br>Tue Aug  4 00:30:12 2020 TUN/TAP device tun0 opened<br>Tue Aug  4 00:30:12 2020 TUN/TAP TX queue length <span class="hljs-built_in">set</span> to 100<br>Tue Aug  4 00:30:12 2020 /sbin/ip link <span class="hljs-built_in">set</span> dev tun0 up mtu 1500<br>Tue Aug  4 00:30:12 2020 /sbin/ip addr add dev tun0 <span class="hljs-built_in">local</span> 10.8.0.1 peer 10.8.0.2<br>Tue Aug  4 00:30:12 2020 /sbin/ip route add 10.8.0.0/24 via 10.8.0.2<br>Tue Aug  4 00:30:12 2020 Could not determine IPv4/IPv6 protocol. Using AF_INET<br>Tue Aug  4 00:30:12 2020 Socket Buffers: R=[87380-&gt;87380] S=[16384-&gt;16384]<br>Tue Aug  4 00:30:12 2020 Listening <span class="hljs-keyword">for</span> incoming TCP connection on [AF_INET]<br>[undef]:1194<br>Tue Aug  4 00:30:12 2020 TCPv4_SERVER link <span class="hljs-built_in">local</span> (bound): [AF_INET][undef]:1194<br>Tue Aug  4 00:30:12 2020 TCPv4_SERVER link remote: [AF_UNSPEC]<br>Tue Aug  4 00:30:12 2020 GID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 00:30:12 2020 UID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 00:30:12 2020 MULTI: multi_init called, r=256 v=256<br>Tue Aug  4 00:30:12 2020 IFCONFIG POOL: base=10.8.0.4 size=62, ipv6=0<br>Tue Aug  4 00:30:12 2020 IFCONFIG POOL LIST<br>Tue Aug  4 00:30:12 2020 MULTI: TCP INIT maxclients=2048 maxevents=2052<br>Tue Aug  4 00:30:12 2020 Initialization Sequence Completed<br><br>[root@centos7 ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe8a:5121/64 scope link<br>   valid_lft forever preferred_lft forever<br>3: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state<br>UNKNOWN group default qlen 100<br> link/none<br> inet 10.8.0.1 peer 10.8.0.2/32 scope global tun0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::c8db:a8ca:b492:a3e0/64 scope link stable-privacy<br>        valid_lft forever preferred_lft forever<br>        <br>[root@centos7 ~]<span class="hljs-comment"># route -n</span><br>Kernel IP routing table<br>Destination   Gateway     Genmask     Flags Metric Ref  Use Iface<br>0.0.0.0     172.30.0.253   0.0.0.0     UG   100   0     0 eth0<br>10.8.0.0     10.8.0.2     255.255.255.0  UG   0    0     0 tun0<br>10.8.0.2     0.0.0.0     255.255.255.255 UH   0    0     0 tun0<br>172.30.0.0    0.0.0.0     255.255.255.0  U   100   0     0 eth0<br></code></pre></td></tr></table></figure>

<p>验证tun网卡设备：</p>
<p>输入：ifconfig tun0</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup23.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="2-7-准备-OpenVPN-客户端配置文件"><a href="#2-7-准备-OpenVPN-客户端配置文件" class="headerlink" title="2.7 准备 OpenVPN 客户端配置文件"></a>2.7 准备 OpenVPN 客户端配置文件</h3><h4 id="2-7-1-客户端默认范例配置文件说明"><a href="#2-7-1-客户端默认范例配置文件说明" class="headerlink" title="2.7.1 客户端默认范例配置文件说明"></a>2.7.1 客户端默认范例配置文件说明</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&#x27;^[[:alpha:]].*&#x27;</span> /usr/share/doc/openvpn/sample/sample-<br>config-files/client.conf<br>client   <span class="hljs-comment">#声明自己是个客户端</span><br>dev tun   <span class="hljs-comment">#接口类型，必须和服务端保持一致</span><br>proto udp  <span class="hljs-comment">#协议类型，必须和服务端保持一致</span><br>remote my-server-1 1194 <span class="hljs-comment">#server端的ip和端口，可以写域名但是需要可以解析成IP</span><br>resolv-retry infinite  <span class="hljs-comment">#如果是写的server端的域名，那么就始终解析，如果域名发生变化，会重新连接到新的域名对应的IP</span><br>nobind          <span class="hljs-comment">#本机不绑定监听端口，客户端是随机打开端口连接到服务端的1194</span><br>persist-key<br>persist-tun<br>ca ca.crt<br>cert client.crt<br>key client.key<br>remote-cert-tls server  <span class="hljs-comment">#指定采用服务器证书校验方式</span><br>tls-auth ta.key 1<br>cipher AES-256-CBC<br>verb 3<br></code></pre></td></tr></table></figure>

<h3 id="2-7-2-生成客户端用户的配置文件"><a href="#2-7-2-生成客户端用户的配置文件" class="headerlink" title="2.7.2 生成客户端用户的配置文件"></a>2.7.2 生成客户端用户的配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#生成客户端文件,文件后缀必须为.ovpn</span><br>[root@centos7 ~]<span class="hljs-comment"># grep &#x27;^[[:alpha:]].*&#x27; /usr/share/doc/openvpn-2.4.10/sample/sample-config-files/client.conf &gt; /etc/openvpn/client/wangxiaochun/client.ovpn</span><br><br><span class="hljs-comment">#修改配置文件,内容如下</span><br>[root@centos7 ~]<span class="hljs-comment"># vim /etc/openvpn/client/wangxiaochun/client.ovpn</span><br>[root@centos7 ~]<span class="hljs-comment"># cat /etc/openvpn/client/wangxiaochun/client.ovpn</span><br>client<br>dev tun<br>proto tcp<br>remote  10.0.0.8  1194        <span class="hljs-comment">#生产中为OpenVPN公网IP</span><br>resolv-retry infinite<br>nobind<br><span class="hljs-comment">#persist-key</span><br><span class="hljs-comment">#persist-tun</span><br>ca ca.crt<br>cert wangxiaochun.crt<br>key wangxiaochun.key<br>remote-cert-tls server<br><span class="hljs-comment">#tls-auth ta.key 1</span><br>cipher AES-256-CBC<br>verb 3 <span class="hljs-comment">#此值不能随意指定,否则无法通信</span><br>compress lz4-v2 <span class="hljs-comment">#此项在OpenVPN2.4.X版本使用,需要和服务器端保持一致,如不指定,默认使用comp-lz压缩</span><br></code></pre></td></tr></table></figure>

<h3 id="2-8-Windows-配置部署-OpenVPN-客户端"><a href="#2-8-Windows-配置部署-OpenVPN-客户端" class="headerlink" title="2.8 Windows 配置部署 OpenVPN 客户端"></a>2.8 Windows 配置部署 OpenVPN 客户端</h3><h4 id="2-8-1-Windows-安装-OpenVPN-客户端"><a href="#2-8-1-Windows-安装-OpenVPN-客户端" class="headerlink" title="2.8.1 Windows 安装 OpenVPN 客户端"></a>2.8.1 Windows 安装 OpenVPN 客户端</h4><p>官方客户端下载地址：<br><a target="_blank" rel="noopener" href="https://openvpn.net/community-downloads/">https://openvpn.net/community-downloads/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup24.jpg" srcset="/blog/img/loading.gif"></p>
<p><strong>openvpn客户端安装过程：</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup25.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup26.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup27.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup28.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup29.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="2-8-2-Windows-客户端配置准备"><a href="#2-8-2-Windows-客户端配置准备" class="headerlink" title="2.8.2 Windows 客户端配置准备"></a>2.8.2 Windows 客户端配置准备</h4><p>保存证书到openvpn 客户端安装目录：C:\Program Files\OpenVPN\config</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在服务器打包证书并下载发送给windows客户端</span><br><span class="hljs-built_in">cd</span> /etc/openvpn/client/wangxiaochun/<br>[root@centos7 wangxiaochun]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/client/wangxiaochun<br>[root@centos7 wangxiaochun]<span class="hljs-comment">#tar cf wangxiaochun.tar ./</span><br>tar: ./wangxiaochun.tar: file is the archive; not dumped<br>ll<br>total 40<br>-rw------- 1 root root  1204 Aug  3 21:05 ca.crt<br>-rw-r--r-- 1 root root  231 Aug  3 23:31 client.ovpn<br>-rw------- 1 root root  4506 Aug  3 21:05 wangxiaochun.crt<br>-rw------- 1 root root  1704 Aug  3 21:05 wangxiaochun.key<br>-rw-r--r-- 1 root root 20480 Aug  4 10:48 wangxiaochun.tar<br><br>[root@centos7 wangxiaochun]<span class="hljs-comment"># tar tf wangxiaochun.tar</span><br>./<br>./wangxiaochun.key<br>./wangxiaochun.crt<br>./ca.crt<br>./client.ovpn<br></code></pre></td></tr></table></figure>

<p>放置到windows客户端的 C:\Program Files\OpenVPN\config 目录下（不能直接传输到C盘，需要传输出来后在放进C盘）</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup30.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="2-8-3-Windows-客户端建立OpenVPN连接"><a href="#2-8-3-Windows-客户端建立OpenVPN连接" class="headerlink" title="2.8.3 Windows 客户端建立OpenVPN连接"></a>2.8.3 Windows 客户端建立OpenVPN连接</h4><p>在windows 程序中打开 OpenVPN GUI 工具</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup31.jpg" srcset="/blog/img/loading.gif"></p>
<p>稍等一会儿,在状态栏显示以下图标,右键点连接</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup32.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup33.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup34.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup35.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="2-8-4-Windows-客户端验证通信"><a href="#2-8-4-Windows-客户端验证通信" class="headerlink" title="2.8.4 Windows 客户端验证通信"></a>2.8.4 Windows 客户端验证通信</h3><h4 id="2-8-4-1-在Windows-客户端测试访问OpenVPN后端服务器"><a href="#2-8-4-1-在Windows-客户端测试访问OpenVPN后端服务器" class="headerlink" title="2.8.4.1 在Windows 客户端测试访问OpenVPN后端服务器"></a>2.8.4.1 在Windows 客户端测试访问OpenVPN后端服务器</h4><p><strong>后端服务器显示是来自于OpenVPN服务器的连接</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup36.jpg" srcset="/blog/img/loading.gif"></p>
<h5 id="2-8-4-2-观察OpenVPN服务器日志"><a href="#2-8-4-2-观察OpenVPN服务器日志" class="headerlink" title="2.8.4.2 观察OpenVPN服务器日志"></a>2.8.4.2 观察OpenVPN服务器日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># tail /var/log/openvpn/openvpn.log -f -n0</span><br>Tue Aug  4 11:57:44 2020 TCP connection established with [AF_INET]10.0.0.1:6913<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 TLS: Initial packet from<br>[AF_INET]10.0.0.1:6913, sid=6b727fec 8459dc55<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 VERIFY OK: depth=1, CN=Easy-RSA CA<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 VERIFY OK: depth=0, CN=wangxiaochun<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_VER=2.4.9<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_PLAT=win<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_PROTO=2<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_NCP=2<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_LZ4=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_LZ4v2=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_LZO=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_COMP_STUB=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_COMP_STUBv2=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_TCPNL=1<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 peer info: IV_GUI_VER=OpenVPN_GUI_11<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 WARNING: <span class="hljs-string">&#x27;link-mtu&#x27;</span> is used<br>inconsistently, <span class="hljs-built_in">local</span>=<span class="hljs-string">&#x27;link-mtu 1560&#x27;</span>, remote=<span class="hljs-string">&#x27;link-mtu 1559&#x27;</span><br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 WARNING: <span class="hljs-string">&#x27;comp-lzo&#x27;</span> is present <span class="hljs-keyword">in</span> <span class="hljs-built_in">local</span><br>config but missing <span class="hljs-keyword">in</span> remote config, <span class="hljs-built_in">local</span>=<span class="hljs-string">&#x27;comp-lzo&#x27;</span><br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 Control Channel: TLSv1.3, cipher TLSv1.3<br>TLS_AES_256_GCM_SHA384, 2048 bit RSA<br>Tue Aug  4 11:57:45 2020 10.0.0.1:6913 [wangxiaochun] Peer Connection Initiated<br>with [AF_INET]10.0.0.1:6913<br>Tue Aug  4 11:57:45 2020 wangxiaochun/10.0.0.1:6913 MULTI_sva: pool returned<br>IPv4=10.8.0.6, IPv6=(Not enabled)<br>Tue Aug  4 11:57:45 2020 wangxiaochun/10.0.0.1:6913 MULTI: Learn: 10.8.0.6 -&gt;<br>wangxiaochun/10.0.0.1:6913<br>Tue Aug  4 11:57:45 2020 wangxiaochun/10.0.0.1:6913 MULTI: primary virtual IP<br><span class="hljs-keyword">for</span> wangxiaochun/10.0.0.1:6913: 10.8.0.6<br>Tue Aug  4 11:57:46 2020 wangxiaochun/10.0.0.1:6913 PUSH: Received control<br>message: <span class="hljs-string">&#x27;PUSH_REQUEST&#x27;</span><br>Tue Aug  4 11:57:46 2020 wangxiaochun/10.0.0.1:6913 SENT CONTROL [wangxiaochun]:<br><span class="hljs-string">&#x27;PUSH_REPLY,route 172.30.0.0 255.255.0.0,compress lz4-v2,route 10.8.0.1,topology</span><br><span class="hljs-string">net30,ping 10,ping-restart 120,ifconfig 10.8.0.6 10.8.0.5,peer-id 0,cipher AES-</span><br><span class="hljs-string">256-GCM&#x27;</span> (status=1)<br>Tue Aug  4 11:57:46 2020 wangxiaochun/10.0.0.1:6913 Data Channel: using<br>negotiated cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span><br>Tue Aug  4 11:57:46 2020 wangxiaochun/10.0.0.1:6913 Outgoing Data Channel:<br>Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br>Tue Aug  4 11:57:46 2020 wangxiaochun/10.0.0.1:6913 Incoming Data Channel:<br>Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br><br>cat /var/<span class="hljs-built_in">log</span>/openvpn/openvpn-status.log<br>OpenVPN CLIENT LIST<br>Updated,Tue Aug  4 13:26:45 2020<br>Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since<br>wangxiaochun,10.0.0.1:6913,87125,41765,Tue Aug  4 11:57:44 2020<br>ROUTING TABLE<br>Virtual Address,Common Name,Real Address,Last Ref<br>10.8.0.6,wangxiaochun,10.0.0.1:6913,Tue Aug  4 12:52:44 2020<br>GLOBAL STATS<br>Max bcast/mcast queue length,1<br>END<br></code></pre></td></tr></table></figure>

<h5 id="2-8-4-3-验证OpenVPN服务器连接状态"><a href="#2-8-4-3-验证OpenVPN服务器连接状态" class="headerlink" title="2.8.4.3 验证OpenVPN服务器连接状态"></a>2.8.4.3 验证OpenVPN服务器连接状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">ss -nt<br>State     Recv-Q     Send-Q  Local Address:Port  Peer Address:Port <br>   <br>ESTAB      0        52       10.0.0.8:22     10.0.0.1:14009<br>   <br>ESTAB      0        0       10.0.0.8:1194    10.0.0.1:6913<br></code></pre></td></tr></table></figure>

<h5 id="2-8-4-4-验证-Windows-客户端的-IP地址"><a href="#2-8-4-4-验证-Windows-客户端的-IP地址" class="headerlink" title="2.8.4.4 验证 Windows 客户端的 IP地址"></a>2.8.4.4 验证 Windows 客户端的 IP地址</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup37.jpg" srcset="/blog/img/loading.gif"></p>
<h5 id="2-8-4-5-验证Windows-客户端的路由表"><a href="#2-8-4-5-验证Windows-客户端的路由表" class="headerlink" title="2.8.4.5 验证Windows 客户端的路由表"></a>2.8.4.5 验证Windows 客户端的路由表</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup38.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="2-9-Mac-OS-配置部署OpenVPN-客户端"><a href="#2-9-Mac-OS-配置部署OpenVPN-客户端" class="headerlink" title="2.9 Mac OS 配置部署OpenVPN 客户端"></a>2.9 Mac OS 配置部署OpenVPN 客户端</h3><p>官方没有提供基于Mac OS的OpenVPN的客户端<br>第三方OpenVPN 客户端参考链接: <a target="_blank" rel="noopener" href="https://tunnelblick.net/downloads.html">https://tunnelblick.net/downloads.html</a><br>需要科学访问</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup39.jpg" srcset="/blog/img/loading.gif"></p>
<h2 id="三、-故障排错"><a href="#三、-故障排错" class="headerlink" title="三、 故障排错"></a>三、 故障排错</h2><h3 id="3-1-在tcp模式下开启explicit-exit-notify-导致无法启动"><a href="#3-1-在tcp模式下开启explicit-exit-notify-导致无法启动" class="headerlink" title="3.1 在tcp模式下开启explicit-exit-notify 导致无法启动"></a>3.1 在tcp模式下开启explicit-exit-notify 导致无法启动</h3><p>explicit-exit-notify 可以支持在UDP协议时,OpenVPN重启后,客户端自动重新连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/openvpn/server.conf<br><span class="hljs-comment">#在tcp模式下开启通知</span><br>proto tcp<br>explicit-exit-notify 1<br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart openvpn@server.service</span><br>Job <span class="hljs-keyword">for</span> openvpn@server.service failed because the control process exited with<br>error code.<br>See <span class="hljs-string">&quot;systemctl status openvpn@server.service&quot;</span> and <span class="hljs-string">&quot;journalctl -xe&quot;</span> <span class="hljs-keyword">for</span> details<br><br>tail /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log -f -n0<br>Tue Aug  4 13:29:52 2020 /sbin/ip route del 10.8.0.0/24<br>RTNETLINK answers: Operation not permitted<br>Tue Aug  4 13:29:52 2020 ERROR: Linux route delete <span class="hljs-built_in">command</span> failed: external<br>program exited with error status: 2<br>Tue Aug  4 13:29:52 2020 Closing TUN/TAP interface<br>Tue Aug  4 13:29:52 2020 /sbin/ip addr del dev tun0 <span class="hljs-built_in">local</span> 10.8.0.1 peer 10.8.0.2<br>RTNETLINK answers: Operation not permitted<br>Tue Aug  4 13:29:52 2020 Linux ip addr del failed: external program exited with<br>error status: 2<br>Tue Aug  4 13:29:52 2020 SIGTERM[hard,] received, process exiting<br>Options error: --explicit-exit-notify can only be used with --proto udp<br>Use --<span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> more information.<br></code></pre></td></tr></table></figure>

<p><strong>修改配置,选择UDP协议</strong><br><strong>注意: 需要在防火墙或安全组中开启1194/UDP端口</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/openvpn/server.conf<br>proto udp<br>explicit-exit-notify 1<br>systemctl restart openvpn@server.service<br></code></pre></td></tr></table></figure>

<p><strong>客户端也需要修改为UDP协议,否则会显示下面</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup40.jpg" srcset="/blog/img/loading.gif"></p>
<p><strong>修改客户端配置文件</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup41.jpg" srcset="/blog/img/loading.gif"></p>
<p>重新连接成功</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup42.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup43.jpg" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">ss -ntua<br>Netid    State     Recv-Q    Send-Q  Local Address:Port  Peer<br>Address:Port    <br>udp     UNCONN    0       0        0.0.0.0:1194   <br>0.0.0.0:*     <br>udp     UNCONN    0       0       127.0.0.1:323    <br>0.0.0.0:*     <br>udp     UNCONN    0       0         [::1]:323     <br>[::]:*     <br>tcp     LISTEN    0       128       0.0.0.0:22    <br>0.0.0.0:*     <br>tcp     LISTEN    0       100      127.0.0.1:25    <br>0.0.0.0:*     <br>tcp     ESTAB     0       52       10.0.0.8:22    <br>10.0.0.1:14009   <br>tcp     LISTEN    0       128        [::]:22      <br>[::]:*     <br>tcp     LISTEN    0       100        [::1]:25      <br>[::]:* <br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup44.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="3-2-压缩算法错误导致连接失败"><a href="#3-2-压缩算法错误导致连接失败" class="headerlink" title="3.2 压缩算法错误导致连接失败"></a>3.2 压缩算法错误导致连接失败</h3><p><strong>OpenVPN 2.4.x 客户端支持更新的压缩算法lz4-v2, 而comp-lzo是为老版本兼容使用,两者不要在一起混用,否则可能会导致连接失败</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#开启兼容的压缩功能</span><br>vim /etc/openvpn/server.conf<br>compress lz4-v2<br>push <span class="hljs-string">&quot;compress lz4-v2&quot;</span> <br>comp-lzo<br>systemctl restart openvpn@server.service<br><br><span class="hljs-comment">#windows客户端连接后,服务器可以看到下面日志提示</span><br>tail /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log -f -n0<br>......<br>Tue Aug  4 13:35:40 2020 /sbin/ip route del 10.8.0.0/24<br>RTNETLINK answers: Operation not permitted<br>Tue Aug  4 13:35:40 2020 ERROR: Linux route delete <span class="hljs-built_in">command</span> failed: external<br>program exited with error status: 2<br>Tue Aug  4 13:35:40 2020 Closing TUN/TAP interface<br>Tue Aug  4 13:35:40 2020 /sbin/ip addr del dev tun0 <span class="hljs-built_in">local</span> 10.8.0.1 peer 10.8.0.2<br>RTNETLINK answers: Operation not permitted<br>Tue Aug  4 13:35:40 2020 Linux ip addr del failed: external program exited with<br>error status: 2<br>Tue Aug  4 13:35:40 2020 SIGTERM[hard,] received, process exiting<br>Tue Aug  4 13:35:40 2020 OpenVPN 2.4.9 x86_64-redhat-linux-gnu [SSL (OpenSSL)]<br>[LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Apr 24 2020<br>Tue Aug  4 13:35:40 2020 library versions: OpenSSL 1.1.1c FIPS  28 May 2019, LZO<br>2.08<br>Tue Aug  4 13:35:40 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-tun -- this may cause restarts to fail<br>Tue Aug  4 13:35:40 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-key -- this may cause restarts to fail<br>Tue Aug  4 13:35:40 2020 Diffie-Hellman initialized with 2048 bit key<br>Tue Aug  4 13:35:40 2020 ROUTE_GATEWAY 10.0.0.2/255.255.255.0 IFACE=eth0<br>HWADDR=00:0c:29:8a:51:21<br>Tue Aug  4 13:35:40 2020 TUN/TAP device tun0 opened<br>Tue Aug  4 13:35:40 2020 TUN/TAP TX queue length <span class="hljs-built_in">set</span> to 100<br>Tue Aug  4 13:35:40 2020 /sbin/ip link <span class="hljs-built_in">set</span> dev tun0 up mtu 1500<br>Tue Aug  4 13:35:40 2020 /sbin/ip addr add dev tun0 <span class="hljs-built_in">local</span> 10.8.0.1 peer 10.8.0.2<br>Tue Aug  4 13:35:40 2020 /sbin/ip route add 10.8.0.0/24 via 10.8.0.2<br>Tue Aug  4 13:35:40 2020 Could not determine IPv4/IPv6 protocol. Using AF_INET<br>Tue Aug  4 13:35:40 2020 Socket Buffers: R=[87380-&gt;87380] S=[16384-&gt;16384]<br>Tue Aug  4 13:35:40 2020 Listening <span class="hljs-keyword">for</span> incoming TCP connection on [AF_INET]<br>[undef]:1194<br>Tue Aug  4 13:35:40 2020 TCPv4_SERVER link <span class="hljs-built_in">local</span> (bound): [AF_INET][undef]:1194<br>Tue Aug  4 13:35:40 2020 TCPv4_SERVER link remote: [AF_UNSPEC]<br>Tue Aug  4 13:35:40 2020 GID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 13:35:40 2020 UID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 13:35:40 2020 MULTI: multi_init called, r=256 v=256<br>Tue Aug  4 13:35:40 2020 IFCONFIG POOL: base=10.8.0.4 size=62, ipv6=0<br>Tue Aug  4 13:35:40 2020 ifconfig_pool_read(), <span class="hljs-keyword">in</span>=<span class="hljs-string">&#x27;wangxiaochun,10.8.0.4&#x27;</span>, TODO:<br>IPv6<br>Tue Aug  4 13:35:40 2020 succeeded -&gt; ifconfig_pool_set()<br>Tue Aug  4 13:35:40 2020 IFCONFIG POOL LIST<br>Tue Aug  4 13:35:40 2020 wangxiaochun,10.8.0.4<br>Tue Aug  4 13:35:40 2020 MULTI: TCP INIT maxclients=2048 maxevents=2052<br>Tue Aug  4 13:35:40 2020 Initialization Sequence Completed<br>Tue Aug  4 13:36:11 2020 TCP connection established with [AF_INET]10.0.0.1:14124<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 TLS: Initial packet from<br>[AF_INET]10.0.0.1:14124, sid=7ebe3c44 bf2f7f6d<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 VERIFY OK: depth=1, CN=Easy-RSA CA<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 VERIFY OK: depth=0, CN=wangxiaochun<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_VER=2.4.9<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_PLAT=win<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_PROTO=2<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_NCP=2<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_LZ4=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_LZ4v2=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_LZO=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_COMP_STUB=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_COMP_STUBv2=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_TCPNL=1<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 peer info: IV_GUI_VER=OpenVPN_GUI_11<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 WARNING: <span class="hljs-string">&#x27;link-mtu&#x27;</span> is used<br>inconsistently, <span class="hljs-built_in">local</span>=<span class="hljs-string">&#x27;link-mtu 1560&#x27;</span>, remote=<span class="hljs-string">&#x27;link-mtu 1559&#x27;</span><br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 WARNING: <span class="hljs-string">&#x27;comp-lzo&#x27;</span> is present <span class="hljs-keyword">in</span> <span class="hljs-built_in">local</span><br>config but missing <span class="hljs-keyword">in</span> remote config, <span class="hljs-built_in">local</span>=<span class="hljs-string">&#x27;comp-lzo&#x27;</span><br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 Control Channel: TLSv1.3, cipher TLSv1.3<br>TLS_AES_256_GCM_SHA384, 2048 bit RSA<br>Tue Aug  4 13:36:12 2020 10.0.0.1:14124 [wangxiaochun] Peer Connection Initiated<br>with [AF_INET]10.0.0.1:14124<br>Tue Aug  4 13:36:12 2020 wangxiaochun/10.0.0.1:14124 MULTI_sva: pool returned<br>IPv4=10.8.0.6, IPv6=(Not enabled)<br>Tue Aug  4 13:36:12 2020 wangxiaochun/10.0.0.1:14124 MULTI: Learn: 10.8.0.6 -&gt;<br>wangxiaochun/10.0.0.1:14124<br>Tue Aug  4 13:36:12 2020 wangxiaochun/10.0.0.1:14124 MULTI: primary virtual IP<br><span class="hljs-keyword">for</span> wangxiaochun/10.0.0.1:14124: 10.8.0.6<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 PUSH: Received control<br>message: <span class="hljs-string">&#x27;PUSH_REQUEST&#x27;</span><br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 SENT CONTROL<br>[wangxiaochun]: <span class="hljs-string">&#x27;PUSH_REPLY,route 172.30.0.0 255.255.0.0,compress lz4-v2,route</span><br><span class="hljs-string">10.8.0.1,topology net30,ping 10,ping-restart 120,ifconfig 10.8.0.6</span><br><span class="hljs-string">10.8.0.5,peer-id 0,cipher AES-256-GCM&#x27;</span> (status=1)<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Data Channel: using<br>negotiated cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span><br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Outgoing Data Channel:<br>Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Incoming Data Channel:<br>Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 80<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 96<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 96<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 96<br>Tue Aug  4 13:36:13 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 80<br>Tue Aug  4 13:36:18 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 96<br>Tue Aug  4 13:36:18 2020 wangxiaochun/10.0.0.1:14124 Bad LZO decompression<br>header byte: 96<br></code></pre></td></tr></table></figure>

<p>在客户端可以看到面提示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup45.jpg" srcset="/blog/img/loading.gif"></p>
<p>客户端无法访问后端服务器</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup46.jpg" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#关闭兼容的压缩功能</span><br>vim /etc/openvpn/server.conf<br>;comp-lzo<br>systemctl restart openvpn@server.service<br></code></pre></td></tr></table></figure>

<p>客户端重新连接,访问后端服务器成功</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup47.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="3-3-工作模式错误"><a href="#3-3-工作模式错误" class="headerlink" title="3.3 工作模式错误"></a>3.3 工作模式错误</h3><p><strong>OpenVPN两种工作模式:TUN和TAP,都可以支持TCP和UDP协议,但如果服务器和客户工作模式不同,比如服务器为TAP,客户端为TUN,会导致连接失败</strong></p>
<p>修改服务器端为TAP模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/openvpn/server.conf<br>dev tap<br>;dev tun<br><br>systemctl restart openvpn@server.service<br>ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group<br>default qlen 1000<br> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br> inet 127.0.0.1/8 scope host lo<br>   valid_lft forever preferred_lft forever<br> inet6 ::1/128 scope host<br>   valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff<br> inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0<br>   valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP<br>group default qlen 1000<br> link/ether 00:0c:29:8a:51:2b brd ff:ff:ff:ff:ff:ff<br> inet 172.30.0.1/24 brd 172.30.0.255 scope global noprefixroute eth1<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::20c:29ff:fe8a:512b/64 scope link<br>   valid_lft forever preferred_lft forever<br>15: tap0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state<br>UNKNOWN group default qlen 100<br> link/ether 6a:5c:7d:7a:0d:6e brd ff:ff:ff:ff:ff:ff<br> inet 10.8.0.1/24 brd 10.8.0.255 scope global tap0<br>   valid_lft forever preferred_lft forever<br> inet6 fe80::685c:7dff:fe7a:d6e/64 scope link<br>   valid_lft forever preferred_lft forever<br>   <br>tail -n 20 /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log<br>Tue Aug  4 14:12:13 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-tun -- this may cause restarts to fail<br>Tue Aug  4 14:12:13 2020 WARNING: you are using user/group/chroot/setcon without<br>persist-key -- this may cause restarts to fail<br>Tue Aug  4 14:12:13 2020 Diffie-Hellman initialized with 2048 bit key<br>Tue Aug  4 14:12:13 2020 TUN/TAP device tap0 opened<br>Tue Aug  4 14:12:13 2020 TUN/TAP TX queue length <span class="hljs-built_in">set</span> to 100<br>Tue Aug  4 14:12:13 2020 /sbin/ip link <span class="hljs-built_in">set</span> dev tap0 up mtu 1500<br>Tue Aug  4 14:12:13 2020 /sbin/ip addr add dev tap0 10.8.0.1/24 broadcast<br>10.8.0.255<br>Tue Aug  4 14:12:13 2020 Could not determine IPv4/IPv6 protocol. Using AF_INET<br>Tue Aug  4 14:12:13 2020 Socket Buffers: R=[212992-&gt;212992] S=[212992-&gt;212992]<br>Tue Aug  4 14:12:13 2020 UDPv4 link <span class="hljs-built_in">local</span> (bound): [AF_INET][undef]:1194<br>Tue Aug  4 14:12:13 2020 UDPv4 link remote: [AF_UNSPEC]<br>Tue Aug  4 14:12:13 2020 GID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 14:12:13 2020 UID <span class="hljs-built_in">set</span> to openvpn<br>Tue Aug  4 14:12:13 2020 MULTI: multi_init called, r=256 v=256<br>Tue Aug  4 14:12:13 2020 IFCONFIG POOL: base=10.8.0.2 size=253, ipv6=0<br>Tue Aug  4 14:12:13 2020 ifconfig_pool_read(), <span class="hljs-keyword">in</span>=<span class="hljs-string">&#x27;wangxiaochun,10.8.0.4&#x27;</span>, TODO:<br>IPv6<br>Tue Aug  4 14:12:13 2020 succeeded -&gt; ifconfig_pool_set()<br>Tue Aug  4 14:12:13 2020 IFCONFIG POOL LIST<br>Tue Aug  4 14:12:13 2020 wangxiaochun,10.8.0.4<br>Tue Aug  4 14:12:13 2020 Initialization Sequence Completed<br><br>route -n<br>Kernel IP routing table<br>Destination   Gateway     Genmask     Flags Metric Ref  Use Iface<br>0.0.0.0     10.0.0.2     0.0.0.0     UG   102   0     0 eth0<br>10.0.0.0     0.0.0.0     255.255.255.0  U   102   0     0 eth0<br>10.8.0.0     0.0.0.0     255.255.255.0  U   0    0     0 tap0<br>172.30.0.0    0.0.0.0     255.255.255.0  U   101   0     0 eth1<br></code></pre></td></tr></table></figure>

<p>因为客户端为TUN模式,导致连接失败</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup48.jpg" srcset="/blog/img/loading.gif"></p>
<p>修改客户端也为TAP模式</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup49.jpg" srcset="/blog/img/loading.gif"></p>
<p>再次连接成功</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup50.jpg" srcset="/blog/img/loading.gif"></p>
<h2 id="四、-OpenVPN-高级功能"><a href="#四、-OpenVPN-高级功能" class="headerlink" title="四、 OpenVPN 高级功能"></a>四、 OpenVPN 高级功能</h2><p>本节介绍OpenVPN的高级功能,主要关于安全加强及客户端的管理功能,比如:员工入职、离职涉及到的创建账户与吊销账户证书。</p>
<h3 id="4-1-启用安全增强功能"><a href="#4-1-启用安全增强功能" class="headerlink" title="4.1 启用安全增强功能"></a>4.1 启用安全增强功能</h3><p>启用防止DoS攻击的安全增强配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># openvpn --genkey --secret /etc/openvpn/certs/ta.key</span><br>[root@centos7 ~]<span class="hljs-comment"># cat /etc/openvpn/certs/ta.key</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 2048 bit OpenVPN static key</span><br><span class="hljs-comment">#</span><br>-----BEGIN OpenVPN Static key V1-----<br>44a78a4b16b8fb4fa85f1c8af7bcae82<br>3b014ab75f50a24e13f8de798af070d3<br>7d29863fac94a6a4b28952bfeacb14b0<br>4e79a3ab790ce3d99eec0a6fdfbdb24d<br>c6bfca666e63de6d768aa25d145bd388<br>5dabb2b05ad27245eb37aa27f78e81b1<br>b8bcfd0d4e280bc02a51afb528d20955<br>d72d3578d269be2682ca468249888f3e<br>80c642d49238510ae6c50f8849739f75<br>b31d915ea4178977e246b5ec5e3298a5<br>822a74575c17348ae87e81f27732a325<br>8655a3d9aa0ee6aac3f68f6a45987561<br>cb1aed7be16824d56676ba406ea85f66<br>ad847f45dffff7b3e19bd6d6dd4406f1<br>3e0ad44f4f6ef9850e1556edad4b4280<br>49724f63a30780b91ecb0eddb07dfebc<br>-----END OpenVPN Static key V1-----<br><br>[root@centos7 ~]<span class="hljs-comment"># ll /etc/openvpn/certs</span><br>total 24<br>-rw------- 1 root root 1204 Aug  3 20:34 ca.crt<br>-rw------- 1 root root  424 Aug  3 20:35 dh.pem<br>-rw------- 1 root root 4608 Aug  3 20:34 server.crt<br>-rw------- 1 root root 1704 Aug  3 20:35 server.key<br>-rw------- 1 root root  636 Aug  4 15:53 ta.key<br><br>[root@centos7 ~]<span class="hljs-comment"># vim /etc/openvpn/server.conf</span><br><span class="hljs-comment">#tls-auth ta.key 0 # This file is secret</span><br>tls-auth /etc/openvpn/certs/ta.key 0  <span class="hljs-comment">#客户端为1,服务器端为0</span><br><br>[root@centos7 ~]<span class="hljs-comment"># systemctl restart openvpn@server.service</span><br><br><span class="hljs-comment">#日志提示出错</span><br>[root@centos7 ~]<span class="hljs-comment"># tail -n 20 /var/log/openvpn/openvpn.log -f</span><br>Tue Aug  4 15:56:30 2020 TLS Error: cannot locate HMAC <span class="hljs-keyword">in</span> incoming packet from<br>[AF_INET]10.0.0.1:59743<br>Tue Aug  4 15:56:39 2020 TLS Error: cannot locate HMAC <span class="hljs-keyword">in</span> incoming packet from<br>[AF_INET]10.0.0.1:59743<br>Tue Aug  4 15:56:45 2020 TLS Error: cannot locate HMAC <span class="hljs-keyword">in</span> incoming packet from<br>[AF_INET]10.0.0.1:59073<br></code></pre></td></tr></table></figure>

<p>客户端无法直接连接</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup51.jpg" srcset="/blog/img/loading.gif"></p>
<p>将ta.key 传到客户端相关目录下</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup52.jpg" srcset="/blog/img/loading.gif"></p>
<p>修改客户端配置文件clent.ovpn,添加一行</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup53.jpg" srcset="/blog/img/loading.gif"></p>
<p>客户端重新连接成功</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup54.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="4-2-设置私钥密码"><a href="#4-2-设置私钥密码" class="headerlink" title="4.2 设置私钥密码"></a>4.2 设置私钥密码</h3><p>新建一个账户magedu，并且设置证书密码，提高证书及登录VPN的安全性。</p>
<h4 id="4-2-1-创建新用户-生成对应的有密码的私钥和证书申请"><a href="#4-2-1-创建新用户-生成对应的有密码的私钥和证书申请" class="headerlink" title="4.2.1 创建新用户,生成对应的有密码的私钥和证书申请"></a>4.2.1 创建新用户,生成对应的有密码的私钥和证书申请</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-client/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-client/3<br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-req magedu</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating a RSA private key<br>...............................................................+++++<br>................+++++<br>writing new private key to <span class="hljs-string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-</span><br><span class="hljs-string">35371.iJfHbs/tmp.9lGUMy&#x27;</span><br>Enter PEM pass phrase: <br><span class="hljs-comment">#输入两遍密码，123456</span><br>Verifying - Enter PEM pass phrase:<br><span class="hljs-comment">#输入两遍密码</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [magedu]:  <span class="hljs-comment">#接受默认值,直接回车</span><br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-client/3/pki/reqs/magedu.req<br>key: /etc/openvpn/easy-rsa-client/3/pki/private/magedu.key<br></code></pre></td></tr></table></figure>

<h4 id="4-2-2-导入证书申请并颁发证书"><a href="#4-2-2-导入证书申请并颁发证书" class="headerlink" title="4.2.2 导入证书申请并颁发证书"></a>4.2.2 导入证书申请并颁发证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># pwd</span><br>/etc/openvpn/easy-rsa-server/3<br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/magedu.req magedu</span><br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>The request has been successfully imported with a short name of: magedu<br>You may now use this name to perform signing operations on this request.<br><br><span class="hljs-comment">#确保证书有效期是合理值</span><br>[root@centos7 3]<span class="hljs-comment"># grep EASYRSA_CERT_EXPIRE vars</span><br>set_var EASYRSA_CERT_EXPIRE 90<br><br><span class="hljs-comment">#颁发证书</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa sign client magedu</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>You are about to sign the following certificate.<br>Please check over the details shown below <span class="hljs-keyword">for</span> accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br><span class="hljs-built_in">source</span> or that you have verified the request checksum with the sender.<br>Request subject, to be signed as a client certificate <span class="hljs-keyword">for</span> 90 days:<br>subject=<br> commonName         = magedu<br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Confirm request details: yes  <span class="hljs-comment">#输入yes</span><br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-<br>36053.IQvyRq/tmp.5GkGy2<br>Check that the request matches the signature<br>Signature ok<br>The Subject<span class="hljs-string">&#x27;s Distinguished Name is as follows</span><br><span class="hljs-string">commonName      :ASN.1 12:&#x27;</span>magedu<span class="hljs-string">&#x27;</span><br><span class="hljs-string">Certificate is to be certified until Nov  2 08:30:43 2020 GMT (90 days)  #有效期</span><br><span class="hljs-string">Write out database with 1 new entries</span><br><span class="hljs-string">Data Base Updated</span><br><span class="hljs-string">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 3]# cat /etc/openvpn/easy-rsa-server/3/pki/index.txt</span><br><span class="hljs-string">V 201031091943Z EDAEBAB8D65066D307AE58ADC1A56682 unknown /CN=server</span><br><span class="hljs-string">V 201031153815Z 5FE114ACC4FE6AB89D17E1B0EECF2B78 unknown</span><br><span class="hljs-string">/CN=wangxiaochun</span><br><span class="hljs-string">V 201102083043Z C971227DA77824C8ACB7D655D09D4081 unknown /CN=magedu</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-3-将用户的证书相关文件放在指定的目录中"><a href="#4-2-3-将用户的证书相关文件放在指定的目录中" class="headerlink" title="4.2.3 将用户的证书相关文件放在指定的目录中"></a>4.2.3 将用户的证书相关文件放在指定的目录中</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 3]<span class="hljs-comment"># mkdir /etc/openvpn/client/magedu</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt /etc/openvpn/client/magedu</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-client/3/pki/private/magedu.key /etc/openvpn/client/magedu</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/magedu/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/client/wangxiaochun/client.ovpn /etc/openvpn/client/magedu/</span><br>[root@centos7 3]<span class="hljs-comment"># ll /etc/openvpn/client/magedu/</span><br>total 28<br>-rw------- 1 root root 1204 Aug  4 16:41 ca.crt<br>-rw-r--r-- 1 root root  231 Aug  4 16:44 client.ovpn<br>-rw------- 1 root root  424 Aug  4 16:41 dh.pem<br>-rw------- 1 root root 4492 Aug  4 16:38 magedu.crt<br>-rw------- 1 root root 1854 Aug  4 16:38 magedu.key<br>-rw------- 1 root root  636 Aug  4 16:41 ta.key<br><br>[root@centos7 3]<span class="hljs-comment"># cd /etc/openvpn/client/magedu/</span><br><br><span class="hljs-comment">#根据服务器端修改下面配置,需要和服务器同步</span><br>[root@centos7 magedu]<span class="hljs-comment"># vim client.ovpn</span><br>client<br>dev tun<br>proto tcp<br>remote 10.0.0.8 1194<br>resolv-retry infinite<br>nobind<br><span class="hljs-comment">#persist-key</span><br><span class="hljs-comment">#persist-tun</span><br>ca ca.crt<br>cert magedu.crt<br>key magedu.key<br>remote-cert-tls server<br>tls-auth ta.key 1<br>cipher AES-256-CBC<br>verb 3<br>compress lz4-v2<br><br>[root@centos7 magedu]<span class="hljs-comment"># tar cf magedu.tar *</span><br>[root@centos7 magedu]<span class="hljs-comment"># tar tvf magedu.tar</span><br>-rw------- root/root    1204 2020-08-04 16:41 ca.crt<br>-rw-r--r-- root/root    225 2020-08-04 16:47 client.ovpn<br>-rw------- root/root    424 2020-08-04 16:41 dh.pem<br>-rw------- root/root    4492 2020-08-04 16:38 magedu.crt<br>-rw------- root/root    1854 2020-08-04 16:38 magedu.key<br>-rw------- root/root    636 2020-08-04 16:41 ta.key<br></code></pre></td></tr></table></figure>

<h4 id="4-2-4-将相关文件传给客户端主机相应目录"><a href="#4-2-4-将相关文件传给客户端主机相应目录" class="headerlink" title="4.2.4 将相关文件传给客户端主机相应目录"></a>4.2.4 将相关文件传给客户端主机相应目录</h4><p>放置到windows客户端的 C:\Program Files\OpenVPN\config 目录下</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup55.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="4-2-5-Windows-客户端重新连接"><a href="#4-2-5-Windows-客户端重新连接" class="headerlink" title="4.2.5 Windows 客户端重新连接"></a>4.2.5 Windows 客户端重新连接</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup56.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup57.jpg" srcset="/blog/img/loading.gif"></p>
<p>查看日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 magedu]<span class="hljs-comment"># tail -n0 /var/log/openvpn/openvpn.log -f</span><br><br>Tue Aug  4 17:31:39 2020 TCP connection established with [AF_INET]10.0.0.1:6915<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 TLS: Initial packet from<br>[AF_INET]10.0.0.1:6915, sid=32d69aea a611c78d<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 VERIFY OK: depth=1, CN=Easy-RSA CA<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 VERIFY OK: depth=0, CN=magedu<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_VER=2.4.9<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_PLAT=win<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_PROTO=2<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_NCP=2<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_LZ4=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_LZ4v2=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_LZO=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_COMP_STUB=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_COMP_STUBv2=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_TCPNL=1<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 peer info: IV_GUI_VER=OpenVPN_GUI_11<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 Control Channel: TLSv1.3, cipher TLSv1.3<br>TLS_AES_256_GCM_SHA384, 2048 bit RSA<br>Tue Aug  4 17:31:40 2020 10.0.0.1:6915 [magedu] Peer Connection Initiated with<br>[AF_INET]10.0.0.1:6915<br>Tue Aug  4 17:31:40 2020 magedu/10.0.0.1:6915 MULTI_sva: pool returned<br>IPv4=10.8.0.10, IPv6=(Not enabled)<br>Tue Aug  4 17:31:40 2020 magedu/10.0.0.1:6915 MULTI: Learn: 10.8.0.10 -&gt;<br>magedu/10.0.0.1:6915<br>Tue Aug  4 17:31:40 2020 magedu/10.0.0.1:6915 MULTI: primary virtual IP <span class="hljs-keyword">for</span><br>magedu/10.0.0.1:6915: 10.8.0.10<br>Tue Aug  4 17:31:41 2020 magedu/10.0.0.1:6915 PUSH: Received control message:<br><span class="hljs-string">&#x27;PUSH_REQUEST&#x27;</span><br>Tue Aug  4 17:31:41 2020 magedu/10.0.0.1:6915 SENT CONTROL [magedu]:<br><span class="hljs-string">&#x27;PUSH_REPLY,route 172.30.0.0 255.255.0.0,compress lz4-v2,route 10.8.0.1,topology</span><br><span class="hljs-string">net30,ping 10,ping-restart 120,ifconfig 10.8.0.10 10.8.0.9,peer-id 0,cipher AES-</span><br><span class="hljs-string">256-GCM&#x27;</span> (status=1)<br>Tue Aug  4 17:31:41 2020 magedu/10.0.0.1:6915 Data Channel: using negotiated<br>cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span><br>Tue Aug  4 17:31:41 2020 magedu/10.0.0.1:6915 Outgoing Data Channel: Cipher<br><span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br>Tue Aug  4 17:31:41 2020 magedu/10.0.0.1:6915 Incoming Data Channel: Cipher<br><span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized with 256 bit key<br><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup58.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="4-3-账户证书管理"><a href="#4-3-账户证书管理" class="headerlink" title="4.3 账户证书管理"></a>4.3 账户证书管理</h3><p>主要是证书的创建和吊销，对应的员工的入职和离职</p>
<h4 id="4-3-1-证书自动过期"><a href="#4-3-1-证书自动过期" class="headerlink" title="4.3.1 证书自动过期"></a>4.3.1 证书自动过期</h4><p>过期时间以服务器时间为准，如果过期,需要重新颁发证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#过期时间由以下设置决定</span><br>[root@centos7 ~]<span class="hljs-comment"># grep EASYRSA_CERT_EXPIRE /etc/openvpn/easy-rsa-server/3/vars </span><br>set_var EASYRSA_CERT_EXPIRE 90<br></code></pre></td></tr></table></figure>

<p>如果证书过期,在服务器端可以看到以下日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#让服务器时间改为2年后时间（改了记得改回来）</span><br>[root@centos7 ~]<span class="hljs-comment"># date -s &#x27;2 year&#x27;</span><br>Thu Aug  4 17:41:04 CST 2022<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup59.jpg" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#服务器端日志中会显示用户证书过期</span><br>[root@centos7 ~]<span class="hljs-comment"># tail -n0 /var/log/openvpn/openvpn.log -f</span><br>Thu Aug  4 17:42:22 2022 TCP connection established with [AF_INET]10.0.0.1:11324<br>Thu Aug  4 17:42:23 2022 10.0.0.1:11324 TLS: Initial packet from<br>[AF_INET]10.0.0.1:11324, sid=a2957674 874cf1f7<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 VERIFY OK: depth=1, CN=Easy-RSA CA<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 VERIFY ERROR: depth=0, error=certificate<br>has expired: CN=magedu<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 OpenSSL: error:1417C086:SSL<br>routines:tls_process_client_certificate:certificate verify failed<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 TLS_ERROR: BIO <span class="hljs-built_in">read</span> tls_read_plaintext<br>error<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 TLS Error: TLS object -&gt; incoming<br>plaintext <span class="hljs-built_in">read</span> error<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 TLS Error: TLS handshake failed<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 Fatal TLS error (check_tls_errors_co),<br>restarting<br>Thu Aug  4 17:42:24 2022 10.0.0.1:11324 SIGUSR1[soft,tls-error] received,<br>client-instance restarting<br></code></pre></td></tr></table></figure>

<h4 id="4-3-2-证书手动注销"><a href="#4-3-2-证书手动注销" class="headerlink" title="4.3.2 证书手动注销"></a>4.3.2 证书手动注销</h4><h5 id="4-3-2-1-查看当前证书的有效性-有效为V-无效为R"><a href="#4-3-2-1-查看当前证书的有效性-有效为V-无效为R" class="headerlink" title="4.3.2.1 查看当前证书的有效性,有效为V,无效为R"></a>4.3.2.1 查看当前证书的有效性,有效为V,无效为R</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cat /etc/openvpn/easy-rsa-server/3/pki/index.txt</span><br>V 201031091943Z EDAEBAB8D65066D307AE58ADC1A56682 unknown /CN=server<br>V 201031153815Z 5FE114ACC4FE6AB89D17E1B0EECF2B78 unknown<br>/CN=wangxiaochun<br>V 201102083043Z C971227DA77824C8ACB7D655D09D4081 unknown /CN=magedu<br></code></pre></td></tr></table></figure>

<h5 id="4-3-2-2-吊销指定的用户的证书"><a href="#4-3-2-2-吊销指定的用户的证书" class="headerlink" title="4.3.2.2 吊销指定的用户的证书"></a>4.3.2.2 吊销指定的用户的证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa revoke magedu</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Please confirm you wish to revoke the certificate with the following subject:<br>subject=<br> commonName         = magedu<br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Continue with revocation: yes<br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-<br>3787.Q2lnW6/tmp.18ZdMO<br>Revoking Certificate C971227DA77824C8ACB7D655D09D4081.<br>Data Base Updated<br>IMPORTANT!!!<br>Revocation was successful. You must run gen-crl and upload a CRL to your<br>infrastructure <span class="hljs-keyword">in</span> order to prevent the revoked cert from being accepted.<br><br><span class="hljs-comment">#查看当前证书的有效性,有效为V,无效为R</span><br>[root@centos7 3]<span class="hljs-comment"># cat /etc/openvpn/easy-rsa-server/3/pki/index.txt</span><br>V 201031091943Z EDAEBAB8D65066D307AE58ADC1A56682 unknown /CN=server<br>V 201031153815Z 5FE114ACC4FE6AB89D17E1B0EECF2B78 unknown<br>/CN=wangxiaochun<br>R 201102083043Z 200805123127Z C971227DA77824C8ACB7D655D09D4081 unknown<br>/CN=magedu<br><br><span class="hljs-comment">#当前断开客户端连接,magedu用户仍然能连接成功</span><br></code></pre></td></tr></table></figure>

<h5 id="4-3-2-3-生成证书吊销列表"><a href="#4-3-2-3-生成证书吊销列表" class="headerlink" title="4.3.2.3 生成证书吊销列表"></a>4.3.2.3 生成证书吊销列表</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#每次吊销证书后都需要更新证书吊销列表文件,并且需要重启OpenVPN服务</span><br>[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-crl</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-<br>4323.gUt4WS/tmp.ybAcAU<br>An updated CRL has been created.<br>CRL file: /etc/openvpn/easy-rsa-server/3/pki/crl.pem<br><br>[root@centos7 3]<span class="hljs-comment"># cat pki/crl.pem</span><br>-----BEGIN X509 CRL-----<br>MIIB3DCBxQIBATANBgkqhkiG9w0BAQsFADAWMRQwEgYDVQQDDAtFYXN5LVJTQSBD<br>QRcNMjAwODA1MTIzNTUwWhcNMjEwMjAxMTIzNTUwWjAkMCICEQDJcSJ9p3gkyKy3<br>1lXQnUCBFw0yMDA4MDUxMjMxMjdaoFUwUzBRBgNVHSMESjBIgBTsgQDyOXOLGO7X<br>V2+OgLrlSVrqsqEapBgwFjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0GCFHzgaFQ++1WN<br>1iOovl+rVG2sq0Z6MA0GCSqGSIb3DQEBCwUAA4IBAQCMpTte/0ffpnC/ClU8GnBl<br>vnRLOmPZjvYHSoldZxZ+8PA1tKisu0r5k+V41oRxIpZeyvzwOI2SEqqqjN1BLcGj<br>4LX5exu49QlDYtAhJQ029nTQjtj5AqpcaEvID5eRTQqaX94Ykw3MVxdOqNRVjt46<br>AUTbAFrWmgAtcMbByZYtmd2h9kNwfSaJFEnJHgAqIdGJq+LnNJuHxuBWPXArtjyN<br>o5aUdhfSzEOnbRLgdwaRnsrW4K5EOFpETB7t0CQ9b+9X8fV5hqZmm6MlgI2dhLha<br>dsRkCZmdlMKvP8LjlFfy8E0rSss1jFmyvm/HRhqoIdOuQXWayryyfn6hfNyp5GMT<br>-----END X509 CRL-----<br><span class="hljs-comment">#传到windows上,修改文件后缀为crl,双击就可以打开此文件,看到下面显示信息</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup60.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup61.jpg" srcset="/blog/img/loading.gif"></p>
<h5 id="4-3-2-4-将吊销列表文件发布"><a href="#4-3-2-4-将吊销列表文件发布" class="headerlink" title="4.3.2.4 将吊销列表文件发布"></a>4.3.2.4 将吊销列表文件发布</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#第一次吊销证时需要编辑配置文件调用吊销证书的文件,后续吊销无需此步</span><br>[root@centos7 3]<span class="hljs-comment"># vim /etc/openvpn/server.conf</span><br>crl-verify /etc/openvpn/easy-rsa-server/3/pki/crl.pem<br><br><span class="hljs-comment">#每次吊销证书后,都需要重新启动才能生效</span><br>[root@centos7 3]<span class="hljs-comment"># systemctl restart openvpn@server.service</span><br></code></pre></td></tr></table></figure>

<h5 id="4-3-2-5-再次测试连接失败"><a href="#4-3-2-5-再次测试连接失败" class="headerlink" title="4.3.2.5 再次测试连接失败"></a>4.3.2.5 再次测试连接失败</h5><p>用户端再次连接失败</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup62.jpg" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#观察OpenVPN目志</span><br>tail -f /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log -n0<br>Wed Aug  5 21:13:25 2020 TCP connection established with [AF_INET]10.0.0.1:7419<br>Wed Aug  5 21:13:26 2020 10.0.0.1:7419 TLS: Initial packet from<br>[AF_INET]10.0.0.1:7419, sid=169fe75b 63908b79<br>Wed Aug  5 21:13:26 2020 10.0.0.1:7419 WARNING: Failed to <span class="hljs-built_in">stat</span> CRL file, not<br>(re)loading CRL.<br>Wed Aug  5 21:13:26 2020 10.0.0.1:7419 VERIFY ERROR: depth=0, error=certificate<br>revoked: CN=magedu<br>Wed Aug  5 21:13:26 2020 10.0.0.1:7419 OpenSSL: error:1417C086:SSL<br>routines:tls_process_client_certificate:certificate verify failed<br></code></pre></td></tr></table></figure>

<h4 id="4-3-3-账户重名证书签发"><a href="#4-3-3-账户重名证书签发" class="headerlink" title="4.3.3 账户重名证书签发"></a>4.3.3 账户重名证书签发</h4><p>假如公司已有员工叫magedu已经离职,且证书已被吊销，现在又新来一个员工仍叫magedu，那么一般的区分办法是在用户名后面加数字，如:magedu1、magedu2等，假如还想使用magedu这个账户名签发证书的话，那么需要删除服务器之前magedu的账户，并删除签发记录和证书，否则新用户的证书无法导入，并重新颁发证书</p>
<h5 id="4-3-3-1-手动重新颁发证书"><a href="#4-3-3-1-手动重新颁发证书" class="headerlink" title="4.3.3.1 手动重新颁发证书"></a>4.3.3.1 手动重新颁发证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#删除已离职备撤销的账户证书</span><br>[root@centos7 ~]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-client/3/</span><br>[root@centos7 3]<span class="hljs-comment"># rm -f pki/private/magedu.key</span><br>[root@centos7 3]<span class="hljs-comment"># rm -f pki/reqs/magedu.req</span><br>[root@centos7 3]<span class="hljs-comment"># rm -rf /etc/openvpn/client/magedu/*</span><br>[root@centos7 3]<span class="hljs-comment"># rm -f /etc/openvpn/easy-rsa-server/3/pki/reqs/magedu.req</span><br>[root@centos7 3]<span class="hljs-comment"># rm -f /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt</span><br><br><span class="hljs-comment">#删除之前的带R的吊销记录,此为可选项</span><br>[root@centos7 3]<span class="hljs-comment"># vim /etc/openvpn/easy-rsa-server/3/pki/index.txt</span><br><br><span class="hljs-comment">#重新生成新的账户证书申请和私钥</span><br>[root@centos7 3]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-client/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa gen-req magedu</span><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating a RSA private key<br>..................................+++++<br>.........+++++<br>writing new private key to <span class="hljs-string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-</span><br><span class="hljs-string">26582.hrORzD/tmp.bTOf5p&#x27;</span><br>Enter PEM pass phrase:<br>Verifying - Enter PEM pass phrase:<br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [magedu]:<span class="hljs-comment">#直接回车</span><br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-client/3/pki/reqs/magedu.req<br>key: /etc/openvpn/easy-rsa-client/3/pki/private/magedu.key<br><br><span class="hljs-comment">#CA导入证书并签发</span><br>[root@centos7 3]<span class="hljs-comment"># cd /etc/openvpn/easy-rsa-server/3</span><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/magedu.req magedu</span><br><br>[root@centos7 3]<span class="hljs-comment"># ./easyrsa sign client magedu</span><br>......<br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Confirm request details: yes  <span class="hljs-comment">#输入yes</span><br>......<br>Write out database with 1 new entries<br>Data Base Updated<br>Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt<br><br><span class="hljs-comment">#生成相关文件</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt /etc/openvpn/client/magedu/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/easy-rsa-client/3/pki/private/magedu.key /etc/openvpn/client/magedu/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/magedu/</span><br>[root@centos7 3]<span class="hljs-comment"># cp /etc/openvpn/client/wangxiaochun/client.ovpn /etc/openvpn/client/magedu/</span><br><br><span class="hljs-comment">#修改客户端配置文件</span><br>[root@centos7 3]<span class="hljs-comment"># vim /etc/openvpn/client/magedu/client.ovpn</span><br>client<br>dev tun<br>proto tcp<br>remote 10.0.0.8 1194<br>resolv-retry infinite<br>nobind<br><span class="hljs-comment">#persist-key</span><br><span class="hljs-comment">#persist-tun</span><br>ca ca.crt<br>cert magedu.crt<br>key magedu.key<br>remote-cert-tls server<br>tls-auth ta.key 1<br>cipher AES-256-CBC<br>verb 3<br>compress lz4-v2<br><br>[root@centos7 3]<span class="hljs-comment"># tree /etc/openvpn/client/magedu</span><br>/etc/openvpn/client/magedu<br>├── ca.crt<br>├── client.ovpn<br>├── dh.pem<br>├── magedu.crt<br>├── magedu.key<br>└── ta.key<br>0 directories, 6 files<br><br><span class="hljs-comment">#将/etc/openvpn/client/magedu所有文件打包传到客户端用</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-3-2-自动化的证书颁发脚本"><a href="#4-3-3-2-自动化的证书颁发脚本" class="headerlink" title="4.3.3.2 自动化的证书颁发脚本"></a>4.3.3.2 自动化的证书颁发脚本</h4><p>通过脚本实现自动化的证书颁发</p>
<h5 id="4-3-3-2-1-脚本内容"><a href="#4-3-3-2-1-脚本内容" class="headerlink" title="4.3.3.2.1 脚本内容"></a>4.3.3.2.1 脚本内容</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat openvpn-user-crt.sh<br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#Author: wangxiaochun</span><br><span class="hljs-comment">#QQ: 29308620</span><br><span class="hljs-comment">#Date: 2020-08-02</span><br><span class="hljs-comment">#FileName： openvpn-user-crt.sh</span><br><span class="hljs-comment">#URL: http://www.wangxiaochun.com</span><br><span class="hljs-comment">#Description： The test script</span><br><span class="hljs-comment">#Copyright (C): 2020 All rights reserved</span><br><span class="hljs-comment">#********************************************************************</span><br>. /etc/init.d/<span class="hljs-built_in">functions</span><br>OPENVPN_SERVER=&lt;OpenVPN Server 公网IP&gt;<br>PASS=123456<br><span class="hljs-function"><span class="hljs-title">remove_cert</span></span> () &#123;<br>  rm -rf /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  find /etc/openvpn/ -name <span class="hljs-string">&quot;<span class="hljs-variable">$NAME</span>.*&quot;</span> -delete<br>  &#125;<br><span class="hljs-function"><span class="hljs-title">create_cert</span></span> () &#123;<br>  <span class="hljs-built_in">cd</span> /etc/openvpn/easy-rsa-client/3<br> ./easyrsa gen-req <span class="hljs-variable">$&#123;NAME&#125;</span> nopass &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">EOF</span><br>  <span class="hljs-built_in">cd</span> /etc/openvpn/easy-rsa-server/3<br> ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="hljs-variable">$&#123;NAME&#125;</span>.req<br><span class="hljs-variable">$&#123;NAME&#125;</span><br> ./easyrsa sign client <span class="hljs-variable">$&#123;NAME&#125;</span> &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">yes</span><br><span class="hljs-string">EOF</span><br>  mkdir /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  cp /etc/openvpn/easy-rsa-server/3/pki/issued/<span class="hljs-variable">$&#123;NAME&#125;</span>.crt<br>/etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  cp /etc/openvpn/easy-rsa-client/3/pki/private/<span class="hljs-variable">$&#123;NAME&#125;</span>.key<br>/etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  cp /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  cat &gt; /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span>/client.ovpn &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">client</span><br><span class="hljs-string">dev tun</span><br><span class="hljs-string">proto tcp</span><br><span class="hljs-string">remote 10.0.0.8 1194</span><br><span class="hljs-string">resolv-retry infinite</span><br><span class="hljs-string">nobind</span><br><span class="hljs-string">#persist-key</span><br><span class="hljs-string">#persist-tun</span><br><span class="hljs-string">ca ca.crt</span><br><span class="hljs-string">cert $NAME.crt</span><br><span class="hljs-string">key $NAME.key</span><br><span class="hljs-string">remote-cert-tls server</span><br><span class="hljs-string">tls-auth ta.key 1</span><br><span class="hljs-string">cipher AES-256-CBC</span><br><span class="hljs-string">verb 3</span><br><span class="hljs-string">compress lz4-v2</span><br><span class="hljs-string">EOF</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;证书存放路径:/etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span>,证书文件如下:&quot;</span><br>  <span class="hljs-built_in">echo</span> -e<br><span class="hljs-string">&quot;\E[1;32m******************************************************************\E[0m</span><br><span class="hljs-string">&quot;</span><br>  ls -l /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br>  <span class="hljs-built_in">echo</span> -e<br><span class="hljs-string">&quot;\E[1;32m******************************************************************\E[0m</span><br><span class="hljs-string">&quot;</span><br>  <span class="hljs-built_in">cd</span> /etc/openvpn/client/<span class="hljs-variable">$&#123;NAME&#125;</span><br> zip -qP <span class="hljs-string">&quot;<span class="hljs-variable">$PASS</span>&quot;</span> /root/<span class="hljs-variable">$&#123;NAME&#125;</span>.zip *<br> action  <span class="hljs-string">&quot;证书的打包文件已生成: /root/<span class="hljs-variable">$&#123;NAME&#125;</span>.zip&quot;</span><br>&#125;<br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入用户的姓名拼音(如:wangxiaochun): &quot;</span> NAME<br>remove_cert<br>create_cert<br><br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-2-2-执行脚本"><a href="#4-3-3-2-2-执行脚本" class="headerlink" title="4.3.3.2.2 执行脚本"></a>4.3.3.2.2 执行脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash openvpn-user-crt.sh<br>请输入用户的姓名拼音(如:): magedu<br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>Generating a RSA private key<br>................................................................................<br>................................................................................<br>............................+++++<br>............................................................................++++<br>+<br>writing new private key to <span class="hljs-string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-</span><br><span class="hljs-string">13504.eqdKk5/tmp.kowkjQ&#x27;</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [magedu]:<br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-client/3/pki/reqs/magedu.req<br>key: /etc/openvpn/easy-rsa-client/3/pki/private/magedu.key<br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>The request has been successfully imported with a short name of: magedu<br>You may now use this name to perform signing operations on this request.<br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars<br>Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019<br>You are about to sign the following certificate.<br>Please check over the details shown below <span class="hljs-keyword">for</span> accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br><span class="hljs-built_in">source</span> or that you have verified the request checksum with the sender.<br>Request subject, to be signed as a client certificate <span class="hljs-keyword">for</span> 90 days:<br>subject=<br> commonName         = magedu<br>Type the word <span class="hljs-string">&#x27;yes&#x27;</span> to <span class="hljs-built_in">continue</span>, or any other input to abort.<br>Confirm request details: Using configuration from /etc/openvpn/easy-rsa-<br>server/3/pki/easy-rsa-13552.TvELex/tmp.Gx7dds<br>Check that the request matches the signature<br>Signature ok<br>The Subject<span class="hljs-string">&#x27;s Distinguished Name is as follows</span><br><span class="hljs-string">commonName      :ASN.1 12:&#x27;</span>magedu<span class="hljs-string">&#x27;</span><br><span class="hljs-string">Certificate is to be certified until Nov  3 13:50:50 2020 GMT (90 days)</span><br><span class="hljs-string">Write out database with 1 new entries</span><br><span class="hljs-string">Data Base Updated</span><br><span class="hljs-string">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/magedu.crt</span><br><span class="hljs-string">证书存放路径:/etc/openvpn/client/magedu,证书文件如下:</span><br><span class="hljs-string">******************************************************************</span><br><span class="hljs-string">total 28</span><br><span class="hljs-string">-rw------- 1 root root 1204 Aug  5 21:50 ca.crt</span><br><span class="hljs-string">-rw-r--r-- 1 root root  225 Aug  5 21:50 client.ovpn</span><br><span class="hljs-string">-rw------- 1 root root  424 Aug  5 21:50 dh.pem</span><br><span class="hljs-string">-rw------- 1 root root 4492 Aug  5 21:50 magedu.crt</span><br><span class="hljs-string">-rw------- 1 root root 1704 Aug  5 21:50 magedu.key</span><br><span class="hljs-string">-rw------- 1 root root  636 Aug  5 21:50 ta.key</span><br><span class="hljs-string">******************************************************************</span><br><span class="hljs-string">证书的打包文件已生成: /root/magedu.zip         [ OK ]</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-3-3-在Windows客户端用新证书连接登录"><a href="#4-3-3-3-在Windows客户端用新证书连接登录" class="headerlink" title="4.3.3.3 在Windows客户端用新证书连接登录"></a>4.3.3.3 在Windows客户端用新证书连接登录</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup63.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup64.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup65.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="4-4-生产推荐配置文件"><a href="#4-4-生产推荐配置文件" class="headerlink" title="4.4 生产推荐配置文件"></a>4.4 生产推荐配置文件</h3><p>server端和client端的生产推荐配置文件分别如下</p>
<h4 id="4-4-1-server-端配置"><a href="#4-4-1-server-端配置" class="headerlink" title="4.4.1 server 端配置"></a>4.4.1 server 端配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># grep &#x27;^[^#;]&#x27; /etc/openvpn/server.conf</span><br>port 1194<br>proto tcp<br>dev tun<br>ca /etc/openvpn/certs/ca.crt<br>cert /etc/openvpn/certs/server.crt<br>key /etc/openvpn/certs/server.key  <span class="hljs-comment"># This file should be kept secret</span><br>dh /etc/openvpn/certs/dh.pem<br>server 10.8.0.0 255.255.255.0<br>push <span class="hljs-string">&quot;route 172.30.0.0 255.255.0.0&quot;</span><br>keepalive 10 120<br>tls-auth /etc/openvpn/certs/ta.key 0<br>cipher AES-256-CBC<br>compress lz4-v2<br>push <span class="hljs-string">&quot;compress lz4-v2&quot;</span><br>max-clients 2048<br>user openvpn<br>group openvpn<br>status /var/<span class="hljs-built_in">log</span>/openvpn/openvpn-status.log<br>log-append /var/<span class="hljs-built_in">log</span>/openvpn/openvpn.log<br>verb 3<br>mute 200<br>crl-verify /etc/openvpn/easy-rsa-server/3/pki/crl.pem<br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-client-端配置"><a href="#4-4-2-client-端配置" class="headerlink" title="4.4.2 client 端配置"></a>4.4.2 client 端配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># cat /etc/openvpn/client/wangxiaochun/client.ovpn</span><br>client<br>dev tun<br>proto tcp<br>remote 10.0.0.8 1194<br>resolv-retry infinite<br>nobind<br><span class="hljs-comment">#persist-key</span><br><span class="hljs-comment">#persist-tun</span><br>ca ca.crt<br>cert magedu.crt<br>key magedu.key<br>remote-cert-tls server<br>tls-auth ta.key 1<br>cipher AES-256-CBC<br>verb 3<br>compress lz4-v2<br></code></pre></td></tr></table></figure>



<h2 id="五、-扩展知识"><a href="#五、-扩展知识" class="headerlink" title="五、 扩展知识"></a>五、 扩展知识</h2><h3 id="5-1-OpenVPN-Access-Server"><a href="#5-1-OpenVPN-Access-Server" class="headerlink" title="5.1 OpenVPN Access Server"></a>5.1 OpenVPN Access Server</h3><p>VPN Access Server 归属于 OpenVPN Solution，是官方推荐的VPN服务，它介于可收费与免费之间。</p>
<p>其实这个就是把 Openvpn Community 开源版做成了更方便，更稳定，优化过了的商业版。商业版有后台有基于Web的管理面板，也没有各种复杂和编译，而且只提供2个免费测试的USER，如果需要更多则需要购买许可证 5美元/用户。适合个人自用，不适合多人用。<br>参考文档: <a target="_blank" rel="noopener" href="https://openvpn.net/vpn-server-resources/finishing-configuration-of-access-server/">https://openvpn.net/vpn-server-resources/finishing-configuration-of-access-server/</a></p>
<h4 id="5-1-1-安装-OpenVpn-Access-Server"><a href="#5-1-1-安装-OpenVpn-Access-Server" class="headerlink" title="5.1.1 安装 OpenVpn Access Server"></a>5.1.1 安装 OpenVpn Access Server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注意:CentOS8 不支持下面包</span><br>ll openvpn-as-*<br>-rw-r--r-- 1 root root  32742864 Apr 28 20:04 openvpn-as-2.8.3_f28d2eae-<br>CentOS7.x86_64.rpm<br>-rw-r--r-- 1 root root 130562200 Apr 28 20:03 openvpn-as-bundled-clients-8.rpm<br><br>[root@centos7 ~]<span class="hljs-comment"># yum -y install openvpn-as-2.8.3_f28d2eae-CentOS7.x86_64.rpm</span><br>openvpn-as-bundled-clients-8.rpm<br>To reconfigure manually, use the /usr/<span class="hljs-built_in">local</span>/openvpn_as/bin/ovpn-init tool.<br>+++++++++++++++++++++++++++++++++++++++++++++++<br>Access Server 2.8.3 has been successfully installed <span class="hljs-keyword">in</span> /usr/<span class="hljs-built_in">local</span>/openvpn_as<br>Configuration <span class="hljs-built_in">log</span> file has been written to /usr/<span class="hljs-built_in">local</span>/openvpn_as/init.log<br>Access Server Web UIs are available here:<br>Admin UI: https://10.0.0.17:943/admin<br>Client UI: https://10.0.0.17:943/<br>+++++++++++++++++++++++++++++++++++++++++++++++<br>Verifying : openvpn-as-2.8.3_f28d2eae-CentOS7.x86_64            <br>                  1/4<br>Verifying : MySQL-python-1.2.5-1.el7.x86_64                 <br>                  2/4<br>Verifying : openvpn-as-bundled-clients-8-1.noarch              <br>                  3/4<br>Verifying : cyrus-sasl-2.1.26-23.el7.x86_64                 <br>                  4/4<br>Installed:<br>openvpn-as.x86_64 0:2.8.3_f28d2eae-CentOS7          openvpn-as-<br>bundled-clients.noarch 0:8-1         <br>Dependency Installed:<br>MySQL-python.x86_64 0:1.2.5-1.el7             cyrus-sasl.x86_64<br>0:2.1.26-23.el7            <br>Complete!<br><br>getent passwd openvpn<br>openvpn:x:1002:1002::/home/openvpn:/sbin/nologin<br><br>passwd openvpn<br>Changing password <span class="hljs-keyword">for</span> user openvpn.<br>New password:<br>BAD PASSWORD: The password is shorter than 8 characters<br>Retype new password:<br>passwd: all authentication tokens updated successfully.<br><br><span class="hljs-comment">#安装包后openvpnas.service 自动启动</span><br>[root@centos7 ~]<span class="hljs-comment"># systemctl status openvpnas.service</span><br>● openvpnas.service - OpenVPN Access Server Service<br> Loaded: loaded (/usr/lib/systemd/system/openvpnas.service; enabled; vendor<br>preset: disabled)<br> Active: active (running) since Wed 2020-08-05 22:26:16 CST; 50min ago<br>Main PID: 1408 (python2)<br> CGroup: /system.slice/openvpnas.service<br>     ├─1408 python2 -c from pyovpn.sagent.sagent_entry import openvpnas ;<br>openvpnas() --logfile=/var/<span class="hljs-built_in">log</span>/openvp...<br>├─1439 /usr/bin/python2 -c from pyovpn.log.logworker import start ;<br>start()<br>     ├─1440 /usr/bin/python2 -c from pyovpn.cserv.wserv_entry import start<br>; start() -no -u openvpn_as -g openv...<br>     ├─1479 /usr/bin/python2 -c from pyovpn.sagent.iptworker import start6<br>; start6()<br>     ├─1486 /usr/bin/python2 -c from pyovpn.sagent.iptworker import start<br>; start()<br>     ├─1494 openvpn-openssl --errors-to-stderr --config stdin<br>     ├─1499 openvpn-openssl --errors-to-stderr --config stdin<br>     └─1502 openvpn-openssl --errors-to-stderr --config stdin<br>Aug 05 22:26:15 centos7.wangxiaochun.com systemd[1]: Starting OpenVPN Access<br>Server Service...<br>Aug 05 22:26:16 centos7.wangxiaochun.com systemd[1]: Started OpenVPN Access<br>Server Service.<br>Aug 05 22:28:11 centos7.wangxiaochun.com python2[1408]:<br>pam_unix(openvpnas:auth): authentication failure; logname...nvpn<br>Aug 05 22:28:31 centos7.wangxiaochun.com python2[1408]:<br>pam_unix(openvpnas:auth): authentication failure; logname...nvpn<br>Aug 05 22:28:48 centos7.wangxiaochun.com python2[1408]:<br>pam_unix(openvpnas:auth): authentication failure; logname...nvpn<br>Hint: Some lines were ellipsized, use -l to show <span class="hljs-keyword">in</span> full.<br><br><span class="hljs-comment">#查看打开的相关端口</span><br>[root@centos7 ~]<span class="hljs-comment"># ss -ntlp</span><br>State   Recv-Q Send-Q       Local Address:Port    Peer Address:Port<br>      <br>LISTEN   0    50 127.0.0.1:909      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=15))<br>LISTEN   0    50     *:943      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=8))<br>LISTEN   0    128    *:22      *:*          users:<br>((<span class="hljs-string">&quot;sshd&quot;</span>,pid=827,fd=3))<br>LISTEN   0    100127.0.0.1:25      *:*          users:<br>((<span class="hljs-string">&quot;master&quot;</span>,pid=962,fd=13))<br>LISTEN   0    1     *:443      *:*          users:<br>((<span class="hljs-string">&quot;openvpn-openssl&quot;</span>,pid=1481,fd=5))<br>LISTEN   0    50 127.0.0.1:904      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=10))<br>LISTEN   0    50 127.0.0.1:905      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=11))<br>LISTEN   0    50 127.0.0.1:906      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=12))<br>LISTEN   0    50 127.0.0.1:907      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=13))<br>LISTEN   0    50 127.0.0.1:908      *:*          users:<br>((<span class="hljs-string">&quot;python2&quot;</span>,pid=1427,fd=14))<br>LISTEN   0    128   [::]:22     [::]:*          users:<br>((<span class="hljs-string">&quot;sshd&quot;</span>,pid=827,fd=4))<br>LISTEN   0    100  [::1]:25     [::]:*          users:<br>((<span class="hljs-string">&quot;master&quot;</span>,pid=962,fd=14))<br></code></pre></td></tr></table></figure>

<h4 id="5-1-2-登录服务器Admin-UI-进行管理"><a href="#5-1-2-登录服务器Admin-UI-进行管理" class="headerlink" title="5.1.2 登录服务器Admin UI 进行管理"></a>5.1.2 登录服务器Admin UI 进行管理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://openvpn-server:943/admin<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup66.jpg" srcset="/blog/img/loading.gif"></p>
<p>输入用户openvpn和上面设置的密码可以登录</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup67.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup68.jpg" srcset="/blog/img/loading.gif"></p>
<p>登录成功</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup69.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="5-1-3-从-Client-UI登录客户端连接地址下载相关文件"><a href="#5-1-3-从-Client-UI登录客户端连接地址下载相关文件" class="headerlink" title="5.1.3 从 Client UI登录客户端连接地址下载相关文件"></a>5.1.3 从 Client UI登录客户端连接地址下载相关文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://openvpn-server:943/<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup70.jpg" srcset="/blog/img/loading.gif"></p>
<p>选择下载相应的软件版本安装</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup71.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup72.jpg" srcset="/blog/img/loading.gif"></p>
<p>下载软件完成</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup73.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="5-1-4-安装客户端软件"><a href="#5-1-4-安装客户端软件" class="headerlink" title="5.1.4 安装客户端软件"></a>5.1.4 安装客户端软件</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup74.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup75.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup76.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup77.jpg" srcset="/blog/img/loading.gif"></p>
<p>安装完成</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup78.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="5-1-5-运行软件并登录"><a href="#5-1-5-运行软件并登录" class="headerlink" title="5.1.5 运行软件并登录"></a>5.1.5 运行软件并登录</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup79.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup80.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup81.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup82.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup83.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup84.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup85.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup86.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup87.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="5-1-6-验证登录"><a href="#5-1-6-验证登录" class="headerlink" title="5.1.6 验证登录"></a>5.1.6 验证登录</h4><h5 id="5-1-6-1-客户端查看登录"><a href="#5-1-6-1-客户端查看登录" class="headerlink" title="5.1.6.1 客户端查看登录"></a>5.1.6.1 客户端查看登录</h5><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/OpenVPN/openVPN-setup88.jpg" srcset="/blog/img/loading.gif"></p>
<h5 id="5-1-6-2-服务器查看日志"><a href="#5-1-6-2-服务器查看日志" class="headerlink" title="5.1.6.2 服务器查看日志"></a>5.1.6.2 服务器查看日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># tail /var/log/openvpnas.log -f</span><br>2020-09-18T07:57:05+0800 [stdout<span class="hljs-comment">#info] [OVPN 0] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br>TCP connection established with [AF_INET]10.0.0.1:6503<span class="hljs-string">&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;</span>Thu Sep 17 23:57:05 2020<br>Socket flags: TCP_NODELAY=1 succeeded<span class="hljs-string">&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;</span>Thu Sep 17 23:57:05 2020<br>10.0.0.1:6503 Non-OpenVPN client protocol detected<span class="hljs-string">&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;</span>Thu Sep 17 23:57:05 2020<br>10.0.0.1:6503 SIGTERM[soft,port-share-redirect] received, client-instance<br>exiting<span class="hljs-string">&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;</span>2020-09-18T07:57:05+0800<br>[pyovpn.xml.udscli.UDSProxyQueryFactory<span class="hljs-comment">#info] Starting factory</span><br>&lt;pyovpn.xml.udscli.UDSProxyQueryFactory instance at 0x7f76d7d328c0&gt;<span class="hljs-string">&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [twisted.python.log#info] &quot;-&quot; - - [17/Sep/2020:23:57:05</span><br><span class="hljs-string">+0000] &quot;POST /RPC2 HTTP/1.0&quot; 200 1240 &quot;-&quot; &quot;Twisted/XMLRPClib&quot;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;</span>2020-09-18T07:57:05+0800<br>[twisted.python.log<span class="hljs-comment">#info] &quot;127.0.0.1&quot; - - [17/Sep/2020:23:57:05 +0000] &quot;POST</span><br>/RPC2 HTTP/1.1<span class="hljs-string">&quot; 200 297 &quot;</span>-<span class="hljs-string">&quot; &quot;</span>-<span class="hljs-string">&quot;&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;2020-09-18T07:57:05+0800</span><br><span class="hljs-string">[pyovpn.xml.udscli.UDSProxyQueryFactory#info] Stopping factory</span><br><span class="hljs-string">&lt;pyovpn.xml.udscli.UDSProxyQueryFactory instance at 0x7f76d7d328c0&gt;&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">TCP connection established with [AF_INET]10.0.0.1:6504&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">Socket flags: TCP_NODELAY=1 succeeded&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:6504 Non-OpenVPN client protocol detected&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 0] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:6504 SIGTERM[soft,port-share-redirect] received, client-instance</span><br><span class="hljs-string">exiting&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;2020-09-18T07:57:05+0800</span><br><span class="hljs-string">[pyovpn.xml.udscli.UDSProxyQueryFactory#info] Starting factory</span><br><span class="hljs-string">&lt;pyovpn.xml.udscli.UDSProxyQueryFactory instance at 0x7f76d7cfdef0&gt;&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [twisted.python.log#info] &quot;</span>-<span class="hljs-string">&quot; - - [17/Sep/2020:23:57:05</span><br><span class="hljs-string">+0000] &quot;</span>POST /RPC2 HTTP/1.0<span class="hljs-string">&quot; 200 10020 &quot;</span>-<span class="hljs-string">&quot; &quot;</span>Twisted/XMLRPClib<span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;2020-09-18T07:57:05+0800</span><br><span class="hljs-string">[twisted.python.log#info] &quot;</span>127.0.0.1<span class="hljs-string">&quot; - - [17/Sep/2020:23:57:05 +0000] &quot;</span>POST<br>/RPC2 HTTP/1.1<span class="hljs-string">&quot; 200 10020 &quot;</span>-<span class="hljs-string">&quot; &quot;</span>-<span class="hljs-string">&quot;&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [WEB] OUT: &#x27;2020-09-18T07:57:05+0800</span><br><span class="hljs-string">[pyovpn.xml.udscli.UDSProxyQueryFactory#info] Stopping factory</span><br><span class="hljs-string">&lt;pyovpn.xml.udscli.UDSProxyQueryFactory instance at 0x7f76d7cfdef0&gt;&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 TLS: Initial packet from [AF_INET]10.0.0.1:65018 (via</span><br><span class="hljs-string">[AF_INET]10.0.0.7%eth0), sid=daedad3d 3c2e53b5&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 VERIFY OK: depth=1, /CN=OpenVPN CA&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 VERIFY OK: nsCertType=CLIENT&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 VERIFY OK: depth=0, /CN=openvpn&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_GUI_VER=OCmacOS_3.1.3-713&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_VER=3.git::f225fcd0&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_PLAT=win&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_NCP=2&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_TCPNL=1&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_PROTO=2&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_LZO_STUB=1&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_COMP_STUB=1&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_COMP_STUBv2=1&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 peer info: IV_HWADDR=00:2b:67:bd:6b:d1&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:05 2020<br>10.0.0.1:65018 TLS: Username/Password authentication deferred <span class="hljs-keyword">for</span> username<br><span class="hljs-string">&#x27;openvpn&#x27;</span> <span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] AUTH SUCCESS &#123;&#x27;status&#x27;: 0, &#x27;session_id&#x27;:</span><br><span class="hljs-string">&#x27;[redacted]&#x27;, &#x27;reason&#x27;: &#x27;SESSION_ID found existing web authed session, allowing</span><br><span class="hljs-string">VPN session&#x27;, &#x27;serial_list&#x27;: [], &#x27;user&#x27;: &#x27;openvpn&#x27;, &#x27;proplist&#x27;:</span><br><span class="hljs-string">&#123;u&#x27;pvt_google_auth_secret_locked&#x27;: u&#x27;false&#x27;, u&#x27;prop_autogenerate&#x27;: u&#x27;true&#x27;,</span><br><span class="hljs-string">&#x27;prop_deny&#x27;: &#x27;false&#x27;, u&#x27;pvt_google_auth_secret&#x27;: &#x27;[redacted]&#x27;, u&#x27;type&#x27;:</span><br><span class="hljs-string">u&#x27;user_compile&#x27;, u&#x27;prop_superuser&#x27;: u&#x27;true&#x27;&#125;, &#x27;common_name&#x27;: u&#x27;openvpn&#x27;,</span><br><span class="hljs-string">&#x27;serial&#x27;: &#x27;2&#x27;, &#x27;create_new_session&#x27;: True&#125;</span><br><span class="hljs-string">cli=u&#x27;win&#x27;/u&#x27;3.git::f225fcd0&#x27;/u&#x27;OCmacOS_3.1.3-713&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:05 2020<br>MANAGEMENT: CMD <span class="hljs-string">&#x27;client-auth 1 0&#x27;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 Control Channel: TLSv1.2, cipher TLSv1/SSLv3 ECDHE-RSA-AES256-</span><br><span class="hljs-string">GCM-SHA384, 2048 bit RSA&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">10.0.0.1:65018 [openvpn] Peer Connection Initiated with [AF_INET]10.0.0.1:65018</span><br><span class="hljs-string">(via [AF_INET]10.0.0.7%eth0)&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:05 2020<br>10.0.0.1:65018 PUSH: Received control message: <span class="hljs-string">&#x27;PUSH_REQUEST&#x27;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">openvpn/10.0.0.1:65018 OPTIONS IMPORT: compression parms modified&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">openvpn/10.0.0.1:65018 MULTI: Learn: 172.27.232.3 -&gt; openvpn/10.0.0.1:65018&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:05+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:05 2020</span><br><span class="hljs-string">openvpn/10.0.0.1:65018 MULTI: primary virtual IP for openvpn/10.0.0.1:65018:</span><br><span class="hljs-string">172.27.232.3&#x27;</span><br><span class="hljs-string">2020-09-18T07:57:06+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:06 2020<br>openvpn/10.0.0.1:65018 PUSH: Received control message: <span class="hljs-string">&#x27;PUSH_REQUEST&#x27;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:06+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:06 2020<br>openvpn/10.0.0.1:65018 SENT CONTROL [openvpn]: <span class="hljs-string">&#x27;PUSH_REPLY,explicit-exit-</span><br><span class="hljs-string">notify,topology subnet,route-delay 5 30,dhcp-pre-release,dhcp-renew,dhcp-</span><br><span class="hljs-string">release,route-metric 101,ping 12,ping-restart 50,compress stub-v2,redirect-</span><br><span class="hljs-string">gateway def1,redirect-gateway bypass-dhcp,redirect-gateway autolocal,route-</span><br><span class="hljs-string">gateway 172.27.232.1,dhcp-option DNS 223.6.6.6,dhcp-option DNS</span><br><span class="hljs-string">180.76.76.76,register-dns,block-ipv6,ifconfig 172.27.232.3 255.255.248.0,peer-id</span><br><span class="hljs-string">0,auth-tokenSESS_ID,cipher AES-256-GCM&#x27;</span> (status=1)<span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:06+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:06 2020<br>openvpn/10.0.0.1:65018 Data Channel: using negotiated cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:06+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:06 2020<br>openvpn/10.0.0.1:65018 Outgoing Data Channel: Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized<br>with 256 bit key<span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:06+0800 [stdout#info] [OVPN 1] OUT: &quot;</span>Thu Sep 17 23:57:06 2020<br>openvpn/10.0.0.1:65018 Incoming Data Channel: Cipher <span class="hljs-string">&#x27;AES-256-GCM&#x27;</span> initialized<br>with 256 bit key<span class="hljs-string">&quot;</span><br><span class="hljs-string">2020-09-18T07:57:12+0800 [stdout#info] [OVPN 1] OUT: &#x27;Thu Sep 17 23:57:12 2020</span><br><span class="hljs-string">openvpn/10.0.0.1:65018 IP packet with unknown IP version=0 seen&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-2-docker-运行OpenVPN-Access-Server"><a href="#5-2-docker-运行OpenVPN-Access-Server" class="headerlink" title="5.2 docker 运行OpenVPN Access Server"></a>5.2 docker 运行OpenVPN Access Server</h3><p>参考链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://hub.docker.com/r/linuxserver/openvpn-as<br></code></pre></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/Linux-OpenVPN/">Linux OpenVPN</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/03/11/%E8%BF%90%E7%BB%B4%E8%87%AA%E8%BF%90%E5%8C%96%E4%B9%8BANSIBLE/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">运维自运化之ANSIBLE</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/02/27/%E9%AB%98%E6%80%A7%E8%83%BDWEB%E6%9C%8D%E5%8A%A1Nginx%EF%BC%88%E4%B8%89%EF%BC%89Nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/">
                        <span class="hidden-mobile">高性能WEB服务Nginx（三）Nginx核心配置和高级配置</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
