

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>企业级反向代理HAPROXY - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="企业级反向代理HAPROXY">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-06-07 20:09" pubdate>
        2021年6月7日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      28.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      453
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">企业级反向代理HAPROXY</h1>
            
            <div class="markdown-body">
              <h1 id="企业级反向代理HAPROXY"><a href="#企业级反向代理HAPROXY" class="headerlink" title="企业级反向代理HAPROXY"></a>企业级反向代理HAPROXY</h1><h2 id="一、web架构介绍"><a href="#一、web架构介绍" class="headerlink" title="一、web架构介绍"></a>一、web架构介绍</h2><h3 id="1-1-单机房架构"><a href="#1-1-单机房架构" class="headerlink" title="1.1 单机房架构"></a>1.1 单机房架构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy1.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-2-多机房架构"><a href="#1-2-多机房架构" class="headerlink" title="1.2 多机房架构"></a>1.2 多机房架构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy2.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-3-公有云架构"><a href="#1-3-公有云架构" class="headerlink" title="1.3 公有云架构"></a>1.3 公有云架构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy3.png" srcset="/blog/img/loading.gif"></p>
<h3 id="1-4-私有云架构"><a href="#1-4-私有云架构" class="headerlink" title="1.4 私有云架构"></a>1.4 私有云架构</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy4.png" srcset="/blog/img/loading.gif"></p>
<h2 id="二、负载均衡简介"><a href="#二、负载均衡简介" class="headerlink" title="二、负载均衡简介"></a>二、负载均衡简介</h2><p>负载均衡：Load Balance，简称LB，是一种服务或基于硬件设备等实现的高可用反向代理技术，负载<br>均衡将特定的业务(web服务、网络流量等)分担给指定的一个或多个后端特定的服务器或设备，从而提<br>高了公司业务的并发处理能力、保证了业务的高可用性、方便了业务后期的水平动态扩展<br>阿里云SLB介绍 ：<a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/1803">https://yq.aliyun.com/articles/1803</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy5.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-1-为什么使用负载均衡"><a href="#2-1-为什么使用负载均衡" class="headerlink" title="2.1 为什么使用负载均衡"></a>2.1 为什么使用负载均衡</h3><ul>
<li>Web服务器的动态水平扩展–&gt;对用户无感知</li>
<li>增加业务并发访问及处理能力–&gt;解决单服务器瓶颈问题</li>
<li>节约公网IP地址–&gt;降低IT支出成本</li>
<li>隐藏内部服务器IP–&gt;提高内部服务器安全性</li>
<li>配置简单–&gt;固定格式的配置文件</li>
<li>功能丰富–&gt;支持四层和七层，支持动态下线主机</li>
<li>性能较强–&gt;并发数万甚至数十万</li>
</ul>
<h3 id="2-2-负载均衡类型"><a href="#2-2-负载均衡类型" class="headerlink" title="2.2 负载均衡类型"></a>2.2 负载均衡类型</h3><p>四层：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">LVS：Linux Virtual Server<br>Nginx：1.9版之后<br>HAProxy：High Availability Proxy<br></code></pre></td></tr></table></figure>

<p>七层：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">HAProxy<br>Nginx<br></code></pre></td></tr></table></figure>

<p>硬件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">F5    https://f5.com/zh<br>Netscaler https://www.citrix.com.cn/products/citrix-adc/<br>Array   https://www.arraynetworks.com.cn/<br>深信服    http://www.sangfor.com.cn/<br>北京灵州   http://www.lingzhou.com.cn/cpzx/llfzjh/<br></code></pre></td></tr></table></figure>

<h3 id="2-3-应用场景"><a href="#2-3-应用场景" class="headerlink" title="2.3 应用场景"></a>2.3 应用场景</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">四层：Redis、Mysql、RabbitMQ、Memcache等<br>七层：Nginx、Tomcat、Apache、PHP、图片、动静分离、API等<br></code></pre></td></tr></table></figure>

<p>随着公司业务的发展，公司负载均衡服务既有四层的，又有七层的，通过LVS实现四层和Nginx实现七<br>层的负载均衡对机器资源消耗比较大，并且管理复杂度提升，运维总监要求，目前需要对前端负载均衡服务进行一定的优化和复用，能否用一种服务同既能实现七层负载均衡，又能实现四层负载均衡，并且性能高效，配置管理容易，而且还是开源。</p>
<p>在企业生产环境中，每天会有很多的需求变更，比如增加服务器、新业务上线、url路由修改、域名配置等等，对于前端负载均衡设备来说，容易维护，复杂度低，是首选指标。在企业中，稳定压倒一切，与其搞得很复杂，经常出问题，不如做的简单和稳定。在企业中，90%以上的故障，来源于需求变更。可能是程序bug，也可能是人为故障，也可能是架构设计问题等。前端负载均衡设备为重中之重，在软件选型上一定充分考虑，能满足业务的前提下，尽可能降低复杂度，提高易维护性</p>
<h3 id="2-4-HAProxy介绍"><a href="#2-4-HAProxy介绍" class="headerlink" title="2.4 HAProxy介绍"></a>2.4 HAProxy介绍</h3><p>HAProxy是法国开发者 威利塔罗(Willy Tarreau) 在2000年使用C语言开发的一个开源软件，是一款具<br>备高并发(一万以上)、高性能的TCP和HTTP负载均衡器，支持基于cookie的持久性，自动故障切换，支持正则表达式及web状态统计，目前最新TLS版本为2.2</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy6.png" srcset="/blog/img/loading.gif"></p>
<p><strong>历史版本：</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy7.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">历史版本更新功能：1.4 1.5 1.6 1.7 1.8 1.9 2.0 2.1 2.2 2.3 2.4-dev<br>1.8：多线程，HTTP/2缓存……<br>1.7：服务器动态配置，多类型证书……<br>1.6：DNS解析支持，HTTP连接多路复用……<br>1.5：开始支持SSL，IPV6，会话保持……<br></code></pre></td></tr></table></figure>

<p>从2013年HAProxy 分为社区版和企业版，企业版将提供更多的特性和功能以及全天24小时的技术支持<br>等服务。</p>
<h4 id="2-4-1-企业版"><a href="#2-4-1-企业版" class="headerlink" title="2.4.1 企业版"></a>2.4.1 企业版</h4><p>企业版网站：<a target="_blank" rel="noopener" href="https://www.haproxy.com/">https://www.haproxy.com/</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy8.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-4-2-社区版"><a href="#2-4-2-社区版" class="headerlink" title="2.4.2 社区版"></a>2.4.2 社区版</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy9.png" srcset="/blog/img/loading.gif"></p>
<p>社区版网站：<a target="_blank" rel="noopener" href="http://www.haproxy.org/">http://www.haproxy.org/</a><br>github：<a target="_blank" rel="noopener" href="https://github.com/haproxy">https://github.com/haproxy</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy10.png" srcset="/blog/img/loading.gif"></p>
<h4 id="2-4-3-版本对比"><a href="#2-4-3-版本对比" class="headerlink" title="2.4.3 版本对比"></a>2.4.3 版本对比</h4><table>
<thead>
<tr>
<th>功能</th>
<th>社区版</th>
<th>企业版</th>
</tr>
</thead>
<tbody><tr>
<td>高级HTTP / TCP负载平衡和持久性</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>高级健康检查</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>应用程序加速</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>高级安全特性</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>高级管理</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>HAProxy Dev Branch新功能</td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>24*7 支持服务</td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>实时仪表盘</td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>VRRP和Route Health Injection HA工具</td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>基于应用程序的高级DDoS和Bot保护(自动保护)</td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>Bot(机器人)监测</td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>ACL，映射和TLS票证密钥同步</td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>Web应用防火墙</td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>HTTP协议验证</td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>实时集群追踪</td>
<td></td>
<td>支持</td>
</tr>
</tbody></table>
<h4 id="2-4-4-HAProxy功能"><a href="#2-4-4-HAProxy功能" class="headerlink" title="2.4.4 HAProxy功能"></a>2.4.4 HAProxy功能</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy11.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy12.png" srcset="/blog/img/loading.gif"></p>
<p>支持功能：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">TCP 和 HTTP反向代理<br>SSL/TSL服务器<br>可以针对HTTP请求添加cookie，进行路由后端服务器<br>可平衡负载至后端服务器，并支持持久连接<br>支持所有主服务器故障切换至备用服务器<br>支持专用端口实现监控服务<br>支持停止接受新连接请求，而不影响现有连接<br>可以在双向添加，修改或删除HTTP报文首部<br>响应报文压缩<br>支持基于pattern实现连接请求的访问控制<br>通过特定的URI为授权用户提供详细的状态信息<br>后端服务器只能看到haproxy服务器的ip地址对自己进项访问<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy13.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">支持http反向代理<br>支持动态程序的反向代理<br>支持基于数据库的反向代理<br></code></pre></td></tr></table></figure>

<p><strong>不具备的功能：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">正向代理--squid，nginx<br>缓存代理--varnish<br>web服务--nginx、tengine、apache、php、tomcat<br>UDP--目前不支持UDP协议<br>单机性能--相比LVS性能较差<br></code></pre></td></tr></table></figure>



<h2 id="三、HAProxy安装及基础配置"><a href="#三、HAProxy安装及基础配置" class="headerlink" title="三、HAProxy安装及基础配置"></a>三、HAProxy安装及基础配置</h2><p><strong>介绍HAProxy的基础安装及基础配置</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy14.png" srcset="/blog/img/loading.gif"></p>
<p>内网IP地址划分：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#外部网段：</span><br>172.16.0.0/16<br><br><span class="hljs-comment">#内部网段：</span><br>10.0.0.0/24<br><br><span class="hljs-comment">#可用地址范围：</span><br>10.0.0.1--10.0.0.254<br></code></pre></td></tr></table></figure>

<h3 id="3-1-Ubuntu-安装"><a href="#3-1-Ubuntu-安装" class="headerlink" title="3.1 Ubuntu 安装"></a>3.1 Ubuntu 安装</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy15.png" srcset="/blog/img/loading.gif"></p>
<p>打开链接： <a target="_blank" rel="noopener" href="https://haproxy.debian.net/">https://haproxy.debian.net/</a> ，选择合适的版本，会自动出现下面安装提示</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy16.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#apt-get install software-properties-common</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#add-apt-repository ppa:vbernat/haproxy-2.0</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt update</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt-cache madison haproxy</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt install haproxy=2.0.4-1ppa1~bionic</span><br><br><span class="hljs-comment">#或安装最新版</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt-get install haproxy=2.0.\*</span><br><br><span class="hljs-comment">#验证haproxy版本</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#haproxy -v</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu1804 ~]<span class="hljs-comment">#apt-get install software-properties-common</span><br>Reading package lists... Done<br>Building dependency tree   <br>Reading state information... Done<br>The following additional packages will be installed:<br>python3-software-properties<br>The following packages will be upgraded:<br>python3-software-properties software-properties-common<br>2 upgraded, 0 newly installed, 0 to remove and 252 not upgraded.<br>Need to get 33.6 kB of archives.<br>After this operation, 13.3 kB of additional disk space will be used.<br>Do you want to <span class="hljs-built_in">continue</span>? [Y/n] y<br>Get:1 http://mirrors.aliyun.com/ubuntu bionic-updates/main amd64 software-<br>properties-common all 0.96.24.32.12 [10.0 kB]<br>Get:2 http://mirrors.aliyun.com/ubuntu bionic-updates/main amd64 python3-<br>software-properties all 0.96.24.32.12 [23.6 kB]<br>Fetched 33.6 kB <span class="hljs-keyword">in</span> 5s (6,528 B/s)        <br>(Reading database ... 71030 files and directories currently installed.)<br>Preparing to unpack .../software-properties-common_0.96.24.32.12_all.deb ...<br>Unpacking software-properties-common (0.96.24.32.12) over (0.96.24.32.4) ...<br>Preparing to unpack .../python3-software-properties_0.96.24.32.12_all.deb ...<br>Unpacking python3-software-properties (0.96.24.32.12) over (0.96.24.32.4) ...<br>Processing triggers <span class="hljs-keyword">for</span> man-db (2.8.3-2) ...<br>Setting up python3-software-properties (0.96.24.32.12) ...<br>Processing triggers <span class="hljs-keyword">for</span> dbus (1.12.2-1ubuntu1) ...<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#add-apt-repository ppa:vbernat/haproxy-2.0</span><br>HAProxy is a free, very fast and reliable solution offering high availability,<br>load balancing, and proxying <span class="hljs-keyword">for</span> TCP and HTTP-based applications. It is<br>particularly suited <span class="hljs-keyword">for</span> web sites crawling under very high loads <span class="hljs-keyword">while</span> needing<br>persistence or Layer7 processing. Supporting tens of thousands of connections is<br>clearly realistic with todays hardware. Its mode of operation makes its<br>integration into existing architectures very easy and riskless, <span class="hljs-keyword">while</span> still<br>offering the possibility not to expose fragile web servers to the Net.<br>This PPA contains packages <span class="hljs-keyword">for</span> HAProxy 2.0.<br>More info: https://launchpad.net/~vbernat/+archive/ubuntu/haproxy-2.0<br>Press [ENTER] to <span class="hljs-built_in">continue</span> or Ctrl-c to cancel adding it.<br>Hit:1 http://mirrors.aliyun.com/ubuntu bionic InRelease<br>Hit:2 http://mirrors.aliyun.com/ubuntu bionic-security InRelease<br>Hit:3 http://mirrors.aliyun.com/ubuntu bionic-updates InRelease        <br>    <br>Hit:4 http://mirrors.aliyun.com/ubuntu bionic-proposed InRelease        <br>   <br>Hit:5 http://mirrors.aliyun.com/ubuntu bionic-backports InRelease       <br>    <br>Get:6 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic InRelease [20.7<br>kB]  <br>Get:7 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main i386<br>Packages [984 B]<br>Get:8 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main amd64<br>Packages [988 B]<br>Get:9 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main<br>Translation-en [704 B]<br>Fetched 23.4 kB <span class="hljs-keyword">in</span> 6s (3,971 B/s)   <br>Reading package lists... Done<br><br>[root@ubuntu1804 ~]<span class="hljs-comment"># apt-get update</span><br>Hit:1 http://mirrors.aliyun.com/ubuntu bionic InRelease<br>Hit:2 http://mirrors.aliyun.com/ubuntu bionic-security InRelease        <br>   <br>Hit:3 http://mirrors.aliyun.com/ubuntu bionic-updates InRelease        <br>    <br>Hit:4 http://mirrors.aliyun.com/ubuntu bionic-proposed InRelease        <br>   <br>Hit:5 http://mirrors.aliyun.com/ubuntu bionic-backports InRelease       <br>    <br>Hit:6 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic InRelease   <br>   <br>Reading package lists... Done<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt-get install haproxy=2.0.\*</span><br>Reading package lists... Done<br>Building dependency tree   <br>Reading state information... Done<br>Selected version <span class="hljs-string">&#x27;2.0.13-1ppa1~bionic&#x27;</span> (HAProxy 2.0:18.04/bionic [amd64]) <span class="hljs-keyword">for</span><br><span class="hljs-string">&#x27;haproxy&#x27;</span><br>The following additional packages will be installed:<br>liblua5.3-0 libpcre2-8-0<br>Suggested packages:<br>vim-haproxy haproxy-doc<br>The following NEW packages will be installed:<br>haproxy liblua5.3-0 libpcre2-8-0<br>0 upgraded, 3 newly installed, 0 to remove and 252 not upgraded.<br>Need to get 1,526 kB/1,819 kB of archives.<br>After this operation, 4,246 kB of additional disk space will be used.<br>Do you want to <span class="hljs-built_in">continue</span>? [Y/n] y<br>Get:1 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main amd64<br>haproxy amd64 2.0.13-1ppa1~bionic [1,526 kB]<br>Fetched 572 kB <span class="hljs-keyword">in</span> 26s (22.1 kB/s)                       <br>    <br>Selecting previously unselected package liblua5.3-0:amd64.<br>(Reading database ... 71032 files and directories currently installed.)<br>Preparing to unpack .../liblua5.3-0_5.3.3-1ubuntu0.18.04.1_amd64.deb ...<br>Unpacking liblua5.3-0:amd64 (5.3.3-1ubuntu0.18.04.1) ...<br>Selecting previously unselected package libpcre2-8-0:amd64.<br>Preparing to unpack .../libpcre2-8-0_10.31-2_amd64.deb ...<br>Unpacking libpcre2-8-0:amd64 (10.31-2) ...<br>Selecting previously unselected package haproxy.<br>Preparing to unpack .../haproxy_2.0.13-1ppa1~bionic_amd64.deb ...<br>Unpacking haproxy (2.0.13-1ppa1~bionic) ...<br>Processing triggers <span class="hljs-keyword">for</span> ureadahead (0.100.0-20) ...<br>Processing triggers <span class="hljs-keyword">for</span> libc-bin (2.27-3ubuntu1) ...<br>Processing triggers <span class="hljs-keyword">for</span> systemd (237-3ubuntu10.3) ...<br>Processing triggers <span class="hljs-keyword">for</span> man-db (2.8.3-2) ...<br>Setting up libpcre2-8-0:amd64 (10.31-2) ...<br>Setting up liblua5.3-0:amd64 (5.3.3-1ubuntu0.18.04.1) ...<br>Processing triggers <span class="hljs-keyword">for</span> rsyslog (8.32.0-1ubuntu4) ...<br>Setting up haproxy (2.0.13-1ppa1~bionic) ...<br>Created symlink /etc/systemd/system/multi-user.target.wants/haproxy.service →<br>/lib/systemd/system/haproxy.service.<br>Processing triggers <span class="hljs-keyword">for</span> libc-bin (2.27-3ubuntu1) ...<br>Processing triggers <span class="hljs-keyword">for</span> ureadahead (0.100.0-20) ...<br>Processing triggers <span class="hljs-keyword">for</span> systemd (237-3ubuntu10.3) ...<br>Processing triggers <span class="hljs-keyword">for</span> rsyslog (8.32.0-1ubuntu4) ...<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt-cache madison haproxy</span><br> haproxy | 2.0.13-1ppa1~bionic | http://ppa.launchpad.net/vbernat/haproxy-<br>2.0/ubuntu bionic/main amd64 Packages<br> haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-<br>security/main amd64 Packages<br> haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-<br>updates/main amd64 Packages<br> haproxy |   1.8.8-1 | http://mirrors.aliyun.com/ubuntu bionic/main amd64<br>Packages<br> haproxy |   1.8.8-1 | http://mirrors.aliyun.com/ubuntu bionic/main Sources<br> haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-<br>security/main Sources<br> haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-<br>updates/main Sources<br><br>[root@ubuntu1804 ~]<span class="hljs-comment">#haproxy -v</span><br>HA-Proxy version 2.0.13-1ppa1~bionic 2020/02/15 - https://haproxy.org/<br></code></pre></td></tr></table></figure>

<h3 id="3-2-CentOS-安装"><a href="#3-2-CentOS-安装" class="headerlink" title="3.2 CentOS 安装"></a>3.2 CentOS 安装</h3><p>在centos 系统上通过 yum、编译等多种安装方式</p>
<h4 id="3-2-1-系统默认yum源"><a href="#3-2-1-系统默认yum源" class="headerlink" title="3.2.1 系统默认yum源"></a>3.2.1 系统默认yum源</h4><p>CentOS 7 的默认的base仓库中包含haproxy的安装包文件，但是版本比较旧，是1.5.18的版本，距离<br>当前版本已经有较长时间没有更新，由于版本比较旧所以有很多功能不支持，如果对功能和性能没有要求可以使用此版本，否则推荐使用新版本。</p>
<p>范例：CentOS 7 安装haproxy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum install haproxy -y</span><br><span class="hljs-comment">#验证haproxy版本</span><br><br>[root@centos7 ~]<span class="hljs-comment"># haproxy -v</span><br>HA-Proxy version 1.5.18 2016/05/10<br>Copyright 2000-2016 Willy Tarreau &lt;willy@haproxy.org&gt;<br><br>[root@centos7 ~]<span class="hljs-comment"># rpm -ql haproxy</span><br>/etc/haproxy<br>/etc/haproxy/haproxy.cfg<br>/etc/logrotate.d/haproxy<br>/etc/sysconfig/haproxy<br>/usr/bin/halog<br>/usr/bin/iprange<br>/usr/lib/systemd/system/haproxy.service<br>/usr/sbin/haproxy<br>/usr/sbin/haproxy-systemd-wrapper<br>/usr/share/doc/haproxy-1.5.18<br>/usr/share/doc/haproxy-1.5.18/CHANGELOG<br>/usr/share/doc/haproxy-1.5.18/LICENSE<br>/usr/share/doc/haproxy-1.5.18/README<br>/usr/share/doc/haproxy-1.5.18/ROADMAP<br>/usr/share/doc/haproxy-1.5.18/VERSION<br>/usr/share/doc/haproxy-1.5.18/acl.fig<br>/usr/share/doc/haproxy-1.5.18/architecture.txt<br>/usr/share/doc/haproxy-1.5.18/close-options.txt<br>/usr/share/doc/haproxy-1.5.18/coding-style.txt<br>/usr/share/doc/haproxy-1.5.18/configuration.txt<br>/usr/share/doc/haproxy-1.5.18/cookie-options.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/backends-v0.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/backends.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/be-fe-changes.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/binding-possibilities.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/buffer-redesign.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/buffers.fig<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/config-language.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/connection-reuse.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/cttproxy-changes.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/entities-v2.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/how-it-works.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/http_load_time.url<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/rate-shaping.txt<br>/usr/share/doc/haproxy-1.5.18/design-thoughts/sess_par_sec.txt<br>/usr/share/doc/haproxy-1.5.18/examples<br>/usr/share/doc/haproxy-1.5.18/examples/acl-content-sw.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/auth.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/build.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/content-sw-sample.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/cttproxy-src.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/examples.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/haproxy.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/option-http_proxy.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/ssl.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/tarpit.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/test-section-kw.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/transparent_proxy.cfg<br>/usr/share/doc/haproxy-1.5.18/examples/url-switching.cfg<br>/usr/share/doc/haproxy-1.5.18/gpl.txt<br>/usr/share/doc/haproxy-1.5.18/haproxy-en.txt<br>/usr/share/doc/haproxy-1.5.18/haproxy-fr.txt<br>/usr/share/doc/haproxy-1.5.18/haproxy.1<br>/usr/share/doc/haproxy-1.5.18/internals<br>/usr/share/doc/haproxy-1.5.18/internals/acl.txt<br>/usr/share/doc/haproxy-1.5.18/internals/body-parsing.txt<br>/usr/share/doc/haproxy-1.5.18/internals/buffer-operations.txt<br>/usr/share/doc/haproxy-1.5.18/internals/buffer-ops.fig<br>/usr/share/doc/haproxy-1.5.18/internals/connect-status.txt<br>/usr/share/doc/haproxy-1.5.18/internals/connection-header.txt<br>/usr/share/doc/haproxy-1.5.18/internals/connection-scale.txt<br>/usr/share/doc/haproxy-1.5.18/internals/entities.fig<br>/usr/share/doc/haproxy-1.5.18/internals/entities.pdf<br>/usr/share/doc/haproxy-1.5.18/internals/entities.svg<br>/usr/share/doc/haproxy-1.5.18/internals/entities.txt<br>/usr/share/doc/haproxy-1.5.18/internals/hashing.txt<br>/usr/share/doc/haproxy-1.5.18/internals/header-parser-speed.txt<br>/usr/share/doc/haproxy-1.5.18/internals/header-tree.txt<br>/usr/share/doc/haproxy-1.5.18/internals/http-cookies.txt<br>/usr/share/doc/haproxy-1.5.18/internals/http-docs.txt<br>/usr/share/doc/haproxy-1.5.18/internals/http-parsing.txt<br>/usr/share/doc/haproxy-1.5.18/internals/naming.txt<br>/usr/share/doc/haproxy-1.5.18/internals/pattern.dia<br>/usr/share/doc/haproxy-1.5.18/internals/pattern.pdf<br>/usr/share/doc/haproxy-1.5.18/internals/polling-states.fig<br>/usr/share/doc/haproxy-1.5.18/internals/repartition-be-fe-fi.txt<br>/usr/share/doc/haproxy-1.5.18/internals/sequence.fig<br>/usr/share/doc/haproxy-1.5.18/internals/stats-v2.txt<br>/usr/share/doc/haproxy-1.5.18/internals/stream-sock-states.fig<br>/usr/share/doc/haproxy-1.5.18/internals/todo.cttproxy<br>/usr/share/doc/haproxy-1.5.18/lgpl.txt<br>/usr/share/doc/haproxy-1.5.18/proxy-protocol.txt<br>/usr/share/doc/haproxy-1.5.18/queuing.fig<br>/usr/share/haproxy<br>/usr/share/haproxy/400.http<br>/usr/share/haproxy/403.http<br>/usr/share/haproxy/408.http<br>/usr/share/haproxy/500.http<br>/usr/share/haproxy/502.http<br>/usr/share/haproxy/503.http<br>/usr/share/haproxy/504.http<br>/usr/share/haproxy/README<br>/usr/share/man/man1/halog.1.gz<br>/usr/share/man/man1/haproxy.1.gz<br>/var/lib/haproxy<br></code></pre></td></tr></table></figure>

<p>范例：CentOS 8 安装haproxy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#yum -y install haproxy</span><br>[root@centos8 ~]<span class="hljs-comment">#haproxy -v</span><br>HA-Proxy version 1.8.15 2018/12/13<br>Copyright 2000-2018 Willy Tarreau &lt;willy@haproxy.org&gt;<br>[root@centos8 ~]<span class="hljs-comment">#haproxy -vv</span><br>HA-Proxy version 1.8.15 2018/12/13<br>Copyright 2000-2018 Willy Tarreau &lt;willy@haproxy.org&gt;<br>Build options :<br>TARGET  = linux2628<br>CPU   = generic<br>CC    = gcc<br>CFLAGS  = -O2 -g -fno-strict-aliasing -Wdeclaration-after-statement -fwrapv -<br>Wno-format-truncation -Wno-null-dereference -Wno-unused-label<br>OPTIONS = USE_LINUX_TPROXY=1 USE_CRYPT_H=1 USE_GETADDRINFO=1 USE_ZLIB=1<br>USE_REGPARM=1 USE_OPENSSL=1 USE_LUA=1 USE_SYSTEMD=1 USE_PCRE=1<br>Default settings :<br>maxconn = 2000, bufsize = 16384, maxrewrite = 1024, maxpollevents = 200<br>Built with OpenSSL version : OpenSSL 1.1.1 FIPS  11 Sep 2018<br>Running on OpenSSL version : OpenSSL 1.1.1c FIPS  28 May 2019<br>OpenSSL library supports TLS extensions : yes<br>OpenSSL library supports SNI : yes<br>OpenSSL library supports : TLSv1.0 TLSv1.1 TLSv1.2 TLSv1.3<br>Built with Lua version : Lua 5.3.4<br>Built with transparent proxy support using: IP_TRANSPARENT IPV6_TRANSPARENT<br>IP_FREEBIND<br>Encrypted password support via crypt(3): yes<br>Built with multi-threading support.<br>Built with PCRE version : 8.42 2018-03-20<br>Running on PCRE version : 8.42 2018-03-20<br>PCRE library supports JIT : no (USE_PCRE_JIT not <span class="hljs-built_in">set</span>)<br>Built with zlib version : 1.2.11<br>Running on zlib version : 1.2.11<br>Compression algorithms supported : identity(<span class="hljs-string">&quot;identity&quot;</span>), deflate(<span class="hljs-string">&quot;deflate&quot;</span>),<br>raw-deflate(<span class="hljs-string">&quot;deflate&quot;</span>), gzip(<span class="hljs-string">&quot;gzip&quot;</span>)<br>Built with network namespace support.<br>Available polling systems :<br>  epoll : pref=300, <span class="hljs-built_in">test</span> result OK<br>   poll : pref=200, <span class="hljs-built_in">test</span> result OK<br>   select : pref=150, <span class="hljs-built_in">test</span> result OK<br>Total: 3 (3 usable), will use epoll.<br>Available filters :<br>[SPOE] spoe<br>[COMP] compression<br>[TRACE] trace<br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-第三方安装包"><a href="#3-2-2-第三方安装包" class="headerlink" title="3.2.2 第三方安装包"></a>3.2.2 第三方安装包</h4><p>官方没有提供rpm相关的包,可以通过第三方仓库的rpm包<br>从第三方网站下载rpm包：<a target="_blank" rel="noopener" href="https://pkgs.org/download/haproxy">https://pkgs.org/download/haproxy</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy17.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy18.png" srcset="/blog/img/loading.gif"></p>
<p>范例：基于互联网第三方仓库在线安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#wget http://www.nosuchhost.net/~cheese/fedora/packages/epel-7/x86_64/cheese-</span><br>release-7-1.noarch.rpm<br><span class="hljs-comment">#rpm -ivh cheese-release-7-1.noarch.rpm</span><br><span class="hljs-comment">#yum install haproxy</span><br><br><span class="hljs-comment">#验证haproxy版本</span><br><span class="hljs-comment"># haproxy -v</span><br>HA-Proxy version 1.8.14-52e4d43 2018/09/20<br>Copyright 2000-2018 Willy Tarreau &lt;willy@haproxy.org&gt;<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy19.png" srcset="/blog/img/loading.gif"></p>
<p>范例：利用第三方 yum 仓库安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#wget https://centos7.iuscommunity.org/ius-release.rpm</span><br>[root@centos7 ~]<span class="hljs-comment">#rpm -Uvh ius-release*rpm</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install epel-release</span><br>[root@centos7 ~]<span class="hljs-comment">#rpm -Uvh ius-release*rpm</span><br>[root@centos7 ~]<span class="hljs-comment">#yum install haproxy18u</span><br>[root@centos7 ~]<span class="hljs-comment">#haproxy -v</span><br>HA-Proxy version 1.8.23 2019/11/25<br>Copyright 2000-2019 Willy Tarreau &lt;willy@haproxy.org&gt;<br></code></pre></td></tr></table></figure>

<p>范例：下载rpm包离线安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载安装lua库对应的版本</span><br>[root@centos7 ~]<span class="hljs-comment">#wget</span><br>https://dl.iuscommunity.org/pub/ius/stable/CentOS/7/x86_64/lua53u-libs-5.3.4-<br>1.ius.centos7.x86_64.rpm<br><span class="hljs-comment">#安装lua库</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install lua53u-libs-5.3.4-1.ius.centos7.x86_64.rpm</span><br><span class="hljs-comment">#下载haproxy</span><br>[root@centos7 ~]<span class="hljs-comment">#wget</span><br>https://dl.iuscommunity.org/pub/ius/stable/CentOS/7/x86_64/haproxy18u-1.8.20-<br>1.el7.ius.x86_64.rpm<br><span class="hljs-comment">#安装haproxy</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install haproxy18u-1.8.20-1.el7.ius.x86_64.rpm</span><br>[root@centos7 ~]<span class="hljs-comment">#haproxy -v</span><br>HA-Proxy version 1.8.20 2019/04/25<br><br>Copyright 2000-2019 Willy Tarreau &lt;willy@haproxy.org&gt;<br>[root@centos7 ~]<span class="hljs-comment">#systemctl start haproxy</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl status haproxy.service</span><br>● haproxy.service - HAProxy Load Balancer<br> Loaded: loaded (/usr/lib/systemd/system/haproxy.service; disabled; vendor<br>preset: disabled)<br> Active: active (running) since Mon 2020-03-30 21:17:23 CST; 56s ago<br>Process: 1257 ExecStartPre=/usr/sbin/haproxy -f <span class="hljs-variable">$CONFIG</span> -c -q (code=exited,<br>status=0/SUCCESS)<br>Main PID: 1258 (haproxy)<br> CGroup: /system.slice/haproxy.service<br>     ├─1258 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p<br>/run/haproxy.pid<br>     └─1260 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p<br>/run/haproxy.pid<br>Mar 30 21:17:23 centos7.wangxiaochun.com systemd[1]: Starting HAProxy Load<br>Balancer...<br>Mar 30 21:17:23 centos7.wangxiaochun.com systemd[1]: Started HAProxy Load<br>Balancer.<br></code></pre></td></tr></table></figure>

<h3 id="3-3-编译安装-HAProxy"><a href="#3-3-编译安装-HAProxy" class="headerlink" title="3.3 编译安装 HAProxy"></a>3.3 编译安装 HAProxy</h3><p>编译安装HAProxy 2.0 LTS版本，更多源码包下载地址：<a target="_blank" rel="noopener" href="http://www.haproxy.org/download/">http://www.haproxy.org/download/</a></p>
<h4 id="3-3-1-解决-lua-环境"><a href="#3-3-1-解决-lua-环境" class="headerlink" title="3.3.1 解决 lua 环境"></a>3.3.1 解决 lua 环境</h4><p>HAProxy 支持基于lua实现功能扩展，lua是一种小巧的脚本语言，于1993年由巴西里约热内卢天主教<br>大学（Pontifical Catholic University of Rio de Janeiro）里的一个研究小组开发，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p>
<p>Lua 官网：<a target="_blank" rel="noopener" href="http://www.lua.org/">www.lua.org</a></p>
<p>Lua 应用场景</p>
<ul>
<li><p>游戏开发</p>
</li>
<li><p>独立应用脚本</p>
</li>
<li><p>Web 应用脚本</p>
</li>
<li><p>扩展和数据库插件，如MySQL Proxy</p>
</li>
<li><p>安全系统，如入侵检测系统</p>
</li>
</ul>
<h5 id="3-3-1-1-CentOS-基础环境"><a href="#3-3-1-1-CentOS-基础环境" class="headerlink" title="3.3.1.1 CentOS 基础环境"></a>3.3.1.1 CentOS 基础环境</h5><p>参考链接：<a target="_blank" rel="noopener" href="http://www.lua.org/start.html">http://www.lua.org/start.html</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy20.png" srcset="/blog/img/loading.gif"></p>
<p>由于CentOS7 之前版本自带的lua版本比较低并不符合HAProxy要求的lua最低版本(5.3)的要求，因此需要编译安装较新版本的lua环境，然后才能编译安装HAProxy，过程如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#当前系统版本</span><br>[root@centos7 ~]<span class="hljs-comment">#lua -v</span><br>Lua 5.1.4 Copyright (C) 1994-2008 Lua.org, PUC-Rio<br><br><span class="hljs-comment">#安装基础命令及编译依赖环境</span><br>[root@centos7 ~]<span class="hljs-comment"># yum install gcc readline-devel -y</span><br>[root@centos7 ~]<span class="hljs-comment"># wget http://www.lua.org/ftp/lua-5.3.5.tar.gz</span><br>[root@centos7 ~]<span class="hljs-comment"># tar xvf lua-5.3.5.tar.gz -C /usr/local/src</span><br>[root@centos7 ~]<span class="hljs-comment"># cd /usr/local/src/lua-5.3.5</span><br>[root@centos7 lua-5.3.5]<span class="hljs-comment"># make linux test</span><br><br><span class="hljs-comment">#查看编译安装的版本</span><br>[root@centos7 lua-5.3.5]<span class="hljs-comment">#src/lua -v</span><br>Lua 5.3.5 Copyright (C) 1994-2018 Lua.org, PUC-Rio<br></code></pre></td></tr></table></figure>

<h5 id="3-3-1-2-Ubuntu-基础环境"><a href="#3-3-1-2-Ubuntu-基础环境" class="headerlink" title="3.3.1.2 Ubuntu 基础环境"></a>3.3.1.2 Ubuntu 基础环境</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装基础命令及编译依赖环境</span><br><span class="hljs-comment"># apt install gcc iproute2 ntpdate tcpdump telnet traceroute nfs-kernel-</span><br>server nfs-common lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-<br>dev openssh-server libreadline-dev libsystemd-dev<br><br><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># wget http://www.lua.org/ftp/lua-5.3.5.tar.gz</span><br><span class="hljs-comment"># tar xvf lua-5.3.5.tar.gz</span><br><span class="hljs-comment"># cd lua-5.3.5</span><br><span class="hljs-comment"># make linux test</span><br><br><span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/src/lua-5.3.5<br><span class="hljs-comment"># ./src/lua -v</span><br>Lua 5.3.5 Copyright (C) 1994-2018 Lua.org, PUC-Rio<br><span class="hljs-comment">#或安装系统自带的lua</span><br><span class="hljs-comment"># apt install lua5.3=5.3.3-1ubuntu0.18.04.1</span><br><span class="hljs-comment"># lua5.3 -v</span><br>Lua 5.3.3 Copyright (C) 1994-2016 Lua.org, PUC-Rio<br></code></pre></td></tr></table></figure>

<h4 id="3-3-2-编译安装HAProxy"><a href="#3-3-2-编译安装HAProxy" class="headerlink" title="3.3.2 编译安装HAProxy"></a>3.3.2 编译安装HAProxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#HAProxy 1.8及1.9版本编译参数：</span><br>make  ARCH=x86_64 TARGET=linux2628 USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1<br>USE_SYSTEMD=1  USE_CPU_AFFINITY=1  PREFIX=/usr/<span class="hljs-built_in">local</span>/haproxy<br><br><span class="hljs-comment">#HAProxy 2.0以上版本编译参数：</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install gcc openssl-devel pcre-devel systemd-devel</span><br>[root@centos7 ~]<span class="hljs-comment">#wget http://www.haproxy.org/download/2.0/src/haproxy-2.0.22.tar.gz</span><br>[root@centos7 ~]<span class="hljs-comment">#tar xvf haproxy-2.0.22.tar.gz -C /usr/local/src</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /usr/local/src/haproxy-2.0.22/</span><br><br><span class="hljs-comment">#查看安装方法</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#ll Makefile</span><br>-rw-rw-r-- 1 root root 40812 Feb 12 23:18 Makefile<br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#cat README</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#cat INSTALL</span><br><br><span class="hljs-comment">#参考INSTALL文件进行编译安装</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#make ARCH=x86_64 TARGET=linux-glibc USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1 USE_LUA=1 LUA_INC=/usr/local/src/lua-5.3.5/src/ LUA_LIB=/usr/local/src/lua-5.3.5/src/</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment"># make install PREFIX=/apps/haproxy</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#ln -s /apps/haproxy/sbin/haproxy /usr/sbin/</span><br><br><span class="hljs-comment">#查看生成的文件</span><br>[root@centos7 haproxy-2.0.22]<span class="hljs-comment">#tree /apps/haproxy/</span><br>/apps/haproxy/<br>├── doc<br>│  └── haproxy<br>│    ├── 51Degrees-device-detection.txt<br>│    ├── architecture.txt<br>│    ├── close-options.txt<br>│    ├── configuration.txt<br>│    ├── cookie-options.txt<br>│    ├── DeviceAtlas-device-detection.txt<br>│    ├── intro.txt<br>│    ├── linux-syn-cookies.txt<br>│    ├── lua.txt<br>│    ├── management.txt<br>│    ├── netscaler-client-ip-insertion-protocol.txt<br>│    ├── network-namespaces.txt<br>│    ├── peers.txt<br>│    ├── peers-v2.0.txt<br>│    ├── proxy-protocol.txt<br>│    ├── regression-testing.txt<br>│    ├── seamless_reload.txt<br>│    ├── SOCKS4.protocol.txt<br>│    ├── SPOE.txt<br>│    └── WURFL-device-detection.txt<br>├── sbin<br>│  └── haproxy<br>└── share<br> └── man<br>   └── man1<br>     └── haproxy.1<br>6 directories, 22 files<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-验证HAProxy版本"><a href="#3-3-3-验证HAProxy版本" class="headerlink" title="3.3.3 验证HAProxy版本"></a>3.3.3 验证HAProxy版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#验证HAProxy版本：</span><br>[root@centos7 ~]<span class="hljs-comment">#which haproxy</span><br>/usr/sbin/haproxy<br>[root@centos7 ~]<span class="hljs-comment"># haproxy -v</span><br>HA-Proxy version 2.0.22-d4759ba 2021/04/12 - https://haproxy.org/<br><br><span class="hljs-comment">#大写-V选项显示版本和帮助用法</span><br>[root@centos7 ~]<span class="hljs-comment"># haproxy -V</span><br>HA-Proxy version 2.0.22-d4759ba 2021/04/12 - https://haproxy.org/<br>Usage : haproxy [-f &lt;cfgfile|cfgdir&gt;]* [ -vdVD ] [ -n &lt;maxconn&gt; ] [ -N &lt;maxpconn&gt; ]<br>        [ -p &lt;pidfile&gt; ] [ -m &lt;max megs&gt; ] [ -C &lt;dir&gt; ] [-- &lt;cfgfile&gt;*]<br>        -v displays version ; -vv shows known build options.<br>        -d enters debug mode ; -db only disables background mode.<br>        -dM[&lt;byte&gt;] poisons memory with &lt;byte&gt; (defaults to 0x50)<br>        -V enters verbose mode (disables quiet mode)<br>        -D goes daemon ; -C changes to &lt;dir&gt; before loading files.<br>        -W master-worker mode.<br>        -Ws master-worker mode with systemd notify support.<br>        -q quiet mode : don<span class="hljs-string">&#x27;t display messages</span><br><span class="hljs-string">        -c check mode : only check config files and exit</span><br><span class="hljs-string">        -n sets the maximum total # of connections (uses ulimit -n)</span><br><span class="hljs-string">        -m limits the usable amount of memory (in MB)</span><br><span class="hljs-string">        -N sets the default, per-proxy maximum # of connections (0)</span><br><span class="hljs-string">        -L set local peer name (default to hostname)</span><br><span class="hljs-string">        -p writes pids of all children to this file</span><br><span class="hljs-string">        -de disables epoll() usage even when available</span><br><span class="hljs-string">        -dp disables poll() usage even when available</span><br><span class="hljs-string">        -dS disables splice usage (broken on old kernels)</span><br><span class="hljs-string">        -dG disables getaddrinfo() usage</span><br><span class="hljs-string">        -dR disables SO_REUSEPORT usage</span><br><span class="hljs-string">        -dr ignores server address resolution failures</span><br><span class="hljs-string">        -dV disables SSL verify on servers side</span><br><span class="hljs-string">        -sf/-st [pid ]* finishes/terminates old pids.</span><br><span class="hljs-string">        -x &lt;unix_socket&gt; get listening sockets from a unix socket</span><br><span class="hljs-string">        -S &lt;bind&gt;[,&lt;bind options&gt;...] new master CLI</span><br><span class="hljs-string">    </span><br><span class="hljs-string">[root@centos7 ~]# haproxy -vv</span><br><span class="hljs-string">HA-Proxy version 2.0.22-d4759ba 2021/04/12 - https://haproxy.org/</span><br><span class="hljs-string">Build options :</span><br><span class="hljs-string">  TARGET  = linux-glibc</span><br><span class="hljs-string">  CPU     = generic</span><br><span class="hljs-string">  CC      = gcc</span><br><span class="hljs-string">  CFLAGS  = -m64 -march=x86-64 -O2 -g -fno-strict-aliasing -Wdeclaration-after-statement -fwrapv -Wno-unused-label -Wno-sign-compare -Wno-unused-parameter -Wno-old-style-declaration -Wno-ignored-qualifiers -Wno-clobbered -Wno-missing-field-initializers -Wtype-limits</span><br><span class="hljs-string">  OPTIONS = USE_PCRE=1 USE_OPENSSL=1 USE_LUA=1 USE_ZLIB=1 USE_SYSTEMD=1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Feature list : +EPOLL -KQUEUE -MY_EPOLL -MY_SPLICE +NETFILTER +PCRE -PCRE_JIT -PCRE2 -PCRE2_JIT +POLL -PRIVATE_CACHE +THREAD -PTHREAD_PSHARED -REGPARM -STATIC_PCRE -STATIC_PCRE2 +TPROXY +LINUX_TPROXY +LINUX_SPLICE +LIBCRYPT +CRYPT_H -VSYSCALL +GETADDRINFO +OPENSSL +LUA +FUTEX +ACCEPT4 -CLOSEFROM -MY_ACCEPT4 +ZLIB -SLZ +CPU_AFFINITY +TFO +NS +DL +RT -DEVICEATLAS -51DEGREES -WURFL +SYSTEMD -OBSOLETE_LINKER +PRCTL +THREAD_DUMP -EVPORTS</span><br><span class="hljs-string"></span><br><span class="hljs-string">Default settings :</span><br><span class="hljs-string">  bufsize = 16384, maxrewrite = 1024, maxpollevents = 200</span><br><span class="hljs-string"></span><br><span class="hljs-string">Built with multi-threading support (MAX_THREADS=64, default=1).</span><br><span class="hljs-string">Built with OpenSSL version : OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="hljs-string">Running on OpenSSL version : OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="hljs-string">OpenSSL library supports TLS extensions : yes</span><br><span class="hljs-string">OpenSSL library supports SNI : yes</span><br><span class="hljs-string">OpenSSL library supports : SSLv3 TLSv1.0 TLSv1.1 TLSv1.2</span><br><span class="hljs-string">Built with Lua version : Lua 5.3.5</span><br><span class="hljs-string">Built with network namespace support.</span><br><span class="hljs-string">Built with transparent proxy support using: IP_TRANSPARENT IPV6_TRANSPARENT IP_FREEBIND</span><br><span class="hljs-string">Built with zlib version : 1.2.7</span><br><span class="hljs-string">Running on zlib version : 1.2.7</span><br><span class="hljs-string">Compression algorithms supported : identity(&quot;identity&quot;), deflate(&quot;deflate&quot;), raw-deflate(&quot;deflate&quot;), gzip(&quot;gzip&quot;)</span><br><span class="hljs-string">Built with PCRE version : 8.32 2012-11-30</span><br><span class="hljs-string">Running on PCRE version : 8.32 2012-11-30</span><br><span class="hljs-string">PCRE library supports JIT : no (USE_PCRE_JIT not set)</span><br><span class="hljs-string">Encrypted password support via crypt(3): yes</span><br><span class="hljs-string"></span><br><span class="hljs-string">Available polling systems :</span><br><span class="hljs-string">      epoll : pref=300,  test result OK</span><br><span class="hljs-string">       poll : pref=200,  test result OK</span><br><span class="hljs-string">     select : pref=150,  test result OK</span><br><span class="hljs-string">Total: 3 (3 usable), will use epoll.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Available multiplexer protocols :</span><br><span class="hljs-string">(protocols marked as &lt;default&gt; cannot be specified using &#x27;</span>proto<span class="hljs-string">&#x27; keyword)</span><br><span class="hljs-string">              h2 : mode=HTX        side=FE|BE     mux=H2</span><br><span class="hljs-string">              h2 : mode=HTTP       side=FE        mux=H2</span><br><span class="hljs-string">       &lt;default&gt; : mode=HTX        side=FE|BE     mux=H1</span><br><span class="hljs-string">       &lt;default&gt; : mode=TCP|HTTP   side=FE|BE     mux=PASS</span><br><span class="hljs-string"></span><br><span class="hljs-string">Available services : none</span><br><span class="hljs-string"></span><br><span class="hljs-string">Available filters :</span><br><span class="hljs-string">	[SPOE] spoe</span><br><span class="hljs-string">	[COMP] compression</span><br><span class="hljs-string">	[CACHE] cache</span><br><span class="hljs-string">	[TRACE] trace</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-4-HAProxy启动文件"><a href="#3-3-4-HAProxy启动文件" class="headerlink" title="3.3.4 HAProxy启动文件"></a>3.3.4 HAProxy启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /usr/lib/systemd/system/haproxy.service</span><br>[Unit]<br>Description=HAProxy Load Balancer<br>After=syslog.target network.target<br><br>[Service]<br>ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg  -c -q<br>ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /var/lib/haproxy/haproxy.pid<br>ExecReload=/bin/<span class="hljs-built_in">kill</span> -USR2 <span class="hljs-variable">$MAINPID</span><br><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment">#默认缺少配置文件，无法启动</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl daemon-reload</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl start haproxy</span><br>Job <span class="hljs-keyword">for</span> haproxy.service failed because the control process exited with error<br>code. See <span class="hljs-string">&quot;systemctl status haproxy.service&quot;</span> and <span class="hljs-string">&quot;journalctl -xe&quot;</span> <span class="hljs-keyword">for</span> details.<br><br>[root@centos7 ~]<span class="hljs-comment">#tail /var/log/messages</span><br>Mar 30 22:28:50 centos7 systemd: haproxy.service: control process exited,<br>code=exited status=1<br>Mar 30 22:28:50 centos7 systemd: Failed to start HAProxy Load Balancer.<br>Mar 30 22:28:50 centos7 systemd: Unit haproxy.service entered failed state.<br>Mar 30 22:28:50 centos7 systemd: haproxy.service failed.<br>Mar 30 22:28:54 centos7 systemd: Starting HAProxy Load Balancer...<br>Mar 30 22:28:54 centos7 haproxy: [ALERT] 089/222854 (28223) : Cannot open<br>configuration file/directory /etc/haproxy/haproxy.cfg : No such file or<br>directory<br>Mar 30 22:28:54 centos7 systemd: haproxy.service: control process exited,<br>code=exited status=1<br>Mar 30 22:28:54 centos7 systemd: Failed to start HAProxy Load Balancer.<br>Mar 30 22:28:54 centos7 systemd: Unit haproxy.service entered failed state.<br>Mar 30 22:28:54 centos7 systemd: haproxy.service failed.<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-配置文件"><a href="#3-3-5-配置文件" class="headerlink" title="3.3.5 配置文件"></a>3.3.5 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看配置文件范例</span><br>[root@centos7 ~]<span class="hljs-comment"># tree /usr/local/src/haproxy-2.0.22/examples/</span><br>/usr/<span class="hljs-built_in">local</span>/src/haproxy-2.0.22/examples/<br>├── acl-content-sw.cfg<br>├── content-sw-sample.cfg<br>├── errorfiles<br>│   ├── 400.http<br>│   ├── 403.http<br>│   ├── 408.http<br>│   ├── 500.http<br>│   ├── 502.http<br>│   ├── 503.http<br>│   ├── 504.http<br>│   └── README<br>├── haproxy.init<br>├── option-http_proxy.cfg<br>├── socks4.cfg<br>├── transparent_proxy.cfg<br>└── wurfl-example.cfg<br><br>1 directory, 15 files<br><br><span class="hljs-comment">#创建自定义的配置文件</span><br>[root@centos7 ~]<span class="hljs-comment"># mkdir /etc/haproxy</span><br>[root@centos7 ~]<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>global<br>    maxconn 100000<br>    chroot /apps/haproxy<br>    stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin<br>    <span class="hljs-comment">#uid 99</span><br>    <span class="hljs-comment">#gid 99</span><br>    user haproxy<br>    group haproxy<br>    daemon<br>    <span class="hljs-comment">#nbproc 4</span><br>    <span class="hljs-comment">#cpu-map 1 0</span><br>    <span class="hljs-comment">#cpu-map 2 1</span><br>    <span class="hljs-comment">#cpu-map 3 2</span><br>    <span class="hljs-comment">#cpu-map 4 3</span><br>    pidfile /var/lib/haproxy/haproxy.pid<br>    <span class="hljs-built_in">log</span> 127.0.0.1 local2 info<br><br>defaults<br>    option http-keep-alive<br>    option forwardfor<br>    maxconn 100000<br>    mode http<br>    timeout connect 300000ms<br>    timeout client 300000ms<br>    timeout server 300000ms<br><br>listen stats<br> mode http<br> <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br> stats <span class="hljs-built_in">enable</span><br> <span class="hljs-built_in">log</span> global<br> stats uri     /haproxy-status<br> stats auth    haadmin:123456<br><br>listen web_port<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    server web1 127.0.0.1:8080 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h4 id="3-3-6-启动-haproxy"><a href="#3-3-6-启动-haproxy" class="headerlink" title="3.3.6 启动 haproxy"></a>3.3.6 启动 haproxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#准备socket文件目录</span><br>[root@centos7 ~]<span class="hljs-comment"># mkdir /var/lib/haproxy</span><br><br><span class="hljs-comment">#设置用户和目录权限</span><br>[root@centos7 ~]<span class="hljs-comment"># useradd -r -s /sbin/nologin -d /var/lib/haproxy haproxy</span><br>[root@centos7 ~]<span class="hljs-comment"># systemctl enable --now haproxy</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-7-验证-haproxy-状态"><a href="#3-3-7-验证-haproxy-状态" class="headerlink" title="3.3.7 验证 haproxy 状态"></a>3.3.7 验证 haproxy 状态</h4><p>haproxy.cfg文件中定义了chroot、pidfile、user、group等参数，如果系统没有相应的资源会导致<br>haproxy无法启动，具体参考日志文件 /var/log/messages</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#systemctl status haproxy</span><br>● haproxy.service - HAProxy Load Balancer<br> Loaded: loaded (/usr/lib/systemd/system/haproxy.service; disabled; vendor<br>preset: disabled)<br> Active: active (running) since Mon 2020-03-30 20:45:20 CST; 4min 45s ago<br>Process: 1362 ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -c -q<br>(code=exited, status=0/SUCCESS)<br>Main PID: 1363 (haproxy)<br> CGroup: /system.slice/haproxy.service<br>     ├─1363 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p<br>/var/lib/haproxy/haproxy.pid<br>     └─1366 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p<br>/var/lib/haproxy/haproxy.pid<br>Mar 30 20:45:20 centos7.wangxiaochun.com systemd[1]: Starting HAProxy Load<br>Balancer...<br>Mar 30 20:45:20 centos7.wangxiaochun.com systemd[1]: Started HAProxy Load<br>Balancer.<br>Mar 30 20:45:20 centos7.wangxiaochun.com haproxy[1363]: [NOTICE] 089/204520<br>(1363) : New worker <span class="hljs-comment">#1 (1366...ked</span><br>Mar 30 20:45:20 centos7.wangxiaochun.com haproxy[1363]: [WARNING] 089/204520<br>(1366) : Server web_port/we...ue.<br>Mar 30 20:45:20 centos7.wangxiaochun.com haproxy[1363]: [ALERT] 089/204520<br>(1366) : proxy <span class="hljs-string">&#x27;web_port&#x27;</span> has...le!<br>Hint: Some lines were ellipsized, use -l to show <span class="hljs-keyword">in</span> full.<br><br>[root@centos7 ~]<span class="hljs-comment"># pstree -p |grep haproxy</span><br>     |-haproxy(28101)---haproxy(28105)<br></code></pre></td></tr></table></figure>

<h4 id="3-3-8-查看haproxy的状态页面"><a href="#3-3-8-查看haproxy的状态页面" class="headerlink" title="3.3.8 查看haproxy的状态页面"></a>3.3.8 查看haproxy的状态页面</h4><p>浏览器访问： <a target="_blank" rel="noopener" href="http://haproxy-server:9999/haproxy-status">http://haproxy-server:9999/haproxy-status</a></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy21.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy22.png" srcset="/blog/img/loading.gif"></p>
<h3 id="3-4-基础配置详解"><a href="#3-4-基础配置详解" class="headerlink" title="3.4 基础配置详解"></a>3.4 基础配置详解</h3><p>配置文件官方帮助文档</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy23.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy24.png" srcset="/blog/img/loading.gif"></p>
<p>官方文档：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://cbonte.github.io/haproxy-dconv/ <span class="hljs-comment">#每个版本都可能会有参数发生变化，使用其他版本的时候要查看官方文档</span><br>http://cbonte.github.io/haproxy-dconv/2.1/configuration.html<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy25.png" srcset="/blog/img/loading.gif"></p>
<p>HAProxy 的配置文件haproxy.cfg由两大部分组成，分别是global和proxies部分</p>
<ul>
<li>global：全局配置段</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">进程及安全配置相关的参数<br>性能调整相关参数<br>Debug参数<br></code></pre></td></tr></table></figure>

<ul>
<li>proxies：代理配置段</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">defaults：为frontend, backend, listen提供默认配置<br>frontend：前端，相当于nginx中的server &#123;&#125;<br>backend：后端，相当于nginx中的upstream &#123;&#125;<br>listen：同时拥有前端和后端配置,配置简单,生产推荐使用<br></code></pre></td></tr></table></figure>

<h4 id="3-4-1-global配置"><a href="#3-4-1-global配置" class="headerlink" title="3.4.1 global配置"></a>3.4.1 global配置</h4><h5 id="3-4-1-1-global-配置参数说明"><a href="#3-4-1-1-global-配置参数说明" class="headerlink" title="3.4.1.1 global 配置参数说明"></a>3.4.1.1 global 配置参数说明</h5><p>官方文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#3">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#3</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">chroot <span class="hljs-comment">#锁定运行目录</span><br>deamon <span class="hljs-comment">#以守护进程运行</span><br>stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin process 1 <span class="hljs-comment">#socket文件</span><br>user, group, uid, gid  <span class="hljs-comment">#运行haproxy的用户身份</span><br>nbproc  n <span class="hljs-comment">#开启的haproxy work 进程数，默认进程数是一个</span><br><span class="hljs-comment">#nbthread 1 #和多进程 nbproc配置互斥（版本有关,CentOS8的haproxy1.8无此问题）,指定每个haproxy进程开启的线程数，默认为每个进程一个线程</span><br><span class="hljs-comment">#如果同时启用nbproc和nbthread 会出现以下日志的错误，无法启动服务</span><br>Apr  7 14:46:23 haproxy haproxy: [ALERT] 097/144623 (1454) : config : cannot<br><span class="hljs-built_in">enable</span> multiple processes <span class="hljs-keyword">if</span> multiple threads are configured. Please use either<br>nbproc or nbthread but not both.<br><br>cpu-map 1 0  <span class="hljs-comment">#绑定haproxy worker 进程至指定CPU，将第1个work进程绑定至0号CPU</span><br>cpu-map 2 1   <span class="hljs-comment">#绑定haproxy worker 进程至指定CPU，将第2个work进程绑定至1 号CPU</span><br><br>maxconn n  <span class="hljs-comment">#每个haproxy进程的最大并发连接数</span><br>maxsslconn n  <span class="hljs-comment">#每个haproxy进程ssl最大连接数,用于haproxy配置了证书的场景下</span><br>maxconnrate n  <span class="hljs-comment">#每个进程每秒创建的最大连接数量</span><br>spread-checks n <span class="hljs-comment">#后端server状态check随机提前或延迟百分比时间，建议2-5(20%-50%)之间，默认值0</span><br>pidfile <span class="hljs-comment">#指定pid文件路径</span><br><span class="hljs-built_in">log</span> 127.0.0.1 local2 info <span class="hljs-comment">#定义全局的syslog服务器；日志服务器需要开启UDP协议，最多可以定义两个</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-1-2-多进程和线程"><a href="#3-4-1-2-多进程和线程" class="headerlink" title="3.4.1.2 多进程和线程"></a>3.4.1.2 多进程和线程</h5><p>范例：多进程和socket文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br>global<br>maxconn 100000<br>chroot /apps/haproxy<br>stats socket /var/lib/haproxy/haproxy.sock1 mode 600 level admin process 1   <br>stats socket /var/lib/haproxy/haproxy.sock2 mode 600 level admin process 2<br>uid 99<br>gid 99<br>daemon<br>nbproc 2<br><br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart haproxy</span><br>[root@centos7 ~]<span class="hljs-comment">#pstree -p |grep haproxy</span><br>     |-haproxy(2634)-+-haproxy(2637)<br>     |        `-haproxy(2638)<br>[root@centos7 ~]<span class="hljs-comment">#ll /var/lib/haproxy/</span><br>total 4<br>-rw-r--r-- 1 root root 5 Mar 31 18:49 haproxy.pid<br>srw------- 1 root root 0 Mar 31 18:49 haproxy.sock1<br>srw------- 1 root root 0 Mar 31 18:49 haproxy.sock2<br></code></pre></td></tr></table></figure>

<h5 id="3-4-1-3-HAProxy日志配置"><a href="#3-4-1-3-HAProxy日志配置" class="headerlink" title="3.4.1.3 HAProxy日志配置"></a>3.4.1.3 HAProxy日志配置</h5><p>HAproxy本身不记录客户端的访问日志.此外为减少服务器负载,一般生产中HAProxy不记录日志，记录日志交给后端服务器。<br>也可以配置HAProxy利用rsyslog服务记录日志到指定日志文件中</p>
<h6 id="3-4-1-3-1-HAProxy配置"><a href="#3-4-1-3-1-HAProxy配置" class="headerlink" title="3.4.1.3.1 HAProxy配置"></a>3.4.1.3.1 HAProxy配置</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在global配置项定义：</span><br><span class="hljs-built_in">log</span> 127.0.0.1 <span class="hljs-built_in">local</span>&#123;1-7&#125; info <br><span class="hljs-comment">#基于syslog记录日志到指定设备，级别有(err、warning、info、debug) </span><br><span class="hljs-comment">#ip地址里如果换成其他后端服务器地址就会将日志发送到其他后端服务器里</span><br><br>listen web_port<br><span class="hljs-built_in">bind</span> 127.0.0.1:80<br>mode http<br><span class="hljs-built_in">log</span> global <span class="hljs-comment">#开启当前web_port的日志功能，默认不记录日志</span><br>server web1  127.0.0.1:8080 check inter 3000 fall 2 rise 5<br><br><span class="hljs-comment"># systemctl restart haproxy</span><br></code></pre></td></tr></table></figure>

<h6 id="3-4-1-3-2-Rsyslog配置"><a href="#3-4-1-3-2-Rsyslog配置" class="headerlink" title="3.4.1.3.2 Rsyslog配置"></a>3.4.1.3.2 Rsyslog配置</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/rsyslog.conf<br><span class="hljs-variable">$ModLoad</span> imudp<br><span class="hljs-variable">$UDPServerRun</span> 514<br>......<br>local3.*  /var/<span class="hljs-built_in">log</span>/haproxy.log<br>......<br><br><span class="hljs-comment"># systemctl restart rsyslog</span><br></code></pre></td></tr></table></figure>

<h6 id="3-4-1-3-3-验证HAProxy日志"><a href="#3-4-1-3-3-验证HAProxy日志" class="headerlink" title="3.4.1.3.3 验证HAProxy日志"></a>3.4.1.3.3 验证HAProxy日志</h6><p>重启syslog服务并访问app页面，然后验证是否生成日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># tail -f /var/log/haproxy.log</span><br>Aug 14 20:21:06 localhost haproxy[18253]: Connect from 192.168.0.1:3050 to<br>10.0.0.7:80 (web_host/HTTP)<br>Aug 14 20:21:06 localhost haproxy[18253]: Connect from 192.168.0.1:3051 to<br>10.0.0.7:80 (web_host/HTTP)<br>Aug 14 20:21:06 localhost haproxy[18253]: Connect from 192.168.0.1:3050 to<br>10.0.0.7:80 (web_host/HTTP)<br></code></pre></td></tr></table></figure>

<h6 id="3-4-1-3-4-实战案例：启动本地和远程日志"><a href="#3-4-1-3-4-实战案例：启动本地和远程日志" class="headerlink" title="3.4.1.3.4 实战案例：启动本地和远程日志"></a>3.4.1.3.4 实战案例：启动本地和远程日志</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br><span class="hljs-built_in">log</span> 127.0.0.1 local2 info<br><span class="hljs-built_in">log</span> 10.0.0.8 local2 info<br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart haproxy</span><br><span class="hljs-comment">#开启本地日志</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/rsyslog.conf</span><br><span class="hljs-variable">$ModLoad</span> imudp<br><span class="hljs-variable">$UDPServerRun</span> 514<br>......<br>local2.*                    /var/<span class="hljs-built_in">log</span>/haproxy.log<br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart rsyslog</span><br><br><span class="hljs-comment">#开启远程主机日志</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/rsyslog.conf</span><br>module(load=<span class="hljs-string">&quot;imudp&quot;</span>) <span class="hljs-comment"># needs to be done just once </span><br>input(<span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;imudp&quot;</span> port=<span class="hljs-string">&quot;514&quot;</span>)<br>local3.*          /var/<span class="hljs-built_in">log</span>/haproxy.log<br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart rsyslog</span><br><br><span class="hljs-comment">#浏览器访问：http://haproxy-server:9999/haproxy-status,观察本机和远程主机生成的日志</span><br>[root@centos7 ~]<span class="hljs-comment">#tail /var/log/haproxy.log</span><br>[root@centos7 ~]<span class="hljs-comment">#cat /var/log/haproxy.log</span><br>Mar 30 23:42:52 localhost haproxy[28643]: Connect from 10.0.0.1:7820 to<br>10.0.0.7:9999 (stats/HTTP)<br>Mar 30 23:42:52 localhost haproxy[28643]: Connect from 10.0.0.1:7821 to<br>10.0.0.7:9999 (stats/HTTP)<br>Mar 30 23:42:53 localhost haproxy[28643]: Connect from 10.0.0.1:7822 to<br>10.0.0.7:9999 (stats/HTTP)<br><br>[root@centos8 ~]<span class="hljs-comment">#tail /var/log/haproxy.log</span><br>Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7824 to<br>10.0.0.7:9999 (stats/HTTP)<br>Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7825 to<br>10.0.0.7:9999 (stats/HTTP)<br>Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7826 to<br>10.0.0.7:9999 (stats/HTTP)<br>Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7827 to<br>10.0.0.7:9999 (stats/HTTP)<br></code></pre></td></tr></table></figure>

<h4 id="3-4-2-Proxies配置"><a href="#3-4-2-Proxies配置" class="headerlink" title="3.4.2 Proxies配置"></a>3.4.2 Proxies配置</h4><p>官方文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">defaults [&lt;name&gt;] <span class="hljs-comment">#默认配置项，针对以下的frontend、backend和listen生效，可以多个name也可以没有name</span><br>frontend &lt;name&gt;  <span class="hljs-comment">#前端servername，类似于Nginx的一个虚拟主机 server和LVS服务集群。</span><br>backend &lt;name&gt;  <span class="hljs-comment">#后端服务器组，等于nginx的upstream和LVS中的RS服务器</span><br>listen  &lt;name&gt;  <span class="hljs-comment">#将frontend和backend合并在一起配置，相对于frontend和backend配置更简洁，生产常用</span><br></code></pre></td></tr></table></figure>

<p>注意：name字段只能使用大小写字母，数字，‘-’(dash)，’_‘(underscore)，’.’ (dot)和 ‘:’(colon)，并且严格区分大小写</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy26.png" srcset="/blog/img/loading.gif"></p>
<h5 id="3-4-2-1-Proxies配置-defaults"><a href="#3-4-2-1-Proxies配置-defaults" class="headerlink" title="3.4.2.1 Proxies配置-defaults"></a>3.4.2.1 Proxies配置-defaults</h5><p>defaults 配置参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">option redispatch   <span class="hljs-comment">#当server Id对应的服务器挂掉后，强制定向到其他健康的服务器，重新派发，默认开启</span><br>option abortonclose  <span class="hljs-comment">#当服务器负载很高时，自动结束掉当前队列处理比较久的连接，针对业务情况选择开启</span><br>option http-keep-alive <span class="hljs-comment">#开启与客户端的会话保持</span><br>option forwardfor   <span class="hljs-comment">#透传客户端真实IP至后端web服务器</span><br>mode http|tcp <span class="hljs-comment">#设置默认工作类型,使用TCP服务器性能更好，减少压力</span><br>timeout http-keep-alive 120s <span class="hljs-comment">#session 会话保持超时时间，此时间段内会转发到相同的后端服务器</span><br>timeout connect 120s <span class="hljs-comment">#客户端请求从haproxy到后端server最长连接等待时间(TCP连接之前)，默认单位ms</span><br>timeout server 600s <span class="hljs-comment">#客户端请求从haproxy到后端服务端的请求处理超时时长(TCP连接之后)，默认单位ms，如果超时，会出现502错误，此值建议设置较大些（根据业务设置），访止502错误</span><br>timeout client 600s <span class="hljs-comment">#设置haproxy与客户端的最长非活动时间，默认单位ms，建议和timeout server相同</span><br>timeout check  5s  <span class="hljs-comment">#对后端服务器的默认检测超时时间</span><br>default-server inter 1000 weight 3  <span class="hljs-comment">#指定后端服务器的默认设置</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-2-Proxies配置-listen-简化配置"><a href="#3-4-2-2-Proxies配置-listen-简化配置" class="headerlink" title="3.4.2.2 Proxies配置-listen 简化配置"></a>3.4.2.2 Proxies配置-listen 简化配置</h5><p>使用listen替换 frontend和backend的配置方式，可以简化设置，通常只用于TCP协议的应用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#官网业务访问入口</span><br>listen WEB_PORT_80<br> <span class="hljs-built_in">bind</span> 10.0.0.7:80 <br> mode http<br> option forwardfor<br> server web1  10.0.0.17:8080  check inter 3000 fall 3 rise 5<br> server web2  10.0.0.27:8080  check inter 3000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<p><strong>实例：</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy56.png" srcset="/blog/img/loading.gif" alt="架构图"></p>
<p>注意点：</p>
<ul>
<li>web1和web2网关不需要指向haproxy。因为使用ngixn作为反向代理的时候web服务器的网关也没有指向nginx</li>
<li>haproxy不需要ip_forward。因为haproxy仅仅是代理，而不像lvs那样做转发，因此不需要开启（根据需求开）</li>
</ul>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">服务器名称</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">172.16.0.200/16</td>
<td align="center">internet</td>
<td align="center">用户访问机（仅主机模式）</td>
</tr>
<tr>
<td align="center">172.16.0.100/16</td>
<td align="center">haproxy</td>
<td align="center">haproxy服务器（eth1，仅主机模式）</td>
</tr>
<tr>
<td align="center">10.0.0.7/16</td>
<td align="center">haproxy</td>
<td align="center">haproxy服务器（eth0）</td>
</tr>
<tr>
<td align="center">10.0.0.17</td>
<td align="center">web1</td>
<td align="center">web服务器</td>
</tr>
<tr>
<td align="center">10.0.0.27</td>
<td align="center">web2</td>
<td align="center">web服务器</td>
</tr>
</tbody></table>
<p><strong>环境部署</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#internet服务器操作</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>TYPE=<span class="hljs-string">&quot;Ethernet&quot;</span><br>PROXY_METHOD=<span class="hljs-string">&quot;none&quot;</span><br>BROWSER_ONLY=<span class="hljs-string">&quot;no&quot;</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=172.16.0.200 <span class="hljs-comment">#修改ip地址</span><br>DEFROUTE=<span class="hljs-string">&quot;yes&quot;</span><br>IPV4_FAILURE_FATAL=<span class="hljs-string">&quot;no&quot;</span><br>NAME=<span class="hljs-string">&quot;eth0&quot;</span><br>UUID=<span class="hljs-string">&quot;e4085f99-fd7e-4239-9992-2dc837a3d5e2&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth0&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>IPV6_PRIVACY=<span class="hljs-string">&quot;no&quot;</span><br>NETMASK=255.255.0.0<br>DNS1=223.5.5.5<br>[root@centos7 ~]<span class="hljs-comment"># systemctl restart network</span><br><br><span class="hljs-comment">#haproxy服务器操作</span><br>[root@haproxy ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth1</span><br>BOOTPROTO=<span class="hljs-string">&quot;static&quot;</span><br>IPADDR=172.16.0.100<br>NAME=<span class="hljs-string">&quot;eth1&quot;</span><br>DEVICE=<span class="hljs-string">&quot;eth1&quot;</span><br>ONBOOT=<span class="hljs-string">&quot;yes&quot;</span><br>PREFIX=16<br>[root@haproxy ~]<span class="hljs-comment"># systemctl restart network</span><br>[root@haproxy ~]<span class="hljs-comment"># nmcli connection reload</span><br>[root@haproxy ~]<span class="hljs-comment"># nmcli connection </span><br>[root@haproxy ~]<span class="hljs-comment"># nmcli connection delete Wired\ connection\ 1</span><br>[root@haproxy ~]<span class="hljs-comment"># nmcli connection </span><br>NAME  UUID                                  TYPE            DEVICE <br>eth0  e4085f99-fd7e-4239-9992-2dc837a3d5e2  802-3-ethernet  eth0   <br>eth1  9c92fad9-6ecb-3e6c-eb4d-8a47c6f50c04  802-3-ethernet  eth1<br>[root@haproxy ~]<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000<br>    link/ether 00:0c:29:1a:45:e7 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.7/24 brd 10.0.0.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::40d2:a76f:ddbe:7372/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000<br>    link/ether 00:0c:29:1a:45:f1 brd ff:ff:ff:ff:ff:ff<br>    inet 172.16.0.100/16 brd 172.16.255.255 scope global eth1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe1a:45f1/64 scope link <br>       valid_lft forever preferred_lft forever<br>       <br><span class="hljs-comment">#web1服务器操作</span><br>[root@web1 ~]<span class="hljs-comment"># yum install -y httpd;systemctl enable --now httpd;hostname &gt; /var/www/html/index.html</span><br>[root@web2 ~]<span class="hljs-comment"># yum install -y httpd;systemctl enable --now httpd;hostname &gt; /var/www/html/index.html</span><br><br><span class="hljs-comment">#测试web服务器</span><br>[root@haproxy ~]<span class="hljs-comment"># curl 10.0.0.17</span><br>web1<br>[root@haproxy ~]<span class="hljs-comment"># curl 10.0.0.27</span><br>web2<br></code></pre></td></tr></table></figure>

<p><strong>安装软件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#haproxy编译安装haproxy，过程略</span><br><br><span class="hljs-comment">#修改haproxy配置文件</span><br>[root@haproxy ~]<span class="hljs-comment"># vim /etc/haproxy/haproxy.cfg</span><br>global<br>    maxconn 100000<br>    chroot /apps/haproxy<br>    <span class="hljs-comment">#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin</span><br>    stats socket /var/lib/haproxy/haproxy.sock1 mode 600 level admin process 1<br>    stats socket /var/lib/haproxy/haproxy.sock2 mode 600 level admin process 2<br>    <span class="hljs-comment">#uid 99</span><br>    <span class="hljs-comment">#gid 99</span><br>    user haproxy<br>    group haproxy<br>    daemon<br>    <span class="hljs-comment">#nbproc 4</span><br>    <span class="hljs-comment">#cpu-map 1 0</span><br>    <span class="hljs-comment">#cpu-map 2 1</span><br>    <span class="hljs-comment">#cpu-map 3 2</span><br>    <span class="hljs-comment">#cpu-map 4 3</span><br>    pidfile /var/lib/haproxy/haproxy.pid<br>    <span class="hljs-built_in">log</span> 127.0.0.1 local2 info<br><br>defaults<br>    option http-keep-alive<br>    option forwardfor<br>    maxconn 100000<br>    mode http<br>    timeout connect 300000ms<br>    timeout client 300000ms<br>    timeout server 300000ms<br><br>listen stats<br> mode http<br> <span class="hljs-built_in">bind</span> 0.0.0.0:9999<br> stats <span class="hljs-built_in">enable</span><br> <span class="hljs-built_in">log</span> global<br> stats uri     /haproxy-status<br> stats auth    haadmin:123456<br><br>listen web_80_port<br>    <span class="hljs-built_in">bind</span> 172.16.0.100:80<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    server web1 10.0.0.17:80 check inter 3000 fall 3 rise 3<br>    server web2 10.0.0.27:80 check inter 3000 fall 3 rise 3<br><br>[root@haproxy ~]<span class="hljs-comment"># systemctl reload haproxy</span><br><br><span class="hljs-comment">#进入haproxy-status页面就会出现web1和web2这两行</span><br><br><span class="hljs-comment">#internal测试</span><br>[root@centos7 ~]<span class="hljs-comment"># curl 172.16.0.100</span><br>web1<br>[root@centos7 ~]<span class="hljs-comment"># curl 172.16.0.100</span><br>web2<br>[root@centos7 ~]<span class="hljs-comment"># curl 172.16.0.100</span><br>web1<br>[root@centos7 ~]<span class="hljs-comment"># curl 172.16.0.100</span><br>web2<br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-3-Proxies配置-frontend"><a href="#3-4-2-3-Proxies配置-frontend" class="headerlink" title="3.4.2.3 Proxies配置-frontend"></a>3.4.2.3 Proxies配置-frontend</h5><p><strong>frontend 配置参数：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">bind</span>： <span class="hljs-comment">#指定HAProxy的监听地址，可以是IPV4或IPV6，可以同时监听多个IP或端口，可同时用于listen字段中</span><br><span class="hljs-comment">#格式：</span><br><span class="hljs-built_in">bind</span> [&lt;address&gt;]:&lt;port_range&gt; [, ...] [param*]<br><span class="hljs-comment">#注意：如果需要绑定在非本机的IP，需要开启内核参数：net.ipv4.ip_nonlocal_bind=1</span><br>backlog &lt;backlog&gt; <span class="hljs-comment">#针对所有server配置,当前端服务器的连接数达到上限后的后援队列长度，注意：不支持backend</span><br>4313<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen http_proxy <span class="hljs-comment">#监听http的多个IP的多个端口和sock文件</span><br>    <span class="hljs-built_in">bind</span> :80,:443,:8801-8810<br> <span class="hljs-built_in">bind</span> 10.0.0.1:10080,10.0.0.1:10443<br> <span class="hljs-built_in">bind</span> /var/run/ssl-frontend.sock user root mode 600 accept-proxy<br> <br>listen http_https_proxy <span class="hljs-comment">#https监听</span><br> <span class="hljs-built_in">bind</span> :80<br> <span class="hljs-built_in">bind</span> :443 ssl crt /etc/haproxy/site.pem <span class="hljs-comment">#公钥和私钥公共文件</span><br> <br>listen http_https_proxy_explicit <span class="hljs-comment">#监听ipv6、ipv4和unix sock文件</span><br> <span class="hljs-built_in">bind</span> ipv6@:80<br> <span class="hljs-built_in">bind</span> ipv4@public_ssl:443 ssl crt /etc/haproxy/site.pem<br> <span class="hljs-built_in">bind</span> unix@ssl-frontend.sock user root mode 600 accept-proxy<br> <br>listen external_bind_app1 <span class="hljs-comment">#监听file descriptor</span><br> <span class="hljs-built_in">bind</span> <span class="hljs-string">&quot;fd@<span class="hljs-variable">$&#123;FD_APP1&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure>

<p>生产示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">frontend magedu_web_port <span class="hljs-comment">#可以采用后面形式命名：业务-服务-端口号</span><br>    <span class="hljs-built_in">bind</span> :80,:8080<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:10080,:8801-8810,10.0.0.17:9001-9010<br>    mode http|tcp   <span class="hljs-comment">#指定负载协议类型</span><br>    use_backend &lt;backend_name&gt;  <span class="hljs-comment">#调用的后端服务器组名称</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-4-Proxies配置-backend"><a href="#3-4-2-4-Proxies配置-backend" class="headerlink" title="3.4.2.4 Proxies配置-backend"></a>3.4.2.4 Proxies配置-backend</h5><p>定义一组后端服务器，backend服务器将被frontend进行调用。<br>注意: backend 的名称必须唯一,并且必须在listen或frontend中事先定义才可以使用,否则服务无法启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">mode http|tcp   <span class="hljs-comment">#指定负载协议类型,和对应的frontend必须一致</span><br>option <span class="hljs-comment">#配置选项</span><br>server  <span class="hljs-comment">#定义后端real server,必须指定IP和端口</span><br></code></pre></td></tr></table></figure>

<p>注意：option后面加 httpchk，smtpchk,mysql-check,pgsql-check，ssl-hello-chk方法，可用于实现更多应用层检测功能。<br><strong>server 配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#针对一个server配置</span><br>check <span class="hljs-comment">#对指定real进行健康状态检查，如果不加此设置，默认不开启检查,只有check后面没有其它配置也可以启用检查功能</span><br><span class="hljs-comment">#默认对相应的后端服务器IP和端口,利用TCP连接进行周期性健康性检查（其实就是利用tcp的握手方式来检查）,注意必须指定端口才能实现健康性检查</span><br>addr &lt;IP&gt;  <span class="hljs-comment">#可指定的健康状态监测IP，可以是专门的数据网段，减少业务网络的流量</span><br>port &lt;num&gt; <span class="hljs-comment">#指定的健康状态监测端口</span><br>inter &lt;num&gt; <span class="hljs-comment">#健康状态检查间隔时间，默认2000 ms</span><br>fall &lt;num&gt;  <span class="hljs-comment">#后端服务器从线上转为线下的检查的连续失效次数，默认为3</span><br>rise &lt;num&gt;  <span class="hljs-comment">#后端服务器从下线恢复上线的检查的连续有效次数，默认为2</span><br>weight &lt;weight&gt; <span class="hljs-comment">#默认为1，最大值为256，0(状态为蓝色)表示不参与负载均衡（相当于服务器下线了），但仍接受持久连接</span><br>backup <span class="hljs-comment">#将后端服务器标记为备份状态,只在所有非备份主机down机时提供服务，类似Sorry Server</span><br>disabled <span class="hljs-comment">#将后端服务器标记为不可用状态，即维护状态，除了持久模式，将不再接受连接,状态为深黄色</span><br>redirect prefix http://www.baidu.com/ <span class="hljs-comment">#将请求临时(302)重定向至其它URL，只适用于http模式</span><br>redir http://www.baidu.com    <span class="hljs-comment">#将请求临时(302)重定向至其它URL，只适用于http模式</span><br>maxconn &lt;maxconn&gt; <span class="hljs-comment">#当前后端server的最大并发连接数</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-5-frontend-backend-配置实例"><a href="#3-4-2-5-frontend-backend-配置实例" class="headerlink" title="3.4.2.5 frontend+backend 配置实例"></a>3.4.2.5 frontend+backend 配置实例</h5><p>范例1：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">frontend magedu-test-http<br>    <span class="hljs-built_in">bind</span> :80,:8080<br>    mode tcp<br>    use_backend magedu-test-http-nodes<br><br>backend magedu-test-http-nodes<br>    mode tcp<br>    default-server inter 1000 weight 6 <br>    server web1 10.0.0.17:80 weight 2 check addr 10.0.0.117 port 8080<br>    server web1 10.0.0.27:80 check<br></code></pre></td></tr></table></figure>

<p>范例2：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#官网业务访问入口</span><br>frontend WEB_PORT_80<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    use_backend web_prot_http_nodes<br> <br>backend web_prot_http_nodes<br>    mode http<br>    option forwardfor<br>    server 10.0.0.17 10.0.0.17:8080  check inter 3000 fall 3 rise 5 <br>    server 10.0.0.27 10.0.0.27:8080  check inter 3000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h4 id="3-4-3-使用子配置文件保存配置"><a href="#3-4-3-使用子配置文件保存配置" class="headerlink" title="3.4.3 使用子配置文件保存配置"></a>3.4.3 使用子配置文件保存配置</h4><p>当业务众多时，将所有配置都放在一个配置文件中，会造成维护困难。可以考虑按业务分类，将配置信息拆分，放在不同的子配置文件中，从而达到方便维护的目的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建子配置目录</span><br>[root@centos7 ~]<span class="hljs-comment">#mkdir /etc/haproxy/conf.d/</span><br><br><span class="hljs-comment">#创建子配置文件，注意：必须为cfg后缀非.开头的配置文件</span><br>[root@centos7 ~]<span class="hljs-comment">#vim  /etc/haproxy/conf.d/test.cfg</span><br>listen WEB_PORT_80<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    balance roundrobin<br>    server web1  10.0.0.17:80 check inter 3000 fall 2 rise 5<br>    server web2  10.0.0.27:80 check inter 3000 fall 2 rise 5<br><br><span class="hljs-comment">#添加子配置目录到unit文件中</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /lib/systemd/system/haproxy.service</span><br>[Unit]<br>Description=HAProxy Load Balancer<br>After=syslog.target network.target<br><br>[Service]<br><span class="hljs-comment">#修改下面两行</span><br>ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf.d/  -c -q<br>ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf.d/  -p /var/lib/haproxy/haproxy.pid<br>ExecReload=/bin/<span class="hljs-built_in">kill</span> -USR2 <span class="hljs-variable">$MAINPID</span><br><br>[Install]<br>WantedBy=multi-user.target<br><br>[root@centos7 ~]<span class="hljs-comment">#systemctl daemon-reload</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart haproxy</span><br></code></pre></td></tr></table></figure>



<h2 id="四、HAProxy调度算法"><a href="#四、HAProxy调度算法" class="headerlink" title="四、HAProxy调度算法"></a>四、HAProxy调度算法</h2><p>HAProxy通过固定参数 balance 指明对后端服务器的调度算法，该参数可以配置在listen或backend选<br>项中。<br>HAProxy的调度算法分为静态和动态调度算法，但是有些算法可以根据参数在静态和动态算法中相互转换。<br>官方文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-balance">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-balance</a></p>
<h3 id="4-1-静态算法"><a href="#4-1-静态算法" class="headerlink" title="4.1 静态算法"></a>4.1 静态算法</h3><p>静态算法：按照事先定义好的规则轮询公平调度，不关心后端服务器的当前负载、连接数和响应速度<br>等，且无法实时修改权重(只能为0和1,不支持其它值)，只能靠重启HAProxy生效。</p>
<h4 id="4-1-1-socat-工具"><a href="#4-1-1-socat-工具" class="headerlink" title="4.1.1 socat 工具"></a>4.1.1 socat 工具</h4><p>对服务器动态权重和其它状态可以利用 socat工具进行调整，Socat 是 Linux 下的一个多功能的网络工<br>具，名字来由是Socket CAT，相当于netCAT的增强版.Socat 的主要特点就是在两个数据流之间建立双<br>向通道，且支持众多协议和链接方式。如 IP、TCP、 UDP、IPv6、Socket文件等<br>范例：利用工具socat 对服务器动态权重调整</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#yum -y install socat</span><br><br><span class="hljs-comment">#查看帮助</span><br>[root@centos7 ~]<span class="hljs-comment">#socat -h</span><br>[root@centos7 ~]<span class="hljs-comment">#echo &quot;help&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>Unknown <span class="hljs-built_in">command</span>. Please enter one of the following commands only :<br><span class="hljs-built_in">help</span>      : this message<br>prompt     : toggle interactive mode with prompt<br>quit      : disconnect<br>show tls-keys [id|*]: show tls keys references or dump tls ticket keys when id<br>specified<br> <span class="hljs-built_in">set</span> ssl tls-key [id|keyfile] &lt;tlskey&gt;: <span class="hljs-built_in">set</span> the next TLS key <span class="hljs-keyword">for</span> the &lt;id&gt; or<br>&lt;keyfile&gt; listener to &lt;tlskey&gt;<br> <span class="hljs-built_in">set</span> ssl cert &lt;certfile&gt; &lt;payload&gt; : replace a certificate file<br>commit ssl cert &lt;certfile&gt; : commit a certificate file<br>abort ssl cert &lt;certfile&gt; : abort a transaction <span class="hljs-keyword">for</span> a certificate file<br>show sess [id] : report the list of current sessions or dump this session<br>shutdown session : <span class="hljs-built_in">kill</span> a specific session<br>shutdown sessions server : <span class="hljs-built_in">kill</span> sessions on a server<br> clear counters : clear max statistics counters (add <span class="hljs-string">&#x27;all&#x27;</span> <span class="hljs-keyword">for</span> all counters)<br>show info   : report information about the running process<br>[desc|json|typed]*<br>show <span class="hljs-built_in">stat</span>   : report counters <span class="hljs-keyword">for</span> each proxy and server [desc|json|typed]*<br>show schema json : report schema used <span class="hljs-keyword">for</span> stats<br><span class="hljs-built_in">disable</span> agent : <span class="hljs-built_in">disable</span> agent checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br><span class="hljs-built_in">disable</span> health : <span class="hljs-built_in">disable</span> health checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br><span class="hljs-built_in">disable</span> server : <span class="hljs-built_in">disable</span> a server <span class="hljs-keyword">for</span> maintenance (use <span class="hljs-string">&#x27;set server&#x27;</span> instead) <span class="hljs-comment">#禁用服务器</span><br><span class="hljs-built_in">enable</span> agent  : <span class="hljs-built_in">enable</span> agent checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br><span class="hljs-built_in">enable</span> health : <span class="hljs-built_in">enable</span> health checks (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)<br><span class="hljs-built_in">enable</span> server : <span class="hljs-built_in">enable</span> a disabled server (use <span class="hljs-string">&#x27;set server&#x27;</span> instead)  <span class="hljs-comment">#启用服务器</span><br> <span class="hljs-built_in">set</span> maxconn server : change a server<span class="hljs-string">&#x27;s maxconn setting</span><br><span class="hljs-string"> set server   : change a server&#x27;</span>s state, weight or address      <span class="hljs-comment">#设置服务器</span><br> get weight   : report a server<span class="hljs-string">&#x27;s current weight</span><br><span class="hljs-string"> set weight   : change a server&#x27;</span>s weight (deprecated)<br>show startup-logs : report logs emitted during HAProxy startup<br>show peers [peers section]: dump some information about all the peers or this<br>peers section<br> <span class="hljs-built_in">set</span> maxconn global : change the per-process maxconn setting<br> <span class="hljs-built_in">set</span> rate-limit : change a rate limiting value<br> <span class="hljs-built_in">set</span> severity-output [none|number|string] : <span class="hljs-built_in">set</span> presence of severity level <span class="hljs-keyword">in</span><br>feedback information<br> <span class="hljs-built_in">set</span> timeout  : change a timeout setting<br>show env [var] : dump environment variables known to the process<br>show cli sockets : dump list of cli sockets<br>show cli level  : display the level of the current CLI session<br>show fd [num] : dump list of file descriptors <span class="hljs-keyword">in</span> use<br>show activity : show per-thread activity stats (<span class="hljs-keyword">for</span> support/developers)<br>operator    : lower the level of the current CLI session to operator<br>user      : lower the level of the current CLI session to user<br> clear table  : remove an entry from a table<br> <span class="hljs-built_in">set</span> table [id] : update or create a table entry<span class="hljs-string">&#x27;s data</span><br><span class="hljs-string">show table [id]: report table usage stats or dump this table&#x27;</span>s contents<br><span class="hljs-built_in">disable</span> frontend : temporarily <span class="hljs-built_in">disable</span> specific frontend<br><span class="hljs-built_in">enable</span> frontend : re-enable specific frontend<br> <span class="hljs-built_in">set</span> maxconn frontend : change a frontend<span class="hljs-string">&#x27;s maxconn setting</span><br><span class="hljs-string">show servers state [id]: dump volatile server information (for backend &lt;id&gt;)</span><br><span class="hljs-string">show backend  : list backends in the current running config</span><br><span class="hljs-string">shutdown frontend : stop a specific frontend</span><br><span class="hljs-string"> set dynamic-cookie-key backend : change a backend secret key for dynamic</span><br><span class="hljs-string">cookies</span><br><span class="hljs-string">enable dynamic-cookie backend : enable dynamic cookies on a specific backend</span><br><span class="hljs-string">disable dynamic-cookie backend : disable dynamic cookies on a specific backend</span><br><span class="hljs-string">show errors  : report last request and response errors for each proxy</span><br><span class="hljs-string">show resolvers [id]: dumps counters from all resolvers section and</span><br><span class="hljs-string">          associated name servers</span><br><span class="hljs-string">show cache   : show cache status</span><br><span class="hljs-string">add acl    : add acl entry</span><br><span class="hljs-string"> clear acl &lt;id&gt; : clear the content of this acl</span><br><span class="hljs-string">del acl    : delete acl entry</span><br><span class="hljs-string"> get acl    : report the patterns matching a sample for an ACL</span><br><span class="hljs-string">show acl [id] : report available acls or dump an acl&#x27;</span>s contents<br>add map    : add map entry<br> clear map &lt;id&gt; : clear the content of this map<br>del map    : delete map entry<br> get map    : report the keys and values matching a sample <span class="hljs-keyword">for</span> a map<br> <span class="hljs-built_in">set</span> map    : modify map entry<br>show map [id] : report available maps or dump a map<span class="hljs-string">&#x27;s contents</span><br><span class="hljs-string">trace &lt;module&gt; [cmd [args...]] : manage live tracing</span><br><span class="hljs-string">show trace [&lt;module&gt;] : show live tracing state</span><br><span class="hljs-string">show threads  : show some threads debugging information</span><br><span class="hljs-string">show pools   : report information about the memory pools usage</span><br><span class="hljs-string">show events [&lt;sink&gt;] : show event sink state</span><br><span class="hljs-string">show profiling : show CPU profiling options</span><br><span class="hljs-string"> set profiling : enable/disable CPU profiling</span><br><span class="hljs-string"> </span><br><span class="hljs-string"> [root@centos7 ~]#echo &quot;show info&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string">Name: HAProxy</span><br><span class="hljs-string">Version: 2.1.3</span><br><span class="hljs-string">Release_date: 2020/02/12</span><br><span class="hljs-string">Nbthread: 4</span><br><span class="hljs-string">Nbproc: 1</span><br><span class="hljs-string">Process_num: 1</span><br><span class="hljs-string">Pid: 2279</span><br><span class="hljs-string">Uptime: 0d 0h46m07s</span><br><span class="hljs-string">Uptime_sec: 2767</span><br><span class="hljs-string">Memmax_MB: 0</span><br><span class="hljs-string">PoolAlloc_MB: 0</span><br><span class="hljs-string">PoolUsed_MB: 0</span><br><span class="hljs-string">PoolFailed: 0</span><br><span class="hljs-string">Ulimit-n: 200041</span><br><span class="hljs-string">Maxsock: 200041</span><br><span class="hljs-string">Maxconn: 100000</span><br><span class="hljs-string">Hard_maxconn: 100000</span><br><span class="hljs-string">CurrConns: 0</span><br><span class="hljs-string">CumConns: 1</span><br><span class="hljs-string">CumReq: 1</span><br><span class="hljs-string">MaxSslConns: 0</span><br><span class="hljs-string">CurrSslConns: 0</span><br><span class="hljs-string">CumSslConns: 0</span><br><span class="hljs-string">Maxpipes: 0</span><br><span class="hljs-string">PipesUsed: 0</span><br><span class="hljs-string">PipesFree: 0</span><br><span class="hljs-string">ConnRate: 0</span><br><span class="hljs-string">ConnRateLimit: 0</span><br><span class="hljs-string">MaxConnRate: 0</span><br><span class="hljs-string">SessRate: 0</span><br><span class="hljs-string">SessRateLimit: 0</span><br><span class="hljs-string">MaxSessRate: 0</span><br><span class="hljs-string">SslRate: 0</span><br><span class="hljs-string">SslRateLimit: 0</span><br><span class="hljs-string">MaxSslRate: 0</span><br><span class="hljs-string">SslFrontendKeyRate: 0</span><br><span class="hljs-string">SslFrontendMaxKeyRate: 0</span><br><span class="hljs-string">SslFrontendSessionReuse_pct: 0</span><br><span class="hljs-string">SslBackendKeyRate: 0</span><br><span class="hljs-string">SslBackendMaxKeyRate: 0</span><br><span class="hljs-string">SslCacheLookups: 0</span><br><span class="hljs-string">SslCacheMisses: 0</span><br><span class="hljs-string">CompressBpsIn: 0</span><br><span class="hljs-string">CompressBpsOut: 0</span><br><span class="hljs-string">CompressBpsRateLim: 0</span><br><span class="hljs-string">ZlibMemUsage: 0</span><br><span class="hljs-string">MaxZlibMemUsage: 0</span><br><span class="hljs-string">Tasks: 19</span><br><span class="hljs-string">Run_queue: 1</span><br><span class="hljs-string">Idle_pct: 100</span><br><span class="hljs-string">node: centos7.wangxiaochun.com</span><br><span class="hljs-string">Stopping: 0</span><br><span class="hljs-string">Jobs: 7</span><br><span class="hljs-string">Unstoppable Jobs: 0</span><br><span class="hljs-string">Listeners: 6</span><br><span class="hljs-string">ActivePeers: 0</span><br><span class="hljs-string">ConnectedPeers: 0</span><br><span class="hljs-string">DroppedLogs: 0</span><br><span class="hljs-string">BusyPolling: 0</span><br><span class="hljs-string">FailedResolutions: 0</span><br><span class="hljs-string">TotalBytesOut: 0</span><br><span class="hljs-string">BytesOutRate: 0</span><br><span class="hljs-string">DebugCommandsIssued: 0</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#cat /etc/haproxy/haproxy.cfg</span><br><span class="hljs-string">......</span><br><span class="hljs-string">listen magedu-test-80</span><br><span class="hljs-string">bind :81,:82</span><br><span class="hljs-string">mode http</span><br><span class="hljs-string">server web1 10.0.0.17:80 check inter 3000 fall 3 rise 5</span><br><span class="hljs-string">server web2 10.0.0.27:80 check weight 3 </span><br><span class="hljs-string">......</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;show servers state&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string">1</span><br><span class="hljs-string"># be_id be_name srv_id srv_name srv_addr srv_op_state srv_admin_state</span><br><span class="hljs-string">srv_uweight srv_iweight srv_time_since_last_change srv_check_status</span><br><span class="hljs-string">srv_check_result srv_check_health srv_check_state srv_agent_state bk_f_forced_id</span><br><span class="hljs-string">srv_f_forced_id srv_fqdn srv_port srvrecord</span><br><span class="hljs-string">2 magedu-test-80 1 web1 10.0.0.17 2 0 2 1 812 6 3 7 6 0 0 0 - 80 -</span><br><span class="hljs-string">2 magedu-test-80 2 web2 10.0.0.27 2 0 2 3 812 6 3 4 6 0 0 0 - 80 -</span><br><span class="hljs-string">4 web_port 1 web1 127.0.0.1 0 0 1 1 810 8 2 0 6 0 0 0 - 8080 -</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;get weight magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock #注意配置文件中listen的名称</span><br><span class="hljs-string">3 (initial 3)</span><br><span class="hljs-string"></span><br><span class="hljs-string">#修改weight，注意只针对单进程有效。如要完全实现权重修改，就必须修改所有的sock文件</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;set weight magedu-test-80/web2 2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;get weight magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string">2 (initial 3)</span><br><span class="hljs-string"></span><br><span class="hljs-string">#将后端服务器禁用，注意只针对单进程有效。要完全实现权重修改，就必须修改所有的sock文件</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;disable server magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">#启用后端服务器</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;enable server magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">#将后端服务器软下线，即weight设为0</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;set weight magedu-test-80/web1 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">#针对haproxy的多进程,将后端服务器禁用</span><br><span class="hljs-string">[root@centos7 ~]#vim /etc/haproxy/haproxy.cfg</span><br><span class="hljs-string">......</span><br><span class="hljs-string">stats socket /var/lib/haproxy/haproxy1.sock mode 600 level admin process 1 #绑定第1个进程和socket文件</span><br><span class="hljs-string">stats socket /var/lib/haproxy/haproxy2.sock mode 600 level admin process 2 #绑定第2个进程和socket文件</span><br><span class="hljs-string">nbproc 2</span><br><span class="hljs-string">.....</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;disable server magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy1.sock</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;disable server magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy2.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@haproxy ~]#for i in &#123;1..2&#125;;do echo &quot;set weight magedu-test-80/web$i 10&quot; | socat stdio /var/lib/haproxy/haproxy$i.sock;done</span><br><span class="hljs-string"></span><br><span class="hljs-string">#如果静态算法，如:static-rr，可以更改weight为0或1，但不支持动态更改weight为其它值，否则会提示下面信息</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;set weight magedu-test-80/web1 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;set weight magedu-test-80/web1 1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@centos7 ~]#echo &quot;set weight magedu-test-80/web1 2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="hljs-string">Backend is using a static LB algorithm and only accepts weights &#x27;</span>0%<span class="hljs-string">&#x27; and &#x27;</span>100%<span class="hljs-string">&#x27;.</span><br></code></pre></td></tr></table></figure>

<p>范例: 上线和下线后端服务器脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat haproyx_host_up_down.sh</span><br>. /etc/init.d/<span class="hljs-built_in">functions</span><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>up)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;set weight magedu-m42-web-80/<span class="hljs-variable">$2</span> 1&quot;</span> | socat stdio /var/lib/haproxy/haproxy.sock<br> [ $? -eq 0 ] &amp;&amp; action <span class="hljs-string">&quot;<span class="hljs-variable">$2</span> is up&quot;</span><br> ;;<br>down)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;set weight magedu-m42-web-80/<span class="hljs-variable">$2</span> 0&quot;</span> | socat stdio /var/lib/haproxy/haproxy.sock<br> [ $? -eq 0 ] &amp;&amp; action <span class="hljs-string">&quot;<span class="hljs-variable">$2</span> is down&quot;</span><br> ;;<br>*)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: `basename <span class="hljs-variable">$0</span>` up|down IP&quot;</span><br> ;;<br><span class="hljs-keyword">esac</span><br><br><span class="hljs-comment">#下图操作需要将脚本添加执行权限和做软连接到/usr/bin/下</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy27.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-1-2-static-rr"><a href="#4-1-2-static-rr" class="headerlink" title="4.1.2 static-rr"></a>4.1.2 static-rr</h4><p>static-rr：基于权重的轮询调度，不支持运行时利用socat进行权重的动态调整(只支持0和1,不支持其它值)及后端服务器慢启动，其后端主机数量没有限制，相当于LVS中的 wrr</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance static-rr<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 2 check inter 3000 fall 2 rise 5<br><br><span class="hljs-comment">#查看此时权重</span><br>[root@haproxy ~]<span class="hljs-comment"># echo &quot;get weight web_80_port/web1 1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>1 (initial 1)<br><br><span class="hljs-comment">#不能动态修改权重，但是可以改成0或1</span><br>[root@haproxy ~]<span class="hljs-comment"># echo &quot;set weight web_80_port/web1 3&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>Backend is using a static LB algorithm and only accepts weights <span class="hljs-string">&#x27;0%&#x27;</span> and <span class="hljs-string">&#x27;100%&#x27;</span>.<br><br>[root@haproxy ~]<span class="hljs-comment"># echo &quot;set weight web_80_port/web1 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><br>[root@haproxy ~]<span class="hljs-comment"># echo &quot;set weight web_80_port/web1 1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><br><br></code></pre></td></tr></table></figure>

<h4 id="4-1-3-first"><a href="#4-1-3-first" class="headerlink" title="4.1.3 first"></a>4.1.3 first</h4><p>first：根据服务器在列表中的位置，自上而下进行调度，但是其只会当第一台服务器的连接数达到上<br>限，新请求才会分配给下一台服务，因此会忽略服务器的权重设置，此方式使用较少<br>不支持用socat进行动态修改权重,可以设置0和1,可以设置其它值但无效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance first<br>    server web1 10.0.0.17:80 maxconn 2 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<p>测试访问效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#同时运行下面命令，观察结果</span><br><span class="hljs-comment"># while true;do curl http://10.0.0.7/index.html ; sleep 0.1;done</span><br></code></pre></td></tr></table></figure>

<h3 id="4-2-动态算法"><a href="#4-2-动态算法" class="headerlink" title="4.2 动态算法"></a>4.2 动态算法</h3><p>动态算法：基于后端服务器状态进行调度适当调整，优先调度至当前负载较低的服务器，且权重可以在haproxy运行时动态调整无需重启。</p>
<h4 id="4-2-1-roundrobin"><a href="#4-2-1-roundrobin" class="headerlink" title="4.2.1 roundrobin"></a>4.2.1 roundrobin</h4><p>roundrobin：基于权重的轮询动态调度算法，支持权重的运行时调整，不同于lvs中的rr轮训模式，<br>HAProxy中的roundrobin支持慢启动(新加的服务器会逐渐增加转发数)，其每个后端backend中最多支持4095个real server，支持对real server权重动态调整，<strong>roundrobin为默认调度算法</strong>,此算法使用广泛</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance roundrobin<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 2 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<p>支持动态调整权重：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># echo &quot;get weight web_host/web1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>1 (initial 1)<br><br><span class="hljs-comment"># echo &quot;set weight web_host/web1 3&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><br><span class="hljs-comment"># echo &quot;get weight web_host/web1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>3 (initial 1)<br></code></pre></td></tr></table></figure>

<h4 id="4-2-2-leastconn"><a href="#4-2-2-leastconn" class="headerlink" title="4.2.2 leastconn"></a>4.2.2 leastconn</h4><p>leastconn加权的最少连接的动态，支持权重的运行时调整和慢启动，即:根据当前连接最少的后端服务器而非权重进行优先调度(新客户端连接)，比较适合长连接的场景使用，比如：MySQL等场景</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance leastconn<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h4 id="4-2-3-random"><a href="#4-2-3-random" class="headerlink" title="4.2.3 random"></a>4.2.3 random</h4><p>在1.9版本开始增加 random的负载平衡算法，其基于随机数作为一致性hash的key，随机负载平衡对于大型服务器场或经常添加或删除服务器非常有用，支持weight的动态调整，weight较大的主机有更大概率获取新请求<br>random配置实例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance random<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h3 id="4-3-其他算法"><a href="#4-3-其他算法" class="headerlink" title="4.3 其他算法"></a>4.3 其他算法</h3><p>其它算法即可作为静态算法，又可以通过选项成为动态算法</p>
<h4 id="4-3-1-source"><a href="#4-3-1-source" class="headerlink" title="4.3.1 source"></a>4.3.1 source</h4><p>源地址hash，基于用户源地址hash并将请求转发到后端服务器，后续同一个源地址请求将被转发至同<br>一个后端web服务器。此方式当后端服务器数据量发生变化时，会导致很多用户的请求转发至新的后端服务器，默认为静态方式，但是可以通过hash-type支持的选项更改</p>
<p>这个算法一般是在不插入Cookie的TCP模式下使用，也可给拒绝会话cookie的客户提供最好的会话粘<br>性，适用于session会话保持但不支持cookie和缓存的场景</p>
<p>源地址有两种转发客户端请求到后端服务器的服务器选取计算方式，分别是取模法和一致性hash</p>
<h5 id="4-3-1-1-map-base-取模法"><a href="#4-3-1-1-map-base-取模法" class="headerlink" title="4.3.1.1 map-base 取模法"></a>4.3.1.1 map-base 取模法</h5><p>map-based：取模法，对source地址进行hash计算，再基于服务器总权重的取模，最终结果决定将此<br>请求转发至对应的后端服务器。此方法是静态的，即不支持在线调整权重，不支持慢启动，可实现对后端服务器均衡调度。缺点是当服务器的总权重发生变化时，即有服务器上线或下线，都会因总权重发生变化而导致调度结果整体改变，hash-type 指定的默认值为此算法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">所谓取模运算，就是计算两个数相除之后的余数，10%7=3, 7%4=3<br>map-based算法：基于权重取模，hash(source_ip)%所有后端服务器相加的总权重<br></code></pre></td></tr></table></figure>

<p>取模法配置示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode tcp<br>    <span class="hljs-built_in">log</span> global<br>    balance <span class="hljs-built_in">source</span><br>    hash-type map-based<br>    server web1  10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 3<br>    server web2  10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 3<br><br><span class="hljs-comment">#不支持动态调整权重值</span><br>[root@haproxy ~]<span class="hljs-comment">#echo &quot;set weight web_host/10.0.0.27 10&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>Backend is using a static LB algorithm and only accepts weights <span class="hljs-string">&#x27;0%&#x27;</span> and <span class="hljs-string">&#x27;100%&#x27;</span>.<br><br><span class="hljs-comment">#只能动态上线和下线</span><br>[root@haproxy ~]<span class="hljs-comment">#echo &quot;set weight web_host/10.0.0.27 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br><br>[root@haproxy conf.d]<span class="hljs-comment">#echo &quot;get weight web_host/10.0.0.27&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span><br>0 (initial 1)<br></code></pre></td></tr></table></figure>

<h5 id="4-3-1-2-一致性hash"><a href="#4-3-1-2-一致性hash" class="headerlink" title="4.3.1.2 一致性hash"></a>4.3.1.2 一致性hash</h5><p>一致性哈希，当服务器的总权重发生变化时，对调度结果影响是局部的，不会引起大的变动，<br>hash（o）mod n ，该hash算法是动态的，支持使用 socat等工具进行在线权重调整，支持慢启动<br>算法：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">1、key1=hash(source_ip)%(2^32) [0---4294967295]<br>2、keyA=hash(后端服务器虚拟ip)%(2^32)<br>3、将key1和keyA都放在hash环上，将用户请求调度到离key1最近的keyA对应的后端服务器<br></code></pre></td></tr></table></figure>

<p>hash环偏斜问题</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">增加虚拟服务器IP数量，比如：一个后端服务器根据权重为1生成1000个虚拟IP，再hash。而后端服务器权<br>重为2则生成2000的虚拟IP，再bash,最终在hash环上生成3000个节点，从而解决hash环偏斜问题<br></code></pre></td></tr></table></figure>

<h6 id="4-3-1-2-1-hash对象"><a href="#4-3-1-2-1-hash对象" class="headerlink" title="4.3.1.2.1 hash对象"></a>4.3.1.2.1 hash对象</h6><p>Hash对象到后端服务器的映射关系：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy28.png" srcset="/blog/img/loading.gif"></p>
<h6 id="4-3-1-2-2-一致性hash示意图"><a href="#4-3-1-2-2-一致性hash示意图" class="headerlink" title="4.3.1.2.2 一致性hash示意图"></a>4.3.1.2.2 一致性hash示意图</h6><p>后端服务器在线与离线的调度方式</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy29.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy30.png" srcset="/blog/img/loading.gif"></p>
<h6 id="4-3-1-2-3-一致性hash配置示例"><a href="#4-3-1-2-3-一致性hash配置示例" class="headerlink" title="4.3.1.2.3 一致性hash配置示例"></a>4.3.1.2.3 一致性hash配置示例</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode tcp<br>    <span class="hljs-built_in">log</span> global<br>    balance <span class="hljs-built_in">source</span><br>    hash-type consistent<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h4 id="4-3-2-uri"><a href="#4-3-2-uri" class="headerlink" title="4.3.2 uri"></a>4.3.2 uri</h4><p>基于对用户请求的URI的左半部分或整个uri做hash，再将hash结果对总权重进行取模后，根据最终结<br>果将请求转发到后端指定服务器，适用于后端是缓存服务器场景，默认是静态算法，也可以通过hash-<br>type指定map-based和consistent，来定义使用取模法还是一致性hash。<br><strong>注意：此算法基于应用层，所以只支持 mode http ，不支持 mode tcp</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;<br>左半部分：/&lt;path&gt;;&lt;params&gt;<br>整个uri：/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy31.png" srcset="/blog/img/loading.gif"></p>
<h5 id="4-3-2-1-uri-取模法配置示例"><a href="#4-3-2-1-uri-取模法配置示例" class="headerlink" title="4.3.2.1 uri 取模法配置示例"></a>4.3.2.1 uri 取模法配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance uri<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h5 id="4-3-2-2-uri-一致性hash配置示例"><a href="#4-3-2-2-uri-一致性hash配置示例" class="headerlink" title="4.3.2.2 uri 一致性hash配置示例"></a>4.3.2.2 uri 一致性hash配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance uri<br>    hash-type consistent<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h5 id="4-3-2-3-访问测试"><a href="#4-3-2-3-访问测试" class="headerlink" title="4.3.2.3 访问测试"></a>4.3.2.3 访问测试</h5><p>访问不同的uri，确认可以将用户同样的请求转发至相同的服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curl http://10.0.0.7/test1.html</span><br><span class="hljs-comment"># curl http://10.0.0.7/test2..html</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-3-url-param"><a href="#4-3-3-url-param" class="headerlink" title="4.3.3 url_param"></a>4.3.3 url_param</h4><p>url_param对用户请求的url中的 params 部分中的一个参数key对应的value值作hash计算，并由服务<br>器总权重相除以后派发至某挑出的服务器；通常用于追踪用户，以确保来自同一个用户的请求始终发往同一个real server，如果无没key，将按roundrobin算法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">假设：<br>url = http://www.magedu.com/foo/bar/index.php?key=value<br><br>则：<br>host = <span class="hljs-string">&quot;www.magedu.com&quot;</span><br>url_param = <span class="hljs-string">&quot;key=value&quot;</span><br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-1-url-param取模法配置示例"><a href="#4-3-3-1-url-param取模法配置示例" class="headerlink" title="4.3.3.1 url_param取模法配置示例"></a>4.3.3.1 url_param取模法配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance url_param userid <span class="hljs-comment">#url_param hash</span><br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-2-url-param一致性hash配置示例"><a href="#4-3-3-2-url-param一致性hash配置示例" class="headerlink" title="4.3.3.2 url_param一致性hash配置示例"></a>4.3.3.2 url_param一致性hash配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance url_param userid keyword <span class="hljs-comment">#对url_param的值取hash</span><br>    hash-type consistent<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h5 id="4-3-3-3-测试访问"><a href="#4-3-3-3-测试访问" class="headerlink" title="4.3.3.3 测试访问"></a>4.3.3.3 测试访问</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">#url_param取模法<br># curl http://10.0.0.7/index.html?userid=&lt;NAME_ID&gt;<br>例子：<br>curl http://10.0.0.7/index.html?userid=1<br>curl http://10.0.0.7/index.html?userid=2<br>#url_param一致性hash<br># curl &quot;http://10.0.0.7/index.html?userid=&lt;NAME_ID&gt;&amp;typeid=&lt;TYPE_ID&gt;&quot;<br>例子：<br>curl http://10.0.0.7/index.html?userid=1&amp;typeid=1<br>curl http://10.0.0.7/index.html?userid=2&amp;typeid=2<br></code></pre></td></tr></table></figure>

<h4 id="4-3-4-hdr"><a href="#4-3-4-hdr" class="headerlink" title="4.3.4 hdr"></a>4.3.4 hdr</h4><p>针对用户每个http头部(header)请求中的指定信息做hash，此处由 name 指定的http首部将会被取出并做hash计算，然后由服务器总权重取模以后派发至某挑出的服务器，如果无有效值，则会使用默认的轮询调度。</p>
<h5 id="4-3-4-1-hdr取模法配置示例"><a href="#4-3-4-1-hdr取模法配置示例" class="headerlink" title="4.3.4.1 hdr取模法配置示例"></a>4.3.4.1 hdr取模法配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance hdr(User-Agent)<br>    <span class="hljs-comment">#balance hdr(host)</span><br><br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h5 id="4-3-4-2-一致性hash配置示例"><a href="#4-3-4-2-一致性hash配置示例" class="headerlink" title="4.3.4.2 一致性hash配置示例"></a>4.3.4.2 一致性hash配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance hdr(User-Agent)<br>    hash-type consistent<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h5 id="4-3-4-3-测试访问"><a href="#4-3-4-3-测试访问" class="headerlink" title="4.3.4.3 测试访问"></a>4.3.4.3 测试访问</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -v http://10.0.0.7/index.html</span><br>[root@centos6 ~]<span class="hljs-comment">#curl -vA &#x27;firefox&#x27; http://10.0.0.7/index.html</span><br>[root@centos6 ~]<span class="hljs-comment">#curl -vA &#x27;chrome&#x27; http://10.0.0.7/index.html</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-5-rdp-cookie"><a href="#4-3-5-rdp-cookie" class="headerlink" title="4.3.5 rdp-cookie"></a>4.3.5 rdp-cookie</h4><p>rdp-cookie对远windows远程桌面的负载，使用cookie保持会话，默认是静态，也可以通过hash-type<br>指定map-based和consistent，来定义使用取模法还是一致性hash。</p>
<h5 id="4-3-5-1-rdp-cookie-取模法配置示例"><a href="#4-3-5-1-rdp-cookie-取模法配置示例" class="headerlink" title="4.3.5.1 rdp-cookie 取模法配置示例"></a>4.3.5.1 rdp-cookie 取模法配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen RDP<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:3389<br>    balance rdp-cookie<br>    mode tcp<br>    server rdp0 10.0.0.17:3389 check fall 3 rise 5 inter 2000 weight 1<br></code></pre></td></tr></table></figure>

<h5 id="4-3-5-2-rdp-cookie-一致性hash配置示例"><a href="#4-3-5-2-rdp-cookie-一致性hash配置示例" class="headerlink" title="4.3.5.2 rdp-cookie 一致性hash配置示例"></a>4.3.5.2 rdp-cookie 一致性hash配置示例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@haproxy ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/windows_rdp.cfg</span><br>listen windows_RDP_3389<br>    <span class="hljs-built_in">bind</span>  172.16.0.100:3389<br>    balance rdp-cookie<br>    hash-type consistent<br>    mode tcp<br>    server rdp0 10.0.0.200:3389 check fall 3 rise 5 inter 2000 weight 1<br><br>[root@haproxy ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.7 172.16.0.100<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy32.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy33.png" srcset="/blog/img/loading.gif"></p>
<h5 id="4-3-5-3-基于iptables实现RDP协议转发"><a href="#4-3-5-3-基于iptables实现RDP协议转发" class="headerlink" title="4.3.5.3 基于iptables实现RDP协议转发"></a>4.3.5.3 基于iptables实现RDP协议转发</h5><p>必须开启ip转发功能： net.ipv4.ip_forward = 1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#sysctl -w net.ipv4.ip_forward=1</span><br><span class="hljs-comment">#客户端和Windows在不同网段需要下面命令,注意后端服务器需要将iptables主机配置为网关</span><br>[root@centos8 ~]<span class="hljs-comment">#iptables -t nat -A PREROUTING -d 172.16.0.100 -p tcp --dport 3389 -j DNAT --to-destination 10.0.0.200:3389</span><br><br><span class="hljs-comment">#客户端和Windows在同一网段需要再执行下面命令</span><br>[root@centos8 ~]<span class="hljs-comment">#iptables -t nat -A PREROUTING -d 10.0.0.8 -p tcp --dport 3389 -j DNAT --to-destination 10.0.0.1:3389</span><br>[root@centos8 ~]<span class="hljs-comment">#iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j SNAT --to-source 10.0.0.8</span><br><br><span class="hljs-comment">#注意window网关要指向转发机器的ip地址</span><br></code></pre></td></tr></table></figure>

<p>在windows 可以看到以下信息</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy34.png" srcset="/blog/img/loading.gif"></p>
<h4 id="4-3-6-算法总结"><a href="#4-3-6-算法总结" class="headerlink" title="4.3.6 算法总结"></a>4.3.6 算法总结</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#静态</span><br>static-rr---------&gt;tcp/http <br>first-------------&gt;tcp/http <br><br><span class="hljs-comment">#动态</span><br>roundrobin--------&gt;tcp/http<br>leastconn---------&gt;tcp/http<br>random------------&gt;tcp/http<br><br><span class="hljs-comment">#以下静态和动态取决于hash_type是否consistent</span><br><span class="hljs-built_in">source</span>------------&gt;tcp/http<br>Uri---------------&gt;http<br>url_param---------&gt;http  <br>hdr---------------&gt;http<br>rdp-cookie--------&gt;tcp<br></code></pre></td></tr></table></figure>

<h4 id="4-3-7-各算法使用场景"><a href="#4-3-7-各算法使用场景" class="headerlink" title="4.3.7 各算法使用场景"></a>4.3.7 各算法使用场景</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">first <span class="hljs-comment">#使用较少</span><br><br>static-rr <span class="hljs-comment">#做了session共享的web集群</span><br>roundrobin<br>random<br><br>leastconn <span class="hljs-comment">#数据库</span><br><span class="hljs-built_in">source</span> <span class="hljs-comment">#基于客户端公网IP的会话保持</span><br><br>Uri---------------&gt;http  <span class="hljs-comment">#缓存服务器，CDN服务商，蓝汛、百度、阿里云、腾讯</span><br>url_param---------&gt;http  <span class="hljs-comment">#可以实现session保持</span><br><br>hdr <span class="hljs-comment">#基于客户端请求报文头部做下一步处理</span><br>rdp-cookie <span class="hljs-comment">#基于Windows主机,很少使用</span><br></code></pre></td></tr></table></figure>



<h2 id="五、高级功能及配置"><a href="#五、高级功能及配置" class="headerlink" title="五、高级功能及配置"></a>五、高级功能及配置</h2><p>介绍HAProxy高级配置及实用案例</p>
<h3 id="5-1-基于cookie的会话保持"><a href="#5-1-基于cookie的会话保持" class="headerlink" title="5.1 基于cookie的会话保持"></a>5.1 基于cookie的会话保持</h3><p>cookie value：为当前server指定cookie值，实现基于cookie的会话黏性，相对于基于 source 地址<br>hash 调度算法对客户端的粒度更精准，但同时也加大了haproxy负载，目前此模式使用较少， 已经被<br>session共享服务器代替</p>
<p>注意：不支持 tcp mode，使用 http mode</p>
<h4 id="5-1-1-配置选项"><a href="#5-1-1-配置选项" class="headerlink" title="5.1.1 配置选项"></a>5.1.1 配置选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">cookie name [ rewrite | insert | prefix ][ indirect ] [ nocache ][ postonly ] [<br>preserve ][ httponly ] [ secure ][ domain ]* [ maxidle &lt;idle&gt; ][ maxlife ]<br><br>name： <span class="hljs-comment">#cookie 的 key名称，用于实现持久连接</span><br>insert： <span class="hljs-comment">#插入新的cookie,默认不插入cookie</span><br>indirect： <span class="hljs-comment">#如果客户端已经有cookie,则不会再发送cookie信息</span><br>nocache： <span class="hljs-comment">#当client和hapoxy之间有缓存服务器（如：CDN）时，不允许中间缓存器缓存cookie，因为这会导致很多经过同一个CDN的请求都发送到同一台后端服务器</span><br></code></pre></td></tr></table></figure>

<h4 id="5-1-2-配置示例"><a href="#5-1-2-配置示例" class="headerlink" title="5.1.2 配置示例"></a>5.1.2 配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>balance roundrobin<br>mode http <span class="hljs-comment">#不支持 tcp mode</span><br><span class="hljs-built_in">log</span> global<br>cookie WEBSRV insert nocache indirect<br>server web1  10.0.0.17:80 check inter 3000 fall 2 rise 5 cookie web1<br>server web2  10.0.0.27:80 check inter 3000 fall 2 rise 5 cookie web2<br>解释：<br>第一次访问网站的时候系统会，响应报文会被服务器分配一个cookie（使用上面的参数为例，WEDSRV=web1）请求报文不会收到cookie。<br>下次访问同一个网站的时候，请求报文就携带上次响应报文里收到的cookie（也就是：WEDSRV=web1），然后haproxy收到就知道上次用户访问被分配到cookie为web1的服务器里，那么这次也是分配到web1。<br>如果浏览器缓存清理后就会重新分配cookie<br></code></pre></td></tr></table></figure>

<p>5.1.3 验证cookie信息<br>浏览器验证：</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy35.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy36.png" srcset="/blog/img/loading.gif"></p>
<p>通过命令行验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -i 10.0.0.7</span><br>HTTP/1.1 200 OK<br>date: Thu, 02 Apr 2020 02:26:08 GMT<br>server: Apache/2.4.6 (CentOS)<br>last-modified: Thu, 02 Apr 2020 01:44:28 GMT<br>etag: <span class="hljs-string">&quot;a-5a244f0fd5175&quot;</span><br>accept-ranges: bytes<br>content-length: 10<br>content-type: text/html; charset=UTF-8<br>set-cookie: WEBSRV=web2; path=/<br>cache-control: private<br><br>10.0.0.27<br>[root@centos6 ~]<span class="hljs-comment">#curl -i 10.0.0.7</span><br>HTTP/1.1 200 OK<br>date: Thu, 02 Apr 2020 02:26:15 GMT<br>server: Apache/2.4.6 (CentOS)<br>last-modified: Thu, 02 Apr 2020 01:44:13 GMT<br>etag: <span class="hljs-string">&quot;a-5a244f01f8adc&quot;</span><br>accept-ranges: bytes<br>content-length: 10<br>content-type: text/html; charset=UTF-8<br>set-cookie: WEBSRV=web1; path=/<br>cache-control: private<br><br>10.0.0.17<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -b WEBSRV=web1 10.0.0.7</span><br>10.0.0.17<br>[root@centos6 ~]<span class="hljs-comment">#curl -b WEBSRV=web2 10.0.0.7</span><br>10.0.0.27<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -vb WEBSRV=web1 10.0.0.7</span><br>* About to connect() to 10.0.0.7 port 80 (<span class="hljs-comment">#0)</span><br>*  Trying 10.0.0.7... connected<br>* Connected to 10.0.0.7 (10.0.0.7) port 80 (<span class="hljs-comment">#0)</span><br>&gt; GET / HTTP/1.1<br>&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1<br>zlib/1.2.3 libidn/1.18 libssh2/1.4.2<br>&gt; Host: 10.0.0.7<br>&gt; Accept: */*<br>&gt; Cookie: WEBSRV=web1<br>&gt;<br>&lt; HTTP/1.1 200 OK<br>&lt; date: Thu, 02 Apr 2020 02:27:54 GMT<br>&lt; server: Apache/2.4.6 (CentOS)<br>&lt; last-modified: Thu, 02 Apr 2020 01:44:13 GMT<br>&lt; etag: <span class="hljs-string">&quot;a-5a244f01f8adc&quot;</span><br>&lt; accept-ranges: bytes<br>&lt; content-length: 10<br>&lt; content-type: text/html; charset=UTF-8<br>&lt;<br>10.0.0.17<br>* Connection <span class="hljs-comment">#0 to host 10.0.0.7 left intact</span><br>* Closing connection <span class="hljs-comment">#0</span><br>[root@centos6 ~]<span class="hljs-comment">#curl -vb WEBSRV=web2 10.0.0.7</span><br>* About to connect() to 10.0.0.7 port 80 (<span class="hljs-comment">#0)</span><br>*  Trying 10.0.0.7... connected<br>* Connected to 10.0.0.7 (10.0.0.7) port 80 (<span class="hljs-comment">#0)</span><br>&gt; GET / HTTP/1.1<br>&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1<br>zlib/1.2.3 libidn/1.18 libssh2/1.4.2<br>&gt; Host: 10.0.0.7<br>&gt; Accept: */*<br>&gt; Cookie: WEBSRV=web2<br>&gt;<br>&lt; HTTP/1.1 200 OK<br>&lt; date: Thu, 02 Apr 2020 02:27:57 GMT<br>&lt; server: Apache/2.4.6 (CentOS)<br>&lt; last-modified: Thu, 02 Apr 2020 01:44:28 GMT<br>&lt; etag: <span class="hljs-string">&quot;a-5a244f0fd5175&quot;</span><br>&lt; accept-ranges: bytes<br>&lt; content-length: 10<br>&lt; content-type: text/html; charset=UTF-8<br>&lt;<br>10.0.0.27<br>* Connection <span class="hljs-comment">#0 to host 10.0.0.7 left intact</span><br>* Closing connection <span class="hljs-comment">#0</span><br></code></pre></td></tr></table></figure>

<h3 id="5-2-HAProxy状态页"><a href="#5-2-HAProxy状态页" class="headerlink" title="5.2 HAProxy状态页"></a>5.2 HAProxy状态页</h3><p>通过web界面，显示当前HAProxy的运行状态<br>官方帮助：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-stats%20admin<br>http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4-stats%20admin<br></code></pre></td></tr></table></figure>

<h4 id="5-2-1-状态页配置项"><a href="#5-2-1-状态页配置项" class="headerlink" title="5.2.1 状态页配置项"></a>5.2.1 状态页配置项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">stats <span class="hljs-built_in">enable</span>          <span class="hljs-comment">#基于默认的参数启用stats page</span><br>stats hide-version    <span class="hljs-comment">#将状态页中haproxy版本隐藏</span><br>stats refresh &lt;delay&gt; <span class="hljs-comment">#设定自动刷新时间间隔，默认不自动刷新</span><br>stats uri &lt;prefix&gt;    <span class="hljs-comment">#自定义stats page uri，默认值：/haproxy?stats</span><br>stats realm &lt;realm&gt;   <span class="hljs-comment">#账户认证时的提示信息，示例：stats realm  HAProxy\Statistics</span><br>stats auth &lt;user&gt;:&lt;passwd&gt; <span class="hljs-comment">#认证时的账号和密码，可定义多个用户,每行指定一个用户.默认：no authentication</span><br>stats admin &#123; <span class="hljs-keyword">if</span> | unless &#125; &lt;cond&gt; <span class="hljs-comment">#启用stats page中的管理功能</span><br></code></pre></td></tr></table></figure>

<h4 id="5-2-2-启用状态页"><a href="#5-2-2-启用状态页" class="headerlink" title="5.2.2 启用状态页"></a>5.2.2 启用状态页</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen stats<br><span class="hljs-built_in">bind</span> :9999 <span class="hljs-comment">#绑定的ip一般使用内网IP，而不用外网或者0.0.0.0这种别人可以访问的IP</span><br>stats <span class="hljs-built_in">enable</span><br> <span class="hljs-comment">#stats hide-version</span><br>stats uri /haproxy-status      <span class="hljs-comment">#自定义stats page uri</span><br>stats realm HAProxy\ Status\ Page   <span class="hljs-comment">#账户认证时的提示信息，不是所有的浏览器会有提示信息</span><br>stats auth haadmin:123456  <span class="hljs-comment">#两个用户</span><br>stats auth admin:123456<br> <span class="hljs-comment">#stats refresh 30s</span><br>stats admin <span class="hljs-keyword">if</span> TRUE <span class="hljs-comment">#安全原因，不建议打开</span><br></code></pre></td></tr></table></figure>

<h4 id="5-2-3-登录状态页"><a href="#5-2-3-登录状态页" class="headerlink" title="5.2.3 登录状态页"></a>5.2.3 登录状态页</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">pid = 27134 (process <span class="hljs-comment">#1, nbproc = 1, nbthread = 1) #pid为当前pid号，process为当前进</span><br>程号，nbproc和nbthread为一共多少进程和每个进程多少个线程<br>uptime = 0d 0h00m04s <span class="hljs-comment">#启动了多长时间</span><br>system limits: memmax = unlimited; ulimit-n = 200029 <span class="hljs-comment">#系统资源限制：内存/最大打开文件</span><br>数/<br>maxsock = 200029; maxconn = 100000; maxpipes = 0 <span class="hljs-comment">#最大socket连接数/单进程最大连接数/</span><br>最大管道数maxpipes<br>current conns = 2; current pipes = 0/0; conn rate = 2/sec; bit rate = 0.000 kbps<br><span class="hljs-comment">#当前连接数/当前管道数/当前连接速率</span><br>Running tasks: 1/14; idle = 100 % <span class="hljs-comment">#运行的任务/当前空闲率</span><br>active UP： <span class="hljs-comment">#在线服务器</span><br>backup UP： <span class="hljs-comment">#标记为backup的服务器</span><br>active UP, going down： <span class="hljs-comment">#监测未通过正在进入down过程</span><br>backup UP, going down： <span class="hljs-comment">#备份服务器正在进入down过程</span><br>active DOWN, going up： <span class="hljs-comment">#down的服务器正在进入up过程</span><br>backup DOWN, going up： <span class="hljs-comment">#备份服务器正在进入up过程</span><br>active or backup DOWN： <span class="hljs-comment">#在线的服务器或者是backup的服务器已经转换成了down状态</span><br>not checked： <span class="hljs-comment">#标记为不监测的服务器</span><br>active or backup DOWN <span class="hljs-keyword">for</span> maintenance (MAINT) <span class="hljs-comment">#active或者backup服务器人为下线的</span><br>active or backup SOFT STOPPED <span class="hljs-keyword">for</span> maintenance <span class="hljs-comment">#active或者backup被人为软下线(人为将weight改成0)</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy37.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-2-4-backend-server信息"><a href="#5-2-4-backend-server信息" class="headerlink" title="5.2.4 backend server信息"></a>5.2.4 backend server信息</h4><table>
<thead>
<tr>
<th>session rate(每秒的连接会话信息)：</th>
<th>Errors(错误统计信息)：</th>
</tr>
</thead>
<tbody><tr>
<td>cur:每秒的当前会话数量</td>
<td>Req:错误请求量</td>
</tr>
<tr>
<td>max:每秒新的最大会话数量</td>
<td>conn:错误链接量</td>
</tr>
<tr>
<td>limit:每秒新的会话限制量</td>
<td>Resp:错误响应量</td>
</tr>
<tr>
<td>sessions(会话信息)：</td>
<td>Warnings(警告统计信息)：</td>
</tr>
<tr>
<td>cur:当前会话量</td>
<td>Retr:重新尝试次数</td>
</tr>
<tr>
<td>max:最大会话量</td>
<td>Redis:再次发送次数</td>
</tr>
<tr>
<td>limit: 限制会话量</td>
<td></td>
</tr>
<tr>
<td>Total:总共会话量</td>
<td>Server(real server信息)：</td>
</tr>
<tr>
<td>LBTot:选中一台服务器所用的总时间</td>
<td>Status:后端机的状态，包括UP和DOWN</td>
</tr>
<tr>
<td>Last：和服务器的持续连接时间</td>
<td>LastChk:持续检查后端服务器的时间</td>
</tr>
<tr>
<td>Wght:权重</td>
<td></td>
</tr>
<tr>
<td>Bytes(流量统计)：</td>
<td>Act:活动链接数量</td>
</tr>
<tr>
<td>In:网络的字节输入总量</td>
<td>Bck:备份的服务器数量</td>
</tr>
<tr>
<td>Out:网络的字节输出总量</td>
<td>Chk:心跳检测时间</td>
</tr>
<tr>
<td>Dwn:后端服务器连接后都是DOWN的数量</td>
<td></td>
</tr>
<tr>
<td>Denied(拒绝统计信息)：</td>
<td>Dwntme:总的downtime时间</td>
</tr>
<tr>
<td>Req:拒绝请求量</td>
<td>Thrtle:server 状态</td>
</tr>
<tr>
<td>Resp:拒绝回复量</td>
<td></td>
</tr>
</tbody></table>
<h4 id="5-2-5-利用状态页实现haproxy服务器的健康性检查"><a href="#5-2-5-利用状态页实现haproxy服务器的健康性检查" class="headerlink" title="5.2.5 利用状态页实现haproxy服务器的健康性检查"></a>5.2.5 利用状态页实现haproxy服务器的健康性检查</h4><p>范例：通过curl命令或killall命令对haproxy的状态页的访问实现健康检查</p>
<p><strong>使用keepalived实现haproxy的高可用，通过脚本检测haproxy服务器的健康性</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#curl -I http://haadmin:123456@10.0.0.7:9999/haproxy-status</span><br>HTTP/1.1 200 OK<br>cache-control: no-cache<br>content-type: text/html<br><br>[root@centos8 ~]<span class="hljs-comment">#curl -I -u haadmin:123456 http://10.0.0.7:9999/haproxy-status</span><br>HTTP/1.1 200 OK<br>cache-control: no-cache<br>content-type: text/html<br><br>[root@centos8 ~]<span class="hljs-comment">#echo $?</span><br>0<br><br>[root@haproxy ~]<span class="hljs-comment">#systemctl stop haproxy</span><br><br>[root@centos8 ~]<span class="hljs-comment">#curl -I http://haadmin:123456@10.0.0.7:9999/haproxy-status</span><br>curl: (7) Failed to connect to 10.0.0.7 port 9999: Connection refused<br><br>[root@centos8 ~]<span class="hljs-comment">#echo $?</span><br>7<br><br>[root@haproxy ~]<span class="hljs-comment"># systemctl stop haproxy</span><br>[root@haproxy ~]<span class="hljs-comment"># killall -0 haproxy</span><br>haproxy: no process found<br><br>[root@haproxy ~]<span class="hljs-comment"># systemctl start haproxy</span><br>[root@haproxy ~]<span class="hljs-comment"># killall -0 haproxy</span><br>[root@haproxy ~]<span class="hljs-comment"># echo $?</span><br>0<br></code></pre></td></tr></table></figure>

<h3 id="5-3-IP透传"><a href="#5-3-IP透传" class="headerlink" title="5.3 IP透传"></a>5.3 IP透传</h3><p>web服务器中需要记录客户端的真实IP地址，用于做访问统计、安全防护、行为分析、区域排行等场<br>景。</p>
<h4 id="5-3-1-layer-4-与-layer-7"><a href="#5-3-1-layer-4-与-layer-7" class="headerlink" title="5.3.1 layer 4 与 layer 7"></a>5.3.1 layer 4 与 layer 7</h4><p>四层：IP+PORT转发<br>七层：协议+内容交换</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy38.png" srcset="/blog/img/loading.gif" alt="layer4与layer7"></p>
<h5 id="5-3-1-1-四层负载"><a href="#5-3-1-1-四层负载" class="headerlink" title="5.3.1.1 四层负载"></a>5.3.1.1 四层负载</h5><p>在四层负载设备中，把client发送的报文目标地址(原来是负载均衡设备的IP地址)，根据均衡设备设置的选择web服务器的规则选择对应的web服务器IP地址，这样client就可以直接跟此服务器建立TCP连接并发送数据，而四层负载自身不参与建立连接，而和LVS不同，haproxy是伪四层负载均衡，因为haproxy需要分别和前端客户端及后端服务器建立连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@haproxy ~]<span class="hljs-comment">#tcpdump tcp -i eth0  -nn port ! 22 -w dump-tcp.pcap -v</span><br>[root@haproxy ~]<span class="hljs-comment">#tcpdump tcp -i eth1  -nn port ! 22 -w dump-tcp2.pcap -v</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy39.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy40.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-3-2-四层IP透传（不常用）"><a href="#5-3-2-四层IP透传（不常用）" class="headerlink" title="5.3.2 四层IP透传（不常用）"></a>5.3.2 四层IP透传（不常用）</h4><p>当haproxy工作在四层的时候，可以透传客户端真实IP至后端服务器。最后通过nginx日志记录客户端IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#haproxy 配置：</span><br>listen web_http_nodes<br> <span class="hljs-built_in">bind</span>  172.16.0.100:80<br> mode tcp       <span class="hljs-comment">#不支持http协议</span><br> balance roundrobin<br> server web1 www.wangxiaochun.com:80 send-proxy check inter 3000 fall 3<br>rise 5 <span class="hljs-comment">#添加send-proxy</span><br><span class="hljs-comment">#nginx 配置：在访问日志中通过变量$proxy_protocol_addr 记录透传过来的客户端IP</span><br>http &#123;<br>log_format main  <span class="hljs-string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot;</span><br><span class="hljs-string">&quot;$proxy_protocol_addr&quot;&#x27;</span><br> server &#123;<br>   listen    80 proxy_protocol; <span class="hljs-comment">#启用此项，将无法直接访问此网站，只能通过四层代理</span><br>访问<br>   server_name www.wangxiaochun.com;<br>......<br></code></pre></td></tr></table></figure>

<p>抓包可以看到 continuation 信息中带有客户端的源IP</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy41.png" srcset="/blog/img/loading.gif"></p>
<p>范例: nginx 开启四层日志功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#nginx在开启proxy_protocol前</span><br>[root@internet ~]<span class="hljs-comment">#curl 172.16.0.100</span><br>&lt;html&gt;<br>&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;<br>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>[root@VM_0_10_centos ~]<span class="hljs-comment"># tail -f /apps/nginx/logs/nginx.access.log</span><br>111.199.187.69 - - [09/Apr/2020:20:48:51 +0800] <span class="hljs-string">&quot;PROXY TCP4 10.0.0.7 58.87.87.99</span><br><span class="hljs-string">35948 80&quot;</span> sendfileon<br>111.199.187.69 - - [09/Apr/2020:20:48:54 +0800] <span class="hljs-string">&quot;PROXY TCP4 10.0.0.7 58.87.87.99</span><br><span class="hljs-string">35952 80&quot;</span> sendfileon<br>111.199.187.69 - - [09/Apr/2020:20:48:57 +0800] <span class="hljs-string">&quot;PROXY TCP4 10.0.0.7 58.87.87.99</span><br><span class="hljs-string">35954 80&quot;</span> sendfileon<br><br><span class="hljs-comment">#在nginx服务器上开启日志格式和proxy_protocal</span><br>[root@VM_0_10_centos ~]<span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br>http &#123;<br>.......<br>log_format main  <span class="hljs-string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot;</span><br><span class="hljs-string">&quot;$proxy_protocol_addr&quot;&#x27;</span><br> sendfile    on;<br> keepalive_timeout  65;<br> client_max_body_size 100m;<br> server &#123;<br>   listen    80 default_server proxy_protocol ;<br>......<br><br><span class="hljs-comment">#nginx在开启proxy_protocol后，可以看客户端真实源IP</span><br>[root@VM_0_10_centos ~]<span class="hljs-comment"># tail -f /apps/nginx/logs/nginx.access.log</span><br>111.199.187.69 - - [09/Apr/2020:20:52:52 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span><br><span class="hljs-string">&quot;172.16.0.200&quot;</span>sendfileon<br></code></pre></td></tr></table></figure>

<h4 id="5-3-3-七层IP透传"><a href="#5-3-3-七层IP透传" class="headerlink" title="5.3.3 七层IP透传"></a>5.3.3 七层IP透传</h4><p>当haproxy工作在七层的时候，也可以透传客户端真实IP至后端服务器</p>
<h5 id="5-3-3-1-HAProxy配置"><a href="#5-3-3-1-HAProxy配置" class="headerlink" title="5.3.3.1 HAProxy配置"></a>5.3.3.1 HAProxy配置</h5><p>在由haproxy发往后端主机的请求报文中添加“X-Forwarded-For”首部，其值为前端客户端的地址；用<br>于向后端主发送真实的客户端IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">option forwardfor [ except &lt;network&gt; ] [ header &lt;name&gt; ] [ if-none ]<br>[ except &lt;network&gt; ]：请求报请来自此处指定的网络时不予添加此首部，如haproxy自身所在网络<br>[ header &lt;name&gt; ]：使用自定义的首部名称，而非“X-Forwarded-For<span class="hljs-string">&quot;，示例：X-client</span><br><span class="hljs-string">[ if-none ] 如果没有首部才添加首部，如果有使用默认值</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#haproxy 配置</span><br>defaults <span class="hljs-comment">#（添加以下任意一行）</span><br>    option forwardfor  <span class="hljs-comment">#此为默认值,首部字段默认为：X-Forwarded-For</span><br>    option forwardfor except 127.0.0.0/8 header X-client <span class="hljs-comment">#或者自定义首部,如:X-client</span><br><br><span class="hljs-comment">#listen配置</span><br>listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    <span class="hljs-built_in">log</span> global<br>    balance random<br>    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br>    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<h5 id="5-3-3-2-web服务器日志格式配置"><a href="#5-3-3-2-web服务器日志格式配置" class="headerlink" title="5.3.3.2 web服务器日志格式配置"></a>5.3.3.2 web服务器日志格式配置</h5><p>配置web服务器，记录负载均衡透传的客户端IP地址</p>
<p><strong>注意：如自定义首部，那么日志格式添加的内容就要填自定义的首部</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#apache 配置：</span><br>LogFormat <span class="hljs-string">&quot;%&#123;X-Forwarded-For&#125;i %a %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined<br><br><span class="hljs-comment">#nginx 日志格式：</span><br><span class="hljs-comment">#即添加下面两种格式的其一，按需求选择</span><br><span class="hljs-variable">$proxy_add_x_forwarded_for</span>：包括客户端IP和中间经过的所有代理的IP<br><span class="hljs-variable">$http_x_forwarded_For</span>：只有客户端IP<br>log_format main  <span class="hljs-string">&#x27;&quot;$proxy_add_x_forwarded_for&quot; - $remote_user [$time_local]</span><br><span class="hljs-string">&quot;$request&quot; &#x27;</span><br>           <span class="hljs-string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>           <span class="hljs-string">&#x27;&quot;$http_user_agent&quot; $http_x_forwarded_For&#x27;</span>;<br>          <br>[root@centos8 ~]<span class="hljs-comment">#tail /var/log/nginx/access.log</span><br><span class="hljs-string">&quot;172.16.0.200, 10.0.0.7&quot;</span> 10.0.0.7 - - [09/Apr/2020:19:10:16 +0800] <span class="hljs-string">&quot;GET /</span><br><span class="hljs-string">HTTP/1.1&quot;</span> 200 4057 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7</span><br><span class="hljs-string">NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span><br><br><span class="hljs-comment">#tomcat 配置：conf目录下的server.xml</span><br>&lt;Valve className=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="hljs-string">&quot;logs&quot;</span><br> prefix=<span class="hljs-string">&quot;localhost_access_log&quot;</span> suffix=<span class="hljs-string">&quot;.txt&quot;</span><br> pattern=<span class="hljs-string">&quot;%&#123;X-Forwarded-For&#125;i %h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;  <br></code></pre></td></tr></table></figure>

<h5 id="5-3-3-3-验证客户端IP地址"><a href="#5-3-3-3-验证客户端IP地址" class="headerlink" title="5.3.3.3 验证客户端IP地址"></a>5.3.3.3 验证客户端IP地址</h5><p>apache日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/httpd/conf/httpd.conf</span><br>LogFormat <span class="hljs-string">&quot;%&#123;X-Forwarded-For&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined<br><br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart httpd</span><br><br>[root@centos6 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.6<br><br>[root@centos6 ~]<span class="hljs-comment">#curl  http://10.0.0.7</span><br>10.0.0.17<br><br>[root@centos7 ~]<span class="hljs-comment">#tail -f /var/log/httpd/access_log</span><br>10.0.0.6 10.0.0.7 - - [01/Apr/2020:01:08:31 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span><br><span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span><br><span class="hljs-string">libidn/1.18 libssh2/1.4.2&quot;</span><br>10.0.0.6 10.0.0.7 - - [01/Apr/2020:01:08:33 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span><br><span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span><br><span class="hljs-string">libidn/1.18 libssh2/1.4.2&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-4-报文修改"><a href="#5-4-报文修改" class="headerlink" title="5.4 报文修改"></a>5.4 报文修改</h3><p>在http模式下，基于实际需求修改客户端的请求报文与响应报文，通过reqadd和reqdel在请求报文添加删除字段，通过rspadd与rspidel在响应报文中添加与删除字段。</p>
<p>注意：此功能的以下相关指令在2.1版本中已经取消</p>
<p>官方文档：参看2.0的帮助文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4-rspadd<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在向后端服务器转发的请求报文尾部添加指定首部</span><br>reqadd &lt;string&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]<br>示例：reqadd X-Via:\ HAproxy  <span class="hljs-comment">#注意只能有一个空格，并需要转义</span><br><br><span class="hljs-comment">#在向后端服务器转发的请求报文中删除匹配正则表达式的首部</span><br>reqdel &lt;search&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]<br>reqidel &lt;search&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]  <span class="hljs-comment">#忽略大小写</span><br>示例：<br>reqidel user-agent<br>reqidel X-Forwarded-For <span class="hljs-comment">#无法删除</span><br><br><span class="hljs-comment">#在向前端客户端转发的响应报文尾部添加指定首部</span><br>rspadd &lt;string&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]<br>示例：<br>rspadd X-Via:\ HAproxy<br>rspadd Server:\ wanginx<br><br><span class="hljs-comment">#从向前端客户端转发的响应报文中删除匹配正则表达式的首部</span><br>rspdel &lt;search&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]<br>rspidel &lt;search&gt; [&#123;<span class="hljs-keyword">if</span> | unless&#125; &lt;cond&gt;]  <span class="hljs-comment">#忽略大小写</span><br>示例：<br>rspidel ^server:.* <span class="hljs-comment">#从响应报文删除server信息</span><br>rspidel X-Powered-By:.* <span class="hljs-comment">#从响应报文删除X-Powered-By信息,一般此首部字段保存php版本信息 #</span><br></code></pre></td></tr></table></figure>

<p>2.1版本以上用下面指令http-request和http-response代替<br>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-http-request<br>http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-http-response<br></code></pre></td></tr></table></figure>

<p>配置说明：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#添加请求报文</span><br>http-request add-header &lt;name&gt; &lt;fmt&gt; [ &#123; <span class="hljs-keyword">if</span> | unless &#125; &lt;condition&gt; ]<br><span class="hljs-comment">#示例：http-request add-header X-Haproxy-Current-Date %T</span><br><span class="hljs-comment">#删除请求报文</span><br>http-request del-header &lt;name&gt; [ &#123; <span class="hljs-keyword">if</span> | unless &#125; &lt;condition&gt; ]<br><br><span class="hljs-comment">#添加响应报文</span><br>http-response add-header &lt;name&gt; &lt;fmt&gt; [ &#123; <span class="hljs-keyword">if</span> | unless &#125; &lt;condition&gt; ]<br><span class="hljs-comment">#删除响应报文</span><br>http-response del-header &lt;name&gt;<br><span class="hljs-comment">#示例：http-response del-header Server</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#添加向后端报务器发起的请求报文首部</span><br>vim haproxy.cfg<br>frontend main *:80<br><span class="hljs-comment">#    bind *:80</span><br>   default_backend websrvs<br>   reqadd testheader:\ haproxyserver  <span class="hljs-comment">#加此行,注意只能有一个空格，并需要转义</span><br><br><span class="hljs-comment">#在后端httpd服务器</span><br>vim /etc/httpd/conf/httpd.conf<br>LogFormat <span class="hljs-string">&quot;%&#123;testheader&#125;i %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined<br><br><span class="hljs-comment">#查看日志</span><br>tail –f /var/<span class="hljs-built_in">log</span>/httpd/acesss_log<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#删除向后端服务器发起的请求报文首部</span><br>vim haproxy.cfg<br>frontend main *:80<br><span class="hljs-comment">#    bind *:80</span><br>   default_backend websrvs<br>   reqdel User-Agent <span class="hljs-comment">#或reqidel user-agent #忽略大小写</span><br>   <br><span class="hljs-comment">#查看后端服务器日志</span><br>[root@web1 ~]<span class="hljs-comment"># tail -f /var/log/httpd/access_log</span><br><span class="hljs-comment">#删除User-Agent前</span><br>10.0.0.7 - - [06/Jun/2021:16:30:04 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br>10.0.0.7 - - [06/Jun/2021:16:30:05 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br>10.0.0.7 - - [06/Jun/2021:16:30:06 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br><span class="hljs-comment">#删除User-Agent后</span><br>10.0.0.7 - - [06/Jun/2021:16:30:07 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br>10.0.0.7 - - [06/Jun/2021:16:30:08 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br>10.0.0.7 - - [06/Jun/2021:16:30:09 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;172.16.0.200&quot;</span> <span class="hljs-string">&quot;haproxyserver&quot;</span><br><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#添加响应报文首部</span><br>vim haproxy.cfg<br>frontend main *:80<br><span class="hljs-comment">#    bind *:80</span><br>   default_backend websrvs<br>   rspadd X-Via:\ HAproxy-1  <span class="hljs-comment">#加此行</span><br>   maxconn     5000<br><br><span class="hljs-comment">#客户端访问调试模式,查看reponse headers，看到</span><br>Server: Apache/2.4.37 (centos)  <span class="hljs-comment">#系统自带显示</span><br>X-Via: HAproxy-1<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#删除响应报文中的server首部</span><br>vim haproxy.cfg<br>frontend main *:80<br><span class="hljs-comment">#    bind *:80</span><br>   default_backend websrvs<br>   rspadd X-Via:\ HAproxy-1<br>   rspidel Server <span class="hljs-comment">#或者 rspidel server   #加此行 ,忽略大小写</span><br>   rsqidel X-Powered-By:.* <span class="hljs-comment">#删除Php版本</span><br>   maxconn     5000<br><br><span class="hljs-comment">#客户端访问调试模式,查看reponse headers，看到</span><br>Server: Apache/2.4.37 (centos)  <span class="hljs-comment">#此行消失</span><br>X-Via: HAproxy-1<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#增加响应报文的首部，实现伪装Server首部</span><br>vim haproxy.cfg<br>frontend main *:80<br><span class="hljs-comment">#    bind *:80</span><br>   default_backend websrvs<br>   rspadd X-Via:\ HAproxy-1<br>   rspdel Server  <span class="hljs-comment">#或者用 rspidel server</span><br>   rspadd Server:\  wanginx  <span class="hljs-comment">#增加此行</span><br><br>[root@internet ~]<span class="hljs-comment">#curl -i  172.16.0.100</span><br>HTTP/1.1 200 OK<br>date: Thu, 09 Apr 2020 08:32:10 GMT<br>last-modified: Thu, 09 Apr 2020 01:23:18 GMT<br>etag: <span class="hljs-string">&quot;f-5a2d17630635b&quot;</span><br>accept-ranges: bytes<br>content-length: 15<br>content-type: text/html; charset=UTF-8<br>server: wanginx<br><br>RS1 10.0.0.17<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#新版本的写法</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br>listen web_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>http-request add-header X-Haproxy-Current-Date %T <span class="hljs-comment">#添加请求报文首部</span><br>http-response del-header server <span class="hljs-comment">#删除响应报文首部</span><br>mode http<br><span class="hljs-built_in">log</span> global<br>option httpchk<br>http-check expect status 200<br>server web1  10.0.0.17:80 check inter 3000 fall 2 rise 5<br>server web2  10.0.0.27:80 check inter 3000 fall 2 rise 5<br><br><span class="hljs-comment">#查看后端服务器日志</span><br>tail –f /var/<span class="hljs-built_in">log</span>/httpd/acesss_log<br>10.0.0.7 - - [05/Apr/2020:20:13:48 +0800] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="hljs-string">&quot;-&quot;</span><br><span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) l</span><br><span class="hljs-string">ibcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span><br><span class="hljs-string">&quot;05/Apr/2020:12:13:48 +0000&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-自定义日志格式"><a href="#5-5-自定义日志格式" class="headerlink" title="5.5 自定义日志格式"></a>5.5 自定义日志格式</h3><p>log global 开启日志功能，默认只会在记录下面格式的日志</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">[root@haproxy ~]#tail /var/log/haproxy.log<br>Apr 9 19:38:46 localhost haproxy[60049]: Connect from 172.16.0.200:54628 to<br>172.16.0.100:80 (web_prot_http_nodes/HTTP)<br></code></pre></td></tr></table></figure>

<p>option httplog 可以用 http 格式记录下来，并且可以使用相关指令将特定信息记录在haproxy的日志中<strong>但一般不建议开启</strong>，这会加重 HAProxy 负载</p>
<h4 id="5-5-1-配置选项"><a href="#5-5-1-配置选项" class="headerlink" title="5.5.1 配置选项"></a>5.5.1 配置选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">log</span> global <span class="hljs-comment">#开启记录日志,默认不开启</span><br>option httplog                <span class="hljs-comment">#开启记录httplog日志格式选项</span><br>capture cookie &lt;name&gt; len &lt;length&gt; <span class="hljs-comment">#捕获请求和响应报文中的 cookie及值的长度,将之记录到日志</span><br>capture request header &lt;name&gt; len &lt;length&gt; <span class="hljs-comment">#捕获请求报文中指定的首部内容和长度并记录日志</span><br>capture response header &lt;name&gt; len &lt;length&gt; <span class="hljs-comment">#捕获响应报文中指定的内容和长度首部并记录日志</span><br><br><span class="hljs-comment">#示例：</span><br><span class="hljs-built_in">log</span> global<br>option httplog<br>capture request header Host len  256<br>capture request header User-Agent len 512<br>capture request header Referer len 15<br>capture request header X-Forwarded-For len 15<br></code></pre></td></tr></table></figure>

<p>同时开启日志功能log global和option httplog，记录日志格式如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@haproxy ~]<span class="hljs-comment">#tail /var/log/haproxy.log</span><br>Apr  9 19:42:02 localhost haproxy[60236]: 172.16.0.200:54630<br>[09/Apr/2020:19:42:02.623] web_prot_http_nodes web_prot_http_nodes/web1<br>0/0/1/1/2 200 4264 - - ---- 1/1/0/0/0 0/0 <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="5-5-2-配置示例"><a href="#5-5-2-配置示例" class="headerlink" title="5.5.2 配置示例"></a>5.5.2 配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global <span class="hljs-comment">#开启日志功能</span><br>option httplog <span class="hljs-comment">#开启httplog日志格式选项</span><br>capture request header User-Agent len 512 <span class="hljs-comment">#记录日志信息,记录User-Agent首</span><br>部值的前512个字符<br>capture request header Host len  256 <span class="hljs-comment">#记录日志信息,记录Host首部值</span><br>cookie SERVER-COOKIE insert indirect nocache<br>server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5<br>server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h4 id="5-5-3-验证日志格式"><a href="#5-5-3-验证日志格式" class="headerlink" title="5.5.3 验证日志格式"></a>5.5.3 验证日志格式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#tail -n3 /var/log/haproxy.log</span><br>Apr  2 12:44:26 localhost haproxy[27637]: 10.0.0.6:50004<br>[02/Apr/2020:12:44:26.817] web_port web_port/web1 0/0/0/2/3 200 42484 - - --NI<br>1/1/0/0/0 0/0 &#123;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1<br>zlib/1.2.3 libidn/1.18 libssh2/1.4.2|10.0.0.7&#125; <span class="hljs-string">&quot;GET /test.php HTTP/1.1&quot;</span><br>Apr  2 12:44:27 localhost haproxy[27637]: 10.0.0.6:50006<br>[02/Apr/2020:12:44:27.294] web_port web_port/web2 0/0/0/1/1 404 370 - - --NI<br>1/1/0/0/0 0/0 &#123;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1<br>zlib/1.2.3 libidn/1.18 libssh2/1.4.2|10.0.0.7&#125; <span class="hljs-string">&quot;GET /test.php HTTP/1.1&quot;</span><br>Apr  2 12:44:27 localhost haproxy[27637]: 10.0.0.6:50008<br>[02/Apr/2020:12:44:27.840] web_port web_port/web1 0/0/0/3/4 200 42484 - - --NI<br>1/1/0/0/0 0/0 &#123;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1<br>zlib/1.2.3 libidn/1.18 libssh2/1.4.2|10.0.0.7&#125; <span class="hljs-string">&quot;GET /test.php HTTP/1.1&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-6-压缩功能"><a href="#5-6-压缩功能" class="headerlink" title="5.6 压缩功能"></a>5.6 压缩功能</h3><p>对响应给客户端的报文进行压缩，以节省网络带宽，但是会占用部分CPU性能</p>
<p><strong>建议在后端服务器开启压缩功能，而非在HAProxy上开启压缩</strong></p>
<h4 id="5-6-1-配置选项"><a href="#5-6-1-配置选项" class="headerlink" title="5.6.1 配置选项"></a>5.6.1 配置选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">compression algo &lt;algorithm&gt; ... <span class="hljs-comment">#启用http协议中的压缩机制，常用算法有 gzip，deflate</span><br><br><span class="hljs-comment">#压缩算法&lt;algorithm&gt;支持下面类型：</span><br>    identity                     <span class="hljs-comment">#debug调试使用的压缩方式</span><br>    gzip                         <span class="hljs-comment">#常用的压缩方式，与各浏览器兼容较好</span><br>    deflate                      <span class="hljs-comment">#有些浏览器不支持</span><br>    raw-deflate                  <span class="hljs-comment">#新式的压缩方式</span><br>    compression <span class="hljs-built_in">type</span> &lt;mime <span class="hljs-built_in">type</span>&gt; ... <span class="hljs-comment">#要压缩的文件类型</span><br><br><span class="hljs-comment">#示例：</span><br>compression algo gzip deflate<br>compression <span class="hljs-built_in">type</span> text/html text/css text/plain<br></code></pre></td></tr></table></figure>

<h4 id="5-6-2-配置示例"><a href="#5-6-2-配置示例" class="headerlink" title="5.6.2 配置示例"></a>5.6.2 配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    balance roundrobin<br>    <span class="hljs-built_in">log</span> global<br>    option httplog<br>    compression algo gzip deflate  <span class="hljs-comment">#启用压缩和指定算法</span><br>    compression <span class="hljs-built_in">type</span> compression <span class="hljs-built_in">type</span> text/plain text/html text/css text/xml<br>    text/javascript application/javascript       <span class="hljs-comment">#指定压缩文件类型</span><br>    server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5<br>    server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5<br><br><span class="hljs-comment">#后端服务器准备一个文本文件</span><br>[root@centos7 ~]<span class="hljs-comment">#ll /var/www/html/m.txt -h</span><br>-rwxr-xr-x 1 root root 772K Apr  2 12:56 /var/www/html/m.txt<br></code></pre></td></tr></table></figure>

<h4 id="5-6-3-验证压缩功能"><a href="#5-6-3-验证压缩功能" class="headerlink" title="5.6.3 验证压缩功能"></a>5.6.3 验证压缩功能</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -is --compressed  10.0.0.7/m.txt|less</span><br>HTTP/1.1 200 OK<br>date: Thu, 02 Apr 2020 05:00:26 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>last-modified: Thu, 02 Apr 2020 04:56:25 GMT<br>etag: W/<span class="hljs-string">&quot;c0ef6-5a2479f7aee68&quot;</span><br>accept-ranges: bytes<br>content-type: text/plain; charset=UTF-8<br>set-cookie: WEBSRV=web1; path=/<br>cache-control: private<br>content-encoding: deflate<br>transfer-encoding: chunked<br>vary: Accept-Encoding<br>Feb  2 18:49:27 centos7 journal: Runtime journal is using 6.0M (max allowed<br>48.6M, trying to leave 72.9M free of 480.1M available → current <span class="hljs-built_in">limit</span> 48.6M).<br>Feb  2 18:49:27 centos7 kernel: Initializing cgroup subsys cpuset<br>Feb  2 18:49:27 centos7 kernel: Initializing cgroup subsys cpu<br>Feb  2 18:49:27 centos7 kernel: Initializing cgroup subsys cpuacct<br>......<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy42.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy43.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-7-web服务器状态监测"><a href="#5-7-web服务器状态监测" class="headerlink" title="5.7 web服务器状态监测"></a>5.7 web服务器状态监测</h3><h4 id="5-7-1-三种状态监测方式"><a href="#5-7-1-三种状态监测方式" class="headerlink" title="5.7.1 三种状态监测方式"></a>5.7.1 三种状态监测方式</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">基于四层的传输端口做状态监测，此为默认方式<br>基于GET方法指定 URI 做状态监测,需要访问整个页面资源,占用更多带宽<br>基于HEAD方法指定 URI 的request请求头部内容做状态监测，占用较少带宽,建议使用此方式<br></code></pre></td></tr></table></figure>

<h4 id="5-7-2-基于应用层http协议进行健康性检测"><a href="#5-7-2-基于应用层http协议进行健康性检测" class="headerlink" title="5.7.2 基于应用层http协议进行健康性检测"></a>5.7.2 基于应用层http协议进行健康性检测</h4><p>基于应用层http协议，采有不同的监测方式，对后端real server进行状态监测<br>注意: 此方式会导致在后端服务器生成很多的HAProxy发起的访问日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">option httpchk  <span class="hljs-comment">#启用七层健康性检测，对tcp 和 http 模式都支持，默认为：OPTIONS / HTTP/1.0</span><br><span class="hljs-comment">#下面为检测自定义网页</span><br>option httpchk &lt;uri&gt; <span class="hljs-comment">#此项是看改uri是否支持OPTIONS这个&lt;method&gt;方法，不是真实的访问该uri页面</span><br>option httpchk &lt;method&gt; &lt;uri&gt;<br>option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;<br><br><span class="hljs-comment">#期望以上检查得到的响应码</span><br>http-check expect [!] &lt;match&gt; &lt;pattern&gt;<br><span class="hljs-comment">#示例：</span><br>http-check expect status 200<br>http-check expect ! rstatus ^5 <span class="hljs-comment">#支持正则表达式</span><br><br><span class="hljs-comment">#关于HTTP/1.1的说明</span><br>&lt;version&gt; is the optional HTTP version string. It defaults to <span class="hljs-string">&quot;HTTP/1.0&quot;</span> but some servers might behave incorrectly <span class="hljs-keyword">in</span> HTTP 1.0, so turning it to HTTP/1.1 may sometimes <span class="hljs-built_in">help</span>. Note that the Host field is mandatory <span class="hljs-keyword">in</span> HTTP/1.1, and as a trick, it is possible to pass it after <span class="hljs-string">&quot;\r\n&quot;</span> following the version string.<br></code></pre></td></tr></table></figure>

<h4 id="5-7-3-配置示例"><a href="#5-7-3-配置示例" class="headerlink" title="5.7.3 配置示例"></a>5.7.3 配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br> <span class="hljs-comment">#option httpchk GET /monitor/check.html #默认HTTP/1.0</span><br> <span class="hljs-comment">#option httpchk GET /monitor/check.html HTTP/1.0</span><br> <span class="hljs-comment">#option httpchk GET /monitor/check.html HTTP/1.1 #注意：HTTP/1.1强制要求必须有Host字段</span><br>option httpchk HEAD /monitor/check.html HTTP/1.1\r\nHost:\ 10.0.0.7 <span class="hljs-comment">#使用HEAD减少网络流量</span><br>cookie SERVER-COOKIE insert indirect nocache<br>server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5<br>server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5<br><br><span class="hljs-comment">#在所有后端服务建立检测页面</span><br>[root@backend ~]<span class="hljs-comment">#mkdir /var/www/html/monitor/</span><br>[root@backend ~]<span class="hljs-comment">#echo monitor &gt; /var/www/html/monitor/check.html</span><br><br><span class="hljs-comment">#关闭一台Backend服务器</span><br>[root@backend1 ~]<span class="hljs-comment">#systemctl stop httpd</span><br></code></pre></td></tr></table></figure>

<h4 id="5-7-4-验证http监测"><a href="#5-7-4-验证http监测" class="headerlink" title="5.7.4 验证http监测"></a>5.7.4 验证http监测</h4><p>查看到状态页，可以看到启了七层检测功能：<strong>LastChk字段：L7</strong></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy44.png" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#后端服务器查看访问日志</span><br>[root@backend ~]<span class="hljs-comment">#tail /var/log/httpd/access_log</span><br>10.0.0.7 - - [02/Apr/2020:14:25:22 +0800] <span class="hljs-string">&quot;HEAD /monitor/check.html HTTP/1.1&quot;</span><br>200 - <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span><br>10.0.0.7 - - [02/Apr/2020:14:25:25 +0800] <span class="hljs-string">&quot;HEAD /monitor/check.html HTTP/1.1&quot;</span><br>200 - <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span><br>10.0.0.7 - - [02/Apr/2020:14:25:28 +0800] <span class="hljs-string">&quot;HEAD /monitor/check.html HTTP/1.1&quot;</span><br>200 - <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;-&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-8-ACL"><a href="#5-8-ACL" class="headerlink" title="5.8 ACL"></a>5.8 ACL</h3><p>访问控制列表（ACL，Access Control Lists）是一种基于包过滤的访问控制技术，它可以根据设定的条件对经过服务器传输的数据包进行过滤(条件匹配)，即对接收到的报文进行匹配和过滤，基于请求报文头部中的源地址、源端口、目标地址、目标端口、请求方法、URL、文件后缀等信息内容进行匹配并执行进一步操作，比如允许其通过或丢弃。<br>官方帮助</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7<br>http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#7<br></code></pre></td></tr></table></figure>

<h4 id="5-8-1-ACL配置选项"><a href="#5-8-1-ACL配置选项" class="headerlink" title="5.8.1 ACL配置选项"></a>5.8.1 ACL配置选项</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">acl  &lt;aclname&gt; &lt;criterion&gt;  [flags]   [operator]  [&lt;value&gt;]<br>acl   名称        匹配规范     匹配模式    具体操作符   操作对象类型<br></code></pre></td></tr></table></figure>

<h5 id="5-8-1-1-ACL-Name"><a href="#5-8-1-1-ACL-Name" class="headerlink" title="5.8.1.1 ACL-Name"></a>5.8.1.1 ACL-Name</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">acl  image_service hdr_dom(host)  -i  img.magedu.com<br><br><span class="hljs-comment">#ACL名称，可以使用大字母A-Z、小写字母a-z、数字0-9、冒号：、点.、中横线和下划线，并且严格区分大小写，比如:my_acl和My_Acl就是两个完全不同的acl</span><br></code></pre></td></tr></table></figure>

<h5 id="5-8-1-2-ACL-criterion"><a href="#5-8-1-2-ACL-criterion" class="headerlink" title="5.8.1.2 ACL-criterion"></a>5.8.1.2 ACL-criterion</h5><p><strong>定义ACL匹配规范，即：判断条件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs bash">hdr string，提取在一个HTTP请求报文的首部<br>hdr（[&lt;name&gt; [，&lt;occ&gt;]]）：完全匹配字符串,header的指定信息，&lt;occ&gt; 表示在多值中使用的值的出<br>现次数<br>hdr_beg（[&lt;name&gt; [，&lt;occ&gt;]]）：前缀匹配，header中指定匹配内容的begin<br>hdr_end（[&lt;name&gt; [，&lt;occ&gt;]]）：后缀匹配，header中指定匹配内容end<br>hdr_dom（[&lt;name&gt; [，&lt;occ&gt;]]）：域匹配，header中的domain name<br>hdr_dir（[&lt;name&gt; [，&lt;occ&gt;]]）：路径匹配，header的uri路径<br>hdr_len（[&lt;name&gt; [，&lt;occ&gt;]]）：长度匹配，header的长度匹配<br>hdr_reg（[&lt;name&gt; [，&lt;occ&gt;]]）：正则表达式匹配，自定义表达式(regex)模糊匹配<br>hdr_sub（[&lt;name&gt; [，&lt;occ&gt;]]）：子串匹配，header中的uri模糊匹配<br><br><span class="hljs-comment">#示例：</span><br>hdr(&lt;string&gt;) 用于测试请求头部首部指定内容<br>hdr_dom(host) 请求的host名称，如 www.magedu.com<br>hdr_beg(host) 请求的host开头，如 www.  img.  video.  download.  ftp.<br>hdr_end(host) 请求的host结尾，如 .com  .net  .cn<br><br><span class="hljs-comment">#示例：</span><br>acl bad_agent hdr_sub(User-Agent) -i curl wget<br>block <span class="hljs-keyword">if</span> bad_agent<br><br><span class="hljs-comment">#有些功能是类似的，比如以下几个都是匹配用户请求报文中host的开头是不是www</span><br>acl short_form hdr_beg(host)    www.<br>acl alternate1 hdr_beg(host) -m beg www.<br>acl alternate2 hdr_dom(host) -m beg www.<br>acl alternate3 hdr(host)   -m beg www.<br><br>base : string<br><span class="hljs-comment">#返回第一个主机头和请求的路径部分的连接，该请求从主机名开始，并在问号之前结束,对虚拟主机有用</span><br>&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@<span class="hljs-comment">#&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;#?&lt;query&gt;#&lt;frag&gt;</span><br>base   : exact string match<br>base_beg : prefix match<br>base_dir : subdir match<br>base_dom : domain match<br>base_end : suffix match<br>base_len : length match<br>base_reg : regex match<br>base_sub : substring match<br><br>path : string<br><span class="hljs-comment">#提取请求的URL路径，该路径从第一个斜杠开始，并在问号之前结束（无主机部分）</span><br>&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;<span class="hljs-comment">#/&lt;path&gt;;&lt;params&gt;#?&lt;query&gt;#&lt;frag&gt;</span><br>path   : exact string match<br>path_beg : prefix match  <span class="hljs-comment">#请求的URL开头，如/static、/images、/img、/css</span><br>path_end : suffix match  <span class="hljs-comment">#请求的URL中资源的结尾，如 .gif .png .css .js .jpg .jpeg</span><br>path_dom : domain match<br>path_dir : subdir match<br>path_len : length match<br>path_reg : regex match<br>path_sub : substring match<br><br><span class="hljs-comment">#示例：</span><br>path_beg -i /haproxy-status/<br>path_end .jpg .jpeg .png .gif<br>path_reg ^/images.*\.jpeg$<br>path_sub image <br><br>url : string<br><span class="hljs-comment">#提取请求中的整个URL。一个典型的应用是具有预取能力的缓存，以及需要从数据库聚合多个信息并将它们保</span><br>存在缓存中的网页门户入口，推荐使用path<br>url ：exact string match<br>url_beg : prefix match<br>url_dir : subdir match<br>url_dom : domain match<br>url_end : suffix match<br>url_len : length match<br>url_reg : regex match<br>url_sub : substring match<br><br>dst <span class="hljs-comment">#目标IP</span><br>dst_port <span class="hljs-comment">#目标PORT</span><br><br>src  <span class="hljs-comment">#源IP</span><br>src_port <span class="hljs-comment">#源PORT</span><br><br><span class="hljs-comment">#示例：</span><br>acl invalid_src src 10.0.0.7 192.168.1.0/24<br>acl invalid_src src 172.16.0.0/24<br><br>acl invalid_port src_port 0:1023<br><br>status : <span class="hljs-built_in">integer</span>  <span class="hljs-comment">#返回在响应报文中的状态码</span><br><br><span class="hljs-comment">#七层协议</span><br>acl valid_method method GET HEAD<br>http-request deny <span class="hljs-keyword">if</span> ! valid_method<br></code></pre></td></tr></table></figure>

<h5 id="5-8-1-3-ACL-flags"><a href="#5-8-1-3-ACL-flags" class="headerlink" title="5.8.1.3 ACL-flags"></a>5.8.1.3 ACL-flags</h5><p>ACL匹配模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">-i 不区分大小写<br>-m 使用指定的pattern匹配方法<br>-n 不做DNS解析<br>-u 禁止acl重名，否则多个同名ACL匹配或关系<br></code></pre></td></tr></table></figure>

<h5 id="5-8-1-4-ACL-operator"><a href="#5-8-1-4-ACL-operator" class="headerlink" title="5.8.1.4 ACL-operator"></a>5.8.1.4 ACL-operator</h5><p>ACL 操作符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">整数比较：eq、ge、gt、le、lt<br>字符比较：<br>- exact match   (-m str) :字符串必须完全匹配模式<br>- substring match (-m sub) :在提取的字符串中查找模式，如果其中任何一个被发现，ACL将匹配<br>- prefix match  (-m beg) :在提取的字符串首部中查找模式，如果其中任何一个被发现，ACL将匹<br>配<br>- suffix match  (-m end) :将模式与提取字符串的尾部进行比较，如果其中任何一个匹配，则ACL<br>进行匹配<br>- subdir match  (-m dir) :查看提取出来的用斜线分隔（“/<span class="hljs-string">&quot;）的字符串，如其中任一个匹配，则</span><br><span class="hljs-string">ACL进行匹配</span><br><span class="hljs-string">- domain match  (-m dom) :查找提取的用点（“.&quot;</span>）分隔字符串，如果其中任何一个匹配，则ACL<br>进行匹配<br></code></pre></td></tr></table></figure>

<h5 id="5-8-1-5-ACL-value"><a href="#5-8-1-5-ACL-value" class="headerlink" title="5.8.1.5 ACL-value"></a>5.8.1.5 ACL-value</h5><p>value的类型</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">The ACL engine can match these types against patterns of the following types :<br>- Boolean <span class="hljs-comment">#布尔值</span><br>- <span class="hljs-built_in">integer</span> or <span class="hljs-built_in">integer</span> range <span class="hljs-comment">#整数或整数范围，比如用于匹配端口范围</span><br>- IP address / network <span class="hljs-comment">#IP地址或IP范围, 192.168.0.1 ,192.168.0.1/24</span><br>- string--&gt; www.magedu.com<br>exact –精确比较<br>substring—子串<br>suffix-后缀比较<br>prefix-前缀比较<br>subdir-路径， /wp-includes/js/jquery/jquery.js<br>domain-域名，www.magedu.com<br>- regular expression <span class="hljs-comment">#正则表达式</span><br>- hex block <span class="hljs-comment">#16进制</span><br></code></pre></td></tr></table></figure>

<h4 id="5-8-2-多个ACL的组合调用方式"><a href="#5-8-2-多个ACL的组合调用方式" class="headerlink" title="5.8.2 多个ACL的组合调用方式"></a>5.8.2 多个ACL的组合调用方式</h4><p>多个ACL的逻辑处理</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">与：隐式（默认）使用<br>或：使用“or&quot; 或 “||&quot;表示<br>否定：使用 &quot;!&quot; 表示<br></code></pre></td></tr></table></figure>

<p><strong>多个ACL调用方式：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#示例：</span><br><span class="hljs-keyword">if</span> valid_src valid_port <span class="hljs-comment">#与关系，ACL中A和B都要满足为true，默认为与</span><br><span class="hljs-keyword">if</span> invalid_src || invalid_port  <span class="hljs-comment">#或，ACL中A或者B满足一个为true</span><br><span class="hljs-keyword">if</span> ! invalid_src <span class="hljs-comment">#非，取反，不满足ACL才为true</span><br></code></pre></td></tr></table></figure>

<h4 id="5-8-3-ACL示例-域名匹配"><a href="#5-8-3-ACL示例-域名匹配" class="headerlink" title="5.8.3 ACL示例-域名匹配"></a>5.8.3 ACL示例-域名匹配</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl pc_domain hdr_dom(host)    -i www.magedu.org<br>acl mobile_domain hdr_dom(host)  -i mobile.magedu.org<br><br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend pc_hosts <span class="hljs-keyword">if</span> pc_domain<br>use_backend mobile_hosts <span class="hljs-keyword">if</span> mobile_domain<br>default_backend pc_hosts  <span class="hljs-comment">#所有ACL都不匹配,则使用的默认backend</span><br><br><span class="hljs-comment">###################### backend hosts #############################</span><br>ackend mobile_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<p>测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#cat /etc/hosts</span><br>127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4<br>centos6.localdomain<br>::1     localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.0.0.7 mobile.magedu.org www.magedu.org magedu.org<br><br>[root@centos6 ~]<span class="hljs-comment">#curl www.magedu.org</span><br>10.0.0.27<br>[root@centos6 ~]<span class="hljs-comment">#curl mobile.magedu.org</span><br>10.0.0.17<br>[root@centos6 ~]<span class="hljs-comment">#curl magedu.org</span><br>10.0.0.27<br></code></pre></td></tr></table></figure>

<h4 id="5-8-4-ACL示例-基于源IP或子网调度访问"><a href="#5-8-4-ACL示例-基于源IP或子网调度访问" class="headerlink" title="5.8.4 ACL示例-基于源IP或子网调度访问"></a>5.8.4 ACL示例-基于源IP或子网调度访问</h4><p>将指定的源地址调度至指定的web服务器组。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl pc_domain hdr_dom(host)    -i www.magedu.org<br>acl mobile_domain hdr_dom(host)  -i mobile.magedu.org<br>acl ip_range_test src 172.18.0.0/16 10.0.0.6   <span class="hljs-comment">#基于源地址的ACL,定义多个ACL的顺序无关</span><br>acl ip_range_test2 src 172.18.0.200<br><br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend pc_hosts     <span class="hljs-keyword">if</span>  ip_range_test  <span class="hljs-comment">#放在前面的ACL规则优先生效,引用ACL时,严格的ACL应放在前面</span><br>use_backend pc_hosts     <span class="hljs-keyword">if</span>  pc_domain<br>use_backend mobile_hosts   <span class="hljs-keyword">if</span>  mobile_domain<br>default_backend pc_hosts<br><br><span class="hljs-comment">###################### backend hosts #############################</span><br>backend mobile_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<p>测试结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.6<br>[root@centos6 ~]<span class="hljs-comment">#curl www.magedu.org</span><br>10.0.0.27<br>[root@internet ~]<span class="hljs-comment">#curl -H &quot;HOST: www.magedu.org&quot; 10.0.0.7</span><br>10.0.0.27<br>[root@centos6 ~]<span class="hljs-comment">#curl mobile.magedu.org</span><br>10.0.0.27<br>[root@centos6 ~]<span class="hljs-comment">#curl magedu.org</span><br>10.0.0.27<br>[root@centos8 ~]<span class="hljs-comment">#curl mobile.magedu.org</span><br>10.0.0.17<br>[root@centos8 ~]<span class="hljs-comment">#curl www.magedu.org</span><br>10.0.0.27<br>[root@centos8 ~]<span class="hljs-comment">#curl magedu.org</span><br>10.0.0.27<br></code></pre></td></tr></table></figure>

<h4 id="5-8-5-ACL示例-基于源地址的访问控制"><a href="#5-8-5-ACL示例-基于源地址的访问控制" class="headerlink" title="5.8.5 ACL示例-基于源地址的访问控制"></a>5.8.5 ACL示例-基于源地址的访问控制</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy45.png" srcset="/blog/img/loading.gif"></p>
<p>拒绝指定IP或者IP范围访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen web_host<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl acl_deny_src src 10.0.0.6 192.168.0.0/24<br><br><span class="hljs-comment">###################### acl hosts #################################</span><br>http-request deny  <span class="hljs-keyword">if</span> acl_deny_src  <span class="hljs-comment">#2.1版本后，不再支持block，拒绝指定IP</span><br> <span class="hljs-comment">#block if acl_deny_src 拒绝指定IP</span><br> <span class="hljs-comment">#http-request allow</span><br>default_backend default_web<br><br><span class="hljs-comment">###################### backend hosts #############################</span><br>backend magedu_host<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend default_web<br>mode http<br>server web1 10.0.0.27:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl www.magedu.org</span><br>&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;<br>Request forbidden by administrative rules.<br>&lt;/body&gt;&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<h4 id="5-8-6-ACL示例-匹配浏览器类型"><a href="#5-8-6-ACL示例-匹配浏览器类型" class="headerlink" title="5.8.6 ACL示例-匹配浏览器类型"></a>5.8.6 ACL示例-匹配浏览器类型</h4><p>匹配客户端浏览器，将不同类型的浏览器调动至不同的服务器组<br>范例: 163 网易拒绝curl和wget的访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ubuntu2004 ~]<span class="hljs-comment">#curl -I www.163.com</span><br>HTTP/1.1 403 Forbidden<br>Date: Fri, 01 Jan 2021 06:57:22 GMT<br>Content-Type: text/html<br>Content-Length: 237<br>Connection: keep-alive<br>Server: web cache<br>Expires: Fri, 01 Jan 2021 06:57:22 GMT<br>X-Ser: BC17_lt-shandong-zaozhuang-6-cache-1<br>Cache-Control: no-cache,no-store,private<br>cdn-user-ip: 111.199.184.218<br>cdn-ip: 124.132.138.17<br>X-Cache-Remote: HIT<br>cdn-source: baishan<br><br>[root@ubuntu2004 ~]<span class="hljs-comment">#curl -I -A &quot;wget&quot; www.163.com</span><br>HTTP/1.1 403 Forbidden<br>Date: Fri, 01 Jan 2021 06:58:13 GMT<br>Content-Type: text/html<br>Content-Length: 237<br>Connection: keep-alive<br>Server: web cache<br>Expires: Fri, 01 Jan 2021 06:58:13 GMT<br>X-Ser: BC17_lt-shandong-zaozhuang-6-cache-1<br>Cache-Control: no-cache,no-store,private<br>cdn-user-ip: 111.199.184.218<br>cdn-ip: 124.132.138.17<br>X-Cache-Remote: HIT<br>cdn-source: baishan<br><br><span class="hljs-comment">#不拒绝其它浏览器的访问</span><br>[root@ubuntu2004 ~]<span class="hljs-comment">#curl -I -A &quot;ApacheBench&quot; www.163.com</span><br>HTTP/1.1 301 Moved Permanently<br>Date: Fri, 01 Jan 2021 06:58:41 GMT<br>Content-Length: 0<br>Connection: keep-alive<br>Server: web cache<br>Location: https://www.163.com/<br>Cache-Control: no-cache,no-store,private<br>cdn-user-ip: 111.199.184.218<br>cdn-ip: 124.132.138.11<br>X-Cache-Remote: MISS<br>cdn-source: baishan<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl acl_user_agent hdr_sub(User-Agent)  -i curl wget    <span class="hljs-comment">#基于浏览器的ACL</span><br>acl acl_user_agent_ab hdr_sub(User-Agent)  -i ApacheBench<br><br><span class="hljs-comment">###################### acl hosts #################################</span><br>redirect prefix  http://www.baidu.com <span class="hljs-keyword">if</span> acl_user_agent <span class="hljs-comment">#302 临时重定向至新URL</span><br>http-request deny   <span class="hljs-keyword">if</span> acl_user_agent_ab <span class="hljs-comment">#拒绝ab</span><br><span class="hljs-comment">#block if acl_user_agent #拒绝agent</span><br>default_backend pc_hosts<br><br><span class="hljs-comment">###################### backend hosts #############################</span><br>backend mobile_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -I 10.0.0.7</span><br>HTTP/1.1 302 Found<br>content-length: 0<br>location: http://10.0.0.8/<br>cache-control: no-cache<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -L 10.0.0.7</span><br>10.0.0.8<br>[root@centos6 ~]<span class="hljs-comment">#wget -O - -q http://10.0.0.7</span><br>10.0.0.8<br>[root@centos6 ~]<span class="hljs-comment">#curl -A chrome http://10.0.0.7</span><br>10.0.0.27<br><br><span class="hljs-comment">#模拟ab</span><br>[root@centos6 ~]<span class="hljs-comment">#curl -A ApacheBench 10.0.0.7</span><br>&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;<br>Request forbidden by administrative rules.<br>&lt;/body&gt;&lt;/html&gt;<br><br>[root@centos6 ~]<span class="hljs-comment">#ab -n1 -c 1 http://10.0.0.7/</span><br>This is ApacheBench, Version 2.3 &lt;<span class="hljs-variable">$Revision</span>: 655654 $&gt;<br>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/<br>Licensed to The Apache Software Foundation, http://www.apache.org/<br><br>Benchmarking 10.0.0.7 (be patient).....<span class="hljs-keyword">done</span><br><br>Server Software:    <br>Server Hostname:     10.0.0.7<br>Server Port:       80<br><br>Document Path:     /<br>Document Length:     93 bytes<br><br>Concurrency Level:    1<br>Time taken <span class="hljs-keyword">for</span> tests:  0.001 seconds<br>Complete requests:    1<br>Failed requests:     0<br>Write errors:      0<br>Non-2xx responses:    1   <span class="hljs-comment">#提示出现非200的响应</span><br>Total transferred:    208 bytes<br>HTML transferred:    93 bytes<br>Requests per second:   939.85 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:    1.064 [ms] (mean)<br>Time per request:    1.064 [ms] (mean, across all concurrent requests)<br>Transfer rate:      190.91 [Kbytes/sec] received<br><br>Connection Times (ms)<br>      min mean[+/-sd] median  max<br>Connect:     1   1  0.0    1    1<br>Processing:   1   1  0.0    1    1<br>Waiting:     0   0  0.0    0    0<br>Total:      1   1  0.0    1    1<br><br><span class="hljs-comment">#haproxy日志提示403</span><br>[root@centos7 ~]<span class="hljs-comment">#tail /var/log/haproxy.log</span><br>Apr  4 08:16:29 localhost haproxy[1483]: 10.0.0.6:56470<br>[04/Apr/2020:08:16:29.977] magedu_http_port magedu_http_port/&lt;NOSRV&gt;<br>0/-1/-1/-1/0 403 212 - - PR-- 1/1/0/0/0 0/0 <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="5-8-7-ACL示例-基于文件后缀名实现动静分离"><a href="#5-8-7-ACL示例-基于文件后缀名实现动静分离" class="headerlink" title="5.8.7 ACL示例-基于文件后缀名实现动静分离"></a>5.8.7 ACL示例-基于文件后缀名实现动静分离</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl acl_static path_end -i .jpg .jpeg .png .gif .css .js .html  <span class="hljs-comment">#基于文件后缀名的ACL</span><br>acl acl_php  path_end -i .php<br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend mobile_hosts <span class="hljs-keyword">if</span> acl_static<br>use_backend app_hosts <span class="hljs-keyword">if</span> acl_php<br>default_backend pc_hosts<br><span class="hljs-comment">###################### backend hosts #############################</span><br>backend mobile_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br><br>backend app_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br><br><span class="hljs-comment">#分别在后端两台主机准备相关文件</span><br>[root@centos17 ~]<span class="hljs-comment">#ls /var/www/html</span><br>index.html wang.jpg<br><br>[root@centos27 ~]<span class="hljs-comment">#cat /var/www/html/test.php</span><br>&lt;?php<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;h1&gt;http://10.0.0.27/test.php&lt;/h1&gt;\n&quot;</span>;<br>?&gt;<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy46.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy47.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-8-8-ACL-匹配访问路径实现动静分离"><a href="#5-8-8-ACL-匹配访问路径实现动静分离" class="headerlink" title="5.8.8 ACL-匹配访问路径实现动静分离"></a>5.8.8 ACL-匹配访问路径实现动静分离</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl acl_static path_beg  -i /static /images /javascript     <span class="hljs-comment">#基于路径的ACL，path_beg为...开头</span><br>acl acl_static path_end  -i .jpg .jpeg .png .gif .css .js .html .htm  <span class="hljs-comment">#ACL同名为或关系，path_end为...结尾</span><br>acl acl_app path_beg  -i /api<br><br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend static_hosts <span class="hljs-keyword">if</span> acl_static<br>use_backend app_hosts  <span class="hljs-keyword">if</span> acl_app<br>default_backend app_hosts<br><span class="hljs-comment">###################### backend hosts #############################</span><br>backend static_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend app_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br><br><span class="hljs-comment">#创建相关文件</span><br>[root@centos17 ~]<span class="hljs-comment">#mkdir /var/www/html/static</span><br>[root@centos17 ~]<span class="hljs-comment">#echo 10.0.0.17 &gt; /var/www/html/static/test.html</span><br><br><span class="hljs-comment">#测试访问</span><br>[root@centos6 ~]<span class="hljs-comment">#curl 10.0.0.7/static/test.html</span><br>10.0.0.17<br><br><br></code></pre></td></tr></table></figure>

<h4 id="5-8-9-ACL示例-预定义ACL使用"><a href="#5-8-9-ACL示例-预定义ACL使用" class="headerlink" title="5.8.9 ACL示例-预定义ACL使用"></a>5.8.9 ACL示例-预定义ACL使用</h4><p>官方帮助文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7.4">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7.4</a></p>
<h5 id="5-8-9-1-预定义ACL"><a href="#5-8-9-1-预定义ACL" class="headerlink" title="5.8.9.1 预定义ACL"></a>5.8.9.1 预定义ACL</h5><table>
<thead>
<tr>
<th>ACL name</th>
<th>Equivalent to</th>
<th>Usage</th>
</tr>
</thead>
<tbody><tr>
<td>FALSE</td>
<td>always_false</td>
<td>never match</td>
</tr>
<tr>
<td>HTTP</td>
<td>req_proto_http</td>
<td>match if protocol is valid HTTP</td>
</tr>
<tr>
<td>HTTP_1.0</td>
<td>req_ver 1.0</td>
<td>match HTTP version 1.0</td>
</tr>
<tr>
<td>HTTP_1.1</td>
<td>req_ver 1.1</td>
<td>match HTTP version 1.1</td>
</tr>
<tr>
<td>HTTP_CONTENT</td>
<td>hdr_val(content-length) gt 0</td>
<td>match an existing content-length</td>
</tr>
<tr>
<td>HTTP_URL_ABS</td>
<td>url_reg ^[^/:]*://</td>
<td>match absolute URL with scheme</td>
</tr>
<tr>
<td>HTTP_URL_SLASH</td>
<td>url_beg /</td>
<td>match URL beginning with “/“</td>
</tr>
<tr>
<td>HTTP_URL_STAR</td>
<td>url *</td>
<td>match URL equal to “*”</td>
</tr>
<tr>
<td>LOCALHOST</td>
<td>src 127.0.0.1/8</td>
<td>match connection from local host</td>
</tr>
<tr>
<td>METH_CONNECT</td>
<td>method CONNECT</td>
<td>match HTTP CONNECT method</td>
</tr>
<tr>
<td>METH_DELETE</td>
<td>method DELETE</td>
<td>match HTTP DELETE method</td>
</tr>
<tr>
<td>METH_GET</td>
<td>method GET HEAD</td>
<td>match HTTP GET or HEAD method</td>
</tr>
<tr>
<td>METH_HEAD</td>
<td>method HEAD</td>
<td>match HTTP HEAD method</td>
</tr>
<tr>
<td>METH_OPTIONS</td>
<td>method OPTIONS</td>
<td>match HTTP OPTIONS method</td>
</tr>
<tr>
<td>METH_POST</td>
<td>method POST</td>
<td>match HTTP POST method</td>
</tr>
<tr>
<td>METH_PUT</td>
<td>method PUT</td>
<td>match HTTP PUT method</td>
</tr>
<tr>
<td>METH_TRACE</td>
<td>method TRACE</td>
<td>match HTTP TRACE method</td>
</tr>
<tr>
<td>RDP_COOKIE</td>
<td>req_rdp_cookie_cnt gt 0</td>
<td>match presence of an RDP cookie</td>
</tr>
<tr>
<td>REQ_CONTENT</td>
<td>req_len gt 0</td>
<td>match data in the request buffer</td>
</tr>
<tr>
<td>TRUE</td>
<td>always_true</td>
<td>always match</td>
</tr>
<tr>
<td>WAIT_END</td>
<td>wait_end</td>
<td>wait for end of content analysis</td>
</tr>
</tbody></table>
<h5 id="5-8-9-2-预定义ACL使用"><a href="#5-8-9-2-预定义ACL使用" class="headerlink" title="5.8.9.2 预定义ACL使用"></a>5.8.9.2 预定义ACL使用</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -I -XTRACE 10.0.0.7/static/test.html</span><br>HTTP/1.1 200 OK<br>date: Sat, 04 Apr 2020 02:04:01 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>transfer-encoding: chunked<br>content-type: message/http<br><br>[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl acl_static_path path_beg  -i /static /images /javascript<br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend static_path_hosts <span class="hljs-keyword">if</span> acl_static_path<br>http-request deny <span class="hljs-keyword">if</span> METH_TRACE HTTP_1.1  <span class="hljs-comment">#引用预定义的ACL，多个ACL默认为与关系</span><br>default_backend pc_hosts<br><span class="hljs-comment">################### backend hosts ################################</span><br>backend static_path_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend mobile_hosts<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -I -XTRACE 10.0.0.7/static/test.html</span><br>HTTP/1.1 403 Forbidden<br>content-length: 93<br>cache-control: no-cache<br>content-type: text/html<br>connection: close<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -I -0 -XTRACE 10.0.0.7/static/test.html</span><br>HTTP/1.1 200 OK<br>date: Sat, 04 Apr 2020 02:10:13 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>content-type: message/http<br>connection: close<br><br><span class="hljs-comment">#查看日志，观察协议版本</span><br>[root@centos17 ~]<span class="hljs-comment">#tail /var/log/httpd/access_log</span><br>10.0.0.7 - - [04/Apr/2020:10:11:41 +0800] <span class="hljs-string">&quot;TRACE /static/test.html HTTP/1.0&quot;</span> 200<br>230 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1</span><br><span class="hljs-string">zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span><br><br>[root@centos6 ~]<span class="hljs-comment">#curl -i 10.0.0.7/static/test.html</span><br>HTTP/1.1 200 OK<br>date: Sat, 04 Apr 2020 02:07:58 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>last-modified: Sat, 04 Apr 2020 01:27:45 GMT<br>etag: <span class="hljs-string">&quot;a-5a26cf0ed4913&quot;</span><br>accept-ranges: bytes<br>content-length: 10<br>content-type: text/html; charset=UTF-8<br>10.0.0.17<br></code></pre></td></tr></table></figure>

<h3 id="5-9-自定义HAProxy-错误界面"><a href="#5-9-自定义HAProxy-错误界面" class="headerlink" title="5.9 自定义HAProxy 错误界面"></a>5.9 自定义HAProxy 错误界面</h3><p>对指定的报错进行重定向，进行优雅的显示错误页面<br>使用errorfile和errorloc指令的两种方法，可以实现自定义各种错误页面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy48.png" srcset="/blog/img/loading.gif"></p>
<p>默认情况下，所有后端服务器都down机后，会显示下面页面</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy49.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-9-1-基于自定义的错误页面文件"><a href="#5-9-1-基于自定义的错误页面文件" class="headerlink" title="5.9.1 基于自定义的错误页面文件"></a>5.9.1 基于自定义的错误页面文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#自定义错误页</span><br>errorfile &lt;code&gt; &lt;file&gt;<br>&lt;code&gt; <span class="hljs-comment">#HTTP status code.支持200, 400, 403, 405, 408, 425, 429, 500, 502，503,504</span><br>&lt;file&gt; <span class="hljs-comment">#包含完整HTTP响应头的错误页文件的绝对路径。 建议后缀&quot;.http&quot;，以和一般的html文件相区分</span><br><br><span class="hljs-comment">#示例：</span><br>errorfile 400 /etc/haproxy/errorfiles/400badreq.http<br>errorfile 403 /etc/haproxy/errorfiles/403forbid.http<br>errorfile 503 /etc/haproxy/errorfiles/503sorry.http<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">defaults<br><span class="hljs-comment">#option forwardfor</span><br><span class="hljs-comment">#no option http-use-htx 支持html文件,此设置和版本有关，2.1不支持</span><br><span class="hljs-comment">#......</span><br><br><span class="hljs-comment">#加下面行</span><br>errorfile 500 /usr/<span class="hljs-built_in">local</span>/haproxy/html/500.http<br>errorfile 502 /usr/<span class="hljs-built_in">local</span>/haproxy/html/502.http<br>errorfile 503 /usr/<span class="hljs-built_in">local</span>/haproxy/html/503.http<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br>defaults<br>option http-keep-alive<br>option forwardfor<br>maxconn 100000<br>mode http<br>timeout connect 300000ms<br>timeout client 300000ms<br>timeout server 300000ms<br>errorfile 503 /apps/haproxy/html/503.http <br><br>listen<br>.......<br><br>[root@centos7 ~]<span class="hljs-comment">#vim /apps/haproxy/html/503.http</span><br>HTTP/1.1 503 Service Unavailable<br>Content-Type:text/html;charset=utf-8<br><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;报错页面&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;网站维护中......请稍候再试&lt;/h1&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h2&gt;联系电话：400-123-4567&lt;/h2&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;<br>&lt;/body&gt;<br><br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart haproxy</span><br><span class="hljs-comment">#将后端服务器down，可以观察到以下页面</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy50.png" srcset="/blog/img/loading.gif"></p>
<p>范例：启用no option http-use-htx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@haproxy ~]<span class="hljs-comment">#vi /etc/haproxy/haproxy.cfg</span><br>defaults<br> option http-keep-alive<br> no option http-use-htx  <span class="hljs-comment">#在defaults 块中添加</span><br> errorfile 503 /apps/haproxy/errorfiles/503.html<br> <br> [root@haproxy ~]<span class="hljs-comment">#cat /apps/haproxy/errorfiles/503.html</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;报错页面&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;网站维护中......请稍侯再试&lt;/h1&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h2&gt;联系电话：400-123-8888&lt;/h2&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;<br>&lt;/body&gt;<br><br><span class="hljs-comment">#注意没有响应头信息</span><br>[root@internet ~]<span class="hljs-comment">#curl -I 172.16.0.100</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;title&gt;报错页面&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;网站维护中......请稍侯再试&lt;/h1&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h2&gt;联系电话：400-123-8888&lt;/h2&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;<br>&lt;/body&gt;<br><br><span class="hljs-comment">#ubuntu的客户端提示错误</span><br>root@ubuntu2004:~<span class="hljs-comment"># curl  172.16.0.100</span><br>curl: (1) Received HTTP/0.9 when not allowed<br></code></pre></td></tr></table></figure>

<h4 id="5-9-2-基于http重定向错误页面"><a href="#5-9-2-基于http重定向错误页面" class="headerlink" title="5.9.2 基于http重定向错误页面"></a>5.9.2 基于http重定向错误页面</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#错误页面重定向</span><br>errorloc &lt;code&gt; &lt;url&gt;<br><span class="hljs-comment">#相当于errorloc302 &lt;code&gt; &lt;url&gt;，利用302重定向至指URL</span><br><br><span class="hljs-comment">#示例：</span><br>errorloc 503 http://www.magedu.com/error_pages/503.html<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br>defaults<br><span class="hljs-comment">#option http-keep-alive</span><br><span class="hljs-comment">#option forwardfor</span><br><span class="hljs-comment">#no option http-use-htx</span><br><span class="hljs-comment">#...... 加以下一行</span><br><span class="hljs-comment">#errorfile 503 /apps/haproxy/html/503.http</span><br>errorloc 503 http://10.0.0.8/error_page/503.html<br><br>[root@centos8 ~]<span class="hljs-comment">#cat /var/www/html/error_page/503.html</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;title&gt;报错页面&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;网站维护中......请稍侯再试&lt;/h1&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h2&gt;联系电话：400-123-4567&lt;/h2&gt;&lt;/center&gt;<br>&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;<br>&lt;/body&gt;<br><br><span class="hljs-comment">#浏览器访问http://haproxy/ 302自动跳转至下面页面</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy51.png" srcset="/blog/img/loading.gif"></p>
<h3 id="5-10-HAProxy-四层负载"><a href="#5-10-HAProxy-四层负载" class="headerlink" title="5.10 HAProxy 四层负载"></a>5.10 HAProxy 四层负载</h3><p>针对除HTTP以外的TCP协议应用服务访问的应用场景</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">MySQL<br>Redis<br>Memcache<br>RabbitMQ<br></code></pre></td></tr></table></figure>

<p>Q: 后端服务器和haproxy还是和客户端建立三次握手?</p>
<p>A：后端服务器和haproxy建立三次握手</p>
<h4 id="5-10-1-四层负载示例"><a href="#5-10-1-四层负载示例" class="headerlink" title="5.10.1 四层负载示例"></a>5.10.1 四层负载示例</h4><p>注意：如果使用frontend和backend，一定在 frontend 和 backend 段中都指定mode tcp</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">listen redis-port<br> <span class="hljs-built_in">bind</span> 10.0.0.7:6379<br> mode tcp<br> balance leastconn<br> server server1 10.0.0.17:6379 check<br> server server2 10.0.0.27:6379 check backup<br></code></pre></td></tr></table></figure>

<p>范例：对 MySQL 服务实现四层负载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#vim /etc/haproxy/haproxy.cfg</span><br>listen magedu_mysql<br><span class="hljs-built_in">bind</span> 10.0.0.7:3306<br>mode tcp<br>balance leastconn<br>server mysql1 10.0.0.17:3306 check <br> server mysql2 10.0.0.27:3306 check      <span class="hljs-comment">#如果不写端口号，可以转发，但无法check状态</span><br><br><span class="hljs-comment">#或者使用frontend和backend实现</span><br>frontend mysql<br>   <span class="hljs-built_in">bind</span> :3306<br>   mode tcp  <span class="hljs-comment">#必须指定tcp模式</span><br>   default_backend mysqlsrvs<br>backend mysqlsrvs<br>   mode tcp <span class="hljs-comment">#必须指定tcp模式</span><br>   balance leastconn<br>   server mysql1 10.0.0.17:3306<br>   server mysql2 10.0.0.27:3306<br>   <br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart haproxy</span><br><br><span class="hljs-comment">#在后端服务器安装和配置mariadb服务</span><br>[root@centos7 ~]<span class="hljs-comment">#yum -y install mariadb-server</span><br>[root@centos7 ~]<span class="hljs-comment">#mysql -e &quot;grant all on *.* to test@&#x27;10.0.0.%&#x27; identified by &#x27;123456&#x27;&quot;</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/my.cnf</span><br>[mysqld]<br>server-id=17 <span class="hljs-comment">#在另一台主机为27</span><br>[root@centos7 ~]<span class="hljs-comment">#systemctl start mariadb</span><br><br><span class="hljs-comment">#测试</span><br>[root@centos6 ~]<span class="hljs-comment">#mysql -utest -p123456 -e &quot;show variables like &#x27;hostname&#x27;&quot;</span><br>+---------------+--------------------------+<br>| Variable_name | Value          |<br>+---------------+--------------------------+<br>| hostname   | centos17.wangxiaochu.com |<br>+---------------+--------------------------+<br>[root@centos6 ~]<span class="hljs-comment">#mysql -utest -p123456 -e &quot;show variables like &#x27;hostname&#x27;&quot;</span><br>+---------------+--------------------------+<br>| Variable_name | Value          |<br>+---------------+--------------------------+<br>| hostname   | centos27.wangxiaochu.com |<br>+---------------+--------------------------+<br>[root@centos6 ~]<span class="hljs-comment">#mysql -utest -p123456 -h10.0.0.7 -e &#x27;select @@server_id&#x27;</span><br>+-------------+<br>| @@server_id |<br>+-------------+<br>|      17 |<br>+-------------+<br>[root@centos6 ~]<span class="hljs-comment">#mysql -utest -p123456 -h10.0.0.7 -e &#x27;select @@server_id&#x27;</span><br>+-------------+<br>| @@server_id |<br>+-------------+<br>|      27 |<br>+-------------+<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy52.png" srcset="/blog/img/loading.gif"></p>
<h4 id="5-10-2-ACL示例-四层访问控制"><a href="#5-10-2-ACL示例-四层访问控制" class="headerlink" title="5.10.2 ACL示例-四层访问控制"></a>5.10.2 ACL示例-四层访问控制</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">frontend web_host<br>    <span class="hljs-built_in">bind</span> 10.0.0.7:80<br>    mode http<br>    balance roundrobin<br>    <span class="hljs-built_in">log</span> global<br>    option httplog<br><span class="hljs-comment">###################### acl setting ############################### </span><br>    acl static_path path_beg  -i /static /images /javascript<br>    acl invalid_src src 192.168.1.0/24 10.0.0.8<br><span class="hljs-comment">###################### acl hosts #################################</span><br>use_backend static_path_host <span class="hljs-keyword">if</span> HTTP_1.1 TRUE static_path<br>tcp-request connection reject <span class="hljs-keyword">if</span> invalid_src   <span class="hljs-comment">#四层ACL控制 （tcp拒绝）</span><br>default_backend default_web<br><span class="hljs-comment">################### backend hosts ################################</span><br>backend php_server_host<br>mode http<br>server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br><br>backend static_path_host<br>mode http<br>server web1 10.0.0.27 check inter 2000 fall 3 rise 5<br><br>backend default_web<br>mode http<br>server web1 10.0.0.37:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h3 id="5-11-HAProxy-https-实现"><a href="#5-11-HAProxy-https-实现" class="headerlink" title="5.11 HAProxy https 实现"></a>5.11 HAProxy https 实现</h3><p>haproxy可以实现https的证书安全,但基于性能考虑,生产中证书都是在后端服务器比如nginx上实现<br>从用户到haproxy为https,从happroxy到后端服务器用http通信</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#配置HAProxy支持https协议，支持ssl会话；</span><br><span class="hljs-built_in">bind</span> *:443 ssl crt /PATH/TO/SOME_PEM_FILE<br><br><span class="hljs-comment">#指令 crt 后证书文件为PEM格式，需要同时包含证书和所有私钥</span><br>cat demo.key demo.crt &gt; demo.pem<br><br><span class="hljs-comment">#把80端口的请求重向定443</span><br><span class="hljs-built_in">bind</span> *:80<br>redirect scheme https <span class="hljs-keyword">if</span> !&#123; ssl_fc &#125;<br><br><span class="hljs-comment">#向后端传递用户请求的协议和端口（frontend或backend）</span><br>http_request set-header X-Forwarded-Port %[dst_port]<br>http_request add-header X-Forwared-Proto https <span class="hljs-keyword">if</span> &#123; ssl_fc &#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-11-1-证书制作"><a href="#5-11-1-证书制作" class="headerlink" title="5.11.1 证书制作"></a>5.11.1 证书制作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs bash">方法1<br>[root@centos7 ~]mkdir /etc/haproxy/certs/<br>[root@centos7 ~]<span class="hljs-built_in">cd</span> /etc/haproxy/certs/<br>[root@centos7 certs]<span class="hljs-comment">#openssl genrsa -out haproxy.key 2048</span><br>[root@centos7 certs]<span class="hljs-comment">#openssl req -new -x509 -key haproxy.key -out haproxy.crt</span><br>-subj <span class="hljs-string">&quot;/CN=www.magedu.org&quot;</span><br><span class="hljs-comment">#或者用下一条命令实现</span><br>[root@centos7 certs]<span class="hljs-comment">#openssl req -x509 -newkey rsa:2048 -subj</span><br><span class="hljs-string">&quot;/CN=www.magedu.org&quot;</span> -keyout haproxy.key -nodes -days 365 -out haproxy.crt<br><br>[root@centos7 certs]<span class="hljs-comment">#cat haproxy.key haproxy.crt &gt; haproxy.pem</span><br>[root@centos7 certs]<span class="hljs-comment">#openssl x509 -in haproxy.pem -noout -text #查看证书</span><br><br><span class="hljs-comment">#方法2</span><br>[root@centos7 ~]<span class="hljs-comment">#mkdir /etc/haproxy/certs/</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /etc/pki/tls/certs</span><br>[root@centos7 certs]<span class="hljs-comment">#make /etc/haproxy/certs/haproxy.pem</span><br><span class="hljs-built_in">umask</span> 77 ; \<br>PEM1=`/bin/mktemp /tmp/openssl.XXXXXX` ; \<br>PEM2=`/bin/mktemp /tmp/openssl.XXXXXX` ; \<br>/usr/bin/openssl req -utf8 -newkey rsa:2048 -keyout <span class="hljs-variable">$PEM1</span> -nodes -x509 -days 365<br>-out <span class="hljs-variable">$PEM2</span> ; \<br>cat <span class="hljs-variable">$PEM1</span> &gt; /etc/haproxy/certs/haproxy.pem ; \<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span>  &gt;&gt; /etc/haproxy/certs/haproxy.pem ; \<br>cat <span class="hljs-variable">$PEM2</span> &gt;&gt; /etc/haproxy/certs/haproxy.pem ; \<br>rm -f <span class="hljs-variable">$PEM1</span> <span class="hljs-variable">$PEM2</span><br>Generating a 2048 bit RSA private key<br>.+++<br>..............................................+++<br>writing new private key to <span class="hljs-string">&#x27;/tmp/openssl.x8hOA8&#x27;</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Country Name (2 letter code) [XX]:CN<br>State or Province Name (full name) []:beijing<br>Locality Name (eg, city) [Default City]:beijing<br>Organization Name (eg, company) [Default Company Ltd]:magedu<br>Organizational Unit Name (eg, section) []:it<br>Common Name (eg, your name or your server<span class="hljs-string">&#x27;s hostname) []:www.magedu.org</span><br><span class="hljs-string">Email Address []:</span><br><span class="hljs-string">[root@centos7 certs]#ll /etc/haproxy/certs/</span><br><span class="hljs-string">total 4</span><br><span class="hljs-string">-rw------- 1 root root 3027 Apr  4 10:35 haproxy.pem</span><br></code></pre></td></tr></table></figure>

<h4 id="5-11-2-https配置示例"><a href="#5-11-2-https配置示例" class="headerlink" title="5.11.2 https配置示例"></a>5.11.2 https配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment">#cat /etc/haproxy/conf.d/test.cfg</span><br>frontend magedu_http_port<br><span class="hljs-built_in">bind</span> 10.0.0.7:80<br><span class="hljs-comment">###################### https setting ############################## </span><br><span class="hljs-built_in">bind</span> 10.0.0.7:443 ssl crt /etc/haproxy/certs/haproxy.pem<br>redirect scheme https <span class="hljs-keyword">if</span> !&#123; ssl_fc &#125;     <span class="hljs-comment"># 注意&#123; &#125;内的空格</span><br>http-request set-header X-forwarded-Port  %[dst_port]<br>http-request add-header X-forwarded-Proto https <span class="hljs-keyword">if</span> &#123; ssl_fc &#125;<br><br>mode http<br>balance roundrobin<br><span class="hljs-built_in">log</span> global<br>option httplog<br><span class="hljs-comment">###################### acl setting ###############################</span><br>acl mobile_domain hdr_dom(host)  -i mobile.magedu.org<br><span class="hljs-comment">###################### acl hosts #################################</span><br>default_backend pc_hosts<br><span class="hljs-comment">################### backend hosts #################################</span><br>backend mobile_hosts<br>mode http<br>server web1 10.0.0.17:80 check inter 2000 fall 3 rise 5<br><br>backend pc_hosts<br>mode http<br> <span class="hljs-comment">#http-request set-header X-forwarded-Port  %[dst_port] 也可加在此处</span><br> <span class="hljs-comment">#http-request add-header X-forwarded-Proto https if &#123; ssl_fc &#125;</span><br>server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br><br>[root@centos7 ~]<span class="hljs-comment">#ss -ntl</span><br>State   Recv-Q Send-Q     Local Address:Port  Peer Address:Port    <br>  <br>LISTEN   0    100         127.0.0.1:25         *:*     <br>   <br>LISTEN   0    128          10.0.0.7:443        *:*     <br>   <br>LISTEN   0    128             *:9999        *:*     <br>   <br>LISTEN   0    128          10.0.0.7:80         *:*     <br>   <br>LISTEN   0    128             *:22         *:*     <br>   <br>LISTEN   0    128           [::]:22         [::]:* <br></code></pre></td></tr></table></figure>

<h4 id="5-11-3-修改后端服务器的日志格式"><a href="#5-11-3-修改后端服务器的日志格式" class="headerlink" title="5.11.3 修改后端服务器的日志格式"></a>5.11.3 修改后端服务器的日志格式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos27 ~]<span class="hljs-comment">#vim /etc/httpd/conf/httpd.conf</span><br>LogFormat <span class="hljs-string">&quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot; \&quot;%&#123;X-</span><br><span class="hljs-string">Forwarded-Port&#125;i\&quot; \&quot;%&#123;X-Forwarded-Proto&#125;i\&quot;&quot;</span> combined <br></code></pre></td></tr></table></figure>

<h4 id="5-11-4-验证https"><a href="#5-11-4-验证https" class="headerlink" title="5.11.4 验证https"></a>5.11.4 验证https</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos6 ~]<span class="hljs-comment">#curl -IkL http://www.magedu.org</span><br>HTTP/1.1 302 Found<br>content-length: 0<br>location: https://www.magedu.org/<br>cache-control: no-cache<br><br>HTTP/1.1 200 OK<br>date: Sat, 04 Apr 2020 02:31:31 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>last-modified: Thu, 02 Apr 2020 01:44:13 GMT<br>etag: <span class="hljs-string">&quot;a-5a244f01f8adc&quot;</span><br>accept-ranges: bytes<br>content-length: 10<br>content-type: text/html; charset=UTF-8<br><br>[root@centos6 ~]<span class="hljs-comment">#curl -Ik https://www.magedu.org</span><br>HTTP/1.1 200 OK<br>date: Sat, 04 Apr 2020 02:31:50 GMT<br>server: Apache/2.4.6 (CentOS) PHP/5.4.16<br>last-modified: Thu, 02 Apr 2020 01:44:28 GMT<br>etag: <span class="hljs-string">&quot;a-5a244f0fd5175&quot;</span><br>accept-ranges: bytes<br>content-length: 10<br>content-type: text/html; charset=UTF-8<br><br><span class="hljs-comment">#查看后端服务器的访问日志</span><br>[root@centos27 ~]<span class="hljs-comment">#tail /var/log/httpd/access_log</span><br>10.0.0.7 - - [04/Apr/2020:10:40:17 +0800] <span class="hljs-string">&quot;HEAD / HTTP/1.1&quot;</span> 200 - <span class="hljs-string">&quot;-&quot;</span><br><span class="hljs-string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span><br><span class="hljs-string">libidn/1.18 libssh2/1.4.2&quot;</span> <span class="hljs-string">&quot;443&quot;</span> <span class="hljs-string">&quot;https&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy53.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy54.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/HAProxy/haproxy55.png" srcset="/blog/img/loading.gif"></p>
<h2 id="六、-本章重点总结"><a href="#六、-本章重点总结" class="headerlink" title="六、 本章重点总结"></a>六、 本章重点总结</h2><ul>
<li>HAProxy调度算法</li>
<li>动静分离与客户端源IP透传</li>
<li>ACL使用与报文修改</li>
<li>服务器动态下线 </li>
<li>编写shell脚本，实现能够基于参数传递 Real Server 服务器IP，并实现将其从多个HAProxy进程下<br>线与上线（编写shell脚本，传递后端服务器IP，使其能够在HAProxy实现上线与下线。提示：使用socat命令）</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">stats socket /var/lib/haproxy/haproxy1.sock mode 600 level admin process 1<br>stats socket /var/lib/haproxy/haproxy2.sock mode 600 level admin process 2<br></code></pre></td></tr></table></figure>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/Linux-HAPROXY/">Linux HAPROXY</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/09/02/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E9%9B%86%E7%BE%A4keepalived/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">高可用性集群keepalived</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/05/24/Devops%E4%B9%8B%E5%9F%BA%E4%BA%8EJenkins%E7%9A%84CI%E4%B8%8ECD%E5%AE%9E%E6%88%98/">
                        <span class="hidden-mobile">Devops之基于Jenkins的CI与CD实战</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
