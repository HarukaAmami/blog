

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>高性能WEB服务Nginx（三）Nginx核心配置和高级配置 - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="高性能WEB服务Nginx（三）Nginx核心配置和高级配置">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-02-27 21:44" pubdate>
        2021年2月27日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      47.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      728
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">高性能WEB服务Nginx（三）Nginx核心配置和高级配置</h1>
            
            <div class="markdown-body">
              <h1 id="Nginx核心配置"><a href="#Nginx核心配置" class="headerlink" title="Nginx核心配置"></a>Nginx核心配置</h1><h1 id="一、Nginx文件配置说明"><a href="#一、Nginx文件配置说明" class="headerlink" title="一、Nginx文件配置说明"></a>一、Nginx文件配置说明</h1><h2 id="1-1-Nginx官方帮助文档"><a href="#1-1-Nginx官方帮助文档" class="headerlink" title="1.1 Nginx官方帮助文档"></a>1.1 Nginx官方帮助文档</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://nginx.org/en/docs/<br></code></pre></td></tr></table></figure>

<h2 id="1-2-tengine-帮助文档"><a href="#1-2-tengine-帮助文档" class="headerlink" title="1.2 tengine 帮助文档"></a>1.2 tengine 帮助文档</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://tengine.taobao.org/documentation_cn.html<br></code></pre></td></tr></table></figure>

<h2 id="1-3-Nginx的配置文件组成部分"><a href="#1-3-Nginx的配置文件组成部分" class="headerlink" title="1.3 Nginx的配置文件组成部分"></a>1.3 Nginx的配置文件组成部分</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stata">主配置文件：nginx.<span class="hljs-keyword">conf</span><br>子配置文件: <span class="hljs-keyword">include</span> <span class="hljs-keyword">conf</span>.<span class="hljs-keyword">d</span><span class="hljs-comment">/*.conf</span><br><span class="hljs-comment">fastcgi， uwsgi，scgi 等协议相关的配置文件</span><br><span class="hljs-comment">nternet Mail Extensions多用途互联网</span><br><span class="hljs-comment">邮件扩展类型，MIME消息能包含文本、图像、音频、视频以及其他应用程序专用的数据，是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。</span><br></code></pre></td></tr></table></figure>
<p>**MIME参考文档： **</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types<br></code></pre></td></tr></table></figure>

<p><strong>Nginx 主配置文件的配置指令方式</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss">directive value <span class="hljs-selector-attr">[value2 ...]</span>;<br>#注意<br>(<span class="hljs-number">1</span>) 指令必须以分号结尾<br>(<span class="hljs-number">2</span>) 支持使用配置变量<br>	内建变量：由Nginx模块引入，可直接引用<br>	自定义变量：由用户使用set命令定义,格式: set variable_name value;<br>	引用变量：<span class="hljs-variable">$variable_name</span><br></code></pre></td></tr></table></figure>
<p><strong>主配置文件结构：四部分</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">main block：主配置段，即全局配置段，对http,mail都有效<br><span class="hljs-comment">#事件驱动相关的配置</span><br>event &#123;<br>...<br>&#125; <br><span class="hljs-comment">#http/https 协议相关配置段</span><br>http &#123;<br>...<br>&#125;     <br><span class="hljs-comment">#默认配置文件不包括下面两个块</span><br><span class="hljs-comment">#mail 协议相关配置段</span><br>mail &#123;<br>...<br>&#125;  <br><span class="hljs-comment">#stream 服务器相关配置段</span><br>stream &#123;<br>...<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>默认的nginx.conf 配置文件格式说明</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#全局配置端，对全局生效，主要设置nginx的启动用户/组，启动的工作进程数量，工作模式，Nginx的PID路径，日志路径等。</span><br>user nginx nginx;<br>worker_processes  1;  <span class="hljs-comment">#启动工作进程数数量</span><br>events &#123; <span class="hljs-comment">#events设置块，主要影响nginx服务器与用户的网络连接，比如是否允许同时接受多个网络连接，使用哪种事件驱动模型处理请求，每个工作进程可以同时支持的最大连接数，是否开启对多工作进程下的网络连接进行序列化等。</span><br>  worker_connections  1024;  <span class="hljs-comment">#设置单个nginx工作进程可以接受的最大并发，作为web服务器的时候最大并发数为worker_connections * worker_processes，作为反向代理的时候为(worker_connections * worker_processes)/2</span><br>&#125;<br>http &#123; <span class="hljs-comment">#http块是Nginx服务器配置中的重要部分，缓存、代理和日志格式定义等绝大多数功能和第三方模块都可以在这设置，http块可以包含多个server块，而一个server块中又可以包含多个location块，server块可以配置文件引入、MIME-Type定义、日志自定义、是否启用sendfile、连接超时时间和单个链接的请求上限等。</span><br> include    mime.types;<br> default_type application/octet-stream;<br> sendfile    on; <span class="hljs-comment">#作为web服务器的时候打开sendfile加快静态文件传输，指定是否使用sendfile系统调用来传输文件,sendfile系统调用在两个文件描述符之间直接传递数据(完全在内核中操作)，从而避免了数据在内核缓冲区和用户缓冲区之间的拷贝，操作效率很高，被称之为零拷贝，硬盘 &gt;&gt;kernel buffer (快速拷贝到kernelsocket buffer) &gt;&gt;协议栈。</span><br> keepalive_timeout  65;  <span class="hljs-comment">#长连接超时时间，单位是秒</span><br> server &#123; <span class="hljs-comment">#设置一个虚拟机主机，可以包含自己的全局快，同时也可以包含多个location模块。比如本虚拟机监听的端口、本虚拟机的名称和IP配置，多个server 可以使用一个端口，比如都使用80端口提供web服务、</span><br>   listen    80;  <span class="hljs-comment">#配置server监听的端口</span><br>   server_name localhost; <span class="hljs-comment">#本server的名称，当访问此名称的时候nginx会调用当前serevr内部的配置进程匹配。</span><br>   location / &#123; <span class="hljs-comment">#location其实是server的一个指令，为nginx服务器提供比较多而且灵活的指令，都是在location中体现的，主要是基于nginx接受到的请求字符串，对用户请求的UIL进行匹配，并对特定的指令进行处理，包括地址重定向、数据缓存和应答控制等功能都是在这部分实现，另外很多第三方模块的配置也是在location模块中配置。</span><br>     root  html; <span class="hljs-comment">#相当于默认页面的目录名称，默认是安装目录的相对路径，可以使用绝对路径配置。</span><br>     index index.html index.htm; <span class="hljs-comment">#默认的页面文件名称</span><br>   &#125;<br>   error_page  500 502 503 504 /50x.html; <span class="hljs-comment">#错误页面的文件名称</span><br>   location = /50x.html &#123; <span class="hljs-comment">#location处理对应的不同错误码的页面定义到/50x.html，这个跟对应其server中定义的目录下。</span><br>     root  html;  <span class="hljs-comment">#定义默认页面所在的目录</span><br>   &#125;<br> &#125;<br> <br><span class="hljs-comment">#和邮件相关的配置</span><br><span class="hljs-comment">#mail &#123;</span><br><span class="hljs-comment">#        ...</span><br><span class="hljs-comment">#    &#125;     mail 协议相关配置段</span><br><br><span class="hljs-comment">#tcp代理配置，1.9版本以上支持</span><br><span class="hljs-comment">#stream &#123;</span><br><span class="hljs-comment">#        ...</span><br><span class="hljs-comment">#    &#125;    stream 服务器相关配置段</span><br><br><span class="hljs-comment">#导入其他路径的配置文件</span><br><span class="hljs-comment">#include /apps/nginx/conf.d/*.conf</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="1-4-全局配置"><a href="#1-4-全局配置" class="headerlink" title="1.4 全局配置"></a>1.4 全局配置</h2><p>Main 全局配置段常见的配置指令分类</p>
<ul>
<li>正常运行必备的配置</li>
<li>优化性能相关的配置</li>
<li>用于调试及定位问题相关的配置</li>
<li>事件驱动相关的配置</li>
</ul>
<p>全局配置说明：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">user</span> nginx nginx; <span class="hljs-comment">#启动Nginx工作进程的用户和组</span><br><span class="hljs-attribute">worker_processes</span> [number | auto]; <span class="hljs-comment">#启动Nginx工作进程的数量,一般设为和CPU核心数相同</span><br><span class="hljs-attribute">worker_cpu_affinity</span> <span class="hljs-number">00000001</span> <span class="hljs-number">00000010</span> <span class="hljs-number">00000100</span> <span class="hljs-number">00001000</span>; <span class="hljs-comment">#将Nginx工作进程绑定到指定的CPU核心，默认Nginx是不进行进程绑定的，绑定并不是意味着当前nginx进程独占以一核心CPU，但是可以保证此进程不会运行在其他核心上，这就极大减少了nginx的工作进程在不同的cpu核心上的来回跳转，减少了CPU对进程的资源分配与回收以及内存管理等，因此可以有效的提升nginx服务器的性能。</span><br><span class="hljs-attribute">CPU</span> MASK: <span class="hljs-number">00000001</span>：<span class="hljs-number">0</span>号CPU<br>          <span class="hljs-number">00000010</span>：<span class="hljs-number">1</span>号CPU<br>                       <span class="hljs-number">10000000</span>：<span class="hljs-number">7</span>号CPU<br><span class="hljs-comment">#示例:</span><br>worker_cpu_affinity <span class="hljs-number">0001</span> <span class="hljs-number">0010</span> <span class="hljs-number">0100</span> <span class="hljs-number">1000</span>;第0号---第3号<span class="hljs-attribute">CPU</span><br>worker_cpu_affinity <span class="hljs-number">0101</span> <span class="hljs-number">1010</span><br><br><span class="hljs-comment">#示例</span><br>worker_processes  <span class="hljs-number">4</span>;<br><span class="hljs-attribute">worker_cpu_affinity</span> <span class="hljs-number">00000010</span> <span class="hljs-number">00001000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">10000000</span>;<br><span class="hljs-comment"># ps axo pid,cmd,psr | grep nginx</span><br>31093 nginx: <span class="hljs-attribute">master</span> process /apps  <span class="hljs-number">1</span><br><span class="hljs-number">34474</span> nginx: worker process     <span class="hljs-number">1</span><br><span class="hljs-number">34475</span> nginx: worker process     <span class="hljs-number">3</span><br><span class="hljs-number">34476</span> nginx: worker process     <span class="hljs-number">5</span><br><span class="hljs-number">34477</span> nginx: worker process     <span class="hljs-number">7</span><br><span class="hljs-number">35751</span> grep nginx<br><br><span class="hljs-comment">#错误日志记录配置，语法：error_log file [debug | info | notice | warn | error |crit | alert | emerg]</span><br><span class="hljs-comment">#error_log logs/error.log;</span><br><span class="hljs-comment">#error_log logs/error.log notice;</span><br>error_log /apps/nginx/logs/error.log <span class="hljs-literal">error</span>;<br><br><span class="hljs-comment">#pid文件保存路径</span><br><span class="hljs-attribute">pid</span>    /apps/nginx/logs/nginx.pid;<br><span class="hljs-attribute">worker_priority</span> <span class="hljs-number">0</span>; <span class="hljs-comment">#工作进程优先级，-20~20(19)</span><br><span class="hljs-attribute">worker_rlimit_nofile</span> <span class="hljs-number">65536</span>; <span class="hljs-comment">#所有worker进程能打开的文件数量上限,包括:Nginx的所有连接（例如与代理服务器的连接等），而不仅仅是与客户端的连接,另一个考虑因素是实际的并发连接数不能超过系统级别的最大打开文件数的限制.最好与ulimit -n 或者limits.conf的值保持一致,</span><br><span class="hljs-comment">#修改pam限制</span><br><span class="hljs-comment"># cat /etc/security/limits.conf</span><br>*        <span class="hljs-attribute">soft</span>  nofile      <span class="hljs-number">1000000</span><br>*        hard  nofile      <span class="hljs-number">1000000</span><br><br><span class="hljs-comment"># watch -n1 &#x27;ps -axo pid,cmd,nice | grep nginx&#x27; #验证进程优先级</span><br><br>daemon <span class="hljs-literal">off</span>;  <span class="hljs-comment">#前台运行Nginx服务用于测试、docker等环境。</span><br><span class="hljs-attribute">master_process</span> <span class="hljs-literal">off</span>|<span class="hljs-literal">on</span>; <span class="hljs-comment">#是否开启Nginx的master-worker工作模式，仅用于开发调试场景,默认为on</span><br><br><span class="hljs-section">events</span> &#123;<br> <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">65536</span>;  <span class="hljs-comment">#设置单个工作进程的最大并发连接数</span><br> <span class="hljs-attribute">use</span> <span class="hljs-literal">epoll</span>; <span class="hljs-comment">#使用epoll事件驱动，Nginx支持众多的事件驱动，比如:select、poll、epoll，只能设置在events模块中设置。</span><br> <span class="hljs-attribute">accept_mutex</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#on为同一时刻一个请求轮流由work进程处理,而防止被同时唤醒所有worker,避免多个睡眠进程被唤醒的设置，默认为off，新请求会唤醒所有worker进程,此过程也称为&quot;惊群&quot;，因此nginx刚安装完以后要进行适当的优化。建议设置为on</span><br> <span class="hljs-attribute">multi_accept</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#ON时Nginx服务器的每个工作进程可以同时接受多个新的网络连接，此指令默认为off，即默认为一个工作进程只能一次接受一个新的网络连接，打开后几个同时接受多个。建议设置为on</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>范例：实现nginx的高并发配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># yum install -y httpd-tools</span><br><span class="hljs-comment"># ulimit -n 102400</span><br><span class="hljs-comment"># while true;do ab -c 5000 -n 10000 http://10.0.0.7/;sleep 0.5;done</span><br><br><span class="hljs-comment">#默认配置不支持高并发,会出现以下错误日志</span><br><span class="hljs-comment"># tail /apps/nginx/logs/error.log</span><br>2020/09/24 21:19:33 [crit] 41006<span class="hljs-comment">#0: *1105860 open() &quot;/apps/nginx/html/50x.html&quot;failed (24: Too many open files), client: 10.0.0.7, server: localhost, request:&quot;GET / HTTP/1.0&quot;, host: &quot;10.0.0.7&quot;</span><br>2020/09/24 21:19:33 [crit] 41006<span class="hljs-comment">#0: accept4() failed (24: Too many open files)</span><br>2020/09/24 21:19:33 [crit] 41006<span class="hljs-comment">#0: *1114177 open() &quot;/apps/nginx/html/index.html&quot; failed (24: Too many open files), client: 10.0.0.7, server: localhost, request: &quot;GET / HTTP/1.0&quot;, host: &quot;10.0.0.7&quot;</span><br><br><span class="hljs-comment">#修改配置，如果已经修改或了就不用再添加了</span><br><span class="hljs-comment"># vim /etc/security/limits.conf</span><br>*  - nproc 100000<br><br><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf </span><br>worker_rlimit_nofile 100000; <span class="hljs-comment">#放在全局配置中</span><br><br><span class="hljs-comment"># systemctl restart nginx</span><br></code></pre></td></tr></table></figure>

<h2 id="1-5-http配置块"><a href="#1-5-http配置块" class="headerlink" title="1.5 http配置块"></a>1.5 http配置块</h2><p><strong>http 协议相关的配置结构</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">http</span> &#123;<br>    ...;<br>    ...;  <span class="hljs-comment">#各server的公共配置</span><br>    <span class="hljs-section">server</span> &#123;   <span class="hljs-comment">#每个server用于定义一个虚拟主机,第一个server为默认虚拟服务器</span><br>        ...;<br>    &#125;<br>    <span class="hljs-section">server</span> &#123;  <br>        ...;<br>        <span class="hljs-attribute">server_name</span> ; <span class="hljs-comment">#虚拟主机名</span><br>        <span class="hljs-attribute">root</span> ;  <span class="hljs-comment">#主目录</span><br>        <span class="hljs-attribute">alias</span> ;   <span class="hljs-comment">#路径别名</span><br>        <span class="hljs-attribute">location</span> [OPERATOR] URL &#123;   <span class="hljs-comment">#指定URL的特性</span><br>            ...;<br>            <span class="hljs-attribute">if</span> CONDITION &#123;<br>                ...;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>http 协议配置说明</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>    mime.types; <span class="hljs-comment">#导入支持的文件类型,是相对于/apps/nginx/conf的目录</span><br>    <span class="hljs-attribute">default_type</span> application/octet-stream; <span class="hljs-comment">#除mime.types中文件类型外,设置其它文件默认类型，访问其它类型时会提示下载不匹配的类型文件</span><br><span class="hljs-comment">#日志配置部分</span><br>    <span class="hljs-comment">#log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>    <span class="hljs-comment">#         &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>    <span class="hljs-comment">#         &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br>    <span class="hljs-comment">#access_log logs/access.log main;</span><br><span class="hljs-comment">#自定义优化参数</span><br>    <span class="hljs-attribute">sendfile</span>    <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment">#tcp_nopush   on; #在开启了sendfile的情况下，合并请求后统一发送给客户端。</span><br>    <span class="hljs-comment">#tcp_nodelay  off; #在开启了keepalived模式下的连接是否启用TCP_NODELAY选项，当为off时，延迟0.2s发送，默认On时，不延迟发送，立即发送用户响应报文。</span><br>    <span class="hljs-comment">#keepalive_timeout 0;</span><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span> <span class="hljs-number">65</span>; <span class="hljs-comment">#设置会话保持时间,第二个值为响应首部:keep-Alived:timeout=65,可以和第一个值不同</span><br>    <span class="hljs-comment">#gzip on; #开启文件压缩</span><br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>    <span class="hljs-number">80</span>; <span class="hljs-comment">#设置监听地址和端口</span><br>        <span class="hljs-attribute">server_name</span> localhost; <span class="hljs-comment">#设置server name，可以以空格隔开写多个并支持正则表达式，如:*.rlin.com www.rlin.* ~^www\d+\.rlin\.com$ default_server</span><br>        <span class="hljs-comment">#charset koi8-r; #设置编码格式，默认是俄语格式，建议改为utf-8</span><br>        <span class="hljs-comment">#access_log logs/host.access.log main;</span><br>        <span class="hljs-attribute">location</span> / &#123;<br>            <span class="hljs-attribute">root</span>  html;<br>            <span class="hljs-attribute">index</span> index.html index.htm;<br>        &#125;<br>        <span class="hljs-comment">#error_page 404       /404.html;</span><br>        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span><br>        <br>        <span class="hljs-attribute">error_page</span>  <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span> /50x.html; <span class="hljs-comment">#定义错误页面</span><br>        <span class="hljs-attribute">location</span> = /50x.html &#123;<br>            <span class="hljs-attribute">root</span>  html;<br>        &#125;<br>        <span class="hljs-comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment">#location ~ \.php$ &#123; #以http的方式转发php请求到指定web服务器</span><br>        <span class="hljs-comment">#  proxy_pass  http://127.0.0.1;</span><br>        <span class="hljs-comment">#&#125;</span><br>        <span class="hljs-comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment">#location ~ \.php$ &#123; #以fastcgi的方式转发php请求到php处理</span><br>        <span class="hljs-comment">#  root      html;</span><br>        <span class="hljs-comment">#  fastcgi_pass  127.0.0.1:9000;</span><br>        <span class="hljs-comment">#  fastcgi_index index.php;</span><br>        <span class="hljs-comment">#  fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;</span><br>        <span class="hljs-comment">#  include    fastcgi_params;</span><br>        <span class="hljs-comment">#&#125;</span><br>        <span class="hljs-comment"># deny access to .htaccess files, if Apache&#x27;s document root</span><br>        <span class="hljs-comment"># concurs with nginx&#x27;s one</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment">#location ~ /\.ht &#123; #拒绝web形式访问指定文件，如很多的网站都是通过.htaccess文件来改变自己的重定向等功能。</span><br>        <span class="hljs-comment">#  deny all;</span><br>        <span class="hljs-comment">#&#125;</span><br>        <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /passwd.html</span> &#123;<br>            <span class="hljs-attribute">deny</span> all;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment"># another virtual host using mix of IP-, name-, and port-based configuration</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#server &#123; #自定义虚拟server</span><br>    <span class="hljs-comment">#  listen    8000;</span><br>    <span class="hljs-comment">#  listen    somename:8080;</span><br>    <span class="hljs-comment">#  server_name somename alias another.alias;</span><br>    <span class="hljs-comment">#  location / &#123;</span><br>    <span class="hljs-comment">#    root  html;</span><br>    <span class="hljs-comment">#    index index.html index.htm; #指定默认网页文件，此指令由ngx_http_index_module模块提供</span><br>    <span class="hljs-comment">#  &#125;</span><br>    <span class="hljs-comment">#&#125;</span><br>    <span class="hljs-comment"># HTTPS server</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#server &#123; #https服务器配置</span><br>    <span class="hljs-comment">#  listen    443 ssl;</span><br>    <span class="hljs-comment">#  server_name localhost;</span><br>    <span class="hljs-comment">#  ssl_certificate   cert.pem;</span><br>    <span class="hljs-comment">#  ssl_certificate_key cert.key;</span><br>    <span class="hljs-comment">#  ssl_session_cache  shared:SSL:1m;</span><br>    <span class="hljs-comment">#  ssl_session_timeout 5m;</span><br>    <span class="hljs-comment">#  ssl_ciphers HIGH:!aNULL:!MD5;</span><br>    <span class="hljs-comment">#  ssl_prefer_server_ciphers on;</span><br>    <span class="hljs-comment">#  location / &#123;</span><br>    <span class="hljs-comment">#    root  html;</span><br>    <span class="hljs-comment">#    index index.html index.htm;</span><br>    <span class="hljs-comment">#  &#125;</span><br>    <span class="hljs-comment">#&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="1-5-1-MIME"><a href="#1-5-1-MIME" class="headerlink" title="1.5.1 MIME"></a>1.5.1 MIME</h3><p><strong>MIME参考文档</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types<br></code></pre></td></tr></table></figure>

<p><strong>设置MIME</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#在响应报文中将指定的文件扩展名映射至MIME对应的类型</span><br><span class="hljs-attribute">include</span>      /etc/nginx/mime.types;<br><span class="hljs-attribute">default_type</span>   application/octet-stream;<span class="hljs-comment">#除mime.types中的类型外，指定其它文件的默认MIME类型，浏览器一般会提示下载</span><br><span class="hljs-section">types</span> &#123;<br>    text/<span class="hljs-attribute">html</span> html;<br>    image/<span class="hljs-attribute">gif</span> gif;<br>    image/<span class="hljs-attribute">jpeg</span> jpg;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="1-5-2-范例：识别php文件为text-html"><a href="#1-5-2-范例：识别php文件为text-html" class="headerlink" title="1.5.2 范例：识别php文件为text/html"></a>1.5.2 范例：识别php文件为text/html</h3><h4 id="1-5-2-1-添加PHP网页"><a href="#1-5-2-1-添加PHP网页" class="headerlink" title="1.5.2.1 添加PHP网页"></a>1.5.2.1 添加PHP网页</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">vim /apps/nginx/html/test.php<br><span class="hljs-meta">&lt;?php</span><br>phpinfo();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="1-5-2-2-测试PHP网页"><a href="#1-5-2-2-测试PHP网页" class="headerlink" title="1.5.2.2 测试PHP网页"></a>1.5.2.2 测试PHP网页</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># curl 10.0.0.101/test.php -I</span><br>HTTP/1.1 200 OK<br>Server: nginx/1.16.1<br>Date: Thu, 11 Feb 2021 03:30:25 GMT<br>Content-Type: application/octet-stream<br>Content-Length: 20<br>Last-Modified: Thu, 11 Feb 2021 03:29:05 GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;6024a481-14&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure>

<h4 id="1-5-2-3-修改nginx配置文件"><a href="#1-5-2-3-修改nginx配置文件" class="headerlink" title="1.5.2.3 修改nginx配置文件"></a>1.5.2.3 修改nginx配置文件</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br><span class="hljs-section">http</span> &#123;<br> <span class="hljs-attribute">include</span>    mime.types;<br> <span class="hljs-attribute">default_type</span> text/html;<br> ......<br> &#125;<br>......<br></code></pre></td></tr></table></figure>

<h4 id="1-5-2-4-重启nginx"><a href="#1-5-2-4-重启nginx" class="headerlink" title="1.5.2.4 重启nginx"></a>1.5.2.4 重启nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># nginx -t</span><br><span class="hljs-comment"># nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h4 id="1-5-2-5-再次测试"><a href="#1-5-2-5-再次测试" class="headerlink" title="1.5.2.5 再次测试"></a>1.5.2.5 再次测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># curl 10.0.0.101/test.php -I</span><br>HTTP/1.1 200 OK<br>Server: nginx/1.16.1<br>Date: Thu, 11 Feb 2021 03:42:52 GMT<br>Content-Type: text/html<br>Content-Length: 20<br>Last-Modified: Thu, 11 Feb 2021 03:29:05 GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;6024a481-14&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure>

<h3 id="1-5-3-指定响应报文server首部"><a href="#1-5-3-指定响应报文server首部" class="headerlink" title="1.5.3 指定响应报文server首部"></a>1.5.3 指定响应报文server首部</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#是否在响应报文中的Content-Type显示指定的字符集，默认off不显示</span><br>charset charset | off;<br><br><span class="hljs-comment">#示例</span><br>charset utf-8;<br><br><span class="hljs-comment">#是否在响应报文的Server首部显示nginx版本</span><br>server_tokens on | off | build | string;<br></code></pre></td></tr></table></figure>
<h4 id="1-5-3-1-范例-修改server字段"><a href="#1-5-3-1-范例-修改server字段" class="headerlink" title="1.5.3.1 范例: 修改server字段"></a>1.5.3.1 范例: 修改server字段</h4><p>如果想自定义响应报文的nginx版本信息，需要修改源码文件，重新编译。</p>
<p>如果server_tokens on，修改 src/core/nginx.h 修改第13-14行，如下示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim ..src/core/nginx.h</span><br><span class="hljs-comment">#define NGINX_VERSION   &quot;1.68.9&quot;</span><br><span class="hljs-comment">#define NGINX_VER     &quot;rlin/&quot; NGINX_VERSION</span><br></code></pre></td></tr></table></figure>
<p>如果server_tokens off，修改 src/http/ngx_http_header_filter_module.c</p>
<p>第49行，把其中的nginx改为自己想要的文字即可,如：rlin;如下示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim ..src/http/ngx_http_header_filter_module.c</span><br>static char ngx_http_server_string[] = <span class="hljs-string">&quot;Server: rlin&quot;</span> CRLF;<br></code></pre></td></tr></table></figure>

<h4 id="1-5-3-2-范例-修改-Server-头部信息"><a href="#1-5-3-2-范例-修改-Server-头部信息" class="headerlink" title="1.5.3.2 范例: 修改 Server 头部信息"></a>1.5.3.2 范例: 修改 Server 头部信息</h4><h5 id="1-5-3-2-1-测试-server-头部信息1"><a href="#1-5-3-2-1-测试-server-头部信息1" class="headerlink" title="1.5.3.2.1 测试 server 头部信息1"></a>1.5.3.2.1 测试 server 头部信息1</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># curl -I www.rlinpc.net</span><br>HTTP/1.1 200 OK<br>Server: nginx/1.16.1<br>Date: Fri, 12 Feb 2021 02:00:24 GMT<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 8<br>Last-Modified: Tue, 09 Feb 2021 03:36:10 GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;6022032a-8&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure>

<h5 id="1-5-3-2-2-修改版本信息"><a href="#1-5-3-2-2-修改版本信息" class="headerlink" title="1.5.3.2.2 修改版本信息"></a>1.5.3.2.2 修改版本信息</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http"># vim /usr/local/src/nginx-1.16.1/src/core/nginx.h<br>#define NGINX_VERSION      &quot;9.99&quot;<br>#define NGINX_VER          &quot;rlin/&quot; NGINX_VERSION<br></code></pre></td></tr></table></figure>

<h5 id="1-5-3-2-3-重新编译nginx"><a href="#1-5-3-2-3-重新编译nginx" class="headerlink" title="1.5.3.2.3 重新编译nginx"></a>1.5.3.2.3 重新编译nginx</h5><p><strong>使用nginx -V获取当时编译的参数重新编译一次</strong></p>
<p>略</p>
<h5 id="1-5-3-2-4-测试-server-头部信息2"><a href="#1-5-3-2-4-测试-server-头部信息2" class="headerlink" title="1.5.3.2.4 测试 server 头部信息2"></a>1.5.3.2.4 测试 server 头部信息2</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># curl -I www.rlinpc.net</span><br>HTTP/1.1 200 OK<br>Server: rlin/9.99 <span class="hljs-comment">#这里的Server发生了变化</span><br>Date: Fri, 12 Feb 2021 02:14:15 GMT<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 8<br>Last-Modified: Tue, 09 Feb 2021 03:36:10 GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;6022032a-8&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure>

<h5 id="1-5-3-2-5-再次修改版本信息"><a href="#1-5-3-2-5-再次修改版本信息" class="headerlink" title="1.5.3.2.5 再次修改版本信息"></a>1.5.3.2.5 再次修改版本信息</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /usr/local/src/nginx-1.16.1/src/http/ngx_http_header_filter_module.c</span><br>static u_char ngx_http_server_string[] = <span class="hljs-string">&quot;Server: rlin-nginx&quot;</span> CRLF;<br></code></pre></td></tr></table></figure>

<h5 id="1-5-3-2-6-重新编译nginx"><a href="#1-5-3-2-6-重新编译nginx" class="headerlink" title="1.5.3.2.6 重新编译nginx"></a>1.5.3.2.6 重新编译nginx</h5><p>略</p>
<h5 id="1-5-3-2-7-修改nginx配置文件"><a href="#1-5-3-2-7-修改nginx配置文件" class="headerlink" title="1.5.3.2.7 修改nginx配置文件"></a>1.5.3.2.7 修改nginx配置文件</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.c/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="1-5-3-2-8-重启nginx"><a href="#1-5-3-2-8-重启nginx" class="headerlink" title="1.5.3.2.8 重启nginx"></a>1.5.3.2.8 重启nginx</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h5 id="1-5-3-2-9-测试-server-头部信息3"><a href="#1-5-3-2-9-测试-server-头部信息3" class="headerlink" title="1.5.3.2.9 测试 server 头部信息3"></a>1.5.3.2.9 测试 server 头部信息3</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># curl -I www.rlinpc.net</span><br>HTTP/1.1 200 OK<br>Server: rlin-nginx <span class="hljs-comment">#server 再次发生改变</span><br>Date: Fri, 12 Feb 2021 02:23:55 GMT<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 8<br>Last-Modified: Tue, 09 Feb 2021 03:36:10 GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;6022032a-8&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure>
<h2 id="1-6-核心配置示例"><a href="#1-6-核心配置示例" class="headerlink" title="1.6 核心配置示例"></a>1.6 核心配置示例</h2><p>基于不同的IP、不同的端口以及不用得域名实现不同的虚拟主机，依赖于核心模块<code>ngx_http_core_module</code>实现。</p>
<p><strong>多虚拟主机展示</strong></p>
<h3 id="1-6-1-新建一个-PC-web站点"><a href="#1-6-1-新建一个-PC-web站点" class="headerlink" title="1.6.1 新建一个 PC web站点"></a>1.6.1 新建一个 PC web站点</h3><h4 id="1-6-1-1-定义子配置文件路径"><a href="#1-6-1-1-定义子配置文件路径" class="headerlink" title="1.6.1.1 定义子配置文件路径"></a>1.6.1.1 定义子配置文件路径</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir /apps/nginx/conf/conf.d</span><br></code></pre></td></tr></table></figure>

<h4 id="1-6-1-2-修改配置文件使nginx能够读取该文件夹的子配置文件"><a href="#1-6-1-2-修改配置文件使nginx能够读取该文件夹的子配置文件" class="headerlink" title="1.6.1.2 修改配置文件使nginx能够读取该文件夹的子配置文件"></a>1.6.1.2 修改配置文件使nginx能够读取该文件夹的子配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /apps/nginx/conf/nginx.conf<br>http &#123;<br>  ......;<br>  <span class="hljs-comment">#在http内添加此行即可</span><br>  include /apps/nginx/conf/conf.d/*.conf;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-6-1-3-添加子配置文件"><a href="#1-6-1-3-添加子配置文件" class="headerlink" title="1.6.1.3 添加子配置文件"></a>1.6.1.3 添加子配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#创建PC网站配置 </span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br>server &#123;<br>    listen     80;<br>    server_name www.rlinpc.net;<br>    charset utf-8;<br>    server_tokens off;<br>    location / &#123;<br>        root    /data/nginx/html/pc;<br>        index   index.html index.htm;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-6-1-4-创建网页文件夹"><a href="#1-6-1-4-创建网页文件夹" class="headerlink" title="1.6.1.4 创建网页文件夹"></a>1.6.1.4 创建网页文件夹</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -p /data/nginx/html/pc</span><br></code></pre></td></tr></table></figure>

<h4 id="1-6-1-5-给nginx用户授权"><a href="#1-6-1-5-给nginx用户授权" class="headerlink" title="1.6.1.5 给nginx用户授权"></a>1.6.1.5 给nginx用户授权</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># chown -R nginx.nginx /data/nginx/</span><br></code></pre></td></tr></table></figure>

<h4 id="1-6-1-6-添加网页"><a href="#1-6-1-6-添加网页" class="headerlink" title="1.6.1.6 添加网页"></a>1.6.1.6 添加网页</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># echo &quot;rlin的PC网站&quot; &gt; /data/nginx/html/pc/index.html</span><br></code></pre></td></tr></table></figure>

<h4 id="1-6-1-7-检查语法并重启"><a href="#1-6-1-7-检查语法并重启" class="headerlink" title="1.6.1.7 检查语法并重启"></a>1.6.1.7 检查语法并重启</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h4 id="1-6-1-8-访问测试"><a href="#1-6-1-8-访问测试" class="headerlink" title="1.6.1.8 访问测试"></a>1.6.1.8 访问测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#Linux访问</span><br><span class="hljs-comment"># vim /etc/hosts</span><br>10.0.0.101 www.rlinpc.net<br><br><span class="hljs-comment"># curl www.rlinpc.net</span><br><br><span class="hljs-comment">#浏览器访问</span><br>C:\WINDOWS\System32\drivers\etc\hosts<br><span class="hljs-comment">#添加</span><br>10.0.0.101 www.rlinpc.net<br><span class="hljs-comment">#浏览器访问 www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h3 id="1-6-2-新建一个Mobile-web站点"><a href="#1-6-2-新建一个Mobile-web站点" class="headerlink" title="1.6.2 新建一个Mobile web站点"></a>1.6.2 新建一个Mobile web站点</h3><h4 id="1-6-2-1-添加子配置文件"><a href="#1-6-2-1-添加子配置文件" class="headerlink" title="1.6.2.1 添加子配置文件"></a>1.6.2.1 添加子配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /app/snginx/conf/conf.d/mobile.conf</span><br>server &#123;<br>listen     80;<br>    server_name www.rlinmobile.net;<br>    charset utf-8;<br>    location / &#123;<br>        root    /data/nginx/html/mobile;<br>        index   index.html index.htm;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-6-2-2-创建网页文件夹"><a href="#1-6-2-2-创建网页文件夹" class="headerlink" title="1.6.2.2 创建网页文件夹"></a>1.6.2.2 创建网页文件夹</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -p /data/nginx/html/mobile</span><br></code></pre></td></tr></table></figure>

<h4 id="1-6-2-3-创建网页文件"><a href="#1-6-2-3-创建网页文件" class="headerlink" title="1.6.2.3 创建网页文件"></a>1.6.2.3 创建网页文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># echo &quot;rlin mobile web&quot; &gt; /data/nginx/html/mobile/index.html</span><br></code></pre></td></tr></table></figure>

<h4 id="1-6-2-4-检查语法并重新加载nginx"><a href="#1-6-2-4-检查语法并重新加载nginx" class="headerlink" title="1.6.2.4 检查语法并重新加载nginx"></a>1.6.2.4 检查语法并重新加载nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h4 id="1-6-2-5-访问测试"><a href="#1-6-2-5-访问测试" class="headerlink" title="1.6.2.5 访问测试"></a>1.6.2.5 访问测试</h4><p><strong>注意：先修改hosts文件</strong></p>
<p>浏览器访问：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">www.rlinmobile.net<br></code></pre></td></tr></table></figure>
<h3 id="1-6-3-root与alias"><a href="#1-6-3-root与alias" class="headerlink" title="1.6.3 root与alias"></a>1.6.3 root与alias</h3><p><strong>root与alias使用的区别：</strong></p>
<ul>
<li>root：指定web的家目录，在定义location的时候，文件的绝对路径等于 <strong>root+location</strong></li>
<li>alias：定义路径别名，会把访问的路径重新定义到其指定的路径</li>
</ul>
<h5 id="root使用范例："><a href="#root使用范例：" class="headerlink" title="root使用范例："></a>root使用范例：</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /about &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc; <span class="hljs-comment">#必须要在html目录中创建一个about目录才可以访问，否则报错。</span><br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># mkdir -p /data/nginx/html/pc/about</span><br><span class="hljs-comment"># echo about &gt; /data/nginx/html/pc/about/index.html</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#访问测试：浏览器访问 www.rlinpc.nets/about/index.html</span><br></code></pre></td></tr></table></figure>

<h5 id="alias使用范例"><a href="#alias使用范例" class="headerlink" title="alias使用范例"></a>alias使用范例</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /about &#123; <span class="hljs-comment">#使用alias的时候uri后面如果加了斜杠则下面的路径配置必须加斜杠，否则403</span><br>        <span class="hljs-attribute">alias</span> /data/nginx/html/pc; <span class="hljs-comment">#当访问about的时候，会显示alias定义的/data/nginx/html/pc里面的内容。</span><br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>&#125;<br><br>重启Nginx并访问测试<br>http://www.rlinpc.net/about/index.<span class="hljs-attribute">html</span> <span class="hljs-comment">#访问指定文件资源</span><br></code></pre></td></tr></table></figure>
<h2 id="1-7-location的详细使用"><a href="#1-7-location的详细使用" class="headerlink" title="1.7 location的详细使用"></a>1.7 location的详细使用</h2><p>在没有使用正则表达式的时候，nginx会先在server中的多个location选取匹配度最高的一个uri，uri是用户请求的字符串，即域名后面的web文件路径，然后使用该location模块中的正则url和字符串，如果匹配成功就结束搜索，并使用此location处理此请求。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">语法规则： location [=|~|~*|^~] /uri/ &#123; … &#125;<br>=  <span class="hljs-comment">#用于标准uri前，需要请求字串与uri精确匹配，如果匹配成功就停止向下匹配并立即处理请求。</span><br>~  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且区分大小写，并且匹配</span><br>!~  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且区分大小写，并且不匹配</span><br>~*  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且不区分大写，并且匹配</span><br>!~* <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且不区分大小写,并且不匹配</span><br>^~  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且匹配以什么开头</span><br>$  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且匹配以什么结尾</span><br>\  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且转义字符。可以转. * ?等</span><br>*  <span class="hljs-comment">#用于标准uri前，表示包含正则表达式并且代表任意长度的任意字符</span><br></code></pre></td></tr></table></figure>

<h3 id="1-7-1-匹配案例-精确匹配"><a href="#1-7-1-匹配案例-精确匹配" class="headerlink" title="1.7.1 匹配案例-精确匹配"></a>1.7.1 匹配案例-精确匹配</h3><p>在server部分使用location配置一个web界面，要求：当访问nginx 服务器的/logo的时候要显示指定html文件的内容</p>
<p><strong>精确匹配一般用于匹配组织的logo等相对固定的URL，匹配优先级最高</strong></p>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span>  &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br>    <span class="hljs-attribute">location</span> = /logo.jpg&#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/static;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#上传logo.jpg图片到/data/nginx/static，重启Nginx并访问测试</span><br><span class="hljs-comment">#浏览器访问(在window里)：www.rlinpc.net/logo.jpg</span><br></code></pre></td></tr></table></figure>
<h3 id="1-7-2-匹配案例-区分大小写"><a href="#1-7-2-匹配案例-区分大小写" class="headerlink" title="1.7.2 匹配案例-区分大小写"></a>1.7.2 匹配案例-区分大小写</h3><p>~ 实现区分大小写的模糊匹配. 以下范例中, 如果访问uri中包含大写字母的JPG，则以下location匹配Ax.jpg条件不成功，因为 ~ 区分大小写，当用户的请求被执行匹配时发现location中定义的是小写的jpg，本次访问的uri匹配失败，后续要么继续往下匹配其他的location（如果有），要么报错给客户端</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#区分大小写</span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /A.?\.txt</span> &#123; <span class="hljs-comment">#匹配字母A开头的jpg图片，后面?表示A后面零次或一个字符</span><br>        <span class="hljs-attribute">root</span> /data/nginx/static;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#重启Nginx并访问测试</span><br><span class="hljs-comment">#将只能访问以小写字符的jpg图片，不能识别大写的JPG结尾的图片</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -r reload</span><br><span class="hljs-comment"># cd /data.nginx/static</span><br><span class="hljs-comment">#存放AA.jpg</span><br><span class="hljs-comment">#存放Aa.jpg</span><br><span class="hljs-comment">#浏览器访问图片</span><br>www.rlinpc.net/AA.<span class="hljs-attribute">jpg</span> (结果访问失败)<br>www.rlinpc.net/Aa.jpg (结果访问成功)<br></code></pre></td></tr></table></figure>
<h3 id="1-7-3-匹配案例-不区分大小写"><a href="#1-7-3-匹配案例-不区分大小写" class="headerlink" title="1.7.3 匹配案例-不区分大小写"></a>1.7.3 匹配案例-不区分大小写</h3><p>~* 用来对用户请求的uri做模糊匹配，uri中无论都是大写、都是小写或者大小写混合，此模式也都会匹配，通常使用此模式匹配用户request中的静态资源并继续做下一步操作,此方式使用较多</p>
<p>注意: 此方式中,对于Linux文件系统上的文件仍然是区分大小写的,如果磁盘文件不存在,仍会提示404</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#选用一下其中一个都可以达到效果</span><br><span class="hljs-comment">#正则表达式匹配</span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* /A.?\.txt</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/static;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#精确匹配指定名称</span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* /aa.jpg</span> &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /opt/nginx/html/image;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#重启Nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -r reload</span><br><br><span class="hljs-attribute">cd</span> /data.nginx/static<br><span class="hljs-comment">#存放AA.txt</span><br><span class="hljs-comment">#存放Aa.txt</span><br><span class="hljs-comment">#存放aA.txt</span><br><span class="hljs-comment">#存放aa.txt</span><br><span class="hljs-comment">#浏览器访问图片</span><br>www.rlinpc.net/AA.txt (结果访问成功)<br>www.rlinpc.net/Aa.txt (结果访问成功)<br>www.rlinpc.net/aa.txt (结果访问成功)<br>www.rlinpc.net/aA.txt (结果访问成功)<br></code></pre></td></tr></table></figure>

<h3 id="1-7-4-匹配案例-URI开头"><a href="#1-7-4-匹配案例-URI开头" class="headerlink" title="1.7.4 匹配案例-URI开头"></a>1.7.4 匹配案例-URI开头</h3><p>范例:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /static &#123;<br>        <span class="hljs-attribute">root</span> /opt/rlin;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment"># mkdir -p /opt/rlin/static&#123;1..3&#125;</span><br><span class="hljs-comment"># echo &quot;static1&quot; &gt; /opt/rlin/static1/index.html</span><br><span class="hljs-comment"># echo &quot;stattic2&quot; &gt; /opt/rlin/static2/index.html</span><br><span class="hljs-comment"># echo &quot;stattic3&quot; &gt; /opt/rlin/static3/index.html</span><br><br><span class="hljs-comment">#浏览器访问</span><br>www.rlinpc.net/<span class="hljs-attribute">static1</span><br>结果：<br>static1<br>www.rlinpc.net/static2<br>结果：<br>static2<br>www.rlinpc.net/static3<br>结果：<br>static3<br></code></pre></td></tr></table></figure>
<h3 id="1-7-5-匹配案例-文件名后缀"><a href="#1-7-5-匹配案例-文件名后缀" class="headerlink" title="1.7.5 匹配案例-文件名后缀"></a>1.7.5 匹配案例-文件名后缀</h3><p><strong>大部分公司都是基于这种模式实现动静分离</strong><br>范例4：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(gif|jpg|jpeg|bmp|png|tiff|tif|ico|wmf|js|css)$</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/static;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125; <br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment"># mkdir /data/nginx/static</span><br><span class="hljs-comment"># cd /data/nginx/static</span><br><span class="hljs-comment">#存放1.jpg文件</span><br><span class="hljs-comment">#存放1.gif文件</span><br><span class="hljs-comment">#存放1.png文件</span><br><span class="hljs-comment">#....</span><br>浏览器访问<br>www.rlinpc.net/1.<span class="hljs-attribute">jpg</span><br>www.rlinpc.net/<span class="hljs-number">1</span>.gif<br>www.rlinpc.net/<span class="hljs-number">1</span>.png<br>.....<br></code></pre></td></tr></table></figure>
<h3 id="1-7-6-匹配案例-优先级"><a href="#1-7-6-匹配案例-优先级" class="headerlink" title="1.7.6 匹配案例-优先级"></a>1.7.6 匹配案例-优先级</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">匹配优先级：=, ^~, ～/～*，/<br>location优先级：(location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location ~,~* 正则顺序) &gt; (location 部分起始路径) &gt; (/)<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* /1.jpg</span> &#123;<br>    <span class="hljs-attribute">root</span> /data/nginx/html/images;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> = /<span class="hljs-number">1</span>.jpg &#123; <span class="hljs-comment">#通常用于精确匹配指定文件，如favicon.ico、employcode.js、index.jsp等</span><br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/static;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#创建文件夹，分别上传1.jpg图片到/data/nginx/html/images和/data/nginx/html/static</span><br><span class="hljs-comment"># mkdir -p /data/nginx/html/images</span><br><span class="hljs-comment"># mkdir -p /data/nginx/html/static</span><br><br><span class="hljs-comment">#重启nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#浏览器访问www.rlinpc.net/1.jpg，结果显示是static里的1.jpg会被调用</span><br></code></pre></td></tr></table></figure>
<h3 id="1-7-7-生产使用案例"><a href="#1-7-7-生产使用案例" class="headerlink" title="1.7.7 生产使用案例"></a>1.7.7 生产使用案例</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#直接匹配网站根会加速Nginx访问处理:</span><br><span class="hljs-attribute">location</span> = / &#123;<br> ......;<br>&#125;<br><span class="hljs-attribute">location</span> / &#123;<br> ......;<br>&#125;<br><br><span class="hljs-comment">#静态资源配置：</span><br><span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /static/ &#123;<br> ......;<br>&#125;<br><span class="hljs-comment"># 或者</span><br><span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(gif|jpg|jpeg|png|css|js|ico)$</span> &#123;<br> ......;<br>&#125;<br><br><span class="hljs-comment">#多应用配置</span><br><span class="hljs-attribute">location</span> <span class="hljs-regexp">~* /app1</span> &#123;<br>  ......;<br>&#125;<br><span class="hljs-attribute">location</span> <span class="hljs-regexp">~* /app2</span> &#123;<br>  ......;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="1-8-Nginx-四层访问控制"><a href="#1-8-Nginx-四层访问控制" class="headerlink" title="1.8 Nginx 四层访问控制"></a>1.8 Nginx 四层访问控制</h2><p>访问控制基于模块<code>ngx_http_access_module</code>实现，可以通过匹配客户端源IP地址进行限制。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> /about &#123;<br>    <span class="hljs-attribute">alias</span> /data/nginx/html/pc;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">deny</span>  <span class="hljs-number">10.0.0.5</span>; <span class="hljs-comment">#决绝某个IP访问</span><br>    <span class="hljs-attribute">allow</span> <span class="hljs-number">10.0.0.101</span>/<span class="hljs-number">24</span>; <span class="hljs-comment">#允许10.0.0.101/24访问</span><br>    <span class="hljs-attribute">allow</span> <span class="hljs-number">10.0.0.102</span>/<span class="hljs-number">16</span>; <span class="hljs-comment">#允许10.0.0.102/16访问</span><br>    <span class="hljs-attribute">allow</span> <span class="hljs-number">2001</span>:0db8::/<span class="hljs-number">32</span>; <span class="hljs-comment">#允许2001:0db8::/32访问</span><br>    <span class="hljs-attribute">deny</span> all;  <span class="hljs-comment">#先允许小部分，再拒绝大部分</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="1-9-nginx账户认证功能（一般用户公司内部）"><a href="#1-9-nginx账户认证功能（一般用户公司内部）" class="headerlink" title="1.9 nginx账户认证功能（一般用户公司内部）"></a>1.9 nginx账户认证功能（一般用户公司内部）</h2><h3 id="1-9-1-安装nginx"><a href="#1-9-1-安装nginx" class="headerlink" title="1.9.1 安装nginx"></a>1.9.1 安装nginx</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install -y httpd-tools -y <span class="hljs-comment">#Centos</span><br>apt install -y apache2-utils -y <span class="hljs-comment">#Ubuntu</span><br></code></pre></td></tr></table></figure>

<h3 id="1-9-2-添加账户密码"><a href="#1-9-2-添加账户密码" class="headerlink" title="1.9.2 添加账户密码"></a>1.9.2 添加账户密码</h3><h4 id="1-9-2-1-首次添加"><a href="#1-9-2-1-首次添加" class="headerlink" title="1.9.2.1 首次添加"></a>1.9.2.1 首次添加</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># htpasswd -cbm /apps/nginx/conf/.htpasswd rlin 123456</span><br><span class="hljs-comment"># cat /apps/nginx/conf/.htpasswd </span><br>rlin:$apr1$USjpH9t3<span class="hljs-variable">$ii</span>.ZijTLeGUiR0CtpGkw7/<br></code></pre></td></tr></table></figure>

<h4 id="1-9-2-2-再次添加"><a href="#1-9-2-2-再次添加" class="headerlink" title="1.9.2.2 再次添加"></a>1.9.2.2 再次添加</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># htpasswd -bm /apps/nginx/conf/.htpasswd ubuntu 123456</span><br><span class="hljs-comment"># cat /apps/nginx/conf/.htpasswd </span><br>rlin:$apr1$USjpH9t3<span class="hljs-variable">$ii</span>.ZijTLeGUiR0CtpGkw7/<br>ubuntu:$apr1$RFmN9kmx<span class="hljs-variable">$W2gL9VWPa1xTCLKPDy6y51</span><br></code></pre></td></tr></table></figure>

<h4 id="1-9-2-3-添加nginx子配置文件"><a href="#1-9-2-3-添加nginx子配置文件" class="headerlink" title="1.9.2.3 添加nginx子配置文件"></a>1.9.2.3 添加nginx子配置文件</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> = /login/ &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">auth_basic</span> <span class="hljs-string">&quot;login password&quot;</span>;<br>        <span class="hljs-attribute">auth_basic_user_file</span> /apps/nginx/conf/.htpasswd;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-9-2-4-创建登录页面"><a href="#1-9-2-4-创建登录页面" class="headerlink" title="1.9.2.4 创建登录页面"></a>1.9.2.4 创建登录页面</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -p /data/nginx/html/pc/login</span><br><span class="hljs-comment"># echo &quot;login page&quot; &gt; /data/nginx/html/pc/login/index.html</span><br></code></pre></td></tr></table></figure>

<h4 id="1-9-2-5-检查语法并重启nginx"><a href="#1-9-2-5-检查语法并重启nginx" class="headerlink" title="1.9.2.5 检查语法并重启nginx"></a>1.9.2.5 检查语法并重启nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h4 id="1-9-2-6-浏览器访问"><a href="#1-9-2-6-浏览器访问" class="headerlink" title="1.9.2.6 浏览器访问"></a>1.9.2.6 浏览器访问</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">www.rlinpc.net/login<br></code></pre></td></tr></table></figure>

<h2 id="1-10-自定义错误页面"><a href="#1-10-自定义错误页面" class="headerlink" title="1.10 自定义错误页面"></a>1.10 自定义错误页面</h2><p>定义错误页，以指定的响应状态码进行响应, 可用位置：http, server, location, if in location</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">error_page code ... [=[response]] uri;<br></code></pre></td></tr></table></figure>
<p>使用步骤：</p>
<ol>
<li>先使用<code>error_page</code>定义错误页的相应码和访问哪个<code>错误页面uri</code></li>
<li>使用<code>location 错误页面uri</code>定义错误页面路径</li>
</ol>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br><span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span> /error.html;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> = /error.html &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/error;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问不存在的页面，如：www.rlinpc.net/12324888.jpg</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br><span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> /40x.html;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> = /40x.html &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/error;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问不存在的页面，如：www.rlinpc.net/12324888.jpg</span><br></code></pre></td></tr></table></figure>
<p>范例：浏览器”截胡”</p>
<p>使用360浏览器访问基于IP的不存在页面时会自动用广告页面代替错误页面</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#404转为302</span><br><span class="hljs-attribute">vim</span> /data/nginx/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> = <span class="hljs-number">302</span> /index.html; <span class="hljs-comment">#这里是跳到主页面</span><br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br>&#125;<br><span class="hljs-comment">#或</span><br><span class="hljs-comment"># vim /data/nginx/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br><span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> = <span class="hljs-number">302</span> /40x.html; <span class="hljs-comment">#这里是跳到40x的错误页面</span><br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> = /40x.html &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/error;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#检查语法并重启nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问不存在的页面，如：www.rlinpc.net/12324888.jpg</span><br></code></pre></td></tr></table></figure>
<h2 id="1-11-自定义错误日志"><a href="#1-11-自定义错误日志" class="headerlink" title="1.11 自定义错误日志"></a>1.11 自定义错误日志</h2><p>语法格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Syntax</span><span class="hljs-punctuation">: </span>error_log file [level];<br><span class="hljs-attribute">Default</span>:<br>error_log logs/error.log error;<br><span class="hljs-attribute">Context</span><span class="hljs-punctuation">: </span>main, http, mail, stream, server, location<br><span class="hljs-attribute">level</span><span class="hljs-punctuation">: </span>debug, info, notice, warn, error, crit, alert, emerg<br></code></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /data/nginx/conf.d/pc.conf</span><br>server&#123;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> /error.html; <span class="hljs-comment">#默认⽬录下⾯创建error.html⻚⾯</span><br>    <span class="hljs-comment">#自定义日志多用于单独统计某个域名的访问量和日志非常有用</span><br>    <span class="hljs-attribute">access_log</span> /apps/nginx/logs/www.rlinpc.net_access.log;<br>    <span class="hljs-attribute">error_log</span> /apps/nginx/logs/www.rlinpc.net_error.log;<br>    <span class="hljs-attribute">location</span> = /error.html&#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#添加错误网页</span><br><span class="hljs-comment"># vim /data/nginx/html/pc/error.html</span><br><span class="hljs-attribute">qq123456789</span><br><span class="hljs-number">404</span><br><br><span class="hljs-comment">#创建日志存放路径</span><br><span class="hljs-comment"># mkdir /apps/nginx/logs   #启动nginx的账号对这个路径要有权限</span><br><br><span class="hljs-comment">#检查语法并重启nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -r reload</span><br><br><span class="hljs-comment">#浏览器访问不存在的页面,并查看 /apps/nginx/log/www.rlinpc.net_error.log 文件</span><br></code></pre></td></tr></table></figure>
<h2 id="1-12-检测文件是否存在"><a href="#1-12-检测文件是否存在" class="headerlink" title="1.12 检测文件是否存在"></a>1.12 检测文件是否存在</h2><p>try_files会按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如果所有文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。只有最后一个参数可以引起一个内部重定向，之前的参数只设置内部URI的指向。最后一个参数是回退URI且必须存在，否则会出现内部500错误。<br>语法格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Syntax</span><span class="hljs-punctuation">: </span>try_files file ... uri;<br>try_files file ... =code;<br><span class="hljs-attribute">Default</span><span class="hljs-punctuation">: </span>—<br><span class="hljs-attribute">Context</span><span class="hljs-punctuation">: </span>server, location<br></code></pre></td></tr></table></figure>
<p>范例：如果不存在页面, 就转到default.html页面</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /data/nginx/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>        <span class="hljs-attribute">try_files</span> $uri $uri.html $uri/index.html /about/default.html;<br>        <span class="hljs-comment">#try_files $uri $uri/index.html $uri.html =489;</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># mkdir -p /data/nginx/html/pc/about</span><br><span class="hljs-comment"># echo &quot;default page&quot; &gt;&gt; /data/nginx/html/pc/about/default.html</span><br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#当访问到http://www.magedu.org/about/xx.html 等不存在的uri会显示default.html，如果是自定义的状态码则会显示在返回数据的状态码中</span><br><br><span class="hljs-comment">#注释default.html行,启用上面489行生效后,再观察结果</span><br><span class="hljs-attribute">vim</span> /data/nginx/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>        <span class="hljs-comment">#try_files $uri  $uri.html $uri/index.html /about/default.html;</span><br>        <span class="hljs-attribute">try_files</span> $uri $uri/index.html $uri.html =<span class="hljs-number">489</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment"># curl -I www.rlinpc.net/about/xx.html</span><br>HTTP/1.1 489 <br>Server: nginx/1.16.1<br>Date: Sun, 14 <span class="hljs-attribute">Feb</span> <span class="hljs-number">2021</span> <span class="hljs-number">04</span>:<span class="hljs-number">01</span>:<span class="hljs-number">41</span> GMT<br>Content-Length: <span class="hljs-number">0</span><br>Connection: keep-alive<br></code></pre></td></tr></table></figure>
<h2 id="1-13-长连接配置"><a href="#1-13-长连接配置" class="headerlink" title="1.13 长连接配置"></a>1.13 长连接配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">keepalive_timeout timeout [header_timeout];  <span class="hljs-comment">#设定保持连接超时时长，0表示禁止长连接，默认为75s，通常配置在http字段作为站点全局配置</span><br>keepalive_requests number;  <span class="hljs-comment">#在一次长连接上所允许请求的资源的最大数量，默认为100次,建议适当调大,比如:500</span><br></code></pre></td></tr></table></figure>
<p>范例:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">keepalive_requests</span> <span class="hljs-number">3</span>;<br><span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span> <span class="hljs-number">60</span>;<br><span class="hljs-comment">#开启长连接后，返回客户端的会话保持时间为60s，单次长连接累计请求达到指定次数请求或65秒就会被断开，后面的60为发送给客户端应答报文头部中显示的超时时间设置为60s：如不设置客户端将不显示超时时间。</span><br><br>Keep-Alive:timeout=60  <span class="hljs-comment">#浏览器收到的服务器返回的报文</span><br><br><span class="hljs-comment">#如果设置为0表示关闭会话保持功能，将如下显示：</span><br>Connection:<span class="hljs-attribute">close</span>  <span class="hljs-comment">#浏览器收到的服务器返回的报文</span><br><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br>server &#123;<br>    <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">keepalive_requests</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-attribute">keepalive_timeout</span> <span class="hljs-number">65</span> <span class="hljs-number">60</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>    /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span>   index.html index.htm;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#检查语法并重启nginx</span><br><span class="hljs-comment"># apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment"># curl www.rlinpc.net -I</span><br>HTTP/1.1 200 <span class="hljs-attribute">OK</span><br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: Sun, <span class="hljs-number">14</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">09</span>:<span class="hljs-number">22</span>:<span class="hljs-number">16</span> GMT<br>Content-Type: text/html<br>Content-Length: <span class="hljs-number">16</span><br>Last-Modified: Sat, <span class="hljs-number">13</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">02</span>:<span class="hljs-number">50</span>:<span class="hljs-number">18</span> GMT<br>Connection: keep-alive<br>Keep-Alive: timeout=<span class="hljs-number">60</span> <span class="hljs-comment">#设置超时时间</span><br>ETag: <span class="hljs-string">&quot;60273e6a-10&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure>
<h2 id="1-14-作为下载服务器配置"><a href="#1-14-作为下载服务器配置" class="headerlink" title="1.14 作为下载服务器配置"></a>1.14 作为下载服务器配置</h2><p><code>ngx_http_autoindex_module</code> 模块处理以斜杠字符 “/“ 结尾的请求，并生成目录列表,可以做为下载服务配置使用<br>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://nginx.org/en/docs/http/ngx_http_autoindex_module.html<br></code></pre></td></tr></table></figure>
<p>相关指令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">autoindex on | off; #自动文件索引功能，默为off<br>autoindex_exact_size on | off;  #计算文件确切大小（单位bytes），off 显示大概大小（单位K、M)，默认on<br>autoindex_localtime on | off ; #显示本机时间而非GMT(格林威治)时间，默认off<br>autoindex_format html | xml | json | jsonp; #显示索引的页面文件风格，默认html<br>limit_rate rate; #限制响应客户端传输速率(除GET和HEAD以外的所有方法)，单位B/s,即bytes/second，默认值0,表示无限制,此指令由ngx_http_core_module提供<br></code></pre></td></tr></table></figure>
<p>范例：实现下载站点</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#注意:download不需要index.html文件</span><br><span class="hljs-comment"># mkdir -p /data/nginx/html/pc/download</span><br><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br>server&#123;<br>    ......<br>        <span class="hljs-attribute">location</span> /download &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc/;<br>        <span class="hljs-attribute">autoindex</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#自动索引功能</span><br>        <span class="hljs-attribute">autoindex_localtime</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#计算文件确切大小，on显示精确大小（单位byte），off只显示大概大小（单位kb、mb、gb）</span><br>        <span class="hljs-comment">#autoindex_localtime off;</span><br>        <span class="hljs-attribute">autoindex_locatime</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#显示本机时间而非GMT（格林威治）时间</span><br>        <span class="hljs-attribute">limit_rate</span> <span class="hljs-number">10k</span>; <span class="hljs-comment">#限制响应给客⼾端的传输速率，单位是bytes/second，默认值0表⽰⽆限制</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#检查并重启nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -r reload</span><br><br><span class="hljs-comment">#创建下载文件夹</span><br><span class="hljs-comment"># mkdir -p /data/nginx/html/pc/download</span><br><span class="hljs-comment">#往/data/nginx/html/pc/download添加文件</span><br><span class="hljs-comment">#访问浏览器www.rlinpc.net/download</span><br></code></pre></td></tr></table></figure>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-download.png" srcset="/blog/img/loading.gif" title="下载页面"></p>
<h2 id="1-15-作为上传服务器"><a href="#1-15-作为上传服务器" class="headerlink" title="1.15 作为上传服务器"></a>1.15 作为上传服务器</h2><p>以下指令控制上传数据：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">1m</span>; <span class="hljs-comment">#设置允许客户端上传单个文件的最大值，默认值为1m,上传文件超过此值会出413错误</span><br><span class="hljs-attribute">client_body_buffer_size</span> size; <span class="hljs-comment">#用于接收每个客户端请求报文的body部分的缓冲区大小;默认16k;超出此大小时，其将被暂存到磁盘上的由下面client_body_temp_path指令所定义的位置</span><br><span class="hljs-attribute">client_body_temp_path</span> path [level1 [level2 [level3]]];<br><span class="hljs-comment">#设定存储客户端请求报文的body部分的临时存储路径及子目录结构和数量，目录名为16进制的数字，使用hash之后的值从后往前截取1位、2位、2位作为目录名</span><br><span class="hljs-attribute">md5sum</span> /data/nginx/html/pc/index.html<br>95f6f65f498c74938064851b1bb <span class="hljs-number">96</span> <span class="hljs-number">3d</span> <span class="hljs-number">4</span> /data/nginx/html/pc/index.html<br><span class="hljs-number">1</span>级目录占<span class="hljs-number">1</span>位<span class="hljs-number">16</span>进制，即<span class="hljs-number">2</span>^<span class="hljs-number">4</span>=<span class="hljs-number">16</span>个目录  <span class="hljs-number">0</span>-f<br><span class="hljs-number">2</span>级目录占<span class="hljs-number">2</span>位<span class="hljs-number">16</span>进制，即<span class="hljs-number">2</span>^<span class="hljs-number">8</span>=<span class="hljs-number">256</span>个目录 <span class="hljs-number">00</span>-ff<br><span class="hljs-number">3</span>级目录占<span class="hljs-number">2</span>位<span class="hljs-number">16</span>进制，即<span class="hljs-number">2</span>^<span class="hljs-number">8</span>=<span class="hljs-number">256</span>个目录 <span class="hljs-number">00</span>-ff<br><br><span class="hljs-comment">#配置示例：</span><br>client_max_body_size <span class="hljs-number">100m</span>; <span class="hljs-comment">#如果太大，上传时会出现下图的413错误,注意:如果php上传,还需要修改php.ini的相关配置</span><br><span class="hljs-attribute">client_body_buffer_size</span> <span class="hljs-number">1024k</span>;<br><span class="hljs-attribute">client_body_temp_path</span>  /apps/nginx/client_body_temp/ <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span>; <span class="hljs-comment">#上传时,Nginx会自动创建相关目录,1 2 2 表示2^4*2^8*2^8=2^20</span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#上传超过nginx指定client_max_body_size值会出413错误</span><br><span class="hljs-comment"># tail /apps/nginx/logs/nginx.access.log</span><br>125.41.184.117 - - [27/Sep/2020:00:09:00 +0800] <span class="hljs-string">&quot;POST /wp-admin/async-upload.php HTTP/1.1&quot;</span> 413 578 <span class="hljs-string">&quot;http://www.rlin.com/wp-admin/post-new.php&quot;</span><br><span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36 Edg/85.0.564.63&quot;</span> <span class="hljs-string">&quot;-&quot;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># tree /apps/nginx/client_body_temp/</span><br>/apps/nginx/client_body_temp/<br>├── 5<br>│  └── 00<br>│    └── 00<br>└── 6<br> └── 00<br>   └── 00<br></code></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nging/conf/nginx.conf</span><br>http&#123;<br>    ......;<br>    <span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">client_body_buffer_size</span> <span class="hljs-number">16k</span>;<br>    <span class="hljs-attribute">client_body_temp_path</span> /apps/nginx/temp <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span>; <span class="hljs-comment">#/apps/nginx/temp要注意权限</span><br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>
<h2 id="1-16-其他配置"><a href="#1-16-其他配置" class="headerlink" title="1.16 其他配置"></a>1.16 其他配置</h2><h3 id="1-16-1-对哪种浏览器禁用长链接"><a href="#1-16-1-对哪种浏览器禁用长链接" class="headerlink" title="1.16.1 对哪种浏览器禁用长链接"></a>1.16.1 对哪种浏览器禁用长链接</h3><p>模块语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">keepalive_disable</span> <span class="hljs-literal">none</span> | browser ...;<br></code></pre></td></tr></table></figure>
<p>范例1：对ie6禁用长链接</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br><span class="hljs-section">http</span> &#123;<br>    ......;<br>    <span class="hljs-attribute">keepalive_disable</span> mise6; <span class="hljs-comment">#禁止ie6浏览器访问。 MSIE 名词释义： Microsoft Internet Explorer，简称MSIE。MSIE是微软公司推出的一款网页浏览器</span><br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>
<h3 id="1-16-2-限制客户端使用除了指定的请求方法之外的其它方法"><a href="#1-16-2-限制客户端使用除了指定的请求方法之外的其它方法" class="headerlink" title="1.16.2 限制客户端使用除了指定的请求方法之外的其它方法"></a>1.16.2 限制客户端使用除了指定的请求方法之外的其它方法</h3><p>模块语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">limit_except</span> method ... &#123; ... &#125;，仅⽤于<span class="hljs-attribute">location</span><br>method:GET, HEAD, POST, PUT, DELETE，MKCOL, COPY, MOVE, OPTIONS, PROPFIND,PROPPATCH, LOCK, UNLOCK, PATCH<br>注意：HEAD是默认允许，如果使用了这个模块，除了GET和HEAD之外所有的方法都会限制访问<br></code></pre></td></tr></table></figure>
<p>范例1：除了GET和HEAD之外，其它⽅法仅允许10.0.0.102/24⽹段主机使⽤</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>        <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> /upload &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">limit_except</span> GET &#123;<br>            <span class="hljs-attribute">allow</span> <span class="hljs-number">10.0.0.102</span>;<br>            <span class="hljs-attribute">deny</span> all;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin -s reload</span><br><span class="hljs-comment"># mkdir -p /data/nginx/html/pc/upload</span><br><span class="hljs-comment"># echo &quot;upload&quot; &gt; /data/nginx/pc/upload/index.html</span><br><br><span class="hljs-comment">#测试上传文件</span><br><span class="hljs-comment">#10.0.0.102主机</span><br><span class="hljs-attribute">curl</span> -XPUT /etc/issue http://www.rlinpc.net<br>curl: (<span class="hljs-number">3</span>) &lt;url&gt; malformed<br>&lt;html&gt;<br>&lt;head&gt;&lt;title&gt;<span class="hljs-number">405</span> Not Allowed&lt;/title&gt;&lt;/head&gt; <span class="hljs-comment">#Nginx已经允许但是程序未⽀持上传功能</span><br>&lt;body bgcolor=<span class="hljs-string">&quot;white&quot;</span>&gt;<br>&lt;center&gt;&lt;h1&gt;<span class="hljs-number">405</span> Not Allowed&lt;/h1&gt;&lt;/center&gt;<br>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br><span class="hljs-comment">#非10.0.0.102主机</span><br>curl -XPUT /etc/issue http://www.rlinpc/upload<br>curl: (<span class="hljs-number">3</span>) &lt;url&gt; malformed<br>&lt;html&gt;<br>&lt;head&gt;&lt;title&gt;<span class="hljs-number">403</span> Forbidden&lt;/title&gt;&lt;/head&gt; <span class="hljs-comment">#Nginx拒绝上传</span><br>&lt;body bgcolor=<span class="hljs-string">&quot;white&quot;</span>&gt;<br>&lt;center&gt;&lt;h1&gt;<span class="hljs-number">403</span> Forbidden&lt;/h1&gt;&lt;/center&gt;<br>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>
<h3 id="1-16-3-是否启用asynchronous-file-I-O-AIO-功能，需要编译开启（一般少用）"><a href="#1-16-3-是否启用asynchronous-file-I-O-AIO-功能，需要编译开启（一般少用）" class="headerlink" title="1.16.3 是否启用asynchronous file I/O(AIO)功能，需要编译开启（一般少用）"></a>1.16.3 是否启用asynchronous file I/O(AIO)功能，需要编译开启（一般少用）</h3><p>模块语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">aio on|off <span class="hljs-comment">#是否启用asynchronous file I/O(AIO)功能，需要编译开启 --with-file-aio</span><br><br><span class="hljs-comment">#linux 2.6以上内核提供以下⼏个系统调⽤来⽀持aio：</span><br>1、SYS_io_setup：建⽴aio的context<br>2、SYS_io_submit: 提交I/O操作请求<br>3、SYS_io_getevents：获取已完成的I/O事件<br>4、SYS_io_cancel：取消I/O操作请求<br>5、SYS_io_destroy：毁销aio的context<br></code></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">directio</span> size | <span class="hljs-literal">off</span>; <span class="hljs-comment">#操作完全和aio相反，aio是读取⽂件而directio是写⽂件到磁盘，启⽤直接I/O，默认为关闭，当⽂件大于等于给定大小时，例如directio 4m，同步（直接）写磁盘，而非写缓存。</span><br></code></pre></td></tr></table></figure>
<p>范例：开启aio（需要配合directio一起开启）</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>     <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">aio</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">directio</span> <span class="hljs-number">4m</span>;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h3 id="1-16-4-是否缓存打开过的文件信息（一般是打开）"><a href="#1-16-4-是否缓存打开过的文件信息（一般是打开）" class="headerlink" title="1.16.4 是否缓存打开过的文件信息（一般是打开）"></a>1.16.4 是否缓存打开过的文件信息（一般是打开）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">open_file_cache off;  <span class="hljs-comment">#是否缓存打开过的文件信息</span><br>open_file_cache max=N [inactive=time];<br><br><span class="hljs-comment">#nginx可以缓存以下三种信息：</span><br>(1) 文件元数据：文件的描述符、文件大小和最近一次的修改时间<br>(2) 打开的目录结构<br>(3) 没有找到的或者没有权限访问的文件的相关信息<br>max=N：<span class="hljs-comment">#可缓存的缓存项上限数量;达到上限后会使用LRU(Least recently used，最近最少使用)算法实现管理</span><br>inactive=time：<span class="hljs-comment">#缓存项的非活动时长，在此处指定的时长内未被命中的或命中的次数少于 open_file_cache_min_uses 指令所指定的次数的缓存项即为非活动项，将被删除</span><br><br>open_file_cache_valid time; <span class="hljs-comment">#缓存项有效性的检查验证频率，默认值为60s</span><br>open_file_cache_errors on | off; <span class="hljs-comment">#是否缓存查找时发生错误的文件一类的信息,默认值为off</span><br>open_file_cache_min_uses number; <span class="hljs-comment">#open_file_cache指令的inactive参数指定的时长内，至少被命中此处指定的次数方可被归类为活动项,默认值为1</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br><span class="hljs-section">http</span> &#123;<br>    ......<br>        <span class="hljs-attribute">open_file_cache</span> max=<span class="hljs-number">10000</span> inactive=<span class="hljs-number">60s</span>; <span class="hljs-comment">#最⼤缓存10000个⽂件，⾮活动数据超时时⻓60s</span><br>        <span class="hljs-attribute">open_file_cache_valid</span> <span class="hljs-number">60s</span>; <span class="hljs-comment">#每间隔60s检查⼀下缓存数据有效性</span><br>        <span class="hljs-attribute">open_file_cache_min_uses</span> <span class="hljs-number">5</span>; <span class="hljs-comment">#60秒内⾄少被命中访问5次才被标记为活动数据</span><br>        <span class="hljs-attribute">open_file_cache_errors</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#缓存错误信息</span><br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h3 id="1-16-5-隐藏nginx的版本号"><a href="#1-16-5-隐藏nginx的版本号" class="headerlink" title="1.16.5 隐藏nginx的版本号"></a>1.16.5 隐藏nginx的版本号</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br><span class="hljs-section">http</span> &#123;<br>    ......<br>        <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>; <span class="hljs-comment">#隐藏Nginx server版本。</span><br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h2 id="1-17-Nginx重定向301、302、307的区别"><a href="#1-17-Nginx重定向301、302、307的区别" class="headerlink" title="1.17 Nginx重定向301、302、307的区别"></a>1.17 Nginx重定向301、302、307的区别</h2><p>301：永久重定向，该操作比较危险，需要谨慎操作。如果设置了301，但是一段时间后又想取消，但是浏览器中已经有了缓存，还是会重定向。</p>
<p>302：临时重定向，但是会在重定向的时候改变 method: 把 POST 改成 GET，于是有了 307</p>
<p>307：临时重定向，在重定向时不会改变 method</p>
<h1 id="二、Nginx高级配置"><a href="#二、Nginx高级配置" class="headerlink" title="二、Nginx高级配置"></a>二、Nginx高级配置</h1><h2 id="2-1-Nginx-状态页"><a href="#2-1-Nginx-状态页" class="headerlink" title="2.1 Nginx 状态页"></a>2.1 Nginx 状态页</h2><p>基于nginx 模块 <code>ngx_http_stub_status_module</code> 实现，在编译安装nginx的时候需要添加编译参数<code>--with-http_stub_status_module</code>，否则配置完成之后监测会是提⽰语法错误。</p>
<table>
<thead>
<tr>
<th>句法</th>
<th>stub_status;</th>
</tr>
</thead>
<tbody><tr>
<td>默认</td>
<td>-</td>
</tr>
<tr>
<td>语境</td>
<td>服务器（server），位置（location）</td>
</tr>
</tbody></table>
<p>注意: 状态页显示的是整个服务器的状态，而非虚拟主机的状态</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#配置⽰例：</span><br><span class="hljs-attribute">location</span> /nginx_status &#123;<br>    stub_status; <span class="hljs-comment">#在location里输入这个参数，在1.7.5之前的版本中，指令语法需要任意参数，例如“ stub_status on”</span><br>    <span class="hljs-attribute">auth_basic</span>      <span class="hljs-string">&quot;auth login&quot;</span>;<br>    <span class="hljs-attribute">auth_basic_user_file</span> /apps/nginx/conf/.htpasswd;<br>    <span class="hljs-attribute">allow</span> <span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">16</span>;<br>    <span class="hljs-attribute">allow</span> <span class="hljs-number">127.0.0.1</span>;<br>    <span class="hljs-attribute">deny</span> all;<br>&#125;<br><br><span class="hljs-comment">#状态⻚⽤于输出nginx的基本状态信息：</span><br><span class="hljs-comment">#输出信息⽰例：</span><br><span class="hljs-attribute">Active</span> connections: <span class="hljs-number">291</span><br>server accepts handled requests<br><span class="hljs-number">16630948</span> <span class="hljs-number">16630948</span> <span class="hljs-number">31070465</span><br>上⾯三个数字分别对应accepts,handled,requests三个值<br>Reading: <span class="hljs-number">6</span> Writing: <span class="hljs-number">179</span> Waiting: <span class="hljs-number">106</span><br><br>Active connections： <span class="hljs-comment">#当前处于活动状态的客户端连接数，包括连接等待空闲连接数=reading+writing+waiting</span><br>accepts：<span class="hljs-comment">#统计总值，Nginx⾃启动后已经接受的客户端请求的总数。</span><br>handled：<span class="hljs-comment">#统计总值，Nginx⾃启动后已经处理完成的客户端请求的总数，通常等于accepts，除⾮有因worker_connections限制等被拒绝的连接。</span><br>requests：<span class="hljs-comment">#统计总值，Nginx⾃启动后客户端发来的总的请求数。</span><br>Reading：<span class="hljs-comment">#当前状态，正在读取客⼾端请求报⽂⾸部的连接的连接数。</span><br>Writing：<span class="hljs-comment">#当前状态，正在向客⼾端发送响应报⽂过程中的连接数。</span><br>Waiting：<span class="hljs-comment">#当前状态，正在等待客⼾端发出请求的空闲连接数，开启 keep-alive的情况下,这个值等于 active –(reading+writing),</span><br></code></pre></td></tr></table></figure>
<p>范例：分析网站当前访问量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curl http://www.rlin.com/nginx_status 2&gt; /dev/null | awk &#x27;/Reading/&#123;print $2,$4,$6&#125;&#x27;</span><br>0 1 1<br></code></pre></td></tr></table></figure>
<h2 id="2-2-Nginx第三方模块"><a href="#2-2-Nginx第三方模块" class="headerlink" title="2.2 Nginx第三方模块"></a>2.2 Nginx第三方模块</h2><p>第三模块是对nginx 的功能扩展，第三方模块需要在编译安装Nginx 的时候使用参数–add-module=PATH指定路径添加，有的模块是由公司的开发人员针对业务需求定制开发的，有的模块是开源爱好者开发好之后上传到github进行开源的模块，nginx支持第三方模块需要从源码重新编译支持，比如:开源的echo模块 <a target="_blank" rel="noopener" href="https://github.com/openresty/echo-nginx-module">https://github.com/openresty/echo-nginx-module</a></p>
<h3 id="2-2-1-范例：第三方模块echo如何加入到nginx"><a href="#2-2-1-范例：第三方模块echo如何加入到nginx" class="headerlink" title="2.2.1 范例：第三方模块echo如何加入到nginx"></a>2.2.1 范例：第三方模块echo如何加入到nginx</h3><h4 id="2-2-1-1-下载第三方模块"><a href="#2-2-1-1-下载第三方模块" class="headerlink" title="2.2.1.1 下载第三方模块"></a>2.2.1.1 下载第三方模块</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># git clone https://github.com/openresty/echo-nginx-module.git</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-1-2-获取nginx编译参数"><a href="#2-2-1-2-获取nginx编译参数" class="headerlink" title="2.2.1.2 获取nginx编译参数"></a>2.2.1.2 获取nginx编译参数</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /apps/nginx/sbin/nginx -V</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-1-3-重新编译nginx"><a href="#2-2-1-3-重新编译nginx" class="headerlink" title="2.2.1.3 重新编译nginx"></a>2.2.1.3 重新编译nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ./configure --prefix=/apps/nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_image_filter_module --with-http_geoip_module --with-http_gunzip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module #最后的--add-module是将echo模块添加进nginx的编译里</span><br><span class="hljs-comment"># make </span><br><span class="hljs-comment"># make install</span><br></code></pre></td></tr></table></figure>
<h3 id="2-2-2-范例：nginx如何使用第三方模块（如何使用在github里参考，这里以echo为例）"><a href="#2-2-2-范例：nginx如何使用第三方模块（如何使用在github里参考，这里以echo为例）" class="headerlink" title="2.2.2 范例：nginx如何使用第三方模块（如何使用在github里参考，这里以echo为例）"></a>2.2.2 范例：nginx如何使用第三方模块（如何使用在github里参考，这里以echo为例）</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net<br>        location / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> hello world;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问http://www.rlinpc.net/</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>      <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>      <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>      <span class="hljs-attribute">location</span> /main &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">default_type</span> text/html;<br>        <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;hello world,main--&gt;&quot;</span>;<br>        <span class="hljs-attribute">echo</span> $remote_addr ;<br>        echo_reset_timer;  <span class="hljs-comment">#将计时器开始时间重置为当前时间</span><br>        <span class="hljs-attribute">echo_location</span> /sub1;<br>        <span class="hljs-attribute">echo_location</span> /sub2;<br>        <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;took $echo_timer_elapsed sec for total.&quot;</span>;<br>      &#125;<br>    <br>      <span class="hljs-attribute">location</span> /sub1 &#123;<br>        <span class="hljs-attribute">echo_sleep</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-attribute">echo</span> sub1;<br>      &#125;<br>    <br>      <span class="hljs-attribute">location</span> /sub2 &#123;<br>        <span class="hljs-attribute">echo_sleep</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-attribute">echo</span> sub2;<br>      &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#测试是查看结果</span><br><span class="hljs-comment"># curl www.rlinpc.net/main</span><br><span class="hljs-attribute">hello</span> world,main--&gt;<br><span class="hljs-number">10.0.0.101</span><br>sub1<br>sub2<br>took <span class="hljs-number">2</span>.<span class="hljs-number">004</span> sec for total.<br></code></pre></td></tr></table></figure>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-disanfangtest.png" srcset="/blog/img/loading.gif" title="第三方测试"></p>
<h2 id="2-3-Nginx变量使用"><a href="#2-3-Nginx变量使用" class="headerlink" title="2.3 Nginx变量使用"></a>2.3 Nginx变量使用</h2><ul>
<li>nginx的变量可以在配置文件中引用，作为功能判断或者日志等场景使用</li>
<li>变量可以分为内置变量和自定义变量</li>
<li>内置变量是由nginx模块自带，通过变量可以获取到众多的与客户端访问相关的值。<h3 id="2-3-1-内置变量"><a href="#2-3-1-内置变量" class="headerlink" title="2.3.1 内置变量"></a>2.3.1 内置变量</h3>官方文档<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://nginx.org/en/docs/varindex.html<br></code></pre></td></tr></table></figure>
<h4 id="2-3-1-1-常用内置变量之-remote-addr"><a href="#2-3-1-1-常用内置变量之-remote-addr" class="headerlink" title="2.3.1.1 常用内置变量之$remote_addr"></a>2.3.1.1 常用内置变量之<code>$remote_addr</code></h4></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$remote_addr</span>;<br><span class="hljs-comment">#存放了客⼾端的地址，注意是客⼾端的公⽹IP，也就是⼀家⼈访问⼀个⽹站，则会显⽰为路由器的公⽹IP。</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $remote_addr;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-2-常用内置变量之-args"><a href="#2-3-1-2-常用内置变量之-args" class="headerlink" title="2.3.1.2 常用内置变量之$args"></a>2.3.1.2 常用内置变量之<code>$args</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$args</span>；<br><span class="hljs-comment">#变量中存放了URL中的指令，例如 http://www.rlin.net/main/index.do?id=20190221&amp;partner=search中的id=20190221&amp;partner=search </span><br><span class="hljs-comment">#返回结果为: id=20190221&amp;partner=search</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $args;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-3-常用内置变量之-document-root"><a href="#2-3-1-3-常用内置变量之-document-root" class="headerlink" title="2.3.1.3 常用内置变量之$document_root"></a>2.3.1.3 常用内置变量之<code>$document_root</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$document_root</span>；<br><span class="hljs-comment">#保存了针对当前资源的请求的系统根⽬录，如/apps/nginx/html。</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $document_root;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-4-常用内置变量之-document-uri"><a href="#2-3-1-4-常用内置变量之-document-uri" class="headerlink" title="2.3.1.4 常用内置变量之#document_uri"></a>2.3.1.4 常用内置变量之<code>#document_uri</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$document_uri</span>；<br><span class="hljs-comment">#保存了当前请求中不包含指令的URI，注意是不包含请求的指令，⽐如http://www.rlin.net/main/index.do?id=20190221&amp;partner=search会被定义为/main/index.do</span><br><span class="hljs-comment">#返回结果为:/main/index.do</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $document_uri;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-5-常用变量之-host"><a href="#2-3-1-5-常用变量之-host" class="headerlink" title="2.3.1.5 常用变量之$host"></a>2.3.1.5 常用变量之<code>$host</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$host</span>；<br><span class="hljs-comment">#存放了请求的host名称。</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $host;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-6-常用变量之-http-user-agent"><a href="#2-3-1-6-常用变量之-http-user-agent" class="headerlink" title="2.3.1.6 常用变量之$http_user_agent"></a>2.3.1.6 常用变量之<code>$http_user_agent</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$http_user_agent</span>；<br><span class="hljs-comment">#客⼾端浏览器的详细信息</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $http_user_agent;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-6-常用变量之-http-cookie"><a href="#2-3-1-6-常用变量之-http-cookie" class="headerlink" title="2.3.1.6 常用变量之$http_cookie"></a>2.3.1.6 常用变量之<code>$http_cookie</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$http_cookie</span>；<br><span class="hljs-comment">#客⼾端的cookie信息。</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $http_cookie;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-7-常用变量之-limit-rate"><a href="#2-3-1-7-常用变量之-limit-rate" class="headerlink" title="2.3.1.7  常用变量之$limit_rate"></a>2.3.1.7  常用变量之<code>$limit_rate</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">limit_rate 10240;<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$limit_rate</span>; (一般不用)<br><span class="hljs-comment">#如果nginx服务器使⽤limit_rate配置了显⽰⽹络速率，则会显⽰，如果没有设置， 则显⽰0。</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-8-常用变量之-remote-port"><a href="#2-3-1-8-常用变量之-remote-port" class="headerlink" title="2.3.1.8 常用变量之$remote_port"></a>2.3.1.8 常用变量之<code>$remote_port</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$remote_port</span>；<br><span class="hljs-comment">#客⼾端请求Nginx服务器时随机打开的端⼝，这是每个客⼾端⾃⼰的端⼝。</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $remote_port;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-9-常用变量之-remote-user"><a href="#2-3-1-9-常用变量之-remote-user" class="headerlink" title="2.3.1.9 常用变量之$remote_user"></a>2.3.1.9 常用变量之<code>$remote_user</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$remote_user</span>；<br><span class="hljs-comment">#已经经过Auth Basic Module验证的⽤⼾名。</span><br></code></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $remote_user;<br>        &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-10-常用变量之-request-body-file"><a href="#2-3-1-10-常用变量之-request-body-file" class="headerlink" title="2.3.1.10 常用变量之$request_body_file"></a>2.3.1.10 常用变量之<code>$request_body_file</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$request_body_file</span>；<br><span class="hljs-comment">#做反向代理时发给后端服务器的本地资源的名称。</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $request_body_file;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-10-常用变量之-request-method"><a href="#2-3-1-10-常用变量之-request-method" class="headerlink" title="2.3.1.10 常用变量之$request_method"></a>2.3.1.10 常用变量之<code>$request_method</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$request_method</span>；<br><span class="hljs-comment">#请求资源的⽅式，GET/PUT/DELETE等</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $request_method;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-11-常用变量之-request-filename"><a href="#2-3-1-11-常用变量之-request-filename" class="headerlink" title="2.3.1.11  常用变量之$request_filename"></a>2.3.1.11  常用变量之<code>$request_filename</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$request_filename</span>；<br><span class="hljs-comment">#当前请求的资源⽂件的路径名称，由root或alias指令与URI请求⽣成的⽂件绝对路径，如/apps/nginx/html/main/index.html</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $request_filename;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-12-常用变量之-request-uri；"><a href="#2-3-1-12-常用变量之-request-uri；" class="headerlink" title="2.3.1.12 常用变量之$request_uri；"></a>2.3.1.12 常用变量之<code>$request_uri；</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$request_uri</span>；<br><span class="hljs-comment">#包含请求参数的原始URI，不包含主机名，如：/main/index.do?id=20190221&amp;partner=search 。</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $request_uri;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-13-常用变量之-scheme"><a href="#2-3-1-13-常用变量之-scheme" class="headerlink" title="2.3.1.13 常用变量之$scheme"></a>2.3.1.13 常用变量之<code>$scheme</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$scheme</span>；<br><span class="hljs-comment">#请求的协议，如ftp，https，http等。</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $scheme;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-14-常用变量之-server-protocol"><a href="#2-3-1-14-常用变量之-server-protocol" class="headerlink" title="2.3.1.14 常用变量之$server_protocol"></a>2.3.1.14 常用变量之<code>$server_protocol</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$server_protocol</span>；<br><span class="hljs-comment">#保存了客⼾端请求资源使⽤的协议的版本，如HTTP/1.0，HTTP/1.1，HTTP/2.0等。</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $server_protocol;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-15-常用变量之-server-addr"><a href="#2-3-1-15-常用变量之-server-addr" class="headerlink" title="2.3.1.15 常用变量之$server_addr"></a>2.3.1.15 常用变量之<code>$server_addr</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$server_addr</span>；<br><span class="hljs-comment">#保存了服务器的IP地址。</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $server_addr;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-16-常用变量之-server-name"><a href="#2-3-1-16-常用变量之-server-name" class="headerlink" title="2.3.1.16 常用变量之$server_name"></a>2.3.1.16 常用变量之<code>$server_name</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$server_name</span>；<br><span class="hljs-comment">#请求的服务器的主机名。</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $server_name;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-17-常用变量之-server-port"><a href="#2-3-1-17-常用变量之-server-port" class="headerlink" title="2.3.1.17 常用变量之$server_port"></a>2.3.1.17 常用变量之<code>$server_port</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$server_port</span>；<br><span class="hljs-comment">#请求的服务器的端⼝号。</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $server_port;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-18-常用变量之-http-lt-name-gt"><a href="#2-3-1-18-常用变量之-http-lt-name-gt" class="headerlink" title="2.3.1.18 常用变量之$http_&lt;name&gt;"></a>2.3.1.18 常用变量之<code>$http_&lt;name&gt;</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$http_</span>&lt;name&gt;<br><span class="hljs-comment">#name为任意请求报文首部字段,表示记录请求报文的首部字段</span><br>arbitrary request header field; the last part of a variable name is the fieldname converted to lower <span class="hljs-keyword">case</span> with dashes replaced by underscores <span class="hljs-comment">#用下划线代替横线</span><br><span class="hljs-comment">#示例: echo $http_User_Agent;</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $http_&lt;name&gt;;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-1-19-常用变量之-http-user-agent"><a href="#2-3-1-19-常用变量之-http-user-agent" class="headerlink" title="2.3.1.19 常用变量之$http_user_agent"></a>2.3.1.19 常用变量之<code>$http_user_agent</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$http_user_agent</span>;<br><span class="hljs-comment">#客户端浏览器的详细信息</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $http_user_agent;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<h4 id="2-3-1-20-常用变量之-proxy-add-x-forwarded-for"><a href="#2-3-1-20-常用变量之-proxy-add-x-forwarded-for" class="headerlink" title="2.3.1.20 常用变量之$proxy_add_x_forwarded_for"></a>2.3.1.20 常用变量之<code>$proxy_add_x_forwarded_for</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$proxy_add_x_forwarded_for</span><br><span class="hljs-comment">#此变量表示将客户端IP追加请求报文中X-Forwarded-For首部字段,多个IP之间用逗号分隔,如果请求中没有X-Forwarded-For,就使用$remote_addr the “X-Forwarded-For” client request header field with the $remote_addr variable appended to it, separated by a comma. If the “X-Forwarded-For” field is notpresent in the client request header, the $proxy_add_x_forwarded_for variable isequal to the $remote_addr variable.</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">echo</span> $proxy_add_x_forwarded_for;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-2-自定义变量"><a href="#2-3-2-自定义变量" class="headerlink" title="2.3.2 自定义变量"></a>2.3.2 自定义变量</h3><p>假如需要⾃定义变量名称和值，使⽤指令<code>set $variable value;</code>，则⽅法如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">Syntax: <span class="hljs-built_in">set</span> <span class="hljs-variable">$variable</span> value;<br>Default: —<br>Context: server, location, <span class="hljs-keyword">if</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-1-范例：自定义值范例"><a href="#2-3-2-1-范例：自定义值范例" class="headerlink" title="2.3.2.1 范例：自定义值范例"></a>2.3.2.1 范例：自定义值范例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> <span class="hljs-variable">$NAME</span> rlin; <span class="hljs-comment">#自定义定义值</span><br><span class="hljs-built_in">set</span> <span class="hljs-variable">$IP</span> <span class="hljs-variable">$remote_addr</span>; <span class="hljs-comment">#使用nginx内置变量</span><br></code></pre></td></tr></table></figure>
<h4 id="2-3-2-2-范例1：在配置文件中使用"><a href="#2-3-2-2-范例1：在配置文件中使用" class="headerlink" title="2.3.2.2 范例1：在配置文件中使用"></a>2.3.2.2 范例1：在配置文件中使用</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">set</span> $NAME rlin;<br>        <span class="hljs-attribute">echo</span> $NAME;<br>        <span class="hljs-attribute">set</span> $my_port $server_port;<br>        <span class="hljs-attribute">echo</span> $my_port;<br>        <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;$server_name:$server_port&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<h4 id="2-3-2-3-范例2：在配置文件中使用"><a href="#2-3-2-3-范例2：在配置文件中使用" class="headerlink" title="2.3.2.3 范例2：在配置文件中使用"></a>2.3.2.3 范例2：在配置文件中使用</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html; <span class="hljs-comment">#如果不加这个浏览器就不知道用什么解析下面的echo输出</span><br>        <span class="hljs-attribute">set</span> $IP $remote_addr;<br>        <span class="hljs-attribute">echo</span> $IP;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h2 id="2-4-Nginx自定义访问日志"><a href="#2-4-Nginx自定义访问日志" class="headerlink" title="2.4 Nginx自定义访问日志"></a>2.4 Nginx自定义访问日志</h2><p>访问⽇志是记录客⼾端即⽤⼾的具体请求内容信息，全局配置模块中的error_log是记录nginx服务器运⾏时的⽇志保存路径和记录⽇志的level，因此有着本质的区别，⽽且Nginx的错误⽇志⼀般只有⼀个，但是访问⽇志可以在不同server中定义多个，定义⼀个⽇志需要使⽤access_log指定⽇志的保存路径，使⽤log_format指定⽇志的格式，格式中定义要保存的具体⽇志内容。 </p>
<p>访问日志由 <code>ngx_http_log_module</code> 模块实现</p>
<p>官方帮助文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://nginx.org/en/docs/http/ngx_http_log_module.html<br></code></pre></td></tr></table></figure>
<p>语法格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">Syntax: access_log path [format [buffer=size] [gzip[=level]] [flush=time]<br>[<span class="hljs-keyword">if</span>=condition]];<br>access_log off;<br>Default:<br>access_log logs/access.log combined;<br>Context: http, server, location, <span class="hljs-keyword">if</span> <span class="hljs-keyword">in</span> location, limit_except<br></code></pre></td></tr></table></figure>
<h3 id="2-4-1-自定义默认格式日志"><a href="#2-4-1-自定义默认格式日志" class="headerlink" title="2.4.1 自定义默认格式日志"></a>2.4.1 自定义默认格式日志</h3><p>如果是要保留日志的源格式，只是添加相应的日志内容，则配置如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br><span class="hljs-section">http</span> &#123;<br>......<br><span class="hljs-attribute">log_format</span> nginx_format1  <span class="hljs-string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot;&#x27;</span><br>           <span class="hljs-string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>           <span class="hljs-string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><br>           <span class="hljs-string">&#x27;$server_name:$server_port&#x27;</span>;<br>           <br><span class="hljs-attribute">access_log</span> logs/access.log nginx_format1;<br>&#125;<br><br><span class="hljs-comment">#重启nginx并访问测试日志格式</span><br>==&gt; /apps/nginx/logs/access.<span class="hljs-attribute">log</span> &lt;==<br><span class="hljs-number">10.0.0.1</span> - - [<span class="hljs-number">22</span>/Feb/<span class="hljs-number">2019</span>:<span class="hljs-number">08</span>:<span class="hljs-number">44</span>:<span class="hljs-number">14</span> +<span class="hljs-number">0800</span>] <span class="hljs-string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> <span class="hljs-number">404</span> <span class="hljs-number">162</span> <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0&quot;</span> <span class="hljs-string">&quot;-&quot;</span>www.rlin.com:<span class="hljs-number">80</span><br></code></pre></td></tr></table></figure>
<h3 id="2-4-2-自定义json格式日志"><a href="#2-4-2-自定义json格式日志" class="headerlink" title="2.4.2 自定义json格式日志"></a>2.4.2 自定义json格式日志</h3><p>Nginx 的默认访问⽇志记录内容相对⽐较单⼀，默认的格式也不⽅便后期做⽇志统计分析，<strong>⽣产环境中通常将nginx⽇志转换为json⽇志</strong>，然后配合使⽤ELK做⽇志收集-统计-分析</p>
<h4 id="2-4-2-1-范例：自定义json日志格式"><a href="#2-4-2-1-范例：自定义json日志格式" class="headerlink" title="2.4.2.1 范例：自定义json日志格式"></a>2.4.2.1 范例：自定义json日志格式</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /apps/nginx/conf/nginx.conf<br>http &#123;<br>    ......<br>        <span class="hljs-attribute">log_format</span> access_json   <br>        <span class="hljs-string">&#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;responsetime&quot;:$request_time,&#x27;</span> <span class="hljs-comment">#总的处理时间</span><br>        <span class="hljs-string">&#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span> <span class="hljs-comment">#后端应用服务器处理时间</span><br>        <span class="hljs-string">&#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;uri&quot;:&quot;$uri&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;tcp_xff&quot;:&quot;$proxy_protocol_addr&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;</span>;<br>        <br>        <span class="hljs-attribute">access_log</span> /apps/nginx/logs/access_json.log access_json;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/ngins -s reload</span><br><br><span class="hljs-comment">#重启Nginx并访问测试日志格式,参考链接:http://json.cn/</span><br>&#123;&quot;@timestamp&quot;:&quot;2019-02-22T08:55:32+08:00&quot;,&quot;host&quot;:&quot;10.0.0.8&quot;,&quot;clientip&quot;:&quot;10.0.0.1&quot;,&quot;size&quot;:162,&quot;<span class="hljs-attribute">responset</span><br>ime<span class="hljs-string">&quot;:0.000,&quot;</span>upstreamtime<span class="hljs-string">&quot;:&quot;</span>-<span class="hljs-string">&quot;,&quot;</span>upstreamhost<span class="hljs-string">&quot;:&quot;</span>-<span class="hljs-string">&quot;,&quot;</span>http_host<span class="hljs-string">&quot;:&quot;</span>www.magedu.org<span class="hljs-string">&quot;,&quot;</span>uri<span class="hljs-string">&quot;:&quot;</span>/favicon.ico<span class="hljs-string">&quot;,&quot;</span>xff<span class="hljs-string">&quot;:&quot;</span>-<span class="hljs-string">&quot;,&quot;</span>referer<span class="hljs-string">&quot;:&quot;</span>-<br><span class="hljs-string">&quot;,&quot;</span>tcp_xff<span class="hljs-string">&quot;:&quot;</span><span class="hljs-string">&quot;,&quot;</span>http_user_agent<span class="hljs-string">&quot;:&quot;</span>Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span> (Windows NT <span class="hljs-number">6</span>.<span class="hljs-number">1</span>; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0&quot;,&quot;status&quot;:&quot;404&quot;&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-4-2-2-范例：其他虚拟机使用自定义的json日志格式"><a href="#2-4-2-2-范例：其他虚拟机使用自定义的json日志格式" class="headerlink" title="2.4.2.2 范例：其他虚拟机使用自定义的json日志格式"></a>2.4.2.2 范例：其他虚拟机使用自定义的json日志格式</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    ......<br>        <span class="hljs-attribute">access_log</span> /apps/nginx/logs/access_rlinpc_json.log access_json;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/ngins -s reload</span><br><span class="hljs-comment">#浏览器访问测试，然后查看日志，百度json校验，将日志复制完整的一段到到校验那里查看是否是json格式</span><br></code></pre></td></tr></table></figure>

<h3 id="2-4-3-json格式的日志访问统计"><a href="#2-4-3-json格式的日志访问统计" class="headerlink" title="2.4.3 json格式的日志访问统计"></a>2.4.3 json格式的日志访问统计</h3><h4 id="2-4-3-1-范例1：使用Python3统计日志里200和404有多少个"><a href="#2-4-3-1-范例1：使用Python3统计日志里200和404有多少个" class="headerlink" title="2.4.3.1 范例1：使用Python3统计日志里200和404有多少个"></a>2.4.3.1 范例1：使用Python3统计日志里200和404有多少个</h4><h5 id="2-4-3-1-1-安装Python3"><a href="#2-4-3-1-1-安装Python3" class="headerlink" title="2.4.3.1.1 安装Python3"></a>2.4.3.1.1 安装Python3</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install -y python3  #ubuntu</span><br><span class="hljs-comment"># yum install -y python3  #centos</span><br></code></pre></td></tr></table></figure>

<h5 id="2-4-3-1-2-添加Python脚本"><a href="#2-4-3-1-2-添加Python脚本" class="headerlink" title="2.4.3.1.2 添加Python脚本"></a>2.4.3.1.2 添加Python脚本</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># vim /apps/log.py</span><br><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#coding:utf-8</span><br>status_200= []<br>status_404= []<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;access_json.log&quot;</span>) <span class="hljs-keyword">as</span> f:<br>  <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>    line = <span class="hljs-built_in">eval</span>(line)<br>    <span class="hljs-keyword">if</span> line.get(<span class="hljs-string">&quot;status&quot;</span>) == <span class="hljs-string">&quot;200&quot;</span>:<br>      status_200.append(line.get)<br>    <span class="hljs-keyword">elif</span> line.get(<span class="hljs-string">&quot;status&quot;</span>) == <span class="hljs-string">&quot;404&quot;</span>:<br>      status_404.append(line.get)<br>    <span class="hljs-keyword">else</span>:<br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;状态码 ERROR&quot;</span>)<br>      <span class="hljs-built_in">print</span>((line.get(<span class="hljs-string">&quot;clientip&quot;</span>)))<br>f.close()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;状态码200的有--:&quot;</span>,<span class="hljs-built_in">len</span>(status_200))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;状态码404的有--:&quot;</span>,<span class="hljs-built_in">len</span>(status_404))<br></code></pre></td></tr></table></figure>

<h5 id="2-4-3-1-4-测试脚本"><a href="#2-4-3-1-4-测试脚本" class="headerlink" title="2.4.3.1.4 测试脚本"></a>2.4.3.1.4 测试脚本</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#保存日志文件到指定路径并进测试：</span><br><span class="hljs-comment"># python3 /apps/log.py</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-3-2-范例2：使用Python2统计日志里200和404有多少个"><a href="#2-4-3-2-范例2：使用Python2统计日志里200和404有多少个" class="headerlink" title="2.4.3.2 范例2：使用Python2统计日志里200和404有多少个"></a>2.4.3.2 范例2：使用Python2统计日志里200和404有多少个</h4><h5 id="2-4-3-2-1-安装Python2"><a href="#2-4-3-2-1-安装Python2" class="headerlink" title="2.4.3.2.1 安装Python2"></a>2.4.3.2.1 安装Python2</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install -y python2 #ubuntn</span><br><span class="hljs-comment"># yum install -y python2 #centos</span><br></code></pre></td></tr></table></figure>

<h5 id="2-4-3-2-2-添加Python脚本"><a href="#2-4-3-2-2-添加Python脚本" class="headerlink" title="2.4.3.2.2 添加Python脚本"></a>2.4.3.2.2 添加Python脚本</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># vim /apps/log.py</span><br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br>status_200= []<br>status_404= []<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;access_json.log&quot;</span>) <span class="hljs-keyword">as</span> f:<br>  <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>    line = <span class="hljs-built_in">eval</span>(line)<br>    <span class="hljs-keyword">if</span> line.get(<span class="hljs-string">&quot;status&quot;</span>) == <span class="hljs-string">&quot;200&quot;</span>:<br>      status_200.append(line.get)<br>    <span class="hljs-keyword">elif</span> line.get(<span class="hljs-string">&quot;status&quot;</span>) == <span class="hljs-string">&quot;404&quot;</span>:<br>      status_404.append(line.get)<br>    <span class="hljs-keyword">else</span>:<br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;状态码 ERROR&quot;</span>)<br>    <span class="hljs-built_in">print</span>(line.get(<span class="hljs-string">&quot;clientip&quot;</span>))<br>    f.close()<br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;状态码200的有--:&quot;</span>,<span class="hljs-built_in">len</span>(status_200)<br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;状态码404的有--:&quot;</span>,<span class="hljs-built_in">len</span>(status_404)<br></code></pre></td></tr></table></figure>

<h5 id="2-4-3-2-4-测试脚本"><a href="#2-4-3-2-4-测试脚本" class="headerlink" title="2.4.3.2.4 测试脚本"></a>2.4.3.2.4 测试脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#保存日志文件到指定路径并进测试：</span><br>python nginx_json.py<br>状态码200的有--: 1910<br>状态码404的有--: 13<br><br><span class="hljs-comment">#转换python2语法到python3</span><br>pip3 install 2to3<br>2to3 -w log.py<br></code></pre></td></tr></table></figure>
<h4 id="2-4-3-3-范例3：获取日志中用户访问的ip地址"><a href="#2-4-3-3-范例3：获取日志中用户访问的ip地址" class="headerlink" title="2.4.3.3 范例3：获取日志中用户访问的ip地址"></a>2.4.3.3 范例3：获取日志中用户访问的ip地址</h4><h5 id="2-4-3-3-1-安装Python2"><a href="#2-4-3-3-1-安装Python2" class="headerlink" title="2.4.3.3.1 安装Python2"></a>2.4.3.3.1 安装Python2</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># apt install -y python2</span><br><span class="hljs-comment"># yum install -y python2</span><br></code></pre></td></tr></table></figure>

<h5 id="2-4-3-3-2-添加脚本"><a href="#2-4-3-3-2-添加脚本" class="headerlink" title="2.4.3.3.2 添加脚本"></a>2.4.3.3.2 添加脚本</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># vim /apps/log.py</span><br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#coding:utf-8</span><br>status_200= []<br>status_404= []<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;access_json.log&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>        line = <span class="hljs-built_in">eval</span>(line)<br>        <span class="hljs-built_in">print</span>(line.get(<span class="hljs-string">&quot;clientip&quot;</span>))<br>f.close()<br></code></pre></td></tr></table></figure>

<h5 id="2-4-3-3-3-执行脚本"><a href="#2-4-3-3-3-执行脚本" class="headerlink" title="2.4.3.3.3 执行脚本"></a>2.4.3.3.3 执行脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># python2.7 log.py</span><br></code></pre></td></tr></table></figure>

<h2 id="2-5-Nginx压缩功能"><a href="#2-5-Nginx压缩功能" class="headerlink" title="2.5 Nginx压缩功能"></a>2.5 Nginx压缩功能</h2><p>Nginx⽀持对指定类型的⽂件进⾏压缩然后再传输给客⼾端，⽽且压缩还可以设置压缩⽐例，压缩后的⽂件⼤⼩将⽐源⽂件显著变⼩，这样有助于降低出⼝带宽的利⽤率，降低企业的IT⽀出，不过会占⽤相应的CPU资源。</p>
<p><strong>注意：需要在编译的时候加上压缩的参数</strong></p>
<p>Nginx对文件的压缩功能是以来于模块<code>ngx_http_gzip_module</code></p>
<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://nginx.org/en/docs/http/ngx_http_gzip_module.html<br></code></pre></td></tr></table></figure>

<h3 id="2-5-1-压缩指令"><a href="#2-5-1-压缩指令" class="headerlink" title="2.5.1 压缩指令"></a>2.5.1 压缩指令</h3><p>配置指令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启⽤或禁⽤gzip压缩，默认关闭</span><br>gzip on | off;<br><br><span class="hljs-comment">#压缩⽐由低到⾼从1到9，默认为1，推荐3-5，不要超过5</span><br>gzip_comp_level level; <br><br><span class="hljs-comment">#禁⽤IE6 gzip功能</span><br>gzip_disable <span class="hljs-string">&quot;MSIE [1-6]\.&quot;</span>;<br><br><span class="hljs-comment">#gzip压缩的最⼩⽂件，⼩于设置值的⽂件将不会压缩</span><br>gzip_min_length 1k;<br><br><span class="hljs-comment">#启⽤压缩功能时，协议的最⼩版本，默认HTTP/1.1</span><br>gzip_http_version 1.0 | 1.1;<br><br><span class="hljs-comment">#指定Nginx服务需要向服务器申请的缓存空间的个数*⼤⼩，默认32 4k|16 8k;</span><br>gzip_buffers number size;<br><br><span class="hljs-comment">#指明仅对哪些类型的资源执⾏压缩操作；默认为gzip_types text/html，不⽤显⽰指定，否则出错，可以在/apps/nginx/conf/mine.type里查看类型</span><br>gzip_types mime-type ...;<br><br><span class="hljs-comment">#如果启⽤压缩，是否在响应报⽂⾸部插⼊“Vary: Accept-Encoding”</span><br>gzip_vary on | off;<br></code></pre></td></tr></table></figure>

<h3 id="2-5-2-范例：开启压缩功能，并测试"><a href="#2-5-2-范例：开启压缩功能，并测试" class="headerlink" title="2.5.2 范例：开启压缩功能，并测试"></a>2.5.2 范例：开启压缩功能，并测试</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#配置文件添加压缩配置</span><br><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br><span class="hljs-section">http</span> &#123;<br>    ......<br>    <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">gzip_buffers</span> <span class="hljs-number">128</span> <span class="hljs-number">4k</span><br>    gzip_comp_level <span class="hljs-number">5</span>;<br>    <span class="hljs-attribute">gzip_min_length</span> <span class="hljs-number">1k</span>;<br>    <span class="hljs-attribute">gzip_types</span> text/plain application/javascript application/x-javascript text/cssapplication/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;<br>    <span class="hljs-attribute">gzip_vary</span> <span class="hljs-literal">on</span>;<br>&#125;<br><br><span class="hljs-comment">#添加虚拟机</span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>        <span class="hljs-attribute">location</span> /download &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;     <br>        <span class="hljs-attribute">default_type</span> text/html;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#检查语法并重启nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#准备文件</span><br><span class="hljs-comment"># cd /data/nginx/html/pc/download/</span><br><span class="hljs-comment"># cp /apps/nginx/logs/access.log /data/nginx/html/pc/download/m.txt</span><br><span class="hljs-comment"># echo &quot;test&quot; &gt; /data/nginx/html/pc/download/test.html #小于1k的文件测试是否会压缩</span><br><br><span class="hljs-comment">#查看文件</span><br><span class="hljs-comment"># ls</span><br>.....<br>-rw-r--r-- 1 <span class="hljs-attribute">root</span>  root  <span class="hljs-number">5918</span> Feb <span class="hljs-number">15</span> <span class="hljs-number">22</span>:<span class="hljs-number">23</span> m.txt<br>-rw-r--r-- <span class="hljs-number">1</span> root  root     <span class="hljs-number">5</span> Feb <span class="hljs-number">15</span> <span class="hljs-number">22</span>:<span class="hljs-number">23</span> test.html<br><br><span class="hljs-comment">#curl测试是否有开启压缩</span><br><span class="hljs-comment"># curl --head --compressed http://www.rlinpc.net/test.html</span><br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: M<span class="hljs-literal">on</span>, <span class="hljs-number">15</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">19</span> GMT<br>Content-Type: text/html<br>Content-Length: <span class="hljs-number">5</span><br>Last-Modified: M<span class="hljs-literal">on</span>, <span class="hljs-number">15</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">23</span>:<span class="hljs-number">44</span> GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;602a83f0-5&quot;</span><br>Accept-Ranges: bytes<br><span class="hljs-comment">#文件太小没有开启压缩</span><br><br><span class="hljs-comment"># curl --head --compressed http://www.rlinpc.net/m.txt</span><br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: M<span class="hljs-literal">on</span>, <span class="hljs-number">15</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">32</span> GMT<br>Content-Type: text/plain<br>Last-Modified: M<span class="hljs-literal">on</span>, <span class="hljs-number">15</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">23</span>:<span class="hljs-number">38</span> GMT<br>Connection: keep-alive<br>Vary: Accept-Encoding<br>ETag: W/<span class="hljs-string">&quot;602a83ea-171e&quot;</span><br>Content-Encoding: gzip <span class="hljs-comment">#有开启压缩</span><br></code></pre></td></tr></table></figure>

<p><strong>总结：被访问的文件大小是不会开启压缩</strong></p>
<h2 id="2-6-https功能"><a href="#2-6-https功能" class="headerlink" title="2.6 https功能"></a>2.6 https功能</h2><p>Web⽹站的登录⻚⾯都是使⽤https加密传输的，加密数据以保障数据的安全，HTTPS能够加密信息，以免敏感信息被第三⽅获取，所以很多银⾏⽹站或电⼦邮箱等等安全级别较⾼的服务都会采⽤HTTPS协议，HTTPS其实是有两部分组成：HTTP + SSL / TLS，也就是在HTTP上⼜加了⼀层处理加密信息的模块。服务端和客⼾端的信息传输都会通过TLS进⾏加密，所以传输的数据都是加密后的数据。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce23.png" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-intrduce22.png" srcset="/blog/img/loading.gif" alt="https实现过程图例"></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-keyword">https</span> 实现过程如下：<br><span class="hljs-number">1.</span>客户端发起HTTPS请求：<br>客户端访问某个web端的<span class="hljs-keyword">https</span>地址，一般都是<span class="hljs-number">443</span>端口<br><br><span class="hljs-number">2.</span>服务端的配置：<br>采用<span class="hljs-keyword">https</span>协议的服务器必须要有一套证书，可以通过一些组织申请，也可以自己制作，目前国内很多网站都自己做的，当你访问一个网站的时候提示证书不可信任就表示证书是自己做的，证书就是一个公钥和私钥，就像一把锁和钥匙，正常情况下只有你的钥匙可以打开你的锁，你可以把这个送给别人让他锁住一个箱子，里面放满了钱或秘密，别人不知道里面放了什么而且别人也打不开，只有你的钥匙是可以打开的。<br><br><span class="hljs-number">3.</span>传送证书：<br>服务端给客户端传递证书，其实就是公钥，里面包含了很多信息，例如证书得到颁发机构、过期时间等等。<br><br><span class="hljs-number">4.</span>客户端解析证书：<br>这部分工作是有客户端完成的，首先回验证公钥的有效性，比如颁发机构、过期时间等等，如果发现异常则会弹出一个警告框提示证书可能存在问题，如果证书没有问题就生成一个随机值，然后用证书对该随机值进行加密，就像<span class="hljs-number">2</span>步骤所说把随机值锁起来，不让别人看到。<br><br><span class="hljs-number">5.</span>传送<span class="hljs-number">4</span>步骤的加密数据：<br>就是将用证书加密后的随机值传递给服务器，目的就是为了让服务器得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值进行加密解密了。<br><br><span class="hljs-number">6.</span>服务端解密信息：<br>服务端用私钥解密<span class="hljs-number">5</span>步骤加密后的随机值之后，得到了客户端传过来的随机值(私钥)，然后把内容通过该值进行对称加密，对称加密就是将信息和私钥通过算法混合在一起，这样除非你知道私钥，不然是无法获取其内部的内容，而正好客户端和服务端都知道这个私钥，所以只要机密算法够复杂就可以保证数据的安全性。<br><br><span class="hljs-number">7.</span>传输加密后的信息:<br>服务端将用私钥加密后的数据传递给客户端，在客户端可以被还原出原数据内容。<br><br><span class="hljs-number">8.</span>客户端解密信息：<br>客户端用之前生成的私钥获解密服务端传递过来的数据，由于数据一直是加密的，因此即使第三方获取到数据也无法知道其详细内容。<br></code></pre></td></tr></table></figure>
<h3 id="2-6-1-https-配置参数"><a href="#2-6-1-https-配置参数" class="headerlink" title="2.6.1 https 配置参数"></a>2.6.1 https 配置参数</h3><p>nginx的https功能基于模块<code>ngx_http_ssl_module</code>实现，因此如果是编译安装的nginx要使⽤参数<code>ngx_http_ssl_module</code>开启ssl功能，但是作为nginx的核⼼功能，yum安装的nginx默认就是开启的，编译安装的nginx需要指定编译参数<code>--with-http_ssl_module</code>开启。</p>
<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://nginx.org/en/docs/http/ngx_http_ssl_module.html<br></code></pre></td></tr></table></figure>

<p>配置参数如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ssl</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span>;<br><span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br><span class="hljs-comment">#为指定的虚拟主机配置是否启⽤ssl功能，此功能在1.15.0废弃，使⽤listen [ssl]替代。</span><br><br><span class="hljs-attribute">ssl_certificate</span> /path/to/file;<br><span class="hljs-comment">#当前虚拟主机使⽤使⽤的公钥⽂件，⼀般是crt⽂件</span><br><br><span class="hljs-attribute">ssl_certificate_key</span> /path/to/file;<br><span class="hljs-comment">#当前虚拟主机使⽤的私钥⽂件，⼀般是key⽂件</span><br><br><span class="hljs-attribute">ssl_protocols</span> [SSLv2] [SSLv3] [TLSv1] [TLSv1.<span class="hljs-number">1</span>] [TLSv1.<span class="hljs-number">2</span>];<br><span class="hljs-comment">#⽀持ssl协议版本，早期为ssl,现在是TSL，默认为后三个</span><br><br><span class="hljs-attribute">ssl_session_cache</span> <span class="hljs-literal">off</span> | <span class="hljs-literal">none</span> | [builtin[:size]] [shared:name:size];<br><span class="hljs-comment">#配置ssl缓存</span><br>		off： <span class="hljs-comment">#关闭缓存</span><br>		none: <span class="hljs-comment">#通知客⼾端⽀持ssl session cache，但实际不⽀持</span><br>		builtin[:size]：<span class="hljs-comment">#使⽤OpenSSL内建缓存，为每worker进程私有</span><br>		[shared:name:size]：<span class="hljs-comment">#在各worker之间使⽤⼀个共享的缓存，需要定义⼀个缓存名称和缓存空间⼤⼩，⼀兆可以存储4000个会话信息，多个虚拟主机可以使⽤相同的缓存名称。</span><br>		<br><span class="hljs-attribute">ssl_session_timeout</span> time; <span class="hljs-comment">#客⼾端连接可以复⽤ssl session cache中缓存的有效时⻓，默认5m</span><br></code></pre></td></tr></table></figure>
<h3 id="2-6-2-实现自签名证书"><a href="#2-6-2-实现自签名证书" class="headerlink" title="2.6.2 实现自签名证书"></a>2.6.2 实现自签名证书</h3><h4 id="2-6-2-1-创建存放证书的文件夹"><a href="#2-6-2-1-创建存放证书的文件夹" class="headerlink" title="2.6.2.1 创建存放证书的文件夹"></a>2.6.2.1 创建存放证书的文件夹</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -p /apps/nginx/certs</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-2-生成Ca证书"><a href="#2-6-2-2-生成Ca证书" class="headerlink" title="2.6.2.2 生成Ca证书"></a>2.6.2.2 生成Ca证书</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /apps/nginx/certs</span><br><span class="hljs-comment"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 3650 -out ca.crt</span><br>Generating a 4096 bit RSA private key<br>.................++<br>.....<br>Country Name (2 letter code) [XX]:CN <span class="hljs-comment">#国家代码,https://country-code.cl/</span><br>State or Province Name (full name) []:GuangDong <span class="hljs-comment">#省份</span><br>Locality Name (eg, city) [Default City]:GuangZhou <span class="hljs-comment">#城市名称</span><br>Organization Name (eg, company) [Default Company Ltd]:rlin.Ltd <span class="hljs-comment">#公司名称</span><br>Organizational Unit Name (eg, section) []:it <span class="hljs-comment">#部⻔</span><br>Common Name (eg, your name or your server<span class="hljs-string">&#x27;s hostname) []:ca.rlin.com #通⽤名称</span><br><span class="hljs-string">Email Address []:346636558@qq.com #邮箱</span><br><span class="hljs-string"></span><br><span class="hljs-string">#ll #查看生成的文件</span><br><span class="hljs-string">-rw-r--r--  1 root  root  2130 Feb 16 06:28 ca.crt</span><br><span class="hljs-string">-rw-------  1 root  root  3272 Feb 16 06:28 ca.key</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-3-生成key和csr文件"><a href="#2-6-2-3-生成key和csr文件" class="headerlink" title="2.6.2.3 生成key和csr文件"></a>2.6.2.3 生成key和csr文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout www.rlin.com.key -out www.rlin.com.csr</span><br>Generating a 4096 bit RSA private key<br>..............++<br>..++<br>writing new private key to <span class="hljs-string">&#x27;www.rlin.com.key&#x27;</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Country Name (2 letter code) [XX]:CN<br>State or Province Name (full name) []:GuangDong<br>Locality Name (eg, city) [Default City]:GuangZhou<br>Organization Name (eg, company) [Default Company Ltd]:rlin.Ltd<br>Organizational Unit Name (eg, section) []:it<br>Common Name (eg, your name or your server<span class="hljs-string">&#x27;s hostname) []:www.rlin.com</span><br><span class="hljs-string">Email Address []:346636558@qq.com</span><br><span class="hljs-string"></span><br><span class="hljs-string">Please enter the following &#x27;</span>extra<span class="hljs-string">&#x27; attributes</span><br><span class="hljs-string">to be sent with your certificate request</span><br><span class="hljs-string">A challenge password []: #注意：密码不用填直接回车</span><br><span class="hljs-string">An optional company name []:</span><br><span class="hljs-string"></span><br><span class="hljs-string"># ls</span><br><span class="hljs-string">ca.crt  ca.key  www.rlin.com.csr  www.rlin.com.key</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-4-签发证书"><a href="#2-6-2-4-签发证书" class="headerlink" title="2.6.2.4 签发证书"></a>2.6.2.4 签发证书</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># openssl x509 -req -days 3650 -in www.rlin.com.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out www.rlin.com.crt</span><br>Signature ok<br>subject=/C=CN/ST=GuangDong/L=GuangZhou/O=rlin.Ltd/OU=it/CN=www.rlin.com/emailAddress=346636558@qq.com<br>Getting CA Private Key<br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-5-验证证书内容"><a href="#2-6-2-5-验证证书内容" class="headerlink" title="2.6.2.5 验证证书内容"></a>2.6.2.5 验证证书内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">Certificate:<br>    Data:<br>        Version: 1 (0x0)<br>        Serial Number:<br>            de:9a:96:ff:d7:<span class="hljs-built_in">fc</span>:45:3d<br>    Signature Algorithm: sha256WithRSAEncryption<br>        Issuer: C=CN, ST=GuangDong, L=GuangZhou, O=rlin.Ltd, OU=it, CN=ca.rlin.com/emailAddress=346636558@qq.com<br>        Validity<br>            Not Before: Nov 14 09:11:10 2022 GMT<br>            Not After : Nov 11 09:11:10 2032 GMT<br>        Subject: C=CN, ST=GuangDong, L=GuangZhou, O=rlin.Ltd, OU=it, CN=www.rlin.com/emailAddress=346636558@qq.com<br>        Subject Public Key Info:<br>            Public Key Algorithm: rsaEncryption<br>                Public-Key: (4096 bit)<br>                Modulus:<br>                   ......<br>                Exponent: 65537 (0x10001)<br>    Signature Algorithm: sha256WithRSAEncryption<br>         ......<br></code></pre></td></tr></table></figure>
<h3 id="2-6-3-nginx证书配置"><a href="#2-6-3-nginx证书配置" class="headerlink" title="2.6.3 nginx证书配置"></a>2.6.3 nginx证书配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>    <span class="hljs-attribute">ssl_certificate</span> /apps/nginx/certs/www.rlinpc.net.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> /apps/nginx/certs/www.rlinpc.net.key;<br>    <span class="hljs-attribute">ssl_session_cache</span> shared:sslcache:<span class="hljs-number">20m</span>;<br>    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br>浏览器访问 https://www.rlinpc.<span class="hljs-attribute">net</span> ，出现不信任，就在高级里点击继续访问<br></code></pre></td></tr></table></figure>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-zhengshuyanzheng.jpg" srcset="/blog/img/loading.gif" alt="Nginx证书验证"></p>
<h3 id="2-6-4-实现多域名https"><a href="#2-6-4-实现多域名https" class="headerlink" title="2.6.4 实现多域名https"></a>2.6.4 实现多域名https</h3><p>Nginx⽀持基于单个IP实现多域名的功能，并且还⽀持单IP多域名的基础之上实现HTTPS，其实是基于Nginx的SNI（Server Name Indication）功能实现，SNI是为了解决⼀个Nginx服务器内使⽤⼀个IP绑定多个域名和证书的功能，其具体功能是客⼾端在连接到服务器建⽴SSL链接之前先发送要访问站点的域名（Hostname），这样服务器再根据这个域名返回给客⼾端⼀个合适的证书。</p>
<p>自制证书可以使用这个项目：<a target="_blank" rel="noopener" href="https://github.com/Fishdrowned/ssl">https://github.com/Fishdrowned/ssl</a></p>
<h4 id="2-6-4-1-制作新的key和csr⽂件"><a href="#2-6-4-1-制作新的key和csr⽂件" class="headerlink" title="2.6.4.1 制作新的key和csr⽂件"></a>2.6.4.1 制作新的key和csr⽂件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout mobile.rlin.net.key -out mobile.rlin.net.csr</span><br>Generating a 4096 bit RSA private key<br>....................................++<br>.....++<br>writing new private key to <span class="hljs-string">&#x27;mobile.rlin.net.key&#x27;</span><br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Country Name (2 letter code) [XX]:CN<br>State or Province Name (full name) []:GuangDong<br>Locality Name (eg, city) [Default City]:GuangZhou <br>Organization Name (eg, company) [Default Company Ltd]:rlin.Ltd<br>Organizational Unit Name (eg, section) []:it<br>Common Name (eg, your name or your server<span class="hljs-string">&#x27;s hostname) []:mobile.rlin.net</span><br><span class="hljs-string">Email Address []:346636558@qq.com</span><br><span class="hljs-string"></span><br><span class="hljs-string">Please enter the following &#x27;</span>extra<span class="hljs-string">&#x27; attributes</span><br><span class="hljs-string">to be sent with your certificate request</span><br><span class="hljs-string">A challenge password []:</span><br><span class="hljs-string">An optional company name []:</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-4-2-签名新的证书"><a href="#2-6-4-2-签名新的证书" class="headerlink" title="2.6.4.2 签名新的证书"></a>2.6.4.2 签名新的证书</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">openssl x509 -req -days 3650 -<span class="hljs-keyword">in</span> mobile.rlin.net.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out mobile.rlin.net.crt <br>Signature ok<br>subject=/C=CN/ST=GuangDong/L=GuangZhou/O=rlin.Ltd/OU=it/CN=mobile.rlin.net/emailAddress=346636558@qq.com<br>Getting CA Private Key<br></code></pre></td></tr></table></figure>

<h4 id="2-6-4-3-验证新证书内容"><a href="#2-6-4-3-验证新证书内容" class="headerlink" title="2.6.4.3 验证新证书内容"></a>2.6.4.3 验证新证书内容</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># openssl x509 -in mobile.rlin.net.crt -noout -text</span><br>Certificate:<br>    Data:<br>        Version: 1 (0x0)<br>        Serial Number:<br>            de:9a:96:ff:d7:<span class="hljs-built_in">fc</span>:45:3f<br>    Signature Algorithm: sha256WithRSAEncryption<br>        Issuer: C=CN, ST=GuangDong, L=GuangZhou, O=rlin.Ltd, OU=it, CN=ca.rlin.com/emailAddress=346636558@qq.com<br>        Validity<br>            Not Before: Nov 14 11:11:56 2022 GMT<br>            Not After : Nov 11 11:11:56 2032 GMT<br>        Subject: C=CN, ST=GuangDong, L=GuangZhou, O=rlin.Ltd, OU=it, CN=mobile.rlin.net/emailAddress=346636558@qq.com<br>        Subject Public Key Info:<br>            Public Key Algorithm: rsaEncryption<br>                Public-Key: (4096 bit)<br>                Modulus:<br>                    ......<br>                Exponent: 65537 (0x10001)<br>    Signature Algorithm: sha256WithRSAEncryption<br>         ......<br></code></pre></td></tr></table></figure>

<h4 id="2-6-4-4-修改nginx配置"><a href="#2-6-4-4-修改nginx配置" class="headerlink" title="2.6.4.4 修改nginx配置"></a>2.6.4.4 修改nginx配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/mobile.conf</span><br>server &#123;<br>	listen 80;<br>	server_name mobile.rlin.net;<br>	location / &#123;<br>	root html;<br>	index index.html index.htm;<br>	&#125;<br>	location /linux38 &#123;<br>	root /data/nginx/html/mobile;<br>	index index.html index.htm;<br>	&#125;<br>	location /python &#123;<br>	root /data/nginx/html/mobile;<br>	index index.html index.htm;<br>	&#125;<br>&#125;<br>server &#123;<br>	<span class="hljs-comment">#一般公司的中小型网站值需要配置listen、ssl_certificate、ssl_certificate_key</span><br>	listen 443 ssl; <br>	server_name mobile.rlin.net;<br>	ssl_certificate /apps/nginx/certs/mobile.rlin.net.crt;<br>	ssl_certificate_key /apps/nginx/certs/mobile.rlin.net.key;<br>	ssl_session_cache shared:sslcache:20m;<br>	ssl_session_timeout 10m;<br>	location / &#123;<br>	root /data/nginx/html/mobile;<br>	index index.html index.htm;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器使用移动端访问 mobile.rlin.net.key</span><br></code></pre></td></tr></table></figure>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-mobilessl.png" srcset="/blog/img/loading.gif"></p>
<h3 id="2-6-5-实现-HSTS"><a href="#2-6-5-实现-HSTS" class="headerlink" title="2.6.5 实现 HSTS"></a>2.6.5 实现 HSTS</h3><p><strong>官方文档:</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/<br></code></pre></td></tr></table></figure>
<p>注意：</p>
<ol>
<li>配置rewrite才能实现http跳转到https</li>
<li>需要在全局或局部添加<code>add_header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains&quot; always;</code>这个配置。（always 参数可确保为所有响应（包括内部生成的错误响应）设置标头。旧版本的 NGINX（1.7.5 或 NGINX Plus R5 之前的版本）不支持 always 参数，也不会在内部生成的错误响应中设置标头。）</li>
</ol>
<p>范例1:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">ssl_certificate</span> /apps/nginx/certs/www.rlin.net.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> /apps/nginx/certs/www.rlin.net.key;<br>    <span class="hljs-attribute">ssl_session_cache</span> shared:sslcache:<span class="hljs-number">20m</span>;<br>    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">add_header</span> Strict-Transport-Security <span class="hljs-string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">if</span> ( $scheme = http ) &#123;<br>            <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(.*)$</span> https://www.rlinpc.net/<span class="hljs-variable">$1</span> <span class="hljs-literal">redirect</span>;    <span class="hljs-comment">#访问https重写到https</span><br>        &#125;<br>        <br>        <span class="hljs-attribute">if</span> (!-e $request_filename) &#123;<br>            <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(.*)</span> /index.html <span class="hljs-literal">last</span>; <span class="hljs-comment">#输错地址，强制跳到首页</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment"># curl -ikL https://www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<p>范例2：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">add_header</span> Strict-Transport-Security max-age=<span class="hljs-number">31536000</span>;<br>    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://$host$request_uri;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">ssl_certificate</span> /apps/nginx/certs/www.rlin.net.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> /apps/nginx/certs/www.rlin.net.key;<br>    <span class="hljs-attribute">ssl_session_cache</span> shared:sslcache:<span class="hljs-number">20m</span>;<br>    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">add_header</span> Strict-Transport-Security <span class="hljs-string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">if</span> ( $scheme = http ) &#123;<br>            <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(.*)$</span> https://www.rlinpc.net/<span class="hljs-variable">$1</span> <span class="hljs-literal">redirect</span>;    <br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment"># curl -ikL https://www.rlinpc.net</span><br></code></pre></td></tr></table></figure>





<h3 id="2-6-6-关于favicon-ico"><a href="#2-6-6-关于favicon-ico" class="headerlink" title="2.6.6 关于favicon.ico"></a>2.6.6 关于favicon.ico</h3><p>favicon.ico 文件是浏览器收藏网址时显示的图标，当客户端使用浏览器问页面时，浏览器会自己主动发起请求获取页面的favicon.ico文件，但是当浏览器请求的favicon.ico文件不存在时，服务器会记录404日志，而且浏览器也会显示404报错</p>
<p>下载ico图片，将图片放在/opt/static</p>
<p>解决方法：</p>
<p><strong>方法一：服务器不记录访问日志：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlin.com;<br>    <span class="hljs-attribute">location</span> = /favicon.ico &#123;<br>        <span class="hljs-attribute">log_not_found</span> <span class="hljs-literal">off</span>;<br>        <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>
<p><strong>方法二：将图标保存到指定目录访问</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># mkdir -p /opt/static</span><br><span class="hljs-comment"># cd /opt/static</span><br><span class="hljs-comment"># wget ico图片地址</span><br><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlin.com;<br>    <span class="hljs-attribute">location</span> = /favicon.ico&#123;<br>        <span class="hljs-attribute">root</span> /opt/static;<br>        <span class="hljs-attribute">expires</span> <span class="hljs-number">90d</span>; <span class="hljs-comment">#设置⽂件过期时间</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>
<h2 id="2-7-安全选项"><a href="#2-7-安全选项" class="headerlink" title="2.7 安全选项"></a>2.7 安全选项</h2><h3 id="2-7-1-隐藏nginx版本号"><a href="#2-7-1-隐藏nginx版本号" class="headerlink" title="2.7.1 隐藏nginx版本号"></a>2.7.1 隐藏nginx版本号</h3><p><strong>注意：更改nginx源码信息并重新编译nginx</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#更改nginx源码信息</span><br><span class="hljs-comment"># vim /usr/local/src/nginx-1.6.1/src/http/ngx_http_header_filter_module.c</span><br><span class="hljs-comment">#在第49行，定义响应报⽂中的server字段信息</span><br>static u_char ngx_http_server_string[] = <span class="hljs-string">&quot;Server: rlin-nginx&quot;</span> CRLF; <span class="hljs-comment">#定义响应报文中的server字段信息</span><br><br><span class="hljs-comment">#获取原nginx编译信息</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -V</span><br><br><span class="hljs-comment">#关闭nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s stop</span><br><br><span class="hljs-comment">#重新编译</span><br><span class="hljs-comment"># cd /usr/local/src/nginx-1.16.1/</span><br><span class="hljs-comment"># ./configure --prefix=/apps/nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_image_filter_module --with-http_geoip_module --with-http_gunzip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module</span><br><span class="hljs-comment"># make</span><br><span class="hljs-comment"># make install</span><br><br><span class="hljs-comment">#启动nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx </span><br><span class="hljs-comment">#浏览器访问https://www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<h3 id="2-7-2-升级OpenSSL版本"><a href="#2-7-2-升级OpenSSL版本" class="headerlink" title="2.7.2 升级OpenSSL版本"></a>2.7.2 升级OpenSSL版本</h3><p>⼼脏出⾎（英语：Heartbleed），也简称为⼼⾎漏洞，是⼀个出现在加密程序库OpenSSL的安全漏洞，该程序库⼴泛⽤于实现互联⽹的传输层安全（TLS）协议。它于2012年被引⼊了软件中，2014年4⽉⾸次向公众披露。只要使⽤的是存在缺陷的OpenSSL实例，⽆论是服务器还是客⼾端，都可能因此⽽受到攻击。此问题的原因是在实现TLS的⼼跳扩展时没有对输⼊进⾏适当验证（缺少边界检查），因此漏洞的名称来源于“⼼跳”（heartbeat）。该程序错误属于缓冲区过读，即可以读取的数据⽐应该允许读取的还多。</p>
<h4 id="2-7-2-1-关闭nginx"><a href="#2-7-2-1-关闭nginx" class="headerlink" title="2.7.2.1 关闭nginx"></a>2.7.2.1 关闭nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#关闭nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s stop</span><br></code></pre></td></tr></table></figure>

<h4 id="2-7-2-2-下载openssl源码包"><a href="#2-7-2-2-下载openssl源码包" class="headerlink" title="2.7.2.2 下载openssl源码包"></a>2.7.2.2 下载openssl源码包</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># wget https://github.com/openssl/openssl/archive/refs/tags/OpenSSL_1_1_1d.tar.gz</span><br><span class="hljs-comment"># tar xvf OpenSSL_1_1_1d.tar.gz</span><br></code></pre></td></tr></table></figure>

<h4 id="2-7-2-3-重新编译nginx"><a href="#2-7-2-3-重新编译nginx" class="headerlink" title="2.7.2.3 重新编译nginx"></a>2.7.2.3 重新编译nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># cd /usr/local/src/nginx-1.6.1</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -V</span><br><span class="hljs-comment"># ./configure --prefix=/apps/nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_image_filter_module --with-http_geoip_module --with-http_gunzip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module --with-openssl=/usr/local/src/openssl-OpenSSL_1_1_1d</span><br><span class="hljs-comment"># make</span><br><span class="hljs-comment"># make install</span><br></code></pre></td></tr></table></figure>

<h4 id="2-7-2-4-验证并启动Nginx"><a href="#2-7-2-4-验证并启动Nginx" class="headerlink" title="2.7.2.4 验证并启动Nginx"></a>2.7.2.4 验证并启动Nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx</span><br></code></pre></td></tr></table></figure>

<h1 id="三、Nginx-rewrite-相关功能"><a href="#三、Nginx-rewrite-相关功能" class="headerlink" title="三、Nginx rewrite 相关功能"></a>三、Nginx rewrite 相关功能</h1><p>Nginx服务器利⽤<code>ngx_http_rewrite_module</code>模块解析和处理rewrite请求，此功能依靠 PCRE(perl compatibleregularexpression)，因此编译之前要安装PCRE库，rewrite是nginx服务器的重要功能之⼀，⽤于实现URL的重写，URL的重写是⾮常有⽤的功能，⽐如它可以在我们改变⽹站结构之后，不需要客⼾端修改原来的书签，也⽆需其他⽹站修改我们的链接，就可以设置为访问，另外还可以在⼀定程度上提⾼⽹站的安全性。</p>
<h2 id="3-1-ngx-http-rewrite-module"><a href="#3-1-ngx-http-rewrite-module" class="headerlink" title="3.1 ngx_http_rewrite_module"></a>3.1 ngx_http_rewrite_module</h2><p><strong>官方文档:</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html<br></code></pre></td></tr></table></figure>

<h3 id="3-1-1-if指令"><a href="#3-1-1-if指令" class="headerlink" title="3.1.1 if指令"></a>3.1.1 if指令</h3><p>⽤于条件匹配判断，并根据条件判断结果选择不同的Nginx配置，可以配置在server或location块中进⾏配置，Nginx的if语法仅能使⽤if做单次判断，不⽀持使⽤if else或者if elif这样的多重判断，⽤法如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span> （条件匹配） &#123;<br>	action<br>&#125;<br></code></pre></td></tr></table></figure>
<p>使⽤正则表达式对变量进⾏匹配，匹配成功时if指令认为条件为true，否则认为false，变量与表达式之间使⽤以下符号链接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">= <span class="hljs-comment">#⽐较变量和字符串是否相等，相等时if指令认为该条件为true，反之为false。</span><br>!= <span class="hljs-comment">#⽐较变量和字符串是否不相等，不相等时if指令认为条件为true，反之为false。</span><br>~ <span class="hljs-comment">#表⽰在匹配过程中区分⼤⼩写字符，（可以通过正则表达式匹配），满⾜匹配条件为真，不满⾜为假。</span><br>!~ <span class="hljs-comment">#为区分⼤⼩写字符且匹配结果不匹配，不满⾜为真，满⾜为假。</span><br>~* <span class="hljs-comment">#表⽰在匹配过程中不区分⼤⼩写字符，（可以通过正则表达式匹配），满⾜匹配条件为真，不满⾜为假。</span><br>!~* <span class="hljs-comment">#为不区分⼤⼩字符且匹配结果不匹配，满⾜为假，不满⾜为真。</span><br>-f 和 ! -f <span class="hljs-comment">#判断请求的⽂件是否存在和是否不存在</span><br>-d 和 ! -d <span class="hljs-comment">#判断请求的⽬录是否存在和是否不存在。</span><br>-x 和 ! -x <span class="hljs-comment">#判断⽂件是否可执⾏和是否不可执⾏。</span><br>-e 和 ! -e <span class="hljs-comment">#判断请求的⽂件或⽬录是否存在和是否不存在(包括⽂件，⽬录，软链接)。</span><br></code></pre></td></tr></table></figure>
<p><strong>注： 如果$变量的值为空字符串或是以0开头的任意字符串，则if指令认为该条件为false，其他条件为true。</strong></p>
<h4 id="3-1-1-1-范例1"><a href="#3-1-1-1-范例1" class="headerlink" title="3.1.1.1 范例1"></a>3.1.1.1 范例1</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">default_type</span> text/html;<br>        <span class="hljs-attribute">if</span> ( $scheme = http )&#123;<br>            <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;if-----&gt; $scheme&quot;</span>;<br>        &#125;<br>        <span class="hljs-attribute">if</span> ( $scheme = https )&#123;<br>            <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;if--rlin---&gt; $scheme&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#检查语法并重新加载nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#浏览器访问</span><br>http://www.rlinpc.<span class="hljs-attribute">conf</span><br>https://www.rilnpc.conf<br></code></pre></td></tr></table></figure>
<h4 id="3-1-1-2-范例2"><a href="#3-1-1-2-范例2" class="headerlink" title="3.1.1.2 范例2"></a>3.1.1.2 范例2</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">default_type</span> text/html;<br>        <span class="hljs-attribute">if</span> (-f $request_filename) &#123;<br>            <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;file is exist&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#检查语法并重新加载nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">default_type</span> text/html;<br>        <span class="hljs-attribute">if</span> (!-f $request_filename) &#123;<br>            <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;file is not exist&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#检查语法并重新加载nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问</span><br></code></pre></td></tr></table></figure>

<h3 id="3-1-2-set指令"><a href="#3-1-2-set指令" class="headerlink" title="3.1.2 set指令"></a>3.1.2 set指令</h3><p>指定key并给其定义⼀个变量，变量可以调⽤Nginx内置变量赋值给key，另外set定义格式为set $key $value，及⽆论是key还是value都要加$符号。（类似nginx的自定义变量）</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /&#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">default_type</span> text/html;<br>        <span class="hljs-attribute">set</span> $NAME rlin;<br>        <span class="hljs-attribute">echo</span> $NAME;<br>        <span class="hljs-attribute">set</span> $MY_PORT $server_port;<br>        <span class="hljs-attribute">echo</span> $MY_PORT;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#检查语法并重新加载nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<h3 id="3-1-3-break指令"><a href="#3-1-3-break指令" class="headerlink" title="3.1.3 break指令"></a>3.1.3 break指令</h3><p><strong>用于中断当前相同作用域(location)中的其他Nginx配置，与该指令处于同⼀作用域的Nginx配置中，位于它前面的配置⽣效，位于后面的指令配置就不再⽣效了。</strong>Nginx服务器在根据配置处理请求的过程中遇到该指令的时候，回到上⼀层作⽤域继续向下读取配置，该指令可以在server块和location块以及if块中使⽤，使⽤语法如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">location</span> /main &#123;<br>	  <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>	  <span class="hljs-attribute">index</span> index.html;<br>	  <span class="hljs-attribute">default_type</span> text/html;<br>	  <span class="hljs-attribute">set</span> $name magedu;<br>   	  <span class="hljs-attribute">echo</span> $name;<br>	  break;<br>	  <span class="hljs-attribute">set</span> $my_port $server_port;<br>	  <span class="hljs-attribute">echo</span> $my_port;<br> &#125;<br>&#125;<br><br><span class="hljs-comment">#检查语法并重新加载nginx</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<h3 id="3-1-4-return指令"><a href="#3-1-4-return指令" class="headerlink" title="3.1.4 return指令"></a>3.1.4 return指令</h3><p>从nginx版本0.8.2开始⽀持，return⽤于完成对请求的处理，并直接向客⼾端返回响应状态码，⽐如其可以指定重定向URL(对于特殊重定向状态码，301/302等) 或者是指定提⽰⽂本内容(对于特殊状态码403/500等)，处于此指令后的所有配置都将不被执⾏，return可以在server、if和location块进⾏配置，⽤法如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">return</span> code; <span class="hljs-comment">#返回给客⼾端指定的HTTP状态码</span><br><span class="hljs-attribute">return</span> code (text); <span class="hljs-comment">#返回给客⼾端的状态码及响应体内容，可以调⽤变量</span><br><span class="hljs-attribute">return</span> code URL； <span class="hljs-comment">#返回给客⼾端的URL地址</span><br><br><span class="hljs-comment">#例如：</span><br>server &#123;<br>     <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>     <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>     <span class="hljs-attribute">location</span> /main &#123;<br>     <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>     <span class="hljs-attribute">default_type</span> text/html;<br>     <span class="hljs-attribute">index</span> index.html;<br>     <span class="hljs-attribute">if</span> ( $scheme = http )&#123;<br>        <span class="hljs-comment">#return 666;</span><br>        <span class="hljs-comment">#return 666 &quot;not allow http&quot;;</span><br>        <span class="hljs-comment">#return 301 http://www.baidu.com;</span><br>        <span class="hljs-attribute">return</span> <span class="hljs-number">500</span> <span class="hljs-string">&quot;service error&quot;</span>;<br>         <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;if-----&gt; $scheme&quot;</span>; <span class="hljs-comment">#return后⾯的将不再执⾏</span><br>     &#125;<br>     <span class="hljs-attribute">if</span> ( $scheme = https )&#123;<br>        <span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;if ----&gt; $scheme&quot;</span>;<br>     &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<h4 id="3-1-4-1-范例1"><a href="#3-1-4-1-范例1" class="headerlink" title="3.1.4.1 范例1"></a>3.1.4.1 范例1</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net<br>    location /index2 &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html<br>        retuen <span class="hljs-number">999</span> <span class="hljs-string">&quot;rlin&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment"># mkdir -p /data/nginx/html/pc/index2/</span><br><span class="hljs-comment"># echo &quot;index2&quot; &gt; /data/nginx/html/pc/index2/index.html</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net/index2</span><br></code></pre></td></tr></table></figure>
<h4 id="3-1-4-2-范例2"><a href="#3-1-4-2-范例2" class="headerlink" title="3.1.4.2 范例2"></a>3.1.4.2 范例2</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /index2 &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html；<br>        retuen <span class="hljs-number">301</span> http://www.jd.com;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net/index2</span><br></code></pre></td></tr></table></figure>
<h4 id="3-1-4-3-范例3：简单实现https1"><a href="#3-1-4-3-范例3：简单实现https1" class="headerlink" title="3.1.4.3 范例3：简单实现https1"></a>3.1.4.3 范例3：简单实现https1</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">default_type</span> text/html;<br>        <span class="hljs-attribute">if</span> ( $scheme = http )&#123;<br>            <span class="hljs-attribute">retuen</span> <span class="hljs-number">301</span> https://www.bilibili.com;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<h4 id="3-1-4-4-范例3：简单实现https2"><a href="#3-1-4-4-范例3：简单实现https2" class="headerlink" title="3.1.4.4 范例3：简单实现https2"></a>3.1.4.4 范例3：简单实现https2</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-comment">#add_header StrictTransport-Security max-age=15768000;</span><br>    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://$server_name$request_uri;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        ......;<br>    &#125;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">ssl_certificate</span> /apps/nginx/certs/www.rlinpc.net.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> /apps/nginx/certs/www.rlinpc.net.key;<br>    <span class="hljs-attribute">ssl_session_cache</span> shared:sslcache:<span class="hljs-number">20m</span>;<br>    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;<br>    <span class="hljs-attribute">ssl_prefer_server_ciphers</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">ssl_protocols</span> TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        ......;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h3 id="3-1-5-rewrite-log指令"><a href="#3-1-5-rewrite-log指令" class="headerlink" title="3.1.5 rewrite_log指令"></a>3.1.5 rewrite_log指令</h3><p>设置是否开启记录<code>ngx_http_rewrite_module</code>模块日志记录到error_log日志文件当中，可以配置在http、server、location或if当中。</p>
<p><strong>注意：需要日志级别为notice 。</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>     <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>     <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>     <span class="hljs-attribute">location</span> /main &#123;<br>     <span class="hljs-attribute">index</span> index.html;<br>     <span class="hljs-attribute">default_type</span> text/html;<br>     <span class="hljs-attribute">set</span> $name rlin;<br>     <span class="hljs-attribute">echo</span> $name;<br>     <span class="hljs-attribute">rewrite_log</span> <span class="hljs-literal">on</span>;<br>     break;<br>     <span class="hljs-attribute">set</span> $my_port $server_port;<br>     <span class="hljs-attribute">echo</span> $my_port;<br>     &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nignx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#浏览器访问网站，并验证error_log</span><br><span class="hljs-comment"># tail -f /apps/nginx/logs/error.log</span><br></code></pre></td></tr></table></figure>
<h2 id="3-2-rewrite指令"><a href="#3-2-rewrite指令" class="headerlink" title="3.2 rewrite指令"></a>3.2 rewrite指令</h2><p>通过正则表达式的匹配来改变URI，可以同时存在⼀个或多个指令，按照顺序依次对URI进⾏匹配，rewrite主要是针对⽤⼾请求的URL或者是URI做具体处理，以下是URL和URI的具体介绍：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">URI(universal resource identifier)：通⽤资源标识符，标识⼀个资源的路径，可以不带协议。<br><br>URL(uniform resource location):统⼀资源定位符，是⽤于在Internet中描述资源的字符串，是URI的⼦集，主要包括传输协议(scheme)、主机(IP、端⼝号或者域名)和资源具体地址(⽬录和⽂件名)等三部分，⼀般格式为scheme://主机名[:端⼝号][/资源路径],如http://www.a.com:8080/path/file/index.html就是⼀个URL路径，URL必须带访问协议。<br><br>每个URL都是⼀个URI，但是URI不都是URL。<br><br>例如：<br>http://example.org:8080/path/to/resource.txt <span class="hljs-comment">#URI/URL</span><br>ftp://example.org/resource.txt <span class="hljs-comment">#URI/URL</span><br>/absolute/path/to/resource.txt <span class="hljs-comment">#URI</span><br></code></pre></td></tr></table></figure>
<p>rewrite的官⽅介绍地址<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite%EF%BC%8C">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite，</a> rewrite可以配置在server、location、if，其具体使用方式为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rewrite regex replacement [flag];<br></code></pre></td></tr></table></figure>
<p>rewrite将用户请求的URI基于regex所描述的模式进行检查，匹配到时将其替换为表达式指定的新的URI。 注意：如果在同⼀级配置块中存在多个rewrite规则，那么会⾃下而下逐个检查；被某条件规则替换完成后，会重新⼀轮的替换检查，隐含有循环机制，但不超过10次；如果超过，提示500响应码，[flag]所表⽰的标志位⽤于控制此循环机制，如果替换后的URL是以<code>http://</code>或<code>https://</code>开头，则替换结果会直接以重向返回给客⼾端, 即永久重定向301<br><strong>正则表达式格式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">. <span class="hljs-comment">#匹配除换行符以外的任意字符</span><br>\w <span class="hljs-comment">#匹配字母或数字或下划线或汉字</span><br>\s <span class="hljs-comment">#匹配任意的空白符</span><br>\d <span class="hljs-comment">#匹配数字</span><br>\b <span class="hljs-comment">#匹配单词的开始或结束</span><br>^ <span class="hljs-comment">#匹配字付串的开始</span><br>$ <span class="hljs-comment">#匹配字符串的结束</span><br>* <span class="hljs-comment">#匹配重复零次或更多次</span><br>+ <span class="hljs-comment">#匹配重复一次或更多次</span><br>? <span class="hljs-comment">#匹配重复零次或一次</span><br>(n) <span class="hljs-comment">#匹配重复n次</span><br>&#123;n,&#125; <span class="hljs-comment">#匹配重复n次或更多次</span><br>&#123;n,m&#125; <span class="hljs-comment">#匹配重复n到m次</span><br>*? <span class="hljs-comment">#匹配重复任意次，但尽可能少重复</span><br>+? <span class="hljs-comment">#匹配重复1次或更多次，但尽可能少重复</span><br>?? <span class="hljs-comment">#匹配重复0次或1次，但尽可能少重复</span><br>&#123;n,m&#125;? <span class="hljs-comment">#匹配重复n到m次，但尽可能少重复</span><br>&#123;n,&#125;? <span class="hljs-comment">#匹配重复n次以上，但尽可能少重复</span><br>\W  <span class="hljs-comment">#匹配任意不是字母，数字，下划线，汉字的字符</span><br>\S <span class="hljs-comment">#匹配任意不是空白符的字符</span><br>\D <span class="hljs-comment">#匹配任意非数字的字符</span><br>\B <span class="hljs-comment">#匹配不是单词开头或结束的位置</span><br>[^x] <span class="hljs-comment">#匹配除了x以外的任意字符</span><br>[^rlin] <span class="hljs-comment">#匹配除了rlin 这几个字母以外的任意字符</span><br></code></pre></td></tr></table></figure>
<h3 id="3-2-1-rewrite-flag使用介绍"><a href="#3-2-1-rewrite-flag使用介绍" class="headerlink" title="3.2.1 rewrite flag使用介绍"></a>3.2.1 rewrite flag使用介绍</h3><p>利⽤nginx的rewrite的指令，可以实现url的重新跳转，rewrtie有四种不同的flag，分别是redirect(临时重定向)、permanent(永久重定向)、break和last。其中前两种是跳转型的flag，后两种是代理型。</p>
<ul>
<li><p>跳转型是指有客⼾端浏览器重新对新地址进⾏请求。</p>
</li>
<li><p>代理型是在WEB服务器内部实现跳转的。</p>
</li>
</ul>
<p><strong>rewrite 格式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">Syntax: rewrite regex replacement [flag]; <span class="hljs-comment">#通过正则表达式处理⽤⼾请求并返回替换后的数据包。</span><br>Default: — <br>Context: server, location, <span class="hljs-keyword">if</span><br></code></pre></td></tr></table></figure>
<p>flag 说明</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">redirect；<br><span class="hljs-comment">#临时重定向，重写完成后以临时重定向⽅式直接返回重写后⽣成的新URL给客⼾端，由客⼾端重新发起请求；使⽤相对路径,或者http://或https://开头，状态码：302</span><br><br>permanent；<br><span class="hljs-comment">#重写完成后以永久重定向⽅式直接返回重写后⽣成的新URL给客⼾端，由客⼾端重新发起请求，状态码：301</span><br><br>last；<br><span class="hljs-comment">#重写完成后停⽌对当前URI在当前location中后续的其它重写操作，⽽后对新的URL启动新⼀轮重写检查，不建议在location中使⽤</span><br><br><span class="hljs-built_in">break</span>；<br><span class="hljs-comment">#重写完成后停⽌对当前URL在当前location中后续的其它重写操作，⽽后直接将匹配结果返还给客⼾端即结束循环并返回数据给客⼾端，建议在location中使⽤</span><br></code></pre></td></tr></table></figure>
<p>要求：因业务需要，将访问源域名 <a target="_blank" rel="noopener" href="http://www.rlinpc.net/">www.rlinpc.net</a> 的请求永久重定向到<a target="_blank" rel="noopener" href="https://www.bilibili.com/">https://www.bilibili.com</a> 。</p>
<h4 id="3-2-1-1-范例：rewrite案例1-域名临时重定向"><a href="#3-2-1-1-范例：rewrite案例1-域名临时重定向" class="headerlink" title="3.2.1.1 范例：rewrite案例1-域名临时重定向"></a>3.2.1.1 范例：rewrite案例1-域名临时重定向</h4><p>临时重定向不会缓存域名解析记录(A记录)，但是永久重定向会缓存。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net<br>    location / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">if</span> ( $scheme = http )<br>            &#123;<br>            <span class="hljs-attribute">rewrite</span> / https://www.bilibili.com <span class="hljs-literal">redirect</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问 www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<h4 id="3-2-1-2-范例：rewrite案例2-域名永久重定向"><a href="#3-2-1-2-范例：rewrite案例2-域名永久重定向" class="headerlink" title="3.2.1.2 范例：rewrite案例2-域名永久重定向"></a>3.2.1.2 范例：rewrite案例2-域名永久重定向</h4><p>临时重定向不会缓存域名解析记录(A记录)，但是永久重定向会缓存。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    ......<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">if</span> ( $scheme = http )<br>            &#123;<br>            <span class="hljs-attribute">rewrite</span> / https://www.bilibili.com permanet;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问 www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<h3 id="3-2-2-rewrite案例–break与last"><a href="#3-2-2-rewrite案例–break与last" class="headerlink" title="3.2.2 rewrite案例–break与last"></a>3.2.2 rewrite案例–break与last</h3><p>要求：访问about的请求被转发至images，而访问images传递请求再次被转发至images1，以此测试last和break分别有什么区别</p>
<h4 id="3-2-2-1-break案例1"><a href="#3-2-2-1-break案例1" class="headerlink" title="3.2.2.1 break案例1"></a>3.2.2.1 break案例1</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#Nginx配置：</span><br>break测试案例：当客户端访问break的时候，测试通过rewrite将URL重写为test1，然后再通过rewrite将test1重写为test2测试两条write规则最终哪一条生效，并且测试重写后的URL会不会到其他location重新匹配。<br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /break &#123;<br>    <span class="hljs-comment">#return 666 &quot;break&quot;;</span><br>    <span class="hljs-attribute">root</span> /data/nginx;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/break/(.*)</span> /test1/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;  <span class="hljs-comment">#break匹配成功后不再向下匹配，也不会跳转到其他的location，即直接结束匹配并给客户端返回结果数据。</span><br>    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/test1/(.*)</span> /test2/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;  <span class="hljs-comment">#break不会匹配后面的rewrite规则也不匹配其他location</span><br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> = /test1 &#123;<br>    <span class="hljs-attribute">return</span> <span class="hljs-number">999</span> <span class="hljs-string">&quot;new test1&quot;</span>;<br>    <span class="hljs-comment">#index index.html;</span><br>    <span class="hljs-comment">#root /data/nginx;</span><br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> = /test2 &#123;<br>    <span class="hljs-attribute">return</span> <span class="hljs-number">666</span> <span class="hljs-string">&quot;new test2&quot;</span>;<br>    <span class="hljs-comment">#root /opt/nginx;</span><br>    <span class="hljs-comment">#index index.html;</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment"># curl -L http://www.rlinpc.net/test1 #看返回结果是否是new test1</span><br><span class="hljs-comment"># curl -L http://www.rlinpc.net/test2 #看返回结果是否是new test2</span><br><br><span class="hljs-comment">#创建资源路径：</span><br><span class="hljs-comment"># mkdir /data/nginx/break</span><br><span class="hljs-comment"># mkdir /data/nginx/test1</span><br><span class="hljs-comment"># mkdir /data/nginx/test2</span><br><br><span class="hljs-comment">#创建网页文件</span><br><span class="hljs-comment"># cat /data/nginx/break/index.html</span><br><span class="hljs-attribute">break</span><br><span class="hljs-comment">#cat /data/nginx/test1/index.html</span><br>test1<br><span class="hljs-comment"># cat /data/nginx/test2/index.html</span><br>test2 <br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#break访问测试：</span><br><span class="hljs-comment"># curl  -L http://www.magedu.net/break/index.html</span><br>test1 <span class="hljs-comment">#最终的结果不会超出当前break的location，并且不会继续匹配当前location后续的write规则，而是直接返回数据给客户端。</span><br></code></pre></td></tr></table></figure>
<h4 id="3-2-2-2-break案例2"><a href="#3-2-2-2-break案例2" class="headerlink" title="3.2.2.2 break案例2"></a>3.2.2.2 break案例2</h4><p>break适用于不改变客户端访问方式，但是要将访问的目的URL做单次重写的场景，比如有V1/V2两个版本的网站前端页面并存，旧版本的网站数据已经保存到了statics不能丢失，但是要将访问新版本的资源重写到新的静态资源路径到新的目录static：就算是访问旧的网站，也会帮你跳转到新的网站上</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#创建资源路径</span><br><span class="hljs-comment"># mkdir /data/nginx/static -p</span><br><span class="hljs-comment"># mkdir /data/nginx/statics -p</span><br><span class="hljs-comment">#创建网页文件</span><br><span class="hljs-comment"># echo &quot;v1&quot; &gt;&gt; /data/nginx/statics/rlin.js</span><br><span class="hljs-comment"># echo &quot;v2&quot; &gt;&gt; /data/nginx/static/rlin.js</span><br><br><span class="hljs-comment">#修改配置文件</span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /statics &#123;<br>    <span class="hljs-attribute">root</span> /data/nginx;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-comment">#rewrite ^/statics/(.*) /static/$1 break;</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net/statics/rlin.js</span><br><br><span class="hljs-comment">#再次修改配置文件</span><br><span class="hljs-attribute">vim</span> /apps/nginx/conf/conf.d/pc.conf<br>server &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /statics &#123;<br>    <span class="hljs-attribute">root</span> /data/nginx;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/statics/(.*)</span> /static/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net/statics/rlin.js</span><br><br><span class="hljs-comment">#对比两次浏览器显示的结果</span><br></code></pre></td></tr></table></figure>
<h4 id="3-2-3-3-last案例"><a href="#3-2-3-3-last案例" class="headerlink" title="3.2.3.3 last案例"></a>3.2.3.3 last案例</h4><p>last：对某个location的URL匹配成功后会停止当前location的后续rewrite规则，并结束当前location，然后将匹配生成的新URL跳转至其他location继续匹配，直到没有location可匹配后将最后一次location的数据返回给客户端。（在多个location之中来回匹配）</p>
<p>last 适用于要不改变客户端访问方式但是需做多次目的URL重写的场景，使用场景不是很多。</p>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /last &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/last/(.*)</span> /test1/<span class="hljs-variable">$1</span> <span class="hljs-literal">last</span>; <span class="hljs-comment">#跳转到 location /test1</span><br>        <span class="hljs-comment">#rewrite ^/test1/(.*) /test2/$1 last; #如果第一条rewrite规则匹配成功则不执行本条，否则执行本条rewrite规则。</span><br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /test1 &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx;<br>        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/test1/(.*)</span> /test2/<span class="hljs-variable">$1</span> <span class="hljs-literal">last</span>; <span class="hljs-comment">#跳转到 location /test2</span><br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /test2 &#123;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">666</span> <span class="hljs-string">&quot;new test2&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#浏览器访问</span><br><span class="hljs-comment"># curl -L http://www.rlinpc.net/last/index.html</span><br><span class="hljs-attribute">new</span> test2 <span class="hljs-comment">#结果会匹配多个location，直到最终全部匹配完成，返回最后一个location的匹配结果给客户端。</span><br><span class="hljs-comment">#last适用于要不改变客户端访问方式但是需做多次目的URL重写的场景，场景不是很多。</span><br></code></pre></td></tr></table></figure>
<h3 id="3-2-4-rewrite案例-自动跳转https1"><a href="#3-2-4-rewrite案例-自动跳转https1" class="headerlink" title="3.2.4 rewrite案例: 自动跳转https1"></a>3.2.4 rewrite案例: 自动跳转https1</h3><p>要求：基于通信安全考虑公司网站要求全站https，因此要求将在不影响用户请求的情况下将http请求全部自动跳转至https，另外也可以实现部分location跳转</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>    <span class="hljs-attribute">ssl_certificate</span> /apps/nginx/certs/www.rlinpc.net.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> /apps/nginx/certs/www.rlinpc.net.key;<br>    <span class="hljs-attribute">ssl_session_cache</span> shared:sslcache:<span class="hljs-number">20m</span>;<br>    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">location</span> / &#123;   <span class="hljs-comment">#针对全站跳转</span><br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">if</span> ($scheme = http )&#123;  <span class="hljs-comment">#如果没有加条件判断，会导致死循环</span><br>            <span class="hljs-attribute">rewrite</span> / https://$host <span class="hljs-literal">redirect</span>;<br>        &#125; <br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /login &#123;   <span class="hljs-comment">#针对特定的URL进行跳转https</span><br>        <span class="hljs-attribute">if</span> ($scheme = http )&#123;  <span class="hljs-comment">#如果没有加条件判断，会导致死循环</span><br>            <span class="hljs-attribute">rewrite</span> / https://$host/login <span class="hljs-literal">redirect</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment"># curl -ikL www.rlinpc.net</span><br>HTTP/1.1 302 <span class="hljs-attribute">Moved</span> Temporarily<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: Wed, <span class="hljs-number">17</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">42</span>:<span class="hljs-number">35</span> GMT<br>Content-Type: text/html<br>Content-Length: <span class="hljs-number">145</span><br>Connection: keep-alive<br>Location: https://www.rlinpc.net<br><br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: Wed, <span class="hljs-number">17</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">42</span>:<span class="hljs-number">35</span> GMT<br>Content-Type: text/html<br>Content-Length: <span class="hljs-number">14</span><br>Last-Modified: M<span class="hljs-literal">on</span>, <span class="hljs-number">15</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">22</span>:<span class="hljs-number">46</span>:<span class="hljs-number">17</span> GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;602af9b9-e&quot;</span><br>Accept-Ranges: bytes<br><br>rlin test web<br></code></pre></td></tr></table></figure>
<h3 id="3-2-5-rewrite案例-自动跳转https2"><a href="#3-2-5-rewrite案例-自动跳转https2" class="headerlink" title="3.2.5 rewrite案例: 自动跳转https2"></a>3.2.5 rewrite案例: 自动跳转https2</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-comment">#add_header StrictTransport-Security max-age=15768000;</span><br>    <span class="hljs-comment">#return 301 https://$server_name$request_uri;</span><br>    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^(.*)$</span> https://$host<span class="hljs-variable">$1</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        ......;<br>    &#125;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">ssl_certificate</span> /apps/nginx/certs/www.rlinpc.net.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> /apps/nginx/certs/www.rlinpc.net.key;<br>    <span class="hljs-attribute">ssl_session_cache</span> shared:sslcache:<span class="hljs-number">20m</span>;<br>    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;<br>    <span class="hljs-attribute">ssl_prefer_server_ciphers</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">ssl_protocols</span> TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        ......;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h3 id="3-2-6-范例-如果是因为规则匹配问题导致的陷入死循环"><a href="#3-2-6-范例-如果是因为规则匹配问题导致的陷入死循环" class="headerlink" title="3.2.6 范例: 如果是因为规则匹配问题导致的陷入死循环"></a>3.2.6 范例: 如果是因为规则匹配问题导致的陷入死循环</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -IkL http://www.rlin.com<br>HTTP/1.1 302 Moved Temporarily<br>Server: nginx/1.18.0<br>Date: Thu, 08 Oct 2020 13:07:19 GMT<br>Content-Type: text/html<br>Content-Length: 145<br>Connection: keep-alive<br>Location: https://www.rlin.com/<br>HTTP/1.1 302 Moved Temporarily<br>Server: nginx/1.18.0<br>Date: Thu, 08 Oct 2020 13:07:19 GMT<br>Content-Type: text/html<br>Content-Length: 145<br>Connection: keep-alive<br>Location: https://www.rlin.com/<br>HTTP/1.1 302 Moved Temporarily<br>Server: nginx/1.18.0<br>Date: Thu, 08 Oct 2020 13:07:19 GMT<br>Content-Type: text/html<br>Content-Length: 145<br>Connection: keep-alive<br>Location: https://www.rlin.com/<br>HTTP/1.1 302 Moved Temporarily<br>Server: nginx/1.18.0<br>Date: Thu, 08 Oct 2020 13:39:59 GMT<br>Content-Type: text/html<br>Content-Length: 145<br>Connection: keep-alive<br>Location: https://www.rlin.com<br><br>curl: (47) Maximum (50) redirects followed<br></code></pre></td></tr></table></figure>
<h3 id="3-2-7-rewrite-案例-判断文件是否存在"><a href="#3-2-7-rewrite-案例-判断文件是否存在" class="headerlink" title="3.2.7 rewrite 案例: 判断文件是否存在"></a>3.2.7 rewrite 案例: 判断文件是否存在</h3><p>要求：当用户访问到公司网站的时输入了一个错误的URL，可以将用户重定向至官网首页</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    server_name: www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">if</span> ( !-f $request_filename )&#123;<br>            <span class="hljs-attribute">rewrite</span> (.*) https://www.rlin.net/index.html; <span class="hljs-comment">#实现客户端浏览器的302跳转</span><br>            <span class="hljs-comment">#rewrite .* /index.html; #web服务器内部跳转</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<h3 id="3-2-8-rewrite案例：用非主流浏览器访问自动转条到相应的location里"><a href="#3-2-8-rewrite案例：用非主流浏览器访问自动转条到相应的location里" class="headerlink" title="3.2.8 rewrite案例：用非主流浏览器访问自动转条到相应的location里"></a>3.2.8 rewrite案例：用非主流浏览器访问自动转条到相应的location里</h3><p>范例：如果客户端浏览器包含MSIE，则rewrite客户端请求到/msie目录下</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>     <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>     <span class="hljs-attribute">server_name</span> www.rlinpc.net<br>     location / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">if</span> ( $http_user_agent <span class="hljs-regexp">~ MSIE)</span>&#123;<br>        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^(.*)$</span> /msie/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;<br>        &#125;<br>     &#125;<br>     <br>    <span class="hljs-attribute">location</span> = /msie &#123;<br>        ......;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br></code></pre></td></tr></table></figure>
<h3 id="3-2-9-rewrite案例范例：更换目录访问方式，目录转换为对象存储形式1"><a href="#3-2-9-rewrite案例范例：更换目录访问方式，目录转换为对象存储形式1" class="headerlink" title="3.2.9 rewrite案例范例：更换目录访问方式，目录转换为对象存储形式1"></a>3.2.9 rewrite案例范例：更换目录访问方式，目录转换为对象存储形式1</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#要求: www.rlinpc.net/20200706/static/ =&gt; www.rlinpc.net/static?id=20200706</span><br><br><span class="hljs-comment">#创建网页存放路径和网页文件</span><br><span class="hljs-comment"># mkdir /data/nginx/html/pc/static</span><br><span class="hljs-comment"># echo &#x27;20200706/static&#x27; &gt; /data/nginx/html/pc/static/index.html</span><br><br><span class="hljs-comment">#修改配置文件</span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /&#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(\d+)/(.+)/</span> /<span class="hljs-variable">$2</span>?id=<span class="hljs-variable">$1</span> <span class="hljs-literal">last</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#浏览器访问：www.rlinpc.net/20200706/static/</span><br></code></pre></td></tr></table></figure>
<h3 id="3-2-10-rewrite案例范例：更换目录访问方式，目录转换为对象存储形式2"><a href="#3-2-10-rewrite案例范例：更换目录访问方式，目录转换为对象存储形式2" class="headerlink" title="3.2.10 rewrite案例范例：更换目录访问方式，目录转换为对象存储形式2"></a>3.2.10 rewrite案例范例：更换目录访问方式，目录转换为对象存储形式2</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#要求: www.rlinpc.net/20200706/image/ =&gt; www.rlinpc.net/image?id=20200706</span><br><br><span class="hljs-comment">#创建网页存放路径和网页文件</span><br><span class="hljs-comment"># mkdir /data/nginx/html/pc/image</span><br><span class="hljs-comment"># echo &#x27;20200706/image&#x27; &gt; /data/nginx/html/pc/image/index.html</span><br><br><span class="hljs-comment">#修改配置文件</span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br>server &#123;<br>    listen 80;<br>    server_name www.rlinpc.net;<br>    location /&#123;<br>        root /data/nginx/html/pc;<br>        index index.html;<br>        rewrite ^/(\d+)/(.+)/ /<span class="hljs-variable">$2</span>?id=<span class="hljs-variable">$1</span> last;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#浏览器访问：www.rlinpc.net/20200706/image/</span><br></code></pre></td></tr></table></figure>

<h3 id="3-2-11-rewrite案例范例：多目录转换访问方式"><a href="#3-2-11-rewrite案例范例：多目录转换访问方式" class="headerlink" title="3.2.11 rewrite案例范例：多目录转换访问方式"></a>3.2.11 rewrite案例范例：多目录转换访问方式</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#要求: www.rlinpc.net/images/20200706/1.jpg =&gt; www.rlinpc.net/index.do?name=images&amp;dir=20200706=&amp;file=1.jpg</span><br><br><span class="hljs-comment">#修改配置文件</span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>     <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>     <span class="hljs-attribute">server_name</span> www.rlinpc.net<br>     location / &#123;<br>         <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>         <span class="hljs-attribute">index</span> index.html;<br>         <span class="hljs-attribute">if</span> ($host <span class="hljs-regexp">~* (.*)\.rlinpc\.net)</span> &#123;<br>         <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(.*)/(\d+)/(.*)$</span>  /index.do?name=<span class="hljs-variable">$1</span>&amp;dir=<span class="hljs-variable">$2</span>&amp;file=<span class="hljs-variable">$3</span> <span class="hljs-literal">last</span>; <span class="hljs-comment"># $1：images $2：20200706 $3：1.jpg</span><br>         &#125;<br>     &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问：www.rlinpc.net/images/20200706/1.jpg</span><br></code></pre></td></tr></table></figure>

<h2 id="3-3-nginx-防盗链"><a href="#3-3-nginx-防盗链" class="headerlink" title="3.3 nginx 防盗链"></a>3.3 nginx 防盗链</h2><p>防盗链基于客户端携带的referer实现，referer是记录打开一个页面之前记录是从哪个页面跳转过来的标记信息，如果别人只链接了自己网站图片或某个单独的资源，而不是打开了网站的整个页面，这就是盗链，referer就是之前的那个网站域名，正常的referer信息有以下几种：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">none：请求报文首部没有referer首部，比如用户直接在浏览器输入域名访问web网站，就没有referer信息。<br>blocked：请求报文有referer首部，但无有效值，比如为空。<br>server_names：referer首部中包含本主机名及即nginx 监听的server_name。<br>arbitrary_string：自定义指定字符串，但可使用*作通配符。<br>regular expression：被指定的正则表达式模式匹配到的字符串,要使用~开头，例如~.*\.magedu\.com。<br></code></pre></td></tr></table></figure>
<p>正常通过搜索引擎搜索web网站并访问该网站的referer信息如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#通过搜索引擎访问web网站的referer信息：</span><br>==&gt; <span class="hljs-regexp">/apps/</span>nginx<span class="hljs-regexp">/logs/</span>access_json.log &lt;==<br>&#123;<span class="hljs-string">&quot;@timestamp&quot;</span>:<span class="hljs-string">&quot;2019-02-28T13:58:46+08:00&quot;</span>,<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;192.168.7.102&quot;</span>,<span class="hljs-string">&quot;clientip&quot;</span>:<span class="hljs-string">&quot;192.168.0.1&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;responsetime&quot;</span>:<span class="hljs-number">0.000</span>,<span class="hljs-string">&quot;upstreamtime&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;upstreamhost&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;http_host&quot;</span>:<span class="hljs-string">&quot;www.magedu.net&quot;</span>,<span class="hljs-string">&quot;uri&quot;</span>:<span class="hljs-string">&quot;/index.html&quot;</span>,<span class="hljs-string">&quot;domain&quot;</span>:<span class="hljs-string">&quot;www.magedu.net&quot;</span>,<span class="hljs-string">&quot;xff&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;referer&quot;</span>:<span class="hljs-string">&quot;https://www.baidu.com/s?ie=utf-8&amp;f=8&amp;rsv_bp=1&amp;rsv_idx=1&amp;tn=baidu&amp;wd=www.magedu.net&amp;oq=www.mageedu.net&amp;rsv_pq=d63060680002eb69&amp;rsv_t=de01TWnmyTdcJqph7SfI1hXgXLJxSSfUPcQ3QkWdJk%2FLNrN95ih3XOhbRs4&amp;rqlang=cn&amp;rsv_enter=1&amp;inputT=321&amp;rsv_sug3=41&amp;rsv_sug2=0&amp;rsv_sug4=1626&quot;</span>,<span class="hljs-string">&quot;tcp_xff&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;http_user_agent&quot;</span>:<span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64)AppleWebKit/537.36 (KHTML, like Gecko)Chrome/72.0.3626.119 Safari/537.36&quot;</span>,<span class="hljs-string">&quot;status&quot;</span>:<span class="hljs-string">&quot;304&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-3-1-实现web盗链"><a href="#3-3-1-实现web盗链" class="headerlink" title="3.3.1 实现web盗链"></a>3.3.1 实现web盗链</h3><p>在一个web 站点盗链另一个站点的资源信息，比如图片、视频等。</p>
<p>范例：实现简单盗链</p>
<table>
<thead>
<tr>
<th>主机IP</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.101</td>
<td>盗链网站</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>源站</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#主机2</span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br>server &#123;<br>  listen 80;<br>  server_name www.rlinnpc.com;<br>  location / &#123;<br>    index index.html;<br>    root <span class="hljs-string">&quot;/data/nginx/html/pc&quot;</span>;<br>        access_log /apps/nginx/logs/www.rlinpc.com.log access_json;<br>   &#125;<br>&#125;<br><br><span class="hljs-comment">#准备盗链web页面：</span><br><span class="hljs-comment"># mkdir -p /data/nginx/html/pc</span><br><span class="hljs-comment"># vim /data/nginx/html/pc/index.html</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br> &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br> &lt;title&gt;盗链页面&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;a href=<span class="hljs-string">&quot;http://www.rlinpc.net&quot;</span>&gt;测试盗链&lt;/a&gt;<br>&lt;img src=<span class="hljs-string">&quot;http://www.rlinpc.net/images/1.jpg&quot;</span>/&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br><span class="hljs-comment">#主机1</span><br><span class="hljs-comment"># mkdir -p /data/nginx/html/images</span><br><span class="hljs-comment">#存放1.jpg</span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br>server &#123;<br>    listen 80;<br>    server_name www.rlinpc.net;<br>    location /images &#123;<br>       root /data/nginx/html/pc;<br>       index index.html;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#浏览器访问http://www.rlinnpc.net/ ,查看图片是否正常显示</span><br><span class="hljs-comment">#验证两个域名的日志，是否会在被盗连的web站点的日志中出现以下盗链日志信息：</span><br>（主要还是看referer信息后面的网址是否是搜索引擎或者是已知的地址）<br>==&gt; /apps/nginx/logs/www.rlinpc.com_access.log &lt;==<br>&#123;<span class="hljs-string">&quot;@timestamp&quot;</span>:<span class="hljs-string">&quot;2021-02-18T22:17:58+08:00&quot;</span>,<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.102&quot;</span>,<span class="hljs-string">&quot;clientip&quot;</span>:<span class="hljs-string">&quot;10.0.0.1&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:34,<span class="hljs-string">&quot;responsetime&quot;</span>:0.000,<span class="hljs-string">&quot;upstreamtime&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;upstreamhost&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;http_host&quot;</span>:<span class="hljs-string">&quot;www.rlinpc.com&quot;</span>,<span class="hljs-string">&quot;uri&quot;</span>:<span class="hljs-string">&quot;/favicon.ico&quot;</span>,<span class="hljs-string">&quot;domain&quot;</span>:<span class="hljs-string">&quot;www.rlinpc.com&quot;</span>,<span class="hljs-string">&quot;xff&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;referer&quot;</span>:<span class="hljs-string">&quot;http://www.rlinpc.com/&quot;</span>,<span class="hljs-string">&quot;tcp_xff&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;http_user_agent&quot;</span>:<span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36&quot;</span>,<span class="hljs-string">&quot;status&quot;</span>:<span class="hljs-string">&quot;200&quot;</span>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="3-3-2-实现防盗链"><a href="#3-3-2-实现防盗链" class="headerlink" title="3.3.2 实现防盗链"></a>3.3.2 实现防盗链</h3><p>基于访问安全考虑，nginx支持通过<code>ungx_http_referer_module</code>模块，检查访问请求的referer信息是否有效实现防盗链功能</p>
<p>官方文档地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://nginx.org/en/docs/http/ngx_http_referer_module.html#valid_referers<br></code></pre></td></tr></table></figure>

<p><strong>范例：实现防盗链</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /images &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">valid_referers</span> <span class="hljs-literal">none</span> <span class="hljs-literal">blocked</span> server_names <span class="hljs-regexp">*.rlin.com</span> <span class="hljs-regexp">*.rlin.org</span> ~\.google\. ~\.baidu\. ~\.bing\. ~\.so\. ~\.dogedoge\. ; <span class="hljs-comment">#定义有效的referer,允许访问</span><br>        <br>        <span class="hljs-attribute">if</span> ($invalid_referer)&#123; <span class="hljs-comment">#假如是使用其他的无效的referer访问</span><br>            <span class="hljs-attribute">return</span> <span class="hljs-number">403</span> <span class="hljs-string">&quot;Forbidden Access&quot;</span>; <span class="hljs-comment">#返回状态码403，拒绝访问</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/ngins -s reload</span><br><span class="hljs-comment">#浏览器访问盗链网址</span><br></code></pre></td></tr></table></figure>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fangdaolian1.jpg" srcset="/blog/img/loading.gif"><br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fangdaolian2.jpg" srcset="/blog/img/loading.gif"><br><strong>范例：实现防盗链</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    ......<br>    <span class="hljs-attribute">location</span> /images &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">valid_referers</span> <span class="hljs-literal">none</span> <span class="hljs-literal">blocked</span> server_names<br>            <span class="hljs-regexp">*.example.com</span> <span class="hljs-regexp">example.*</span> www.example.org/galleries/<br>            ~\.google\. ~\.baidu\.; <span class="hljs-comment">#定义有效的referer</span><br>        <br>        <span class="hljs-attribute">if</span> ($invalid_referer)&#123; <span class="hljs-comment">#假如是使用其他的无效的referer访问：</span><br>            <span class="hljs-attribute">return</span> <span class="hljs-number">403</span>; <span class="hljs-comment">#返回状态码403</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/ngins -s reload</span><br><span class="hljs-comment">#浏览器访问盗链网址</span><br></code></pre></td></tr></table></figure>
<p>在被盗链的nginx服务器查看日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">tail  /apps/nginx/logs/www.rlinpc.net_access.log<br>10.0.0.1 - - [18/Feb/2021:22:23:43 +0800] <span class="hljs-string">&quot;GET /images/1.jpg HTTP/1.1&quot;</span> 403 16 <span class="hljs-string">&quot;http://www.rlinpc.com/&quot;</span> <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36&quot;</span><br></code></pre></td></tr></table></figure>
<h2 id="3-4-其它相关高级功能"><a href="#3-4-其它相关高级功能" class="headerlink" title="3.4 其它相关高级功能"></a>3.4 其它相关高级功能</h2><p>第三方模块</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://github.com/agile6v/awesome-nginx/<br></code></pre></td></tr></table></figure>
<p>Lua 参考网站</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.runoob.com/lua/lua-tutorial.html<br></code></pre></td></tr></table></figure>
<p>自动生成 nginx 配置文件</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">#需要科学上网<br>https://www.digitalocean.com/community/tools/nginx<br></code></pre></td></tr></table></figure>

<h1 id="四、-Nginx反向代理功能"><a href="#四、-Nginx反向代理功能" class="headerlink" title="四、 Nginx反向代理功能"></a>四、 Nginx反向代理功能</h1><p>反向代理：反向代理也叫reverse proxy，指的是代理外网用户的请求到内部的指定web服务器，并将数据返回给用户的一种方式，这是用的比较多的一种方式。</p>
<p>Nginx除了可以在企业提供高性能的web服务之外，另外还可以将本身不具备的请求通过某种预定义的协议转发至其它服务器处理，不同的协议就是Nginx服务器与其他服务器进行通信的一种规范，主要在不同的场景使用以下模块实现不同的功能：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx">ngx_http_proxy_module： <span class="hljs-comment">#将客户端的请求以http协议转发至指定服务器进行处理。</span><br><span class="hljs-attribute">ngx_http_upstream_module</span> <span class="hljs-comment">#用于定义proxy_pass,fastcgi_pass,uwsgi_pass等指令引用的后端服务器分组</span><br>ngx_stream_proxy_module：<span class="hljs-comment">#将客户端的请求以tcp协议转发至指定服务器处理。</span><br>ngx_http_fastcgi_module：<span class="hljs-comment">#将客户端对php的请求以fastcgi协议转发至指定服务器助理。</span><br>ngx_http_uwsgi_module：<span class="hljs-comment">#将客户端对Python的请求以uwsgi协议转发至指定服务器处理。</span><br></code></pre></td></tr></table></figure>
<p>逻辑调用关系：<br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili1.jpg" srcset="/blog/img/loading.gif"><br><strong>生产环境部署结构：</strong><br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili2.jpg" srcset="/blog/img/loading.gif"><br>访问逻辑图：<br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili3.jpg" srcset="/blog/img/loading.gif"></p>
<h2 id="4-1-实现http反向代理"><a href="#4-1-实现http反向代理" class="headerlink" title="4.1 实现http反向代理"></a>4.1 实现http反向代理</h2><p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://nginx.org/en/docs/http/ngx_http_proxy_module.html<br></code></pre></td></tr></table></figure>

<h3 id="4-1-1-Nginx-http-协议反向代理入门"><a href="#4-1-1-Nginx-http-协议反向代理入门" class="headerlink" title="4.1.1 Nginx http 协议反向代理入门"></a>4.1.1 Nginx http 协议反向代理入门</h3><h4 id="4-1-1-1-反向代理配置参数proxy-pass"><a href="#4-1-1-1-反向代理配置参数proxy-pass" class="headerlink" title="4.1.1.1 反向代理配置参数proxy_pass"></a>4.1.1.1 反向代理配置参数<code>proxy_pass</code></h4><p>用来设置将客户端请求转发给的后端服务器的主机，可以是主机名(将转发至后端服务做为主机头首部)、IP地址：端口的方式</p>
<p>也可以代理到预先设置的主机群组，需要模块<code>ngx_http_upstream_module</code>支持</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_pass</span> URL;<br>Default:	—<br>Context:	location, <span class="hljs-attribute">if</span> in location, limit_except<br></code></pre></td></tr></table></figure>

<p>范例1：</p>
<p>proxy_pass指定的URI不带斜线将访问的/web，等于访问后端服务器<code>http://10.0.0.18:8080/web/index.html</code>，即后端服务器配置的站点根目录要有web目录才可以被访问</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> /web &#123; <br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">proxy_pass</span> http://10.0.0.18:8080; <span class="hljs-comment">#8080后面无&quot;/&quot;符号,需要将location后面 url 附加到proxy_pass指定的url后面,类似于root</span><br>&#125;<br><span class="hljs-comment">#浏览器做如下转换：</span><br><span class="hljs-comment">#http://nginx/web/index.html ==&gt; http://10.0.0.18:8080/web/index.html</span><br></code></pre></td></tr></table></figure>

<p>范例2：</p>
<p>proxy_pass指定的URI带斜线，等于访问后端服务器的<code>http://10.0.0.18:8080/index.html</code> 内容返回给客户端</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> /web &#123;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">proxy_pass</span> http://10.0.0.18:8080/; <span class="hljs-comment">#8080后面有&quot;/&quot;符号,相当于置换,即访问/web时实际返回proxy_pass后面uri内容.类似于alias</span><br>&#125;<br><span class="hljs-comment">#浏览器做如下转换：</span><br><span class="hljs-comment">#http://nginx/web/index.html ==&gt; http://10.0.0.18:8080</span><br></code></pre></td></tr></table></figure>

<p>范例3：</p>
<p>如果location定义其uri时使用了正则表达式模式(包括<del>,</del>*,但不包括^~)，则proxy_pass之后必须不能使用uri; 用户请求时传递的uri将直接附加至后端服务器之后</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    ...<br>    <span class="hljs-attribute">server_name</span> HOSTNAME; <br>    <span class="hljs-attribute">location</span> ~|<span class="hljs-regexp">~* /uri/</span> &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://host:port; <span class="hljs-comment">#proxy_pass后面的url 不能加/</span><br>     &#125;<br>    ...<br>&#125;<br><span class="hljs-comment">#浏览器做如下转换：</span><br><span class="hljs-comment">#http://HOSTNAME/uri/ --&gt; http://hosturi/</span><br></code></pre></td></tr></table></figure>
<h4 id="4-1-1-2-反向代理配置参数proxy-hide-header"><a href="#4-1-1-2-反向代理配置参数proxy-hide-header" class="headerlink" title="4.1.1.2 反向代理配置参数proxy_hide_header"></a>4.1.1.2 反向代理配置参数<code>proxy_hide_header</code></h4><p>用于nginx作为反向代理的时候，在返回给客户端http响应时，隐藏后端服务器相应头部的信息，可以设置在http,server或location块</p>
<p>默认nginx在响应报文中不传递后端服务器的首部字段Date, Server, X-Pad, X-Accel等参数，如果要传递的话则要使用 proxy_pass_header field声明将后端服务器返回的值传递给客户端</p>
<p>field 首部字段大小不敏感</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_hide_header</span> field;<br>Default: —<br>Context: http, server, location<br></code></pre></td></tr></table></figure>

<p>范例：隐藏后端服务器ETag首部字段</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /web &#123;<br>    <span class="hljs-attribute">index</span> index.html;<br>    <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>    <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>
<p>范例：透传后端服务器的Server和Date首部,同时不再显示前端服务器的Server字段</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /web &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_pass_header</span> Server;<br>        <span class="hljs-attribute">proxy_pass_header</span> Date;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>
<h4 id="4-1-1-3-反向代理配置参数proxy-pass-request-body"><a href="#4-1-1-3-反向代理配置参数proxy-pass-request-body" class="headerlink" title="4.1.1.3 反向代理配置参数proxy_pass_request_body"></a>4.1.1.3 反向代理配置参数<code>proxy_pass_request_body</code></h4><p>是否向后端服务器发送HTTP实体部分,可以设置在http,server或location块，默认即为开启</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax: <span class="hljs-attribute">proxy_pass_request_body</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span>;<br>Default: <span class="hljs-attribute">proxy_pass_request_body</span> <span class="hljs-literal">on</span>;<br>Context: http, server, location<br></code></pre></td></tr></table></figure>

<h4 id="4-1-1-4-反向代理配置参数proxy-pass-request-headers"><a href="#4-1-1-4-反向代理配置参数proxy-pass-request-headers" class="headerlink" title="4.1.1.4 反向代理配置参数proxy_pass_request_headers"></a>4.1.1.4 反向代理配置参数<code>proxy_pass_request_headers</code></h4><p>是否将客户端的请求头部转发给后端服务器，可以设置在http,server或location块，默认即为开启</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_pass_request_headers</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span>;<br>Default: <span class="hljs-attribute">proxy_pass_request_headers</span> <span class="hljs-literal">on</span>;<br>Context: http, server, location<br></code></pre></td></tr></table></figure>
<h4 id="4-1-1-5-反向代理配置参数proxy-set-header"><a href="#4-1-1-5-反向代理配置参数proxy-set-header" class="headerlink" title="4.1.1.5 反向代理配置参数proxy_set_header"></a>4.1.1.5 反向代理配置参数<code>proxy_set_header</code></h4><p>可更改或添加客户端的请求头部信息内容并转发至后端服务器，比如在后端服务器想要获取客户端的真实IP的时候，就要更改每一个报文的头部</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_set_header</span> field value;<br>Default: <span class="hljs-attribute">proxy_set_header</span> Host $proxy_host;<br>         <span class="hljs-attribute">proxy_set_header</span> Connection close;<br>Context:	http, server, location<br></code></pre></td></tr></table></figure>

<p>范例1：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /web &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;<br>        $<span class="hljs-attribute">proxy_add_x_forwarded_for</span> $remote_addr;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#注意：”$proxy_add_x_forwarded_for“为nginx内置变量，使用方法请查看”常用变量之`$proxy_add_x_forwarded_for`“一节</span><br></code></pre></td></tr></table></figure>

<p>范例2：</p>
<p>添加HOST到报文头部，如果客户端为NAT上网那么其值为客户端的共用的公网IP地址，常用于在日之中记录客户端的真实IP地址。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /web &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Real-IP $remote_addr;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#在后端httpd服务器修改配置,添加日志记录X-Forwarded-For字段，接收由nginx转发的IP地址</span><br><span class="hljs-comment">#如：</span><br><span class="hljs-attribute">LogFormat</span> <span class="hljs-string">&quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot; \&quot;%&#123;X-Real-IP&#125;i\&quot;&quot;</span> combined <br><br><span class="hljs-comment">#在后端服务器查看日志</span><br><span class="hljs-comment"># tail /var/log/httpd/access_log  -f</span><br><span class="hljs-number">10.0.0.8</span> - - [<span class="hljs-number">09</span>/Oct/<span class="hljs-number">2020</span>:<span class="hljs-number">21</span>:<span class="hljs-number">50</span>:<span class="hljs-number">57</span> +<span class="hljs-number">0800</span>] <span class="hljs-string">&quot;HEAD /static/index.html HTTP/1.0&quot;</span> <span class="hljs-number">200</span> - <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.29.0&quot;</span> <span class="hljs-string">&quot;10.0.0.7&quot;</span><br></code></pre></td></tr></table></figure>
<h4 id="4-1-1-6-反向代理配置参数proxy-connect-timeout"><a href="#4-1-1-6-反向代理配置参数proxy-connect-timeout" class="headerlink" title="4.1.1.6 反向代理配置参数proxy_connect_timeout"></a>4.1.1.6 反向代理配置参数<code>proxy_connect_timeout</code></h4><p>配置nginx服务器与后端服务器尝试建立连接的超时时间，默认为60秒</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_connect_timeout</span> time;<br>Default: <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">60s</span>;<br>Context: http, server, location<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /web &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">6s</span>; <span class="hljs-comment">#60s为自定义nginx与后端服务器建立连接的超时时间,超时会返回客户端504响应码</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-1-1-7-反向代理配置参数proxy-read-timeout"><a href="#4-1-1-7-反向代理配置参数proxy-read-timeout" class="headerlink" title="4.1.1.7 反向代理配置参数proxy_read_timeout"></a>4.1.1.7 反向代理配置参数<code>proxy_read_timeout</code></h4><p>配置nginx服务器向后端服务器或服务器组发起read请求后，等待的超时时间，默认60s</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_read_timeout</span> time;<br>Default: <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">60s</span>;<br>Context: http, server, location<br></code></pre></td></tr></table></figure>

<h4 id="4-1-1-8-反向代理配置参数proxy-send-timeout"><a href="#4-1-1-8-反向代理配置参数proxy-send-timeout" class="headerlink" title="4.1.1.8 反向代理配置参数proxy_send_timeout"></a>4.1.1.8 反向代理配置参数<code>proxy_send_timeout</code></h4><p>配置nginx项后端服务器或服务器组发起write请求后，等待的超时 时间，默认60s</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_send_timeout</span> time;<br>Default: <span class="hljs-attribute">proxy_send_timeout</span> <span class="hljs-number">60s</span>;<br>Context: http, server, location<br></code></pre></td></tr></table></figure>
<h4 id="4-1-1-9-反向代理配置参数proxy-http-version"><a href="#4-1-1-9-反向代理配置参数proxy-http-version" class="headerlink" title="4.1.1.9 反向代理配置参数proxy_http_version"></a>4.1.1.9 反向代理配置参数<code>proxy_http_version</code></h4><p>用于设置nginx提供代理服务的HTTP协议的版本，默认http 1.0nginx</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">0</span> | <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;<br>Default: <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">0</span>;<br>Context: http, server, <span class="hljs-attribute">location</span><br>This directive appeared in version <span class="hljs-number">1</span>.<span class="hljs-number">1</span>.<span class="hljs-number">4</span>.<br></code></pre></td></tr></table></figure>
<h4 id="4-1-1-10-反向代理配置参数proxy-ignore-client-abort"><a href="#4-1-1-10-反向代理配置参数proxy-ignore-client-abort" class="headerlink" title="4.1.1.10 反向代理配置参数proxy_ignore_client_abort"></a>4.1.1.10 反向代理配置参数<code>proxy_ignore_client_abort</code></h4><p>当客户端网络中断请求时，nginx服务器中断其对后端服务器的请求。即如果此项设置为on开启，则服务器会忽略客户端中断并一直等着代理服务执行返回，如果设置为off，则客户端中断后Nginx也会中断客户端请求并立即记录499日志，默认为off。</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_ignore_client_abort</span> <span class="hljs-literal">on</span> | <span class="hljs-literal">off</span>;<br>Default: <span class="hljs-attribute">proxy_ignore_client_abort</span> <span class="hljs-literal">off</span>;<br>Context: http, server, location<br></code></pre></td></tr></table></figure>
<h4 id="4-1-1-11-反向代理配置参数proxy-headers-hash-bucket-size"><a href="#4-1-1-11-反向代理配置参数proxy-headers-hash-bucket-size" class="headerlink" title="4.1.1.11 反向代理配置参数proxy_headers_hash_bucket_size"></a>4.1.1.11 反向代理配置参数<code>proxy_headers_hash_bucket_size</code></h4><p>当配置了 proxy_hide_header和proxy_set_header的时候，用于设置nginx保存HTTP报文头的hash表的上限</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_headers_hash_bucket_size</span> size;<br>Default: <span class="hljs-attribute">proxy_headers_hash_bucket_size</span> <span class="hljs-number">64</span>;<br>Context: http, server, location<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /web &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_hide_header</span> ;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Real-IP $remote_addr;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_headers_hash_bucket_size</span> <span class="hljs-number">128</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-1-12-反向代理配置参数proxy-headers-hash-max-size"><a href="#4-1-1-12-反向代理配置参数proxy-headers-hash-max-size" class="headerlink" title="4.1.1.12 反向代理配置参数proxy_headers_hash_max_size"></a>4.1.1.12 反向代理配置参数<code>proxy_headers_hash_max_size</code></h4><p>设置proxy_headers_hash_bucket_size的最大可用空间</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_headers_hash_max_size</span> size;<br>Default: <span class="hljs-attribute">proxy_headers_hash_max_size</span> <span class="hljs-number">512</span>;<br>Context: http, server, location<br></code></pre></td></tr></table></figure>

<h4 id="4-1-1-13-http核心参数server-namse-hash-bucket-size"><a href="#4-1-1-13-http核心参数server-namse-hash-bucket-size" class="headerlink" title="4.1.1.13 http核心参数server_namse_hash_bucket_size"></a>4.1.1.13 http核心参数<code>server_namse_hash_bucket_size</code></h4><p>设置服务器名称hash表的上限大小</p>
<p>可用于反向代理</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">server_names_hash_max_size</span> size;<br>Default:	<br><span class="hljs-attribute">server_names_hash_max_size</span> <span class="hljs-number">512</span>;<br>Context:	http<br></code></pre></td></tr></table></figure>

<h4 id="4-1-1-14-http核心参数server-namse-hash-bucket-size"><a href="#4-1-1-14-http核心参数server-namse-hash-bucket-size" class="headerlink" title="4.1.1.14 http核心参数server_namse_hash_bucket_size"></a>4.1.1.14 http核心参数<code>server_namse_hash_bucket_size</code></h4><p>server_name hash表申请空间大小</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">server_names_hash_bucket_size</span> size;<br>Default: <span class="hljs-attribute">server_names_hash_bucket_size</span> <span class="hljs-number">32</span>|<span class="hljs-number">64</span>|<span class="hljs-number">128</span>;<br>Context: http<br></code></pre></td></tr></table></figure>
<h3 id="4-1-2-实战案例-反向代理单台-web-服务器"><a href="#4-1-2-实战案例-反向代理单台-web-服务器" class="headerlink" title="4.1.2 实战案例: 反向代理单台 web 服务器"></a>4.1.2 实战案例: 反向代理单台 web 服务器</h3><h4 id="4-1-2-1-要求和准备"><a href="#4-1-2-1-要求和准备" class="headerlink" title="4.1.2.1 要求和准备"></a>4.1.2.1 要求和准备</h4><p>要求：将用户对域 <a target="_blank" rel="noopener" href="http://www.rlinpc.net/">www.rlinpc.net</a> 的请求转发值后端服务器处理</p>
<table>
<thead>
<tr>
<th>服务器IP地址</th>
<th>hostname</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.101</td>
<td>web1</td>
<td>nginx 代理服务器</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>web2</td>
<td>后端web A，apache部署</td>
</tr>
</tbody></table>
<h4 id="4-1-2-2-修改hostname"><a href="#4-1-2-2-修改hostname" class="headerlink" title="4.1.2.2 修改hostname"></a>4.1.2.2 修改hostname</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-comment"># hostnamectl set-hostname web1</span><br><br><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-comment"># hostnamectl set-hostname web2</span><br></code></pre></td></tr></table></figure>
<h4 id="4-1-2-3-部署后端Apache服务"><a href="#4-1-2-3-部署后端Apache服务" class="headerlink" title="4.1.2.3 部署后端Apache服务"></a>4.1.2.3 部署后端Apache服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install httpd -y</span><br><span class="hljs-comment"># cd /var/www/html</span><br><span class="hljs-comment"># cp index.html index.html.bak</span><br><span class="hljs-comment"># echo &quot;webA 10.0.0.102&quot; &gt; /var/www/html/index.html</span><br><span class="hljs-comment"># systemctl enable --now httpd</span><br><span class="hljs-comment">#浏览器访问 10.0.0.102，查看网页内容</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-2-3-Nginx配置文件配置"><a href="#4-1-2-3-Nginx配置文件配置" class="headerlink" title="4.1.2.3 Nginx配置文件配置"></a>4.1.2.3 Nginx配置文件配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">access_log</span> /apps/nginx/logs/www.rlinpc.net_access.log;<br>    <span class="hljs-attribute">error_log</span> /apps/nginx/logs/www.rlinpc.net_error.log;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net</span><br>````<br><span class="hljs-comment">### 4.1.3 实战案例: 指定 location 实现反向代理</span><br><br><span class="hljs-comment">#### 4.1.3.1 要求和准备</span><br><br>| 服务器IP地址 | <span class="hljs-attribute">hostname</span>   | 作用                               |<br>| ------------ | ---------- | ---------------------------------- |<br>| <span class="hljs-number">10.0.0.101</span>   | web1       | nginx 代理服务器                   |<br>| <span class="hljs-number">10.0.0.102</span>   | web2-java  | 后端web A，apache部署（模拟java）  |<br>| <span class="hljs-number">10.0.0.103</span>   | web3-mysql | 后端web B，apache部署（模拟mysql） |<br><br><span class="hljs-comment">#### 4.1.3.2 修改hostname</span><br><br>```sh<br><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-comment"># hostname set-hostname web1</span><br><br><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-comment"># hostname set-hostname web2-java</span><br><br><span class="hljs-comment">#10.0.0.103</span><br><span class="hljs-comment"># hostname set-hostname web3-mysql</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-3-3-部署后端Apache服务"><a href="#4-1-3-3-部署后端Apache服务" class="headerlink" title="4.1.3.3  部署后端Apache服务"></a>4.1.3.3  部署后端Apache服务</h4><h5 id="4-1-3-3-1-web-2-部署apache服务"><a href="#4-1-3-3-1-web-2-部署apache服务" class="headerlink" title="4.1.3.3.1 web 2 部署apache服务"></a>4.1.3.3.1 web 2 部署apache服务</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y httpd</span><br><span class="hljs-comment"># vim /etc/httpd/conf/httpd.conf</span><br>......<br><span class="hljs-comment">#修改为8080</span><br>Listen 8080<br><br><span class="hljs-comment">#准备网页文件</span><br><span class="hljs-comment"># mkdir /var/www/html/java</span><br><span class="hljs-comment"># echo 10.0.0.102 web2-java &gt; /var/www/html/java/index.html</span><br><span class="hljs-comment"># systemclt enable --now httpd</span><br></code></pre></td></tr></table></figure>

<h5 id="4-1-3-3-2-web-3-部署apache服务"><a href="#4-1-3-3-2-web-3-部署apache服务" class="headerlink" title="4.1.3.3.2 web 3 部署apache服务"></a>4.1.3.3.2 web 3 部署apache服务</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y httpd</span><br><span class="hljs-comment"># vim /etc/httpd/conf/httpd.conf</span><br>......<br><span class="hljs-comment">#修改为3306</span><br>Listen 3306<br><br><span class="hljs-comment">#准备网页文件</span><br><span class="hljs-comment"># mkdir /var/www/html/mysql</span><br><span class="hljs-comment"># echo 10.0.0.103 web3-mysql &gt; /var/www/html/mysql/index.html</span><br><span class="hljs-comment"># systemclt enable --now httpd</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-3-4-web-1-部署nginx服务"><a href="#4-1-3-4-web-1-部署nginx服务" class="headerlink" title="4.1.3.4 web 1 部署nginx服务"></a>4.1.3.4 web 1 部署nginx服务</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /java &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /mysql &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.103:3306;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#浏览器访问:</span><br><span class="hljs-comment">#www.rlinpc.net/java</span><br><span class="hljs-comment">#www.rlinpc.net/mysql</span><br></code></pre></td></tr></table></figure>
<h3 id="4-1-4-反向代理之缓存功能"><a href="#4-1-4-反向代理之缓存功能" class="headerlink" title="4.1.4 反向代理之缓存功能"></a>4.1.4 反向代理之缓存功能</h3><h4 id="4-1-4-1-反向代理缓存功能配置参数proxy-cache"><a href="#4-1-4-1-反向代理缓存功能配置参数proxy-cache" class="headerlink" title="4.1.4.1 反向代理缓存功能配置参数proxy_cache"></a>4.1.4.1 反向代理缓存功能配置参数<code>proxy_cache</code></h4><p>缓存功能默认关闭状态,需要先动配置才能启用，指明调用的缓存，或关闭缓存机制</p>
<p>语法：    </p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_cache</span> zone | <span class="hljs-literal">off</span>;<br>Default: <span class="hljs-attribute">proxy_cache</span> <span class="hljs-literal">off</span>;<br>Context: http, server, <span class="hljs-attribute">location</span><br><span class="hljs-comment">#zone_name 表示缓存的名称.需要由proxy_cache_path事先定义</span><br></code></pre></td></tr></table></figure>
<h4 id="4-1-4-2-反向代理缓存功能配置参数proxy-cache-key"><a href="#4-1-4-2-反向代理缓存功能配置参数proxy-cache-key" class="headerlink" title="4.1.4.2 反向代理缓存功能配置参数proxy_cache_key"></a>4.1.4.2 反向代理缓存功能配置参数<code>proxy_cache_key</code></h4><p>缓存中用于“键”的内容</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_cache_key</span> string;<br>Default: <span class="hljs-attribute">proxy_cache_key</span> $scheme$proxy_host$request_uri;<br>Context: http, server, location<br></code></pre></td></tr></table></figure>
<h4 id="4-1-4-3-反向代理缓存功能配置参数proxy-cache-valid"><a href="#4-1-4-3-反向代理缓存功能配置参数proxy-cache-valid" class="headerlink" title="4.1.4.3  反向代理缓存功能配置参数proxy_cache_valid"></a>4.1.4.3  反向代理缓存功能配置参数<code>proxy_cache_valid</code></h4><p>定义对特定响应码的响应内容的缓存时长，定义在http{…}中</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_cache_valid</span> [code ...] time;<br>Default:	—<br>Context:	http, server, <span class="hljs-attribute">location</span><br><span class="hljs-comment">#示例:</span><br>proxy_cache_valid <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">10m</span>;<br><span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">404</span> <span class="hljs-number">1m</span>;<br></code></pre></td></tr></table></figure>
<h4 id="4-1-4-4-反向代理缓存功能配置参数proxy-cache-path"><a href="#4-1-4-4-反向代理缓存功能配置参数proxy-cache-path" class="headerlink" title="4.1.4.4 反向代理缓存功能配置参数proxy_cache_path"></a>4.1.4.4 反向代理缓存功能配置参数<code>proxy_cache_path</code></h4><p>设置缓存的路径和其他参数。缓存数据是保存在文件中的，缓存的键和文件名都是在代理URL上执行MD5的结果。</p>
<p>可用于proxy功能的缓存</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_cache_path</span> path [levels=levels] [use_temp_path=<span class="hljs-literal">on</span>|<span class="hljs-literal">off</span>] keys_zone=name:size [inactive=time] [max_size=size] <br>                              [min_free=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] <br>                              [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=<span class="hljs-literal">on</span>|<span class="hljs-literal">off</span>] <br>                              [purger_files=number] [purger_sleep=time] [purger_threshold=time];<br>Default: —<br>Context: <span class="hljs-attribute">http</span><br><br><span class="hljs-comment">#示例：在http配置定义缓存信息</span><br>proxy_cache_path /var/cache/nginx/proxy_cache <span class="hljs-comment">#定义缓存保存路径，proxy_cache会自动创建</span><br>levels=<span class="hljs-number">1</span>:<span class="hljs-number">2</span>:<span class="hljs-number">2</span> <span class="hljs-comment">#定义缓存目录结构层次，1:2:2可以生成2^4x2^8x2^8=2^20=1048576个目录</span><br>keys_zone=proxycache:<span class="hljs-number">20m</span> <span class="hljs-comment">#指内存中缓存的大小，主要用于存放key和metadata（如：使用次数） </span><br>inactive=<span class="hljs-number">120s</span>  <span class="hljs-comment">#缓存有效时间 </span><br>max_size=<span class="hljs-number">1g</span>; <span class="hljs-comment">#最大磁盘占用空间，磁盘存入文件内容的缓存空间最大值</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-4-5-反向代理缓存功能配置参数proxy-cache"><a href="#4-1-4-5-反向代理缓存功能配置参数proxy-cache" class="headerlink" title="4.1.4.5 反向代理缓存功能配置参数proxy_cache"></a>4.1.4.5 反向代理缓存功能配置参数<code>proxy_cache</code></h4><p>指定用于页面缓存的共享内存。同一块共享内存可以在多个地方使用。off参数可以屏蔽从上层配置继承的缓存功能。zone名称由“proxy_cache_path”指令定义。</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_cache</span> zone | <span class="hljs-literal">off</span>;<br>Default: <span class="hljs-attribute">proxy_cache</span> <span class="hljs-literal">off</span>;<br>Context: http, server, location<br></code></pre></td></tr></table></figure>
<h4 id="4-1-4-6-反向代理缓存功能配置参数proxy-cache-key"><a href="#4-1-4-6-反向代理缓存功能配置参数proxy-cache-key" class="headerlink" title="4.1.4.6 反向代理缓存功能配置参数proxy_cache_key"></a>4.1.4.6 反向代理缓存功能配置参数<code>proxy_cache_key</code></h4><p>定义用于缓存的键</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_cache_key</span> string;<br>Default: <span class="hljs-attribute">proxy_cache_key</span> $scheme$proxy_host$request_uri;<br>Context: http, server, <span class="hljs-attribute">location</span><br><span class="hljs-comment">#示例：</span><br>proxy_cache_key $request_uri; <span class="hljs-comment">#对指定的数据进行MD5的运算做为缓存的key</span><br><span class="hljs-attribute">proxy_cache_key</span> <span class="hljs-string">&quot;$host$request_uri $cookie_user&quot;</span>;<br><span class="hljs-attribute">proxy_cache_key</span> $scheme$proxy_host$uri$is_args$args;<br></code></pre></td></tr></table></figure>

<h4 id="4-1-4-7-反向代理缓存功能配置参数proxy-cache-valid"><a href="#4-1-4-7-反向代理缓存功能配置参数proxy-cache-valid" class="headerlink" title="4.1.4.7 反向代理缓存功能配置参数proxy_cache_valid"></a>4.1.4.7 反向代理缓存功能配置参数<code>proxy_cache_valid</code></h4><p>为不同的响应状态码设置不同的缓存时间</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_cache_valid</span> [code ...] time;<br>Default: —<br>Context: http, server, <span class="hljs-attribute">location</span><br><span class="hljs-comment">#示例：</span><br>proxy_cache_valid <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">301</span> <span class="hljs-number">10m</span>; <span class="hljs-comment">#指定的状态码返回的数据缓存多长时间</span><br><span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">1m</span>;  <span class="hljs-comment">#除指定的状态码返回的数据以外的缓存多长时间,必须设置,否则不会缓存</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-4-8-反向代理缓存功能配置参数proxy-cache-use-stale"><a href="#4-1-4-8-反向代理缓存功能配置参数proxy-cache-use-stale" class="headerlink" title="4.1.4.8 反向代理缓存功能配置参数proxy_cache_use_stale"></a>4.1.4.8 反向代理缓存功能配置参数<code>proxy_cache_use_stale</code></h4><p>如果后端服务器出现状况，nginx是可以使用过期的响应缓存的。这条指令就是定义何种条件下允许开启此机制。这条指令的参数与proxy_next_upstream指令的参数相同。</p>
<p>此外，updating参数允许nginx在正在更新缓存的情况下使用过期的缓存作为响应。这样做可以使更新缓存数据时，访问源服务器的次数最少。</p>
<p>在植入新的缓存条目时，如果想使访问源服务器的次数最少，可以使用proxy_cache_lock指令。</p>
<p>在被代理的后端服务器出现哪种情况下，可直接使用过期的缓存响应客户端</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_cache_use_stale</span> <span class="hljs-literal">error</span> | timeout | invalid_header | updating | http_500 | http_502 | http_503 | http_504 | http_403                                     | http_404 | http_429 | <span class="hljs-literal">off</span> ...;<br>Default: <span class="hljs-attribute">proxy_cache_use_stale</span> <span class="hljs-literal">off</span>;<br>Context: http, server, <span class="hljs-attribute">location</span><br><span class="hljs-comment">#示例</span><br>proxy_cache_use_stale <span class="hljs-literal">error</span> http_502 http_503;<br></code></pre></td></tr></table></figure>
<p>4.1.4.9 反向代理缓存功能配置参数<code>proxy_cache_methods</code></p>
<p>对哪些客户端请求方法对应的响应进行缓存，GET和HEAD方法总是被缓存</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">proxy_cache_methods</span> GET | HEAD | POST ...;<br>Default: <span class="hljs-attribute">proxy_cache_methods</span> GET HEAD;<br>Context: http, server, <span class="hljs-attribute">location</span><br>This directive appeared in version <span class="hljs-number">0</span>.<span class="hljs-number">7</span>.<span class="hljs-number">59</span>.<br></code></pre></td></tr></table></figure>

<h4 id="4-1-4-9-反向代理缓存功能范例"><a href="#4-1-4-9-反向代理缓存功能范例" class="headerlink" title="4.1.4.9 反向代理缓存功能范例"></a>4.1.4.9 反向代理缓存功能范例</h4><h4 id="4-1-4-9-1-范例：非缓存场景压测"><a href="#4-1-4-9-1-范例：非缓存场景压测" class="headerlink" title="4.1.4.9.1 范例：非缓存场景压测"></a>4.1.4.9.1 范例：非缓存场景压测</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-comment"># cd /var/www/html/java</span><br><span class="hljs-comment"># tail /var/log/syslog &gt; cache.log</span><br><span class="hljs-comment"># chmod 644 cache.log</span><br><br><span class="hljs-comment">#10.0.0.103</span><br><span class="hljs-comment"># yum install -y httpd-tools #centos需要安装</span><br><span class="hljs-comment"># vim /etc/hosts</span><br>10.0.0.101 www.rlinpc.net<br><br><span class="hljs-comment"># ab -n 2000 -c200 http://www.rlinpc.net/java/cache.log</span><br><span class="hljs-comment">#经过三次测试</span><br>Requests per second:    120.39 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       1661.306 [ms] (mean)<br><br>Requests per second:    121.20 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       1650.161 [ms] (mean)<br><br>Requests per second:    113.48 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       1762.431 [ms] (mean)<br></code></pre></td></tr></table></figure>

<h5 id="4-1-4-9-2-范例：准备缓存配置"><a href="#4-1-4-9-2-范例：准备缓存配置" class="headerlink" title="4.1.4.9.2 范例：准备缓存配置"></a>4.1.4.9.2 范例：准备缓存配置</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br><span class="hljs-section">http</span> &#123;<br>.....<br>    <span class="hljs-comment">#cache setting</span><br>    <span class="hljs-attribute">proxy_cache_path</span> /apps/nginx/proxy_cache levels=<span class="hljs-number">2</span>:<span class="hljs-number">2</span>:<span class="hljs-number">2</span> keys_zone=rlinpccache:<span class="hljs-number">128m</span> inactive=<span class="hljs-number">180s</span> max_size=<span class="hljs-number">5g</span>; <br>&#125;<br><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123; <br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /java &#123; <span class="hljs-comment">#要缓存的URL 或者放在server配置项对所有URL都进行缓存</span><br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_cache</span> rlinpccache; <span class="hljs-comment">#这里的名字要跟刚刚keys_zone=定义的名字一样</span><br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>        <span class="hljs-attribute">proxy_cache_key</span> $request_uri;<br>        <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">301</span> <span class="hljs-number">10m</span>; <span class="hljs-comment">#指定的状态码返回的数据缓存多长时间</span><br>        <span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">1m</span>;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /mysql &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.103:3306;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>        <span class="hljs-attribute">proxy_cache</span> rlinpccache;<br>        <span class="hljs-attribute">proxy_cache_key</span> $request_uri;<br>        <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">301</span> <span class="hljs-number">10m</span>;<br>        <span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">1m</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/ngins -s reload</span><br></code></pre></td></tr></table></figure>

<h5 id="4-1-4-9-3-范例：访问并验证缓存文件"><a href="#4-1-4-9-3-范例：访问并验证缓存文件" class="headerlink" title="4.1.4.9.3 范例：访问并验证缓存文件"></a>4.1.4.9.3 范例：访问并验证缓存文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-comment">#先验证/apps/nginx/proxy_cache的文件</span><br>ll /apps/nginx/proxy_cache<br>total 8<br>drwx------  2 nginx root  4096 Feb 21 22:16 ./<br>drwxr-xr-x 13 nginx nginx 4096 Feb 21 22:16 ../<br><br><span class="hljs-comment">#10.0.0.103</span><br><span class="hljs-comment"># ab -n2000 -c200 http://www.rlinpc.net/web/cache.log</span><br><span class="hljs-comment">#经过三次测试</span><br>Requests per second:    260.56 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       767.574 [ms] (mean)<br><br>Requests per second:    333.10 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       600.423 [ms] (mean)<br><br>Requests per second:    236.04 [<span class="hljs-comment">#/sec] (mean)</span><br>Time per request:       847.314 [ms] (mean)<br><br><span class="hljs-comment">#验证缓存目录结构及文件大小 </span><br><span class="hljs-comment"># cd /apps/nginx/proxy_cache</span><br><span class="hljs-comment"># tree </span><br>.<br>└── b5<br>    └── 3d<br>        └── ce<br>            └── 6fc1e543ceb12a0cfb476e4335ce3db5 <br><span class="hljs-comment">#文件夹的名称和缓存文件的名称的最后几位有关</span><br></code></pre></td></tr></table></figure>

<h3 id="4-1-5-添加头部报文信息"><a href="#4-1-5-添加头部报文信息" class="headerlink" title="4.1.5 添加头部报文信息"></a>4.1.5 添加头部报文信息</h3><p>nginx基于模块<code>ngx_http_headers_module</code>可实现对头部报文添加指定的key与值</p>
<p>官方参考文档地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://nginx.org/en/docs/http/ngx_http_headers_module.html<br></code></pre></td></tr></table></figure>

<p>语法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">Syntax:	add_header name value [always];<br>Default: —<br>Context: http, server, location, <span class="hljs-keyword">if</span> <span class="hljs-keyword">in</span> location<br><br><span class="hljs-comment">#示例</span><br>add_header X-Via  <span class="hljs-variable">$server_addr</span>; <span class="hljs-comment">#当前nginx主机的IP</span><br>add_header X-Cache <span class="hljs-variable">$upstream_cache_status</span>; <span class="hljs-comment">#是否缓存命中</span><br>add_header X-Accel <span class="hljs-variable">$server_name</span>; <span class="hljs-comment">#客户访问的FQDN</span><br><br><span class="hljs-comment">#添加自定义响应信息的尾部， 1.13.2版后支持</span><br>add_trailer name value [always];<br></code></pre></td></tr></table></figure>

<p>范例：添加头部信息</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123; <br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /java &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102:8080;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>        <span class="hljs-attribute">proxy_cache</span> rlinpccache;<br>        <span class="hljs-attribute">proxy_cache_key</span> $request_uri;<br>        <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">301</span> <span class="hljs-number">10m</span>;<br>        <span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">1m</span>;<br>        <span class="hljs-attribute">add_header</span> X-Via  $server_addr;<br>        <span class="hljs-attribute">add_header</span> X-Cache $upstream_cache_status;<br>        <span class="hljs-attribute">add_header</span> X-Accel $server_name;<br>    &#125;<br>    <span class="hljs-attribute">location</span> /mysql &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.103:3306;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>        <span class="hljs-attribute">proxy_cache</span> rlinpccache;<br>        <span class="hljs-attribute">proxy_cache_key</span> $request_uri;<br>        <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">302</span> <span class="hljs-number">301</span> <span class="hljs-number">10m</span>;<br>        <span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">1m</span>;<br>        <span class="hljs-attribute">add_header</span> X-Via  $server_addr;<br>        <span class="hljs-attribute">add_header</span> X-Cache $upstream_cache_status;<br>        <span class="hljs-attribute">add_header</span> X-Accel $server_name;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/ngins -s reload</span><br><br><span class="hljs-comment">#验证头部信息</span><br><span class="hljs-comment">#10.0.0.103</span><br><span class="hljs-attribute">curl</span> -I http://www.rlinpc.net/java/cache.log<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: M<span class="hljs-literal">on</span>, <span class="hljs-number">22</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">05</span>:<span class="hljs-number">23</span>:<span class="hljs-number">41</span> GMT<br>Content-Length: <span class="hljs-number">1523628</span><br>Connection: keep-alive<br>Last-Modified: M<span class="hljs-literal">on</span>, <span class="hljs-number">22</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">39</span>:<span class="hljs-number">51</span> GMT<br>X-Via:  <span class="hljs-number">10.0.0.101</span><br>X-Cache: MISS          <span class="hljs-comment">#第一次无缓存</span><br>X-Accel: www.rlinpc.net<br>Accept-Ranges: bytes<br><br>curl -I http://www.rlinpc.net/java/cache.log<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br>Server: nginx/<span class="hljs-number">1</span>.<span class="hljs-number">16</span>.<span class="hljs-number">1</span><br>Date: M<span class="hljs-literal">on</span>, <span class="hljs-number">22</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">05</span>:<span class="hljs-number">23</span>:<span class="hljs-number">44</span> GMT<br>Content-Length: <span class="hljs-number">1523628</span><br>Connection: keep-alive<br>Last-Modified: M<span class="hljs-literal">on</span>, <span class="hljs-number">22</span> Feb <span class="hljs-number">2021</span> <span class="hljs-number">03</span>:<span class="hljs-number">39</span>:<span class="hljs-number">51</span> GMT<br>X-Via:  <span class="hljs-number">10.0.0.101</span><br>X-Cache: HIT           <span class="hljs-comment">#第二次命令缓存</span><br>X-Accel: www.rlinpc.net<br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure>
<h3 id="4-1-7-添加自定义响应信息的尾部"><a href="#4-1-7-添加自定义响应信息的尾部" class="headerlink" title="4.1.7 添加自定义响应信息的尾部"></a>4.1.7 添加自定义响应信息的尾部</h3><p>nginx基于模块<code>ngx_http_headers_module</code>可实现对尾部报文添加指定的key与值</p>
<p>官方参考文档地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://nginx.org/en/docs/http/ngx_http_headers_module.html<br></code></pre></td></tr></table></figure>

<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">add_trailer</span> name value [always];<br>Default: —<br>Context: http, server, location, <span class="hljs-attribute">if</span> in location<br>This directive appeared in version <span class="hljs-number">1</span>.<span class="hljs-number">13</span>.<span class="hljs-number">2</span>.<br></code></pre></td></tr></table></figure>

<h3 id="4-1-8-expires延长图片的有效期"><a href="#4-1-8-expires延长图片的有效期" class="headerlink" title="4.1.8 expires延长图片的有效期"></a>4.1.8 expires延长图片的有效期</h3><p>范例：expires延长图片的有效期（同样也是在<code>ngx_http_headers_module</code>模块里，详细打开网页查看）</p>
<p>expires作用：可以在用户第一次访问网页的时候将一些图片之类的静态资源缓存到自己的电脑里，然后下次访问相同的域名的时候，只要在有效的时期里就不用再次缓存，可以有效的较少缓存的时间</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">expires</span> [modified] time;<br>        <span class="hljs-attribute">expires</span> epoch | max | <span class="hljs-literal">off</span>;<br>Default: <span class="hljs-attribute">expires</span> <span class="hljs-literal">off</span>;<br>Context: http, server, location, <span class="hljs-attribute">if</span> in location<br><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listne</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rilnpc.net;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(gif|jpg|jepg|bmp|png|tiff|tif|ico|wmf|js)$</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/static;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">expires</span> <span class="hljs-number">30d</span>;<br>        .....<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h2 id="4-2-Nginx-http-反向代理高级应用"><a href="#4-2-Nginx-http-反向代理高级应用" class="headerlink" title="4.2 Nginx http 反向代理高级应用"></a>4.2 Nginx http 反向代理高级应用</h2><p>Nginx可以将客户端的请求转发至单台后端服务器但是无法转发至特定的一组的服务器，而且不能对后端服务器提供相应的服务器状态监测，但是Nginx可以基于<code>ngx_http_upstream_module</code>模块提供服务器分组转发、权重分配、状态检测、调度算法等高级功能。</p>
<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://nginx.org/en/docs/http/ngx_http_upstream_module.html<br></code></pre></td></tr></table></figure>

<h3 id="4-2-1-反向代理高级应用配置参数"><a href="#4-2-1-反向代理高级应用配置参数" class="headerlink" title="4.2.1 反向代理高级应用配置参数"></a>4.2.1 反向代理高级应用配置参数</h3><h4 id="4-2-1-1-反向代理高级应用配置参数upstream"><a href="#4-2-1-1-反向代理高级应用配置参数upstream" class="headerlink" title="4.2.1.1 反向代理高级应用配置参数upstream"></a>4.2.1.1 反向代理高级应用配置参数<code>upstream</code></h4><p>定义一组服务器。服务器可以监听不同的端口。此外，监听TCP和UNIX域套接字的服务器可以混合使用。</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">upstream</span> name &#123; ... &#125;<br>Default: —<br>Context: http<br></code></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> backend &#123;<br>     <span class="hljs-attribute">server</span> backend1.example.com weight=<span class="hljs-number">5</span>;<br>     <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8080</span>    max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>     <span class="hljs-attribute">server</span> unix:/tmp/backend3;<br>     <span class="hljs-attribute">server</span> backup1.example.com backup;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-2-1-2-反向代理高级应用配置参数server"><a href="#4-2-1-2-反向代理高级应用配置参数server" class="headerlink" title="4.2.1.2 反向代理高级应用配置参数server"></a>4.2.1.2 反向代理高级应用配置参数<code>server</code></h4><p>配置一个后端web服务器，配置在upstream内，至少要有一个server服务器配置</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">server</span> address [parameters];<br>Default: —<br>Context: upstream<br></code></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#server支持的parameters如下：</span><br>weight=<span class="hljs-attribute">number</span> <span class="hljs-comment">#设置权重，默认为1,实现类似于LVS中的WRR,WLC等</span><br>max_conns=number  <span class="hljs-comment">#给当前server设置最大活动链接数，默认为0表示没有限制</span><br>max_fails=number  <span class="hljs-comment">#对后端服务器连续监测失败多少次就标记为不可用,默认为1次,当客户端访问时,才会利用TCP触发对探测后端服务器健康性检查,而非周期性的探测</span><br>fail_timeout=time <span class="hljs-comment">#对后端服务器的单次监测超时时间，默认为10秒</span><br>backup  <span class="hljs-comment">#设置为备份服务器，当所有服务器不可用时将重新启用次服务器</span><br>down   <span class="hljs-comment">#标记为down状态</span><br>resolve <span class="hljs-comment">#当server定义的是主机名的时候，当A记录发生变化会自动应用新IP而不用重启Nginx</span><br></code></pre></td></tr></table></figure>
<h4 id="4-2-1-3-反向代理高级应用配置参数hash"><a href="#4-2-1-3-反向代理高级应用配置参数hash" class="headerlink" title="4.2.1.3 反向代理高级应用配置参数hash"></a>4.2.1.3 反向代理高级应用配置参数<code>hash</code></h4><p>基于指定请求报文中首部字段或者URI等key做hash计算，使用consistent参数，将使用ketama一致性hash算法，适用于后端是Cache服务器（如varnish）时使用，consistent定义使用一致性hash运算，一致性hash基于取模运算</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	<span class="hljs-attribute">hash</span> key [consistent];<br>Default: —<br>Context: <span class="hljs-attribute">upstream</span><br>This directive appeared in version <span class="hljs-number">1</span>.<span class="hljs-number">7</span>.<span class="hljs-number">2</span>.<br></code></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">hash</span> $request_uri consistent; <span class="hljs-comment">#基于用户请求的uri做hash</span><br><span class="hljs-attribute">hash</span> $cookie_sessionid  <span class="hljs-comment">#基于cookie中的sessionid这个key进行hash调度,实现会话绑定</span><br></code></pre></td></tr></table></figure>
<h4 id="4-2-1-4-反向代理高级应用配置参数ip-hash"><a href="#4-2-1-4-反向代理高级应用配置参数ip-hash" class="headerlink" title="4.2.1.4 反向代理高级应用配置参数ip_hash"></a>4.2.1.4 反向代理高级应用配置参数<code>ip_hash</code></h4><p>源地址hash调度方法，基于的客户端的remote_addr(源地址IPv4的前24位或整个IPv6地址)做hash计算，以实现会话保持</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	ip_hash;<br>Default: —<br>Context: upstream<br></code></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> backend &#123;<br>    ip_hash;<br><br>    <span class="hljs-attribute">server</span> backend1.example.com;<br>    <span class="hljs-attribute">server</span> backend2.example.com;<br>    <span class="hljs-attribute">server</span> backend3.example.com down;<br>    <span class="hljs-attribute">server</span> backend4.example.com;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili4.jpg" srcset="/blog/img/loading.gif" alt="基于 hash 的调度算法"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili5.jpg" srcset="/blog/img/loading.gif" alt="添加节点后,会导致很多的调度的缓存信息失效"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili6.jpg" srcset="/blog/img/loading.gif" alt="一致性hash算法"></p>
<h4 id="4-2-1-5-反向代理高级应用配置参数least-conn"><a href="#4-2-1-5-反向代理高级应用配置参数least-conn" class="headerlink" title="4.2.1.5 反向代理高级应用配置参数least_conn"></a>4.2.1.5 反向代理高级应用配置参数<code>least_conn</code></h4><p>最少连接调度算法，优先将客户端请求调度到当前连接最少的后端服务器,相当于LVS中的WLC</p>
<p>语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx">Syntax:	least_conn;<br>Default: —<br>Context: <span class="hljs-attribute">upstream</span><br>This directive appeared in versions <span class="hljs-number">1</span>.<span class="hljs-number">3</span>.<span class="hljs-number">1</span> and <span class="hljs-number">1</span>.<span class="hljs-number">2</span>.<span class="hljs-number">2</span>.<br></code></pre></td></tr></table></figure>

<h3 id="4-2-2-反向代理示例：后端多台web服务器"><a href="#4-2-2-反向代理示例：后端多台web服务器" class="headerlink" title="4.2.2 反向代理示例：后端多台web服务器"></a>4.2.2 反向代理示例：后端多台web服务器</h3><h4 id="4-2-2-1-环境说明"><a href="#4-2-2-1-环境说明" class="headerlink" title="4.2.2.1 环境说明"></a>4.2.2.1 环境说明</h4><table>
<thead>
<tr>
<th>服务器IP地址</th>
<th>hostname</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.101</td>
<td>web1</td>
<td>Nginx 代理服务器</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>webA</td>
<td>后端web A，Apache部署</td>
</tr>
<tr>
<td>10.0.0.103</td>
<td>webB</td>
<td>后端web B，Apache部署</td>
</tr>
</tbody></table>
<h4 id="4-2-2-2-修改hostname"><a href="#4-2-2-2-修改hostname" class="headerlink" title="4.2.2.2 修改hostname"></a>4.2.2.2 修改hostname</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-comment"># hostname set-hostname web1</span><br><br><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-comment"># hostname set-hostname webA</span><br><br><span class="hljs-comment">#10.0.0.103</span><br><span class="hljs-comment"># hostname set-hostname webB</span><br></code></pre></td></tr></table></figure>
<h4 id="4-2-2-3-部署后端服务器"><a href="#4-2-2-3-部署后端服务器" class="headerlink" title="4.2.2.3 部署后端服务器"></a>4.2.2.3 部署后端服务器</h4><h5 id="4-2-2-3-1-webA部署"><a href="#4-2-2-3-1-webA部署" class="headerlink" title="4.2.2.3.1 webA部署"></a>4.2.2.3.1 webA部署</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y httpd</span><br><span class="hljs-comment"># mkdir /var/www/html/web</span><br><span class="hljs-comment"># echo &#x27;www.rlinpc.net 10.0.0.102 webA &gt; /var/www/html/web/index.html</span><br><span class="hljs-comment"># systemctl enable --now httpd</span><br></code></pre></td></tr></table></figure>

<h5 id="4-2-2-3-2-webB部署"><a href="#4-2-2-3-2-webB部署" class="headerlink" title="4.2.2.3.2 webB部署"></a>4.2.2.3.2 webB部署</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y httpd</span><br><span class="hljs-comment"># mkdir /var/www/html/web</span><br><span class="hljs-comment"># echo &#x27;www.rlinpc.net 10.0.0.103 webA &gt; /var/www/html/web/index.html</span><br><span class="hljs-comment"># systemctl enable --now httpd</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-2-4-配置Nginx反向代理"><a href="#4-2-2-4-配置Nginx反向代理" class="headerlink" title="4.2.2.4 配置Nginx反向代理"></a>4.2.2.4 配置Nginx反向代理</h4><p><strong>注意：本节实验过程中先关闭缓存</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-attribute">upstream</span> rlin-web &#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.102:80</span> weight=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">5s</span> max_fails=<span class="hljs-number">3</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.103:80</span> weight=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">5s</span> max_fails=<span class="hljs-number">3</span>;<br>    <span class="hljs-comment">#下面的三个算法都可以试一试</span><br>    <span class="hljs-comment">#hash $request_uri consistent;</span><br>    <span class="hljs-comment">#ip_hash;</span><br>    <span class="hljs-comment">#least_conn;</span><br>&#125;<br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /web &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://rlin-web;<br>        <span class="hljs-attribute">proxy_hide_header</span> ETag;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $remote_addr;<br>        <span class="hljs-comment">#proxy_cache rlinpccache;</span><br>        <span class="hljs-comment">#proxy_cache_key $request_uri;</span><br>        <span class="hljs-comment">#proxy_cache_valid 200 302 301 10m;</span><br>        <span class="hljs-comment">#proxy_cache_valid any 1m;</span><br>        <span class="hljs-attribute">add_header</span> X-Via  $server_addr;<br>        <span class="hljs-attribute">add_header</span> X-Cache $upstream_cache_status;<br>        <span class="hljs-attribute">add_header</span> X-Accel $server_name;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#浏览器访问</span><br><span class="hljs-comment"># www.rlinpc.net/web/index.html</span><br></code></pre></td></tr></table></figure>

<h3 id="4-2-3-实战案例-一级代理实现客户端IP透传"><a href="#4-2-3-实战案例-一级代理实现客户端IP透传" class="headerlink" title="4.2.3 实战案例: 一级代理实现客户端IP透传"></a>4.2.3 实战案例: 一级代理实现客户端IP透传</h3><h4 id="4-2-3-1-环境说明"><a href="#4-2-3-1-环境说明" class="headerlink" title="4.2.3.1 环境说明"></a>4.2.3.1 环境说明</h4><table>
<thead>
<tr>
<th>服务器IP地址</th>
<th>hostname</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.101</td>
<td>web1</td>
<td>Nginx 代理服务器</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>webA</td>
<td>后端web A，Apache部署</td>
</tr>
<tr>
<td>10.0.0.103</td>
<td>webB</td>
<td>后端web B，Apache部署</td>
</tr>
</tbody></table>
<h4 id="4-2-3-2-修改hostname"><a href="#4-2-3-2-修改hostname" class="headerlink" title="4.2.3.2 修改hostname"></a>4.2.3.2 修改hostname</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-comment"># hostname set-hostname web1</span><br><br><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-comment"># hostname set-hostname webA</span><br><br><span class="hljs-comment">#10.0.0.103</span><br><span class="hljs-comment"># hostname set-hostname webB</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-3-3-Nginx配置"><a href="#4-2-3-3-Nginx配置" class="headerlink" title="4.2.3.3 Nginx配置"></a>4.2.3.3 Nginx配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br>upstream rlin-web &#123;<br> <span class="hljs-comment">#hash $request_uri consistent; #consistent 一致性hash算法</span><br>  server 10.0.0.101:80 weight=1 fail_timeout=5s max_fails=3;<br>  server 10.0.0.102:80 weight=1 fail_timeout=5s max_fails=3 backup;<br>&#125;<br><br>server &#123;<br>  listen 80;<br>  server_name www.rlinpc.net;<br>  location / &#123;<br>    index index.html index.php;<br>    root /data/nginx/html/pc;<br>  &#125;<br>  <br>  location /web &#123;<br>    index index.html;<br>    proxy_pass http://rlin-web/;<br>    proxy_set_header X-Forwarded-For-rlinpc  <span class="hljs-variable">$remote_addr</span>; <span class="hljs-comment">#添加客户端IP到报文头部</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/conf/nginx.conf</span><br><span class="hljs-comment">#找到日志的配置，添加&quot;$http_x_forwarded_for&quot;</span><br><span class="hljs-comment">#如：</span><br>log_format  main  <span class="hljs-string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>                  <span class="hljs-string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>                  <span class="hljs-string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#在访问web后查看日志</span><br><span class="hljs-comment"># tail -f /apps/nginx/logs/access.log</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-3-4-后端部署"><a href="#4-2-3-4-后端部署" class="headerlink" title="4.2.3.4 后端部署"></a>4.2.3.4 后端部署</h4><h5 id="4-2-3-4-1-webA部署"><a href="#4-2-3-4-1-webA部署" class="headerlink" title="4.2.3.4.1 webA部署"></a>4.2.3.4.1 webA部署</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y httpd</span><br><span class="hljs-comment"># vim /etc/httpd/conf/http.conf #centos</span><br><span class="hljs-comment">#找到那一行直接备份更改</span><br>LogFormat <span class="hljs-string">&quot;%&#123;X-Forwarded-For-rlinpc&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot; &#123;Referer&#125;i\&quot; \&quot;% &#123;User-Agent&#125;i\&quot;&quot;</span> combined <span class="hljs-comment">#注意，新加的IP报文名称要与nginx设置的一样</span><br><span class="hljs-comment"># systemctl enable --now httpd</span><br><br><span class="hljs-comment">#重启apache，访问web界面并验证apache日志</span><br><span class="hljs-comment"># tail -f /var/log/http/access_log</span><br></code></pre></td></tr></table></figure>

<h5 id="4-2-3-4-2-webB部署"><a href="#4-2-3-4-2-webB部署" class="headerlink" title="4.2.3.4.2 webB部署"></a>4.2.3.4.2 webB部署</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y httpd</span><br><span class="hljs-comment"># vim /etc/httpd/conf/http.conf #centos</span><br><span class="hljs-comment">#找到那一行直接备份更改</span><br>LogFormat <span class="hljs-string">&quot;%&#123;X-Forwarded-For-rlinpc&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot; &#123;Referer&#125;i\&quot; \&quot;% &#123;User-Agent&#125;i\&quot;&quot;</span> combined <span class="hljs-comment">#注意，新加的IP报文名称要与nginx设置的一样</span><br><span class="hljs-comment"># systemctl enable --now httpd</span><br><br><span class="hljs-comment">#重启apache，访问web界面并验证apache日志</span><br><span class="hljs-comment"># tail -f /var/log/http/access_log</span><br></code></pre></td></tr></table></figure>

<h3 id="4-2-4-多级代理实现客户端-IP-透传"><a href="#4-2-4-多级代理实现客户端-IP-透传" class="headerlink" title="4.2.4  多级代理实现客户端 IP 透传"></a>4.2.4  多级代理实现客户端 IP 透传</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili7.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="4-2-4-1-环境准备"><a href="#4-2-4-1-环境准备" class="headerlink" title="4.2.4.1 环境准备"></a>4.2.4.1 环境准备</h4><table>
<thead>
<tr>
<th>服务器IP地址</th>
<th>hostname</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.101</td>
<td>web1</td>
<td>Nginx 代理服务器</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>web2</td>
<td>后端web A，Nginx部署</td>
</tr>
<tr>
<td>10.0.0.103</td>
<td>web3</td>
<td>后端web B，Apache部署</td>
</tr>
</tbody></table>
<h4 id="4-2-4-2-修改hostname"><a href="#4-2-4-2-修改hostname" class="headerlink" title="4.2.4.2 修改hostname"></a>4.2.4.2 修改hostname</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-comment"># hostname set-hostname web1</span><br><br><span class="hljs-comment">#10.0.0.102</span><br><span class="hljs-comment"># hostname set-hostname web2</span><br><br><span class="hljs-comment">#10.0.0.103</span><br><span class="hljs-comment"># hostname set-hostname web3</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-4-3-Web1配置"><a href="#4-2-4-3-Web1配置" class="headerlink" title="4.2.4.3 Web1配置"></a>4.2.4.3 Web1配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>   <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>   <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>   <span class="hljs-attribute">location</span> / &#123;<br>      <span class="hljs-attribute">proxy_pass</span> http://10.0.0.102;<br>      <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;<br>   &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-4-4-Web2配置"><a href="#4-2-4-4-Web2配置" class="headerlink" title="4.2.4.4 Web2配置"></a>4.2.4.4 Web2配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>   <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>   <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>   <span class="hljs-attribute">location</span> / &#123;<br>      <span class="hljs-attribute">proxy_pass</span> http://10.0.0.103;<br>      <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;<br>   &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-4-3-Web3配置"><a href="#4-2-4-3-Web3配置" class="headerlink" title="4.2.4.3 Web3配置"></a>4.2.4.3 Web3配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y httpd</span><br><span class="hljs-comment"># vim /etc/httpd/conf/http.conf</span><br><span class="hljs-comment">#找到那一行直接备份更改</span><br>LogFormat <span class="hljs-string">&quot;%&#123;X-Forwarded-For&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot; &#123;Referer&#125;i\&quot; \&quot;% &#123;User-Agent&#125;i\&quot;&quot;</span> combined<br><span class="hljs-comment"># systemctl enable --now httpd</span><br><br><span class="hljs-comment">#测试访问</span><br><span class="hljs-comment"># curl www.rlinpc.net/web/index.html</span><br><br><span class="hljs-comment">#后端服务器查看日志</span><br><span class="hljs-comment"># tail -f /var/log/httpd/access_log</span><br></code></pre></td></tr></table></figure>
<h3 id="4-2-5实战案例-基于Cookie-实现会话绑定"><a href="#4-2-5实战案例-基于Cookie-实现会话绑定" class="headerlink" title="4.2.5实战案例: 基于Cookie 实现会话绑定"></a>4.2.5实战案例: 基于Cookie 实现会话绑定</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">upstream</span> websrvs &#123;<br>        <span class="hljs-attribute">hash</span> $cookie_hello;  <span class="hljs-comment">#hello是cookie的key的名称</span><br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.102:80</span> weight=<span class="hljs-number">2</span>;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.103:80</span> weight=<span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> /&#123;<br>        <span class="hljs-comment">#proxy_cache mycache;</span><br>        <span class="hljs-attribute">proxy_pass</span> http://websrvs;<br>        &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#测试</span><br><span class="hljs-comment"># curl -b hello=haruka http://www.rlinpc.net</span><br></code></pre></td></tr></table></figure>

<h2 id="4-3-实现-Nginx-tcp-负载均衡"><a href="#4-3-实现-Nginx-tcp-负载均衡" class="headerlink" title="4.3 实现 Nginx tcp 负载均衡"></a>4.3 实现 Nginx tcp 负载均衡</h2><p>Nginx在1.9.0版本开始支持tcp模式的负载均衡，在1.9.13版本开始支持udp协议的负载，udp主要用于DNS的域名解析，其配置方式和指令和http 代理类似，其基于<code>ngx_stream_proxy_module</code>模块实现tcp负载，另外基于模块<code>ngx_stream_upstream_module</code>实现后端服务器分组转发、权重分配、状态监测、调度算法等高级功能。</p>
<p>如果编译安装,需要指定 <code>--with-stream</code> 选项才能支持ngx_stream_proxy_module模块</p>
<p>一般都是使用lvs和haproxy来作为负载均衡</p>
<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">https://nginx.org/en/docs/stream/ngx_stream_proxy_module.html<br>http://nginx.org/en/docs/stream/ngx_stream_upstream_module.html<br></code></pre></td></tr></table></figure>

<p>tcp负载均衡upstream语法，可以与七层负载均衡语法进行对比</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">Syntax:</span>	upstream <span class="hljs-class">name </span>&#123; ... &#125;<br><span class="hljs-symbol">Default:</span>	—<br><span class="hljs-symbol">Context:</span> stream<br></code></pre></td></tr></table></figure>

<h3 id="4-3-1tcp负载均衡配置参数-了解一下，一般会用HAProxy或LVS代替"><a href="#4-3-1tcp负载均衡配置参数-了解一下，一般会用HAProxy或LVS代替" class="headerlink" title="4.3.1tcp负载均衡配置参数(了解一下，一般会用HAProxy或LVS代替)"></a>4.3.1tcp负载均衡配置参数(了解一下，一般会用HAProxy或LVS代替)</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br><span class="hljs-attribute">include</span> /apps/nginx/conf/tcp/<span class="hljs-regexp">*.conf</span>; <span class="hljs-comment">#注意此处的include与http模块平级</span><br><span class="hljs-comment"># mkdir /apps/nginx/conf/tcp -p</span><br><br><span class="hljs-comment"># vim /apps/nginx/conf/tcp/pc.conf</span><br><span class="hljs-comment">#定义stream相关的服务；Context:main</span><br><span class="hljs-section">stream</span> &#123; <br>    <span class="hljs-attribute">upstream</span> backend &#123; <span class="hljs-comment">#定义后端服务器</span><br>        <span class="hljs-attribute">hash</span> $remote_addr consistent; <span class="hljs-comment">#定义调度算法</span><br>        <span class="hljs-attribute">server</span> backend1.example.com:<span class="hljs-number">12345</span> weight=<span class="hljs-number">5</span>; <span class="hljs-comment">#定义具体server</span><br>        <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:12345</span>    max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>        <span class="hljs-attribute">server</span> unix:/tmp/backend3;<br>    &#125;<br>    <br>    <span class="hljs-attribute">upstream</span> dns &#123; <span class="hljs-comment">#定义后端服务器</span><br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.1:53535</span>;  <span class="hljs-comment">#定义具体server</span><br>        <span class="hljs-attribute">server</span> dns.example.com:<span class="hljs-number">53</span>;<br>    &#125;<br>    <br>    <span class="hljs-section">server</span> &#123; <span class="hljs-comment">#定义server</span><br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">12345</span>; <span class="hljs-comment">#监听IP:PORT</span><br>        <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">1s</span>; <span class="hljs-comment">#连接超时时间</span><br>        <span class="hljs-attribute">proxy_timeout</span> <span class="hljs-number">3s</span>; <span class="hljs-comment">#转发超时时间</span><br>        <span class="hljs-attribute">proxy_pass</span> backend; <span class="hljs-comment">#转发到具体服务器组</span><br>    &#125;<br>    <br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">127.0.0.1:53</span> udp reuseport;<br>                   <span class="hljs-attribute">proxy_timeout</span> <span class="hljs-number">20s</span>;<br>                   <span class="hljs-attribute">proxy_pass</span> dns;<br>    &#125;<br>    <br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> [::<span class="hljs-number">1</span>]:<span class="hljs-number">12345</span>;<br>        <span class="hljs-attribute">proxy_pass</span> unix:/tmp/stream.socket;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="4-3-2-负载均衡实例-Redis"><a href="#4-3-2-负载均衡实例-Redis" class="headerlink" title="4.3.2 负载均衡实例 : Redis"></a>4.3.2 负载均衡实例 : Redis</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili8.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="4-3-2-1-后端服务器安装-redis"><a href="#4-3-2-1-后端服务器安装-redis" class="headerlink" title="4.3.2.1 后端服务器安装 redis"></a>4.3.2.1 后端服务器安装 redis</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装两台redis服务器</span><br><span class="hljs-comment"># yum -y install redis #centos</span><br><span class="hljs-comment"># sed -i &#x27;/^bind /c bind 0.0.0.0&#x27; /etc/redis.conf</span><br><span class="hljs-comment">#注意：redis如果监听的地址不为*要在配置文件里将hosts修改为0.0.0.0</span><br><br><span class="hljs-comment"># systemctl enable --now redis</span><br><span class="hljs-comment"># ss -tnl | grep 6379</span><br></code></pre></td></tr></table></figure>
<h4 id="4-3-2-2-nginx配置"><a href="#4-3-2-2-nginx配置" class="headerlink" title="4.3.2.2 nginx配置"></a>4.3.2.2 nginx配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br>include /apps/nginx/conf/tcp/*.conf<br><br><span class="hljs-comment"># mkdir /apps/nginx/conf/tcp</span><br><br><span class="hljs-comment"># vim /apps/nginx/conf/tcp/tcp.conf</span><br>stream &#123;<br>    upstream redis_Server &#123;<br>        server 10.0.0.102:6379 max_fails=3 fail_timeout=30s;<br>        server 10.0.0.103:6379 max_fails=3 fail_timeout=30s;<br>    &#125;<br>    <br>    server &#123;<br>        listen 10.0.0.101:6379;<br>        proxy_connect_timeout 3s;<br>        proxy_timeout 3s;<br>        proxy_pass redis_server;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment"># ss -tnl | grep 6379</span><br></code></pre></td></tr></table></figure>
<h4 id="4-3-2-3-测试"><a href="#4-3-2-3-测试" class="headerlink" title="4.3.2.3 测试"></a>4.3.2.3 测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#测试通过nginx 负载链接redis</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.102 set name rlin</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.102 get name</span><br><span class="hljs-comment"># redis-cli -h 10.0.0.101 get name</span><br></code></pre></td></tr></table></figure>

<h3 id="4-3-3-负载均衡实例：MySQL"><a href="#4-3-3-负载均衡实例：MySQL" class="headerlink" title="4.3.3 负载均衡实例：MySQL"></a>4.3.3 负载均衡实例：MySQL</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fanxiangdaili9.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="4-3-3-1-后端服务器安装MySQL"><a href="#4-3-3-1-后端服务器安装MySQL" class="headerlink" title="4.3.3.1 后端服务器安装MySQL"></a>4.3.3.1 后端服务器安装MySQL</h4><p>环境配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">10.0.0.101     <span class="hljs-comment">#配置Nginx hostnamectl set-hostname Nginx</span><br>10.0.0.102     <span class="hljs-comment">#配置MySQL hostnamectl set-hostname mysql-server1</span><br>10.0.0.103     <span class="hljs-comment">#配置MySQL hostnamectl set-hostname mysql-server2</span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#102，103 安装MySQL服务</span><br><span class="hljs-comment"># yum -y install mariadb-server mysql #centos</span><br><span class="hljs-comment"># systemclt enable --now mariadb #centos</span><br><br><span class="hljs-comment"># mysql</span><br>create user rlin@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>flush privileges;<br><span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-3-2-nginx配置"><a href="#4-3-3-2-nginx配置" class="headerlink" title="4.3.3.2 nginx配置"></a>4.3.3.2 nginx配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nging/conf/tcp/tcp.conf</span><br><span class="hljs-section">stream</span> &#123;<br>    <span class="hljs-attribute">upstream</span> mysql_server &#123;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.102:3306</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">10.0.0.103:3306</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30s</span>;<br>    &#125;<br>    <br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">10.0.0.101:3306</span>;<br>        <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">6s</span>;<br>        <span class="hljs-attribute">proxy_timeout</span> <span class="hljs-number">15s</span>;<br>        <span class="hljs-attribute">proxy_pass</span> mysql_server;<br>    &#125;    <br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-3-3-测试"><a href="#4-3-3-3-测试" class="headerlink" title="4.3.3.3 测试"></a>4.3.3.3 测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#测试通过nginx负载链接MySQL</span><br><span class="hljs-comment">#10.0.0.102 测试</span><br><span class="hljs-comment"># mysql -urlin -p123456 -h10.0.0.101 -e &#x27;show variables like &quot;hostname&quot;&#x27; #多输入几次看结果</span><br><br><span class="hljs-comment">#10.0.0.103 测试</span><br><span class="hljs-comment"># mysql -urlin -p123456 -h10.0.0.101 -e &#x27;show variables like &quot;hostname&quot;&#x27; #多输入几次看结果</span><br><br><span class="hljs-comment">#停止其中一个服务器的MySQL服务,停止那一台就在另一台进行测试</span><br><span class="hljs-comment"># systemctl stop mysqld</span><br><br><span class="hljs-comment">#再次测试访问,只会看到mysql-server1进行响应</span><br><span class="hljs-comment"># mysql -urlin -p123456 -h10.0.0.101 -e &#x27;show variables like &quot;hostname&quot;&#x27;  #多输入几次看结果</span><br></code></pre></td></tr></table></figure>
<h3 id="4-3-4-负载均衡实例：redis和MySQL"><a href="#4-3-4-负载均衡实例：redis和MySQL" class="headerlink" title="4.3.4 负载均衡实例：redis和MySQL"></a>4.3.4 负载均衡实例：redis和MySQL</h3><h4 id="4-3-4-1-后端服务器安装MySQL"><a href="#4-3-4-1-后端服务器安装MySQL" class="headerlink" title="4.3.4.1 后端服务器安装MySQL"></a>4.3.4.1 后端服务器安装MySQL</h4><p>环境配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">10.0.0.101 <span class="hljs-comment">#Ningx hostnamectl set-hostname nginx</span><br>10.0.0.102 <span class="hljs-comment">#redis hostnamectl set-hostname reids</span><br>10.0.0.103 <span class="hljs-comment">#mysql hostnamectl set-hostname mysql</span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装MySQL服务</span><br><span class="hljs-comment"># yum -y install mariadb-server #centos</span><br><span class="hljs-comment"># systemclt enable --now mariadb #centos</span><br><br><span class="hljs-comment"># mysql</span><br>create user rlin@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>flush privileges;<br><span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>
<h4 id="4-3-4-2-后端服务器安装redis"><a href="#4-3-4-2-后端服务器安装redis" class="headerlink" title="4.3.4.2 后端服务器安装redis"></a>4.3.4.2 后端服务器安装redis</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># yum -y install redis #centos</span><br><span class="hljs-comment"># sed -i &#x27;/^bind /c bind 0.0.0.0&#x27; /etc/redis.conf</span><br><span class="hljs-comment">#注意：redis如果监听的地址不为*要在配置文件里将hosts修改为0.0.0.0</span><br><br><span class="hljs-comment"># systemctl enable --now redis</span><br></code></pre></td></tr></table></figure>
<h4 id="4-3-4-3-nginx配置"><a href="#4-3-4-3-nginx配置" class="headerlink" title="4.3.4.3 nginx配置"></a>4.3.4.3 nginx配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br>include /apps/nginx/conf/tcp/*.conf;  <span class="hljs-comment">#注意此处的include与http模块平级</span><br><br><span class="hljs-comment"># mkdir /apps/nginx/conf/tcp -p</span><br><br><span class="hljs-comment"># vim /apps/nginx/conf/tcp/tcp.conf</span><br>stream &#123;<br>    <span class="hljs-comment">#只有一个就不指定算法了</span><br>    upstream redis_server&#123;<br>        server 10.0.0.102:6379 max_fails=3 fail_timeout=30s;<br>    &#125;<br>    <br>    upstream mysql_server &#123;<br>        server 10.0.0.103:3306 max_fails=3 fail_timeout=30s;<br>    &#125;<br>    <br>    <span class="hljs-comment">#监听redis</span><br>    server &#123;<br>        listen 10.0.0.101:6379;<br>        proxy_connect_timeout 3s;<br>        proxy_timeout 3s;<br>        proxy_pass redis_server;<br>    &#125;<br>    <br>    <span class="hljs-comment">#监听MySQL</span><br>    server &#123;<br>        listen 10.0.0.101:6379;<br>        proxy_connect_timeout 3s;<br>        proxy_timeout 3s;<br>        proxy_pass mysql_server;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t </span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h2 id="4-4-Nginx实现FastCGI"><a href="#4-4-Nginx实现FastCGI" class="headerlink" title="4.4 Nginx实现FastCGI"></a>4.4 Nginx实现FastCGI</h2><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi1.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi2.jpg" srcset="/blog/img/loading.gif"></p>
<p>CGI的由来：<br>最早的Web服务器只能简单地响应浏览器发来的HTTP请求，并将存储在服务器上的HTML文件返回给浏览器，也就是静态html文件，但是后期随着网站功能增多网站开发也越来越复杂，以至于出现动态技术，比如像php(1995年)、java(1995)、python(1991)语言开发的网站，但是nginx/apache服务器并不能直接运行 php、java这样的文件，apache实现的方式是打补丁，但是nginx确通过与第三方基于协议实现，即通过某种特定协议将客户端请求转发给第三方服务处理，第三方服务器会新建新的进程处理用户的请求，处理完成后返回数据给Nginx并回收进程，最后nginx在返回给客户端，那这个约定就是通用网关接口(common gateway interface，简称CGI)，CGI（协议） 是web服务器和外部应用程序之间的接口标准，是cgi程序和web服务器之间传递信息的标准化接口。</p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi3.jpg" srcset="/blog/img/loading.gif"></p>
<p><strong>为什么会有FastCGI？</strong></p>
<p>CGI协议虽然解决了语言解析器和 Web Server 之间通讯的问题，但是它的效率很低，因为 Web Server每收到一个请求都会创建一个CGI进程，PHP解析器都会解析php.ini文件，初始化环境，请求结束的时候再关闭进程，对于每一个创建的CGI进程都会执行这些操作，所以效率很低，而FastCGI是用来提高CGI性能的，FastCGI每次处理完请求之后不会关闭掉进程，而是保留这个进程，使这个进程可以处理多个请求。这样的话每个请求都不用再重新创建一个进程了，大大提升了处理效率。</p>
<p><strong>什么是PHP-FPM？</strong><br>PHP-FPM(FastCGI Process Manager：FastCGI进程管理器)是一个实现了Fastcgi的程序，并且提供进程管理的功能。进程包括master进程和worker进程。</p>
<p>master进程只有一个，负责监听端口，接受来自web server的请求。worker进程一般会有多个，每个进程中会嵌入一个PHP解析器，进行PHP代码的处理。</p>
<h3 id="4-4-1-FastCGI配置指令"><a href="#4-4-1-FastCGI配置指令" class="headerlink" title="4.4.1 FastCGI配置指令"></a>4.4.1 FastCGI配置指令</h3><p>Nginx基于模块<code>ngx_http_fastcgi_module</code>实现通过fastcgi协议将指定的客户端请求转发至php-fpm处理，其配置指令如下</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">fastcgi_pass</span> address:port;<br><span class="hljs-comment">#转发请求到后端服务器，address为后端的fastcgi server的地址，可用位置：location, if inlocation</span><br><br><span class="hljs-attribute">fastcgi_index</span> name;<br><span class="hljs-comment">#fastcgi默认的主页资源，示例：fastcgi_index index.php;</span><br><br><span class="hljs-attribute">fastcgi_param</span> parameter value [if_not_empty];<br><span class="hljs-comment">#设置传递给FastCGI服务器的参数值，可以是文本，变量或组合，可用于将Nginx的内置变量赋值给自定义key</span><br><br><span class="hljs-attribute">fastcgi_param</span> REMOTE_ADDR     $remote_addr; <span class="hljs-comment">#客户端源IP</span><br><span class="hljs-attribute">fastcgi_param</span> REMOTE_PORT     $remote_port; <span class="hljs-comment">#客户端源端口</span><br><span class="hljs-attribute">fastcgi_param</span> SERVER_ADDR     $server_addr; <span class="hljs-comment">#请求的服务器IP地址</span><br><span class="hljs-attribute">fastcgi_param</span> SERVER_PORT     $server_port; <span class="hljs-comment">#请求的服务器端口</span><br><span class="hljs-attribute">fastcgi_param</span> SERVER_NAME     $server_name; <span class="hljs-comment">#请求的server name</span><br><br>Nginx默认配置示例：<br> <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> &#123;<br>    <span class="hljs-attribute">root</span>      /scripts;<br>    <span class="hljs-comment">#对于PHP来讲只需要配置以下三行，最后一行加上去就行</span><br>    <span class="hljs-attribute">fastcgi_pass</span>  <span class="hljs-number">127.0.0.1:9000</span>;<br>    <span class="hljs-attribute">fastcgi_index</span> index.php;<br>    <span class="hljs-comment">#下面两种选择文件路径二选一</span><br>    <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME /scripts$fastcgi_script_name; <span class="hljs-comment">#默认脚本路径(PHP文件路径)</span><br>    <span class="hljs-comment">#fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br>    <span class="hljs-attribute">include</span>    fastcgi_params;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>fastcgi 缓存定义指令：注意使用fastcgi缓存, 可能会导致源代码更新失败,生产慎用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">fastcgi_cache_path path [levels=levels] [use_temp_path=on|off]<br>keys_zone=name:size [inactive=time] [max_size=size] [manager_files=number]<br>[manager_sleep=time] [manager_threshold=time] [loader_files=number]<br>[loader_sleep=time] [loader_threshold=time] [purger=on|off]<br>[purger_files=number] [purger_sleep=time] [purger_threshold=time];<br><br><span class="hljs-comment">#定义fastcgi的缓存;</span><br>path  <span class="hljs-comment">#缓存位置为磁盘上的文件系统路径</span><br>max_size=size <span class="hljs-comment">#磁盘path路径中用于缓存数据的缓存空间上限</span><br>levels=levels：<span class="hljs-comment">#缓存目录的层级数量，以及每一级的目录数量</span><br>levels=ONE:TWO:THREE <span class="hljs-comment">#示例：leves=1:2:2</span><br>keys_zone=name:size <span class="hljs-comment">#设置缓存名称及k/v映射的内存空间的名称及大小</span><br>inactive=time <span class="hljs-comment">#缓存有效时间，默认10分钟，需要在指定时间满足fastcgi_cache_min_uses次数被视为活动缓存。</span><br></code></pre></td></tr></table></figure>

<p>缓存调用指令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">fastcgi_cache zone | off; <span class="hljs-comment">#调用指定的缓存空间来缓存数据，可用位置：http, server, location</span><br><br>fastcgi_cache_key string; <span class="hljs-comment">#定义用作缓存项的key的字符串，示例：fastcgi_cache_key $request_uri;</span><br><br>fastcgi_cache_methods GET | HEAD | POST ...; <span class="hljs-comment">#为哪些请求方法使用缓存</span><br><br>fastcgi_cache_min_uses number; <span class="hljs-comment">#缓存空间中的缓存项在inactive定义的非活动时间内至少要被访问到此处所指定的次数方可被认作活动项</span><br><br>fastcgi_keep_conn on | off; <span class="hljs-comment">#收到后端服务器响应后，fastcgi服务器是否关闭连接，建议启用长连接</span><br><br>fastcgi_cache_valid [code ...] time; <span class="hljs-comment">#不同的响应码各自的缓存时长</span><br><br>fastcgi_hide_header field; <span class="hljs-comment">#隐藏响应头指定信息</span><br><br>fastcgi_pass_header field; <span class="hljs-comment">#返回响应头指定信息，默认不会将Status、X-Accel-...返回</span><br></code></pre></td></tr></table></figure>

<h3 id="4-4-2-FastCGI实战案例-Nginx与php-fpm在同一服务器"><a href="#4-4-2-FastCGI实战案例-Nginx与php-fpm在同一服务器" class="headerlink" title="4.4.2 FastCGI实战案例 : Nginx与php-fpm在同一服务器"></a>4.4.2 FastCGI实战案例 : Nginx与php-fpm在同一服务器</h3><p>php安装可以通过yum或者编译安装，使用yum安装相对比较简单，编译安装更方便自定义参数或选项。<br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi4.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="4-4-2-1-环境准备"><a href="#4-4-2-1-环境准备" class="headerlink" title="4.4.2.1 环境准备"></a>4.4.2.1 环境准备</h4><p>使用base源自带的php版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.101</span><br><span class="hljs-comment"># yum -y install php-fpm php-mysqlnd php-json</span><br><span class="hljs-comment">#或者安装清华的php源</span><br><span class="hljs-comment"># yum install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm</span><br><br><span class="hljs-comment">#开启php-fpm</span><br><span class="hljs-comment"># systemclt enable --now php-fpm</span><br><br><span class="hljs-comment">#查看php-fpm是否开启成功</span><br>ps -ef | grep php-fpm<br>root      24262      1  0 18:18 ?        00:00:00 php-fpm: master process (/etc/php/7.2/fpm/php-fpm.conf)<br>nginx     24263  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24264  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24265  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24266  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24267  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>root      24486  23795  0 20:09 pts/1    00:00:00 grep --color=auto php-fpm<br></code></pre></td></tr></table></figure>
<h4 id="4-4-2-2-php相关配置优化"><a href="#4-4-2-2-php相关配置优化" class="headerlink" title="4.4.2.2 php相关配置优化"></a>4.4.2.2 php相关配置优化</h4><p><strong>相关优化可以看lamp的笔记</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim /etc/php-fpm.conf  #centos</span><br>include=/etc/php-fpm.d/*.conf<br>pid = /run/php-fpm/php-fpm.pid<br>error_log = /var/<span class="hljs-built_in">log</span>/php-fpm/error.log<br>daemonize = yes <span class="hljs-comment">#是否后台启动</span><br><br><span class="hljs-comment"># vim /etc/php-fpm.d/www.conf #centos</span><br>[www]<br>user = nginx<br>group = nginx<br>listen = /run/php-fpm/www.sock  <span class="hljs-comment">#指定使用UDS,或者使用下面形式</span><br>;listen = 127.0.0.1:9000  <span class="hljs-comment">#监听地址及IP</span><br>listen.acl_users = apache,nginx<br>listen.allowed_clients = 127.0.0.1<br>pm = dynamic<br>pm.max_children = 50<br>pm.start_servers = 5<br>pm.min_spare_servers = 5<br>pm.max_spare_servers = 35<br>pm.status_path = /pm_status  <span class="hljs-comment">#修改此行</span><br><br><span class="hljs-comment"># systemctl restart php-fpm</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-3准备php测试页面"><a href="#4-4-2-3准备php测试页面" class="headerlink" title="4.4.2.3准备php测试页面"></a>4.4.2.3准备php测试页面</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># mkdir -p /data/php</span><br><span class="hljs-comment"># vim /data/php/index.php #php测试页面</span><br>&lt;?php<br>phpinfo();<br>?&gt;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-4-Nginx配置转发"><a href="#4-4-2-4-Nginx配置转发" class="headerlink" title="4.4.2.4 Nginx配置转发"></a>4.4.2.4 Nginx配置转发</h4><p>Nginx安装完成之后默认生成了与fastcgi的相关配置文件，一般保存在nginx的安装路径的conf目录当中，如/apps/nginx/conf/fastcgi.conf、/apps/nginx/conf/fastcgi_params。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$|status|ping</span> &#123;<br>            <span class="hljs-attribute">root</span>           /data/php; <span class="hljs-comment">#$document_root调用root目录</span><br>            <span class="hljs-attribute">fastcgi_pass</span>  unix:/run/php-fpm/www.sock;<br>            <span class="hljs-comment">#fastcgi_pass   127.0.0.1:9000;</span><br>            <span class="hljs-attribute">fastcgi_index</span>  index.php;<br>            <span class="hljs-attribute">fastcgi_param</span>  SCRIPT_FILENAME  /data/php$fastcgi_script_name;<br>            <span class="hljs-comment">#fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br>            <span class="hljs-comment">#如果SCRIPT_FILENAME是绝对路径则可以省略root /data/php;</span><br>            <span class="hljs-attribute">include</span>        fastcgi_params;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><span class="hljs-comment">#浏览器访问www.rlinpc.net/index.php</span><br></code></pre></td></tr></table></figure>
<h4 id="4-4-2-5-访问验证php测试页面"><a href="#4-4-2-5-访问验证php测试页面" class="headerlink" title="4.4.2.5 访问验证php测试页面"></a>4.4.2.5 访问验证php测试页面</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi7.jpg" srcset="/blog/img/loading.gif"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#常见的错误：</span><br>File not found.  <span class="hljs-comment">#路径不对</span><br>502  <span class="hljs-comment">#php-fpm处理超时、服务停止运行等原因导致的无法连接或请求超时</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-6-php-fpm-的运行状态页面"><a href="#4-4-2-6-php-fpm-的运行状态页面" class="headerlink" title="4.4.2.6 php-fpm 的运行状态页面"></a>4.4.2.6 php-fpm 的运行状态页面</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(ping|pm_status)$</span> &#123;<br>             <span class="hljs-attribute">include</span> fastcgi_params;<br>             <span class="hljs-comment">#fastcgi_pass unix:/run/php-fpm/www.sock;</span><br>             <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">127.0.0.1:9000</span>;<br>             <span class="hljs-attribute">fastcgi_param</span> PATH_TRANSLATED $document_root$fastcgi_script_name;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#测试</span><br><span class="hljs-comment"># curl http://www.rlinpc.net/ping</span><br><span class="hljs-attribute">pong</span><br><br><span class="hljs-comment"># curl http://www.rlinpc.net/pm_status</span><br>pool:                 www<br>process manager:      dynamic<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8436</span><br>accepted conn:        <span class="hljs-number">5</span><br>listen queue:         <span class="hljs-number">0</span><br>max listen queue:     <span class="hljs-number">0</span><br>listen queue len:     <span class="hljs-number">511</span><br>idle processes:       <span class="hljs-number">4</span><br>active processes:     <span class="hljs-number">1</span><br>total processes:      <span class="hljs-number">5</span><br>max active processes: <span class="hljs-number">1</span><br>max children reached: <span class="hljs-number">0</span><br>slow requests:        <span class="hljs-number">0</span><br><br><span class="hljs-comment"># curl http://www.rlinpc.net/pm_status?full</span><br>pool:                 www<br>process manager:      dynamic<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>accepted conn:        <span class="hljs-number">6</span><br>listen queue:         <span class="hljs-number">0</span><br>max listen queue:     <span class="hljs-number">0</span><br>listen queue len:     <span class="hljs-number">511</span><br>idle processes:       <span class="hljs-number">4</span><br>active processes:     <span class="hljs-number">1</span><br>total processes:      <span class="hljs-number">5</span><br>max active processes: <span class="hljs-number">1</span><br>max children reached: <span class="hljs-number">0</span><br>slow requests:        <span class="hljs-number">0</span><br><br>************************<br>pid:                  <span class="hljs-number">24263</span><br>state:                Running<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>requests:             <span class="hljs-number">2</span><br>request duration:     <span class="hljs-number">268</span><br>request method:       GET<br>request URI:          /pm_status?full<br>content length:       <span class="hljs-number">0</span><br>user:                 -<br>script:               -<br><span class="hljs-literal">last</span> request cpu:     <span class="hljs-number">0</span>.<span class="hljs-number">00</span><br><span class="hljs-literal">last</span> request memory:  <span class="hljs-number">0</span><br><br>************************<br>pid:                  <span class="hljs-number">24264</span><br>state:                Idle<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>requests:             <span class="hljs-number">1</span><br>request duration:     <span class="hljs-number">13377</span><br>request method:       GET<br>request URI:          /pm_status<br>content length:       <span class="hljs-number">0</span><br>user:                 -<br>script:               -<br><span class="hljs-literal">last</span> request cpu:     <span class="hljs-number">0</span>.<span class="hljs-number">00</span><br><span class="hljs-literal">last</span> request memory:  <span class="hljs-number">2097152</span><br><br>************************<br>pid:                  <span class="hljs-number">24265</span><br>state:                Idle<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>requests:             <span class="hljs-number">1</span><br>request duration:     <span class="hljs-number">532</span><br>request method:       GET<br>request URI:          /ping<br>content length:       <span class="hljs-number">0</span><br>user:                 -<br>script:               -<br><span class="hljs-literal">last</span> request cpu:     <span class="hljs-number">0</span>.<span class="hljs-number">00</span><br><span class="hljs-literal">last</span> request memory:  <span class="hljs-number">2097152</span><br><br>************************<br>pid:                  <span class="hljs-number">24266</span><br>state:                Idle<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>requests:             <span class="hljs-number">1</span><br>request duration:     <span class="hljs-number">580</span><br>request method:       GET<br>request URI:          /ping<br>content length:       <span class="hljs-number">0</span><br>user:                 -<br>script:               -<br><span class="hljs-literal">last</span> request cpu:     <span class="hljs-number">0</span>.<span class="hljs-number">00</span><br><span class="hljs-literal">last</span> request memory:  <span class="hljs-number">2097152</span><br><br>************************<br>pid:                  <span class="hljs-number">24267</span><br>state:                Idle<br>start time:           <span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span><br>start since:          <span class="hljs-number">8467</span><br>requests:             <span class="hljs-number">1</span><br>request duration:     <span class="hljs-number">426</span><br>request method:       GET<br>request URI:          /pm_status<br>content length:       <span class="hljs-number">0</span><br>user:                 -<br>script:               -<br><span class="hljs-literal">last</span> request cpu:     <span class="hljs-number">0</span>.<span class="hljs-number">00</span><br><span class="hljs-literal">last</span> request memory:  <span class="hljs-number">2097152</span><br><br><span class="hljs-comment"># curl http://www.rlinpc.net/pm_status?html</span><br>&lt;!DOCTYPE html PUBLIC <span class="hljs-string">&quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;</span> <span class="hljs-string">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;</span>&gt;<br>&lt;html xmlns=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span> xml:lang=<span class="hljs-string">&quot;en&quot;</span> lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;&lt;title&gt;PHP-FPM Status Page&lt;/title&gt;&lt;/head&gt;<br>&lt;body&gt;<br>&lt;table&gt;<br>&lt;tr&gt;&lt;th&gt;pool&lt;/th&gt;&lt;td&gt;www&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;process manager&lt;/th&gt;&lt;td&gt;dynamic&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;start time&lt;/th&gt;&lt;td&gt;<span class="hljs-number">23</span>/Feb/<span class="hljs-number">2021</span>:<span class="hljs-number">18</span>:<span class="hljs-number">18</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0800</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;start since&lt;/th&gt;&lt;td&gt;<span class="hljs-number">8487</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;accepted conn&lt;/th&gt;&lt;td&gt;<span class="hljs-number">7</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;listen queue&lt;/th&gt;&lt;td&gt;<span class="hljs-number">0</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;max listen queue&lt;/th&gt;&lt;td&gt;<span class="hljs-number">0</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;listen queue len&lt;/th&gt;&lt;td&gt;<span class="hljs-number">511</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;idle processes&lt;/th&gt;&lt;td&gt;<span class="hljs-number">4</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;active processes&lt;/th&gt;&lt;td&gt;<span class="hljs-number">1</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;total processes&lt;/th&gt;&lt;td&gt;<span class="hljs-number">5</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;max active processes&lt;/th&gt;&lt;td&gt;<span class="hljs-number">1</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;max children reached&lt;/th&gt;&lt;td&gt;<span class="hljs-number">0</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;tr&gt;&lt;th&gt;slow requests&lt;/th&gt;&lt;td&gt;<span class="hljs-number">0</span>&lt;/td&gt;&lt;/tr&gt;<br>&lt;/table&gt;<br>&lt;/body&gt;&lt;/html&gt;<br><br><span class="hljs-comment"># curl http://www.rlinpc.net/pm_status?json</span><br>&#123;&quot;pool&quot;:&quot;www&quot;,&quot;<span class="hljs-attribute">process</span> manager<span class="hljs-string">&quot;:&quot;</span>dynamic<span class="hljs-string">&quot;,&quot;</span>start time<span class="hljs-string">&quot;:1614075531,&quot;</span>start since<span class="hljs-string">&quot;:8517,&quot;</span>accepted conn<span class="hljs-string">&quot;:8,&quot;</span>listen queue<span class="hljs-string">&quot;:0,&quot;</span>max listen queue<span class="hljs-string">&quot;:0,&quot;</span>listen queue len<span class="hljs-string">&quot;:511,&quot;</span>idle processes<span class="hljs-string">&quot;:4,&quot;</span>active processes<span class="hljs-string">&quot;:1,&quot;</span>total processes<span class="hljs-string">&quot;:5,&quot;</span>max active processes<span class="hljs-string">&quot;:1,&quot;</span>max children reached<span class="hljs-string">&quot;:0,&quot;</span>slow requests<span class="hljs-string">&quot;:0&#125;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi8.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi9.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="4-4-2-7-安装数据库"><a href="#4-4-2-7-安装数据库" class="headerlink" title="4.4.2.7 安装数据库"></a>4.4.2.7 安装数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># yum install -y mariadb-server</span><br><br><span class="hljs-comment"># vim /etc/mysql/mysql.conf.d/mysqld.cnf #Ubuntu需要修改</span><br><span class="hljs-comment">#bind-address           = 127.0.0.1</span><br>bind-address            = *  <span class="hljs-comment">#将本地地址改为*</span><br><br><span class="hljs-comment">#开启数据库</span><br><span class="hljs-comment"># systemctl enable --now mariadb</span><br><span class="hljs-comment"># mysql</span><br>create database wordpress;<br>grant all on wordpress.* to wordpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-8-布置wordpress"><a href="#4-4-2-8-布置wordpress" class="headerlink" title="4.4.2.8 布置wordpress"></a>4.4.2.8 布置wordpress</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># mkdir -p /data/php </span><br><span class="hljs-comment"># cd /data/php</span><br><span class="hljs-comment"># wget https://cn.wordpress.org/latest-zh_CN.tar.gz</span><br><span class="hljs-comment"># tar xvf latest-zh_CN.tar.gz</span><br><span class="hljs-comment"># chown nginx.nginx -R wordpress</span><br><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>        <span class="hljs-attribute">index</span> index.html;<br>    &#125;<br>    <br>    <span class="hljs-attribute">location</span> /wordpress &#123;<br>        <span class="hljs-attribute">root</span> /data/php;<br>        <span class="hljs-attribute">index</span> index.php;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br><br><span class="hljs-comment">#浏览器访问www.rlinpc.net/wordpress/index.php，按着安装(注意chrome的缓存会是wordpress/index.php一直出现下载文件的状态，这是需要清理缓存或更换浏览器)</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi10.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="4-4-3-FastCGI实战案例-Nginx与php不在同一个服务器"><a href="#4-4-3-FastCGI实战案例-Nginx与php不在同一个服务器" class="headerlink" title="4.4.3 FastCGI实战案例 : Nginx与php不在同一个服务器"></a>4.4.3 FastCGI实战案例 : Nginx与php不在同一个服务器</h3><p>nginx会处理静态请求，但是会转发动态请求到后端指定的php-fpm服务器，因此代码也需要放在后端的php-fpm服务器，即静态页面放在Nginx服务器上,而动态页面放在后端php-fpm服务器，正常情况下，一般都是采用在同一个服务器<br><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi5.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="4-4-3-1-安装较新版本php-fpm"><a href="#4-4-3-1-安装较新版本php-fpm" class="headerlink" title="4.4.3.1 安装较新版本php-fpm"></a>4.4.3.1 安装较新版本php-fpm</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#yum安装默认版本php和相关APP依赖的包</span><br><span class="hljs-comment"># yum -y install php-fpm php-mysqlnd php-json #centos</span><br><span class="hljs-comment">#或者安装清华的php源</span><br><span class="hljs-comment"># yum install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm</span><br><br><span class="hljs-comment">#centos验证安装路径</span><br><span class="hljs-comment"># rpm -ql php-fpm</span><br>/etc/httpd/conf.d/php.conf<br>/etc/logrotate.d/php-fpm<br>/etc/nginx/conf.d/php-fpm.conf<br>/etc/nginx/default.d/php.conf<br>/etc/php-fpm.conf<br>/etc/php-fpm.d<br>/etc/php-fpm.d/www.conf<br>/etc/systemd/system/php-fpm.service.d<br>/run/php-fpm<br>/usr/lib/.build-id<br>/usr/lib/.build-id/bf<br>/usr/lib/.build-id/bf/8d6b2bca109fb20f8037d72220670f2d6cc954<br>/usr/lib/systemd/system/httpd.service.d/php-fpm.conf<br>/usr/lib/systemd/system/nginx.service.d/php-fpm.conf<br>/usr/lib/systemd/system/php-fpm.service<br>/usr/sbin/php-fpm<br>/usr/share/doc/php-fpm<br>/usr/share/doc/php-fpm/php-fpm.conf.default<br>/usr/share/doc/php-fpm/www.conf.default<br>/usr/share/fpm<br>/usr/share/fpm/status.html<br>/usr/share/licenses/php-fpm<br>/usr/share/licenses/php-fpm/fpm_LICENSE<br>/usr/share/man/man8/php-fpm.8.gz<br>/var/lib/php/opcache<br>/var/lib/php/session<br>/var/lib/php/wsdlcache<br>/var/<span class="hljs-built_in">log</span>/php-fpm<br><br><span class="hljs-comment">#ubuntu验证安装路径</span><br><span class="hljs-comment"># dpkg -L php7.2-fpm</span><br>/.<br>/etc<br>/etc/apache2<br>/etc/apache2/conf-available<br>/etc/apache2/conf-available/php7.2-fpm.conf<br>/etc/init<br>/etc/init/php7.2-fpm.conf<br>/etc/init.d<br>/etc/init.d/php7.2-fpm<br>/etc/logrotate.d<br>/etc/logrotate.d/php7.2-fpm<br>/etc/php<br>/etc/php/7.2<br>/etc/php/7.2/fpm<br>/etc/php/7.2/fpm/conf.d<br>/etc/php/7.2/fpm/php-fpm.conf<br>/etc/php/7.2/fpm/pool.d<br>/etc/php/7.2/fpm/pool.d/www.conf<br>/lib<br>/lib/systemd<br>/lib/systemd/system<br>/lib/systemd/system/php7.2-fpm.service<br>/usr<br>/usr/lib<br>/usr/lib/php<br>/usr/lib/php/7.2<br>/usr/lib/php/7.2/sapi<br>/usr/lib/php/7.2/sapi/fpm<br>/usr/lib/php/php7.2-fpm-reopenlogs<br>/usr/lib/tmpfiles.d<br>/usr/lib/tmpfiles.d/php7.2-fpm.conf<br>/usr/sbin<br>/usr/sbin/php-fpm7.2<br>/usr/share<br>/usr/share/bug<br>/usr/share/bug/php7.2-fpm<br>/usr/share/bug/php7.2-fpm/control<br>/usr/share/bug/php7.2-fpm/script<br>/usr/share/doc<br>/usr/share/lintian<br>/usr/share/lintian/overrides<br>/usr/share/lintian/overrides/php7.2-fpm<br>/usr/share/man<br>/usr/share/man/man8<br>/usr/share/man/man8/php-fpm7.2.8.gz<br>/usr/share/php<br>/usr/share/php/7.2<br>/usr/share/php/7.2/fpm<br>/usr/share/php/7.2/fpm/status.html<br>/usr/share/doc/php7.2-fpm<br><br><span class="hljs-comment">#开启php-fpm</span><br><span class="hljs-comment"># systemclt enable --now php-fpm</span><br><br><span class="hljs-comment">#查看php-fpm是否开启成功</span><br><span class="hljs-comment"># ps -ef | grep php-fpm</span><br>root      24262      1  0 18:18 ?        00:00:00 php-fpm: master process (/etc/php/7.2/fpm/php-fpm.conf)<br>nginx     24263  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24264  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24265  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24266  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24267  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>root      24486  23795  0 20:09 pts/1    00:00:00 grep --color=auto php-fpm<br></code></pre></td></tr></table></figure>

<h4 id="4-4-3-2-修改php-fpm监听配置"><a href="#4-4-3-2-修改php-fpm监听配置" class="headerlink" title="4.4.3.2 修改php-fpm监听配置"></a>4.4.3.2 修改php-fpm监听配置</h4><p>php-fpm默认监听在127.0.0.1的9000端口，也就是无法远程连接，因此要做相应的修改。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#centos</span><br><span class="hljs-comment"># vim /etc/php-fpm.d/www.conf</span><br>;listen = /run/php-fpm/www.sock <span class="hljs-comment">#注释此行</span><br>listen = 9000  <span class="hljs-comment">#指定监听端口</span><br>;listen.allowed_clients = 127.0.0.1  <span class="hljs-comment">#注释此行</span><br><br><span class="hljs-comment">#ubuntu</span><br><span class="hljs-comment"># vim /etc/php/7.2/fpm/pool.d/www.conf </span><br>;listen = /run/php/php7.2-fpm.sock <span class="hljs-comment">#注释此行</span><br>listen = 9000<br>;listen.allowed_clients = 127.0.0.1  <span class="hljs-comment">#注释此行</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-3-3-准备php测试页面"><a href="#4-4-3-3-准备php测试页面" class="headerlink" title="4.4.3.3 准备php测试页面"></a>4.4.3.3 准备php测试页面</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#准备php数据目录</span><br><span class="hljs-comment"># mkdir -p /data/php</span><br><span class="hljs-comment"># vim /data/php/index.php</span><br>&lt;?php<br>phpinfo();<br>?&gt;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-3-4-启动并验证php-fpm"><a href="#4-4-3-4-启动并验证php-fpm" class="headerlink" title="4.4.3.4 启动并验证php-fpm"></a>4.4.3.4 启动并验证php-fpm</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启动php-fpm</span><br><span class="hljs-comment"># systemctl enable --now php-fpm.service #centos</span><br><span class="hljs-comment"># systemctl enable --now php7.2-fpm.service #ubuntu</span><br><br><span class="hljs-comment">#验证php-fpm进程及端口</span><br><span class="hljs-comment"># ps -ef | grep php-fpm</span><br>root        775      1  0 21:43 ?        00:00:00 php-fpm: master process (/etc/php/7.2/fpm/php-fpm.conf)<br>nginx       855    775  0 21:44 ?        00:00:00 php-fpm: pool www<br>nginx       856    775  0 21:44 ?        00:00:00 php-fpm: pool www<br>nginx       857    775  0 21:44 ?        00:00:00 php-fpm: pool www<br>nginx       858    775  0 21:44 ?        00:00:00 php-fpm: pool www<br>nginx       859    775  0 21:44 ?        00:00:00 php-fpm: pool www<br>root       1154   1051  0 21:53 pts/0    00:00:00 grep --color=auto php-fpm<br><br><span class="hljs-comment"># ss -tnl | grep 9000</span><br>LISTEN   0         511                       *:9000                   *:* <br><br><span class="hljs-comment"># lsof -i :9000</span><br>COMMAND   PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>php-fpm7. 775  root    7u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 855 nginx    9u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 856 nginx    9u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 857 nginx    9u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 858 nginx    9u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 859 nginx    9u  IPv6  27404      0t0  TCP *:9000 (LISTEN)<br></code></pre></td></tr></table></figure>

<h4 id="4-4-3-5-Nginx配置转发"><a href="#4-4-3-5-Nginx配置转发" class="headerlink" title="4.4.3.5 Nginx配置转发"></a>4.4.3.5 Nginx配置转发</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">index</span> index.php;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">root</span> /data/nginx/html/pc;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$|status|ping</span> &#123;<br>            <span class="hljs-attribute">root</span>           html;<br>            <span class="hljs-attribute">fastcgi_pass</span>   <span class="hljs-number">10.0.0.102:9000</span>;<br>            <span class="hljs-attribute">fastcgi_index</span>  index.php;<br>            <span class="hljs-attribute">fastcgi_param</span>  SCRIPT_FILENAME  /data/php$fastcgi_script_name;<br>            <span class="hljs-comment">#fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br>            <span class="hljs-attribute">include</span>        fastcgi_params;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(ping|pm_status)$</span> &#123;<br>             <span class="hljs-attribute">include</span> fastcgi_params;<br>             <span class="hljs-comment">#fastcgi_pass unix:/run/php-fpm/www.sock;</span><br>             <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">10.0.0.102:9000</span>;<br>             <span class="hljs-attribute">fastcgi_param</span> PATH_TRANSLATED $document_root$fastcgi_script_name;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-3-6-访问验证php测试页面"><a href="#4-4-3-6-访问验证php测试页面" class="headerlink" title="4.4.3.6 访问验证php测试页面"></a>4.4.3.6 访问验证php测试页面</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi11.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="4-4-4-实现动静分离"><a href="#4-4-4-实现动静分离" class="headerlink" title="4.4.4 实现动静分离"></a>4.4.4 实现动静分离</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi6.jpg" srcset="/blog/img/loading.gif"></p>
<p><strong>要求：将客户端对除php以外的资源的访问转发至后端服务器 10.0.0.103上（10.0.0.102是动态资源，10.0.0.103是静态资源）</strong></p>
<h4 id="4-4-4-1-配置-Nginx-实现反向代理的动静分离"><a href="#4-4-4-1-配置-Nginx-实现反向代理的动静分离" class="headerlink" title="4.4.4.1 配置 Nginx 实现反向代理的动静分离"></a>4.4.4.1 配置 Nginx 实现反向代理的动静分离</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#10.0.0.101 </span><br><span class="hljs-comment"># vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">index</span> index.html;<br>        <span class="hljs-attribute">proxy_pass</span> http://10.0.0.103; <span class="hljs-comment">#注意端口</span><br>    &#125;<br>   <br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$|status|ping</span> &#123;<br>            <span class="hljs-attribute">root</span>           /data/php;<br>            <span class="hljs-attribute">fastcgi_pass</span>   <span class="hljs-number">10.0.0.102:9000</span>;<br>            <span class="hljs-attribute">fastcgi_index</span>  index.php;<br>            <span class="hljs-comment">#fastcgi_param  SCRIPT_FILENAME  /data/php$fastcgi_script_name;</span><br>            <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME  $document_root$fastcgi_script_name;<br>            <span class="hljs-attribute">include</span>        fastcgi_params;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -t</span><br><span class="hljs-comment"># /apps/nginx/sbin/nginx -s reload</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-4-2-准备后端php服务器"><a href="#4-4-4-2-准备后端php服务器" class="headerlink" title="4.4.4.2 准备后端php服务器"></a>4.4.4.2 准备后端php服务器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.102安装php服务</span><br><span class="hljs-comment">#yum或apt安装默认版本php和相关APP依赖的包</span><br><span class="hljs-comment"># yum -y install php-fpm php-mysqlnd php-json #centos</span><br><span class="hljs-comment"># apt -y install php-fpm php-mysqlnd php-json #Ubuntu</span><br><span class="hljs-comment">#或者安装清华的php源</span><br><span class="hljs-comment"># yum install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm</span><br><br><span class="hljs-comment">#开启php-fpm</span><br><span class="hljs-comment"># systemclt start php-fpm #centos</span><br><span class="hljs-comment"># systemctl start php7.2-fpm #ubuntu</span><br><br><span class="hljs-comment">#查看php-fpm是否开启成功</span><br><span class="hljs-comment"># ps -ef | grep php-fpm</span><br>root      24262      1  0 18:18 ?        00:00:00 php-fpm: master process (/etc/php/7.2/fpm/php-fpm.conf)<br>nginx     24263  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24264  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24265  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24266  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>nginx     24267  24262  0 18:18 ?        00:00:00 php-fpm: pool www<br>root      24486  23795  0 20:09 pts/1    00:00:00 grep --color=auto php-fpm<br><br><span class="hljs-comment">#准备php数据目录</span><br><span class="hljs-comment"># mkdir -p /data/php</span><br><span class="hljs-comment"># vim /data/php/index.php</span><br>&lt;?php<br>phpinfo();<br>?&gt;<br><br><span class="hljs-comment">#修改监听配置</span><br><span class="hljs-comment">#centos</span><br><span class="hljs-comment"># vim /etc/php-fpm.d/www.conf</span><br>;listen = /run/php-fpm/www.sock <span class="hljs-comment">#注释此行</span><br>listen = 9000  <span class="hljs-comment">#指定监听端口</span><br>;listen.allowed_clients = 127.0.0.1  <span class="hljs-comment">#注释此行</span><br>systemctl restart php-fpm<br><br><span class="hljs-comment">#ubuntu</span><br><span class="hljs-comment"># vim /etc/php/7.2/fpm/pool.d/www.conf </span><br>;listen = /run/php/php7.2-fpm.sock <span class="hljs-comment">#注释此行</span><br>listen = 9000<br>;listen.allowed_clients = 127.0.0.1  <span class="hljs-comment">#注释此行</span><br>systemctl restart php7.2-fpm<br><br><span class="hljs-comment">#启动php-fpm</span><br><span class="hljs-comment"># systemctl enable --now php-fpm.service #centos</span><br><span class="hljs-comment"># systemctl enable --now php7.2-fpm.service #ubuntu</span><br><br><span class="hljs-comment">#验证php-fpm进程及端口</span><br><span class="hljs-comment"># ps -ef | grep php-fpm</span><br>root       9775      1  0 20:13 ?        00:00:00 php-fpm: master process (/etc/php/7.2/fpm/php-fpm.conf)<br>www-data   9776   9775  0 20:13 ?        00:00:00 php-fpm: pool www<br>www-data   9777   9775  0 20:13 ?        00:00:00 php-fpm: pool www<br>root       9805   1409  0 20:18 pts/0    00:00:00 grep --color=auto php-fpm<br><br><br><span class="hljs-comment"># ss -tnl | grep 9000</span><br>LISTEN   0         511                       *:9000                   *:* <br><br><span class="hljs-comment"># lsof -i :9000</span><br>COMMAND    PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>php-fpm7. 9775     root    7u  IPv6  59755      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 9776 www-data    9u  IPv6  59755      0t0  TCP *:9000 (LISTEN)<br>php-fpm7. 9777 www-data    9u  IPv6  59755      0t0  TCP *:9000 (LISTEN)<br></code></pre></td></tr></table></figure>

<h4 id="4-4-4-3-准备后端-httpd-服务器"><a href="#4-4-4-3-准备后端-httpd-服务器" class="headerlink" title="4.4.4.3 准备后端 httpd 服务器"></a>4.4.4.3 准备后端 httpd 服务器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#10.0.0.103安装httpd服务</span><br><span class="hljs-comment"># yum -y install httpd #centos</span><br><span class="hljs-comment"># apt -y install apache2 #ubuntu</span><br><br><span class="hljs-comment"># systemctl enable --now httpd #centos</span><br><span class="hljs-comment"># systemctl enable --now apache2 #ubuntu</span><br><br><span class="hljs-comment"># mkdir /var/www/html/images -p </span><br><span class="hljs-comment"># cd /var/www/html/images </span><br><span class="hljs-comment">#存放一张1.jpg的图片</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-4-4-测试"><a href="#4-4-4-4-测试" class="headerlink" title="4.4.4.4 测试"></a>4.4.4.4 测试</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi11.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-fastcgi12.jpg" srcset="/blog/img/loading.gif"></p>
<h1 id="五、Nginx-二次开发版本"><a href="#五、Nginx-二次开发版本" class="headerlink" title="五、Nginx 二次开发版本"></a>五、Nginx 二次开发版本</h1><h2 id="5-1-Tengine"><a href="#5-1-Tengine" class="headerlink" title="5.1 Tengine"></a>5.1 Tengine</h2><h3 id="5-1-1-Tengine-介绍"><a href="#5-1-1-Tengine-介绍" class="headerlink" title="5.1.1 Tengine 介绍"></a>5.1.1 Tengine 介绍</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-tengine1.jpg" srcset="/blog/img/loading.gif"><br>Tengine是由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性。Tengine的性能和稳定性已经在大型的网站如淘宝网，天猫商城等得到了很好的检验。它的最终目标是打造一个高效、稳定、安全、易用的Web平台。</p>
<p>官网：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://tengine.taobao.org/<br></code></pre></td></tr></table></figure>

<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://tengine.taobao.org/documentation_cn.html<br></code></pre></td></tr></table></figure>

<h3 id="5-1-2-动态模块"><a href="#5-1-2-动态模块" class="headerlink" title="5.1.2 动态模块"></a>5.1.2 动态模块</h3><p>参考文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://tengine.taobao.org/document_cn/dso_cn.html<br></code></pre></td></tr></table></figure>

<p>这个模块主要是用来运行时动态加载模块，而不用每次都要重新编译Tengine.</p>
<p>如果你想要编译官方模块为动态模块，你需要在configure的时候加上类似这样的指令(–with-http_xxx_module),./configure –help可以看到更多的细节.</p>
<p>如果只想要安装官方模块为动态模块(不安装Nginx)，那么就只需要configure之后，执行 make dso_install命令.</p>
<p>动态加载模块的个数限制为128个.</p>
<p>如果已经加载的动态模块有修改，那么必须重起Tengine才会生效.</p>
<p>只支持HTTP模块.</p>
<p>模块 在Linux/FreeBSD/MacOS下测试成功.</p>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><span class="hljs-section">dso</span> &#123;<br>      <span class="hljs-attribute">load</span> ngx_http_lua_module.so;<br>      <span class="hljs-attribute">load</span> ngx_http_memcached_module.so;<br>&#125;<br><span class="hljs-section">events</span> &#123;<br>      <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="5-1-2-1-编译安装-tengine-2-1-2"><a href="#5-1-2-1-编译安装-tengine-2-1-2" class="headerlink" title="5.1.2.1 编译安装 tengine-2.1.2"></a>5.1.2.1 编译安装 tengine-2.1.2</h4><p>注意: 不支持CentOS8，ubuntu1804，稳定版只支持2015年12月21日之前发布的系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#前期准备，安装相应的软件</span><br><span class="hljs-comment">#centos</span><br><span class="hljs-comment"># yum -y install gcc pcre-devel openssl-devel </span><br><span class="hljs-comment">#ubuntu</span><br><span class="hljs-comment"># apt-get install -y iproute2 ntpdate tcpdump telnet traceroute nfs-kernel-server nfs-common lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev ntpdate tcpdump telnet traceroute gcc openssh-server lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev ntpdate tcpdump telnet traceroute iotop unzip zip </span><br><br><span class="hljs-comment">#创建nginx用户</span><br><span class="hljs-comment">#useradd -r nginx</span><br><br><span class="hljs-comment">#编译tengine</span><br><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># wget http://tengine.taobao.org/download/tengine-2.1.2.tar.gz</span><br><span class="hljs-comment"># tar xf tengine-2.1.2.tar.gz</span><br><span class="hljs-comment"># cd tengine-2.1.2/</span><br><span class="hljs-comment"># ./configure --prefix=/apps/tengine-2.1.2 --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre</span><br><span class="hljs-comment"># make &amp;&amp; make install</span><br><br><span class="hljs-comment">#查看tengine文件目录</span><br>tree /apps/tengine-2.1.2/<br>/apps/tengine-2.1.2/<br>├── conf<br>│  ├── browsers<br>│  ├── fastcgi.conf<br>│  ├── fastcgi.conf.default<br>│  ├── fastcgi_params<br>│  ├── fastcgi_params.default<br>│  ├── koi-utf<br>│  ├── koi-win<br>│  ├── mime.types<br>│  ├── mime.types.default<br>│  ├── module_stubs<br>│  ├── nginx.conf<br>│  ├── nginx.conf.default<br>│  ├── scgi_params<br>│  ├── scgi_params.default<br>│  ├── uwsgi_params<br>│  ├── uwsgi_params.default<br>│  └── win-utf<br>├── html<br>│  ├── 50x.html<br>│  └── index.html<br>├── include<br>│  ├── nginx.h<br>│  ├── ngx_alloc.h<br>│  ├── ngx_array.h<br>│  ├── ngx_atomic.h<br>│  ├── ngx_auto_config.h<br>│  ├── ngx_auto_headers.h<br>│  ├── ngx_buf.h<br>│  ├── ngx_channel.h<br>│  ├── ngx_conf_file.h<br>│  ├── ngx_config.h<br>│  ├── ngx_connection.h<br>│  ├── ngx_core.h<br>│  ├── ngx_crc32.h<br>│  ├── ngx_crc.h<br>│  ├── ngx_crypt.h<br>│  ├── ngx_cycle.h<br>│  ├── ngx_errno.h<br>│  ├── ngx_event_busy_lock.h<br>│  ├── ngx_event_connect.h<br>│  ├── ngx_event.h<br>│  ├── ngx_event_openssl.h<br>│  ├── ngx_event_pipe.h<br>│  ├── ngx_event_posted.h<br>│  ├── ngx_event_timer.h<br>│  ├── ngx_file.h<br>│  ├── ngx_files.h<br>│  ├── ngx_gcc_atomic_x86.h<br>│  ├── ngx_hash.h<br>│  ├── ngx_http_busy_lock.h<br>│  ├── ngx_http_cache.h<br>│  ├── ngx_http_config.h<br>│  ├── ngx_http_core_module.h<br>│  ├── ngx_http.h<br>│  ├── ngx_http_reqstat.h<br>│  ├── ngx_http_request.h<br>│  ├── ngx_http_script.h<br>│  ├── ngx_http_ssi_filter_module.h<br>│  ├── ngx_http_ssl_module.h<br>│  ├── ngx_http_upstream.h<br>│  ├── ngx_http_upstream_round_robin.h<br>│  ├── ngx_http_v2.h<br>│  ├── ngx_http_v2_module.h<br>│  ├── ngx_http_variables.h<br>│  ├── ngx_inet.h<br>│  ├── ngx_linux_config.h<br>│  ├── ngx_linux.h<br>│  ├── ngx_list.h<br>│  ├── ngx_log.h<br>│  ├── ngx_md5.h<br>│  ├── ngx_murmurhash.h<br>│  ├── ngx_open_file_cache.h<br>│  ├── ngx_os.h<br>│  ├── ngx_palloc.h<br>│  ├── ngx_parse.h<br>│  ├── ngx_pipe.h<br>│  ├── ngx_process_cycle.h<br>│  ├── ngx_process.h<br>│  ├── ngx_proc.h<br>│  ├── ngx_proxy_protocol.h<br>│  ├── ngx_queue.h<br>│  ├── ngx_radix_tree.h<br>│  ├── ngx_rbtree.h<br>│  ├── ngx_regex.h<br>│  ├── ngx_resolver.h<br>│  ├── ngx_segment_tree.h<br>│  ├── ngx_setaffinity.h<br>│  ├── ngx_setproctitle.h<br>│  ├── ngx_sha1.h<br>│  ├── ngx_shmem.h<br>│  ├── ngx_shmtx.h<br>│  ├── ngx_slab.h<br>│  ├── ngx_socket.h<br>│  ├── ngx_string.h<br>│  ├── ngx_sysinfo.h<br>│  ├── ngx_syslog.h<br>│  ├── ngx_thread.h<br>│  ├── ngx_time.h<br>│  ├── ngx_times.h<br>│  ├── ngx_trie.h<br>│  └── ngx_user.h<br>├── logs<br>├── modules<br>└── sbin<br> ├── dso_tool<br> └── nginx<br>6 directories, 101 files<br><br><span class="hljs-comment">#建立tengine软连接</span><br><span class="hljs-comment"># ln -s /apps/tengine-2.1.2/sbin/* /usr/sbin/</span><br><br><span class="hljs-comment">#查看tengine版本</span><br><span class="hljs-comment"># nginx -v</span><br>Tengine version: Tengine/2.1.2 (nginx/1.6.2)<br><br><span class="hljs-comment">#开启tengine</span><br><span class="hljs-comment"># nginx</span><br><br><span class="hljs-comment">#查看端口号</span><br><span class="hljs-comment"># ss -tnl</span><br>State   Recv-Q Send-Q  Local Address:Port Peer Address:Port       <br>LISTEN   0    128         *:80        *:*         <br>LISTEN   0    128         *:22        *:*         <br>LISTEN   0    100      127.0.0.1:25        *:*         <br>LISTEN   0    128        [::]:22      [::]:*         <br>LISTEN   0    100       [::1]:25      [::]:* <br><br><span class="hljs-comment">#测试tengine</span><br><span class="hljs-comment"># curl 10.0.0.101</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;Welcome to tengine!&lt;/title&gt;<br>&lt;style&gt;<br>    body &#123;<br>        width: 35em;<br>        margin: 0 auto;<br>        font-family: Tahoma, Verdana, Arial, sans-serif;<br>    &#125;<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to tengine!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the tengine web server is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">&quot;http://tengine.taobao.org/&quot;</span>&gt;tengine.taobao.org&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using tengine.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br><span class="hljs-comment"># curl -I 10.0.0.101</span><br>HTTP/1.1 200 OK<br>Server: Tengine/2.1.2<br>Date: Wed, 24 Feb 2021 14:22:31 GMT<br>Content-Type: text/html<br>Content-Length: 555<br>Last-Modified: Wed, 24 Feb 2021 14:17:12 GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">&quot;60365fe8-22b&quot;</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></table></figure>

<h4 id="5-1-2-2-在tengine-2-1-2中添加-lua-动态模块"><a href="#5-1-2-2-在tengine-2-1-2中添加-lua-动态模块" class="headerlink" title="5.1.2.2 在tengine-2.1.2中添加 lua 动态模块"></a>5.1.2.2 在tengine-2.1.2中添加 lua 动态模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#基于上一小节继续以下操作</span><br><span class="hljs-comment">#安装lua模块</span><br><span class="hljs-comment"># yum -y install lua-devel</span><br><span class="hljs-comment"># cd /usr/local/src/tengine-2.1.2</span><br><br><span class="hljs-comment">#查看帮助</span><br><span class="hljs-comment"># ./configure --help |grep http_lua</span><br> --with-http_lua_module             <span class="hljs-built_in">enable</span> ngx_http_lua_module (will also <span class="hljs-built_in">enable</span> --with-md5 and --with-sha1)<br>  --with-http_lua_module=shared      <span class="hljs-built_in">enable</span> ngx_http_lua_module (shared) (will also <span class="hljs-built_in">enable</span> --with-md5 and --with-sha1)<br><br><span class="hljs-comment">#重新编译</span><br><span class="hljs-comment"># ./configure --prefix=/apps/tengine-2.1.2 --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-http_lua_module=shared</span><br><br><span class="hljs-comment"># make dso_install</span><br><br><span class="hljs-comment">#查看重新编译的的文件</span><br><span class="hljs-comment"># tree /apps/tengine-2.1.2/modules/</span><br>/apps/tengine-2.1.2/modules/<br>└── ngx_http_lua_module.so<br><br>0 directories, 1 file<br><br><span class="hljs-comment">#修改配置文件，是tnegine能加载lua模块</span><br><span class="hljs-comment"># vim /apps/tengine-2.1.2/conf/nginx.conf</span><br>......<br>events &#123;<br> worker_connections  1024;<br>&#125;<br><span class="hljs-comment"># load modules compiled as Dynamic Shared Object (DSO)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#dso &#123;</span><br><span class="hljs-comment">#  load ngx_http_fastcgi_module.so;</span><br><span class="hljs-comment">#  load ngx_http_rewrite_module.so;</span><br><span class="hljs-comment">#&#125;</span><br>dso &#123;              <br>     load ngx_http_lua_module.so;<br>&#125;<br><br>http &#123;<br>......<br>&#125;<br><br><span class="hljs-comment"># nginx -t</span><br>the configuration file /apps/tengine-2.1.2/conf/nginx.conf syntax is ok<br>configuration file /apps/tengine-2.1.2/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br><br><span class="hljs-comment"># nginx -V |&amp; grep share</span><br> ngx_http_lua_module (shared, 3.1)<br></code></pre></td></tr></table></figure>

<h4 id="5-1-2-3-编译安装-tengine-2-3-2"><a href="#5-1-2-3-编译安装-tengine-2-3-2" class="headerlink" title="5.1.2.3 编译安装 tengine-2.3.2"></a>5.1.2.3 编译安装 tengine-2.3.2</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装相应的编译工具</span><br><span class="hljs-comment"># yum -y install gcc pcre-devel openssl-devel #centos</span><br><br><span class="hljs-comment">#申请账号</span><br><span class="hljs-comment"># useradd -r -s /sbin/nologin nginx     #centos</span><br><span class="hljs-comment"># useradd -m -r -s /sbin/nologin nginx  #ubuntu</span><br><br><span class="hljs-comment">#编译tengine</span><br><span class="hljs-comment"># cd /usr/local/src</span><br><span class="hljs-comment"># wget http://tengine.taobao.org/download/tengine-2.3.2.tar.gz</span><br><span class="hljs-comment"># tar xvf tengine-2.3.2.tar.gz</span><br><span class="hljs-comment"># cd tengine-2.3.2/</span><br><span class="hljs-comment"># ./configure --prefix=/apps/tengine-2.3.2 --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br><span class="hljs-comment"># make &amp;&amp; make install</span><br><br><span class="hljs-comment">#查看tengine文件</span><br><span class="hljs-comment"># tree /apps/tengine-2.3.2/</span><br>/apps/tengine-2.3.2/<br>├── conf<br>│  ├── fastcgi.conf<br>│  ├── fastcgi.conf.default<br>│  ├── fastcgi_params<br>│  ├── fastcgi_params.default<br>│  ├── koi-utf<br>│  ├── koi-win<br>│  ├── mime.types<br>│  ├── mime.types.default<br>│  ├── nginx.conf<br>│  ├── nginx.conf.default<br>│  ├── scgi_params<br>│  ├── scgi_params.default<br>│  ├── uwsgi_params<br>│  ├── uwsgi_params.default<br>│  └── win-utf<br>├── html<br>│  ├── 50x.html<br>│  └── index.html<br>├── logs<br>└── sbin<br> └── nginx<br>4 directories, 18 files<br><br><span class="hljs-comment">#创建软连接，方便启动</span><br><span class="hljs-comment"># ln -s /apps/tengine-2.3.2/sbin/* /usr/sbin/</span><br><br><span class="hljs-comment">#查看tengine版本</span><br><span class="hljs-comment"># nginx -v</span><br>Tengine version: Tengine/2.3.2<br>nginx version: nginx/1.17.3<br><br><span class="hljs-comment">#开启tengine</span><br><span class="hljs-comment"># nginx</span><br><br><span class="hljs-comment">#查看端口</span><br><span class="hljs-comment"># ss -ntl</span><br>State         Recv-Q         Send-Q                  Local Address:Port                    Peer Address:Port         <br>LISTEN        0              128                           0.0.0.0:111                          0.0.0.0:*            <br>LISTEN        0              511                           0.0.0.0:80                           0.0.0.0:*            <br>LISTEN        0              128                     127.0.0.53%lo:53                           0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:22                           0.0.0.0:*            <br>LISTEN        0              64                            0.0.0.0:30808                        0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:48728                        0.0.0.0:*            <br>LISTEN        0              64                            0.0.0.0:2049                         0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:26632                        0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:14856                        0.0.0.0:*            <br>LISTEN        0              128                              [::]:45614                           [::]:*            <br>LISTEN        0              128                              [::]:111                             [::]:*            <br>LISTEN        0              128                              [::]:22                              [::]:*            <br>LISTEN        0              128                              [::]:58138                           [::]:*            <br>LISTEN        0              64                               [::]:2049                            [::]:*            <br>LISTEN        0              64                               [::]:21962                           [::]:*            <br>LISTEN        0              128                              [::]:19500                           [::]:*    <br><br><span class="hljs-comment"># curl 10.0.0.104</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;Welcome to tengine!&lt;/title&gt;<br>&lt;style&gt;<br>    body &#123;<br>        width: 35em;<br>        margin: 0 auto;<br>        font-family: Tahoma, Verdana, Arial, sans-serif;<br>    &#125;<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to tengine!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the tengine web server is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">&quot;http://tengine.taobao.org/&quot;</span>&gt;tengine.taobao.org&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using tengine.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<h3 id="5-1-3-concat-模块使用"><a href="#5-1-3-concat-模块使用" class="headerlink" title="5.1.3 concat 模块使用"></a>5.1.3 concat 模块使用</h3><h4 id="5-1-3-1-concat模块说明"><a href="#5-1-3-1-concat模块说明" class="headerlink" title="5.1.3.1 concat模块说明"></a>5.1.3.1 concat模块说明</h4><p>网站中的css、js等文件都是小文件，单个文件大小几k甚至几十个字节，所以文件的特点是小而多，会造成网站加载时http请求较多，且网络传输时间比较短，甚至有时候请求时间比传输时间还长，当公司网站中的这类小文件很多时，大量的http请求就会造成传输效率低，影响网站的访问速度和客户端体验，这时合并http请求就非常有必要了，concat模块就提供了合并文件http请求的功能，这个模块由淘宝开发，功能和apache的mod_concat模块类似</p>
<p>模块说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://tengine.taobao.org/document_cn/http_concat_cn.html<br></code></pre></td></tr></table></figure>

<p>访问方式</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">请求参数需要用两个问号（<span class="hljs-string">&#x27;??&#x27;</span>）例如：<br>http:<span class="hljs-regexp">//</span>example.com<span class="hljs-regexp">/??style1.css,style2.css,foo/</span>style3.css<br><br>参数中某位置只包含一个‘?’，则<span class="hljs-string">&#x27;?&#x27;</span>后表示文件的版本，例如：<br>http:<span class="hljs-regexp">//</span>example.com<span class="hljs-regexp">/??style1.css,style2.css,foo/</span>style3.css?v=<span class="hljs-number">102234</span><br></code></pre></td></tr></table></figure>

<h4 id="5-1-3-2-编译安装-concat-模块"><a href="#5-1-3-2-编译安装-concat-模块" class="headerlink" title="5.1.3.2 编译安装 concat 模块"></a>5.1.3.2 编译安装 concat 模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#基于上一小节继续以下操作</span><br><span class="hljs-comment"># cd /usr/local/src/tengine-2.1.2</span><br><br><span class="hljs-comment">#tengine-2.1.2有此模块</span><br><span class="hljs-comment"># ./configure --help |grep http_concat</span><br> --with-http_concat_module     <span class="hljs-built_in">enable</span> ngx_http_concat_module<br> --with-http_concat_module=shared  <span class="hljs-built_in">enable</span> ngx_http_concat_module (shared)<br> <br><span class="hljs-comment">#tengine-2.3.2无此模块</span><br><span class="hljs-comment"># ./configure --help |grep http_concat</span><br> <br><span class="hljs-comment"># ./configure --prefix=/apps/tengine-2.1.2 --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-http_lua_module=shared --with-http_concat_module=shared</span><br><br><span class="hljs-comment"># make dso_install</span><br> <br><span class="hljs-comment"># tree /apps/tengine-2.1.2/modules/</span><br>/apps/tengine-2.1.2/modules/<br>├── ngx_http_concat_module.so<br>└── ngx_http_lua_module.so<br><br>0 directories, 2 files<br><br><span class="hljs-comment">#通过动态模块实现concat功能：</span><br><span class="hljs-comment"># vim /apps/tengine-2.1.2/conf/nginx.conf</span><br>dso &#123;<br> load ngx_http_lua_module.so;<br> load ngx_http_concat_module.so;<br>&#125;<br><br><span class="hljs-comment"># nginx -t</span><br>the configuration file /apps/tengine-2.1.2/conf/nginx.conf syntax is ok<br>configuration file /apps/tengine-2.1.2/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br><br><span class="hljs-comment"># nginx -s reload</span><br><br><span class="hljs-comment"># nginx -V 2&gt;&amp;1| grep share</span><br> ngx_http_concat_module (shared, 3.1)<br> ngx_http_lua_module (shared, 3.1)<br> <br> <span class="hljs-comment">#通过重新编译tengine实现concat功能：</span><br><span class="hljs-comment"># ./configure ... --with-http_concat_module</span><br></code></pre></td></tr></table></figure>

<h3 id="5-1-4-tengine配置文件"><a href="#5-1-4-tengine配置文件" class="headerlink" title="5.1.4 tengine配置文件"></a>5.1.4 tengine配置文件</h3><p>tengine兼容Nginx指定版本的配置参数</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /apps/tenginx/conf/conf.d/pc.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpe.net <span class="hljs-regexp">*.www.rlinpe.net</span> pc.rlinpc.net;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">concat</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">root</span> html;<br>        <span class="hljs-attribute">index</span> index.html index.htm;<br>    &#125;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/php;<br>        <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">10.0.0.18:9000</span>;<br>        <span class="hljs-attribute">fastcgi_index</span> index.php;<br>        <span class="hljs-comment">#fastcgi_param SCRIPT_FILENAME /data/nginx/php$fastcgi_script_name;</span><br>        <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME $document_root$fastcgi_script_name;<br>        <span class="hljs-attribute">include</span> fastcgi_params;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="5-2-openresty"><a href="#5-2-openresty" class="headerlink" title="5.2 openresty"></a>5.2 openresty</h2><h3 id="5-2-1-openresty-介绍"><a href="#5-2-1-openresty-介绍" class="headerlink" title="5.2.1 openresty 介绍"></a>5.2.1 openresty 介绍</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-openresty.jpg" srcset="/blog/img/loading.gif"></p>
<p>Nginx 是俄罗斯人发明的， Lua 是巴西几个教授发明的，中国人章亦春把 LuaJIT VM 嵌入到 Nginx中，实现了 OpenResty 这个高性能服务端解决方案</p>
<p>OpenResty® 是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web服务和动态网关。</p>
<p>OpenResty® 通过汇聚各种设计精良的 Nginx 模块（主要由 OpenResty 团队自主开发），从而将Nginx 有效地变成一个强大的通用 Web 应用平台。这样 Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 10K 乃至 1000K 以上单机并发连接的高性能 Web 应用系统。</p>
<p>OpenResty® 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及Redis 等都进行一致的高性能响应。</p>
<p>官网: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://openresty.org/cn/<br></code></pre></td></tr></table></figure>

<h4 id="5-2-2-编译安装-openresty"><a href="#5-2-2-编译安装-openresty" class="headerlink" title="5.2.2 编译安装 openresty"></a>5.2.2 编译安装 openresty</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装必要的编译软件</span><br><span class="hljs-comment"># yum install -y gcc pcre-devel openssl-devel make #centos</span><br><br><span class="hljs-comment">#创建用户并下载文件</span><br><span class="hljs-comment"># useradd -r -s /sbin/nologin nginx #centos</span><br><span class="hljs-comment"># useradd  -m -r -s /sbin/nologin nginx #ubuntu</span><br><br><span class="hljs-comment">#下载源码</span><br><span class="hljs-comment">#cd /usr/local/src</span><br><span class="hljs-comment"># wget https://openresty.org/download/openresty-1.17.8.2.tar.gz</span><br><span class="hljs-comment"># tar xf openresty-1.17.8.2.tar.gz</span><br><span class="hljs-comment"># cd openresty-1.17.8.2/</span><br><br><span class="hljs-comment">#编译安装</span><br><span class="hljs-comment"># ./configure --prefix=/apps/openresty --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br><span class="hljs-comment"># make &amp;&amp; make install</span><br><br><span class="hljs-comment">#查看安装之后的文件</span><br><span class="hljs-comment"># tree /apps/openresty/</span><br>./apps/openresty/<br>├── bin<br>│  ├── md2pod.pl<br>│  ├── nginx-xml2pod<br>│  ├── openresty -&gt; /apps/openresty/nginx/sbin/nginx<br>│  ├── opm<br>│  ├── resty<br>│  ├── restydoc<br>│  └── restydoc-index<br>├── COPYRIGHT<br>├── luajit<br>│  ├── bin<br>│  │  ├── luajit -&gt; luajit-2.1.0-beta3<br>│  │  └── luajit-2.1.0-beta3<br>│  ├── include<br>│  │  └── luajit-2.1<br>│  │    ├── lauxlib.h<br>│  │    ├── luaconf.h<br>│  │    ├── lua.h<br>│  │    ├── lua.hpp<br>│  │    ├── luajit.h<br>│  │    └── lualib.h<br>│  ├── lib<br>│  │  ├── libluajit-5.1.a<br>│  │  ├── libluajit-5.1.so -&gt; libluajit-5.1.so.2.1.0<br>│  │  ├── libluajit-5.1.so.2 -&gt; libluajit-5.1.so.2.1.0<br>│  │  ├── libluajit-5.1.so.2.1.0<br>│  │  ├── lua<br>│  │  │  └── 5.1<br>│  │  └── pkgconfig<br>│  │    └── luajit.pc<br>│  └── share<br>│    ├── lua<br>│    │  └── 5.1<br>│    ├── luajit-2.1.0-beta3<br>│    │  └── jit<br>│    │    ├── bc.lua<br>│    │    ├── bcsave.lua<br>│    │    ├── dis_arm64be.lua<br>│    │    ├── dis_arm64.lua<br>│    │    ├── dis_arm.lua<br>│    │    ├── dis_mips64el.lua<br>│    │    ├── dis_mips64.lua<br>│    │    ├── dis_mipsel.lua<br>│    │    ├── dis_mips.lua<br>│    │    ├── dis_ppc.lua<br>│    │    ├── dis_x64.lua<br>│    │    ├── dis_x86.lua<br>│    │    ├── dump.lua<br>│    │    ├── p.lua<br>│    │    ├── v.lua<br>│    │    ├── vmdef.lua<br>│    │    └── zone.lua<br>│    └── man<br>│      └── man1<br>│        └── luajit.1<br>├── lualib<br>│  ├── cjson.so<br>│  ├── librestysignal.so<br>│  ├── ngx<br>│  │  ├── balancer.lua<br>│  │  ├── base64.lua<br>│  │  ├── errlog.lua<br>│  │  ├── ocsp.lua<br>│  │  ├── pipe.lua<br>│  │  ├── process.lua<br>│  │  ├── re.lua<br>│  │  ├── req.lua<br>│  │  ├── resp.lua<br>│  │  ├── semaphore.lua<br>│  │  ├── ssl<br>│  │  │  └── session.lua<br>│  │  └── ssl.lua<br>│  ├── rds<br>│  │  └── parser.so<br>│  ├── redis<br>│  │  └── parser.so<br>│  ├── resty<br>│  │  ├── aes.lua<br>│  │  ├── core<br>│  │  │  ├── base64.lua<br>│  │  │  ├── base.lua<br>│  │  │  ├── ctx.lua<br>│  │  │  ├── exit.lua<br>│  │  │  ├── hash.lua<br>│  │  │  ├── misc.lua<br>│  │  │  ├── ndk.lua<br>│  │  │  ├── phase.lua<br>│  │  │  ├── regex.lua<br>│  │  │  ├── request.lua<br>│  │  │  ├── response.lua<br>│  │  │  ├── shdict.lua<br>│  │  │  ├── time.lua<br>│  │  │  ├── uri.lua<br>│  │  │  ├── utils.lua<br>│  │  │  ├── var.lua<br>│  │  │  └── worker.lua<br>│  │  ├── core.lua<br>│  │  ├── dns<br>│  │  │  └── resolver.lua<br>│  │  ├── <span class="hljs-built_in">limit</span><br>│  │  │  ├── conn.lua<br>│  │  │  ├── count.lua<br>│  │  │  ├── req.lua<br>│  │  │  └── traffic.lua<br>│  │  ├── lock.lua<br>│  │  ├── lrucache<br>│  │  │  └── pureffi.lua<br>│  │  ├── lrucache.lua<br>│  │  ├── md5.lua<br>│  │  ├── memcached.lua<br>│  │  ├── mysql.lua<br>│  │  ├── random.lua<br>│  │  ├── redis.lua<br>│  │  ├── sha1.lua<br>│  │  ├── sha224.lua<br>│  │  ├── sha256.lua<br>│  │  ├── sha384.lua<br>│  │  ├── sha512.lua<br>│  │  ├── sha.lua<br>│  │  ├── shell.lua<br>│  │  ├── signal.lua<br>│  │  ├── string.lua<br>│  │  ├── upload.lua<br>│  │  ├── upstream<br>│  │  │  └── healthcheck.lua<br>│  │  └── websocket<br>│  │    ├── client.lua<br>│  │    ├── protocol.lua<br>│  │    └── server.lua<br>│  └── tablepool.lua<br>├── nginx<br>│  ├── conf<br>│  │  ├── fastcgi.conf<br>│  │  ├── fastcgi.conf.default<br>│  │  ├── fastcgi_params<br>│  │  ├── fastcgi_params.default<br>│  │  ├── koi-utf<br>│  │  ├── koi-win<br>│  │  ├── mime.types<br>│  │  ├── mime.types.default<br>│  │  ├── nginx.conf<br>│  │  ├── nginx.conf.default<br>│  │  ├── scgi_params<br>│  │  ├── scgi_params.default<br>│  │  ├── uwsgi_params<br>│  │  ├── uwsgi_params.default<br>│  │  └── win-utf<br>│  ├── html<br>│  │  ├── 50x.html<br>│  │  └── index.html<br>│  ├── logs<br>│  └── sbin<br>│    └── nginx<br>├── pod<br>│  ├── array-var-nginx-module-0.05<br>│  │  └── array-var-nginx-module-0.05.pod<br>│  ├── drizzle-nginx-module-0.1.11<br>│  │  └── drizzle-nginx-module-0.1.11.pod<br>│  ├── echo-nginx-module-0.62<br>│  │  └── echo-nginx-module-0.62.pod<br>│  ├── encrypted-session-nginx-module-0.08<br>│  │  └── encrypted-session-nginx-module-0.08.pod<br>│  ├── form-input-nginx-module-0.12<br>│  │  └── form-input-nginx-module-0.12.pod<br>│  ├── headers-more-nginx-module-0.33<br>│  │  └── headers-more-nginx-module-0.33.pod<br>│  ├── iconv-nginx-module-0.14<br>│  │  └── iconv-nginx-module-0.14.pod<br>│  ├── lua-5.1.5<br>│  │  └── lua-5.1.5.pod<br>│  ├── lua-cjson-2.1.0.8<br>│  │  └── lua-cjson-2.1.0.8.pod<br>│  ├── luajit-2.1<br>│  │  ├── changes.pod<br>│  │  ├── contact.pod<br>│  │  ├── ext_c_api.pod<br>│  │  ├── extensions.pod<br>│  │  ├── ext_ffi_api.pod<br>│  │  ├── ext_ffi.pod<br>│  │  ├── ext_ffi_semantics.pod<br>│  │  ├── ext_ffi_tutorial.pod<br>│  │  ├── ext_jit.pod<br>│  │  ├── ext_profiler.pod<br>│  │  ├── faq.pod<br>│  │  ├── install.pod<br>│  │  ├── luajit-2.1.pod<br>│  │  ├── running.pod<br>│  │  └── status.pod<br>│  ├── luajit-2.1-20200102<br>│  │  └── luajit-2.1-20200102.pod<br>│  ├── lua-rds-parser-0.06<br>│  ├── lua-redis-parser-0.13<br>│  │  └── lua-redis-parser-0.13.pod<br>│  ├── lua-resty-core-0.1.19<br>│  │  ├── lua-resty-core-0.1.19.pod<br>│  │  ├── ngx.balancer.pod<br>│  │  ├── ngx.base64.pod<br>│  │  ├── ngx.errlog.pod<br>│  │  ├── ngx.ocsp.pod<br>│  │  ├── ngx.pipe.pod<br>│  │  ├── ngx.process.pod<br>│  │  ├── ngx.re.pod<br>│  │  ├── ngx.req.pod<br>│  │  ├── ngx.resp.pod<br>│  │  ├── ngx.semaphore.pod<br>│  │  ├── ngx.ssl.pod<br>│  │  └── ngx.ssl.session.pod<br>│  ├── lua-resty-dns-0.21<br>│  │  └── lua-resty-dns-0.21.pod<br>│  ├── lua-resty-limit-traffic-0.07<br>│  │  ├── lua-resty-limit-traffic-0.07.pod<br>│  │  ├── resty.limit.conn.pod<br>│  │  ├── resty.limit.count.pod<br>│  │  ├── resty.limit.req.pod<br>│  │  └── resty.limit.traffic.pod<br>│  ├── lua-resty-lock-0.08<br>│  │  └── lua-resty-lock-0.08.pod<br>│  ├── lua-resty-lrucache-0.10<br>│  │  └── lua-resty-lrucache-0.10.pod<br>│  ├── lua-resty-memcached-0.15<br>│  │  └── lua-resty-memcached-0.15.pod<br>│  ├── lua-resty-mysql-0.21<br>│  │  └── lua-resty-mysql-0.21.pod<br>│  ├── lua-resty-redis-0.28<br>│  │  └── lua-resty-redis-0.28.pod<br>│  ├── lua-resty-shell-0.03<br>│  │  └── lua-resty-shell-0.03.pod<br>│  ├── lua-resty-signal-0.02<br>│  │  └── lua-resty-signal-0.02.pod<br>│  ├── lua-resty-string-0.12<br>│  │  └── lua-resty-string-0.12.pod<br>│  ├── lua-resty-upload-0.10<br>│  │  └── lua-resty-upload-0.10.pod<br>│  ├── lua-resty-upstream-healthcheck-0.06<br>│  │  └── lua-resty-upstream-healthcheck-0.06.pod<br>│  ├── lua-resty-websocket-0.07<br>│  │  └── lua-resty-websocket-0.07.pod<br>│  ├── lua-tablepool-0.01<br>│  │  └── lua-tablepool-0.01.pod<br>│  ├── memc-nginx-module-0.19<br>│  │  └── memc-nginx-module-0.19.pod<br>│  ├── nginx<br>│  │  ├── accept_failed.pod<br>│  │  ├── beginners_guide.pod<br>│  │  ├── chunked_encoding_from_backend.pod<br>│  │  ├── configure.pod<br>│  │  ├── configuring_https_servers.pod<br>│  │  ├── contributing_changes.pod<br>│  │  ├── control.pod<br>│  │  ├── converting_rewrite_rules.pod<br>│  │  ├── daemon_master_process_off.pod<br>│  │  ├── debugging_log.pod<br>│  │  ├── development_guide.pod<br>│  │  ├── events.pod<br>│  │  ├── example.pod<br>│  │  ├── faq.pod<br>│  │  ├── freebsd_tuning.pod<br>│  │  ├── hash.pod<br>│  │  ├── howto_build_on_win32.pod<br>│  │  ├── install.pod<br>│  │  ├── license_copyright.pod<br>│  │  ├── load_balancing.pod<br>│  │  ├── nginx_dtrace_pid_provider.pod<br>│  │  ├── nginx.pod<br>│  │  ├── ngx_core_module.pod<br>│  │  ├── ngx_google_perftools_module.pod<br>│  │  ├── ngx_http_access_module.pod<br>│  │  ├── ngx_http_addition_module.pod<br>│  │  ├── ngx_http_api_module_head.pod<br>│  │  ├── ngx_http_auth_basic_module.pod<br>│  │  ├── ngx_http_auth_jwt_module.pod<br>│  │  ├── ngx_http_auth_request_module.pod<br>│  │  ├── ngx_http_autoindex_module.pod<br>│  │  ├── ngx_http_browser_module.pod<br>│  │  ├── ngx_http_charset_module.pod<br>│  │  ├── ngx_http_core_module.pod<br>│  │  ├── ngx_http_dav_module.pod<br>│  │  ├── ngx_http_empty_gif_module.pod<br>│  │  ├── ngx_http_f4f_module.pod<br>│  │  ├── ngx_http_fastcgi_module.pod<br>│  │  ├── ngx_http_flv_module.pod<br>│  │  ├── ngx_http_geoip_module.pod<br>│  │  ├── ngx_http_geo_module.pod<br>│  │  ├── ngx_http_grpc_module.pod<br>│  │  ├── ngx_http_gunzip_module.pod<br>│  │  ├── ngx_http_gzip_module.pod<br>│  │  ├── ngx_http_gzip_static_module.pod<br>│  │  ├── ngx_http_headers_module.pod<br>│  │  ├── ngx_http_hls_module.pod<br>│  │  ├── ngx_http_image_filter_module.pod<br>│  │  ├── ngx_http_index_module.pod<br>│  │  ├── ngx_http_js_module.pod<br>│  │  ├── ngx_http_keyval_module.pod<br>│  │  ├── ngx_http_limit_conn_module.pod<br>│  │  ├── ngx_http_limit_req_module.pod<br>│  │  ├── ngx_http_log_module.pod<br>│  │  ├── ngx_http_map_module.pod<br>│  │  ├── ngx_http_memcached_module.pod<br>│  │  ├── ngx_http_mirror_module.pod<br>│  │  ├── ngx_http_mp4_module.pod<br>│  │  ├── ngx_http_perl_module.pod<br>│  │  ├── ngx_http_proxy_module.pod<br>│  │  ├── ngx_http_random_index_module.pod<br>│  │  ├── ngx_http_realip_module.pod<br>│  │  ├── ngx_http_referer_module.pod<br>│  │  ├── ngx_http_rewrite_module.pod<br>│  │  ├── ngx_http_scgi_module.pod<br>│  │  ├── ngx_http_secure_link_module.pod<br>│  │  ├── ngx_http_session_log_module.pod<br>│  │  ├── ngx_http_slice_module.pod<br>│  │  ├── ngx_http_spdy_module.pod<br>│  │  ├── ngx_http_split_clients_module.pod<br>│  │  ├── ngx_http_ssi_module.pod<br>│  │  ├── ngx_http_ssl_module.pod<br>│  │  ├── ngx_http_status_module.pod<br>│  │  ├── ngx_http_stub_status_module.pod<br>│  │  ├── ngx_http_sub_module.pod<br>│  │  ├── ngx_http_upstream_conf_module.pod<br>│  │  ├── ngx_http_upstream_hc_module.pod<br>│  │  ├── ngx_http_upstream_module.pod<br>│  │  ├── ngx_http_userid_module.pod<br>│  │  ├── ngx_http_uwsgi_module.pod<br>│  │  ├── ngx_http_v2_module.pod<br>│  │  ├── ngx_http_xslt_module.pod<br>│  │  ├── ngx_mail_auth_http_module.pod<br>│  │  ├── ngx_mail_core_module.pod<br>│  │  ├── ngx_mail_imap_module.pod<br>│  │  ├── ngx_mail_pop3_module.pod<br>│  │  ├── ngx_mail_proxy_module.pod<br>│  │  ├── ngx_mail_smtp_module.pod<br>│  │  ├── ngx_mail_ssl_module.pod<br>│  │  ├── ngx_stream_access_module.pod<br>│  │  ├── ngx_stream_core_module.pod<br>│  │  ├── ngx_stream_geoip_module.pod<br>│  │  ├── ngx_stream_geo_module.pod<br>│  │  ├── ngx_stream_js_module.pod<br>│  │  ├── ngx_stream_keyval_module.pod<br>│  │  ├── ngx_stream_limit_conn_module.pod<br>│  │  ├── ngx_stream_log_module.pod<br>│  │  ├── ngx_stream_map_module.pod<br>│  │  ├── ngx_stream_proxy_module.pod<br>│  │  ├── ngx_stream_realip_module.pod<br>│  │  ├── ngx_stream_return_module.pod<br>│  │  ├── ngx_stream_split_clients_module.pod<br>│  │  ├── ngx_stream_ssl_module.pod<br>│  │  ├── ngx_stream_ssl_preread_module.pod<br>│  │  ├── ngx_stream_upstream_hc_module.pod<br>│  │  ├── ngx_stream_upstream_module.pod<br>│  │  ├── ngx_stream_zone_sync_module.pod<br>│  │  ├── request_processing.pod<br>│  │  ├── server_names.pod<br>│  │  ├── stream_processing.pod<br>│  │  ├── switches.pod<br>│  │  ├── syntax.pod<br>│  │  ├── sys_errlist.pod<br>│  │  ├── syslog.pod<br>│  │  ├── variables_in_config.pod<br>│  │  ├── websocket.pod<br>│  │  ├── welcome_nginx_facebook.pod<br>│  │  └── windows.pod<br>│  ├── ngx_coolkit-0.2<br>│  ├── ngx_devel_kit-0.3.1<br>│  │  ├── ngx_devel_kit-0.3.1.pod<br>│  │  └── readme_auto_lib.pod<br>│  ├── ngx_lua-0.10.17<br>│  │  └── ngx_lua-0.10.17.pod<br>│  ├── ngx_lua_upstream-0.07<br>│  │  └── ngx_lua_upstream-0.07.pod<br>│  ├── ngx_postgres-1.0<br>│  │  ├── ngx_postgres-1.0.pod<br>│  │  └── todo.pod<br>│  ├── ngx_stream_lua-0.0.8<br>│  │  ├── dev_notes.pod<br>│  │  └── ngx_stream_lua-0.0.8.pod<br>│  ├── opm-0.0.5<br>│  │  └── opm-0.0.5.pod<br>│  ├── rds-csv-nginx-module-0.09<br>│  │  └── rds-csv-nginx-module-0.09.pod<br>│  ├── rds-json-nginx-module-0.15<br>│  │  └── rds-json-nginx-module-0.15.pod<br>│  ├── redis2-nginx-module-0.15<br>│  │  └── redis2-nginx-module-0.15.pod<br>│  ├── redis-nginx-module-0.3.7<br>│  ├── resty-cli-0.25<br>│  │  └── resty-cli-0.25.pod<br>│  ├── set-misc-nginx-module-0.32<br>│  │  └── set-misc-nginx-module-0.32.pod<br>│  ├── srcache-nginx-module-0.32<br>│  │  └── srcache-nginx-module-0.32.pod<br>│  └── xss-nginx-module-0.06<br>│    └── xss-nginx-module-0.06.pod<br>├── resty.index<br>└── site<br> ├── lualib<br> ├── manifest<br> └── pod<br>83 directories, 313 files<br><br><span class="hljs-comment"># ln -s /apps/openresty/bin/* /usr/bin/</span><br><span class="hljs-comment"># openresty -v</span><br><span class="hljs-comment"># nginx version: openresty/1.17.8.2</span><br><br><span class="hljs-comment">#启动openresty</span><br><span class="hljs-comment"># openresty</span><br><br><span class="hljs-comment"># ss -ntl</span><br>State         Recv-Q         Send-Q                  Local Address:Port                    Peer Address:Port         <br>LISTEN        0              128                           0.0.0.0:111                          0.0.0.0:*            <br>LISTEN        0              511                           0.0.0.0:80                           0.0.0.0:*            <br>LISTEN        0              128                     127.0.0.53%lo:53                           0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:22                           0.0.0.0:*            <br>LISTEN        0              64                            0.0.0.0:27932                        0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:46750                        0.0.0.0:*            <br>LISTEN        0              64                            0.0.0.0:2049                         0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:21442                        0.0.0.0:*            <br>LISTEN        0              128                           0.0.0.0:61732                        0.0.0.0:*            <br>LISTEN        0              128                              [::]:111                             [::]:*            <br>LISTEN        0              128                              [::]:22                              [::]:*            <br>LISTEN        0              128                              [::]:17526                           [::]:*            <br>LISTEN        0              64                               [::]:20984                           [::]:*            <br>LISTEN        0              128                              [::]:33184                           [::]:*            <br>LISTEN        0              64                               [::]:2049                            [::]:*            <br>LISTEN        0              128                              [::]:53414                           [::]:* <br><br><span class="hljs-comment"># ps -ef |grep nginx</span><br>root      17739      1  0 21:50 ?        00:00:00 nginx: master process openresty<br>nginx     17740  17739  0 21:50 ?        00:00:00 nginx: worker process<br>root      17747   1592  0 21:51 pts/0    00:00:00 grep --color=auto nginx<br><br><span class="hljs-comment"># curl 10.0.0.105</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;Welcome to OpenResty!&lt;/title&gt;<br>&lt;style&gt;<br>    body &#123;<br>        width: 35em;<br>        margin: 0 auto;<br>        font-family: Tahoma, Verdana, Arial, sans-serif;<br>    &#125;<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to OpenResty!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the OpenResty web platform is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">&quot;https://openresty.org/&quot;</span>&gt;openresty.org&lt;/a&gt;.&lt;br/&gt;<br>Commercial support is available at<br>&lt;a href=<span class="hljs-string">&quot;https://openresty.com/&quot;</span>&gt;openresty.com&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> flying OpenResty.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-openresty2.jpg" srcset="/blog/img/loading.gif"></p>
<h1 id="六、系统参数优化"><a href="#六、系统参数优化" class="headerlink" title="六、系统参数优化"></a>六、系统参数优化</h1><p>默认的Linux内核参数考虑的是最通用场景，不符合用于支持高并发访问的Web服务器的定义，根据业务特点来进行调整，当Nginx作为静态web内容服务器、反向代理或者提供压缩服务器的服务器时，内核参数的调整都是不同的，此处针对最通用的、使Nginx支持更多并发请求的TCP网络参数做简单的配置</p>
<h2 id="6-1优化内核参数"><a href="#6-1优化内核参数" class="headerlink" title="6.1优化内核参数"></a>6.1优化内核参数</h2><p>修改/etc/sysctl.conf </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#centos优化</span><br>fs.file-max = 1000000<br><span class="hljs-comment">#表示单个进程较大可以打开的句柄数</span><br><br>net.ipv4.tcp_tw_reuse = 1<br><span class="hljs-comment">#参数设置为 1 ，表示允许将TIME_WAIT状态的socket重新用于新的TCP链接，这对于服务器来说意义重大，因为总有大量TIME_WAIT状态的链接存在</span><br><br>net.ipv4.tcp_keepalive_time = 600<br><span class="hljs-comment">#当keepalive启动时，TCP发送keepalive消息的频度;默认是2小时，将其设置为10分钟，可更快的清理无效链接</span><br><br>net.ipv4.tcp_fin_timeout = 30<br><span class="hljs-comment">#当服务器主动关闭链接时，socket保持在FIN_WAIT_2状态的较大时间</span><br><br>net.ipv4.tcp_max_tw_buckets = 5000<br><span class="hljs-comment">#表示操作系统允许TIME_WAIT套接字数量的较大值，如超过此值，TIME_WAIT套接字将立刻被清除并打印警告信息,默认为8000，过多的TIME_WAIT套接字会使Web服务器变慢</span><br><br>net.ipv4.ip_local_port_range = 1024 65000<br><span class="hljs-comment">#定义UDP和TCP链接的本地端口的取值范围</span><br><br>net.ipv4.tcp_rmem = 10240 87380 12582912<br><span class="hljs-comment">#定义了TCP接受缓存的最小值、默认值、较大值</span><br><br>net.ipv4.tcp_wmem = 10240 87380 12582912<br><span class="hljs-comment">#定义TCP发送缓存的最小值、默认值、较大值</span><br><br>net.core.netdev_max_backlog = 8096<br><span class="hljs-comment">#当网卡接收数据包的速度大于内核处理速度时，会有一个列队保存这些数据包。这个参数表示该列队的较大值</span><br><br>net.core.rmem_default = 6291456<br><span class="hljs-comment">#表示内核套接字接受缓存区默认大小</span><br><br>net.core.wmem_default = 6291456<br><span class="hljs-comment">#表示内核套接字发送缓存区默认大小</span><br><br>net.core.rmem_max = 12582912<br><span class="hljs-comment">#表示内核套接字接受缓存区较大大小</span><br><br>net.core.wmem_max = 12582912<br><span class="hljs-comment">#表示内核套接字发送缓存区较大大小</span><br>注意：以上的四个参数，需要根据业务逻辑和实际的硬件成本来综合考虑<br><br>net.ipv4.tcp_syncookies = 1<br><span class="hljs-comment">#与性能无关。用于解决TCP的SYN攻击</span><br><br>net.ipv4.tcp_max_syn_backlog = 8192<br><span class="hljs-comment">#这个参数表示TCP三次握手建立阶段接受SYN请求列队的较大长度，默认1024，将其设置的大一些可使出现Nginx繁忙来不及accept新连接时，Linux不至于丢失客户端发起的链接请求</span><br><br>net.ipv4.tcp_tw_recycle = 1<br><span class="hljs-comment">#这个参数用于设置启用timewait快速回收</span><br><br>net.core.somaxconn=262114<br><span class="hljs-comment">#选项默认值是128，这个参数用于调节系统同时发起的TCP连接数，在高并发的请求中，默认的值可能会导致链接超时或者重传，因此需要结合高并发请求数来调节此值。</span><br><br>net.ipv4.tcp_max_orphans=262114<br><span class="hljs-comment">#选项用于设定系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤立链接将立即被复位并输出警告信息。这个限制指示为了防止简单的DOS攻击，不用过分依靠这个限制甚至认为的减小这个值，更多的情况是增加这个值</span><br><br><span class="hljs-comment">#ubuntu优化</span><br>vim /etc/sysctl.conf<br><span class="hljs-comment"># Controls source route verification</span><br>net.ipv4.conf.default.rp_filter = 1<br>net.ipv4.ip_nonlocal_bind = 1<br>net.ipv4.ip_forward = 1<br><span class="hljs-comment"># Do not accept source routing</span><br>net.ipv4.conf.default.accept_source_route = 0<br><span class="hljs-comment"># Controls the System Request debugging functionality of the kernel</span><br>kernel.sysrq = 0<br><span class="hljs-comment"># Controls whether core dumps will append the PID to the core filename.</span><br><span class="hljs-comment"># Useful for debugging multi-threaded applications.</span><br>kernel.core_uses_pid = 1<br><span class="hljs-comment"># Controls the use of TCP syncookies</span><br>net.ipv4.tcp_syncookies = 1<br><span class="hljs-comment"># Disable netfilter on bridges.</span><br>net.bridge.bridge-nf-call-ip6tables = 0<br>net.bridge.bridge-nf-call-iptables = 0<br>net.bridge.bridge-nf-call-arptables = 0<br><span class="hljs-comment"># Controls the default maxmimum size of a mesage queue</span><br>kernel.msgmnb = 65536<br><span class="hljs-comment"># # Controls the maximum size of a message, in bytes</span><br>kernel.msgmax = 65536<br><span class="hljs-comment"># Controls the maximum shared segment size, in bytes</span><br>kernel.shmmax = 68719476736<br><span class="hljs-comment"># # Controls the maximum number of shared memory segments, in pages</span><br>kernel.shmall = 4294967296<br><span class="hljs-comment"># TCP kernel paramater</span><br>net.ipv4.tcp_mem = 786432 1048576 1572864<br>net.ipv4.tcp_rmem = 4096 87380 4194304<br>net.ipv4.tcp_wmem = 4096 16384 4194304<br>net.ipv4.tcp_window_scaling = 1<br>net.ipv4.tcp_sack = 1<br><span class="hljs-comment"># socket buffer</span><br>net.core.wmem_default = 8388608<br>net.core.rmem_default = 8388608<br>net.core.rmem_max = 16777216<br>net.core.wmem_max = 16777216<br>net.core.netdev_max_backlog = 262144<br>net.core.somaxconn = 20480<br>net.core.optmem_max = 81920<br><span class="hljs-comment"># TCP conn</span><br>net.ipv4.tcp_max_syn_backlog = 262144<br>net.ipv4.tcp_syn_retries = 3<br>net.ipv4.tcp_retries1 = 3<br>net.ipv4.tcp_retries2 = 15<br><span class="hljs-comment"># tcp conn reuse</span><br>net.ipv4.tcp_timestamps = 0<br>net.ipv4.tcp_tw_reuse = 0<br>net.ipv4.tcp_tw_recycle = 0<br>net.ipv4.tcp_fin_timeout = 1<br>net.ipv4.tcp_max_tw_buckets = 20000<br>net.ipv4.tcp_max_orphans = 3276800<br>net.ipv4.tcp_synack_retries = 1<br>net.ipv4.tcp_syncookies = 1<br><span class="hljs-comment"># keepalive conn</span><br>net.ipv4.tcp_keepalive_time = 300<br>net.ipv4.tcp_keepalive_intvl = 30<br>net.ipv4.tcp_keepalive_probes = 3<br>net.ipv4.ip_local_port_range = 10001 65000<br><span class="hljs-comment"># swap</span><br>vm.overcommit_memory = 0<br>vm.swappiness = 10<br><span class="hljs-comment">#net.ipv4.conf.eth1.rp_filter = 0</span><br><span class="hljs-comment">#net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="hljs-comment">#net.ipv4.conf.lo.arp_announce = 2</span><br><span class="hljs-comment">#net.ipv4.conf.all.arp_ignore = 1</span><br><span class="hljs-comment">#net.ipv4.conf.all.arp_announce = 2</span><br><br><span class="hljs-comment"># apt update</span><br></code></pre></td></tr></table></figure>

<h2 id="6-2-PAM-资源限制优化"><a href="#6-2-PAM-资源限制优化" class="headerlink" title="6.2 PAM 资源限制优化"></a>6.2 PAM 资源限制优化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#centos</span><br><span class="hljs-comment"># vim /etc/security/limits.conf</span><br>在/etc/security/limits.conf 最后增加：<br>* soft nofile 65535<br>* hard nofile 65535<br>* soft nproc 65535<br>* hard nproc 65535<br><br><span class="hljs-comment">#ubuntu</span><br><span class="hljs-comment"># vim /etc/security/limits.conf</span><br><span class="hljs-comment">#root账⼾的资源软限制和硬限制</span><br>root soft core unlimited<br>root hard core unlimited<br>root soft nproc 1000000<br>root hard nproc 1000000<br>root soft nofile 1000000<br>root hard nofile 1000000<br>root soft memlock 32000<br>root hard memlock 32000<br>root soft msgqueue 8192000<br>root hard msgqueue 8192000<br><span class="hljs-comment">#其他账⼾的资源软限制和硬限制</span><br>* soft core unlimited<br>* hard core unlimited<br>* soft nproc 1000000<br>* hard nproc 1000000<br>* soft nofile 1000000<br>* hard nofile 1000000<br>* soft memlock 32000<br>* hard memlock 32000<br>* soft msgqueue 8192000<br>* hard msgqueue 8192000<br></code></pre></td></tr></table></figure>



<h1 id="七、项目实战-利用-LNMP-实现WordPress站点搭建"><a href="#七、项目实战-利用-LNMP-实现WordPress站点搭建" class="headerlink" title="七、项目实战 : 利用 LNMP 实现WordPress站点搭建"></a>七、项目实战 : 利用 LNMP 实现WordPress站点搭建</h1><h2 id="7-1环境说明"><a href="#7-1环境说明" class="headerlink" title="7.1环境说明"></a>7.1环境说明</h2><h3 id="7-1-1-部署规划"><a href="#7-1-1-部署规划" class="headerlink" title="7.1.1 部署规划"></a>7.1.1 部署规划</h3><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp1.jpg" srcset="/blog/img/loading.gif"></p>
<table>
<thead>
<tr>
<th>服务器地址</th>
<th>hostname</th>
<th>部署软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.7</td>
<td>web1</td>
<td>Nginx1.20.1 php-fpm7.4 wordpress6.1.1</td>
</tr>
<tr>
<td>10.0.0.17</td>
<td>web2</td>
<td>mysql5.7  redis3.2.12</td>
</tr>
</tbody></table>
<h3 id="7-1-2-软件下载地址"><a href="#7-1-2-软件下载地址" class="headerlink" title="7.1.2 软件下载地址"></a>7.1.2 软件下载地址</h3><p><strong>除了Linux系统，其他软件可以按需求选择版本</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">L：Linux（CentOS7）https://mirrors.aliyun.com/centos/7/isos/x86_64/<br>N：Nginx（1.18.0） https://nginx.org/en/download.html<br>M：MySQL（8.0.19） https://dev.mysql.com/downloads/mysql/ <br>                  https://downloads.mysql.com/archives/community/<br>P：PHP（7.4.10） http://php.net/downloads.php<br>Wordpress（5.4.2）：https://cn.wordpress.org/download/<br></code></pre></td></tr></table></figure>

<h3 id="7-1-3-修改hostname"><a href="#7-1-3-修改hostname" class="headerlink" title="7.1.3 修改hostname"></a>7.1.3 修改hostname</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#10.0.0.7</span><br><span class="hljs-comment"># hostname set-hostname web1</span><br><br><span class="hljs-comment">#10.0.0.17</span><br><span class="hljs-comment"># hostname set-hostname web2</span><br></code></pre></td></tr></table></figure>

<h2 id="7-2-命令式部署"><a href="#7-2-命令式部署" class="headerlink" title="7.2 命令式部署"></a>7.2 命令式部署</h2><h3 id="7-2-1-部署MySQL"><a href="#7-2-1-部署MySQL" class="headerlink" title="7.2.1 部署MySQL"></a>7.2.1 部署MySQL</h3><h4 id="7-2-1-1-安装MySQL"><a href="#7-2-1-1-安装MySQL" class="headerlink" title="7.2.1.1 安装MySQL"></a>7.2.1.1 安装MySQL</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#下载MySQL的repo文件</span><br><span class="hljs-comment"># yum install -y https://dev.mysql.com/get/mysql80-community-release-el7-7.noarch.rpm</span><br><br><span class="hljs-comment">#修改repo文件</span><br><span class="hljs-comment"># vim /etc/yum.repos.d/mysql-community.repo </span><br><span class="hljs-comment"># Enable to use MySQL 5.7</span><br>[mysql57-community]<br>name=MySQL 5.7 Community Server<br>baseurl=http://repo.mysql.com/yum/mysql-5.7-community/el/7/<span class="hljs-variable">$basearch</span><br>enabled=1 <span class="hljs-comment">#修改为1</span><br>gpgcheck=1<br>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql-2022<br>       file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql<br><br>[mysql80-community]<br>name=MySQL 8.0 Community Server<br>baseurl=http://repo.mysql.com/yum/mysql-8.0-community/el/7/<span class="hljs-variable">$basearch</span><br>enabled=0 <span class="hljs-comment">#修改为0</span><br>gpgcheck=1<br>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql-2022<br>       file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql<br>......<br>       <br><span class="hljs-comment">#安装MySQL</span><br><span class="hljs-comment"># yum install -y mysql-community-server</span><br><span class="hljs-comment"># systemctl enable --now mysqld</span><br><span class="hljs-comment"># 数据库添加管理员密码</span><br><span class="hljs-comment"># mysqladmin -uroot -p&quot;`sed -En &#x27;/temporary password/s/.*: (.*)/\1/p&#x27; /var/log/mysqld.log`&quot; password &quot;Admin123456@&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-1-2-添加wordpress数据库"><a href="#7-2-1-2-添加wordpress数据库" class="headerlink" title="7.2.1.2 添加wordpress数据库"></a>7.2.1.2 添加wordpress数据库</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mysql -uroot -pAdmin123456@</span><br>mysql&gt; create database wordpress;<br>Query OK, 1 row affected (0.06 sec)<br><br>mysql&gt; create user wordpress@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&#x27;Admin123456@&#x27;</span>;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; grant all on wordpress.* to wordpress@<span class="hljs-string">&#x27;%&#x27;</span>;<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure>

<h3 id="7-2-2-部署nginx"><a href="#7-2-2-部署nginx" class="headerlink" title="7.2.2 部署nginx"></a>7.2.2 部署nginx</h3><h4 id="7-2-2-1-安装nginx"><a href="#7-2-2-1-安装nginx" class="headerlink" title="7.2.2.1 安装nginx"></a>7.2.2.1 安装nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y nginx</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-2-2-修改nginx配置文件"><a href="#7-2-2-2-修改nginx配置文件" class="headerlink" title="7.2.2.2 修改nginx配置文件"></a>7.2.2.2 修改nginx配置文件</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /etc/nginx/conf.d/wordpress.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.org;<br><br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/wordpress;<br>        <span class="hljs-attribute">index</span> index.php index.html index.htm;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/wordpress;<br>        <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">127.0.0.1:9000</span>;<br>        <span class="hljs-attribute">fastcgi_index</span> index.php;<br>        <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME $document_root$fastcgi_script_name;<br>        <span class="hljs-attribute">include</span> fastcgi_params;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(ping|pm_status)$</span> &#123;<br>        <span class="hljs-attribute">include</span> fastcgi_params;<br>        <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">127.0.0.1:9000</span>;<br>        <span class="hljs-attribute">fastcgi_param</span> PATH_TRANSLATED $document_root$fastcgi_script_name;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># nginx -t</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-2-3-创建文件夹"><a href="#7-2-2-3-创建文件夹" class="headerlink" title="7.2.2.3 创建文件夹"></a>7.2.2.3 创建文件夹</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -p /data/nginx/wordpress</span><br></code></pre></td></tr></table></figure>

<h3 id="7-2-3-部署PHP"><a href="#7-2-3-部署PHP" class="headerlink" title="7.2.3 部署PHP"></a>7.2.3 部署PHP</h3><h4 id="7-2-3-1-安装PHP"><a href="#7-2-3-1-安装PHP" class="headerlink" title="7.2.3.1 安装PHP"></a>7.2.3.1 安装PHP</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#下载php的repo文件</span><br><span class="hljs-comment"># yum -y install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm</span><br><span class="hljs-comment"># yum install -y php74-php-fpm php74-php-mysqlnd php74-php-opcache</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-3-2-修改PHP配置文件"><a href="#7-2-3-2-修改PHP配置文件" class="headerlink" title="7.2.3.2 修改PHP配置文件"></a>7.2.3.2 修改PHP配置文件</h4><p><strong>php的其他优化请看lamp博客</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /etc/opt/remi/php74/php-fpm.d/www.conf</span><br>[www]<br>user = nginx<br>group = nginx<br>listen = 127.0.0.1:9000<br>pm = dynamic<br>pm.max_children = 5<br>pm.start_servers = 2<br>pm.min_spare_servers = 1<br>pm.max_spare_servers = 3<br>pm.status_path = /pm_status<br>ping.path = /ping<br>access.log = /var/opt/remi/php74/<span class="hljs-built_in">log</span>/php-fpm/<span class="hljs-variable">$pool</span>.access.log<br>slowlog = <span class="hljs-built_in">log</span>/<span class="hljs-variable">$pool</span>.log.slow<br><br><span class="hljs-comment">#检查php语法</span><br><span class="hljs-comment"># /opt/remi/php74/root/usr/sbin/php-fpm -t</span><br>[17-Nov-2022 13:54:31] NOTICE: configuration file /etc/opt/remi/php74/php-fpm.conf <span class="hljs-built_in">test</span> is successful<br></code></pre></td></tr></table></figure>

<h4 id="7-2-3-3-准备php页面"><a href="#7-2-3-3-准备php页面" class="headerlink" title="7.2.3.3 准备php页面"></a>7.2.3.3 准备php页面</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># mkdir -p /data/nginx/wordpress</span><br><span class="hljs-comment"># vim /data/nginx/wordpress/test.php</span><br>&lt;?php<br>phpinfo();<br>?&gt;<br></code></pre></td></tr></table></figure>

<h4 id="7-2-3-4-启动php和nginx"><a href="#7-2-3-4-启动php和nginx" class="headerlink" title="7.2.3.4 启动php和nginx"></a>7.2.3.4 启动php和nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl enable --now php74-php-fpm nginx</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-3-3-查看php状态"><a href="#7-2-3-3-查看php状态" class="headerlink" title="7.2.3.3 查看php状态"></a>7.2.3.3 查看php状态</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#查看php加载的模块</span><br><span class="hljs-comment"># /opt/remi/php74/root/usr/sbin/php-fpm -m</span><br>[PHP Modules]<br>bz2<br>calendar<br>cgi-fcgi<br>Core<br>ctype<br>curl<br>date<br>exif<br>fileinfo<br>filter<br>ftp<br>gettext<br><span class="hljs-built_in">hash</span><br>iconv<br>json<br>libxml<br>mysqli<br>mysqlnd<br>openssl<br>pcre<br>PDO<br>pdo_mysql<br>pdo_sqlite<br>Phar<br>Reflection<br>session<br>sockets<br>SPL<br>sqlite3<br>standard<br>tokenizer<br>Zend OPcache<br>zlib<br><br>[Zend Modules]<br>Zend OPcache <span class="hljs-comment">#php缓存已经开启</span><br><br><span class="hljs-comment">#查看php-fpm运行状态</span><br><span class="hljs-comment"># curl www.rlilnpc.org/ping</span><br>pong<br><span class="hljs-comment"># curl www.rlinpc.org/pm_status</span><br>pool:                 www<br>process manager:      dynamic<br>start time:           17/Nov/2022:13:31:44 +0800<br>start since:          186<br>accepted conn:        6<br>listen queue:         0<br>max listen queue:     0<br>listen queue len:     128<br>idle processes:       4<br>active processes:     1<br>total processes:      5<br>max active processes: 1<br>max children reached: 0<br>slow requests:        0<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp2.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp3.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp4.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="7-2-4-部署Wordpress"><a href="#7-2-4-部署Wordpress" class="headerlink" title="7.2.4 部署Wordpress"></a>7.2.4 部署Wordpress</h3><h4 id="7-2-4-1-下载源码包并解压到指定路径"><a href="#7-2-4-1-下载源码包并解压到指定路径" class="headerlink" title="7.2.4.1 下载源码包并解压到指定路径"></a>7.2.4.1 下载源码包并解压到指定路径</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y unzip</span><br><span class="hljs-comment"># wget https://cn.wordpress.org/latest-zh_CN.zip</span><br><span class="hljs-comment"># unzip latest-zh_CN.zip</span><br><span class="hljs-comment"># mv wordpress/* /data/nginx/wordpress</span><br><span class="hljs-comment"># chown -R nginx.nginx /data/nginx/wordpress</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-4-2-浏览器访问安装wordpress"><a href="#7-2-4-2-浏览器访问安装wordpress" class="headerlink" title="7.2.4.2 浏览器访问安装wordpress"></a>7.2.4.2 浏览器访问安装wordpress</h4><p>浏览器访问：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">www.rlinpc.org<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp5.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp6.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp7.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp8.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="7-2-4-3-登录后台管理界面并发表文章"><a href="#7-2-4-3-登录后台管理界面并发表文章" class="headerlink" title="7.2.4.3 登录后台管理界面并发表文章"></a>7.2.4.3 登录后台管理界面并发表文章</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp9.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp10.jpg" srcset="/blog/img/loading.gif"></p>
<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp11.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="7-2-4-4-验证发表的文章"><a href="#7-2-4-4-验证发表的文章" class="headerlink" title="7.2.4.4 验证发表的文章"></a>7.2.4.4 验证发表的文章</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp12.jpg" srcset="/blog/img/loading.gif"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">tree /data/nginx/wordpress/wp-content/uploads/<br>/data/nginx/wordpress/wp-content/uploads/<br>└── 2021<br>    └── 02<br>        └── 20151221-03131.jpg<br><br>2 directories, 1 file<br></code></pre></td></tr></table></figure>

<h4 id="7-2-4-5-配置允许上传大文件"><a href="#7-2-4-5-配置允许上传大文件" class="headerlink" title="7.2.4.5 配置允许上传大文件"></a>7.2.4.5 配置允许上传大文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#注意:默认只支持1M以下文件上传,要上传大图片,需要修改下面三项配置,最大上传由三项值的最小值决定</span><br><span class="hljs-comment">#直接上传大于1M文件,会出现下面413错误</span><br><span class="hljs-comment"># tail -f /var/log/nginx/access.log</span><br><br><span class="hljs-comment"># vim /etc/nginx/conf.d/wordpress.conf</span><br>server &#123;<br>   client_max_body_size 10m; <span class="hljs-comment">#默认值为1M</span><br>.....<br>&#125;<br><br><span class="hljs-comment">#检查nginx配置文件是否有错误</span><br><span class="hljs-comment"># nginx -t</span><br><br><span class="hljs-comment"># vim /etc/opt/remi/php74/php.ini</span><br>post_max_size = 30M  <span class="hljs-comment">#默认值为8M</span><br>upload_max_filesize = 20M  <span class="hljs-comment">#默认值为2M</span><br><br><span class="hljs-comment">#检查php配置文件是否有错误</span><br><span class="hljs-comment"># /opt/remi/php74/root/usr/sbin/php-fpm -t</span><br>[27-Feb-2021 16:48:02] NOTICE: configuration file /apps/php74/etc/php-fpm.conf <span class="hljs-built_in">test</span> is successful<br><br><span class="hljs-comment"># systemctl restart nginx php-fpm</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-4-5-安全加固"><a href="#7-2-4-5-安全加固" class="headerlink" title="7.2.4.5 安全加固"></a>7.2.4.5 安全加固</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp13.jpg" srcset="/blog/img/loading.gif"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># vim /etc/nginx/nginx.conf</span><br><span class="hljs-section">http</span> &#123;<br>    ......;<br>    <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>; <span class="hljs-comment">#添加此行</span><br>&#125;<br><br><span class="hljs-comment"># vim /etc/nginx/conf.d/wordpress.conf</span><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.rlinpc.org;<br><br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/wordpress;<br>        <span class="hljs-attribute">index</span> index.php index.html index.htm;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> &#123;<br>        <span class="hljs-attribute">root</span> /data/nginx/wordpress;<br>        <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">127.0.0.1:9000</span>;<br>        <span class="hljs-attribute">fastcgi_index</span> index.php;<br>        <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME $document_root$fastcgi_script_name;<br>        <span class="hljs-attribute">include</span> fastcgi_params;<br>        <span class="hljs-attribute">fastcgi_hide_header</span> X-Powered-By; <span class="hljs-comment">#添加此行</span><br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(ping|pm_status)$</span> &#123;<br>        <span class="hljs-attribute">include</span> fastcgi_params;<br>        <span class="hljs-attribute">fastcgi_pass</span> <span class="hljs-number">127.0.0.1:9000</span>;<br>        <span class="hljs-attribute">fastcgi_param</span> PATH_TRANSLATED $document_root$fastcgi_script_name;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># nginx -t</span><br><span class="hljs-comment"># systemctl reload nginx</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp14.jpg" srcset="/blog/img/loading.gif"></p>
<h3 id="7-2-5-PHP-扩展session模块支持redis"><a href="#7-2-5-PHP-扩展session模块支持redis" class="headerlink" title="7.2.5 PHP 扩展session模块支持redis"></a>7.2.5 PHP 扩展session模块支持redis</h3><p><strong>PHP 扩展session模块支持redis</strong></p>
<p>PECL是 PHP 扩展的存储库，提供用于下载和开发 PHP 扩展的所有已知扩展和托管功能的目录</p>
<p>官方链接: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://pecl.php.net/package-stats.php<br></code></pre></td></tr></table></figure>

<p>github: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://github.com/phpredis/phpredis<br></code></pre></td></tr></table></figure>

<p>github安装文档: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://github.com/phpredis/phpredis/blob/develop/INSTALL.markdown<br></code></pre></td></tr></table></figure>

<p>开始在 PHP 中使用 Redis 前， 需要确保已经安装了 redis 服务及 PHP redis 驱动。</p>
<p>PHP redis 驱动下载地址为:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://github.com/phpredis/phpredis/releases<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp16.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="7-2-5-1-安装redis"><a href="#7-2-5-1-安装redis" class="headerlink" title="7.2.5.1 安装redis"></a>7.2.5.1 安装redis</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y redis</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-5-2-修改redis配置文件"><a href="#7-2-5-2-修改redis配置文件" class="headerlink" title="7.2.5.2 修改redis配置文件"></a>7.2.5.2 修改redis配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># sed -Ei.backup -e &#x27;/^bind/s/(bind ).*/\10.0.0.0/&#x27; -e &#x27;/# requirepass/s/# (requirepass ).*/\1123456/&#x27; /etc/redis.conf</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-5-3-启动redis"><a href="#7-2-5-3-启动redis" class="headerlink" title="7.2.5.3 启动redis"></a>7.2.5.3 启动redis</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl enable --now redis</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-5-4-安装php扩展"><a href="#7-2-5-4-安装php扩展" class="headerlink" title="7.2.5.4 安装php扩展"></a>7.2.5.4 安装php扩展</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum install -y php74-php-pecl-redis5</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-5-5-重启php"><a href="#7-2-5-5-重启php" class="headerlink" title="7.2.5.5 重启php"></a>7.2.5.5 重启php</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart php74-php-fpm</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-5-6-查看PHP是否支持redis扩展"><a href="#7-2-5-6-查看PHP是否支持redis扩展" class="headerlink" title="7.2.5.6 查看PHP是否支持redis扩展"></a>7.2.5.6 查看PHP是否支持redis扩展</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># /opt/remi/php74/root/sbin/php-fpm -m | grep redis</span><br>redis<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp17.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="7-2-5-7-配置-php-支持-redis-保存-session"><a href="#7-2-5-7-配置-php-支持-redis-保存-session" class="headerlink" title="7.2.5.7 配置 php 支持 redis 保存 session"></a>7.2.5.7 配置 php 支持 redis 保存 session</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#修改配置文件</span><br>vim /etc/opt/remi/php74/php-fpm.d/www.conf<br>......<br><span class="hljs-comment">#在末尾</span><br>session.save_handler = redis<br>session.save_path = <span class="hljs-string">&quot;tcp://10.0.0.17:6379?auth=123456&quot;</span><br>......<br><br><span class="hljs-comment">#检查语法</span><br><span class="hljs-comment"># /opt/remi/php74/root/sbin/php-fpm -t</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-5-8-重启php"><a href="#7-2-5-8-重启php" class="headerlink" title="7.2.5.8 重启php"></a>7.2.5.8 重启php</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># systemctl restart php74-php-fpm</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-5-9-查看session的存储路径是否更改"><a href="#7-2-5-9-查看session的存储路径是否更改" class="headerlink" title="7.2.5.9 查看session的存储路径是否更改"></a>7.2.5.9 查看session的存储路径是否更改</h4><p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp18.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="7-2-5-10-php实现-session-的测试页面"><a href="#7-2-5-10-php实现-session-的测试页面" class="headerlink" title="7.2.5.10 php实现 session 的测试页面"></a>7.2.5.10 php实现 session 的测试页面</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim /data/nginx/wordpress/session.php</span><br>&lt;?php<br>session_start();<br>//redis用session_id作为key 并且是以string的形式存储<br><span class="hljs-variable">$redisKey</span> = <span class="hljs-string">&#x27;PHPREDIS_SESSION:&#x27;</span> . session_id();<br><br>// SESSION 赋值测试<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&quot;Hello, I&#x27;m in redis&quot;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;arr&#x27;</span>] = [1, 2, 3, 4, 5, 6];<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;message&quot;</span>] , <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Redis key =  &quot;</span> . <span class="hljs-variable">$redisKey</span> . <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;以下是从Redis获取的数据&quot;</span>, <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><br>// 取数据<span class="hljs-string">&#x27;</span><br><span class="hljs-string">$redis = new Redis();</span><br><span class="hljs-string">$redis-&gt;connect(&#x27;</span>10.0.0.7<span class="hljs-string">&#x27;, 6379);</span><br><span class="hljs-string">$redis-&gt;auth(&#x27;</span>123456<span class="hljs-string">&#x27;);</span><br><span class="hljs-string"></span><br><span class="hljs-string">echo $redis-&gt;get($redisKey);</span><br><span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-5-11-访问-web-页面测试实现session保存在redis服务"><a href="#7-2-5-11-访问-web-页面测试实现session保存在redis服务" class="headerlink" title="7.2.5.11 访问 web 页面测试实现session保存在redis服务"></a>7.2.5.11 访问 web 页面测试实现session保存在redis服务</h4><p>浏览器访问：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">www.rlinpc.net/session.php<br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp19.jpg" srcset="/blog/img/loading.gif"></p>
<h4 id="7-2-5-12-redis客户端验证session数据"><a href="#7-2-5-12-redis客户端验证session数据" class="headerlink" title="7.2.5.12 redis客户端验证session数据"></a>7.2.5.12 redis客户端验证session数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># redis-cli -h 10.0.0.7 -a 123456</span><br>10.0.0.7:6379&gt; keys *<br>1) <span class="hljs-string">&quot;PHPREDIS_SESSION:pitsj07de142k7nb8ldbutkbnq&quot;</span><br>10.0.0.7:6379&gt; get PHPREDIS_SESSION:pitsj07de142k7nb8ldbutkbnq<br><span class="hljs-string">&quot;message|s:19:\&quot;Hello, I&#x27;m in redis\&quot;;arr|a:6:&#123;i:0;i:1;i:1;i:2;i:2;i:3;i:3;i:4;i:4;i:5;i:5;i:6;&#125;&quot;</span><br></code></pre></td></tr></table></figure>

<h2 id="7-3-shell脚本部署"><a href="#7-3-shell脚本部署" class="headerlink" title="7.3 shell脚本部署"></a>7.3 shell脚本部署</h2><p><strong>脚本部署全部用指定版本，且都PHP，Nginx和MySQL都使用编译安装</strong></p>
<h3 id="7-3-1-环境规划"><a href="#7-3-1-环境规划" class="headerlink" title="7.3.1 环境规划"></a>7.3.1 环境规划</h3><table>
<thead>
<tr>
<th>服务器地址</th>
<th>安装软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.7</td>
<td>Nginx1.18.0、PHP7.10.4</td>
</tr>
<tr>
<td>10.0.0.17</td>
<td>MySQL8.0.19 Redis5.4.2</td>
</tr>
</tbody></table>
<p><strong>备份资料</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br><span class="hljs-comment">#下载mysql-8.0.19</span><br>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz<br><br><span class="hljs-comment">#编写一键安装脚本</span><br>vim install_mysql5.7or8.0_for_centos.sh<br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#Author: wangxiaochun</span><br><span class="hljs-comment">#QQ: 29308620</span><br><span class="hljs-comment">#Date: 2020-02-12</span><br><span class="hljs-comment">#FileName： install_mysql5.7_for_centos.sh</span><br><span class="hljs-comment">#URL: http://www.magedu.com</span><br><span class="hljs-comment">#Description： The test script</span><br><span class="hljs-comment">#Copyright (C): 2020 All rights reserved</span><br><span class="hljs-comment">#********************************************************************</span><br><span class="hljs-comment">#MySQL Download URL: https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.29-linux-glibc2.12-x86_64.tar.gz</span><br><br>. /etc/init.d/<span class="hljs-built_in">functions</span> <br>SRC_DIR=`<span class="hljs-built_in">pwd</span>`<br>MYSQL=<span class="hljs-string">&#x27;mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz&#x27;</span><br>COLOR=<span class="hljs-string">&quot;echo -e \\033[01;31m&quot;</span><br>END=<span class="hljs-string">&#x27;\033[0m&#x27;</span><br>MYSQL_ROOT_PASSWORD=123456<br>DIR=/data/mysql<br><br><span class="hljs-function"><span class="hljs-title">check</span></span> ()&#123;<br><span class="hljs-built_in">cd</span>  <span class="hljs-variable">$SRC_DIR</span><br><span class="hljs-keyword">if</span> [ !  -e <span class="hljs-variable">$MYSQL</span> ];<span class="hljs-keyword">then</span><br>        <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;缺少<span class="hljs-variable">$&#123;MYSQL&#125;</span>文件&quot;</span><span class="hljs-variable">$END</span><br>        <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;请将相关软件放在<span class="hljs-variable">$&#123;SRC_DIR&#125;</span>目录下&quot;</span><span class="hljs-variable">$END</span><br>        <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">elif</span> [ -e /usr/<span class="hljs-built_in">local</span>/mysql ];<span class="hljs-keyword">then</span><br>        action <span class="hljs-string">&quot;数据库已存在，安装失败&quot;</span> <span class="hljs-literal">false</span><br>        <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">elif</span> [ ! -e DIR ];<span class="hljs-keyword">then</span>   <span class="hljs-comment">#检查是否缺少/data/mysql文件，没有会安装失败</span><br>        <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;缺少<span class="hljs-variable">$DIR</span>文件&quot;</span><span class="hljs-variable">$END</span><br>        mkdir -p <span class="hljs-variable">$DIR</span><br>        <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;已自动创建<span class="hljs-variable">$DIR</span>文件&quot;</span><span class="hljs-variable">$END</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">return</span><br><span class="hljs-keyword">fi</span><br><br>&#125;   <br><br><span class="hljs-function"><span class="hljs-title">install_mysql</span></span>()&#123;<br>    <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;开始安装MySQL数据库...&quot;</span><span class="hljs-variable">$END</span><br>     yum  -y -q install libaio numactl-libs   libaio &amp;&gt; /dev/null<br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$SRC_DIR</span><br>    tar xf <span class="hljs-variable">$MYSQL</span> -C /usr/<span class="hljs-built_in">local</span>/<br>    MYSQL_DIR=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MYSQL</span>| sed -nr <span class="hljs-string">&#x27;s/^(.*[0-9]).*/\1/p&#x27;</span>`<br>    ln -s  /usr/<span class="hljs-built_in">local</span>/<span class="hljs-variable">$MYSQL_DIR</span> /usr/<span class="hljs-built_in">local</span>/mysql<br>    chown -R  root.root /usr/<span class="hljs-built_in">local</span>/mysql/<br>    id mysql &amp;&gt; /dev/null || &#123; useradd -s /sbin/nologin -r  mysql ; action <span class="hljs-string">&quot;创建mysql用户&quot;</span>; &#125;<br><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;PATH=/usr/local/mysql/bin/:$PATH&#x27;</span> &gt; /etc/profile.d/mysql.sh<br>    .  /etc/profile.d/mysql.sh<br>    cat &gt; /etc/my.cnf &lt;&lt;-<span class="hljs-string">EOF</span><br><span class="hljs-string">[mysqld]</span><br><span class="hljs-string">server-id=1</span><br><span class="hljs-string">log-bin</span><br><span class="hljs-string">datadir=/data/mysql</span><br><span class="hljs-string">socket=/data/mysql/mysql.sock                                                                                                   </span><br><span class="hljs-string">log-error=/data/mysql/mysql.log</span><br><span class="hljs-string">pid-file=/data/mysql/mysql.pid</span><br><span class="hljs-string">[client]</span><br><span class="hljs-string">socket=/data/mysql/mysql.sock</span><br><span class="hljs-string">EOF</span><br>    mysqld --initialize --user=mysql --datadir=/data/mysql <br>    cp /usr/<span class="hljs-built_in">local</span>/mysql/support-files/mysql.server  /etc/init.d/mysqld<br>    chkconfig --add mysqld<br>    chkconfig mysqld on<br>    service mysqld start<br>    [ $? -ne 0 ] &amp;&amp; &#123; <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;数据库启动失败，退出!&quot;</span><span class="hljs-variable">$END</span>;<span class="hljs-built_in">exit</span>; &#125;<br>    MYSQL_OLDPASSWORD=`awk <span class="hljs-string">&#x27;/A temporary password/&#123;print $NF&#125;&#x27;</span> /data/mysql/mysql.log`<br>    mysqladmin  -uroot -p<span class="hljs-variable">$MYSQL_OLDPASSWORD</span> password <span class="hljs-variable">$MYSQL_ROOT_PASSWORD</span> &amp;&gt;/dev/null<br>    action <span class="hljs-string">&quot;数据库安装完成&quot;</span> <br>&#125;<br><br>check<br><br>install_mysql<br><br><span class="hljs-comment">#查看文件</span><br>ll<br><br><span class="hljs-comment">#检查脚本语法是否有错误</span><br>bash -n install_mysql5.7or8.0_for_centos.sh<br><br><span class="hljs-comment">#调试脚本</span><br>bash -x install_mysql5.7or8.0_for_centos.sh<br><br><span class="hljs-comment">#删除调试脚本是创建的mysql文件夹</span><br>mv /usr/<span class="hljs-built_in">local</span> mysql mysql.bak<br><br><span class="hljs-comment">#运行脚本安装数据库</span><br>bash install_mysql5.7or8.0_for_centos.sh<br></code></pre></td></tr></table></figure>

<p><strong>备份资料</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum -y install gcc openssl-devel libxml2-devel bzip2-devel libmcrypt-devel sqlite-devel oniguruma-devel<br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br>wget https://www.php.net/distributions/php-7.4.11.tar.xz<br>ll -h php-7.4.11.tar.xz<br>-rw-r--r--. 1 root root 9.9M Feb 27 08:42 php-7.4.11.tar.xz<br>tar xf php-7.4.11.tar.xz<br><span class="hljs-built_in">cd</span> php-7.4.11<br>./configure --prefix=/apps/php74 --enable-mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-openssl --with-zlib --with-config-file-path=/etc --with-config-file-scan-dir=/etc/php.d --enable-mbstring --enable-xml --enable-sockets --enable-fpm --enable-maintainer-zts --disable-fileinfo<br><br>......<br>config.status: creating main/php_config.h<br>config.status: executing default commands<br><br>+--------------------------------------------------------------------+<br>| License:                              |<br>| This software is subject to the PHP License, available <span class="hljs-keyword">in</span> this   |<br>| distribution <span class="hljs-keyword">in</span> the file LICENSE. By continuing this installation |<br>| process, you are bound by the terms of this license agreement.   |<br>| If you <span class="hljs-keyword">do</span> not agree with the terms of this license, you must abort |<br>| the installation process at this point.              |<br>+--------------------------------------------------------------------+<br><br>Thank you <span class="hljs-keyword">for</span> using PHP.<br><br>make -j 8 &amp;&amp; make install <span class="hljs-comment">#看条件是否能加-j </span><br><br>cp /usr/<span class="hljs-built_in">local</span>/src/php-7.4.11/php.ini-production /etc/php.ini<br><span class="hljs-built_in">cd</span> /apps/php74/etc<br>cp php-fpm.conf.default php-fpm.conf<br><span class="hljs-built_in">cd</span> php-fpm.d/<br>cp www.conf.default www.conf<br>vim www.conf<br>[www]<br>user = nginx<br>group = nginx<br>listen = 127.0.0.1:9000<br>pm = dynamic<br>pm.max_children = 5<br>pm.start_servers = 2<br>pm.min_spare_servers = 1<br>pm.max_spare_servers = 3<br>pm.status_path = /pm_status<br>ping.path = /ping<br>access.log = <span class="hljs-built_in">log</span>/<span class="hljs-variable">$pool</span>.access.log<br>slowlog = <span class="hljs-built_in">log</span>/<span class="hljs-variable">$pool</span>.log.slow<br><br><span class="hljs-comment">#创建用户</span><br>useradd -r -s /sbin/nologin nginx<br><br><span class="hljs-comment">#创建访问日志文件路径</span><br>mkdir /apps/php74/<span class="hljs-built_in">log</span><br><br><span class="hljs-comment">#检查配置文件</span><br>/apps/php74/sbin/php-fpm -t<br>[27-Feb-2021 11:53:51] NOTICE: configuration file /apps/php74/etc/php-fpm.conf <span class="hljs-built_in">test</span> is successful<br><br><span class="hljs-comment">#复制文件</span><br>cp /usr/<span class="hljs-built_in">local</span>/src/php-7.4.11/sapi/fpm/php-fpm.service /usr/lib/systemd/system/<br><br><span class="hljs-comment">#加载配置文件，将php设置为开机启动，启动php</span><br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> --now php-fpm<br>Created symlink from /etc/systemd/system/multi-user.target.wants/php-fpm.service to /usr/lib/systemd/system/php-fpm.service.<br><br><span class="hljs-comment">#出现9000端口证明成功</span><br>ss -tnl<br>State       Recv-Q Send-Q             Local Address:Port                            Peer Address:Port              <br>LISTEN      0      128                            *:22                                         *:*                  <br>LISTEN      0      128                    127.0.0.1:9000                                       *:*                  <br>LISTEN      0      128                           :::22                                        :::*   <br><br>pstree -p |grep php<br>           |-php-fpm(116240)-+-php-fpm(116241)<br>           |                 `-php-fpm(116242)<br><br>ps -ef |grep php<br>root     116240      1  0 11:59 ?        00:00:00 php-fpm: master process (/apps/php74/etc/php-fpm.conf)<br>nginx    116241 116240  0 11:59 ?        00:00:00 php-fpm: pool www<br>nginx    116242 116240  0 11:59 ?        00:00:00 php-fpm: pool www<br>root     116245   1342  0 12:00 pts/0    00:00:00 grep --color=auto php<br><br><span class="hljs-comment">#编辑php.ini配置文件</span><br>vim /etc/php.ini<br>[opcache]<br>; Determines <span class="hljs-keyword">if</span> Zend OPCache is enabled<br>zend_extension=opcache.so                           <br>opcache.enable=1<br>.....<br><br>/apps/php74/sbin/php-fpm -t<br>[27-Feb-2021 17:04:54] NOTICE: configuration file /apps/php74/etc/php-fpm.conf <span class="hljs-built_in">test</span> is successful<br><br>systemctl restart php-fpm<br><span class="hljs-comment">#访问测试页确认开启opcache加速</span><br></code></pre></td></tr></table></figure>

<p><img src="https://lwx-1304975851.cos.ap-guangzhou.myqcloud.com/myblog/nginx/nginx-lnmp15.jpg" srcset="/blog/img/loading.gif"></p>
<p><strong>备份资料3</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum -y install gcc pcre-devel openssl-devel zlib-devel<br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src/<br>wget http://nginx.org/download/nginx-1.18.0.tar.gz<br>tar xf nginx-1.18.0.tar.gz<br><span class="hljs-built_in">cd</span> nginx-1.18.0/<br>./configure --prefix=/apps/nginx \<br>--user=nginx \<br>--group=nginx \<br>--with-http_ssl_module \<br>--with-http_v2_module \<br>--with-http_realip_module \<br>--with-http_stub_status_module \<br>--with-http_gzip_static_module \<br>--with-pcre \<br>--with-stream \<br>--with-stream_ssl_module \<br>--with-stream_realip_module<br>make &amp;&amp; make install<br><br>vim /usr/lib/systemd/system/nginx.service<br>[Unit]<br>Description=nginx - high performance web server<br>Documentation=http://nginx.org/en/docs/<br>After=network-online.target remote-fs.target nss-lookup.target<br>Wants=network-online.target<br>[Service]<br>Type=forking<br>PIDFile=/apps/nginx/run/nginx.pid<br>ExecStart=/apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf<br>ExecReload=/bin/<span class="hljs-built_in">kill</span> -s HUP <span class="hljs-variable">$MAINPID</span><br>ExecStop=/bin/<span class="hljs-built_in">kill</span> -s TERM <span class="hljs-variable">$MAINPID</span><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment">#创建目录</span><br>mkdir /apps/nginx/run/<br><br><span class="hljs-comment">#修改配置文件</span><br>vim /apps/nginx/conf/nginx.conf<br>pid /apps/nginx/run/nginx.pid;<br><br><span class="hljs-comment">#创建软连接</span><br>ln -s /apps/nginx/sbin/nginx /usr/sbin/<br><br><span class="hljs-comment">#检查配置文件是否有错误</span><br>nginx -t<br><br><span class="hljs-comment">#加载配置文件并启动nginx</span><br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> --now nginx<br><br><span class="hljs-comment">#查看端口</span><br>ss -ntl<br>State       Recv-Q Send-Q             Local Address:Port                            Peer Address:Port              <br>LISTEN      0      128                            *:80                                         *:*                  <br>LISTEN      0      128                            *:22                                         *:*                  <br>LISTEN      0      128                    127.0.0.1:9000                                       *:*                  <br>LISTEN      0      128                           :::22                                        :::*      <br></code></pre></td></tr></table></figure>

<p><strong>资料备份4</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br>wget https://cn.wordpress.org/wordpress-5.4.2-zh_CN.tar.gz<br>tar xf wordpress-5.4.2-zh_CN.tar.gz<br>cp -r wordpress/* /data/nginx/wordpress<br>chown -R nginx.nginx /data/nginx/wordpress/<br></code></pre></td></tr></table></figure>

<p><strong>备份资料5</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/src<br>ls<br>wget http://pecl.php.net/get/redis-5.3.1.tgz<br>tar xf redis-5.3.1.tgz<br><span class="hljs-built_in">cd</span> redis-5.3.1/<br>ls<br>arrays.markdown    config.w32        library.c        redis_array_impl.c  redis_commands.h    sentinel_library.h<br>cluster_library.c  COPYING           library.h        redis_array_impl.h  redis_sentinel.c    sentinel.markdown<br>cluster_library.h  crc16.h           php_redis.h      redis.c             redis_sentinel.h    tests<br>cluster.markdown   CREDITS           README.markdown  redis_cluster.c     redis_session.c<br>common.h           INSTALL.markdown  redis_array.c    redis_cluster.h     redis_session.h<br>config.m4          liblzf            redis_array.h    redis_commands.c    sentinel_library.c<br><br><span class="hljs-comment">#如果是yum安装php,需要执行yum -y install php-cli php-devel</span><br><span class="hljs-comment">#以下为编译安装php的对应方式</span><br>/apps/php74/bin/phpize<br>Configuring <span class="hljs-keyword">for</span>:<br>PHP Api Version:         20190902<br>Zend Module Api No:      20190902<br>Zend Extension Api No:   320190902<br>Cannot find autoconf. Please check your autoconf installation and the <span class="hljs-comment">#报错提示</span><br><span class="hljs-variable">$PHP_AUTOCONF</span> environment variable. Then, rerun this script.<br><br>yum -y install autoconf<br>/apps/php74/bin/phpize<br>Configuring <span class="hljs-keyword">for</span>:<br>PHP Api Version:         20190902<br>Zend Module Api No:      20190902<br>Zend Extension Api No:   320190902<br><br><span class="hljs-comment">#查看生成configure脚本</span><br>ls<br>arrays.markdown    config.h.in   CREDITS           redis_array.c       redis_commands.c  sentinel_library.c<br>autom4te.cache     config.m4     INSTALL.markdown  redis_array.h       redis_commands.h  sentinel_library.h<br>build              configure     liblzf            redis_array_impl.c  redis_sentinel.c  sentinel.markdown<br>cluster_library.c  configure.ac  library.c         redis_array_impl.h  redis_sentinel.h  tests<br>cluster_library.h  config.w32    library.h         redis.c             redis_session.c<br>cluster.markdown   COPYING       php_redis.h       redis_cluster.c     redis_session.h<br>common.h           crc16.h       README.markdown   redis_cluster.h     run-tests.php<br><br><span class="hljs-comment">#yum安装php,无需指定--with-php-config</span><br>./configure --with-php-config=/apps/php74/bin/php-config --enable-redis<br>make &amp;&amp; make install<br>......<br>See any operating system documentation about shared libraries <span class="hljs-keyword">for</span><br>more information, such as the ld(1) and ld.so(8) manual pages.<br>----------------------------------------------------------------------<br><br>Build complete.<br>Don<span class="hljs-string">&#x27;t forget to run &#x27;</span>make <span class="hljs-built_in">test</span><span class="hljs-string">&#x27;.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Installing shared extensions:     /apps/php74/lib/php/extensions/no-debug-zts-20190902/</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">#验证redis模块</span><br><span class="hljs-string">#yum安装php,模块文件默认存放在 /usr/lib64/php/modules/redis.so</span><br><span class="hljs-string">ll /apps/php74/lib/php/extensions/no-debug-zts-20190902/</span><br><span class="hljs-string">total 9584</span><br><span class="hljs-string">-rwxr-xr-x. 1 root root 4647932 Feb 27 11:38 opcache.a</span><br><span class="hljs-string">-rwxr-xr-x. 1 root root 2509608 Feb 27 11:38 opcache.so</span><br><span class="hljs-string">-rwxr-xr-x. 1 root root 2651376 Feb 27 17:18 redis.so</span><br><span class="hljs-string"></span><br><span class="hljs-string">#编辑php.ini配置文件，扩展redis.so模块</span><br><span class="hljs-string">vim /etc/php.ini</span><br><span class="hljs-string">.....</span><br><span class="hljs-string">#extension=/apps/php74/lib/php/extensions/no-debug-zts-20190902/redis.so</span><br><span class="hljs-string">extension=redis.so   #文件最后一行添加此行,路径可省略</span><br><span class="hljs-string">systemctl restart php-fpm</span><br><span class="hljs-string"></span><br><span class="hljs-string">#在10.0.0.17主机安装redis服务</span><br><span class="hljs-string">yum -y install redis</span><br><span class="hljs-string">vim /etc/redis.conf</span><br><span class="hljs-string">bind 0.0.0.0</span><br><span class="hljs-string">requirepass 123456</span><br><span class="hljs-string"></span><br><span class="hljs-string">systemctl enable --now redis</span><br><span class="hljs-string"></span><br><span class="hljs-string">#端口号6379</span><br><span class="hljs-string">ss -tnl</span><br><span class="hljs-string">State       Recv-Q Send-Q             Local Address:Port                            Peer Address:Port              </span><br><span class="hljs-string">LISTEN      0      128                            *:6379                                       *:*                  </span><br><span class="hljs-string">LISTEN      0      128                            *:22                                         *:*                  </span><br><span class="hljs-string">LISTEN      0      128                           :::22                                        :::*                  </span><br><span class="hljs-string">LISTEN      0      70                            :::33060                                     :::*                  </span><br><span class="hljs-string">LISTEN      0      128                           :::3306                                      :::*      </span><br><span class="hljs-string"></span><br><span class="hljs-string">#在10.0.0.7主机配置php的session保存在redis服务</span><br><span class="hljs-string">vim /etc/php.ini</span><br><span class="hljs-string">[Session]</span><br><span class="hljs-string">; Handler used to store/retrieve data.</span><br><span class="hljs-string">; http://php.net/session.save-handler</span><br><span class="hljs-string">session.save_handler = redis</span><br><span class="hljs-string">session.save_path = &quot;tcp://10.0.0.17:6379?auth=123456&quot; </span><br><span class="hljs-string"></span><br><span class="hljs-string">systemctl restart php-fpm</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>

<p>" srcset="/blog/img/loading.gif<img src=""></p>
<p>" srcset="/blog/img/loading.gif<img src=""></p>
<p>准备 php实现 session 的测试页面</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /data/nginx/wordpress/session.php<br><br></code></pre></td></tr></table></figure>

<p>" srcset="/blog/img/loading.gif<img src=""></p>
<h4 id="访问-web-页面测试实现session保存在redis服务"><a href="#访问-web-页面测试实现session保存在redis服务" class="headerlink" title="访问 web 页面测试实现session保存在redis服务"></a>访问 web 页面测试实现session保存在redis服务</h4><p>" srcset="/blog/img/loading.gif<img src=""></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli -h 10.0.0.17 -a 123456<br>redis-cli -h 10.0.0.17 -a 123456<br>10.0.0.17:6379&gt; keys *<br>1) <span class="hljs-string">&quot;PHPREDIS_SESSION:t4q6udsscerbnb35lm215jojrl&quot;</span> <span class="hljs-comment">#要根据获得的key来输入</span><br>10.0.0.17:6379&gt; get PHPREDIS_SESSION:t4q6udsscerbnb35lm215jojrl<br><span class="hljs-string">&quot;message|s:19:\&quot;Hello, I&#x27;m in redis\&quot;;arr|a:6:&#123;i:0;i:1;i:1;i:2;i:2;i:3;i:3;i:4;i:4;i:5;i:5;i:6;&#125;&quot;</span><br></code></pre></td></tr></table></figure>



<h2 id="7-4-ansible部署"><a href="#7-4-ansible部署" class="headerlink" title="7.4 ansible部署"></a>7.4 ansible部署</h2><p>略</p>
<h2 id="7-5-docker部署"><a href="#7-5-docker部署" class="headerlink" title="7.5 docker部署"></a>7.5 docker部署</h2><p>略</p>
<h2 id="7-6-kubernets部署"><a href="#7-6-kubernets部署" class="headerlink" title="7.6 kubernets部署"></a>7.6 kubernets部署</h2><p>略</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/Linux-Nginx/">Linux Nginx</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/03/02/%E4%BC%81%E4%B8%9A%E7%BA%A7VPN%E6%9C%8D%E5%8A%A1OpenVPN/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">企业级VPN服务OpenVPN</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/02/27/%E9%AB%98%E6%80%A7%E8%83%BDWEB%E6%9C%8D%E5%8A%A1Nginx%EF%BC%88%E4%BA%8C%EF%BC%89Nginx%E6%9E%B6%E6%9E%84%E5%92%8C%E5%AE%89%E8%A3%85/">
                        <span class="hidden-mobile">高性能WEB服务Nginx（二）Nginx架构和安装</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
