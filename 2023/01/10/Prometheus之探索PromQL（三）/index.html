

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="rlin">
  <meta name="keywords" content="">
  <title>Prometheus之探索PromQL（三） - rlin的运维笔记</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"rintime.gitee.io","root":"/blog/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>rlin的运维笔记</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Prometheus之探索PromQL（三）">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-01-10 10:58" pubdate>
        2023年1月10日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      15.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      207
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Prometheus之探索PromQL（三）</h1>
            
            <div class="markdown-body">
              <h1 id="探索PromQL"><a href="#探索PromQL" class="headerlink" title="探索PromQL"></a>探索PromQL</h1><p>通过PromQL用户可以非常方便地对监控样本数据进行统计分析，PromQL支持常见的运算操作符，同时PromQL中还提供了大量的内置函数可以实现对数据的高级处理。当然在学习PromQL之前，还需要了解Prometheus的样本数据模型。PromQL作为Prometheus的核心能力除了实现数据的对外查询和展现，同时告警监控也是依赖PromQL实现的。</p>
<p>Prometheu提供一个函数式的表达式语言PromQL(Prometheus Query Language)，可以使用户实时地查找和聚合时间序列数据，表达式计算结果可以在图表中展示，也可以在Prometheus表达式浏览器中以表格形式展示，或者作为数据源，以HTTP API的方式提供给外部系统使用。</p>
<p>主要内容：</p>
<ul>
<li>Prometheus的数据模型</li>
<li>Promthues中监控指标的类型</li>
<li>深入PromQL</li>
<li>4个黄金指标和USE方法</li>
</ul>
<p>学习PromQL的官方地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://prometheus.io/docs/prometheus/latest/querying/basics/<br></code></pre></td></tr></table></figure>

<h1 id="一、理解时间序列"><a href="#一、理解时间序列" class="headerlink" title="一、理解时间序列"></a>一、理解时间序列</h1><p>之前我们通过node_exporter暴露的HTTP服务，Prometheus可以采集到当前主机所有监控指标的样本数据。例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span><br><span class="hljs-comment"># TYPE node_cpu_seconds_total counter</span><br>node_cpu_seconds_total&#123;cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;idle&quot;</span>&#125; 45331.81<br>node_cpu_seconds_total&#123;cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;iowait&quot;</span>&#125; 7.52<br>node_cpu_seconds_total&#123;cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;irq&quot;</span>&#125; 0<br>node_cpu_seconds_total&#123;cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;nice&quot;</span>&#125; 0<br>......<br><br><span class="hljs-comment"># HELP node_load1 1m load average.</span><br><span class="hljs-comment"># TYPE node_load1 gauge</span><br>node_load1 0<br></code></pre></td></tr></table></figure>

<p>其中非#开头的每一行表示当前node_exporter采集到的一个监控样本：<code>node_cpu_seconds_total</code>和<code>node_load1</code>表明了当前指标的名称、大括号中的标签则反映了当前样本的一些特征和维度、浮点数则是该监控样本的具体值。</p>
<h2 id="1-1-样本"><a href="#1-1-样本" class="headerlink" title="1.1 样本"></a>1.1 样本</h2><p>Prometheus会将所有采集到的样本数据以时间序列（time-series）的方式保存在内存数据库中，并且定时保存到硬盘上。time-series是按照时间戳和值的序列顺序存放的，我们称之为向量(vector)，每条time-series通过指标名称(metrics name)和一组标签集(labelset)命名。如下所示，可以将time-series理解为一个以时间为Y轴的数字矩阵：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">^<br>│   . . . . . . . . . . . . . . . . .   . .    node_cpu_seconds_total&#123;cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;<br>│     . . . . . . . . . . . . . . . . . . .    node_cpu_seconds_total&#123;cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;system&quot;</span>&#125;<br>│     . . . . . . . . . .   . . . . . . . .    node_load1<br>│     . . . . . . . . . . . . . . . .   . .  <br>v<br>  &lt;------------------ 时间 ----------------&gt;<br></code></pre></td></tr></table></figure>

<p>在time-series中的每一个点称为一个样本（sample），样本由以下三部分组成：</p>
<ul>
<li>指标(metric)：metric name和描述当前样本特征的labelsets;</li>
<li>时间戳(timestamp)：一个精确到毫秒的时间戳;</li>
<li>样本值(value)： 一个float64的浮点型数据表示当前样本的值。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">&lt;--------------------------- metric ---------------------&gt;&lt;-timestamp -&gt;&lt;-value-&gt;<br>prometheus_http_requests_total&#123;status=<span class="hljs-string">&quot;200&quot;</span>, method=<span class="hljs-string">&quot;GET&quot;</span>&#125;@1434417560938 =&gt; 94355<br>prometheus_http_requests_total&#123;status=<span class="hljs-string">&quot;200&quot;</span>, method=<span class="hljs-string">&quot;GET&quot;</span>&#125;@1434417561287 =&gt; 94334<br><br>prometheus_http_requests_total&#123;status=<span class="hljs-string">&quot;404&quot;</span>, method=<span class="hljs-string">&quot;GET&quot;</span>&#125;@1434417560938 =&gt; 38473<br>prometheus_http_requests_total&#123;status=<span class="hljs-string">&quot;404&quot;</span>, method=<span class="hljs-string">&quot;GET&quot;</span>&#125;@1434417561287 =&gt; 38544<br><br>prometheus_http_requests_total&#123;status=<span class="hljs-string">&quot;200&quot;</span>, method=<span class="hljs-string">&quot;POST&quot;</span>&#125;@1434417560938 =&gt; 4748<br>prometheus_http_requests_total&#123;status=<span class="hljs-string">&quot;200&quot;</span>, method=<span class="hljs-string">&quot;POST&quot;</span>&#125;@1434417561287 =&gt; 4785<br></code></pre></td></tr></table></figure>

<h2 id="1-2-指标-Metric"><a href="#1-2-指标-Metric" class="headerlink" title="1.2 指标(Metric)"></a>1.2 指标(Metric)</h2><p>在形式上，所有的指标(Metric)都通过如下格式标示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">&lt;metric name&gt;&#123;&lt;label name&gt;=&lt;label value&gt;, ...&#125;<br></code></pre></td></tr></table></figure>

<p>指标的名称(metric name)可以反映被监控样本的含义（比如，<code>prometheus_http_requests_total</code> - 表示当前系统接收到的HTTP请求总量）。指标名称只能由ASCII字符、数字、下划线以及冒号组成并必须符合正则表达式<code>[a-zA-Z_:][a-zA-Z0-9_:]*</code>。</p>
<p>标签(label)反映了当前样本的特征维度，通过这些维度Prometheus可以对样本数据进行过滤，聚合等。标签的名称只能由ASCII字符、数字以及下划线组成并满足正则表达式<code>[a-zA-Z_][a-zA-Z0-9_]*</code>。</p>
<h1 id="二、初识PromQL"><a href="#二、初识PromQL" class="headerlink" title="二、初识PromQL"></a>二、初识PromQL</h1><p>Prometheus通过指标名称（metrics name）以及对应的一组标签（labelset）唯一定义一条时间序列。指标名称反映了监控样本的基本标识，而label则在这个基本特征上为采集到的数据提供了多种特征维度。可以基于这些特征维度过滤，聚合，统计从而产生新的计算后的一条时间序列。</p>
<p>PromQL是Prometheus内置的数据查询语言，其提供对时间序列数据丰富的查询，聚合以及逻辑运算能力的支持。并且被广泛应用在Prometheus的日常应用当中，包括对数据查询、可视化、告警处理当中。可以这么说，PromQL是Prometheus所有应用场景的基础，理解和掌握PromQL是Prometheus入门的第一课。</p>
<h2 id="2-1-查询样本数据"><a href="#2-1-查询样本数据" class="headerlink" title="2.1 查询样本数据"></a>2.1 查询样本数据</h2><p>当Prometheus通过Exporter采集到相应的监控指标样本数据后，我们就可以通过PromQL对监控样本数据进行查询。</p>
<p>当我们直接使用监控指标名称查询时，可以查询该指标下的所有数据。如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">prometheus_http_requests_total<br></code></pre></td></tr></table></figure>

<p>等同于：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">prometheus_http_requests_total&#123;&#125;<br></code></pre></td></tr></table></figure>

<p>该表达式会返回指标名称为<code>prometheus_http_requests_total</code>的所有时间序列：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/-/ready&quot;&#125; 3<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/api/v1/label/:name/values&quot;&#125; 22<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/api/v1/labels&quot;&#125; 9<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/api/v1/metadata&quot;&#125; 18<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/api/v1/query&quot;&#125; 254<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/api/v1/query_exemplars&quot;&#125; 2<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/api/v1/query_range&quot;&#125; 388<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/api/v1/rules&quot;&#125; 1<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/api/v1/series&quot;&#125; 37<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/api/v1/status/buildinfo&quot;&#125; 1<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/api/v1/targets&quot;&#125; 3<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/favicon.ico&quot;&#125; 83<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/graph&quot;&#125; 3<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/metrics&quot;&#125; 5414<br>prometheus_http_requests_total&#123;code=&quot;200&quot;,handler=&quot;/static/*filepath&quot;&#125; 12<br>prometheus_http_requests_total&#123;code=&quot;302&quot;,handler=&quot;/&quot;&#125; 3<br>prometheus_http_requests_total&#123;code=&quot;400&quot;,handler=&quot;/api/v1/query&quot;&#125; 1<br></code></pre></td></tr></table></figure>

<p>PromQL还支持用户根据时间序列的标签匹配模式来对时间序列进行过滤，目前主要支持两种匹配模式：完全匹配和正则匹配。（之后在标签匹配中会说明）</p>
<h2 id="2-2-查询数据的类型"><a href="#2-2-查询数据的类型" class="headerlink" title="2.2 查询数据的类型"></a>2.2 查询数据的类型</h2><p>官网介绍：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://prometheus.io/docs/prometheus/latest/querying/basics/#expression-language-data-types<br></code></pre></td></tr></table></figure>

<p>在Prometheus的表达式语言中，一个表达式或子表达式可以分为四种类型：</p>
<ul>
<li><strong>Instant vector</strong>（瞬时向量，瞬时数据）：</li>
</ul>
<blockquote>
<p>是对目标实例查询到的同一个时间戳的一组时间序列数据（按照时间的推移对数据进存储和展示），每个<br>时间序列包含单个数据样本，比如<font color=orange><code>node_memory_MemFree bytes</code></font>查询的是当前剩余内存（可用内存）就是一个瞬时向量，该表达式的返回值中只会包含该时间序列中的最新的一个样本值，而相应的这样的表达式称之为瞬时向量表达式，例如：<font color=orange><code>prometheus_http_requests_total</code></font></p>
</blockquote>
<p>prometheus API查询瞬时数据命令，在没有指定匹配条件的前提下，会返回所有包含此指标数据的实例数据：</p>
<p>例如：prometheus_.http_requests_total</p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-71.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li><strong>Range vector</strong>（范围向量，范围数据）：</li>
</ul>
<blockquote>
<p>是指在任何一个时间范围内，抓取的所有度量指标数据，比如最近一天的网卡流量趋势图。</p>
<p>范围向量表达式和瞬时向量表达式之间的差异在于在区间向量表达式中我们需要定义时间选择的范围，时间范围通过时间范围选择器<code>[]</code>进行定义。</p>
</blockquote>
<p>例如：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">prometheus_<span class="hljs-selector-class">.http_requests_total</span><span class="hljs-selector-attr">[5m]</span><br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-70.png" srcset="/blog/img/loading.gif"></p>
<p><strong>补充：</strong></p>
<p>除了使用m表示分钟以外，PromQL的时间范围选择器支持其它时间单位：</p>
<blockquote>
<ul>
<li>s - 秒</li>
<li>m - 分钟</li>
<li>h - 小时</li>
<li>d - 天</li>
<li>w - 周</li>
<li>y - 年</li>
</ul>
</blockquote>
<ul>
<li><strong>Scalar</strong>（标量、纯量数据）：</li>
</ul>
<blockquote>
<p>是一个浮点数类型的数据值。例如使用node_load1获取到时一个瞬时向量后，在使用prometheus的内置函数<code>scalar()</code>将瞬时向量转换为标量。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">scalar(sum(node_load1)) #sum()函数在之后会<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-72.png" srcset="/blog/img/loading.gif"></p>
<ul>
<li><strong>String</strong>（字符串）</li>
</ul>
<blockquote>
<p>简单的字符串类型的数据，目前未使用，(a simple string value;currently unused)。</p>
<p>直接使用字符串，作为PromQL表达式，则会直接返回字符串。</p>
</blockquote>
<h1 id="三、指标数据类型"><a href="#三、指标数据类型" class="headerlink" title="三、指标数据类型"></a>三、指标数据类型</h1><p>在Prometheus的存储实现上所有的监控样本都是以time-series的形式保存在Prometheus内存的TSDB（时序数据库）中，而time-series所对应的监控指标(metric)也是通过labelset进行唯一命名的。</p>
<p>从存储上来讲所有的监控指标metric都是相同的，但是在不同的场景下这些metric又有一些细微的差异。 例如，在node_exporter返回的样本中指标node_load1反应的是当前系统的负载状态，随着时间的变化这个指标返回的样本数据是在不断变化的。而指标node_cpu所获取到的样本数据却不同，它是一个持续增大的值，因为其反应的是CPU的累积使用时间，从理论上讲只要系统不关机，这个值是会无限变大的。</p>
<p>为了能够帮助用户理解和区分这些不同监控指标之间的差异，Prometheus定义了4中不同的指标类型(metric type)：Counter（计数器）、Gauge（仪表盘）、Histogram（直方图）、Summary（摘要）。</p>
<p>在Exporter返回的样本数据中，其注释中也包含了该样本的类型。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span><br><span class="hljs-comment"># TYPE node_cpu_seconds_total counter</span><br>node_cpu_seconds_total&#123;cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;idle&quot;</span>&#125; 45331.81<br>......<br></code></pre></td></tr></table></figure>

<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://prometheus.io/docs/concepts/metric_types/<br></code></pre></td></tr></table></figure>

<h2 id="3-1-Counter"><a href="#3-1-Counter" class="headerlink" title="3.1 Counter"></a>3.1 Counter</h2><p>Counter：计数器，Counter类型代表一个累积的指标数据，在没有被重启的前提下只增不减，比如磁盘I/O总数、Nginx/API的请求总数、网卡流经的报文总数等。一般在定义Counter类型指标的名称时推荐使用_total作为后缀。</p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-39.png" srcset="/blog/img/loading.gif"></p>
<p>Counter是一个简单但有强大的工具，例如我们可以在应用程序中记录某些事件发生的次数，通过以时序的形式存储这些数据，我们可以轻松的了解该事件产生速率的变化。</p>
<p>PromQL内置的聚合操作和函数可以让用户对这些数据进行进一步的分析：</p>
<p>例如：通过rate()函数获取HTTP请求量的增长率：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">rate</span><span class="hljs-params">(prometheus_http_requests_total[<span class="hljs-number">5</span>m])</span></span><br></code></pre></td></tr></table></figure>

<p><strong>注意：rate()函数会在之后有解释。</strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-68.png" srcset="/blog/img/loading.gif"></p>
<p>例如：查询当前系统中，访问量前10的HTTP地址：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">topk(10, prometheus_http_requests_total)<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-69.png" srcset="/blog/img/loading.gif"></p>
<h2 id="3-2-Gauge"><a href="#3-2-Gauge" class="headerlink" title="3.2 Gauge"></a>3.2 Gauge</h2><p>Gauge:仪表盘，Gauge类型代表一个可以任意变化的指标数据，值可以随时增高或减少，如带宽速率、CPU负载、内存利用率、nginx活动连接数等。<br><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-40.png" srcset="/blog/img/loading.gif"></p>
<p>通过Gauge指标，用户可以直接查看系统的当前状态：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">node_memory_MemFree_bytes<br></code></pre></td></tr></table></figure>

<p>还可以使用<code>deriv()</code>计算样本的线性回归模型，甚至是直接使用<code>predict_linear()</code>对数据的变化趋势进行预测。例如，预测系统磁盘空间在4个小时之后的剩余情况：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">predict_linear(node_filesystem_free_bytes&#123;job=<span class="hljs-string">&quot;node&quot;</span>&#125;[1h], 4 * 3600)<br></code></pre></td></tr></table></figure>

<h2 id="3-3-Histogram"><a href="#3-3-Histogram" class="headerlink" title="3.3 Histogram"></a>3.3 Histogram</h2><p>Histogram：累积直方图。Histogram会在一段时间范围内对数据进行采详（通常是请求持续时间或响应大小等），假如每分钟产生一个当前的活跃连接数，那么一天24小时*60分钟=1440分钟就会产生1440个数据，查看数据的每间隔的绘图跨度为2小时，那么2点的柱状图(bucket)会包含0点到2点即两个小时的数据，而4点的柱状图(bucket)则会包含0点到4点的数据，而6点的柱状图(bucket)则会包含0点到6点的数据，可用于统计从当天零点开始到当前时间的数据统计结果，如http请求成功率、丢包率等。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># curl localhost:9090/metrics | grep prometheus_tsdb_compaction_chunk_range_seconds_bucket</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;100&quot;</span>&#125; <span class="hljs-number">0</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;400&quot;</span>&#125; <span class="hljs-number">0</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;1600&quot;</span>&#125; <span class="hljs-number">0</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;6400&quot;</span>&#125; <span class="hljs-number">0</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;25600&quot;</span>&#125; <span class="hljs-number">0</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;102400&quot;</span>&#125; <span class="hljs-number">0</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;409600&quot;</span>&#125; <span class="hljs-number">1189</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;1.6384e+06&quot;</span>&#125; <span class="hljs-number">1189</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;6.5536e+06&quot;</span>&#125; <span class="hljs-number">18267</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;2.82144e+07&quot;</span>&#125; <span class="hljs-number">18267</span><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;+Inf&quot;</span>&#125; <span class="hljs-number">18267</span><br><br><span class="hljs-attribute">prometheus_tsdb_compaction_chunk_range_seconds_bucket</span><br><span class="hljs-comment"># TYPE go_gc_heap_frees_by_size_bytes_total histogram</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>(le=<span class="hljs-string">&quot;8.999999999999998&quot;</span>&#125; <span class="hljs-number">1</span>.<span class="hljs-number">489766</span>e+<span class="hljs-number">06</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>(le=<span class="hljs-string">&quot;24.999999999999996&quot;</span>) <span class="hljs-number">3</span>.<span class="hljs-number">1621269</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>&#123;le=<span class="hljs-string">&quot;64.99999999999999&quot;</span>&#125; <span class="hljs-number">3</span>.<span class="hljs-number">10805887</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>&#123;le=<span class="hljs-string">&quot;144.99999999999997&quot;</span>&#125; <span class="hljs-number">4</span>.<span class="hljs-number">5192143</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>&#123;le=<span class="hljs-string">&quot;320.99999999999994&quot;</span>&#125; <span class="hljs-number">4</span>.<span class="hljs-number">5981675</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>&#123;le=<span class="hljs-string">&quot;704.9999999999999&quot;</span>&#125; <span class="hljs-number">4</span>.<span class="hljs-number">6231281</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>&#123;le=<span class="hljs-string">&quot;1536.9999999999998&quot;</span>&#125; <span class="hljs-number">4</span>.<span class="hljs-number">6293065</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>&#123;le=<span class="hljs-string">&quot;3200.9999999999995&quot;</span>) <span class="hljs-number">4</span>.<span class="hljs-number">6357758</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>&#123;le=<span class="hljs-string">&quot;6528.999999999999&quot;</span>&#125; <span class="hljs-number">4</span>.<span class="hljs-number">6406395</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>(le=<span class="hljs-string">&quot;13568.999999999998&quot;</span>&#125; <span class="hljs-number">4</span>.<span class="hljs-number">6415683</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>&#123;le=<span class="hljs-string">&quot;27264.999999999996&quot;</span>&#125; <span class="hljs-number">4</span>.<span class="hljs-number">6443154</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_bucket</span>&#123;le=<span class="hljs-string">&quot;+Inf&quot;</span>&#125; <span class="hljs-number">4</span>.<span class="hljs-number">6448752</span>e+<span class="hljs-number">07</span><br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_sum</span> <span class="hljs-number">4</span>.<span class="hljs-number">690375928</span>e+<span class="hljs-number">09</span> #数据总值<br><span class="hljs-attribute">go_gc_heap_frees_by_size_bytes_total_count</span> <span class="hljs-number">4</span>.<span class="hljs-number">6448752</span>e+<span class="hljs-number">07</span> #数据个数<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-41.png" srcset="/blog/img/loading.gif" alt="histogram累积直方图"></p>
<h2 id="3-4-Summary"><a href="#3-4-Summary" class="headerlink" title="3.4 Summary"></a>3.4 Summary</h2><p>Summary：摘要，也是一组数据，默认统计选中的指标的最近l0分钟内的数据的分位数，可以指定数据统计范围。</p>
<p>分位数(Quantile)，亦称分位点，是指用分割点(cut point)将随机数据统计并划分为几个具有相同概率的连续区间，常见的为四分位，四分位数是将数据样本统计后分成四个区间，将范围内的数据进行百分比的占比统计，从0到1，表示是0号-100，(0%-25%，25%-50%，50%-75%，75%-100%)，利用四分位数，可以快速了解数据的大概统计结果。</p>
<p>如下统计的是0、0.25、0.5、0.75、1的数据量分别是多少。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">go_gc_duration_seconds</span><br><span class="hljs-comment"># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span><br><span class="hljs-comment"># TYPE go_gc_duration_seconds summary</span><br><span class="hljs-string">go_gc_duration</span> <span class="hljs-string">seconds&#123;quantile=&quot;0&quot;&#125;</span> <span class="hljs-number">1.8479e-05</span><br><span class="hljs-string">go_gc_duration_seconds&#123;quantile=&quot;0.25&quot;&#125;</span> <span class="hljs-number">6.5059e-05</span> <span class="hljs-comment">#25%的go_gc_duration_seconds的持续时间</span><br><span class="hljs-string">go_gc_duration_seconds&#123;quantile=&quot;0.5&quot;&#125;</span> <span class="hljs-number">9.3605e-05</span> <span class="hljs-comment">#50%的go_gc_duration_secondsl的持续时间</span><br><span class="hljs-string">go_gc_duration_seconds&#123;quantile=&quot;0.75&quot;&#125;</span> <span class="hljs-number">0.000133103</span> <span class="hljs-comment">#75%的go_gc_duration_seconds的持续时间</span><br><span class="hljs-string">go_gc_duration_seconds&#123;quantile-&quot;1&quot;&#125;</span> <span class="hljs-number">0.004022673</span> <span class="hljs-comment">#100%的go_gc_duration_seconds的特续时间</span><br><span class="hljs-string">g0_gc_duration_seconds_sum</span> <span class="hljs-number">1.446781088</span> <span class="hljs-comment">#数据总和</span><br><span class="hljs-string">go_gc_duration_seconds_count</span> <span class="hljs-number">7830</span> <span class="hljs-comment">#数据个数</span><br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-42.png" srcset="/blog/img/loading.gif"></p>
<h2 id="3-5-Histogram与Summary的补充"><a href="#3-5-Histogram与Summary的补充" class="headerlink" title="3.5 Histogram与Summary的补充"></a>3.5 Histogram与Summary的补充</h2><p>Summary类型与Histogram类型相似之处在于的样本同样会反应当前指标的记录的总数(以_count作为后缀)以及其值的总量（以_sum作为后缀）。不同在于Histogram指标直接反应了在不同区间内样本的个数，区间通过标签len进行定义。</p>
<p>同时对于Histogram的指标，我们还可以通过histogram_quantile()函数计算出其值的分位数。不同在于Histogram通过histogram_quantile函数是在服务器端计算的分位数。 而Sumamry的分位数则是直接在客户端计算完成。因此对于分位数的计算而言，Summary在通过PromQL进行查询时有更好的性能表现，而Histogram则会消耗更多的资源。反之对于客户端而言Histogram消耗的资源更少。<strong>在选择这两种方式时应该按照自己的实际场景进行选择。</strong></p>
<h1 id="四、PromQL-指标数据格式简介"><a href="#四、PromQL-指标数据格式简介" class="headerlink" title="四、PromQL-指标数据格式简介"></a>四、PromQL-指标数据格式简介</h1><h2 id="4-1-指标数据格式"><a href="#4-1-指标数据格式" class="headerlink" title="4.1 指标数据格式"></a>4.1 指标数据格式</h2><p>prometheus指标数据格式为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#没有标签的</span><br>metric_name metric_value<br><span class="hljs-comment"># TYPE node_load15 gauge</span><br>node_load15 0.1<br><br><span class="hljs-comment">#一个标签的</span><br>metric_name&#123;label1_name=<span class="hljs-string">&quot;label1-value&quot;</span>&#125; metric_Value<br><span class="hljs-comment"># TYPE node_network_receive_bytes_total counter</span><br>node_network_receive_bytes_total&#123;device=<span class="hljs-string">&quot;eth0&quot;</span>&#125; 1.44096e+07<br><br><span class="hljs-comment">#多个标签的</span><br>metric_name&#123;label1_name=<span class="hljs-string">&quot;label1-value&quot;</span>,labelN_name=<span class="hljs-string">&quot;labelN-value&quot;</span>&#125; metric_value<br><span class="hljs-comment"># TYPE node_filesystem_files_free gauge</span><br>node_filesystem_files_free&#123;device=<span class="hljs-string">&quot;/dev/sda2&quot;</span>,fstype=<span class="hljs-string">&quot;xfs&quot;</span>,mountpoint=<span class="hljs-string">&quot;/boot&quot;</span>&#125; 523984<br></code></pre></td></tr></table></figure>

<h2 id="4-2-指标数据格式示例"><a href="#4-2-指标数据格式示例" class="headerlink" title="4.2 指标数据格式示例"></a>4.2 指标数据格式示例</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh">node_memory_MemTotal_bytes <span class="hljs-comment">#查询node节点总内存大小</span><br>node_memory_MemFree_bytes <span class="hljs-comment">#查询node节点剩余可用内存</span><br>node_memory_MemTotar_bytes&#123;instance=<span class="hljs-string">&quot;10.0.0.17:9100&quot;</span>&#125; <span class="hljs-comment">#基于标签查询指定节点的总内存</span><br>node_memory_MemFree_bytes.(instance=<span class="hljs-string">&quot;10.0.0.17:9100&quot;</span>&#125; <span class="hljs-comment">#基于标签查询指定节点的可用内存</span><br><br>node_disk_io_time_seconds_total&#123;device=<span class="hljs-string">&quot;sda&quot;</span>&#125; <span class="hljs-comment">#查询指定磁盘的每秒磁盘io</span><br>node_filesystem_free_bytes&#123;device=<span class="hljs-string">&quot;/dev/sdal&quot;</span>,fstype=<span class="hljs-string">&quot;xfs&quot;</span>,mountpoint=<span class="hljs-string">&quot;/&quot;</span>&#125; <span class="hljs-comment">#查看指定磁盘的磁盘剩余空间</span><br><br><span class="hljs-comment">#HELP node_1load11 m load average. #cPU负载</span><br><span class="hljs-comment"># TYPE node loadl gauge</span><br>node_load1 0.1<br><br><span class="hljs-comment"># HELP node load15 15m load average.</span><br><span class="hljs-comment"># TYPE node load15 gauge</span><br>node_load15 0.17<br><br><span class="hljs-comment"># HELP node load5 5m load average.</span><br><span class="hljs-comment"># TYPE node load5 gauge</span><br>node_load5 0.13<br></code></pre></td></tr></table></figure>

<h1 id="五、PromQL-标签匹配"><a href="#五、PromQL-标签匹配" class="headerlink" title="五、PromQL-标签匹配"></a>五、PromQL-标签匹配</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">=：选择与提供的字符串完全相同的标签，精确匹配。<br>!=：选择与提供的字符串不相同的标签，取反。<br>=~：选择则表达式与提供的字符串（或子字符串）相匹配的标签。<br>!~：选择正则表达式与提供的字符串（或子字符串）不匹配的标签。<br><br><span class="hljs-comment">#查询格式&lt;metric name&gt;&#123;&lt;label name&gt;=&lt;label value&gt;,···&#125;</span><br>node_load1&#123;instance=<span class="hljs-string">&quot;10.0.0.17:9100&quot;</span>&#125;<br>node_load1&#123;job=<span class="hljs-string">&quot;promethues-node&quot;</span>&#125;<br><br>node_1oad1&#123;job=<span class="hljs-string">&quot;node&quot;</span>,instance=<span class="hljs-string">&quot;10.0.0.17:9100&quot;</span>&#125; <span class="hljs-comment">#精确匹配</span><br>node_load1&#123;job=<span class="hljs-string">&quot;node&quot;</span>,instance!=<span class="hljs-string">&quot;10.0.0.17:9100&quot;</span>&#125; <span class="hljs-comment">#取反</span><br>node_1oad1&#123;instance=~<span class="hljs-string">&quot;10.0.0.17.*:9100$&quot;</span>&#125; <span class="hljs-comment">#包含正则且匹配</span><br>node_load1&#123;instance!~<span class="hljs-string">&quot;10.0.0.7:9100&quot;</span>&#125; <span class="hljs-comment">#包含正则且取反</span><br></code></pre></td></tr></table></figure>

<p>补充：PromQL对正则表达式还可以支持多个表达式之间使用<code>|</code>进行分离。</p>
<p>比如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">prometheus_http_requests_total&#123;code=~&quot;200|400&quot;&#125;<br></code></pre></td></tr></table></figure>

<p>从查询结果上看，只可以看到code有“200”和“400”</p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-73.png" srcset="/blog/img/loading.gif"></p>
<h1 id="六、PromQL-运算符"><a href="#六、PromQL-运算符" class="headerlink" title="六、PromQL-运算符"></a>六、PromQL-运算符</h1><p>prometheus中存在以下二进制算术运算符：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">+：加法<br>-：减法<br>*：乘法<br>/：除法<br><span class="hljs-meta">%</span><span class="bash">：模</span><br>^：幂等<br></code></pre></td></tr></table></figure>

<p>我们可以通过指标<code>node_memory_MemFree_bytes</code>获取当前主机可用的内存空间大小，其样本单位为Bytes。如果客户端要求使用MB作为单位响应数据，那只需要将查询到的时间序列的样本值进行单位换算即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">node_memory_MemFree_bytes/1024/1024 #将内存进行单位从字节转行为兆<br></code></pre></td></tr></table></figure>

<p>当瞬时向量与标量之间进行数学运算时，数学运算符会依次作用域瞬时向量中的每一个样本值，从而得到一组新的时间序列。</p>
<p>而如果是瞬时向量与瞬时向量之间进行数学运算时，过程会相对复杂一点。 例如，如果我们想根据<code>node_disk_read_bytes_total</code>和<code>node_disk_written_bytes_total</code>获取主机磁盘IO的总量，可以使用如下表达式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">node_disk_read_bytes_total&#123;device=&quot;sda&quot;&#125; + node_disk_written_bytes_total&#123;device=&quot;sda&quot;&#125; #计算磁盘读写数据量<br>(node_disk_read_bytes_total&#123;device=&quot;sda&quot;&#125; + node_disk_written_bytes_total&#123;device=&quot;sda&quot;&#125;)/1024/1024 #单位转换<br></code></pre></td></tr></table></figure>

<p>那这个表达式是如何工作的呢？依次找到与左边向量元素匹配（标签完全一致）的右边向量元素进行运算，如果没找到匹配元素，则直接丢弃。同时新的时间序列将不会包含指标名称。</p>
<p>该表达式返回结果的示例如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">&#123;device=<span class="hljs-string">&quot;sda&quot;</span>,instance=<span class="hljs-string">&quot;10.0.0.7:9100&quot;</span>,job=<span class="hljs-string">&quot;node&quot;</span>&#125;=&gt;373878784 + 417726464<br></code></pre></td></tr></table></figure>

<h2 id="6-1-grafana上演示使用运算符"><a href="#6-1-grafana上演示使用运算符" class="headerlink" title="6.1 grafana上演示使用运算符"></a>6.1 grafana上演示使用运算符</h2><ol>
<li>进入一个dashboard（可以根据需求新建dashboard，这里为了方面而直接在原有的dashborad里添加）</li>
</ol>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-43.png" srcset="/blog/img/loading.gif"></p>
<ol start="2">
<li>点击左上角的“Add panel”</li>
</ol>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-44.png" srcset="/blog/img/loading.gif"></p>
<ol start="3">
<li>点击“Add a new planel”</li>
</ol>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-45.png" srcset="/blog/img/loading.gif"></p>
<ol start="4">
<li>在“Query”页面，Data source选择“prometheus”，查询方式选择“Code”，输入表达式，点击“Run queries”查看结果</li>
</ol>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-46.png" srcset="/blog/img/loading.gif"></p>
<ol start="5">
<li>查看grafana结果</li>
</ol>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-47.png" srcset="/blog/img/loading.gif"></p>
<p><strong>对比在prometheus server查看数据</strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-48.png" srcset="/blog/img/loading.gif"></p>
<h1 id="七、Prometheus内置函数"><a href="#七、Prometheus内置函数" class="headerlink" title="七、Prometheus内置函数"></a>七、Prometheus内置函数</h1><p>Prometheus还提供了其它大量的内置函数，可以对时序数据进行丰富的处理。</p>
<p>prometheus官方关于内置函数的文档地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://prometheus.io/docs/prometheus/latest/querying/functions/#functions<br></code></pre></td></tr></table></figure>

<p>Prometheus提供了下列内置的内置函数，这些内置函数作用于瞬时向量。可以将瞬时表达式返回的样本数据进行聚合，形成一个新的时间序列。</p>
<p>使用内置函数作的语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]<br></code></pre></td></tr></table></figure>

<p>其中只有<code>count_values</code>, <code>quantile</code>, <code>topk</code>, <code>bottomk</code>支持参数(parameter)。</p>
<p>下面介绍一些常用的内置函数。</p>
<h2 id="7-1-max、min、avg"><a href="#7-1-max、min、avg" class="headerlink" title="7.1 max、min、avg"></a>7.1 max、min、avg</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">max() <span class="hljs-comment">#最大值</span><br>min() <span class="hljs-comment">#最小值</span><br>avg() <span class="hljs-comment">#平均值</span><br><br><span class="hljs-comment">#计算每个节点的最大流量值</span><br>max(node_network_receive_bytes_total) by (instance)  <span class="hljs-comment">#这里的by是指定保留哪些字段</span><br><br><span class="hljs-comment">#计算每个节点最近5分钟每个device的最大流量</span><br>max(rate(node_network_receive_bytes_total[5m])) by (device) <span class="hljs-comment">#这里的by是指定保留哪些字段</span><br></code></pre></td></tr></table></figure>

<p><strong>运算时，有“by”和没“by”的区别</strong></p>
<p><strong>没有“by”</strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-49.png" srcset="/blog/img/loading.gif"></p>
<p><strong>有“by”</strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-50.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-2-sum、count"><a href="#7-2-sum、count" class="headerlink" title="7.2 sum、count"></a>7.2 sum、count</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">sum() <span class="hljs-comment">#求数据值相加的和（总数）</span><br>sum(prometheus_http_requests_total)<br>&#123;&#125; 3951 <span class="hljs-comment">#最近总共请求数为3951次，用于计算返回值的总数（如http请求次数）</span><br><br>count() <span class="hljs-comment">#统计返回值的条数</span><br>count(node_os_version)<br>&#123;&#125; 1 <span class="hljs-comment">#一共返回一条数据，可以用于统计节点数，pod数量等</span><br><br>count_values() <span class="hljs-comment">#对value的个数（行数）进行技术，并将value赋值给自定义标签，从而成为新的label</span><br>count_values(<span class="hljs-string">&quot;node_Version&quot;</span>,node_os_version) <span class="hljs-comment">#统计不同的系统版本节点有多少</span><br>&#123;node_Version=<span class="hljs-string">&quot;7&quot;</span>&#125; 1<br></code></pre></td></tr></table></figure>

<p><strong><code>sum(prometheus_http_requests_total)</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-56.png" srcset="/blog/img/loading.gif"></p>
<p><strong><code>count(node_os_version)</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-57.png" srcset="/blog/img/loading.gif"></p>
<p><strong><code>count_values(&quot;node_Version&quot;,node_os_version)</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-58.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-3-abs、absent"><a href="#7-3-abs、absent" class="headerlink" title="7.3 abs、absent"></a>7.3 abs、absent</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">abs() <span class="hljs-comment">#返回指标数据的值</span><br>abs(sum(prometheus_http_requests_total&#123;handler=<span class="hljs-string">&quot;/metrics&quot;</span>&#125;))<br><br>absent() <span class="hljs-comment">#如果监控项有数据就返回空，没有数据返回1。可用于对监控项设置告警通知（如果返回值等于1就触发告警通知）</span><br>absent(sum(prometheus_http_requests_total&#123;handler=<span class="hljs-string">&quot;/metrics&quot;</span>&#125;))<br></code></pre></td></tr></table></figure>

<p><strong><code>abs(sum(prometheus_http_requests_total&#123;handler=&quot;/metrics&quot;&#125;))</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-53.png" srcset="/blog/img/loading.gif"></p>
<p><strong><code>absent(sum(prometheus_http_requests_total&#123;handler=&quot;/metrics&quot;&#125;))</code></strong></p>
<p><strong>有数据</strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-54.png" srcset="/blog/img/loading.gif"></p>
<p><strong>没有数据</strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-55.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-4-stddev、stdvar"><a href="#7-4-stddev、stdvar" class="headerlink" title="7.4 stddev、stdvar"></a>7.4 stddev、stdvar</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">stddev() <span class="hljs-comment">#求标准差</span><br>stddev(prometheus_http_requests_total)<br><br>sedvar() <span class="hljs-comment">#求方差</span><br>stdvar(prometheus_http_requests_total)<br></code></pre></td></tr></table></figure>

<p><strong><code>stddev(prometheus_http_requests_total)</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-51.png" srcset="/blog/img/loading.gif"></p>
<p><strong><code>stdvar(prometheus_http_request_total)</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-52.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-5-topk、bottomk"><a href="#7-5-topk、bottomk" class="headerlink" title="7.5 topk、bottomk"></a>7.5 topk、bottomk</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">topk() <span class="hljs-comment">#样本值排名最大的N个数据，对每一个时间点都只取前3高的数据，那么这样做可能会造成单个及其的采集数据不连贯。使用topk一般都是为了做瞬时报警。</span><br>topk(6,prometheus_http_requests_total) <span class="hljs-comment">#取从大到小的前6个</span><br><br>bottomk() <span class="hljs-comment">#样本值排名最小的N个数据</span><br>bottomk(6,prometheus_http_requests_total) <span class="hljs-comment">#取从小到大的前6个</span><br></code></pre></td></tr></table></figure>

<p><strong><code>topk(6,prometheus_http_requests_total)</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-60.png" srcset="/blog/img/loading.gif"></p>
<p><strong><code>bottomk(6,prometheus_http_requests_total)</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-61.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-6-rate、irate"><a href="#7-6-rate、irate" class="headerlink" title="7.6 rate、irate"></a>7.6 rate、irate</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">rate() <span class="hljs-comment">#专门搭配counter数据使用函数，rate会取指定时间范围内所有数据点，算出一组速率，然后取平均值作为结果，适合用于计算数据相对平稳的数据</span><br>rate(prometheus_http_requests_total[5m])<br>rate(node_network_receive_bytes_total[5m])<br><br>irate() <span class="hljs-comment">#专门搭配counter数据类型使用函数，irate取的是在指定时间范围内的最近两个数据点来算速率，适合计算数据变化比较大的数据，显示的数据相对比较准确，所以官网说：”irate函数适合快速变化的计数器（counter），而rate适合缓慢变化的计数器（counter）</span><br>irate(prometheus_http_requests_total[5m])<br>irate(node_network_receive_bytes_total[5m])<br></code></pre></td></tr></table></figure>

<p><strong><code>rate(prometheus_http_requests_total[5m])</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-59.png" srcset="/blog/img/loading.gif"></p>
<p><strong><code>rate(node_network_receive_byte_total[5m])</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-62.png" srcset="/blog/img/loading.gif"></p>
<p><strong><code>irate(prometheus_http_requests_total[5m])</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-63.png" srcset="/blog/img/loading.gif"></p>
<p><strong><code>irate(node_network_receive_byte_total[5m])</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-64.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-7-by、witchout"><a href="#7-7-by、witchout" class="headerlink" title="7.7 by、witchout"></a>7.7 by、witchout</h2><p>without用于从计算结果中移除列举的标签，而保留其它标签。by则正好相反，结果向量中只保留列出的标签，其余标签则移除。通过without和by可以按照样本的问题对数据进行聚合。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">by <span class="hljs-comment">#在计算结果中，值保留by指定的标签的值，并移除其他所有的</span><br>sum(rate(node_network_receive_packets_total&#123;instalce=~<span class="hljs-string">&quot;.*&quot;</span>&#125;[10m])) by (instance)<br>sum(rate(node_memory_MemFree_bytes[5m])) by (increase)<br><br>without <span class="hljs-comment">#从计算结果中移除列举的instance,job标签，保留其他标签</span><br>sum(prometheus_http_requests_total) without (instancce,job)<br></code></pre></td></tr></table></figure>

<p><strong><code>sum(rate(node_network_receive_packets_total&#123;instalce=~&quot;.*&quot;&#125;[10m])) by (instance)</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-65.png" srcset="/blog/img/loading.gif"></p>
<p><strong><code>sum(rate(node_memory_MemFree_bytes[5m])) by (increase)</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-66.png" srcset="/blog/img/loading.gif"></p>
<p><strong><code>sum(prometheus_http_requests_total) without (instancce,job)</code></strong></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-67.png" srcset="/blog/img/loading.gif"></p>
<h2 id="7-8-计算Counter指标增长率"><a href="#7-8-计算Counter指标增长率" class="headerlink" title="7.8 计算Counter指标增长率"></a>7.8 计算Counter指标增长率</h2><p>我们知道Counter类型的监控指标其特点是只增不减，在没有发生重置（如服务器重启，应用重启）的情况下其样本值应该是不断增大的。为了能够更直观的表示样本数据的变化剧烈情况，需要计算样本的增长速率。</p>
<p>如下图所示，样本增长率反映出了样本变化的剧烈程度：</p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-75.png" srcset="/blog/img/loading.gif"></p>
<p>increase(v range-vector)函数是PromQL中提供的众多内置函数之一。其中参数v是一个范围向量，<code>increase()</code>函数获取范围向量中的第一个后最后一个样本并返回其增长量。因此，可以通过以下表达式Counter类型指标的增长率：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">increase</span><span class="hljs-params">(node_cpu_seconds_total[<span class="hljs-number">2</span>m])</span></span> / <span class="hljs-number">120</span><br></code></pre></td></tr></table></figure>

<p>这里通过<code>node_cpu_seconds_total[2m]</code>获取时间序列最近两分钟的所有样本，increase计算出最近两分钟的增长量，最后除以时间120秒得到<code>node_cpu_seconds_total</code>样本在最近两分钟的平均增长率。并且这个值也近似于主机节点最近两分钟内的平均CPU使用率。</p>
<p>除了使用increase函数以外，PromQL中还直接内置了<code>rate(v range-vector)</code>函数，rate函数可以直接计算区间向量v在时间窗口内平均增长速率。因此，通过以下表达式可以得到与increase函数相同的结果：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">rate</span><span class="hljs-params">(node_cpu_seconds_total[<span class="hljs-number">2</span>m])</span></span><br></code></pre></td></tr></table></figure>

<p>需要注意的是使用<code>rate()</code>或者<code>increase()</code>函数去计算样本的平均增长速率，容易陷入“长尾问题”当中，其无法反应在时间窗口内样本数据的突发变化。 例如，对于主机而言在2分钟的时间窗口内，可能在某一个由于访问量或者其它问题导致CPU占用100%的情况，但是通过计算在时间窗口内的平均增长率却无法反应出该问题。</p>
<p>为了解决该问题，PromQL提供了另外一个灵敏度更高的函数<code>irate(v range-vector)</code>。irate同样用于计算区间向量的计算率，但是其反应出的是瞬时增长率。irate函数是通过区间向量中最后两个两本数据来计算区间向量的增长速率。这种方式可以避免在时间窗口范围内的“长尾问题”，并且体现出更好的灵敏度，通过irate函数绘制的图标能够更好的反应样本数据的瞬时变化状态。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">irate</span><span class="hljs-params">(node_cpu_seconds_total[<span class="hljs-number">2</span>m])</span></span><br></code></pre></td></tr></table></figure>

<p>irate函数相比于rate函数提供了更高的灵敏度，不过当需要分析长期趋势或者在告警规则中，irate的这种灵敏度反而容易造成干扰。因此在长期趋势分析或者告警中更推荐使用rate函数。</p>
<h3 id="7-8-1-举例：CPU的使用率"><a href="#7-8-1-举例：CPU的使用率" class="headerlink" title="7.8.1 举例：CPU的使用率"></a>7.8.1 举例：CPU的使用率</h3><p>总的来说，CPU使用率的计算方法为：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-number">100</span><span class="hljs-meta">%</span>-<span class="hljs-comment">(cpu空闲时间/cpu总时间)</span><br></code></pre></td></tr></table></figure>

<p>那我么如何获取“cpu空闲时间”和“cpu总时间”呢？</p>
<p>下面一步一步来：</p>
<ol>
<li>我们知道<code>node_cpu_seconds_total</code>是我们需要使用的key name。但是输入到prometheus里意义不大，得不到我们想要的。</li>
</ol>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-76.png" srcset="/blog/img/loading.gif"></p>
<ol start="2">
<li>我们把“idle”空闲的CPU时间和全部CPU时间都过滤出来。</li>
</ol>
<p>注意：key后面要加<code>&#123;&#125;</code></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c">公式<span class="hljs-number">1</span>：node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;<br>公式<span class="hljs-number">2</span>：node_cpu_seconds_total <span class="hljs-meta">#全部CPU的增量</span><br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-77.png" srcset="/blog/img/loading.gif"></p>
<ol start="3">
<li>使用<code>increase()</code>把<code>node_cpu_seconds_total&#123;mode=&#39;idle&#39;&#125;</code>包起来，这样我们得到了一个关于cpu的增量。同时在函数的里加上我们需要的时间，比如一分钟。最后我么就得到了CPU在空闲时间的一分钟增量了。</li>
</ol>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs prolog">公式<span class="hljs-number">1</span>：increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[<span class="hljs-number">1</span>m])<br>公式<span class="hljs-number">2</span>：increase(node_cpu_seconds_total[<span class="hljs-number">1</span>m]) #全部<span class="hljs-symbol">CPU</span>一分钟的增量<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-78.png" srcset="/blog/img/loading.gif"></p>
<p>注意：因为现在的服务多数都是多核的服务器，在prometheus里会看到有很多条曲线（代表不同核）的曲线图。但是曲线太多，又会显得太混杂，所以我们需要进一步加强公式。</p>
<ol start="4">
<li>使用<code>sum()</code>函数将多个核的数值都加起来。然后我们就看到曲线图里只有一条关于所有CPU在一分钟的增量了。</li>
</ol>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs axapta">公式<span class="hljs-number">1</span>：<span class="hljs-keyword">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[<span class="hljs-number">1</span>m]))<br>公式<span class="hljs-number">2</span>：<span class="hljs-keyword">sum</span>(increase(node_cpu_seconds_total[<span class="hljs-number">1</span>m])) <span class="hljs-meta">#全部CPU一分钟的增量</span><br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-79.png" srcset="/blog/img/loading.gif"></p>
<p>但是这里会出现一个问题，原本的监控是监控多台服务器的，采集的数据自然是多台服务器的数据。但是怎么会现在变成一条曲线呢？</p>
<p>原因是出自于<code>sum()</code>这个函数，它会将所有的数据都加起来。不光将一台服务器的所有CPU都加在一起了，还将所有服务器的CPU也加在一起，这样的话就变成了服务器集群总CPU平均值了。如何解决？看下一步。</p>
<ol start="5">
<li>使用“instance”关键字将所有实例拆分出来。这样就可以解决由于<code>sum()</code>函数将所有服务器的数据相加的问题了。曲线图里就能看到由多台主机形成的曲线图了。</li>
</ol>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs axapta">公式<span class="hljs-number">1</span>：<span class="hljs-keyword">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[<span class="hljs-number">1</span>m])) <span class="hljs-keyword">by</span> (instance)<br>公式<span class="hljs-number">2</span>：<span class="hljs-keyword">sum</span>(increase(node_cpu_seconds_total[<span class="hljs-number">1</span>m])) <span class="hljs-keyword">by</span> (instance) <span class="hljs-meta">#所有服务器全部CPU一分钟的增量</span><br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-80.png" srcset="/blog/img/loading.gif"></p>
<ol start="6">
<li>算出“cpu空闲时间/cpu总时间”的值，得出空闲CPU的百分比。</li>
</ol>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">sum(<span class="hljs-name">increase</span>(<span class="hljs-name">node_cpu_seconds_total</span>&#123;mode=&#x27;idle&#x27;&#125;[<span class="hljs-number">1</span>m])) by (<span class="hljs-name">instance</span>) / sum(<span class="hljs-name">increase</span>(<span class="hljs-name">node_cpu_seconds_total</span>[<span class="hljs-number">1</span>m])) by (<span class="hljs-name">instance</span>)<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-81.png" srcset="/blog/img/loading.gif"></p>
<ol start="7">
<li>用1减去空闲CPU百分比再乘100，算出CPU在一分钟的使用率。</li>
</ol>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(<span class="hljs-number">1</span> - (<span class="hljs-name">sum</span>(<span class="hljs-name">increase</span>(<span class="hljs-name">node_cpu_seconds_total</span>&#123;mode=&#x27;idle&#x27;&#125;[<span class="hljs-number">1</span>m])) by (<span class="hljs-name">instance</span>) / sum(<span class="hljs-name">increase</span>(<span class="hljs-name">node_cpu_seconds_total</span>[<span class="hljs-number">1</span>m])) by (<span class="hljs-name">instance</span>))) * <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-82.png" srcset="/blog/img/loading.gif"></p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-83.png" srcset="/blog/img/loading.gif"></p>
<p>举一反三：</p>
<p>获取cpu其他状态的空闲值</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-meta">#获取mode=user</span><br><span class="hljs-keyword">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;user&quot;</span>&#125;[<span class="hljs-number">1</span>m])) <span class="hljs-keyword">by</span> (instance) / <span class="hljs-keyword">sum</span>(increase(node_cpu_seconds_total[<span class="hljs-number">1</span>m])) <span class="hljs-keyword">by</span> (instance)<br><br><span class="hljs-meta">#获取mode=system</span><br><span class="hljs-keyword">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;system&quot;</span>&#125;[<span class="hljs-number">1</span>m])) <span class="hljs-keyword">by</span> (instance) / <span class="hljs-keyword">sum</span>(increase(node_cpu_seconds_total[<span class="hljs-number">1</span>m])) <span class="hljs-keyword">by</span> (instance)<br><br><span class="hljs-meta">#获取mode=iowait</span><br><span class="hljs-keyword">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;iowait&quot;</span>&#125;[<span class="hljs-number">1</span>m])) <span class="hljs-keyword">by</span> (instance) / <span class="hljs-keyword">sum</span>(increase(node_cpu_seconds_total[<span class="hljs-number">1</span>m])) <span class="hljs-keyword">by</span> (instance)<br></code></pre></td></tr></table></figure>

<h2 id="7-9-预测Gauge指标变化趋势"><a href="#7-9-预测Gauge指标变化趋势" class="headerlink" title="7.9 预测Gauge指标变化趋势"></a>7.9 预测Gauge指标变化趋势</h2><p>在一般情况下，系统管理员为了确保业务的持续可用运行，会针对服务器的资源设置相应的告警阈值。例如，当磁盘空间只剩512MB时向相关人员发送告警通知。 这种基于阈值的告警模式对于当资源用量是平滑增长的情况下是能够有效的工作的。 但是如果资源不是平滑变化的呢？ 比如有些某些业务增长，存储空间的增长速率提升了高几倍。这时，如果基于原有阈值去触发告警，当系统管理员接收到告警以后可能还没来得及去处理问题，系统就已经不可用了。 因此阈值通常来说不是固定的，需要定期进行调整才能保证该告警阈值能够发挥去作用。 那么还有没有更好的方法吗？</p>
<p>PromQL中内置的<code>predict_linear(v range-vector, t scalar) </code>函数可以帮助系统管理员更好的处理此类情况，predict_linear函数可以预测时间序列v在t秒后的值。它基于简单线性回归的方式，对时间窗口内的样本数据进行统计，从而可以对时间序列的变化趋势做出预测。例如，基于2小时的样本数据，来预测主机可用磁盘空间的是否在4个小时之后的剩余情况，可以使用如下表达式：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">predict_linear</span>(node_filesystem_free_bytes&#123;job=<span class="hljs-string">&quot;node&quot;</span>&#125;[<span class="hljs-number">2</span>h], <span class="hljs-number">4</span> * <span class="hljs-number">3600</span>)<br></code></pre></td></tr></table></figure>

<h2 id="7-10-统计Histogram指标的分位数"><a href="#7-10-统计Histogram指标的分位数" class="headerlink" title="7.10 统计Histogram指标的分位数"></a>7.10 统计Histogram指标的分位数</h2><p>我们之前介绍了Prometheus的四种监控指标类型，其中Histogram和Summary都可以同于统计和分析数据的分布情况。区别在于Summary是直接在客户端计算了数据分布的分位数情况。而Histogram的分位数计算需要通过histogram_quantile(φ float, b instant-vector)函数进行计算。其中φ（0&lt;φ&lt;1）表示需要计算的分位数，如果需要计算中位数φ取值为0.5，以此类推即可。</p>
<p>以指标prometheus_http_request_duration_seconds_bucket为例：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># HELP prometheus_http_request_duration_seconds Histogram of latencies for HTTP requests.</span><br><span class="hljs-comment"># TYPE prometheus_http_request_duration_seconds histogram</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>,le=<span class="hljs-string">&quot;0.1&quot;</span>&#125; <span class="hljs-number">1</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>,le=<span class="hljs-string">&quot;0.2&quot;</span>&#125; <span class="hljs-number">1</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>,le=<span class="hljs-string">&quot;0.4&quot;</span>&#125; <span class="hljs-number">1</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>,le=<span class="hljs-string">&quot;1&quot;</span>&#125; <span class="hljs-number">1</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>,le=<span class="hljs-string">&quot;3&quot;</span>&#125; <span class="hljs-number">1</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>,le=<span class="hljs-string">&quot;8&quot;</span>&#125; <span class="hljs-number">1</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>,le=<span class="hljs-string">&quot;20&quot;</span>&#125; <span class="hljs-number">1</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>,le=<span class="hljs-string">&quot;60&quot;</span>&#125; <span class="hljs-number">1</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>,le=<span class="hljs-string">&quot;120&quot;</span>&#125; <span class="hljs-number">1</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>,le=<span class="hljs-string">&quot;+Inf&quot;</span>&#125; <span class="hljs-number">1</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_sum</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>&#125; <span class="hljs-number">2</span>.<span class="hljs-number">0809</span>e-<span class="hljs-number">05</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_count</span>&#123;handler=<span class="hljs-string">&quot;/-/ready&quot;</span>&#125; <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>当计算9分位数时，使用如下表达式：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">histogram_quantile</span><span class="hljs-params">(<span class="hljs-number">0.5</span>,prometheus_http_request_duration_seconds_bucket)</span></span><br></code></pre></td></tr></table></figure>

<p>通过对Histogram类型的监控指标，就可以轻松获取样本数据的分布情况。同时分位数的计算，也可以非常方便的用于评判当前监控指标的服务水平。</p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-84.png" srcset="/blog/img/loading.gif"></p>
<p>需要注意的是通过histogram_quantile计算的分位数，并非为精确值，而是通过<code>prometheus_http_request_duration_seconds_bucket</code>和<code>prometheus_http_request_duration_seconds_sum</code></p>
<h2 id="7-12-动态标签替换"><a href="#7-12-动态标签替换" class="headerlink" title="7.12 动态标签替换"></a>7.12 动态标签替换</h2><p>一般来说来说，使用PromQL查询到时间序列后，可视化工具会根据时间序列的标签来渲染图表。例如通过up指标可以获取到当前所有运行的Exporter实例以及其状态：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">up</span>&#123;instance=<span class="hljs-string">&quot;localhost:8080&quot;</span>,job=<span class="hljs-string">&quot;cadvisor&quot;</span>&#125;    <span class="hljs-number">1</span><br><span class="hljs-attribute">up</span>&#123;instance=<span class="hljs-string">&quot;localhost:9090&quot;</span>,job=<span class="hljs-string">&quot;prometheus&quot;</span>&#125;    <span class="hljs-number">1</span><br><span class="hljs-attribute">up</span>&#123;instance=<span class="hljs-string">&quot;localhost:9100&quot;</span>,job=<span class="hljs-string">&quot;node&quot;</span>&#125;    <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>这是可视化工具渲染图标时可能根据，instance和job的值进行渲染，为了能够让客户端的图标更具有可读性，可以通过label_replace标签为时间序列添加额外的标签。label_replace的具体参数如下：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">label<span class="hljs-constructor">_replace(<span class="hljs-params">v</span> <span class="hljs-params">instant</span>-<span class="hljs-params">vector</span>, <span class="hljs-params">dst_label</span> <span class="hljs-params">string</span>, <span class="hljs-params">replacement</span> <span class="hljs-params">string</span>, <span class="hljs-params">src_label</span> <span class="hljs-params">string</span>, <span class="hljs-params">regex</span> <span class="hljs-params">string</span>)</span><br></code></pre></td></tr></table></figure>

<p>该函数会依次对v中的每一条时间序列进行处理，通过regex匹配src_label的值，并将匹配部分relacement写入到dst_label标签中。如下所示：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">label_replace</span><span class="hljs-params">(up, <span class="hljs-string">&quot;host&quot;</span>, <span class="hljs-string">&quot;$1&quot;</span>, <span class="hljs-string">&quot;instance&quot;</span>,  <span class="hljs-string">&quot;(.*):.*&quot;</span>)</span></span><br></code></pre></td></tr></table></figure>

<p>函数处理后，时间序列将包含一个host标签，host标签的值为Exporter实例的IP地址：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">up</span>&#123;host=<span class="hljs-string">&quot;localhost&quot;</span>,instance=<span class="hljs-string">&quot;localhost:8080&quot;</span>,job=<span class="hljs-string">&quot;cadvisor&quot;</span>&#125;    <span class="hljs-number">1</span><br><span class="hljs-attribute">up</span>&#123;host=<span class="hljs-string">&quot;localhost&quot;</span>,instance=<span class="hljs-string">&quot;localhost:9090&quot;</span>,job=<span class="hljs-string">&quot;prometheus&quot;</span>&#125;    <span class="hljs-number">1</span><br><span class="hljs-attribute">up</span>&#123;host=<span class="hljs-string">&quot;localhost&quot;</span>,instance=<span class="hljs-string">&quot;localhost:9100&quot;</span>,job=<span class="hljs-string">&quot;node&quot;</span>&#125; <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>除了label_replace以外，Prometheus还提供了label_join函数，该函数可以将时间序列中v多个标签src_label的值，通过separator作为连接符写入到一个新的标签dst_label中:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">label<span class="hljs-constructor">_join(<span class="hljs-params">v</span> <span class="hljs-params">instant</span>-<span class="hljs-params">vector</span>, <span class="hljs-params">dst_label</span> <span class="hljs-params">string</span>, <span class="hljs-params">separator</span> <span class="hljs-params">string</span>, <span class="hljs-params">src_label_1</span> <span class="hljs-params">string</span>, <span class="hljs-params">src_label_2</span> <span class="hljs-params">string</span>, <span class="hljs-operator">...</span>)</span><br></code></pre></td></tr></table></figure>

<p><code>label_replace</code>和<code>label_join</code>函数提供了对时间序列标签的自定义能力，从而能够更好的于客户端或者可视化工具配合。</p>
<h1 id="八、在HTTP-API中使用PromQL"><a href="#八、在HTTP-API中使用PromQL" class="headerlink" title="八、在HTTP API中使用PromQL"></a>八、在HTTP API中使用PromQL</h1><p>Prometheus当前稳定的HTTP API可以通过/api/v1访问。</p>
<h2 id="8-1-格式概览"><a href="#8-1-格式概览" class="headerlink" title="8.1 格式概览"></a>8.1 格式概览</h2><p>Prometheus API使用了JSON格式的响应内容。 当API调用成功后将会返回2xx的HTTP状态码。</p>
<p>反之，当API调用失败时可能返回以下几种不同的HTTP状态码：</p>
<ul>
<li><code>400 Bad Request</code>：当参数缺失或不正确</li>
<li><code>422 Unprocessable Entity</code>：表达式不能被执行（<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc4918#page-78">RFC4918</a>）</li>
<li><code>503 Service Unavailable</code>：查询超时或中止</li>
</ul>
<p>如果在到达API端点之前发生错误，可能会返回其他非<code>2xx</code>状态码。</p>
<p>如果有错误不能阻止请求执行，可能会返回一个警告数组。成功收集的所有数据都将在<code>data</code>字段中返回。</p>
<p>JSON响应格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span> | <span class="hljs-string">&quot;error&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &lt;data&gt;,<br>  <span class="hljs-comment">// Only set if status is &quot;error&quot;. The data field may still hold</span><br>  <span class="hljs-comment">// additional data.</span><br>  <span class="hljs-attr">&quot;errorType&quot;</span>: <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>,<br>  <span class="hljs-attr">&quot;error&quot;</span>: <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>,<br>  <span class="hljs-comment">// Only if there were warnings while executing the request.</span><br>  <span class="hljs-comment">// There will still be data in the data field.</span><br>  <span class="hljs-attr">&quot;warnings&quot;</span>: [<span class="hljs-string">&quot;&lt;string&gt;&quot;</span>]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输入时间戳可以以<a target="_blank" rel="noopener" href="https://www.ietf.org/rfc/rfc3339.txt">RFC3339</a>格式提供；也可以是秒为单位的Unix时间戳，可选的小数位数表示秒精度。输出时间戳总是表示为Unix时间戳（以秒为单位）。</p>
<p>可以重复的查询参数的名称以<code>[]</code>结尾。</p>
<p><code>&lt;series_selector&gt;</code>占位符指的是Prometheus时间序列选择器，例如<code>prometheus_http_requests_total</code>或<code>prometheus_http_requests_total&#123;method=~&quot;(GET|POST)</code>，并且需要进行URL编码。</p>
<p><code>&lt;duration&gt;</code>占位符指的是Prometheus格式的持续时间字符串，修理工为<code>[0-9]+[smhdwy]</code>。例如，<code>5m</code>表示持续时间为5分钟。</p>
<p><code>&lt;bool&gt;</code>占位符指的是布尔值（字符串<code>true</code>和<code>false</code>）。</p>
<p>通过HTTP API我们可以分别通过<code>/api/v1/query</code>和<code>/api/v1/query_range</code>查询PromQL表达式当前或者一定时间范围内的计算结果。</p>
<h2 id="8-2-瞬时数据查询"><a href="#8-2-瞬时数据查询" class="headerlink" title="8.2 瞬时数据查询"></a>8.2 瞬时数据查询</h2><p>通过使用QUERY API我们可以查询PromQL在特定时间点下的计算结果。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /api/v1/query<br>POST /api/v1/query<br></code></pre></td></tr></table></figure>

<ul>
<li><p>URL查询参数：</p>
<ul>
<li><p><code>query=&lt;string&gt;</code>： Prometheus表达式查询字符串。</p>
</li>
<li><p><code>time=&lt;rfc3339 | unix_timestamp&gt;</code>：计算的时间戳，可选。</p>
</li>
<li><p><code>timeout=&lt;duration&gt;</code>：计算的超时时间，可选， 默认为<code>query.timeout</code> 选项的值。</p>
</li>
</ul>
</li>
</ul>
<p>如果省略<code>time</code>参数，则使用当前服务器时间。</p>
<p>可以使用<code>POST</code>方法和<code>Content-Type: application/x-www-form-urlencoded</code>请求头直接在请求体中对这些参数进行URL编码。这在指定可能违反服务器端URL字符限制的大型查询时非常有用。</p>
<p>查询结果的<code>data</code>部分格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;resultType&quot;</span>: <span class="hljs-string">&quot;matrix&quot;</span> | <span class="hljs-string">&quot;vector&quot;</span> | <span class="hljs-string">&quot;scalar&quot;</span> | <span class="hljs-string">&quot;string&quot;</span>,<br>  <span class="hljs-attr">&quot;result&quot;</span>: &lt;value&gt;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>&lt;value&gt;</code>指的是查询结果数据，根据结果类型，该数据具有不同的格式。</p>
<p>例如使用以下表达式查询表达式up在时间点2015-07-01T20:10:51.781Z的计算结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl &#x27;http:<span class="hljs-comment">//localhost:9090/api/v1/query?query=up&amp;time=2015-07-01T20:10:51.781Z&#x27;</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;resultType&quot;</span>: <span class="hljs-string">&quot;vector&quot;</span>,<br>    <span class="hljs-attr">&quot;result&quot;</span>: []<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="8-3-范围数据查询"><a href="#8-3-范围数据查询" class="headerlink" title="8.3 范围数据查询"></a>8.3 范围数据查询</h2><p>通过使用QUERY_RANGE API我们可以计算一段时间范围内的计算结果。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1/query_range<br>POST <span class="hljs-regexp">/api/</span>v1/query_range<br></code></pre></td></tr></table></figure>

<p>URL查询参数：</p>
<ul>
<li><code>query=&lt;string&gt;</code>： Prometheus表达式查询字符串。</li>
<li><code>start=&lt;rfc3339 | unix_timestamp&gt;</code>：启始时间戳。</li>
<li><code>end=&lt;rfc3339 | unix_timestamp&gt;</code>：结束时间戳。</li>
<li><code>time=&lt;rfc3339 | unix_timestamp&gt;</code>：计算的时间戳，可选。</li>
<li><code>timeout=&lt;duration&gt;</code>：计算的超时时间，可选， 默认为<code>query.timeout</code> 选项的值。</li>
</ul>
<p>可以使用<code>POST</code>方法和<code>Content-Type: application/x-www-form-urlencoded</code>请求头直接在请求体中对这些参数进行URL编码。这在指定可能违反服务器端URL字符限制的大型查询时非常有用。</p>
<p>查询结果的<code>data</code>部分格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;resultType&quot;</span>: <span class="hljs-string">&quot;matrix&quot;</span>,<br>  <span class="hljs-attr">&quot;result&quot;</span>: &lt;value&gt;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>例如使用以下表达式查询表达式up在30秒范围内以15秒为间隔计算PromQL表达式的结果。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl &#x27;http:<span class="hljs-comment">//localhost:9090/api/v1/query_range?query=up&amp;start=2015-07-01T20:10:30.781Z&amp;end=2015-07-01T20:11:00.781Z&amp;step=15s&#x27;</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;resultType&quot;</span>: <span class="hljs-string">&quot;matrix&quot;</span>,<br>    <span class="hljs-attr">&quot;result&quot;</span>: []<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="8-4-查询元数据"><a href="#8-4-查询元数据" class="headerlink" title="8.4 查询元数据"></a>8.4 查询元数据</h2><p>根据标签选择器查找时间序列</p>
<p>通过使用SERIES API我们可以计算返回与某个标签集合匹配的时间序列列表。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1/series<br>POST <span class="hljs-regexp">/api/</span>v1/series<br></code></pre></td></tr></table></figure>

<p>URL查询参数：</p>
<ul>
<li><code>match[]=&lt;series_selector&gt;</code>：选择要返回的时间序列的序列选择器参数。必须提供至少一个<code>match[]</code>参数。</li>
<li><code>start=&lt;rfc3339 | unix_timestamp&gt;</code>：起始时间戳。</li>
<li><code>end=&lt;rfc3339 | unix_timestamp&gt;</code>：结束时间戳。</li>
</ul>
<p>你可以使用<code>POST</code>方法和<code>Content-Type: application/x-www-form-urlencoded</code>请求头直接在请求体中对这些参数进行URL编码。这在指定可能违反服务器端URL字符限制的大型查询时非常有用。</p>
<p>下面的例子返回所有匹配选择器<code>up</code>或<code>process_start_time_seconds&#123;job=&quot;prometheus&quot;&#125;</code>的序列：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl -g &#x27;http:<span class="hljs-comment">//localhost:9090/api/v1/series?&#x27; --data-urlencode &#x27;match[]=up&#x27; --data-urlencode &#x27;match[]=process_start_time_seconds&#123;job=&quot;prometheus&quot;&#125;&#x27;</span><br>&#123;<br>    <span class="hljs-attr">&quot;status&quot;</span>:<span class="hljs-string">&quot;success&quot;</span>,<br>    <span class="hljs-attr">&quot;data&quot;</span>:[<br>        &#123;<br>            <span class="hljs-attr">&quot;__name__&quot;</span>:<span class="hljs-string">&quot;process_start_time_seconds&quot;</span>,<br>            <span class="hljs-attr">&quot;instance&quot;</span>:<span class="hljs-string">&quot;localhost:9090&quot;</span>,<br>            <span class="hljs-attr">&quot;job&quot;</span>:<span class="hljs-string">&quot;prometheus&quot;</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;__name__&quot;</span>:<span class="hljs-string">&quot;up&quot;</span>,<br>            <span class="hljs-attr">&quot;instance&quot;</span>:<span class="hljs-string">&quot;localhost:9090&quot;</span>,<br>            <span class="hljs-attr">&quot;job&quot;</span>:<span class="hljs-string">&quot;prometheus&quot;</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;__name__&quot;</span>:<span class="hljs-string">&quot;up&quot;</span>,<br>            <span class="hljs-attr">&quot;instance&quot;</span>:<span class="hljs-string">&quot;localhost:9100&quot;</span>,<br>            <span class="hljs-attr">&quot;job&quot;</span>:<span class="hljs-string">&quot;node&quot;</span>&#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="8-5-获取标签名称"><a href="#8-5-获取标签名称" class="headerlink" title="8.5 获取标签名称"></a>8.5 获取标签名称</h2><p>通过使用LABEL API可以返回标签名称列表。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1/labels<br>POST <span class="hljs-regexp">/api/</span>v1/labels<br></code></pre></td></tr></table></figure>

<p>JSON响应的<code>data</code>部分是字符串标签名称的列表。</p>
<p>例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl &#x27;localhost:<span class="hljs-number">9090</span>/api/v1/labels&#x27;<br>&#123;<br>    <span class="hljs-attr">&quot;status&quot;</span>:<span class="hljs-string">&quot;success&quot;</span>,<br>    <span class="hljs-attr">&quot;data&quot;</span>:[<br>        <span class="hljs-string">&quot;__name__&quot;</span>,<br>        <span class="hljs-string">&quot;address&quot;</span>,<br>        <span class="hljs-string">&quot;bios_date&quot;</span>,<br>        <span class="hljs-string">&quot;bios_vendor&quot;</span>,<br>        <span class="hljs-string">&quot;bios_version&quot;</span>,<br>        <span class="hljs-string">&quot;board_name&quot;</span>,<br>        <span class="hljs-string">&quot;board_serial&quot;</span>,<br>        <span class="hljs-string">&quot;board_vendor&quot;</span>,<br>        <span class="hljs-string">&quot;board_version&quot;</span>,<br>        <span class="hljs-string">&quot;branch&quot;</span>,<br>        <span class="hljs-string">&quot;broadcast&quot;</span>,<br>        <span class="hljs-string">&quot;call&quot;</span>,<br>        <span class="hljs-string">&quot;cause&quot;</span>,<br>        <span class="hljs-string">&quot;chassis_asset_tag&quot;</span>,<br>        <span class="hljs-string">&quot;chassis_serial&quot;</span>,<br>        <span class="hljs-string">&quot;chassis_vendor&quot;</span>,<br>        <span class="hljs-string">&quot;chassis_version&quot;</span>,<br>        <span class="hljs-string">&quot;clocksource&quot;</span>,<br>        <span class="hljs-string">&quot;code&quot;</span>,<br>        <span class="hljs-string">&quot;collector&quot;</span>,<br>        <span class="hljs-string">&quot;config&quot;</span>,<br>        <span class="hljs-string">&quot;cpu&quot;</span>,<br>        <span class="hljs-string">&quot;device&quot;</span>,<br>        <span class="hljs-string">&quot;dialer_name&quot;</span>,<br>        <span class="hljs-string">&quot;domainname&quot;</span>,<br>        <span class="hljs-string">&quot;duplex&quot;</span>,<br>        <span class="hljs-string">&quot;endpoint&quot;</span>,<br>        <span class="hljs-string">&quot;event&quot;</span>,<br>        <span class="hljs-string">&quot;fstype&quot;</span>,<br>        <span class="hljs-string">&quot;goversion&quot;</span>,<br>        <span class="hljs-string">&quot;handler&quot;</span>,<br>        <span class="hljs-string">&quot;id&quot;</span>,<br>        <span class="hljs-string">&quot;id_like&quot;</span>,<br>        <span class="hljs-string">&quot;instance&quot;</span>,<br>        <span class="hljs-string">&quot;interval&quot;</span>,<br>        <span class="hljs-string">&quot;ip&quot;</span>,<br>        <span class="hljs-string">&quot;job&quot;</span>,<br>        <span class="hljs-string">&quot;le&quot;</span>,<br>        <span class="hljs-string">&quot;listener_name&quot;</span>,<br>        <span class="hljs-string">&quot;machine&quot;</span>,<br>        <span class="hljs-string">&quot;major&quot;</span>,<br>        <span class="hljs-string">&quot;minor&quot;</span>,<br>        <span class="hljs-string">&quot;mode&quot;</span>,<br>        <span class="hljs-string">&quot;model&quot;</span>,<br>        <span class="hljs-string">&quot;mountpoint&quot;</span>,<br>        <span class="hljs-string">&quot;name&quot;</span>,<br>        <span class="hljs-string">&quot;nodename&quot;</span>,<br>        <span class="hljs-string">&quot;operstate&quot;</span>,<br>        <span class="hljs-string">&quot;path&quot;</span>,<br>        <span class="hljs-string">&quot;power_supply&quot;</span>,<br>        <span class="hljs-string">&quot;pretty_name&quot;</span>,<br>        <span class="hljs-string">&quot;product_name&quot;</span>,<br>        <span class="hljs-string">&quot;product_serial&quot;</span>,<br>        <span class="hljs-string">&quot;product_uuid&quot;</span>,<br>        <span class="hljs-string">&quot;product_version&quot;</span>,<br>        <span class="hljs-string">&quot;quantile&quot;</span>,<br>        <span class="hljs-string">&quot;queue&quot;</span>,<br>        <span class="hljs-string">&quot;reason&quot;</span>,<br>        <span class="hljs-string">&quot;release&quot;</span>,<br>        <span class="hljs-string">&quot;revision&quot;</span>,<br>        <span class="hljs-string">&quot;role&quot;</span>,<br>        <span class="hljs-string">&quot;scrape_job&quot;</span>,<br>        <span class="hljs-string">&quot;serial&quot;</span>,<br>        <span class="hljs-string">&quot;slice&quot;</span>,<br>        <span class="hljs-string">&quot;sysname&quot;</span>,<br>        <span class="hljs-string">&quot;system_vendor&quot;</span>,<br>        <span class="hljs-string">&quot;time_zone&quot;</span>,<br>        <span class="hljs-string">&quot;type&quot;</span>,<br>        <span class="hljs-string">&quot;usage&quot;</span>,<br>        <span class="hljs-string">&quot;uuid&quot;</span>,<br>        <span class="hljs-string">&quot;version&quot;</span>,<br>        <span class="hljs-string">&quot;version_id&quot;</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="8-6-查询标签值"><a href="#8-6-查询标签值" class="headerlink" title="8.6 查询标签值"></a>8.6 查询标签值</h2><p>返回所提供的标签名称的标签值列表：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/label/</span>&lt;label_name&gt;/values<br></code></pre></td></tr></table></figure>

<p>JSON响应的<code>data</code>部分是字符串标签值的列表。</p>
<p>如下示例查询<code>job</code>标签的所有标签值：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl http:<span class="hljs-comment">//localhost:9090/api/v1/label/job/values</span><br>&#123;<br>    <span class="hljs-attr">&quot;status&quot;</span>:<span class="hljs-string">&quot;success&quot;</span>,<br>    <span class="hljs-attr">&quot;data&quot;</span>:[<br>        <span class="hljs-string">&quot;node&quot;</span>,<br>        <span class="hljs-string">&quot;prometheus&quot;</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="8-7-表达式查询结果格式"><a href="#8-7-表达式查询结果格式" class="headerlink" title="8.7 表达式查询结果格式"></a>8.7 表达式查询结果格式</h2><p>表达式查询可以在<code>data</code>部分的<code>result</code>属性中返回以下响应值。<code>&lt;sample_value&gt;</code>占位符是数值类型的采样值。JSON不支持特殊的浮点值，如<code>NaN</code>、<code>Inf</code>和<code>-Inf</code>，因此采样值作为引号包裹的JSON字符串传输，而不是原始数字。</p>
<h3 id="8-7-1-范围向量"><a href="#8-7-1-范围向量" class="headerlink" title="8.7.1 范围向量"></a>8.7.1 范围向量</h3><p>范围向量作为 <code>matrix</code>结果类型返回。对应的<code>result</code>属性格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">[<br>  &#123;<br>    <span class="hljs-attr">&quot;metric&quot;</span>: &#123; <span class="hljs-attr">&quot;&lt;label_name&gt;&quot;</span>: <span class="hljs-string">&quot;&lt;label_value&gt;&quot;</span>, ... &#125;,<br>    <span class="hljs-attr">&quot;values&quot;</span>: [ [ &lt;unix_time&gt;, <span class="hljs-string">&quot;&lt;sample_value&gt;&quot;</span> ], ... ]<br>  &#125;,<br>  ...<br>]<br></code></pre></td></tr></table></figure>

<h3 id="8-7-2-瞬时向量"><a href="#8-7-2-瞬时向量" class="headerlink" title="8.7.2 瞬时向量"></a>8.7.2 瞬时向量</h3><p>瞬时向量作为<code>vector</code>结果类型返回。对应的<code>result</code>属性格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">[<br>  &#123;<br>    <span class="hljs-attr">&quot;metric&quot;</span>: &#123; <span class="hljs-attr">&quot;&lt;label_name&gt;&quot;</span>: <span class="hljs-string">&quot;&lt;label_value&gt;&quot;</span>, ... &#125;,<br>    <span class="hljs-attr">&quot;value&quot;</span>: [ &lt;unix_time&gt;, <span class="hljs-string">&quot;&lt;sample_value&gt;&quot;</span> ]<br>  &#125;,<br>  ...<br>]<br></code></pre></td></tr></table></figure>

<h3 id="8-7-3-标量"><a href="#8-7-3-标量" class="headerlink" title="8.7.3 标量"></a>8.7.3 标量</h3><p>标量结果作为<code>scalar</code>结果类型返回。对应的<code>result</code>属性格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">[ &lt;unix_time&gt;, <span class="hljs-string">&quot;&lt;scalar_value&gt;&quot;</span> ]<br></code></pre></td></tr></table></figure>

<h3 id="8-7-4-字符串"><a href="#8-7-4-字符串" class="headerlink" title="8.7.4 字符串"></a>8.7.4 字符串</h3><p>字符串结果作为<code>string</code>结果类型返回。对应的<code>result</code>属性格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">[ &lt;unix_time&gt;, <span class="hljs-string">&quot;&lt;string_value&gt;&quot;</span> ]<br></code></pre></td></tr></table></figure>

<h3 id="8-7-5-目标"><a href="#8-7-5-目标" class="headerlink" title="8.7.5 目标"></a>8.7.5 目标</h3><p>返回Prometheus目标发现的当前状态概览：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1/targets<br></code></pre></td></tr></table></figure>

<p>活动的（active）和丢弃的（dropped）目标都是响应的一部分。<code>labels</code> 表示重新标记后的标签集合。<code>discoveredLabels</code> 表示在重新标记之前的服务发现期间检索到的未修改的标签。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl http:<span class="hljs-comment">//localhost:9090/api/v1/targets</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;activeTargets&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;discoveredLabels&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;__address__&quot;</span>: <span class="hljs-string">&quot;localhost:9100&quot;</span>,<br>          <span class="hljs-attr">&quot;__metrics_path__&quot;</span>: <span class="hljs-string">&quot;/metrics&quot;</span>,<br>          <span class="hljs-attr">&quot;__scheme__&quot;</span>: <span class="hljs-string">&quot;http&quot;</span>,<br>          <span class="hljs-attr">&quot;__scrape_interval__&quot;</span>: <span class="hljs-string">&quot;15s&quot;</span>,<br>          <span class="hljs-attr">&quot;__scrape_timeout__&quot;</span>: <span class="hljs-string">&quot;10s&quot;</span>,<br>          <span class="hljs-attr">&quot;job&quot;</span>: <span class="hljs-string">&quot;node&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;labels&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;instance&quot;</span>: <span class="hljs-string">&quot;localhost:9100&quot;</span>,<br>          <span class="hljs-attr">&quot;job&quot;</span>: <span class="hljs-string">&quot;node&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;scrapePool&quot;</span>: <span class="hljs-string">&quot;node&quot;</span>,<br>        <span class="hljs-attr">&quot;scrapeUrl&quot;</span>: <span class="hljs-string">&quot;http://localhost:9100/metrics&quot;</span>,<br>        <span class="hljs-attr">&quot;globalUrl&quot;</span>: <span class="hljs-string">&quot;http://CentOS7.9:9100/metrics&quot;</span>,<br>        <span class="hljs-attr">&quot;lastError&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-attr">&quot;lastScrape&quot;</span>: <span class="hljs-string">&quot;2023-01-06T16:31:21.214177719+08:00&quot;</span>,<br>        <span class="hljs-attr">&quot;lastScrapeDuration&quot;</span>: <span class="hljs-number">0.008274684</span>,<br>        <span class="hljs-attr">&quot;health&quot;</span>: <span class="hljs-string">&quot;up&quot;</span>,<br>        <span class="hljs-attr">&quot;scrapeInterval&quot;</span>: <span class="hljs-string">&quot;15s&quot;</span>,<br>        <span class="hljs-attr">&quot;scrapeTimeout&quot;</span>: <span class="hljs-string">&quot;10s&quot;</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;discoveredLabels&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;__address__&quot;</span>: <span class="hljs-string">&quot;localhost:9090&quot;</span>,<br>          <span class="hljs-attr">&quot;__metrics_path__&quot;</span>: <span class="hljs-string">&quot;/metrics&quot;</span>,<br>          <span class="hljs-attr">&quot;__scheme__&quot;</span>: <span class="hljs-string">&quot;http&quot;</span>,<br>          <span class="hljs-attr">&quot;__scrape_interval__&quot;</span>: <span class="hljs-string">&quot;15s&quot;</span>,<br>          <span class="hljs-attr">&quot;__scrape_timeout__&quot;</span>: <span class="hljs-string">&quot;10s&quot;</span>,<br>          <span class="hljs-attr">&quot;job&quot;</span>: <span class="hljs-string">&quot;prometheus&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;labels&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;instance&quot;</span>: <span class="hljs-string">&quot;localhost:9090&quot;</span>,<br>          <span class="hljs-attr">&quot;job&quot;</span>: <span class="hljs-string">&quot;prometheus&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;scrapePool&quot;</span>: <span class="hljs-string">&quot;prometheus&quot;</span>,<br>        <span class="hljs-attr">&quot;scrapeUrl&quot;</span>: <span class="hljs-string">&quot;http://localhost:9090/metrics&quot;</span>,<br>        <span class="hljs-attr">&quot;globalUrl&quot;</span>: <span class="hljs-string">&quot;http://CentOS7.9:9090/metrics&quot;</span>,<br>        <span class="hljs-attr">&quot;lastError&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-attr">&quot;lastScrape&quot;</span>: <span class="hljs-string">&quot;2023-01-06T16:31:30.043732383+08:00&quot;</span>,<br>        <span class="hljs-attr">&quot;lastScrapeDuration&quot;</span>: <span class="hljs-number">0.003546879</span>,<br>        <span class="hljs-attr">&quot;health&quot;</span>: <span class="hljs-string">&quot;up&quot;</span>,<br>        <span class="hljs-attr">&quot;scrapeInterval&quot;</span>: <span class="hljs-string">&quot;15s&quot;</span>,<br>        <span class="hljs-attr">&quot;scrapeTimeout&quot;</span>: <span class="hljs-string">&quot;10s&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-attr">&quot;droppedTargets&quot;</span>: []<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-7-6-规则"><a href="#8-7-6-规则" class="headerlink" title="8.7.6 规则"></a>8.7.6 规则</h3><p><code>/rules</code> API返回当前加载的告警和记录规则列表。此外，它还返回由每个告警规则的Prometheus实例触发的当前活动告警。</p>
<p>由于<code>/rules</code>端点是相当新的，所以它不具有与总体API v1相同的稳定性保证。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1/rules<br></code></pre></td></tr></table></figure>

<p>URL查询参数： <code>- type=alert|record</code>：只返回警报规则（如<code>type=alert</code>）或记录规则（如<code>type=record</code>）。当该参数不存在或为空时，不做任何过滤。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl http:<span class="hljs-comment">//localhost:9090/api/v1/rules</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;groups&quot;</span>: []<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-7-7-告警"><a href="#8-7-7-告警" class="headerlink" title="8.7.7 告警"></a>8.7.7 告警</h3><p><code>/alerts</code> 端点返回所有活动告警列表。</p>
<p>由于<code>/alerts</code>端点是相当新的，所以它不具有与总体API v1相同的稳定性保证。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1/alerts<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl http:<span class="hljs-comment">//localhost:9090/api/v1/alerts</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;alerts&quot;</span>: []<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-7-8-查询目标元数据"><a href="#8-7-8-查询目标元数据" class="headerlink" title="8.7.8 查询目标元数据"></a>8.7.8 查询目标元数据</h3><p>下面的端点返回关于目标当前抓取的指标的元数据。这是<strong>实验性的</strong>，将来可能会改变。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/targets/m</span>etadata<br></code></pre></td></tr></table></figure>

<p>URL查询参数：</p>
<ul>
<li><code>match_target=&lt;label_selectors&gt;</code>：通过标签集合匹配目标的标签选择器。如果留空，则选择所有目标。</li>
<li><code>metric=&lt;string&gt;</code>：用于检索元数据的指标名称。如果保持为空，则检索所有指标元数据。</li>
<li><code>limit=&lt;number&gt;</code>：要匹配的最大目标数量。</li>
</ul>
<p>查询结果的<code>data</code>部分包含一个对象列表，其中包含指标元数据和目标标签集合。</p>
<p>下面的示例返回来自前两个目标（标签为<code>job=&quot;prometheus&quot;</code>）的<code>go_goroutines</code>度量的所有元数据条目：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl -G http:<span class="hljs-comment">//localhost:9090/api/v1/targets/metadata \</span><br>    --data-urlencode &#x27;metric=go_goroutines&#x27; \<br>    --data-urlencode &#x27;match_target=&#123;job=<span class="hljs-attr">&quot;prometheus&quot;</span>&#125;&#x27; \<br>    --data-urlencode &#x27;limit=<span class="hljs-number">2</span>&#x27;<br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: [<br>    &#123;<br>      <span class="hljs-attr">&quot;target&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;instance&quot;</span>: <span class="hljs-string">&quot;localhost:9090&quot;</span>,<br>        <span class="hljs-attr">&quot;job&quot;</span>: <span class="hljs-string">&quot;prometheus&quot;</span><br>      &#125;,<br>      <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;gauge&quot;</span>,<br>      <span class="hljs-attr">&quot;help&quot;</span>: <span class="hljs-string">&quot;Number of goroutines that currently exist.&quot;</span>,<br>      <span class="hljs-attr">&quot;unit&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下面的示例返回所有具有 <code>instance=&quot;127.0.0.1:9090</code>标签的目标的所有指标的元数据。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl -G http:<span class="hljs-comment">//localhost:9090/api/v1/targets/metadata \</span><br>    --data-urlencode &#x27;match_target=&#123;instance=<span class="hljs-attr">&quot;127.0.0.1:9090&quot;</span>&#125;&#x27;<br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: []<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-7-9-告警管理器"><a href="#8-7-9-告警管理器" class="headerlink" title="8.7.9 告警管理器"></a>8.7.9 告警管理器</h3><p>返回Prometheus告警管理器发现的当前状态概览：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1/alertmanagers<br></code></pre></td></tr></table></figure>

<p>活动的（active）和丢弃的（dropped）告警管理器都是响应的一部分。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl http:<span class="hljs-comment">//localhost:9090/api/v1/alertmanagers</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;activeAlertmanagers&quot;</span>: [],<br>    <span class="hljs-attr">&quot;droppedAlertmanagers&quot;</span>: []<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-7-10-状态"><a href="#8-7-10-状态" class="headerlink" title="8.7.10 状态"></a>8.7.10 状态</h3><p>返回当前Prometheus配置。</p>
<p>返回当前加载的配置文件：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/status/</span>config<br></code></pre></td></tr></table></figure>

<p>配置作为转储YAML文件返回。由于YAML库的限制，所以不包括YAML注释。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> curl http://localhost:9090/api/v1/status/config</span><br>&#123;<br>  &quot;status&quot;: &quot;success&quot;,<br>  &quot;data&quot;: &#123;<br>    &quot;yaml&quot;: &quot;global:\n  scrape_interval: 15s\n  scrape_timeout: 10s\n  evaluation_interval: 15s\nalerting:\n  alertmanagers:\n  - follow_redirects: true\n    enable_http2: true\n    scheme: http\n    timeout: 10s\n    api_version: v2\n    static_configs:\n    - targets: []\nscrape_configs:\n- job_name: prometheus\n  honor_timestamps: true\n  scrape_interval: 15s\n  scrape_timeout: 10s\n  metrics_path: /metrics\n  scheme: http\n  follow_redirects: true\n  enable_http2: true\n  static_configs:\n  - targets:\n    - localhost:9090\n- job_name: node\n  honor_timestamps: true\n  scrape_interval: 15s\n  scrape_timeout: 10s\n  metrics_path: /metrics\n  scheme: http\n  follow_redirects: true\n  enable_http2: true\n  static_configs:\n  - targets:\n    - localhost:9100\n&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-7-11-选项"><a href="#8-7-11-选项" class="headerlink" title="8.7.11 选项"></a>8.7.11 选项</h3><p>返回Prometheus配置的选项值：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/status/</span>flags<br></code></pre></td></tr></table></figure>

<p>所有值都是结果 <code>string</code>类型。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl http:<span class="hljs-comment">//localhost:9090/api/v1/status/flags</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;alertmanager.notification-queue-capacity&quot;</span>: <span class="hljs-string">&quot;10000&quot;</span>,<br>    <span class="hljs-attr">&quot;alertmanager.timeout&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-attr">&quot;config.file&quot;</span>: <span class="hljs-string">&quot;/apps/prometheus/prometheus.yml&quot;</span>,<br>    <span class="hljs-attr">&quot;enable-feature&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-attr">&quot;log.format&quot;</span>: <span class="hljs-string">&quot;logfmt&quot;</span>,<br>    <span class="hljs-attr">&quot;log.level&quot;</span>: <span class="hljs-string">&quot;info&quot;</span>,<br>    <span class="hljs-attr">&quot;query.lookback-delta&quot;</span>: <span class="hljs-string">&quot;5m&quot;</span>,<br>    <span class="hljs-attr">&quot;query.max-concurrency&quot;</span>: <span class="hljs-string">&quot;20&quot;</span>,<br>    <span class="hljs-attr">&quot;query.max-samples&quot;</span>: <span class="hljs-string">&quot;50000000&quot;</span>,<br>    <span class="hljs-attr">&quot;query.timeout&quot;</span>: <span class="hljs-string">&quot;2m&quot;</span>,<br>    <span class="hljs-attr">&quot;rules.alert.for-grace-period&quot;</span>: <span class="hljs-string">&quot;10m&quot;</span>,<br>    <span class="hljs-attr">&quot;rules.alert.for-outage-tolerance&quot;</span>: <span class="hljs-string">&quot;1h&quot;</span>,<br>    <span class="hljs-attr">&quot;rules.alert.resend-delay&quot;</span>: <span class="hljs-string">&quot;1m&quot;</span>,<br>    <span class="hljs-attr">&quot;scrape.adjust-timestamps&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>    <span class="hljs-attr">&quot;scrape.discovery-reload-interval&quot;</span>: <span class="hljs-string">&quot;5s&quot;</span>,<br>    <span class="hljs-attr">&quot;scrape.timestamp-tolerance&quot;</span>: <span class="hljs-string">&quot;2ms&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.agent.no-lockfile&quot;</span>: <span class="hljs-string">&quot;false&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.agent.path&quot;</span>: <span class="hljs-string">&quot;data-agent/&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.agent.retention.max-time&quot;</span>: <span class="hljs-string">&quot;0s&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.agent.retention.min-time&quot;</span>: <span class="hljs-string">&quot;0s&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.agent.wal-compression&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.agent.wal-segment-size&quot;</span>: <span class="hljs-string">&quot;0B&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.agent.wal-truncate-frequency&quot;</span>: <span class="hljs-string">&quot;0s&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.remote.flush-deadline&quot;</span>: <span class="hljs-string">&quot;1m&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.remote.read-concurrent-limit&quot;</span>: <span class="hljs-string">&quot;10&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.remote.read-max-bytes-in-frame&quot;</span>: <span class="hljs-string">&quot;1048576&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.remote.read-sample-limit&quot;</span>: <span class="hljs-string">&quot;50000000&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.allow-overlapping-blocks&quot;</span>: <span class="hljs-string">&quot;false&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.head-chunks-write-queue-size&quot;</span>: <span class="hljs-string">&quot;0&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.max-block-chunk-segment-size&quot;</span>: <span class="hljs-string">&quot;0B&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.max-block-duration&quot;</span>: <span class="hljs-string">&quot;1d12h&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.min-block-duration&quot;</span>: <span class="hljs-string">&quot;2h&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.no-lockfile&quot;</span>: <span class="hljs-string">&quot;false&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.path&quot;</span>: <span class="hljs-string">&quot;data/&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.retention&quot;</span>: <span class="hljs-string">&quot;0s&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.retention.size&quot;</span>: <span class="hljs-string">&quot;0B&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.retention.time&quot;</span>: <span class="hljs-string">&quot;0s&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.wal-compression&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>    <span class="hljs-attr">&quot;storage.tsdb.wal-segment-size&quot;</span>: <span class="hljs-string">&quot;0B&quot;</span>,<br>    <span class="hljs-attr">&quot;web.config.file&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-attr">&quot;web.console.libraries&quot;</span>: <span class="hljs-string">&quot;console_libraries&quot;</span>,<br>    <span class="hljs-attr">&quot;web.console.templates&quot;</span>: <span class="hljs-string">&quot;consoles&quot;</span>,<br>    <span class="hljs-attr">&quot;web.cors.origin&quot;</span>: <span class="hljs-string">&quot;.*&quot;</span>,<br>    <span class="hljs-attr">&quot;web.enable-admin-api&quot;</span>: <span class="hljs-string">&quot;false&quot;</span>,<br>    <span class="hljs-attr">&quot;web.enable-lifecycle&quot;</span>: <span class="hljs-string">&quot;false&quot;</span>,<br>    <span class="hljs-attr">&quot;web.enable-remote-write-receiver&quot;</span>: <span class="hljs-string">&quot;false&quot;</span>,<br>    <span class="hljs-attr">&quot;web.external-url&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-attr">&quot;web.listen-address&quot;</span>: <span class="hljs-string">&quot;0.0.0.0:9090&quot;</span>,<br>    <span class="hljs-attr">&quot;web.max-connections&quot;</span>: <span class="hljs-string">&quot;512&quot;</span>,<br>    <span class="hljs-attr">&quot;web.page-title&quot;</span>: <span class="hljs-string">&quot;Prometheus Time Series Collection and Processing Server&quot;</span>,<br>    <span class="hljs-attr">&quot;web.read-timeout&quot;</span>: <span class="hljs-string">&quot;5m&quot;</span>,<br>    <span class="hljs-attr">&quot;web.route-prefix&quot;</span>: <span class="hljs-string">&quot;/&quot;</span>,<br>    <span class="hljs-attr">&quot;web.user-assets&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-7-12-运行时信息"><a href="#8-7-12-运行时信息" class="headerlink" title="8.7.12 运行时信息"></a>8.7.12 运行时信息</h3><p>返回关于Prometheus服务器的各种运行时信息属性：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/status/</span>runtimeinfo<br></code></pre></td></tr></table></figure>

<p>根据运行时属性的性质，返回的值具有不同的类型。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl http:<span class="hljs-comment">//localhost:9090/api/v1/status/runtimeinfo</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;startTime&quot;</span>: <span class="hljs-string">&quot;2023-01-04T03:19:54.117358252Z&quot;</span>,<br>    <span class="hljs-attr">&quot;CWD&quot;</span>: <span class="hljs-string">&quot;/apps/prometheus-2.37.5.linux-amd64&quot;</span>,<br>    <span class="hljs-attr">&quot;reloadConfigSuccess&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">&quot;lastConfigTime&quot;</span>: <span class="hljs-string">&quot;2023-01-04T03:20:14Z&quot;</span>,<br>    <span class="hljs-attr">&quot;corruptionCount&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;goroutineCount&quot;</span>: <span class="hljs-number">31</span>,<br>    <span class="hljs-attr">&quot;GOMAXPROCS&quot;</span>: <span class="hljs-number">4</span>,<br>    <span class="hljs-attr">&quot;GOGC&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-attr">&quot;GODEBUG&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-attr">&quot;storageRetention&quot;</span>: <span class="hljs-string">&quot;15d&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>注意：</strong>在Prometheus各个版本之间，准确返回的运行时属性可能会发生变化，该变化不会在另行通知。</p>
<h3 id="8-7-13-构建信息"><a href="#8-7-13-构建信息" class="headerlink" title="8.7.13 构建信息"></a>8.7.13 构建信息</h3><p>以下端点返回关于Prometheus服务器的各种构建信息属性：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/status/</span>buildinfo<br></code></pre></td></tr></table></figure>

<p>所有值都是结果 <code>string</code>类型。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl http:<span class="hljs-comment">//localhost:9090/api/v1/status/buildinfo</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;version&quot;</span>: <span class="hljs-string">&quot;2.37.5&quot;</span>,<br>    <span class="hljs-attr">&quot;revision&quot;</span>: <span class="hljs-string">&quot;8d25a0867918173e501b417e7acd85861df8fb0e&quot;</span>,<br>    <span class="hljs-attr">&quot;branch&quot;</span>: <span class="hljs-string">&quot;HEAD&quot;</span>,<br>    <span class="hljs-attr">&quot;buildUser&quot;</span>: <span class="hljs-string">&quot;root@fa6380105630&quot;</span>,<br>    <span class="hljs-attr">&quot;buildDate&quot;</span>: <span class="hljs-string">&quot;20221209-12:46:41&quot;</span>,<br>    <span class="hljs-attr">&quot;goVersion&quot;</span>: <span class="hljs-string">&quot;go1.18.9&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>注意</strong>：在Prometheus各个版本之间，准确返回的构建属性可能会发生变化，该变化不会在另行通知。</p>
<h3 id="8-7-14-TSDB管理API"><a href="#8-7-14-TSDB管理API" class="headerlink" title="8.7.14 TSDB管理API"></a>8.7.14 TSDB管理API</h3><p>这些API为高级用户提供数据库功能。这些API默认是不启用的，除非设置了<code>--web.enable-admin-api</code> 选项。</p>
<p>而且还暴露了一个gRPC API，其定义可以在<a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/blob/master/prompb/rpc.proto">这里</a>找到。这是<strong>实验性的</strong>，将来可能会改变。</p>
<p>注意：有些API需要在prometheus.service里添加<code>--web.enable-admin-api</code>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> vim /usr/lib/systemd/system/prometheus.service</span><br>[Unit]<br>Description=Monitoring system and time series database<br>Documentation=https://prometheus.io/docs/introduction/overview/<br>After=network.target<br><br>[Service]<br>Restart=on-failure<br>WorkingDirectory=/apps/prometheus/<br>ExecStart=/apps/prometheus/prometheus --web.enable-admin-api --config.file=/apps/prometheus/prometheus.yml<br>User=prometheus<br><br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> systemctl daemon-reload <span class="hljs-comment">#读取service文件</span></span><br><span class="hljs-meta">#</span><span class="bash"> systemctl restart prometheus.service <span class="hljs-comment">#重启prometheus</span></span><br></code></pre></td></tr></table></figure>

<p><code>--web.enable-admin-api</code>：对需要管理操作的API时启用。</p>
<h4 id="8-7-14-1-TSDB状态"><a href="#8-7-14-1-TSDB状态" class="headerlink" title="8.7.14.1 TSDB状态"></a>8.7.14.1 TSDB状态</h4><p>返回关于Prometheus TSDB的各种状态统计。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/status/</span>tsdb<br></code></pre></td></tr></table></figure>

<ul>
<li><p>headStats：供了关于TSDB头块的以下数据。</p>
<ul>
<li><p>numSeries：系列的数量。</p>
</li>
<li><p>chunkCount：块的数量。</p>
</li>
<li><p>minTime：当前的最小时间戳，以毫秒为单位。</p>
</li>
<li><p>maxTime：当前的最大时间戳，以毫秒为单位。</p>
</li>
</ul>
</li>
<li><p>seriesCountByMetricName：提供一个度量名称及其系列计数的列表。</p>
</li>
<li><p>labelValueCountByLabelName：提供一个标签名称和它们的值计数的列表。</p>
</li>
<li><p>memoryIntesByLabelName：提供一个标签名称和内存使用的字节数的列表。内存使用量是通过添加给定标签名称的所有值的长度来计算的。</p>
</li>
<li><p>seriesCountByLabelPair：提供一个标签值对及其系列计数的列表。</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl http:<span class="hljs-comment">//localhost:9090/api/v1/status/tsdb</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;headStats&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;numSeries&quot;</span>: <span class="hljs-number">1527</span>,<br>      <span class="hljs-attr">&quot;numLabelPairs&quot;</span>: <span class="hljs-number">766</span>,<br>      <span class="hljs-attr">&quot;chunkCount&quot;</span>: <span class="hljs-number">4099</span>,<br>      <span class="hljs-attr">&quot;minTime&quot;</span>: <span class="hljs-number">1672992000000</span>,<br>      <span class="hljs-attr">&quot;maxTime&quot;</span>: <span class="hljs-number">1672996416721</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;seriesCountByMetricName&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;prometheus_http_request_duration_seconds_bucket&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">260</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;prometheus_http_response_size_bytes_bucket&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">234</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;node_scrape_collector_duration_seconds&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">45</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;node_scrape_collector_success&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">45</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;node_cpu_seconds_total&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">32</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;prometheus_http_requests_total&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">29</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;prometheus_http_response_size_bytes_count&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">26</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;prometheus_http_response_size_bytes_sum&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">26</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;prometheus_http_request_duration_seconds_count&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">26</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;prometheus_http_request_duration_seconds_sum&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">26</span><br>      &#125;<br>    ],<br>    <span class="hljs-attr">&quot;labelValueCountByLabelName&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;__name__&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">477</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;le&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">70</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;collector&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">45</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;handler&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">26</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;quantile&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">9</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;mode&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">8</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;device&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">8</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;version&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">7</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;name&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">7</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;code&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">6</span><br>      &#125;<br>    ],<br>    <span class="hljs-attr">&quot;memoryInBytesByLabelName&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;__name__&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">15707</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;handler&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">468</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;le&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">323</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;collector&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">291</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;revision&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">91</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;version&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">86</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;path&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">53</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;model&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">46</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;slice&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">43</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;role&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">43</span><br>      &#125;<br>    ],<br>    <span class="hljs-attr">&quot;seriesCountByLabelValuePair&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;job=prometheus&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1001</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;instance=localhost:9090&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1001</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;instance=localhost:9100&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">526</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;job=node&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">526</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;__name__=prometheus_http_request_duration_seconds_bucket&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">260</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;__name__=prometheus_http_response_size_bytes_bucket&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">234</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;le=+Inf&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">57</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;__name__=node_scrape_collector_duration_seconds&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">45</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;__name__=node_scrape_collector_success&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">45</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;device=sda2&quot;</span>,<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">39</span><br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="8-7-14-2-TSDB快照"><a href="#8-7-14-2-TSDB快照" class="headerlink" title="8.7.14.2 TSDB快照"></a>8.7.14.2 TSDB快照</h4><p>快照在TSDB的数据目录下创建所有当前数据的快照到 <code>snapshots/&lt;datetime&gt;-&lt;rand&gt;</code> ，并返回该目录作为响应。它将选择性地跳过快照数据，这些数据只出现在头块中，并且还没有压缩到磁盘。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/admin/</span>tsdb/snapshot<br>PUT <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/admin/</span>tsdb/snapshot<br></code></pre></td></tr></table></figure>

<p>URL查询参数：</p>
<ul>
<li><code>skip_head=&lt;bool&gt;</code>：跳过头块中的数据。可选的。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl -XPOST http:<span class="hljs-comment">//localhost:9090/api/v1/admin/tsdb/snapshot</span><br>&#123;<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;20230106T090400Z-284c0661e9d138c1&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>查看快照</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> ls /apps/prometheus/data/snapshots</span><br>20230106T090322Z-12d1383aad1567ff  20230106T090400Z-284c0661e9d138c1<br></code></pre></td></tr></table></figure>

<p>根据上面的提示，快照存在于 <code>&lt;data-dir&gt;/snapshots/20230106T090400Z-284c0661e9d138c1</code>中。</p>
<h4 id="8-7-14-3-删除时间序列"><a href="#8-7-14-3-删除时间序列" class="headerlink" title="8.7.14.3 删除时间序列"></a>8.7.14.3 删除时间序列</h4><p>DeleteSeries删除时间范围内的一系列选择的数据。实际的数据仍然存在于磁盘上，并在将来的压缩中清除，或者可以通过点击Clean Tombstones端点显式地清除。</p>
<p>如果成功，则返回 <code>204</code>状态码。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/admin/</span>tsdb/delete_series<br>PUT <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/admin/</span>tsdb/delete_series<br></code></pre></td></tr></table></figure>

<p>URL查询参数：</p>
<ul>
<li><code>match[]=&lt;series_selector&gt;</code>: 选择要删除的时间序列的标签匹配器参数。必须提供至少一个<code>match[]</code>参数。</li>
<li><code>start=&lt;rfc3339 | unix_timestamp&gt;</code>：开始时间戳。可选，默认为尽可能最短时间。</li>
<li><code>end=&lt;rfc3339 | unix_timestamp&gt;</code>：结束时间戳。可选，默认为尽可能最长的时间。</li>
</ul>
<p>不设置开始和结束时间将清除数据库中匹配的时间序列的所有数据。</p>
<p>例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl -X POST \<br>  -g &#x27;http:<span class="hljs-comment">//localhost:9090/api/v1/admin/tsdb/delete_series?match[]=up&amp;match[]=process_start_time_seconds&#123;job=&quot;prometheus&quot;&#125;&#x27;</span><br></code></pre></td></tr></table></figure>

<h4 id="8-7-14-4-Clean-Tombstones"><a href="#8-7-14-4-Clean-Tombstones" class="headerlink" title="8.7.14.4 Clean Tombstones"></a>8.7.14.4 Clean Tombstones</h4><p>CleanTombstones从磁盘移除删除的数据，并清理现有的tombstones。可以在删除时间序列之后使用它来释放空间。</p>
<p>如果成功，则返回 <code>204</code>状态码。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/admin/</span>tsdb/clean_tombstones<br>PUT <span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/admin/</span>tsdb/clean_tombstones<br></code></pre></td></tr></table></figure>

<p>没有参数和请求体。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"># curl -XPOST http:<span class="hljs-comment">//localhost:9090/api/v1/admin/tsdb/clean_tombstones</span><br></code></pre></td></tr></table></figure>



<h1 id="九、最佳实践：4个黄金指标和USE方法"><a href="#九、最佳实践：4个黄金指标和USE方法" class="headerlink" title="九、最佳实践：4个黄金指标和USE方法"></a>九、最佳实践：4个黄金指标和USE方法</h1><p>前面部分介绍了Prometheus的数据存储模型以及4种指标类型，同时Prometheus提供的强大的PromQL可以实现对数据的个性化处理。Promthues基于指标提供了一个通用的监控解决方案。这里先思考一个基本的问题，在实现监控时，我们到底应该监控哪些对象以及哪些指标？</p>
<h2 id="9-1-监控所有"><a href="#9-1-监控所有" class="headerlink" title="9.1 监控所有"></a>9.1 监控所有</h2><p>在之前<strong>Prometheus简介</strong>部分介绍监控的基本目标，首先是及时发现问题其次是要能够快速对问题进行定位。对于传统监控解决方案而言，用户看到的依然是一个黑盒，用户无法真正了解系统的真正的运行状态。因此Prometheus鼓励用户监控所有的东西。</p>
<p>下面列举一些常用的监控维度：</p>
<table>
<thead>
<tr>
<th><strong>级别</strong></th>
<th><strong>监控什么</strong></th>
<th><strong>Exporter</strong></th>
</tr>
</thead>
<tbody><tr>
<td>网络</td>
<td>网络协议：http、dns、tcp、icmp；网络硬件：路由器，交换机等</td>
<td>BlockBox Exporter;SNMP Exporter</td>
</tr>
<tr>
<td>主机</td>
<td>资源用量</td>
<td>node exporter</td>
</tr>
<tr>
<td>容器</td>
<td>资源用量</td>
<td>cAdvisor</td>
</tr>
<tr>
<td>应用(包括Library)</td>
<td>延迟，错误，QPS，内部状态等</td>
<td>代码中集成Prmometheus Client</td>
</tr>
<tr>
<td>中间件状态</td>
<td>资源用量，以及服务状态</td>
<td>代码中集成Prmometheus Client</td>
</tr>
<tr>
<td>编排工具</td>
<td>集群资源用量，调度等</td>
<td>Kubernetes Components</td>
</tr>
</tbody></table>
<h2 id="9-2-监控模式"><a href="#9-2-监控模式" class="headerlink" title="9.2 监控模式"></a>9.2 监控模式</h2><p>除了上述介绍的不同监控级别以外。实际上根据不同的系统类型和目标，这里还有一些通用的套路和模式可以使用。</p>
<h2 id="9-3-4个黄金指标"><a href="#9-3-4个黄金指标" class="headerlink" title="9.3 4个黄金指标"></a>9.3 4个黄金指标</h2><p>Four Golden Signals是Google针对大量分布式监控的经验总结，4个黄金指标可以在服务级别帮助衡量终端用户体验、服务中断、业务影响等层面的问题。主要关注与以下四种类型的指标：延迟，通讯量，错误以及饱和度：</p>
<ul>
<li>延迟：服务请求所需时间。</li>
</ul>
<blockquote>
<p>记录用户所有请求所需的时间，重点是要区分成功请求的延迟时间和失败请求的延迟时间。 例如在数据库或者其他关键祸端服务异常触发HTTP 500的情况下，用户也可能会很快得到请求失败的响应内容，如果不加区分计算这些请求的延迟，可能导致计算结果与实际结果产生巨大的差异。除此以外，在微服务中通常提倡“快速失败”，开发人员需要特别注意这些延迟较大的错误，因为这些缓慢的错误会明显影响系统的性能，因此追踪这些错误的延迟也是非常重要的。</p>
</blockquote>
<ul>
<li>通讯量：监控当前系统的流量，用于衡量服务的容量需求。</li>
</ul>
<blockquote>
<p>流量对于不同类型的系统而言可能代表不同的含义。例如，在HTTP REST API中, 流量通常是每秒HTTP请求数；</p>
</blockquote>
<ul>
<li>错误：监控当前系统所有发生的错误请求，衡量当前系统错误发生的速率。</li>
</ul>
<blockquote>
<p>对于失败而言有些是显式的(比如, HTTP 500错误)，而有些是隐式(比如，HTTP响应200，但实际业务流程依然是失败的)。</p>
<p>对于一些显式的错误如HTTP 500可以通过在负载均衡器(如Nginx)上进行捕获，而对于一些系统内部的异常，则可能需要直接从服务中添加钩子统计并进行获取。</p>
</blockquote>
<ul>
<li>饱和度：衡量当前服务的饱和度。</li>
</ul>
<blockquote>
<p>主要强调最能影响服务状态的受限制的资源。 例如，如果系统主要受内存影响，那就主要关注系统的内存状态，如果系统主要受限与磁盘I/O，那就主要观测磁盘I/O的状态。因为通常情况下，当这些资源达到饱和后，服务的性能会明显下降。同时还可以利用饱和度对系统做出预测，比如，“磁盘是否可能在4个小时候就满了”。</p>
</blockquote>
<h2 id="9-4-RED方法"><a href="#9-4-RED方法" class="headerlink" title="9.4 RED方法"></a>9.4 RED方法</h2><p>RED方法是Weave Cloud在基于Google的“4个黄金指标”的原则下结合Prometheus以及Kubernetes容器实践，细化和总结的方法论，特别适合于云原生应用以及微服务架构应用的监控和度量。主要关注以下三种关键指标：</p>
<ul>
<li>(请求)速率：服务每秒接收的请求数。</li>
<li>(请求)错误：每秒失败的请求数。</li>
<li>(请求)耗时：每个请求的耗时。</li>
</ul>
<p>在“4大黄金信号”的原则下，RED方法可以有效的帮助用户衡量云原生以及微服务应用下的用户体验问题。</p>
<h2 id="9-5-USE方法"><a href="#9-5-USE方法" class="headerlink" title="9.5 USE方法"></a>9.5 USE方法</h2><p>USE方法全称”Utilization Saturation and Errors Method”，主要用于分析系统性能问题，可以指导用户快速识别资源瓶颈以及错误的方法。正如USE方法的名字所表示的含义，USE方法主要关注与资源的：使用率(Utilization)、饱和度(Saturation)以及错误(Errors)。</p>
<ul>
<li>使用率：关注系统资源的使用情况。 这里的资源主要包括但不限于：CPU，内存，网络，磁盘等等。100%的使用率通常是系统性能瓶颈的标志。</li>
<li>饱和度：例如CPU的平均运行排队长度，这里主要是针对资源的饱和度(注意，不同于4大黄金信号)。任何资源在某种程度上的饱和都可能导致系统性能的下降。</li>
<li>错误：错误计数。例如：“网卡在数据包传输过程中检测到的以太网网络冲突了14次”。</li>
</ul>
<p>通过对资源以上指标持续观察，通过以下流程可以知道用户识别资源瓶颈：</p>
<p><img src="C:\Users\kinci\Desktop\blog-picture\prometheus\prometheus-74.png" srcset="/blog/img/loading.gif"></p>
<h1 id="十、小结"><a href="#十、小结" class="headerlink" title="十、小结"></a>十、小结</h1><p>PromQL是Prometheus的标准查询语句，通过强大的数据统计能力，使得将监控指标与实际业务进行关联成为可能。同时通过内置的预测函数，能够帮助用户将传统的面向结果转变为面向预测的方式。从而更有效的为业务和系统的正常运行保驾护航。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/prometheus/">prometheus</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2023/02/06/Prometheus%E4%B9%8B%E8%81%94%E9%82%A6%EF%BC%88%E5%85%AB%EF%BC%89/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Prometheus之联邦（八）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2023/01/10/Prometheus%E4%B9%8BPushgateway%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8%EF%BC%88%E5%85%AD%EF%BC%89/">
                        <span class="hidden-mobile">Prometheus之Pushgateway介绍与使用（六）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
